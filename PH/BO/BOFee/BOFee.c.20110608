/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/05/03              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOFee.h"

#define	PD_PREFIX	"org"
char    cDebug;
OBJPTR(DB);

void BOFee(char    cdebug)
{
        cDebug = cdebug;
}

double CalFee(char cType,double dTxnAmt,double dValue, double dAddValue,double dMin,double dMax);

int	FindFee(hash_t* hContext,
		 	double	dTxnAmt,
			const char* csFeeType,
			const char* csCountry,
			const char* csChannelCode,
			const char* csServiceCode,
			const char* csTxnCode,
			const char* csMerchantId,
			const char* csMerchantClientId);
int GetTxnFee(hash_t *hContext, const hash_t *hRequest)
{
	int iRet = 0;
	double	dOrgTxnAmt = 0;
	double	dPspTxnAmt = 0;
	char	*csOrgTxnCountry;
	char	*csOrgChannelCode;
	char	*csOrgServiceCode;
	char	*csOrgMerchantId;
	char	*csOrgMerchantClientId;
	char	*csOrgTxnCode;
	char	csTag[PD_TAG_LEN + 1];

	int	iInitMode = PD_FALSE;

	hash_t	*hRec;
	

	GetField_Int(hContext,"init_mode",&iInitMode);
DEBUGLOG(("BOFee::GetTxnFee() init_mode = [%d]\n",iInitMode));

	
	
/* txn amt */
	if (iInitMode)
		sprintf(csTag,"%s_txn_amt",PD_PREFIX);
	else
		strcpy(csTag,"txn_amt");
	
	if (GetField_Double(hContext,csTag,&dOrgTxnAmt)) {
		dPspTxnAmt = dOrgTxnAmt;
DEBUGLOG(("BOFee::GetTxnFee() %s = [%f]\n",csTag,dOrgTxnAmt));
	}
	else {
DEBUGLOG(("BOFee::GetTxnFee() %s not found!!!\n",csTag));
	}

/* txn code */
	if (iInitMode)
		sprintf(csTag,"%s_txn_code",PD_PREFIX);
	else
		strcpy(csTag,"txn_code");
	if (GetField_CString(hContext,csTag,&csOrgTxnCode)) {
DEBUGLOG(("BOFee::GetTxnFee() %s = [%s]\n",csTag,csOrgTxnCode));
	}
	else {
DEBUGLOG(("BOFee::GetTxnFee() %s not found!!!\n",csTag));
	}

/*org txn country */
	if (iInitMode) {
		sprintf(csTag,"%s_txn_country",PD_PREFIX);
        	if (GetField_CString(hContext,csTag,&csOrgTxnCountry)) {
DEBUGLOG(("BOFee::GetTxnFee() %s = [%s]\n",csTag,csOrgTxnCountry));
        	}
        	else {
DEBUGLOG(("BOFee::GetTxnFee() %s is missing!!!\n",csTag));
        	}
	}
	else {
		strcpy(csTag,"txn_country");
        	if (GetField_CString(hRequest,csTag,&csOrgTxnCountry)) {
DEBUGLOG(("BOFee::GetTxnFee() %s = [%s]\n",csTag,csOrgTxnCountry));
        	}
        	else {
DEBUGLOG(("BOFee::GetTxnFee() %s is missing!!!\n",csTag));
        	}
	}


/*org channel code */
	if (iInitMode)
		sprintf(csTag,"%s_channel_code",PD_PREFIX);
	else
		strcpy(csTag,"channel_code");
        if (GetField_CString(hContext,csTag,&csOrgChannelCode)) {
DEBUGLOG(("BOFee::GetTxnFee() %s = [%s]\n",csTag,csOrgChannelCode));
        }
        else {
DEBUGLOG(("BOFee::GetTxnFee() %s is missing!!!\n",csTag));
        }

/*org service code */
	if (iInitMode) {
		sprintf(csTag,"%s_service_code",PD_PREFIX);
        	if (GetField_CString(hContext,csTag,&csOrgServiceCode)) {
DEBUGLOG(("BOFee::GetTxnFee() %s = [%s]\n",csTag,csOrgServiceCode));
        	}
        	else {
DEBUGLOG(("BOFee::GetTxnFee() %s is missing!!!\n",csTag));
        	}
	}
	else {
		strcpy(csTag,"service_code");
        	if (GetField_CString(hRequest,csTag,&csOrgServiceCode)) {
DEBUGLOG(("BOFee::GetTxnFee() %s = [%s]\n",csTag,csOrgServiceCode));
        	}
        	else {
DEBUGLOG(("BOFee::GetTxnFee() %s is missing!!!\n",csTag));
        	}
	}



/*org merchant id */
	if (iInitMode) {
		sprintf(csTag,"%s_merchant_id",PD_PREFIX);
        	if (GetField_CString(hContext,csTag,&csOrgMerchantId)) {
DEBUGLOG(("BOFee::GetTxnFee() %s = [%s]\n",csTag,csOrgMerchantId));
        	}
        	else {
DEBUGLOG(("BOFee::GetTxnFee() %s is missing!!!\n",csTag));
        	}
	}
	else {
		strcpy(csTag,"merchant_id");
        	if (GetField_CString(hRequest,csTag,&csOrgMerchantId)) {
DEBUGLOG(("BOFee::GetTxnFee() %s = [%s]\n",csTag,csOrgMerchantId));
        	}
        	else {
DEBUGLOG(("BOFee::GetTxnFee() %s is missing!!!\n",csTag));
        	}
	}


/*org merchant client id */
	if (iInitMode) {
		sprintf(csTag,"%s_client_id",PD_PREFIX);
	}
	else {
		strcpy(csTag,"merchant_client_id");
	}

       	if (GetField_CString(hContext,csTag,&csOrgMerchantClientId)) {
DEBUGLOG(("BOFee::GetTxnFee() %s = [%s]\n",csTag,csOrgMerchantClientId));
       	}
       	else {
DEBUGLOG(("BOFee::GetTxnFee() %s is missing!!!\n",csTag));
       	}

/* find txn fee */
	hRec = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hRec,0); 

	iRet = FindFee(hRec,
		dOrgTxnAmt,
		PD_TXN_CHG_TYPE_FEE,
		csOrgTxnCountry,
		csOrgChannelCode,
		csOrgServiceCode,
		csOrgTxnCode,
		csOrgMerchantId,
		csOrgMerchantClientId);
DEBUGLOG(("BOFee: Call txn Fee = [%d]\n",iRet));
	if (iRet == PD_OK) {
		double	dTmp;
		if (GetField_Double(hRec,"merchant_fee",&dTmp)) {
			PutField_Double(hContext,"merchant_txn_fee",dTmp);
DEBUGLOG(("BOFee: merchant_txn_fee = [%lf]\n",dTmp));
		}
		if (GetField_Double(hRec,"customer_fee",&dTmp)) {
			dPspTxnAmt += dTmp;
			PutField_Double(hContext,"customer_txn_fee",dTmp);
DEBUGLOG(("BOFee: customer_txn_fee = [%lf]\n",dTmp));
DEBUGLOG(("BOFee: src_psp_txn_amt = [%lf]\n",dPspTxnAmt));
		}
	}

	hash_destroy(hRec);
        hash_init(hRec,0); 
	if (iRet == PD_OK) {
		iRet = FindFee(hRec,
			dOrgTxnAmt,
			PD_TXN_CHG_TYPE_MARKUP,
			csOrgTxnCountry,
			csOrgChannelCode,
			csOrgServiceCode,
			csOrgTxnCode,
			csOrgMerchantId,
			csOrgMerchantClientId);
DEBUGLOG(("BOFee: Call markup Fee = [%d]\n",iRet));
		if (iRet == PD_OK) {
			double	dTmp;
			if (GetField_Double(hRec,"merchant_fee",&dTmp)) {
				PutField_Double(hContext,"merchant_mu_fee",dTmp);
DEBUGLOG(("BOFee: merchant_mu_fee = [%lfd]\n",dTmp));
			}
			if (GetField_Double(hRec,"customer_fee",&dTmp)) {
				dPspTxnAmt += dTmp;
				PutField_Double(hContext,"customer_mu_fee",dTmp);
DEBUGLOG(("BOFee: customer_mu_fee = [%lf]\n",dTmp));
DEBUGLOG(("BOFee: src_psp_txn_amt = [%lf]\n",dPspTxnAmt));
			}
		}
	}

	PutField_Double(hContext,"src_psp_txn_amt",dPspTxnAmt);
	hash_destroy(hRec);
        FREE_ME(hRec);

	return iRet = 0;
}
double CalFee(char cType,double dTxnAmt,double dValue, double dAddValue, double dMin,double dMax)
{
	double	dResult = 0.0;

DEBUGLOG(("BOFee:CalFee() [%c] [%lf] [%lf] [%lf] i[%lf] x[%lf]\n",cType,dTxnAmt,dValue,dAddValue,dMin,dMax));
	if (cType == PD_PRECENTAGE) {
        	double dTmp = 0;
                dTmp = dTxnAmt * (dValue/100);
                dResult = newround(dTmp,PD_DECIMAL_LEN);
        }
        else if (cType == PD_FIXED_AMOUNT) {
       		dResult = newround(dValue,PD_DECIMAL_LEN);
        }
DEBUGLOG(("BOFee:CalFee() Fee = [%lf]\n",dResult));
	if (dMin > dResult  && dMin != 0)
		dResult = dMin;
	if (dResult > dMax && dMax != 0 )
		dResult = dMax;
DEBUGLOG(("BOFee:CalFee() after min max Fee = [%lf]\n",dResult));

	return dResult;
}

int     FindFee(hash_t	*hContext,
			double dTxnAmt,
			const char* csFeeType,
                        const char* csCountry,
                        const char* csChannelCode,
                        const char* csServiceCode,
                        const char* csTxnCode,
                        const char* csMerchantId,
                        const char* csMerchantClientId)

{
	int	iRet = PD_OK;
	int	iVal;

	DBObjPtr = CreateObj(DBPtr,"DBRuleTxnFee","Find");
        if ((*DBObjPtr)(csFeeType,
			csCountry, 
		        csChannelCode,
                        csServiceCode,
                        csTxnCode,
                        csMerchantId,
			csMerchantClientId,
                        &iVal) != PD_OK) {
                iRet = INT_ERR;
DEBUGLOG(("BOFee::GetTxnFee() call FindFee failed!!!\n"));
        }
	else {
	        char            cChgType;
                char            cPartyType;
                char            cP1PartyType;
                char            cP2PartyType;
                char            cType;
                char            cP1Type;
                char            cP2Type;
                double          dValue;
                double          dP1Value;
                double          dP2Value;
                double          dAddValue;
                double          dP1AddValue;
                double          dP2AddValue;
		double		dMin;
		double		dP1Min;
		double		dP2Min;
		double		dMax;
		double		dP1Max;
		double		dP2Max;
                
                int             iCnt,iFound;
                recordset_t     *rRecordSet;
                hash_t          *hRec;
                rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
		recordset_init(rRecordSet,0);

DEBUGLOG(("BOFee::FindFee() rule fee def id = [%d]\n",iVal));
                DBObjPtr = CreateObj(DBPtr,"DBRuleTxnFeeDef","FindID");
                iFound = (unsigned long)(*DBObjPtr)(iVal,rRecordSet);
DEBUGLOG(("BOFee::FindFee() rule fee def id found = [%d]\n",iFound));
		if (iFound == PD_FOUND) {
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {  
                                
                                if (GetField_Char(hRec,"chg_type",&cChgType)) {
DEBUGLOG(("BOFee::FindFee() charge type = [%c]\n",cChgType));
                                }
                                
                                if (GetField_Char(hRec,"chg_party_type",&cPartyType)) {
//DEBUGLOG(("BOFee::GetTxnFee() party type = [%c]\n",cPartyType));
                                }
                                
                                if (GetField_Char(hRec,"type",&cType)) {
//DEBUGLOG(("BOFee::GetTxnFee() type = [%c]\n",cType));
                                }
                                if (GetField_Double(hRec,"value",&dValue)) {
//DEBUGLOG(("BOFee::GetTxnFee() value = [%lf]\n",dValue));
                                }
                                if (GetField_Double(hRec,"add_value",&dAddValue)) {
//DEBUGLOG(("BOFee::GetTxnFee() add_value = [%lf]\n",dAddValue));
                                }
                                if (GetField_Double(hRec,"min_value",&dMin)){
//DEBUGLOG(("BOFee::GetTxnFee() min_value = [%lf]\n",dMin));
                                }
                                if (GetField_Double(hRec,"max_value",&dMax)){
//DEBUGLOG(("BOFee::GetTxnFee() max_value = [%lf]\n",dMax));
                                }
                                
                                if (iCnt == 0) {
                                        cP1PartyType = cPartyType;
                                        cP1Type = cType;
                                        dP1Value = dValue;
                                        dP1AddValue = dAddValue;
					dP1Min = dMin;
					dP1Max = dMax;
DEBUGLOG(("BOFee::FindFee() p1 party type = [%c]\n",cP1PartyType));
DEBUGLOG(("BOFee::FindFee() p1 type = [%c]\n",cP1Type));
DEBUGLOG(("BOFee::FindFee() p1 value = [%lf]\n",dP1Value));
DEBUGLOG(("BOFee::FindFee() p1 add value = [%lf]\n",dP1AddValue));
DEBUGLOG(("BOFee::FindFee() p1 min value = [%lf]\n",dP1Min));
DEBUGLOG(("BOFee::FindFee() p1 max value = [%lf]\n",dP1Max));
                                }
                                else {
                                        cP2PartyType = cPartyType;
                                        cP2Type = cType;
                                        dP2Value = dValue;
                                        dP2AddValue = dAddValue;
					dP2Min = dMin;
					dP2Max = dMax;
DEBUGLOG(("BOFee::FindFee() p2 party type = [%c]\n",cP2PartyType));
DEBUGLOG(("BOFee::FindFee() p2 type = [%c]\n",cP2Type));
DEBUGLOG(("BOFee::FindFee() p2 value = [%lf]\n",dP2Value));
DEBUGLOG(("BOFee::FindFee() p2 add value = [%lf]\n",dP2AddValue));
DEBUGLOG(("BOFee::FindFee() p2 min value = [%lf]\n",dP2Min));
DEBUGLOG(("BOFee::FindFee() p2 max value = [%lf]\n",dP2Max));
                                }

                                iCnt++;
                                hRec = RecordSet_GetNext(rRecordSet);
                        }

DEBUGLOG(("BOFee::FindFee() chg type = [%c]\n",cChgType));
			double dMfee;
                        double dCfee;
                        if (cP1PartyType == PD_CHG_PARTY_MERCHANT) {
                        	dMfee = CalFee(cType,dTxnAmt,dP1Value,dP2AddValue,dP1Min,dP1Max);
DEBUGLOG(("BOFee::FindFee() merchant fee = [%f]\n",dMfee));
                        }
                        else if (cP1PartyType == PD_CHG_PARTY_CUSTOMER) {
                       		dCfee = CalFee(cType,dTxnAmt,dP2Value,dP2AddValue,dP2Min,dP2Max);
DEBUGLOG(("BOFee::FindFee() customer_fee = [%f]\n",dCfee));
                        }

                        if (cP2PartyType == PD_CHG_PARTY_MERCHANT) {
                       		dMfee = CalFee(cType,dTxnAmt,dP1Value,dP1AddValue,dP1Min,dP1Max);
DEBUGLOG(("BOFee::FindFee() merchant fee = [%f]\n",dMfee));
                        }
                        else if (cP2PartyType == PD_CHG_PARTY_CUSTOMER) {
                        	dCfee = CalFee(cType,dTxnAmt,dP2Value,dP2AddValue,dP2Min,dP2Max);
DEBUGLOG(("BOFee::FindFee() customer_fee = [%f]\n",dCfee));
                        }
			if (cChgType == PD_CHG_NORMAL) {
                                if (cP1PartyType == PD_CHG_PARTY_MERCHANT) {
                                        PutField_Double(hContext,"merchant_fee",dMfee);
DEBUGLOG(("BOFee::FindFee() merchant fee = [%f]\n",dMfee));
                                }
				else if (cP1PartyType == PD_CHG_PARTY_CUSTOMER) {
                                        PutField_Double(hContext,"customer_fee",dCfee);
DEBUGLOG(("BOFee::FindFee() customer_fee = [%f]\n",dMfee));
                                }
                        }
			else if (cChgType == PD_CHG_BOTH ) {
                                PutField_Double(hContext,"merchant_fee",dMfee);
DEBUGLOG(("BOFee::FindFee() merchant_fee = [%f]\n",dMfee));
                                PutField_Double(hContext,"customer_fee",dCfee);
DEBUGLOG(("BOFee::FindFee() customer_fee = [%f]\n",dCfee));
			}
			else if (cChgType == PD_CHG_MAX ) {
				if (dMfee >= dCfee) {	
DEBUGLOG(("BOFee::FindFee() Pay by Merchant fee = [%lf]\n",dMfee));
                                        PutField_Double(hContext,"merchant_fee",dMfee);
				}
				else {
DEBUGLOG(("BOFee::FindFee() Pay by Customer fee = [%lf]\n",dCfee));
                                        PutField_Double(hContext,"customer_fee",dCfee);
				}	
			}
			else if (cChgType == PD_CHG_MIN ) {
                                if (dMfee <= dCfee) {
DEBUGLOG(("BOFee::FindFee() Pay by Merchant fee = [%lf]\n",dMfee));
                                        PutField_Double(hContext,"merchant_fee",dMfee);
                                }
                                else {
DEBUGLOG(("BOFee::FindFee() Pay by Customer fee = [%lf]\n",dCfee));
                                        PutField_Double(hContext,"customer_fee",dCfee);
                                }
                        }
                }
                else {
DEBUGLOG(("BOFee::FindFee() rule fee def id record not found!!! skip\n"));
                }
        }
	return iRet;
}

int UpdateAmt(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csOrgTxnSeq;
	char	*csPtr;
	double	dTmp;
	double	dTxnAmt;
	double	dNetAmt;
	double	dFee = 0.0;

	hash_t		*hRec;
	recordset_t     *rRecordSet;

        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);
	
/*org txn seq */
        if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("BOFee:UpdateAmt() org_txn_seq = [%s]\n",csOrgTxnSeq));
        }
        else {
DEBUGLOG(("BOFee:UpdateAmt() org_txn_seq is missing!!!\n"));
        }

/*org txn amt */
        if (GetField_Double(hContext,"org_txn_amt",&dTxnAmt)) {
DEBUGLOG(("BOFee:UpdateAmt() org_txn_amt = [%lf]\n",dTxnAmt));
		dNetAmt = dTxnAmt;
        }
	else {
DEBUGLOG(("BOFee:UpdateAmt() org_txn_amt is missing!!!\n"));
	}

/* get all merchant charge */
	DBObjPtr = CreateObj(DBPtr,"DBTxnFeeChg","GetFeeChgDetailByType");
	if ((unsigned long)(*DBObjPtr)(csOrgTxnSeq,PD_CHG_PARTY_MERCHANT,rRecordSet) == PD_OK) {
        	hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {  
			if (GetField_CString(hRec,"chg_type",&csPtr)) {
DEBUGLOG(("BOFee:UpdateAmt() chg_type = [%s]\n",csPtr));
			}
			if (GetField_CString(hRec,"ccy",&csPtr)) {
DEBUGLOG(("BOFee:UpdateAmt() ccy = [%s]\n",csPtr));
			}
			if (GetField_Double(hRec,"fee",&dTmp)) {
DEBUGLOG(("BOFee:UpdateAmt() fee = [%lf]\n",dTmp));
				dFee += dTmp;
				dNetAmt -= dTmp;
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}

DEBUGLOG(("BOFee:UpdateAmt() service_fee = [%lf]\n",dFee));
DEBUGLOG(("BOFee:UpdateAmt() net_amt = [%lf]\n",dNetAmt));
		PutField_Double(hContext,"service_fee",dFee);
		PutField_Double(hContext,"net_amt",dNetAmt);
	}

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
	
	return	iRet;
}
