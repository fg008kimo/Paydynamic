/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/12/17              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOBankCharge.h"

#define	PD_PREFIX	"org"
char    cDebug;
OBJPTR(DB);

void BOBankCharge(char    cdebug)
{
        cDebug = cdebug;
}

double CalBankCharge(const char* csCcy,char cType,double dTxnAmt,double dValue,double dAddValue,double dMin,double dMax);
int GetNetAmount(hash_t *hRls);
int     FindBankCharge(hash_t   *hRls,
                        double dTxnAmt,
                        const char* csBankCode,
                        const char* csPid,
                        const char* csBaid,
                        const char* csCountry,
                        const char* csCcy,
                        const char* csChannelCode,
                        const char* csTxnCode);

int GetTxnBankCharge(hash_t *hRls)
{
	int iRet = 0;

	double	dTxnAmt = 0.0;
	char	*csBankCode;
	char	*csPid;
	char	*csBaid;
	char	*csTxnCountry;
	char	*csTxnCcy;
	char	*csChannelCode;
	char	*csTxnCode;
	double	dBankCharge = 0.0;

	char	csTag[PD_TAG_LEN + 1];
	
/* txn_amt */
	if (GetField_Double(hRls,"txn_amt",&dTxnAmt)) {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() txn_amt = [%f]\n",dTxnAmt));
	}
	else {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() txn_amt not found!!!\n"));
	}

/*bank_code */
        if (GetField_CString(hRls,"bank_code",&csBankCode)) {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() bank_code = [%s]\n",csBankCode));
        }
        else {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() bank_code is missing!!!\n"));
        }

/*pid */
        if (GetField_CString(hRls,"pid",&csPid)) {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() pid = [%s]\n",csPid));
        }
        else {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() pid is missing!!!\n"));
        }

/*baid */
        if (GetField_CString(hRls,"baid",&csBaid)) {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() baid = [%s]\n",csBaid));
        }
        else {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() baid is missing!!!\n"));
        }

/*txn_country */
        if (GetField_CString(hRls,"txn_country",&csTxnCountry)) {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() txn_country = [%s]\n",csTxnCountry));
		PutField_CString(hRls,"country_id",csTxnCountry);
        }
        else {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() txn_country is missing!!!\n"));
	}

/*txn_ccy */
       	if (GetField_CString(hRls,"txn_ccy",&csTxnCcy)) {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() txn_ccy = [%s]\n",csTxnCcy));
		PutField_CString(hRls,"ccy",csTxnCcy);
       	}
       	else {
DEBUGLOG(("BOFee::GetTxnFee() %s is missing!!!\n",csTag));
       	}

/*channel_code */
        if (GetField_CString(hRls,"channel_code",&csChannelCode)) {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() channel_code = [%s]\n",csChannelCode));
        }
        else {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() channel_code is missing!!!\n"));
        }

/* txn_code */
        if (GetField_CString(hRls,"txn_code",&csTxnCode)) {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() txn_code = [%s]\n",csTxnCode));
        }
        else {
DEBUGLOG(("BOBankCharge::GetTxnBankCharge() txn_code not found!!!\n"));
        }

	iRet = FindBankCharge(hRls,
			dTxnAmt,
			csBankCode,
			csPid,
			csBaid,
			csTxnCountry,
			csTxnCcy,
			csChannelCode,
			csTxnCode);

DEBUGLOG(("BOBankCharge: Call FindBankCharge = [%d]\n",iRet));

	if (iRet == PD_OK) {
		if (GetField_Double(hRls,"txn_bank_charge",&dBankCharge)) {
DEBUGLOG(("BOBankCharge: txn_bank_charge = [%lf]\n",dBankCharge));
		}
	}

DEBUGLOG(("BOFee exit = [%d]\n",iRet));

	//return iRet;
	return 0;
}

double CalBankCharge(const char* csCcy,char cType,double dTxnAmt,double dValue,double dAddValue,double dMin,double dMax)
{
	double	dResult = 0.0;

DEBUGLOG(("BOBankCharge:CalBankCharge() [%c] TxnAmt[%lf] Value[%lf] AddValue[%lf] i[%lf] x[%lf]\n",cType,dTxnAmt,dValue,dAddValue,dMin,dMax));

	if (cType == PD_PRECENTAGE) {
DEBUGLOG(("BOBankCharge:CalBankCharge() [%c]\n",PD_PRECENTAGE));
        	double dTmp = 0;
                dTmp = dTxnAmt * (dValue/100);
                dResult = newround(dTmp,PD_DECIMAL_LEN);
        }
        else if (cType == PD_FIXED_AMOUNT) {
DEBUGLOG(("BOBankCharge:CalBankCharge() [%c]\n",PD_FIXED_AMOUNT));
       		dResult = newround(dValue,PD_DECIMAL_LEN);
        }
        else if (cType == PD_PRECENT_WITH_FIX) {
DEBUGLOG(("BOBankCharge:CalBankCharge() [%c]\n",PD_PRECENT_WITH_FIX));
        	double dTmp = 0;
                dTmp = dTxnAmt * (dValue/100) + dAddValue;
                dResult = newround(dTmp,PD_DECIMAL_LEN);
	}

DEBUGLOG(("BOBankCharge:CalBankCharge() BankCharge = [%lf]\n",dResult));

	if (dMin >= 1) {
		if (dResult < dMin) {
DEBUGLOG(("BOBankCharge:CalBankCharge() BankCharge = [%lf] = min[%lf]\n",dResult,dMin));
			dResult = dMin;
		}
	}

	if (dMax >= 1) {
		if (dResult > dMax) {
DEBUGLOG(("BOBankCharge:CalBankCharge() [%lf] > [%lf] &&  max[%lf] > 0.0\n",dResult,dMax,dMax));
			dResult = dMax;
		}
	}

DEBUGLOG(("BOBankCharge:CalBankCharge() after min max BankCharge = [%lf]\n",dResult));

	DBObjPtr = CreateObj(DBPtr,"DBCurrency","IsSupportDecimal");
        if ((unsigned long)((DBObjPtr)(csCcy))!=PD_TRUE){
DEBUGLOG(("BOBankCharge:CalBankCharge() [%s] doesn't support decimal\n",csCcy));
		dResult = newround(dResult,0);
DEBUGLOG(("BOBankCharge:CalBankCharge() new min max Fee = [%lf]\n",dResult));
        }

	return dResult;
}

int GetNetAmount(hash_t *hRls)
{
        int     iRet = PD_OK;
        double  dTxnAmt = 0.0;
        double  dBankCharge = 0.0;
        char*   csTxnCode;
        double  dNetAmt = 0.0;

DEBUGLOG(("BOBankCharge:GetNetAmount()\n"));

/* txn_code */
        if (GetField_CString(hRls,"txn_code",&csTxnCode)) {

/* txn_amt */
                if (GetField_Double(hRls,"txn_amt",&dTxnAmt)) {
DEBUGLOG(("BOBankCharge:GetNetAmount() txn_amt = [%lf]\n",dTxnAmt));
                }

/* bank_charge */
                if (GetField_Double(hRls,"txn_bank_charge",&dBankCharge)) {
DEBUGLOG(("BOBankCharge:GetNetAmount() txn_bank_charge = [%lf]\n",dBankCharge));
                }

/* net_amt */
		dNetAmt = dTxnAmt - dBankCharge;
DEBUGLOG(("BOBankCharge:GetNetAmount() net_amt = [%lf]\n",dNetAmt));
                PutField_Double(hRls,"net_amt",dNetAmt);
        }
        else {
                iRet = PD_ERR;
DEBUGLOG(("BOBankCharge:GetNetAmount() txn_code is missing\n"));
ERRLOG("BOBankCharge:GetNetAmount() txn_code is missing\n");
                PutField_Int(hRls,"internal_error",iRet);
        }

	return iRet;
}

int     FindBankCharge(hash_t	*hRls,
			double dTxnAmt,
                        const char* csBankCode,	
                        const char* csPid,	
                        const char* csBaid,	
                        const char* csCountry,
			const char* csCcy,
                        const char* csChannelCode,
                        const char* csTxnCode)
{
	int	iRet = PD_OK;
	
	char	cType;
	double  dValue = 0.0;		
	double	dAddVal = 0.0;
	double	dMinVal = 0.0;
	double	dMaxVal = 0.0;
	
	double 	dBankCharge = 0.0;
	double	dNetAmt = 0.0;

DEBUGLOG(("[%s] [%s] [%s] [%s] [%s] [%s] [%s]\n", 
        csBankCode, csPid, csBaid, csCountry, 
	csCcy, csChannelCode, csTxnCode)); 

	DBObjPtr = CreateObj(DBPtr,"DBRuleTxnBankCharge","Find");
        if ((*DBObjPtr)(hRls) != PD_OK) {
                iRet = INT_ERR;
DEBUGLOG(("BOBankCharge::FindBankCharge() call Find failed!!!\n"));
        }
	else {
/* type */
                if (GetField_Char(hRls, "type", &cType)) {
DEBUGLOG(("BOBankCharge:: type  = [%c]\n", cType));
                }

/* value */
                if (GetField_Double(hRls, "value", &dValue)) {
DEBUGLOG(("BOBankCharge:: value = [%lf]\n", dValue));
                }

/* add_value */
                if (GetField_Double(hRls, "add_value", &dAddVal)) {
DEBUGLOG(("BOBankCharge:: add_value = [%lf]\n", dAddVal));
                }

/* min_value */
                if (GetField_Double(hRls, "min_value", &dMinVal)) {
DEBUGLOG(("BOBankCharge:: min_value = [%lf]\n", dMinVal));
                }

/* max_value */
                if (GetField_Double(hRls, "max_value", &dMaxVal)) {
DEBUGLOG(("BOBankCharge:: max_value = [%lf]\n", dMaxVal));
                }
	}

	if (iRet == PD_OK) {
/* CalBankCharge */
		dBankCharge = CalBankCharge(csCcy,cType,dTxnAmt,dValue,dAddVal,dMinVal,dMaxVal);
DEBUGLOG(("BOBankCharge:: bank_charge = [%lf]\n", dBankCharge));
		PutField_Double(hRls,"txn_bank_charge",dBankCharge);

/* GetNetAmount */
		iRet = GetNetAmount(hRls);
		if (iRet == PD_OK) {
                	if (GetField_Double(hRls, "net_amt", &dNetAmt)) {
DEBUGLOG(("BOBankCharge:: net_amt = [%lf]\n", dNetAmt));
                	}
		}
	}

	return iRet;
}
