/*
Partnerdelight (c)2014. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/11/05              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "dbutility.h"
#include "BOOLStmtEngine.h"
#include "myrecordset.h"
#include "myhash.h"
#include "math.h"
#include <time.h>

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);


void BOOLStmtEngine(char cdebug)
{
	cDebug = cdebug;
}


int DoAction(const char* csActionType, hash_t* hContext, hash_t* hMatchRule);


int ProcessMatching(hash_t* hContext) {
	int iRet = PD_OK;
	int iTmpRet;

	char *csBaidTxnId;
/*
	char *csTriggerType;
	char *csNature;
	char *csBaidTxnCode;
*/

	int iSubRuleId;
	char *csActionType;
	int iExitOnError;

	int iCnt, iMatched, iExitSubRule, iSkipOnce;
	int iLastSubRuleId;
	char csLastActionType[PD_ENGINE_ACTION_LEN + 1];

	recordset_t *rMatchRule;
	rMatchRule = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rMatchRule, 0);
	hash_t *hMatchRule;

	// get baid_txn_id
	if (iRet == PD_OK) {
		if (!GetField_CString(hContext, "baid_txn_id", &csBaidTxnId)) {
DEBUGLOG(("ProcessMatching:: baid_txn_id not found\n"));
			iRet = PD_ERR;
		} else {
DEBUGLOG(("ProcessMatching:: baid_txn_id = [%s]\n", csBaidTxnId));
		}
	}

/*
	// lock baid txn
	if (iRet == PD_OK) {
DEBUGLOG(("ProcessMatching:: call DBOLBAIDTxn::MatchRespTxnNoWait()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "MatchRespTxnNoWait");
		iTmpRet = (unsigned long)(*DBObjPtr)(csBaidTxnId, PD_COMPLETE);
		if (iTmpRet != PD_FOUND) {
DEBUGLOG(("ProcessMatching:: call DBOLBAIDTxn::MatchRespTxnNoWait() failed\n"));
			iRet = PD_ERR;
		}
	}
*/

/*
	// get trigger_type
	if (iRet == PD_OK) {
		if (!GetField_CString(hContext, "trigger_type", &csTriggerType)) {
DEBUGLOG(("ProcessMatching:: trigger_type not found\n"));
			iRet = PD_ERR;
		} else {
DEBUGLOG(("ProcessMatching:: trigger_type = [%s]\n", csTriggerType));
		}
	}

	// get bank_acct_type
	if (iRet == PD_OK) {
		if (!GetField_CString(hContext, "bank_acct_type", &csNature)) {
DEBUGLOG(("ProcessMatching:: bank_acct_type not found\n"));
			iRet = PD_ERR;
		} else {
DEBUGLOG(("ProcessMatching:: bank_acct_type = [%s]\n", csNature));
		}
	}

	// get baid_txn_code
	if (iRet == PD_OK) {
		if (!GetField_CString(hContext, "baid_txn_code", &csBaidTxnCode)) {
DEBUGLOG(("ProcessMatching:: baid_txn_code not found\n"));
			iRet = PD_ERR;
		} else {
DEBUGLOG(("ProcessMatching:: baid_txn_code = [%s]\n", csBaidTxnCode));
		}
	}
*/

	// get match rule
	if (iRet == PD_OK) {
DEBUGLOG(("ProcessMatching:: call DBOLStmtMatchEngine::GetStmtRule()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLStmtMatchEngine", "GetStmtRule");
		iTmpRet = (unsigned long)(*DBObjPtr)(hContext, rMatchRule);
		if (iTmpRet != PD_OK) {
DEBUGLOG(("ProcessMatching:: call DBOLStmtMatchEngine::GetStmtRule() failed\n"));
			iRet = PD_ERR;
		}
	}

	if (iRet == PD_OK) {
		// loop match rule
		iCnt = 0;
		iMatched = 0;
		iExitSubRule = 0;

		hMatchRule = RecordSet_GetFirst(rMatchRule);
		while (hMatchRule) {
			iSkipOnce = 0;
			iCnt++;

			// get sub_rule_id
			if (!GetField_Int(hMatchRule, "sub_rule_id", &iSubRuleId)) {
DEBUGLOG(("ProcessMatching:: sub_rule_id not found\n"));
				iRet = PD_ERR;
				break;
			} else {
DEBUGLOG(("ProcessMatching:: sub_rule_id = [%d]\n", iSubRuleId));
			}

			// get action_type
			if (!GetField_CString(hMatchRule, "action_type", &csActionType)) {
DEBUGLOG(("ProcessMatching:: action_type not found\n"));
				iRet = PD_ERR;
				break;
			} else {
DEBUGLOG(("ProcessMatching:: action_type = [%s]\n", csActionType));
			}

			// get exit_on_error
			if (!GetField_Int(hMatchRule, "exit_on_error", &iExitOnError)) {
DEBUGLOG(("ProcessMatching:: exit_on_error not found\n"));
				iRet = PD_ERR;
				break;
			} else {
DEBUGLOG(("ProcessMatching:: exit_on_error = [%d]\n", iExitOnError));
			}

			if (iCnt == 1) {
				iLastSubRuleId = iSubRuleId;
				strcpy(csLastActionType, csActionType);
			} else {
				if (iSubRuleId != iLastSubRuleId) {
					if (iMatched) {
DEBUGLOG(("ProcessMatching:: matched! skip remaining sub-rule\n"));
						break;
					} else {
						iExitSubRule = 0;
					}
					iLastSubRuleId = iSubRuleId;
				} else if (iExitSubRule) {
DEBUGLOG(("ProcessMatching:: skip this sub-rule\n"));
					hMatchRule = RecordSet_GetNext(rMatchRule);
					continue;
				} else if ((!strcmp(csActionType, csLastActionType)) && (iMatched)) {
DEBUGLOG(("ProcessMatching:: skip this action\n"));
					iSkipOnce = 1;
				}
				strcpy(csLastActionType, csActionType);
			}

			// process action_type
			if (!iSkipOnce) {
				iRet = DoAction(csActionType, hContext, hMatchRule);

/* for testing start */
				printf ("Enter value for iRet: ");
				scanf ("%d", &iRet);
DEBUGLOG(("ProcessMatching:: iRet = [%d]\n", iRet));
/* for testing end */

				if (iRet == PD_OK) {
					iMatched = 1;
				} else {
					iMatched = 0;
					if (iExitOnError) {
						iExitSubRule = 1;
					}
				}
			}

			hMatchRule = RecordSet_GetNext(rMatchRule);
		}

		if (iRet == PD_OK) {
			if ((iCnt > 0) && (iMatched)) {
DEBUGLOG(("ProcessMatching:: matched!\n"));
			}
		}
	}

	// recordset destroy
	RecordSet_Destroy(rMatchRule);
	FREE_ME(rMatchRule);

DEBUGLOG(("ProcessMatching() exit iRet = [%d]\n", iRet));
	return iRet;
}

int DoAction(const char* csActionType, hash_t* hContext, hash_t* hMatchRule) {
	int iRet = PD_OK;
	int iTmpRet;
	char *csTmp;

	int iFieldCnt, iIndex;
	int iTagCnt = 0;
	int iIsSqlCond;
	int iSqlCnt = 0;
	char *csParty, *csFilter, *csOperator, *csValue;
	char *csTag = (char*) malloc (64);

	hash_t *hMatchValue;
	hMatchValue = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hMatchValue, 0);

	recordset_t *rEngineSql;
	rEngineSql = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rEngineSql, 0);
	hash_t *hEngineSql;

	// get field_cnt
	if (iRet == PD_OK) {
		if (!GetField_Int(hMatchRule, "field_cnt", &iFieldCnt)) {
DEBUGLOG(("DoAction:: field_cnt not found\n"));
			iRet = PD_ERR;
		} else {
DEBUGLOG(("DoAction:: field_cnt = [%d]\n", iFieldCnt));
		}
	}

	// loop
	if (iRet == PD_OK) {
		for (iIndex = 1; iIndex <= iFieldCnt; iIndex++) {
			iTagCnt++;
			iIsSqlCond = 1;

			// get party
			sprintf(csTag, "party_%d", iIndex);
			if (!GetField_CString(hMatchRule, csTag, &csParty)) {
DEBUGLOG(("DoAction:: [%s] not found\n", csTag));
				iRet = PD_ERR;
				break;
			} else {
DEBUGLOG(("DoAction:: [%s] = [%s]\n", csTag, csParty));
				if ((strcmp(csParty, PD_BOTH_PARTY) != 0)
					&& (strcmp(csParty, PD_PSP_TXN_PARTY) != 0)
					&& (strcmp(csParty, PD_BAID_TXN_PARTY) != 0)) {
DEBUGLOG(("DoAction:: undefined party\n"));
					iRet = PD_ERR;
					break;
				}
			}

			// get filter
			sprintf(csTag, "filter_%d", iIndex);
			if (!GetField_CString(hMatchRule, csTag, &csFilter)) {
DEBUGLOG(("DoAction:: [%s] not found\n", csTag));
				iRet = PD_ERR;
				break;
			} else {
DEBUGLOG(("DoAction:: [%s] = [%s]\n", csTag, csFilter));
			}

			// if party != "both"
			if (strcmp(csParty, PD_BOTH_PARTY) != 0) {
				// get operator
				sprintf(csTag, "operator_%d", iIndex);
				if (!GetField_CString(hMatchRule, csTag, &csOperator)) {
DEBUGLOG(("DoAction:: [%s] not found\n", csTag));
					iRet = PD_ERR;
					break;
				} else {
DEBUGLOG(("DoAction:: [%s] = [%s]\n", csTag, csOperator));
					if ((strcmp(csOperator, "=") != 0)
						&& (strcmp(csOperator, ">") != 0)
						&& (strcmp(csOperator, "<") != 0)
						&& (strcmp(csOperator, "!=") != 0)
						&& (strcmp(csOperator, ">=") != 0)
						&& (strcmp(csOperator, "<=") != 0)) {
DEBUGLOG(("DoAction:: undefined operator\n"));
						iRet = PD_ERR;
						break;
					}
				}

				// get value
				sprintf(csTag, "value_%d", iIndex);
				if (!GetField_CString(hMatchRule, csTag, &csValue)) {
DEBUGLOG(("DoAction:: [%s] not found\n", csTag));
					iRet = PD_ERR;
					break;
				} else {
DEBUGLOG(("DoAction:: [%s] = [%s]\n", csTag, csValue));
				}
			}

/*
			if (!strcmp(csFilter, "keywords")) {
				iTagCnt--;
				iIsSqlCond = 0;
			}
*/

			if (iIsSqlCond) {
				sprintf(csTag, "party_%d", iTagCnt);
				PutField_CString(hMatchValue, csTag, csParty);
				sprintf(csTag, "filter_%d", iIndex);
				PutField_CString(hMatchValue, csTag, csFilter);
				if (strcmp(csParty, PD_BOTH_PARTY) != 0) {
					sprintf(csTag, "operator_%d", iTagCnt);
					PutField_CString(hMatchValue, csTag, csOperator);
					sprintf(csTag, "value_%d", iTagCnt);
					PutField_CString(hMatchValue, csTag, csValue);
				}
			}
		}
	}

	// get action sql
	if (iRet == PD_OK) {
		PutField_CString(hMatchRule, "engine_type", "stmt");
DEBUGLOG(("DoAction:: call DBOLEngineSql::GetEngineSql()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLEngineSql", "GetEngineSql");
		iTmpRet = (unsigned long)(*DBObjPtr)(hMatchRule, rEngineSql);
		if (iTmpRet != PD_OK) {
DEBUGLOG(("DoAction:: call DBOLEngineSql::GetEngineSql() failed\n"));
			iRet = PD_ERR;
		} else {
			hEngineSql = RecordSet_GetFirst(rEngineSql);
			while (hEngineSql) {
				GetField_CString(hEngineSql, "sql", &csTmp);
DEBUGLOG(("DoAction: sql = [%s]\n", csTmp));
				iSqlCnt++;
				sprintf(csTag, "sql_%d", iSqlCnt);
				PutField_CString(hMatchValue, csTag, csTmp);
				hEngineSql = RecordSet_GetNext(rEngineSql);
			}
		}
	}

	// execute action sql
	if (iRet == PD_OK) {
		if (!strcmp(csActionType, "fr_baid1_to_psp1")) {
DEBUGLOG(("DoAction:: call DBOLStmtMatchEngine::fr_baid1_to_psp1()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLStmtMatchEngine", "fr_baid1_to_psp1");
			iTmpRet = (unsigned long)(*DBObjPtr)(iTagCnt, hMatchValue, hContext);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("DoAction:: call DBOLStmtMatchEngine::fr_baid1_to_psp1() failed\n"));
				iRet = PD_ERR;
			} else {
				GetField_CString(hContext, "psp_txn_1_id", &csTmp);
DEBUGLOG(("DoAction:: psp_txn_1_id = [%s]\n", csTmp));
			}
		} else if (!strcmp(csActionType, "fr_psp1_to_psp2")) {
DEBUGLOG(("DoAction:: call DBOLStmtMatchEngine::fr_psp1_to_psp2()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLStmtMatchEngine", "fr_psp1_to_psp2");
			iTmpRet = (unsigned long)(*DBObjPtr)(hContext);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("DoAction:: call DBOLStmtMatchEngine::fr_psp1_to_psp2() failed\n"));
				iRet = PD_ERR;
			} else {
				GetField_CString(hContext, "psp_txn_2_id", &csTmp);
DEBUGLOG(("DoAction:: psp_txn_2_id = [%s]\n", csTmp));
			}
		} else if (!strcmp(csActionType, "fr_psp2_to_baid2")) {
DEBUGLOG(("DoAction:: call DBOLStmtMatchEngine::fr_psp2_to_baid2()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLStmtMatchEngine", "fr_psp2_to_baid2");
			iTmpRet = (unsigned long)(*DBObjPtr)(iTagCnt, hMatchValue, hContext);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("DoAction:: call DBOLStmtMatchEngine::fr_psp2_to_baid2() failed\n"));
				iRet = PD_ERR;
			} else {
				GetField_CString(hContext, "baid_txn_2_id", &csTmp);
DEBUGLOG(("DoAction:: baid_txn_2_id = [%s]\n", csTmp));
			}
		}
	}

	// free malloc
	FREE_ME(csTag);
	// hash destroy
	hash_destroy(hMatchValue);
	FREE_ME(hMatchValue);
	// recordset destroy
	RecordSet_Destroy(rEngineSql);
	FREE_ME(rEngineSql);

DEBUGLOG(("DoAction() exit iRet = [%d]\n", iRet));
	return iRet;
}
