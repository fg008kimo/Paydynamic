/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/11/29              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOMmsBalance.h"

char    cDebug;
OBJPTR(DB);
/*OBJPTR(Txn);*/
OBJPTR(BO);

void BOMmsBalance(char    cdebug)
{
	cDebug = cdebug;
}

int GetPspCountry(hash_t *hRls);
int GetMerchCountryService(hash_t *hRls);
int IsNotFirstRec(hash_t *hRls);

int PspSourceBalance(hash_t *hRls);
int MBSourceBalance(hash_t *hRls);
int BankSourceBalance(hash_t *hRls);
int MerchSourceBalance(hash_t *hRls);

int PspDestBalance(hash_t *hRls);
int MBDestBalance(hash_t *hRls);
int BankDestBalance(hash_t *hRls);


int PTMHandler(hash_t *hRls)
{
	int	iRet = PD_OK;
	char	cTmp;


	if (GetField_Char(hRls,"isd_ind",&cTmp)) {
DEBUGLOG(("BOMmsBalance::PTMHandler: isd_ind [%c]\n", cTmp));
		if (cTmp == PD_SOURCE) {
			/* PSP Balance */
			iRet = PspSourceBalance(hRls);

		} else if (cTmp == PD_DESTINATION ) {
			/* MB Balance */
			iRet = MBDestBalance(hRls);

		} else {
DEBUGLOG(("BOMmsBalance::PTMHandler: invalid isd_ind [%c]\n", cTmp));
ERRLOG("BOMmsBalance::PTMHandler: invalid isd_ind [%c]\n", cTmp);
			iRet = INT_ERR;
		}
	}	
	else {
DEBUGLOG(("BOMmsBalance::PTMHandler: get isd_ind failed"));
ERRLOG("BOMmsBalance::PTMHandler: get isd_ind failed");
		iRet = INT_ERR;
	}
	
DEBUGLOG(("BOMmsBalance::PTMHandler: exit iRet = [%d]\n", iRet));
	
	return 	iRet;
}

int MTBHandler(hash_t *hRls)
{
        int     iRet = PD_OK;
        char    cTmp;

        if (GetField_Char(hRls,"isd_ind",&cTmp)) {
DEBUGLOG(("BOMmsBalance::MTBHandler: isd_ind [%c]\n", cTmp));
                if (cTmp == PD_SOURCE) {
                        /* MB Balance */
                        iRet = MBSourceBalance(hRls);

                } else if (cTmp == PD_DESTINATION ) {
                        /* Bank Balance */
                        iRet = BankDestBalance(hRls);
                } else {
DEBUGLOG(("BOMmsBalance::MTBHandler: invalid isd_ind [%c]\n", cTmp));
ERRLOG("BOMmsBalance::MTBHandler: invalid isd_ind [%c]\n", cTmp);
                        iRet = INT_ERR;
                }
        }
        else {
DEBUGLOG(("BOMmsBalance::MTBHandler: get isd_ind failed"));
ERRLOG("BOMmsBalance::MTBHandler: get isd_ind failed");
                iRet = INT_ERR;
        }

DEBUGLOG(("BOMmsBalance::MTBHandler: exit iRet = [%d]\n", iRet));

        return  iRet;
}

int PTPHandler(hash_t *hRls)
{
        int     iRet = PD_OK;
        char    cTmp;

        if (GetField_Char(hRls,"isd_ind",&cTmp)) {
DEBUGLOG(("BOMmsBalance::PTPHandler: isd_ind [%c]\n", cTmp));
                if (cTmp == PD_SOURCE) {
                        /* Source PSP Balance */
                        iRet = PspSourceBalance(hRls);

                } else if (cTmp == PD_DESTINATION ) {
                        /* Dest PSP Balance */
                        iRet = PspDestBalance(hRls);
                } else {
DEBUGLOG(("BOMmsBalance::PTPHandler: invalid isd_ind [%c]\n", cTmp));
ERRLOG("BOMmsBalance::PTPHandler: invalid isd_ind [%c]\n", cTmp);
                        iRet = INT_ERR;
                }
        }
        else {
DEBUGLOG(("BOMmsBalance::PTPHandler: get isd_ind failed"));
ERRLOG("BOMmsBalance::PTPHandler: get isd_ind failed");
                iRet = INT_ERR;
        }

DEBUGLOG(("BOMmsBalance::PTPHandler: exit iRet = [%d]\n", iRet));

        return  iRet;
}


int MTPHandler(hash_t *hRls)
{
        int     iRet = PD_OK;
        char    cTmp;

        if (GetField_Char(hRls,"isd_ind",&cTmp)) {
DEBUGLOG(("BOMmsBalance::MTPHandler: isd_ind [%c]\n", cTmp));
                if (cTmp == PD_SOURCE) {
                        /* MB Balance */
                        iRet = MBSourceBalance(hRls);

                } else if (cTmp == PD_DESTINATION ) {
                        /* PSP Balance */
                        iRet = PspDestBalance(hRls);
                } else {
DEBUGLOG(("BOMmsBalance::MTPHandler: invalid isd_ind [%c]\n", cTmp));
ERRLOG("BOMmsBalance::MTPHandler: invalid isd_ind [%c]\n", cTmp);
                        iRet = INT_ERR;
                }
        }
        else {
DEBUGLOG(("BOMmsBalance::MTPHandler: get isd_ind failed"));
ERRLOG("BOMmsBalance::MTPHandler: get isd_ind failed");
                iRet = INT_ERR;
        }

DEBUGLOG(("BOMmsBalance::MTPHandler: exit iRet = [%d]\n", iRet));

        return  iRet;
}

int BTBHandler(hash_t *hRls)
{
        int     iRet = PD_OK;
        char    cTmp;

        if (GetField_Char(hRls,"isd_ind",&cTmp)) {
DEBUGLOG(("BOMmsBalance::BTBHandler: isd_ind [%c]\n", cTmp));
                if (cTmp == PD_SOURCE) {
                        /* Source Bank Balance */
                        iRet = BankSourceBalance(hRls);

                } else if (cTmp == PD_DESTINATION ) {
                        /* Dest Bank Balance */
                        iRet = BankDestBalance(hRls);
                } else {
DEBUGLOG(("BOMmsBalance::BTBHandler: invalid isd_ind [%c]\n", cTmp));
ERRLOG("BOMmsBalance::BTBHandler: invalid isd_ind [%c]\n", cTmp);
                        iRet = INT_ERR;
                }
        }
        else {
DEBUGLOG(("BOMmsBalance::BTBHandler: get isd_ind failed"));
ERRLOG("BOMmsBalance::BTBHandler: get isd_ind failed");
                iRet = INT_ERR;
        }

DEBUGLOG(("BOMmsBalance::BTBHandler: exit iRet = [%d]\n", iRet));

        return  iRet;
}

int BTMHandler(hash_t *hRls)
{
        int     iRet = PD_OK;
        char    cTmp;

        if (GetField_Char(hRls,"isd_ind",&cTmp)) {
DEBUGLOG(("BOMmsBalance::BTMHandler: isd_ind [%c]\n", cTmp));
                if (cTmp == PD_SOURCE) {
                        /* Bank Balance */
                        iRet = BankSourceBalance(hRls);

                } else if (cTmp == PD_DESTINATION ) {
                        /* MB Balance */
                        iRet = MBDestBalance(hRls);
                } else {
DEBUGLOG(("BOMmsBalance::BTMHandler: invalid isd_ind [%c]\n", cTmp));
ERRLOG("BOMmsBalance::BTMHandler: invalid isd_ind [%c]\n", cTmp);
                        iRet = INT_ERR;
                }
        }
        else {
DEBUGLOG(("BOMmsBalance::BTMHandler: get isd_ind failed"));
ERRLOG("BOMmsBalance::BTMHandler: get isd_ind failed");
                iRet = INT_ERR;
        }

DEBUGLOG(("BOMmsBalance::BTMHandler: exit iRet = [%d]\n", iRet));

        return  iRet;
}

int CTBHandler(hash_t *hRls)
{
        int     iRet = PD_OK;
        char    cTmp;

        if (GetField_Char(hRls,"isd_ind",&cTmp)) {
DEBUGLOG(("BOMmsBalance::CTBHandler: isd_ind [%c]\n", cTmp));
                if (cTmp == PD_SOURCE) {
                        /* Merchant Balance */
                        iRet = MerchSourceBalance(hRls);

                } else if (cTmp == PD_DESTINATION ) {
                        /* Bank Balance */
                        iRet = BankDestBalance(hRls);
                } else {
DEBUGLOG(("BOMmsBalance::CTBHandler: invalid isd_ind [%c]\n", cTmp));
ERRLOG("BOMmsBalance::CTBHandler: invalid isd_ind [%c]\n", cTmp);
                        iRet = INT_ERR;
                }
        }
        else {
DEBUGLOG(("BOMmsBalance::CTBHandler: get isd_ind failed"));
ERRLOG("BOMmsBalance::CTBHandler: get isd_ind failed");
                iRet = INT_ERR;
        }

DEBUGLOG(("BOMmsBalance::CTBHandler: exit iRet = [%d]\n", iRet));

        return  iRet;
}


int GetPspCountry(hash_t *hRls)
{
	char *csPspId = NULL;
	char *csTxnCountry = NULL;
        hash_t  *hRec;
	int	iRet = PD_OK;

        recordset_t     *rRecordSet;


	if (GetField_CString(hRls, "txn_country", csTxnCountry)) {
DEBUGLOG(("GetPspCountry::country = [%s]\n",csTxnCountry));
		return iRet;
	}

        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOMmsBalance::GetPspCountry:Call PspCountry:GetPspCountry\n"));

	GetField_CString(hRls, "psp_id", &csPspId);

DEBUGLOG(("BOMmsBalance::GetPspContry:psp_id [%s]\n", csPspId));

	DBObjPtr = CreateObj(DBPtr,"DBPspCountry","GetPspCountry");
	if ((*DBObjPtr)(csPspId, rRecordSet) == PD_OK) {
DEBUGLOG(("GetPspCountry::found record = [%s]\n", csPspId));
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if (GetField_CString(hRec,"country",&csTxnCountry)) {
DEBUGLOG(("GetPspCountry::country = [%s]\n",csTxnCountry));
				PutField_CString(hRls, "txn_country", csTxnCountry);
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}	
	else{
DEBUGLOG(("GetPspCountry:: not found record for [%s]\n",csPspId));
ERRLOG("BOMmsBalance:GetPspCountry::GetPspCountry::not found record!!\n");
		iRet = INT_NOT_RECORD;
	}
        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

	return iRet;

}

int GetMerchCountryService(hash_t *hRls)
{
	char	*csTxnSeq = NULL;
	char	*csServiceCode = NULL;
	char    *csTxnCountry = NULL;
	int	iRet = PD_OK;

        hash_t  *hRec;
        recordset_t     *rRecordSet;

	if (GetField_CString(hRls, "txn_country", csTxnCountry) &&
	    GetField_CString(hRls, "service_code", csServiceCode)) {
DEBUGLOG(("GetPspCountry::country = [%s] service = [%s]\n",csTxnCountry, csServiceCode));
		return iRet;
	}

        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	/* Get Service From MmsTxnHeader */
DEBUGLOG(("BOMmsBalance::GetMerchCountryService:Call MmsTransaction:GetMmsTxnHeader\n"));

	GetField_CString(hRls, "txn_seq", &csTxnSeq);

DEBUGLOG(("BOMmsBalance::GetMerchCountryService:txn_seq [%s]\n", csTxnSeq));

	DBObjPtr = CreateObj(DBPtr,"DBMmsTransaction","GetMmsTxnHeader");
	if ((*DBObjPtr)(csTxnSeq, rRecordSet) == PD_OK) {
                hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {
                        if (GetField_CString(hRec,"service_code",&csServiceCode)) {
DEBUGLOG(("GetMerchCountryService::service_code = [%s]\n",csServiceCode));

				PutField_CString(hRls, "service_code", csServiceCode);
                        }
                        hRec = RecordSet_GetNext(rRecordSet);
                }
	}
	else {
DEBUGLOG(("GetMerchCountryService:: service_code not found for [%s]\n",csTxnSeq));
ERRLOG("BOMmsBalance:GetMerchCountryService::GetMmsTxnHeader::not found record!!\n");
		iRet = INT_NOT_RECORD;
	}

	/* Get Country by Service */
	if (iRet == PD_OK) {
DEBUGLOG(("BOMmsBalance::GetMerchCountryService:Call Service:FindCountryByService\n"));
		DBObjPtr = CreateObj(DBPtr,"DBService","FindCountryByService");
		if ((unsigned long)((*DBObjPtr)(csServiceCode, csTxnCountry)) == FOUND) {

DEBUGLOG(("GetMerchCountryService::country = [%s]\n",csTxnCountry));
			PutField_CString(hRls, "txn_country", csTxnCountry);
		}
		else {
DEBUGLOG(("GetMerchCountryService:: country not found for service [%s]\n",csTxnCountry));
ERRLOG("BOMmsBalance:GetMerchCountryService::Service::FindCountryByService::not found record!!\n");
			iRet = INT_NOT_RECORD;
		}
	}

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

	return iRet;

}

int IsNotFirstRec(hash_t *hRls)
{
	int	iRet = PD_OK;
	int	iTmpRet = PD_OK;

	char	*csTxnSeq;
	char	*csDtlTxnSeq;

        if (GetField_CString(hRls, "txn_seq", &csTxnSeq)) {
DEBUGLOG(("IsNotFirstRec::txn_seq = [%s]\n",csTxnSeq));
	}
	else {
DEBUGLOG(("IsNotFirstRec:txn_seq not found!!\n"));
ERRLOG("BOMmsBalance::IsNotFirstRec::txn_seq not found\n");
		iRet = INT_ERR;
	}

        if (GetField_CString(hRls, "dtl_txn_seq", &csDtlTxnSeq)) {
DEBUGLOG(("IsNotFirstRec::dtl_txn_seq = [%s]\n",csDtlTxnSeq));
        }
        else {
DEBUGLOG(("IsNotFirstRec:dtl_txn_seq not found!!\n"));
ERRLOG("BOMmsBalance::IsNotFirstRec::dtl_txn_seq not found\n");
                iRet = INT_ERR;
        }

        if (iRet == PD_OK) {
DEBUGLOG(("BOMmsBalance::IsNotFirstRec:Call MmsTransaction:ChkNonFirstProcessRecord\n"));

                DBObjPtr = CreateObj(DBPtr,"DBMmsTransaction","ChkNonFirstProcessRecord");
		iTmpRet = (unsigned long)(*DBObjPtr)(csTxnSeq, csDtlTxnSeq);

                if (iTmpRet == PD_FOUND) {
DEBUGLOG(("IsNotFistRec::FOUND Non-first record\n"));
                        PutField_Char(hRls, "found_record", PD_YES);
                }
                else if (iTmpRet == PD_NOT_FOUND) { 
DEBUGLOG(("IsNotFistRec::NOT FOUND Non-first record\n"));
                        PutField_Char(hRls, "found_record", PD_NO);
		} 
		else {
DEBUGLOG(("IsNotFirstRec::ChkNonFirstProcessRecord ERR\n"));
ERRLOG("BOMmsBalance::IsNotFirstRec::ChkNonFirstProcessRecord ERR\n");
                        iRet = INT_NOT_RECORD;
                }
        }

	return iRet;
}


int PspSourceBalance(hash_t *hRls)
{
	int	iRet = PD_OK;

	char	*csPspId = NULL;
	char	*csCountry = NULL;
	char	*csCcy = NULL;
	char	*csUpdateUser = NULL;

	double	dAmt = 0.0;
	double  dProcessingCost = 0.0;

	char 	cTmp;
        double  dAvaBalance = 0.0;


/* psp_id */
	if(GetField_CString(hRls,"psp_id",&csPspId)){
DEBUGLOG(("PspSourceBalance::psp_id = [%s]\n",csPspId));
	}
	else{
DEBUGLOG(("PspSourceBalance:psp_id not found!!\n"));
ERRLOG("BOMmsBalance::PspSourceBalance::psp_id not found\n");
		iRet = INT_ERR;
	}


/* Ccy */
	if(GetField_CString(hRls,"txn_ccy",&csCcy)){
DEBUGLOG(("PspSourceBalance::ccy = [%s]\n",csCcy));
	}
	else{
DEBUGLOG(("PspSourceBalance:ccy not found!!\n"));
ERRLOG("BOMmsBalance::PspSourceBalance::ccy Failed\n");
		iRet = INT_ERR;
	}

/* Update_user */
	if(GetField_CString(hRls,"update_user",&csUpdateUser)){
DEBUGLOG(("PspSourceBalance::update_user = [%s]\n",csUpdateUser));
	}
	else{
DEBUGLOG(("PspSourceBalance:update_user not found!!\n"));
ERRLOG("BOMmsBalance::PspSourceBalance::update_user Failed\n");
		iRet = INT_ERR;
	}

/* For in-transit */
/* Amt */
	if(GetField_Double(hRls,"txn_amt",&dAmt)){
DEBUGLOG(("PspSourceBalance::txn_amt = [%lf]\n",dAmt));
	}
	else{
DEBUGLOG(("PspSourceBalance:txn_amt not found!!\n"));
ERRLOG("BOMmsBalance::PspSourceBalance::txn_amt Failed\n");
		iRet = INT_ERR;
	}

/* For processing_cost */
	if(GetField_Double(hRls,"processing_cost",&dProcessingCost)){
DEBUGLOG(("PspSourceBalance::processing_cost = [%lf]\n",dProcessingCost));
	}
	else{
DEBUGLOG(("PspSourceBalance:processing_cost not found!!\n"));
		dProcessingCost = 0.0;
	}


/* Get Country */
	if (iRet == PD_OK){
		if (GetPspCountry(hRls) == PD_OK) {
			if (GetField_CString(hRls, "txn_country", &csCountry)) {
DEBUGLOG(("PspSourceBalance::txn-country = [%s]\n",csCountry));
			}
			else {
DEBUGLOG(("PspSourceBalance::txn_country Failed\n"));
ERRLOG("BOMmsBalance::PspSourceBalance::txn_country Failed\n");

				iRet = INT_ERR;
			}
		} else {
DEBUGLOG(("PspSourceBalance::GetPspCountry Failed\n"));
ERRLOG("BOMmsBalance::PspSourceBalance::GetPpsCountry Failed\n");
			iRet = INT_ERR;
		}
	}


/* Debit Balance - Amt */
	if (iRet == PD_OK){

                if (iRet == PD_OK) {
DEBUGLOG(("BOMmsBalance::PspSourceBalance::Call BOBalance:GetAvalPspBalanceForUpdate\n"));
                        BOObjPtr = CreateObj(BOPtr,"BOBalance","GetAvalPspBalanceForUpdate");
                        if((unsigned long)((*BOObjPtr)(csCountry, csCcy, csPspId, &dAvaBalance) != PD_OK)) {
DEBUGLOG(("BOMmsBalance::PspSourceBalance::BOBalance:GetAvalPspBalanceForUpdate Failed\n"));
ERRLOG("BOMmsBalance::PspSourceBalance::BOBalance:GetAvalPspBalanceForUpdate Failed\n");
                                iRet=INT_ERR;
                        }
                        else {
DEBUGLOG(("BOMmsBalance::PspSourceBalance::PSP Balance [%lf]\n", dAvaBalance));
                        }
                }

		if (iRet == PD_OK) {
			if (dAvaBalance - dAmt - dProcessingCost <  0) {
DEBUGLOG(("PspSourceBalance::Not enought Ava Balance for pps [%s] balance [%lf] amt [%lf] processing_cost [%lf]\n", csPspId, dAvaBalance, dAmt, dProcessingCost));
				iRet = INT_ERR;
			}	
		}

		if (iRet == PD_OK) {
			iRet = IsNotFirstRec(hRls);
		}

		if (iRet == PD_OK) {

			/****** only debit Amt while has previous record found for prevent duplicate debit *****/

			if (GetField_Char(hRls, "found_record", &cTmp)) {
DEBUGLOG(("PspSourceBalance::found_record [%c]\n", cTmp));

				if (cTmp == PD_YES) {

DEBUGLOG(("PspSourceBalance::Call DBPspBalance:DebitBalance:Amt\n"));
					DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
					if ((*DBObjPtr)(csPspId,csCountry, csCcy, PD_PSP_BAL, dAmt, csUpdateUser) != PD_OK) {
DEBUGLOG(("PspSourceBalance::DBPspBalance:DebitBalance Failed:Amt\n"));
ERRLOG("BOMmsBalance::PspSourceBalance::Debit Balance - Amt failed\n");
						iRet = INT_ERR;
					}

				}
				else {
DEBUGLOG(("PspSourceBalance::Not need to debit Amt\n"));
				}
			} 
			else {
DEBUGLOG(("PspSourceBalance::found_record fail\n"));
ERRLOG("BOMmsBalance::PspSourceBalance::found_record fail\n");
				iRet = INT_ERR;
			}
		}
		else {
DEBUGLOG(("PspSourceBalance::IsNotFirstRec fail\n"));
		}
	}


/* Debit Balance - Processing Cost */
	if ((iRet == PD_OK) && (dProcessingCost > 0)) {
DEBUGLOG(("PspSourceBalance::Call DBPspBalance:DebitBalance:ProcessingCost\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
		if ((*DBObjPtr)(csPspId,csCountry, csCcy, PD_PSP_BAL, dProcessingCost, csUpdateUser) != PD_OK) {
DEBUGLOG(("PspSourceBalance::DBPspBalance:DebitBalance Failed:ProcessingCost\n"));
ERRLOG("BOMmsBalance::PspSourceBalance::Debit Balance - ProcessingCost failed\n");
			iRet = INT_ERR;
		}
	}


	return iRet;		
 	
}

int MBSourceBalance(hash_t *hRls)
{
        int     iRet = PD_OK;

        char    *csMBId = NULL;
        char    *csCcy = NULL;
        char    *csUpdateUser = NULL;

        double  dAmt = 0.0;

/* mb_id */
        if(GetField_CString(hRls,"mb_id",&csMBId)){
DEBUGLOG(("MBSourceBalance::mb_id = [%s]\n",csMBId));
        }
        else{
DEBUGLOG(("MBSourceBalance:mb_id not found!!\n"));
ERRLOG("BOMmsBalance::MBSourceBalance::mb_id not found\n");
                iRet = INT_ERR;
        }

/* Ccy */
        if(GetField_CString(hRls,"txn_ccy",&csCcy)){
DEBUGLOG(("MBSourceBalance::ccy = [%s]\n",csCcy));
        }
        else{
DEBUGLOG(("MBSourceBalance:ccy not found!!\n"));
ERRLOG("BOMmsBalance::MBSourceBalance::ccy Failed\n");
                iRet = INT_ERR;
        }

/* Update_user */
        if(GetField_CString(hRls,"update_user",&csUpdateUser)){
DEBUGLOG(("MBSourceBalance::update_user = [%s]\n",csUpdateUser));
        }
        else{
DEBUGLOG(("MBSourcealance:update_user not found!!\n"));
ERRLOG("BOMmsBalance::MBSouceBalance::update_user Failed\n");
                iRet = INT_ERR;
        }

/* For in-transit */
/* Amt */
        if(GetField_Double(hRls,"txn_amt",&dAmt)){
DEBUGLOG(("MBSourceBalance::txn_amt = [%lf]\n",dAmt));
        }
        else{
DEBUGLOG(("MBSourceBalance:txn_amt not found!!\n"));
ERRLOG("BOMmsBalance::MBSourceBalance::txn_amt Failed\n");
                iRet = INT_ERR;
        }

/* Debit Balance - Amt*/
        if ((iRet == PD_OK) && (dAmt > 0)) {
DEBUGLOG(("MBSourceBalance::Call DBMmsMBBalance:DebitBalance:Amt\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMmsMBBalance","DebitBalance");
                if ((*DBObjPtr)(csMBId,csCcy, dAmt, csUpdateUser) != PD_OK) {
DEBUGLOG(("MBSourceBalance::DBMmsMBBalance:DebitBalance Failed:Amt\n"));
ERRLOG("BOMmsBalance::MBSourceBalance::Debit Balance - Amt failed\n");
                        iRet = INT_ERR;
                }
        }
	return iRet;

}

int BankSourceBalance(hash_t *hRls)
{
        int     iRet = PD_OK;

        char    *csBankId = NULL;
        char    *csCcy = NULL;
        char    *csUpdateUser = NULL;

        double  dAmt = 0.0;
        double  dProcessingCost = 0.0;


/* bank_id */
        if(GetField_CString(hRls,"bank_id",&csBankId)){
DEBUGLOG(("BankSourceBalance::bank_id = [%s]\n",csBankId));
        }
        else{
DEBUGLOG(("BankSourceBalance:bank_id not found!!\n"));
ERRLOG("BOMmsBalance::BankSourceBalance::bank_id not found\n");
                iRet = INT_ERR;
        }

/* Ccy */
        if(GetField_CString(hRls,"txn_ccy",&csCcy)){
DEBUGLOG(("BankSourceBalance::ccy = [%s]\n",csCcy));
        }
        else{
DEBUGLOG(("BankSourceBalance:ccy not found!!\n"));
ERRLOG("BOMmsBalance::BankSourceBalance::ccy Failed\n");
                iRet = INT_ERR;
        }

/* Update_user */
        if(GetField_CString(hRls,"update_user",&csUpdateUser)){
DEBUGLOG(("BankSourceBalance::update_user = [%s]\n",csUpdateUser));
        }
        else{
DEBUGLOG(("BankSourceBalance:update_user not found!!\n"));
ERRLOG("BOMmsBalance::BankSourceBalance::update_user Failed\n");
                iRet = INT_ERR;
        }

/* For in-transit */
/* Amt */
        if(GetField_Double(hRls,"txn_amt",&dAmt)){
DEBUGLOG(("BankSourceBalance::txn_amt = [%lf]\n",dAmt));
        }
        else{
DEBUGLOG(("BankSourceBalance:txn_amt not found!!\n"));
ERRLOG("BOMmsBalance::BankSourceBalance::txn_amt Failed\n");
                iRet = INT_ERR;
        }

/* For processing_cost */
        if(GetField_Double(hRls,"processing_cost",&dProcessingCost)){
DEBUGLOG(("BankSourceBalance::processing_cost = [%lf]\n",dProcessingCost));
        }
        else{
DEBUGLOG(("BankSourceBalance:processing_cost not found!!\n"));
                dProcessingCost = 0.0;
        }

/* Debit Balance - Amt */
        if ((iRet == PD_OK) && (dAmt > 0)) {
DEBUGLOG(("BankDestBalance::Call DBMmsBankBalance:DebitBalance:Amt\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMmsBankBalance","DebitBalance");
                if ((*DBObjPtr)(csBankId,csCcy, dAmt, csUpdateUser) != PD_OK) {
DEBUGLOG(("BankDestBalance::DBMmsBankBalance:DebitBalance Failed:Amt\n"));
ERRLOG("BOMmsBalance::BankDestBalance::Debit Balance - Amt failed\n");
                        iRet = INT_ERR;
                }
        }

/* Debit Balance - Processing Cost*/
        if ((iRet == PD_OK) && (dProcessingCost > 0)) {
DEBUGLOG(("BankDestBalance::Call DBMmsBankBalance:DebitBalance:ProcessingCost\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMmsBankBalance","DebitBalance");
                if ((*DBObjPtr)(csBankId,csCcy, dProcessingCost, csUpdateUser) != PD_OK) {
DEBUGLOG(("BankDestBalance::DBMmsBankBalance:DebitBalance Failed:ProcessingCost\n"));
ERRLOG("BOMmsBalance::BankDestBalance::Debit Balance - Processing Cost failed\n");
                        iRet = INT_ERR;
                }
        }

        return iRet;

}

int MerchSourceBalance(hash_t *hRls)
{
        int     iRet = PD_OK;

        char    *csMerchId = NULL;
        char    *csCountry = NULL;
        char    *csService = NULL;
        char    *csCcy = NULL;
        char    *csUpdateUser = NULL;
	char	*csTxnSeq = NULL;

        double  dAmt = 0.0;
        double  dProcessingCost = 0.0;


/* txn_seq */
        if(GetField_CString(hRls,"txn_seq",&csTxnSeq)){
DEBUGLOG(("MerchSourceBalance::txn_seq = [%s]\n",csMerchId));
        }
        else{
DEBUGLOG(("MerchSourceBalance:txn_seq not found!!\n"));
ERRLOG("BOMmsBalance::MerchSourceBalance::txn_seq not found\n");
                iRet = INT_ERR;
        }

/* merchant_id */
        if(GetField_CString(hRls,"merchant_id",&csMerchId)){
DEBUGLOG(("MerchSourceBalance::merchant_id = [%s]\n",csMerchId));
        }
        else{
DEBUGLOG(("MerchSourceBalance:merchant_id not found!!\n"));
ERRLOG("BOMmsBalance::MerchSourceBalance::merchant_id not found\n");
                iRet = INT_ERR;
        }


/* Ccy */
        if(GetField_CString(hRls,"txn_ccy",&csCcy)){
DEBUGLOG(("MerchSourceBalance::ccy = [%s]\n",csCcy));
        }
        else{
DEBUGLOG(("MerchSourceBalance:ccy not found!!\n"));
ERRLOG("BOMmsBalance::MerchSourceBalance::ccy Failed\n");
                iRet = INT_ERR;
        }

/* Update_user */
        if(GetField_CString(hRls,"update_user",&csUpdateUser)){
DEBUGLOG(("MerchSourceBalance::update_user = [%s]\n",csUpdateUser));
        }
        else{
DEBUGLOG(("MerchSourceBalance:update_user not found!!\n"));
ERRLOG("BOMmsBalance::MerchSourceBalance::update_user Failed\n");
                iRet = INT_ERR;
        }

/* For in-transit */
/* Amt */
        if(GetField_Double(hRls,"txn_amt",&dAmt)){
DEBUGLOG(("MerchSourceBalance::txn_amt = [%lf]\n",dAmt));
        }
        else{
DEBUGLOG(("MerchSourceBalance:txn_amt not found!!\n"));
ERRLOG("BOMmsBalance::MerchSourceBalance::txn_amt Failed\n");
                iRet = INT_ERR;
        }

/* For processing_cost */
        if(GetField_Double(hRls,"processing_cost",&dProcessingCost)){
DEBUGLOG(("MerchSourceBalance::processing_cost = [%lf]\n",dProcessingCost));
        }
        else{
DEBUGLOG(("MerchSourceBalance:processing_cost not found!!\n"));
                dProcessingCost = 0.0;
        }

/* Get Country and Service */
        if (iRet == PD_OK){
                if (GetMerchCountryService(hRls) == PD_OK) {

                        if (GetField_CString(hRls, "service_code", &csService)) {
DEBUGLOG(("MerchSourceBalance::service_code = [%s]\n",csService));
                        }
                        else {
DEBUGLOG(("MerchSourceBalance::service_code Failed\n"));
ERRLOG("BOMmsBalance::MerchSourceBalance::service_code Failed\n");
				iRet = INT_ERR;
                        }

                        if (GetField_CString(hRls, "txn_country", &csCountry)) {
DEBUGLOG(("MerchSourceBalance::txn_country = [%s]\n",csCountry));
                        }
                        else {
DEBUGLOG(("MerchSourceBalance::txn_country Failed\n"));
ERRLOG("BOMmsBalance::MerchSourceBalance::txn_country Failed\n");
				iRet = INT_ERR;
                        }

                } else {
DEBUGLOG(("MerchSourceBalance::GetMerchCountryService Failed\n"));
ERRLOG("BOMmsBalance::MerchSourceBalance::GetMerchCountryService Failed\n");
                        iRet = INT_ERR;
                }
        }


/* Debit Balance - Amt */
        if (iRet == PD_OK) {
DEBUGLOG(("MerchSourceBalance::Call DBMerchantBalance:UpdateAvalBal:Amt\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateAvalBal");
                if ((*DBObjPtr)(csMerchId,csCountry, csCcy, csService, dAmt * (-1), csUpdateUser) != PD_OK) {
DEBUGLOG(("MerchSourceBalance::DBMerchantBalance:UpdateAvalBal:Debit Failed:Amt\n"));
ERRLOG("BOMmsBalance::MerchSourceBalance::Debit Balance - Amt failed\n");
                        iRet = INT_ERR;
                }
        }


/* Debit Balance - Processing Cost */
        if ((iRet == PD_OK) && (dProcessingCost > 0)) {
DEBUGLOG(("MerchSourceBalance::Call DBMerchantBalance:UpdateAvalBal:Processing Cost\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateAvalBal");
                if ((*DBObjPtr)(csMerchId,csCountry, csCcy, csService, dProcessingCost * (-1), csUpdateUser) != PD_OK) {
DEBUGLOG(("MerchSourceBalance::DBMerchantBalance:UpdateAvalBal:Debit Failed:Processing Cost\n"));
ERRLOG("BOMmsBalance::MerchSourceBalance::Debit Balance - Processing Cost failed\n");
                        iRet = INT_ERR;
                }
        }

        return iRet;   

}


int PspDestBalance(hash_t *hRls)
{
        int     iRet = PD_OK;

        char    *csPspId = NULL;
        char    *csCountry = NULL;
        char    *csCcy = NULL;
        char    *csUpdateUser = NULL;

        double  dAmt = 0.0;
        double  dProcessingCost = 0.0;
        double  dBankCharge = 0.0;

	double  dAvaBalance = 0.0;


/* psp_id */
        if(GetField_CString(hRls,"psp_id",&csPspId)){
DEBUGLOG(("PspDestBalance::psp_id = [%s]\n",csPspId));
        }
        else{
DEBUGLOG(("PspDestBalance:psp_id not found!!\n"));
ERRLOG("BOMmsBalance::PspDestBalance::psp_id not found\n");
                iRet = INT_ERR;
        }

/* Ccy */
        if(GetField_CString(hRls,"txn_ccy",&csCcy)){
DEBUGLOG(("PspDestBalance::ccy = [%s]\n",csCcy));
        }
        else{
DEBUGLOG(("PspDestBalance:ccy not found!!\n"));
ERRLOG("BOMmsBalance::PspDestBalance::ccy Failed\n");
                iRet = INT_ERR;
        }

/* Update_user */
        if(GetField_CString(hRls,"update_user",&csUpdateUser)){
DEBUGLOG(("PspDestBalance::update_user = [%s]\n",csUpdateUser));
        }
        else{
DEBUGLOG(("PspDestBalance:update_user not found!!\n"));
ERRLOG("BOMmsBalance::PspDestBalance::update_user Failed\n");
                iRet = INT_ERR;
        }

/* For in-transit */
/* Amt */
        if(GetField_Double(hRls,"txn_amt",&dAmt)){
DEBUGLOG(("PspDestBalance::txn_amt = [%lf]\n",dAmt));
        }
        else{
DEBUGLOG(("PspDestBalance:txn_amt not found!!\n"));
ERRLOG("BOMmsBalance::PspDestBalance::txn_amt Failed\n");
                iRet = INT_ERR;
        }

/* For processing_cost */
        if(GetField_Double(hRls,"processing_cost",&dProcessingCost)){
DEBUGLOG(("PspDestBalance::processing_cost = [%lf]\n",dProcessingCost));
        }
        else{
DEBUGLOG(("PspDestBalance:processing_cost not found!!\n"));
                dProcessingCost = 0.0;
        }

/* For bank_charge */
        if(GetField_Double(hRls,"bank_charge",&dBankCharge)){
DEBUGLOG(("PspDestBalance::bank_charge = [%lf]\n",dBankCharge));
        }
        else{
DEBUGLOG(("PspDestBalance:bank_charge not found!!\n"));
                dBankCharge = 0.0;
        }




                if (iRet == PD_OK) {
DEBUGLOG(("BOMmsBalance::PspDestBalance::Call BOBalance:GetAvalPspBalanceForUpdate\n"));
                        BOObjPtr = CreateObj(BOPtr,"BOBalance","GetAvalPspBalanceForUpdate");
                        if((unsigned long)((*BOObjPtr)(csCountry, csCcy, csPspId, &dAvaBalance) != PD_OK)) {
DEBUGLOG(("BOMmsBalance::PspDestBalance::BOBalance:GetAvalPspBalanceForUpdate Failed\n"));
ERRLOG("BOMmsBalance::PspDestBalance::BOBalance:GetAvalPspBalanceForUpdate Failed\n");
                                iRet=INT_ERR;
                        }
                        else {
DEBUGLOG(("BOAdjustment::ProcessPartyBalance::PSP Balance [%lf]\n", dAvaBalance));
                        }

                }

		if (iRet == PD_OK) {
			if ((dAvaBalance + dAmt - dProcessingCost - dBankCharge) < 0) {
DEBUGLOG(("PspDestBalance::Not enought Ava Balance for pps [%s] balance [%lf] amt [%lf] processing_cost [%lf] BankCharge [%lf]\n", csPspId, dAvaBalance, dAmt, dProcessingCost, dBankCharge));
                                iRet = INT_ERR;
			}
		}




/* Credit Balance - Amt*/
        if ((iRet == PD_OK) && (dAmt > 0)) {
DEBUGLOG(("PspDestBalance::Call DBPspBalance:CreditBalance:Amt\n"));
                DBObjPtr = CreateObj(DBPtr,"DBPspBalance","CreditBalance");
                if ((*DBObjPtr)(csPspId,csCountry, csCcy, PD_PSP_BAL, dAmt, csUpdateUser) != PD_OK) {
DEBUGLOG(("PspDestBalance::DBPspBalance:CreditBalance Failed:Amt\n"));
ERRLOG("BOMmsBalance::PspDestBalance::Credit Balance - Amt failed\n");
                        iRet = INT_ERR;
                }
        }

/* Debit Balance - Processing Cost */
        if ((iRet == PD_OK) && (dProcessingCost > 0)) {
DEBUGLOG(("PspDestBalance::Call DBPspBalance:DebitBalance:ProcessingCost\n"));
                DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
                if ((*DBObjPtr)(csPspId,csCountry, csCcy, PD_PSP_BAL, dProcessingCost, csUpdateUser) != PD_OK) {
DEBUGLOG(("PspDestBalance::DBPspBalance:DebitBalance Failed:ProcessingCost\n"));
ERRLOG("BOMmsBalance::PspDestBalance::Debit Balance - ProcessingCost failed\n");
                        iRet = INT_ERR;
                }
        }

/* Debit Balance - Bank Charge */
        if ((iRet == PD_OK) && (dBankCharge > 0)) {
DEBUGLOG(("PspDestBalance::Call DBPspBalance:DebitBalance:Bank Charge\n"));
                DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
                if ((*DBObjPtr)(csPspId,csCountry, csCcy, PD_PSP_BAL, dBankCharge, csUpdateUser) != PD_OK) {
DEBUGLOG(("PspDestBalance::DBPspBalance:DebitBalance Failed:Bank Charge\n"));
ERRLOG("BOMmsBalance::PspDestBalance::Debit Balance - Bank Charge failed\n");
                        iRet = INT_ERR;
                }
        }

	return iRet;


}


int MBDestBalance(hash_t *hRls)
{
	int	iRet = PD_OK;

	char	*csMBId = NULL;
	char	*csCcy = NULL;
	char	*csUpdateUser = NULL;

	double	dAmt = 0.0;
	double  dProcessingCost = 0.0;
	double	dBankCharge = 0.0;


/* mb_id */
	if(GetField_CString(hRls,"mb_id",&csMBId)){
DEBUGLOG(("MBDestBalance::mb_id = [%s]\n",csMBId));
	}
	else{
DEBUGLOG(("MBDestBalance:mb_id not found!!\n"));
ERRLOG("BOMmsBalance::MBDestBalance::mb_id not found\n");
		iRet = INT_ERR;
	}

/* Ccy */
	if(GetField_CString(hRls,"txn_ccy",&csCcy)){
DEBUGLOG(("MBDestBalance::ccy = [%s]\n",csCcy));
	}
	else{
DEBUGLOG(("MBDestBalance:ccy not found!!\n"));
ERRLOG("BOMmsBalance::MBDestBalance::ccy Failed\n");
		iRet = INT_ERR;
	}

/* Update_user */
	if(GetField_CString(hRls,"update_user",&csUpdateUser)){
DEBUGLOG(("MBDestBalance::update_user = [%s]\n",csUpdateUser));
	}
	else{
DEBUGLOG(("MBDestBalance:update_user not found!!\n"));
ERRLOG("BOMmsBalance::MBDestBalance::update_user Failed\n");
		iRet = INT_ERR;
	}

/* For in-transit */
/* Amt */
	if(GetField_Double(hRls,"txn_amt",&dAmt)){
DEBUGLOG(("MBDestBalance::txn_amt = [%lf]\n",dAmt));
	}
	else{
DEBUGLOG(("MBDestBalance:txn_amt not found!!\n"));
ERRLOG("BOMmsBalance::MBDestBalance::txn_amt Failed\n");
		iRet = INT_ERR;
	}

/* For processing_cost */
	if(GetField_Double(hRls,"processing_cost",&dProcessingCost)){
DEBUGLOG(("MBDestBalance::processing_cost = [%lf]\n",dProcessingCost));
	}
	else{
DEBUGLOG(("MBDestBalance:processing_cost not found!!\n"));
		dProcessingCost = 0.0;
	}

/* For bank_charge */
	if(GetField_Double(hRls,"bank_charge",&dBankCharge)){
DEBUGLOG(("MBDestBalance::bank_charge = [%lf]\n",dBankCharge));
	}
	else{
DEBUGLOG(("MBDestBalance:bank_charge not found!!\n"));
		dBankCharge = 0.0;
	}


/* Credit Balance - Amt */

	if (iRet == PD_OK){
DEBUGLOG(("MBDestBalance::Call DBMmsMBBalance:CreditBalance:Amt\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMmsMBBalance","CreditBalance");
		if ((*DBObjPtr)(csMBId, csCcy, dAmt, csUpdateUser) != PD_OK) {
DEBUGLOG(("MBDestBalance::DBMmsMBBalance:CreditBalance Failed:Amt\n"));
ERRLOG("BOMmsBalance::MBDestBalance::CreditBalance - Amt failed\n");
			iRet = INT_ERR;
		}
	}

/* Debit Balance - Processing Cost */
	if ((iRet == PD_OK) && (dProcessingCost > 0)) {
DEBUGLOG(("MBDestBalance::Call DBMmsMBBalance:DebitBalance:ProcessingCost\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMmsMBBalance","DebitBalance");
		if ((*DBObjPtr)(csMBId,csCcy, dProcessingCost, csUpdateUser) != PD_OK) {
DEBUGLOG(("MBDestBalance::DBMmsMBBalance:DebitBalance Failed:ProcessingCost\n"));
ERRLOG("BOMmsBalance::MBDestBalance::Debit Balance - ProcessingCost failed\n");
			iRet = INT_ERR;
		}
	}

/* Debit Balance - Bank Charge */
	if ((iRet == PD_OK) && (dBankCharge > 0)) {
DEBUGLOG(("MBDestBalance::Call DBMmsMBBalance:DebitBalance:Bank Charge\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMmsMBBalance","DebitBalance");
		if ((*DBObjPtr)(csMBId,csCcy, dBankCharge, csUpdateUser) != PD_OK) {
DEBUGLOG(("MBDestBalance::DBMmsMBBalance:DebitBalance Failed:Bank Charge\n"));
ERRLOG("BOMmsBalance::MBDestBalance::Debit Balance - Bank Charge failed\n");
			iRet = INT_ERR;
		}
	}

	return iRet;		
 	
}


int	BankDestBalance(hash_t *hRls)
{
       int     iRet = PD_OK;

        char    *csBankId = NULL;
        char    *csCcy = NULL;
        char    *csUpdateUser = NULL;

        double  dAmt = 0.0;
        double  dBankCharge = 0.0;


/* bank_id */
        if(GetField_CString(hRls,"bank_id",&csBankId)){
DEBUGLOG(("BankDestBalance::bank_id = [%s]\n",csBankId));
        }
        else{
DEBUGLOG(("BankDestBalance:bank_id not found!!\n"));
ERRLOG("BOMmsBalance::BankDestBalance::bank_id not found\n");
                iRet = INT_ERR;
        }

/* Ccy */
        if(GetField_CString(hRls,"txn_ccy",&csCcy)){
DEBUGLOG(("BankDestBalance::ccy = [%s]\n",csCcy));
        }
        else{
DEBUGLOG(("BankDestBalance:ccy not found!!\n"));
ERRLOG("BOMmsBalance::BankDestBalance::ccy Failed\n");
                iRet = INT_ERR;
        }

/* Update_user */
        if(GetField_CString(hRls,"update_user",&csUpdateUser)){
DEBUGLOG(("BankDestBalance::update_user = [%s]\n",csUpdateUser));
        }
        else{
DEBUGLOG(("BankDestBalance:update_user not found!!\n"));
ERRLOG("BOMmsBalance::BankDestBalance::update_user Failed\n");
                iRet = INT_ERR;
        }

/* For in-transit */
/* Amt */
        if(GetField_Double(hRls,"txn_amt",&dAmt)){
DEBUGLOG(("BankDestBalance::txn_amt = [%lf]\n",dAmt));
        }
        else{
DEBUGLOG(("BankDestBalance:txn_amt not found!!\n"));
ERRLOG("BOMmsBalance::BankDestBalance::txn_amt Failed\n");
                iRet = INT_ERR;
        }

/* For bank_charge */
        if(GetField_Double(hRls,"bank_charge",&dBankCharge)){
DEBUGLOG(("BankDestBalance::bank_charge = [%lf]\n",dBankCharge));
        }
        else{
DEBUGLOG(("BankDestBalance:bank_charge not found!!\n"));
                dBankCharge = 0.0;
        }


/* Credit Balance - Amt */
        if (iRet == PD_OK){
DEBUGLOG(("BankDestBalance::Call DBMmsBankBalance:CreditBalance:Amt\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMmsBankBalance","CreditBalance");
                if ((*DBObjPtr)(csBankId, csCcy, dAmt, csUpdateUser) != PD_OK) {
DEBUGLOG(("BankDestBalance::DBMmsBankBalance:CreditBalance Failed:Amt\n"));
ERRLOG("BOMmsBalance::BankDestBalance::CreditBalance - Amt failed\n");
                        iRet = INT_ERR;
                }
        }

/* Debit Balance - Bank Charge */
        if ((iRet == PD_OK) && (dBankCharge > 0)) {
DEBUGLOG(("BankDestBalance::Call DBMmsBankBalance:DebitBalance:Bank Charge\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMmsBankBalance","DebitBalance");
                if ((*DBObjPtr)(csBankId,csCcy, dBankCharge, csUpdateUser) != PD_OK) {
DEBUGLOG(("BankDestBalance::DBMmsBankBalance:DebitBalance Failed:Bank Charge\n"));
ERRLOG("BOMmsBalance::BankDestBalance::Debit Balance - Bank Charge failed\n");
                        iRet = INT_ERR;
                }
        }

	return iRet;

}


