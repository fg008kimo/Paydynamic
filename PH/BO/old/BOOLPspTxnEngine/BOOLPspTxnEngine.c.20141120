/*
Partnerdelight (c)2014. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/11/14              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "dbutility.h"
#include "BOOLPspTxnEngine.h"
#include "myrecordset.h"
#include "myhash.h"
#include "math.h"
#include <time.h>

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);


void BOOLPspTxnEngine(char cdebug)
{
	cDebug = cdebug;
}


int	DoAction(hash_t* hContext);
int	GetTxnDetail(const char* csLevel, const char* csTxnId, hash_t* hTxn, const int iIsPostedTxn);
void	ConvertHash(const hash_t* hIn, hash_t* hOut, const int iIdx, const char* csMode);
int	RunSpecialAction(const int iActionId, hash_t* hTxn);
int	DoPostTxn(hash_t* hContext,hash_t* hRequest);
int	DoUpdateTxn(hash_t* hContext,hash_t* hRequest);


int	DoAction(hash_t* hContext)
{
	int iRet = PD_OK;

	int  i = 0;
	int  iTxnCnt = 0;
	int  iPostedTxnCnt = 0;
	int  iBaidTxnCnt = 0;
	int  iPostedBaidTxnCnt = 0;
	int  iLoopCnt = 0;
	int  iRunRule = PD_FALSE;
	int  iTotalCnt = 0;
	int  iNextAction = PD_FALSE;
	int  iTmp = 0;
	int  iTxnAction = 0;
	char *csTmp= NULL;
	char  csTag[PD_TAG_LEN+1];
	char  cInBaidTxn;
	char  cInPostBaidTxn;
	char  cInTxn;
	char  cInPostTxn;
	char *csTxnId;
        char *csBaidTxnId;

	hash_t          *hRec;
	hash_t          *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

	hash_t          *hDetail;
	hDetail = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hDetail,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	//get action (classify,reconcile,etc...)
	if(GetField_CString(hContext,"action",&csTmp)){
		PutField_CString(hTxn,"next_action",csTmp);
DEBUGLOG(("DoAction:: action = [%s]\n", csTmp));
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("DoAction:: action is missing!!!\n"));
ERRLOG("BOOLPspTxnEngine: DoAction:: action is missing!!!\n");
	}
	
	//get trigger_type (auto, manual)
	if(GetField_CString(hContext,"trigger_type",&csTmp)){
		PutField_CString(hTxn,"trigger_type",csTmp);
DEBUGLOG(("DoAction:: trigger_type = [%s]\n", csTmp));
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("DoAction:: trigger_type is missing!!!\n"));
ERRLOG("BOOLPspTxnEngine: DoAction:: trigger_type is missing!!!\n");
	}

	//input_channel (SMS,OMT)
	if(GetField_CString(hContext,"input_channel",&csTmp)){
		PutField_CString(hTxn,"input_channel",csTmp);
DEBUGLOG(("DoAction:: input_channel = [%s]\n", csTmp));
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("DoAction:: input_channel is missing!!!\n"));
ERRLOG("BOOLPspTxnEngine: DoAction:: input_channel is missing!!!\n");
	}

	//get all txn details by txn_id and baid_txn_id
	if (iRet == PD_OK) {
		//get txn_cnt, baid_txn_cnt
		if(GetField_Int(hContext, "txn_cnt", &iTxnCnt)) {
			PutField_Int(hTxn,"txn_cnt",iTxnCnt);
DEBUGLOG(("DoAction:: txn_cnt = [%d]\n", iTxnCnt));
		}
		if(GetField_Int(hContext, "baid_txn_cnt", &iBaidTxnCnt)) {
			PutField_Int(hTxn,"baid_txn_cnt",iBaidTxnCnt);
DEBUGLOG(("DoAction:: baid_txn_cnt = [%d]\n", iBaidTxnCnt));
		}
		if(GetField_Int(hContext, "posted_txn_cnt", &iPostedTxnCnt)){
DEBUGLOG(("DoAction:: posted_txn_cnt = [%d]\n", iPostedTxnCnt));
		}
		if(GetField_Int(hContext, "posted_baid_txn_cnt", &iPostedBaidTxnCnt)){
DEBUGLOG(("DoAction:: posted_baid_txn_cnt = [%d]\n", iPostedBaidTxnCnt));
		}

		if(iBaidTxnCnt>iTxnCnt)
			iTotalCnt = iBaidTxnCnt;
		else
			iTotalCnt = iTxnCnt;

		for(i=0; i<iTxnCnt; i++){
			hash_init(hDetail,0);
			sprintf(csTag,"txn_id_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
				if(GetTxnDetail(PD_TXN_HEADER_LEVEL,csTmp,hDetail,PD_FALSE)!=PD_OK){
					iRet = INT_ERR;
				}
				else{
					ConvertHash(hDetail,hTxn,i,PD_SINGLE_TO_MULTIPLE);
				}
			}
		}

		for(i=0; i<iBaidTxnCnt; i++){
			hash_init(hDetail,0);
			sprintf(csTag,"baid_txn_id_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
				if(GetTxnDetail(PD_BAID_TXN_LEVEL,csTmp,hDetail,PD_FALSE)!=PD_OK){
					iRet = INT_ERR;
				}
				else{
					ConvertHash(hDetail,hTxn,i,PD_SINGLE_TO_MULTIPLE);
				}
			}
		}

		if(iPostedTxnCnt>0){
			hash_init(hDetail,0);
			if(GetField_CString(hContext,"posted_txn_id",&csTmp)){
				PutField_CString(hTxn,"posted_txn_id",csTmp);
				if(GetTxnDetail(PD_TXN_HEADER_LEVEL,csTmp,hDetail,PD_TRUE)!=PD_OK){
					iRet = INT_ERR;
				}
				else{
					ConvertHash(hDetail,hTxn,0,PD_SINGLE_TO_MULTIPLE);
				}
			}
		}
		if(iPostedBaidTxnCnt>0){
			hash_init(hDetail,0);
			if(GetField_CString(hContext,"posted_baid_txn_id",&csTmp)){
				PutField_CString(hTxn,"posted_baid_txn_id",csTmp);
				if(GetTxnDetail(PD_BAID_TXN_LEVEL,csTmp,hDetail,PD_TRUE)!=PD_OK){
					iRet = INT_ERR;
				}
				else{
					ConvertHash(hDetail,hTxn,0,PD_SINGLE_TO_MULTIPLE);
				}
			}
		}
	}

	if (iRet == PD_OK) {
		iNextAction = PD_TRUE;
	}

	//start loop
	iLoopCnt = 0;
	while(iNextAction){
		if(iLoopCnt<iTotalCnt){
DEBUGLOG(("DoAction:: ===========Loop #[%d]===========\n",iLoopCnt));

			RemoveField_CString(hTxn,"txn_code");
			RemoveField_CString(hTxn,"bank_acct_type");

			ConvertHash(hTxn,hTxn,iLoopCnt,PD_MULTIPLE_TO_SINGLE);

			if(GetField_CString(hTxn,"txn_id",&csTxnId) && GetField_CString(hTxn,"baid_txn_id",&csBaidTxnId)){
DEBUGLOG(("DoAction::txn_id[%s],baid_txn_id[%s]\n",csTxnId,csBaidTxnId));
			}
			if(GetField_CString(hTxn,"posted_txn_id",&csTmp)){
DEBUGLOG(("DoAction::posted_txn_id[%s]\n",csTmp));
			}
			if(GetField_CString(hTxn,"posted_baid_txn_id",&csTmp)){
DEBUGLOG(("DoAction::posted_baid_txn_id[%s]\n",csTmp));
			}

			//next action
			if(!GetField_CString(hTxn,"next_action",&csTmp)){
DEBUGLOG(("DoAction:: next_action not found!!!\n"));
ERRLOG("BOOLPspTxnEngine: DoAction:: next_action not found!!!\n");
				TxnAbort();
				break;
			}
			else{
DEBUGLOG(("DoAction:: action [%s]\n",csTmp));
				PutField_CString(hTxn,"action",csTmp);
			}

			//txn_code 
			if(!GetField_CString(hTxn,"txn_code",&csTmp)){
DEBUGLOG(("DoAction:: txn_code not found!!!\n"));
ERRLOG("BOOLPspTxnEngine: DoAction:: txn_code not found!!!\n");
				TxnAbort();
				break;
			}
DEBUGLOG(("DoAction:: txn_code = [%s]\n", csTmp));

			//bank_acct_type
			if(!GetField_CString(hTxn,"bank_acct_type",&csTmp)){
DEBUGLOG(("DoAction:: bank_acct_type not found!!!\n"));
ERRLOG("BOOLPspTxnEngine: DoAction:: bank_acct_type not found!!!\n");
				TxnAbort();
				break;
			}
DEBUGLOG(("DoAction:: bank_acct_type = [%s]\n", csTmp));

			recordset_init(rRecordSet,0);
			DBObjPtr = CreateObj(DBPtr,"DBOLPspTxnEngine","GetPspTxnEngine");
			if ((*DBObjPtr)(hTxn,rRecordSet) == PD_OK) {
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {

					iRunRule = PD_TRUE;

					//get special rule and run it
					if(GetField_Int(hRec,"spc_action_id",&iTmp)){
						iRunRule = RunSpecialAction(iTmp,hTxn);
					}

					//if no special action or special action result = TRUE, get rule parameters and run the rule
					if(iRunRule){
						if(GetField_Int(hRec,"exec_seq",&iTmp)){
DEBUGLOG(("DoAction() GetPspTxnEngine: Exec Seq [%d]\n",iTmp));
						}
						
						//having input txn?baid txn?post txn?
						if(GetField_Char(hRec,"in_baid_txn",&cInBaidTxn)){
						}
						if(GetField_Char(hRec,"in_post_baid_txn",&cInPostBaidTxn)){
						}
						if(GetField_Char(hRec,"in_txn",&cInTxn)){
						}
						if(GetField_Char(hRec,"in_post_txn",&cInPostTxn)){
						}

						iTxnAction = 0;
						if(GetField_Int(hRec,"txn_action",&iTxnAction)){
						}

						if(iTxnAction==PD_ENGINE_ACTION_POST_TXN){
							if(DoPostTxn(hTxn,hRec)!=PD_OK){
								iRet = PD_ERR;
DEBUGLOG(("DoAction() DoPostTxn Failed!!!\n"));
							}
						}
						else if(iTxnAction==PD_ENGINE_ACTION_UPDATE_TXN){
							if(DoUpdateTxn(hTxn,hRec)!=PD_OK){
								iRet = PD_ERR;
DEBUGLOG(("DoAction() DoUpdateTxn Failed!!!\n"));
							}
						}

						if(iRet==PD_OK){
						//run next action if any
							if(GetField_CString(hRec,"next_action",&csTmp)){
DEBUGLOG(("DoAction() Do Next Action [%s]\n",csTmp));
								PutField_CString(hTxn,"action",csTmp);
								if(DoAction(hTxn)!=PD_OK){
									iRet = PD_ERR;
DEBUGLOG(("DoAction() Do Next Action Failed!!!!\n"));
								}
							}
						}

						if(iRet!=PD_OK){
							TxnAbort();
							iNextAction = PD_FALSE;
							break;
						}

					}
					//else, (continue next rule) or (quit job and TxnAbort)
					else{
					}

					hRec = RecordSet_GetNext(rRecordSet);
				}
			}

DEBUGLOG(("DoAction:: ===========End Loop #[%d]===========\n",iLoopCnt));
			iLoopCnt ++;
		}
		else{
			iNextAction = PD_FALSE;
DEBUGLOG(("DoAction() Loop End\n"));
		}

	}//while iNextAction

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);
	FREE_ME(hDetail);

DEBUGLOG(("DoAction() exit iRet = [%d]\n", iRet));
	return iRet;
}


void	ConvertHash(const hash_t* hIn, hash_t* hOut, const int iIdx, const char* csMode)
{
	char	csTag[PD_TAG_LEN+1];
	char	*csTmp = NULL;
	double	dTmp = 0.0;

	//txn_id, txn_code, CR/DR, acct type, baid_type, txn_amt
	if(!strcmp(csMode,PD_MULTIPLE_TO_SINGLE)){
		sprintf(csTag,"txn_id_%d",iIdx);
		if(GetField_CString(hIn,csTag,&csTmp)){
			PutField_CString(hOut,"txn_id",csTmp);
		}

		sprintf(csTag,"baid_txn_id_%d",iIdx);
		if(GetField_CString(hIn,csTag,&csTmp)){
			PutField_CString(hOut,"baid_txn_id",csTmp);
		}

		sprintf(csTag,"posted_txn_id_%d",iIdx);
		if(GetField_CString(hIn,csTag,&csTmp)){
			PutField_CString(hOut,"posted_txn_id",csTmp);
		}

		sprintf(csTag,"posted_baid_txn_id_%d",iIdx);
		if(GetField_CString(hIn,csTag,&csTmp)){
			PutField_CString(hOut,"posted_baid_txn_id",csTmp);
		}

		sprintf(csTag,"txn_code_%d",iIdx);
		if(GetField_CString(hIn,csTag,&csTmp)){
			PutField_CString(hOut,"org_txn_code",csTmp);
			PutField_CString(hOut,"txn_code",csTmp);
		}

		sprintf(csTag,"baid_txn_code_%d",iIdx);
		if(GetField_CString(hIn,csTag,&csTmp)){
			PutField_CString(hOut,"baid_txn_code",csTmp);
			PutField_CString(hOut,"txn_code",csTmp); //override txn_code
		}

		sprintf(csTag,"posted_txn_code_%d",iIdx);
		if(GetField_CString(hIn,csTag,&csTmp)){
			PutField_CString(hOut,"posted_txn_code",csTmp);
		}

		sprintf(csTag,"posted_baid_txn_code_%d",iIdx);
		if(GetField_CString(hIn,csTag,&csTmp)){
			PutField_CString(hOut,"posted_baid_txn_code",csTmp);
		}

		sprintf(csTag,"cr_dr_%d",iIdx);
		if(GetField_CString(hIn,csTag,&csTmp)){
			PutField_CString(hOut,"cr_dr",csTmp);
		}

		sprintf(csTag,"bank_acct_type_%d",iIdx);
		if(GetField_CString(hIn,csTag,&csTmp)){
			PutField_CString(hOut,"org_bank_acct_type",csTmp);
			PutField_CString(hOut,"bank_acct_type",csTmp);
		}

		sprintf(csTag,"baid_bank_acct_type_%d",iIdx);
		if(GetField_CString(hIn,csTag,&csTmp)){
			PutField_CString(hOut,"baid_bank_acct_type",csTmp);
			PutField_CString(hOut,"bank_acct_type",csTmp); //override bank_acct_type
		}

		sprintf(csTag,"posted_bank_acct_type_%d",iIdx);
		if(GetField_CString(hIn,csTag,&csTmp)){
			PutField_CString(hOut,"posted_bank_acct_type",csTmp);
		}

		sprintf(csTag,"posted_baid_bank_acct_type_%d",iIdx);
		if(GetField_CString(hIn,csTag,&csTmp)){
			PutField_CString(hOut,"posted_baid_bank_acct_type",csTmp);
		}

		sprintf(csTag,"baid_type_%d",iIdx);
		if(GetField_CString(hIn,csTag,&csTmp)){
			PutField_CString(hOut,"baid_type",csTmp);
		}

		sprintf(csTag,"txn_amt_%d",iIdx);
		if(GetField_Double(hIn,csTag,&dTmp)){
			PutField_Double(hOut,"txn_amt",dTmp);
		}

		sprintf(csTag,"baid_txn_amt_%d",iIdx);
		if(GetField_Double(hIn,csTag,&dTmp)){
			PutField_Double(hOut,"baid_txn_amt",dTmp);
		}
	}

	else if(!strcmp(csMode,PD_SINGLE_TO_MULTIPLE)){
		sprintf(csTag,"txn_id_%d",iIdx);
		if(GetField_CString(hIn,"txn_id",&csTmp)){
			PutField_CString(hOut,csTag,csTmp);
		}

		sprintf(csTag,"baid_txn_id_%d",iIdx);
		if(GetField_CString(hIn,"baid_txn_id",&csTmp)){
			PutField_CString(hOut,csTag,csTmp);
		}

		sprintf(csTag,"posted_txn_id_%d",iIdx);
		if(GetField_CString(hIn,"posted_txn_id",&csTmp)){
			PutField_CString(hOut,csTag,csTmp);
		}

		sprintf(csTag,"posted_baid_txn_id_%d",iIdx);
		if(GetField_CString(hIn,"posted_baid_txn_id",&csTmp)){
			PutField_CString(hOut,csTag,csTmp);
		}

		sprintf(csTag,"txn_code_%d",iIdx);
		if(GetField_CString(hIn,"txn_code",&csTmp)){
			PutField_CString(hOut,csTag,csTmp);
		}

		sprintf(csTag,"baid_txn_code_%d",iIdx);
		if(GetField_CString(hIn,"baid_txn_code",&csTmp)){
			PutField_CString(hOut,csTag,csTmp);
		}

		sprintf(csTag,"posted_txn_code_%d",iIdx);
		if(GetField_CString(hIn,"posted_txn_code",&csTmp)){
			PutField_CString(hOut,csTag,csTmp);
		}

		sprintf(csTag,"posted_baid_txn_code_%d",iIdx);
		if(GetField_CString(hIn,"posted_baid_txn_code",&csTmp)){
			PutField_CString(hOut,csTag,csTmp);
		}

		sprintf(csTag,"cr_dr_%d",iIdx);
		if(GetField_CString(hIn,"cr_dr",&csTmp)){
			PutField_CString(hOut,csTag,csTmp);
		}

		sprintf(csTag,"bank_acct_type_%d",iIdx);
		if(GetField_CString(hIn,"bank_acct_type",&csTmp)){
			PutField_CString(hOut,csTag,csTmp);
		}

		sprintf(csTag,"baid_bank_acct_type_%d",iIdx);
		if(GetField_CString(hIn,"baid_bank_acct_type",&csTmp)){
			PutField_CString(hOut,csTag,csTmp);
		}

		sprintf(csTag,"posted_bank_acct_type_%d",iIdx);
		if(GetField_CString(hIn,"posted_bank_acct_type",&csTmp)){
			PutField_CString(hOut,csTag,csTmp);
		}

		sprintf(csTag,"posted_baid_bank_acct_type_%d",iIdx);
		if(GetField_CString(hIn,"posted_baid_bank_acct_type",&csTmp)){
			PutField_CString(hOut,csTag,csTmp);
		}

		sprintf(csTag,"baid_type_%d",iIdx);
		if(GetField_CString(hIn,"baid_type",&csTmp)){
			PutField_CString(hOut,csTag,csTmp);
		}

		sprintf(csTag,"txn_amt_%d",iIdx);
		if(GetField_Double(hIn,"txn_amt",&dTmp)){
			PutField_Double(hOut,csTag,dTmp);
		}

		sprintf(csTag,"baid_txn_amt_%d",iIdx);
		if(GetField_Double(hIn,"baid_txn_amt",&dTmp)){
			PutField_Double(hOut,csTag,dTmp);
		}
	}

	else{
		//do nothing
	}

}



int	GetTxnDetail(const char* csLevel, const char* csTxnId, hash_t* hTxn, const int iIsPostedTxn)
{
	int	iRet = PD_OK;
	char	*csTmp;

	hash_t	*hRec;
	recordset_t	*rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	hash_t	*hTmp;
	hTmp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTmp, 0);

	hash_t	*hBaidTxn;
	hBaidTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hBaidTxn, 0);

DEBUGLOG(("GetTxnDetail:: in [%s] Level\n",csLevel));
	if(!strcmp(csLevel,PD_TXN_HEADER_LEVEL)){

		if(iIsPostedTxn) PutField_CString(hTxn,"posted_txn_id",csTxnId);
		else             PutField_CString(hTxn,"txn_id",csTxnId);

		DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","GetTxnHeader");
		if ((*DBObjPtr)(csTxnId,rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if(GetField_CString(hRec,"txn_code",&csTmp)){
					if(iIsPostedTxn) PutField_CString(hTxn,"posted_txn_code",csTmp);
					else		 PutField_CString(hTxn,"txn_code",csTmp);
DEBUGLOG(("GetTxnDetail:: txn_code [%s]\n",csTmp));
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
/*
		recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","GetTxnDetail");
		if ((*DBObjPtr)(csTxnId,rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
*/
		DBObjPtr = CreateObj(DBPtr,"DBOLTxnPspDetail","GetTxnPspDetail");
		if ((*DBObjPtr)(csTxnId,hTmp) == PD_OK) {
			if(GetField_CString(hTmp,"psp_id",&csTmp)){
DEBUGLOG(("GetTxnDetail:: psp_id [%s]\n",csTmp));
				DBObjPtr = CreateObj(DBPtr, "DBOLPspDetail", "GetPspDetail");
				if((unsigned long)(*DBObjPtr)(csTmp, hTmp)==PD_OK){
					if(GetField_CString(hTmp,"bank_acct_type",&csTmp)){
						if(iIsPostedTxn) PutField_CString(hTxn,"posted_bank_acct_type",csTmp);
						else		 PutField_CString(hTxn,"bank_acct_type",csTmp);
DEBUGLOG(("GetTxnDetail:: bank_acct_type [%s]\n",csTmp));
					}
				}
			}
		}

	}

	else if(!strcmp(csLevel,PD_BAID_TXN_LEVEL)){

		if(iIsPostedTxn) PutField_CString(hTxn,"posted_baid_txn_id",csTxnId);
		else             PutField_CString(hTxn,"baid_txn_id",csTxnId);

		DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "GetBaidTxn");
                if((unsigned long)(*DBObjPtr)(csTxnId, hBaidTxn)==PD_OK){
			if(GetField_CString(hBaidTxn,"txn_code",&csTmp)){
				if(iIsPostedTxn) PutField_CString(hTxn,"posted_baid_txn_code",csTmp);
				else		 PutField_CString(hTxn,"baid_txn_code",csTmp);
DEBUGLOG(("GetTxnDetail:: baid_txn_code [%s]\n",csTmp));
			}
			if(GetField_CString(hBaidTxn,"pid",&csTmp)){
				hash_init(hTmp, 0);
				DBObjPtr = CreateObj(DBPtr, "DBOLPspDetail", "GetPspDetail");
				if((unsigned long)(*DBObjPtr)(csTmp, hTmp)==PD_OK){
					if(GetField_CString(hTmp,"bank_acct_type",&csTmp)){
						if(iIsPostedTxn) PutField_CString(hTxn,"posted_baid_bank_acct_type",csTmp);
						else		 PutField_CString(hTxn,"baid_bank_acct_type",csTmp);
DEBUGLOG(("GetTxnDetail:: baid_bank_acct_type [%s]\n",csTmp));
					}
				}
			}
		}
	}

	else{
		iRet = PD_ERR;
	}

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
        FREE_ME(hBaidTxn);
        FREE_ME(hTmp);
DEBUGLOG(("GetTxnDetail() exit iRet = [%d]\n", iRet));
	return iRet;
}


int	RunSpecialAction(const int iActionId, hash_t* hTxn)
{
	int	iRet = PD_TRUE;

	hash_t          *hRec;
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	PutField_Int(hTxn,"action_id",iActionId);
DEBUGLOG(("RunSpecialAction:: [%d]\n",iActionId));

	DBObjPtr = CreateObj(DBPtr,"DBOLPspTxnSpcAction","GetPspTxnSpcAction");
	if ((*DBObjPtr)(hTxn,rRecordSet) == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
DEBUGLOG(("RunSpecialAction() exit iRet = [%d]\n", iRet));
	return iRet;
}


int	DoPostTxn(hash_t* hContext,hash_t* hRequest)
{
	int iRet = PD_OK;
	int iOrgBaidTxn = 0;
	int iPostBaidTxn = 0;
	int iOrgTxn = 0;
	int iPostTxn = 0;
	int iTmp = 0;
	char *csTmp;
	char *csToPostLevel;
	char *csToPostTxnCode;

DEBUGLOG(("DoPostTxn()\n"));

	//use the org txn?baid txn?post txn?
	if(GetField_Int(hRequest,"org_baid_txn",&iOrgBaidTxn)){
	}
	if(GetField_Int(hRequest,"org_txn",&iOrgTxn)){
	}
	if(GetField_Int(hRequest,"post_baid_txn",&iPostBaidTxn)){
	}
	if(GetField_Int(hRequest,"post_txn",&iPostTxn)){
	}
	
	if(GetField_CString(hRequest,"baid_category",&csTmp)){
	}
	if(GetField_Int(hRequest,"bal_rule_id",&iTmp)){
	}
	if(GetField_Int(hRequest,"af_status_rule_id",&iTmp)){
	}

	if(GetField_CString(hRequest,"to_post_txn_level",&csToPostLevel)){
DEBUGLOG(("DoPostTxn() To post level [%s]\n",csToPostLevel));
	}
	if(GetField_CString(hRequest,"to_post_txn_code",&csToPostTxnCode)){
	}


	if(!strcmp(csToPostLevel,PD_TXN_HEADER_LEVEL)){


/*testing*/	PutField_Int(hContext,"posted_txn_cnt",1);
/*testing*/	PutField_CString(hContext,"posted_txn_id","T000000000060342");


	}

	else if(!strcmp(csToPostLevel,PD_BAID_TXN_LEVEL)){


/*testing*/	PutField_Int(hContext,"posted_baid_txn_cnt",1);
/*testing*/	PutField_CString(hContext,"posted_baid_txn_id","A000000000028062");



	}


DEBUGLOG(("DoPostTxn() exit iRet = [%d]\n", iRet));
	return iRet; 
}


int	DoUpdateTxn(hash_t* hContext,hash_t* hRequest)
{
	int iRet = PD_OK;
	int iOrgBaidTxn = 0;
	int iPostBaidTxn = 0;
	int iOrgTxn = 0;
	int iPostTxn = 0;
	int iTmp = 0;
	int iUpdateBal = PD_FALSE;
	int iCheckStatus = PD_FALSE;
	int iUpdateStatus = PD_FALSE;
	char *csTxnId;
	char csLevel[PD_ENGINE_TYPE_LEN+1];

	hash_t          *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

DEBUGLOG(("DoUpdateTxn()\n"));

	//use the org txn?baid txn?post txn?
	GetField_Int(hRequest,"org_baid_txn",&iOrgBaidTxn);
	GetField_Int(hRequest,"org_txn",&iOrgTxn);
	GetField_Int(hRequest,"post_baid_txn",&iPostBaidTxn);
	GetField_Int(hRequest,"post_txn",&iPostTxn);

	if(iOrgBaidTxn){
		if(GetField_CString(hContext,"baid_txn_id",&csTxnId)){
			sprintf(csLevel,"%s",PD_BAID_TXN_LEVEL);
		}
		else{
			iRet = PD_ERR;
DEBUGLOG(("DoUpdateTxn() baid_txn_id id missing!!!!!!\n"));
		}
	}
	else if(iOrgTxn){
		if(GetField_CString(hContext,"txn_id",&csTxnId)){
			sprintf(csLevel,"%s",PD_TXN_HEADER_LEVEL);
		}
		else{
			iRet = PD_ERR;
DEBUGLOG(("DoUpdateTxn() txn_id id missing!!!!!!\n"));
		}
	}
	else if(iPostBaidTxn){
		if(GetField_CString(hContext,"posted_baid_txn_id",&csTxnId)){
			sprintf(csLevel,"%s",PD_BAID_TXN_LEVEL);
		}
		else{
			iRet = PD_ERR;
DEBUGLOG(("DoUpdateTxn() posted_baid_txn_id id missing!!!!!!\n"));
		}
	}
	else if(iPostTxn){
		if(GetField_CString(hContext,"posted_txn_id",&csTxnId)){
			sprintf(csLevel,"%s",PD_TXN_HEADER_LEVEL);
		}
		else{
			iRet = PD_ERR;
DEBUGLOG(("DoUpdateTxn() posted_txn_id id missing!!!!!!\n"));
		}
	}
	else{
DEBUGLOG(("DoUpdateTxn() do nothing\n"));
		iRet = PD_SKIP_OK;
	}

	//get update rules(balance, status)
	if(iRet==PD_OK){
                if(GetField_Int(hRequest,"bal_rule_id",&iTmp)){
                        //get balance rule
                        iUpdateBal = PD_TRUE;
                }
                if(GetField_Int(hRequest,"bf_status_rule_id",&iTmp)){

                        //get status rule
                        iCheckStatus = PD_TRUE;
		}
		if(GetField_Int(hRequest,"af_status_rule_id",&iTmp)){

			//get status rule
			iUpdateStatus = PD_TRUE;
		}
	}

	//start update (balance, status)
	if(iRet==PD_OK){
		if(!strcmp(csLevel,PD_TXN_HEADER_LEVEL)){
DEBUGLOG(("DoUpdateTxn() [%s][%s]\n",csLevel,csTxnId));
			PutField_CString(hTxn,"org_txn_seq",csTxnId);

			if(iCheckStatus){
				//do check status
DEBUGLOG(("DoUpdateTxn() do check status\n"));
			}

			if(iRet==PD_OK && iUpdateStatus){
				//do update status
DEBUGLOG(("DoUpdateTxn() do update status\n"));
			}

			if(iRet==PD_OK && iUpdateBal){
				//do update balance
DEBUGLOG(("DoUpdateTxn() do update balance\n"));
			}


		}
		else{ //BAID_TXN_LEVEL
DEBUGLOG(("DoUpdateTxn() [%s][%s]\n",csLevel,csTxnId));
			PutField_CString(hTxn,"txn_seq",csTxnId);

			if(iCheckStatus){
				//do check status
DEBUGLOG(("DoUpdateTxn() do check status\n"));
			}

			if(iRet==PD_OK && iUpdateStatus){
				//do update status
DEBUGLOG(("DoUpdateTxn() do update status\n"));
			}
		
		}
	}

	if(iRet==PD_SKIP_OK)
		iRet = PD_OK;

	FREE_ME(hTxn);

DEBUGLOG(("DoUpdateTxn() exit iRet = [%d]\n", iRet));
	return iRet; 
}
