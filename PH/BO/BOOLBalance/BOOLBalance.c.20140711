/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/10/10              LokMan Chow
Modify UpdateTxnAmount				   2014/06/11		   Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOOLBalance.h"

char    cDebug;
OBJPTR(DB);
OBJPTR(BO);

void BOOLBalance(char    cdebug)
{
	cDebug = cdebug;
}

int CreditDepositAmount(hash_t *hContext,
			const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode, 
			const char cType,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dNetAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee);

int DebitDepositAmount(hash_t* hContext,
			const char* csPostingDate,
			const char* csCountry,
			const char* csServiceCode,
			const char cType,
			const char* csMerchantCCY,
			const char* csMerchantID,
			double dNetAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee);

int PayoutVoided(hash_t* hContext,
		const char* csCountry,
		const char* csServiceCode,
		const char* csMerchantCCY,
		const char* csMerchantID,
		double dNetAmount,
		const char* csPspCCY,
		const char* csPspID,
		double dPspAmount,
		char   cParty,
		int iDayOfWeek);

int PayoutSuccess(hash_t* hContext,
			const char* csCountry,
			const char* csServiceCode,
			const char* csMerchantCCY,
			const char* csMerchantID,
			double dNetAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			char   cParty,
			int iDayOfWeek);

int CreditAFPOFloat(hash_t* hContext,
			const char* csPostingDate,
			const char* csCountry,
			const char* csServiceCode,
			const char* csMerchantCCY,
			const char* csMerchantID,
			double dNetAmount);

int DebitAFPOFloat(hash_t* hContext,
			const char* csPostingDate,
			const char* csCountry,
			const char* csServiceCode,
			const char* csMerchantCCY,
			const char* csMerchantID,
			double dNetAmount);

int UpdateTxnAmount(hash_t *hContext)
{
	int	iRet = PD_OK;
	//char	*csTxnCode = NULL;
	//char	*csPostingDate = NULL;
	char	csPostingDate[PD_DATE_LEN + 1];
	char	*csOrgTxnSeq = NULL;
	char	*csOrgTxnCountry = NULL;
	char	*csOrgTxnCcy = NULL;
	char	*csOrgMerchantId = NULL;
	char	*csOrgDstCcy = NULL;
	char	*csOrgPspId = NULL;
	char	*csOrgServiceCode = NULL;
	//double	dOrgTxnAmt= 0.0;
	double	dOrgNetAmt= 0.0;
	double	dOrgDstTxnAmt= 0.0;
	double	dReserveAmt = 0.0;
	double	dPspFee = 0.0;
	double	dTmp= 0.0;
	//int	iRecon = PD_FALSE;
	//int	iReleased = PD_FALSE;
	
	char cAmt;
	char cType;

	hash_t *hVal;
	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

	csPostingDate[0]= '\0';

/*org txn seq */
	if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_txn_seq = [%s]\n",csOrgTxnSeq));
	} else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_txn_seq is missing!!!\n"));
	}

/*org txn country */
	if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_txn_country = [%s]\n",csOrgTxnCountry));
	} else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_txn_country is missing!!!\n"));
	}

/*org txn ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_txn_ccy = [%s]\n",csOrgTxnCcy));
	} else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_txn_ccy is missing!!!\n"));
	}

/* amt_type */
	if (GetField_Char(hContext,"amt_type",&cAmt)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() amt_type = [%c]\n",cAmt));
	} else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() amt_type is missing!!!\n"));
	}

/* party_type */
	if (GetField_Char(hContext,"party_type",&cType)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() party_type = [%c]\n",cType));
	} else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() party_type is missing!!!\n"));
	}

	if (cType == PD_TYPE_MERCHANT) {

	/*org service Code */
		if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_service_code = [%s]\n",csOrgServiceCode));
		} else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_service_code is missing!!!\n"));
		}
	/*org merchant id */
		if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_merchant_id = [%s]\n",csOrgMerchantId));
		}
		else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_merchant_id is missing!!!\n"));
		}
	/*org net amount */
		if (GetField_Double(hContext,"net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() net_amt = [%lf]\n",dOrgNetAmt));
		}
		else {
			if (GetField_Double(hContext,"org_net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_net_amt = [%lf]\n",dOrgNetAmt));
			}
			else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_net_amt is missing!!!\n"));
			}
		}
	/*reserved amt */
		if (GetField_Double(hContext,"reserve_amt",&dReserveAmt)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() reserve_amt = [%lf]\n",dReserveAmt));
		}
		else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() not reserve_amt\n"));
		}

	} else if (cType == PD_TYPE_PSP) {

	/*org psp ccy */
		if (GetField_CString(hContext,"org_dst_txn_ccy",&csOrgDstCcy)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_dst_txn_ccy = [%s]\n",csOrgDstCcy));
		}
		else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_dst_txn_ccy is missing!!!\n"));
		}
	/*org psp id */
		if (GetField_CString(hContext,"org_psp_id",&csOrgPspId)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_psp_id = [%s]\n",csOrgPspId));
		}
		else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_psp_id is missing!!!\n"));
		}
	/*org psp txn amount */
		if (GetField_Double(hContext,"org_dst_net_amt",&dOrgDstTxnAmt)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_dst_net_amt = [%lf]\n",dOrgDstTxnAmt));
		}
		else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_dst_net_amt is missing!!!\n"));
		}
	/* psp_fee */
		if (GetField_Double(hContext,"precal_fee",&dPspFee)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() precal_fee = [%lf]\n",dPspFee));
		}
	}

	if (cAmt == PD_IND_CREDIT){
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() Update Credit Txn\n"));
		iRet =CreditDepositAmount(hContext,
					csPostingDate,
					csOrgTxnCountry,
					csOrgServiceCode,
					cType,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt,
					csOrgDstCcy,
					csOrgPspId,
					dOrgDstTxnAmt,
					dReserveAmt,
					dPspFee);
	}
	else if(cAmt == PD_IND_DEBIT){
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() Update Debit Txn\n"));
		iRet =DebitDepositAmount(hContext,
					csPostingDate,
					csOrgTxnCountry,
					csOrgServiceCode,
					cType,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt,
					csOrgDstCcy,
					csOrgPspId,
					dOrgDstTxnAmt,
					dReserveAmt,
					dPspFee);
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() None txn\n"));
	}
	
	if(iRet==PD_OK){
		if (cType == PD_TYPE_MERCHANT) {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() DBOLMerchantBalance::GetCurrentValues() called\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetCurrentValues");
			if((unsigned long)(*DBObjPtr)(csOrgMerchantId,csOrgTxnCcy,csOrgTxnCountry,csOrgServiceCode,hVal)!=PD_ERR){
				if(GetField_Double(hVal,"current_bal",&dTmp)){
					PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() current_bal= [%f]\n",dTmp));
				}
				if(GetField_Double(hVal,"total_hold",&dTmp)){
					PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() total_hold= [%f]\n",dTmp));
				}
				if(GetField_Double(hVal,"in_intransit",&dTmp)){
					PutField_Double(hContext,"in_intransit",dTmp);
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() in_intransit= [%f]\n",dTmp));
				}
				if(GetField_Double(hVal,"out_intransit",&dTmp)){
					PutField_Double(hContext,"out_intransit",dTmp);
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() out_intransit= [%f]\n",dTmp));
				}

			} else {
				iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() DBOLMerchantBalance::GetCurrentValues() Failed\n"));
ERRLOG("BOOLBalance:UpdateTxnAmount() DBOLMerchantBalance::GetCurrentValues() Failed\n");
			}
		} else if (cType == PD_TYPE_PSP) {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() DBOLPIDBal::GetBalance() called\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLPIDBal","GetBalance");
			if((unsigned long)(*DBObjPtr)(csOrgPspId,csOrgTxnCountry,csOrgDstCcy,hContext)!=PD_ERR){
				if(GetField_Double(hContext,"psp_balance",&dTmp)){
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() psp_balance = [%f]\n",dTmp));
				}
				if(GetField_Double(hContext,"psp_total_hold",&dTmp)){
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() psp_total_hold = [%f]\n",dTmp));
				}
			} else {
				iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() DBOLPIDBal::GetBalance() Failed\n"));
ERRLOG("BOOLBalance:UpdateTxnAmount() DBOLPIDBal::GetBalance() Failed\n");
			}
		}
	}

	FREE_ME(hVal);	

DEBUGLOG(("BOOLBalance:UpdateTxnAmount() Ret = [%d]\n",iRet));
	return iRet;
}

int CreditDepositAmount(hash_t* hContext,
			const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode,
			const char cType,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dNetAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee) 
{
	int iRet = PD_OK;
	char	csLocalPostingDate[PD_DATE_LEN +1];

DEBUGLOG(("BOOLBalance:CreditDepositAmount()\n"));
DEBUGLOG(("BOOLBalance:CreditDepositAmount() merchant = [%lf], psp = [%lf], res = [%lf]\n",dNetAmount,dPspAmount,dReserveAmount));

/* Merchant */
	if (cType == PD_TYPE_MERCHANT) {
		if (iRet == PD_OK) {
	/* Add or Update Txn Element */
	/* update txn element for Reserved Amount */
DEBUGLOG(("BOOLBalance:CreditDepositAmount() Update Reserve Element\n"));
			PutField_Double(hContext,"reserve_amt",dReserveAmount);
			PutField_CString(hContext,"amount_type",PD_DR);
			BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddReserveAmtElement");
			iRet = (unsigned long)(*BOObjPtr)(hContext);

	/* update txn element for float Amount */
			if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:CreditDepositAmount() UpdateFloat Element\n"));
				PutField_Double(hContext,"float_amt",dNetAmount - dReserveAmount);
				BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddMerchantFloatAmtElement");
				iRet = (unsigned long)(*BOObjPtr)(hContext);
			}
		}

	/* lock opening balance */
		if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:CreditDepositAmount() DBOLMerchantBalance::GetOpenBalanceForUpdate() called\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetOpenBalanceForUpdate");
			if ((*DBObjPtr)(hContext,
					csMerchantID,
					csMerchantCCY,
					csCountry,
					csServiceCode) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:CreditDepositAmount() DBOLMerchantBalance::GetOpenBalanceForUpdate() Failed\n"));
ERRLOG("BOOLBalance:CreditDepositAmount() DBOLMerchantBalance::GetOpenBalanceForUpdate() Failed\n");
			}
		}
/* PSP */
	} else if (cType == PD_TYPE_PSP) {
	/* lock opening balance */
		if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:CreditDepositAmount() DBOLPIDBal::GetOpenBalanceForUpdate() called\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLPIDBal","GetOpenBalanceForUpdate");
			if ((*DBObjPtr)(csPspID,
					csCountry,
					csPspCCY,
					hContext) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:CreditDepositAmount() DBOLPIDBal::GetOpenBalanceForUpdate() Failed\n"));
ERRLOG("BOOLBalance:CreditDepositAmount() DBOLPIDBal::GetOpenBalanceForUpdate() Failed\n");
			}
		}
	}

/***** update  Context for approval date and approval timestamp */
	DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
	(*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:CreditDepositAmount()  SystemControl::GetApprovalDT called\n"));

	if (strlen(csPostingDate) == 0) {
DEBUGLOG(("BOOLBalance:CreditDepositAmount()  overriding approval_date\n"));
		char    *csPtr;
		if (GetField_CString(hContext,"approval_date",&csPtr)) {
			strcpy(csLocalPostingDate,csPtr);
DEBUGLOG(("BOOLBalance:CreditDepositAmount()  approval_date = [%s]\n",csLocalPostingDate));
		}

	}
	else {
DEBUGLOG(("BOOLBalance:CreditDepositAmount()  approcal_date [%s] from parameter\n",csPostingDate));
		strcpy(csLocalPostingDate,csPostingDate);
	}

/* Merchant */
	if (cType == PD_TYPE_MERCHANT) {
		if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:CreditDepositAmount() DBOLMerchantBalance::UpdateCurrBal() called\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateCurrBal");
			if ((*DBObjPtr)(csMerchantID,
					csCountry,
					csMerchantCCY,
					csServiceCode,
					dNetAmount,
					PD_IND_CREDIT,
					PD_UPDATE_USER) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:CreditDepositAmount() DBOLMerchantBalance::UpdateCurrBal() Failed\n"));
ERRLOG("BOOLBalance:CreditDepositAmount() DBOLMerchantBalance::UpdateCurrBal() Failed\n");
			}
		}
/* PSP */
	} else if (cType == PD_TYPE_PSP) {
		if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:CreditDepositAmount() DBOLPIDBal::UpdateBalance() called\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLPIDBal","UpdateBalance");
			if ((*DBObjPtr)(csPspID,
					csCountry,
					csPspCCY,
					PD_IND_CREDIT,
					dPspAmount - dPspFee,
					PD_UPDATE_USER) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:CreditDepositAmount() DBOLPIDBal::UpdateBalance() Failed\n"));
ERRLOG("BOOLBalance:CreditDepositAmount() DBOLPIDBal::UpdateBalance() Failed\n");
			}
		}
	}

DEBUGLOG(("BOOLBalance:CreditDepositAmount() iRet = [%d]\n",iRet));
	return iRet;
}


int DebitDepositAmount(hash_t* hContext,
			const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode,
			const char cType,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dNetAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee) 
{
	int iRet = PD_OK;
	double dAvaBalance = 0.0;
	double dTmp = 0.0;

DEBUGLOG(("BOOLBalance:DebitDepositAmount()\n"));
DEBUGLOG(("BOOLBalance:DebitDepositAmount() merchant = [%lf], psp = [%lf], res = [%lf]\n",dNetAmount,dPspAmount,dReserveAmount));

/* Merchant */
	if (cType == PD_TYPE_MERCHANT) {
		if(iRet==PD_OK){
DEBUGLOG(("BOOLBalance:DebitDepositAmount() DBOLMerchantBalance::GetCurrBalance called\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLMerchantBalance", "GetCurrBalance");
			if((unsigned long)(*DBObjPtr)(csMerchantID,
						      csMerchantCCY,
						      csCountry,
						      csServiceCode,
						      &dTmp) != PD_OK){
				iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DebitDepositAmount() DBOLMerchantBalance::GetCurrBalance Failed\n"));
ERRLOG("BOOLBalance:DebitDepositAmount() DBOLMerchantBalance::GetCurrBalance Failed\n");
			}
			else{

DEBUGLOG(("BOOLBalance:DebitDepositAmount() GetCurrBalance current_bal = [%lf]\n",dTmp));
				if(dNetAmount>dTmp){
DEBUGLOG(("BOOLBalance:DebitDepositAmount() Merchant Current Balance [%lf] < debit balance [%lf]\n", dTmp,dNetAmount));
ERRLOG("BOOLBalance::DebitDepositAmount() Merchant Current Balance [%lf] < debit balance [%lf]\n", dTmp,dNetAmount);
					iRet = INT_INSUFFICIENT_FUND;
					PutField_Int(hContext,"internal_error",iRet);
				}
			}
		}

	/* lock opening balance */
		if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:DebitDepositAmount() DBOLMerchantBalance::GetOpenBalanceForUpdate() called\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetOpenBalanceForUpdate");
			if ((*DBObjPtr)(hContext,
					csMerchantID,
					csMerchantCCY,
					csCountry,
					csServiceCode) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DebitDepositAmount() DBOLMerchantBalance::GetOpenBalanceForUpdate() Failed\n"));
ERRLOG("BOOLBalance:DebitDepositAmount() DBOLMerchantBalance::GetOpenBalanceForUpdate() Failed\n");
			}
		}
/* PSP */
	} else if (cType == PD_TYPE_PSP) {
		if(iRet==PD_OK){
DEBUGLOG(("BOOLBalance:DebitDepositAmount() DBOLPIDBal::GetBalanceForUpdate() called\n"));
DEBUGLOG(("TESTING: csPspCCY = [%s]\n", csPspCCY));
			DBObjPtr = CreateObj(DBPtr, "DBOLPIDBal", "GetAvalPidBal");
			if((unsigned long)(*DBObjPtr)(csPspID,csPspCCY,csCountry,&dAvaBalance)!=PD_OK) {
DEBUGLOG(("BOOLBalance:DebitDepositAmount() DBOLPIDBal::GetBalanceForUpdate() Failed\n"));
ERRLOG("BOOLBalance::DebitDepositAmount() DBOLPIDBAL::GetBalanceForUpdate() Failed\n");
				iRet=INT_ERR;
			}
			else {
DEBUGLOG(("BOOLBalance:DebitDepositAmount() PSP Balance [%lf]\n", dAvaBalance));
				if(dAvaBalance<(dPspAmount-dPspFee)){
DEBUGLOG(("BOOLBalance:DebitDepositAmount() PSP Balance [%lf] < debit balance [%lf]\n", dAvaBalance,(dPspAmount-dPspFee)));
ERRLOG("BOOLBalance::DebitDepositAmount() PSP Balance [%lf] < debit balance [%lf]\n", dAvaBalance,(dPspAmount-dPspFee));
					iRet = INT_INSUFFICIENT_FUND;
					PutField_Int(hContext,"internal_error",iRet);
				}
			}
		}

	/* lock opening balance */
		if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:DebitDepositAmount DBOLPIDBal::GetOpenBalanceForUpdate() called\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLPIDBal","GetOpenBalanceForUpdate");
			if ((*DBObjPtr)(csPspID,
					csCountry,
					csPspCCY,
					hContext) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DebitDepositAmount DBOLPIDBal::GetOpenBalanceForUpdate() Failed\n"));
ERRLOG("BOOLBalance:DebitDepositAmount DBOLPIDBal::GetOpenBalanceForUpdate() Failed\n");
			}
		}
	}

/***** update  Context for approval date and approval timestamp */
	DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
	(*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:DebitDepositAmount()  SystemControl::GetApprovalDT called\n"));

/* Merchant */
	if (cType == PD_TYPE_MERCHANT) {
		if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:DebitDepositAmount() DBOLMerchantBalance::UpdateCurrBal() called\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateCurrBal");
			if ((*DBObjPtr)(csMerchantID,
					csCountry,
					csMerchantCCY,
					csServiceCode,
					dNetAmount,
					PD_IND_DEBIT,
					PD_UPDATE_USER) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DebitDepositAmount() DBOLMerchantBalance::UpdateCurrBal() Failed\n"));
ERRLOG("BOOLBalance:DebitDepositAmount() DBOLMerchantBalance::UpdateCurrBal() Failed\n");
			}
		}
/* PSP */
	} else if (cType == PD_TYPE_PSP) {
		if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:DebitDepositAmount() DBOLPIDBal::UpdateBalance() called\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLPIDBal","UpdateBalance");
			if ((*DBObjPtr)(csPspID,
					csCountry,
					csPspCCY,
					PD_IND_DEBIT,
					dPspAmount - dPspFee,
					PD_UPDATE_USER) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DebitDepositAmount() DBOLPIDBal::UpdateBalance() Failed\n"));
ERRLOG("BOOLBalance:DebitDepositAmount() DBOLPIDBal::UpdateBalance() Failed\n");
			}
		}
	}

DEBUGLOG(("BOOLBalance:DebitDepositAmount() iRet = [%d]\n",iRet));
	return iRet;
}


int ProcessHold(hash_t *hContext,
		const hash_t *hRequest)
{
	int iRet = PD_OK;

	char    *csTxnCcy;
	char    *csTxnCountry;
	char    *csPspId;
	char    *csMerchantId;
	char    *csServiceCode;
	char    *csUser;
	char    cType;
	char    cHold;
	char    cMHind;
	int     iAllowBalNegative = PD_FALSE;
	double  dAmt=0.0;
	double  dBal=0.0;
	double  dFloat=0.0;
	double  dAFPO=0.0;
	double  dFundIn=0.0;
	double  dResPO=0.0;
	double  dHold=0.0;
	double  dAval=0.0;
	double  dTmp=0.0;
	double  dAvaNetFloat=0.0;
	double  dRemainDebit=0.0;
	double  dDebitdFundIn=0.0;
	int     iRlsToSett = PD_FALSE;
	int     iAllowPayout = PD_FALSE;

	hash_t *hVal;
	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

/*party_type*/
	if(GetField_Char(hContext,"party_type",&cType)){
DEBUGLOG(("BOOLBalance:ProcessHold() party_type = [%c]\n",cType));
	}
	else{
		cType=PD_TYPE_MERCHANT;
	}

/*hold_type*/
	if(GetField_Char(hContext,"hold_type",&cHold)){
DEBUGLOG(("BOOLBalance:ProcessHold() hold_type = [%c]\n",cHold));
	}

/*rls_to_sett*/
	if(GetField_Int(hContext,"rls_to_sett",&iRlsToSett)){
DEBUGLOG(("BOOLBalance:ProcessHold() rls_to_sett = [%d]\n",iRlsToSett));
	}

/*txn country */
	if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {
DEBUGLOG(("BOOLBalance:ProcessHold() txn_country = [%s]\n",csTxnCountry));
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessHold() txn_country is missing!!!\n"));
	}

/*txn ccy */
	if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {
DEBUGLOG(("BOOLBalance:ProcessHold() txn_ccy = [%s]\n",csTxnCcy));
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessHold() txn_ccy is missing!!!\n"));
	}
/*service code */
	if (GetField_CString(hContext,"service_code",&csServiceCode)) {
DEBUGLOG(("BOOLBalance:ProcessHold() service_code = [%s]\n",csServiceCode));
	}

/*merchant id */
	if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {
DEBUGLOG(("BOOLBalance:ProcessHold() merchant_id = [%s]\n",csMerchantId));
	}

/*psp id */
	if (GetField_CString(hContext,"psp_id",&csPspId)) {
DEBUGLOG(("BOOLBalance:ProcessHold() psp_id = [%s]\n",csPspId));
	}

/*amount */
	if (GetField_Double(hContext,"txn_amt",&dAmt)) {
DEBUGLOG(("BOOLBalance:ProcessHold() txn_amt = [%lf]\n",dAmt));
	}

/*update_user*/
	if (GetField_CString(hContext,"update_user",&csUser)) {
DEBUGLOG(("BOOLBalance:ProcessHold() update_user = [%s]\n",csUser));
	}

/* mh_ind */
	if (GetField_Char(hContext, "mh_ind", &cMHind)) {
		PutField_Char(hContext, "hold_po_st", cMHind);
DEBUGLOG(("BOOLBalance:ProcessHold() mh_ind = [%c]\n",cMHind));
	}

/*allow_bal_negative */
	if (GetField_Int(hContext, "allow_bal_negative", &iAllowBalNegative)) {
DEBUGLOG(("BOOLBalance:ProcessHold() allow_bal_negative = [%d]\n", iAllowBalNegative));
	}

/*allow_payout*/
	if(GetField_Int(hContext,"allow_payout",&iAllowPayout)){
DEBUGLOG(("BOOLBalance:ProcessHold() allow_payout = [%d]\n",iAllowPayout));
	}

	if(cType==PD_TYPE_MERCHANT){

DEBUGLOG(("BOOLBalance: ProcessHold: DBOLMerchantBalance->GetOpenBalanceForUpdate\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetOpenBalanceForUpdate");
		if((unsigned long)(*DBObjPtr)(hVal, csMerchantId,csTxnCcy,csTxnCountry,csServiceCode)!=PD_ERR) {

/***** update  Context for approval date and approval timestamp */
			DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
			(*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:ProcessHold()  SystemControl::GetApprovalDT called\n"));

			if (cMHind == PD_TYPE_PAYOUT) {
				if(GetField_Double(hVal,"merchant_open_bal",&dBal)){
DEBUGLOG(("BOOLBalance: current_bal (P) = [%lf]\n",dBal));
				}
				if(GetField_Double(hVal,"total_float",&dFloat)){
DEBUGLOG(("BOOLBalance: total_float (P) = [%lf]\n",dFloat));
				}
				if(GetField_Double(hVal,"total_float_after_payout",&dAFPO)){
DEBUGLOG(("BOOLBalance: total_float_after_payout (P) = [%lf]\n",dAFPO));
				}
				if(GetField_Double(hVal,"fundin_payout",&dFundIn)){
DEBUGLOG(("BOOLBalance: fundin_payout (P) = [%lf]\n",dFundIn));
				}
				if(GetField_Double(hVal,"reserved_payout",&dResPO)){
DEBUGLOG(("BOOLBalance: reserved_payout (P) = [%lf]\n",dResPO));
				}
				if(GetField_Double(hVal,"total_hold",&dHold)){
DEBUGLOG(("BOOLBalance: total_hold (P) = [%lf]\n",dHold));
				}
				
				dAval=dBal-dHold;
			}
			else {
				if(GetField_Double(hVal,"merchant_open_bal_settlement",&dBal)){
DEBUGLOG(("BOOLBalance: current_bal (S) = [%lf]\n",dBal));
				}
				if(GetField_Double(hVal,"total_hold_settlement",&dHold)){
DEBUGLOG(("BOOLBalance: total_hold (S) = [%lf]\n",dHold));
				}
				dAval=dBal-dHold;
			}
		}
		else{
DEBUGLOG(("BOOLBalance: ProcessHold: DBOLMerchantBalance->GetOpenBalanceForUpdate Failed\n"));
ERRLOG("BOOLBalance: ProcessHold: DBOLMerchantBalance->GetOpenBalanceForUpdate Failed\n");
			iRet=PD_ERR;
		}

		if (iRet == PD_OK) {
			if(GetField_Double(hVal,"merchant_open_bal",&dTmp)){
DEBUGLOG(("BOOLBalance: open_bal = [%f]\n",dTmp));
				PutField_Double(hContext, "merchant_open_bal", dTmp);
			}

			if(GetField_Double(hVal,"merchant_open_bal_settlement",&dTmp)){
DEBUGLOG(("BOOLBalance: open_bal_settlement = [%f]\n",dTmp));
				PutField_Double(hContext, "merchant_open_bal_settlement", dTmp);
			}
		}
	}
	else if(cType==PD_TYPE_PSP){
		//do nothing in cut-down version
	}
	if(iRet==PD_OK){
		if(cHold==PD_HOLD){
			if (iAllowBalNegative == PD_FALSE) {
				if(dAval<dAmt){
DEBUGLOG(("BOOLBalance: ProcessHold: Hold Amount[%lf] > Balance[%lf]\n",dAmt,dAval));
ERRLOG("BOOLBalance: ProcessHold: Hold Amount[%lf] > Balance[%lf]\n",dAmt,dAval);
					iRet = INT_INVALID_PAY_AMOUNT;
				}
			}
		}
		else if(cHold==PD_UNHOLD){
			if(dHold<dAmt){
DEBUGLOG(("BOOLBalance: ProcessHold: Original Hold[%lf] < Unhold Amt[%lf]\n",dHold,dAmt));
ERRLOG("BOOLBalance: ProcessHold: Original Hold[%lf] < Unhold Amt[%lf]\n",dHold,dAmt);
				iRet = INT_INVALID_PAY_AMOUNT;
			}
		}
	}
	if(iRet==PD_OK){
		if(cType==PD_TYPE_MERCHANT){
			if(iRlsToSett && cMHind==PD_TYPE_PAYOUT && cHold==PD_UNHOLD){
				dAvaNetFloat = dBal-dFloat-dAFPO-dFundIn-dResPO;
				if(dAvaNetFloat<0.0)
					dAvaNetFloat = 0.0;

				if(dAvaNetFloat>=dAmt)
					dRemainDebit = 0.0;
				else
					dRemainDebit = dAmt-dAvaNetFloat;

				//debit current_bal
DEBUGLOG(("BOOLBalance: ProcessHold: DBOLMerchantBalance->UpdateCurrBal\n"));
				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateCurrBal");
				iRet = (unsigned long)(*DBObjPtr)(csMerchantId,
						csTxnCountry,
						csTxnCcy,
						csServiceCode,
						(-1)*dAmt,
						csUser);

				//debit fundin payout (if needed)
				if(iRet==PD_OK && dRemainDebit>0.0 && dFundIn>0.0){
					if(dRemainDebit<=dFundIn){
						dDebitdFundIn = dRemainDebit;
					}
					else{
						dDebitdFundIn = dFundIn;
					}

DEBUGLOG(("BOOLBalance: ProcessHold: DBOLMerchantBalance->UpdateFundInPayout\n"));
					DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateFundInPayout");
					iRet = (unsigned long)(*DBObjPtr)(csMerchantId,
							csTxnCountry,
							csTxnCcy,
							csServiceCode,
							(-1)*dDebitdFundIn,
							csUser);
				}

				//credit current_sett_bal
				if(iRet==PD_OK){
DEBUGLOG(("BOOLBalance: ProcessHold: DBOLMerchantBalance->UpdateSettBal\n"));
					DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateSettBal");
					iRet = (unsigned long)(*DBObjPtr)(csMerchantId,
							csTxnCountry,
							csTxnCcy,
							csServiceCode,
							dAmt,
							0.0,
							PD_IND_CREDIT,
							csUser);
				}

			}
			if(iRet==PD_OK){
DEBUGLOG(("BOOLBalance: ProcessHold: DBOLMerchantBalance->UpdateHoldBalance\n"));
				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateHoldBalance");
				iRet = (unsigned long)(*DBObjPtr)(csMerchantId,
								  csTxnCountry,
								  csTxnCcy,
								  csServiceCode,
								  cMHind,
								  cHold,
								  dAmt,
								  csUser);
			}
			if(iRet==PD_OK){
				hash_init(hVal,0);
				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetCurrentValues");
				if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){

					if(GetField_Double(hVal,"current_bal",&dTmp)){
						PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOOLBalance: current_bal= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"current_bal_settlement",&dTmp)){
						PutField_Double(hContext,"current_bal_settlement",dTmp);
DEBUGLOG(("BOOLBalance: current_bal_settlement= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_float_settlement",&dTmp)){
						PutField_Double(hContext,"total_float_settlement",dTmp);
DEBUGLOG(("BOOLBalance: total_float_settlement= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
						PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOOLBalance: total_reserved_amount= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_hold",&dTmp)){
						PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOOLBalance: total_hold= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_hold_settlement",&dTmp)){
						PutField_Double(hContext,"total_hold_settlement",dTmp);
DEBUGLOG(("BOOLBalance: total_hold_settlement= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_float_after_payout",&dTmp)){
						PutField_Double(hContext,"total_float_after_payout",dTmp);
DEBUGLOG(("BOOLBalance: total_float_after_payout= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"fundin_payout",&dTmp)){
						PutField_Double(hContext,"fundin_payout",dTmp);
DEBUGLOG(("BOOLBalance: fundin_payout= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"reserved_payout",&dTmp)){
						PutField_Double(hContext,"reserved_payout",dTmp);
DEBUGLOG(("BOOLBalance: reserved_payout= [%f]\n",dTmp));
					}
				}
			}

		}
		else if(cType==PD_TYPE_PSP){
			//do nothing in cut-down version
		}
	}
	FREE_ME(hVal);


	if(iRet==PD_OK){
		if(cHold==PD_HOLD){
			PutField_CString(hContext, "amount_type", PD_DR);
		} else {
			PutField_CString(hContext, "amount_type", PD_CR);
		}
DEBUGLOG(("BOOLBalance:ProcessHold() AddHold Element\n"));
		BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddHoldAmtElement");
		iRet = (unsigned long)(*BOObjPtr)(hContext);
	}

	return iRet;
}



int GetAvalPayoutBalance(hash_t *hContext,
			const hash_t *hRequest,
			double *dActualBalance,
			double *dAvalBalance)
{
	int     iRet = PD_OK;
	char    *csOrgTxnCountry;
	char    *csOrgTxnCcy;
	char    *csOrgMerchantId;
	char    *csOrgServiceCode;
	double  dTmp=0.0;
	double  dBal=0.0;
	double  dFeeRate=0.0;
	int     iDayOfWeek;

//org txn country 
	if (GetField_CString(hContext,"txn_country",&csOrgTxnCountry)) {
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance() txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance() txn_country is missing!!!\n"));
	}

///org txn ccy 
	if (GetField_CString(hContext,"txn_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance() txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else{
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance() txn_ccy is missing!!!\n"));
	}
///org service Code 
	if (GetField_CString(hContext,"service_code",&csOrgServiceCode)) {
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance() service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance() service_code is missing!!!\n"));
	}

///org merchant id
	if (GetField_CString(hContext,"merchant_id",&csOrgMerchantId)) {
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance() merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance() merchant_id is missing!!!\n"));
	}

///day of week
	if (GetField_Int(hContext,"day_of_week",&iDayOfWeek)) {
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance() day_of_week = [%d]\n",iDayOfWeek));
	}
	else {
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance() day_of_week is missing!!!\n"));
	}

///approximate_fee_rate
	if (GetField_Double(hContext,"approximate_fee_rate",&dFeeRate)) {
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance() approximate_fee_rate = [%lf]\n",dFeeRate));
	}
	else {
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance() approximate_fee_rate is missing!!!\n"));
	}

	if(iRet ==PD_OK){
DEBUGLOG(("BOOLBalance::Call DBOLMerchantBalance:GetRemainPOBalance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetRemainPOBalance");
		if((unsigned long)(*DBObjPtr)(hContext,
					csOrgMerchantId,
					csOrgTxnCcy,
					csOrgTxnCountry,
					csOrgServiceCode,
					&dBal)==PD_OK){
DEBUGLOG(("GetAvalBalance remain payout balance = [%lf]\n",dBal));
			*dActualBalance = dBal;
		}
		else{
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance()  balance for [%s] [%s] [%s] not found\n",csOrgMerchantId,csOrgTxnCcy,csOrgServiceCode));
ERRLOG("BOOLBalance:GetAvalPayoutBalance()  balance for [%s] [%s] [%s] not found\n",csOrgMerchantId,csOrgTxnCcy,csOrgServiceCode);
			*dActualBalance = 0.0;
			*dAvalBalance= 0.0;
			iRet = PD_ERR;
		}
	}
	if(iRet==PD_OK){
			GetField_Double(hContext,"merchant_remain_po_with_fee",&dTmp);
			*dAvalBalance = dTmp;
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance() Aval balance = [%lf]\n",*dAvalBalance));
DEBUGLOG(("BOOLBalance:GetAvalPayoutBalance() Actual balance = [%lf]\n",*dActualBalance));
	}

	return iRet;
}

int UpdatePayoutAmount(hash_t* hContext)
{
	char    *csOrgTxnCountry;
	char    *csOrgTxnCcy;
	char    *csOrgMerchantId;
	char    *csOrgServiceCode;
	char    *csOrgDstCcy;
	char    *csOrgPspId;
	char    cRespMode;
	char    cParty;
	double  dOrgNetAmt=0.0;
	double  dOrgDstTxnAmt=0.0;
	double  dPrecalFee=0.0;
	double  dTmp;
	int     iDayOfWeek=0;
	hash_t* hVal;

	int iRet = PD_OK;

/*org txn country */
	if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_txn_country is missing!!!\n"));
	}

/*org txn ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_txn_ccy is missing!!!\n"));
	}
/*org service code */
	if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_service_code is missing!!!\n"));
	}

/*org merchant id */
	if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_merchant_id is missing!!!\n"));
	}


/*org net amount */
	if (GetField_Double(hContext,"net_amt",&dOrgNetAmt)) {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() net_amt = [%lf]\n",dOrgNetAmt));
	}
	else {
		if (GetField_Double(hContext,"org_net_amt",&dOrgNetAmt)) {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_net_amt = [%lf]\n",dOrgNetAmt));
		}
		else {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_net_amt is missing!!!\n"));
		}
	}
/*response_mode*/
	if (GetField_Char(hContext,"response_mode",&cRespMode)) {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() response_mode = [%c]\n",cRespMode));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() response_mode is missing!!!\n"));
	}

/*party_type*/
	if(GetField_Char(hContext,"party_type",&cParty)){
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() party_type = [%c]\n",cParty));
	}
	else{
		cParty = PD_TYPE_GLOBAL;
	}

/*org psp id */
	if (GetField_CString(hContext,"org_psp_id",&csOrgPspId)) {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_psp_id = [%s]\n",csOrgPspId));
	}
	else {
		if(cParty==PD_TYPE_MERCHANT){
			csOrgPspId = strdup("000");
		}
		else{
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_psp_id is missing!!!\n"));
		}
	}

/*org psp ccy */
	if (GetField_CString(hContext,"org_psp_txn_ccy",&csOrgDstCcy)) {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_psp_txn_ccy = [%s]\n",csOrgDstCcy));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_psp_txn_ccy is missing!!!\n"));
	}
/*org psp txn amount */
	if (GetField_Double(hContext,"org_dst_net_amt",&dOrgDstTxnAmt)) {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_dst_net_amt = [%lf]\n",dOrgDstTxnAmt));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() org_dst_net_amt is missing!!!\n"));
	}

/*org psp precal fee*/
	if (GetField_Double(hContext,"precal_fee",&dPrecalFee)) {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() psp precal_fee = [%lf]\n",dPrecalFee));
	}

/*DayOfWeek*/
	if (GetField_Int(hContext,"day_of_week",&iDayOfWeek)) {
DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() day_of_week = [%d]\n",iDayOfWeek));
	}

	if(cRespMode==PD_ACCEPT){
		iRet = PayoutSuccess(hContext,
					csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt,
					csOrgDstCcy,
					csOrgPspId,
					dOrgDstTxnAmt+dPrecalFee,
					cParty,
					iDayOfWeek);
	}
	else if(cRespMode==PD_REVERSED){
		iRet = PayoutVoided(hContext,
					csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt,
					csOrgDstCcy,
					csOrgPspId,
					dOrgDstTxnAmt+dPrecalFee,
					cParty,
					iDayOfWeek);
	}


	if((iRet==PD_OK) && (cParty!=PD_TYPE_PSP)){
		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csOrgMerchantId,csOrgTxnCcy,csOrgTxnCountry,csOrgServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"current_bal",&dTmp)){
				PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOOLBalance: current_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOOLBalance: total_float= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOOLBalance: total_reserved_amount= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOOLBalance: total_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float_after_payout",&dTmp)){
				PutField_Double(hContext,"total_float_after_payout",dTmp);
DEBUGLOG(("BOOLBalance: total_float_after_payout= [%f]\n",dTmp));
			}

			if(GetField_Double(hVal,"current_bal_settlement",&dTmp)){
				PutField_Double(hContext,"current_bal_settlement",dTmp);
DEBUGLOG(("BOOLBalance: current_bal_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float_settlement",&dTmp)){
				PutField_Double(hContext,"total_float_settlement",dTmp);
DEBUGLOG(("BOOLBalance: total_float_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold_settlement",&dTmp)){
				PutField_Double(hContext,"total_hold_settlement",dTmp);
DEBUGLOG(("BOOLBalance: total_hold_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"fundin_payout",&dTmp)){
				PutField_Double(hContext,"fundin_payout",dTmp);
DEBUGLOG(("BOOLBalance: fundin_payout= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"reserved_payout",&dTmp)){
				PutField_Double(hContext,"reserved_payout",dTmp);
DEBUGLOG(("BOOLBalance: reserved_payout= [%f]\n",dTmp));
			}
		}

		FREE_ME(hVal);

		if(cParty==PD_TYPE_MERCHANT)
			FREE_ME(csOrgPspId);
	}

	if((iRet==PD_OK) && (cParty!=PD_TYPE_MERCHANT)){
		DBObjPtr = CreateObj(DBPtr,"DBPIDBal","GetBalance");
		if((unsigned long)(*DBObjPtr)(csOrgPspId,csOrgTxnCountry,csOrgDstCcy,hContext)!=PD_ERR){
			if(GetField_Double(hContext,"psp_balance",&dTmp)){
DEBUGLOG(("BOOLBalance:psp_balance = [%f]\n",dTmp));
			}
			if(GetField_Double(hContext,"psp_total_hold",&dTmp)){
DEBUGLOG(("BOOLBalance:psp_total_hold = [%f]\n",dTmp));
			}
		}

	}

DEBUGLOG(("BOOLBalance:UpdatePayoutAmount() iRet = [%d]\n",iRet));
	return iRet;

}

int PayoutSuccess(hash_t* hContext,
			const char* csCountry,
			const char* csServiceCode,
			const char* csMerchantCCY,
			const char* csMerchantID,
			double dNetAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			char   cParty,
			int iDayOfWeek)
{
	int     iRet = PD_OK;
	double  dTmp = 0.0;
	double  dRemainDailyCap = 0.0;
	double  dDailyCap = 0.0;
	char    *csEffectDate;
	char    *csDate;
	csEffectDate = (char*) malloc (PD_DATETIME_LEN +1 );

	hash_t* hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

DEBUGLOG(("BOOLBalance:PayoutSuccess()\n"));
DEBUGLOG(("BOOLBalance:PayoutSuccess() merchant = [%lf], psp = [%lf]\n",dNetAmount,dPspAmount));

/* lock opening balance */
	if (cParty!=PD_TYPE_PSP) {
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetOpenBalanceForUpdate");
		if ((*DBObjPtr)(hContext,
				csMerchantID,
				csMerchantCCY,
				csCountry,
				csServiceCode) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:PayoutSuccess() GetOpenBalanceForUpdate Failed\n"));
			return iRet;
		}
	}

/***** update  Context for approval date and approval timestamp */
	DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
	(*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:PayoutSuccess()  SystemControl::GetApprovalDT called\n"));
	if(GetField_CString(hContext,"approval_date",&csDate)){
		iDayOfWeek=day_of_week((const unsigned char *)csDate);
	}

	if (cParty==PD_TYPE_MERCHANT || cParty==PD_TYPE_GLOBAL) {
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateCurrBal");
		if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				(-1)*dNetAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DBOLMerchantBalance::UpdateCurrBal()  Failed\n"));
			return iRet;
		}

		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantReservedAmt","GetDailyCapforUpdate");
		if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				iDayOfWeek,
				&dDailyCap,
				&dRemainDailyCap,
				csEffectDate) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DBOLMerchantReservedAmt::GetDailyCapforUpdate()  Failed\n"));
			return iRet;
		}
		if(dDailyCap > 0.0 && dRemainDailyCap >=dNetAmount){
			PutField_CString(hTxn,"merchant_id",csMerchantID);
			PutField_CString(hTxn,"txn_country",csCountry);
			PutField_CString(hTxn,"txn_ccy",csMerchantCCY);
			PutField_CString(hTxn,"service_code",csServiceCode);
			PutField_Int(hTxn,"dow",iDayOfWeek);
			PutField_CString(hTxn,"effect_date",csEffectDate);
			PutField_Double(hTxn,"remain_daily_cap",dRemainDailyCap-dNetAmount);
			PutField_Char(hTxn,"amt_type",PD_RES_AMT_DAILY_CAP);
			PutField_Char(hTxn,"status",PD_RES_AMT_STATUS_APPROVE);
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantReservedAmt","UpdateAmt");
			if ((*DBObjPtr)(hTxn) != PD_OK) {
				iRet = INT_ERR;
				FREE_ME(csEffectDate);
				FREE_ME(hTxn);
DEBUGLOG(("BOOLBalance:DBOLMerchantReservedAmt::UpdateAmt()  Failed\n"));
				return iRet;
			}
		}

	}
	if(cParty==PD_TYPE_MERCHANT){
		if(GetField_Double(hContext,"deduct_reserved_po",&dTmp)){
			if(dTmp>0.0){
				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdatePayoutReserved");
				if ((*DBObjPtr)(csMerchantID,
						csCountry,
						csMerchantCCY,
						csServiceCode,
						(-1)*dTmp,
						PD_UPDATE_USER) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DBOLMerchantBalance::UpdatePayoutReserved()  Failed\n"));
					return iRet;
				}
			}
		}
		if(GetField_Double(hContext,"deduct_fundin_po",&dTmp)){
			if(dTmp>0.0){
				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateFundInPayout");
				if ((*DBObjPtr)(csMerchantID,
						csCountry,
						csMerchantCCY,
						csServiceCode,
						(-1)*dTmp,
						PD_UPDATE_USER) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DBOLMerchantBalance::UpdateFundInPayout()  Failed\n"));
					return iRet;
				}
			}
		}
	}

	if (cParty==PD_TYPE_PSP || cParty==PD_TYPE_GLOBAL) {
DEBUGLOG(("BOOLBalance:PayoutSuccess DebitPSP AvalBalance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLPIDBal","UpdateBalance");
		if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				PD_IND_DEBIT,
				dPspAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DBOLPIDBal::DebitBalance() Failed\n"));
		}
	}

	FREE_ME(csEffectDate);
	FREE_ME(hTxn);
DEBUGLOG(("BOOLBalance:PayoutSuccess() iRet = [%d]\n",iRet));
	return iRet;
}
int PayoutVoided(hash_t* hContext,
		const char* csCountry,
		const char* csServiceCode,
		const char* csMerchantCCY,
		const char* csMerchantID,
		double dNetAmount,
		const char* csPspCCY,
		const char* csPspID,
		double dPspAmount,
		char   cParty,
		int iDayOfWeek)
{
	int iRet = PD_OK;
	int iSameDate = PD_FALSE;
	double  dRemainDailyCap = 0.0;
	double  dDailyCap = 0.0;
	char    *csPostingDate;
	char    *csEffectDate;
	csEffectDate = (char*) malloc (PD_DATETIME_LEN +1 );

	hash_t* hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

DEBUGLOG(("BOOLBalance:PayoutVoided()\n"));
DEBUGLOG(("BOOLBalance:PayoutVoided() merchant = [%lf], psp = [%lf]\n",dNetAmount,dPspAmount));

	if(GetField_Int(hContext,"same_date_cancel",&iSameDate)){
DEBUGLOG(("BOOLBalance:PayoutVoided() same_date_cancel [%d]\n",iSameDate));
	}


/* lock opening balance */
	if (cParty!=PD_TYPE_PSP) {
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetOpenBalanceForUpdate");
		if ((*DBObjPtr)(hContext,
				csMerchantID,
				csMerchantCCY,
				csCountry,
				csServiceCode) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:PayoutVoided() GetOpenBalanceForUpdate Failed\n"));
			return iRet;
		}
	}

/***** update  Context for approval date and approval timestamp */
	DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
	(*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:PayoutVoided()  SystemControl::GetApprovalDT called\n"));
	if(GetField_CString(hContext,"approval_date",&csPostingDate)){
		iDayOfWeek=day_of_week((const unsigned char *)csPostingDate);
	}

	if (cParty==PD_TYPE_MERCHANT) {
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateCurrBal");
		if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dNetAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DBOLMerchantBalance::UpdateCurrBal() Failed\n"));
		}

		if(iSameDate==PD_TRUE){
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantReservedAmt","GetDailyCapforUpdate");
			if ((*DBObjPtr)(csMerchantID,
					csCountry,
					csMerchantCCY,
					csServiceCode,
					iDayOfWeek,
					&dDailyCap,
					&dRemainDailyCap,
					csEffectDate) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DBOLMerchantReservedAmt::GetDailyCapforUpdate()  Failed\n"));
				return iRet;
			}

			PutField_CString(hTxn,"merchant_id",csMerchantID);
			PutField_CString(hTxn,"txn_country",csCountry);
			PutField_CString(hTxn,"txn_ccy",csMerchantCCY);
			PutField_CString(hTxn,"service_code",csServiceCode);
			PutField_Int(hTxn,"dow",iDayOfWeek);
			PutField_CString(hTxn,"effect_date",csEffectDate);
			PutField_Double(hTxn,"remain_daily_cap",dRemainDailyCap+dNetAmount);
			PutField_Char(hTxn,"amt_type",PD_RES_AMT_DAILY_CAP);
			PutField_Char(hTxn,"status",PD_RES_AMT_STATUS_APPROVE);
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantReservedAmt","UpdateAmt");
			if ((*DBObjPtr)(hTxn) != PD_OK) {
				iRet = INT_ERR;
				FREE_ME(csEffectDate);
				FREE_ME(hTxn);
DEBUGLOG(("BOOLBalance:DBOLMerchantReservedAmt::UpdateAmt()  Failed\n"));
				return iRet;
			}
		}

	}
/*
	if (cParty==PD_TYPE_GLOBAL){ 
	    //((cParty==PD_TYPE_MERCHANT) && (iSameDate==PD_FALSE))) {
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateFloat");
		if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dNetAmount,
				0.0,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DBOLMerchantBalance::UpdateFloat() Failed\n"));
			return iRet;
		}
	}
*/
	if (cParty==PD_TYPE_PSP || cParty==PD_TYPE_GLOBAL) {
DEBUGLOG(("BOOLBalance:PayoutVoided CreditPSP AvalBalance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLPIDBal","UpdateBalance");
		if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				PD_IND_CREDIT,
				dPspAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DBOLPIDBal::CreditBalance() Failed\n"));
		}
	}

	FREE_ME(csEffectDate);
	FREE_ME(hTxn);
DEBUGLOG(("BOOLBalance:PayoutVoided() iRet = [%d]\n",iRet));
	return iRet;
}


int UpdateSettlementAmount(hash_t *hContext)
{
	int     iRet = PD_OK;
	char    *csTxnCode;
	char    *csSubTxnCode;
	char    *csOrgTxnSeq;
	char    *csOrgTxnCountry;
	char    *csOrgTxnCcy;
	char    *csOrgMerchantId;
	char    *csOrgServiceCode;
	double  dOrgNetAmt=0.0;
	double  dFee=0.0;
	double  dTmp;
	hash_t* hVal;


DEBUGLOG(("BOOLBalance:UpdateSettlementAmount()\n"));

//txn code
	if (GetField_CString(hContext,"txn_code",&csTxnCode)) {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() txn_code = [%s]\n",csTxnCode));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() txn_code is missing!!!\n"));
	}
//org txn seq
	if (GetField_CString(hContext,"txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() txn_seq = [%s]\n",csOrgTxnSeq));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() txn_seq is missing!!!\n"));
	}

//org txn country
	if (GetField_CString(hContext,"txn_country",&csOrgTxnCountry)) {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() txn_country is missing!!!\n"));
	}

///org txn ccy
	if (GetField_CString(hContext,"request_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
		if (GetField_CString(hContext,"txn_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() txn_ccy = [%s]\n",csOrgTxnCcy));
		}
		else{
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() txn_ccy is missing!!!\n"));
		}
	}
///org service Code
	if (GetField_CString(hContext,"service_code",&csOrgServiceCode)) {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() service_code is missing!!!\n"));
	}

///org merchant id
	if (GetField_CString(hContext,"merchant_id",&csOrgMerchantId)) {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() merchant_id is missing!!!\n"));
	}

///org net amount 
	if (GetField_Double(hContext,"net_amt",&dOrgNetAmt)) {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() net_amt = [%lf]\n",dOrgNetAmt));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() net_amt is missing!!!\n"));
	}

///fee
	if (GetField_Double(hContext,"src_txn_fee",&dFee)) {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() fee = [%lf]\n",dFee));
	}

//sub_txn_code
	if (GetField_CString(hContext,"sub_txn_code",&csSubTxnCode)) {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() sub_txn_code = [%s]\n",csSubTxnCode));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() sub_txn_code is missing!!!\n"));
	}


DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() Update Avi Settlement Balance\n"));

	if(!strcmp(csTxnCode,PD_OL_SETTLEMENT_REQUEST)){
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() Call DBOLMerchantBalance:UpdateSettInTransit[%c]\n",PD_IND_CREDIT));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateSettInTransit");
		iRet = (unsigned long)(*DBObjPtr)(csOrgMerchantId,
						csOrgTxnCountry,
						csOrgTxnCcy,
						csOrgServiceCode,
						dOrgNetAmt,
						PD_IND_CREDIT,
						PD_UPDATE_USER);
	}

	else if(!strcmp(csTxnCode,PD_SETTLEMENT_CANCEL)){
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() Call DBOLMerchantBalance:UpdateSettInTransit[%c]\n",PD_IND_DEBIT));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateSettInTransit");
		iRet = (unsigned long)(*DBObjPtr)(csOrgMerchantId,
						csOrgTxnCountry,
						csOrgTxnCcy,
						csOrgServiceCode,
						dOrgNetAmt,
						PD_IND_DEBIT,
						PD_UPDATE_USER);
	}
	else if(!strcmp(csTxnCode,PD_SETTLEMENT_DELIVERY)){
		iRet = PD_OK;
	}
	else if(!strcmp(csTxnCode,PD_SETTLEMENT_APPROVAL)){

/* lock opening balance */
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetOpenBalanceForUpdate");
		if ((*DBObjPtr)(hContext,
				csOrgMerchantId,
				csOrgTxnCcy,
				csOrgTxnCountry,
				csOrgServiceCode) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() GetOpenBalanceForUpdate Failed\n"));
		}
		else {
/***** update  Context for approval date and approval timestamp */
			DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
			(*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount()  SystemControl::GetApprovalDT called\n"));

			/* merchant_open_bal */
			if (GetField_Double(hContext, "merchant_open_bal", &dTmp)) {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() merchant_open_bal = [%lf]\n",dTmp));
				PutField_Double(hContext, "open_bal", dTmp);
			}

			/* merchant_open_bal_settlement */
			if (GetField_Double(hContext, "merchant_open_bal_settlement", &dTmp)) {
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() merchant_open_bal_settlement = [%lf]\n",dTmp));
				PutField_Double(hContext, "open_bal_settlement", dTmp);
			}
		}

DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() Call DBOLMerchantBalance:UpdateSettBal[%c]\n",PD_IND_DEBIT));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateSettBal");
		iRet = (unsigned long)(*DBObjPtr)(csOrgMerchantId,
						csOrgTxnCountry,
						csOrgTxnCcy,
						csOrgServiceCode,
						dOrgNetAmt,
						dFee,
						PD_IND_DEBIT,
						PD_UPDATE_USER);

		if(iRet==PD_OK){
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() Call DBOLMerchantBalance:UpdateSettInTransit[%c]\n",PD_IND_DEBIT));
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateSettInTransit");
			iRet = (unsigned long)(*DBObjPtr)(csOrgMerchantId,
						csOrgTxnCountry,
						csOrgTxnCcy,
						csOrgServiceCode,
						dOrgNetAmt+dFee,
						PD_IND_DEBIT,
						PD_UPDATE_USER);
		}
	}
	else if (!strcmp(csTxnCode, PD_VOID_TXN_CODE) && !strcmp(csSubTxnCode, PD_SETTLEMENT_VOID))  {
/* lock opening balance */
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetOpenBalanceForUpdate");
		if ((*DBObjPtr)(hContext,
				csOrgMerchantId,
				csOrgTxnCcy,
				csOrgTxnCountry,
				csOrgServiceCode) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() GetOpenBalanceForUpdate Failed\n"));
		}

/***** update  Context for approval date and approval timestamp */
		DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
		(*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:UpdateSettlementAmount()  SystemControl::GetApprovalDT called\n"));

DEBUGLOG(("BOOLBalance:UpdateSettlementAmount() Call DBOLMerchantBalance:UpdateSettBal[%c]\n",PD_IND_CREDIT));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateSettBal");
		iRet = (unsigned long)(*DBObjPtr)(csOrgMerchantId,
						csOrgTxnCountry,
						csOrgTxnCcy,
						csOrgServiceCode,
						dOrgNetAmt,
						dFee,
						PD_IND_CREDIT,
						PD_UPDATE_USER);
	}

	else {
DEBUGLOG(("BOOLBalance:None Settlement txn\n"));
		return iRet;
	}


		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csOrgMerchantId,csOrgTxnCcy,csOrgTxnCountry,csOrgServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"current_bal",&dTmp)){
				PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOOLBalance: current_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"current_bal_settlement",&dTmp)){
				PutField_Double(hContext,"current_bal_settlement",dTmp);
DEBUGLOG(("BOOLBalance: current_bal_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOOLBalance: total_float= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float_after_payout",&dTmp)){
				PutField_Double(hContext,"total_float_after_payout",dTmp);
DEBUGLOG(("BOOLBalance: total_float_after_payout= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float_settlement",&dTmp)){
				PutField_Double(hContext,"total_float_settlement",dTmp);
DEBUGLOG(("BOOLBalance: total_float_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOOLBalance: total_reserved_amount= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOOLBalance: total_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold_settlement",&dTmp)){
				PutField_Double(hContext,"total_hold_settlement",dTmp);
DEBUGLOG(("BOOLBalance: total_hold_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"fundin_payout",&dTmp)){
				PutField_Double(hContext,"fundin_payout",dTmp);
DEBUGLOG(("BOOLBalance: fundin_payout= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"reserved_payout",&dTmp)){
				PutField_Double(hContext,"reserved_payout",dTmp);
DEBUGLOG(("BOOLBalance: reserved_payout= [%f]\n",dTmp));
			}
		}

		FREE_ME(hVal);
DEBUGLOG(("BOOLBalance iRet=[%d]\n",iRet));
	return iRet;
}

int DebitSebBalance(hash_t *hContext, const hash_t *hRequest)
{
	int     iRet = PD_OK;
	int     iCnt = 0;
	char*   csBankCcy;
	char*   csTxnId;
	char*   csTmp;
	char    csTag[PD_TAG_LEN+1];
	double  dNetAmt;
	double  dTmp;
	double  dBal;
	double  dRate;
	double  dRatio;
	double  dTotalAmt=0;
	hash_t* hRec;
	hash_t* hVal;
	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

DEBUGLOG(("BOOLBalance:DebitSebBalance()\n"));

//txn_seq
	if (GetField_CString(hContext,"txn_seq",&csTxnId)) {
		PutField_CString(hVal,"txn_id",csTxnId);
DEBUGLOG(("BOOLBalance:DebitSebBalance()txn_seq = [%s]\n",csTxnId));
	}
	else {
DEBUGLOG(("BOOLBalance:DebitSebBalance() txn_seq is missing!!!\n"));
	}

//bank_ccy
	if (GetField_CString(hContext,"bank_ccy",&csBankCcy)) {
DEBUGLOG(("BOOLBalance:DebitSebBalance() bank_ccy = [%s]\n",csBankCcy));
	}
	else {
DEBUGLOG(("BOOLBalance:DebitSebBalance() bank_ccy is missing!!!\n"));
	}

///net amount
	if (GetField_Double(hContext,"bank_bal",&dNetAmt)) {
DEBUGLOG(("BOOLBalance:DebitSebBalance() bank_bal = [%lf]\n",dNetAmt));
	}
	else {
DEBUGLOG(("BOOLBalance:DebitSebBalance() bank_bal is missing!!!\n"));
	}

	DBObjPtr = CreateObj(DBPtr,"DBSebBalance","FindBankBalanceInfo");
	if ((*DBObjPtr)(csBankCcy,rRecordSet) == PD_OK) {
DEBUGLOG(("FindBankBalanceInfo::found record = [%s]\n",csBankCcy));
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if(GetField_CString(hRec,"from_ccy",&csTmp)){
				sprintf(csTag,"from_ccy_%d",iCnt);
				PutField_CString(hVal,csTag,csTmp);
				PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("FindBankBalanceInfo::%s= [%s]\n",csTag,csTmp));
			}
			if(GetField_Double(hRec,"bank_bal",&dTmp)){
				sprintf(csTag,"bank_bal_%d",iCnt);
				PutField_Double(hVal,csTag,dTmp);
				sprintf(csTag,"old_bal_%d",iCnt);
				PutField_Double(hContext,csTag,dTmp);
DEBUGLOG(("FindBankBalanceInfo::%s= [%lf]\n",csTag,dTmp));

				dTotalAmt += dTmp;
			}
			if(GetField_Double(hRec,"rate",&dTmp)){
				sprintf(csTag,"rate_%d",iCnt);
				PutField_Double(hVal,csTag,dTmp);
DEBUGLOG(("FindBankBalanceInfo::%s= [%lf]\n",csTag,dTmp));
			}
			if(GetField_Double(hRec,"ratio",&dTmp)){
				sprintf(csTag,"ratio_%d",iCnt);
				PutField_Double(hVal,csTag,dTmp);
DEBUGLOG(("FindBankBalanceInfo::%s= [%lf]\n",csTag,dTmp));
			}

			iCnt++;
			PutField_Int(hContext,"seb_ccy_cnt",iCnt);
			hRec = RecordSet_GetNext(rRecordSet);
		}
		if(dTotalAmt<dNetAmt){
DEBUGLOG(("BOOLBalance:DebitSebBalance:Not enought amount[%s][%lf]\n",csBankCcy,dTotalAmt));
		}
		PutField_Double(hContext,"bal_after_fo",dTotalAmt-dNetAmt);
	}
	else{
		iRet=PD_SKIP_OK;
DEBUGLOG(("BOOLBalance:DebitSebBalance:FindBankBalanceInfo::record not found[%s]\n",csBankCcy));
	}


	if(iRet==PD_OK){
		int i;
		for(i=0;i<iCnt;i++){
			sprintf(csTag,"from_ccy_%d",i);
			GetField_CString(hVal,csTag,&csTmp);
			PutField_CString(hVal,"txn_ccy",csTmp);

			sprintf(csTag,"bank_bal_%d",i);
			GetField_Double(hVal,csTag,&dBal);

			sprintf(csTag,"rate_%d",i);
			GetField_Double(hVal,csTag,&dRate);
			PutField_Double(hVal,"rate",dRate);

			sprintf(csTag,"ratio_%d",i);
			GetField_Double(hVal,csTag,&dRatio);
			PutField_Double(hVal,"ratio",dRatio);

			dTmp = dBal-(dNetAmt*dRatio);
			PutField_Double(hVal,"txn_amt",(dNetAmt*dRatio));
			sprintf(csTag,"fundout_amt_%d",i);
			PutField_Double(hContext,csTag,(dNetAmt*dRatio));
			sprintf(csTag,"new_bal_%d",i);
			PutField_Double(hContext,csTag,dTmp);

DEBUGLOG(("BOOLBalance:DebitSebBalance:Call DBSebBalance:UpdateBankBalance[%s][%s][%lf]\n",csTmp,csBankCcy,dTmp));
			DBObjPtr = CreateObj(DBPtr,"DBSebBalance","UpdateBankBalance");
			if((*DBObjPtr)(csTmp,csBankCcy,dTmp)!=PD_OK){
DEBUGLOG(("BOOLBalance:DebitSebBalance:UpdateBankBalance[%s][%s][%lf] Failed\n",csTmp,csBankCcy,dTmp));
				iRet = PD_ERR;
				break;
			}
			else{
DEBUGLOG(("BOOLBalance:DebitSebBalance:Call TxnSetContributors:Add\n"));
				PutField_CString(hVal,"add_user",PD_UPDATE_USER);
				DBObjPtr = CreateObj(DBPtr,"DBTxnSetContributors","Add");
				if((*DBObjPtr)(hVal)!=PD_OK){
DEBUGLOG(("BOOLBalance:DebitSebBalance:TxnSetContributors:Add Failed\n"));
					iRet = PD_ERR;
					break;
				}
			}
		}
	}

	if(iRet==PD_SKIP_OK)
		iRet = PD_OK;

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hVal);
	return  iRet;
}

int RestoreSebBalance(hash_t *hContext, const hash_t *hRequest)
{
	int     iRet = PD_OK;
	int     i, iCnt = 0;
	char    *csOrgTxnSeq;
	char    *csTxnCode;
	char    *csFromCcy;
	char    *csToCcy;
	char    csTag[PD_TAG_LEN+1];
	double  dTmp,dRate,dRatio,dAmt,dCalRate,dOrgBankAmt,dOrgRate,dOrgRatio;
	double  dCalRatio_D=0;
	hash_t  *hRec, *hVal, *hTxn;

	hTxn = (hash_t*)  malloc (sizeof(hash_t));
	hash_init(hTxn,0);
	hVal = (hash_t*)  malloc (sizeof(hash_t));
	hash_init(hVal,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("BOOLBalance:RestoreSebBalance() org_txn_seq = [%s]\n",csOrgTxnSeq));
	}
	else{
DEBUGLOG(("BOOLBalance:RestoreSebBalance() org_txn_seq is missing!!!\n"));
	}

	if (GetField_CString(hContext,"new_txn_code",&csTxnCode)) {
DEBUGLOG(("BOOLBalance:RestoreSebBalance() new_txn_code = [%s]\n",csTxnCode));
	}
	else{
DEBUGLOG(("BOOLBalance:RestoreSebBalance() new_txn_code is missing!!!\n"));
	}

	if(!strcmp(csTxnCode,PD_SETTLEMENT_VOID)){
DEBUGLOG(("Authorize::Call DBOLMerchantSettlementDetail:GetSettlementDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantSettlementDetail","GetSettlementDetail");
		if((unsigned long)(*DBObjPtr)(csOrgTxnSeq,rRecordSet)==PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if(GetField_CString(hRec,"deliver_ccy",&csToCcy)){
					PutField_CString(hTxn,"bank_ccy",csToCcy);
DEBUGLOG(("GetSettlementDetail::to_ccy = [%s]\n",csToCcy));
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}
	else{ //if(!strcmp(csTxnCode,PD_FUND_IN_PAYOUT_MERCHANT_VOID)){
DEBUGLOG(("Authorize::Call DBOLTransaction:GetTxnDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","GetTxnDetail");
		if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec,"txn_ccy",&csToCcy)) {
					PutField_CString(hTxn,"bank_ccy",csToCcy);
DEBUGLOG(("GetTxnDetail::to_ccy = [%s]\n",csToCcy));
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}
	RecordSet_Destroy(rRecordSet);

DEBUGLOG(("BOOLBalance:RestoreSebBalance:Call TxnSetContributors:GetContributors\n"));
	recordset_init(rRecordSet,0);
	DBObjPtr = CreateObj(DBPtr,"DBTxnSetContributors","GetContributors");
	if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet)==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			sprintf(csTag,"txn_ccy_%d",iCnt);
			if (GetField_CString(hRec,"txn_ccy",&csFromCcy)) {
				PutField_CString(hTxn,csTag,csFromCcy);
DEBUGLOG(("GetContributors::%s = [%s]\n",csTag,csFromCcy));
			}
			sprintf(csTag,"rate_%d",iCnt);
			if (GetField_Double(hRec,"rate",&dRate)) {
DEBUGLOG(("GetContributors::%s = [%lf]\n",csTag,dRate));
			}
			sprintf(csTag,"ratio_%d",iCnt);
			if (GetField_Double(hRec,"ratio",&dRatio)) {
DEBUGLOG(("GetContributors::%s = [%lf]\n",csTag,dRatio));
			}
			sprintf(csTag,"txn_amt_%d",iCnt);
			if (GetField_Double(hRec,"txn_amt",&dAmt)) {
DEBUGLOG(("GetContributors::%s = [%lf]\n",csTag,dAmt));
			}

			dCalRatio_D += dAmt;

DEBUGLOG(("BOOLBalance:RestoreSebBalance:Call DBSebBalance:FindBalanceByCcy\n"));
			DBObjPtr = CreateObj(DBPtr,"DBSebBalance","FindBalanceByCcy");
			if ((unsigned long)(*DBObjPtr)(csFromCcy,csToCcy,hVal) == PD_FOUND) {
				if (GetField_Double(hVal,"bank_bal",&dOrgBankAmt)) {
DEBUGLOG(("FindBalanceByCcy : org_bank_amt = [%f]\n", dOrgBankAmt));
				}
				if (GetField_Double(hVal,"rate",&dOrgRate)) {
DEBUGLOG(("FindBalanceByCcy : org_rate = [%f]\n", dOrgRate));
				}
				if (GetField_Double(hVal,"ratio",&dOrgRatio)) {
DEBUGLOG(("FindBalanceByCcy : org_ratio = [%f]\n", dOrgRatio));
				}

				dCalRate = newround(((dRate*dAmt)+(dOrgRate*dOrgBankAmt))/(dAmt+dOrgBankAmt),PD_ROUND_UP_DEC);
				dCalRatio_D += dOrgBankAmt;

				sprintf(csTag,"rate_%d",iCnt);
				PutField_Double(hTxn,csTag,dCalRate);
				sprintf(csTag,"amt_%d",iCnt);
				PutField_Double(hTxn,csTag,(dAmt+dOrgBankAmt));

			}
			else{
				iRet = PD_ERR;
DEBUGLOG(("BOOLBalance:RestoreSebBalance:FindBalanceByCcy ERROR!!!\n"));
				break;
			}

			iCnt++;
			hRec = RecordSet_GetNext(rRecordSet);
		}

		for(i=0; i<iCnt; i++){
			sprintf(csTag,"txn_ccy_%d",i);
			if(GetField_CString(hTxn,csTag,&csFromCcy)){
				PutField_CString(hTxn,"from_ccy",csFromCcy);
DEBUGLOG(("BOOLBalance:RestoreSebBalance:[%s][%s]\n",csFromCcy,csToCcy));
			}
			sprintf(csTag,"rate_%d",i);
			if(GetField_Double(hTxn,csTag,&dTmp)){
				PutField_Double(hTxn,"rate",dTmp);
DEBUGLOG(("BOOLBalance:RestoreSebBalance:new rate=[%lf]\n",dTmp));
			}
			sprintf(csTag,"amt_%d",i);
			if(GetField_Double(hTxn,csTag,&dTmp)){
				dRatio = newround((dTmp/dCalRatio_D),PD_ROUND_UP_DEC);
				PutField_Double(hTxn,"ratio",dRatio);
DEBUGLOG(("BOOLBalance:RestoreSebBalance:new ratio=[%lf]\n",dRatio));

				PutField_Double(hTxn,"bank_bal",dTmp);
DEBUGLOG(("BOOLBalance:RestoreSebBalance:new bank_bal=[%lf]\n",dTmp));
			}

DEBUGLOG(("BOOLBalance:RestoreSebBalance:Update SebBalance table\n"));
			DBObjPtr = CreateObj(DBPtr,"DBSebBalance","Add");
			iRet = (unsigned long)(*DBObjPtr)(hTxn);

		}
	}


	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);
	FREE_ME(hVal);
	return iRet;
}

int  ProcessFundinPayout(hash_t *hContext)
{
	int iRet = PD_OK;

	char    *csTxnCcy;
	char    *csTxnCountry;
	char    cPartyType;
	char    *csPspId;
	char    *csMerchantId;
	char    *csServiceCode;
	char    *csUser;
	char    cDCInd;
	int     iChgBalMode;
	int     iVoidFlag = PD_FALSE;
	double  dFundinAmt = 0.0;
	double  dFee = 0.0;

	double  dTmp = 0.0;
	//double  dPspBal = 0.0;
	double  dOrgFundinAmt = 0.0;
	double  dNetFundinAmt = 0.0;
	double  dBalInPsp = 0.0;
	char    *csTmp;
	double  dMarkupAmt = 0.0;

	hash_t *hVal;
	hVal = (hash_t*) malloc (sizeof(hash_t));

	if (GetField_CString(hContext, "txn_seq", &csTmp)) {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout: txn_seq [%s]\n", csTmp));
		PutField_CString(hContext, "from_txn_seq", csTmp);
	}

/* party_type */
	if(GetField_Char(hContext,"party_type",&cPartyType)){
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() party_type = [%c]\n",cPartyType));
	}

/*merchant id */
	if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() merchant_id = [%s]\n",csMerchantId));
	}

/*psp id */
	if (GetField_CString(hContext,"psp_id",&csPspId)) {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout () psp_id = [%s]\n",csPspId));
	}

/*txn country */
	if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() txn_country = [%s]\n",csTxnCountry));
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() txn_country is missing!!!\n"));
	}

/* txn ccy */
	if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() txn_ccy = [%s]\n",csTxnCcy));
		PutField_CString(hContext, "org_txn_ccy", csTxnCcy);
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() txn_ccy is missing!!!\n"));
	}

/*service code */
	if (GetField_CString(hContext,"service_code",&csServiceCode)) {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() service_code = [%s]\n",csServiceCode));
	}
/* dc_ind */
	if (GetField_Char(hContext, "dc_ind", &cDCInd)) {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() dc_ind = [%c]\n",cDCInd));
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() dc_ind is missing!!!\n"));
		iRet = INT_ERR;
	}

/* chg_bal_mode */
	if (GetField_Int(hContext, "chg_bal_mode", &iChgBalMode)) {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() chg_bal_mode = [%d]\n",iChgBalMode));
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() chg_bal_mode is missing!!!\n"));
		iRet = INT_ERR;
	}

/*amount */
	if (GetField_Double(hContext,"txn_amt",&dFundinAmt)) {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() fundin_amt = [%lf]\n",dFundinAmt));
		PutField_Double(hContext, "org_txn_amt", dFundinAmt);
	}

/* fee */
	if (GetField_Double(hContext, "src_txn_fee", &dFee)) {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() fundin_fee = [%lf]\n",dFee));
	}

/* fee_ccy */
	if (GetField_CString(hContext, "src_txn_fee_ccy", &csTmp)) {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() fundin_fee_ccy = [%s]\n",csTmp));
	}


/*update_user*/
	if (GetField_CString(hContext,"update_user",&csUser)) {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() update_user = [%s]\n",csUser));
	}

/* void_flag */
	if (GetField_Int(hContext,"void_flag",&iVoidFlag)) {
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() void_flag  = [%d]\n",iVoidFlag));
	}

	// Check Valid to process
	if (cPartyType == PD_TYPE_MERCHANT) {
		hash_init(hVal,0);

DEBUGLOG(("BOOLBalance: ProcessFundinPayout: DBOLMerchantBalance->GetOpenBalanceForUpdate\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetOpenBalanceForUpdate");
		if((unsigned long)(*DBObjPtr)(hVal, csMerchantId,csTxnCcy,csTxnCountry,csServiceCode)!=PD_ERR) {

			if (GetField_Double(hVal, "merchant_open_bal", &dBalInPsp)) {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout open_bal = [%f]\n",dBalInPsp));
				PutField_Double(hContext, "merchant_open_bal", dBalInPsp);
			}

			if (GetField_Double(hVal, "merchant_open_bal_settlement", &dTmp)) {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout open_bal_settlement = [%f]\n",dTmp));
				PutField_Double(hContext,"merchant_open_bal_settlement",dTmp);
			}

			if (GetField_Double(hVal, "fundin_payout", &dOrgFundinAmt)) {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout fundin_payout = [%f]\n",dOrgFundinAmt));
			}


			if (cDCInd == PD_IND_CREDIT) {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout Credit, no need check org fundin_payout\n"));
			} else if (cDCInd == PD_IND_DEBIT) {

				if (dOrgFundinAmt < dFundinAmt) {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout: Original Fundin [%lf] < Debit Fundin [%lf]\n",dOrgFundinAmt, dFundinAmt));
ERRLOG("BOOLBalance: ProcessFundinPayout: Original Fundin [%lf] < Debit Fundin [%lf]\n",dOrgFundinAmt, dFundinAmt);
					iRet = INT_INVALID_PAY_AMOUNT;
				}

				if (dBalInPsp < dFundinAmt) {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout: Original BalInPsp[%lf] < Debit Fundin [%lf]\n",dBalInPsp, dFundinAmt));
ERRLOG("BOOLBalance: ProcessFundinPayout: Original BalInPsp [%lf] < Debit Fundin [%lf]\n",dBalInPsp, dFundinAmt);
					iRet = INT_INVALID_PAY_AMOUNT;
				}
			}
			else if (cDCInd == PD_IND_OVERWRITE){
				if (dOrgFundinAmt < dFundinAmt) {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout: Original Fundin [%lf] < Debit Fundin [%lf]\n",dOrgFundinAmt, dFundinAmt));
ERRLOG("BOOLBalance: ProcessFundinPayout: Original Fundin [%lf] < Debit Fundin [%lf]\n",dOrgFundinAmt, dFundinAmt);
					iRet = INT_INVALID_PAY_AMOUNT;
				}
			}
		}
		else {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout: DBOLMerchantBalance->GetOpenBalanceForUpdate Failed\n"));
ERRLOG("BOOLBalance: ProcessFundinPayout: DBOLMerchantBalance->GetOpenBalanceForUpdate Failed\n");
			iRet=PD_ERR;
		}

		hash_destroy(hVal);

	}

	else if (cPartyType == PD_TYPE_PSP) {
	/* do nothing in cut-down version
		hash_init(hVal,0);

DEBUGLOG(("BOOLBalance: ProcessFundinPayout: DBPspBalance->GetBalanceForUpdate\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalanceForUpdate");
		if ((unsigned long)(*DBObjPtr)(csPspId,csTxnCountry,csTxnCcy,hVal)==PD_OK) {

			if (GetField_Double(hVal,"balance",&dPspBal)) {
DEBUGLOG(("BOOLBalance::ProcessFundinPayout PSP balance = [%f]\n",dPspBal));
			}
			if (GetField_Double(hVal,"total_hold",&dTmp)) {
DEBUGLOG(("BOOLBalance::ProcessFundinPayout PSP total_hold = [%f]\n",dTmp));
			}
		}
		else {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout: DBPspBalance->GetBalance Failed\n"));
ERRLOG("BOOLBalance: ProcessFundinPayout: DBPspBalance->GetBalance Failed\n");
			iRet=INT_ERR;
		}

		hash_destroy(hVal);

		if (cDCInd == PD_IND_DEBIT) {

			if (dPspBal < dFundinAmt) {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout: Not enought Bal [%lf] Fundin [%lf]\n", dPspBal, dFundinAmt));
ERRLOG("BOOLBalance: ProcessFundinPayout: Not enouthg Bal [%lf] Fundin [%lf]\n", dPspBal, dFundinAmt);
				iRet=INT_ERR;
		       }
		}
	*/
	}

	// Handle Balance / Fundin payout
	if (iRet == PD_OK) {

		/***** update  Context for approval date and approval timestamp */
		DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
		(*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:ProcessFundinPayout()  SystemControl::GetApprovalDT called\n"));

		if (cPartyType == PD_TYPE_MERCHANT) {

			if (iChgBalMode == PD_TRUE) {

DEBUGLOG(("BOOLBalance: ProcessFundinPayout: DBOLMerchantBalance->SetFundInPayout\n"));
				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","SetFundInPayout");
				if (cDCInd == PD_IND_DEBIT) {
					dTmp = (-1) * (dFundinAmt - dFee);
					PutField_Double(hContext, "net_amt", (dFundinAmt - dFee));
				}
				else  {
					dTmp = dFundinAmt - dFee;
					PutField_Double(hContext, "net_amt", dTmp);
				}
				iRet = (unsigned long)(*DBObjPtr)(csMerchantId,
								  csTxnCountry,
								  csTxnCcy,
								  csServiceCode,
								  dTmp,
								  csUser);
			} else {
				if (cDCInd == PD_IND_CREDIT) {

					dNetFundinAmt = dOrgFundinAmt + dFundinAmt;
DEBUGLOG(("BOOLBalance: ProcessFundinPayout: Credit NetAmount = [%lf]\n", dNetFundinAmt));
					dTmp = dFundinAmt;

				} else if (cDCInd == PD_IND_DEBIT) {
					dNetFundinAmt = dOrgFundinAmt - dFundinAmt;
DEBUGLOG(("BOOLBalance: ProcessFundinPayout: Debit NetAmount = [%lf]\n", dNetFundinAmt));
					dTmp = (-1) * dFundinAmt;
				}
				else if (cDCInd == PD_IND_OVERWRITE){
					dNetFundinAmt = dFundinAmt;
DEBUGLOG(("BOOLBalance: ProcessFundinPayout: NetAmount = [%lf]\n", dNetFundinAmt));
					dTmp = (-1) * (dOrgFundinAmt - dFundinAmt);
				}
DEBUGLOG(("BOOLBalance: ProcessFundinPayout: DBOLMerchantBalance->UpdateFundInPayout\n"));
				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateFundInPayout");
				iRet = (unsigned long)(*DBObjPtr)(csMerchantId,
								  csTxnCountry,
								  csTxnCcy,
								  csServiceCode,
								  dTmp,
								  csUser);
			}

			if(iRet==PD_OK){
				hash_init(hVal, 0);

				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetCurrentValues");
				if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){
					if(GetField_Double(hVal,"current_bal",&dTmp)){
						PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOOLBalance: ProcessFundinPayout current_bal= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_float",&dTmp)){
						PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOOLBalance: ProcessFundinPayout total_float = [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"current_bal_settlement",&dTmp)){
						PutField_Double(hContext,"current_bal_settlement",dTmp);
DEBUGLOG(("BOOLBalance: ProcessFundinPayout current_bal_settlement= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_float_settlement",&dTmp)){
						PutField_Double(hContext,"total_float_settlement",dTmp);
DEBUGLOG(("BOOLBalance: ProcessFundinPayout total_float_settlement= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
						PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOOLBalance: ProcessFundinPayout total_reserved_amount= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_hold",&dTmp)){
						PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOOLBalance: ProcessFundinPayout total_hold= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_hold_settlement",&dTmp)){
						PutField_Double(hContext,"total_hold_settlement",dTmp);
DEBUGLOG(("BOOLBalance: ProcessFundinPayout total_hold_settlement= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_float_after_payout",&dTmp)){
						PutField_Double(hContext,"total_float_after_payout",dTmp);
DEBUGLOG(("BOOLBalance: ProcessFundinPayout total_float_after_payout= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"fundin_payout",&dTmp)){
						PutField_Double(hContext,"fundin_payout",dTmp);
DEBUGLOG(("BOOLBalance: ProcessFundinPayout fundin_payout= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"reserved_payout",&dTmp)){
						PutField_Double(hContext,"reserved_payout",dTmp);
DEBUGLOG(("BOOLBalance: ProcessFundinPayout reserved_payout= [%f]\n",dTmp));
					}
				} else {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout: DBOLMerchantBalance->GetBalance Failed\n"));
ERRLOG("BOOLBalance: ProcessFundinPayout: DBOLMerchantBalance->GetBalance Failed\n");
					iRet = PD_ERR;
				}
				hash_destroy(hVal);
			}
		}
		else if (cPartyType == PD_TYPE_PSP) {
		/*do nothing in cut-down version
			hash_init(hVal,0);

			if (cDCInd == PD_IND_DEBIT) {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout : DBPspBalance->DebitBalance\n"));
				DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");

			} else if (cDCInd == PD_IND_CREDIT) {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout : DBPspBalance->CreditBalance\n"));
				DBObjPtr = CreateObj(DBPtr,"DBPspBalance","CreditBalance");
			}

			iRet = (unsigned long)(*DBObjPtr)(csPspId,
							  csTxnCountry,
							  csTxnCcy,
							  PD_PSP_BAL,
							  dFundinAmt,
							  csUser);

			if(iRet==PD_OK){
				DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalance");
				if((unsigned long)(*DBObjPtr)(csPspId,csTxnCountry,csTxnCcy,hVal)!=PD_ERR){
					if(GetField_Double(hVal,"balance",&dTmp)){
						PutField_Double(hContext,"bal",dTmp);
DEBUGLOG(("BOOLBalance:ProcessFundinPayout psp_balance = [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_float",&dTmp)){
						PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOOLBalance:ProcessFundinPayout psp_total_float = [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_hold",&dTmp)){
						PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOOLBalance:ProcessFundinPayout psp_total_hold = [%f]\n",dTmp));
					}
				}
			}
			hash_destroy(hVal);
		*/
		}
	}
	FREE_ME(hVal);
	if (iRet == PD_OK) {

		if (iVoidFlag == PD_FALSE) {
			if (iChgBalMode == PD_TRUE) {
				if (cDCInd == PD_IND_CREDIT) {

					if (GetField_Double(hContext, "markup_amt", &dMarkupAmt)) {
						if (dMarkupAmt > 0.0) {
							PutField_Double(hContext, "org_txn_amt", dFundinAmt);
						}
					}

					PutField_CString(hContext, "amount_type", PD_CR);

DEBUGLOG(("BOOLBalance:ProcessFundinPayout() Add Element\n"));
					BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddTxnAmtElement");
					iRet = (unsigned long)(*BOObjPtr)(hContext);


					if (iRet == PD_OK) {

						if (dMarkupAmt > 0.0) {
							PutField_Char(hContext, "org_party_type", PD_TYPE_CUSTOMER);
							PutField_CString(hContext, "amount_type", PD_DR);
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() Add Markup Element\n"));
							BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddMarkupAmtElement");
							iRet = (unsigned long)(*BOObjPtr)(hContext);
						}
					}

					if (iRet == PD_OK) {
						PutField_CString(hContext, "amount_type", PD_DR);
DEBUGLOG(("BOOLBalance:ProcessFundinPayout() Add Fee Element\n"));
						BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddTxnFeeElements");
						iRet = (unsigned long)(*BOObjPtr)(hContext);
					}


				}  else {
DEBUGLOG(("BOOLBalance: ProcessFundinPayout: Unexpected case \n"));
ERRLOG("BOOLBalance: ProcessFundinPayout: Unexpected case \n");
				// Not expect debit
					iRet = INT_ERR;
				}
			}
		}
	}

	return iRet;
}


int ProcessMerchantAdjAmount(hash_t *hContext)
{
	int     iRet = PD_OK;
	char    *csOrgTxnCode;
	char    *csTxnCountry;
	char    *csTxnCcy;
	char    *csMerchantId;
	char    *csServiceCode;
	char    cDCType;
	double  dNetAmt=0.0;
	char    *csUser;
	double  dTmp;
	double  dBal = 0.0;
	int     iAllowBalNegative = PD_FALSE;
	int     iAllowModify = PD_FALSE;

	hash_t* hVal;
	hVal = (hash_t*) malloc (sizeof(hash_t));

DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount()\n"));

/* txn_code */
	if(GetField_CString(hContext,"txn_code",&csOrgTxnCode)){
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() txn_code = [%s]\n",csOrgTxnCode));
	}
	else{
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() txn_code not found!!\n"));
	}

/*txn country */
	if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() txn_country = [%s]\n",csTxnCountry));
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() txn_country is missing!!!\n"));
	}

/*txn ccy */
	if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {
DEBUGLOG(("BOOLBalance:ProcesseMerchantAdjAmount() txn_ccy = [%s]\n",csTxnCcy));
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() txn_ccy is missing!!!\n"));
	}

/*service Code */
	if (GetField_CString(hContext,"service_code",&csServiceCode)) {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() service_code = [%s]\n",csServiceCode));
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() service_code is missing!!!\n"));
	}

/*merchant id */
	if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() merchant_id = [%s]\n",csMerchantId));
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() merchant_id is missing!!!\n"));
	}

/* net amount */
	if (GetField_Double(hContext,"net_amt",&dNetAmt)) {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() net_amt = [%lf]\n",dNetAmt));
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() net_amt is missing!!!\n"));
	}

/* credit or debit - real action */
	if (GetField_Char(hContext, "dc_type", &cDCType)) {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() cDCType = [%c]\n",cDCType));
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() cDCType is missing !!!\n"));
	}

	if (GetField_CString(hContext, "add_user", &csUser)) {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() User = [%s]\n",csUser));
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() User is missing !!!\n"));
	}

/* allow_bal_neg */
	if (GetField_Int(hContext, "allow_bal_neg", &iAllowBalNegative)) {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() allow_bal_neg= [%d]\n", iAllowBalNegative));
	}

/* allow_modify */
	if (GetField_Int(hContext, "allow_modify", &iAllowModify)) {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() allow_Modify = [%d]\n", iAllowModify));
	}

	if (iRet == PD_OK) {
		hash_init(hVal, 0);

		if(iAllowModify == PD_FALSE && iAllowBalNegative == PD_FALSE){
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount(): GetSettAvalBalance\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLMerchantBalance", "GetSettAvalBalance");
		}
		else {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount(): GetCurrBalance\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLMerchantBalance", "GetCurrBalanceForUpdate");
		}
		if((unsigned long)(*DBObjPtr)(hVal, csMerchantId, csTxnCcy, csTxnCountry, csServiceCode, &dBal) != PD_OK){
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() GetBalance Failed !\n"));
			iRet = INT_ERR;
		} else {

DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() GetBalance [%lf]\n", dBal));
			dBal = newround(dBal, 2);

			if (GetField_Double(hVal, "merchant_open_bal", &dTmp)) {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() GetOpenBalanceForUpdate open_bal = [%f]\n",dTmp));
				PutField_Double(hContext, "merchant_open_bal", dTmp);
			}
			else {
				PutField_Double(hContext, "merchant_open_bal", 0.0);
			}

			if (GetField_Double(hVal, "merchant_open_bal_settlement", &dTmp)) {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() GetOpenBalanceForUpdate open_bal_settlement = [%f]\n",dTmp));
				PutField_Double(hContext, "merchant_open_bal_settlement", dTmp);
			}
			else {
				PutField_Double(hContext, "merchant_open_bal_settlement", 0.0);
			}

			/*** Update Context for approval date and approval timestamp ****/
			DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
			(*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() GetApprovalDT called\n"));

		}
		hash_destroy(hVal);
	}

	if (iRet == PD_OK && cDCType == PD_IND_DEBIT) {
		if(iAllowModify == PD_FALSE && iAllowBalNegative == PD_TRUE){
			if(!strcmp(csOrgTxnCode,PD_MERCHANT_ADJUSTMENT)){
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() Charge back\n"));
			} else {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() Not Charge back Failed !\n"));
			iRet = INT_ERR;
			}
		} else {
			if (dNetAmt <= dBal) {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() [%lf] [%lf] sufficient fund\n",dBal,dNetAmt));
			} else {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() [%lf] [%lf] INSUFFICIENT_FUND\n",dBal,dNetAmt));
				iRet = INT_INSUFFICIENT_FUND;
			}
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() Call UpdateAdjBal\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateAdjBal");
		if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCountry,csTxnCcy, csServiceCode, dNetAmt, cDCType, csUser)!= PD_OK){
DEBUGLOG(("BOOLBalance:ProcessMerchantAdjAmount() UpdateSettBal Failed !\n"));
			iRet = INT_ERR;
		}
	}


	if (iRet == PD_OK) {
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"current_bal",&dTmp)){
				PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOOLBalance: UpdateMerchantAdjAmount() current_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"current_bal_settlement",&dTmp)){
				PutField_Double(hContext,"current_bal_settlement",dTmp);
DEBUGLOG(("BOOLBalance: UpdateMerchantAdjAmount() current_bal_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float_settlement",&dTmp)){
				PutField_Double(hContext,"total_float_settlement",dTmp);
DEBUGLOG(("BOOLBalance: UpdateMerchantAdjAmount() total_float_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOOLBalance: UpdateMerchantAdjAmount() total_reserved_amount= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOOLBalance: UpdateMerchantAdjAmount() total_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold_settlement",&dTmp)){
				PutField_Double(hContext,"total_hold_settlement",dTmp);
DEBUGLOG(("BOOLBalance: UpdateMerchantAdjAmount() total_hold_settlement= [%f]\n",dTmp));
			}

			if(GetField_Double(hVal,"total_float_after_payout",&dTmp)){
				PutField_Double(hContext,"total_float_after_payout",dTmp);
DEBUGLOG(("BOOLBalance: UpdateMerchantAdjAmount() total_float_after_payout= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"fundin_payout",&dTmp)){
				PutField_Double(hContext,"fundin_payout",dTmp);
DEBUGLOG(("BOOLBalance: UpdateMerchantAdjAmount() fundin_payout= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"reserved_payout",&dTmp)){
				PutField_Double(hContext,"reserved_payout",dTmp);
DEBUGLOG(("BOOLBalance: UpdateMerchantAdjAmount() reserved_payout= [%f]\n",dTmp));
			}
		}
		else {
DEBUGLOG(("BOOLBalance:UpdateMerchantAdjAmount() GetCurrentValue Failed !\n"));
			iRet = INT_ERR;
		}

		hash_destroy(hVal);
	}


	FREE_ME(hVal);

DEBUGLOG(("BOOLBalance:UpdateMerchantAdjAmount()  exit = [%d]\n",iRet));

	return iRet;
}



int     ProcessTransferAvaPayout(hash_t *hContext)
{
	int     iRet = PD_OK;

	char    *csMerchantId;
	char    *csTxnCcy;
	char    *csTxnCountry;
	char    *csServiceCode;
	char    *csUser;
	char    cDCType;

	double  dFundin = 0.0;
	double  dResvPO = 0.0;
	double  dNetAmt = 0.0;

	double  dOrgFundin = 0.0;
	double  dOrgResvPO = 0.0;
	double  dOrgPrevFt= 0.0;

	double  dFee = 0.0;
	char    *csFeeCcy;

	double  dMarkupAmt = 0.0;
	double  dRemainMarkupAmt = 0.0;
	char    *csMarkupCcy;

	char    *csTmp;
	double  dTmp = 0.0;

	hash_t *hVal, *hElement;

	hVal = (hash_t*) malloc (sizeof(hash_t));
	hElement = (hash_t*) malloc (sizeof(hash_t));

	hash_init(hElement, 0);

/* txn_seq */
	if (GetField_CString(hContext, "txn_seq", &csTmp)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout: txn_seq [%s]\n", csTmp));

		PutField_CString(hElement, "from_txn_seq", csTmp);
	}

/*merchant id */
	if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {
DEBUGLOG(("BOOLBalance:ProcessTransferPayout() merchant_id = [%s]\n",csMerchantId));
	}

/*txn country */
	if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() txn_country = [%s]\n",csTxnCountry));
	}

/* txn ccy */
	if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() txn_ccy = [%s]\n",csTxnCcy));
		PutField_CString(hElement, "org_txn_ccy", csTxnCcy);
	}

/*service code */
	if (GetField_CString(hContext,"service_code",&csServiceCode)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() service_code = [%s]\n",csServiceCode));
	}

/* dc_type */
	if (GetField_Char(hContext, "dc_type", &cDCType)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() dc_type = [%c]\n",cDCType));
	}

/* fundin_amt */
	if (GetField_Double(hContext, "actual_fundin", &dFundin)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() fundin = [%lf]\n",dFundin));
	}

/* reserved payout */
	if (GetField_Double(hContext, "actual_resv_po", &dResvPO)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() resv_po = [%lf]\n",dResvPO));
	}

/* net amt */
	if (GetField_Double(hContext, "actual_net_amt", &dNetAmt)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() net_amt = [%lf]\n",dNetAmt));
	}

/* markup */
	if (GetField_Double(hContext, "markup_amt", &dMarkupAmt)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() markup amt = [%lf]\n",dMarkupAmt));
		dRemainMarkupAmt = dMarkupAmt;
		PutField_Double(hElement, "markup_amt", dMarkupAmt);
	}

/* for element - org fundin */
	if (GetField_Double(hContext, "org_actual_fundin", &dOrgFundin)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() org fundin = [%lf]\n",dOrgFundin));
		PutField_Double(hElement, "org_fundin", dOrgFundin);
	}

/* for element - org resv po*/
	if (GetField_Double(hContext, "org_actual_resv_po", &dOrgResvPO)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() org resv po = [%lf]\n",dOrgResvPO));
		PutField_Double(hElement, "org_resv_po", dOrgResvPO);
	}

/* for element - org prev ft */
	if (GetField_Double(hContext, "org_actual_prev_ft", &dOrgPrevFt)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() org prev ft = [%lf]\n",dOrgPrevFt));
		PutField_Double(hElement, "org_perv_float", dOrgPrevFt);
}

/* markup ccy */
	if (GetField_CString(hContext, "markup_ccy", &csMarkupCcy)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() markup_ccy = [%s]\n", csMarkupCcy));
	}

/* fee */
	if (GetField_Double(hContext, "actual_txn_fee", &dFee)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() txn_fee = [%lf]\n",dFee));
		PutField_Double(hElement, "src_txn_fee", dFee);
	}

/* fee ccy */
	if (GetField_CString(hContext, "actual_txn_fee_ccy", &csFeeCcy)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() txn_fee_ccy = [%s]\n",csFeeCcy));
		PutField_CString(hElement, "src_txn_fee_ccy", csFeeCcy);
	}

/*update_user*/
	if (GetField_CString(hContext,"update_user",&csUser)) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvapayout() update_user = [%s]\n",csUser));
		PutField_CString(hElement, "update_user", csUser);
	}

	/***** update  Context for approval date and approval timestamp */
	DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
	(*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:ProcessTransferAvapayout()  SystemControl::GetApprovalDT called\n"));

	if (cDCType == PD_IND_DEBIT) {
		dFundin = (-1) * dFundin;
		dResvPO = (-1) * dResvPO;
		dNetAmt = (-1) * dNetAmt;
	}
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() fundin [%lf] ResvPO [%lf] NetAmt [%lf]\n", dFundin, dResvPO, dNetAmt));

	if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout(): DBOLMerchantBalance->TransferAvaPayout\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","TransferAvaPayout");

		iRet = (unsigned long)(*DBObjPtr)(csMerchantId,
							csTxnCountry,
							csTxnCcy,
							csServiceCode,
							dFundin,
							dResvPO,
							dNetAmt,
							csUser);

		if (iRet != PD_OK) {
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout(): DBOLMerchantBalance->TransferAvaPayout FAILED!\n"));
ERRLOG("BOOLBalance: ProcessTransferAvaPayout: DBOLMerchantBalance->TransferAvaPayout FAILED!\n");
		}
	}

	if (iRet == PD_OK) {
		hash_init(hVal, 0);

		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"current_bal",&dTmp)){
				PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOOLBalance: ProcessTransferAvaPayout current_bal= [%f]\n",dTmp));
			}

			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOOLBalance: ProcessTransferAvaPayout total_float = [%f]\n",dTmp));
			}

			if(GetField_Double(hVal,"current_bal_settlement",&dTmp)){
				PutField_Double(hContext,"current_bal_settlement",dTmp);
DEBUGLOG(("BOOLBalance: ProcessTransferAvaPayout current_bal_settlement= [%f]\n",dTmp));
			}

			if(GetField_Double(hVal,"total_float_settlement",&dTmp)){
				PutField_Double(hContext,"total_float_settlement",dTmp);
DEBUGLOG(("BOOLBalance: ProcessTransferAvaPayout total_float_settlement= [%f]\n",dTmp));
			}

			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOOLBalance: ProcessTransferAvaPayout total_reserved_amount= [%f]\n",dTmp));
			}

			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOOLBalance: ProcessTransferAvaPayout total_hold= [%f]\n",dTmp));
			}

			if(GetField_Double(hVal,"total_hold_settlement",&dTmp)){
				PutField_Double(hContext,"total_hold_settlement",dTmp);
DEBUGLOG(("BOOLBalance: ProcessTransferAvaPayout total_hold_settlement= [%f]\n",dTmp));
			}

			if(GetField_Double(hVal,"total_float_after_payout",&dTmp)){
				PutField_Double(hContext,"total_float_after_payout",dTmp);
DEBUGLOG(("BOOLBalance: ProcessTransferAvaPayout total_float_after_payout= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"fundin_payout",&dTmp)){
				PutField_Double(hContext,"fundin_payout",dTmp);
DEBUGLOG(("BOOLBalance: ProcessTransferAvaPayout fundin_payout= [%f]\n",dTmp));
			}

			if(GetField_Double(hVal,"reserved_payout",&dTmp)){
				PutField_Double(hContext,"reserved_payout",dTmp);
DEBUGLOG(("BOOLBalance: ProcessTransferAvaPayout reserved_payout= [%f]\n",dTmp));
			}
		} else {
DEBUGLOG(("BOOLBalance: ProcessTransferAvaPayout : DBOLMerchantBalance->GetCurrentValues Failed\n"));
ERRLOG("BOOLBalance: ProcessTransferAvaPayout : DBOLMerchantBalance->GetCurrentValues Failed\n");
			iRet = PD_ERR;
		}
		hash_destroy(hVal);
	}

	if (cDCType == PD_IND_CREDIT) {
		if (dOrgPrevFt > 0.0) {
			if (dRemainMarkupAmt > 0.0) {
				if (dOrgPrevFt >= dRemainMarkupAmt) {
					dOrgPrevFt = dOrgPrevFt - dRemainMarkupAmt;
					dRemainMarkupAmt = 0.0;
					PutField_Double(hElement, "org_perv_float", dOrgPrevFt);
				} else {
					dRemainMarkupAmt = dRemainMarkupAmt - dOrgPrevFt;
					dOrgPrevFt = 0.0;
					RemoveField_Double(hElement, "org_perv_float");
				}
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() prev ft = [%lf]\n",dOrgPrevFt));
			}
		}

		if (dOrgResvPO > 0.0) {
			if (dRemainMarkupAmt > 0.0) {
				if (dOrgResvPO >= dRemainMarkupAmt) {
					dOrgResvPO = dOrgResvPO - dRemainMarkupAmt;
					dRemainMarkupAmt = 0.0;
					PutField_Double(hElement, "org_resv_po", dOrgResvPO);
				} else {
					dRemainMarkupAmt = dRemainMarkupAmt - dOrgResvPO;
					dOrgResvPO = 0.0;
					RemoveField_Double(hElement, "org_resv_po");
				}
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() resv po = [%lf]\n",dOrgResvPO));
			}
		}
		if (dOrgFundin > 0.0) {
			if (dRemainMarkupAmt > 0.0) {
				if (dOrgFundin >= dRemainMarkupAmt) {
					dOrgFundin = dOrgFundin - dRemainMarkupAmt;
					dRemainMarkupAmt = 0.0;
					PutField_Double(hElement, "org_fundin", dOrgFundin);
				}
DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() fundin = [%lf]\n",dOrgFundin));
			}
		}
	}


	if (iRet == PD_OK) {
		/* Add Element */
		PutField_Char(hElement, "party_type", PD_TYPE_MERCHANT);
		if (cDCType == PD_IND_DEBIT) {
			PutField_CString(hElement, "amount_type", PD_DR);
		} else {
			PutField_CString(hElement, "amount_type", PD_CR);
		}

DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() Add TransferAvaPayout Element\n"));
		BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddTransferAvaPOElement");
		iRet = (unsigned long)(*BOObjPtr)(hElement);
	}
	if (iRet == PD_OK) {
		/* Add Markup */
		if (dMarkupAmt > 0.0) {
			PutField_Char(hElement, "org_party_type", PD_TYPE_CUSTOMER);
			PutField_CString(hElement, "amount_type", PD_DR);

			if (GetField_Double(hContext, "markup_rate", &dTmp)) {
				PutField_Double(hElement, "markup_rate", dTmp);
			}
			/******/
			PutField_CString(hElement, "dst_txn_ccy", csMarkupCcy);
			/******/

DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() Add AddMarkupAmtElement\n"));
			BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddMarkupAmtElement");
			iRet = (unsigned long)(*BOObjPtr)(hElement);
		}
	}

	if (iRet == PD_OK) {
		/* Add Fee */
		PutField_CString(hElement, "amount_type", PD_DR);

DEBUGLOG(("BOOLBalance:ProcessTransferAvaPayout() Add AddTxnFeeElements\n"));
		BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddTxnFeeElements");
		iRet = (unsigned long)(*BOObjPtr)(hElement);

	}


	FREE_ME(hVal);
	return iRet;
}


int UpdateAFPOFloat(hash_t* hContext)
{
	char    *csOrgTxnCountry;
	char    *csOrgTxnCcy;
	char    *csOrgMerchantId;
	char    *csOrgServiceCode;

	char    cDCInd;
	double  dOrgNetAmt=0.0;
	double  dTmp = 0.0;
	hash_t* hVal;

	int iRet = PD_OK;

	char    csPostingDate[PD_DATE_LEN + 1];
	char    *csTmp = NULL;
	char    csLocalPostingDate[PD_DATE_LEN + 1];

/*txn country */
	if (GetField_CString(hContext,"txn_country",&csOrgTxnCountry)) {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() txn_country is missing!!!\n"));
	}

/*txn ccy */
	if (GetField_CString(hContext,"txn_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() txn_ccy is missing!!!\n"));
	}
/*org service code */
	if (GetField_CString(hContext,"service_code",&csOrgServiceCode)) {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() service_code is missing!!!\n"));
	}

/*org merchant id */
	if (GetField_CString(hContext,"merchant_id",&csOrgMerchantId)) {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() merchant_id is missing!!!\n"));
	}

/*net amount*/
	if (GetField_Double(hContext,"net_amt",&dOrgNetAmt)) {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() net_amt = [%lf]\n",dOrgNetAmt));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() net_amt is missing!!!\n"));
	}

/*dc_ind*/
	if (GetField_Char(hContext,"dc_ind",&cDCInd)) {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() dc_ind = [%c]\n",cDCInd));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() dc_ind is missing!!!\n"));
	}

	csPostingDate[0]= '\0';

////lock opening balance
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetOpenBalanceForUpdate");
		if ((*DBObjPtr)(hContext,
				csOrgMerchantId,
				csOrgTxnCcy,
				csOrgTxnCountry,
				csOrgServiceCode) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() GetOpenBalanceForUpdate Failed\n"));
		}
	}

	/***** update  Context for approval date and approval timestamp */
	DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
	(*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat ()  SystemControl::GetApprovalDT called\n"));

	if (GetField_CString(hContext, "approval_date", &csTmp)) {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() get approval_date [%s]\n", csTmp));
	}
	if (GetField_CString(hContext, "approval_timestamp", &csTmp)) {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() get approval_timestamp [%s]\n", csTmp));
	}

	if (iRet == PD_OK) {
		// already clear csPostingDate
		if (strlen(csPostingDate) == 0) {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat()  overriding approval_date\n"));
			char    *csPtr;

			if (GetField_CString(hContext,"approval_date",&csPtr)) {
				strcpy(csLocalPostingDate,csPtr);
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat()  posting_date = [%s]\n",csLocalPostingDate));
			}
		}
		else {
DEBUGLOG(("BOOLBalance:UpdateAFPOFloat()  posting_date [%s] from parameter\n",csPostingDate));
			strcpy(csLocalPostingDate,csPostingDate);
		}


		if(cDCInd==PD_IND_CREDIT){
			iRet = CreditAFPOFloat(hContext,
					csLocalPostingDate,
					csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt);
		}
		else{
			iRet = DebitAFPOFloat(hContext,
					csLocalPostingDate,
					csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt);
		}
	}

	if(iRet==PD_OK){
		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csOrgMerchantId,csOrgTxnCcy,csOrgTxnCountry,csOrgServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"current_bal",&dTmp)){
				PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOOLBalance: current_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOOLBalance: total_reserved_amount= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOOLBalance: total_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float_after_payout",&dTmp)){
				PutField_Double(hContext,"total_float_after_payout",dTmp);
DEBUGLOG(("BOOLBalance: total_float_after_payout= [%f]\n",dTmp));
			}

			if(GetField_Double(hVal,"current_bal_settlement",&dTmp)){
				PutField_Double(hContext,"current_bal_settlement",dTmp);
DEBUGLOG(("BOOLBalance: current_bal_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float_settlement",&dTmp)){
				PutField_Double(hContext,"total_float_settlement",dTmp);
DEBUGLOG(("BOOLBalance: total_float_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold_settlement",&dTmp)){
				PutField_Double(hContext,"total_hold_settlement",dTmp);
DEBUGLOG(("BOOLBalance: total_hold_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"fundin_payout",&dTmp)){
				PutField_Double(hContext,"fundin_payout",dTmp);
DEBUGLOG(("BOOLBalance: fundin_payout= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"reserved_payout",&dTmp)){
				PutField_Double(hContext,"reserved_payout",dTmp);
DEBUGLOG(("BOOLBalance: reserved_payout= [%f]\n",dTmp));
			}

		}

		FREE_ME(hVal);
	}


DEBUGLOG(("BOOLBalance:UpdateAFPOFloat() iRet = [%d]\n",iRet));
	return iRet;

}

int CreditAFPOFloat(hash_t* hContext,
			const char* csPostingDate,
			const char* csCountry,
			const char* csServiceCode,
			const char* csMerchantCCY,
			const char* csMerchantID,
			double dNetAmount)
{
	int iRet = PD_OK;
	char *csUser = strdup("");

DEBUGLOG(("BOOLBalance:CreditAFPOFloat() [%s][%s][%s][%s][%s][%lf]\n",csMerchantID,csServiceCode,csMerchantCCY,csCountry,csPostingDate,dNetAmount));

	if(GetField_CString(hContext,"add_user",&csUser)){
DEBUGLOG(("BOOLBalance:CreditAFPOFloat() user = [%s]\n",csUser));
	}
	else{
		csUser = strdup(PD_UPDATE_USER);
	}

	DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBucket","CreditMerchantAmount");
	if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			PD_DEFAULT_PSP,
			PD_BUCKET_TYPE_AFTER_PAYOUT_FLOAT,
			dNetAmount,
			csUser) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:CreditAFPOFloat() CreditMerchantAmount [AFPO Float]Failed\n"));
	}

	if(iRet == PD_OK){
DEBUGLOG(("BOOLBalance:Call DBOLMerchantBalance:UpdateAfterPayoutFloat\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateAfterPayoutFloat");
		if((*DBObjPtr)(csMerchantID,
			   csCountry,
			   csMerchantCCY,
			   csServiceCode,
			   dNetAmount,
			   csUser)!= PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DBOLMerchantBalance:UpdateAfterPayoutFloat Failed!!!!\n"));
		}
	}

	FREE_ME(csUser);
DEBUGLOG(("BOOLBalance:CreditAFPOFloat() iRet = [%d]\n",iRet));
	return iRet;
}

int DebitAFPOFloat(hash_t* hContext,
			const char* csPostingDate,
			const char* csCountry,
			const char* csServiceCode,
			const char* csMerchantCCY,
			const char* csMerchantID,
			double dNetAmount)
{
	int     iRet = PD_OK;
	int     i = 0;
	int     iTotal = 0;
	char    *csUser = strdup("");
	char    *csOrgPostingDate;
	char    *csPspId;
	char    csTag[PD_TAG_LEN+1];
	double  dTmp = 0.0;
	double  dTotalAmt = 0.0;
	double  dRemainAmt = 0.0;
	double  dAmount = 0.0;

	hash_t* hRec;
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

DEBUGLOG(("BOOLBalance:DebitAFPOFloat() [%s][%s][%s][%s][%s][%lf]\n",csMerchantID,csServiceCode,csMerchantCCY,csCountry,csPostingDate,dNetAmount));

	if(GetField_CString(hContext,"add_user",&csUser)){
DEBUGLOG(("BOOLBalance:DebitAFPOFloat() user = [%s]\n",csUser));
	}
	else{
		csUser = strdup(PD_UPDATE_USER);
	}

	//Check total AFPO float is greater than the request amount
DEBUGLOG(("BOOLBalance:Call DBOLMerchantBucket:GetTotalAFPOFloat\n"));
	DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBucket","GetTotalAFPOFloat");
	iRet = (unsigned long)(*DBObjPtr)(csMerchantID,
			   csCountry,
			   csMerchantCCY,
			   csServiceCode, rRecordSet);
	if(iRet == PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
		while(hRec){
			if(GetField_CString(hRec,"post_date",&csOrgPostingDate)){
				sprintf(csTag,"post_date_%d",iTotal);
				PutField_CString(hContext,csTag,csOrgPostingDate);
			}
			if(GetField_CString(hRec,"psp_id",&csPspId)){
				sprintf(csTag,"psp_id_%d",iTotal);
				PutField_CString(hContext,csTag,csPspId);
			}
			if(GetField_Double(hRec,"balance",&dTmp)){
				sprintf(csTag,"balance_%d",iTotal);
				PutField_Double(hContext,csTag,dTmp);
				dTotalAmt += dTmp;
			}
DEBUGLOG(("BOOLBalance:GetTotalAFPOFloat [%s][%s][%f]\n",csOrgPostingDate,csPspId,dTmp));
			iTotal++;
			hRec = RecordSet_GetNext(rRecordSet);
		}
		dTotalAmt = newround(dTotalAmt,PD_DECIMAL_LEN);
		dNetAmount = newround(dNetAmount,PD_DECIMAL_LEN);

		if(dTotalAmt < dNetAmount){
DEBUGLOG(("BOOLBalance:Total AFPO Float[%f] < Request Amount[%f]\n",dTotalAmt, dNetAmount));
			iRet = INT_INSUFFICIENT_FUND;
			PutField_Int(hContext,"internal_error",iRet);
		}
	}

	//debit AFPO float from oldest to newest from merchant bucket
	if(iRet == PD_OK){
		dAmount = 0.0;
		dRemainAmt = dNetAmount;
		for(i=0; i<iTotal; i++){
			if(dRemainAmt==0.0)
				break;

			dTmp = 0.0;
			sprintf(csTag,"balance_%d",i);
			GetField_Double(hContext,csTag,&dTmp);
			if(dRemainAmt>dTmp){
				dRemainAmt = dRemainAmt - dTmp;
				dAmount = dTmp;
			}
			else{
				dAmount = dRemainAmt;
				dRemainAmt = 0.0;
			}
DEBUGLOG(("BOOLBalance: debit AF bucket: Amount[%f]\n",dAmount));	  

			sprintf(csTag,"post_date_%d",i);
			if(GetField_CString(hContext,csTag,&csOrgPostingDate)){
DEBUGLOG(("BOOLBalance: debit AF bucket: post_date[%s]\n",csOrgPostingDate));
				sprintf(csTag,"psp_id_%d",i);
				if(GetField_CString(hContext,csTag,&csPspId)){
DEBUGLOG(("BOOLBalance: debit AF bucket: psp_id[%s]\n",csPspId));

DEBUGLOG(("BOOLBalance:Call DBOLMerchantBucket:DebitMerchantAmount\n"));
					DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBucket","DebitMerchantAmount");
					if ((unsigned long)(*DBObjPtr)(csOrgPostingDate,
								csMerchantID,
								csCountry,
								csMerchantCCY,
								csServiceCode,
								csPspId,
								PD_BUCKET_TYPE_AFTER_PAYOUT_FLOAT,
								dAmount,
								csUser) != PD_OK) {
						iRet = INT_ERR;
						break;
DEBUGLOG(("BOOLBalance:DebitAFPOFloat() DebitMerchantAmount [AFPO Float]Failed\n"));
					}
				}
			}
		}
	}

	if(iRet == PD_OK){
		//debit total after payout flost from merchant balance
DEBUGLOG(("BOOLBalance:Call DBOLMerchantBalance:UpdateAfterPayoutFloat\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateAfterPayoutFloat");
		if((unsigned long)(*DBObjPtr)(csMerchantID,
			   csCountry,
			   csMerchantCCY,
			   csServiceCode,
			   (-1)*dNetAmount,
			   csUser)!= PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DBOLMerchantBalance:UpdateAfterPayoutFloat Failed!!!!\n"));
		}
	}

	FREE_ME(csUser);
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
DEBUGLOG(("BOOLBalance:DebitAFPOFloat() iRet = [%d]\n",iRet));
	return iRet;
}
	  
	  
