/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/10/10              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOOLBalance.h"

char    cDebug;
OBJPTR(DB);
OBJPTR(BO);

void BOOLBalance(char    cdebug)
{
        cDebug = cdebug;
}

int CreditDepositAmount(hash_t *hContext,
			const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode, 
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dNetAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dPspFee);

int DebitDepositAmount(hash_t* hContext,
			const char* csPostingDate,
                       const char* csCountry,
		       const char* csServiceCode,
		       const char* csMerchantCCY,
		       const char* csMerchantID,
		       double dNetAmount,
		       const char* csPspCCY,
		       const char* csPspID,
		       double dPspAmount,
		       double dPspFee);

int UpdateTxnAmount(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csTxnCode;
	//char	*csPostingDate = NULL;
	char	csPostingDate[PD_DATE_LEN + 1];
	char	*csOrgTxnSeq;
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgDstCcy;
	char	*csOrgPspId;
	char	*csOrgServiceCode;
	//double	dOrgTxnAmt= 0.0;
	double	dOrgNetAmt= 0.0;
	double	dOrgDstTxnAmt= 0.0;
	//double	dReserveAmt = 0.0;
	double	dPspFee = 0.0;
	double	dTmp= 0.0;
	//int	iRecon = PD_FALSE;
	//int	iReleased = PD_FALSE;
	hash_t* hVal;


DEBUGLOG(("BOOLBalance:UpdateTxnAmount()\n"));
	csPostingDate[0]= '\0';

/*txn code */
	if (GetField_CString(hContext,"txn_code",&csTxnCode)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() txn_code = [%s]\n",csTxnCode));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() txn_code is missing!!!\n"));
	}
/*org txn seq */
	if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_txn_seq = [%s]\n",csOrgTxnSeq));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_txn_seq is missing!!!\n"));
	}

/*org txn country */
	if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_txn_country is missing!!!\n"));
	}

/*org txn ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_txn_ccy is missing!!!\n"));
	}
/*org service Code */
	if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_service_code is missing!!!\n"));
	}

/*org merchant id */
	if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_merchant_id is missing!!!\n"));
	}

/*org psp ccy */
	if (GetField_CString(hContext,"org_dst_txn_ccy",&csOrgDstCcy)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_dst_txn_ccy = [%s]\n",csOrgDstCcy));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_dst_txn_ccy is missing!!!\n"));
	}


/*org psp id */
	if (GetField_CString(hContext,"org_psp_id",&csOrgPspId)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_psp_id = [%s]\n",csOrgPspId));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_psp_id is missing!!!\n"));
	}

/*org net amount */
	if (GetField_Double(hContext,"net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() net_amt = [%lf]\n",dOrgNetAmt));
	}
	else {
		if (GetField_Double(hContext,"org_net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_net_amt = [%lf]\n",dOrgNetAmt));
		}
		else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_net_amt is missing!!!\n"));
		}
	}

/*org psp txn amount */
	if (GetField_Double(hContext,"org_dst_net_amt",&dOrgDstTxnAmt)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_dst_net_amt = [%lf]\n",dOrgDstTxnAmt));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() org_dst_net_amt is missing!!!\n"));
	}

/* psp_fee */
	if (GetField_Double(hContext,"precal_fee",&dPspFee)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() precal_fee = [%lf]\n",dPspFee));
	}
	else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() precal_fee not found, try to get from request\n"));
		if (GetField_Double(hRequest,"service_fee",&dPspFee)) {	
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() service_fee = [%lf]\n",dPspFee));
		}
		else {
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() service_fee is missing!!!\n"));
		}
	}

	if (!strcmp(csTxnCode,PD_INITIAL_OLN_TXN_CODE)){
DEBUGLOG(("BOOLBalance:UpdateTxnAmount() Update Deposit Txn\n"));
		iRet =CreditDepositAmount(hContext,
					csPostingDate,
					csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt,
					csOrgDstCcy,
					csOrgPspId,
					dOrgDstTxnAmt,
					dPspFee);
	}
	else if(!strcmp(csTxnCode,PD_VOID_TXN_CODE)){

DEBUGLOG(("BOOLBalance:UpdateTxnAmount() Update Deposit Txn (Void)\n"));
		iRet =DebitDepositAmount(hContext,
					csPostingDate,
                                        csOrgTxnCountry,
                                        csOrgServiceCode,
                                        csOrgTxnCcy,
                                        csOrgMerchantId,
					dOrgNetAmt,
                                        csOrgDstCcy,
                                        csOrgPspId,
                                        dOrgDstTxnAmt,
                                        dPspFee);
	}
	else {
DEBUGLOG(("BOOLBalance:None Deposit txn\n"));
	}
	
	if(iRet==PD_OK){

		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csOrgMerchantId,csOrgTxnCcy,csOrgTxnCountry,csOrgServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"current_bal",&dTmp)){
				PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOOLBalance: current_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOOLBalance: total_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"in_intransit",&dTmp)){
				PutField_Double(hContext,"in_intransit",dTmp);
DEBUGLOG(("BOOLBalance: in_intransit= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"out_intransit",&dTmp)){
				PutField_Double(hContext,"out_intransit",dTmp);
DEBUGLOG(("BOOLBalance: out_intransit= [%f]\n",dTmp));
			}

		}
		DBObjPtr = CreateObj(DBPtr,"DBOLProviderBalance","GetBalance");
		if((unsigned long)(*DBObjPtr)(csOrgPspId,csOrgTxnCountry,csOrgDstCcy,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"balance",&dTmp)){
				PutField_Double(hContext,"psp_balance",dTmp);
DEBUGLOG(("BOOLBalance:psp_balance = [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"psp_total_hold",dTmp);
DEBUGLOG(("BOOLBalance:psp_total_hold = [%f]\n",dTmp));
			}
		}

		FREE_ME(hVal);
	}
	
	return iRet;
}

int CreditDepositAmount(hash_t* hContext,
			const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dNetAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dPspFee) 
{
	int iRet = PD_OK;
	char	csLocalPostingDate[PD_DATE_LEN +1];

DEBUGLOG(("BOOLBalance:CreditDepositAmount()\n"));
DEBUGLOG(("BOOLBalance:CreditDepositAmount() merchant = [%lf], psp = [%lf]\n",dNetAmount,dPspAmount));

	if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:CreditDepositAmount CreditPSP Balance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLProviderBalance","UpdateBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				PD_IND_CREDIT,
				dPspAmount - dPspFee,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:CreditDepositAmount() UpdateFloat Failed\n"));
		}
	}

	if (iRet == PD_OK) {
/* Add or Update Txn Element */   ///TODO
/* update txn element for float Amount */
/*                if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:CreditDepositAmount() UpdateFloat Element\n"));
                        PutField_Double(hContext,"float_amt",dNetAmount);
                        BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddMerchantFloatAmtElement");
                        iRet = (unsigned long)(*BOObjPtr)(hContext);
                }
*/
	}

/* lock opening balance */
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetOpenBalanceForUpdate");
        	if ((*DBObjPtr)(hContext,
				csMerchantID,
				csMerchantCCY,
				csCountry,
				csServiceCode) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:CreditDepositAmount() GetOpenBalanceForUpdate Failed\n"));
		}
	}


/***** update  Context for approval date and approval timestamp */
        DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
        (*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:CreditDepositAmount()  SystemControl::GetApprovalDT called\n"));

        if (strlen(csPostingDate) == 0) {
DEBUGLOG(("BOOLBalance:CreditDepositAmount()  overriding approval_date\n"));
                char    *csPtr;
                if (GetField_CString(hContext,"approval_date",&csPtr)) {
                        strcpy(csLocalPostingDate,csPtr);
DEBUGLOG(("BOOLBalance:CreditDepositAmount()  approval_date = [%s]\n",csLocalPostingDate));
                }

        }
        else {
DEBUGLOG(("BOOLBalance:CreditDepositAmount()  approcal_date [%s] from parameter\n",csPostingDate));
                strcpy(csLocalPostingDate,csPostingDate);
        }
	
	if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:DBOLMerchantBalance UpdateCurrBal\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateCurrBal");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dNetAmount,
				PD_IND_CREDIT,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:CreditDepositAmount() UpdateFloat Failed\n"));
		}
	}



DEBUGLOG(("BOOLBalance:CreditDepositAmount() iRet = [%d]\n",iRet));
	return iRet;
}


int DebitDepositAmount(hash_t* hContext,
			const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dNetAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dPspFee) 
{
	int iRet = PD_OK;
	double dAvaBalance = 0.0;
	double dTmp = 0.0;

DEBUGLOG(("BOOLBalance:DebitDepositAmount()\n"));
DEBUGLOG(("BOOLBalance:DebitDepositAmount() merchant = [%lf], psp = [%lf]\n",dNetAmount,dPspAmount));

	if(iRet==PD_OK){
		DBObjPtr = CreateObj(DBPtr, "DBOLProviderBalance", "GetAvalOLProviderBalance");
		if((unsigned long)(*DBObjPtr)(csPspID,csPspCCY,csCountry,csPspCCY,&dAvaBalance)!=PD_OK) {
DEBUGLOG(("BOOLBalance:GetBalanceForUpdate Failed\n"));
ERRLOG("BOOLBalance:GetBalanceForUpdate Failed\n");
			iRet=INT_ERR;
		}
		else {
DEBUGLOG(("BOOLBalance::DebitDepositAmount() PSP Balance [%lf]\n", dAvaBalance));
			if(dAvaBalance<(dPspAmount-dPspFee)){
DEBUGLOG(("BOOLBalance::DebitDepositAmount() PSP Balance [%lf] < debit balance [%lf]\n", dAvaBalance,(dPspAmount-dPspFee)));
ERRLOG("BOOLBalance::DebitDepositAmount() PSP Balance [%lf] < debit balance [%lf]\n", dAvaBalance,(dPspAmount-dPspFee));
				iRet = INT_INSUFFICIENT_FUND;
				PutField_Int(hContext,"internal_error",iRet);
			}
		}
	}

	if(iRet==PD_OK){
		DBObjPtr = CreateObj(DBPtr, "DBOLMerchantBalance", "GetCurrBalance");
                if((unsigned long)(*DBObjPtr)(csMerchantID,
					      csMerchantCCY,
					      csCountry,
					      csServiceCode,
					      &dTmp) != PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DebitDepositAmount() GetCurrBalance Failed\n"));
		}
		else{

DEBUGLOG(("BOOLBalance:DebitDepositAmount() GetCurrBalance current_bal = [%lf]\n",dTmp));
			if(dNetAmount>dTmp){
DEBUGLOG(("BOOLBalance::DebitDepositAmount() Merchant Current Balance [%lf] < debit balance [%lf]\n", dTmp,dNetAmount));
ERRLOG("BOOLBalance::DebitDepositAmount() Merchant Current Balance [%lf] < debit balance [%lf]\n", dTmp,dNetAmount);
				iRet = INT_INSUFFICIENT_FUND;
				PutField_Int(hContext,"internal_error",iRet);
			}
		}
	}


/* lock opening balance */
        if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetOpenBalanceForUpdate");
                if ((*DBObjPtr)(hContext,
                                csMerchantID,
                                csMerchantCCY,
                                csCountry,
                                csServiceCode) != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DebitDepositAmount() GetOpenBalanceForUpdate Failed\n"));
                }
        }
/***** update  Context for approval date and approval timestamp */
		DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
		(*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:DebitDepositAmount()  SystemControl::GetApprovalDT called\n"));

	if(iRet==PD_OK){
		//update current balance 
DEBUGLOG(("BOOLBalance:DebitDepositAmount() Call DBOLMerchantBalance:UpdateCurrBal[%c]\n",PD_IND_DEBIT));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateCurrBal");
		iRet = (unsigned long)(*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dNetAmount,
				PD_IND_DEBIT,
				PD_UPDATE_USER);
DEBUGLOG(("BOOLBalance:DebitDepositAmount() UpdateSettBal iRet = [%d]\n",iRet));
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOOLBalance:DBOLProviderBalance UpdateBalance\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLProviderBalance","UpdateBalance");
        		if ((*DBObjPtr)(csPspID,
					csCountry,
					csPspCCY,
					PD_IND_DEBIT,
					dPspAmount - dPspFee,
					PD_UPDATE_USER) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("BOOLBalance:DebitDepositAmount() DebitBalance Failed\n"));
			}
	}

DEBUGLOG(("BOOLBalance:DebitDepositAmount() iRet = [%d]\n",iRet));
	return iRet;
}


int ProcessHold(hash_t *hContext,
		const hash_t *hRequest)
{
	int iRet = PD_OK;

	char	*csTxnCcy;
	char	*csTxnCountry;
	char	*csPspId;
	char	*csMerchantId;
	char	*csServiceCode;
	char	*csUser;
	char	cType;
	char	cHold;
	int	iAllowBalNegative = PD_FALSE;
	double	dAmt=0.0;
	double	dBal=0.0;
	double	dHold=0.0;
	double	dAval=0.0;
	double	dTmp=0.0;

	hash_t *hVal;
	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

/*party_type*/
	if(GetField_Char(hContext,"party_type",&cType)){
DEBUGLOG(("BOOLBalance:ProcessHold() party_type = [%c]\n",cType));
	}

/*hold_type*/
	if(GetField_Char(hContext,"hold_type",&cHold)){
DEBUGLOG(("BOOLBalance:ProcessHold() hold_type = [%c]\n",cHold));
	}

/*txn country */
	if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {	
DEBUGLOG(("BOOLBalance:ProcessHold() txn_country = [%s]\n",csTxnCountry));
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessHold() txn_country is missing!!!\n"));
	}

/*txn ccy */
	if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {	
DEBUGLOG(("BOOLBalance:ProcessHold() txn_ccy = [%s]\n",csTxnCcy));
	}
	else {
DEBUGLOG(("BOOLBalance:ProcessHold() txn_ccy is missing!!!\n"));
	}
/*service code */
	if (GetField_CString(hContext,"service_code",&csServiceCode)) {	
DEBUGLOG(("BOOLBalance:ProcessHold() service_code = [%s]\n",csServiceCode));
	}

/*merchant id */
	if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {	
DEBUGLOG(("BOOLBalance:ProcessHold() merchant_id = [%s]\n",csMerchantId));
	}

/*psp id */
	if (GetField_CString(hContext,"psp_id",&csPspId)) {	
DEBUGLOG(("BOOLBalance:ProcessHold() psp_id = [%s]\n",csPspId));
	}

/*amount */
	if (GetField_Double(hContext,"txn_amt",&dAmt)) {	
DEBUGLOG(("BOOLBalance:ProcessHold() txn_amt = [%lf]\n",dAmt));
	}

/*update_user*/
	if (GetField_CString(hContext,"update_user",&csUser)) {	
DEBUGLOG(("BOOLBalance:ProcessHold() update_user = [%s]\n",csUser));
	}

/*allow_bal_negative */
	if (GetField_Int(hContext, "allow_bal_negative", &iAllowBalNegative)) {
DEBUGLOG(("BOOLBalance:ProcessHold() allow_bal_negative = [%d]\n", iAllowBalNegative));
	}


	if(cType==PD_TYPE_MERCHANT){

DEBUGLOG(("BOOLBalance: ProcessHold: DBOLMerchantBalance->GetOpenBalanceForUpdate\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetOpenBalanceForUpdate");
		if((unsigned long)(*DBObjPtr)(hVal, csMerchantId,csTxnCcy,csTxnCountry,csServiceCode)!=PD_ERR) {

/***** update  Context for approval date and approval timestamp */
			DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
			(*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:ProcessHold()  SystemControl::GetApprovalDT called\n"));

			if(GetField_Double(hVal,"merchant_open_bal",&dBal)){
DEBUGLOG(("BOOLBalance: current_bal (P) = [%lf]\n",dBal));
			}
			if(GetField_Double(hVal,"total_hold",&dHold)){
DEBUGLOG(("BOOLBalance: total_hold (P) = [%lf]\n",dHold));
			}
			dAval=dBal-dHold;
		}
                else{
DEBUGLOG(("BOOLBalance: ProcessHold: DBOLMerchantBalance->GetOpenBalanceForUpdate Failed\n"));
ERRLOG("BOOLBalance: ProcessHold: DBOLMerchantBalance->GetOpenBalanceForUpdate Failed\n");
                        iRet=PD_ERR;
                }

		if (iRet == PD_OK) {
			if(GetField_Double(hVal,"merchant_open_bal",&dTmp)){
DEBUGLOG(("BOOLBalance: open_bal = [%f]\n",dTmp));
				PutField_Double(hContext, "merchant_open_bal", dTmp);
			}

		}
	}
        else if(cType==PD_TYPE_PSP){
DEBUGLOG(("BOOLBalance: ProcessHold: DBOLProviderBalance->GetBalance\n"));
                DBObjPtr = CreateObj(DBPtr,"DBOLProviderBalance","GetBalanceForUpdate");
                if ((unsigned long)(*DBObjPtr)(csPspId,csTxnCountry,csTxnCcy,hVal)==PD_OK) {

/***** update  Context for approval date and approval timestamp */
                        DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
                        (*DBObjPtr)(hContext);
DEBUGLOG(("BOOLBalance:ProcessHold() PSP SystemControl::GetApprovalDT called\n"));


                        if (GetField_Double(hVal,"balance",&dBal)) {
DEBUGLOG(("BOOLBalance::balance = [%f]\n",dBal));
                        }
                        if (GetField_Double(hVal,"total_hold",&dHold)) {
DEBUGLOG(("BOOLBalance::total_hold = [%f]\n",dHold));
                        }
                        dAval=dBal-dHold;
                }
                else{
DEBUGLOG(("BOOLBalance: ProcessHold: DBOLProviderBalance->GetBalance Failed\n"));
ERRLOG("BOOLBalance: ProcessHold: DBOLProviderBalance->GetBalance Failed\n");
                        iRet=INT_ERR;
                }
        }

	if(iRet==PD_OK){
                if(cHold==PD_HOLD){
			if (iAllowBalNegative == PD_FALSE) {
				if(dAval<dAmt){
DEBUGLOG(("BOOLBalance: ProcessHold: Hold Amount[%lf] > Balance[%lf]\n",dAmt,dAval));
ERRLOG("BOOLBalance: ProcessHold: Hold Amount[%lf] > Balance[%lf]\n",dAmt,dAval);
					iRet = INT_INVALID_PAY_AMOUNT;
				}
			}
		}
		else if(cHold==PD_UNHOLD){
			if(dHold<dAmt){
DEBUGLOG(("BOOLBalance: ProcessHold: Original Hold[%lf] < Unhold Amt[%lf]\n",dHold,dAmt));
ERRLOG("BOOLBalance: ProcessHold: Original Hold[%lf] < Unhold Amt[%lf]\n",dHold,dAmt);
				iRet = INT_INVALID_PAY_AMOUNT;
			}
		}
	}

	if(iRet==PD_OK){
		if(cType==PD_TYPE_MERCHANT){
DEBUGLOG(("BOOLBalance: ProcessHold: DBOLMerchantBalance->HoldBalance\n"));
                	DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","UpdateHoldBalance");
                	iRet = (unsigned long)(*DBObjPtr)(csMerchantId,
							  csTxnCountry,
							  csTxnCcy,
							  csServiceCode,
							  dAmt,
							  cHold,
							  csUser);

			if(iRet==PD_OK){
				hash_init(hVal,0);
				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBalance","GetCurrentValues");
				if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){

					if(GetField_Double(hVal,"current_bal",&dTmp)){
						PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOOLBalance: current_bal= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_hold",&dTmp)){
						PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOOLBalance: total_hold= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"in_intransit",&dTmp)){
						PutField_Double(hContext,"in_intransit",dTmp);
DEBUGLOG(("BOOLBalance: in_intransit= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"out_intransit",&dTmp)){
						PutField_Double(hContext,"out_intransit",dTmp);
DEBUGLOG(("BOOLBalance: out_intransit= [%f]\n",dTmp));
					}
				}
			}


		}
		else if(cType==PD_TYPE_PSP){
			hash_init(hVal,0);
DEBUGLOG(("BOOLBalance: ProcessHold: DBOLProviderBalance->HoldBalance\n"));
                	DBObjPtr = CreateObj(DBPtr,"DBOLProviderBalance","UpdateHoldBalance");
                	iRet = (unsigned long)(*DBObjPtr)(csPspId,
							  csTxnCountry,
							  csTxnCcy,
							  cHold,
							  dAmt,
							  csUser);

			if(iRet==PD_OK){
				DBObjPtr = CreateObj(DBPtr,"DBOLProviderBalance","GetBalance");
				if((unsigned long)(*DBObjPtr)(csPspId,csTxnCountry,csTxnCcy,hVal)!=PD_ERR){
					if(GetField_Double(hVal,"balance",&dTmp)){
						PutField_Double(hContext,"bal",dTmp);
DEBUGLOG(("BOOLBalance:psp_balance = [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_hold",&dTmp)){
						PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOOLBalance:psp_total_hold = [%f]\n",dTmp));
					}
				}
			}
		}
	}
	FREE_ME(hVal);

/* TODO
	if(iRet==PD_OK){
		if(cHold==PD_HOLD){
			PutField_CString(hContext, "amount_type", PD_DR);
		} else {
			PutField_CString(hContext, "amount_type", PD_CR);
		}
DEBUGLOG(("BOOLBalance:ProcessHold() AddHold Element\n"));
		BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddHoldAmtElement");
		iRet = (unsigned long)(*BOObjPtr)(hContext);
	}
*/
	return iRet;
}

