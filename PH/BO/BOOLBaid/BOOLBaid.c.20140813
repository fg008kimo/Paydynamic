/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/02/25              David Wong
Add multi_match_ind for OBD                        2014/04/10              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "dbutility.h"
#include "BOOLBaid.h"
#include "myrecordset.h"
#include "myhash.h"
#include "math.h"
#include <time.h>

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void BOOLBaid(char cdebug)
{
	cDebug = cdebug;
}

int PostBaidTxn(const char* csBaidTxnId)
{
	int iRet = PD_OK;
	int iTmpRet;

	hash_t *hBaidTxn;
	hBaidTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hBaidTxn, 0);

	hash_t *hStmtDtl;
	hStmtDtl = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hStmtDtl, 0);

	hash_t *hRec;
	hRec = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRec, 0);

	char csTxnSeq[PD_TXN_SEQ_LEN + 1];
	double dTxnAmt;
	char *csTxnCcy;
	char csTxnDateTime[PD_DATETIME_LEN + 1];

	char* csTmp;
	int iTmp;
	double dTmp;

	time_t tNow;
	struct tm * tStruct;
	char csBuf[PD_TMP_BUF_LEN];

	tNow = time(0);
	tStruct = localtime(&tNow);


	// MatchRespTxn (lock baid txn)
	if (iRet == PD_OK) {
DEBUGLOG(("PostBaidTxn() call DBOLBAIDTxn::MatchRespTxn()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "MatchRespTxn");
		iTmpRet = (unsigned long)(*DBObjPtr)(csBaidTxnId, PD_COMPLETE);
		if (iTmpRet != PD_FOUND) {
DEBUGLOG(("PostBaidTxn() call DBOLBAIDTxn::MatchRespTxn() failed\n"));
			iRet = PD_ERR;
		}
	}

	// get baid txn details
	if (iRet == PD_OK) {
DEBUGLOG(("PostBaidTxn() call DBOLBAIDTxn::GetBaidTxn()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "GetBaidTxn");
		iTmpRet = (unsigned long)(*DBObjPtr)(csBaidTxnId, hBaidTxn);
		if (iTmpRet != PD_OK) {
DEBUGLOG(("PostBaidTxn() call DBOLBAIDTxn::GetBaidTxn() failed\n"));
			iRet = PD_ERR;
		}
	}

	// get stmt details
	if (iRet == PD_OK) {
		if (GetField_CString(hBaidTxn, "stat_txn_id", &csTmp)) {
DEBUGLOG(("PostBaidTxn() call DBOLStatement::GetStmtDtl()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "GetStmtDtl");
			iTmpRet = (unsigned long)(*DBObjPtr)(csTmp, hStmtDtl);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("PostBaidTxn() call DBOLStatement::GetStmtDtl() failed\n"));
				iRet = PD_ERR;
			}
		} else {
DEBUGLOG(("PostBaidTxn() cannot get stat_txn_id from baid txn\n"));
			iRet = PD_ERR;
		}
	}

	if (iRet == PD_OK) {
// for add ol_txn_header
		if (iRet == PD_OK) {
			PutField_Int(hRec, "db_commit", PD_FALSE);

			// txn_id
			DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextOmtTxnSeq");
			strcpy(csTxnSeq, (*DBObjPtr)());
			PutField_CString(hRec, "txn_seq", csTxnSeq);

			// input_channel
			PutField_CString(hRec, "channel_code", PD_CHANNEL_OMT);

			// status
			PutField_Char(hRec, "status", PD_TO_PSP);

			// txn_code
			GetField_CString(hBaidTxn, "txn_code", &csTmp);
			PutField_CString(hRec, "txn_code", csTmp);
			if (!strcmp(csTmp, PD_BANK_DEPOSIT_TXN_CODE)) {
				PutField_Int(hRec, "multi_match_ind", PD_FALSE);
			}

			// process_type
			PutField_CString(hRec, "process_type", "0000");

			// process_code
			PutField_CString(hRec, "process_code", "000000");

			// host_posting_date
			char csTmpDate[PD_DATETIME_LEN + 1];
			DBObjPtr = CreateObj(DBPtr, "DBSystemControl", "FindCode");
			if ((unsigned long)(*DBObjPtr)("CTPHDATE", csTmpDate) == FOUND) {
DEBUGLOG(("PostBaidTxn: Current Processor Hub Date = [%s]\n", csTmpDate));
				PutField_CString(hRec, "host_posting_date", csTmpDate);
			}

			// internal_code
			PutField_Int(hRec, "internal_code", 0);

			// response_code
			PutField_CString(hRec, "response_code", "0");

			// transaction_amount
			GetField_Double(hBaidTxn, "txn_amt", &dTxnAmt);
			PutField_Double(hRec, "txn_amt", dTxnAmt);

			// deposit_amount
			PutField_Double(hRec, "deposit_amt", dTxnAmt);

			// display_amount
			PutField_Double(hRec, "display_amt", dTxnAmt);

			// local_tm_date
			strftime(csBuf, sizeof(csBuf), "%Y%m%d", tStruct);
			PutField_CString(hRec, "local_tm_date", csBuf);
			strcpy(csTxnDateTime, csBuf);
			PutField_CString(hRec, "transmission_datetime", csTxnDateTime);
			PutField_CString(hRec, "tm_date", csBuf);

			// local_tm_time
			strftime(csBuf, sizeof(csBuf), "%H%M%S", tStruct);
			PutField_CString(hRec, "local_tm_time", csBuf);
			strcat(csTxnDateTime, csBuf);
			PutField_CString(hRec, "transmission_datetime", csTxnDateTime);
			PutField_CString(hRec, "tm_time", csBuf);

			// create_user
			PutField_CString(hRec, "add_user", PD_UPDATE_USER);

			// client_ip
			// PutField_CString(hRec, "ip_addr", ?);

			// service_code
			// PutField_CString(hRec, "service_code", ?);

			// upload_channel
			GetField_CString(hBaidTxn, "input_channel", &csTmp);
			if (!strcmp(csTmp, PD_CHANNEL_SMS)) {
				PutField_Int(hRec, "upload_channel", PD_SMS_UPLOAD);
			} else {
				PutField_Int(hRec, "upload_channel", PD_STMT_UPLOAD);
			}

DEBUGLOG(("PostBaidTxn() call DBOLTransaction::Add()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Add");
			iTmpRet = (unsigned long)(*DBObjPtr)(hRec);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("PostBaidTxn() call DBOLTransaction::Add() failed\n"));
				iRet = PD_ERR;
			}
		}

// for add ol_txn_psp_detail
		if (iRet == PD_OK) {
			// psp_id
			GetField_CString(hBaidTxn, "pid", &csTmp);
			PutField_CString(hRec, "psp_id", csTmp);

			// baid
			GetField_CString(hBaidTxn, "baid", &csTmp);
			PutField_CString(hRec, "baid", csTmp);

			// txn_ccy
			GetField_CString(hBaidTxn, "txn_ccy", &csTxnCcy);
			PutField_CString(hRec, "txn_ccy", csTxnCcy);

			// txn_amount
			PutField_Double(hRec, "txn_amount", dTxnAmt);

			// txn_date
			GetField_CString(hStmtDtl, "statement_date", &csTmp);
			PutField_CString(hRec, "txn_date", csTmp);

			// txn_time
			GetField_CString(hStmtDtl, "statement_time", &csTmp);
			PutField_CString(hRec, "txn_time", csTmp);

			// bank_code
			GetField_CString(hBaidTxn, "bank_code", &csTmp);
			PutField_CString(hRec, "bank_code", csTmp);

			// bank_acct_num
			GetField_CString(hBaidTxn, "bank_acct_num", &csTmp);
			PutField_CString(hRec, "bank_acct_num", csTmp);

			// cost
			PutField_Double(hRec, "cost", 0.0);

			// open_bal
			GetField_Double(hBaidTxn, "open_bal", &dTmp);
			PutField_Double(hRec, "open_bal", dTmp);

			// total_hold
			PutField_Double(hRec, "total_hold", 0.0);

			// bal
			GetField_Double(hBaidTxn, "curr_bal", &dTmp);
			PutField_Double(hRec, "bal", dTmp);

			// pending_fund
			PutField_Double(hRec, "pending_fund", 0.0);

			// txn_hold_ind
			GetField_Int(hBaidTxn, "pid_txn_hold_ind", &iTmp);
			PutField_Int(hRec, "txn_hold_ind", iTmp);

			// sys_match_ind
			GetField_Int(hBaidTxn, "pid_sys_match_ind", &iTmp);
			PutField_Int(hRec, "sys_match_ind", iTmp);

			// customer_text
			if (GetField_CString(hStmtDtl, "tfr_customer_text", &csTmp)) {
				PutField_CString(hRec, "customer_text", csTmp);
			}

			// sender_name
			if (GetField_CString(hStmtDtl, "sender_name", &csTmp)) {
				PutField_CString(hRec, "sender_name", csTmp);
			}

			// txn_ref_num
			if (GetField_CString(hStmtDtl, "txn_ref_num", &csTmp)) {
				PutField_CString(hRec, "txn_ref_num", csTmp);
			}

DEBUGLOG(("PostBaidTxn() call DBOLTxnPspDetail::Add()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Add");
			iTmpRet = (unsigned long)(*DBObjPtr)(hRec);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("PostBaidTxn() call DBOLTxnPspDetail::Add() failed\n"));
				iRet = PD_ERR;
			}
		}

// for add ol_txn_elements
		if (iRet == PD_OK) {
			// txn_element_type
			PutField_CString(hRec, "txn_element_type", PD_ELEMENT_TXN_AMT);

			// amount
			PutField_Double(hRec, "amount", dTxnAmt);

			// ccy
			PutField_CString(hRec, "ccy", csTxnCcy);

			// amt_type
			GetField_CString(hStmtDtl, "amt_type", &csTmp);
			PutField_CString(hRec, "amount_type", csTmp);

			// party_type
			PutField_Char(hRec, "party_type", PD_TYPE_PSP);

DEBUGLOG(("PostBaidTxn() call DBOLTxnElements::Add()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLTxnElements", "Add");
			iTmpRet = (unsigned long)(*DBObjPtr)(hRec);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("PostBaidTxn() call DBOLTxnElements::Add() failed\n"));
				iRet = PD_ERR;
			}
		}

// for update ol_txn_header
		if (iRet == PD_OK) {
			// status
			PutField_Char(hRec, "status", PD_COMPLETE);

			// ar_ind
			PutField_Char(hRec, "ar_ind", PD_ACCEPT);

			// sub_status
			PutField_CString(hRec, "sub_status", PD_UNALLOCATED);

			// net_amt
			PutField_Double(hRec, "net_amt", dTxnAmt);

			// net_ccy
			PutField_CString(hRec, "net_ccy", csTxnCcy);

			// approval_date & approval_timestamp
			DBObjPtr = CreateObj(DBPtr, "DBSystemControl", "GetApprovalDT");
			(*DBObjPtr)(hRec);

DEBUGLOG(("PostBaidTxn() call DBOLTransaction::Update()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
			iTmpRet = (unsigned long)(*DBObjPtr)(hRec);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("PostBaidTxn() call DBOLTransaction::Update() failed\n"));
				iRet = PD_ERR;
			}
		}

// for update ol_baid_txn
		if (iRet == PD_OK) {
			hash_destroy(hRec);
			hash_init(hRec, 0);

			// update_user
			PutField_CString(hRec, "update_user", PD_UPDATE_USER);

			// txn_id
			PutField_CString(hRec, "txn_seq", csBaidTxnId);

			// dst_txn_id
			PutField_CString(hRec, "dst_txn_id", csTxnSeq);

			// posted_ind
			PutField_Int(hRec, "posted_ind", 1);

DEBUGLOG(("PostBaidTxn() call DBOLBAIDTxn::Update()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Update");
			iTmpRet = (unsigned long)(*DBObjPtr)(hRec);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("PostBaidTxn() call DBOLBAIDTxn::Update() failed\n"));
				iRet = PD_ERR;
			}
		}
	}

	hash_destroy(hBaidTxn);
	FREE_ME(hBaidTxn);
	hash_destroy(hStmtDtl);
	FREE_ME(hStmtDtl);
	hash_destroy(hRec);
	FREE_ME(hRec);

DEBUGLOG(("PostBaidTxn() Ret = [%d]\n", iRet));

	return iRet;
}
