/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/12/07              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOAdjustment.h"

char    cDebug;
OBJPTR(DB);

void BOAdjustment(char    cdebug)
{
        cDebug = cdebug;
}

int GetCurrentCode(hash_t *hRec)
{
        int     iRet = PD_OK;

	char	cPartyType;
	char	cAction;

	int	iTmp = 0;
/*	char	*csTmp = NULL;*/

        char    csCurrentCode[PD_ADJ_TYPE_CODE_LEN + 1];

	memset(csCurrentCode, 0, sizeof(csCurrentCode));


	if (GetField_Char(hRec, "party_type", &cPartyType)) {
DEBUGLOG(("GetCurrentCode::party_type [%c]\n", cPartyType));
	}

	if (GetField_Char(hRec, "action", &cAction)) {
DEBUGLOG(("GetCurrentCode::action [%c]\n", cAction));
	}

 /*       if (cAction == PD_ADJ_TYPE_ACTION_ADD) {*/
DEBUGLOG(("GetCurrentCode::Call AdjustmentType: GetMaxCode\n"));

                DBObjPtr = CreateObj(DBPtr,"DBAdjustmentType","GetMaxCode");
                if((unsigned long)((*DBObjPtr)(cPartyType, &csCurrentCode)) ==PD_OK) {

DEBUGLOG(("GetCurrentCode::CurrentCode Get [%s]\n", csCurrentCode));

			/* No Current Found */
                        if (strlen(csCurrentCode) == 0) {
                                strcpy(csCurrentCode, PD_ADJ_TYPE_DEF_CODE);
                        } else {
                                iTmp = atoi(csCurrentCode);
                                iTmp++;

                                sprintf(csCurrentCode, "%0*d", PD_ADJ_TYPE_CODE_LEN, iTmp);
                        }
DEBUGLOG(("GetCurrentCode::CurrentCode Assigned [%s]\n", csCurrentCode));
                        PutField_CString(hRec, "code", csCurrentCode);

                }
                else {
DEBUGLOG(("GetCurrentCode:GetMaxCode not found\n"));
ERRLOG("BOAdjustment::GetCurrentCode::GetMaxCode not found!!\n");
                        iRet=INT_ERR;
                }
/*
        } else if (cAction == PD_ADJ_TYPE_ACTION_UPDATE || cAction == PD_ADJ_TYPE_ACTION_DELETE) {

                if(GetField_CString(hRec,"code",&csTmp)){
DEBUGLOG(("GetCurrentCode::code = [%s]\n",csTmp));
                        PutField_CString(hRec, "code", csTmp);
                        strcpy(csCurrentCode, csTmp);
                }
                else {
DEBUGLOG(("GetCurrentCode::code not found!!\n"));
ERRLOG("BOAdjustment::GetCurrentCode::code not found!!\n");
                iRet=INT_ERR;
                }
        }
*/

	return 	iRet;
}

int     ValidateProcess(const hash_t* hInRec)
{
        int     iRet = PD_OK;

        char    cAction;
        char    cPartyType;
        char    *csCode = NULL;
        char    *csFullCode = NULL;

        char    cNewDCInd;
        char    cCurrentDCInd;

        hash_t          *hRec;
        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t *)malloc(sizeof(recordset_t));

        recordset_init(rRecordSet, 0);

        if (!(GetField_Char(hInRec, "action", &cAction) &&
                GetField_Char(hInRec, "party_type", &cPartyType) &&
                GetField_CString(hInRec, "code", &csCode) &&
                GetField_CString(hInRec, "full_code", &csFullCode) &&
                GetField_Char(hInRec, "dc_ind", &cNewDCInd))) {

DEBUGLOG(("VerifyProcess:: Not Complete Information cAction [%c] cPartyType [%c] csCode [%s] csFullCode [%s] cNewDCInd [%c]\n", cAction, cPartyType, csCode, csFullCode, cNewDCInd));
                iRet = PD_ERR;

        }
        else {
DEBUGLOG(("VerifyProcess:: cAction [%c] cPartyType [%c] csCode [%s] csFullCode [%s] cNewDCInd [%c]\n",cAction, cPartyType, csCode, csFullCode, cNewDCInd));
        }


        /* if record exists and action is delete, not allow */
        /* if record exists and action is update, only allow update desc */

        if (iRet == PD_OK) {

		if (cAction != PD_ADJ_TYPE_ACTION_ADD) { 

DEBUGLOG(("VerifyProcess::Call Transaction: ChkTxnCodeExist\n"));

	                DBObjPtr = CreateObj(DBPtr,"DBTransaction","ChkTxnCodeExist");
			if((unsigned long)((*DBObjPtr)(csFullCode)) == PD_FOUND) {
DEBUGLOG(("VerifyProcess::Call Transaction: ChkTxnCodeExist: FOUND\n"));

				if (cAction == PD_ADJ_TYPE_ACTION_DELETE) {
DEBUGLOG(("VerifyProcess::Not Allow Delete\n"));
                                	iRet = PD_ERR;
                        	}
                        	else if (cAction == PD_ADJ_TYPE_ACTION_UPDATE) {

                                	DBObjPtr = CreateObj(DBPtr,"DBAdjustmentType","GetAdjustmentTypeRec");
                                	if ((*DBObjPtr)(cPartyType, csCode, rRecordSet) == PD_OK) {

                                        	hRec = RecordSet_GetFirst(rRecordSet);
                                        	while (hRec) {
                                                	if (GetField_Char(hRec,"dc_ind",&cCurrentDCInd)) {
DEBUGLOG(("VerifyProcess::GetAdjustmentTypeRec::dc_ind = [%c]\n",cCurrentDCInd));
                                                	}
                                                	hRec = RecordSet_GetNext(rRecordSet);
                                        	}

                                        	if (cNewDCInd != cCurrentDCInd) {
                                                	iRet = PD_ERR;
                                        	}
                                	} else {
                                        	iRet = PD_ERR;
                                	}
                        	}
                	}
                	else {
DEBUGLOG(("VerifyProcess::Call Transaction: ChkTxnCodeExist: NOT FOUND\n"));
                	}
		}
		else {
DEBUGLOG(("VerifyProcess::OK for Add\n"));
		}	
	}
        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

        return iRet;
}

