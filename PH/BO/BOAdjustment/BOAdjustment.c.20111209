/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/12/07              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOAdjustment.h"

char    cDebug;
OBJPTR(DB);
OBJPTR(BO);

void BOAdjustment(char    cdebug)
{
        cDebug = cdebug;
}

int GetCurrentCode(hash_t *hRec)
{
        int     iRet = PD_OK;

	char	cPartyType;
	char	cAction;

	int	iTmp = 0;

        char    csCurrentCode[PD_ADJ_TYPE_CODE_LEN + 1];

	memset(csCurrentCode, 0, sizeof(csCurrentCode));


	if (GetField_Char(hRec, "party_type", &cPartyType)) {
DEBUGLOG(("GetCurrentCode::party_type [%c]\n", cPartyType));
	}

	if (GetField_Char(hRec, "action", &cAction)) {
DEBUGLOG(("GetCurrentCode::action [%c]\n", cAction));
	}

DEBUGLOG(("GetCurrentCode::Call AdjustmentType: GetMaxCode\n"));

	DBObjPtr = CreateObj(DBPtr,"DBAdjustmentType","GetMaxCode");
        if((unsigned long)((*DBObjPtr)(cPartyType, &csCurrentCode)) ==PD_OK) {

DEBUGLOG(("GetCurrentCode::CurrentCode Get [%s]\n", csCurrentCode));

		/* No Current Code Found */
        	if (strlen(csCurrentCode) == 0) {
                	strcpy(csCurrentCode, PD_ADJ_TYPE_DEF_CODE);
                } else {
                	iTmp = atoi(csCurrentCode);
                        iTmp++;

			if (iTmp > PD_ADJ_TYPE_MAX_CODE) {
				iRet = INT_ERR;
			}
			else {
				sprintf(csCurrentCode, "%0*d", PD_ADJ_TYPE_CODE_LEN, iTmp);
			}
                }
DEBUGLOG(("GetCurrentCode::CurrentCode Assigned [%s]\n", csCurrentCode));
                PutField_CString(hRec, "code", csCurrentCode);

	}
        else {
DEBUGLOG(("GetCurrentCode:GetMaxCode not found\n"));
ERRLOG("BOAdjustment::GetCurrentCode::GetMaxCode not found!!\n");
		iRet=INT_ERR;
        }

DEBUGLOG(("GetCurrentCode: return iRet [%d]\n", iRet));

	return 	iRet;
}


int     ValidateProcess(const hash_t* hInRec)
{
        int     iRet = PD_OK;

        char    cAction;
        char    cPartyType;
        char    *csCode = NULL;
        char    *csFullCode = NULL;

        char    cNewDCInd;
        char    cCurrentDCInd;

        hash_t          *hRec;
        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t *)malloc(sizeof(recordset_t));

        recordset_init(rRecordSet, 0);

        if (!(GetField_Char(hInRec, "action", &cAction) &&
                GetField_Char(hInRec, "party_type", &cPartyType) &&
                GetField_CString(hInRec, "code", &csCode) &&
                GetField_CString(hInRec, "full_code", &csFullCode) &&
                GetField_Char(hInRec, "dc_ind", &cNewDCInd))) {

DEBUGLOG(("ValidateProcess:: Not Complete Information cAction [%c] cPartyType [%c] csCode [%s] csFullCode [%s] cNewDCInd [%c]\n", cAction, cPartyType, csCode, csFullCode, cNewDCInd));
                iRet = PD_ERR;

        }
        else {
DEBUGLOG(("ValidateProcess:: cAction [%c] cPartyType [%c] csCode [%s] csFullCode [%s] cNewDCInd [%c]\n",cAction, cPartyType, csCode, csFullCode, cNewDCInd));
        }


        /* if record exists and action is delete, not allow */
        /* if record exists and action is update, only allow update desc */

        if (iRet == PD_OK) {

		if (cAction != PD_ADJ_TYPE_ACTION_ADD) { 

DEBUGLOG(("ValidateProcess::Call Transaction: ChkTxnCodeExist\n"));

	                DBObjPtr = CreateObj(DBPtr,"DBTransaction","ChkTxnCodeExist");
			if((unsigned long)((*DBObjPtr)(csFullCode)) == PD_FOUND) {
DEBUGLOG(("ValidateProcess::Call Transaction: ChkTxnCodeExist: FOUND\n"));

				if (cAction == PD_ADJ_TYPE_ACTION_DELETE) {
DEBUGLOG(("ValidateProcess::Not Allow Delete\n"));
                                	iRet = PD_ERR;
                        	}
                        	else if (cAction == PD_ADJ_TYPE_ACTION_UPDATE) {

                                	DBObjPtr = CreateObj(DBPtr,"DBAdjustmentType","GetAdjustmentTypeRec");
                                	if ((*DBObjPtr)(cPartyType, csCode, rRecordSet) == PD_OK) {

                                        	hRec = RecordSet_GetFirst(rRecordSet);
                                        	while (hRec) {
                                                	if (GetField_Char(hRec,"dc_ind",&cCurrentDCInd)) {
DEBUGLOG(("ValidateProcess::GetAdjustmentTypeRec::dc_ind = [%c]\n",cCurrentDCInd));
                                                	}
                                                	hRec = RecordSet_GetNext(rRecordSet);
                                        	}

                                        	if (cNewDCInd != cCurrentDCInd) {
DEBUGLOG(("ValidateProcess::GetAdjustmentTypeRec::dc_ind = [%c] not match with new dc_ind [%c], not allow update\n",cCurrentDCInd, cNewDCInd));
                                                	iRet = PD_ERR;
                                        	}
                                	} else {
                                        	iRet = PD_ERR;
DEBUGLOG(("ValidateProces::GetAdjustmentTypeRec:: failed\n"));
ERRLOG("BOAdjustment::ValidateProcess::GetAdjustmentTypeRec:: failed!!\n");
                                	}
                        	}
                	}
                	else {
DEBUGLOG(("ValidateProcess::Call Transaction: ChkTxnCodeExist: NOT FOUND\n"));
                	}
		}
		else {
DEBUGLOG(("ValidateProcess::OK for Add\n"));
		}	
	}
        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);


DEBUGLOG(("ValidateProcess::Return iRet [%d]\n", iRet));

        return iRet;
}


int     ProcessPartyBalance(hash_t* hInRec)
{
	int	iRet = PD_OK;

	char	cPartyType;
	char	cDCInd;

	char	*csCode = NULL;
	char	*csCountry = NULL;
	char	*csCcy = NULL;	
	char	*csUpdateUser = NULL;
        double  dAmt=0.0;
        double  dTmp=0.0;

	char	*csPspId = NULL;
	char	*csMerchantId = NULL;
	char	*csServiceCode = NULL;

        hash_t          *hRec;
        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t *)malloc(sizeof(recordset_t));

	hash_t	*hTxn;
	hTxn = (hash_t *)malloc(sizeof(hash_t));
	hash_init(hTxn, 0);

/* code */
	if (GetField_CString(hInRec, "code", &csCode)) {
DEBUGLOG(("ProcessPartyBalance::code [%s]\n", csCode));
	}

/* party_type */
	if (GetField_Char(hInRec, "party_type", &cPartyType)) {
DEBUGLOG(("ProcessPartyBalance::party_type [%c]\n", cPartyType));
	}

/* country */
	if (GetField_CString(hInRec, "txn_country", &csCountry)) {
DEBUGLOG(("ProcessPartyBalance::country [%s]\n", csCountry));
	}

/* ccy */
	if (GetField_CString(hInRec, "txn_ccy", &csCcy)) {
DEBUGLOG(("ProcessPartyBalance::ccy [%s]\n", csCcy));
	}


/* dc_ind */
        recordset_init(rRecordSet, 0);

DEBUGLOG(("ProcessPartyBalance::Call DBAdjustment:GetAdjustmentTypeRec\n"));

	DBObjPtr = CreateObj(DBPtr,"DBAdjustmentType","GetAdjustmentTypeRec");
	if ((*DBObjPtr)(cPartyType, csCode, rRecordSet) == PD_OK) {

		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
                	if (GetField_Char(hRec,"dc_ind",&cDCInd)) {
DEBUGLOG(("ProcessPartyBalance::GetAdjustmentTypeRec::dc_ind = [%c]\n",cDCInd));

				PutField_Char(hInRec, "dc_ind", cDCInd);
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("ProcessPartyBalance::GetAdjustmentTypeRec:: failed\n"));
ERRLOG("BOAdjustment::ProcessPartyBalance::GetAdjustmentTypeRec:: failed!!\n");
	}

/* udpate_user */
        if(GetField_CString(hInRec,"add_user",&csUpdateUser)){
DEBUGLOG(("ProcessPartyBalance::add_user= [%s]\n",csUpdateUser));
	}


/* txn_amt */
        if(GetField_Double(hInRec,"txn_amt",&dAmt)){
DEBUGLOG(("ProcessPartyBalance::txn_amt= [%f]\n",dAmt));

		PutField_Double(hInRec, "net_amt", dAmt);
        }


/* for psp */
	if (cPartyType == PD_TYPE_PSP) {

		if (GetField_CString(hInRec, "psp_id", &csPspId)) {
DEBUGLOG(("ProcessPartyBalance::psp_id [%s]\n", csPspId));
		}
		else {
DEBUGLOG(("ProcessPartyBalance::psp_id missing\n"));
ERRLOG("BOAdjustment::ProcessPartyBalance::psp_id missing!!\n");
			iRet = INT_ERR;
		}

		if (cDCInd == PD_ADJ_TYPE_DEBIT) {
			/* ChkBalance?? */

			if (iRet==PD_OK) {
DEBUGLOG(("BOAdjustment::Call DBPspBalance:DebitBalance\n"));
				DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
				if ((*DBObjPtr)(csPspId,csCountry, csCcy, PD_PSP_BAL, dAmt, csUpdateUser) != PD_OK) {
DEBUGLOG(("BOAdjustment::DBPspBalance:DebitBalance Failed\n"));
					iRet = INT_ERR;
				}
			}
		} else if (cDCInd == PD_ADJ_TYPE_CREDIT) {
                        if (iRet==PD_OK) {
DEBUGLOG(("BOAdjustment::Call DBPspBalance:CreditBalance\n"));
                                DBObjPtr = CreateObj(DBPtr,"DBPspBalance","CreditBalance");
                                if ((*DBObjPtr)(csPspId,csCountry, csCcy, PD_PSP_BAL, dAmt, csUpdateUser) != PD_OK) {
DEBUGLOG(("BOAdjustment::DBPspBalance:CreditBalance Failed\n"));
                                        iRet = INT_ERR;
                                }
                        }
		}

		/* Get PSP Balance */
                hash_init(hTxn,0);
DEBUGLOG(("BOAdjustment::Call DBPspBalance:GetBalance\n"));
                DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalance");
                if ((*DBObjPtr)(csPspId, csCountry, csCcy, hTxn) == PD_OK) {

                        if (GetField_Double(hTxn, "balance", &dTmp)) {
DEBUGLOG(("Psp GetBalance::balance = [%f]\n",dTmp));
                                PutField_Double(hInRec, "bal", dTmp);
				PutField_Double(hInRec, "current_bal", dTmp);
                        }

                        if (GetField_Double(hTxn, "total_float", &dTmp)) {
DEBUGLOG(("Psp GetBalance::total_float = [%f]\n",dTmp));
                                PutField_Double(hInRec, "total_float", dTmp);
                        }

                        if (GetField_Double(hTxn, "total_hold", &dTmp)) {
DEBUGLOG(("Psp GetBalance::total_hold = [%f]\n",dTmp));
                                PutField_Double(hInRec, "total_hold", dTmp);
                        }
                }
                else {
ERRLOG("BOAdjustment::PSP GetBalance::Balance for PspId[%s] not found\n",csPspId);
DEBUGLOG(("Psp GetBalance::Balance for PspId[%s] not found\n", csPspId));
                        iRet = INT_ERR;
                }



	}else if (cPartyType == PD_TYPE_MERCHANT) {
/* for merchant */

		/* merchant_id */
		if (GetField_CString(hInRec, "merchant_id", &csMerchantId)) {
DEBUGLOG(("ProcessPartyBalance::merchant_id [%s]\n", csMerchantId));
		}
		else {
DEBUGLOG(("ProcessPartyBalance::merchant_id missing\n"));
ERRLOG("BOAdjustment::ProcessPartyBalance::merchant_id missing!!\n");
			iRet = INT_ERR;
		}

		/* service_code */
		if (GetField_CString(hInRec, "service_code", &csServiceCode)) {
DEBUGLOG(("ProcessPartyBalance::service_code [%s]\n", csServiceCode));
		}
		else {
DEBUGLOG(("ProcessPartyBalance::service_code missing\n"));
ERRLOG("BOAdjustment::ProcessPartyBalance::service_code missing!!\n");
			iRet = INT_ERR;
		}

		if (cDCInd == PD_ADJ_TYPE_DEBIT) {
			/* ChkBalance?? */

			if (iRet == PD_OK) {
DEBUGLOG(("BOAdjustment::ProcessPartyBalance::Call BOBalance:DebitMerchantAvalAmount\n"));
				BOObjPtr = CreateObj(BOPtr,"BOBalance","DebitMerchantAvalAmount");
				if((unsigned long)((*BOObjPtr)(hInRec, hTxn) != PD_OK)){
DEBUGLOG(("BOAdjustment::BOBalance:DebitMerchantAvalAmount Failed\n"));
ERRLOG("TxnMgtByUsATD::BOADjustment::BOBalance:DebitMerchantAvalAmount Failed\n");
					iRet=INT_ERR;
				}
			}
		} else if (cDCInd == PD_ADJ_TYPE_CREDIT) {

DEBUGLOG(("BOAdjustment::ProcessPartyBalance::Call BOBalance:CreditMerchantAvalAmount\n"));
				BOObjPtr = CreateObj(BOPtr,"BOBalance","CreditMerchantAvalAmount");
				if((unsigned long)((*BOObjPtr)(hInRec, hTxn) != PD_OK)){
DEBUGLOG(("BOAdjustment::BOBalance:CreditMerchantAvalAmount Failed\n"));
ERRLOG("TxnMgtByUsATD::BOADjustment::BOBalance:CreditMerchantAvalAmount Failed\n");
				iRet=INT_ERR;
			}
		}
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("ProcessPartyBalance::Incorrect PartyType [%c]\n", cPartyType));
ERRLOG("BOAdjustment::ProcessPartyBalance::Incorrect PartyType [%c]\n", cPartyType);
	}

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

	FREE_ME(hTxn);


DEBUGLOG(("ProcessPartyBalance::Return iRet [%d]\n", iRet));

	return iRet;	
}

