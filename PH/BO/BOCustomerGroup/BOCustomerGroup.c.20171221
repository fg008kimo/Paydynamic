/*
Partnerdelight (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/10              Cody Chan
use BankCode to find the possible Group first	   2013/09/12		   LokMan Chow
not assign group for mobile until txn is success   2015/03/06		   LokMan Chow
Add alert email					   2015/03/27		   LokMan Chow
Support card type option			   2016/10/31		   LokMan Chow
Support QR Payment
	update PickMobileGroup
	update GetAavailableMobSegment		   2016/11/28		   LokMan Chow
Support VMobile Payment for New Phase
	update CreateCustomerGroup		   2017/11/23		   Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOCustomerGroup.h"

char    cDebug;


void BOCustomerGroup(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(DB);
OBJPTR(BO);
int     PickMobileGroup(hash_t* hTxn);

int CreateCustomerGroup(hash_t* hContext,
                hash_t *hRequest,
                hash_t *hResponse)
{
	int	iRet = PD_OK;
	int	iGroupCnt = 0;
	char	*csCustomerTag;
	char	*csMerchantId;
	char	*csCountryId;
	char	*csChannelCode;
	char	*csServiceCode;
	char	*csCurrencyId;
	char	*csBankCode;
	char	*csDate;
	char	*csTmp;
	int	iPromote = PD_FALSE;
	char	cCardType = 'X';
	int	iCheckLB = PD_TRUE;
	double	dAmt = 0.0;

	hash_t *hRec;
	hRec = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRec,0);

	char	csToGroup[PD_CUSTOMER_GROUP_CODE_LEN +1];
	char	csCustomerGroup[PD_CUSTOMER_GROUP_CODE_LEN +1];
DEBUGLOG(("CreateCustomerGroup\n"));

	if (GetField_CString(hContext,"PHDATE",&csDate)) {
DEBUGLOG(("CreateCustomerGroup PH Date = [%s]\n",csDate));
	}
/* country id */
	if (GetField_CString(hContext,"org_txn_country",&csCountryId)) {
DEBUGLOG(("CreateCustomerGroup Country Id = [%s]\n",csCountryId));
	}
/* channel code */
	if (GetField_CString(hContext,"channel_code",&csChannelCode)) {
DEBUGLOG(("CreateCustomerGroup channel_code = [%s]\n",csChannelCode));
	}
/* service code */
	if (GetField_CString(hContext,"org_service_code",&csServiceCode)) {
DEBUGLOG(("CreateCustomerGroup service_code = [%s]\n",csServiceCode));
	}
/* txn_ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csCurrencyId)) {
DEBUGLOG(("CreateCustomerGroup txn_ccy = [%s]\n",csCurrencyId));
	}
/*bank_code*/
	if (GetField_CString(hContext,"bank_code",&csBankCode)) {
DEBUGLOG(("CreateCustomerGroup bank_code = [%s]\n",csBankCode));
	}

	if (GetField_Double(hContext,"org_txn_amt",&dAmt)) {
DEBUGLOG(("CreateCustomerGroup txn_amt = [%lf]\n",dAmt));
	}

	if (GetField_Char(hContext,"card_type",&cCardType)) {
DEBUGLOG(("CreateCustomerGroup card_type = [%c]\n",cCardType));
	}

	if (GetField_CString(hContext,"customer_tag",&csCustomerTag)) {
DEBUGLOG(("CreateCustomerGroup Found tag [%s]\n",csCustomerTag));
		if (GetField_CString(hContext,"org_merchant_id",&csMerchantId)) {
DEBUGLOG(("CreateCustomerGroup Merchant Id [%s]\n",csMerchantId));
		}

/* check if enabled the customer grouping */
		DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupMerchant","FindMerchant");	
		if ((unsigned long)(DBObjPtr)(csMerchantId) == FOUND) {

			PutField_Int(hContext,"cust_seg_enabled",PD_TRUE);
			DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","FindGroup");	
			if ((unsigned long)(DBObjPtr)(csMerchantId,csCustomerTag,&csCustomerGroup) == NOT_FOUND) {
DEBUGLOG(("CreateCustomerGroup Merchant Id [%s][%s] is new!!!\n",csMerchantId,csCustomerTag));
				DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupRules","FindGroupCnt");	
				if ((unsigned long)(DBObjPtr)(csMerchantId) == NOT_FOUND) {
DEBUGLOG(("CreateCustomerGroup not rule define for  Merchant Id!!!\n"));
ERRLOG("BOCustomerGroup:CreateCustomerGroup not rule define for  Merchant Id!!!\n");
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
				}
				else {
DEBUGLOG(("CreateCustomerGroup trying to pickup a group for [%s][%s]\n",csMerchantId,csCustomerTag));
					if(strcmp(csServiceCode,PD_MOBILE_SERVICE)){

						int iPhase = 0;
						DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupMerchant","GetMerchantPhase");
						iPhase = (unsigned long)(DBObjPtr)(csMerchantId);

						DBObjPtr = CreateObj(DBPtr,"DBRuleLB","GetCustomerGroup_CardType");
						if ( (unsigned long)(DBObjPtr)(csChannelCode,
									csMerchantId,
									csServiceCode,
									csCountryId,
									csCurrencyId,
									cCardType,
									dAmt,
									csBankCode,
									hRec) ==PD_OK) {

							if(GetField_Int(hRec,"group_cnt",&iGroupCnt)){
DEBUGLOG(("CreateCustomerGroup Total [%d] group(s) support bank[%s]\n",iGroupCnt,csBankCode));
							}

							if(iGroupCnt == 0){
								if(iPhase>=2){
									sprintf(csCustomerGroup,"GRP_N");
								}
								else{
									iRet = PD_SKIP_OK;
DEBUGLOG(("CreateCustomerGroup No Group in load balance scheme!!!!!!\n"));
								}
							}
							else{
								DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupRules","PickGroup");	
								if ( (unsigned long)(DBObjPtr)(csMerchantId,
											csCountryId,
											csChannelCode,
											csServiceCode,
											csCurrencyId,
											csDate,
											hRec,
											&csCustomerGroup) != FOUND) {

									if(iPhase>=2){
										sprintf(csCustomerGroup,"GRP_N");
									}
									else{
ERRLOG("BOCustomerGroup: CreateCustomerGroup Pickup Group Error\n");
DEBUGLOG(("CreateCustomerGroup Pickup Group Error\n"));
										iRet = INT_ERR;
										PutField_Int(hContext,"internal_error",iRet);
									}
								}

							}
						}
						else{
							iRet = INT_ERR;
DEBUGLOG(("CreateCustomerGroup DBTxnLb: GetCustomerGroup Failed!!!\n"));
ERRLOG("BOCustomerGroup: CreateCustomerGroup DBTxnLb: GetCustomerGroup Failed!!!\n");
						}
					}
					else{//for mobile segment

						int iPhase = 0;
                                                DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupMerchant","GetMerchantPhase");
                                                iPhase = (unsigned long)(DBObjPtr)(csMerchantId);
DEBUGLOG(("CreateCustomerGroup DBCustomerGroupMerchant: GetMerchantPhase phase = [%d]\n",iPhase));

						if (iPhase>0) {
							sprintf(csCustomerGroup,"GRP_N");	
						}
						else{
							/*
								do nothing now
							*/

							iRet = PD_SKIP_OK;
						}
					}

					if(iRet == PD_OK){
						hash_destroy(hRec);
						hash_init(hRec,0);
						PutField_CString(hRec,"customer_group",csCustomerGroup);
						PutField_CString(hRec,"merchant_id",csMerchantId);
						PutField_CString(hRec,"customer_tag",csCustomerTag);
						PutField_CString(hRec,"create_user",PD_UPDATE_USER);
DEBUGLOG(("CreateCustomerGroup new group [%s] for [%s][%s]\n",csCustomerGroup,csMerchantId,csCustomerTag));
						DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","Add");	
						iRet =  (unsigned long)(DBObjPtr)(hRec);
DEBUGLOG(("CreateCustomerGroup iRet = [%d] new group [%s] for [%s][%s]\n",iRet,csCustomerGroup,csMerchantId,csCustomerTag));
						if (iRet == PD_OK) 
							PutField_CString(hContext,"customer_group",csCustomerGroup);
					}
				}
			}
			else {
DEBUGLOG(("CreateCustomerGroup Found [%s] for Merchant Id [%s][%s]\n",csCustomerGroup,csMerchantId,csCustomerTag));


				//for mobile segment
				if(!strcmp(csServiceCode,PD_MOBILE_SERVICE)){
					int iPhase = 0;
                                      	DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupMerchant","GetMerchantPhase");
                                       	iPhase = (unsigned long)(DBObjPtr)(csMerchantId);
DEBUGLOG(("CreateCustomerGroup DBCustomerGroupMerchant: GetMerchantPhase phase = [%d]\n",iPhase));

                                       	if (iPhase>0) {	
						DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupRules","IsMobileGroup");
                                                if ((unsigned long)(DBObjPtr)(csMerchantId,csCustomerGroup) == NOT_FOUND) {
							
							//update customer group detail, add change group log
							
                                                	hash_destroy(hRec);
                                                	hash_init(hRec,0);

							sprintf(csToGroup,"GRP_N");
                                                	PutField_CString(hRec,"customer_group",csToGroup);
                                                	PutField_CString(hRec,"merchant_id",csMerchantId);
                                                	PutField_CString(hRec,"customer_tag",csCustomerTag);
                                                	PutField_CString(hRec,"update_user",PD_UPDATE_USER);

DEBUGLOG(("CreateCustomerGroup new group [%s] for [%s][%s]\n",csToGroup,csMerchantId,csCustomerTag));
                                                	DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","UpdateGroup");
                                                	iRet =  (unsigned long)(DBObjPtr)(hRec);
DEBUGLOG(("CreateCustomerGroup iRet = [%d] new group [%s] for [%s][%s]\n",iRet,csToGroup,csMerchantId,csCustomerTag));

                                                	if (iRet == PD_OK) {
                                                        	PutField_CString(hRec,"to_customer_group",csToGroup);
                                                        	PutField_CString(hRec,"from_customer_group",csCustomerGroup);
                                                        	DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupLog","Add");
                                                        	iRet = (unsigned long)(DBObjPtr)(hRec);
                                                	}

							if (iRet == PD_OK) {
								sprintf(csCustomerGroup,"GRP_N");
                                                        	PutField_CString(hContext,"customer_group",csCustomerGroup);
							}
						}
					}		
				}	

				///(phase 2) customer promotion checking
				DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupPromoList","FindPromoCustomer");
				if ((unsigned long)(DBObjPtr)(csMerchantId,csCustomerTag) == FOUND) {
					iPromote = PD_TRUE;
				}

				if(!iPromote){
					PutField_CString(hContext,"customer_group",csCustomerGroup);
				}
				else{
					iCheckLB = PD_TRUE;
					iGroupCnt = 0;

					///(phase 2) customer promotion start
					// 1st check any segment A/B/C rule did not have virtual PID
					hash_destroy(hRec);
                                        hash_init(hRec,0);
					DBObjPtr = CreateObj(DBPtr,"DBRuleLB","FindRuleWithoutVirtualPID");
					if ( (unsigned long)(DBObjPtr)(csChannelCode,
								csMerchantId,
								csServiceCode,
								csCountryId,
								csCurrencyId,
								csCustomerGroup,
								cCardType,
								dAmt,
								hRec) == PD_OK) {

								if(GetField_Int(hRec,"group_cnt",&iGroupCnt)){
DEBUGLOG(("CreateCustomerGroup Total [%d] Segment Rule(s) did not have Virtual PID\n",iGroupCnt));
								}

								if(iGroupCnt==0)
									iCheckLB = PD_FALSE;
					}
					else{
						iRet = INT_ERR;
DEBUGLOG(("CreateCustomerGroup DBRuleLB:FindRuleWithoutVirtualPID Failed!!!\n"));
ERRLOG("BOCustomerGroup: CreateCustomerGroup DBRuleLB:FindRuleWithoutVirtualPID Failed!!!\n");
					}

					if(iRet == PD_OK){
						iGroupCnt = 0;
						if(iCheckLB){
							//Get Available Segment from Load Balance Rule
							hash_destroy(hRec);
							hash_init(hRec,0);
DEBUGLOG(("CreateCustomerGroup trying to pickup a new group for [%s][%s]\n",csMerchantId,csCustomerTag));
							DBObjPtr = CreateObj(DBPtr,"DBRuleLB","GetPromoteCustomerGroup_CardType");	
							if ( (unsigned long)(DBObjPtr)(csChannelCode,
										csMerchantId,
										csServiceCode,
										csCountryId,
										csCurrencyId,
										csCustomerGroup,
										cCardType,
										dAmt,
										csBankCode,
										hRec) ==PD_OK) {

								if(GetField_Int(hRec,"group_cnt",&iGroupCnt)){
DEBUGLOG(("CreateCustomerGroup Total [%d] group(s) support bank[%s]\n",iGroupCnt,csBankCode));
								}

								if(iGroupCnt == 0){
									iRet = INT_CUSTOMER_SEGMENT_NOT_FOUND;
DEBUGLOG(("CreateCustomerGroup No Group available for bank[%s] to promote!!!!!!\n",csBankCode));
								}
								else if(iGroupCnt == 1){
									if(GetField_CString(hRec,"customer_group_0",&csTmp)){
										sprintf(csToGroup,"%s",csTmp);
										iRet = PD_SKIP_OK;
DEBUGLOG(("CreateCustomerGroup pick group[%s] directly\n",csToGroup));
									}
									else{
										iRet = INT_ERR;
DEBUGLOG(("CreateCustomerGroup DBTxnLb: GetCustomerGroup Failed!!!\n"));
ERRLOG("BOCustomerGroup: CreateCustomerGroup DBTxnLb: GetCustomerGroup Failed!!!\n");
									}
								}
							}
							else{
								iRet = INT_ERR;
DEBUGLOG(("CreateCustomerGroup DBTxnLb: GetCustomerGroup Failed!!!\n"));
ERRLOG("BOCustomerGroup: CreateCustomerGroup DBTxnLb: GetCustomerGroup Failed!!!\n");
							}

						}

						else{
							//Get All segment supported by Merchant (Segment Rules were all using Virtual PID, just select segment by ratio)
							hash_destroy(hRec);
							hash_init(hRec,0);
							DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupRules","GetAllPromoteSegment");	
							if((unsigned long)(DBObjPtr)(csMerchantId,
											 csCustomerGroup,
											 hRec)==PD_OK){

								if(GetField_Int(hRec,"group_cnt",&iGroupCnt)){
DEBUGLOG(("CreateCustomerGroup Total [%d] Segment(s) Present\n",iGroupCnt));
								}

								if(iGroupCnt == 0){
									iRet = INT_CUSTOMER_SEGMENT_NOT_FOUND;
DEBUGLOG(("CreateCustomerGroup No Segment to promote!!!!!!\n"));
								}
							}
							else{
								iRet = INT_ERR;
DEBUGLOG(("CreateCustomerGroup DBCustomerGroupRules:GetAllPromoteSegment() Failed!!!\n"));
ERRLOG("BOCustomerGroup: CreateCustomerGroup DBCustomerGroupRules:GetAllPromoteSegment() Failed!!!\n");
							}
						}
					}


					if(iRet == PD_OK){
						//Pick One Segment
						DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupRules","PickPromoteGroup");	
						iRet = (unsigned long)(DBObjPtr)(csMerchantId,
								csCountryId,
								csChannelCode,
								csServiceCode,
								csCurrencyId,
								csDate,
								csCustomerGroup,
								hRec,
								&csToGroup);

						if(iRet!=FOUND){
DEBUGLOG(("CreateCustomerGroup Pickup Group not found.\n"));
							iRet = INT_CUSTOMER_SEGMENT_NOT_FOUND;
						}
						else{
							iRet=PD_OK;
DEBUGLOG(("CreateCustomerGroup Pickup Group Success [%s]\n",csToGroup));
						}
					}

					
					if(iRet==PD_SKIP_OK)
						iRet = PD_OK;

					if(iRet == PD_OK){
						//update customer group detail, add change group log and update promote list
						hash_destroy(hRec);
						hash_init(hRec,0);
						PutField_CString(hRec,"customer_group",csToGroup);
						PutField_CString(hRec,"merchant_id",csMerchantId);
						PutField_CString(hRec,"customer_tag",csCustomerTag);
						PutField_CString(hRec,"update_user",PD_UPDATE_USER);
DEBUGLOG(("CreateCustomerGroup new group [%s] for [%s][%s]\n",csToGroup,csMerchantId,csCustomerTag));
						DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","UpdateGroup");	
						iRet =  (unsigned long)(DBObjPtr)(hRec);
DEBUGLOG(("CreateCustomerGroup iRet = [%d] new group [%s] for [%s][%s]\n",iRet,csToGroup,csMerchantId,csCustomerTag));
						if (iRet == PD_OK) {
							PutField_CString(hRec,"to_customer_group",csToGroup);
							PutField_CString(hRec,"from_customer_group",csCustomerGroup);
							DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupLog","Add");	
							iRet =  (unsigned long)(DBObjPtr)(hRec);
DEBUGLOG(("CreateCustomerGroup DBCustomerGroupLog: Add [%d]\n",iRet));
						}
						if (iRet == PD_OK){
							PutField_CString(hRec,"date",csDate);
							DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupPromoList","UpdatePromteCustomer");	
							iRet =  (unsigned long)(DBObjPtr)(hRec);
DEBUGLOG(("CreateCustomerGroup DBCustomerGroupPromoList: UpdatePromteCustomer [%d]\n",iRet));
						}
						if (iRet == PD_OK)
							PutField_CString(hContext,"customer_group",csToGroup);

					}
					else if(iRet == INT_CUSTOMER_SEGMENT_NOT_FOUND){
						PutField_CString(hContext,"customer_group",csCustomerGroup);
						iRet = PD_OK;
DEBUGLOG(("CreateCustomerGroup No promotion this time. Remain in the original segment[%s]\n",csCustomerGroup));

					}
				}
			}
		}
		else {
			PutField_Int(hContext,"cust_seg_enabled",PD_FALSE);
DEBUGLOG(("CreateCustomerGroup customer group not enabled for MID [%s], skip!!!\n",csMerchantId));
		}
	}
	else {
DEBUGLOG(("CreateCustomerGroup customer_tag not Found, skip!!!\n"));
	}

	if(iRet==PD_SKIP_OK)
		iRet = PD_OK;

	hash_destroy(hRec);
	FREE_ME(hRec);
DEBUGLOG(("CreateCustomerGroup:: iRet = [%d]\n",iRet));
	return iRet;
}




int ChangeGroup(hash_t* hTxn)
{
	int	iRet = PD_OK;
	char	*csFromCustomerGroup;
	char	*csToCustomerGroup;
	char	*csMerchantId;
	char	*csCountry;
	char	*csServiceCode;
	char	*csTxnCcy;
	char	*csCustomerTag;
	char	*csOrgChannelCode;
	char	*csOrgPostDate;
	//char	*csDate;
	char	*csUser;
	double	dOrgAmt = 0.0;
	int	iChangeHistorical = PD_TRUE;

DEBUGLOG(("ChangeGroup\n"));

	if (GetField_CString(hTxn,"merchant_id",&csMerchantId)) {
DEBUGLOG(("ChangeGroup Merchant Id [%s]\n",csMerchantId));
	}
/*
	if (GetField_CString(hTxn,"txn_country",&csCountry)) {
DEBUGLOG(("ChangeGroup txn_country [%s]\n",csCountry));
	}
	if (GetField_CString(hTxn,"service_code",&csServiceCode)) {
DEBUGLOG(("ChangeGroup service_code [%s]\n",csServiceCode));
	}
	if (GetField_CString(hTxn,"txn_ccy",&csTxnCcy)) {
DEBUGLOG(("ChangeGroup txn_ccy [%s]\n",csTxnCcy));
	}
*/
	if (GetField_CString(hTxn,"customer_tag",&csCustomerTag)) {
DEBUGLOG(("ChangeGroup Customer Tag[%s]\n",csCustomerTag));
	}
	if (GetField_CString(hTxn,"from_customer_group",&csFromCustomerGroup)) {
DEBUGLOG(("ChangeGroup from_customer_group [%s]\n",csFromCustomerGroup));
	}
	if (GetField_CString(hTxn,"to_customer_group",&csToCustomerGroup)) {
DEBUGLOG(("ChangeGroup to_customer_group [%s]\n",csToCustomerGroup));
	}
/*
	if (GetField_CString(hTxn,"date",&csDate)) {
DEBUGLOG(("ChangeGroup date [%s]\n",csDate));
	}
*/
	if (GetField_CString(hTxn,"update_user",&csUser)) {
DEBUGLOG(("ChangeGroup update_user [%s]\n",csUser));
	}
	if (GetField_Int(hTxn,"is_change_his",&iChangeHistorical)) {
DEBUGLOG(("ChangeGroup is_change_historical [%d]\n",iChangeHistorical));
	}

	DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupMerchant","FindMerchant");	
	if ((unsigned long)(DBObjPtr)(csMerchantId) == FOUND) {

		DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","MatchRecord");	
		if ((unsigned long)(DBObjPtr)(csMerchantId,csCustomerTag,csFromCustomerGroup) == FOUND) {
DEBUGLOG(("ChangeGroup [%s][%s][%s] Found!!!\n",csMerchantId,csCustomerTag,csFromCustomerGroup));
			DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","UpdateGroup");	
			PutField_CString(hTxn,"customer_group",csToCustomerGroup);
			if ((unsigned long)(DBObjPtr)(hTxn) != PD_OK) {
DEBUGLOG(("ChangeGroup UpdateGroup Failed!!!\n"));
ERRLOG("BOCustomerGroup: ChangeGroup UpdateGroup Failed!!!!!!\n");
				iRet = INT_ERR;
			}
			else {
				DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupLog","Add");	
				iRet =  (unsigned long)(DBObjPtr)(hTxn);
DEBUGLOG(("ChangeGroup DBCustomerGroupLog: Add [%d]\n",iRet));
			}
		}
		else {
			iRet = PD_SKIP_OK;
DEBUGLOG(("ChangeGroup customer group not matched, skip!!!\n"));
		}

	}
	else {
		iRet = PD_SKIP_OK;
DEBUGLOG(("ChangeGroup customer group not enabled for MID [%s], skip!!!\n",csMerchantId));
	}

	if(iRet == PD_OK && iChangeHistorical){
		DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","GetMerchantDetailByCust");
		iRet = (unsigned long)(DBObjPtr)(csMerchantId,csCustomerTag,hTxn);
		if(iRet == PD_OK){
			if (GetField_CString(hTxn,"txn_country",&csCountry)) {
DEBUGLOG(("ChangeGroup txn_country [%s]\n",csCountry));
			}
			if (GetField_CString(hTxn,"service_code",&csServiceCode)) {
DEBUGLOG(("ChangeGroup service_code [%s]\n",csServiceCode));
			}
			if (GetField_CString(hTxn,"txn_ccy",&csTxnCcy)) {
DEBUGLOG(("ChangeGroup txn_ccy [%s]\n",csTxnCcy));
			}
		}
DEBUGLOG(("ChangeGroup DBCustomerGroupDetail: GetMerchantDetailByCust [%d]\n",iRet));
	}

	hash_t  *hRec;
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
	int iTxnCnt = 0;

	if(iRet == PD_OK && iChangeHistorical){
		//find record in from_group
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetCustomerHistoryTxnList");
		if ((unsigned long)(DBObjPtr)(csMerchantId,
					      csCountry,
					      csServiceCode,
					      csTxnCcy,
					      csCustomerTag,
					      csFromCustomerGroup,
					      hTxn) == PD_OK) {
			if(GetField_Int(hTxn,"txn_count",&iTxnCnt)){
DEBUGLOG(("ChangeGroup total txn record count [%d]\n",iTxnCnt));
			}
		}
	}

	if(iRet == PD_OK && iTxnCnt>0){
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetCustomerHistoryDetail");
		if ((unsigned long)(DBObjPtr)(hTxn,
					rRecordSet) == PD_OK) {

			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec && iRet == PD_OK){
				if(GetField_CString(hRec,"host_posting_date",&csOrgPostDate) &&
				   GetField_CString(hRec,"channel_code",&csOrgChannelCode) &&
				   GetField_Double(hRec,"txn_amt",&dOrgAmt)){
DEBUGLOG(("ChangeGroup Update Delta [%s][%lf]\n",csOrgPostDate,dOrgAmt));
					//transfer the value from from_group to to_group
					DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupCounters","ChangeGroupDelta");
					if ((unsigned long)(DBObjPtr)(
							csCountry,
							csOrgChannelCode,
							csServiceCode,
							csTxnCcy,
							csFromCustomerGroup,
							csToCustomerGroup,
							csOrgPostDate,
							dOrgAmt,
							csUser) != PD_OK){
						iRet = INT_ERR;
					}
				}

				hRec = RecordSet_GetNext(rRecordSet);
			}

			//////update txn_detail by batch
			if(iRet == PD_OK){
				PutField_CString(hTxn,"customer_group",csToCustomerGroup);
				DBObjPtr = CreateObj(DBPtr,"DBTransaction","BatchUpdateCustomerGroup");
				if ((unsigned long)(DBObjPtr)(hTxn) != PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("ChangeGroup DBTransaction:BatchUpdateCustomerGroup Failed!!!\n"));
				}
			}
		}
		else {
			iRet = PD_SKIP_OK;
DEBUGLOG(("ChangeGroup no volume, skip!!!\n"));
		}
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);


	if(iRet == PD_SKIP_OK)
		iRet = PD_OK;

DEBUGLOG(("ChangeGroup:: iRet = [%d]\n",iRet));
	return iRet;
}



int	GetAavailableMobSegment(const char* csMerchantId, hash_t* hTxn)
{
	int iRet = PD_OK;
	int iChk = PD_OK;
	int iCnt = 0;
	int iDef = PD_FALSE;
	int iAssignDefGrp = PD_TRUE;

	char* csGroup;
	char* csTmp;
	char csTag[PD_TAG_LEN+1];
	char* csBankCode;
	char*  csUnionGroup = NULL;
	char*  csOverflowGroup = NULL;

	int iTmp = 0;
	int dTmp = 0.0;
	int iFirstDis = PD_FALSE;
	
	hash_t  *hSeg;
	hash_t  *hRec;
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	hSeg = (hash_t*) malloc(sizeof(hash_t));
	hash_init(hSeg, 0);

DEBUGLOG(("GetAavailableMobSegment()\n"));
	//get all mobile segments' info (enable new customer flag = 1 , Exceed Customer Flag and Exceed Amount Flag = 0):
	//	overflow group, union group, is outage, def assign, first time display
	DBObjPtr = CreateObj(DBPtr,"DBMobBankSelection","GetAllMobileSegmentsInfo");
	iChk = (unsigned long)(DBObjPtr)(csMerchantId,rRecordSet);
	if (iChk == PD_FOUND) {

		hRec = RecordSet_GetFirst(rRecordSet);
		while(hRec){
			csUnionGroup = NULL;
			csOverflowGroup = NULL;

			if(GetField_CString(hRec,"mob_segment",&csGroup) && 
			   GetField_CString(hRec,"bank_code",&csBankCode) &&
			   GetField_Int(hRec,"def_assign",&iDef)){

				GetField_Int(hRec,"first_time_display",&iFirstDis);

				if(GetField_CString(hRec,"union_group",&csUnionGroup)){
					sprintf(csTag,"union_group_%s",csGroup);
					PutField_CString(hSeg,csTag,csUnionGroup);
				}

				if(GetField_CString(hRec,"overflow_group",&csOverflowGroup)){
					sprintf(csTag,"overflow_group_%s",csGroup);
					PutField_CString(hSeg,csTag,csOverflowGroup);
				}

DEBUGLOG(("GetAavailableMobSegment() [%s][%s] 1st time display?[%d], default segment?[%d] union grp[%s], overflow grp[%s]\n",csGroup,csBankCode,iFirstDis,iDef,csUnionGroup,csOverflowGroup));

				if(iFirstDis){
					PutField_CString(hTxn,"pick_group",csGroup);
					if(csUnionGroup) PutField_CString(hTxn,"union_group",csUnionGroup);
					if(csOverflowGroup) PutField_CString(hTxn,"overflow_group",csOverflowGroup);
					iAssignDefGrp = PD_FALSE;
					break;
				}
				else if(iDef){
					PutField_CString(hSeg,"def_group",csGroup);
					break;
				}
				else{
					sprintf(csTag,"segment_%d",iCnt);
					PutField_CString(hSeg,csTag,csGroup);

					if(GetField_Int(hRec,"cust_cnt_limit",&iTmp)){
						sprintf(csTag,"cust_cnt_limit_%d",iCnt);
						PutField_Int(hSeg,csTag,iTmp);
					}

					if(GetField_Int(hRec,"amt_limit",&dTmp)){
						sprintf(csTag,"amt_limit_%d",iCnt);
						PutField_Double(hSeg,csTag,dTmp);
					}

					iCnt++;
					PutField_Int(hSeg,"seg_cnt",iCnt);
				}
			}

			hRec = RecordSet_GetNext(rRecordSet);
		}
	}
	else if (iChk == PD_NOT_FOUND){
		//seems all segment are not available (outage/not allow tag new customer/exceed cnt or amt limit)
		iRet = INT_NO_BANK_AVAILABLE;
	}
	else if (iChk == PD_ERR){
		iRet = INT_ERR;
DEBUGLOG(("GetAavailableMobSegment() DBMobBankSelection::GetAllMobileSegments Failed!!!!\n"));
	}

	if(iRet == PD_OK && iCnt>0){
		if(PickMobileGroup(hSeg) == PD_FOUND){
			if(GetField_CString(hSeg,"pick_group",&csTmp)){
				PutField_CString(hTxn,"pick_group",csTmp);

				sprintf(csTag,"union_group_%s",csTmp);
				if(GetField_CString(hSeg,csTag,&csUnionGroup)){
					PutField_CString(hTxn,"union_group",csUnionGroup);
				}
				
				sprintf(csTag,"overflow_group_%s",csTmp);
				if(GetField_CString(hSeg,csTag,&csOverflowGroup)){
					PutField_CString(hTxn,"overflow_group",csOverflowGroup);
				}
				
				iAssignDefGrp = PD_FALSE;
			}
		}
	}
	
	if(iRet == PD_OK && iAssignDefGrp){
		//if no group can be picked, pick the default segment
		if(GetField_CString(hSeg,"def_group",&csTmp)){
			PutField_CString(hTxn,"pick_group",csTmp);

			sprintf(csTag,"union_group_%s",csTmp);
			if(GetField_CString(hSeg,csTag,&csUnionGroup)){
				PutField_CString(hTxn,"union_group",csUnionGroup);
			}

			sprintf(csTag,"overflow_group_%s",csTmp);
			if(GetField_CString(hSeg,csTag,&csOverflowGroup)){
				PutField_CString(hTxn,"overflow_group",csOverflowGroup);
			}

DEBUGLOG(("GetAavailableMobSegment() Pick Group [%s] (Default)\n",csTmp));
		}
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hSeg);

DEBUGLOG(("GetAavailableMobSegment() iRet = [%d]\n",iRet));
	return iRet;
}


int	PickMobileGroup(hash_t* hTxn)
{
	int iRet = PD_NOT_FOUND;
	int iCnt = 0;
	int iRandIndex=0;
	char *csTmp;
	char csTag[PD_TAG_LEN+1];

	GetField_Int(hTxn,"seg_cnt",&iCnt);
DEBUGLOG(("PickMobileGroup()  count = [%d]\n",iCnt));

	if(iCnt==1){
		sprintf(csTag,"segment_%d",iCnt-1);
		if(GetField_CString(hTxn,csTag,&csTmp)){
			PutField_CString(hTxn,"pick_group",csTmp);
			iRet = PD_FOUND;
DEBUGLOG(("PickMobileGroup() Pick Group [%s]\n",csTmp));
		}
	}
	else{
		//TODO:random select when more than one non-default segment, if not, please change this part 
		iRandIndex = rand() % iCnt;
		sprintf(csTag,"segment_%d",iRandIndex);
		if(GetField_CString(hTxn,csTag,&csTmp)){
			PutField_CString(hTxn,"pick_group",csTmp);
			iRet = PD_FOUND;
DEBUGLOG(("PickMobileGroup() Pick Group [%s]\n",csTmp));
		}
	}
	
DEBUGLOG(("PickMobileGroup() iRet = [%d]\n",iRet));
	return iRet;
}


int	HandleMobSegmentThreshold(const hash_t* hTxn)
{
	int iRet = PD_OK;
	char	*csTmp;
	char	*csMerchantId;
	char	*csServiceCode;
	char	*csCcy;
	char	*csCountry;
	char	*csChannelCode;
	char	*csDate;
	char	*csCustomerGroup;
	char	*csUser;
	int	iCustCnt = 0;
	int	iIsExceedCnt = PD_FALSE;
	int	iIsExceedAmt = PD_FALSE;
	double	dAmtLimit = 0.0;
	int	iCnt = 0;

	int	iUpdate = PD_FALSE;
	int	iExCnt = PD_FALSE;
	int	iExAmt = PD_FALSE;
	char    csCmd[PD_MAX_FILE_LEN + 1];

	hash_t *hSeg;
	hSeg = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hSeg,0);

	hash_t *hUpd;
	hUpd = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hUpd,0);

DEBUGLOG(("HandleMobSegmentThreshold()\n"));

	if(GetField_CString(hTxn,"merchant_id",&csMerchantId)){
DEBUGLOG(("HandleMobSegmentThreshold() merchant_id = [%s]\n",csMerchantId));
	}

	if(GetField_CString(hTxn,"service_code",&csServiceCode)){
DEBUGLOG(("HandleMobSegmentThreshold() service_code = [%s]\n",csServiceCode));
	}

	if(GetField_CString(hTxn,"txn_ccy",&csCcy)){
DEBUGLOG(("HandleMobSegmentThreshold() txn_ccy = [%s]\n",csCcy));
	}

	if(GetField_CString(hTxn,"txn_country",&csCountry)){
DEBUGLOG(("HandleMobSegmentThreshold() txn_country = [%s]\n",csCountry));
	}

	if(GetField_CString(hTxn,"channel_code",&csChannelCode)){
DEBUGLOG(("HandleMobSegmentThreshold() channel_code = [%s]\n",csChannelCode));
	}

	if(GetField_CString(hTxn,"PHDATE",&csDate)){
DEBUGLOG(("HandleMobSegmentThreshold() PHDATE = [%s]\n",csDate));
	}

	if(GetField_CString(hTxn,"customer_group",&csCustomerGroup)){
DEBUGLOG(("HandleMobSegmentThreshold() customer_group = [%s]\n",csCustomerGroup));
	}

	if(GetField_CString(hTxn,"customer_tag",&csTmp)){
DEBUGLOG(("HandleMobSegmentThreshold() customer_tag = [%s]\n",csTmp));
	}

	if(GetField_CString(hTxn,"create_user",&csUser)){
		PutField_CString(hUpd,"update_user",csUser);
DEBUGLOG(("HandleMobSegmentThreshold() create_user = [%s]\n",csUser));
	}

	//check cnt and amt limit flag
	DBObjPtr = CreateObj(DBPtr,"DBMobSegmentThreshold","GetThreshold");
	if ((unsigned long)(DBObjPtr)(csCustomerGroup,hSeg) == PD_FOUND) {
	
		if(GetField_Int(hSeg,"cust_cnt",&iCustCnt)){
DEBUGLOG(("HandleMobSegmentThreshold() cust_cnt = [%d]\n",iCustCnt));
		}
		if(GetField_Int(hSeg,"is_exceed_cnt",&iIsExceedCnt)){
DEBUGLOG(("HandleMobSegmentThreshold() is_exceed_cnt = [%d]\n",iIsExceedCnt));
		}
		if(GetField_Double(hSeg,"amt_limit",&dAmtLimit)){
DEBUGLOG(("HandleMobSegmentThreshold() amt_limit = [%lf]\n",dAmtLimit));
		}
		if(GetField_Int(hSeg,"is_exceed_amt",&iIsExceedAmt)){
DEBUGLOG(("HandleMobSegmentThreshold() is_exceed_amt = [%d]\n",iIsExceedAmt));
		}

		//if off, check the cust cnt and amt
		if(!iIsExceedCnt){
			DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","GetCustomerCntBySegment");
			iCnt = (unsigned long)(DBObjPtr)(csMerchantId,csCustomerGroup);
DEBUGLOG(("HandleMobSegmentThreshold() count for [%s][%s] = [%d]\n",csMerchantId,csCustomerGroup,iCnt));

			if(iCnt>=iCustCnt){
				iUpdate = PD_TRUE;
				iExCnt = PD_TRUE;
				PutField_Int(hUpd,"is_exceed_cnt",iUpdate);
			}
		}

		if(!iIsExceedAmt){
			double dAmt = 0.0;
			DBObjPtr = CreateObj(DBPtr,"DBTxnCounters","GetMobAmtCount");
			iRet = (unsigned long)(DBObjPtr)(csMerchantId,csCcy,csCustomerGroup,&dAmt);
			if(iRet == PD_OK){
				if(dAmt>=dAmtLimit){
					iUpdate = PD_TRUE;
					iExAmt = PD_TRUE;
					PutField_Int(hUpd,"is_exceed_amt",iUpdate);
				}
			}
DEBUGLOG(("HandleMobSegmentThreshold() GetMobAmtCount iRet[%d]. Amount for [%s][%s][%s] = [%lf]\n",iRet,csMerchantId,csCcy,csCustomerGroup,dAmt));
			
		}

		//once exceed, turn on the flag
		if(iUpdate){
DEBUGLOG(("HandleMobSegmentThreshold() Call DBMobSegmentThreshold:Update\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMobSegmentThreshold","Update");
			iRet = (unsigned long)(DBObjPtr)(csCustomerGroup,hUpd);
DEBUGLOG(("HandleMobSegmentThreshold() DBMobSegmentThreshold:Update iRet = [%d]\n",iRet));

			if(iRet == PD_OK){
				sprintf(csCmd,"mobile_segment_threshold.sh %s %d %d %s %d %.2f>/dev/null 2>&1",csCustomerGroup,iExCnt,iExAmt,csUser,iCustCnt,dAmtLimit);
				system(csCmd);
			}
		}
	}

	FREE_ME(hSeg);
	FREE_ME(hUpd);
DEBUGLOG(("HandleMobSegmentThreshold() iRet = [%d]\n",iRet));
	return iRet;
}
