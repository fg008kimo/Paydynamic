/*
Partnerdelight (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/10              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOCustomerGroup.h"

char    cDebug;

void BOCustomerGroup(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(DB);
OBJPTR(BO);

int CreateCustomerGroup(hash_t* hContext,
                hash_t *hRequest,
                hash_t *hResponse)
{
	int	iRet = PD_OK;
	char	*csCustomerTag;
	char	*csMerchantId;
	char	*csCountryId;
	char	*csChannelCode;
	char	*csServiceCode;
	char	*csCurrencyId;

	char	csCustomerGroup[PD_CUSTOMER_GROUP_CODE_LEN +1];
DEBUGLOG(("CreateCustomerGroup\n"));

	if (GetField_CString(hContext,"customer_tag",&csCustomerTag)) {
DEBUGLOG(("CreateCustomerGroup Found tag [%s]\n",csCustomerTag));
		if (GetField_CString(hContext,"org_merchant_id",&csMerchantId)) {
DEBUGLOG(("CreateCustomerGroup Merchant Id [%s]\n",csMerchantId));
		}

/* check if enabled the customer grouping */
		DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupMerchant","FindMerchant");	
		if ((unsigned long)(DBObjPtr)(csMerchantId) == FOUND) {

			DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","FindGroup");	
			if ((unsigned long)(DBObjPtr)(csMerchantId,csCustomerTag,&csCustomerGroup) == NOT_FOUND) {
DEBUGLOG(("CreateCustomerGroup Merchant Id [%s][%s] is new!!!\n",csMerchantId,csCustomerTag));
				DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupRules","FindGroupCnt");	
				if ((unsigned long)(DBObjPtr)(csMerchantId) == NOT_FOUND) {
DEBUGLOG(("CreateCustomerGroup not rule define for  Merchant Id!!!\n"));
ERRLOG("CreateCustomerGroup not rule define for  Merchant Id!!!\n");
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
				}
				else {
DEBUGLOG(("CreateCustomerGroup trying to pickup a group for [%s][%s]\n",csMerchantId,csCustomerTag));
					hash_t *hRec;
					hRec = (hash_t*) malloc (sizeof(hash_t));
       		 			hash_init(hRec,0);
/* country id */
					if (GetField_CString(hContext,"org_txn_country",&csCountryId)) {
DEBUGLOG(("CreateCustomerGroup Country Id = [%s]\n",csCountryId));
					}
/* channel code */
					if (GetField_CString(hContext,"channel_code",&csChannelCode)) {
DEBUGLOG(("CreateCustomerGroup channel_code = [%s]\n",csChannelCode));
					}
/* service code */
					if (GetField_CString(hContext,"org_service_code",&csServiceCode)) {
DEBUGLOG(("CreateCustomerGroup service_code = [%s]\n",csServiceCode));
					}
/* txn_ccy */
					if (GetField_CString(hContext,"org_txn_ccy",&csCurrencyId)) {
DEBUGLOG(("CreateCustomerGroup txn_ccy = [%s]\n",csCurrencyId));
					}
					DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupRules","PickGroup");	
					if ( (unsigned long)(DBObjPtr)(csMerchantId,
									csCountryId,
									csChannelCode,
									csServiceCode,
									csCurrencyId,
									PD_VALUE_TYPE_AMT,
									&csCustomerGroup) == NOT_FOUND) {
ERRLOG("BOCustomerGroup::CreateCustomerGroup Pickup Group Error\n");
DEBUGLOG(("BOCustomerGroup::CreateCustomerGroup Pickup Group Error\n"));
						iRet = INT_ERR;
						PutField_Int(hContext,"internal_error",iRet);
					}
					else {
/* customer group */
						PutField_CString(hRec,"customer_group",csCustomerGroup);
/* merchant_id */
						PutField_CString(hRec,"merchant_id",csMerchantId);
/* customer_tag */
						PutField_CString(hRec,"customer_tag",csCustomerTag);
/* create_user */
						PutField_CString(hRec,"create_user",PD_UPDATE_USER);
DEBUGLOG(("BOCustomerGroup::CreateCustomerGroup new group [%s] for [%s][%s]\n",csCustomerGroup,csMerchantId,csCustomerTag));
						DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","Add");	
						iRet =  (unsigned long)(DBObjPtr)(hRec);
DEBUGLOG(("BOCustomerGroup::CreateCustomerGroup iREt = [%d] new group [%s] for [%s][%s]\n",iRet,csCustomerGroup,csMerchantId,csCustomerTag));
						if (iRet == PD_OK) 
							PutField_CString(hContext,"customer_group",csCustomerGroup);
					}
					FREE_ME(hRec);
				}
			}
			else {
DEBUGLOG(("CreateCustomerGroup Found [%s] for Merchant Id [%s][%s]\n",csCustomerGroup,csMerchantId,csCustomerTag));
				PutField_CString(hContext,"customer_group",csCustomerGroup);
			}
		}
		else {
DEBUGLOG(("CreateCustomerGroup customer group not enabled for MID [%s], skip!!!\n",csMerchantId));
		}
	}
	else {
DEBUGLOG(("CreateCustomerGroup not Found, skip!!!\n"));
	}

DEBUGLOG(("CreateCustomerGroup:: iRet = [%d]\n",iRet));
	return iRet;
}
