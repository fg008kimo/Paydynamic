/*
Partnerdelight (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/10              Cody Chan
use BankCode to find the possible Group first	   2013/09/12		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOCustomerGroup.h"

char    cDebug;

void BOCustomerGroup(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(DB);
OBJPTR(BO);

int CreateCustomerGroup(hash_t* hContext,
                hash_t *hRequest,
                hash_t *hResponse)
{
	int	iRet = PD_OK;
	int	iGroupCnt = 0;
	char	*csCustomerTag;
	char	*csMerchantId;
	char	*csCountryId;
	char	*csChannelCode;
	char	*csServiceCode;
	char	*csCurrencyId;
	char	*csBankCode;
	char	*csDate;
	char	*csTmp;
	int	iPromote = PD_FALSE;

	hash_t *hRec;
	hRec = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRec,0);

	char	csToGroup[PD_CUSTOMER_GROUP_CODE_LEN +1];
	char	csCustomerGroup[PD_CUSTOMER_GROUP_CODE_LEN +1];
DEBUGLOG(("CreateCustomerGroup\n"));

	if (GetField_CString(hContext,"PHDATE",&csDate)) {
DEBUGLOG(("CreateCustomerGroup PH Date = [%s]\n",csDate));
	}
/* country id */
	if (GetField_CString(hContext,"org_txn_country",&csCountryId)) {
DEBUGLOG(("CreateCustomerGroup Country Id = [%s]\n",csCountryId));
	}
/* channel code */
	if (GetField_CString(hContext,"channel_code",&csChannelCode)) {
DEBUGLOG(("CreateCustomerGroup channel_code = [%s]\n",csChannelCode));
	}
/* service code */
	if (GetField_CString(hContext,"org_service_code",&csServiceCode)) {
DEBUGLOG(("CreateCustomerGroup service_code = [%s]\n",csServiceCode));
	}
/* txn_ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csCurrencyId)) {
DEBUGLOG(("CreateCustomerGroup txn_ccy = [%s]\n",csCurrencyId));
	}
/*bank_code*/
	if (GetField_CString(hContext,"bank_code",&csBankCode)) {
DEBUGLOG(("CreateCustomerGroup bank_code= [%s]\n",csBankCode));
	}

	if (GetField_CString(hContext,"customer_tag",&csCustomerTag)) {
DEBUGLOG(("CreateCustomerGroup Found tag [%s]\n",csCustomerTag));
		if (GetField_CString(hContext,"org_merchant_id",&csMerchantId)) {
DEBUGLOG(("CreateCustomerGroup Merchant Id [%s]\n",csMerchantId));
		}

/* check if enabled the customer grouping */
		DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupMerchant","FindMerchant");	
		if ((unsigned long)(DBObjPtr)(csMerchantId) == FOUND) {

			PutField_Int(hContext,"cust_seg_enabled",PD_TRUE);
			DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","FindGroup");	
			if ((unsigned long)(DBObjPtr)(csMerchantId,csCustomerTag,&csCustomerGroup) == NOT_FOUND) {
DEBUGLOG(("CreateCustomerGroup Merchant Id [%s][%s] is new!!!\n",csMerchantId,csCustomerTag));
				DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupRules","FindGroupCnt");	
				if ((unsigned long)(DBObjPtr)(csMerchantId) == NOT_FOUND) {
DEBUGLOG(("CreateCustomerGroup not rule define for  Merchant Id!!!\n"));
ERRLOG("BOCustomerGroup:CreateCustomerGroup not rule define for  Merchant Id!!!\n");
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
				}
				else {
DEBUGLOG(("CreateCustomerGroup trying to pickup a group for [%s][%s]\n",csMerchantId,csCustomerTag));
					DBObjPtr = CreateObj(DBPtr,"DBRuleLB","GetCustomerGroup");	
					if ( (unsigned long)(DBObjPtr)(csMerchantId,
								csServiceCode,
								csCurrencyId,
								csBankCode,
								hRec) ==PD_OK) {

						if(GetField_Int(hRec,"group_cnt",&iGroupCnt)){
DEBUGLOG(("CreateCustomerGroup Total [%d] group(s) support bank[%s]\n",iGroupCnt,csBankCode));
						}

						if(iGroupCnt == 0){
							iRet = PD_SKIP_OK;
							/*iRet = INT_CUSTOMER_SEGMENT_NOT_FOUND;
							PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("CreateCustomerGroup No Group available for bank[%s]!!!!!!\n",csBankCode));
ERRLOG("BOCustomerGroup: CreateCustomerGroup No Group available for bank[%s]!!!\n",csBankCode);*/
							
DEBUGLOG(("CreateCustomerGroup No Group in load balance scheme!!!!!!\n"));
						}
						else if(iGroupCnt == 1){
							if(GetField_CString(hRec,"customer_group_0",&csTmp)){
								sprintf(csCustomerGroup,"%s",csTmp);
DEBUGLOG(("CreateCustomerGroup pick group[%s] directly\n",csCustomerGroup));
							}
							else{
								iRet = INT_ERR;
DEBUGLOG(("CreateCustomerGroup DBTxnLb: GetCustomerGroup Failed!!!\n"));
ERRLOG("BOCustomerGroup: CreateCustomerGroup DBTxnLb: GetCustomerGroup Failed!!!\n");
							}
						}
						else{
							DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupRules","PickGroup");	
							if ( (unsigned long)(DBObjPtr)(csMerchantId,
										csCountryId,
										csChannelCode,
										csServiceCode,
										csCurrencyId,
										csDate,
										hRec,
										&csCustomerGroup) == NOT_FOUND) {
ERRLOG("BOCustomerGroup: CreateCustomerGroup Pickup Group Error\n");
DEBUGLOG(("CreateCustomerGroup Pickup Group Error\n"));
								iRet = INT_ERR;
								PutField_Int(hContext,"internal_error",iRet);
							}

						}
					}
					else{
						iRet = INT_ERR;
DEBUGLOG(("CreateCustomerGroup DBTxnLb: GetCustomerGroup Failed!!!\n"));
ERRLOG("BOCustomerGroup: CreateCustomerGroup DBTxnLb: GetCustomerGroup Failed!!!\n");
					}


					if(iRet == PD_OK){
						hash_init(hRec,0);
						PutField_CString(hRec,"customer_group",csCustomerGroup);
						PutField_CString(hRec,"merchant_id",csMerchantId);
						PutField_CString(hRec,"customer_tag",csCustomerTag);
						PutField_CString(hRec,"create_user",PD_UPDATE_USER);
DEBUGLOG(("CreateCustomerGroup new group [%s] for [%s][%s]\n",csCustomerGroup,csMerchantId,csCustomerTag));
						DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","Add");	
						iRet =  (unsigned long)(DBObjPtr)(hRec);
DEBUGLOG(("CreateCustomerGroup iRet = [%d] new group [%s] for [%s][%s]\n",iRet,csCustomerGroup,csMerchantId,csCustomerTag));
						if (iRet == PD_OK) 
							PutField_CString(hContext,"customer_group",csCustomerGroup);
					}
				}
			}
			else {
DEBUGLOG(("CreateCustomerGroup Found [%s] for Merchant Id [%s][%s]\n",csCustomerGroup,csMerchantId,csCustomerTag));


				///(phase 2) customer promotion checking
				DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupPromoList","FindPromoCustomer");
				if ((unsigned long)(DBObjPtr)(csMerchantId,csCustomerTag) == FOUND) {
					iPromote = PD_TRUE;
				}

				if(!iPromote){
					PutField_CString(hContext,"customer_group",csCustomerGroup);
				}
				else{
					///(phase 2) customer promotion start
					hash_init(hRec,0);
DEBUGLOG(("CreateCustomerGroup trying to pickup a new group for [%s][%s]\n",csMerchantId,csCustomerTag));
					DBObjPtr = CreateObj(DBPtr,"DBRuleLB","GetPromoteCustomerGroup");	
					if ( (unsigned long)(DBObjPtr)(csMerchantId,
								csServiceCode,
								csCurrencyId,
								csBankCode,
								csCustomerGroup,
								hRec) ==PD_OK) {

						if(GetField_Int(hRec,"group_cnt",&iGroupCnt)){
DEBUGLOG(("CreateCustomerGroup Total [%d] group(s) support bank[%s]\n",iGroupCnt,csBankCode));
						}

						if(iGroupCnt == 0){
							iRet = INT_CUSTOMER_SEGMENT_NOT_FOUND;
							PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("CreateCustomerGroup No Group available for bank[%s]!!!!!!\n",csBankCode));
ERRLOG("BOCustomerGroup: CreateCustomerGroup No Group available for bank[%s]!!!\n",csBankCode);
						}
						else if(iGroupCnt == 1){
							if(GetField_CString(hRec,"customer_group_0",&csTmp)){
								sprintf(csToGroup,"%s",csTmp);
DEBUGLOG(("CreateCustomerGroup pick group[%s] directly\n",csToGroup));
							}
							else{
								iRet = INT_ERR;
DEBUGLOG(("CreateCustomerGroup DBTxnLb: GetCustomerGroup Failed!!!\n"));
ERRLOG("BOCustomerGroup: CreateCustomerGroup DBTxnLb: GetCustomerGroup Failed!!!\n");
							}
						}
						else{
							DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupRules","PickPromoteGroup");	
							iRet = (unsigned long)(DBObjPtr)(csMerchantId,
										csCountryId,
										csChannelCode,
										csServiceCode,
										csCurrencyId,
										csDate,
										csCustomerGroup,
										hRec,
										&csToGroup);

							if(iRet!=FOUND){
ERRLOG("BOCustomerGroup: CreateCustomerGroup Pickup Group Error\n");
DEBUGLOG(("CreateCustomerGroup Pickup Group Error\n"));
								iRet = INT_ERR;
								PutField_Int(hContext,"internal_error",iRet);
							}
							else{
								iRet=PD_OK;
DEBUGLOG(("CreateCustomerGroup Pickup Group Success [%s]\n",csToGroup));
							}

						}
					}
					else{
						iRet = INT_ERR;
DEBUGLOG(("CreateCustomerGroup DBTxnLb: GetCustomerGroup Failed!!!\n"));
ERRLOG("BOCustomerGroup: CreateCustomerGroup DBTxnLb: GetCustomerGroup Failed!!!\n");
					}
					if(iRet == PD_OK){
						hash_init(hRec,0);
						PutField_CString(hRec,"customer_group",csToGroup);
						PutField_CString(hRec,"merchant_id",csMerchantId);
						PutField_CString(hRec,"customer_tag",csCustomerTag);
						PutField_CString(hRec,"update_user",PD_UPDATE_USER);
DEBUGLOG(("CreateCustomerGroup new group [%s] for [%s][%s]\n",csToGroup,csMerchantId,csCustomerTag));
						DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","UpdateGroup");	
						iRet =  (unsigned long)(DBObjPtr)(hRec);
DEBUGLOG(("CreateCustomerGroup iRet = [%d] new group [%s] for [%s][%s]\n",iRet,csToGroup,csMerchantId,csCustomerTag));
						if (iRet == PD_OK) {
							PutField_CString(hRec,"to_customer_group",csToGroup);
							PutField_CString(hRec,"from_customer_group",csCustomerGroup);
							DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupLog","Add");	
							iRet =  (unsigned long)(DBObjPtr)(hRec);
DEBUGLOG(("CreateCustomerGroup DBCustomerGroupLog: Add [%d]\n",iRet));
						}
						if (iRet == PD_OK){
							PutField_CString(hRec,"date",csDate);
							DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupPromoList","UpdatePromteCustomer");	
							iRet =  (unsigned long)(DBObjPtr)(hRec);
DEBUGLOG(("CreateCustomerGroup DBCustomerGroupPromoList: UpdatePromteCustomer [%d]\n",iRet));
						}
						if (iRet == PD_OK)
							PutField_CString(hContext,"customer_group",csToGroup);
					}
					
				}
			}
		}
		else {
			PutField_Int(hContext,"cust_seg_enabled",PD_FALSE);
DEBUGLOG(("CreateCustomerGroup customer group not enabled for MID [%s], skip!!!\n",csMerchantId));
		}
	}
	else {
DEBUGLOG(("CreateCustomerGroup not Found, skip!!!\n"));
	}

	if(iRet==PD_SKIP_OK)
		iRet = PD_OK;

DEBUGLOG(("CreateCustomerGroup:: iRet = [%d]\n",iRet));
	FREE_ME(hRec);
	return iRet;
}




int ChangeGroup(hash_t* hTxn)
{
	int	iRet = PD_OK;
	char	*csFromCustomerGroup;
	char	*csToCustomerGroup;
	char	*csMerchantId;
	char	*csCountry;
	char	*csServiceCode;
	char	*csTxnCcy;
	char	*csCustomerTag;
	char	*csOrgChannelCode;
	char	*csOrgPostDate;
	char	*csDate;
	char	*csUser;
	double	dOrgAmt = 0.0;

DEBUGLOG(("ChangeGroup\n"));

	if (GetField_CString(hTxn,"merchant_id",&csMerchantId)) {
DEBUGLOG(("ChangeGroup Merchant Id [%s]\n",csMerchantId));
	}
	if (GetField_CString(hTxn,"txn_country",&csCountry)) {
DEBUGLOG(("ChangeGroup txn_country [%s]\n",csCountry));
	}
	if (GetField_CString(hTxn,"service_code",&csServiceCode)) {
DEBUGLOG(("ChangeGroup service_code [%s]\n",csServiceCode));
	}
	if (GetField_CString(hTxn,"txn_ccy",&csTxnCcy)) {
DEBUGLOG(("ChangeGroup txn_ccy [%s]\n",csTxnCcy));
	}
	if (GetField_CString(hTxn,"customer_tag",&csCustomerTag)) {
DEBUGLOG(("ChangeGroup Customer Tag[%s]\n",csCustomerTag));
	}
	if (GetField_CString(hTxn,"from_customer_group",&csFromCustomerGroup)) {
DEBUGLOG(("ChangeGroup from_customer_group [%s]\n",csFromCustomerGroup));
	}
	if (GetField_CString(hTxn,"to_customer_group",&csToCustomerGroup)) {
DEBUGLOG(("ChangeGroup to_customer_group [%s]\n",csToCustomerGroup));
	}
	if (GetField_CString(hTxn,"date",&csDate)) {
DEBUGLOG(("ChangeGroup date [%s]\n",csDate));
	}
	if (GetField_CString(hTxn,"update_user",&csUser)) {
DEBUGLOG(("ChangeGroup update_user [%s]\n",csUser));
	}

	DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupMerchant","FindMerchant");	
	if ((unsigned long)(DBObjPtr)(csMerchantId) == FOUND) {

		DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","MatchRecord");	
		if ((unsigned long)(DBObjPtr)(csMerchantId,csCustomerTag,csFromCustomerGroup) == FOUND) {
DEBUGLOG(("ChangeGroup [%s][%s][%s] Found!!!\n",csMerchantId,csCustomerTag,csFromCustomerGroup));
			DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","UpdateGroup");	
			PutField_CString(hTxn,"customer_group",csToCustomerGroup);
			if ((unsigned long)(DBObjPtr)(hTxn) != PD_OK) {
DEBUGLOG(("ChangeGroup UpdateGroup Failed!!!\n"));
ERRLOG("BOCustomerGroup: ChangeGroup UpdateGroup Failed!!!!!!\n");
				iRet = INT_ERR;
			}
			else {
				DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupLog","Add");	
				iRet =  (unsigned long)(DBObjPtr)(hTxn);
DEBUGLOG(("ChangeGroup DBCustomerGroupLog: Add [%d]\n",iRet));
			}
		}
		else {
			iRet = PD_SKIP_OK;
DEBUGLOG(("ChangeGroup customer group not matched, skip!!!\n"));
		}

	}
	else {
DEBUGLOG(("ChangeGroup customer group not enabled for MID [%s], skip!!!\n",csMerchantId));
	}

	hash_t  *hRec;
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
	int iTxnCnt = 0;

	if(iRet == PD_OK){
		//find record in from_group
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetCustomerHistoryTxnList");
		if ((unsigned long)(DBObjPtr)(csMerchantId,
					      csCountry,
					      csServiceCode,
					      csTxnCcy,
					      csCustomerTag,
					      csFromCustomerGroup,
					      hTxn) == PD_OK) {
			if(GetField_Int(hTxn,"txn_count",&iTxnCnt)){
DEBUGLOG(("ChangeGroup total txn record count [%d]\n",iTxnCnt));
			}
		}
	}

	if(iRet == PD_OK && iTxnCnt>0){
		recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetCustomerHistoryDetail");
		if ((unsigned long)(DBObjPtr)(hTxn,
					rRecordSet) == PD_OK) {

			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec && iRet == PD_OK){
				if(GetField_CString(hRec,"host_posting_date",&csOrgPostDate) &&
				   GetField_CString(hRec,"channel_code",&csOrgChannelCode) &&
				   GetField_Double(hRec,"txn_amt",&dOrgAmt)){
DEBUGLOG(("ChangeGroup Update Delta [%s][%lf]\n",csOrgPostDate,dOrgAmt));
					//transfer the value from from_group to to_group
					DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupCounters","ChangeGroupDelta");
					if ((unsigned long)(DBObjPtr)(
							csCountry,
							csOrgChannelCode,
							csServiceCode,
							csTxnCcy,
							csFromCustomerGroup,
							csToCustomerGroup,
							csOrgPostDate,
							dOrgAmt,
							csUser) != PD_OK){
						iRet = INT_ERR;
					}
				}

				hRec = RecordSet_GetNext(rRecordSet);
			}

			//////update txn_detail by batch
			if(iRet == PD_OK){
				PutField_CString(hTxn,"customer_group",csToCustomerGroup);
				DBObjPtr = CreateObj(DBPtr,"DBTransaction","BatchUpdateCustomerGroup");
				if ((unsigned long)(DBObjPtr)(hTxn) != PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("ChangeGroup DBTransaction:BatchUpdateCustomerGroup Failed!!!\n"));
				}
			}
		}
		else {
			iRet = PD_SKIP_OK;
DEBUGLOG(("ChangeGroup no volume, skip!!!\n"));
		}
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);


	if(iRet == PD_SKIP_OK)
		iRet = PD_OK;

DEBUGLOG(("ChangeGroup:: iRet = [%d]\n",iRet));
	return iRet;
}
