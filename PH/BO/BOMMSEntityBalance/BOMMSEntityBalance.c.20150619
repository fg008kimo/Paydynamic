/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/06/15              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOMMSEntityBalance.h"

char    cDebug;

OBJPTR(DB);


void BOMMSEntityBalance(char    cdebug)
{
        cDebug = cdebug;
}


int SelectNatureBalanceForUpdate(hash_t *hContext, const hash_t* hReq) 
{
	int	iRet = PD_OK;
	double	dTmp;
	char	*csPtr;

	hash_t	*hData,*hRsp;

DEBUGLOG(("SelectNatureBalanceForUpdate()\n"));
	hData = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hData,0);
	hRsp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRsp,0);

/* entity id */
	if (GetField_CString(hReq,"entity_id",&csPtr)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() Entity ID = [%s]\n",csPtr));
		PutField_CString(hData,"entity_id",csPtr);
	}
	else {
DEBUGLOG(("SelectNatureBalanceForUpdate() Entity ID nto found\n"));
ERRLOG("BOMMSEntityBalance::SelectNatureBalanceForUpdate() Entity ID not found\n");
		iRet = PD_ERR;
	}

/* from_ccy */
	if (iRet == PD_OK ) {
		if (GetField_CString(hReq,"from_ccy",&csPtr)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() from_ccy = [%s]\n",csPtr));
			PutField_CString(hData,"from_ccy",csPtr);
		}
		else {
DEBUGLOG(("SelectNatureBalanceForUpdate() from_ccy to found\n"));
ERRLOG("BOMMSEntityBalance::SelectNatureBalanceForUpdate() from_ccy not found\n");
			iRet = PD_ERR;
		}
	}

/* ccy */
	if (iRet == PD_OK ) {
		if (GetField_CString(hReq,"ccy",&csPtr)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() ccy = [%s]\n",csPtr));
			PutField_CString(hData,"ccy",csPtr);
		}
		else {
DEBUGLOG(("SelectNatureBalanceForUpdate() ccy to found\n"));
ERRLOG("BOMMSEntityBalance::SelectNatureBalanceForUpdate() ccy not found\n");
			iRet = PD_ERR;
		}
	}

/* nature_id */
	if (iRet == PD_OK ) {
		if (GetField_CString(hReq,"nature_id",&csPtr)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() nature_id = [%s]\n",csPtr));
			PutField_CString(hData,"nature_id",csPtr);
		}
		else {
DEBUGLOG(("SelectNatureBalanceForUpdate() nature_id to found\n"));
ERRLOG("BOMMSEntityBalance::SelectNatureBalanceForUpdate() nature_id not found\n");
			iRet = PD_ERR;
		}
	}

/* create entity nature balance if not exist */
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBMmsEntityBalance","GetNatureBalanceForUpdate");
		iRet = (unsigned long)((DBObjPtr)(hData,hContext));
	}

/* create entity balance for opening balance */
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBMmsEntityBalance","GetEntityBalanceForUpdate");
		iRet = (unsigned long)((DBObjPtr)(hData,hRsp));

		if (iRet == PD_OK) {
/*opening_acct_bal */
			if (GetField_Double(hRsp,"acct_bal",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() open_acct_bal = [%lf]\n",dTmp));
				PutField_Double(hContext,"open_acct_bal",dTmp);
			}

/*opening_prepaid */
			if (GetField_Double(hRsp,"prepaid",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() open_prepaid = [%lf]\n",dTmp));
				PutField_Double(hContext,"open_prepaid",dTmp);
			}

/*opening_intransit */
			if (GetField_Double(hRsp,"intransit",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() open_intransit = [%lf]\n",dTmp));
				PutField_Double(hContext,"open_intransit",dTmp);
			}
/*opening_lien */
			if (GetField_Double(hRsp,"lien",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() open_lien = [%lf]\n",dTmp));
				PutField_Double(hContext,"open_lien",dTmp);
			}


		}
	}

	FREE_ME(hData);
	FREE_ME(hRsp);
DEBUGLOG(("SelectNatureBalanceForUpdate:: () Noraml Exit iRet = [%d]\n",iRet));
	return iRet;
}

int CreditIntransit(hash_t* hContext, const hash_t* hReq)
{
	int	iRet = PD_OK;
	char	*csPtr;
	double	dTmp;

	hash_t	*hData,*hRsp;

DEBUGLOG(("CreditIntransit:: ()\n"));
	hData = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hData,0);
	hRsp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRsp,0);

/* entity id */
        if (GetField_CString(hReq,"entity_id",&csPtr)) {
DEBUGLOG(("CreditIntransit() Entity ID = [%s]\n",csPtr));
                PutField_CString(hData,"entity_id",csPtr);
        }
        else {
DEBUGLOG(("CreditIntransit() Entity ID nto found\n"));
ERRLOG("BOMMSEntityBalance::CreditIntransit() Entity ID not found\n");
                iRet = PD_ERR;
        }

/* from_ccy */
        if (iRet == PD_OK ) {
                if (GetField_CString(hReq,"from_ccy",&csPtr)) {
DEBUGLOG(("CreditIntransit() from_ccy = [%s]\n",csPtr));
                        PutField_CString(hData,"from_ccy",csPtr);
                }
                else {
DEBUGLOG(("CreditIntransit() from_ccy to found\n"));
ERRLOG("BOMMSEntityBalance::CreditIntransit() from_ccy not found\n");
                        iRet = PD_ERR;
                }
        }

/* ccy */
        if (iRet == PD_OK ) {
                if (GetField_CString(hReq,"ccy",&csPtr)) {
DEBUGLOG(("CreditIntransit() ccy = [%s]\n",csPtr));
                        PutField_CString(hData,"ccy",csPtr);
                }
                else {
DEBUGLOG(("CreditIntransit() ccy to found\n"));
ERRLOG("BOMMSEntityBalance::CreditIntransit() ccy not found\n");
                        iRet = PD_ERR;
                }
        }

/* nature_id */
        if (iRet == PD_OK ) {
                if (GetField_CString(hReq,"nature_id",&csPtr)) {
DEBUGLOG(("CreditIntransit() nature_id = [%s]\n",csPtr));
                        PutField_CString(hData,"nature_id",csPtr);
                }
                else {
DEBUGLOG(("CreditIntransit() nature_id to found\n"));
ERRLOG("BOMMSEntityBalance::CreditIntransit() nature_id not found\n");
                        iRet = PD_ERR;
                }
        }

        if (iRet == PD_OK ) {
		if (GetField_Double(hContext,"txn_amt",&dTmp)) {
DEBUGLOG(("CreditIntransit:: () intransit = [%lf]\n",dTmp));
			PutField_Double(hContext,"intransit",dTmp);
			PutField_Double(hData,"intransit",dTmp);
		}
                else {
DEBUGLOG(("CreditIntransit() txn_amt to found\n"));
ERRLOG("BOMMSEntityBalance::CreditIntransit() txn_amt not found\n");
                        iRet = PD_ERR;
                }
	}

/* create Nature balance if doesn't exit */
	iRet = SelectNatureBalanceForUpdate(hContext,hReq);

	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBMmsEntityBalance","Update");
		iRet = (unsigned long)((DBObjPtr)(hData));
	}

/* closing balance */
	if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBMmsEntityBalance","GetEntityBalanceForUpdate");
                iRet = (unsigned long)((DBObjPtr)(hData,hRsp));

                if (iRet == PD_OK) {
/*curr_acct_bal */
                        if (GetField_Double(hRsp,"acct_bal",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() curr_acct_bal = [%lf]\n",dTmp));
                                PutField_Double(hContext,"curr_acct_bal",dTmp);
                        }

/*curr_prepaid */
                        if (GetField_Double(hRsp,"prepaid",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() curr_prepaid = [%lf]\n",dTmp));
                                PutField_Double(hContext,"curr_prepaid",dTmp);
                        }

/*curr_intransit */
                        if (GetField_Double(hRsp,"intransit",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() curr_intransit = [%lf]\n",dTmp));
                                PutField_Double(hContext,"curr_intransit",dTmp);
                        }
/*curr_lien */
                        if (GetField_Double(hRsp,"lien",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() curr_lien = [%lf]\n",dTmp));
                                PutField_Double(hContext,"curr_lien",dTmp);
                        }


                }
        }

	FREE_ME(hData);
	FREE_ME(hRsp);
DEBUGLOG(("CreditIntransit:: () Noraml Exit iRet = [%d]\n",iRet));
	return iRet;
}
