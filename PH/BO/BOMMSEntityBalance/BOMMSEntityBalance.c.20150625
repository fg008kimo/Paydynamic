/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/06/15              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "BOMMSEntityBalance.h"

char    cDebug;

OBJPTR(DB);
OBJPTR(BO);

int UpdateEntityNatureBalance(hash_t* hContext, const hash_t* hReq);

void BOMMSEntityBalance(char    cdebug)
{
        cDebug = cdebug;
}


int SelectNatureBalanceForUpdate(hash_t *hContext, const hash_t* hReq) 
{
	int	iRet = PD_OK;
	double	dTmp;
	char	*csPtr;

	hash_t	*hData,*hRsp;

DEBUGLOG(("SelectNatureBalanceForUpdate()\n"));
	hData = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hData,0);
	hRsp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRsp,0);

/* entity id */
	if (GetField_CString(hContext,"entity_id",&csPtr)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() Entity ID = [%s]\n",csPtr));
		PutField_CString(hData,"entity_id",csPtr);
	}
	else {
DEBUGLOG(("SelectNatureBalanceForUpdate() Entity ID not found\n"));
ERRLOG("BOMMSEntityBalance::SelectNatureBalanceForUpdate() Entity ID not found\n");
		iRet = PD_ERR;
	}

/* country */
	if (GetField_CString(hReq,"country",&csPtr)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() country = [%s]\n",csPtr));
		PutField_CString(hData,"country",csPtr);
	}
	else {
DEBUGLOG(("SelectNatureBalanceForUpdate() country not found\n"));
ERRLOG("BOMMSEntityBalance::SelectNatureBalanceForUpdate() country ID not found\n");
		iRet = PD_ERR;
	}

/* from_ccy */
	if (iRet == PD_OK ) {
		if (GetField_CString(hReq,"from_ccy",&csPtr)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() from_ccy = [%s]\n",csPtr));
			PutField_CString(hData,"from_ccy",csPtr);
		}
		else {
DEBUGLOG(("SelectNatureBalanceForUpdate() from_ccy to found\n"));
ERRLOG("BOMMSEntityBalance::SelectNatureBalanceForUpdate() from_ccy not found\n");
			iRet = PD_ERR;
		}
	}

/* ccy */
	if (iRet == PD_OK ) {
		if (GetField_CString(hReq,"ccy",&csPtr)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() ccy = [%s]\n",csPtr));
			PutField_CString(hData,"ccy",csPtr);
		}
		else {
DEBUGLOG(("SelectNatureBalanceForUpdate() ccy to found\n"));
ERRLOG("BOMMSEntityBalance::SelectNatureBalanceForUpdate() ccy not found\n");
			iRet = PD_ERR;
		}
	}

/* create entity balance for opening balance */
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBMmsEntityBalance","GetEntityBalanceForUpdate");
		iRet = (unsigned long)((DBObjPtr)(hData,hRsp));

		if (iRet == PD_OK) {
/*opening_acct_bal */
			if (GetField_Double(hRsp,"acct_bal",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() open_acct_bal = [%lf]\n",dTmp));
				PutField_Double(hContext,"open_acct_bal",dTmp);
			}

/*opening_prepaid */
			if (GetField_Double(hRsp,"prepaid",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() open_prepaid = [%lf]\n",dTmp));
				PutField_Double(hContext,"open_prepaid",dTmp);
			}

/*opening_intransit */
			if (GetField_Double(hRsp,"intransit",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() open_intransit = [%lf]\n",dTmp));
				PutField_Double(hContext,"open_intransit",dTmp);
			}
/*opening_lien */
			if (GetField_Double(hRsp,"lien",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() open_lien = [%lf]\n",dTmp));
				PutField_Double(hContext,"open_lien",dTmp);
			}


		}
	}

	FREE_ME(hData);
	FREE_ME(hRsp);
DEBUGLOG(("SelectNatureBalanceForUpdate:: () Noraml Exit iRet = [%d]\n",iRet));
	return iRet;
}

/* intransit */
int CreditIntransit(hash_t* hContext, const hash_t* hReq)
{
	int	iRet = PD_OK;
DEBUGLOG(("CreditIntransit:: ()\n"));
	PutField_CString(hContext,"amt_type",PD_CR);
	PutField_CString(hContext,"bal_amt","intransit");

	iRet = UpdateEntityNatureBalance(hContext,hReq);

	RemoveField_CString(hContext,"amt_type");
	RemoveField_CString(hContext,"bal_amt");

DEBUGLOG(("CreditIntransit:: return iRet = [%d]\n",iRet));
	return	iRet;
}

int DebitIntransit(hash_t* hContext, const hash_t* hReq)
{
	int	iRet = PD_OK;
DEBUGLOG(("DebitIntransit:: ()\n"));
	PutField_CString(hContext,"amt_type",PD_DR);
	PutField_CString(hContext,"bal_amt","intransit");

	iRet = UpdateEntityNatureBalance(hContext,hReq);
	RemoveField_CString(hContext,"amt_type");
	RemoveField_CString(hContext,"bal_amt");

DEBUGLOG(("DebitIntransit:: return iRet = [%d]\n",iRet));
	return	iRet;
}

/* intransit end */

int CreditAcctBal(hash_t* hContext, const hash_t* hReq)
{
        int     iRet = PD_OK;
DEBUGLOG(("CreditAcctBal:: ()\n"));
        PutField_CString(hContext,"amt_type",PD_CR);
        PutField_CString(hContext,"bal_amt","intransit");

        iRet = UpdateEntityNatureBalance(hContext,hReq);

        RemoveField_CString(hContext,"amt_type");
        RemoveField_CString(hContext,"bal_amt");

DEBUGLOG(("CreditAcctBal:: return iRet = [%d]\n",iRet));
        return  iRet;
}

int DebitAcctBal(hash_t* hContext, const hash_t* hReq)
{
        int     iRet = PD_OK;
DEBUGLOG(("DebitAcctBal:: ()\n"));
        PutField_CString(hContext,"amt_type",PD_DR);
        PutField_CString(hContext,"bal_amt","acct_bal");

        iRet = UpdateEntityNatureBalance(hContext,hReq);
        RemoveField_CString(hContext,"amt_type");
        RemoveField_CString(hContext,"bal_amt");

DEBUGLOG(("DebitAcctBal:: return iRet = [%d]\n",iRet));
        return  iRet;
}

/*** lien ****/

int CreditLien(hash_t* hContext, const hash_t* hReq)
{
        int     iRet = PD_OK;
DEBUGLOG(("CreditLien:: ()\n"));
	double	dOpenAcctBal = 0.0;
	double	dOpenPrepaid = 0.0;
	double	dOpenLien = 0.0;
	double	dOpenIntransit = 0.0;

/* debit acct_bal */
        PutField_CString(hContext,"amt_type",PD_DR);
        PutField_CString(hContext,"bal_amt","acct_bal");

        iRet = UpdateEntityNatureBalance(hContext,hReq);

        RemoveField_CString(hContext,"amt_type");
        RemoveField_CString(hContext,"bal_amt");
/* debit acct_bal End */

/* credit lien */
	if (iRet == PD_OK) {
/* temp store opening bal */
		GetField_Double(hContext,"open_acct_bal",&dOpenAcctBal);
DEBUGLOG(("CreditLien open_acct_bal = [%lf]\n",dOpenAcctBal));

		GetField_Double(hContext,"open_perpaid",&dOpenPrepaid);
DEBUGLOG(("CreditLien open_perpaid = [%lf]\n",dOpenPrepaid));

		GetField_Double(hContext,"open_lien",&dOpenLien);
DEBUGLOG(("CreditLien open_lien = [%lf]\n",dOpenLien));

		GetField_Double(hContext,"open_intransit",&dOpenIntransit);
DEBUGLOG(("CreditLien open_intransit = [%lf]\n",dOpenIntransit));

        	PutField_CString(hContext,"amt_type",PD_CR);
        	PutField_CString(hContext,"bal_amt","lien");

        	iRet = UpdateEntityNatureBalance(hContext,hReq);

        	RemoveField_CString(hContext,"amt_type");
        	RemoveField_CString(hContext,"bal_amt");

		if (iRet == PD_OK) {
/* restore opening bal */
			PutField_Double(hContext,"open_acct_bal",dOpenAcctBal);
			PutField_Double(hContext,"open_prepaid",dOpenPrepaid);
			PutField_Double(hContext,"open_lien",dOpenLien);
			PutField_Double(hContext,"open_intransit",dOpenIntransit);
		}
	}
/* credit lien End */

DEBUGLOG(("CreditLien:: return iRet = [%d]\n",iRet));
        return  iRet;
}


int DebitLien(hash_t* hContext, const hash_t* hReq)
{
        int     iRet = PD_OK;
DEBUGLOG(("DebitLien:: ()\n"));
        double  dOpenAcctBal = 0.0;
        double  dOpenPrepaid = 0.0;
        double  dOpenLien = 0.0;
        double  dOpenIntransit = 0.0;

/* debit lien */
        PutField_CString(hContext,"amt_type",PD_DR);
        PutField_CString(hContext,"bal_amt","lien");

        iRet = UpdateEntityNatureBalance(hContext,hReq);

        RemoveField_CString(hContext,"amt_type");
        RemoveField_CString(hContext,"bal_amt");
/* debit lien End */

/* credit acct_bal */
        if (iRet == PD_OK) {
/* temp store opening bal */
                GetField_Double(hContext,"open_acct_bal",&dOpenAcctBal);
DEBUGLOG(("DebitLien open_acct_bal = [%lf]\n",dOpenAcctBal));

                GetField_Double(hContext,"open_perpaid",&dOpenPrepaid);
DEBUGLOG(("DebitLien open_perpaid = [%lf]\n",dOpenPrepaid));

                GetField_Double(hContext,"open_lien",&dOpenLien);
DEBUGLOG(("DebitLien open_lien = [%lf]\n",dOpenLien));

                GetField_Double(hContext,"open_intransit",&dOpenIntransit);
DEBUGLOG(("DebitLien open_intransit = [%lf]\n",dOpenIntransit));

                PutField_CString(hContext,"amt_type",PD_CR);
                PutField_CString(hContext,"bal_amt","acct_bal");

                iRet = UpdateEntityNatureBalance(hContext,hReq);

                RemoveField_CString(hContext,"amt_type");
                RemoveField_CString(hContext,"bal_amt");

                if (iRet == PD_OK) {
/* restore opening bal */
                        PutField_Double(hContext,"open_acct_bal",dOpenAcctBal);
                        PutField_Double(hContext,"open_prepaid",dOpenPrepaid);
                        PutField_Double(hContext,"open_lien",dOpenLien);
                        PutField_Double(hContext,"open_intransit",dOpenIntransit);
                }
        }
/* credit acct_bal End */

DEBUGLOG(("DebitLien:: return iRet = [%d]\n",iRet));
        return  iRet;
}

/*** Lien ***/


int UpdateEntityNatureBalance(hash_t* hContext, const hash_t* hReq)
{
	int	iRet = PD_OK;
	char	*csPtr;
	char	*csBalAmt;
	char	*csAmtType;
	char	*csFromCcy;
	char	*csTxnCcy;
	char	*csEntityId;
	char	*csTxnCountry;
	char	csTag[PD_TAG_LEN + 1];
	double	dTxnAmt,dNatureTxnAmt;
	double	dTmp;
	int 	i,iBalCnt = 0;

	hash_t	*hData,*hRsp;

DEBUGLOG(("UpdateEntityNatureBalance:: ()\n"));
	hData = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hData,0);
	hRsp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRsp,0);

/* entity id */
        if (GetField_CString(hContext,"entity_id",&csEntityId)) {
DEBUGLOG(("UpdateEntityNatureBalance() Entity ID = [%s]\n",csEntityId));
      	}
       	else {
DEBUGLOG(("UpdateEntityNatureBalance() Entity ID nto found\n"));
ERRLOG("BOMMSEntityBalance::UpdateEntityNatureBalance() Entity ID not found\n");
       		iRet = PD_ERR;
       	}

/* txn_country */
       	if (GetField_CString(hReq,"country",&csTxnCountry)) {
DEBUGLOG(("UpdateEntityNatureBalance() txn_country = [%s]\n",csTxnCountry));
               	PutField_CString(hData,"country",csTxnCountry);
       	}
       	else {
DEBUGLOG(("UpdateEntityNatureBalance() txn_country not found\n"));
ERRLOG("BOMMSEntityBalance::UpdateEntityNatureBalance() txn_country not found\n");
               	iRet = PD_ERR;
       	}

/* from_ccy */
       	if (iRet == PD_OK ) {
               	if (GetField_CString(hReq,"from_ccy",&csFromCcy)) {
DEBUGLOG(("UpdateEntityNatureBalance() from_ccy = [%s]\n",csFromCcy));
                       	PutField_CString(hData,"from_ccy",csFromCcy);
               	}
               	else {
DEBUGLOG(("UpdateEntityNatureBalance() from_ccy to found\n"));
ERRLOG("BOMMSEntityBalance::UpdateEntityNatureBalance() from_ccy not found\n");
                       	iRet = PD_ERR;
               	}
       	}

/* ccy */
       	if (iRet == PD_OK ) {
               	if (GetField_CString(hReq,"ccy",&csTxnCcy)) {
DEBUGLOG(("UpdateEntityNatureBalance() ccy = [%s]\n",csTxnCcy));
                       	PutField_CString(hData,"ccy",csTxnCcy);
               	}
               	else {
DEBUGLOG(("UpdateEntityNatureBalance() ccy to found\n"));
ERRLOG("BOMMSEntityBalance::UpdateEntityNatureBalance() ccy not found\n");
                       	iRet = PD_ERR;
               	}
       	}

/* bal_cnt */
	if (GetField_Int(hContext,"bal_cnt",&iBalCnt)){
DEBUGLOG(("UpdateEntityNatureBalance() bal_cnt = [%d]\n",iBalCnt));
	}

	if (iRet == PD_OK) {
		PutField_CString(hData,"entity_id",csEntityId);
           	PutField_CString(hData,"country",csTxnCountry);
                PutField_CString(hData,"from_ccy",csFromCcy);
                PutField_CString(hData,"ccy",csTxnCcy);
	 	DBObjPtr = CreateObj(DBPtr,"DBMmsEntityBalance","GetEntityBalanceForUpdate");
                iRet = (unsigned long)((DBObjPtr)(hData,hRsp));

                if (iRet == PD_OK) {
/*curr_acct_bal */
                        if (GetField_Double(hRsp,"acct_bal",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() open_acct_bal = [%lf]\n",dTmp));
                                PutField_Double(hContext,"open_acct_bal",dTmp);
                        }

/*curr_prepaid */
                        if (GetField_Double(hRsp,"prepaid",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() open_prepaid = [%lf]\n",dTmp));
                                PutField_Double(hContext,"open_prepaid",dTmp);
                        }

/*curr_intransit */
                        if (GetField_Double(hRsp,"intransit",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() open_intransit = [%lf]\n",dTmp));
                                PutField_Double(hContext,"open_intransit",dTmp);
                        }
/*curr_lien */
                        if (GetField_Double(hRsp,"lien",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() open_lien = [%lf]\n",dTmp));
                                PutField_Double(hContext,"open_lien",dTmp);
                        }
                }
		else {
			iRet = INT_MMS_NATURE_BAL_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("SelectNatureBalanceForUpdate() Nature Bal not found\n"));
ERRLOG("BOMMSEntityBalance:SelectNatureBalanceForUpdate() Nature Bal not found\n");
		}
	}
	if  (iRet == PD_OK) {
		for (i = 0 ; i < iBalCnt; i++) {
			hash_init(hData,0);

			PutField_CString(hData,"entity_id",csEntityId);
               		PutField_CString(hData,"country",csTxnCountry);
                	PutField_CString(hData,"from_ccy",csFromCcy);
                	PutField_CString(hData,"ccy",csTxnCcy);
/* for nature detail log */
			sprintf(csTag,"bal.%d.nature_txn_ccy",i+1);
                	PutField_CString(hContext,csTag,csTxnCcy);

			sprintf(csTag,"bal.%d.nature_net_ccy",i+1);
                	PutField_CString(hContext,csTag,csTxnCcy);



			sprintf(csTag,"bal.%d.nature_id",i+1);
/* nature_id */
                	if (GetField_CString(hContext,csTag,&csPtr)) {
DEBUGLOG(("UpdateEntityNatureBalance() [%s] = [%s]\n",csTag,csPtr));
                       		PutField_CString(hData,"nature_id",csPtr);
                	}
                	else {
DEBUGLOG(("UpdateEntityNatureBalance() %s to found\n",csTag));
ERRLOG("BOMMSEntityBalance::UpdateEntityNatureBalance() %s not found\n",csTag);
                       		iRet = PD_ERR;
                	}

        			if (iRet == PD_OK ) {
					sprintf(csTag,"bal.%d.amt",i+1);
					if (GetField_Double(hContext,csTag,&dNatureTxnAmt)) {
DEBUGLOG(("UpdateEntityNatureBalance:: () %s = [%lf]\n",csTag,dNatureTxnAmt));
/* for nature detail log */
						sprintf(csTag,"bal.%d.net_amt",i+1);
                				PutField_Double(hContext,csTag,dNatureTxnAmt);

						GetField_CString(hContext,"amt_type",&csAmtType);
						GetField_CString(hContext,"bal_amt",&csBalAmt);
DEBUGLOG(("UpdateEntityNatureBalance:: () amt type = [%s] bal_amt = [%s]\n",csAmtType,csBalAmt));
						if (!strcmp(csAmtType,PD_CR))
							PutField_Double(hData,csBalAmt,dNatureTxnAmt);
						else if (!strcmp(csAmtType,PD_DR))
							PutField_Double(hData,csBalAmt,dNatureTxnAmt *(-1));
						else {
DEBUGLOG(("UpdateEntityNatureBalance() invalid amt type [%s]\n",csPtr));
ERRLOG("BOMMSEntityBalance::UpdateEntityNatureBalance() invalid amt type [%s]\n",csPtr);
							iRet = PD_ERR;
						}
					}
                			else {
DEBUGLOG(("UpdateEntityNatureBalance() [%s] to found\n",csTag));
ERRLOG("BOMMSEntityBalance::UpdateEntityNatureBalance() %s not found\n",csTag);
                        			iRet = PD_ERR;
                			}
				}

/* create Nature balance if doesn't exit */




				if (iRet == PD_OK) {
					DBObjPtr = CreateObj(DBPtr,"DBMmsEntityBalance","Update");
					iRet = (unsigned long)((DBObjPtr)(hData));
DEBUGLOG(("BOMMSEntityBalance:UpdateEntityNatureBalance iRet = [%d] from MmsEntityBalance:Update\n",iRet));
				}

		}
	}

/* update txn element for intransit */
	if (iRet == PD_OK) {
		if (!strcmp(csBalAmt,"intransit") ||
		    !strcmp(csBalAmt,"lien")	||
		    !strcmp(csBalAmt,"acct_bal")	
		   ) {
			if(GetField_CString(hContext,"txn_seq",&csPtr)){
                       		PutField_CString(hData,"txn_seq",csPtr);
                	}
/* element type */
	/* intransit */
			if (!strcmp(csBalAmt,"intransit")) {
				PutField_CString(hData,"txn_element_type",PD_ELEMENT_IN_TRANSIT);
			}
	/* lien */
			else if (!strcmp(csBalAmt,"lien")) {
				PutField_CString(hData,"txn_element_type",PD_ELEMENT_HOLD_AMT);
			}
	/* acct_bal */
			else if (!strcmp(csBalAmt,"acct_bal")) {
				PutField_CString(hData,"txn_element_type",PD_ELEMENT_TXN_AMT);
			}
/* ccy */
			PutField_CString(hData,"ccy",csTxnCcy);

			if (GetField_Double(hContext,"txn_amt",&dTxnAmt)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() txn_amt = [%lf]\n",dTxnAmt));
			}
			if (!strcmp(csAmtType,PD_CR)) {
				PutField_Double(hData,"amount",dTxnAmt);
			}
			else
				PutField_Double(hData,"amount",dTxnAmt * (-1));

			BOObjPtr = CreateObj(BOPtr,"BOMMSTxnElement","AddTxnElement");
                	iRet = (unsigned long)((BOObjPtr)(hData));
		}
	}

/* closing balance */
	if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBMmsEntityBalance","GetEntityBalanceForUpdate");
                iRet = (unsigned long)((DBObjPtr)(hData,hRsp));

                if (iRet == PD_OK) {
/*curr_acct_bal */
                        if (GetField_Double(hRsp,"acct_bal",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() curr_acct_bal = [%lf]\n",dTmp));
                                PutField_Double(hContext,"curr_acct_bal",dTmp);
                        }

/*curr_prepaid */
                        if (GetField_Double(hRsp,"prepaid",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() curr_prepaid = [%lf]\n",dTmp));
                                PutField_Double(hContext,"curr_prepaid",dTmp);
                        }

/*curr_intransit */
                        if (GetField_Double(hRsp,"intransit",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() curr_intransit = [%lf]\n",dTmp));
                                PutField_Double(hContext,"curr_intransit",dTmp);
                        }
/*curr_lien */
                        if (GetField_Double(hRsp,"lien",&dTmp)) {
DEBUGLOG(("SelectNatureBalanceForUpdate() curr_lien = [%lf]\n",dTmp));
                                PutField_Double(hContext,"curr_lien",dTmp);
                        }


                }
        }


	FREE_ME(hData);
	FREE_ME(hRsp);
DEBUGLOG(("UpdateEntityNatureBalance:: () Noraml Exit iRet = [%d]\n",iRet));
	return iRet;
}

