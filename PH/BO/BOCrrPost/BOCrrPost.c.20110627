/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/06/23              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOCrrPost.h"

#define	MAX_CNT	10
char    cDebug;
OBJPTR(DB);
OBJPTR(BO);

int doPost(recordset_t* rCcy,hash_t* hRec, const hash_t* hRule) ;
int doPostHD(recordset_t* rCcy,hash_t* hReq);
int doPostDetail(recordset_t* rCcy,hash_t* hReq);
void BOCrrPost(char    cdebug)
{
        cDebug = cdebug;
}

int  PostPHTxn(recordset_t* myRec)
{
	hash_t	*hRec, *hReq;
	int	iRet = PD_OK;
	double	dAmt;
	char	*csPtr;
	char	cPtr;


	char*	strs[MAX_CNT];
	strs[0]  = strdup(PD_TYPE_PSP_FEE);
	strs[1]  = strdup(PD_TYPE_TXN_AMT);
	strs[2]  = strdup(PD_TYPE_NET_AMT);
	strs[3]  = strdup(PD_TYPE_RES_AMT);
	strs[4]  = strdup(PD_TYPE_M_MARKUP);
	strs[5]  = strdup(PD_TYPE_C_MARKUP);
	strs[6]  = strdup(PD_TYPE_M_FEE);
	strs[7]  = strdup(PD_TYPE_C_FEE);
	strs[8]  = strdup(PD_TYPE_M_XU);
	strs[9]  = strdup(PD_TYPE_C_XU);
	
	int i = 0;

	recordset_t  *rCcy;
        rCcy = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rCcy,0);
DEBUGLOG(("BOCrrPosting:PostPHTxn()\n"));

	
	DBObjPtr = CreateObj(DBPtr,"DBCrrBaseCurrency","GetAllCcy");
	(unsigned long)((*DBObjPtr)(rCcy));

	for (i = 0; i < MAX_CNT; i++) {
		int j=0;
		hRec = RecordSet_GetFirst(myRec);
		while (hRec && iRet == PD_OK) {
			hReq = (hash_t*) malloc (sizeof(hash_t));
			hash_init(hReq,0);
/* txn_type */
			if (GetField_CString(hRec,"txn_type",&csPtr)) {
//DEBUGLOG(("BOCrrPosting:PostPHTxn() txn_type = [%s]\n",csPtr));
				PutField_CString(hReq,"txn_type",csPtr);
			}
			else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() txn_type is missing!!!\n"));
				iRet = PD_ERR;
			}
			if (!strcmp(csPtr,strs[i])) {
DEBUGLOG(("<<<%d>>>BOCrrPosting:PostPHTxn() [%s][%s]\n",i,csPtr,strs[i]));
/* txn code */
				if (GetField_CString(hRec,"txn_code",&csPtr)) {
//DEBUGLOG(("BOCrrPosting:PostPHTxn() txn_code = [%s]\n",csPtr));
					PutField_CString(hReq,"txn_code",csPtr);
				}
				else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() txn_code is missing!!!\n"));
					iRet = PD_ERR;
				}

/* txn country */
				if (GetField_CString(hRec,"txn_country",&csPtr)) {
//DEBUGLOG(("BOCrrPosting:PostPHTxn() txn_country = [%s]\n",csPtr));
					PutField_CString(hReq,"txn_country",csPtr);
				}
				else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() txn_country is missing!!!\n"));
					iRet = PD_ERR;
				}

/* product */
				if (GetField_CString(hRec,"product",&csPtr)) {
//DEBUGLOG(("BOCrrPosting:PostPHTxn() product = [%s]\n",csPtr));
					PutField_CString(hReq,"product",csPtr);
				}
				else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() product is missing!!!\n"));
					iRet = PD_ERR;
				}

/* ccy */
				if (GetField_CString(hRec,"ccy",&csPtr)) {
//DEBUGLOG(("BOCrrPosting:PostPHTxn() ccy = [%s]\n",csPtr));
					PutField_CString(hReq,"ccy",csPtr);
				}
				else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() ccy is missing!!!\n"));
					iRet = PD_ERR;
				}


/* party_id */
				if (GetField_CString(hRec,"id",&csPtr)) {
//DEBUGLOG(("BOCrrPosting:PostPHTxn() party_id = [%s]\n",csPtr));
					PutField_CString(hReq,"id",csPtr);
				}
				else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() party_id is missing!!!\n"));
					iRet = PD_ERR;
				}

/* type */
				if (GetField_Char(hRec,"type",&cPtr)) {
//DEBUGLOG(("BOCrrPosting:PostPHTxn() type = [%c]\n",cPtr));
					PutField_Char(hReq,"type",cPtr);
				}
				else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() type is missing!!!\n"));
					iRet = PD_ERR;
				}

/* amount */
				if (GetField_Double(hRec,"amount",&dAmt)) {
//DEBUGLOG(("BOCrrPosting:PostPHTxn() amount = [%lf]\n",dAmt));
					PutField_Double(hReq,"amount",dAmt);
				}
				else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() type is missing!!!\n"));
					iRet = PD_ERR;
				}

/* host_posting_date */
				if (GetField_CString(hRec,"host_posting_date",&csPtr)) {
//DEBUGLOG(("BOCrrPosting:PostPHTxn() host_posting_date = [%s]\n",csPtr));
					PutField_CString(hReq,"host_posting_date",csPtr);
				}
				else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() host_posting_date  is missing!!!\n"));
				}


				if (iRet == PD_OK) {

					hash_t	*hRule;
					hRule = (hash_t*) malloc (sizeof(hash_t));
					hash_init(hRule,0);
					DBObjPtr = CreateObj(DBPtr,"DBCrrRulePosting","GetRule");
					iRet = (unsigned long)((*DBObjPtr)(hReq,hRule));
					if (iRet == PD_NOT_FOUND) {	
						iRet = PD_OK;
//DEBUGLOG(("BOCrrPosting:PostPHTxn() Rule Not found SKIP!!!!!!!!!!!!!!!!!!!\n"));
					}
					else {	
						j++;
						if (j == 1) {
DEBUGLOG(("BOCrrPosting:PostPHTxn() Rule  do post HEAD*************************\n"));
						}
						else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() Rule  do post Detail========================\n"));
						}
			
						iRet = PD_OK;
//						iRet = (doPost(rCcy,hReq,hRule));
					}

					hash_destroy(hRule);
       					FREE_ME(hRule);
				}
			} /* if same type */
			hash_destroy(hReq);
			FREE_ME(hReq);

			hRec = RecordSet_GetNext(myRec);
		}
	}

	
	RecordSet_Destroy(rCcy);
DEBUGLOG(("BOCrrPosting:PostPHTxn() iRet = [%d]\n",iRet));
	return iRet;
}


int doPost(recordset_t* rCcy,hash_t* hRec, const hash_t* hRule) 
{
	int	iRet = PD_OK;
	int	iJnlTypeId;
	int	iCrGlId;
	int	iDrGlId;
	int	iLineNo;
	int	iManualApproval;
	char	*csDesc;
	char	*csTxnSeq;
	char	*csPtr;
	char	*csCcy;
	char	csDateTime[PD_DATETIME_LEN +1];
	char	csDate[PD_DATE_LEN +1];
	char	csTime[PD_TIME_LEN +1];
	char	csYear[PD_YYYY_LEN +1];
	char	csMonth[PD_MM_LEN +1];
	double	dAmt;

	hash_t	*hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

	hash_t	*hJnl;
	hJnl = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hJnl,0);
	
	if (!GetField_Int(hRule,"jnl_type_id",&iJnlTypeId)) {
		iJnlTypeId = 0;
	}
DEBUGLOG(("BOCrrPost::doPost jnl_type_id = [%d]\n",iJnlTypeId));

	if (!GetField_Int(hRule,"credit_gl_id",&iCrGlId)) {
		iCrGlId = 0;
	}
DEBUGLOG(("BOCrrPost::doPost credit_gl_id = [%d]\n",iCrGlId));

	if (!GetField_Int(hRule,"debit_gl_id",&iDrGlId)) {
		iDrGlId = 0;
	}
DEBUGLOG(("BOCrrPost::doPost debit_gl_id = [%d]\n",iDrGlId));

	if (!GetField_Int(hRule,"manual_approval",&iManualApproval)) {
		iManualApproval = 0;
	}
DEBUGLOG(("BOCrrPost::doPost manual_approval = [%d]\n",iManualApproval));

	if (!GetField_CString(hRule,"desc",&csDesc)) {
		csDesc =  NULL;
	}
DEBUGLOG(("BOCrrPost::doPost desc = [%s]\n",csDesc));




/* Txn Header */
	/*db_commit */
        PutField_Int(hTxn,"db_commit",PD_FALSE);

/* ar_id */
        PutField_Char(hTxn,"ar_ind",PD_ACCEPT);
/* status */
        PutField_Char(hTxn,"status",PD_COMPLETE);

/* txn code */
/* if no txn seq */
	if (GetField_CString(hRec,"txn_code",&csPtr))
        	PutField_CString(hTxn,"txn_code",csPtr);
	else
        	PutField_CString(hTxn,"txn_code",PD_BATCH_JL_POST_TXN_CODE);

/* channel code*/
        PutField_CString(hTxn,"channel_code",PD_CHANNEL_BATCH);

/* service code */
        PutField_CString(hTxn,"service_code",PD_DEFAULT_SERVICE);


/* approval date */
/* host posting date */
	if (GetField_CString(hRec,"host_posting_date",&csPtr)) {
        	PutField_CString(hTxn,"host_posting_date",csPtr);
        	PutField_CString(hTxn,"approval_date",csPtr);
	}
/* internal code */
       	PutField_Int(hTxn,"internal_code",PD_OK);

/* local tm date */
	strcpy(csDateTime,getdatetime());
        memcpy(csDate,csDateTime,PD_DATE_LEN);
        csDate[PD_DATE_LEN] = '\0';
       	PutField_CString(hTxn,"local_tm_date",csDate);

        memcpy(csYear,csDateTime,PD_YYYY_LEN);
        csYear[PD_YYYY_LEN] = '\0';

        memcpy(csMonth,&csDateTime[PD_YYYY_LEN],PD_MM_LEN);
        csMonth[PD_MM_LEN] = '\0';

/* local tm time */
	memcpy(csTime,&csDateTime[PD_DATE_LEN],PD_TIME_LEN);
        csTime[PD_TIME_LEN] = '\0';
       	PutField_CString(hTxn,"local_tm_time",csTime);

/* process code */
       	PutField_CString(hTxn,"process_code",PD_PROCESS_CODE_DEF);
/* process type */
       	PutField_CString(hTxn,"process_type",PD_PROCESS_TYPE_DEF);

/* if no txn seq */
	if (!GetField_CString(hRec,"txn_seq",&csTxnSeq)) {
		DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextTxnSeq");
		csTxnSeq  = strdup((*DBObjPtr)());
	}
/* txn seq */
	PutField_CString(hTxn,"txn_seq",csTxnSeq);
	PutField_CString(hJnl,"jnl_id",csTxnSeq);

/* jnl type id */
	PutField_Int(hJnl,"jnl_type_id",iJnlTypeId);

/* description */
	PutField_CString(hJnl,"description",csDesc);

/* txn date */
	PutField_CString(hJnl,"txn_date",csDate);

/* country */
	if (GetField_CString(hRec,"txn_country",&csPtr)) {
		PutField_CString(hJnl,"country_code",csPtr);
	}

/* product */
	if (GetField_CString(hRec,"product",&csPtr)) {
DEBUGLOG(("doPost: product code = [%s]\n",csPtr));
		PutField_CString(hJnl,"product_code",csPtr);
	}
/* ccy */
	if (!GetField_CString(hRec,"ccy",&csCcy)) {
		csCcy = NULL  ;
	}
DEBUGLOG(("BOCrrPost::doPost ccy = [%s]\n",csCcy));

/* acc year */
	PutField_CString(hJnl,"acc_year",csYear);
/* acc month */
	PutField_CString(hJnl,"acc_month",csMonth);

/* create_user */
	PutField_CString(hJnl,"create_user",PD_UPDATE_USER);
/* disabled */
	PutField_Int(hJnl,"didabled",PD_FALSE);


	if (!iManualApproval)
		PutField_Char(hJnl,"status",PD_JNL_APPROVED);
	else 
		PutField_Char(hJnl,"status",PD_JNL_PENDING);

	DBObjPtr = CreateObj(DBPtr,"DBTransaction","Add");
        iRet = (unsigned long)(*DBObjPtr)(hTxn);

	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBCrrJnlHeader","Add");
        	iRet = (unsigned long)(*DBObjPtr)(hJnl);
	}

/* txn amt */
	if (!GetField_Double(hRec,"amount",&dAmt)) {
		dAmt = 0.0;
	}
DEBUGLOG(("BOCrrPost::doPost amount = [%lf]\n",dAmt));
	PutField_Double(hJnl,"txn_amt",dAmt);
/* currency id */
	PutField_CString(hJnl,"currency_id",csCcy);

	if (iRet == PD_OK && iCrGlId != 0 ) {
/*cr ind */
		PutField_Char(hJnl,"cr_ind",PD_IND_CREDIT);
/* gl id */
		PutField_Int(hJnl,"gl_id",iCrGlId);
		DBObjPtr = CreateObj(DBPtr,"DBCrrJnlDetail","GetNextLineNo");
        	iLineNo = (unsigned long)(*DBObjPtr)(csTxnSeq);

		PutField_Int(hJnl,"line_no",iLineNo);
		DBObjPtr = CreateObj(DBPtr,"DBCrrJnlDetail","Add");
        	iRet = (unsigned long)(*DBObjPtr)(hJnl);
		if (iRet == PD_OK) {
			iRet = doPostDetail(rCcy,hJnl);
		}
	}

	if (iRet == PD_OK && iDrGlId != 0 ) {
/*cr ind */
		PutField_Char(hJnl,"cr_ind",PD_IND_DEBIT);
/* gl id */
		PutField_Int(hJnl,"gl_id",iDrGlId);
		DBObjPtr = CreateObj(DBPtr,"DBCrrJnlDetail","GetNextLineNo");
        	iLineNo = (unsigned long)(*DBObjPtr)(csTxnSeq);
		PutField_Int(hJnl,"line_no",iLineNo);

		DBObjPtr = CreateObj(DBPtr,"DBCrrJnlDetail","Add");
        	iRet = (unsigned long)(*DBObjPtr)(hJnl);
		if (iRet == PD_OK) {
			iRet = doPostDetail(rCcy,hJnl);
		}
	}
	
	hash_destroy(hTxn);
       	FREE_ME(hTxn);

	hash_destroy(hJnl);
       	FREE_ME(hJnl);
	return iRet;
}

int doPostDetail(recordset_t* rCcy,hash_t* hReq)
{
	int	iRet = PD_OK;
	char	*csPtr;
	char	*csTxnCcy;
	char	*csTxnSeq;
	double	dAmt;
	double	dExRate;
	double	dExAmt;
	int	iLineNo;
	hash_t	*hRec;

	if (GetField_CString(hReq,"currency_id",&csTxnCcy)) {
DEBUGLOG(("doPostDetail:currency_id = [%s]\n",csTxnCcy));
	}
	if (GetField_Double(hReq,"txn_amt",&dAmt)) {
DEBUGLOG(("doPostDetail:amount = [%lf]\n",dAmt));
	}
	if (GetField_CString(hReq,"jnl_id",&csTxnSeq)) {
DEBUGLOG(("doPostDetail:txn_seq = [%s]\n",csTxnSeq));
	}	
	if (GetField_Int(hReq,"line_no",&iLineNo)) {
DEBUGLOG(("doPostDetail:line_no = [%d]\n",iLineNo));
	}	

	hRec = RecordSet_GetFirst(rCcy);

	while (hRec) {
		if (GetField_CString(hRec,"ccy",&csPtr)) {
			if (strcmp(csPtr,csTxnCcy)) {
				BOObjPtr = CreateObj(DBPtr,"BOExchange","GetExternalExchangeRate");
				dExRate = 0.0;
				dExAmt = 0.0;
                        	if ((*BOObjPtr)(csTxnCcy,csPtr,dAmt,&dExRate,&dExAmt) == PD_OK) {
DEBUGLOG(("doPostDetail: ex rate = [%lf] ex amt = [%lf]\n",dExRate,dExAmt));
					DBObjPtr = CreateObj(DBPtr,"DBCrrJnlDetailAmt","Add");
        				iRet = (unsigned long)(*DBObjPtr)(csTxnSeq,
									iLineNo,
									csPtr,
									dExRate,
									dExAmt,
									PD_FALSE,
									PD_UPDATE_USER);
				}
			}
		}
		hRec = RecordSet_GetNext(rCcy);
	}

	return iRet;
}
int doPostHD(recordset_t* rCcy,hash_t* hReq)
{
	int	iRet = PD_OK;
	int	iJnlTypeId;
	int	iCrGlId;
	int	iDrGlId;
	int	iLineNo;
	int	iManualApproval;
	char	*csDesc;
	char	*csTxnSeq;
	char	*csPtr;
	char	*csCcy;
	char	csDateTime[PD_DATETIME_LEN +1];
	char	csDate[PD_DATE_LEN +1];
	char	csTime[PD_TIME_LEN +1];
	char	csYear[PD_YYYY_LEN +1];
	char	csMonth[PD_MM_LEN +1];
	double	dAmt;

	hash_t	*hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

	hash_t	*hJnl;
	hJnl = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hJnl,0);
	


/* Txn Header */
	/*db_commit */
        PutField_Int(hTxn,"db_commit",PD_FALSE);

/* ar_id */
        PutField_Char(hTxn,"ar_ind",PD_ACCEPT);
/* status */
        PutField_Char(hTxn,"status",PD_COMPLETE);

/* txn code */
/* if no txn seq */
	if (GetField_CString(hReq,"txn_code",&csPtr))
        	PutField_CString(hTxn,"txn_code",csPtr);
	else
        	PutField_CString(hTxn,"txn_code",PD_BATCH_JL_POST_TXN_CODE);

/* channel code*/
        PutField_CString(hTxn,"channel_code",PD_CHANNEL_BATCH);

/* service code */
        PutField_CString(hTxn,"service_code",PD_DEFAULT_SERVICE);


/* approval date */
/* host posting date */
	if (GetField_CString(hReq,"host_posting_date",&csPtr)) {
        	PutField_CString(hTxn,"host_posting_date",csPtr);
        	PutField_CString(hTxn,"approval_date",csPtr);
	}
/* internal code */
       	PutField_Int(hTxn,"internal_code",PD_OK);

/* local tm date */
	strcpy(csDateTime,getdatetime());
        memcpy(csDate,csDateTime,PD_DATE_LEN);
        csDate[PD_DATE_LEN] = '\0';
       	PutField_CString(hTxn,"local_tm_date",csDate);

        memcpy(csYear,csDateTime,PD_YYYY_LEN);
        csYear[PD_YYYY_LEN] = '\0';

        memcpy(csMonth,&csDateTime[PD_YYYY_LEN],PD_MM_LEN);
        csMonth[PD_MM_LEN] = '\0';

/* local tm time */
	memcpy(csTime,&csDateTime[PD_DATE_LEN],PD_TIME_LEN);
        csTime[PD_TIME_LEN] = '\0';
       	PutField_CString(hTxn,"local_tm_time",csTime);

/* process code */
       	PutField_CString(hTxn,"process_code",PD_PROCESS_CODE_DEF);
/* process type */
       	PutField_CString(hTxn,"process_type",PD_PROCESS_TYPE_DEF);

/* if no txn seq */
	if (!GetField_CString(hReq,"txn_seq",&csTxnSeq)) {
		DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextTxnSeq");
		csTxnSeq  = strdup((*DBObjPtr)());
	}
/* txn seq */
	PutField_CString(hTxn,"txn_seq",csTxnSeq);
	PutField_CString(hJnl,"jnl_id",csTxnSeq);

/* jnl type id */
	PutField_Int(hJnl,"jnl_type_id",iJnlTypeId);

/* description */
	PutField_CString(hJnl,"description",csDesc);

/* txn date */
	PutField_CString(hJnl,"txn_date",csDate);

/* country */
	if (GetField_CString(hReq,"txn_country",&csPtr)) {
		PutField_CString(hJnl,"country_code",csPtr);
	}

/* product */
	if (GetField_CString(hReq,"product",&csPtr)) {
DEBUGLOG(("doPost: product code = [%s]\n",csPtr));
		PutField_CString(hJnl,"product_code",csPtr);
	}
/* ccy */
	if (!GetField_CString(hReq,"ccy",&csCcy)) {
		csCcy = NULL  ;
	}
DEBUGLOG(("BOCrrPost::doPost ccy = [%s]\n",csCcy));

/* acc year */
	PutField_CString(hJnl,"acc_year",csYear);
/* acc month */
	PutField_CString(hJnl,"acc_month",csMonth);

/* create_user */
	PutField_CString(hJnl,"create_user",PD_UPDATE_USER);
/* disabled */
	PutField_Int(hJnl,"didabled",PD_FALSE);


	if (!iManualApproval)
		PutField_Char(hJnl,"status",PD_JNL_APPROVED);
	else 
		PutField_Char(hJnl,"status",PD_JNL_PENDING);

	DBObjPtr = CreateObj(DBPtr,"DBTransaction","Add");
        iRet = (unsigned long)(*DBObjPtr)(hTxn);

	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBCrrJnlHeader","Add");
        	iRet = (unsigned long)(*DBObjPtr)(hJnl);
	}

/* txn amt */
	if (!GetField_Double(hReq,"amount",&dAmt)) {
		dAmt = 0.0;
	}
DEBUGLOG(("BOCrrPost::doPost amount = [%lf]\n",dAmt));
	PutField_Double(hJnl,"txn_amt",dAmt);
/* currency id */
	PutField_CString(hJnl,"currency_id",csCcy);

	hash_destroy(hTxn);
       	FREE_ME(hTxn);

	return iRet;
}

