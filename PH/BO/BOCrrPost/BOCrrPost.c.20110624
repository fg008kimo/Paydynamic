/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/06/23              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOCrrPost.h"

char    cDebug;
OBJPTR(DB);

int doPost(hash_t* hRec, const hash_t* hRule) ;
void BOCrrPost(char    cdebug)
{
        cDebug = cdebug;
}

int  PostPHTxn(recordset_t* myRec)
{
	hash_t	*hRec, *hReq;
	int	iRet = PD_OK;
	char*	csTxnCode;
	char*	csCountry;
	char*	csProduct;
	char*	csCcy;
	char*	csTxnType;
	char*	csPartyId;
	char	cType;
	double	dAmt;
	
	int i = 0;

DEBUGLOG(("BOCrrPosting:PostPHTxn()\n"));

	hRec = RecordSet_GetFirst(myRec);
	while (hRec && iRet == PD_OK) {
		i++;
		hReq = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hReq,0);
/* txn code */
		if (GetField_CString(hRec,"txn_code",&csTxnCode)) {
DEBUGLOG(("BOCrrPosting:PostPHTxn() txn_code = [%s]\n",csTxnCode));
		}
		else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() txn_code is missing!!!\n"));
			iRet = PD_ERR;
		}

/* txn country */
		if (GetField_CString(hRec,"txn_country",&csCountry)) {
DEBUGLOG(("BOCrrPosting:PostPHTxn() txn_country = [%s]\n",csCountry));
		}
		else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() txn_country is missing!!!\n"));
			iRet = PD_ERR;
		}

/* product */
		if (GetField_CString(hRec,"product",&csProduct)) {
DEBUGLOG(("BOCrrPosting:PostPHTxn() product = [%s]\n",csProduct));
		}
		else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() product is missing!!!\n"));
			iRet = PD_ERR;
		}

/* ccy */
		if (GetField_CString(hRec,"ccy",&csCcy)) {
DEBUGLOG(("BOCrrPosting:PostPHTxn() ccy = [%s]\n",csCcy));
		}
		else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() ccy is missing!!!\n"));
			iRet = PD_ERR;
		}

/* txn_type */
		if (GetField_CString(hRec,"txn_type",&csTxnType)) {
DEBUGLOG(("BOCrrPosting:PostPHTxn() txn_type = [%s]\n",csTxnType));
		}
		else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() txn_type is missing!!!\n"));
			iRet = PD_ERR;
		}

/* party_id */
		if (GetField_CString(hRec,"id",&csPartyId)) {
DEBUGLOG(("BOCrrPosting:PostPHTxn() party_id = [%s]\n",csPartyId));
		}
		else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() party_id is missing!!!\n"));
			iRet = PD_ERR;
		}

/* type */
		if (GetField_Char(hRec,"type",&cType)) {
DEBUGLOG(("BOCrrPosting:PostPHTxn() type = [%c]\n",cType));
		}
		else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() type is missing!!!\n"));
			iRet = PD_ERR;
		}

/* amount */
		if (GetField_Double(hRec,"amount",&dAmt)) {
DEBUGLOG(("BOCrrPosting:PostPHTxn() amount = [%lf]\n",dAmt));
		}
		else {
DEBUGLOG(("BOCrrPosting:PostPHTxn() type is missing!!!\n"));
			iRet = PD_ERR;
		}

		if (iRet == PD_OK) {

			hash_t	*hRule;
			hRule = (hash_t*) malloc (sizeof(hash_t));
			hash_init(hRule,0);
			DBObjPtr = CreateObj(DBPtr,"DBCrrRulePosting","GetRule");
			iRet = (unsigned long)((*DBObjPtr)(csTxnCode,
					csCountry,
					csProduct,
					csCcy,
					csTxnType,
					csPartyId,
					cType,
					dAmt,
					hRule));
			if (iRet == PD_NOT_FOUND) {	
//DEBUGLOG(("BOCrrPosting:PostPHTxn() Rule Not found SKIP!!!!!!!!!!!!!!!!!!!\n"));
			}
			else {	
DEBUGLOG(("BOCrrPosting:PostPHTxn() PostTxn for [%s_%s_%s_%s_%s_%s_%c] = [%lf]*****\n",csTxnCode,csCountry,csProduct,csCcy,csTxnType,csPartyId,cType,dAmt));
			}

			hash_destroy(hRule);
        		FREE_ME(hRule);
			hRec = RecordSet_GetNext(myRec);
			iRet = PD_OK;
		}
		hash_destroy(hReq);
		FREE_ME(hReq);
	}

DEBUGLOG(("BOCrrPosting:PostPHTxn() i = [%d] iRet = [%d]\n",i,iRet));
	return iRet;
}


int doPost(hash_t* hRec, const hash_t* hRule) 
{

	int	iRet = PD_OK;

	return iRet;
}
