/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/09/23              Cody Chan
Compare int and ext rate			   2011/07/29		   Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOExchange.h"

char    cDebug;
#define PD_PREFIX       "org"

OBJPTR(DB);
OBJPTR(BO);
void BOExchange(char    cdebug)
{
        cDebug = cdebug;
}


double  CalExAmt(double dFromAmt,double dRate,const char* csDstCcy);
int DoExchange(hash_t* hContext,
		double	dTxnAmt,
		const char* csFromCcy,
                const char* csToCcy,
                const char* csCountryId,
                const char* csChannelCode,
                const char* csServiceCode,
                const char* csTxnCode,
                const char* csMerchantId,
                const char* csClientId);

int GetExchangeInfo(hash_t *hContext,
                const hash_t* hRequest)
{
        int     iRet = PD_OK;
	char*	csTxnCcy;
	char*	csPspCcy;
	double	dAmt;
	//,dSebBal,dRatio,dRate;
	char*	csTxnCode;
	char*	csTxnCountry;
	char*	csChannelCode;
	char*	csServiceCode;
	char*	csMerchantId;
	char*	csMerchantClientId;
	char	csTag[PD_TAG_LEN +1];
	int	iInitMode = PD_FALSE;
	
	hash_t	*hRec;


	hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec,0);

DEBUGLOG(("BOExchange:GetExchangeInfo()\n"));
        GetField_Int(hContext,"init_mode",&iInitMode);
DEBUGLOG(("BOExchange::GetExchangeInfo() init_mode = [%d]\n",iInitMode));

        if (iInitMode)
		if (GetField_Double(hContext,"org_txn_amt",&dAmt)) {
DEBUGLOG(("BOExchange:GetExchangeInfo org_txn_amt  = [%lf]\n",dAmt));
		}
		else {
DEBUGLOG(("BOExchange:GetExchangeInfo org_txn_amt is missing!!!\n"));
		}
	else if (GetField_Double(hContext,"txn_amt",&dAmt)) {
DEBUGLOG(("BOExchange:GetExchangeInfo txn_amt = [%f]\n",dAmt));
	}
	else {
DEBUGLOG(("BOExchange:GetExchangeInfo txn_amt is missing!!!\n"));
	}

	if (!GetField_CString(hContext,"txn_ccy",&csTxnCcy) && iRet == PD_OK) {
		if (!GetField_CString(hRequest,"txn_ccy",&csTxnCcy)) {
DEBUGLOG(("BOExchange:GetExchangeInfo txn_ccy is missing!!!\n"));
			iRet = PD_ERR;
		}
	}
	if (!GetField_CString(hContext,"dst_txn_ccy",&csPspCcy) && iRet == PD_OK) {
DEBUGLOG(("BOExchange:GetExchangeInfo dst_txn_ccy is missing!!!\n"));
		iRet = PD_ERR;
	}
	else {
	//	PutField_CString(hContext,"psp_txn_ccy",csPspCcy);
DEBUGLOG(("BOExchange:GetExchangeInfo dst_txn_ccy  = [%s]\n",csPspCcy));
	}





/* txn code */
        if (iInitMode)
                sprintf(csTag,"%s_txn_code",PD_PREFIX);
        else
                strcpy(csTag,"txn_code");
        if (GetField_CString(hContext,csTag,&csTxnCode)) {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s = [%s]\n",csTag,csTxnCode));
        }
        else {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s not found!!!\n",csTag));
        }

/*org txn country */
        if (iInitMode) {
                sprintf(csTag,"%s_txn_country",PD_PREFIX);
                if (GetField_CString(hContext,csTag,&csTxnCountry)) {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s = [%s]\n",csTag,csTxnCountry));
                }
                else {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s is missing!!!\n",csTag));
                }
        }
        else {
                strcpy(csTag,"txn_country");
                if (GetField_CString(hRequest,csTag,&csTxnCountry)) {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s = [%s]\n",csTag,csTxnCountry));
                }
                else {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s is missing!!!\n",csTag));
                }
        }


/*org txn ccy */
        if (iInitMode) {
                sprintf(csTag,"%s_txn_ccy",PD_PREFIX);
                if (GetField_CString(hContext,csTag,&csTxnCcy)) {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s = [%s]\n",csTag,csTxnCcy));
                }
                else {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s is missing!!!\n",csTag));
                }
        }
        else {
                strcpy(csTag,"txn_ccy");
                if (GetField_CString(hRequest,csTag,&csTxnCcy)) {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s = [%s]\n",csTag,csTxnCcy));
                }
                else {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s is missing!!!\n",csTag));
                }
        }


/*org channel code */
        if (iInitMode)
                sprintf(csTag,"%s_channel_code",PD_PREFIX);
        else
                strcpy(csTag,"channel_code");
        if (GetField_CString(hContext,csTag,&csChannelCode)) {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s = [%s]\n",csTag,csChannelCode));
        }
        else {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s is missing!!!\n",csTag));
        }

/*org service code */
        if (iInitMode) {
                sprintf(csTag,"%s_service_code",PD_PREFIX);
                if (GetField_CString(hContext,csTag,&csServiceCode)) {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s = [%s]\n",csTag,csServiceCode));
                }
                else {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s is missing!!!\n",csTag));
                }
        }
        else {
                strcpy(csTag,"service_code");
                if (GetField_CString(hRequest,csTag,&csServiceCode)) {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s = [%s]\n",csTag,csServiceCode));
                }
                else {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s is missing!!!\n",csTag));
                }
        }

/*org merchant id */
        if (iInitMode) {
                sprintf(csTag,"%s_merchant_id",PD_PREFIX);
                if (GetField_CString(hContext,csTag,&csMerchantId)) {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s = [%s]\n",csTag,csMerchantId));
                }
                else {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s is missing!!!\n",csTag));
                }
        }
        else {
                strcpy(csTag,"merchant_id");
                if (GetField_CString(hRequest,csTag,&csMerchantId)) {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s = [%s]\n",csTag,csMerchantId));
                }
                else {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s is missing!!!\n",csTag));
                }
        }


/*org merchant client id */
        if (iInitMode) {
                sprintf(csTag,"%s_client_id",PD_PREFIX);
        }
        else {
                strcpy(csTag,"merchant_client_id");
        }

        if (GetField_CString(hContext,csTag,&csMerchantClientId)) {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s = [%s]\n",csTag,csMerchantClientId));
        }
        else {
DEBUGLOG(("BOExchange::GetExchangeInfo() %s is missing!!!\n",csTag));
        }

	if (iRet == PD_OK) {	

		if (!strcmp(csTxnCcy,csPspCcy) && iRet == PD_OK) {
DEBUGLOG(("BOExchange:GetExhcangeInfo same currency!!!\n"));
			PutField_CString(hContext,"dst_txn_ccy",csTxnCcy);
			PutField_Double(hContext,"dst_txn_amt",dAmt);
			PutField_Double(hContext,"ex_rate",1);
			PutField_Char(hContext,"ex_party",PD_INT_EX);
		}
		else {
DEBUGLOG(("BOExchange:GetExhcangeInfo do Exchange!!!\n"));
			if (DoExchange(hContext,
				dAmt,
				csTxnCcy,
				csPspCcy,
       	         		csTxnCountry,
       	        	 	csChannelCode,
       	         		csServiceCode,
                		csTxnCode,
                		csMerchantId,
                		csMerchantClientId) != PD_OK) {
DEBUGLOG(("BOExchange:GetExhcangeInfo do Exchange Failed!!!\n"));
			}
		}
	}

	
	hash_destroy(hRec);
        FREE_ME(hRec);
DEBUGLOG(("BOExchange:GetExchangeInfo exit Ret = [%d]\n",iRet));
	return iRet;
}
double	CalExAmt(double dFromAmt,double dRate,const char* csDstCcy)
{
	double	dTmp = 0.0;
	dTmp = dFromAmt * dRate;
DEBUGLOG(("CalExAtm: from[%lf] * rate = [%lf] = [%lf] DST CCY = [%s] \n",dFromAmt,dRate,dTmp,csDstCcy));
	DBObjPtr = CreateObj(DBPtr,"DBCurrency","IsSupportDecimal");
	if ((unsigned long)((*DBObjPtr)(csDstCcy)) == PD_TRUE) {
DEBUGLOG(("CalExAmt: Support Decimal\n"));
		dTmp =  newround(dTmp, PD_DECIMAL_LEN);
	}
	else {
DEBUGLOG(("CalExAmt: Doesn't Support Decimal\n"));
		dTmp =  newround(dTmp, 0);
	}
	return dTmp;
}
int GetExternalExchangeRate(const char* csFromCcy,
		const char* csToCcy,
		double	dTxnAmt,
		double	*dExRate,
		double	*dExAmt)
{
	int iRet = PD_OK;
	hash_t	*hRec;
	double	dNewTxnAmt = dTxnAmt;
	double	dRate = 0;

	hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec,0);

DEBUGLOG(("GetExternalExchangeRate from [%s] to [%s] = [%lf]\n",csFromCcy,csToCcy,dTxnAmt));

	DBObjPtr = CreateObj(DBPtr,"DBExchangeRate","GetExchangeRate");
	if ((unsigned long)((*DBObjPtr)(csFromCcy,csToCcy,hRec)) == PD_OK) {
		
		if (GetField_Double(hRec,"rate",&dRate)) {
DEBUGLOG(("GetExternalExchangeRate rate = [%lf]\n",dRate));
/* apply Exchange Markup Fee */
			double dNewAmt =  CalExAmt(dNewTxnAmt,dRate,csToCcy);
DEBUGLOG(("GetExternalExchangeRate new amt in [%s] = [%lf]\n",csToCcy,dNewAmt));
			*dExRate = dRate;
			*dExAmt = dNewAmt;
		}
		else 
			iRet = INT_EX_RATE_ERROR;
	}
	else  {
		iRet = INT_EX_RATE_ERROR;
	}

DEBUGLOG(("GetExternalExchangeRate::() = [%d]\n",iRet));

	hash_destroy(hRec);
	FREE_ME(hRec);
	return iRet;
}


int DoExchange(hash_t* hContext,
		double	dTxnAmt,
		const char* csFromCcy,
		const char* csToCcy,
		const char* csCountryId,
		const char* csChannelCode,
		const char* csServiceCode,
		const char* csTxnCode,
		const char* csMerchantId,
		const char* csClientId)
{
	int	iRet = PD_OK;
	double	dSebBal = 0.0;
	double	dRate = 0.0;
	double	dExRate = 0.0;
	//double	dRatio = 0.0;
	double	dMarkupRate = 0.0;
	double	dExMarkupRate = 0.0;
	double	dNewAmt = 0.0;
	int	iIntRate = PD_FALSE;

	hash_t	*hRec;
	hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec,0);

DEBUGLOG(("DoExchange::() = [%d]\n",iRet));
DEBUGLOG(("DoExchange::() FromCcy= [%s]\n",csFromCcy));
DEBUGLOG(("DoExchange::() ToCcy= [%s]\n",csToCcy));
/*	DBObjPtr = CreateObj(DBPtr,"DBSebBalance","FindBalanceByCcy");
        if ((unsigned long)(*DBObjPtr)(csToCcy,
                        csFromCcy,
                        hRec) == PD_FOUND) {
/// dsp bal
		if (GetField_Double(hRec,"bank_bal",&dSebBal)) {
DEBUGLOG(("DoExchange::() dsp bal = [%lf]\n",dSebBal));
                }
                if (GetField_Double(hRec,"rate",&dRate)) {
DEBUGLOG(("DoExchange::() ex rate = [%lf]\n",dRate));
                }
                if (GetField_Double(hRec,"raito",&dRatio)) {
DEBUGLOG(("DoExchange::() ratio = [%lf]\n",dRatio));
                }
	}
*/
	DBObjPtr = CreateObj(DBPtr,"DBRuleExMarkup","Find");
       	if ((unsigned long)((*DBObjPtr)(PD_EXT_EX,
        	csCountryId,
                csChannelCode,
                csServiceCode,
                csTxnCode,
                csMerchantId,
                csClientId,
                &dExMarkupRate)) == PD_OK) {
DEBUGLOG(("DoExchange::() External Markup Rate = [%lf]\n",dExMarkupRate));
	}

	if (dSebBal > 0.0) {
        	DBObjPtr = CreateObj(DBPtr,"DBRuleExMarkup","Find");
        	if ((unsigned long)((*DBObjPtr)(PD_INT_EX,
						csCountryId,
						csChannelCode,
						csServiceCode,
						csTxnCode,
						csMerchantId,
						csClientId,
						&dMarkupRate)) == PD_OK) {
DEBUGLOG(("DoExchange::() Internal Markup Rate = [%lf]\n",dMarkupRate));
                }

        	DBObjPtr = CreateObj(DBPtr,"DBExchangeRate","GetExchangeRate");
        	if ((unsigned long)((*DBObjPtr)(csFromCcy,csToCcy,hRec)) == PD_OK) {
                	if (GetField_Double(hRec,"rate",&dExRate)) {
DEBUGLOG(("DoExchange::() Exteranl ex Rate = [%lf]\n",dExRate));
			}
		}

		if ((dExRate + dExMarkupRate) > (dMarkupRate + dRate)) {
DEBUGLOG(("DoExchange::() Exteranl ex Rate  is better [%lf] + [%lf] > [%lf] + [%lf]\n",dExMarkupRate,dExRate,dMarkupRate,dRate));
		}
		else {
			dNewAmt = CalExAmt(dTxnAmt,dRate+dMarkupRate,csToCcy);
			if (dNewAmt > dSebBal) {
DEBUGLOG(("DoExchange::() Exteranl ex Rate  since seb balance is less [%lf] < [%lf]\n",dSebBal,dNewAmt));
			}
			else {
				iIntRate = PD_TRUE;
			}

		}
	}
	else {
/* use external rate */
        	DBObjPtr = CreateObj(DBPtr,"DBExchangeRate","GetExchangeRate");
        	if ((unsigned long)((*DBObjPtr)(csFromCcy,csToCcy,hRec)) == PD_OK) {
                	if (GetField_Double(hRec,"rate",&dExRate)) {
DEBUGLOG(("DoExchange::() Exteranl ex Rate = [%lf]\n",dExRate));
			}
		}
	}
	PutField_CString(hContext,"markup_ccy",csToCcy);
	double	dMarkupAmt = 0.0;

	if (iIntRate == PD_FALSE) {
/* use external rate */

/* markup amount in dst currency*/
		dNewAmt = CalExAmt(dTxnAmt,dExRate,csToCcy);
DEBUGLOG(("DoExchange::() dst_txn_amt = [%lf]\n",dNewAmt));
		PutField_Double(hContext,"dst_txn_amt",dNewAmt);
                PutField_Double(hContext,"ex_rate",dExRate);
                PutField_Char(hContext,"ex_party",PD_EXT_EX);

		dMarkupAmt  = CalExAmt(dNewAmt,dExMarkupRate,csToCcy);
DEBUGLOG(("DoExchange::() markup amt = [%lf] in [%s]\n",dMarkupAmt,csToCcy));
		PutField_Double(hContext,"markup_rate",dExMarkupRate);
		PutField_Double(hContext,"markup_amt",dMarkupAmt);

	}
	else {
/* use internal rate */
		dNewAmt = CalExAmt(dTxnAmt,dRate,csToCcy);
DEBUGLOG(("DoExchange::() dst_txn_amt = [%lf]\n",dNewAmt));
		PutField_Double(hContext,"dst_txn_amt",dNewAmt);
               	PutField_Double(hContext,"ex_rate",dRate);
               	PutField_Char(hContext,"ex_party",PD_INT_EX);

		dMarkupAmt  = CalExAmt(dNewAmt,dMarkupRate,csToCcy);
DEBUGLOG(("DoExchange::() markup amt = [%lf] in [%s]\n",dMarkupAmt,csToCcy));
		PutField_Double(hContext,"markup_rate",dMarkupRate);
		PutField_Double(hContext,"markup_amt",dMarkupAmt);
	}
DEBUGLOG(("DoExchange::() return [%d]\n",iRet));
	return iRet;
}
        
int GetExternalExchangeRateByDate(const char* csEffectDate,
                const char* csFromCcy,
                const char* csToCcy,
                double  dTxnAmt,
                double  *dExRate,
                double  *dExAmt)
{       
        int iRet = PD_OK;
        hash_t  *hRec;
        double  dNewTxnAmt = dTxnAmt;
        double  dRate = 0;
                
        hRec = (hash_t*) malloc (sizeof(hash_t));
  hash_init(hRec,0);    
                
        DEBUGLOG(("GetExternalExchangeRateByDate from [%s] to [%s] = [%lf]\n",csFromCcy,csToCcy,dTxnAmt));
        
        DBObjPtr = CreateObj(DBPtr,"DBExchangeRate","GetExchangeRateByDate");
        if ((unsigned long)((*DBObjPtr)(csEffectDate,csFromCcy,csToCcy,hRec)) == PD_OK) {
         
                if (GetField_Double(hRec,"rate",&dRate)) {
                        DEBUGLOG(("GetExternalExchangeRateByDate rate = [%lf]\n",dRate));
                        /* apply Exchange Markup Fee */
                        double dNewAmt =  CalExAmt(dNewTxnAmt,dRate,csToCcy);
                        DEBUGLOG(("GetExternalExchangeRate new amt in [%s] = [%lf]\n",csToCcy,dNewAmt));
                        *dExRate = dRate;
                        *dExAmt = dNewAmt;
                }
                else
                        iRet = INT_EX_RATE_ERROR;
        }
        else  {
                iRet = INT_EX_RATE_ERROR;
        }

DEBUGLOG(("GetExternalExchangeRateByDate::() = [%d]\n",iRet));

        hash_destroy(hRec);
        FREE_ME(hRec);
        return iRet;
}
