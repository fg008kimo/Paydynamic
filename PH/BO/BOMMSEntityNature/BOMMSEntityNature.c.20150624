/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/06/13              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOMMSEntityNature.h"

char    cDebug;

OBJPTR(DB);

void BOMMSEntityNature(char    cdebug)
{
        cDebug = cdebug;
}

int FindEntityNatureId(hash_t* hContext)
{
	int	iRet = PD_ERR;

	int     i= 0,j = 0,iBalCnt = 0,iNatureCnt = 0;
	char    csTag[PD_TAG_LEN +1];
        char    csNatureId[PD_NATURE_ID_LEN +1];
        char    *csGroup,*csGroupValue;
        recordset_t     *rRec;
        hash_t          *hData;

DEBUGLOG(("FindEntityNatureId ()\n"));

        rRec = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRec,0);


        if (GetField_Int(hContext,"bal_cnt",&iBalCnt)) {
DEBUGLOG(("FindEntityNatureId() bal_cnt = [%d]\n",iBalCnt));
        }

        for (i = 0 ;i < iBalCnt; i++){
		sprintf(csTag,"bal.%d.nat_cnt",i+1);
        	if (GetField_Int(hContext,csTag,&iNatureCnt)) {
DEBUGLOG(("FindEntityNatureId() [%s] = [%d]\n",csTag,iNatureCnt));
	

			for (j = 0 ; j < iNatureCnt; j++ ) {
				sprintf(csTag,"bal.%d.nat.%d.grp",i+1,j+1);
        			GetField_CString(hContext,csTag,&csGroup);
//DEBUGLOG(("FindEntityNatureId() [%s] = [%s]\n",csTag,csGroup));
				sprintf(csTag,"nat.%d.grp",j+1);
DEBUGLOG(("FindEntityNatureId() [%s] = [%s]\n",csTag,csGroup));

				sprintf(csTag,"bal.%d.nat.%d.val",i+1,j+1);
        			GetField_CString(hContext,csTag,&csGroupValue);
//DEBUGLOG(("FindEntityNatureId() [%s] = [%s]\n",csTag,csGroupValue));
				sprintf(csTag,"nat.%d.val",j+1);
DEBUGLOG(("FindEntityNatureId() [%s] = [%s]\n",csTag,csGroupValue));

		                hData = (hash_t*) malloc (sizeof(hash_t));
                		hash_init(hData,0);
                		PutField_CString(hData,"group",csGroup);
                		PutField_CString(hData,"group_val",csGroupValue);

                		RecordSet_Add(rRec,hData);
			}

			DBObjPtr = CreateObj(DBPtr,"DBMmsEntityNatureMap","Find");
                	if ((unsigned long)(*DBObjPtr)(rRec,csNatureId) == FOUND) {
//DEBUGLOG(("FindEntityNatureId Nature ID = [%s]\n",csNatureId));
				sprintf(csTag,"bal.%d.nature_id",i+1);
DEBUGLOG(("FindEntityNatureId [%s] = [%s]\n",csTag,csNatureId));
                		PutField_CString(hContext,csTag,csNatureId);
				iRet = PD_OK;
			}
			else  {
DEBUGLOG(("FindEntityNatureId Nature ID not found\n"));
				iRet = PD_ERR;
			}
		}
        }

        RecordSet_Destroy(rRec);
        FREE_ME(rRec);
DEBUGLOG(("FindEntityNatureId Normal exit iRet = [%d]\n",iRet));
	return iRet;
}
