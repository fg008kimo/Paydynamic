/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/10/24              LokMan Chow
Call BOtxnElements				   2012/02/08		   LokMan Chow
Add handle_PayoutIndvCancel 			   2012/04/27		   LokMan Chow
Call CalPspCosts
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOPayout.h"

#define PD_SPACE 0x20
#define PD_TR           "<tr>"
#define PD_TD           "<td>"
#define PD_BOLD         "<b>"
#define PD_TD_STYLE     "<td class=\"format\">"
#define PD_TR_END       "</tr>"
#define PD_TD_END       "</td>"
#define PD_BOLD_END     "</b>"

#define	PD_TMP_SPLIT_AMT 3000

char    cDebug;

void BOPayout(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

int GetPayoutRecords(const unsigned long lBatchId,
                        hash_t *hContext,
                        hash_t* hRequest);

int UpdateDetail(hash_t *hContext,
                hash_t* hRequest);

int UpdateHeader(hash_t *hContext,
		 hash_t* hRequest);

int CheckAvalBalance(hash_t *hContext,
                     const hash_t* hRequest);

int GetPayoutFee(hash_t *hContext,
                 hash_t* hRequest);

int GetPayoutRule(hash_t *hContext,
                  hash_t* hRequest);

int AssignPsp(hash_t *hContext,
              hash_t* hRequest,
	      hash_t* hResponse);

int FormatResponse(const hash_t *hContext,
		   hash_t* hResponse);

int CreatePayoutFileDetail(const char* csPspId,
			   hash_t* hContext);
int CreatePayoutFile(const char* csPspId,
		     hash_t* hContext);

int WritePayoutFile(const char* csPayOutFile,
		    hash_t* hRec);

int WriteAssignedRecord(hash_t *hContext,
			hash_t* hRequest);

int GetGenFileDetail(hash_t *hContext,
		     hash_t* hRequest);

int GenerateBatchSeq(hash_t* hRequest);

int handle_PayoutUpload(const unsigned long lBatchId,hash_t* hContext,hash_t* hRequest);
int handle_PayoutConfirm(const unsigned long lBatchId,hash_t* hContext,hash_t* hRequest);
int handle_PayoutApprove(const unsigned long lBatchId,hash_t* hContext,hash_t* hRequest);
int handle_PayoutPreGenerate(hash_t* hContext,hash_t* hRequest,hash_t* hResponse);
int handle_PayoutGenerate(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
int handle_PayoutCancel(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
int handle_PayoutCancelBeforeApproved(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
int handle_PayoutCancelApproved(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
int handle_PayoutCancelGenerated(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
int handle_PayoutSend(hash_t *hContext,hash_t* hRequest,hash_t* hResponse);
int handle_PayoutIndvCancel(hash_t *hContext,hash_t* hRequest,hash_t* hResponse);
int handle_PayoutReGenerate(hash_t *hContext,hash_t* hRequest,hash_t* hResponse);

int AddTxnLog(hash_t *hContext);

int GetPayoutFilePath(hash_t* hTxn);

int ProcessPayoutTxn(hash_t *hContext,
		 hash_t* hRequest,
		 hash_t* hResponse)
{
	int     iRet = PD_OK;
	char	*csTmp;
	char	*csTxnCode;
	char	*csMerchantId;
	int	iTmp= 0;
	int	i= 0;
	int	iChk= PD_FALSE;
	int	iMerch = PD_FALSE;
	unsigned long lBatchId = 0l;
	char    csTag[PD_TAG_LEN +1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	hash_t  *hHeader;
        hHeader = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hHeader,0);

DEBUGLOG(("BOPayout:ProcessPayoutTxn()\n"));

 	if (GetField_CString(hRequest,"batch_id",&csTmp)) {
		lBatchId = ctol((const unsigned char *)csTmp,strlen(csTmp));
		PutField_CString(hTxn,"batch_id",csTmp);
DEBUGLOG(("BOPayout::ProcessPayoutTxn() batch_id = [%s]\n",csTmp));
        }

	if(GetField_CString(hContext,"approval_date",&csTmp)){
DEBUGLOG(("BOPayout::ProcessPayoutTxn() approval_date = [%s]\n",csTmp));
	}

	if(GetField_Int(hContext,"day_of_week",&iTmp)){
DEBUGLOG(("BOPayout::ProcessPayoutTxn() day_of_week = [%d]\n",iTmp));
	}

 	if (GetField_CString(hRequest,"merchant_id",&csMerchantId)) {
		iMerch = PD_TRUE;
DEBUGLOG(("BOPayout::ProcessPayoutTxn() merchant_id = [%s]\n",csMerchantId));
        }
	PutField_Int(hRequest,"mid_present",iMerch);

 	if (GetField_CString(hRequest,"file_id",&csTmp)) {
		PutField_CString(hHeader,"file_id",csTmp);
DEBUGLOG(("BOPayout::ProcessPayoutTxn() file_id = [%s]\n",csTmp));
        }

 	if (GetField_CString(hRequest,"add_user",&csTmp)) {
		PutField_CString(hTxn,"update_user",csTmp);
		PutField_CString(hHeader,"update_user",csTmp);
DEBUGLOG(("BOPayout::ProcessPayoutTxn() add_user = [%s]\n",csTmp));
	}

	if(GetField_CString(hRequest,"txn_code",&csTxnCode)){
DEBUGLOG(("BOPayout::ProcessPayoutTxn() txn_code = [%s]\n",csTxnCode));
	}

/*---------Payout Upload---------*/
	if(!strcmp(csTxnCode,PD_PAYOUT_UPLOAD)){
		iRet = handle_PayoutUpload(lBatchId,hContext,hRequest);
	}
/*---------Payout Confirm---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_CONFIRM)){
		iRet = handle_PayoutConfirm(lBatchId,hContext,hRequest);
	}
/*---------Payout Approve---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_APPROVE)){
		iRet = handle_PayoutApprove(lBatchId, hContext, hRequest);
	}
/*---------Payout Pre-Generate---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_PRE_GEN)){
		iRet = handle_PayoutPreGenerate(hContext,hRequest,hResponse);
	}
/*---------Payout Generate---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_GENERATE)){
		//for online payout
		iChk = handle_PayoutSend(hContext,hRequest,hResponse);

		if(iChk == PD_FALSE){
			//for offline payout
			iRet = handle_PayoutGenerate(hContext,hRequest,hHeader);
			if(GetField_Int(hContext,"psp_count",&iTmp)){
				PutField_Int(hResponse,"total_cnt",iTmp);

				for(i=1; i<=iTmp; i++){
					sprintf(csTag,"txn_seq_%d",i);
					if(GetField_CString(hContext,csTag,&csTmp)){
						sprintf(csTag,"txnid_%d",i);
						PutField_CString(hResponse,csTag,csTmp);
					}
				}
			}
		}
		else{
			GetField_Int(hContext,"return_send",&iRet);
		}
	}
/*---------Payout Cancel---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL)){
		//PutField_CString(hRequest,"org_txn_code",csTxnCode);
		iRet = handle_PayoutCancel(hContext,hRequest,hHeader);

		if(GetField_CString(hContext,"txn_id",&csTmp)){
			PutField_CString(hResponse,"org_txn_seq",csTmp);
		}
	}

/*---------Payout Cancel Individual Record in File---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_INDV_CANCEL)){
		iRet = handle_PayoutIndvCancel(hContext,hRequest,hResponse);
	}

	else{
DEBUGLOG(("BOPayout::ProcessPayoutTxn() unknown txn_code!!!\n"));
ERRLOG("BOPayout::ProcessPayoutTxn() unknown txn_code!!!\n");
		iRet = INT_ERR;
	}


	if((iRet == PD_OK) && (strcmp(csTxnCode,PD_PAYOUT_PRE_GEN))){
		/*if(strcmp(csTxnCode,PD_PAYOUT_UPLOAD)){
			PutField_CString(hContext,"txn_code",PD_PAYOUT_UPLOAD);
		}*/
		iRet = UpdateHeader(hContext,hRequest);
	}

DEBUGLOG(("BOPayout::ProcessPayoutTxn() iRet[%d]\n",iRet));
	FREE_ME(hTxn);
	FREE_ME(hHeader);
	return	iRet;
}

int handle_PayoutUpload(const unsigned long lBatchId,
			hash_t *hContext,
			hash_t* hRequest)
{
	int	iRet = PD_OK;
	double	dTmp;
	int	iTmp;

DEBUGLOG(("BOPayout::handle_PayoutUpload()\n"));
	iRet = GetPayoutRecords(lBatchId, hContext, hRequest);
	if(iRet == INT_NO_PENDING_RECORD){
		PutField_Double(hContext,"txn_amt",0.0);
		iRet=PD_OK;
	}
	else{
		if(GetField_Double(hRequest,"txn_amt",&dTmp)){
			PutField_Double(hContext,"txn_amt",dTmp);
		}
	}

	if(iRet == PD_OK){
		if(GetField_Int(hRequest,"succ_ind",&iTmp)){
			if(iTmp==PD_TRUE){
				PutField_CString(hContext,"sub_status",PD_UPLOADED);
			}
			else{
				PutField_CString(hContext,"sub_status",PD_UPLOAD_FAILED);
			}
/*
DEBUGLOG(("handle_PayoutUpload::Call DBTransaction:Update\n"));
			DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
			if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK){
				iRet = INT_ERR;
DEBUGLOG(("handle_PayoutUpload::DBTransaction:Update Failed\n"));
			}
*/
		}
	}

	if(iRet == PD_OK){
DEBUGLOG(("handle_PayoutUpload::Call DBTransaction:AddDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
		if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("handle_PayoutUpload::DBTransaction:AddDetail Failed\n"));
		}
	}
DEBUGLOG(("BOPayout::handle_PayoutUpload iRet[%d]\n",iRet));


	return iRet;
}

int handle_PayoutConfirm(const unsigned long lBatchId,
                         hash_t *hContext,
                         hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iStatus=0;
	int	iTmp;
	//char	*csTmp;
	char	*csTxnId=strdup("");
	hash_t  *hTxn;
        hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

DEBUGLOG(("BOPayout::handle_PayoutConfirm()\n"));
	iRet = GetPayoutRecords(lBatchId, hContext, hRequest);

	if(GetField_Int(hRequest,"status",&iStatus)){
		if(iStatus!=PD_PAYOUTFILE_UPLOADED){
			iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("handle_PayoutConfirm() GetPayoutRecords:invalid status!!!\n"));
ERRLOG("BOPayout::handle_PayoutConfirm() GetPayoutRecords:invalid status!!!\n");
		}
	}

	if(iRet == PD_OK){
DEBUGLOG(("handle_PayoutConfirm::call BOMerchant->GetMerchantTxnInfo\n"));
		BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantTxnInfo");
		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);

		if(GetField_Int(hContext,"allow_payout",&iTmp)){
			if(iTmp!=PD_TRUE){
				iRet = INT_INVALID_TXN;
				PutField_Int(hContext,"internal_error",iRet);
ERRLOG("BOPayout::handle_PayoutConfirm() merchant acct not allow payout\n");
DEBUGLOG(("handle_PayoutConfirm() merchat acct not allow payout\n"));
			}
		}
	}

	if(iRet==PD_OK){
		if(GetField_CString(hContext,"org_txn_id",&csTxnId)){
			PutField_CString(hContext,"txn_seq",csTxnId);
		}
		PutField_CString(hContext,"sub_status",PD_UPLOAD_CONFIRMED);
/*
DEBUGLOG(("handle_PayoutUpload::Call DBTransaction:Update\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("handle_PayoutUpload::DBTransaction:Update Failed\n"));
		}
*/
	}

	if(iRet == PD_OK){
		iRet = UpdateDetail(hContext,hRequest);
	}

	FREE_ME(hTxn);
	FREE_ME(csTxnId);
	return iRet;
}

int handle_PayoutApprove(const unsigned long lBatchId,
                         hash_t *hContext,
                         hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iStatus=0;
	double	dTmp;
	char	*csTmp;

//////back up the original txn_seq
	if(GetField_CString(hContext,"txn_seq",&csTmp)){
		PutField_CString(hContext,"new_txn_seq",csTmp);
	}

DEBUGLOG(("BOPayout::handle_PayoutApprove()\n"));
	iRet = GetPayoutRecords(lBatchId, hContext, hRequest);

	if(iRet == PD_OK){
		if(GetField_Int(hRequest,"status",&iStatus)){
			if(iStatus!=PD_PAYOUTFILE_PROCESSING){
				iRet = INT_INVALID_TXN;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("handle_PayoutApprove() GetPayoutRecords:invalid status!!!\n"));
ERRLOG("BOPayout::handle_PayoutApprove() GetPayoutRecords:invalid status!!!\n");
			}
		}
	}

	if(iRet == PD_OK)
		iRet=GenerateBatchSeq(hRequest);


	if(iRet == PD_OK){
DEBUGLOG(("handle_PayoutApprove::call BOMerchant->GetMerchantTxnInfo\n"));
		BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantTxnInfo");
		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
	}

	if(iRet == PD_OK){
		iRet = GetPayoutFee(hContext,hRequest);
	}

	if(iRet == PD_OK){
		iRet = CheckAvalBalance(hContext,hRequest);
	}

	if(iRet == PD_OK){
		iRet = UpdateDetail(hContext,hRequest);
	}

	if(iRet==PD_OK){
		if(GetField_Double(hContext,"total_src_txn_fee",&dTmp)){
			PutField_Double(hContext,"src_txn_fee",dTmp);
		}
		if(GetField_Double(hContext,"total_dst_txn_fee",&dTmp)){
			PutField_Double(hContext,"dst_txn_fee",dTmp);
		}

		/*Add log to TxnElement*/
		if(GetField_CString(hContext,"org_txn_id",&csTmp)){
			PutField_CString(hContext,"from_txn_seq",csTmp);
			PutField_CString(hContext,"txn_seq",csTmp);
		}

		if(GetField_Double(hContext,"net_amt",&dTmp)){
			PutField_Double(hContext,"org_txn_amt",dTmp);
		}
		PutField_CString(hContext,"amount_type",PD_DR);
DEBUGLOG(("handle_PayoutApprove::Call BOTxnElements:AddTxnAmtElement\n"));
		BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnAmtElement");
		iRet = (unsigned long)(*BOObjPtr)(hContext);
/*
DEBUGLOG(("handle_PayoutApprove::Call BOTxnElements:AddTxnFeeElements\n"));
		BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnFeeElements");
		iRet = (unsigned long)(*BOObjPtr)(hContext);
*/
	}

	if(iRet == PD_OK){
DEBUGLOG(("handle_PayoutApprove::Call BOBalance:UpdatePayoutAmount (Merchant)\n"));
		PutField_Char(hContext,"response_mode",PD_ACCEPT);
		PutField_Char(hContext,"party_type",PD_TYPE_MERCHANT);

		BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
		if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("handle_PayoutApprove::BOBalance:UpdatePayoutAmount Failed\n"));
			iRet = INT_ERR;
		}
		else{
			if(GetField_Double(hContext,"merchant_open_bal",&dTmp)){
				PutField_Double(hContext,"open_bal",dTmp);
			}
		}
	}
/*
	if(iRet == PD_OK){
DEBUGLOG(("handle_PayoutApprove::Call DBTransaction:AddDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
		if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("handle_PayoutApprove::DBTransaction:AddDetail Failed\n"));
		}
	}
*/
	if(iRet==PD_OK){
DEBUGLOG(("handle_PayoutApprove::Call DBTransaction:UpdateDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
		if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("handle_PayoutApprove::DBTransaction:UpdateDetail Failed\n"));
		}
	}

	if(iRet==PD_OK){
//		PutField_Char(hContext,"status",PD_COMPLETE);
//		PutField_Char(hContext,"ar_ind",PD_ACCEPT);
		PutField_CString(hContext,"sub_status",PD_APPROVED_FOR_GENERATED);
/*DEBUGLOG(("handle_PayoutApprove::Call DBTransaction:Update\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
		if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("handle_PayoutApprove::DBTransaction:UpdateDetail Failed\n"));
		}
*/
	}

//////put back the original txn_seq
/*	if(GetField_CString(hContext,"new_txn_seq",&csTmp)){
		PutField_CString(hContext,"txn_seq",csTmp);
	}
*/

	return iRet;
}


int handle_PayoutPreGenerate(hash_t *hContext,
			     hash_t* hRequest,
			     hash_t* hResponse)
{
	int	iRet = PD_OK;
	char	*csFileId;
	char	*csTmp;
	char	*csPspId;
	char	*csTxnCcy;
	char    csTag[PD_TAG_LEN +1];
	int	i, iOnlineCnt;
	int	iOnlineResp = PD_FALSE;
	double	dPayoutAmt=0.0;
	double	dTmpAmt=0.0;
	hash_t*	hRec;
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout::handle_PayoutPreGenerate()\n"));

	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetPreGeneratedFileId");
	if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {
			if(GetField_CString(hRec,"file_id",&csFileId)){
DEBUGLOG(("DBMerchantUploadFileDetail Resume FileId[%s]\n",csFileId));
				DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","ResumePreGenFile");
				iRet = (unsigned long)(*DBObjPtr)(csFileId);

				if(iRet==PD_OK){
DEBUGLOG(("DBPayoutGeneratedFileHD Resume FileId[%s]\n",csFileId));
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Delete");
					iRet = (unsigned long)(*DBObjPtr)(csFileId);
				}
				if(iRet==PD_OK){
DEBUGLOG(("DBPayoutGeneratedFileDT Resume FileId[%s]\n",csFileId));
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","Delete");
					iRet = (unsigned long)(*DBObjPtr)(csFileId);
				}
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}

	if(iRet==PD_OK){
		iRet = GetPayoutRule(hContext,hRequest);

		if(iRet==PD_OK){
			iRet = AssignPsp(hContext,hRequest,hResponse);
		}

		if(iRet==PD_OK){
			recordset_init(rRecordSet,0);
			PutField_Char(hRequest,"batch_mode",PD_OFFLINE);
DEBUGLOG(("handle_PayoutPreGenerate::Call DBMerchantUploadFileDetail:GetExistingPsp\n"));
        		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetExistingPsp");
			if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
				i = 0;
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if (GetField_CString(hRec, "psp_id", &csTmp)) {
						sprintf(csTag, "psp_id_%d", i);
						PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetExistingPsp::psp_id = [%s]\n",csTmp));
DEBUGLOG(("handle_PayoutPreGenerate::Call CreatePayoutFileDetail\n"));
						if(CreatePayoutFileDetail(csTmp,hContext)!=PD_OK){
							iRet=INT_ERR;
DEBUGLOG(("CreatePayoutFile for[%s] Failed!!!!\n",csTmp));
						}
					}
					i++;
					hRec = RecordSet_GetNext(rRecordSet);
					PutField_Int(hContext,"psp_count",i);
				}
			}
		}
		if(iRet==PD_OK){
			iRet = WriteAssignedRecord(hContext,hRequest);
		}

	}

	if(iRet==PD_OK){
		iRet = UpdateDetail(hContext,hRequest); 
	}
	if(iRet==PD_OK){
		iRet = FormatResponse(hContext,hResponse);
	}


/*Online Payout*/
	if(iRet==PD_OK || iRet==INT_NO_PENDING_RECORD){
		recordset_init(rRecordSet,0);
		PutField_Char(hRequest,"batch_mode",PD_ONLINE);
DEBUGLOG(("handle_PayoutPreGenerate::Call DBMerchantUploadFileDetail:GetPspAssignedTxn\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetPspAssignedTxn");
		if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				iOnlineCnt = 0;
				if (GetField_CString(hRec, "psp_id", &csPspId)) {
					
					if (GetField_CString(hRec,"payout_ccy", &csTmp)) {
						if(strcmp(csTmp,"RMB"))
							csTxnCcy=strdup(csTmp);
						else
							csTxnCcy=strdup(PD_CCY_ISO_CNY);

						sprintf(csTag, "%s_payout_ccy", csPspId);
						PutField_CString(hContext,csTag,csTxnCcy);
						FREE_ME(csTxnCcy);
DEBUGLOG(("GetPspAssignedTxn::payout_ccy = [%s]\n",csTmp));
					}

					if (GetField_Double(hRec,"payout_amount", &dPayoutAmt)) {
						sprintf(csTag,"%s_accept_amt",csPspId);
						GetField_Double(hContext,csTag,&dTmpAmt);
						PutField_Double(hContext,csTag,dTmpAmt+dPayoutAmt);
DEBUGLOG(("GetPspAssignedTxn::payout_amount = [%lf]\n",dPayoutAmt));
					}

					sprintf(csTag,"%s_accept_cnt",csPspId);
					GetField_Int(hContext,csTag,&iOnlineCnt);
					PutField_Int(hContext,csTag,iOnlineCnt+1);
				}

				iOnlineResp = PD_TRUE;
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		if(iOnlineResp){
			iRet = PD_OK;
			iOnlineCnt = 0;
			dPayoutAmt = 0.0;
			recordset_init(rRecordSet,0);
DEBUGLOG(("handle_PayoutPreGenerate::Call DBMerchantUploadFileDetail:GetExistingPsp\n"));
        		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetExistingPsp");
			if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
				if(!GetField_Int(hResponse,"total_cnt",&i))
					i=0;
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					i ++;
					if (GetField_CString(hRec, "psp_id", &csPspId)) {
						sprintf(csTag, "psp_id_%d", i);
						PutField_CString(hResponse,csTag,csPspId);
DEBUGLOG(("GetExistingPsp::psp_id = [%s]\n",csPspId));

						sprintf(csTag,"%s_accept_cnt",csPspId);
						GetField_Int(hContext,csTag,&iOnlineCnt);
						sprintf(csTag,"accept_cnt_%d",i);
						PutField_Int(hResponse,csTag,iOnlineCnt);
DEBUGLOG(("GetExistingPsp::accept_cnt = [%d]\n",iOnlineCnt));

						sprintf(csTag,"%s_accept_amt",csPspId);
						GetField_Double(hContext,csTag,&dPayoutAmt);
						sprintf(csTag,"accept_amt_%d",i);
						PutField_Double(hResponse,csTag,dPayoutAmt);
DEBUGLOG(("GetExistingPsp::accept_amt = [%lf]\n",dPayoutAmt));

						sprintf(csTag, "%s_payout_ccy", csPspId);
						GetField_CString(hContext,csTag,&csTxnCcy);
						sprintf(csTag,"ccy_%d",i);
						PutField_CString(hResponse,csTag,csTxnCcy);
DEBUGLOG(("GetExistingPsp::payout_ccy = [%s]\n",csTxnCcy));
					}
					PutField_Int(hResponse,"total_cnt",i);

					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
		}
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
DEBUGLOG(("handle_PayoutPreGenerate:: iRet = [%d]\n",iRet));
	return iRet;
}


int handle_PayoutSend(hash_t *hContext,
			  hash_t* hRequest,
			  hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iChk = PD_FALSE;
	int	i=0;
	int	b=0;
	int	iTmp=0;
	//int	iCnt=0;
	char*	csTmp;
	char*	csTmpBID;
	char*	csBatchId;
	char	csTag[PD_TAG_LEN +1];
	//double	dAmt=0.0;
	double	dTmp=0.0;
	unsigned long lBatchId = 0l;
        unsigned long lTmp=0l;

DEBUGLOG(("BOPayout::handle_PayoutSend()\n"));

	hash_t  *hRec, *hDetail, *hHeader, *hTxn;
	
	hHeader= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hHeader,0);

	hDetail= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hDetail,0);

	hTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	csTmpBID = (char*) malloc (128);

	if(GetField_CString(hContext,"PHDATE",&csTmp)){
		PutField_CString(hHeader,"txn_date",csTmp);
	}

DEBUGLOG(("handle_PayoutSend::Call DBMerchantUploadFileDetail:GetOnlineBatchRecord\n"));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetOnlineBatchRecord");
	if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_FOUND){
		
		iChk = PD_TRUE;

		PutField_Int(hDetail,csTag,i);
		PutField_Int(hDetail,"batch_cnt",b);
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec && (iRet==PD_OK)) {
			sprintf(csTag,"batch_id_%d",b);
			if(GetField_CString(hRec,"batch_id",&csBatchId)){
				PutField_CString(hDetail,"batch_id",csBatchId);
				PutField_CString(hTxn,"batch_id",csBatchId);
				PutField_CString(hHeader,csTag,csBatchId);
				if(strcmp(csBatchId,csTmpBID)){
					b++;
					i=0;
					sprintf(csTmpBID,"%s",csBatchId);
				}
			}
			sprintf(csTag,"%s_psp_id",csBatchId);
			if(GetField_CString(hRec,"psp_id",&csTmp)){
				PutField_CString(hHeader,csTag,csTmp);
			}
			sprintf(csTag,"%s_merchant_id",csBatchId);
			if(GetField_CString(hRec,"merchant_id",&csTmp)){
				PutField_CString(hHeader,csTag,csTmp);
			}
			if(GetField_Int(hRec,"seq_num",&iTmp)){
				PutField_Int(hDetail,"seq_num",iTmp);
			}
			if(GetField_CString(hRec,"txn_seq",&csTmp)){
				PutField_CString(hDetail,"txn_id",csTmp);
			}
			if(GetField_CString(hRec,"merchant_ref",&csTmp)){
				PutField_CString(hDetail,"merchant_ref",csTmp);
			}
			if(GetField_CString(hRec,"txn_country",&csTmp)){
				PutField_CString(hDetail,"country",csTmp);
			}
			if(GetField_CString(hRec,"identity_id",&csTmp)){
				PutField_CString(hDetail,"identity_id",csTmp);
			}
			if(GetField_CString(hRec,"account_num",&csTmp)){
				PutField_CString(hDetail,"account_num",csTmp);
			}
			if(GetField_CString(hRec,"account_name",&csTmp)){
				PutField_CString(hDetail,"account_name",csTmp);
			}
			if(GetField_CString(hRec,"bank_name",&csTmp)){
				PutField_CString(hDetail,"bank_name",csTmp);
			}
			if(GetField_CString(hRec,"bank_code",&csTmp)){
				PutField_CString(hDetail,"bank_code",csTmp);
			}
			if(GetField_CString(hRec,"branch",&csTmp)){
				PutField_CString(hDetail,"branch",csTmp);
			}
			if(GetField_CString(hRec,"phone_num",&csTmp)){
				PutField_CString(hDetail,"phone_num",csTmp);
			}
			if(GetField_CString(hRec,"province",&csTmp)){
				PutField_CString(hDetail,"province",csTmp);
			}
			if(GetField_CString(hRec,"city",&csTmp)){
				PutField_CString(hDetail,"city",csTmp);
			}
			if(GetField_CString(hRec,"payout_ccy",&csTmp)){
				PutField_CString(hDetail,"payout_currency",csTmp);
			}
			if(GetField_Double(hRec,"payout_amount",&dTmp)){
				PutField_Double(hDetail,"amount",dTmp);
			}

			PutField_Char(hDetail,"status",PD_INIT);
			PutField_Char(hHeader,"status",PD_INIT);

			i++;
			sprintf(csTag,"%s_txn_count",csBatchId);
			PutField_Int(hHeader,csTag,i);
			PutField_Int(hHeader,"batch_cnt",b);

			//insert detail
			DBObjPtr = CreateObj(DBPtr,"DBPayoutQueueDt","Add");
			if((unsigned long)(*DBObjPtr)(hDetail)==PD_OK){
DEBUGLOG(("BOPayout::handle_PayoutSend Add PayoutQueueDt Success\n"));
			}
			else{
				iRet=INT_ERR;
DEBUGLOG(("BOPayout::handle_PayoutSend Add PayoutQueueDt Failed!!!!\n"));
			}
			
			if(iRet==PD_OK){
				PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_TO_PSP);
				DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","UpdateDetailByBatchId");
				if ((*DBObjPtr)(csBatchId,iTmp,hTxn) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("BOPayout::DBMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
				}
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}


		if(iRet==PD_OK){
			//insert header
			GetField_Int(hHeader,"batch_cnt",&iTmp);
			for(i=0; i<iTmp; i++){
				sprintf(csTag,"batch_id_%d",i);
				if(GetField_CString(hHeader,csTag,&csBatchId)){
					PutField_CString(hHeader,"batch_id",csBatchId);
			
					lBatchId = ctol((const unsigned char *)csBatchId,strlen(csBatchId));
DEBUGLOG(("******************lBatchId[%ld]  lTmp[%ld]\n",lBatchId,lTmp));
					if (lTmp!=lBatchId){
						lTmp = lBatchId;

						recordset_init(rRecordSet,0);
						DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","GetHeader");
						if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
							hRec = RecordSet_GetFirst(rRecordSet);
							while (hRec) {
								if (GetField_CString(hRec,"txn_seq",&csTmp)) {
									PutField_CString(hHeader,"txn_seq",csTmp);
									PutField_CString(hHeader,"sub_status",PD_APPROVED_AND_GENERATED);
DEBUGLOG(("Update TxnHeader::org_txn_seq = [%s]\n",csTmp));
DEBUGLOG(("handle_PayoutSend::Call DBTransaction:Update\n"));
									DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
									if((unsigned long) ((*DBObjPtr)(hHeader))!=PD_OK){
										iRet = INT_ERR;
DEBUGLOG(("handle_PayoutSend::DBTransaction:UpdateDetail Failed\n"));
									}				
								}
								if(GetField_CString(hRec,"service_code",&csTmp)){
									PutField_CString(hHeader,"service_code",csTmp);
								}
								hRec = RecordSet_GetNext(rRecordSet);
							}
						}

						if(iRet==PD_OK){
							sprintf(csTag,"%s_psp_id",csBatchId);
							if(GetField_CString(hHeader,csTag,&csTmp)){
								PutField_CString(hHeader,"psp_id",csTmp);
							}
							sprintf(csTag,"%s_merchant_id",csBatchId);
							if(GetField_CString(hHeader,csTag,&csTmp)){
								PutField_CString(hHeader,"merchant_id",csTmp);
							}
							sprintf(csTag,"%s_txn_count",csBatchId);
							if(GetField_Int(hHeader,csTag,&iTmp)){
								PutField_Int(hHeader,"num_of_record",iTmp);
							}

							DBObjPtr = CreateObj(DBPtr,"DBPayoutQueueHd","Add");
							if((unsigned long)(*DBObjPtr)(hHeader)==PD_OK){
DEBUGLOG(("BOPayout::handle_PayoutSend Add PayoutQueueHd Success\n"));
							}
							else{
								iRet=INT_ERR;
DEBUGLOG(("BOPayout::handle_PayoutSend Add PayoutQueueHd Failed!!!!\n"));
							}
						}

						if(iRet==PD_OK){
DEBUGLOG(("UpdateHeader::DBMerchantUploadFileHeader:UpdateHeader\n"));
							PutField_Int(hTxn,"status",PD_PAYOUTFILE_SENT);
							DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","UpdateHeader");
							if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
								iRet = INT_ERR;
DEBUGLOG(("UpdateHeader::DBMerchantUploadFileHeader:UpdateHeader Failed\n"));
							}
						}
					}
				}
			}
		}

	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hHeader);
	FREE_ME(hDetail);
	FREE_ME(csTmpBID);

	PutField_Int(hContext,"return_send",iRet);
	return iChk;

}

int handle_PayoutGenerate(hash_t *hContext,
			  hash_t* hRequest,
			  hash_t* hHeader)
{
	int	iRet = PD_OK;
	int	i=0;
	int	iTmp=0;
	int	iCnt=0;
	int	iPspCnt=0;
	char*	csTmp;
	char*	csPspId;
	char*	csFilePath;
	char	csTag[PD_TAG_LEN +1];
	char	csNewTxnSeq[PD_TXN_SEQ_LEN +1];
	char	csTmpBatch[PD_TXN_SEQ_LEN +1];
	double	dAmt=0.0;
	double	dTmp=0.0;
	double	dBatchAmt=0.0;
	double	dPspFee=0.0;
	int	iBatchCnt = 0;

DEBUGLOG(("BOPayout::handle_PayoutGenerate()\n"));

	hash_t  *hRec, *hDetail, *hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
	recordset_t     *rDetailSet;
	rDetailSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rDetailSet,0);

DEBUGLOG(("handle_PayoutGenerate::Call DBPayoutGeneratedFileHD:GetPreGenHeader\n"));
	DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetPreGenHeader");
	if((unsigned long)(*DBObjPtr)(rRecordSet)==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if(GetField_CString(hRec,"file_id",&csTmp)){
				PutField_CString(hHeader,"file_id",csTmp);
				PutField_CString(hTxn,"file_id",csTmp);
DEBUGLOG(("GetPreGenHeader::file_id = [%s]\n",csTmp));
			}
			if(GetField_CString(hRec,"psp_id",&csPspId)){
				PutField_CString(hTxn,"psp_id",csPspId);
				PutField_CString(hTxn,"org_psp_id",csPspId);
				iPspCnt++;
				PutField_Int(hContext,"psp_count",iPspCnt);
DEBUGLOG(("GetPreGenHeader::psp_id = [%s]\n",csPspId));
			}
			if(GetField_CString(hRec,"filename",&csTmp)){
				PutField_CString(hTxn,"filename",csTmp);
DEBUGLOG(("GetPreGenHeader::filename = [%s]\n",csTmp));
			}
			
			if(GetPayoutFilePath(hTxn)==PD_OK){
				if(CreatePayoutFile(csPspId,hTxn)!=PD_OK){
DEBUGLOG(("GetPreGenHeader::CreatePayoutFile failed for [%s]!!\n",csPspId));
					iRet= INT_ERR;
					break;
				}
			}
			else{
DEBUGLOG(("GetPreGenHeader::GetPayoutFilePath failed for [%s][%s]!!\n",csPspId,csTmp));
				iRet= INT_ERR;
				break;
			}
			sprintf(csTag, "%s_path", csPspId);
			GetField_CString(hTxn,csTag,&csFilePath);


			if(GetField_CString(hRec,"payout_ccy",&csTmp)){
				PutField_CString(hContext,"org_psp_txn_ccy",csTmp);
				PutField_CString(hContext,"org_txn_ccy",csTmp);
DEBUGLOG(("GetPreGenHeader::payout_ccy = [%s]\n",csTmp));
			}
			if(GetField_Double(hRec,"total_txn_amt",&dAmt)){
				PutField_Double(hContext,"org_dst_net_amt",dAmt);
DEBUGLOG(("GetPreGenHeader::total_txn_amt = [%lf]\n",dAmt));
			}

			i =0;
			memset(csTmpBatch,0,strlen(csTmpBatch));
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_APPROVED);
DEBUGLOG(("handle_PayoutGenerate::Call DBPayoutGeneratedFileDT:GetDetail\n"));
			DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","GetDetail");
			if((unsigned long)(*DBObjPtr)(hTxn,rDetailSet)==PD_OK){
				hDetail = RecordSet_GetFirst(rDetailSet);
				while (hDetail) {
					if(GetField_CString(hDetail,"batch_id",&csTmp)){
						if(strcmp(csTmpBatch,csTmp)){
							strcpy(csTmpBatch,csTmp);
							csTmpBatch[strlen(csTmp)]='\0';
							sprintf(csTag,"assign_batch_%d",iBatchCnt);
							PutField_CString(hContext,csTag,csTmpBatch);
							iBatchCnt++;
							PutField_Int(hContext,"assign_batch_cnt",iBatchCnt);
						}
						sprintf(csTag,"batch_id_%d",i);
						PutField_CString(hRequest,csTag,csTmpBatch);
DEBUGLOG(("handle_PayoutGenerate::GetDetail batch_id[%s]\n",csTmp));
					}
					if(GetField_Double(hDetail,"payout_amount",&dTmp)){
						dBatchAmt=0;
						sprintf(csTag,"%s_total_amt",csTmpBatch);
						GetField_Double(hContext,csTag,&dBatchAmt);
						dBatchAmt+=dTmp;
						PutField_Double(hContext,csTag,dBatchAmt);

DEBUGLOG(("handle_PayoutGenerate::GetDetail payout_amt[%lf]\n",dTmp));

						PutField_Double(hTxn,"org_dst_net_amt",dTmp);
						PutField_Char(hTxn,"txn_type",PD_TYPE_PAYOUT);
DEBUGLOG(("handle_PayoutGenerate::Call BOPsp CalPspCosts\n"));
						BOObjPtr = CreateObj(BOPtr,"BOPsp","CalPspCosts");
						if((unsigned long)(*BOObjPtr)(hTxn,hRequest)==PD_OK){
							if(GetField_Double(hTxn,"precal_fee",&dTmp)){
								dPspFee += dTmp;
								PutField_Double(hContext,"precal_fee",dPspFee);
DEBUGLOG(("handle_PayoutGenerate::payout_fee[%lf]\n",dTmp));
							}
						}
					}
					if(GetField_Int(hDetail,"seq_num",&iTmp)){
						sprintf(csTag,"seq_num_%d",i);
						PutField_Int(hRequest,csTag,iTmp);
DEBUGLOG(("handle_PayoutGenerate::GetDetail seq_num[%d]\n",iTmp));
					}
					if(GetField_CString(hDetail,"txn_country",&csTmp)){
						PutField_CString(hContext,"org_txn_country",csTmp);
						PutField_CString(hContext,"txn_country",csTmp);
DEBUGLOG(("handle_PayoutGenerate::GetDetail txn_country[%s]\n",csTmp));
					}

					if(WritePayoutFile(csFilePath,hDetail)!=PD_OK){
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::WritePayoutFile Error!!!\n"));
ERRLOG("BOPayout::handle_PayoutGenerate:WritePayoutFile Error!!!\n");
					}

					i++;
					PutField_Int(hRequest,"total_count",i);
					hDetail = RecordSet_GetNext(rDetailSet);
				}

				if(iRet==PD_OK){
					PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","UpdateByFileId");
					if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
						iRet=INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::DBPayoutGeneratedFileDT Update Failed!!!\n"));
ERRLOG("BOPayout::handle_PayoutGenerate:DBPayoutGeneratedFileDT Update Failed!!!\n");
					}
				}
			}

			if(iRet == PD_OK){
				PutField_Int(hTxn,"end_file",PD_TRUE);
				iRet = WritePayoutFile(csFilePath,hTxn);
			}

			hRec = RecordSet_GetNext(rRecordSet);

			if(iRet == PD_OK){
				PutField_CString(hContext,"org_psp_id",csPspId);
				PutField_Char(hContext,"response_mode",PD_ACCEPT);
				PutField_Char(hContext,"party_type",PD_TYPE_PSP);

				BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
				if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("handle_PayoutGenerate::UpdatePayoutAmount Failed[%s][%lf]!!!\n",csPspId,dAmt));
ERRLOG("BOPayout::handle_PayoutGenerate:UpdatePayoutAmount Failed!!!\n");
					iRet = INT_ERR;
				}
			}
		
			if (iRet == PD_OK) {
				hash_t *hPsp;
				hPsp = (hash_t*) malloc (sizeof(hash_t));
				hash_init(hPsp,0);
				DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
				if (!(*DBObjPtr)(csPspId, hPsp)) {
					if (GetField_CString(hPsp,"client_id",&csTmp)) {
						PutField_CString(hContext,"psp_client_id",csTmp);
DEBUGLOG(("BOPayout::handle_PayoutGenerate: GetTxnPsp - client id = [%s]\n",csTmp));
					}
				}
				FREE_ME(hPsp);
			}
	
			PutField_Int(hHeader,"status",PD_PAYOUTFILE_GENERATED);

			if(iRet==PD_OK){
				DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextMgtTxnSeq");
				strcpy(csNewTxnSeq,(*DBObjPtr)());
DEBUGLOG(("csNewTxnSeq [%s]!!!\n",csNewTxnSeq));
				PutField_CString(hContext,"txn_id",csNewTxnSeq);
				PutField_CString(hHeader,"txn_seq",csNewTxnSeq);
				sprintf(csTag,"txn_seq_%d",i);
				PutField_CString(hContext,csTag,csNewTxnSeq);
				sprintf(csTag,"txn_seq_%d",iPspCnt);
				PutField_CString(hContext,csTag,csNewTxnSeq);
				PutField_CString(hContext,"new_txn_code",PD_PAYOUT_GENERATE);
				PutField_CString(hContext,"desc","Payout File Generated");
				if(GetField_CString(hContext,"PHDATE",&csTmp)){
					PutField_CString(hContext,"approval_date",csTmp);
				}

				iRet = AddTxnLog(hContext);
			}

			if(iRet==PD_OK){
				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
				if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("Authorize::PayoutGeneratedFileHD::Update Error!!!\n"));
					iRet = INT_ERR;
				}
			}

			if(iRet==PD_OK){
				iRet = UpdateDetail(hContext,hRequest); 
			}

			if(iRet==PD_OK){
				PutField_CString(hContext,"from_txn_seq",csNewTxnSeq);
				PutField_CString(hContext,"amount_type",PD_DR);
				PutField_Double(hContext,"org_txn_amt",dAmt+dPspFee);
DEBUGLOG(("handle_PayoutGenerate::Call BOTxnElements:AddTxnAmtElement\n"));
				BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnAmtElement");
				iRet = (unsigned long)(*BOObjPtr)(hContext);
			}

		}


		if(iRet==PD_OK){
			iCnt=0;
			unsigned long lBatchId=0l;
			hash_t  *hTxn;
			hTxn= (hash_t*) malloc (sizeof(hash_t));
			hash_init(hTxn,0);
			GetField_Int(hContext,"assign_batch_cnt",&iCnt);
			for(i=0; i<iCnt; i++){
				sprintf(csTag,"assign_batch_%d",i);
				if(GetField_CString(hContext,csTag,&csTmp)){
DEBUGLOG(("handle_PayoutGenerate::Update Txn Header sub_status for batch[%s]\n",csTmp));
					lBatchId = ctol((const unsigned char *)csTmp,strlen(csTmp));


					DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","GetHeader");
					if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
						hRec = RecordSet_GetFirst(rRecordSet);
						while (hRec) {
							if (GetField_CString(hRec,"txn_seq",&csTmp)) {
								PutField_CString(hTxn,"txn_seq",csTmp);
								PutField_CString(hTxn,"sub_status",PD_APPROVED_AND_GENERATED);
							}
							hRec = RecordSet_GetNext(rRecordSet);
						}
					}

					//Update Txn Header
DEBUGLOG(("handle_PayoutGenerate::Call DBTransaction:Update\n"));
					DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
					if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::DBTransaction:Update Failed\n"));
					}
				}
			}
			FREE_ME(hTxn);
		}
	}

	return iRet;
}


int handle_PayoutCancel(hash_t *hContext,
			hash_t* hRequest,
			hash_t* hHeader)
{
	int	iRet = PD_OK;
	char	*csTmp;
DEBUGLOG(("BOPayout::handle_PayoutCancel()\n"));

	if(GetField_CString(hRequest,"file_id",&csTmp)){
DEBUGLOG(("BOPayout::Call handle_PayoutCancelGenerated()\n"));
		iRet=handle_PayoutCancelGenerated(hContext,hRequest,hHeader);
	}
	else{
		if(GetField_CString(hRequest,"batch_id",&csTmp)){
DEBUGLOG(("BOPayout::Call handle_PayoutCancelApproved()\n"));
			iRet=handle_PayoutCancelApproved(hContext,hRequest,hHeader);
		}
	}

	return iRet;
}


int handle_PayoutCancelBeforeApproved(hash_t *hContext,
                        hash_t* hRequest,
                        hash_t* hHeader)
{
	int	iRet=PD_OK;
	char	*csTmp;
	char	cTmp;
	unsigned long lBatchId=0l;
	hash_t *hRec;
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);
	

	if(GetField_CString(hRequest,"batch_id",&csTmp)){
                lBatchId = ctol((const unsigned char *)csTmp,strlen(csTmp));
DEBUGLOG(("BOPayout::handle_PayoutCancelBeforeApproved() batch_id = [%s]\n",csTmp));
        }

	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","GetHeader");
	if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if (GetField_CString(hRec,"txn_seq",&csTmp)) {
				PutField_CString(hHeader,"txn_seq",csTmp);
				PutField_CString(hRequest,"org_txn_seq",csTmp);

				if(GetField_Char(hRequest,"action_party",&cTmp)){
					if(cTmp==PD_TYPE_MERCHANT)
						PutField_CString(hHeader,"sub_status",PD_MERCHANT_CANCELLED);
					else
						PutField_CString(hHeader,"sub_status",PD_ADMIN_CANCELLED);
				}

DEBUGLOG(("Update TxnHeader::org_txn_seq = [%s]\n",csTmp));
DEBUGLOG(("handle_PayoutCancelBeforeApproved::Call DBTransaction:Update\n"));
				DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
				if((unsigned long) ((*DBObjPtr)(hHeader))!=PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("handle_PayoutCancelBeforeApproved::DBTransaction:Update Failed\n"));
				}

			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}

	
	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
DEBUGLOG(("BOPayout::handle_PayoutCancelBeforeApproved() iRet=[%d]\n",iRet));

	return iRet;
}


int handle_PayoutCancelApproved(hash_t *hContext,
                        hash_t* hRequest,
                        hash_t* hHeader)
{
	int     iRet = PD_OK;
	char    csNewTxnSeq[PD_TXN_SEQ_LEN+1];
	char    *csTmp;
	double	dTmp;
	long	lBatchId;
	int	iStatus;

	if(GetField_CString(hRequest,"batch_id",&csTmp)){
		lBatchId = ctol((const unsigned char *)csTmp,strlen(csTmp));
DEBUGLOG(("BOPayout::handle_PayoutCancelApproved() batch_id = [%s]\n",csTmp));
	}

	iRet = GetPayoutRecords(lBatchId, hContext, hRequest);

	if(iRet == PD_OK){
		if(GetField_Int(hRequest,"status",&iStatus)){
			if(iStatus!=PD_PAYOUTFILE_APPROVED){
				if(iStatus!=PD_PAYOUTFILE_UPLOADED){
					iRet = INT_INVALID_TXN;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("handle_PayoutCancelApproved() GetPayoutRecords:invalid status!!!\n"));
ERRLOG("BOPayout::handle_PayoutCancelApproved() GetPayoutRecords:invalid status!!!\n");
				}
				else{
DEBUGLOG(("BOPayout::Call handle_PayoutCancelBeforeApproved()\n"));
					iRet=handle_PayoutCancelBeforeApproved(hContext,hRequest,hHeader);
					return iRet;
				}
			}
		}
	}

	if(iRet==PD_OK){
		PutField_CString(hRequest,"txn_code",PD_PAYOUT_CANCEL_APPROVED);
		PutField_Char(hContext,"response_mode",PD_REVERSED);
		PutField_Char(hContext,"party_type",PD_TYPE_MERCHANT);
		if(GetField_Double(hRequest,"txn_amt",&dTmp)){
			PutField_Double(hContext,"org_net_amt",dTmp);
		}

		BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
		if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("handle_PayoutCancelBeforeApproved::UpdatePayoutAmount Failed!!!\n"));
ERRLOG("BOPayout::handle_PayoutCancelBeforeApproved:UpdatePayoutAmount Failed!!!\n");
			iRet = INT_ERR;
		}
	}

	if(iRet == PD_OK){
		hash_t  *hOrgTxn;
		hOrgTxn= (hash_t*) malloc (sizeof(hash_t));
		hash_init(hOrgTxn,0);		
		if(GetField_CString(hContext,"org_txn_id",&csTmp)){
			PutField_CString(hOrgTxn,"txn_seq",csTmp);
DEBUGLOG(("org_txn_id[%s]!!!\n",csTmp));

			DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextMgtTxnSeq");
			strcpy(csNewTxnSeq,(*DBObjPtr)());
DEBUGLOG(("csNewTxnSeq [%s]!!!\n",csNewTxnSeq));
			PutField_CString(hContext,"txn_id",csNewTxnSeq);
			PutField_CString(hContext,"new_txn_code","VPO");
			PutField_CString(hContext,"desc","Reverse Payout");
			if(GetField_CString(hContext,"PHDATE",&csTmp)){
                                PutField_CString(hContext,"approval_date",csTmp);
                        }

			iRet = AddTxnLog(hContext);

			if(iRet==PD_OK){
				PutField_Char(hOrgTxn,"status",PD_REVERSED);
				PutField_CString(hOrgTxn,"sub_status",PD_VOID);

				DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
				iRet = (unsigned long) ((*DBObjPtr)(hOrgTxn));
			}

		}
		else{
			iRet=INT_ERR;
		}
		FREE_ME(hOrgTxn);
	}

	if(iRet==PD_OK){
		PutField_CString(hContext,"from_txn_seq",csNewTxnSeq);
		PutField_CString(hContext,"amount_type",PD_CR);
		if(GetField_Double(hRequest,"txn_amt",&dTmp)){
			PutField_Double(hContext,"org_txn_amt",dTmp);
		}
DEBUGLOG(("handle_PayoutCancelApproved::Call BOTxnElements:AddTxnAmtElement\n"));
		BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnAmtElement");
		iRet = (unsigned long)(*BOObjPtr)(hContext);
	}

	if(iRet==PD_OK){
		iRet = UpdateDetail(hContext,hRequest);
	}

	return iRet;	
}


int handle_PayoutCancelGenerated(hash_t *hContext,
			hash_t* hRequest,
			hash_t* hHeader)
{
	int	iRet = PD_OK;
	char	csNewTxnSeq[PD_TXN_SEQ_LEN+1];
	char	csTag[PD_TAG_LEN +1];
	char	*csTmp;
	double	dTmp;
	double	dFee=0.0;

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout::handle_PayoutCancelGenerated()\n"));
	iRet = GetGenFileDetail(hContext,hRequest);

	if(iRet==PD_OK){
		PutField_CString(hRequest,"txn_code",PD_PAYOUT_CANCEL_GENERATED);
		PutField_Char(hContext,"response_mode",PD_REVERSED);
		PutField_Char(hContext,"party_type",PD_TYPE_PSP);

		BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
		if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("handle_PayoutCancelGenerated::UpdatePayoutAmount Failed!!!\n"));
ERRLOG("BOPayout::handle_PayoutCancelGenerated:UpdatePayoutAmount Failed!!!\n");
			iRet = INT_ERR;
		}
	}
	if (iRet == PD_OK) {
		if(GetField_CString(hContext,"org_psp_id",&csTmp)){
			hash_t *hPsp;
			hPsp = (hash_t*) malloc (sizeof(hash_t));
			hash_init(hPsp,0);
			DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
			if (!(*DBObjPtr)(csTmp, hPsp)) {
				if (GetField_CString(hPsp,"client_id",&csTmp)) {
					PutField_CString(hContext,"psp_client_id",csTmp);
DEBUGLOG(("BOPayout::handle_PayoutCancelGenerated: GetTxnPsp - client id = [%s]\n",csTmp));
				}
			}
			FREE_ME(hPsp);
		}
	}


	if(iRet==PD_OK){
		hash_t  *hOrgTxn;
		hOrgTxn= (hash_t*) malloc (sizeof(hash_t));
		hash_init(hOrgTxn,0);		
		if(GetField_CString(hContext,"org_txn_id",&csTmp)){
			PutField_CString(hOrgTxn,"txn_seq",csTmp);
DEBUGLOG(("org_txn_id[%s]!!!\n",csTmp));

			DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextMgtTxnSeq");
			strcpy(csNewTxnSeq,(*DBObjPtr)());
DEBUGLOG(("csNewTxnSeq [%s]!!!\n",csNewTxnSeq));
			PutField_CString(hContext,"txn_id",csNewTxnSeq);
			PutField_CString(hContext,"new_txn_code","VOG");
			PutField_CString(hContext,"desc","Reverse Payout File Generated");
			if(GetField_CString(hContext,"PHDATE",&csTmp)){
                                PutField_CString(hContext,"approval_date",csTmp);
                        }

			iRet = AddTxnLog(hContext);
	
			if(iRet==PD_OK){
				PutField_Char(hOrgTxn,"status",PD_REVERSED);
				PutField_CString(hOrgTxn,"sub_status",PD_VOID);

				DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
				iRet = (unsigned long) ((*DBObjPtr)(hOrgTxn));
			}
			
		}
		else{
			iRet=INT_ERR;
		}

		FREE_ME(hOrgTxn);
	}
	if(iRet==PD_OK){
		PutField_CString(hContext,"from_txn_seq",csNewTxnSeq);
		PutField_CString(hContext,"amount_type",PD_CR);
		PutField_Char(hContext,"party_type",PD_TYPE_PSP);
		if(GetField_CString(hContext,"org_psp_txn_ccy",&csTmp)){
			PutField_CString(hContext,"org_txn_ccy",csTmp);
		}
		if(GetField_Double(hContext,"org_dst_net_amt",&dTmp)){
			GetField_Double(hContext,"precal_fee",&dFee);
			PutField_Double(hContext,"org_txn_amt",dTmp+dFee);
		}
DEBUGLOG(("handle_PayoutCancelGenerated::Call BOTxnElements:AddTxnAmtElement\n"));
		BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnAmtElement");
		iRet = (unsigned long)(*BOObjPtr)(hContext);
	}


	if(iRet==PD_OK){
		PutField_Int(hHeader,"status",PD_PAYOUTFILE_REVERSED);

		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
		if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("handle_PayoutCancelGenerated::PayoutGeneratedFileHD::Update Error!!!\n"));
			iRet = INT_ERR;
		}
	}

	if(iRet==PD_OK){
		int iCnt = 0;
		int i;
		hash_t	*hDetail;
		hDetail= (hash_t*) malloc (sizeof(hash_t));
		hash_init(hDetail,0);
		GetField_Int(hRequest,"total_cnt",&iCnt);
		PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_REVERSED);
		for(i=0;i<iCnt;i++){
			sprintf(csTag,"gen_txn_id_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
				PutField_CString(hDetail,"gen_txn_id",csTmp);
			}
			DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","UpdateByGenId");
			if((unsigned long)(*DBObjPtr)(hDetail)!=PD_OK){
DEBUGLOG(("handle_PayoutCancelGenerated::PayoutGeneratedFileHD::Update Error!!!\n"));
				iRet = INT_ERR;
			}
		}
		FREE_ME(hDetail);
	}

	if(iRet==PD_OK){
		iRet = UpdateDetail(hContext,hRequest);
	}

	if(iRet==PD_OK){
		int iCnt=0;
		int i=0;
		unsigned long lBatchId=0l;
		hash_t  *hTxn, *hRec;
		hTxn= (hash_t*) malloc (sizeof(hash_t));
		hash_init(hTxn,0);
		GetField_Int(hContext,"cancel_batch_cnt",&iCnt);
		for(i=0; i<iCnt; i++){
			sprintf(csTag,"cancel_batch_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
DEBUGLOG(("handle_PayoutCancelGenerated::Update Txn Header sub_status for batch[%s]\n",csTmp));
                		lBatchId = ctol((const unsigned char *)csTmp,strlen(csTmp));

				DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","GetHeader");
				if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
					hRec = RecordSet_GetFirst(rRecordSet);
					while (hRec) {
						if (GetField_CString(hRec,"txn_seq",&csTmp)) {
							PutField_CString(hTxn,"txn_seq",csTmp);
							PutField_CString(hTxn,"sub_status",PD_APPROVED_FOR_GENERATED);
						}
						hRec = RecordSet_GetNext(rRecordSet);
					}
				}

				//Update Txn Header
DEBUGLOG(("handle_PayoutCancelGenerated::Call DBTransaction:Update\n"));
				DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
				if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::DBTransaction:Update Failed\n"));
                		}
			}
		}
		FREE_ME(hTxn);
	}

	if(iRet==PD_OK){
DEBUGLOG(("handle_PayoutCancelGenerated::Call DBTransaction:UpdateDetail\n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK){
                        iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::DBTransaction:UpdateDetail Failed\n"));
                }
        }

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	return iRet;
}

int handle_PayoutIndvCancel(hash_t *hContext,
			     hash_t* hRequest,
			     hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iTmp;
	double	dTmp;
	double	dPspFee=0.0;
	char	*csOrgGenTxnId;
	char	*csTmp;
	char	csNewTxnSeq[PD_TXN_SEQ_LEN +1];
	char	csTag[PD_TAG_LEN +1];
	hash_t	*hRec, *hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	if(GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hTxn,"update_user",csTmp);
	}

	if(GetField_CString(hRequest,"gen_txn_id",&csOrgGenTxnId)){
DEBUGLOG(("handle_PayoutIndvCancel::gen_txn_id = [%s]\n",csOrgGenTxnId));
		PutField_CString(hTxn,"gen_txn_id",csOrgGenTxnId);
		PutField_CString(hContext,"org_txn_id",csOrgGenTxnId);

DEBUGLOG(("handle_PayoutIndvCancel::Call DBPayoutGeneratedFileDT:GetDetailByGenId\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","GetDetailByGenId");
		iRet = (unsigned long)(*DBObjPtr)(csOrgGenTxnId,rRecordSet);
		if(iRet == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if(GetField_Int(hRec,"status",&iTmp)){
					if(iTmp!=PAYOUT_MASTER_TRANSACTION_GENERATED){
						iRet=INT_INVALID_TXN;
						PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("handle_PayoutIndvCancel::invalid status[%d]!!!!!\n",iTmp));
					}
				}
				if(GetField_CString(hRec,"txn_country",&csTmp)){
					PutField_CString(hContext,"org_txn_country",csTmp);
				}
				if(GetField_CString(hRec,"payout_ccy",&csTmp)){
					PutField_CString(hContext,"org_psp_txn_ccy",csTmp);
				}
				if(GetField_CString(hRec,"psp_id",&csTmp)){
					PutField_CString(hContext,"org_psp_id",csTmp);
				}
				if(GetField_Double(hRec,"payout_amount",&dTmp)){
					PutField_Double(hContext,"org_dst_net_amt",dTmp);
				}
				PutField_Char(hContext,"txn_type",PD_TYPE_PAYOUT);
DEBUGLOG(("handle_PayoutIndvCancel::Call BOPsp CalPspCosts\n"));
				BOObjPtr = CreateObj(BOPtr,"BOPsp","CalPspCosts");
				if((unsigned long)(*BOObjPtr)(hContext,hRequest)==PD_OK){
					if(GetField_Double(hContext,"precal_fee",&dTmp)){
DEBUGLOG(("handle_PayoutIndvCancel::payout_fee[%lf]\n",dTmp));
					}
				}
				if(GetField_CString(hRec,"batch_id",&csTmp)){
					sprintf(csTag,"%s_cancel_amt",csTmp);
					PutField_Double(hContext,csTag,dTmp);
DEBUGLOG(("handle_PayoutIndvCancel:: [%s]=[%lf]\n",csTag,dTmp));
				}
				if(GetField_Int(hRec,"seq_num",&iTmp)){
					PutField_CString(hTxn,"psp_id","");
					PutField_CString(hTxn,"generated_file_name","");
					DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","UpdateDetailByBatchId");
					if ((*DBObjPtr)(csTmp,iTmp,hTxn) != PD_OK) {
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutIndvCancel::DBMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
					}
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}

		if(iRet==PD_OK){
			
			PutField_Char(hContext,"response_mode",PD_REVERSED);
			PutField_Char(hContext,"party_type",PD_TYPE_PSP);

			BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
			if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("handle_PayoutIndvCancel::UpdatePayoutAmount Failed!!!\n"));
ERRLOG("BOPayout::handle_PayoutIndvCancel:UpdatePayoutAmount Failed!!!\n");
				iRet = INT_ERR;
			}
		}

		if(iRet==PD_OK){
			DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextMgtTxnSeq");
			strcpy(csNewTxnSeq,(*DBObjPtr)());
DEBUGLOG(("csNewTxnSeq [%s]!!!\n",csNewTxnSeq));
			PutField_CString(hContext,"txn_id",csNewTxnSeq);
			PutField_CString(hResponse,"org_txn_seq",csNewTxnSeq);
			PutField_CString(hContext,"new_txn_code",PD_PAYOUT_INDV_CANCEL);
			PutField_CString(hContext,"desc","Reverse Payout Record Generated");

			iRet = AddTxnLog(hContext);
		}

		if(iRet==PD_OK){
			PutField_CString(hContext,"from_txn_seq",csNewTxnSeq);
			PutField_CString(hContext,"amount_type",PD_CR);
			PutField_Char(hContext,"party_type",PD_TYPE_PSP);
			if(GetField_CString(hContext,"org_psp_txn_ccy",&csTmp)){
				PutField_CString(hContext,"org_txn_ccy",csTmp);
			}
			if(GetField_Double(hContext,"org_dst_net_amt",&dTmp)){
				GetField_Double(hContext,"precal_fee",&dPspFee);
				PutField_Double(hContext,"org_txn_amt",dTmp+dPspFee);
			}
DEBUGLOG(("handle_PayoutIndvCancel::Call BOTxnElements:AddTxnAmtElement\n"));
			BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnAmtElement");
			iRet = (unsigned long)(*BOObjPtr)(hContext);
		}

		if(iRet==PD_OK){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_REV_FOR_REGEN);
			DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","UpdateByGenId");
			if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
				iRet=INT_ERR;
DEBUGLOG(("handle_PayoutIndvCancel::DBPayoutGeneratedFileDT UpdateByGenId Failed!!!\n"));
ERRLOG("BOPayout::handle_PayoutIndvCancel:DBPayoutGeneratedFileDT UpdateByGenId Failed!!!\n");
			}
			
		}
	}
	else{
		iRet=INT_ERR;
DEBUGLOG(("handle_PayoutIndvCancel::gen_txn_id not found!!!!!\n"));
	}

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
	FREE_ME(hTxn);
	return iRet;
}

int handle_PayoutReGenerate(hash_t *hContext,
			     hash_t* hRequest,
			     hash_t* hResponse)
{
	int	iRet = PD_OK;
/*
	DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","GetPreGeneratedDetail");
	if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {
			if(GetField_CString(hRec,"file_id",&csFileId)){
DEBUGLOG(("DBMerchantUploadFileDetail Resume FileId[%s]\n",csFileId));
				DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","ResumePreGenFile");
				iRet = (unsigned long)(*DBObjPtr)(csFileId);

				if(iRet==PD_OK){
DEBUGLOG(("DBPayoutGeneratedFileHD Resume FileId[%s]\n",csFileId));
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Delete");
					iRet = (unsigned long)(*DBObjPtr)(csFileId);
				}
				if(iRet==PD_OK){
DEBUGLOG(("DBPayoutGeneratedFileDT Resume FileId[%s]\n",csFileId));
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","Delete");
					iRet = (unsigned long)(*DBObjPtr)(csFileId);
				}
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}
*/
	if(iRet==PD_OK){
		iRet = GetPayoutRule(hContext,hRequest);
	}

	if(iRet==PD_OK){
		//iRet = ReAssignPsp(hContext,hRequest,hResponse);
	}
/*
	if(iRet==PD_OK){
		recordset_init(rRecordSet,0);
DEBUGLOG(("handle_PayoutReGenerate::Call DBMerchantUploadFileDetail:GetExistingPsp\n"));
       		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetExistingPsp");
		if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
			i = 0;
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec, "psp_id", &csTmp)) {
					sprintf(csTag, "psp_id_%d", i);
					PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetExistingPsp::psp_id = [%s]\n",csTmp));
DEBUGLOG(("handle_PayoutReGenerate::Call CreatePayoutFileDetail\n"));
					if(CreatePayoutFileDetail(csTmp,hContext)!=PD_OK){
						iRet=INT_ERR;
DEBUGLOG(("CreatePayoutFile for[%s] Failed!!!!\n",csTmp));
					}
				}
				i++;
				hRec = RecordSet_GetNext(rRecordSet);
				PutField_Int(hContext,"psp_count",i);
			}
		}

		RecordSet_Destroy(rRecordSet);
		FREE_ME(rRecordSet);
	}
*/
	if(iRet==PD_OK){
		iRet = WriteAssignedRecord(hContext,hRequest);
	}

	if(iRet==PD_OK){
		iRet = UpdateDetail(hContext,hRequest); 
	}
	if(iRet==PD_OK){
		iRet = FormatResponse(hContext,hResponse);
	}

	return iRet;
}

int AddTxnLog(hash_t *hContext)
{
	int iRet= PD_OK;
	char	*csTmp;
	double	dTmp;
	char	cPartyType;
	hash_t	*hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	if (GetField_Char(hContext,"party_type",&cPartyType)) {
DEBUGLOG(("AddTxnLog:: party_type = [%c]\n",cPartyType));
	}
	if (GetField_CString(hContext,"txn_id",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_seq = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_seq",csTmp);
	}
	if (GetField_CString(hContext,"org_txn_id",&csTmp)) {
DEBUGLOG(("AddTxnLog:: org_txn_seq = [%s]\n",csTmp));
		PutField_CString(hTxn,"org_txn_seq",csTmp);
	}
	if (GetField_CString(hContext,"channel_code",&csTmp)) {
DEBUGLOG(("AddTxnLog:: channel_code = [%s]\n",csTmp));
		PutField_CString(hTxn,"channel_code",csTmp);
	}
	if (GetField_CString(hContext,"new_txn_code",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_code = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_code",csTmp);
	}
	if (GetField_CString(hContext,"desc",&csTmp)) {
DEBUGLOG(("AddTxnLog:: desc = [%s]\n",csTmp));
		PutField_CString(hTxn,"desc",csTmp);
	}
	//PutField_CString(hTxn,"txn_code",PD_PAYOUT_GENERATE);
	if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("AddTxnLog:: host_posting_date = [%s]\n",csTmp));
		PutField_CString(hTxn,"host_posting_date",csTmp);
		PutField_CString(hTxn,"transmission_datetime",csTmp);
		PutField_CString(hTxn,"tm_date",csTmp);
		PutField_CString(hTxn,"txn_date",csTmp);
	}
	if (GetField_CString(hContext,"local_tm_date",&csTmp)) {
DEBUGLOG(("AddTxnLog:: local_tm_date = [%s]\n",csTmp));
		PutField_CString(hTxn,"local_tm_date",csTmp);
	}
	if (GetField_CString(hContext,"local_tm_time",&csTmp)) {
DEBUGLOG(("AddTxnLog:: local_tm_time = [%s]\n",csTmp));
		PutField_CString(hTxn,"local_tm_time",csTmp);
	}
	if (GetField_CString(hContext,"approval_date",&csTmp)) {
DEBUGLOG(("AddTxnLog:: approval_date = [%s]\n",csTmp));
                PutField_CString(hTxn,"approval_date",csTmp);
        }
	if (GetField_CString(hContext,"add_user",&csTmp)) {
DEBUGLOG(("AddTxnLog:: add_user = [%s]\n",csTmp));
		PutField_CString(hTxn,"add_user",csTmp);
	}
	else{
		PutField_CString(hTxn,"add_user",PD_UPDATE_USER);
	}


	PutField_CString(hTxn,"process_type","0000");
	PutField_CString(hTxn,"process_code","000000");
	//PutField_CString(hTxn,"desc","Payout Generated");

//Txn Detail
	if (GetField_CString(hContext,"merchant_id",&csTmp)) {
DEBUGLOG(("AddTxnLog:: merchant_id = [%s]\n",csTmp));
		PutField_CString(hTxn,"merchant_id",csTmp);
	}

	if (GetField_CString(hContext,"service_code",&csTmp)) {
DEBUGLOG(("AddTxnLog:: service_code = [%s]\n",csTmp));
		PutField_CString(hTxn,"service_code",csTmp);
	}

	if(GetField_CString(hContext,"merchant_client_id",&csTmp)){
		PutField_CString(hTxn,"client_id",csTmp);
	}
	else if(GetField_CString(hContext,"psp_client_id",&csTmp)){
		PutField_CString(hTxn,"client_id",csTmp);
	}

	if (GetField_CString(hContext,"txn_ccy",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_ccy = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_ccy",csTmp);
	}
	if (GetField_CString(hContext,"txn_country",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_country = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_country",csTmp);
	}
	if(GetField_Double(hContext,"merchant_open_bal",&dTmp)){
		PutField_Double(hTxn,"open_bal",dTmp);
DEBUGLOG(("AddTxnLog:: open_bal= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"current_bal",&dTmp)){
		PutField_Double(hTxn,"current_bal",dTmp);
DEBUGLOG(("AddTxnLog:: current_bal= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_float",&dTmp)){
		PutField_Double(hTxn,"total_float",dTmp);
DEBUGLOG(("AddTxnLog:: total_float= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_reserved_amount",&dTmp)){
		PutField_Double(hTxn,"total_reserved_amount",dTmp);
DEBUGLOG(("AddTxnLog:: total_reserved_amount= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_hold",&dTmp)){
		PutField_Double(hTxn,"total_hold",dTmp);
DEBUGLOG(("AddTxnLog:: total_hold= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"settlement_in_transit",&dTmp)){
		PutField_Double(hTxn,"settlement_in_transit",dTmp);
DEBUGLOG(("AddTxnLog:: settlement_in_transit= [%f]\n",dTmp));
	}

	if(cPartyType==PD_TYPE_MERCHANT){
		if(GetField_Double(hContext,"org_net_amt",&dTmp)){
			PutField_Double(hTxn,"txn_amt",dTmp);
DEBUGLOG(("AddTxnLog:: txn_amt = [%lf]\n",dTmp));
		}
	}


//Txn Psp Detail
	if (GetField_CString(hContext,"org_psp_id",&csTmp)) {
DEBUGLOG(("AddTxnLog:: psp_id = [%s]\n",csTmp));
		PutField_CString(hTxn,"psp_id",csTmp);
	}

	if (GetField_CString(hContext,"org_psp_txn_ccy",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_ccy = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_ccy",csTmp);
	}
	
	if(GetField_Double(hContext,"org_dst_net_amt",&dTmp)){
		PutField_Double(hTxn,"txn_amt",dTmp);
DEBUGLOG(("AddTxnLog:: txn_amt = [%lf]\n",dTmp));
	}

	if(GetField_Double(hContext,"precal_fee",&dTmp)){
		PutField_Double(hTxn,"service_fee",dTmp);
DEBUGLOG(("AddTxnLog:: service_fee = [%lf]\n",dTmp));
	}

/* psp_balance*/
	if (GetField_Double(hContext,"psp_balance",&dTmp)) {
		PutField_Double(hTxn,"bal",dTmp);
DEBUGLOG(("AddTxnLog:: psp_balance = [%f]\n",dTmp));
	}
/* psp_total_float*/
	if (GetField_Double(hContext,"psp_total_float",&dTmp)) {
		PutField_Double(hTxn,"total_float",dTmp);
DEBUGLOG(("AddTxnLog:: psp_total_float = [%f]\n",dTmp));
	}
/* psp_total_hold*/
	if (GetField_Double(hContext,"psp_total_hold",&dTmp)) {
		PutField_Double(hTxn,"total_hold",dTmp);
DEBUGLOG(("AddTxnLog:: psp_total_hold = [%f]\n",dTmp));
	}

	PutField_Char(hTxn,"status",PD_COMPLETE);
	PutField_Char(hTxn,"ar_ind",PD_ACCEPT);
	PutField_Int(hTxn,"internal_code",PD_OK);
	PutField_CString(hTxn,"response_code","0");

	DBObjPtr = CreateObj(DBPtr,"DBTransaction","Add");
	iRet = (unsigned long) ((*DBObjPtr)(hTxn));

	if(iRet == PD_OK){
DEBUGLOG(("AddTxnLog::Call DBTransaction:AddDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("AddTxnLog::DBTransaction:AddDetail Failed\n"));
		}
	}

	if(iRet==PD_OK){
DEBUGLOG(("AddTxnLog::Call DBTransaction:UpdateDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("AddTxnLog::DBTransaction:UpdateDetail Failed\n"));
		}
	}

	if(iRet == PD_OK && cPartyType!=PD_TYPE_MERCHANT){
DEBUGLOG(("AddTxnLog::Call DBTxnPspDetail:Add\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Add");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("AddTxnLog::DBTxnPspDetail:Add Failed\n"));
		}
	}

	if(iRet==PD_OK && cPartyType!=PD_TYPE_MERCHANT){
DEBUGLOG(("AddTxnLog::Call DBTxnPspDetail:Update\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("AddTxnLog::DBTxnPspDetail:Update Failed\n"));
		}
	}

	FREE_ME(hTxn);
	return iRet;
}


int UpdateHeader(hash_t *hContext,
		hash_t* hRequest)
{
	int     iRet  = PD_OK;
	int	iCnt=0;
	int	i=0;
	int	iResult=0;
	//int	iUpdate=PD_FALSE;
	char	*csTmp;
	char	*csTxnCode;
	char	*csTxnId;
	char	*csBatchId;
	char	csTag[PD_TAG_LEN +1];
	unsigned long lBatchId = 0l;
	unsigned long lTmp=0l;
	double	dTmp;
	double	dBatchAmt=0.0;

	hash_t  *hRec;
	hash_t  *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);
	hash_t  *hHeader;
	hHeader = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hHeader,0);

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout::UpdateHeader()\n"));

	///for POU/POA/POC/PCA, only update one batch	
	if(GetField_CString(hRequest,"batch_id",&csTmp)){
		sprintf(csTag,"batch_id_%d",0);
		PutField_CString(hRequest,csTag,csTmp);
		PutField_Int(hRequest,"total_count",1);
	}

	GetField_CString(hRequest,"txn_code",&csTxnCode);
	if(!strcmp(csTxnCode,PD_PAYOUT_APPROVE)){
		/*
 		if(GetField_CString(hContext,"txn_seq",&csTmp))
			PutField_CString(hTxn,"txn_seq",csTmp);
		if(GetField_CString(hContext,"posting_date",&csTmp))
			PutField_CString(hTxn,"posting_date",csTmp);
		*/
		PutField_Int(hTxn,"status",PD_PAYOUTFILE_APPROVED);
 		if(GetField_CString(hContext,"org_txn_id",&csTxnId)){
			PutField_CString(hContext,"txn_seq",csTxnId);
DEBUGLOG(("UpdateHeader::txn_id = [%s]\n",csTxnId));
		}
	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_CONFIRM)){
		PutField_Int(hTxn,"status",PD_PAYOUTFILE_PROCESSING);
	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_GENERATE)){
 		if(GetField_CString(hContext,"org_txn_id",&csTxnId)){
			PutField_CString(hContext,"txn_seq",csTxnId);
DEBUGLOG(("UpdateHeader::txn_id = [%s]\n",csTxnId));
		}
	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_UPLOAD)){
		if(GetField_CString(hContext,"txn_seq",&csTmp))
			PutField_CString(hTxn,"txn_seq",csTmp);
		if(GetField_CString(hContext,"PHDATE",&csTmp))
			PutField_CString(hTxn,"posting_date",csTmp);

	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_APPROVED)){
		PutField_Int(hTxn,"status",PD_PAYOUTFILE_REVERSED);
	}
	
	
	if(GetField_Int(hRequest,"total_count",&iCnt)){
DEBUGLOG(("UpdateHeader::total_count= [%d]\n",iCnt));
	}
	for(i=0; i<iCnt; i++){
		dBatchAmt=0;
		sprintf(csTag, "batch_id_%d", i);
		GetField_CString(hRequest,csTag,&csBatchId);
		PutField_CString(hTxn,"batch_id",csBatchId);

		lBatchId = ctol((const unsigned char *)csBatchId,strlen(csBatchId));
		if (lTmp==lBatchId)
			continue;

		lTmp = lBatchId;

        	recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","GetHeader");
		if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec,"txn_seq",&csTmp)) {
					//PutField_CString(hHeader,"txn_seq",csTmp);
DEBUGLOG(("UpdateHeader::org_txn_seq = [%s]\n",csTmp));
				}
				if(GetField_Double(hRec,"txn_amt",&dTmp)){
					if(!strcmp(csTxnCode,PD_PAYOUT_APPROVE)){
						PutField_Double(hTxn,"remain_amt",dTmp);
					}
				}
				if(GetField_Double(hRec,"remain_amt",&dTmp)){
					if(!strcmp(csTxnCode,PD_PAYOUT_GENERATE)){
						sprintf(csTag, "%s_total_amt",csBatchId);
						GetField_Double(hContext,csTag,&dBatchAmt);
DEBUGLOG(("UpdateHeader::[%s] = [%lf]\n",csTag,dBatchAmt));
						dTmp -= dBatchAmt;
						PutField_Double(hTxn,"remain_amt",dTmp);
DEBUGLOG(("UpdateHeader::remain_amt = [%lf]\n",dTmp));
					}
					else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_GENERATED)||
						!strcmp(csTxnCode,PD_PAYOUT_INDV_CANCEL)){
						sprintf(csTag, "%s_cancel_amt",csBatchId);
						GetField_Double(hContext,csTag,&dBatchAmt);
DEBUGLOG(("UpdateHeader::[%s] = [%lf]\n",csTag,dBatchAmt));
						dTmp += dBatchAmt;
						PutField_Double(hTxn,"remain_amt",dTmp);
DEBUGLOG(("UpdateHeader::remain_amt = [%lf]\n",dTmp));
					}
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}

		if(!strcmp(csTxnCode,PD_PAYOUT_GENERATE) || !strcmp(csTxnCode,PD_PAYOUT_CANCEL_GENERATED)){
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","MatchCount");
			if(!strcmp(csTxnCode,PD_PAYOUT_GENERATE)){
				iResult = (unsigned long) ((*DBObjPtr)(lBatchId,PAYOUT_MASTER_TRANSACTION_GENERATED));
				if(iResult!=PD_ERR && iResult!=PD_NOT_FOUND){
					if(iResult==PD_TRUE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_GENERATED);
					else if (iResult==PD_FALSE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_PARTIAL_GENERATED);

					PutField_CString(hContext,"sub_status",PD_APPROVED_AND_GENERATED);
					//PutField_CString(hHeader,"sub_status",PD_APPROVED_AND_GENERATED);
					//iUpdate=PD_TRUE;
				}
			}
			else{
				iResult = (unsigned long) ((*DBObjPtr)(lBatchId,PAYOUT_MASTER_TRANSACTION_APPROVED));
				if(iResult!=PD_ERR && iResult!=PD_NOT_FOUND){
					if(iResult==PD_TRUE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_APPROVED);
					else if (iResult==PD_FALSE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_PARTIAL_GENERATED);

					PutField_CString(hContext,"sub_status",PD_APPROVED_FOR_GENERATED);
					//PutField_CString(hHeader,"sub_status",PD_APPROVED_FOR_GENERATED);
					//iUpdate=PD_TRUE;
				}
			}
/*
			if(iUpdate==PD_TRUE){
DEBUGLOG(("handle_PayoutApprove::Call DBTransaction:Update\n"));
				DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
				if((unsigned long) ((*DBObjPtr)(hHeader))!=PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("handle_PayoutApprove::DBTransaction:UpdateDetail Failed\n"));
				}
			}
*/
		}
DEBUGLOG(("UpdateHeader::DBMerchantUploadFileHeader:UpdateHeader\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","UpdateHeader");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("UpdateHeader::DBMerchantUploadFileHeader:UpdateHeader Failed\n"));
		}
	}

	FREE_ME(hTxn);
	FREE_ME(hHeader);
	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
DEBUGLOG(("BOPayout::UpdateHeader() iRet=[%d]\n",iRet));
	return  iRet;
}


int GetPayoutRecords(const unsigned long lBatchId,
			hash_t *hContext,
			hash_t* hRequest)
{
	int	iRet  = PD_OK;
	int	iStatus = 0;
	int	iSeqNum = 0;
	int	iIntErr= PD_OK;
	int	i= 0;
	char	*csMerchantId;
	char	*csServiceCode;
	char	*csTxnCountry=strdup("");
	char	*csTxnCcy;
	char	*csTxnId;
	char	*csTmp;
	double	dTmp=0.0;
	double	dTotalAmt=0.0;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout:GetPayoutRecords()\n"));

DEBUGLOG(("BOPayout::Call DBMerchantUploadFileHeader:GetHeader\n"));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","GetHeader");
	if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
DEBUGLOG(("GetHeader::found record = [%ld]\n",lBatchId));
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if (GetField_CString(hRec,"txn_seq",&csTxnId)) {
				PutField_CString(hContext,"org_txn_id",csTxnId);
DEBUGLOG(("GetHeader::org_txn_seq = [%s]\n",csTxnId));
			}
			if (GetField_Double(hRec,"txn_amt",&dTmp)) {
				PutField_Double(hRequest,"txn_amt",dTmp);
DEBUGLOG(("GetHeader::txn_amt = [%lf]\n",dTmp));
			}
			if (GetField_CString(hRec,"merchant_id",&csMerchantId)) {
				PutField_CString(hRequest,"merchant_id",csMerchantId);
				PutField_CString(hContext,"merchant_id",csMerchantId);
				PutField_CString(hContext,"org_merchant_id",csMerchantId);
DEBUGLOG(("GetHeader::merchant_id= [%s]\n",csMerchantId));
			}
			else{
				iRet = INT_MERCHANT_ID_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetHeader::merchant_id not found\n"));
			}
			if (GetField_CString(hRec,"service_code",&csServiceCode)) {
				PutField_CString(hRequest,"service_code",csServiceCode);
				PutField_CString(hContext,"service_code",csServiceCode);
				PutField_CString(hContext,"org_service_code",csServiceCode);
DEBUGLOG(("GetHeader::service_code= [%s]\n",csServiceCode));

				DBObjPtr = CreateObj(DBPtr,"DBService","FindCountryByService");
				if ((unsigned long)(DBObjPtr)(csServiceCode,csTxnCountry) == FOUND) {
DEBUGLOG(("GetHeader::txn_country= [%s]\n",csTxnCountry));
					PutField_CString(hRequest,"txn_country",csTxnCountry);
					PutField_CString(hContext,"txn_country",csTxnCountry);
					PutField_CString(hContext,"org_txn_country",csTxnCountry);
				}

				DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","ChkRuleExists");
				if ((unsigned long)(DBObjPtr)(csMerchantId,csServiceCode) == PD_FOUND) {
					PutField_Char(hRequest,"batch_mode",PD_ONLINE);

					char*   csPspTmp;
					csPspTmp = (char*) malloc (128);
					DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","FindPsp");
					if ((unsigned long)(DBObjPtr)(csMerchantId,csServiceCode,csPspTmp) == PD_FOUND) {
						PutField_CString(hRequest,"psp_id",csPspTmp);
					}
					FREE_ME(csPspTmp);
				}
				else{
					PutField_Char(hRequest,"batch_mode",PD_OFFLINE);
				}
			}
			else{
				iRet = INT_SERVICE_CODE_MISSING;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetHeader::service_code not found\n"));
			}
			if (GetField_Int(hRec,"status",&iStatus)){
DEBUGLOG(("GetHeader::status= [%d]\n",iStatus));
				PutField_Int(hRequest,"status",iStatus);
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}
	else{
DEBUGLOG(("GetHeader:: not found record for [%ld]\n",lBatchId));
ERRLOG("BOPayout::GetPayoutRecords() GetHeader::not found record!!\n");
		iRet=INT_NOT_RECORD;
		//PutField_Int(hContext,"internal_error",iRet);
	}
	RecordSet_Destroy(rRecordSet);

	if(iRet==PD_OK){	
		BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantDetail");
                if((unsigned long)(*BOObjPtr)(hContext,hRequest)==PD_OK){
			if(GetField_CString(hContext,"merchant_client_id",&csTmp)){
DEBUGLOG(("GetMerchantDetail::client_id= [%s]\n",csTmp));
			}
		}
	}

	if(iRet==PD_OK){
		recordset_init(rRecordSet,0);
DEBUGLOG(("BOPayout::Call DBMerchantUploadFileDetail:GetDetail\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetail");
                if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
                        i = 0;
DEBUGLOG(("GetDetail::found record = [%ld]\n",lBatchId));
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
                                iIntErr = PD_OK;
                                if(GetField_Int(hRec,"seq_num",&iSeqNum)){
                                        sprintf(csTag,"seq_num_%d",i);
                                        PutField_Int(hRequest,csTag,iSeqNum);
DEBUGLOG(("GetDetail::seq_num= [%i]\n",iSeqNum));
                                }
                                if (!GetField_CString(hRec,"txn_country",&csTmp)) {
                                        sprintf(csTag,"txn_country_%d",i);
                                        PutField_CString(hRequest,csTag,csTxnCountry);
                                }
                                if (GetField_CString(hRec,"payout_ccy",&csTmp)){
                                        if(strcmp(csTmp,"RMB"))
                                                csTxnCcy = strdup(csTmp);
                                        else
                                                csTxnCcy = strdup(PD_CCY_ISO_CNY);

                                        sprintf(csTag,"dst_txn_ccy_%d",i);
                                        PutField_CString(hRequest,csTag,csTxnCcy);
                                        PutField_CString(hRequest,"txn_ccy",csTxnCcy);
                                        PutField_CString(hContext,"txn_ccy",csTxnCcy);
                                        PutField_CString(hContext,"org_txn_ccy",csTxnCcy);
DEBUGLOG(("GetDetail::payout_ccy= [%s]\n",csTmp));
                                        FREE_ME(csTxnCcy);
                                }

				if(GetField_CString(hRec,"request_ccy",&csTmp)){
                                        if(strcmp(csTmp,"RMB"))
                                                csTxnCcy = strdup(csTmp);
                                        else
                                                csTxnCcy = strdup(PD_CCY_ISO_CNY);

                                        sprintf(csTag,"txn_ccy_%d",i);
                                        PutField_CString(hRequest,csTag,csTxnCcy);
                                        PutField_CString(hRequest,"txn_ccy",csTxnCcy);
                                        //PutField_CString(hContext,"txn_ccy",csTxnCcy);
                                        PutField_CString(hContext,"org_txn_ccy",csTxnCcy);
DEBUGLOG(("GetDetail::request_ccy= [%s]\n",csTxnCcy));
					FREE_ME(csTxnCcy);
                                }
                                else{
                                        iIntErr = INT_CURRENCY_CODE_NOT_FOUND;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetDetail::ccy not found\n"));
                                }

				if (GetField_Double(hRec,"request_amount",&dTmp)) {
					sprintf(csTag,"txn_amt_%d",i);
                                        PutField_Double(hRequest,csTag,dTmp);
					dTotalAmt += dTmp;
DEBUGLOG(("GetDetail::request_amount= [%lf]\n",dTmp));
                                }
                                if (GetField_Double(hRec,"payout_amount",&dTmp)) {
					//sprintf(csTag,"payout_amount_%d",i);
                                        //PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetDetail::payout_amount= [%lf]\n",dTmp));
                                }
				if (GetField_CString(hRec,"bank_name",&csTmp)){
					sprintf(csTag,"bank_name_%d",i);
                                        PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetDetail::bank_name= [%s]\n",csTmp));
                                }
                                if (GetField_CString(hRec,"bank_code",&csTmp)){
					sprintf(csTag,"bank_code_%d",i);
                                        PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetDetail::bank_code= [%s]\n",csTmp));
				}

                                sprintf(csTag,"int_error_%d",i);
                                PutField_Int(hRequest,csTag,iIntErr);

                                i++;
                                PutField_Int(hRequest,"total_count",i);
                                PutField_Double(hRequest,"total_txn_amt",dTotalAmt);

				hRec = RecordSet_GetNext(rRecordSet);
                        }

                }
                else{
DEBUGLOG(("GetDetail:: not found record for [%ld]\n",lBatchId));
ERRLOG("BOPayout::GetPayoutRecords::GetDetail::not found record!!\n");
                        iRet=INT_NOT_RECORD;
			//PutField_Int(hContext,"internal_error",iRet);
                }

	}

	if(i==0){
DEBUGLOG(("GetDetail::no record for [%ld]\n",lBatchId));
		iRet = INT_NO_PENDING_RECORD;
		//PutField_Int(hContext,"internal_error",iRet);
	}

	FREE_ME(csTxnCountry);	
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
DEBUGLOG(("BOPayout:GetPayoutRecords() iRet=[%d]\n",iRet));
	return	iRet;
}

int UpdateDetail(hash_t *hContext,
		hash_t* hRequest)
{
	int     iRet = PD_OK;
	int	iCnt = 0;
	int	i = 0;
	int	iSeqNum = 0;
	int	iIntErr= PD_OK;
	char	*csBatchId;
	char	*csTxnCode;
	char	*csTmp;
	char	cTmp;
	double	dTmp=0.0;
	char	csTag[PD_TAG_LEN +1];
	char    csResp[PD_RESPONSE_CODE_LEN +1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	if (GetField_CString(hRequest,"batch_id",&csBatchId)){
DEBUGLOG(("BOPayout::UpdateDetail for batch[%s]\n",csBatchId));
	}
	if (GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hTxn,"update_user",csTmp);
	}
	
	
	if(GetField_CString(hRequest,"txn_code",&csTxnCode)){
		if(!strcmp(csTxnCode,PD_PAYOUT_CONFIRM)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_PENDING);
		}
		else if(!strcmp(csTxnCode,PD_PAYOUT_APPROVE)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_APPROVED);
			//iRet=GenerateBatchSeq(hRequest);
		}
		else if(!strcmp(csTxnCode,PD_PAYOUT_GENERATE)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
		}
		else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_GENERATED)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_APPROVED);
		}
		else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_APPROVED)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_REVERSED);
		}
	}

	if(GetField_Char(hRequest,"batch_mode",&cTmp)){
		PutField_Char(hTxn,"batch_mode",cTmp);
	}
	if(GetField_CString(hRequest,"psp_id",&csTmp)){
		PutField_CString(hTxn,"psp_id",csTmp);
	}

	GetField_Int(hRequest,"total_count", &iCnt);
	for(i=0; i<iCnt; i++){
		sprintf(csTag,"batch_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csBatchId)){
DEBUGLOG(("BOPayout::UpdateDetail for batch[%s]\n",csBatchId));
		}
		sprintf(csTag,"seq_num_%d",i);
		if(GetField_Int(hRequest,csTag,&iSeqNum)){
DEBUGLOG(("BOPayout::UpdateDetail seq_num[%d]\n",iSeqNum));
		}
		else{
DEBUGLOG(("BOPayout::UpdateDetail seq_num is missing!!!\n"));
			continue;
		}

		sprintf(csTag,"txn_seq_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_seq",csTmp);
		}
		sprintf(csTag,"psp_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"psp_id",csTmp);
		}
		sprintf(csTag,"txn_country_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_country",csTmp);
		}
		sprintf(csTag,"payout_amt_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"payout_amt",dTmp);
		}
		sprintf(csTag,"txn_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"merchant_fee_ccy",csTmp);
		}
		sprintf(csTag,"dst_txn_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"member_fee_ccy",csTmp);
		}
		sprintf(csTag,"member_fee_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"member_fee",dTmp);
		}
		sprintf(csTag,"merchant_fee_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"merchant_fee",dTmp);
		}
		sprintf(csTag,"markup_amt_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"markup_amt",dTmp);
		}
		sprintf(csTag,"markup_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"markup_ccy",csTmp);
		}
		sprintf(csTag,"ex_rate_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"ex_rate",dTmp);
		}
		sprintf(csTag,"generated_file_name_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"generated_file_name",csTmp);
		}
		sprintf(csTag,"file_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"file_id",csTmp);
		}

		sprintf(csTag,"int_error_%d",i);
		if(GetField_Int(hRequest,csTag,&iIntErr)){
			sprintf(csResp,"%d",iIntErr);
			PutField_CString(hTxn,"resp_code",csResp);
			if(iIntErr!=PD_OK){
				//PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_DECLINED);
			}
		}

		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","UpdateDetailByBatchId");
		if ((*DBObjPtr)(csBatchId,iSeqNum,hTxn) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOPayout::DBMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
		}

	}

DEBUGLOG(("BOPayout:UpdateDetail iRet=[%d]\n",iRet));
	FREE_ME(hTxn);
	return  iRet;
}

int InsertGenFileDT(const hash_t* hRequest)
{
	int     iRet = PD_OK;
	int	iCnt = 0;
	int	i = 0;
	int	iTmp = 0;
	char	*csTmp;
	double	dTmp=0.0;
	char	csTag[PD_TAG_LEN +1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	
DEBUGLOG(("BOPayout:InsertGenFileDT\n"));
	GetField_Int(hRequest,"total_count", &iCnt);
	for(i=0; i<iCnt; i++){
		sprintf(csTag,"batch_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"batch_id",csTmp);
		}
		sprintf(csTag,"seq_num_%d",i);
		if(GetField_Int(hRequest,csTag,&iTmp)){
			PutField_Int(hTxn,"seq_num",iTmp);
		}
		sprintf(csTag,"txn_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_id",csTmp);
		}
		sprintf(csTag,"file_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"file_id",csTmp);
		}
		sprintf(csTag,"txn_country_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_country",csTmp);
		}
		sprintf(csTag,"request_amount_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"request_amount",dTmp);
		}
		sprintf(csTag,"payout_amount_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"payout_amount",dTmp);
		}
		sprintf(csTag,"request_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"request_ccy",csTmp);
		}
		sprintf(csTag,"payout_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"payout_ccy",csTmp);
		}
		sprintf(csTag,"account_name_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"account_name",csTmp);
		}
		sprintf(csTag,"account_num_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"account_num",csTmp);
		}
		sprintf(csTag,"bank_name_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"bank_name",csTmp);
		}
		sprintf(csTag,"branch_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"branch",csTmp);
		}
		sprintf(csTag,"identity_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"identity_id",csTmp);
		}
		sprintf(csTag,"phone_num_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"phone_num",csTmp);
		}
		sprintf(csTag,"merchant_ref_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"merchant_ref",csTmp);
		}
		sprintf(csTag,"province_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"province",csTmp);
		}
		sprintf(csTag,"city_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"city",csTmp);
		}

	
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","Add");
		if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("InsertGenFileDT::DBPayoutGeneratedFileDT:Add Failed\n"));
		}
	}	

	FREE_ME(hTxn);
DEBUGLOG(("BOPayout:InsertGenFileDT iRet=[%d]\n",iRet));
	return  iRet;
}

int CheckAvalBalance(hash_t *hContext,
		     const hash_t* hRequest)
{	
	int	iRet = PD_OK;
	double	dTotalSrcNetAmt = 0.0;
	double	dActualPayoutBal = 0.0;
	double	dAvalPayoutBal = 0.0;

DEBUGLOG(("CheckAvalBalance::Call BOBalance:GetAvalPayoutBalance\n"));
	BOObjPtr = CreateObj(BOPtr,"BOBalance","GetAvalPayoutBalance");
	if((unsigned long)(*BOObjPtr)(hContext,
				hRequest,
				&dActualPayoutBal,
				&dAvalPayoutBal)==PD_OK){
DEBUGLOG(("CheckAvalBalance::GetAvalBalance for payout=[%f]\n",dActualPayoutBal));
	}
	else{
DEBUGLOG(("CheckAvalBalance::GetAvalPayoutBalance Error\n"));
ERRLOG("BOPayout::CheckAvalBalance::GetAvalPayoutBalance Error!!\n");
		iRet = INT_ERR;
	}

	if(iRet==PD_OK){
		if(GetField_Double(hContext,"net_amt",&dTotalSrcNetAmt)){
			if(dAvalPayoutBal<dTotalSrcNetAmt){
				iRet=INT_INSUFFICIENT_FUND;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("CheckAvalBalance::Aval Payout Amt[%f] < Request Net Amt[%f]\n",dActualPayoutBal,dTotalSrcNetAmt));
ERRLOG("BOPayout::CheckAvalBalance::insufficient aval payout balance!!\n");
			}
		}
	}

	return  iRet;
}

int GetPayoutFee(hash_t *hContext,
		 hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iIntErr = PD_OK;
	int	i= 0;
	int	iCnt= 0;
	double	dTmp= 0.0;
	double	dTotalSrcNetAmt = 0.0;
	double	dTotalDstNetAmt = 0.0;
	char	*csTmp;
	char	csTag[PD_TAG_LEN +1];

DEBUGLOG(("BOPayout:GetPayoutFee()\n"));
	PutField_CString(hContext,"txn_code",PD_WITHDRAW_BATCH_TXN_CODE);
	PutField_CString(hContext,"channel_code",PD_CHANNEL_WEB);

	GetField_Int(hRequest,"total_count", &iCnt);
	for(i=0; i<iCnt; i++){
		sprintf(csTag,"txn_seq_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hContext,"from_txn_seq",csTmp);
		}
		sprintf(csTag,"txn_amt_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hContext,"txn_amt",dTmp);
		}
		sprintf(csTag,"txn_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hRequest,"txn_ccy",csTmp);
		}
		sprintf(csTag,"dst_txn_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hContext,"dst_txn_ccy",csTmp);
		}

DEBUGLOG(("GetPayoutFee::Call BOExchange:GetExchangeInfo\n"));
		BOObjPtr = CreateObj(DBPtr,"BOExchange","GetExchangeInfo");
		if ((*BOObjPtr)(hContext,hRequest) == PD_OK) {
DEBUGLOG(("GetPayoutFee::GetExternalExchangeInfo Success\n"));
			if(GetField_Double(hContext,"dst_txn_amt",&dTmp)){
DEBUGLOG(("GetPayoutFee::Destination Amount=[%lf]\n",dTmp));
			}
			if(GetField_CString(hContext,"markup_ccy",&csTmp)){
				sprintf(csTag,"markup_ccy_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetPayoutFee::Markup Ccy=[%s]\n",csTmp));
			}
			if(GetField_Double(hContext,"markup_amt",&dTmp)){
				sprintf(csTag,"markup_amt_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::Markup Amount=[%lf]\n",dTmp));
			}
			if(GetField_Double(hContext,"markup_rate",&dTmp)){
DEBUGLOG(("GetPayoutFee::Markup rate=[%lf]\n",dTmp));
			}
			if(GetField_Double(hContext,"ex_rate",&dTmp)){
				sprintf(csTag,"ex_rate_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::Exchange rate=[%lf]\n",dTmp));
			}
		}
		else{
			iIntErr = INT_ERR;
DEBUGLOG(("GetPayoutFee:::GetExchangeInfo Error\n"));
ERRLOG("BOPayout:GetPayoutFee::::GetExchangeInfo Error\n");
		}

DEBUGLOG(("GetPayoutFee::Call BOFee:GetTxnFee\n"));
		BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
		if((unsigned long)(*BOObjPtr)(hContext,hRequest)==PD_OK){
			if(GetField_Double(hContext,"src_txn_fee",&dTmp)){
				sprintf(csTag,"merchant_fee_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::src txn fee=[%f]\n",dTmp));
			}
			if(GetField_Double(hContext,"net_amt",&dTmp)){
				dTotalSrcNetAmt += dTmp;
DEBUGLOG(("GetPayoutFee::src net amt=[%f]\n",dTmp));
			}
			if(GetField_Double(hContext,"dst_txn_fee",&dTmp)){
				sprintf(csTag,"member_fee_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::dst txn fee=[%f]\n",dTmp));
			}
			if(GetField_Double(hContext,"dst_net_amt",&dTmp)){
				sprintf(csTag,"payout_amt_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
				dTotalDstNetAmt += dTmp;

DEBUGLOG(("GetPayoutFee::dst net amt=[%lf]\n",dTmp));
DEBUGLOG(("GetPayoutFee::total dst net amt for [%s]=[%lf]\n",csTmp,dTotalDstNetAmt));
			}


			/*Add TxnFeeElements*/
			BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnFeeElements");
			iRet = (unsigned long)(*BOObjPtr)(hContext);
		}
		else{
			iIntErr = INT_ERR;
DEBUGLOG(("GetPayoutFee::GetTxnFee Error\n"));
ERRLOG("BOPayout::GetPayoutFee:GetTxnFee Error\n");
		}

		sprintf(csTag,"int_error_%d",i);
		PutField_Int(hRequest,csTag,iIntErr);
	}

	if(GetField_Double(hRequest,"total_txn_amt",&dTmp)){
		PutField_Double(hContext,"txn_amt",dTmp);
	}
	PutField_Double(hContext,"net_amt",dTotalSrcNetAmt);	
	PutField_Double(hContext,"org_net_amt",dTotalSrcNetAmt);	
	PutField_Double(hContext,"dst_txn_amt",dTotalDstNetAmt);	

	PutField_CString(hContext,"txn_code",PD_PAYOUT_APPROVE);
	PutField_CString(hContext,"channel_code",PD_CHANNEL_MGT);

DEBUGLOG(("BOPayout:GetPayoutFee() iRet=[%d]\n",iRet));
	return 	iRet;
}

int GetPayoutPsp(hash_t *hContext,
                const hash_t* hRequest)
{
	int	iRet = PD_OK;
	hash_t  *hRec;

	char	csTag[PD_TMP_BUF_LEN+1];
	char	*csBankName;
	char	*csPspId;
	char	*csOperType;
	double	dOrgTxnAmt;
	double	dPspAmt=0.0;
	double	dTotalPayoutAmt=0.0;
	double	dTierAmt=0.0;
	double	dPct=0.0;
	double	dMinAmt=0.0;
	double	dMaxAmt=0.0;
	int	iTier = 0;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout:GetPayoutPsp()\n"));

 	if (GetField_CString(hContext,"bank_name",&csBankName)) {
DEBUGLOG(("BOPayout::GetPayoutPsp() bank_name = [%s]\n",csBankName));
        }
        else {
DEBUGLOG(("BOPayout::GetPayoutPsp() bank_name not found!!!\n"));
		iRet = INT_BANK_CODE_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
        }

 	if (GetField_Double(hContext,"txn_amt",&dOrgTxnAmt)) {
DEBUGLOG(("BOPayout::GetPayoutPsp() txn_amt = [%lf]\n",dOrgTxnAmt));
        }
        else {
DEBUGLOG(("BOPayout::GetPayoutPsp() txn_amt not found!!!\n"));
		iRet = INT_TXN_AMT_MISSING;
		PutField_Int(hContext,"internal_error",iRet);
        }

	if (GetField_CString(hContext,"operator_type",&csOperType)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() operator_type = [%s]\n",csOperType));
	}
	if (GetField_CString(hContext,"psp_id",&csPspId)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() psp_id = [%s]\n",csPspId));
	}
	if (GetField_Double(hContext,"total_amt",&dPspAmt)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() total_amt = [%f]\n",dPspAmt));
	}

	sprintf(csTag,"%s_total_payout_amt_%s",csPspId,csBankName);
 	if (GetField_Double(hContext,csTag,&dTotalPayoutAmt)) {
DEBUGLOG(("BOPayout::GetPayoutPsp() org total_payout_amt = [%lf]\n",dTotalPayoutAmt));
        }


	if(iRet == PD_OK){
//RuleOperatorTypeDetail:GetRuleOperatorTypeDetail()
		DBObjPtr = CreateObj(DBPtr,"DBRuleOperatorTypeDetail","GetRuleOperatorTypeDetail");
		if ((unsigned long)(*DBObjPtr)(csOperType, rRecordSet)==PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if (GetField_Double(hRec,"amt_min",&dMinAmt)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() amount_min = [%f]\n",dMinAmt));
				}
				if (GetField_Double(hRec,"amt_max",&dMaxAmt)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() amount_max = [%f]\n",dMaxAmt));
				}

				if(dOrgTxnAmt>=dMinAmt && dOrgTxnAmt<=dMaxAmt){
					if (GetField_Int(hRec,"tier_id",&iTier)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() tier_id = [%d]\n",iTier));
					}
					if (GetField_Double(hRec,"amt_pct",&dPct)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() amount_pct = [%lf]\n",dPct));
DEBUGLOG(("BOPayout:GetPayoutPsp() amount for tier[%d] = [%lf]\n",iTier,(dPspAmt*dPct/100)));
					}
				}

				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	if(iRet == PD_OK){
//no rules
		if(!strcmp(csOperType,PD_NO_RULE)){
			//do nothing
		}

//Less Than or Daily Limit
		else if(!strcmp(csOperType,PD_LESS_THAN) || !strcmp(csOperType,PD_DAILY_LIMIT)){
			if((dTotalPayoutAmt + dOrgTxnAmt) >= dPspAmt){
DEBUGLOG(("BOPayout:GetPayoutPsp() Payout Amt[%lf] >= Limited PSP Amt[%f]!!!\n",(dTotalPayoutAmt + dOrgTxnAmt),dPspAmt));
//ERRLOG("Payout amount exceeded limited psp amount!!!\n");
				iRet = INT_EXCEED_LIMIT_PSP_AMT;
				PutField_Int(hContext,"internal_error",iRet);
			}
			else{
				sprintf(csTag,"%s_total_payout_amt_%s",csPspId,csBankName);
				PutField_Double(hContext,csTag,(dTotalPayoutAmt+dOrgTxnAmt));
DEBUGLOG(("BOPayout::GetPayoutPsp() %s (org) = [%lf], (new) = [%lf]\n",csTag,dTotalPayoutAmt,(dTotalPayoutAmt+dOrgTxnAmt)));
			}
		}

//customer rules
		else{
			sprintf(csTag,"%s_tier_%d_amt_%s",csPspId,iTier,csBankName);
 			if (GetField_Double(hContext,csTag,&dTierAmt)) {
        		}
DEBUGLOG(("BOPayout::GetPayoutPsp() %s (org) = [%lf], (new) = [%lf]\n",csTag,dTierAmt,(dTierAmt+dOrgTxnAmt)));

			if((dTierAmt+dOrgTxnAmt)>(dPspAmt*dPct/100)){
DEBUGLOG(("BOPayout:GetPayoutPsp() Payout Amt[%lf] > Limited PSP Amt[%f]!!!\n",(dTierAmt+dOrgTxnAmt),(dPspAmt*dPct/100)));
//ERRLOG("Payout amount exceeded limited psp amount!!!\n");
				iRet = INT_EXCEED_LIMIT_PSP_AMT;
				PutField_Int(hContext,"internal_error",iRet);
			}
			else{
				PutField_Double(hContext,csTag,(dTierAmt+dOrgTxnAmt));
			}

			
		}
	}

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("BOPayout:GetPayoutPsp() exit = [%d]\n",iRet));
	return iRet;
}


int GetPayoutRule(hash_t *hContext,
		  hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iCnt = 0;
	int	iBank = PD_FALSE;
	double	dTmp=0.0;
	char	csBankName[PD_BANK_NAME_LEN+1];
	char	*csTmp;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout:GetPayoutRule()\n"));
DEBUGLOG(("BOPayout::Call DBRulePayoutPsp:GetRulePayoutPspWithPriority\n"));
	DBObjPtr = CreateObj(DBPtr,"DBRulePayoutPsp","GetRulePayoutPspWithPriority");
	if ((unsigned long)(*DBObjPtr)(rRecordSet) == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		iCnt = 0;
		while (hRec) {
			iBank=PD_FALSE;
			if (GetField_CString(hRec, "bank_name", &csTmp)) {
				strcpy(csBankName,TrimAllChar((const unsigned char*)csTmp,strlen(csTmp),PD_SPACE));
				if(strlen(csBankName)>0){
                                        //PutField_CString(hContext,"bank_name",csBankName);
                                        if(strcmp(csBankName,"*")){
                                                sprintf(csTag,"bank%d_bank_name",iCnt);
                                                PutField_CString(hRequest,csTag,csBankName);
                                                iBank=PD_TRUE;
DEBUGLOG(("GetRulePayoutPspWithPriority::bank_name = [%s]\n",csBankName));
                                        }
                                        else{
DEBUGLOG(("GetRulePayoutPspWithPriority::All Bank\n"));
                                        }
                                }
			}
			if (GetField_CString(hRec, "psp_id", &csTmp)) {
				sprintf(csTag,"bank%d_psp_id",iCnt);
				PutField_CString(hRequest,csTag,csTmp);
//DEBUGLOG(("GetRulePayoutPspWithPriority::psp_id = [%s]\n",csTmp));

				/***For testing***/
				sprintf(csTag,"%s_split_amt",csTmp);
				PutField_Double(hContext,csTag,PD_TMP_SPLIT_AMT);
			}
			if (GetField_CString(hRec, "operator_type", &csTmp)) {
				sprintf(csTag,"bank%d_operator_type",iCnt);
				PutField_CString(hRequest,csTag,csTmp);
				//PutField_CString(hContext,"operator_type",csTmp);
//DEBUGLOG(("GetRulePayoutPspWithPriority::operator_type = [%s]\n",csTmp));
			}
			if (GetField_Double(hRec, "total_amt", &dTmp)) {
				sprintf(csTag,"bank%d_total_amt",iCnt);
				PutField_Double(hRequest,csTag,dTmp);
				//PutField_Double(hContext,"total_amt",dTmp);
//DEBUGLOG(("GetRulePayoutPspWithPriority::total_amt = [%lf]\n",dTmp));
			}
			sprintf(csTag,"bank%d_present",iCnt);
			PutField_Int(hRequest,csTag,iBank);

			iCnt++;
			hRec = RecordSet_GetNext(rRecordSet);

			PutField_Int(hRequest,"bank_cnt",iCnt);
		}
	}
	else{
DEBUGLOG(("GetRulePayoutPspWithPriority::not found record!!\n"));
ERRLOG("BOPayout::GetPayoutRule:GetRulePayoutPspWithPriority::not found record!!\n");
		iRet=INT_ERR;
	}
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
DEBUGLOG(("BOPayout:GetPayoutPsp() iRet=[%d]\n",iRet));
	return iRet;
}



int AssignPsp(hash_t *hContext,
	      hash_t* hRequest,
	      hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iCnt = 0;
	int	i = 0;
	int	iTotal = 0;
	int	iTmp = 0;
	int	iResult = 0;
	int	iSeqNum = 0;
	int	iBank = PD_FALSE;
	int	iMerch = PD_FALSE;
	int	iResCnt = 0;
	int	iStatus = PD_FALSE;
	double	dResAmt = 0.0;
	double	dTmp=0.0;
	double	dTxnAmt=0.0;
	char	*csTmp;
	char	*csMerchantId;
	char	*csBatchId;
	char	*csBankName;
	char	*csPspId;
	char	*csPspCcy;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec, *hTxn;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	
DEBUGLOG(("BOPayout:AssignPsp()\n"));

	GetField_Int(hRequest,"bank_cnt",&iCnt);
	GetField_Int(hRequest,"mid_present",&iMerch);
	if(iMerch==PD_TRUE){
		GetField_CString(hRequest,"merchant_id",&csMerchantId);
	}

	for(i=0; i<iCnt;i++){
        	recordset_init(rRecordSet,0);

		sprintf(csTag,"bank%d_present",i);
		GetField_Int(hRequest,csTag,&iBank);
		if(iBank==PD_TRUE){
			sprintf(csTag,"bank%d_bank_name",i);
			if(GetField_CString(hRequest,csTag,&csBankName)){
				PutField_CString(hContext,"bank_name",csBankName);
DEBUGLOG(("AssignPsp::bank_name = [%s]\n",csBankName));
			}
		}
		sprintf(csTag,"bank%d_psp_id",i);
		if(GetField_CString(hRequest,csTag,&csPspId)){
			PutField_CString(hContext,"psp_id",csPspId);
DEBUGLOG(("AssignPsp::psp_id = [%s]\n",csPspId));
		}
		sprintf(csTag,"bank%d_operator_type",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hContext,"operator_type",csTmp);
DEBUGLOG(("AssignPsp::operator_type = [%s]\n",csTmp));
		}
		sprintf(csTag,"bank%d_total_amt",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hContext,"total_amt",dTmp);
DEBUGLOG(("AssignPsp::total_amt = [%lf]\n",dTmp));
		}

		if(iBank==PD_TRUE && iMerch==PD_TRUE){
DEBUGLOG(("AssignPsp::Call DBMerchantUploadFileDetail:GetDetailByRandomWithBankMerchant\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetailByRandomWithBankMerchant");
			iResult = (unsigned long)(*DBObjPtr)(csBankName,csMerchantId,rRecordSet);
		}
		else if(iBank==PD_FALSE && iMerch==PD_TRUE){
DEBUGLOG(("AssignPsp::Call DBMerchantUploadFileDetail:GetDetailByRandomWithMerchant\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetailByRandomWithMerchant");
			iResult = (unsigned long)(*DBObjPtr)(csMerchantId,rRecordSet);
		}
		else if(iBank==PD_TRUE && iMerch==PD_FALSE){
DEBUGLOG(("AssignPsp::Call DBMerchantUploadFileDetail:GetDetailByRandomWithBank\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetailByRandomWithBank");
			iResult = (unsigned long)(*DBObjPtr)(csBankName,rRecordSet);
		}
		else{
DEBUGLOG(("AssignPsp::Call DBMerchantUploadFileDetail:GetDetailByRandom\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetailByRandom");
			iResult = (unsigned long)(*DBObjPtr)(rRecordSet);
		}

		if(iResult == PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			iTmp = 0;
			while(hRec){
				if(GetField_CString(hRec,"batch_id",&csBatchId)){
					sprintf(csTag,"batch_id_%d",iTmp);
					PutField_CString(hTxn,csTag,csBatchId);
DEBUGLOG(("GetDetail::batch_id = [%s]\n",csBatchId));
				}
				if(GetField_Int(hRec,"seq_num",&iSeqNum)){
					sprintf(csTag,"seq_num_%d",iTmp);
					PutField_Int(hTxn,csTag,iSeqNum);
DEBUGLOG(("GetDetail::seq_num = [%d]\n",iSeqNum));
				}
				if(GetField_CString(hRec,"bank_name",&csTmp)){
					if(iBank!=PD_TRUE){
						PutField_CString(hContext,"bank_name",csTmp);
DEBUGLOG(("GetDetail::bank_name = [%s]\n",csTmp));
					}
				}
				if(GetField_CString(hRec,"payout_ccy",&csPspCcy)){
DEBUGLOG(("GetDetail::payout_ccy= [%s]\n",csPspCcy));
				}
				if (GetField_Double(hRec, "payout_amount", &dTxnAmt)) {
					PutField_Double(hContext,"txn_amt",dTxnAmt);
DEBUGLOG(("GetDetail::txn_amt = [%lf]\n",dTxnAmt));
				}

DEBUGLOG(("AssignPsp::Call GetPayoutPsp\n"));
				iResCnt = 0;
				dResAmt = 0.0;
				sprintf(csTag,"psp_id_%d",iTmp);
				if((unsigned long)GetPayoutPsp(hContext,hRequest)==PD_OK){
					PutField_CString(hTxn,csTag,csPspId);

					sprintf(csTag,"%s_payout_ccy",csPspId);
					PutField_CString(hContext,csTag,csPspCcy);

					sprintf(csTag,"%s_accept_cnt",csPspId);
					GetField_Int(hContext,csTag,&iResCnt);
					iResCnt ++;
					PutField_Int(hContext,csTag,iResCnt);

					sprintf(csTag,"%s_accept_amt",csPspId);
					GetField_Double(hContext,csTag,&dResAmt);
					dResAmt += dTxnAmt;
					PutField_Double(hContext,csTag,dResAmt);

//check if the record was failed in the previous rule, update the pending count
					sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
					if(GetField_Int(hContext,csTag,&iStatus)){
						if(iStatus==PD_TRUE){
							iResCnt=0;
							dResAmt=0.0;
							sprintf(csTag,"%s%d_psp",csBatchId,iSeqNum);
							if(GetField_CString(hContext,csTag,&csTmp)){
								sprintf(csTag,"%s_pending_cnt",csTmp);
								GetField_Int(hContext,csTag,&iResCnt);
								iResCnt --;
								PutField_Int(hContext,csTag,iResCnt);

								sprintf(csTag,"%s_pending_amt",csTmp);
								GetField_Double(hContext,csTag,&dResAmt);
								dResAmt -= dTxnAmt;
								PutField_Double(hContext,csTag,dResAmt);
							}
						}
					}
DEBUGLOG(("AssignPsp::Call GetPayoutPsp Success\n"));
				}
				else{
					PutField_CString(hTxn,csTag,"");

//check if the record was failed in the previous rule, not to update the pending count.
					sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
					if(!GetField_Int(hContext,csTag,&iStatus)){
						sprintf(csTag,"%s_pending_cnt",csPspId);
						GetField_Int(hContext,csTag,&iResCnt);
						iResCnt ++;
						PutField_Int(hContext,csTag,iResCnt);

						sprintf(csTag,"%s_pending_amt",csPspId);
						GetField_Double(hContext,csTag,&dResAmt);
						dResAmt += dTxnAmt;
						PutField_Double(hContext,csTag,dResAmt);

						sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
						PutField_Int(hContext,csTag,PD_TRUE);
						sprintf(csTag,"%s%d_psp",csBatchId,iSeqNum);
						PutField_CString(hContext,csTag,csPspId);
					}
DEBUGLOG(("AssignPsp::Call GetPayoutPsp Failed\n"));
				}

				hRec = RecordSet_GetNext(rRecordSet);
				iTmp++;
				iTotal++;
				PutField_Int(hTxn,"total_count",iTmp);
			}

			if(iTmp>0){
				if((unsigned long)UpdateDetail(hContext,hTxn)==PD_OK){
DEBUGLOG(("AssignPsp::Update Detail Success\n"));
				}
			}
		}

	}//end for loop

	if(iTotal==0){
DEBUGLOG(("AssignPsp::No Pending record\n"));
                PutField_Int(hResponse,"total_cnt",iTotal);
                iRet = INT_NO_PENDING_RECORD;
        }

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);

DEBUGLOG(("BOPayout:AssignPsp() iRet=[%d]\n",iRet));
	return iRet;
}

int FormatResponse(const hash_t *hContext,
		   hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	i = 1;
	int	iAcceptCnt,iPendingCnt;
	double	dAcceptAmt,dPendingAmt;
	char	*csPspId;
	char	*csCcy;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout:FormatResponse()\n"));

	DBObjPtr = CreateObj(DBPtr,"DBRulePayoutPsp","GetExistingPsp");
	if((unsigned long) ((*DBObjPtr)(rRecordSet))==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
		while(hRec){
			iAcceptCnt = 0;
			iPendingCnt = 0;
			dAcceptAmt = 0.0;
			dPendingAmt = 0.0;

			if(GetField_CString(hRec,"psp_id",&csPspId)){
				sprintf(csTag,"psp_id_%d",i);
				PutField_CString(hResponse,csTag,csPspId);

				sprintf(csTag,"%s_accept_cnt",csPspId);
				GetField_Int(hContext,csTag,&iAcceptCnt);
				sprintf(csTag,"accept_cnt_%d",i);
				PutField_Int(hResponse,csTag,iAcceptCnt);

				sprintf(csTag,"%s_pending_cnt",csPspId);
				GetField_Int(hContext,csTag,&iPendingCnt);
				sprintf(csTag,"pending_cnt_%d",i);
				PutField_Int(hResponse,csTag,iPendingCnt);

				sprintf(csTag,"%s_payout_ccy",csPspId);
				if(GetField_CString(hContext,csTag,&csCcy)){
					sprintf(csTag,"ccy_%d",i);
					PutField_CString(hResponse,csTag,csCcy);
				}
				else{
					sprintf(csTag,"ccy_%d",i);
					PutField_CString(hResponse,csTag,"-");
				}

				sprintf(csTag,"%s_accept_amt",csPspId);
				GetField_Double(hContext,csTag,&dAcceptAmt);
				sprintf(csTag,"accept_amt_%d",i);
				PutField_Double(hResponse,csTag,dAcceptAmt);
				
				sprintf(csTag,"%s_pending_amt",csPspId);
				GetField_Double(hContext,csTag,&dPendingAmt);
				sprintf(csTag,"pending_amt_%d",i);
				PutField_Double(hResponse,csTag,dPendingAmt);

				PutField_Int(hResponse,"total_cnt",i);
				i++;
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

DEBUGLOG(("BOPayout:FormatResponse() iRet=[%d]\n",iRet));
	return iRet;
}

int GetPayoutFilePath(hash_t* hTxn)
{
	int iRet=PD_OK;
	char	*csFileName;
	char	*csPspId;
	char    csPayOutFile[PD_MAX_FILE_LEN + 1];
	char    csPayOutFilePath[PD_MAX_FILE_LEN + 1];
	char    csTag[PD_TAG_LEN +1];

	if(!GetField_CString(hTxn,"filename",&csFileName)){
DEBUGLOG(("BOPayout:GetPayoutFilePath filename missing!!!!!\n"));
		iRet = INT_ERR;
	}
	if(!GetField_CString(hTxn,"psp_id",&csPspId)){
DEBUGLOG(("BOPayout:GetPayoutFilePath psp_id missing!!!!!\n"));
		iRet = INT_ERR;
	}

	sprintf(csPayOutFilePath, "%s", getenv("OUTPUT_PAYOUT"));
	sprintf(csPayOutFile, "%s/%s", csPayOutFilePath, csFileName);
	sprintf(csTag,"%s_path",csPspId);
	PutField_CString(hTxn,csTag,csPayOutFile);

	return iRet;
}

int CreatePayoutFileDetail(const char* csPspId, hash_t* hContext)
{
	int iRet = PD_OK;

	char*    csDate;
	char    csPayOutFile[PD_MAX_FILE_LEN + 1];
	char    csPayOutFilePath[PD_MAX_FILE_LEN + 1];
	char    csPayOutFileName[PD_FILENAME_LEN + 1];
	char    csTag[PD_TAG_LEN +1];
	char    csFileId[PD_TXN_SEQ_LEN + 1];
	//unsigned long lFileId=0l;
	int     iSeqNum=0;

DEBUGLOG(("BOPayout:CreatePayoutFileDetail()\n"));

	memset(csPayOutFilePath, 0, sizeof(csPayOutFilePath));
	memset(csPayOutFileName, 0, sizeof(csPayOutFileName));
	memset(csFileId, 0, sizeof(csFileId));


	if(GetField_CString(hContext,"PHDATE",&csDate)){
		sprintf(csTag,"%s_file_date",csPspId);
		PutField_CString(hContext,csTag,csDate);
		//PutField_CString(hContext,"file_pid",csPspId);
DEBUGLOG(("CreatePayoutFileDetail::File Date[%s], PID[%s]\n", csDate,csPspId));
	}

DEBUGLOG(("CreatePayoutFileDetail::DBPayoutGeneratedFileHD:GetNextSeq\n"));
	DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetNextSeq");
	if((unsigned long) ((*DBObjPtr)(csDate,csPspId,&iSeqNum))!=PD_OK){
		iRet = INT_ERR;
DEBUGLOG(("CreatePayoutFileDetail::DBPayoutGeneratedFileHD:GetNextSeq Failed\n"));
	}
	else{
		sprintf(csPayOutFilePath, "%s", getenv("OUTPUT_PAYOUT"));
		sprintf(csPayOutFileName, "%s_%s%02d.xls", csPspId, csDate,iSeqNum);

		sprintf(csTag,"%s_seq_num",csPspId);
		PutField_Int(hContext,csTag,iSeqNum);
		//PutField_Int(hContext,"seq_num",iSeqNum);

		sprintf(csTag,"%s_file",csPspId);
		PutField_CString(hContext,csTag,csPayOutFileName);
		//PutField_CString(hContext,"filename",csPayOutFileName);

		sprintf(csPayOutFile, "%s/%s", csPayOutFilePath, csPayOutFileName);
		sprintf(csTag,"%s_path",csPspId);
		PutField_CString(hContext,csTag,csPayOutFile);
	}
/*
	if(iRet==PD_OK){
DEBUGLOG(("CreatePayoutFileDetail::DBPayoutGeneratedFileHD:GetNextFileId\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetNextFileId");
		if((unsigned long) ((*DBObjPtr)(&lFileId))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("CreatePayoutFileDetail::DBPayoutGeneratedFileHD:GetNextFileId Failed\n"));
		}
		else{
			sprintf(csFileId,"%ld",lFileId);
			sprintf(csTag,"%s_file_id",csPspId);
			PutField_CString(hContext,csTag,csFileId);
			//PutField_CString(hContext,"file_id",csFileId);
		}
	}
*/
/*
	if(iRet==PD_OK){
		PutField_Int(hContext,"status",PD_PAYOUTFILE_PRE_GENERATED);
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Add");
		if((unsigned long)(*DBObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("CreatePayoutFileDetail::PayoutGeneratedFileHD::Add Error!!!\n"));
			iRet = INT_ERR;
		}

	}
*/
DEBUGLOG(("BOPayout:CreatePayoutFileDetail() iRet=[%d]\n",iRet));
	return iRet;
}


int CreatePayoutFile(const char* csPspId, hash_t* hContext)
{
	int iRet = PD_OK;
	FILE    *fp;
	char    *csPayOutFile;
	char    csTag[PD_TAG_LEN +1];

DEBUGLOG(("BOPayout:CreatePayoutFile()\n"));

	sprintf(csTag,"%s_path",csPspId);
	if(GetField_CString(hContext,csTag,&csPayOutFile)){
DEBUGLOG(("BOPayout:CreatePayoutFile() writ to file[%s]\n",csPayOutFile));
	}


	if(iRet==PD_OK) {
DEBUGLOG(("CreatePayoutFile::Open PayoutFile [%s] for psp id [%s]\n", csPayOutFile, csPspId));
		fp = fopen(csPayOutFile, "w");
		if (fp == NULL) {
DEBUGLOG(("CreatePayoutFile::Open Payoutfile [%s] problem\n", csPayOutFile));
ERRLOG("BOPayout:CreatePayoutFile::Open Payoutfile problem!!\n");
			iRet=INT_ERR;
		}
	}

	if(iRet==PD_OK) {
		fprintf(fp, "<html><body><table>\n");
		fprintf(fp, "<style type=\"text/css\"> .format{ mso-number-format:'\\@';} </style>\n");
		fprintf(fp, "%s%s%s%s Payout Records%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s\n",
				PD_TR, PD_TD, PD_BOLD, csPspId, PD_BOLD_END, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TR_END);


		fprintf(fp, "%s%sPayout Trans No.%s%sReceiver Name%s%sID Card No.%s%sMobile No.%s%sBank%s%sBranch%s%sBank Account%s%sAmount%s%sProvince%s%sCity%s%sRemarks%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);

		fclose(fp);
	}
DEBUGLOG(("BOPayout:CreatePayoutFile() iRet=[%d]\n",iRet));
	return iRet;
}


int WriteAssignedRecord(hash_t *hContext,
			hash_t* hRequest)
{
	int	iRet=PD_OK;
	int	i=0;
	int	iTmp=0;
	int	iTxnCnt=0;
	int	iCnt=0;
	//int	iBatchCnt=0;
	double	dTmp = 0.0;
	double	dAmt = 0.0;
	double	dPayoutAmt = 0.0;
	double	dRemainAmt = 0.0;
	double	dSplitAmt = 0.0;
	char	*csTmp;
	char	*csTmpBatch=strdup("");
	char	*csPspId;
	char	*csFilePath;
	char	*csTxnCcy;
	char	*csPayoutTxnSeq;
	char	csTag[PD_TAG_LEN +1];
	unsigned long lFileId=0l;
        char    csNewFileId[PD_TXN_SEQ_LEN + 1];
	hash_t  *hRec, *hDetail, *hHeader;

        hHeader= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hHeader,0);
        hDetail= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hDetail,0);
	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout:WriteAssignedRecord()\n"));
	if (GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hDetail,"add_user",csTmp);
		PutField_CString(hHeader,"add_user",csTmp);
	}

	PutField_Char(hRequest,"batch_mode",PD_OFFLINE);
DEBUGLOG(("WriteAssignedRecord::Call DBMerchantUploadFileDetail:GetPspAssignedTxn\n"));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetPspAssignedTxn");
	if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){

		GetField_Int(hContext,"psp_count",&iCnt);
                for(i=0; i<iCnt; i++){
                        sprintf(csTag,"psp_id_%d",i);
                        if(GetField_CString(hContext,csTag,&csPspId)){
                                PutField_CString(hHeader,"file_pid",csPspId);

                                sprintf(csTag, "%s_file_id", csPspId);
                                if(GetField_CString(hContext,csTag,&csTmp)){
                                        PutField_CString(hHeader,"file_id",csTmp);
                                }
                                sprintf(csTag, "%s_file", csPspId);
                                if(GetField_CString(hContext,csTag,&csTmp)){
                                        PutField_CString(hHeader,"filename",csTmp);
                                }
                                sprintf(csTag, "%s_file_date", csPspId);
                                if(GetField_CString(hContext,csTag,&csTmp)){
                                        PutField_CString(hHeader,"file_date",csTmp);
                                }
                                sprintf(csTag, "%s_seq_num", csPspId);
                                if(GetField_Int(hContext,csTag,&iTmp)){
                                        PutField_Int(hHeader,"seq_num",iTmp);
                                }
                                sprintf(csTag, "%s_txn_cnt", csPspId);
                                if(GetField_Int(hContext,csTag,&iTmp)){
                                        PutField_Int(hHeader,"txn_cnt",iTmp);
                                }
                                sprintf(csTag, "%s_txn_amt", csPspId);
                                if(GetField_Double(hContext,csTag,&dTmp)){
                                        PutField_Double(hHeader,"txn_amt",dTmp);
                                }
                                sprintf(csTag, "%s_merchant_fee_ccy", csPspId);
                                if(GetField_CString(hContext,csTag,&csTmp)){
                                        PutField_CString(hHeader,"merchant_fee_ccy",csTmp);
                                }
                                sprintf(csTag, "%s_member_fee_ccy", csPspId);
                                if(GetField_CString(hContext,csTag,&csTmp)){
                                        PutField_CString(hHeader,"member_fee_ccy",csTmp);
                                }
				sprintf(csTag, "%s_merchant_fee", csPspId);
                                if(GetField_Double(hContext,csTag,&dTmp)){
                                        PutField_Double(hHeader,"merchant_fee",dTmp);
                                }
                                sprintf(csTag, "%s_member_fee", csPspId);
                                if(GetField_Double(hContext,csTag,&dTmp)){
                                        PutField_Double(hHeader,"member_fee",dTmp);
                                }

                                if(iRet==PD_OK){
DEBUGLOG(("WriteAssignedRecord::DBPayoutGeneratedFileHD:GetNextFileId\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetNextFileId");
                                        if((unsigned long) ((*DBObjPtr)(&lFileId))!=PD_OK){
                                                iRet = INT_ERR;
DEBUGLOG(("WriteAssignedRecord::DBPayoutGeneratedFileHD:GetNextFileId Failed\n"));
                                        }
                                        else{
                                                sprintf(csNewFileId,"%ld",lFileId);
                                                sprintf(csTag,"%s_file_id",csPspId);
                                                PutField_CString(hHeader,"file_id",csNewFileId);
                                                PutField_CString(hContext,csTag,csNewFileId);
                                        }
                                }

                                PutField_Int(hHeader,"status",PD_PAYOUTFILE_PRE_GENERATED);
                                DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Add");
                                if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("WriteAssignedRecord::PayoutGeneratedFileHD::Add Error!!!\n"));
                                        iRet = INT_ERR;
                                }
                                DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
                                if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("WriteAssignedRecord::PayoutGeneratedFileHD::Update Error!!!\n"));
                                        iRet = INT_ERR;
                                }

                        }
                }

		i = 0;
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec && (iRet==PD_OK)) {
			if (GetField_CString(hRec, "psp_id", &csPspId)) {
				sprintf(csTag, "%s_file", csPspId);
				GetField_CString(hContext,csTag,&csTmp);
				
				sprintf(csTag,"generated_file_name_%d", i);
				PutField_CString(hRequest,csTag,csTmp);

				sprintf(csTag, "%s_file_id", csPspId);
				GetField_CString(hContext,csTag,&csTmp);
				sprintf(csTag,"file_id_%d", i);
				PutField_CString(hRequest,csTag,csTmp);
				PutField_CString(hDetail,"file_id",csTmp);

				sprintf(csTag, "%s_path", csPspId);
				GetField_CString(hContext,csTag,&csFilePath);
DEBUGLOG(("GetPspAssignedTxn::psp_id = [%s]\n",csPspId));
			}
			if (GetField_CString(hRec, "txn_id", &csTmp)) {
				PutField_CString(hDetail,"txn_id",csTmp);
DEBUGLOG(("GetPspAssignedTxn::txn_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "batch_id", &csTmp)) {
				sprintf(csTag, "batch_id_%d", i);
				PutField_CString(hRequest,csTag,csTmp);
				PutField_CString(hDetail,"batch_id",csTmp);
DEBUGLOG(("GetPspAssignedTxn::batch_id = [%s]\n",csTmp));
			}
			if (GetField_Int(hRec, "seq_num", &iTmp)) {
				sprintf(csTag, "seq_num_%d", i);
				PutField_Int(hRequest,csTag,iTmp);
				PutField_Int(hDetail,"seq_num",iTmp);
DEBUGLOG(("GetPspAssignedTxn::seq_num = [%d]\n",iTmp));
			}
			if (GetField_CString(hRec,"txn_country", &csTmp)) {
				sprintf(csTag, "%s_txn_country", csPspId);
				PutField_CString(hContext,csTag,csTmp);
				PutField_CString(hDetail,"txn_country",csTmp);
DEBUGLOG(("GetPspAssignedTxn::txn_country = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"request_ccy", &csTmp)) {
				PutField_CString(hDetail,"request_ccy",csTmp);
DEBUGLOG(("GetPspAssignedTxn::request_ccy = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"payout_ccy", &csTmp)) {
				if(strcmp(csTmp,"RMB"))
					csTxnCcy=strdup(csTmp);
				else
					csTxnCcy=strdup(PD_CCY_ISO_CNY);

				sprintf(csTag, "%s_payout_ccy", csPspId);
				PutField_CString(hContext,csTag,csTxnCcy);
				PutField_CString(hDetail,"payout_ccy",csTxnCcy);
				FREE_ME(csTxnCcy);
DEBUGLOG(("GetPspAssignedTxn::payout_ccy = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"account_name", &csTmp)) {
				PutField_CString(hDetail,"account_name",csTmp);
DEBUGLOG(("GetPspAssignedTxn::account_name = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"account_num", &csTmp)) {
				PutField_CString(hDetail,"account_num",csTmp);
DEBUGLOG(("GetPspAssignedTxn::account_num = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"bank_name", &csTmp)) {
				PutField_CString(hDetail,"bank_name",csTmp);
DEBUGLOG(("GetPspAssignedTxn::bank_name = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"branch", &csTmp)) {
				PutField_CString(hDetail,"branch",csTmp);
DEBUGLOG(("GetPspAssignedTxn::branch = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"identity_id", &csTmp)) {
				PutField_CString(hDetail,"identity_id",csTmp);
DEBUGLOG(("GetPspAssignedTxn::identity_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"phone_num", &csTmp)) {
				PutField_CString(hDetail,"phone_num",csTmp);
DEBUGLOG(("GetPspAssignedTxn::phone_num = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"merchant_ref", &csTmp)) {
				PutField_CString(hDetail,"merchant_ref",csTmp);
DEBUGLOG(("GetPspAssignedTxn::merchant_ref = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"remark", &csTmp)) {
DEBUGLOG(("GetPspAssignedTxn::remark = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"province", &csTmp)) {
				PutField_CString(hDetail,"province",csTmp);
DEBUGLOG(("GetPspAssignedTxn::province = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"city", &csTmp)) {
				PutField_CString(hDetail,"city",csTmp);
DEBUGLOG(("GetPspAssignedTxn::city = [%s]\n",csTmp));
			}
			if (GetField_Double(hRec,"request_amount", &dTmp)) {
				PutField_Double(hDetail,"request_amount",dTmp);
DEBUGLOG(("GetPspAssignedTxn::request_amount = [%lf]\n",dTmp));
			}
			if (GetField_Double(hRec,"payout_amount", &dPayoutAmt)) {
				dRemainAmt = dPayoutAmt;
				///PutField_Double(hDetail,"payout_amount",dTmp);
DEBUGLOG(("GetPspAssignedTxn::payout_amount = [%lf]\n",dPayoutAmt));

				sprintf(csTag,"org_dst_net_amt_%s",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dTmp;
				}
				else{
					dAmt = dTmp;
				}
				PutField_Double(hContext,csTag,dAmt);

				sprintf(csTag,"%s_txn_amt",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dPayoutAmt;
				}
				else{
					dAmt = dPayoutAmt;
				}
				PutField_Double(hContext,csTag,dAmt);
			}
			if (GetField_CString(hRec,"merchant_fee_ccy", &csTmp)) {
				sprintf(csTag,"%s_merchant_fee_ccy",csPspId);
				PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::merchant_fee_ccy = [%s]\n",csTmp));
			}
			if (GetField_Double(hRec,"merchant_fee", &dTmp)) {
				sprintf(csTag,"%s_merchant_fee",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dTmp;
				}
				else{
					dAmt = dTmp;
				}
				PutField_Double(hContext,csTag,dAmt);
DEBUGLOG(("GetPspAssignedTxn::merchant_fee = [%lf]\n",dTmp));
			}

			if (GetField_CString(hRec,"member_fee_ccy", &csTmp)) {
				sprintf(csTag,"%s_member_fee_ccy",csPspId);
				PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::member_fee_ccy = [%s]\n",csTmp));
			}

			if (GetField_Double(hRec,"markup_amt", &dTmp)) {
DEBUGLOG(("GetPspAssignedTxn::markup_amt = [%lf]\n",dTmp));
			}

			if (GetField_Double(hRec,"member_fee", &dTmp)) {
				sprintf(csTag,"%s_member_fee",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dTmp;
				}
				else{
					dAmt = dTmp;
				}
				PutField_Double(hContext,csTag,dAmt);
DEBUGLOG(("GetPspAssignedTxn::member_fee = [%lf]\n",dTmp));
			}

			while(dRemainAmt>0.0){
				sprintf(csTag,"%s_split_amt",csPspId);
				GetField_Double(hContext,csTag,&dSplitAmt);
				if(dRemainAmt>dSplitAmt && dSplitAmt>0.0){
					dRemainAmt -= dSplitAmt;
					PutField_Double(hDetail,"payout_amount",dSplitAmt);
				}
				else{
					PutField_Double(hDetail,"payout_amount",dRemainAmt);
					dRemainAmt -=dRemainAmt;
				}	
				DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextPayoutTxnSeq");
                        	csPayoutTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("WriteAssignedRecord:: GeneratePayoutSeq: [%d]=[%s]\n",i,csPayoutTxnSeq));
                        	PutField_CString(hDetail,"gen_txn_id",csPayoutTxnSeq);
				PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_PRE_GENERATED);
				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","Add");
				if ((unsigned long)(*DBObjPtr)(hDetail) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("WriteAssignedRecord:: DBPayoutGeneratedFileDT:Add Failed\n"));
				}

				iTxnCnt = 0;
				sprintf(csTag,"%s_txn_cnt",csPspId);
				GetField_Int(hContext,csTag,&iTxnCnt);
				PutField_Int(hContext,csTag,iTxnCnt+1);

			}


			i++;
			hRec = RecordSet_GetNext(rRecordSet);
		}
		PutField_Int(hRequest,"total_count",i);
		PutField_Int(hDetail,"total_count",i);
DEBUGLOG(("WriteAssignedRecord::total_count= [%d]\n",i));

		GetField_Int(hContext,"psp_count",&iCnt);
		for(i=0; i<iCnt; i++){
			sprintf(csTag,"psp_id_%d",i);
			if(GetField_CString(hContext,csTag,&csPspId)){

				sprintf(csTag, "%s_file_id", csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"file_id",csTmp);
				}
				sprintf(csTag, "%s_txn_cnt", csPspId);
				if(GetField_Int(hContext,csTag,&iTmp)){
					PutField_Int(hHeader,"txn_cnt",iTmp);
				}
				sprintf(csTag, "%s_txn_amt", csPspId);
				if(GetField_Double(hContext,csTag,&dTmp)){
					PutField_Double(hHeader,"txn_amt",dTmp);
				}
				sprintf(csTag, "%s_merchant_fee_ccy", csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"merchant_fee_ccy",csTmp);
				}
				sprintf(csTag, "%s_member_fee_ccy", csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"member_fee_ccy",csTmp);
				}
				sprintf(csTag, "%s_merchant_fee", csPspId);
				if(GetField_Double(hContext,csTag,&dTmp)){
					PutField_Double(hHeader,"merchant_fee",dTmp);
				}
				sprintf(csTag, "%s_member_fee", csPspId);
				if(GetField_Double(hContext,csTag,&dTmp)){
					PutField_Double(hHeader,"member_fee",dTmp);
				}

				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
				if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("WriteAssignedRecord::PayoutGeneratedFileHD::Update Error!!!\n"));
					iRet = INT_ERR;
				}
				
			}
		}

	}
	else{
DEBUGLOG(("WriteAssignedRecord::GetpspAssignedTxn::Failed!!!!\n"));
ERRLOG("BOPayout:WriteAssignedRecord::GetPspAssignedTxn::Failed!!\n");
		iRet=INT_NOT_RECORD;
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hHeader);
	FREE_ME(hDetail);
	FREE_ME(csTmpBatch);
	FREE_ME(csPayoutTxnSeq);
DEBUGLOG(("WriteAssignedRecord::iRet=[%d]\n",iRet));
	return iRet;
}


int WritePayoutFile(const char* csPayOutFile, hash_t* hRec)
{
	int     iRet=PD_OK;
	int     iTmp;
	char*   csTmp;
	double  dTmp;

DEBUGLOG(("BOPayout:WritePayoutFile()\n"));
	FILE    *fp;
	fp = fopen(csPayOutFile, "a");
	if (fp == NULL) {
DEBUGLOG(("WritePayoutFile::Open Payoutfile [%s] problem\n", csPayOutFile));
ERRLOG("BOPayout:WritePayoutFile::Open Payoutfile problem!!\n");
		iRet=INT_ERR;
	}

	if(iRet==PD_OK) {
		if(GetField_Int(hRec,"end_file",&iTmp)){
			if(iTmp==PD_TRUE){
				fprintf(fp, "</table></body></html>\n");
				fclose(fp);
				return iRet;
			}
		}
	}

	if(iRet==PD_OK) {
	//	fprintf(fp, "%s%sPayout Trans No.%s%sReceiver Name%s%sID Card No.%s%sMobile No.%s%sBank%s%sBranch%s%sBank Account%s%sAmount%s%sProvince%s%sCity%s%sRemarks%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);

		fprintf(fp, "%s", PD_TR);

		if (!GetField_CString(hRec, "merchant_ref", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:merchant_ref [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "account_name", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:account_name [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "identity_id", &csTmp)) {
			csTmp = strdup("0000000");
		}
DEBUGLOG(("WritePayoutFile:identity_id [%s]\n", csTmp));
		fprintf(fp, "%s[%s]%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "phone_num", &csTmp)) {
			csTmp = strdup("0000000");
		}
DEBUGLOG(("WritePayoutFile:phone_num [%s]\n", csTmp));
		fprintf(fp, "%s[%s]%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "bank_name", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:bank_name [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "branch", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:branch [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "account_num", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:account_num [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

		if (!GetField_Double(hRec, "payout_amount", &dTmp)) {
			dTmp = 0.0;
		}
DEBUGLOG(("WritePayoutFile:payout_amount [%f]\n", dTmp));
		fprintf(fp, "%s%f%s",PD_TD,dTmp,PD_TD_END);

		if (!GetField_CString(hRec, "province", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:province [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "city", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:city [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "remark", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:remark [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		fprintf(fp, "%s\n", PD_TR_END);

	}

	FREE_ME(csTmp);
	fclose(fp);
DEBUGLOG(("WritePayoutFile: iRet[%d]\n", iRet));
	return iRet;
}


int GetGenFileDetail(hash_t *hContext,
		     hash_t* hRequest)
{
	int	iRet=PD_OK;
	int	i=0;
	int	iTmp=0;
	double	dTmp = 0.0;
	double	dAmt = 0.0;
	double	dCancelAmt = 0.0;
	double	dPspFee= 0.0;
	char	*csTmp;
	char	*csTmpBatch=strdup("");
	//char	*csPhDate;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec, *hTxn;
        hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
DEBUGLOG(("GetGenFileDetail()\n"));

DEBUGLOG(("GetGenFileDetail::Call DBPayoutGeneratedFileHD:GetHeader\n"));
	DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetHeader");
	iRet = (unsigned long)(*DBObjPtr)(hRequest,rRecordSet);
	if (iRet == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if (GetField_CString(hRec, "psp_id", &csTmp)) {
				PutField_CString(hContext,"org_psp_id",csTmp);
				PutField_CString(hTxn,"org_psp_id",csTmp);
DEBUGLOG(("GetHeader::psp_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "file_date", &csTmp)) {
				//if(GetField_CString(hContext,"PHDATE",&csPhDate)){
				//	if(strcmp(csPhDate,csTmp)){
				//		iRet = INT_INVALID_TXN;
//DEBUGLOG(("GetHeader::file date expired. Cannot cancel file!!!\n"));
//					}
//				}
DEBUGLOG(("GetHeader::file_date = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "filename", &csTmp)) {
DEBUGLOG(("GetHeader::filename = [%s]\n",csTmp));
			}
			if (GetField_Int(hRec, "status", &iTmp)) {
DEBUGLOG(("GetHeader::status = [%d]\n",iTmp));
				if(iTmp!=PD_PAYOUTFILE_GENERATED){
					iRet = INT_INVALID_TXN;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetHeader::invalid status. Cannot cancel file[%s]!!!\n",csTmp));
				}
			}
			if (GetField_Int(hRec, "txn_count", &iTmp)) {
				PutField_Int(hContext,"total_count",iTmp);
DEBUGLOG(("GetHeader::txn_cnt = [%d]\n",iTmp));
			}
			if (GetField_Double(hRec, "total_txn_amt", &dTmp)) {
DEBUGLOG(("GetHeader::total_txn_amt = [%lf]\n",dTmp));
			}
			if (GetField_CString(hRec, "payout_ccy", &csTmp)) {
				PutField_CString(hContext,"org_psp_txn_ccy",csTmp);
DEBUGLOG(("GetHeader::payout_ccy = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "txn_seq", &csTmp)) {
				PutField_CString(hContext,"org_txn_id",csTmp);
DEBUGLOG(("GetHeader::txn_seq = [%s]\n",csTmp));
			}

			hRec = RecordSet_GetNext(rRecordSet);
		}
	}
	RecordSet_Destroy(rRecordSet);

	if(iRet==PD_OK){
		recordset_init(rRecordSet,0);
		PutField_Int(hRequest,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
DEBUGLOG(("GetGenFileDetail::Call DBPayoutGeneratedFileDT:GetDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","GetDetail");
		iRet = (unsigned long)(*DBObjPtr)(hRequest,rRecordSet);
		if (iRet == PD_OK) {
			i = 0;
			int iBatchCnt=0;
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec, "batch_id", &csTmp)) {
					sprintf(csTag, "batch_id_%d", i);
					PutField_CString(hRequest,csTag,csTmp);

					if(strcmp(csTmpBatch,csTmp)){
						strcpy(csTmpBatch,csTmp);
						csTmpBatch[strlen(csTmp)]='\0';
						sprintf(csTag,"cancel_batch_%d",iBatchCnt);
						PutField_CString(hContext,csTag,csTmpBatch);
						iBatchCnt++;
						PutField_Int(hContext,"cancel_batch_cnt",iBatchCnt);
					}
DEBUGLOG(("GetDetail::batch_id = [%s]\n",csTmp));
				}
				if (GetField_Int(hRec, "seq_num", &iTmp)) {
					sprintf(csTag, "seq_num_%d", i);
					PutField_Int(hRequest,csTag,iTmp);
DEBUGLOG(("GetDetail::seq_num = [%d]\n",iTmp));
				}
				if (GetField_CString(hRec, "gen_txn_id", &csTmp)) {
					sprintf(csTag, "gen_txn_id_%d", i);
					PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetDetail::gen_txn_id = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec, "txn_country", &csTmp)) {
					PutField_CString(hContext,"org_txn_country",csTmp);
					PutField_CString(hContext,"txn_country",csTmp);
DEBUGLOG(("GetDetail::txn_country = [%s]\n",csTmp));
				}
				if(GetField_Double(hRec,"payout_amount",&dTmp)){
DEBUGLOG(("GetDetail::payout_amount = [%lf]\n",dTmp));
					if(GetField_Double(hContext,"org_dst_net_amt",&dAmt))
						dAmt += dTmp;
					else
						dAmt = dTmp;

					PutField_Double(hContext,"org_dst_net_amt",dAmt);

					sprintf(csTag,"%s_cancel_amt",csTmpBatch);
					if(GetField_Double(hContext,csTag,&dCancelAmt))
						dCancelAmt+=dTmp;
					else
						dCancelAmt = dTmp;
					PutField_Double(hContext,csTag,dCancelAmt);
DEBUGLOG(("GetDetail::[%s] = [%lf]\n",csTag,dCancelAmt));

					PutField_Double(hTxn,"org_dst_net_amt",dTmp);
					PutField_Char(hTxn,"txn_type",PD_TYPE_PAYOUT);
DEBUGLOG(("GetGenFileDetail::Call BOPsp CalPspCosts\n"));
					BOObjPtr = CreateObj(BOPtr,"BOPsp","CalPspCosts");
					if((unsigned long)(*BOObjPtr)(hTxn,hRequest)==PD_OK){
						if(GetField_Double(hTxn,"precal_fee",&dTmp)){
							dPspFee += dTmp;
							PutField_Double(hContext,"precal_fee",dPspFee);
DEBUGLOG(("GetGenFileDetail::payout_fee[%lf]\n",dTmp));
						}
					}
				}

				sprintf(csTag, "psp_id_%d", i);
				PutField_CString(hRequest,csTag,"");
				sprintf(csTag, "generated_file_name_%d", i);
				PutField_CString(hRequest,csTag,"");

				i++;	
				PutField_Int(hRequest,"total_count",i);
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(csTmpBatch);
	FREE_ME(hTxn);

DEBUGLOG(("GetGenFileDetail: iRet[%d]\n", iRet));
	return iRet;
}

int GenerateBatchSeq(hash_t* hRequest)
{
	int	iRet=PD_OK;
	int	iCnt=0;
	int	i=0;
	char	*csTxnSeq;
	char	csTag[PD_TAG_LEN +1];

	if(GetField_Int(hRequest,"total_count",&iCnt)){
		for(i=0; i<iCnt; i++){
			DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextBatchTxnSeq");
			sprintf(csTag,"txn_seq_%d",i);
			csTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("GenerateBatchSeq: [%d]=[%s]\n",i,csTxnSeq));
			PutField_CString(hRequest,csTag,csTxnSeq);

			FREE_ME(csTxnSeq);
		}
	}
	return iRet;
}

/*
int ReAssignPsp(hash_t *hContext,
	      hash_t* hRequest,
	      hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iCnt = 0;
	int	i = 0;
	int	iTotal = 0;
	int	iTmp = 0;
	int	iResult = 0;
	int	iSeqNum = 0;
	int	iBank = PD_FALSE;
	int	iMerch = PD_FALSE;
	int	iResCnt = 0;
	int	iStatus = PD_FALSE;
	double	dResAmt = 0.0;
	double	dTmp=0.0;
	double	dTxnAmt=0.0;
	char	*csTmp;
	char	*csMerchantId;
	char	*csBatchId;
	char	*csBankName;
	char	*csPspId;
	char	*csPspCcy;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec, *hTxn;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	
DEBUGLOG(("BOPayout:ReAssignPsp()\n"));

	GetField_Int(hRequest,"bank_cnt",&iCnt);
	for(i=0; i<iCnt;i++){
        	recordset_init(rRecordSet,0);

		sprintf(csTag,"bank%d_present",i);
		GetField_Int(hRequest,csTag,&iBank);
		RemoveField_CString(hTxn,"bank_name");
		if(iBank==PD_TRUE){
			sprintf(csTag,"bank%d_bank_name",i);
			if(GetField_CString(hRequest,csTag,&csBankName)){
				PutField_CString(hTxn,"bank_name",csBankName);
DEBUGLOG(("ReAssignPsp::bank_name = [%s]\n",csBankName));
			}
		}
		sprintf(csTag,"bank%d_psp_id",i);
		if(GetField_CString(hRequest,csTag,&csPspId)){
			PutField_CString(hContext,"psp_id",csPspId);
DEBUGLOG(("ReAssignPsp::psp_id = [%s]\n",csPspId));
		}
		sprintf(csTag,"bank%d_operator_type",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hContext,"operator_type",csTmp);
DEBUGLOG(("ReAssignPsp::operator_type = [%s]\n",csTmp));
		}
		sprintf(csTag,"bank%d_total_amt",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hContext,"total_amt",dTmp);
DEBUGLOG(("ReAssignPsp::total_amt = [%lf]\n",dTmp));
		}

		PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_REV_FOR_REGEN);
DEBUGLOG(("ReAssignPsp::Call DBPayoutGeneratedFileDT:GetReGenDetailByRandom\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","GetReGenDetailByRandom");
		iResult = (unsigned long)(*DBObjPtr)(hTxn,rRecordSet);

		if(iResult == PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			iTmp = 0;
			while(hRec){
				if(GetField_CString(hRec,"gen_txn_id",&csTmp)){
					PutField_CString(hTxn,"gen_txn_id",csTmp);
DEBUGLOG(("GetDetail::gen_txn_id = [%s]\n",csTmp));
				}
				if(GetField_CString(hRec,"batch_id",&csBatchId)){
					sprintf(csTag,"batch_id_%d",iTmp);
					PutField_CString(hTxn,csTag,csBatchId);
DEBUGLOG(("GetDetail::batch_id = [%s]\n",csBatchId));
				}
				if(GetField_Int(hRec,"seq_num",&iSeqNum)){
					sprintf(csTag,"seq_num_%d",iTmp);
					PutField_Int(hTxn,csTag,iSeqNum);
DEBUGLOG(("GetDetail::seq_num = [%d]\n",iSeqNum));
				}
				if(GetField_CString(hRec,"bank_name",&csTmp)){
					if(iBank!=PD_TRUE){
						PutField_CString(hContext,"bank_name",csTmp);
DEBUGLOG(("GetDetail::bank_name = [%s]\n",csTmp));
					}
				}
				if(GetField_CString(hRec,"payout_ccy",&csPspCcy)){
DEBUGLOG(("GetDetail::payout_ccy= [%s]\n",csPspCcy));
				}
				if (GetField_Double(hRec, "payout_amount", &dTxnAmt)) {
					PutField_Double(hContext,"txn_amt",dTxnAmt);
DEBUGLOG(("GetDetail::txn_amt = [%lf]\n",dTxnAmt));
				}

DEBUGLOG(("ReAssignPsp::Call GetPayoutPsp\n"));
				iResCnt = 0;
				dResAmt = 0.0;
				sprintf(csTag,"psp_id_%d",iTmp);
				if((unsigned long)GetPayoutPsp(hContext,hRequest)==PD_OK){
					PutField_CString(hTxn,csTag,csPspId);

					sprintf(csTag,"%s_payout_ccy",csPspId);
					PutField_CString(hContext,csTag,csPspCcy);

					sprintf(csTag,"%s_accept_cnt",csPspId);
					GetField_Int(hContext,csTag,&iResCnt);
					iResCnt ++;
					PutField_Int(hContext,csTag,iResCnt);

					sprintf(csTag,"%s_accept_amt",csPspId);
					GetField_Double(hContext,csTag,&dResAmt);
					dResAmt += dTxnAmt;
					PutField_Double(hContext,csTag,dResAmt);

//check if the record was failed in the previous rule, update the pending count
					sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
					if(GetField_Int(hContext,csTag,&iStatus)){
						if(iStatus==PD_TRUE){
							iResCnt=0;
							dResAmt=0.0;
							sprintf(csTag,"%s%d_psp",csBatchId,iSeqNum);
							if(GetField_CString(hContext,csTag,&csTmp)){
								sprintf(csTag,"%s_pending_cnt",csTmp);
								GetField_Int(hContext,csTag,&iResCnt);
								iResCnt --;
								PutField_Int(hContext,csTag,iResCnt);

								sprintf(csTag,"%s_pending_amt",csTmp);
								GetField_Double(hContext,csTag,&dResAmt);
								dResAmt -= dTxnAmt;
								PutField_Double(hContext,csTag,dResAmt);
							}
						}
					}

					PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_REV_AND_REGEN);
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","UpdateByGenId");
					iRet = (unsigned long)(*DBObjPtr)(hTxn);
DEBUGLOG(("ReAssignPsp::Call DBPayoutGeneratedFileDT:UpdateByGenId iRet=[%d]\n",iRet));

					if(iRet==PD_OK){
						DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextPayoutTxnSeq");
						csPayoutTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("ReAssignPsp:: GeneratePayoutSeq: [%s]\n",csPayoutTxnSeq));
						PutField_CString(hRec,"gen_txn_id",csPayoutTxnSeq);
						PutField_Int(hRec,"status",PAYOUT_MASTER_TRANSACTION_PRE_GENERATED);
						DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","Add");
						iRet = (unsigned long)(*DBObjPtr)(hRec);
DEBUGLOG(("ReAssignPsp::Call DBPayoutGeneratedFileDT:Add iRet=[%d]\n",iRet));
					}
					
				}
				else{
					PutField_CString(hTxn,csTag,"");

//check if the record was failed in the previous rule, not to update the pending count.
					sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
					if(!GetField_Int(hContext,csTag,&iStatus)){
						sprintf(csTag,"%s_pending_cnt",csPspId);
						GetField_Int(hContext,csTag,&iResCnt);
						iResCnt ++;
						PutField_Int(hContext,csTag,iResCnt);

						sprintf(csTag,"%s_pending_amt",csPspId);
						GetField_Double(hContext,csTag,&dResAmt);
						dResAmt += dTxnAmt;
						PutField_Double(hContext,csTag,dResAmt);

						sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
						PutField_Int(hContext,csTag,PD_TRUE);
						sprintf(csTag,"%s%d_psp",csBatchId,iSeqNum);
						PutField_CString(hContext,csTag,csPspId);
					}
DEBUGLOG(("ReAssignPsp::Call GetPayoutPsp Failed\n"));
				}

				hRec = RecordSet_GetNext(rRecordSet);
				iTmp++;
				iTotal++;
				PutField_Int(hTxn,"total_count",iTmp);
			}
			//if(iTmp>0){
			//	if((unsigned long)UpdateDetail(hContext,hTxn)==PD_OK){
//DEBUGLOG(("AssignPsp::Update Detail Success\n"));
			//	}
			//}

		}

	}//end for loop

	if(iTotal==0){
DEBUGLOG(("ReAssignPsp::No Pending record\n"));
                PutField_Int(hResponse,"total_cnt",iTotal);
                iRet = INT_NO_PENDING_RECORD;
        }

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);

DEBUGLOG(("BOPayout:ReAssignPsp() iRet=[%d]\n",iRet));
	return iRet;
}*/
