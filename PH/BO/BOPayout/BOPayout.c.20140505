/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/10/24              LokMan Chow
Call BOtxnElements				   2012/02/08		   LokMan Chow
Add handle_PayoutIndvCancel 			   2012/04/27		   LokMan Chow
Call CalPspCosts
Verify and insert payout file			   2014/01/02	    	   LokMan Chow
bug fix for GetDetailByPreApproveId		   2014/02/05		   LokMan Chow
enhancement for POP				   2014/04/30		   LokMan Chow
enhancement for POG				   2014/05/02		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOPayout.h"
#include <math.h>
#include <ctype.h>

#define PD_SPACE 0x20
#define PD_TR           "<tr>"
#define PD_TD           "<td>"
#define PD_BOLD         "<b>"
#define PD_TD_STYLE     "<td class=\"format\">"
#define PD_TR_END       "</tr>"
#define PD_TD_END       "</td>"
#define PD_BOLD_END     "</b>"

#define	PD_TMP_SPLIT_AMT 3000
#define PD_TWV_DELIMETER ','

#define NUM_OF_CHAR                     26
#define HEADER_FIELD_CNT                4
#define DETAIL_FIELD_CNT                16
#define IMPORT_FIELD_LEN                150
#define MAX_NUM_OF_RECORD               2000

#define IDX_HEADER_MERCHANT_ID          0
#define IDX_HEADER_NUMOFREC             2
#define IDX_HEADER_MAC                  3
#define IDX_HEADER_SERVICE_CODE         1

#define IDX_DETAIL_SEQ_NUM              0
#define IDX_DETAIL_MERCHANT_REF         1
#define IDX_DETAIL_COUNTRY              2
#define IDX_DETAIL_ID                   3
#define IDX_DETAIL_ACC_NO               4
#define IDX_DETAIL_BANK_CODE            7
#define IDX_DETAIL_BANK_NAME            6
#define IDX_DETAIL_ACC_NAME             5
#define IDX_DETAIL_BRANCH_NAME          8
#define IDX_DETAIL_PHONE_NO             9
#define IDX_DETAIL_PROVINCE             10
#define IDX_DETAIL_CITY                 11
#define IDX_DETAIL_AMOUNT               12
#define IDX_DETAIL_PAYOUT_CCY           13
#define IDX_DETAIL_DST_CCY              14
#define IDX_DETAIL_MAC                  15
#define IDX_DETAIL_RESPONSE_CODE        16

char    csCharSet[NUM_OF_CHAR]={'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'};
char    csIntSet[NUM_OF_CHAR][3]={"10","11","12","13","14","15","16","17","34","18","19","20","21","22","35","23","24","25","26","27","28","29","32","30","31","33"};
char    csAddSet[NUM_OF_CHAR][3]={"1","10","19","28","37","46","55","64","39","73","82","2","11","20","48","29","38","47","56","65","74","83","21","3","12","30"};
char	csField[DETAIL_FIELD_CNT][PD_TAG_LEN]={"Sequence Num","Merchant Reference","Country","Identity ID","Bank Acct Num","Bank Acct Name","Bank Name","Bank Code","Branch","Phone Num","Province","City","Amount","Request Currency","Payout Currency","Checksum"};

char	csFieldTag[DETAIL_FIELD_CNT-1][PD_TAG_LEN]={"seq_num","merchant_ref","country","identity_id","account_num","account_name","bank_name","bank_code","branch","phone_num","province","city","request_amount","request_currency","payout_currency"};

int	iFieldLength[DETAIL_FIELD_CNT]={6,25,2,25,25,100,150,25,150,25,100,100,14,3,3,32};

char    cDebug;

void BOPayout(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

int UpdateHeader(hash_t *hContext,
                 hash_t* hRequest);

int GetPayoutRule(hash_t *hContext,
                  hash_t* hRequest);

int AssignPsp(hash_t *hContext,
              hash_t* hRequest,
              hash_t* hResponse);

int FormatResponse(const hash_t *hContext,
                   hash_t* hResponse);

int CreatePayoutFileDetail(const char* csPspId,
                           hash_t* hContext);

int CreatePayoutFile(hash_t* hContext);

//int CreatePayoutFile(const char* csPspChannel,const char* csPspId,
//                     hash_t* hContext);

int WritePayoutFile(const char* csPayOutFile,
                    hash_t* hRec);

int WriteAssignedRecord(hash_t *hContext,
                        hash_t* hRequest);

int GetGenFileDetail(hash_t *hContext,
                     hash_t* hRequest);

int GetPayoutFilePath(hash_t* hTxn);

int GetPayoutRecords(hash_t* hTxn,
                        hash_t* hContext,
                        hash_t* hRequest);

int UpdateDetail(hash_t *hContext,
                hash_t* hRequest);

int AddTxnLog(hash_t *hContext, hash_t *hRequest);

int UpdateDetailByTxn(hash_t *hContext,
                        hash_t* hRequest);

int isVoidWithFee(hash_t* hContext);

int HandlePayoutBalance(hash_t* hContext, hash_t* hRequest);
int HandleTxnPayoutBalance(hash_t* hContext, hash_t* hRequest);

//int handle_PayoutUpload(const unsigned long lBatchId,hash_t* hContext,hash_t* hRequest);
//int handle_PayoutConfirm(const unsigned long lBatchId,hash_t* hContext,hash_t* hRequest);
//int handle_PayoutApprove(const unsigned long lBatchId,hash_t* hContext,hash_t* hRequest);
int handle_PayoutPreGenerate(hash_t* hContext,hash_t* hRequest,hash_t* hResponse);
int handle_PayoutGenerate(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
int handle_to_PayoutGenerate(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
//int handle_PayoutCancel(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
//int handle_PayoutCancelBeforeApproved(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
//int handle_PayoutCancelApproved(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
//int handle_PayoutCancelGenerated(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
int handle_PayoutPreSend(hash_t *hContext,hash_t* hRequest,hash_t* hResponse);
int handle_PayoutSend(hash_t *hContext,hash_t* hRequest,hash_t* hResponse);
int handle_PayoutIndvCancel(hash_t *hContext,hash_t* hRequest,hash_t* hResponse);
int handle_PayoutReGenerate(hash_t *hContext,hash_t* hRequest,hash_t* hResponse);

int ProcessPayoutRule(hash_t *hContext, hash_t *hRequest);
int UpdateTxnLog(hash_t *hContext);

int ProcessPayoutTxn(hash_t *hContext,
		 hash_t* hRequest,
		 hash_t* hResponse)
{
	int     iRet = PD_OK;
	char	*csTmp;
	char	*csTxnCode;
	char	*csMerchantId;
	int	iTmp= 0;
	//int	i= 0;
	//int	iChk= PD_FALSE;
	int	iMerch = PD_FALSE;
	unsigned long lBatchId = 0l;
	//char    csTag[PD_TAG_LEN +1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	hash_t  *hHeader;
        hHeader = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hHeader,0);

DEBUGLOG(("BOPayout:ProcessPayoutTxn()\n"));

 	if (GetField_CString(hRequest,"batch_id",&csTmp)) {
		lBatchId = ctol((const unsigned char *)csTmp,strlen(csTmp));
		PutField_CString(hTxn,"batch_id",csTmp);
DEBUGLOG(("BOPayout::ProcessPayoutTxn() batch_id = [%s]\n",csTmp));
        }

	if(GetField_CString(hContext,"approval_date",&csTmp)){
DEBUGLOG(("BOPayout::ProcessPayoutTxn() approval_date = [%s]\n",csTmp));
	}

	if(GetField_Int(hContext,"day_of_week",&iTmp)){
DEBUGLOG(("BOPayout::ProcessPayoutTxn() day_of_week = [%d]\n",iTmp));
	}

 	if (GetField_CString(hRequest,"merchant_id",&csMerchantId)) {
		iMerch = PD_TRUE;
DEBUGLOG(("BOPayout::ProcessPayoutTxn() merchant_id = [%s]\n",csMerchantId));
        }
	PutField_Int(hRequest,"mid_present",iMerch);

 	if (GetField_CString(hRequest,"file_id",&csTmp)) {
		PutField_CString(hHeader,"file_id",csTmp);
DEBUGLOG(("BOPayout::ProcessPayoutTxn() file_id = [%s]\n",csTmp));
        }

 	if (GetField_CString(hRequest,"add_user",&csTmp)) {
		PutField_CString(hTxn,"update_user",csTmp);
		PutField_CString(hHeader,"update_user",csTmp);
DEBUGLOG(("BOPayout::ProcessPayoutTxn() add_user = [%s]\n",csTmp));
	}

	if(GetField_CString(hRequest,"txn_code",&csTxnCode)){
DEBUGLOG(("BOPayout::ProcessPayoutTxn() txn_code = [%s]\n",csTxnCode));
	}

	if (GetField_CString(hRequest,"remark",&csTmp)) {
                PutField_CString(hContext,"remark",csTmp);
DEBUGLOG(("BOPayout::ProcessPayoutTxn() remark = [%s]\n",csTmp));
        }

/*---------Payout Upload---------*/
	if(!strcmp(csTxnCode,PD_PAYOUT_UPLOAD)){
		//iRet = handle_PayoutUpload(lBatchId,hContext,hRequest);
	}
/*---------Payout Confirm---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_CONFIRM)){
		//iRet = handle_PayoutConfirm(lBatchId,hContext,hRequest);
	}
/*---------Payout Approve---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_APPROVE)){
		//iRet = handle_PayoutApprove(lBatchId, hContext, hRequest);
	}
/*---------Payout Pre-Send---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_PRE_SEND)){
		//iRet = handle_PayoutPreSend(hContext,hRequest,hResponse);
	}
/*---------Payout Send---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_SEND)){
		//iRet = handle_PayoutSend(hContext,hRequest,hResponse);
	}
/*---------Payout Pre-Generate---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_PRE_GEN)){
		if(iMerch==PD_TRUE){
			DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","ChkRuleExistsByMerchant");
			if ((unsigned long)(DBObjPtr)(csMerchantId) == PD_FOUND){
				iRet = handle_PayoutPreSend(hContext,hRequest,hResponse);
				if(iRet == INT_NO_PENDING_RECORD){
					iRet = handle_PayoutPreGenerate(hContext,hRequest,hResponse);
				}
			}
			else{
				iRet = handle_PayoutPreGenerate(hContext,hRequest,hResponse);
			}
		}
		else{
			iRet = handle_PayoutPreGenerate(hContext,hRequest,hResponse);
		}
	}
/*---------Payout Generate---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_GENERATE)){
		if(iMerch==PD_TRUE){
			DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","ChkRuleExistsByMerchant");
			if ((unsigned long)(DBObjPtr)(csMerchantId) == PD_FOUND){
				iRet = handle_PayoutSend(hContext,hRequest,hResponse);
				if(iRet == INT_NO_PENDING_RECORD){
					iRet = handle_PayoutGenerate(hContext,hRequest,hResponse);
					//generate by queue
					//iRet = handle_to_PayoutGenerate(hContext,hRequest,hResponse);
				}
			}
			else{
				iRet = handle_PayoutGenerate(hContext,hRequest,hResponse);
				//iRet = handle_to_PayoutGenerate(hContext,hRequest,hResponse);
			}
		}
		else{
			iRet = handle_PayoutGenerate(hContext,hRequest,hResponse);
			//iRet = handle_to_PayoutGenerate(hContext,hRequest,hResponse);
		}

		//for online payout
		//iChk = handle_PayoutSend(hContext,hRequest,hResponse);

		//if(iChk == PD_FALSE){
			//for offline payout
			//iRet = handle_PayoutGenerate(hContext,hRequest,hHeader);
			/*if(GetField_Int(hContext,"psp_count",&iTmp)){
				PutField_Int(hResponse,"total_cnt",iTmp);

				for(i=1; i<=iTmp; i++){
					sprintf(csTag,"txn_seq_%d",i);
					if(GetField_CString(hContext,csTag,&csTmp)){
						sprintf(csTag,"txnid_%d",i);
						PutField_CString(hResponse,csTag,csTmp);
					}
				}
			}*/
		//}
		//else{
		//	GetField_Int(hContext,"return_send",&iRet);
		//}
	}
/*---------Payout Cancel---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL)){
		//PutField_CString(hRequest,"org_txn_code",csTxnCode);
		//iRet = handle_PayoutCancel(hContext,hRequest,hHeader);

		//if(GetField_CString(hContext,"txn_id",&csTmp)){
		//	PutField_CString(hResponse,"org_txn_seq",csTmp);
		//}
	}

/*---------Payout Cancel Individual Record in File---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_INDV_CANCEL)){
		iRet = handle_PayoutIndvCancel(hContext,hRequest,hResponse);
	}

	else{
DEBUGLOG(("BOPayout::ProcessPayoutTxn() unknown txn_code!!!\n"));
ERRLOG("BOPayout::ProcessPayoutTxn() unknown txn_code!!!\n");
		iRet = INT_ERR;
	}


	if((iRet == PD_OK) && (strcmp(csTxnCode,PD_PAYOUT_PRE_GEN))){
		/*if(strcmp(csTxnCode,PD_PAYOUT_UPLOAD)){
			PutField_CString(hContext,"txn_code",PD_PAYOUT_UPLOAD);
		}*/
		//iRet = UpdateHeader(hContext,hRequest);
	}

DEBUGLOG(("BOPayout::ProcessPayoutTxn() iRet[%d]\n",iRet));
	FREE_ME(hTxn);
	FREE_ME(hHeader);
	return	iRet;
}

int handle_PayoutPreGenerate(hash_t *hContext,
			     hash_t* hRequest,
			     hash_t* hResponse)
{
	int	iRet = PD_OK;
	char	*csBatchId;
	char    csTag[PD_TAG_LEN +1];
	char    csBatchList[PD_TMP_MSG_BUF_LEN+1];
	int	iGenId = 0;
	int	iCnt = 0;
	int	i = 0;
	hash_t*	hRec;
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	hash_t  *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));

DEBUGLOG(("BOPayout::handle_PayoutPreGenerate()\n"));
	if(iRet==PD_OK){
		//get pre generate id (from table "payout_generated_tmp")
DEBUGLOG(("Authorize::DBPayoutGeneratedTmp:GetNexteId\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedTmp","GetNextId");
		if((unsigned long) ((*DBObjPtr)(&iGenId))!=PD_OK){
			iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::DBPayoutGeneratedTmp:GetNextId Failed\n"));
		}
		else{
DEBUGLOG(("Authorize:::GetNextId [%d]\n",iGenId));
			PutField_Int(hContext,"pregen_id",iGenId);
			PutField_Int(hResponse,"preview_id",iGenId);
		}
	}

	if(iRet==PD_OK){
		int iProcess = 0;
		csBatchList[0] = '\0';
		//get input batch list
		//select for update, check upload header status = 6
		//update upload header status = 8 (lock header)
		GetField_Int(hContext, "total_cnt", &iCnt);//total batch count
		
		for (i = 0; i < iCnt; i++) {
			sprintf(csTag, "batch_id_%d",i);
			if(GetField_CString(hContext,csTag,&csBatchId)){
				int iChk = 0;
				DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","MatchBatchStatus_ForUpdate");
				iChk = (unsigned long) ((*DBObjPtr)(csBatchId,PD_PAYOUTFILE_APPROVED));
				if(iChk==PD_FOUND){
					sprintf(csTag, "process_batch_%d",iProcess);
					PutField_CString(hContext,csTag,csBatchId);
					iProcess ++;
					PutField_Int(hContext, "total_process_cnt", iProcess);
					if(i>0) strcat(csBatchList,",");
					strcat(csBatchList,csBatchId);
					csBatchList[strlen(csBatchList)]= '\0';
					PutField_CString(hContext,"batch_list",csBatchList);

					hash_init(hTxn,0);

					PutField_CString(hTxn,"batch_id",csBatchId);
					PutField_Int(hTxn,"status",PD_PAYOUTFILE_PRE_GENERATED);
					DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","UpdateHeader");
					if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
						iRet = INT_ERR;
						PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::DBMerchantUploadFileHeader:Update Failed\n"));
ERRLOG("Authorize::DBMerchantUploadFileHeader:Update Failed\n");
						break;
					}

				}
				else{
DEBUGLOG(("Authorize::the batch[%s] is not for generate!!\n",csBatchId));
				}
			}
		}
		if(iProcess==0){
			iRet=INT_NO_PAYOUT_MATCH_RULE;
			PutField_Int(hContext,"internal_error",iRet);
		}
	}

	if(iRet==PD_OK){
		iRet = ProcessPayoutRule(hContext,hRequest);
	}

//--------------------
	if(iRet==PD_OK){
		double	dBal=0.0;
		double	dAvalBal=0.0;
		char	*csPspId;
		char	*csCcy;
		char	*csCountry;
		iCnt = 0;

		recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedTmp","GetExistingPsp");
		if((unsigned long) ((*DBObjPtr)(iGenId,rRecordSet))==PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				hash_init(hTxn,0);
				if(GetField_CString(hRec,"psp_id",&csPspId)){
					sprintf(csTag, "psp_id_%d", iCnt);
					PutField_CString(hContext,csTag,csPspId);
DEBUGLOG(("GetExistingPsp psp_id [%s]\n",csPspId));
				}
				if(GetField_CString(hRec,"psp_ccy",&csCcy)){
					sprintf(csTag, "%s_payout_ccy", csPspId);
					PutField_CString(hContext,csTag,csCcy);
DEBUGLOG(("GetExistingPsp psp_ccy [%s]\n",csCcy));
				}
				if(GetField_CString(hRec,"psp_country",&csCountry)){
DEBUGLOG(("GetExistingPsp psp_country [%s]\n",csCountry));
				}

DEBUGLOG(("Call DBPspBalance:GetAvalPspBalance [%s]\n",csPspId));
				DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetAvalPspBalance");
				if((unsigned long)(*DBObjPtr)(csPspId,
							csCcy,
							csCountry,
							&dBal)==PD_OK){
DEBUGLOG(("GetAvalPspBalance balance = [%lf]\n",dBal));
					PutField_Double(hTxn,"org_psp_bal",dBal);
				}
				
DEBUGLOG(("Call BOPsp:GetAvalPspBalanceForPO\n"));
				BOObjPtr = CreateObj(BOPtr,"BOPsp","GetAvalPspBalanceForPO");
				if((unsigned long)(*BOObjPtr)(hTxn,hTxn)==PD_OK){
					if(GetField_Double(hTxn,"aval_psp_bal",&dAvalBal)){
DEBUGLOG(("GetAvalPspBalanceForPO aval psp balance = [%lf]\n",dAvalBal));
					}
				}
				sprintf(csTag, "%s_aval_psp_bal", csPspId);
				PutField_Double(hContext,csTag,dAvalBal);

				iCnt++;
				PutField_Int(hResponse,"total_cnt",iCnt);//total psp count
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	if(iRet==PD_OK){
		iRet = FormatResponse(hContext,hResponse);
	}

	if(iRet==PD_OK){
		//get input batch list
		//select for update, check upload header status = 8
		//update upload header status = 6 (unlock header)
		iCnt = 0;
		GetField_Int(hContext, "total_cnt", &iCnt);//total batch count
		
		for (i = 0; i < iCnt; i++) {
			sprintf(csTag, "batch_id_%d",i);
			if(GetField_CString(hContext,csTag,&csBatchId)){
				int iChk = 0;
				DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","MatchBatchStatus_ForUpdate");
				iChk = (unsigned long) ((*DBObjPtr)(csBatchId,PD_PAYOUTFILE_PRE_GENERATED));
				if(iChk==PD_FOUND){
					hash_init(hTxn,0);
					PutField_CString(hTxn,"batch_id",csBatchId);
					PutField_Int(hTxn,"status",PD_PAYOUTFILE_APPROVED);
					DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","UpdateHeader");
					if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
						break;
					}
				}
			}
		}
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);
DEBUGLOG(("handle_PayoutPreGenerate:: iRet = [%d]\n",iRet));
	return iRet;
}

/*
int handle_PayoutPreGenerate(hash_t *hContext,
			     hash_t* hRequest,
			     hash_t* hResponse)
{
	int	iRet = PD_OK;
	char	*csFileId;
	char	*csTmp;
	char    csTag[PD_TAG_LEN +1];
	int	i;
	hash_t*	hRec;
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout::handle_PayoutPreGenerate()\n"));

	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetPreGeneratedFileId");
	if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {
			if(GetField_CString(hRec,"file_id",&csFileId)){
DEBUGLOG(("DBMerchantUploadFileDetail Resume FileId[%s]\n",csFileId));
				DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","ResumePreGenFile");
				iRet = (unsigned long)(*DBObjPtr)(csFileId);

				if(iRet==PD_OK){
DEBUGLOG(("DBPayoutGeneratedFileHD Resume FileId[%s]\n",csFileId));
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Delete");
					iRet = (unsigned long)(*DBObjPtr)(csFileId);
				}
				if(iRet==PD_OK){
DEBUGLOG(("DBPayoutGeneratedFileDT Resume FileId[%s]\n",csFileId));
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","Delete");
					iRet = (unsigned long)(*DBObjPtr)(csFileId);
				}
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}

	if(iRet==PD_OK){
		iRet = GetPayoutRule(hContext,hRequest);

		if(iRet==PD_OK){
			iRet = AssignPsp(hContext,hRequest,hResponse);
		}

		if(iRet==PD_OK){
			recordset_init(rRecordSet,0);
			PutField_Char(hRequest,"batch_mode",PD_OFFLINE);
DEBUGLOG(("handle_PayoutPreGenerate::Call DBMerchantUploadFileDetail:GetPreAssignedPsp\n"));
        		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetPreAssignedPsp");
			if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
				i = 0;
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if (GetField_CString(hRec, "psp_id", &csTmp)) {
						sprintf(csTag, "psp_id_%d", i);
						PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetPreAssignedPsp::psp_id = [%s]\n",csTmp));
DEBUGLOG(("handle_PayoutPreGenerate::Call CreatePayoutFileDetail\n"));
						if(CreatePayoutFileDetail(csTmp,hContext)!=PD_OK){
							iRet=INT_ERR;
DEBUGLOG(("CreatePayoutFile for[%s] Failed!!!!\n",csTmp));
						}
					}
					i++;
					hRec = RecordSet_GetNext(rRecordSet);
					PutField_Int(hContext,"psp_count",i);
				}
			}
		}
		if(iRet==PD_OK){
			iRet = WriteAssignedRecord(hContext,hRequest);
		}

	}

	if(iRet==PD_OK){
		int iCnt=0;
		int iTmp=0;
		int iChk=PD_OK;
		char	*csPspId;
		char	*csCountry;
		char	*csCcy;
		double	dBal=0.0;
		double	dAvalBal=0.0;
		hash_t	*hTxn;
		hTxn= (hash_t*) malloc (sizeof(hash_t));

		recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBRulePayoutPsp","GetExistingPsp");
		if((unsigned long) ((*DBObjPtr)(rRecordSet))==PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if(GetField_CString(hRec,"psp_id",&csTmp)){
					sprintf(csTag, "psp_id_%d", iCnt);
					PutField_CString(hContext,csTag,csTmp);
					iCnt++;
DEBUGLOG(("DBRulePayoutPsp:GetExistingPsp psp_id [%s]\n",csTmp));
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}


		//GetField_Int(hContext,"psp_count",&iCnt);
		for (i=0; i< iCnt; i++){
			iTmp=0;
			dBal=0.0;
			dAvalBal=0.0;
			iChk=PD_OK;
			hash_init(hTxn,0);

			sprintf(csTag, "psp_id_%d", i);
			if(GetField_CString(hContext,csTag,&csPspId)){
				sprintf(csTag, "%s_payout_ccy", csPspId);
				if(!GetField_CString(hContext,csTag,&csCcy)){

					recordset_init(rRecordSet,0);
					DBObjPtr = CreateObj(DBPtr,"DBPspCountry","GetPspCountry");
					if((unsigned long) ((*DBObjPtr)(csPspId,rRecordSet))==PD_OK){
						hRec = RecordSet_GetFirst(rRecordSet);
						while(hRec){
							if (GetField_CString(hRec,"ccy_id",&csCcy)) {
DEBUGLOG(("DBRulePayoutPsp:GetExistingPsp ccy [%s]\n",csCcy));
							}
							if (GetField_CString(hRec,"country",&csCountry)) {
								sprintf(csTag, "%s_payout_country", csPspId);
								PutField_CString(hContext,csTag,csCountry);
DEBUGLOG(("DBRulePayoutPsp:GetExistingPsp country [%s]\n",csCountry));
							}
							hRec = RecordSet_GetNext(rRecordSet);
						}
					}
				}
				sprintf(csTag, "%s_payout_country", csPspId);
				if(!GetField_CString(hContext,csTag,&csCountry)){
					iChk = INT_ERR;
				}
				//sprintf(csTag, "%s_accept_cnt", csPspId);
				//if(!GetField_Int(hContext,csTag,&iTmp)){
				//	iChk = INT_ERR;
				//}
				PutField_CString(hTxn,"psp_id",csPspId);
				PutField_Int(hTxn,"txn_cnt",iTmp);

				if(iChk==PD_OK){
DEBUGLOG(("handle_PayoutPreGenerate::Call DBPspBalance:GetAvalPspBalance [%s]\n",csPspId));
					DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetAvalPspBalance");
					if((unsigned long)(*DBObjPtr)(csPspId,
								csCcy,
								csCountry,
								&dBal)==PD_OK){
DEBUGLOG(("GetAvalPspBalance balance = [%lf]\n",dBal));
						PutField_Double(hTxn,"org_psp_bal",dBal);
					}
					else{
						iChk = INT_ERR;
DEBUGLOG(("GetAvalPspBalance find balance failed!!!!\n"));
					}
				}
				if(iChk==PD_OK){
DEBUGLOG(("handle_PayoutPreGenerate::Call BOPsp:GetAvalPspBalanceForPO\n"));
					BOObjPtr = CreateObj(BOPtr,"BOPsp","GetAvalPspBalanceForPO");
					if((unsigned long)(*BOObjPtr)(hTxn,hTxn)==PD_OK){
						if(GetField_Double(hTxn,"aval_psp_bal",&dAvalBal)){
DEBUGLOG(("GetAvalPspBalanceForPO aval psp balance = [%lf]\n",dAvalBal));
						}
					}
					else{
						iChk = INT_ERR;
DEBUGLOG(("GetAvalPspBalanceForPO find aval psp balance failed!!!!\n"));
					}
				}

				sprintf(csTag, "%s_aval_psp_bal", csPspId);
				PutField_Double(hContext,csTag,dAvalBal);
			}
		}
		FREE_ME(hTxn);
	}

	if(iRet==PD_OK){
		iRet = UpdateDetail(hContext,hRequest); 
	}
	if(iRet==PD_OK){
		iRet = FormatResponse(hContext,hResponse);
	}


	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
DEBUGLOG(("handle_PayoutPreGenerate:: iRet = [%d]\n",iRet));
	return iRet;
}
*/

int handle_PayoutPreSend(hash_t *hContext,
                          hash_t* hRequest,
                          hash_t* hResponse)
{
	int     iRet = PD_OK;
	//char	*csFileId;
	char	*csTmp;
	char	*csPspId;
	char	*csTxnCcy;
	char	*csCountry;
	char    csTag[PD_TAG_LEN +1];
	int	i, iOnlineCnt;
	int	iOnlineResp = PD_FALSE;
	double	dPayoutAmt=0.0;
	double	dTmpAmt=0.0;
	double	dBal=0.0;
	double	dAvalBal=0.0;
	hash_t*	hRec;
	hash_t*	hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout::handle_PayoutPreSend()\n"));
	if(GetField_CString(hRequest,"merchant_id",&csTmp)){
DEBUGLOG(("BOPayout::handle_PayoutPreSend() merchant_id [%s]\n",csTmp));
	}

	if(iRet==PD_OK){
		PutField_Char(hRequest,"batch_mode",PD_ONLINE);
DEBUGLOG(("handle_PayoutPreSend::Call DBMerchantUploadFileDetail:GetPspAssignedTxn\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetPspAssignedTxn");
		if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				iOnlineCnt = 0;
				if (GetField_CString(hRec, "psp_id", &csPspId)) {
					
					if (GetField_CString(hRec,"payout_ccy", &csTmp)) {
						if(strcmp(csTmp,"RMB"))
							csTxnCcy=strdup(csTmp);
						else
							csTxnCcy=strdup(PD_CCY_ISO_CNY);

						sprintf(csTag, "%s_payout_ccy", csPspId);
						PutField_CString(hContext,csTag,csTxnCcy);
						FREE_ME(csTxnCcy);
DEBUGLOG(("GetPspAssignedTxn::payout_ccy = [%s]\n",csTmp));
					}

					if (GetField_Double(hRec,"payout_amount", &dPayoutAmt)) {
						sprintf(csTag,"%s_accept_amt",csPspId);
						GetField_Double(hContext,csTag,&dTmpAmt);
						PutField_Double(hContext,csTag,dTmpAmt+dPayoutAmt);
DEBUGLOG(("GetPspAssignedTxn::payout_amount = [%lf]\n",dPayoutAmt));
					}

					if (GetField_CString(hRec,"txn_country", &csTmp)) {
						sprintf(csTag,"%s_country",csPspId);
						PutField_CString(hContext,csTag,csTmp);
					}
					sprintf(csTag,"%s_accept_cnt",csPspId);
					GetField_Int(hContext,csTag,&iOnlineCnt);
					PutField_Int(hContext,csTag,iOnlineCnt+1);
				}

				iOnlineResp = PD_TRUE;
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		else{
			iRet = INT_NO_PENDING_RECORD;
DEBUGLOG(("handle_PayoutPreSend:: No Online Payout Records\n"));
		}

		if(iOnlineResp){
			iRet = PD_OK;
			iOnlineCnt = 0;
			dPayoutAmt = 0.0;
			recordset_init(rRecordSet,0);
DEBUGLOG(("handle_PayoutPreSend::Call DBMerchantUploadFileDetail:GetPreAssignedPsp\n"));
        		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetPreAssignedPsp");
			if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
				//if(!GetField_Int(hResponse,"total_cnt",&i))
				i=0;
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					i ++;
					if (GetField_CString(hRec, "psp_id", &csPspId)) {
						sprintf(csTag, "psp_id_%d", i);
						PutField_CString(hResponse,csTag,csPspId);
DEBUGLOG(("GetPreAssignedPsp::psp_id = [%s]\n",csPspId));
						sprintf(csTag, "psp_id_%d", i-1);
						PutField_CString(hContext,csTag,csPspId);

						sprintf(csTag,"%s_accept_cnt",csPspId);
						GetField_Int(hContext,csTag,&iOnlineCnt);
						sprintf(csTag,"accept_cnt_%d",i);
						PutField_Int(hResponse,csTag,iOnlineCnt);
DEBUGLOG(("GetPreAssignedPsp::accept_cnt = [%d]\n",iOnlineCnt));

						sprintf(csTag,"%s_accept_amt",csPspId);
						GetField_Double(hContext,csTag,&dPayoutAmt);
						sprintf(csTag,"accept_amt_%d",i);
						PutField_Double(hResponse,csTag,dPayoutAmt);
DEBUGLOG(("GetPreAssignedPsp::accept_amt = [%lf]\n",dPayoutAmt));

						sprintf(csTag, "%s_payout_ccy", csPspId);
						GetField_CString(hContext,csTag,&csTxnCcy);
						sprintf(csTag,"ccy_%d",i);
						PutField_CString(hResponse,csTag,csTxnCcy);
DEBUGLOG(("GetPreAssignedPsp::payout_ccy = [%s]\n",csTxnCcy));

						sprintf(csTag, "%s_country", csPspId);
						GetField_CString(hContext,csTag,&csCountry);
					}
					PutField_Int(hResponse,"total_cnt",i);
					PutField_Int(hContext,"psp_count",i);

					PutField_CString(hTxn,"psp_id",csPspId);
					PutField_Int(hTxn,"txn_cnt",iOnlineCnt);
DEBUGLOG(("handle_PayoutPreSend::Call DBPspBalance:GetAvalPspBalance\n"));
					DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetAvalPspBalance");
					if((unsigned long)(*DBObjPtr)(csPspId,
								csTxnCcy,
								csCountry,
								&dBal)==PD_OK){
DEBUGLOG(("GetAvalPspBalance balance = [%lf]\n",dBal));
						PutField_Double(hTxn,"org_psp_bal",dBal);

DEBUGLOG(("handle_PayoutPreSend::Call BOPsp:GetAvalPspBalanceForPO\n"));
						BOObjPtr = CreateObj(BOPtr,"BOPsp","GetAvalPspBalanceForPO");
						if((unsigned long)(*BOObjPtr)(hTxn,hTxn)==PD_OK){
							if(GetField_Double(hTxn,"aval_psp_bal",&dAvalBal)){
DEBUGLOG(("GetAvalPspBalanceForPO aval psp balance = [%lf]\n",dAvalBal));
							}
						}
						else{
DEBUGLOG(("GetAvalPspBalanceForPO find aval psp balance failed!!!!\n"));
						}
					}
					sprintf(csTag, "aval_psp_bal_%d", i);
					PutField_Double(hResponse,csTag,dAvalBal);


					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
		}
	}


	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);
DEBUGLOG(("handle_PayoutPreSend:: iRet = [%d]\n",iRet));
	return iRet;


}

int handle_PayoutSend(hash_t *hContext,
			  hash_t* hRequest,
			  hash_t* hResponse)
{
	int	iRet = PD_OK;
	//int	iChk = PD_FALSE;
	int	i=0;
	int	b=0;
	int	iTmp=0;
	int	iTmpCnt=0;
	int	iTxnCnt=0;
	int	iOrgCnt=0;
	int	iTotal=0;
	int	iTxnTotal=0;
	int	iBatchCnt=0;
	char*	csTmp;
	char*	csTmpBID;
	char*	csBatchId;
	char*	csPspId;
	char*	csPspChannel;
	char	csNewFileId[PD_TXN_SEQ_LEN+1];
	char*	csPayoutTxnSeq;
	char*	csFilePath;
	char	csTag[PD_TAG_LEN +1];
	double	dAmt=0.0;
	double	dRemainAmt=0.0;
	double	dSplitAmt=0.0;
	double	dTmp=0.0;
	double	dTmpTotalAmt=0.0;
	double	dTmpAmt=0.0;
	double	dTotal=0.0;
	unsigned long lBatchId = 0l;
        unsigned long lTmp=0l;
        unsigned long lFileId=0l;

DEBUGLOG(("BOPayout::handle_PayoutSend()\n"));

	hash_t  *hRec, *hDetail, *hHeader, *hTxn, *hOrgHd;
	
	hOrgHd= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hOrgHd,0);

	hHeader= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hHeader,0);

	hDetail= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hDetail,0);

	hTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	csTmpBID = (char*) malloc (128);

	if(GetField_CString(hContext,"PHDATE",&csTmp)){
		PutField_CString(hHeader,"txn_date",csTmp);
	}

	if(GetField_CString(hRequest,"merchant_id",&csTmp)){
DEBUGLOG(("handle_PayoutSend::merchant_id [%s]\n",csTmp));
	}

DEBUGLOG(("handle_PayoutSend::Call DBMerchantUploadFileDetail:GetOnlineBatchRecord\n"));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetOnlineBatchRecord");
	if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_FOUND){
		
		//iChk = PD_TRUE;

		PutField_Int(hDetail,csTag,i);
		PutField_Int(hDetail,"batch_cnt",b);
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec && (iRet==PD_OK)) {
			sprintf(csTag,"batch_id_%d",b);
			if(GetField_CString(hRec,"batch_id",&csBatchId)){
				PutField_CString(hDetail,"batch_id",csBatchId);
				PutField_CString(hTxn,"batch_id",csBatchId);
				PutField_CString(hHeader,csTag,csBatchId);
				if(strcmp(csBatchId,csTmpBID)){
					b++;
					i=0;
					iOrgCnt=0;
					sprintf(csTmpBID,"%s",csBatchId);

DEBUGLOG(("handle_PayoutSend::DBPayoutGeneratedFileHD:GetNextFileId\n"));
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetNextFileId");
					if((unsigned long) ((*DBObjPtr)(&lFileId))!=PD_OK){
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutSend::DBPayoutGeneratedFileHD:GetNextFileId Failed\n"));
						PutField_Int(hContext,"internal_error",iRet);
						break;
					}
					else{
						sprintf(csNewFileId,"%ld",lFileId);
						sprintf(csTag,"%s_file_id",csBatchId);
						PutField_CString(hHeader,csTag,csNewFileId);
						PutField_CString(hHeader,"generated_file_id",csNewFileId);
DEBUGLOG(("handle_PayoutSend::DBPayoutGeneratedFileHD:GetNextFileId [%s]\n",csNewFileId));
					}
					sprintf(csTag,"%s_merchant_id",csBatchId);
					if(GetField_CString(hRec,"merchant_id",&csTmp)){
						PutField_CString(hHeader,csTag,csTmp);
					}
					sprintf(csTag,"%s_psp_id",csBatchId);
					if(GetField_CString(hRec,"psp_id",&csPspId)){
						PutField_CString(hHeader,csTag,csPspId);
						PutField_CString(hTxn,csTag,csPspId);
					}
					//////get split amount///
					dTmp = 0.0;
					RemoveField_Double(hTxn,"payout_split_limit");
					DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspPayoutSplitAmt");
					if ((*DBObjPtr)(csPspId,hTxn) == PD_OK) {
						if (GetField_Double(hTxn,"payout_split_limit",&dTmp)) {
DEBUGLOG(("handle_PayoutSend:: GetPspPayoutSplitAmt - split amount= [%lf]\n",dTmp));
						}
					}
					sprintf(csTag,"%s_split_amt",csBatchId);
					PutField_Double(hTxn,csTag,dTmp);
				}
				PutField_CString(hDetail,"file_id",csNewFileId);
				PutField_CString(hTxn,"file_id",csNewFileId);
			}
			if(GetField_Int(hRec,"seq_num",&iTmp)){
				PutField_Int(hDetail,"seq_num",iTmp);
			}
			if(GetField_CString(hRec,"txn_seq",&csTmp)){
				PutField_CString(hDetail,"upload_txn_id",csTmp);
				//PutField_CString(hDetail,"txn_id",csTmp);
				PutField_CString(hOrgHd,"txn_seq",csTmp);
			}
			if(GetField_CString(hRec,"merchant_ref",&csTmp)){
				PutField_CString(hDetail,"merchant_ref",csTmp);
			}
			if(GetField_CString(hRec,"txn_country",&csTmp)){
				PutField_CString(hDetail,"country",csTmp);
				PutField_CString(hDetail,"txn_country",csTmp);
			}
			if(GetField_CString(hRec,"bank_name",&csTmp)){
				PutField_CString(hDetail,"bank_name",csTmp);
			}
			if(GetField_CString(hRec,"phone_num",&csTmp)){
				PutField_CString(hDetail,"phone_num",csTmp);
			}
			else{
				RemoveField_CString(hDetail,"phone_num");
			}
			if(GetField_CString(hRec,"province",&csTmp)){
				PutField_CString(hDetail,"province",csTmp);
			}
			else{
				RemoveField_CString(hDetail,"province");
			}
			if(GetField_CString(hRec,"city",&csTmp)){
				PutField_CString(hDetail,"city",csTmp);
			}
			else{
				RemoveField_CString(hDetail,"city");
			}
			if(GetField_CString(hRec,"request_ccy",&csTmp)){
				PutField_CString(hDetail,"request_ccy",csTmp);
			}
			if(GetField_Double(hRec,"request_amount",&dTmp)){
				PutField_Double(hDetail,"request_amount",dTmp);
			}
			if(GetField_CString(hRec,"payout_ccy",&csTmp)){
				PutField_CString(hDetail,"payout_currency",csTmp);
				PutField_CString(hDetail,"payout_ccy",csTmp);
				sprintf(csTag,"%s_txn_ccy",csBatchId);
				PutField_CString(hHeader,csTag,csTmp);
				sprintf(csTag,"%s_txn_ccy",csPspId);
				PutField_CString(hHeader,csTag,csTmp);
			}
			if(GetField_Double(hRec,"payout_amount",&dTmp)){
				sprintf(csTag,"%s_txn_amt",csBatchId);
				dAmt = 0.0;
				GetField_Double(hHeader,csTag,&dAmt);
				dAmt+=dTmp;
				PutField_Double(hHeader,csTag,dAmt);

				dRemainAmt = dTmp;
			}
//////////////////////////
//split by average
			sprintf(csTag,"%s_split_amt",csBatchId);
                        GetField_Double(hTxn,csTag,&dSplitAmt);
                        int iSplitCnt = 1;
                        if(dSplitAmt>0){
                                iSplitCnt = (int)(dRemainAmt/dSplitAmt);
                                if(dRemainAmt>(dSplitAmt*iSplitCnt)){
                                        iSplitCnt ++;
                                }

DEBUGLOG(("WriteAssignedRecord:: Split Count: [%d]\n",iSplitCnt));

                                dTmpAmt = 0.0;
                                dTmpTotalAmt = 0.0;

                                dTmpAmt = newround(dRemainAmt/iSplitCnt,0);
                                for(iTmpCnt=0;iTmpCnt<(iSplitCnt-1);iTmpCnt++){
                                        sprintf(csTag,"avag_split_amt_%d",iTmpCnt);
                                        PutField_Double(hContext,csTag,dTmpAmt);
                                        dTmpTotalAmt += dTmpAmt;
                                }
                        }
                        sprintf(csTag,"avag_split_amt_%d",(iSplitCnt-1));
                        PutField_Double(hContext,csTag,dRemainAmt-dTmpTotalAmt);

                        for(iTmpCnt=0;iTmpCnt<iSplitCnt;iTmpCnt++){
			/*while(dRemainAmt>0.0){
				sprintf(csTag,"%s_split_amt",csBatchId);
				GetField_Double(hTxn,csTag,&dSplitAmt);
				if(dRemainAmt>dSplitAmt && dSplitAmt>0.0){
					dRemainAmt = dRemainAmt - dSplitAmt;
					PutField_Double(hDetail,"payout_amount",dSplitAmt);
					PutField_Double(hDetail,"amount",dSplitAmt);
					sprintf(csTag,"%s_%d_payout_amount",csBatchId,i);
					PutField_Double(hDetail,csTag,dSplitAmt);
				}
				else{
					PutField_Double(hDetail,"payout_amount",dRemainAmt);
					PutField_Double(hDetail,"amount",dRemainAmt);
					sprintf(csTag,"%s_%d_payout_amount",csBatchId,i);
					PutField_Double(hDetail,csTag,dRemainAmt);
					dRemainAmt = 0.0;
				}	
			*/
				sprintf(csTag,"avag_split_amt_%d",iTmpCnt);
                                if(GetField_Double(hContext,csTag,&dTmp)){
                                        PutField_Double(hDetail,"payout_amount",dTmp);
					PutField_Double(hDetail,"amount",dTmp);
					sprintf(csTag,"%s_%d_payout_amount",csBatchId,i);
					PutField_Double(hDetail,csTag,dTmp);
                                }

				if(GetField_CString(hRec,"identity_id",&csTmp)){
					PutField_CString(hDetail,"identity_id",csTmp);
					sprintf(csTag,"%s_%d_identity_id",csBatchId,i);
					PutField_CString(hDetail,csTag,csTmp);
				}
				if(GetField_CString(hRec,"account_num",&csTmp)){
					PutField_CString(hDetail,"account_num",csTmp);
					sprintf(csTag,"%s_%d_account_num",csBatchId,i);
					PutField_CString(hDetail,csTag,csTmp);
				}
				if(GetField_CString(hRec,"account_name",&csTmp)){
					PutField_CString(hDetail,"account_name",csTmp);
					sprintf(csTag,"%s_%d_account_name",csBatchId,i);
					PutField_CString(hDetail,csTag,csTmp);
				}
				if(GetField_CString(hRec,"bank_code",&csTmp)){
					PutField_CString(hDetail,"bank_code",csTmp);
					sprintf(csTag,"%s_%d_bank_code",csBatchId,i);
					PutField_CString(hDetail,csTag,csTmp);
				}
				if(GetField_CString(hRec,"branch",&csTmp)){
					PutField_CString(hDetail,"branch",csTmp);
					sprintf(csTag,"%s_%d_branch",csBatchId,i);
					PutField_CString(hDetail,csTag,csTmp);
				}

				PutField_Char(hDetail,"status",PD_INIT);
				PutField_Char(hHeader,"status",PD_INIT);

				i++;
				sprintf(csTag,"%s_txn_count",csBatchId);
				PutField_Int(hHeader,csTag,i);
				PutField_Int(hHeader,"batch_cnt",b);
				//iTotal++;
				//sprintf(csTag,"%s_file_count",csNewFileId);
				//PutField_Int(hHeader,csTag,iTotal);

				if(iRet==PD_OK){
					DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextPayoutTxnSeq");
                        		csPayoutTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("handle_PayoutSend::GeneratePayoutSeq: [%d]=[%s]\n",i,csPayoutTxnSeq));
                        		PutField_CString(hDetail,"txn_id",csPayoutTxnSeq);
					sprintf(csTag,"%s_%d_gen_txn_id",csBatchId,i);
					PutField_CString(hDetail,csTag,csPayoutTxnSeq);
				}

				//insert DBPayoutQueueDt 
				DBObjPtr = CreateObj(DBPtr,"DBPayoutQueueDt","Add");
				if((unsigned long)(*DBObjPtr)(hDetail)==PD_OK){
DEBUGLOG(("handle_PayoutSend::Add PayoutQueueDt Success\n"));
				}
				else{
					iRet=INT_ERR;
DEBUGLOG(("handle_PayoutSend::Add PayoutQueueDt Failed!!!!\n"));
					PutField_Int(hContext,"internal_error",iRet);
					break;
				}

				//insert PayoutGeneratedFileDT 
				if(iRet==PD_OK){
					//PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_SENT);
					PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_SENDING);
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","Add");
					if ((unsigned long)(*DBObjPtr)(hDetail) != PD_OK) {
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutSend::Add BPayoutGeneratedFileDT Failed!!!!\n"));
						PutField_Int(hContext,"internal_error",iRet);
						break;
					}
				}
			}
/////////////////////////////(end while)
			iOrgCnt++;
			sprintf(csTag,"%s_org_txn_cnt",csPspId);
			PutField_Int(hHeader,csTag,iOrgCnt);

			if(iRet==PD_OK){
				//update status, file_id and psp_id
				PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
				PutField_CString(hTxn,"psp_id",csPspId);
				DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","UpdateDetailByBatchId");
				if ((*DBObjPtr)(csBatchId,iTmp,hTxn) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("BOPayout::DBMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
					PutField_Int(hContext,"internal_error",iRet);
					break;
				}
			}

			if(iRet==PD_OK){
				PutField_CString(hOrgHd,"sub_status",PD_APPROVED_AND_SENDING);
				DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
				if ((unsigned long)(*DBObjPtr)(hOrgHd) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("BOPayout::DBTransaction:Update Failed\n"));
				}
			}
			iTxnTotal ++;
			PutField_Int(hHeader,"org_total_txn_count",iTxnTotal);
			hRec = RecordSet_GetNext(rRecordSet);
		}


		if(iRet==PD_OK){
			//insert header
			iTotal = 0;
			GetField_Int(hHeader,"batch_cnt",&iBatchCnt);
			for(i=0; i<iBatchCnt; i++){
				sprintf(csTag,"batch_id_%d",i);
				if(GetField_CString(hHeader,csTag,&csBatchId)){
					PutField_CString(hHeader,"batch_id",csBatchId);
			
					lBatchId = ctol((const unsigned char *)csBatchId,strlen(csBatchId));
DEBUGLOG(("******************lBatchId[%ld]  lTmp[%ld]\n",lBatchId,lTmp));
					if (lTmp!=lBatchId){
						lTmp = lBatchId;

						recordset_init(rRecordSet,0);
						DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","GetHeader");
						if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
							hRec = RecordSet_GetFirst(rRecordSet);
							while (hRec) {
								if(GetField_CString(hRec,"service_code",&csTmp)){
									PutField_CString(hHeader,"service_code",csTmp);
								}
								hRec = RecordSet_GetNext(rRecordSet);
							}
						}

						if(iRet==PD_OK){
							sprintf(csTag,"%s_psp_id",csBatchId);
							if(GetField_CString(hHeader,csTag,&csPspId)){
								PutField_CString(hHeader,"psp_id",csPspId);
							}
							sprintf(csTag,"%s_merchant_id",csBatchId);
							if(GetField_CString(hHeader,csTag,&csTmp)){
								PutField_CString(hHeader,"merchant_id",csTmp);
							}
							sprintf(csTag,"%s_txn_count",csBatchId);
							if(GetField_Int(hHeader,csTag,&iTmp)){
								PutField_Int(hHeader,"num_of_record",iTmp);
								//PutField_Int(hHeader,"txn_cnt",iTmp);

								iTotal+=iTmp;
								PutField_Int(hHeader,"file_total_txn_count",iTotal);
							}
							sprintf(csTag,"%s_txn_amt",csBatchId);
							if(GetField_Double(hHeader,csTag,&dTmp)){
								PutField_Double(hHeader,"txn_amt",dTmp);

								dTotal+=dTmp;
								PutField_Double(hHeader,"file_total_txn_amt",dTotal);
							}
							sprintf(csTag,"%s_file_id",csBatchId);
							if(GetField_CString(hHeader,csTag,&csTmp)){
								PutField_CString(hHeader,"queue_seq",csTmp);
							}

							DBObjPtr = CreateObj(DBPtr,"DBPayoutQueueHd","Add");
							if((unsigned long)(*DBObjPtr)(hHeader)==PD_OK){
DEBUGLOG(("BOPayout::handle_PayoutSend Add PayoutQueueHd Success\n"));
							}
							else{
								iRet=INT_ERR;
DEBUGLOG(("BOPayout::handle_PayoutSend Add PayoutQueueHd Failed!!!!\n"));
								PutField_Int(hContext,"internal_error",iRet);
								break;
							}

							
						}
/*
						if(iRet==PD_OK){
DEBUGLOG(("handle_PayoutSend::Call CreatePayoutFileDetail\n"));
							if(CreatePayoutFileDetail(csPspId,hContext)!=PD_OK){
DEBUGLOG(("CreatePayoutFile for[%s] Failed!!!!\n",csTmp));
								iRet=INT_ERR;
								PutField_Int(hContext,"internal_error",iRet);
								break;
							}
						}
*/
/*
						if(iRet==PD_OK){
							sprintf(csTag,"%s_file_id",csBatchId);
							if(GetField_CString(hHeader,csTag,&csTmp)){
								PutField_CString(hHeader,"file_id",csTmp);
							}
							
							sprintf(csTag,"%s_file",csPspId);
							if(GetField_CString(hContext,csTag,&csTmp)){
								PutField_CString(hHeader,"filename",csTmp);
							}
							
							sprintf(csTag,"%s_file_date",csPspId);
							if(GetField_CString(hContext,csTag,&csTmp)){
								PutField_CString(hHeader,"file_date",csTmp);
							}

							sprintf(csTag,"%s_seq_num",csPspId);
							if(GetField_Int(hContext,csTag,&iTmp)){
								PutField_Int(hHeader,"seq_num",iTmp);
							}

							sprintf(csTag,"%s_txn_ccy",csBatchId);
							if(GetField_CString(hHeader,csTag,&csTmp)){
								PutField_CString(hHeader,"ccy_id",csTmp);
							}

							sprintf(csTag,"%s_txn_amt",csBatchId);
							if(GetField_Double(hHeader,csTag,&dTmp)){
								PutField_Double(hHeader,"txn_amt",dTmp);
							}

							PutField_CString(hHeader,"file_pid",csPspId);
							PutField_Int(hHeader,"status",PD_PAYOUTFILE_PRE_SEND);
							DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Add");
							if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("handle_PayoutSend::PayoutGeneratedFileHD::Add Error!!!\n"));
								iRet = INT_ERR;
								PutField_Int(hContext,"internal_error",iRet);
								break;
							}
							DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
							if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("handle_PayoutSend::PayoutGeneratedFileHD::Update Error!!!\n"));
								iRet = INT_ERR;
								PutField_Int(hContext,"internal_error",iRet);
								break;
							}
							
							PutField_CString(hHeader,"psp_id",csPspId);
							if(GetPayoutFilePath(hHeader)==PD_OK){
								if(CreatePayoutFile(csPspId,hHeader)!=PD_OK){
DEBUGLOG(("handle_PayoutSend::CreatePayoutFile failed for [%s]!!\n",csPspId));
									iRet= INT_ERR;
									break;
								}
							}
							
						}
*/
/*
						if(iRet==PD_OK && !strcmp(csPspId,PD_CHANNEL_TWV)){
							hash_t *hFile;
							hFile= (hash_t*) malloc (sizeof(hash_t));
							hash_init(hFile,0);

							sprintf(csTag, "%s_path", csPspId);
							GetField_CString(hHeader,csTag,&csFilePath);

							iTxnCnt = 0;
							sprintf(csTag,"%s_txn_count",csBatchId);
							GetField_Int(hHeader,csTag,&iTxnCnt);
							for(i=0; i<iTxnCnt; i++){
								hash_init(hFile,0);
								sprintf(csTag,"%s_%d_gen_txn_id",csBatchId,i+1);
								if(GetField_CString(hDetail,csTag,&csTmp)){
									PutField_CString(hFile,"gen_txn_id",csTmp);
								}

								sprintf(csTag,"%s_%d_bank_code",csBatchId,i);
								if(GetField_CString(hDetail,csTag,&csTmp)){
									PutField_CString(hFile,"bank_code",csTmp);
								}

								sprintf(csTag,"%s_%d_branch",csBatchId,i);
								if(GetField_CString(hDetail,csTag,&csTmp)){
									PutField_CString(hFile,"branch",csTmp);
								}

								sprintf(csTag,"%s_%d_account_name",csBatchId,i);
								if(GetField_CString(hDetail,csTag,&csTmp)){
									PutField_CString(hFile,"account_name",csTmp);
								}

								sprintf(csTag,"%s_%d_account_num",csBatchId,i);
								if(GetField_CString(hDetail,csTag,&csTmp)){
									PutField_CString(hFile,"account_num",csTmp);
								}

								sprintf(csTag,"%s_%d_identity_id",csBatchId,i);
								if(GetField_CString(hDetail,csTag,&csTmp)){
									PutField_CString(hFile,"identity_id",csTmp);
								}

								sprintf(csTag,"%s_%d_payout_amount",csBatchId,i);
								if(GetField_Double(hDetail,csTag,&dTmp)){
									PutField_Double(hFile,"payout_amount",dTmp);
								}

								PutField_CString(hFile,"psp_id",csPspId);
								if(WritePayoutFile(csFilePath,hFile)!=PD_OK){
									iRet = INT_ERR;
DEBUGLOG(("handle_PayoutSend::WritePayoutFile Error!!!\n"));
ERRLOG("BOPayout::handle_PayoutSend:WritePayoutFile Error!!!\n");
								}
							}//end for
							FREE_ME(hFile);
						}


*/					}//end if same batch
				}//end if get hHeader batch_id
			}//end for loop
		}
		
		if(iRet==PD_OK){
			if(GetField_CString(hHeader,"psp_id",&csPspId)){
				PutField_CString(hHeader,"file_pid",csPspId);
			}
			if(GetField_CString(hHeader,"generated_file_id",&csTmp)){
				PutField_CString(hHeader,"file_id",csTmp);
			}
			//if(GetField_Int(hHeader,"file_total_txn_count",&iTmp)){
			if(GetField_Int(hHeader,"org_total_txn_count",&iTmp)){
				PutField_Int(hHeader,"txn_cnt",iTmp);
			}
			if(GetField_Double(hHeader,"file_total_txn_amt",&dTmp)){
				PutField_Double(hHeader,"txn_amt",dTmp);
			}


DEBUGLOG(("handle_PayoutSend::Call CreatePayoutFileDetail\n"));
			if(CreatePayoutFileDetail(csPspId,hContext)!=PD_OK){
DEBUGLOG(("CreatePayoutFile for[%s] Failed!!!!\n",csPspId));
					iRet=INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
			}


			if(iRet==PD_OK){
				sprintf(csTag,"%s_file",csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"filename",csTmp);
					PutField_CString(hHeader,"generated_file_name",csTmp);
				}

				sprintf(csTag,"%s_file_date",csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"file_date",csTmp);
				}

				sprintf(csTag,"%s_seq_num",csPspId);
				if(GetField_Int(hContext,csTag,&iTmp)){
					PutField_Int(hHeader,"seq_num",iTmp);
				}

				sprintf(csTag,"%s_txn_ccy",csPspId);
				if(GetField_CString(hHeader,csTag,&csTmp)){
					PutField_CString(hHeader,"ccy_id",csTmp);
				}
/*
				sprintf(csTag,"%s_org_txn_cnt",csPspId);
				if(GetField_Int(hHeader,csTag,&iTmp)){
					PutField_Int(hHeader,"txn_cnt",iTmp);
				}
*/
				PutField_Int(hHeader,"status",PD_PAYOUTFILE_PRE_SEND);
				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Add");
				if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("handle_PayoutSend::PayoutGeneratedFileHD::Add Error!!!\n"));
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
				}
				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
				if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("handle_PayoutSend::PayoutGeneratedFileHD::Update Error!!!\n"));
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
				}

				//PutField_CString(hHeader,"psp_id",csPspId);
				if(GetPayoutFilePath(hHeader)==PD_OK){
					hash_t* hPspDetail;
                                        hPspDetail = (hash_t*) malloc (sizeof(hash_t));
                                        hash_init(hPspDetail,0);
                                        DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
                                        if ((*DBObjPtr)(csPspId,hPspDetail) == PD_OK) {
                                                if (GetField_CString(hPspDetail,"psp_channel_code",&csPspChannel)) {
							//if(CreatePayoutFile(csPspChannel,csPspId,hHeader)!=PD_OK){
							if(CreatePayoutFile(hHeader)!=PD_OK){
DEBUGLOG(("handle_PayoutSend::CreatePayoutFile failed for [%s][%s]!!\n",csPspChannel,csPspId));
								iRet= INT_ERR;
							}
						}
					}
					else{
						iRet= INT_ERR;
DEBUGLOG(("handle_PayoutSend::cannot find channel for [%s]!!\n",csPspId));
					}
					FREE_ME(hPspDetail);
				}
				if(iRet==PD_OK){
					//update file_id and file_name
					DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","UpdateFileNameByFileId");
					if ((*DBObjPtr)(hHeader) != PD_OK) {
DEBUGLOG(("BOPayout::DBMerchantUploadFileDetail:UpdateFileNameByFileId Failed\n"));
					}
				}


			}

			if(iRet==PD_OK && !strcmp(csPspChannel,PD_CHANNEL_TWV)){
				iBatchCnt = 0;
				int j=0;
				hash_t *hFile;
				hFile= (hash_t*) malloc (sizeof(hash_t));
				hash_init(hFile,0);

				sprintf(csTag, "%s_path", csPspId);
				GetField_CString(hHeader,csTag,&csFilePath);

				GetField_Int(hHeader,"batch_cnt",&iBatchCnt);
				for(j=0; j<iBatchCnt; j++){
					sprintf(csTag,"batch_id_%d",j);
					if(GetField_CString(hHeader,csTag,&csBatchId)){
DEBUGLOG(("handle_PayoutSend::Process BatchId[%s]\n",csBatchId));

						iTxnCnt = 0;
						sprintf(csTag,"%s_txn_count",csBatchId);
						GetField_Int(hHeader,csTag,&iTxnCnt);
DEBUGLOG(("handle_PayoutSend::Record Count[%d]\n",iTxnCnt));
						for(i=0; i<iTxnCnt; i++){
							hash_init(hFile,0);
							sprintf(csTag,"%s_%d_gen_txn_id",csBatchId,i+1);
							if(GetField_CString(hDetail,csTag,&csTmp)){
								PutField_CString(hFile,"gen_txn_id",csTmp);
							}

							sprintf(csTag,"%s_%d_bank_code",csBatchId,i);
							if(GetField_CString(hDetail,csTag,&csTmp)){
								PutField_CString(hFile,"bank_code",csTmp);
							}

							sprintf(csTag,"%s_%d_branch",csBatchId,i);
							if(GetField_CString(hDetail,csTag,&csTmp)){
								PutField_CString(hFile,"branch",csTmp);
							}

							sprintf(csTag,"%s_%d_account_name",csBatchId,i);
							if(GetField_CString(hDetail,csTag,&csTmp)){
								PutField_CString(hFile,"account_name",csTmp);
							}

							sprintf(csTag,"%s_%d_account_num",csBatchId,i);
							if(GetField_CString(hDetail,csTag,&csTmp)){
								PutField_CString(hFile,"account_num",csTmp);
							}

							sprintf(csTag,"%s_%d_identity_id",csBatchId,i);
							if(GetField_CString(hDetail,csTag,&csTmp)){
								PutField_CString(hFile,"identity_id",csTmp);
							}

							sprintf(csTag,"%s_%d_payout_amount",csBatchId,i);
							if(GetField_Double(hDetail,csTag,&dTmp)){
								PutField_Double(hFile,"payout_amount",dTmp);
							}

							//PutField_CString(hFile,"psp_id",csPspId);
							PutField_CString(hFile,"psp_channel",csPspChannel);
							if(WritePayoutFile(csFilePath,hFile)!=PD_OK){
								iRet = INT_ERR;
DEBUGLOG(("handle_PayoutSend::WritePayoutFile Error!!!\n"));
ERRLOG("BOPayout::handle_PayoutSend:WritePayoutFile Error!!!\n");
							}
						}//end for
						hash_init(hFile,0);
					}
				}//end for batch
				FREE_ME(hFile);
			}

		}
		FREE_ME(csPayoutTxnSeq);
	}
	else{
		iRet = INT_NO_PENDING_RECORD;
DEBUGLOG(("BOPayout::handle_PayoutSend: No Online Payout Records \n"));
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hOrgHd);
	FREE_ME(hHeader);
	FREE_ME(hDetail);
	FREE_ME(hTxn);
	FREE_ME(csTmpBID);
	//FREE_ME(csPayoutTxnSeq);

	//PutField_Int(hContext,"return_send",iRet);
	//return iChk;
	return iRet;

}

int handle_to_PayoutGenerate(hash_t *hContext,
			  hash_t* hRequest,
			  hash_t* hHeader)
{
DEBUGLOG(("BOPayout::handle_to_PayoutGenerate()\n"));

	int     iRet = PD_OK;
	char	*csTmp;
	hash_t  *hRec, *hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
	
DEBUGLOG(("handle_to_PayoutGenerate::Call DBPayoutGeneratedFileHD:GetPreGenHeader\n"));
	DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetPreGenHeader");
	if((unsigned long)(*DBObjPtr)(PD_PAYOUTFILE_PRE_GENERATED,rRecordSet)==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
		while ((hRec) && (iRet==PD_OK)) {
			if(GetField_CString(hRec,"file_id",&csTmp)){
				PutField_CString(hTxn,"file_id",csTmp);
DEBUGLOG(("GetPreGenHeader::file_id = [%s]\n",csTmp));

				PutField_Int(hTxn,"status",PD_PAYOUTFILE_WAITING_GENERATE);
				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
				if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
DEBUGLOG(("Authorize::PayoutGeneratedFileHD::Update Error!!!\n"));
					iRet = INT_ERR;
				}
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}

	FREE_ME(hTxn);
	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
	return iRet;
}

int handle_PayoutGenerate(hash_t *hContext,
			  hash_t* hRequest,
			  hash_t* hHeader)
{
	int     iRet = PD_OK;
	int     iChk= PD_OK;
	int	iGenId = 0;
	int	iCnt= 0;
	int	iTmp= 0;
	int	iSeqNum= 0;
	char	*csTmp;
	char	*csPspId;
	char	*csTxnCcy;
	char	*csFilePath;
	char	*csPayoutTxnSeq;
	char	*csBatchId;
	char	cBatchMode= PD_OFFLINE;
	double	dTmp;
	double	dPayoutAmt = 0.0;
	double	dSplitAmt = 0.0;
	double	dRemainAmt= 0.0;
	double	dAmt= 0.0;
	double	dTmpAmt= 0.0;
	double	dTmpTotalAmt= 0.0;
	char	csTag[PD_TAG_LEN +1];

	hash_t  *hRec, *hTxn, *hDetail, *hUploadTxn, *hElement;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);
	hDetail= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hDetail,0);
	hUploadTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hUploadTxn,0);
	hElement= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hElement,0);
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout::handle_PayoutGenerate()\n"));

	if(GetField_CString(hRequest,"preview_id",&csTmp)){
		iGenId = atoi(csTmp);
DEBUGLOG(("handle_PayoutGenerate::Preview Id = [%d]\n",iGenId));
	}
	else{
		iRet = INT_ERR;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("handle_PayoutGenerate::Preview Id Not found!!!!!\n"));
ERRLOG("handle_PayoutGenerate::Preview Id Not found!!!!!\n");
	}

	if(iRet == PD_OK){
		//hold gen id
DEBUGLOG(("handle_PayoutGenerate::Call DBPayoutGeneratedTmp:GetPreGenIdForUpdate\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedTmp","GetPreGenIdForUpdate");
		iChk = (unsigned long) ((*DBObjPtr)(iGenId,PD_OK));
		if(iChk ==PD_FOUND){
DEBUGLOG(("handle_PayoutGenerate::Call DBPayoutGeneratedTmp:HoldPreGenId\n"));
			DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedTmp","HoldPreGenId");
			if((unsigned long) ((*DBObjPtr)(iGenId))==PD_OK){
				TxnCommit();
			}
			else{
				iRet = INT_ERR;
				PutField_Int(hContext,"internal_error",iRet);
			}
		}
		else{
			iRet = INT_NOT_RECORD;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("handle_PayoutGenerate::the pregen id is not available now\n"));
		}
		
	}

	if(iRet == PD_OK){
		iCnt = 0;
		recordset_init(rRecordSet,0);
DEBUGLOG(("handle_PayoutGenerate::Call DBPayoutGeneratedTmp:GetExistingPsp\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedTmp","GetExistingPsp");
		if((unsigned long) ((*DBObjPtr)(iGenId,rRecordSet))==PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				hash_init(hTxn,0);
				if(GetField_CString(hRec,"psp_id",&csPspId)){
					PutField_CString(hTxn,"file_pid",csPspId);
					sprintf(csTag,"psp_id_%d",iCnt);
					PutField_CString(hContext,csTag,csPspId);
DEBUGLOG(("GetExistingPsp psp_id [%s]\n",csPspId));

					dTmp = 0.0;
					DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspPayoutSplitAmt");
					if ((*DBObjPtr)(csPspId,hTxn) == PD_OK) {
						if (GetField_Double(hTxn,"payout_split_limit",&dTmp)) {
DEBUGLOG(("BOPayout: GetPspPayoutSplitAmt - split amount= [%lf]\n",dTmp));
						}
						else{
DEBUGLOG(("BOPayout: GetPspPayoutSplitAmt - no split amount found\n"));
						}
					}
					sprintf(csTag,"%s_split_amt",csPspId);
					PutField_Double(hContext,csTag,dTmp);

					if(GetField_CString(hRec,"psp_ccy",&csTmp)){
						PutField_CString(hTxn,"ccy_id",csTmp);
DEBUGLOG(("GetExistingPsp psp_ccy [%s]\n",csTmp));
					}

					if(GetField_Int(hRec,"txn_count",&iTmp)){
						PutField_Int(hTxn,"txn_cnt",iTmp);
DEBUGLOG(("GetExistingPsp txn_count [%d]\n",iTmp));
					}

					if(GetField_CString(hContext,"PHDATE",&csTmp)){
						PutField_CString(hTxn,"PHDATE",csTmp);
					}

					if(GetField_CString(hRequest,"add_user",&csTmp)){
						PutField_CString(hTxn,"add_user",csTmp);
					}

DEBUGLOG(("handle_PayouteGenerate::Call CreatePayoutFileDetail\n"));
					if(CreatePayoutFileDetail(csPspId,hTxn)!=PD_OK){
DEBUGLOG(("CreatePayoutFileDetail for[%s] Failed!!!!\n",csPspId));
						iRet=INT_ERR;
						PutField_Int(hContext,"internal_error",iRet);
						break;
					}

					PutField_Int(hTxn,"status",PD_PAYOUTFILE_PRE_GENERATED);
					//insert gen header
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Add");
					if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
DEBUGLOG(("handle_PayouteGenerate::PayoutGeneratedFileHD::Add Error!!!\n"));
						iRet = INT_ERR;
						PutField_Int(hContext,"internal_error",iRet);
						break;
					}

					//create file and write header
DEBUGLOG(("handle_PayouteGenerate::Call CreatePayoutFile\n"));
					if(CreatePayoutFile(hTxn)!=PD_OK){
DEBUGLOG(("CreatePayoutFile for Failed!!!!\n"));
						iRet=INT_ERR;
						PutField_Int(hContext,"internal_error",iRet);
						break;
					}

					if(GetField_CString(hTxn,"file_id",&csTmp)){
						sprintf(csTag,"%s_file_id",csPspId);
						PutField_CString(hContext,csTag,csTmp);
					}

					if(GetField_CString(hTxn,"file_path",&csTmp)){
						sprintf(csTag,"%s_file_path",csPspId);
						PutField_CString(hContext,csTag,csTmp);
					}

					if(GetField_CString(hTxn,"filename",&csTmp)){
						sprintf(csTag,"%s_filename",csPspId);
						PutField_CString(hContext,csTag,csTmp);
					}

					if(GetField_CString(hTxn,"psp_channel",&csTmp)){
						sprintf(csTag,"%s_psp_channel",csPspId);
						PutField_CString(hContext,csTag,csTmp);
					}

					if(GetField_CString(hTxn,"psp_client",&csTmp)){
						sprintf(csTag,"%s_psp_client",csPspId);
						PutField_CString(hContext,csTag,csTmp);
					}

					iCnt ++;
					PutField_Int(hContext,"psp_count",iCnt);
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	//get all records from payout_generated_tmp with details (for update)
	if(iRet == PD_OK){
		int i, iTxnCnt;
		recordset_init(rRecordSet,0);
DEBUGLOG(("handle_PayouteGenerate::Call DBMerchantUploadFileDetail:GetPregeneratedRecords\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetPregeneratedRecords");
		if((unsigned long)(*DBObjPtr)(iGenId,rRecordSet)==PD_OK){
			i = 0;
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec && (iRet==PD_OK)) {
				hash_init(hTxn,0);
				hash_init(hDetail,0);
				hash_init(hUploadTxn,0);
				hash_init(hElement,0);
				if(GetField_CString(hRequest,"add_user",&csTmp)){
					PutField_CString(hDetail,"add_user",csTmp);
					PutField_CString(hContext,"add_user",csTmp);
					PutField_CString(hTxn,"update_user",csTmp);
					PutField_CString(hTxn,"add_user",csTmp);
				}
				if (GetField_CString(hRec, "psp_id", &csPspId)) {
					PutField_CString(hTxn,"psp_id",csPspId);
					PutField_CString(hTxn,"org_psp_id",csPspId);

					sprintf(csTag, "%s_filename", csPspId);
					GetField_CString(hContext,csTag,&csTmp);
					PutField_CString(hTxn,"generated_file_name",csTmp);

					sprintf(csTag, "%s_file_id", csPspId);
					GetField_CString(hContext,csTag,&csTmp);
					sprintf(csTag,"pregen_file_id_%d", i);
					PutField_CString(hRequest,csTag,csTmp);
					PutField_CString(hDetail,"file_id",csTmp);
					PutField_CString(hTxn,"file_id",csTmp);

					sprintf(csTag, "%s_psp_channel", csPspId);
					GetField_CString(hContext,csTag,&csTmp);
					PutField_CString(hDetail,"psp_channel",csTmp);

					sprintf(csTag, "%s_psp_client", csPspId);//for update txn_header
					GetField_CString(hContext,csTag,&csTmp);
					PutField_CString(hDetail,"client_id",csTmp);

					sprintf(csTag, "%s_file_path", csPspId);
					GetField_CString(hContext,csTag,&csFilePath);
DEBUGLOG(("GetPregeneratedRecords::psp_id = [%s]\n",csPspId));
				}
				if (GetField_CString(hRec, "txn_id", &csTmp)) {
					PutField_CString(hDetail,"upload_txn_id",csTmp);
					PutField_CString(hUploadTxn,"txn_seq",csTmp);
DEBUGLOG(("GetPregeneratedRecords::upload_txn_id = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec, "batch_id", &csBatchId)) {
					sprintf(csTag, "batch_id_%d", i);
					PutField_CString(hRequest,csTag,csBatchId);
					PutField_CString(hDetail,"batch_id",csBatchId);
DEBUGLOG(("GetPregeneratedRecords::batch_id = [%s]\n",csBatchId));
				}
				if (GetField_Int(hRec, "seq_num", &iSeqNum)) {
					sprintf(csTag, "seq_num_%d", i);
					PutField_Int(hRequest,csTag,iSeqNum);
					PutField_Int(hDetail,"seq_num",iSeqNum);
DEBUGLOG(("GetPregeneratedRecords::seq_num = [%d]\n",iSeqNum));
				}
				if (GetField_CString(hRec,"txn_country", &csTmp)) {
					sprintf(csTag, "%s_txn_country", csPspId);
					PutField_CString(hContext,csTag,csTmp);
					PutField_CString(hDetail,"txn_country",csTmp);
					PutField_CString(hTxn,"txn_country",csTmp);
					PutField_CString(hTxn,"org_txn_country",csTmp);
DEBUGLOG(("GetPregeneratedRecords::txn_country = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"request_ccy", &csTmp)) {
					PutField_CString(hDetail,"request_ccy",csTmp);
DEBUGLOG(("GetPregeneratedRecords::request_ccy = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"payout_ccy", &csTmp)) {
					if(strcmp(csTmp,"RMB"))
						csTxnCcy=strdup(csTmp);
					else
						csTxnCcy=strdup(PD_CCY_ISO_CNY);

					sprintf(csTag, "%s_payout_ccy", csPspId);
					PutField_CString(hContext,csTag,csTxnCcy);
					PutField_CString(hDetail,"payout_ccy",csTxnCcy);
					PutField_CString(hTxn,"txn_ccy",csTxnCcy);
					PutField_CString(hTxn,"org_psp_txn_ccy",csTxnCcy);
					PutField_CString(hElement,"org_txn_ccy",csTxnCcy);
                                        PutField_CString(hElement,"src_txn_fee_ccy",csTxnCcy);
					FREE_ME(csTxnCcy);
DEBUGLOG(("GetPregeneratedRecords::payout_ccy = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"account_name", &csTmp)) {
					PutField_CString(hDetail,"account_name",csTmp);
DEBUGLOG(("GetPregeneratedRecords::account_name = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"account_num", &csTmp)) {
					PutField_CString(hDetail,"account_num",csTmp);
DEBUGLOG(("GetPregeneratedRecords::account_num = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"bank_name", &csTmp)) {
					PutField_CString(hDetail,"bank_name",csTmp);
DEBUGLOG(("GetPregeneratedRecords::bank_name = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"branch", &csTmp)) {
					PutField_CString(hDetail,"branch",csTmp);
DEBUGLOG(("GetPregeneratedRecords::branch = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"identity_id", &csTmp)) {
					PutField_CString(hDetail,"identity_id",csTmp);
DEBUGLOG(("GetPregeneratedRecords::identity_id = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"phone_num", &csTmp)) {
					PutField_CString(hDetail,"phone_num",csTmp);
DEBUGLOG(("GetPregeneratedRecords::phone_num = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"merchant_ref", &csTmp)) {
					PutField_CString(hDetail,"merchant_ref",csTmp);
DEBUGLOG(("GetPregeneratedRecords::merchant_ref = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"remark", &csTmp)) {
DEBUGLOG(("GetPregeneratedRecords::remark = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"province", &csTmp)) {
					PutField_CString(hDetail,"province",csTmp);
DEBUGLOG(("GetPregeneratedRecords::province = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"city", &csTmp)) {
					PutField_CString(hDetail,"city",csTmp);
DEBUGLOG(("GetPregeneratedRecords::city = [%s]\n",csTmp));
				}
				if (GetField_Double(hRec,"request_amount", &dTmp)) {
					PutField_Double(hDetail,"request_amount",dTmp);
DEBUGLOG(("GetPregeneratedRecords::request_amount = [%lf]\n",dTmp));
				}
				if (GetField_Double(hRec,"payout_amount", &dPayoutAmt)) {
					dRemainAmt = dPayoutAmt;
DEBUGLOG(("GetPregeneratedRecords::payout_amount = [%lf]\n",dPayoutAmt));

					sprintf(csTag,"org_dst_net_amt_%s",csPspId);
					if(GetField_Double(hContext,csTag,&dAmt)){
						dAmt += dTmp;
					}
					else{
						dAmt = dTmp;
					}
					PutField_Double(hContext,csTag,dAmt);

					sprintf(csTag,"%s_txn_amt",csPspId);
					if(GetField_Double(hContext,csTag,&dAmt)){
						dAmt += dPayoutAmt;
					}
					else{
						dAmt = dPayoutAmt;
					}
					PutField_Double(hContext,csTag,dAmt);
				}
//////////
//split by average
				sprintf(csTag,"%s_split_amt",csPspId);
				dSplitAmt = 0.0;
				dTmpTotalAmt = 0.0;
				GetField_Double(hContext,csTag,&dSplitAmt);
				int iSplitCnt = 1;
				if(dSplitAmt>0){
					iSplitCnt = (int)(dPayoutAmt/dSplitAmt);
					if(dPayoutAmt>(dSplitAmt*iSplitCnt)){
						iSplitCnt ++;
					}

DEBUGLOG(("handle_PayouteGenerate:: Split Count: [%d]\n",iSplitCnt));

					dTmpAmt = 0.0;
					dTmpTotalAmt = 0.0;

					dTmpAmt = newround(dPayoutAmt/iSplitCnt,0);
					for(iTmp=0;iTmp<(iSplitCnt-1);iTmp++){
						sprintf(csTag,"avag_split_amt_%d",iTmp);
						PutField_Double(hContext,csTag,dTmpAmt);
						dTmpTotalAmt += dTmpAmt;
					}
				}
				sprintf(csTag,"avag_split_amt_%d",(iSplitCnt-1));
				PutField_Double(hContext,csTag,dPayoutAmt-dTmpTotalAmt);

				for(iTmp=0;iTmp<iSplitCnt;iTmp++){
					sprintf(csTag,"avag_split_amt_%d",iTmp);
					if(GetField_Double(hContext,csTag,&dTmp)){
						PutField_Double(hDetail,"payout_amount",dTmp);
						PutField_Double(hTxn,"org_dst_net_amt",dTmp);
						PutField_Double(hElement,"org_txn_amt",dTmp);
					}

					//import to payout_generated_file_dt
					DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextPayoutTxnSeq");
					csPayoutTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("handle_PayouteGenerate:: GeneratePayoutSeq: [%d]=[%s]\n",i,csPayoutTxnSeq));
                        		PutField_CString(hDetail,"txn_id",csPayoutTxnSeq);
                        		PutField_CString(hContext,"txn_seq",csPayoutTxnSeq);
                        		PutField_CString(hTxn,"txn_id",csPayoutTxnSeq);
					PutField_CString(hElement,"from_txn_seq",csPayoutTxnSeq);
					if(cBatchMode==PD_OFFLINE)
						PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
					else
						PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_SENT);
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","Add");
					if ((unsigned long)(*DBObjPtr)(hDetail) != PD_OK) {
						iRet = INT_ERR;
DEBUGLOG(("handle_PayouteGenerate:: DBPayoutGeneratedFileDT:Add Failed\n"));
ERRLOG("handle_PayouteGenerate:: DBPayoutGeneratedFileDT:Add Failed\n");
						break;
					}

					//write to file
					if(WritePayoutFile(csFilePath,hDetail)!=PD_OK){
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::WritePayoutFile Error!!!\n"));
ERRLOG("BOPayout::handle_PayoutGenerate:WritePayoutFile Error!!!\n");
						break;
					}

					//create txn to txn_header and detail
					if(iRet==PD_OK){
						PutField_CString(hContext,"process_type","0000");
						PutField_CString(hContext,"process_code","000000");
						PutField_Int(hContext,"do_logging",PD_TRUE);
						PutField_Int(hContext,"db_commit",PD_FALSE);

DEBUGLOG(("handle_PayoutGenerate::Call MGTChannel:AddTxnLog\n"));
						ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnLog");
						if((unsigned long) ((*ChannelObjPtr)(hContext,hDetail))!=PD_OK){
							iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::MGTChannel:AddTxnLog Failed\n"));
						}
						PutField_Int(hContext,"do_logging",PD_FALSE);
					}
					if(iRet==PD_OK){
						//calulate cost
						PutField_Char(hTxn,"txn_type",PD_TYPE_PAYOUT);
DEBUGLOG(("handle_PayoutGenerate::Call BOPsp CalPspCosts\n"));
                                                BOObjPtr = CreateObj(BOPtr,"BOPsp","CalPspCosts");
                                                if((unsigned long)(*BOObjPtr)(hTxn,hRequest)==PD_OK){
                                                        if(GetField_Double(hTxn,"precal_fee",&dTmp)){
                                                                PutField_Double(hElement,"src_txn_fee",dTmp);
DEBUGLOG(("handle_PayoutGenerate::payout_cost[%lf]\n",dTmp));
                                                        }
                                                }
					}
					//add txn_element
                                        if(iRet==PD_OK){
						PutField_Char(hElement,"party_type",PD_TYPE_PSP);
						PutField_CString(hElement,"amount_type",PD_DR);
DEBUGLOG(("handle_PayoutGenerate::Call BOTxnElements:AddTxnAmtElement\n"));
						BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnAmtElement");
						iRet = (unsigned long)(*BOObjPtr)(hElement);

						if(iRet==PD_OK){
DEBUGLOG(("handle_PayoutGenerate::Call BOTxnElements:AddTxnFeeElements\n"));
							BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnFeeElements");
							iRet = (unsigned long)(*BOObjPtr)(hElement);
						}
					}

					//update txn_header and txn_psp_detail
					if(iRet==PD_OK){
DEBUGLOG(("handle_PayoutGenerate::Call BOBalance:UpdatePayoutAmount\n"));
						PutField_Char(hTxn,"party_type",PD_TYPE_PSP);
						PutField_Char(hTxn,"response_mode",PD_ACCEPT);
						BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
						if((unsigned long)(*BOObjPtr)(hTxn)!=PD_OK){
DEBUGLOG(("handle_PayoutGenerate::BOBalance:UpdatePayoutAmount Failed\n"));
							iRet = INT_ERR;
						}
						else{
							if(GetField_CString(hContext,"PHDATE",&csTmp)){
								PutField_CString(hTxn,"PHDATE",csTmp);
							}
							if(GetField_CString(hRequest,"report_date",&csTmp)){
								PutField_CString(hTxn,"report_date",csTmp);
							}
							PutField_CString(hTxn,"desc","Payout (PSP)");
							iRet = UpdateTxnLog(hTxn);
							if(iRet!=PD_OK){
DEBUGLOG(("handle_PayoutGenerate::BOBalance:UpdateTxnLog Failed\n"));
								break;
							}
							else{
								TxnCommit();
							}
						}
					}
						

					iTxnCnt = 0;
					sprintf(csTag,"%s_gen_txn_cnt",csPspId);
					GetField_Int(hContext,csTag,&iTxnCnt);
					PutField_Int(hContext,csTag,iTxnCnt+1);

				}

				//update txn status+detail to merchant_upload_file_dt and update status to txn header
				if(iRet == PD_OK){
					PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
					DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","UpdateDetailByBatchId");
					if ((*DBObjPtr)(csBatchId,iSeqNum,hTxn) != PD_OK) {
						iRet = INT_ERR;
DEBUGLOG(("BOPayout::DBMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
					}
				}
				if(iRet == PD_OK){
					PutField_CString(hUploadTxn,"sub_status",PD_APPROVED_AND_GENERATED);
DEBUGLOG(("handle_PayoutGenerate::Call DBTransaction:Update (UploadTxn)\n"));
					DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
					if((unsigned long) ((*DBObjPtr)(hUploadTxn))!=PD_OK){
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::DBTransaction:Update Failed\n"));
					}
				}
				
				iTxnCnt = 0;
				sprintf(csTag,"%s_txn_cnt",csPspId);
				GetField_Int(hContext,csTag,&iTxnCnt);
				PutField_Int(hContext,csTag,iTxnCnt+1);

				i++;
				hRec = RecordSet_GetNext(rRecordSet);
			}

			if(iRet == PD_OK && i>0){
				hash_init(hTxn,0);
				PutField_Int(hTxn,"end_file",PD_TRUE);
				iRet = WritePayoutFile(csFilePath,hTxn);
			}
			if(i==0){
				iRet = INT_NOT_RECORD;
				PutField_Int(hTxn,"internal_error",iRet);
			}

		}
	}

	//update total amount and status to payout_generated_file_hd
	if(iRet == PD_OK){
		iCnt = 0;
		int i;
		GetField_Int(hContext,"psp_count",&iCnt);
		for(i=0; i<iCnt; i++){
			hash_init(hTxn,0);
			sprintf(csTag,"psp_id_%d",i);
			if(GetField_CString(hContext,csTag,&csPspId)){
				sprintf(csTag,"%s_txn_amt",csPspId);
				GetField_Double(hContext,csTag,&dTmp);
				PutField_Double(hTxn,"txn_amt",dTmp);

				sprintf(csTag,"%s_file_id",csPspId);
				GetField_CString(hContext,csTag,&csTmp);
				PutField_CString(hTxn,"file_id",csTmp);

				PutField_Int(hTxn,"status",PD_PAYOUTFILE_GENERATED);
				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
				if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
DEBUGLOG(("BOPayout::handle_PayoutGenerate:PayoutGeneratedFileHD::Update Error!!!\n"));
ERRLOG("BOPayout::handle_PayoutGenerate:PayoutGeneratedFileHD::Update Error!!!\n");
					iRet = INT_ERR;
					break;
				}
			}
		}
	}


	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
        FREE_ME(hTxn);
        FREE_ME(hDetail);
        FREE_ME(hUploadTxn);
        FREE_ME(hElement);
DEBUGLOG(("BOPayout::handle_PayoutGenerate: [%d]\n",iRet));
	return iRet;
}


/*
int handle_PayoutGenerate(hash_t *hContext,
			  hash_t* hRequest,
			  hash_t* hHeader)
{
	int	iRet = PD_OK;
	int	i=0;
	int	iTmp=0;
	//int	iCnt=0;
	int	iPspCnt=0;
	char*	csTmp;
	char*	csPspId;
	char*	csFilePath;
	char*	csPayoutCcy;
	char*	csPspCountry;
	char*	csPspChannel;
	char	csTag[PD_TAG_LEN +1];
	//char	csNewTxnSeq[PD_TXN_SEQ_LEN +1];
	char	csTmpBatch[PD_TXN_SEQ_LEN +1];
	double	dBal=0.0;
	double	dAvalBal=0.0;
	double	dAmt=0.0;
	double	dTmp=0.0;
	double	dBatchAmt=0.0;
	double	dPspFee=0.0;
	int	iBatchCnt = 0;

DEBUGLOG(("BOPayout::handle_PayoutGenerate()\n"));

	hash_t  *hTmpRec, *hRec, *hDetail, *hTxn, *hUploadTxn;
	hash_t  *hElement;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);
	hUploadTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hUploadTxn,0);
	hElement= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hElement,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
	recordset_t     *rDetailSet;
	rDetailSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rDetailSet,0);
	recordset_t     *rTmpSet;
	rTmpSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rTmpSet,0);

DEBUGLOG(("handle_PayoutGenerate::Call DBPayoutGeneratedFileHD:GetPreGenHeader\n"));
	DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetPreGenHeader");
	if((unsigned long)(*DBObjPtr)(PD_PAYOUTFILE_PRE_GENERATED,rRecordSet)==PD_OK){
	//if((unsigned long)(*DBObjPtr)(PD_PAYOUTFILE_PROCESSING_GENERATE,rRecordSet)==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
		while ((hRec) && (iRet==PD_OK)) {
			if(GetField_CString(hRec,"file_id",&csTmp)){
				PutField_CString(hHeader,"file_id",csTmp);
				PutField_CString(hTxn,"file_id",csTmp);
				PutField_CString(hRequest,"file_id",csTmp);
DEBUGLOG(("GetPreGenHeader::file_id = [%s]\n",csTmp));
			}
			if(GetField_Int(hRec,"seq_num",&iTmp)){
				PutField_Int(hTxn,"seq_num",iTmp);
DEBUGLOG(("GetPreGenHeader::seq_num = [%d]\n",iTmp));
			}
			if(GetField_CString(hRec,"file_date",&csTmp)){
				PutField_CString(hTxn,"file_date",csTmp);
DEBUGLOG(("GetPreGenHeader::file_date = [%s]\n",csTmp));
			}
			if(GetField_Int(hRec,"txn_count",&iTmp)){
				PutField_Int(hTxn,"txn_cnt",iTmp);
DEBUGLOG(("GetPreGenHeader::txn_count = [%d]\n",iTmp));
			}
			if(GetField_CString(hRec,"psp_id",&csPspId)){
				PutField_CString(hRequest,"psp_id",csPspId);
				PutField_CString(hTxn,"psp_id",csPspId);
				PutField_CString(hTxn,"org_psp_id",csPspId);
				iPspCnt++;
				PutField_Int(hContext,"psp_count",iPspCnt);
DEBUGLOG(("GetPreGenHeader::psp_id = [%s]\n",csPspId));
			}
			
			if(GetField_CString(hRec,"payout_ccy",&csPayoutCcy)){
				PutField_CString(hContext,"org_psp_txn_ccy",csPayoutCcy);
				PutField_CString(hContext,"org_txn_ccy",csPayoutCcy);
DEBUGLOG(("GetPreGenHeader::payout_ccy = [%s]\n",csPayoutCcy));
			}

			if(GetField_Double(hRec,"total_txn_amt",&dAmt)){
				PutField_Double(hContext,"org_dst_net_amt",dAmt);
DEBUGLOG(("GetPreGenHeader::total_txn_amt = [%lf]\n",dAmt));
			}

			recordset_init(rTmpSet,0);
			DBObjPtr = CreateObj(DBPtr,"DBPspCountry","GetPspCountry");
			if((unsigned long) ((*DBObjPtr)(csPspId,rTmpSet))==PD_OK){
				hTmpRec = RecordSet_GetFirst(rTmpSet);
				while(hTmpRec){
					if (GetField_CString(hTmpRec,"ccy_id",&csTmp)) {
						if(strcmp(csTmp,csPayoutCcy)){
							continue;
						}
					}
					if (GetField_CString(hTmpRec,"country",&csPspCountry)) {
						PutField_CString(hContext,"txn_country",csPspCountry);
DEBUGLOG(("GetPreGenHeader::txn_country= [%s]\n",csPspCountry));
					}
					hTmpRec = RecordSet_GetNext(rTmpSet);
				}
			}
			else{
DEBUGLOG(("GetPreGenHeader::txn_country not found!!\n"));
ERRLOG("BOPayout::GetPreGenHeader::txn_country not found!!\n");
				iRet=INT_ERR;
				break;
                	}

			if(iRet==PD_OK){
				dBal = 0.0;
DEBUGLOG(("handle_PayoutGenerate::Call DBPspBalance:GetAvalPspBalance\n"));
				DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetAvalPspBalance");
				if((unsigned long)(*DBObjPtr)(csPspId,
							csPayoutCcy,
							csPspCountry,
							&dBal)==PD_OK){
DEBUGLOG(("GetAvalPspBalance balance = [%lf]\n",dBal));
					PutField_Double(hTxn,"org_psp_bal",dBal);
				}
				else{
					iRet = INT_ERR;
DEBUGLOG(("GetAvalPspBalance find balance failed!!!!\n"));
					break;
				}
			}
			if(iRet==PD_OK){
				dAvalBal = 0.0;
DEBUGLOG(("handle_PayouteGenerate::Call BOPsp:GetAvalPspBalanceForPO\n"));
				BOObjPtr = CreateObj(BOPtr,"BOPsp","GetAvalPspBalanceForPO");
				if((unsigned long)(*BOObjPtr)(hTxn,hTxn)==PD_OK){
					if(GetField_Double(hTxn,"aval_psp_bal",&dAvalBal)){
DEBUGLOG(("GetAvalPspBalanceForPO aval psp balance = [%.2f]\n",dAvalBal));
					}
				}
				else{
					iRet = INT_ERR;
DEBUGLOG(("GetAvalPspBalanceForPO find aval psp balance failed!!!!\n"));
					break;
				}
				if(dAmt>dAvalBal){
					iRet = INT_INSUFFICIENT_FUND;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetAvalPspBalanceForPO aval psp balance[%.2f] less than total generate amount[%lf]!!!!\n",dAvalBal,dAmt));
					break;
				}
			}
			RemoveField_Int(hTxn,"txn_cnt");

			if(GetField_CString(hRec,"filename",&csTmp)){
				PutField_CString(hTxn,"filename",csTmp);
				PutField_CString(hRequest,"generated_file_name",csTmp);
DEBUGLOG(("GetPreGenHeader::filename = [%s]\n",csTmp));
			}
			
			if (iRet == PD_OK) {
				hash_t *hPsp;
				hPsp = (hash_t*) malloc (sizeof(hash_t));
				hash_init(hPsp,0);
				DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
				if (!(*DBObjPtr)(csPspId, hPsp)) {
					if (GetField_CString(hPsp,"client_id",&csTmp)) {
						PutField_CString(hContext,"psp_client_id",csTmp);
						PutField_CString(hRequest,"client_id",csTmp);
DEBUGLOG(("BOPayout::handle_PayoutGenerate: GetPspDetail - client id = [%s]\n",csTmp));
					}
					if (GetField_CString(hPsp,"psp_channel_code",&csPspChannel)) {
DEBUGLOG(("BOPayout::handle_PayoutGenerate: GetPspDetail - psp channel code = [%s]\n",csPspChannel));
					}
				}
				FREE_ME(hPsp);
			}

			if(GetPayoutFilePath(hTxn)==PD_OK){
				if(CreatePayoutFile(csPspChannel,csPspId,hTxn)!=PD_OK){
DEBUGLOG(("GetPreGenHeader::CreatePayoutFile failed for [%s]!!\n",csPspId));
					iRet= INT_ERR;
					break;
				}
			}
			else{
DEBUGLOG(("GetPreGenHeader::GetPayoutFilePath failed for [%s][%s]!!\n",csPspId,csTmp));
				iRet= INT_ERR;
				break;
			}
			sprintf(csTag, "%s_path", csPspId);
			GetField_CString(hTxn,csTag,&csFilePath);

//
//			if(iRet==PD_OK){
//				PutField_Int(hHeader,"status",PD_PAYOUTFILE_GENERATED);
//				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
//				if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
//DEBUGLOG(("Authorize::PayoutGeneratedFileHD::Update Error!!!\n"));
//					iRet = INT_ERR;
//				}
//			}

			i =0;
			csTmpBatch[0]='\0';
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_APPROVED);
			recordset_init(rDetailSet,0);
			hash_init(hUploadTxn,0);
DEBUGLOG(("handle_PayoutGenerate::Call DBPayoutGeneratedFileDT:GetDetail\n"));
			DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","GetDetail");
			if((unsigned long)(*DBObjPtr)(hTxn,rDetailSet)==PD_OK){
				hDetail = RecordSet_GetFirst(rDetailSet);
				while ((hDetail) && (iRet==PD_OK)){
					if(GetField_CString(hDetail,"txn_id",&csTmp)){
						sprintf(csTag,"txn_seq_%d",i);
						PutField_CString(hContext,csTag,csTmp);
						PutField_CString(hContext,"txn_seq",csTmp);
						PutField_CString(hElement,"from_txn_seq",csTmp);
					}
					if(GetField_CString(hDetail,"upload_txn_id",&csTmp)){
						PutField_CString(hUploadTxn,"txn_seq",csTmp);
					}
					if(GetField_CString(hDetail,"service_code",&csTmp)){
						sprintf(csTag,"service_code_%d",i);
						PutField_CString(hContext,csTag,csTmp);
					}
					sprintf(csTag,"dst_txn_ccy_%d",i);
					PutField_CString(hRequest,csTag,csPayoutCcy);
					sprintf(csTag,"txn_ccy_%d",i);
					PutField_CString(hRequest,csTag,csPayoutCcy);
					PutField_CString(hElement,"org_txn_ccy",csPayoutCcy);
					PutField_CString(hElement,"src_txn_fee_ccy",csPayoutCcy);

					sprintf(csTag,"psp_id_%d",i);
					PutField_CString(hRequest,csTag,csPspId);

					if(GetField_CString(hDetail,"batch_id",&csTmp)){
						if(strcmp(csTmpBatch,csTmp)){
							strcpy(csTmpBatch,csTmp);
							csTmpBatch[strlen(csTmp)]='\0';
							sprintf(csTag,"assign_batch_%d",iBatchCnt);
							PutField_CString(hContext,csTag,csTmpBatch);
							iBatchCnt++;
							PutField_Int(hContext,"assign_batch_cnt",iBatchCnt);
						}
						sprintf(csTag,"batch_id_%d",i);
						PutField_CString(hRequest,csTag,csTmpBatch);
DEBUGLOG(("handle_PayoutGenerate::GetDetail batch_id[%s]\n",csTmp));
					}
					if(GetField_Double(hDetail,"payout_amount",&dTmp)){
						dBatchAmt=0;
						sprintf(csTag,"%s_total_amt",csTmpBatch);
						GetField_Double(hContext,csTag,&dBatchAmt);
						dBatchAmt+=dTmp;
						PutField_Double(hContext,csTag,dBatchAmt);

						sprintf(csTag,"gen_payout_amt_%d",i);
						PutField_Double(hRequest,csTag,dTmp);
						PutField_Double(hElement,"org_txn_amt",dTmp);

DEBUGLOG(("handle_PayoutGenerate::GetDetail payout_amt[%lf]\n",dTmp));

						PutField_Double(hTxn,"org_dst_net_amt",dTmp);
						PutField_Char(hTxn,"txn_type",PD_TYPE_PAYOUT);
DEBUGLOG(("handle_PayoutGenerate::Call BOPsp CalPspCosts\n"));
						BOObjPtr = CreateObj(BOPtr,"BOPsp","CalPspCosts");
						if((unsigned long)(*BOObjPtr)(hTxn,hRequest)==PD_OK){
							if(GetField_Double(hTxn,"precal_fee",&dTmp)){
								dPspFee += dTmp;
								
								sprintf(csTag,"precal_fee_%d",i);
								PutField_Double(hRequest,csTag,dTmp);
								PutField_Double(hContext,"total_precal_fee",dPspFee);
								PutField_Double(hElement,"src_txn_fee",dTmp);
DEBUGLOG(("handle_PayoutGenerate::payout_fee[%lf]\n",dTmp));
							}
						}

					}
					if(GetField_Int(hDetail,"seq_num",&iTmp)){
						sprintf(csTag,"seq_num_%d",i);
						PutField_Int(hRequest,csTag,iTmp);
DEBUGLOG(("handle_PayoutGenerate::GetDetail seq_num[%d]\n",iTmp));
					}
					if(GetField_CString(hDetail,"txn_country",&csTmp)){
						sprintf(csTag,"txn_country_%d",i);
						PutField_CString(hRequest,csTag,csTmp);
						//PutField_CString(hContext,"txn_country",csTmp);
DEBUGLOG(("handle_PayoutGenerate::GetDetail txn_country[%s]\n",csTmp));
					}

					PutField_CString(hDetail,"psp_channel",csPspChannel);
					if(WritePayoutFile(csFilePath,hDetail)!=PD_OK){
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::WritePayoutFile Error!!!\n"));
ERRLOG("BOPayout::handle_PayoutGenerate:WritePayoutFile Error!!!\n");
					}


					if(iRet==PD_OK){
						PutField_CString(hContext,"process_type","0000");
						PutField_CString(hContext,"process_code","000000");
						PutField_Int(hContext,"do_logging",PD_TRUE);
						PutField_Int(hContext,"db_commit",PD_FALSE);

DEBUGLOG(("handle_PayoutGenerate::Call MGTChannel:AddTxnLog\n"));
						ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnLog");
						if((unsigned long) ((*ChannelObjPtr)(hContext,hRequest))!=PD_OK){
							iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::MGTChannel:AddTxnLog Failed\n"));
						}
						PutField_Int(hContext,"do_logging",PD_FALSE);
					}

	
					if(iRet==PD_OK){
						PutField_CString(hUploadTxn,"sub_status",PD_APPROVED_AND_GENERATED);
DEBUGLOG(("handle_PayoutGenerate::Call DBTransaction:Update (UploadTxn)\n"));
						DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
						if((unsigned long) ((*DBObjPtr)(hUploadTxn))!=PD_OK){
							iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::DBTransaction:Update Failed\n"));
						}
					}

					if(iRet==PD_OK){
						PutField_Char(hElement,"party_type",PD_TYPE_PSP);
						PutField_CString(hElement,"amount_type",PD_DR);
DEBUGLOG(("handle_PayoutGenerate::Call BOTxnElements:AddTxnAmtElement\n"));
						BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnAmtElement");
						iRet = (unsigned long)(*BOObjPtr)(hElement);


						if(iRet==PD_OK){
DEBUGLOG(("handle_PayoutGenerate::Call BOTxnElements:AddTxnFeeElements\n"));
							BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnFeeElements");
							iRet = (unsigned long)(*BOObjPtr)(hElement);
						}
					}

					i++;
					PutField_Int(hRequest,"total_count",i);
					PutField_Int(hContext,"total_cnt",i);
					hDetail = RecordSet_GetNext(rDetailSet);
				}

				if(iRet==PD_OK){
					PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","UpdateByFileId");
					if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
						iRet=INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::DBPayoutGeneratedFileDT Update Failed!!!\n"));
ERRLOG("BOPayout::handle_PayoutGenerate:DBPayoutGeneratedFileDT Update Failed!!!\n");
					}
				}
			}

			if(iRet == PD_OK && i>0){
				PutField_Int(hTxn,"end_file",PD_TRUE);
				iRet = WritePayoutFile(csFilePath,hTxn);
			}

			hRec = RecordSet_GetNext(rRecordSet);

			if(iRet == PD_OK && i>0){
				PutField_Char(hContext,"response_mode",PD_ACCEPT);
				PutField_CString(hContext,"desc","Payout (PSP)");
				PutField_Char(hContext,"party_type",PD_TYPE_PSP);
				if(GetField_CString(hContext,"PHDATE",&csTmp)){
					PutField_CString(hContext,"approval_date",csTmp);
				}

				if(HandlePayoutBalance(hContext,hRequest)!=PD_OK){
DEBUGLOG(("handle_PayoutGenerate::HandlePayoutBalance Failed!!!\n"));
ERRLOG("BOPayout::handle_PayoutGenerate:HandlePayoutBalance Failed!!!\n");
					iRet = INT_ERR;
				}
			}

			if(iRet==PD_OK && i>0){
				PutField_Int(hHeader,"status",PD_PAYOUTFILE_GENERATED);
				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
				if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("Authorize::PayoutGeneratedFileHD::Update Error!!!\n"));
					iRet = INT_ERR;
				}
			}
		
			if(iRet==PD_OK && i>0){
				iRet = UpdateDetail(hContext,hRequest); 
			}
			PutField_Int(hRequest,"total_count",0);
			PutField_Int(hContext,"total_cnt",0);
		}

	}


	FREE_ME(hTxn);
	FREE_ME(hUploadTxn);
	FREE_ME(hElement);
	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
	RecordSet_Destroy(rDetailSet);
        FREE_ME(rDetailSet);
	RecordSet_Destroy(rTmpSet);
        FREE_ME(rTmpSet);
	return iRet;
}
*/

int handle_PayoutIndvCancel(hash_t *hContext,
			     hash_t* hRequest,
			     hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iTmp;
	double	dTmp;
	double	dPspFee=0.0;
	char	*csOrgGenTxnId;
	char	*csTmp;
	char	csNewTxnSeq[PD_TXN_SEQ_LEN +1];
	char	csTag[PD_TAG_LEN +1];
	hash_t	*hRec, *hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	if(GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hTxn,"update_user",csTmp);
	}

	if(GetField_CString(hRequest,"gen_txn_id",&csOrgGenTxnId)){
DEBUGLOG(("handle_PayoutIndvCancel::gen_txn_id = [%s]\n",csOrgGenTxnId));
		PutField_CString(hTxn,"txn_id",csOrgGenTxnId);
		PutField_CString(hContext,"org_txn_id",csOrgGenTxnId);

DEBUGLOG(("handle_PayoutIndvCancel::Call DBPayoutGeneratedFileDT:GetDetailByGenId\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","GetDetailByGenId");
		iRet = (unsigned long)(*DBObjPtr)(csOrgGenTxnId,rRecordSet);
		if(iRet == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if(GetField_Int(hRec,"status",&iTmp)){
					if(iTmp!=PAYOUT_MASTER_TRANSACTION_GENERATED){
						iRet=INT_INVALID_TXN;
						PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("handle_PayoutIndvCancel::invalid status[%d]!!!!!\n",iTmp));
					}
				}
				if(GetField_CString(hRec,"txn_country",&csTmp)){
					PutField_CString(hContext,"org_txn_country",csTmp);
				}
				if(GetField_CString(hRec,"payout_ccy",&csTmp)){
					PutField_CString(hContext,"org_psp_txn_ccy",csTmp);
				}
				if(GetField_CString(hRec,"psp_id",&csTmp)){
					PutField_CString(hContext,"org_psp_id",csTmp);
				}
				if(GetField_Double(hRec,"payout_amount",&dTmp)){
					PutField_Double(hContext,"org_dst_net_amt",dTmp);
				}
				PutField_Char(hContext,"txn_type",PD_TYPE_PAYOUT);
DEBUGLOG(("handle_PayoutIndvCancel::Call BOPsp CalPspCosts\n"));
				BOObjPtr = CreateObj(BOPtr,"BOPsp","CalPspCosts");
				if((unsigned long)(*BOObjPtr)(hContext,hRequest)==PD_OK){
					if(GetField_Double(hContext,"precal_fee",&dTmp)){
DEBUGLOG(("handle_PayoutIndvCancel::payout_fee[%lf]\n",dTmp));
					}
				}
				if(GetField_CString(hRec,"batch_id",&csTmp)){
					sprintf(csTag,"%s_cancel_amt",csTmp);
					PutField_Double(hContext,csTag,dTmp);
DEBUGLOG(("handle_PayoutIndvCancel:: [%s]=[%lf]\n",csTag,dTmp));
				}
				if(GetField_Int(hRec,"seq_num",&iTmp)){
					PutField_CString(hTxn,"psp_id","");
					PutField_CString(hTxn,"generated_file_name","");
					DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","UpdateDetailByBatchId");
					if ((*DBObjPtr)(csTmp,iTmp,hTxn) != PD_OK) {
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutIndvCancel::DBMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
					}
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}

		if(iRet==PD_OK){
			
			PutField_Char(hContext,"response_mode",PD_REVERSED);
			PutField_Char(hContext,"party_type",PD_TYPE_PSP);

			BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
			if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("handle_PayoutIndvCancel::UpdatePayoutAmount Failed!!!\n"));
ERRLOG("BOPayout::handle_PayoutIndvCancel:UpdatePayoutAmount Failed!!!\n");
				iRet = INT_ERR;
			}
		}

		if(iRet==PD_OK){
			DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextMgtTxnSeq");
			strcpy(csNewTxnSeq,(*DBObjPtr)());
DEBUGLOG(("csNewTxnSeq [%s]!!!\n",csNewTxnSeq));
			PutField_CString(hContext,"txn_id",csNewTxnSeq);
			PutField_CString(hResponse,"org_txn_seq",csNewTxnSeq);
			PutField_CString(hContext,"new_txn_code",PD_PAYOUT_INDV_CANCEL);
			PutField_CString(hContext,"desc","Reverse Payout Record Generated");

			iRet = AddTxnLog(hContext,hRequest);
		}

		if(iRet==PD_OK){
			PutField_CString(hContext,"from_txn_seq",csNewTxnSeq);
			PutField_CString(hContext,"amount_type",PD_CR);
			PutField_Char(hContext,"party_type",PD_TYPE_PSP);
			if(GetField_CString(hContext,"org_psp_txn_ccy",&csTmp)){
				PutField_CString(hContext,"org_txn_ccy",csTmp);
			}
			if(GetField_Double(hContext,"org_dst_net_amt",&dTmp)){
				GetField_Double(hContext,"precal_fee",&dPspFee);
				PutField_Double(hContext,"org_txn_amt",dTmp+dPspFee);
			}
DEBUGLOG(("handle_PayoutIndvCancel::Call BOTxnElements:AddTxnAmtElement\n"));
			BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnAmtElement");
			iRet = (unsigned long)(*BOObjPtr)(hContext);
		}

		if(iRet==PD_OK){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_REV_FOR_REGEN);
			DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","UpdateByGenId");
			if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
				iRet=INT_ERR;
DEBUGLOG(("handle_PayoutIndvCancel::DBPayoutGeneratedFileDT UpdateByGenId Failed!!!\n"));
ERRLOG("BOPayout::handle_PayoutIndvCancel:DBPayoutGeneratedFileDT UpdateByGenId Failed!!!\n");
			}
			
		}
	}
	else{
		iRet=INT_ERR;
DEBUGLOG(("handle_PayoutIndvCancel::gen_txn_id not found!!!!!\n"));
	}

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
	FREE_ME(hTxn);
	return iRet;
}
/*
int handle_PayoutReGenerate(hash_t *hContext,
			     hash_t* hRequest,
			     hash_t* hResponse)
{
	int	iRet = PD_OK;
*/
/*
	DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","GetPreGeneratedDetail");
	if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {
			if(GetField_CString(hRec,"file_id",&csFileId)){
DEBUGLOG(("DBMerchantUploadFileDetail Resume FileId[%s]\n",csFileId));
				DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","ResumePreGenFile");
				iRet = (unsigned long)(*DBObjPtr)(csFileId);

				if(iRet==PD_OK){
DEBUGLOG(("DBPayoutGeneratedFileHD Resume FileId[%s]\n",csFileId));
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Delete");
					iRet = (unsigned long)(*DBObjPtr)(csFileId);
				}
				if(iRet==PD_OK){
DEBUGLOG(("DBPayoutGeneratedFileDT Resume FileId[%s]\n",csFileId));
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","Delete");
					iRet = (unsigned long)(*DBObjPtr)(csFileId);
				}
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}
*/
/*
	if(iRet==PD_OK){
		iRet = GetPayoutRule(hContext,hRequest);
	}

	if(iRet==PD_OK){
		//iRet = ReAssignPsp(hContext,hRequest,hResponse);
	}
*/
/*
	if(iRet==PD_OK){
		recordset_init(rRecordSet,0);
DEBUGLOG(("handle_PayoutReGenerate::Call DBMerchantUploadFileDetail:GetExistingPsp\n"));
       		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetExistingPsp");
		if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
			i = 0;
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec, "psp_id", &csTmp)) {
					sprintf(csTag, "psp_id_%d", i);
					PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetExistingPsp::psp_id = [%s]\n",csTmp));
DEBUGLOG(("handle_PayoutReGenerate::Call CreatePayoutFileDetail\n"));
					if(CreatePayoutFileDetail(csTmp,hContext)!=PD_OK){
						iRet=INT_ERR;
DEBUGLOG(("CreatePayoutFile for[%s] Failed!!!!\n",csTmp));
					}
				}
				i++;
				hRec = RecordSet_GetNext(rRecordSet);
				PutField_Int(hContext,"psp_count",i);
			}
		}

		RecordSet_Destroy(rRecordSet);
		FREE_ME(rRecordSet);
	}
*/
/*	if(iRet==PD_OK){
		iRet = WriteAssignedRecord(hContext,hRequest);
	}

	if(iRet==PD_OK){
		iRet = UpdateDetail(hContext,hRequest); 
	}
	if(iRet==PD_OK){
		iRet = FormatResponse(hContext,hResponse);
	}

	return iRet;
}
*/
int UpdateHeader(hash_t *hContext,
		hash_t* hRequest)
{
	int     iRet  = PD_OK;
	int	iCnt=0;
	int	i=0;
	int	iResult=0;
	//int	iUpdate=PD_FALSE;
	char	*csTmp;
	char	*csTxnCode;
	char	*csTxnId;
	char	*csBatchId;
	char	csTag[PD_TAG_LEN +1];
	unsigned long lBatchId = 0l;
	unsigned long lTmp=0l;
	double	dTmp;
	double	dBatchAmt=0.0;

	hash_t  *hRec;
	hash_t  *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);
	hash_t  *hHeader;
	hHeader = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hHeader,0);

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout::UpdateHeader()\n"));

	///for POU/POA/POC/PCA, only update one batch	
	if(GetField_CString(hRequest,"batch_id",&csTmp)){
		sprintf(csTag,"batch_id_%d",0);
		PutField_CString(hRequest,csTag,csTmp);
		PutField_Int(hRequest,"total_count",1);
	}

	GetField_CString(hRequest,"txn_code",&csTxnCode);
	if(!strcmp(csTxnCode,PD_PAYOUT_APPROVE)){
		PutField_Int(hTxn,"status",PD_PAYOUTFILE_APPROVED);
 		if(GetField_CString(hContext,"org_txn_id",&csTxnId)){
			PutField_CString(hContext,"txn_seq",csTxnId);
DEBUGLOG(("UpdateHeader::txn_id = [%s]\n",csTxnId));
		}
	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_CONFIRM)){
		PutField_Int(hTxn,"status",PD_PAYOUTFILE_PROCESSING);
	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_GENERATE)){
 		if(GetField_CString(hContext,"org_txn_id",&csTxnId)){
			PutField_CString(hContext,"txn_seq",csTxnId);
DEBUGLOG(("UpdateHeader::txn_id = [%s]\n",csTxnId));
		}
	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_UPLOAD)){
		if(GetField_CString(hContext,"txn_seq",&csTmp))
			PutField_CString(hTxn,"txn_seq",csTmp);
		if(GetField_CString(hContext,"PHDATE",&csTmp))
			PutField_CString(hTxn,"posting_date",csTmp);

	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_APPROVED)){
		PutField_Int(hTxn,"status",PD_PAYOUTFILE_REVERSED);
	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_BEFORE_APPROVED)){
		PutField_Int(hTxn,"status",PD_PAYOUTFILE_DECLINED);
	}
	
	
	if(GetField_Int(hRequest,"total_count",&iCnt)){
DEBUGLOG(("UpdateHeader::total_count= [%d]\n",iCnt));
	}
	for(i=0; i<iCnt; i++){
		dBatchAmt=0;
		sprintf(csTag, "batch_id_%d", i);
		GetField_CString(hRequest,csTag,&csBatchId);
		PutField_CString(hTxn,"batch_id",csBatchId);

		lBatchId = ctol((const unsigned char *)csBatchId,strlen(csBatchId));
		if (lTmp==lBatchId)
			continue;

		lTmp = lBatchId;

        	recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","GetHeader");
		if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec,"txn_seq",&csTmp)) {
					//PutField_CString(hHeader,"txn_seq",csTmp);
DEBUGLOG(("UpdateHeader::org_txn_seq = [%s]\n",csTmp));
				}
				if(GetField_Double(hRec,"txn_amt",&dTmp)){
					if(!strcmp(csTxnCode,PD_PAYOUT_APPROVE)){
						PutField_Double(hTxn,"remain_amt",dTmp);
					}
				}
				if(GetField_Double(hRec,"remain_amt",&dTmp)){
					if(!strcmp(csTxnCode,PD_PAYOUT_GENERATE)){
						sprintf(csTag, "%s_total_amt",csBatchId);
						GetField_Double(hContext,csTag,&dBatchAmt);
DEBUGLOG(("UpdateHeader::[%s] = [%lf]\n",csTag,dBatchAmt));
						dTmp -= dBatchAmt;
						PutField_Double(hTxn,"remain_amt",dTmp);
DEBUGLOG(("UpdateHeader::remain_amt = [%lf]\n",dTmp));
					}
					else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_GENERATED)||
						!strcmp(csTxnCode,PD_PAYOUT_INDV_CANCEL)){
						sprintf(csTag, "%s_cancel_amt",csBatchId);
						GetField_Double(hContext,csTag,&dBatchAmt);
DEBUGLOG(("UpdateHeader::[%s] = [%lf]\n",csTag,dBatchAmt));
						dTmp += dBatchAmt;
						PutField_Double(hTxn,"remain_amt",dTmp);
DEBUGLOG(("UpdateHeader::remain_amt = [%lf]\n",dTmp));
					}
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}

		if(!strcmp(csTxnCode,PD_PAYOUT_GENERATE) || !strcmp(csTxnCode,PD_PAYOUT_CANCEL_GENERATED)){
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","MatchCount");
			if(!strcmp(csTxnCode,PD_PAYOUT_GENERATE)){
				iResult = (unsigned long) ((*DBObjPtr)(lBatchId,PAYOUT_MASTER_TRANSACTION_GENERATED));
				if(iResult!=PD_ERR && iResult!=PD_NOT_FOUND){
					if(iResult==PD_TRUE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_GENERATED);
					else if (iResult==PD_FALSE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_PARTIAL_GENERATED);

					PutField_CString(hContext,"sub_status",PD_APPROVED_AND_GENERATED);
					//PutField_CString(hHeader,"sub_status",PD_APPROVED_AND_GENERATED);
					//iUpdate=PD_TRUE;
				}
			}
			else{
				iResult = (unsigned long) ((*DBObjPtr)(lBatchId,PAYOUT_MASTER_TRANSACTION_APPROVED));
				if(iResult!=PD_ERR && iResult!=PD_NOT_FOUND){
					if(iResult==PD_TRUE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_APPROVED);
					else if (iResult==PD_FALSE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_PARTIAL_GENERATED);

					PutField_CString(hContext,"sub_status",PD_APPROVED_FOR_GENERATED);
					//PutField_CString(hHeader,"sub_status",PD_APPROVED_FOR_GENERATED);
					//iUpdate=PD_TRUE;
				}
			}
		}
DEBUGLOG(("UpdateHeader::DBMerchantUploadFileHeader:UpdateHeader\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","UpdateHeader");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("UpdateHeader::DBMerchantUploadFileHeader:UpdateHeader Failed\n"));
		}
	}

	FREE_ME(hTxn);
	FREE_ME(hHeader);
	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
DEBUGLOG(("BOPayout::UpdateHeader() iRet=[%d]\n",iRet));
	return  iRet;
}


int GetPayoutRecordsByMode(hash_t *hContext,
			hash_t* hRequest,
			hash_t* hResponse)
{
	int     iRet  = PD_OK;
	int	i= 0;
	int	iCnt= 0;
	int	iTmp= 0;
	char	*csTmp;
	char	cInputInd;
	double	dTmp=0.0;
	double	dTotalAmt=0.0;
	double	dMin=0.0;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

DEBUGLOG(("BOPayout:GetPayoutRecordsByMode()\n"));

	if(GetField_Char(hContext,"input_ind",&cInputInd)){
DEBUGLOG(("GetPayoutRecordsByMode::input_ind = [%c]\n",cInputInd));
	}

	if(GetField_Int(hContext,"status",&iTmp)){
DEBUGLOG(("GetPayoutRecordsByMode::status= [%d]\n",iTmp));
		PutField_Int(hTxn,"status",iTmp);
	}

	if(cInputInd == PD_BY_TXN){
		if (GetField_Int(hContext, "total_cnt", &iCnt)) {
DEBUGLOG(("GetPayoutRecordsByMode::total_cnt = [%d]\n", iCnt));
                }
		for (i = 0; i < iCnt; i++) {
			sprintf(csTag, "batch_id_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
				PutField_CString(hTxn,"batch_id",csTmp);
			}
			sprintf(csTag, "seq_num_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
				PutField_Int(hTxn,"seq_num",atoi(csTmp));
			}

			PutField_Int(hTxn,"current_index",i);
			iRet = GetPayoutRecords(hTxn,hContext,hRequest);
			if(GetField_Double(hContext,"total_net_amt",&dTmp))
				dTotalAmt += dTmp;
		}
		PutField_Int(hContext,"total_cnt",iCnt);
		PutField_Double(hContext,"total_net_amt",dTotalAmt);
	}
	else{
		if(GetField_CString(hContext,"bank_name",&csTmp)){
			PutField_CString(hTxn,"bank_name",csTmp);
DEBUGLOG(("GetPayoutRecordsByMode::bank_name = [%s]\n",csTmp));
		}
		if(GetField_CString(hContext,"batch_id",&csTmp)){
			PutField_CString(hTxn,"batch_id",csTmp);
DEBUGLOG(("GetPayoutRecordsByMode::batch_id = [%s]\n",csTmp));
		}
		if(GetField_Double(hContext,"total_amt",&dTmp)){
			if(dTmp>0.0)
				PutField_Double(hTxn,"total_amt",dTmp);
DEBUGLOG(("GetPayoutRecordsByMode::total_amt = [%lf]\n",dTmp));
		}
		if(GetField_Double(hContext,"min_amt",&dMin)){
			if(dMin>0.0)
				PutField_Double(hTxn,"min_amt",dMin);
DEBUGLOG(("GetPayoutRecordsByMode::min_amt = [%lf]\n",dMin));
		}
		if(GetField_Double(hContext,"max_amt",&dTmp)){
			if(dTmp>0.0){
				PutField_Double(hTxn,"max_amt",dTmp);
				if(dMin==0.0)
					PutField_Double(hTxn,"min_amt",dMin);
			}
DEBUGLOG(("GetPayoutRecordsByMode::max_amt = [%lf]\n",dTmp));
		}
		if(GetField_CString(hContext,"file_id",&csTmp)){
			PutField_CString(hTxn,"file_id",csTmp);
DEBUGLOG(("GetPayoutRecordsByMode::file_id = [%s]\n",csTmp));
		}

		iRet = GetPayoutRecords(hTxn,hContext,hRequest);

	}

	FREE_ME(hTxn);
	return iRet;
}


int GetPayoutRecords(hash_t* hTxn,
			hash_t* hContext,
			hash_t* hRequest)
{
	int     iRet  = PD_OK;
	int	iSeqNum = 0;
	//int	iIntErr= PD_OK;
	int	i= 0;
	int	iTmp= 0;
	int	iOnlineMode = PD_FALSE;
	char	*csMerchantId;
	char	*csServiceCode;
	char	*csTxnCountry=strdup("");
	char	*csTxnCcy;
	char	*csTxnId;
	char	*csTmp;
	char	*csMerchantClientId = NULL;
	char	cInputInd;
	double	dTmp=0.0;
	double	dTotalAmt=0.0;
	double	dLimitedAmt=0.0;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	char*   csPspTmp =strdup("");
	//csPspTmp = (char*) malloc (128);

DEBUGLOG(("BOPayout:GetPayoutRecords()\n"));

	if(GetField_Int(hTxn,"current_index",&i)){
DEBUGLOG(("BOPayout:GetPayoutRecords: current_index [%d]\n",i));
	}
	if(GetField_Double(hTxn,"total_amt",&dLimitedAmt)){
DEBUGLOG(("BOPayout:GetPayoutRecords: total_amt [%lf]\n",dLimitedAmt));
	}
	if(GetField_Char(hContext,"input_ind",&cInputInd)){
DEBUGLOG(("BOPayout:GetPayoutRecords::input_ind = [%c]\n",cInputInd));
	}

DEBUGLOG(("GetPayoutRecords::Call DBMerchantUploadFileDetail:GetDetailByCondition\n"));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetailByCondition");
	if ((unsigned long)(*DBObjPtr)(hTxn,rRecordSet) == PD_FOUND) {
DEBUGLOG(("GetDetailByCondition::found record\n"));
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if (GetField_CString(hRec,"txn_seq",&csTxnId)) {
				sprintf(csTag,"org_txn_id_%d",i);
				PutField_CString(hContext,csTag,csTxnId);
DEBUGLOG(("GetDetailByCondition::org_txn_seq = [%s]\n",csTxnId));
			}
			if (GetField_CString(hRec,"merchant_id",&csMerchantId)) {
				sprintf(csTag,"merchant_id_%d",i);
				PutField_CString(hRequest,"merchant_id",csMerchantId);
				PutField_CString(hContext,"merchant_id",csMerchantId);
				PutField_CString(hRequest,csTag,csMerchantId);
				PutField_CString(hContext,csTag,csMerchantId);
				//sprintf(csTag,"org_merchant_id_%d",i);
				//PutField_CString(hContext,csTag,csMerchantId);
DEBUGLOG(("GetDetailByCondition::merchant_id= [%s]\n",csMerchantId));

				if((i==0)||(cInputInd==PD_BY_TXN)){
					if(!GetField_CString(hContext,"merchant_client_id",&csMerchantClientId)){
						BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantDetail");
						if((unsigned long)(*BOObjPtr)(hContext,hRequest)==PD_OK){
							if(GetField_CString(hContext,"merchant_client_id",&csMerchantClientId)){
DEBUGLOG(("GetMerchantDetail::client_id= [%s]\n",csMerchantClientId));
							}
						}
					}
				}
				sprintf(csTag,"merchant_client_id_%d",i);
				PutField_CString(hContext,csTag,csMerchantClientId);
			}
			else{
				iRet = INT_MERCHANT_ID_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
				break;
DEBUGLOG(("GetDetailByCondition::merchant_id not found\n"));
			}
			if (GetField_CString(hRec,"txn_country",&csTxnCountry)) {
				PutField_CString(hRequest,"txn_country",csTxnCountry);
				PutField_CString(hContext,"txn_country",csTxnCountry);
				sprintf(csTag,"txn_country_%d",i);
				PutField_CString(hRequest,csTag,csTxnCountry);
				PutField_CString(hContext,csTag,csTxnCountry);
DEBUGLOG(("GetDetailByCondition::txn_country= [%s]\n",csTxnCountry));
			}
			if (GetField_CString(hRec,"service_code",&csServiceCode)) {
				PutField_CString(hRequest,"service_code",csServiceCode);
				PutField_CString(hContext,"service_code",csServiceCode);
				sprintf(csTag,"service_code_%d",i);
				PutField_CString(hRequest,csTag,csServiceCode);
				PutField_CString(hContext,csTag,csServiceCode);
				//sprintf(csTag,"org_service_code_%d",i);
				//PutField_CString(hContext,csTag,csServiceCode);
DEBUGLOG(("GetDetailByCondition::service_code= [%s]\n",csServiceCode));

				if((i==0)||(cInputInd==PD_BY_TXN)){
					if(!GetField_Int(hContext,"check_first_txn",&iTmp)){
						//iRet = isVoidWithFee(hContext);
/*
						DBObjPtr = CreateObj(DBPtr,"DBService","FindCountryByService");
						if ((unsigned long)(DBObjPtr)(csServiceCode,csTxnCountry) == FOUND) {
DEBUGLOG(("GetDetailByCondition::txn_country= [%s]\n",csTxnCountry));
							PutField_CString(hRequest,"txn_country",csTxnCountry);
							PutField_CString(hContext,"txn_country",csTxnCountry);
							//sprintf(csTag,"org_txn_country_%d",i);
							PutField_CString(hContext,"first_txn_country",csTxnCountry);
						}

*/						DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","ChkRuleExists");
						if ((unsigned long)(DBObjPtr)(csMerchantId,csServiceCode) == PD_FOUND) {
	
							DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","FindPsp");
							if ((unsigned long)(DBObjPtr)(csMerchantId,csServiceCode,csPspTmp) == PD_FOUND) {
								PutField_CString(hContext,"first_txn_psp",csPspTmp);
								iOnlineMode = PD_TRUE;
DEBUGLOG(("GetDetailByCondition::psp_id = [%s]\n",csPspTmp));
							}
						}
						PutField_Int(hContext,"check_first_txn",PD_TRUE);
						PutField_Int(hContext,"first_txn_mode",iOnlineMode);
					}
					else{
						//GetField_CString(hContext,"first_txn_country",&csTxnCountry);
						GetField_CString(hContext,"first_txn_psp",&csPspTmp);
						GetField_Int(hContext,"first_txn_mode",&iOnlineMode);
					}
				}
				//sprintf(csTag,"txn_country_%d",i);
				//PutField_CString(hRequest,csTag,csTxnCountry);
				//PutField_CString(hContext,csTag,csTxnCountry);

				if(iOnlineMode==PD_TRUE){
					sprintf(csTag,"batch_mode_%d",i);
					PutField_Char(hRequest,csTag,PD_ONLINE);

					sprintf(csTag,"pregen_psp_id_%d",i);
					PutField_CString(hRequest,csTag,csPspTmp);
					//FREE_ME(csPspTmp);
				}
				else{
					sprintf(csTag,"batch_mode_%d",i);
					PutField_Char(hRequest,csTag,PD_OFFLINE);
				}
			}
			else{
				iRet = INT_SERVICE_CODE_MISSING;
				PutField_Int(hContext,"internal_error",iRet);
				break;
DEBUGLOG(("GetDetailByCondition::service_code not found\n"));
			}

			if(GetField_CString(hRec,"identity_id",&csTmp)){
				sprintf(csTag,"identity_id_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetDetailByCondition::identity_id= [%s]\n",csTmp));
			}

			if (GetField_CString(hRec,"merchant_ref",&csTmp)) {
				sprintf(csTag,"merchant_ref_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}

			if(GetField_Int(hRec,"seq_num",&iSeqNum)){
				sprintf(csTag,"seq_num_%d",i);
				PutField_Int(hRequest,csTag,iSeqNum);
DEBUGLOG(("GetDetailByCondition::seq_num= [%i]\n",iSeqNum));
			}
			/*if (!GetField_CString(hRec,"txn_country",&csTmp)) {
				sprintf(csTag,"txn_country_%d",i);
				PutField_CString(hRequest,csTag,csTxnCountry);
				PutField_CString(hContext,csTag,csTxnCountry);
			}*/
			if (GetField_CString(hRec,"payout_ccy",&csTmp)){
				if(strcmp(csTmp,"RMB"))
					csTxnCcy = strdup(csTmp);
				else
					csTxnCcy = strdup(PD_CCY_ISO_CNY);

				sprintf(csTag,"dst_txn_ccy_%d",i);
				PutField_CString(hRequest,csTag,csTxnCcy);
				//sprintf(csTag,"txn_ccy_%d",i);
				//PutField_CString(hRequest,csTag,csTxnCcy);
				//PutField_CString(hContext,csTag,csTxnCcy);
				//sprintf(csTag,"org_txn_ccy_%d",i);
				//PutField_CString(hContext,csTag,csTxnCcy);
DEBUGLOG(("GetDetailByCondition::payout_ccy= [%s]\n",csTmp));
				FREE_ME(csTxnCcy);
			}

			if(GetField_CString(hRec,"request_ccy",&csTmp)){
				if(strcmp(csTmp,"RMB"))
					csTxnCcy = strdup(csTmp);
				else
					csTxnCcy = strdup(PD_CCY_ISO_CNY);

				sprintf(csTag,"txn_ccy_%d",i);
				PutField_CString(hRequest,csTag,csTxnCcy);
				PutField_CString(hContext,csTag,csTxnCcy);
				PutField_CString(hRequest,"txn_ccy",csTxnCcy);
				PutField_CString(hContext,"txn_ccy",csTxnCcy);
				//PutField_CString(hContext,"txn_ccy",csTxnCcy);
				//sprintf(csTag,"org_txn_ccy_%d",i);
				//PutField_CString(hContext,csTag,csTxnCcy);
DEBUGLOG(("GetDetailByCondition::request_ccy= [%s]\n",csTxnCcy));
				FREE_ME(csTxnCcy);
			}
			if (GetField_Double(hRec,"request_amount",&dTmp)) {
				sprintf(csTag,"txn_amt_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
				dTotalAmt += dTmp;
				PutField_Double(hContext,"total_net_amt",dTotalAmt);
DEBUGLOG(("GetDetailByCondition::request_amount= [%lf]\n",dTmp));
			
				if((dLimitedAmt>0.0) && (dTotalAmt>dLimitedAmt)){
					PutField_Double(hContext,"total_net_amt",dTotalAmt-dTmp);
DEBUGLOG(("GetDetailByCondition::total amount[%lf] > limited amount[%lf]. Stop counting Txn\n",dTotalAmt,dLimitedAmt));
					if(i==0){
DEBUGLOG(("GetDetailByCondition:: no record found\n"));
ERRLOG("BOPayout::GetPayoutRecords::GetDetailByCondition::no record found!!\n");
						iRet=INT_NOT_RECORD;
						PutField_Int(hContext,"internal_error",iRet);
					}
					break;
				}
			}
			if (GetField_Double(hRec,"payout_amount",&dTmp)) {
				sprintf(csTag,"payout_amount_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetDetailByCondition::payout_amount= [%lf]\n",dTmp));
			}
			if (GetField_Double(hRec,"merchant_fee",&dTmp)) {
				sprintf(csTag,"org_merchant_fee_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetDetailByCondition::merchant_fee= [%lf]\n",dTmp));
			}
			if (GetField_CString(hRec,"bank_name",&csTmp)){
				sprintf(csTag,"bank_name_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
				PutField_CString(hRequest,"bank_name",csTmp);
DEBUGLOG(("GetDetailByCondition::bank_name= [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"bank_code",&csTmp)){
				sprintf(csTag,"bank_code_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetDetailByCondition::bank_code= [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"branch",&csTmp)){
				sprintf(csTag,"branch_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}
			if (GetField_CString(hRec,"account_num",&csTmp)){
				sprintf(csTag,"account_id_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}
			if (GetField_CString(hRec,"account_name",&csTmp)){
				sprintf(csTag,"account_name_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}
			if(GetField_Int(hRec,"status",&iTmp)){
				sprintf(csTag,"status_%d",i);
				PutField_Int(hRequest,csTag,iTmp);
DEBUGLOG(("GetDetailByCondition::status= [%i]\n",iTmp));
			}
			if (GetField_CString(hRec,"batch_id",&csTmp)){
				sprintf(csTag,"batch_id_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}

			hRec = RecordSet_GetNext(rRecordSet);
			i++;
			PutField_Int(hContext,"last_seq",iSeqNum);
			PutField_Int(hContext,"total_cnt",i);
		}
	}
	else{
DEBUGLOG(("GetDetailByCondition:: no record found\n"));
ERRLOG("BOPayout::GetPayoutRecords::GetDetailByCondition::no record found!!\n");
		iRet=INT_NOT_RECORD;
		PutField_Int(hContext,"internal_error",iRet);
	}

	FREE_ME(csPspTmp);
	FREE_ME(csTxnCountry);
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	return	iRet;
}



int UpdateDetail(hash_t *hContext,
		hash_t* hRequest)
{
	int     iRet = PD_OK;
	int	iCnt = 0;
	int	i = 0;
	int	iTmp = 0;
	int	iSeqNum = 0;
	int	iIntErr= PD_OK;
	char	*csBatchId;
	char	*csTxnCode;
	char	*csTmp;
	char	cTmp;
	double	dTmp=0.0;
	char	csTag[PD_TAG_LEN +1];
	char    csResp[PD_RESPONSE_CODE_LEN +1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	if (GetField_CString(hRequest,"batch_id",&csBatchId)){
DEBUGLOG(("BOPayout::UpdateDetail for batch[%s]\n",csBatchId));
	}
	if (GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hTxn,"update_user",csTmp);
	}
	
	if(GetField_Int(hContext,"approve_id",&iTmp)){
DEBUGLOG(("BOPayout::UpdateDetail approve_id[%d]\n",iTmp));
		PutField_Int(hTxn,"approve_id",iTmp);
	}
	
	if(GetField_CString(hRequest,"txn_code",&csTxnCode)){
		if(!strcmp(csTxnCode,PD_PAYOUT_CONFIRM)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_CONFIRMED);
		}
		else if(!strcmp(csTxnCode,PD_PAYOUT_UPLOAD)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_UPLOADED);
		}
		else if(!strcmp(csTxnCode,PD_PAYOUT_APPROVE)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_APPROVED);
			//iRet=GenerateBatchSeq(hRequest);
		}
		else if(!strcmp(csTxnCode,PD_PAYOUT_GENERATE)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
		}
		else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_GENERATED)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_APPROVED);
		}
		else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_APPROVED)){
			if(GetField_CString(hContext,"txn_id",&csTmp)){
				PutField_CString(hTxn,"aux_txn_seq",csTmp);
			}
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_REVERSED);
		}
		else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_BEFORE_APPROVED)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_CANCELLED);
		}
	}

	if(GetField_Char(hRequest,"batch_mode",&cTmp)){
		PutField_Char(hTxn,"batch_mode",cTmp);
	}
	if(GetField_CString(hRequest,"psp_id",&csTmp)){
		PutField_CString(hTxn,"psp_id",csTmp);
	}
	if(GetField_CString(hRequest,"file_id",&csTmp)){
		PutField_CString(hTxn,"file_id",csTmp);
	}
	if(GetField_CString(hRequest,"generated_file_name",&csTmp)){
		PutField_CString(hTxn,"generated_file_name",csTmp);
	}

	GetField_Int(hContext,"total_cnt", &iCnt);
	for(i=0; i<iCnt; i++){
		sprintf(csTag,"batch_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csBatchId)){
DEBUGLOG(("BOPayout::UpdateDetail for batch[%s]\n",csBatchId));
		}
		sprintf(csTag,"seq_num_%d",i);
		if(GetField_Int(hRequest,csTag,&iSeqNum)){
DEBUGLOG(("BOPayout::UpdateDetail seq_num[%d]\n",iSeqNum));
		}
		else{
DEBUGLOG(("BOPayout::UpdateDetail seq_num is missing!!!\n"));
			continue;
		}

		if(!strcmp(csTxnCode,PD_PAYOUT_CONFIRM)){
			sprintf(csTag,"status_%d",i);
			if(GetField_Int(hRequest,csTag,&iTmp)){
				PutField_Int(hTxn,"status",iTmp);
			}
		}

		if(strcmp(csTxnCode,PD_PAYOUT_GENERATE)){
			sprintf(csTag,"txn_seq_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
				PutField_CString(hTxn,"txn_seq",csTmp);
			}
		}
		sprintf(csTag,"pregen_psp_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"pregen_psp_id",csTmp);
		}
		sprintf(csTag,"psp_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"psp_id",csTmp);
		}
		sprintf(csTag,"txn_country_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_country",csTmp);
		}
		sprintf(csTag,"payout_amt_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"payout_amt",dTmp);
		}
		if(!strcmp(csTxnCode,PD_PAYOUT_APPROVE)){
			sprintf(csTag,"txn_ccy_%d",i);
			if(GetField_CString(hRequest,csTag,&csTmp)){
				PutField_CString(hTxn,"merchant_fee_ccy",csTmp);
			}
			sprintf(csTag,"dst_txn_ccy_%d",i);
			if(GetField_CString(hRequest,csTag,&csTmp)){
				PutField_CString(hTxn,"member_fee_ccy",csTmp);
			}
		}
		sprintf(csTag,"member_fee_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"member_fee",dTmp);
		}
		sprintf(csTag,"merchant_fee_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"merchant_fee",dTmp);
		}
		sprintf(csTag,"markup_amt_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"markup_amt",dTmp);
		}
		sprintf(csTag,"markup_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"markup_ccy",csTmp);
		}
		sprintf(csTag,"ex_rate_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"ex_rate",dTmp);
		}
		sprintf(csTag,"generated_file_name_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"generated_file_name",csTmp);
		}
		sprintf(csTag,"pregen_file_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"pregen_file_id",csTmp);
		}
		sprintf(csTag,"file_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"file_id",csTmp);
		}
		sprintf(csTag,"batch_mode_%d",i);
		if(GetField_Char(hRequest,csTag,&cTmp)){
			PutField_Char(hTxn,"batch_mode",cTmp);
		}
		sprintf(csTag,"generate_id_%d",i);
		if(GetField_Int(hRequest,csTag,&iTmp)){
			PutField_Int(hTxn,"generate_id",iTmp);
		}
		sprintf(csTag,"identity_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"identity_id",csTmp);
DEBUGLOG(("UpdateDetail::identity_id= [%s]\n",csTmp));
		}

		sprintf(csTag,"int_error_%d",i);
		if(GetField_Int(hRequest,csTag,&iIntErr)){
			sprintf(csResp,"%d",iIntErr);
			PutField_CString(hTxn,"resp_code",csResp);
			if(iIntErr!=PD_OK){
				//PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_DECLINED);
			}
		}

		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","UpdateDetailByBatchId");
		if ((*DBObjPtr)(csBatchId,iSeqNum,hTxn) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOPayout::DBMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
		}

	}

DEBUGLOG(("BOPayout:UpdateDetail iRet=[%d]\n",iRet));
	FREE_ME(hTxn);
	return  iRet;
}

int InsertGenFileDT(const hash_t* hRequest)
{
	int     iRet = PD_OK;
	int	iCnt = 0;
	int	i = 0;
	int	iTmp = 0;
	char	*csTmp;
	double	dTmp=0.0;
	char	csTag[PD_TAG_LEN +1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	
DEBUGLOG(("BOPayout:InsertGenFileDT\n"));
	GetField_Int(hRequest,"total_count", &iCnt);
	for(i=0; i<iCnt; i++){
		sprintf(csTag,"batch_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"batch_id",csTmp);
		}
		sprintf(csTag,"seq_num_%d",i);
		if(GetField_Int(hRequest,csTag,&iTmp)){
			PutField_Int(hTxn,"seq_num",iTmp);
		}
		sprintf(csTag,"txn_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_id",csTmp);
		}
		sprintf(csTag,"file_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"file_id",csTmp);
		}
		sprintf(csTag,"txn_country_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_country",csTmp);
		}
		sprintf(csTag,"request_amount_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"request_amount",dTmp);
		}
		sprintf(csTag,"payout_amount_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"payout_amount",dTmp);
		}
		sprintf(csTag,"request_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"request_ccy",csTmp);
		}
		sprintf(csTag,"payout_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"payout_ccy",csTmp);
		}
		sprintf(csTag,"account_name_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"account_name",csTmp);
		}
		sprintf(csTag,"account_num_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"account_num",csTmp);
		}
		sprintf(csTag,"bank_name_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"bank_name",csTmp);
		}
		sprintf(csTag,"branch_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"branch",csTmp);
		}
		sprintf(csTag,"identity_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"identity_id",csTmp);
		}
		sprintf(csTag,"phone_num_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"phone_num",csTmp);
		}
		sprintf(csTag,"merchant_ref_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"merchant_ref",csTmp);
		}
		sprintf(csTag,"province_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"province",csTmp);
		}
		sprintf(csTag,"city_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"city",csTmp);
		}

	
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","Add");
		if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("InsertGenFileDT::DBPayoutGeneratedFileDT:Add Failed\n"));
		}
	}	

	FREE_ME(hTxn);
DEBUGLOG(("BOPayout:InsertGenFileDT iRet=[%d]\n",iRet));
	return  iRet;
}

int CheckAvalBalance(hash_t *hContext,
		     const hash_t* hRequest)
{	
	int	iRet = PD_OK;
	double	dTotalSrcNetAmt = 0.0;
	double	dActualPayoutBal = 0.0;
	double	dAvalPayoutBal = 0.0;
	//double	dFundIn = 0.0;
	char	*csTmp;

DEBUGLOG(("CheckAvalBalance::Call BOBalance:GetAvalPayoutBalance\n"));
	BOObjPtr = CreateObj(BOPtr,"BOBalance","GetAvalPayoutBalance");
	if((unsigned long)(*BOObjPtr)(hContext,
				hRequest,
				&dActualPayoutBal,
				&dAvalPayoutBal)==PD_OK){
DEBUGLOG(("CheckAvalBalance::GetAvalBalance for payout=[%f]\n",dActualPayoutBal));
	}
	else{
DEBUGLOG(("CheckAvalBalance::GetAvalPayoutBalance Error\n"));
ERRLOG("BOPayout::CheckAvalBalance::GetAvalPayoutBalance Error!!\n");
		iRet = INT_ERR;
	}

	if(iRet==PD_OK){
		int iCheck = PD_TRUE;
                if(GetField_CString(hContext,"merchant_id",&csTmp)){
                        if(!strcmp(csTmp,"K000000001") || !strcmp(csTmp,"kkk")){ //for UAT
			//if(!strcmp(csTmp,"M8000017")){ //for PROD
				iCheck = PD_FALSE;
                        }
                }
		if(GetField_Double(hContext,"total_net_amt",&dTotalSrcNetAmt) && iCheck){
DEBUGLOG(("CheckAvalBalance::Compare Aval Payout Amt[%f] with Request Net Amt[%f]\n",dAvalPayoutBal,dTotalSrcNetAmt));
			if(dAvalPayoutBal<dTotalSrcNetAmt){
				iRet=INT_INSUFFICIENT_FUND;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("CheckAvalBalance::Aval Payout Amt[%f] < Request Net Amt[%f]\n",dAvalPayoutBal,dTotalSrcNetAmt));
ERRLOG("BOPayout::CheckAvalBalance::insufficient aval payout balance!!\n");
			}
		}
	}

DEBUGLOG(("CheckAvalBalance::GetAvalPayoutBalance iRet [%d]\n",iRet));
	return  iRet;
}

int GetPayoutFee(hash_t *hContext,
		 hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iIntErr = PD_OK;
	//int	i= 0;
	//int	iCnt= 0;
	double	dTmp= 0.0;
	//double	dTotalSrcNetAmt = 0.0;
	//double	dTotalDstNetAmt = 0.0;
	char	*csTmp;
	char	*csTxnCode;
	char	csTag[PD_TAG_LEN +1];

DEBUGLOG(("BOPayout:GetPayoutFee()\n"));
	if(GetField_CString(hContext,"txn_code",&csTxnCode)){
DEBUGLOG(("GetPayoutFee::txn_code [%s]\n",csTxnCode));
	}

	if(GetField_CString(hContext,"txn_seq",&csTmp)){
		PutField_CString(hContext,"from_txn_seq",csTmp);
	}
	if(GetField_Double(hRequest,"txn_amt",&dTmp)){
		PutField_Double(hContext,"txn_amt",dTmp);
		PutField_Double(hContext,"org_txn_amt",dTmp);
	}
	if(GetField_CString(hRequest,"txn_ccy",&csTmp)){
		PutField_CString(hContext,"org_txn_ccy",csTmp);
	}
	if(GetField_CString(hRequest,"dst_txn_ccy",&csTmp)){
		PutField_CString(hContext,"dst_txn_ccy",csTmp);
	}

	if(strcmp(csTxnCode,PD_PAYOUT_VOID_MERCHANT)){
		//Add AddTxnAmtElement
		PutField_CString(hContext,"amount_type",PD_DR);
		BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnAmtElement");
		iRet = (unsigned long)(*BOObjPtr)(hContext);

		if(iRet==PD_OK){
DEBUGLOG(("GetPayoutFee::Call BOExchange:GetExchangeInfo\n"));
			BOObjPtr = CreateObj(DBPtr,"BOExchange","GetExchangeInfo");
			if ((*BOObjPtr)(hContext,hRequest) == PD_OK) {
DEBUGLOG(("GetPayoutFee::GetExternalExchangeInfo Success\n"));
				if(GetField_Double(hContext,"dst_txn_amt",&dTmp)){
DEBUGLOG(("GetPayoutFee::Destination Amount=[%lf]\n",dTmp));
				}
				if(GetField_CString(hContext,"markup_ccy",&csTmp)){
					sprintf(csTag,"markup_ccy");
					PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetPayoutFee::Markup Ccy=[%s]\n",csTmp));
				}
				if(GetField_Double(hContext,"markup_amt",&dTmp)){
					sprintf(csTag,"markup_amt");
					PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::Markup Amount=[%lf]\n",dTmp));
				}
				if(GetField_Double(hContext,"markup_rate",&dTmp)){
DEBUGLOG(("GetPayoutFee::Markup rate=[%lf]\n",dTmp));
				}
				if(GetField_Double(hContext,"ex_rate",&dTmp)){
					sprintf(csTag,"ex_rate");
					PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::Exchange rate=[%lf]\n",dTmp));
				}
			}
			else{
				iIntErr = INT_ERR;
DEBUGLOG(("GetPayoutFee:::GetExchangeInfo Error\n"));
ERRLOG("BOPayout:GetPayoutFee::::GetExchangeInfo Error\n");
			}
		}
	}
	//else{
		///for void case , do not doExchange
	//}

	if(iRet==PD_OK){
DEBUGLOG(("GetPayoutFee::Call BOFee:GetTxnFee\n"));
		BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
		if((unsigned long)(*BOObjPtr)(hContext,hRequest)==PD_OK){
			if(GetField_Double(hContext,"src_txn_fee",&dTmp)){
				sprintf(csTag,"merchant_fee");
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::src txn fee=[%f]\n",dTmp));
			}
			if(GetField_Double(hContext,"net_amt",&dTmp)){
				sprintf(csTag,"net_amt");
				PutField_Double(hRequest,csTag,dTmp);
				//dTotalSrcNetAmt += dTmp;
DEBUGLOG(("GetPayoutFee::src net amt=[%f]\n",dTmp));
			}
			if(GetField_Double(hContext,"dst_txn_fee",&dTmp)){
				sprintf(csTag,"member_fee");
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::dst txn fee=[%f]\n",dTmp));
			}
			if(GetField_Double(hContext,"dst_net_amt",&dTmp)){
				sprintf(csTag,"payout_amt");
				PutField_Double(hRequest,csTag,dTmp);
				//dTotalDstNetAmt += dTmp;

DEBUGLOG(("GetPayoutFee::dst net amt=[%lf]\n",dTmp));
//DEBUGLOG(("GetPayoutFee::total dst net amt for [%s]=[%lf]\n",csTmp,dTotalDstNetAmt));
			}


			//Add TxnFeeElements
			BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnFeeElements");
			iRet = (unsigned long)(*BOObjPtr)(hContext);
			if(iRet!=PD_OK){
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetPayoutFee::GetTxnFee Error\n"));
ERRLOG("BOPayout::GetPayoutFee:GetTxnFee Error\n");
			}
		}
		else{
			iIntErr = INT_ERR;
DEBUGLOG(("GetPayoutFee::GetTxnFee Error\n"));
ERRLOG("BOPayout::GetPayoutFee:GetTxnFee Error\n");
		}
		sprintf(csTag,"int_error");
		PutField_Int(hRequest,csTag,iIntErr);
	}

	//if(GetField_Double(hRequest,"total_txn_amt",&dTmp)){
	//	PutField_Double(hContext,"txn_amt",dTmp);
	//}
	//PutField_Double(hContext,"net_amt",dTotalSrcNetAmt);	
	//PutField_Double(hContext,"total_net_amt",dTotalSrcNetAmt);	
	//PutField_Double(hContext,"org_net_amt",dTotalSrcNetAmt);	
	//PutField_Double(hContext,"dst_txn_amt",dTotalDstNetAmt);	


DEBUGLOG(("BOPayout:GetPayoutFee() iRet=[%d]\n",iRet));
	return 	iRet;
}

int GetPayoutPsp(hash_t *hContext,
                const hash_t* hRequest)
{
	int	iRet = PD_OK;
	hash_t  *hRec;

	char	csTag[PD_TMP_BUF_LEN+1];
	char	*csBankName;
	char	*csPspId;
	char	*csOperType;
	double	dOrgTxnAmt;
	double	dPspAmt=0.0;
	double	dTotalPayoutAmt=0.0;
	double	dTierAmt=0.0;
	double	dPct=0.0;
	double	dMinAmt=0.0;
	double	dMaxAmt=0.0;
	int	iTier = 0;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout:GetPayoutPsp()\n"));

 	if (GetField_CString(hContext,"bank_name",&csBankName)) {
DEBUGLOG(("BOPayout::GetPayoutPsp() bank_name = [%s]\n",csBankName));
        }
        else {
DEBUGLOG(("BOPayout::GetPayoutPsp() bank_name not found!!!\n"));
		iRet = INT_BANK_CODE_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
        }

 	if (GetField_Double(hContext,"txn_amt",&dOrgTxnAmt)) {
DEBUGLOG(("BOPayout::GetPayoutPsp() txn_amt = [%lf]\n",dOrgTxnAmt));
        }
        else {
DEBUGLOG(("BOPayout::GetPayoutPsp() txn_amt not found!!!\n"));
		iRet = INT_TXN_AMT_MISSING;
		PutField_Int(hContext,"internal_error",iRet);
        }

	if (GetField_CString(hContext,"operator_type",&csOperType)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() operator_type = [%s]\n",csOperType));
	}
	if (GetField_CString(hContext,"psp_id",&csPspId)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() psp_id = [%s]\n",csPspId));
	}
	if (GetField_Double(hContext,"total_amt",&dPspAmt)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() total_amt = [%f]\n",dPspAmt));
	}

	sprintf(csTag,"%s_total_payout_amt_%s",csPspId,csBankName);
 	if (GetField_Double(hContext,csTag,&dTotalPayoutAmt)) {
DEBUGLOG(("BOPayout::GetPayoutPsp() org total_payout_amt = [%lf]\n",dTotalPayoutAmt));
        }


	if(iRet == PD_OK){
//RuleOperatorTypeDetail:GetRuleOperatorTypeDetail()
		DBObjPtr = CreateObj(DBPtr,"DBRuleOperatorTypeDetail","GetRuleOperatorTypeDetail");
		if ((unsigned long)(*DBObjPtr)(csOperType, rRecordSet)==PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if (GetField_Double(hRec,"amt_min",&dMinAmt)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() amount_min = [%f]\n",dMinAmt));
				}
				if (GetField_Double(hRec,"amt_max",&dMaxAmt)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() amount_max = [%f]\n",dMaxAmt));
				}

				if(dOrgTxnAmt>=dMinAmt && dOrgTxnAmt<=dMaxAmt){
					if (GetField_Int(hRec,"tier_id",&iTier)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() tier_id = [%d]\n",iTier));
					}
					if (GetField_Double(hRec,"amt_pct",&dPct)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() amount_pct = [%lf]\n",dPct));
DEBUGLOG(("BOPayout:GetPayoutPsp() amount for tier[%d] = [%lf]\n",iTier,(dPspAmt*dPct/100)));
					}
				}

				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	if(iRet == PD_OK){
//no rules
		if(!strcmp(csOperType,PD_NO_RULE)){
			//do nothing
		}

//Less Than or Daily Limit
		else if(!strcmp(csOperType,PD_LESS_THAN) || !strcmp(csOperType,PD_DAILY_LIMIT)){
			if((dTotalPayoutAmt + dOrgTxnAmt) > dPspAmt){
DEBUGLOG(("BOPayout:GetPayoutPsp() Payout Amt[%lf] > Limited PSP Amt[%f]!!!\n",(dTotalPayoutAmt + dOrgTxnAmt),dPspAmt));
//ERRLOG("Payout amount exceeded limited psp amount!!!\n");
				iRet = INT_EXCEED_LIMIT_PSP_AMT;
				PutField_Int(hContext,"internal_error",iRet);
			}
			else{
				sprintf(csTag,"%s_total_payout_amt_%s",csPspId,csBankName);
				PutField_Double(hContext,csTag,(dTotalPayoutAmt+dOrgTxnAmt));
DEBUGLOG(("BOPayout::GetPayoutPsp() %s (org) = [%lf], (new) = [%lf]\n",csTag,dTotalPayoutAmt,(dTotalPayoutAmt+dOrgTxnAmt)));
			}
		}

//customer rules
		else{
			sprintf(csTag,"%s_tier_%d_amt_%s",csPspId,iTier,csBankName);
 			if (GetField_Double(hContext,csTag,&dTierAmt)) {
        		}
DEBUGLOG(("BOPayout::GetPayoutPsp() %s (org) = [%lf], (new) = [%lf]\n",csTag,dTierAmt,(dTierAmt+dOrgTxnAmt)));

			if((dTierAmt+dOrgTxnAmt)>(dPspAmt*dPct/100)){
DEBUGLOG(("BOPayout:GetPayoutPsp() Payout Amt[%lf] > Limited PSP Amt[%f]!!!\n",(dTierAmt+dOrgTxnAmt),(dPspAmt*dPct/100)));
//ERRLOG("Payout amount exceeded limited psp amount!!!\n");
				iRet = INT_EXCEED_LIMIT_PSP_AMT;
				PutField_Int(hContext,"internal_error",iRet);
			}
			else{
				PutField_Double(hContext,csTag,(dTierAmt+dOrgTxnAmt));
			}

			
		}
	}

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("BOPayout:GetPayoutPsp() exit = [%d]\n",iRet));
	return iRet;
}


int ProcessPayoutRule(hash_t *hContext,
		  hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iCnt = 0;
	//int	iBank = PD_FALSE;
	double	dTmp=0.0;
	char	csBankName[PD_BANK_NAME_LEN+1];
	char	*csTmp;
	char	*csPspId;
	char	*csOperType;
	char	*csTxnId;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;
	hash_t  *hDtl;
	int	iTmp = 0;
	int	i = 0;
	int	iResult = 0;
	int	iAccept = PD_FALSE;
	int	iTier = 0;
	double	dTxnAmt = 0.0;
	double	dPspAmt = 0.0;
	double	dTotalTierAmt = 0.0;
	double	dTotalPayoutAmt = 0.0;
	int	iChk = PD_OK;
	int	iStatus = PD_FALSE;

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	recordset_t     *rDetailSet;
        rDetailSet = (recordset_t*) malloc (sizeof(recordset_t));


DEBUGLOG(("BOPayout:ProcessPayoutRule()\n"));

DEBUGLOG(("BOPayout::Call DBRulePayoutPsp:GetRulePayoutPspWithPriority\n"));
	DBObjPtr = CreateObj(DBPtr,"DBRulePayoutPsp","GetRulePayoutPspWithPriority");
	if ((unsigned long)(*DBObjPtr)(rRecordSet) == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec && iChk == PD_OK) {
			hash_init(hTxn,0);
			if (GetField_CString(hRec, "bank_name", &csTmp)) {
				strcpy(csBankName,TrimAllChar((const unsigned char*)csTmp,strlen(csTmp),PD_SPACE));
				if(strlen(csBankName)>0){
                                        if(strcmp(csBankName,"*")){
						PutField_CString(hTxn,"bank_name",csBankName);
						PutField_Int(hTxn,"bank_present",PD_TRUE);
DEBUGLOG(("GetRulePayoutPspWithPriority::bank_name = [%s]\n",csBankName));
                                        }
                                        else{
						PutField_Int(hTxn,"bank_present",PD_FALSE);
                                        }
                                }
			}
			if (GetField_CString(hRec, "psp_id", &csPspId)) {
				PutField_CString(hTxn,"psp_id",csPspId);
DEBUGLOG(("GetRulePayoutPspWithPriority::psp_id = [%s]\n",csPspId));
			}

			if (GetField_CString(hRec, "psp_ccy", &csTmp)) {
				PutField_CString(hTxn,"payout_ccy",csTmp);
DEBUGLOG(("GetRulePayoutPspWithPriority::psp_ccy = [%s]\n",csTmp));
			}

			if (GetField_Double(hRec, "total_amt", &dPspAmt)) {
				PutField_Double(hTxn,"total_amt",dPspAmt);
DEBUGLOG(("GetRulePayoutPspWithPriority::total_amt = [%lf]\n",dPspAmt));
			}
			if (GetField_CString(hRec, "operator_type", &csOperType)) {
				PutField_CString(hTxn,"operator_type",csOperType);
DEBUGLOG(("GetRulePayoutPspWithPriority::operator_type = [%s]\n",csOperType));

				if(strcmp(csOperType,PD_NO_RULE) && strcmp(csOperType,PD_LESS_THAN) && strcmp(csOperType,PD_DAILY_LIMIT)){
					i = 0;
					double dPct = 0.0;
					hash_t  *hOper;
					recordset_t     *rOperSet;
					rOperSet = (recordset_t*) malloc (sizeof(recordset_t));
					recordset_init(rOperSet,0);
					DBObjPtr = CreateObj(DBPtr,"DBRuleOperatorTypeDetail","GetRuleOperatorTypeDetail");
					if ((unsigned long)(*DBObjPtr)(csOperType, rOperSet)==PD_OK) {
						hOper = RecordSet_GetFirst(rOperSet);
						while(hOper){
							if (GetField_Int(hOper,"tier_id",&iTier)) {
								sprintf(csTag,"tier_id_%d",i);
								PutField_Int(hTxn,csTag,iTier);
DEBUGLOG(("BOPayout:GetRuleOperatorTypeDetail() tier_id = [%d]\n",iTier));
							}
							if (GetField_Double(hOper,"amt_min",&dTmp)) {
								sprintf(csTag,"tier_%d_min",iTier);
								PutField_Double(hTxn,csTag,dTmp);
DEBUGLOG(("BOPayout:GetRuleOperatorTypeDetail() amount_min = [%f]\n",dTmp));
							}
							if (GetField_Double(hOper,"amt_max",&dTmp)) {
								sprintf(csTag,"tier_%d_max",iTier);
								PutField_Double(hTxn,csTag,dTmp);
DEBUGLOG(("BOPayout:GetRuleOperatorTypeDetail() amount_max = [%f]\n",dTmp));
							}

							if (GetField_Double(hOper,"amt_pct",&dPct)) {
DEBUGLOG(("BOPayout:GetRuleOperatorTypeDetail() amount_pct = [%lf]\n",dPct));
								sprintf(csTag,"tier_%d_pct_amt",iTier);
								PutField_Double(hTxn,csTag,(dPspAmt*dPct/100));
DEBUGLOG(("BOPayout:GetRuleOperatorTypeDetail() amount for tier[%d] = [%lf]\n",iTier,(dPspAmt*dPct/100)));
							}
							i++;
							PutField_Int(hTxn,"num_of_tier",i);
							hOper = RecordSet_GetNext(rOperSet);
						}
					}
					else{
						iChk = PD_ERR;
					}
					RecordSet_Destroy(rOperSet);
					FREE_ME(rOperSet);
				}
			}

			if(GetField_Int(hContext,"pregen_id",&iTmp)){
				PutField_Int(hTxn,"pregen_id",iTmp);
			}
			if(GetField_CString(hContext,"batch_list",&csTmp)){
				PutField_CString(hTxn,"batch_list",csTmp);
			}
			if(GetField_CString(hRequest,"merchant_id",&csTmp)){
				PutField_CString(hTxn,"merchant_id",csTmp);
			}
			dTotalPayoutAmt = 0.0;
			dTotalTierAmt = 0.0;
			recordset_init(rDetailSet,0);

			hash_t  *hGenTmp;
			hGenTmp = (hash_t*) malloc (sizeof(hash_t));

			//get approved transaction by the above rule
DEBUGLOG(("ProcessPayoutRule::Call DBMerchantUploadFileDetail:GetRecordByRandomWithPara\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetRecordByRandomWithPara");
			iResult = (unsigned long)(*DBObjPtr)(hTxn,rDetailSet);
			if(iResult == PD_OK){
				hDtl = RecordSet_GetFirst(rDetailSet);
				while(hDtl && iChk == PD_OK){
					iAccept = PD_FALSE;
					hash_init(hGenTmp,0);
					if(GetField_CString(hDtl,"txn_seq",&csTxnId)){
						PutField_CString(hGenTmp,"txn_id",csTxnId);
DEBUGLOG(("GetRecordByRandomWithPara::txn_id = [%s]\n",csTxnId));
					}
					if(GetField_Double(hDtl,"payout_amount",&dTxnAmt)){
DEBUGLOG(("GetRecordByRandomWithPara::payout_amount = [%lf]\n",dTxnAmt));
					}

					//no rules
					if(!strcmp(csOperType,PD_NO_RULE)){
						iAccept = PD_TRUE;
					}
					//Less Than or Daily Limit
					else if(!strcmp(csOperType,PD_LESS_THAN) || !strcmp(csOperType,PD_DAILY_LIMIT)){
						if(((dTotalPayoutAmt + dTxnAmt) > dPspAmt)  && (dPspAmt>0.0)){
DEBUGLOG(("BOPayout:GetRecordByRandomWithPara() Payout Amt[%lf] > Limited PSP Amt[%f]!!!\n",(dTotalPayoutAmt + dTxnAmt),dPspAmt));

						}
						else{
							iAccept = PD_TRUE;
							dTotalPayoutAmt = dTotalPayoutAmt + dTxnAmt;
						}
					}
					//customer rules
					else{
						int iTierCnt = 0;
						double dMinAmt= 0.0;
						double dMaxAmt= 0.0;
						double dPctAmt= 0.0;
						GetField_Int(hTxn,"num_of_tier",&iTierCnt);
						for(i=0; i<iTierCnt; i++){
							dMinAmt = 0.0;
							dMaxAmt = 0.0;
							dPctAmt= 0.0;
							sprintf(csTag,"tier_id_%d",i);
							if(GetField_Int(hTxn,csTag,&iTier)){
								sprintf(csTag,"tier_%d_min",iTier);
								GetField_Double(hTxn,csTag,&dMinAmt);
								sprintf(csTag,"tier_%d_max",iTier);
								GetField_Double(hTxn,csTag,&dMaxAmt);
								if(dTxnAmt>=dMinAmt && dTxnAmt<=dMaxAmt){
									sprintf(csTag,"tier_%d_pct_amt",iTier);
									GetField_Double(hTxn,csTag,&dPctAmt);
									break;
								}
							}
						}

						if((dTotalTierAmt+dTxnAmt)>dPctAmt){
DEBUGLOG(("BOPayout:GetRecordByRandomWithPara () Payout Amt[%lf] > Limited PSP Amt[%f]!!!\n",(dTotalTierAmt+dTxnAmt),dPctAmt));
						}
						else{
							iAccept = PD_TRUE;
							dTotalTierAmt = dTotalTierAmt + dTxnAmt;
						}
					}
					
					if(iAccept){
						iStatus = PD_FALSE;
						sprintf(csTag,"%s_pending",csTxnId);
						GetField_Int(hContext,csTag,&iStatus);
						if(iStatus){
							PutField_Int(hContext,csTag,PD_FALSE);

							sprintf(csTag,"%s_psp",csTxnId);
							if(GetField_CString(hContext,csTag,&csTmp)){
								sprintf(csTag,"%s_pending_cnt",csTmp);
								iCnt = 0;
								GetField_Int(hContext,csTag,&iCnt);
								PutField_Int(hContext,csTag,iCnt-1);

								sprintf(csTag,"%s_pending_amt",csTmp);
								dTmp = 0;
								GetField_Double(hContext,csTag,&dTmp);
								PutField_Double(hContext,csTag,dTmp-dTxnAmt);
							}
						}

						if(GetField_CString(hTxn,"psp_id",&csPspId)){
							PutField_CString(hGenTmp,"psp_id",csPspId);

							sprintf(csTag,"%s_accept_cnt",csPspId);
							iCnt = 0;
							GetField_Int(hContext,csTag,&iCnt);
							PutField_Int(hContext,csTag,iCnt+1);

							sprintf(csTag,"%s_accept_amt",csPspId);
							dTmp = 0;
							GetField_Double(hContext,csTag,&dTmp);
							PutField_Double(hContext,csTag,dTmp+dTxnAmt);
						}

						if(GetField_Int(hContext,"pregen_id",&iTmp)){
							PutField_Int(hGenTmp,"gen_id",iTmp);
						}
						if(GetField_CString(hRequest,"add_user",&csTmp)){
							PutField_CString(hGenTmp,"add_user",csTmp);
						}

						//insert to payout_generated_tmp
						DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedTmp","Add");
						if((unsigned long)(*DBObjPtr)(hGenTmp)!=PD_OK){
DEBUGLOG(("ProcessPayoutRule::DBPayoutGeneratedTmp::Add Error!!!\n"));
ERRLOG("BOPayout:ProcessPayoutRule::DBPayoutGeneratedTmp::Add Error!!!\n");
							iChk= PD_ERR;
						}
					}
					else{
						iStatus = PD_FALSE;
						sprintf(csTag,"%s_pending",csTxnId);
						GetField_Int(hContext,csTag,&iStatus);
						if(!iStatus){
							PutField_Int(hContext,csTag,PD_TRUE);

							sprintf(csTag,"%s_psp",csTxnId);
							PutField_CString(hContext,csTag,csPspId);

							sprintf(csTag,"%s_pending_cnt",csPspId);
							iCnt = 0;
							GetField_Int(hContext,csTag,&iCnt);
							PutField_Int(hContext,csTag,iCnt+1);

							sprintf(csTag,"%s_pending_amt",csPspId);
							dTmp = 0;
							GetField_Double(hContext,csTag,&dTmp);
							PutField_Double(hContext,csTag,dTmp+dTxnAmt);
						}
					}
					hDtl = RecordSet_GetNext(rDetailSet);
				}
			}
			FREE_ME(hGenTmp);

			hRec = RecordSet_GetNext(rRecordSet);
		}
	}
	else{
DEBUGLOG(("GetRulePayoutPspWithPriority::not found record!!\n"));
ERRLOG("BOPayout::ProcessPayoutRule:GetRulePayoutPspWithPriority::not found record!!\n");
		iRet=INT_NO_PAYOUT_MATCH_RULE;
		PutField_Int(hContext,"internal_error",iRet);
	}

	if(iChk!=PD_OK){
		iRet=INT_ERR;
		PutField_Int(hContext,"internal_error",iRet);
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	RecordSet_Destroy(rDetailSet);
	FREE_ME(rDetailSet);
	FREE_ME(hTxn);
DEBUGLOG(("BOPayout:ProcessPayoutRule() iRet=[%d]\n",iRet));
	return iRet;
}




int GetPayoutRule(hash_t *hContext,
		  hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iCnt = 0;
	int	iBank = PD_FALSE;
	double	dTmp=0.0;
	char	csBankName[PD_BANK_NAME_LEN+1];
	char	*csTmp;
	char	*csPspId;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout:GetPayoutRule()\n"));
DEBUGLOG(("BOPayout::Call DBRulePayoutPsp:GetRulePayoutPspWithPriority\n"));
	DBObjPtr = CreateObj(DBPtr,"DBRulePayoutPsp","GetRulePayoutPspWithPriority");
	if ((unsigned long)(*DBObjPtr)(rRecordSet) == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		iCnt = 0;
		while (hRec) {
			iBank=PD_FALSE;
			if (GetField_CString(hRec, "bank_name", &csTmp)) {
				strcpy(csBankName,TrimAllChar((const unsigned char*)csTmp,strlen(csTmp),PD_SPACE));
				if(strlen(csBankName)>0){
                                        //PutField_CString(hContext,"bank_name",csBankName);
                                        if(strcmp(csBankName,"*")){
                                                sprintf(csTag,"bank%d_bank_name",iCnt);
                                                PutField_CString(hRequest,csTag,csBankName);
                                                iBank=PD_TRUE;
DEBUGLOG(("GetRulePayoutPspWithPriority::bank_name = [%s]\n",csBankName));
                                        }
                                        else{
                                                sprintf(csTag,"bank%d_bank_name",iCnt);
                                                PutField_CString(hRequest,csTag,"ALL_BANK");
DEBUGLOG(("GetRulePayoutPspWithPriority::All Bank\n"));
                                        }
                                }
			}
			if (GetField_CString(hRec, "psp_id", &csPspId)) {
				sprintf(csTag,"bank%d_psp_id",iCnt);
				PutField_CString(hRequest,csTag,csPspId);
//DEBUGLOG(("GetRulePayoutPspWithPriority::psp_id = [%s]\n",csPspId));

        			hash_init(hTxn,0);
				dTmp = 0.0;
				DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspPayoutSplitAmt");
				if ((*DBObjPtr)(csPspId,hTxn) == PD_OK) {
					if (GetField_Double(hTxn,"payout_split_limit",&dTmp)) {
DEBUGLOG(("BOPayout: GetPspPayoutSplitAmt - split amount= [%lf]\n",dTmp));
					}
					else{
DEBUGLOG(("BOPayout: GetPspPayoutSplitAmt - no split amount found\n"));
					}
				}
				sprintf(csTag,"%s_split_amt",csPspId);
				PutField_Double(hContext,csTag,dTmp);
			}
			if (GetField_CString(hRec, "operator_type", &csTmp)) {
				sprintf(csTag,"bank%d_operator_type",iCnt);
				PutField_CString(hRequest,csTag,csTmp);
				//PutField_CString(hContext,"operator_type",csTmp);
//DEBUGLOG(("GetRulePayoutPspWithPriority::operator_type = [%s]\n",csTmp));
			}
			if (GetField_Double(hRec, "total_amt", &dTmp)) {
				sprintf(csTag,"bank%d_total_amt",iCnt);
				PutField_Double(hRequest,csTag,dTmp);
				//PutField_Double(hContext,"total_amt",dTmp);
//DEBUGLOG(("GetRulePayoutPspWithPriority::total_amt = [%lf]\n",dTmp));
			}
			sprintf(csTag,"bank%d_present",iCnt);
			PutField_Int(hRequest,csTag,iBank);

			iCnt++;
			hRec = RecordSet_GetNext(rRecordSet);

			PutField_Int(hRequest,"bank_cnt",iCnt);
		}
	}
	else{
DEBUGLOG(("GetRulePayoutPspWithPriority::not found record!!\n"));
ERRLOG("BOPayout::GetPayoutRule:GetRulePayoutPspWithPriority::not found record!!\n");
		iRet=INT_NO_PAYOUT_MATCH_RULE;
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);
DEBUGLOG(("BOPayout:GetPayoutPsp() iRet=[%d]\n",iRet));
	return iRet;
}



int AssignPsp(hash_t *hContext,
	      hash_t* hRequest,
	      hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iCnt = 0;
	int	i = 0;
	int	iTotal = 0;
	int	iTmp = 0;
	int	iFailedCnt = 0;
	int	iResult = 0;
	int	iSeqNum = 0;
	int	iBank = PD_FALSE;
	int	iMerch = PD_FALSE;
	int	iResCnt = 0;
	int	iStatus = PD_FALSE;
	double	dResAmt = 0.0;
	double	dTmp=0.0;
	double	dTxnAmt=0.0;
	char	*csTmp;
	char	*csMerchantId;
	char	*csBatchId;
	char	*csBankName;
	char	*csPspId;
	char	*csPspCcy;
	char	*csCountry;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec, *hTxn, *hDetail;
	int	iBatchCnt = 0;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	
        hDetail = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hDetail,0);
DEBUGLOG(("BOPayout:AssignPsp()\n"));

	GetField_Int(hRequest,"bank_cnt",&iCnt);
	GetField_Int(hRequest,"mid_present",&iMerch);
	if(iMerch==PD_TRUE){
		GetField_CString(hRequest,"merchant_id",&csMerchantId);
		PutField_CString(hDetail,"merchant_id",csMerchantId);
	}

	if (GetField_Int(hContext, "total_batch_cnt", &iBatchCnt)) {
		PutField_Int(hDetail,"batch_cnt",iBatchCnt);
DEBUGLOG(("Authorize::total_batch_cnt = [%d]\n", iBatchCnt));
	}
	for(i=0; i<iBatchCnt;i++){
		sprintf(csTag,"batch_id_%d",i);
		if (GetField_CString(hContext, csTag, &csTmp)) {
DEBUGLOG(("Authorize::() [%s] = [%s]\n", csTag, csTmp));
			PutField_CString(hDetail,csTag,csTmp);
		}
	}

	for(i=0; i<iCnt;i++){
        	recordset_init(rRecordSet,0);
		RemoveField_CString(hDetail,"bank_name");

		sprintf(csTag,"bank%d_present",i);
		GetField_Int(hRequest,csTag,&iBank);
		//if(iBank==PD_TRUE){
			sprintf(csTag,"bank%d_bank_name",i);
			if(GetField_CString(hRequest,csTag,&csBankName)){
				PutField_CString(hContext,"bank_name",csBankName);
				if(iBank==PD_TRUE)
					PutField_CString(hDetail,"bank_name",csBankName);
			}
		//}
		sprintf(csTag,"bank%d_psp_id",i);
		if(GetField_CString(hRequest,csTag,&csPspId)){
			PutField_CString(hContext,"psp_id",csPspId);
DEBUGLOG(("AssignPsp::psp_id = [%s]\n",csPspId));
		}

		hash_t* hTmpRec;
		recordset_t *rTmpSet;
		rTmpSet = (recordset_t*) malloc (sizeof(recordset_t));
		recordset_init(rTmpSet,0);
		recordset_init(rTmpSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBPspCountry","GetPspCountry");
		if((unsigned long) ((*DBObjPtr)(csPspId,rTmpSet))==PD_OK){
			hTmpRec = RecordSet_GetFirst(rTmpSet);
			while(hTmpRec){
				if (GetField_CString(hTmpRec,"ccy_id",&csTmp)) {
					sprintf(csTag,"%s_support_ccy_id",csPspId);
					PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("AssignPsp::psp_id support ccy = [%s]\n",csTmp));
				}
				hTmpRec = RecordSet_GetNext(rTmpSet);
			}
		}
		RecordSet_Destroy(rTmpSet);
		FREE_ME(rTmpSet);

		sprintf(csTag,"bank%d_operator_type",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hContext,"operator_type",csTmp);
DEBUGLOG(("AssignPsp::operator_type = [%s]\n",csTmp));
		}
		sprintf(csTag,"bank%d_total_amt",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hContext,"total_amt",dTmp);
DEBUGLOG(("AssignPsp::total_amt = [%lf]\n",dTmp));
		}

DEBUGLOG(("AssignPsp::Call DBMerchantUploadFileDetail:GetDetailByRandomWithPara\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetailByRandomWithPara");
		iResult = (unsigned long)(*DBObjPtr)(hDetail,rRecordSet);

		if(iResult == PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			iTmp = 0;
			iFailedCnt = 0;
			while(hRec){
				if(GetField_CString(hRec,"batch_id",&csBatchId)){
					sprintf(csTag,"batch_id_%d",iTmp);
					PutField_CString(hTxn,csTag,csBatchId);
DEBUGLOG(("GetDetail::batch_id = [%s]\n",csBatchId));
				}
				if(GetField_Int(hRec,"seq_num",&iSeqNum)){
					sprintf(csTag,"seq_num_%d",iTmp);
					PutField_Int(hTxn,csTag,iSeqNum);
DEBUGLOG(("GetDetail::seq_num = [%d]\n",iSeqNum));
				}
				if(GetField_CString(hRec,"bank_name",&csTmp)){
					//if(iBank!=PD_TRUE){
					//	PutField_CString(hContext,"bank_name",csTmp);
DEBUGLOG(("GetDetail::bank_name = [%s]\n",csTmp));
					//}
				}
				if(GetField_CString(hRec,"txn_country",&csCountry)){
DEBUGLOG(("GetDetail::txn_country = [%s]\n",csCountry));
				}
				if(GetField_CString(hRec,"payout_ccy",&csPspCcy)){
DEBUGLOG(("GetDetail::payout_ccy = [%s]\n",csPspCcy));
				}
				if (GetField_Double(hRec, "payout_amount", &dTxnAmt)) {
					PutField_Double(hContext,"txn_amt",dTxnAmt);
DEBUGLOG(("GetDetail::txn_amt = [%lf]\n",dTxnAmt));
				}

DEBUGLOG(("AssignPsp::Call GetPayoutPsp\n"));
				iResCnt = 0;
				dResAmt = 0.0;
				sprintf(csTag,"pregen_psp_id_%d",iTmp);
				if((unsigned long)GetPayoutPsp(hContext,hRequest)==PD_OK){
					PutField_CString(hTxn,csTag,csPspId);

					sprintf(csTag,"%s_payout_country",csPspId);
					PutField_CString(hContext,csTag,csCountry);

					sprintf(csTag,"%s_payout_ccy",csPspId);
					PutField_CString(hContext,csTag,csPspCcy);

					sprintf(csTag,"%s_support_ccy_id",csPspId);
					if(GetField_CString(hContext,csTag,&csTmp)){
						if(strcmp(csPspCcy,csTmp)){
							iTmp = 0;
							iRet = INT_CURRENCY_ID_NOT_MATCH;
							PutField_Int(hContext,"internal_error",iRet);
							break;
						}
					}

					sprintf(csTag,"%s_accept_cnt",csPspId);
					GetField_Int(hContext,csTag,&iResCnt);
					iResCnt ++;
					PutField_Int(hContext,csTag,iResCnt);

					sprintf(csTag,"%s_accept_amt",csPspId);
					GetField_Double(hContext,csTag,&dResAmt);
					dResAmt += dTxnAmt;
					PutField_Double(hContext,csTag,dResAmt);

//check if the record was failed in the previous rule, update the pending count
					sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
					if(GetField_Int(hContext,csTag,&iStatus)){
						if(iStatus==PD_TRUE){
							iResCnt=0;
							dResAmt=0.0;
							sprintf(csTag,"%s%d_psp",csBatchId,iSeqNum);
							if(GetField_CString(hContext,csTag,&csTmp)){
								sprintf(csTag,"%s_pending_cnt",csTmp);
								GetField_Int(hContext,csTag,&iResCnt);
								iResCnt --;
								PutField_Int(hContext,csTag,iResCnt);

								sprintf(csTag,"%s_pending_amt",csTmp);
								GetField_Double(hContext,csTag,&dResAmt);
								dResAmt -= dTxnAmt;
								PutField_Double(hContext,csTag,dResAmt);
							}
						}
					}
DEBUGLOG(("AssignPsp::Call GetPayoutPsp Success\n"));
				}
				else{
					PutField_CString(hTxn,csTag,"");

//check if the record was failed in the previous rule, not to update the pending count.
					sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
					if(!GetField_Int(hContext,csTag,&iStatus)){
						sprintf(csTag,"%s_pending_cnt",csPspId);
						GetField_Int(hContext,csTag,&iResCnt);
						iResCnt ++;
						PutField_Int(hContext,csTag,iResCnt);

						sprintf(csTag,"%s_pending_amt",csPspId);
						GetField_Double(hContext,csTag,&dResAmt);
						dResAmt += dTxnAmt;
						PutField_Double(hContext,csTag,dResAmt);

						sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
						PutField_Int(hContext,csTag,PD_TRUE);
						sprintf(csTag,"%s%d_psp",csBatchId,iSeqNum);
						PutField_CString(hContext,csTag,csPspId);
					}

					iFailedCnt ++;
DEBUGLOG(("AssignPsp::Call GetPayoutPsp Failed\n"));
				}

				hRec = RecordSet_GetNext(rRecordSet);
				iTmp++;
				iTotal++;
				PutField_Int(hTxn,"total_count",iTmp);
				PutField_Int(hContext,"total_cnt",iTmp);
			}

			if(iTmp>iFailedCnt){
				if((unsigned long)UpdateDetail(hContext,hTxn)==PD_OK){
DEBUGLOG(("AssignPsp::Update Detail Success\n"));
				}
			}
		}

	}//end for loop

	if(iTotal==iFailedCnt && iRet == PD_OK){
DEBUGLOG(("AssignPsp::No Pending record\n"));
		PutField_Int(hContext,"total_cnt",0);
                PutField_Int(hResponse,"total_cnt",iTotal);
                //iRet = INT_NO_PENDING_RECORD;
                iRet = INT_NO_PAYOUT_MATCH_RULE;
        }

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);

DEBUGLOG(("BOPayout:AssignPsp() iRet=[%d]\n",iRet));
	return iRet;
}

int FormatResponse(const hash_t *hContext,
		   hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	i = 1;
	int	iCnt = 0;
	int	iAcceptCnt,iPendingCnt;
	double	dAcceptAmt,dPendingAmt,dAvalBal;
	char	*csPspId;
	char	*csCcy;
	char	csTag[PD_TAG_LEN +1];

DEBUGLOG(("BOPayout:FormatResponse()\n"));

	GetField_Int(hResponse,"total_cnt",&iCnt);

	for(i=0; i<iCnt; i++){
		iAcceptCnt = 0;
		iPendingCnt = 0;
		dAcceptAmt = 0.0;
		dPendingAmt = 0.0;

		sprintf(csTag,"psp_id_%d",i);
		if(GetField_CString(hContext,csTag,&csPspId)){
			sprintf(csTag,"psp_id_%d",i+1);
			PutField_CString(hResponse,csTag,csPspId);

			sprintf(csTag,"%s_accept_cnt",csPspId);
			GetField_Int(hContext,csTag,&iAcceptCnt);
			sprintf(csTag,"accept_cnt_%d",i+1);
			PutField_Int(hResponse,csTag,iAcceptCnt);

			sprintf(csTag,"%s_pending_cnt",csPspId);
			GetField_Int(hContext,csTag,&iPendingCnt);
			sprintf(csTag,"pending_cnt_%d",i+1);
			PutField_Int(hResponse,csTag,iPendingCnt);

			sprintf(csTag,"%s_payout_ccy",csPspId);
			if(GetField_CString(hContext,csTag,&csCcy)){
				sprintf(csTag,"ccy_%d",i+1);
				PutField_CString(hResponse,csTag,csCcy);
			}
			else{
				sprintf(csTag,"ccy_%d",i+1);
				PutField_CString(hResponse,csTag,"-");
			}

			sprintf(csTag,"%s_accept_amt",csPspId);
			GetField_Double(hContext,csTag,&dAcceptAmt);
			sprintf(csTag,"accept_amt_%d",i+1);
			PutField_Double(hResponse,csTag,dAcceptAmt);

			sprintf(csTag,"%s_pending_amt",csPspId);
			GetField_Double(hContext,csTag,&dPendingAmt);
			sprintf(csTag,"pending_amt_%d",i+1);
			PutField_Double(hResponse,csTag,dPendingAmt);

			sprintf(csTag,"%s_aval_psp_bal",csPspId);
			GetField_Double(hContext,csTag,&dAvalBal);
			sprintf(csTag,"aval_psp_bal_%d",i+1);
			PutField_Double(hResponse,csTag,dAvalBal);

		}
	}


DEBUGLOG(("BOPayout:FormatResponse() iRet=[%d]\n",iRet));
	return iRet;
}

int GetPayoutFilePath(hash_t* hTxn)
{
	int iRet=PD_OK;
	char	*csFileName;
	char	*csDate;
	char	*csPspId;
	char    csPayOutFile[PD_MAX_FILE_LEN + 1];
	char    csPayOutFilePath[PD_MAX_FILE_LEN + 1];
	char    csTag[PD_TAG_LEN +1];
	char	csCmd[PD_MAX_FILE_LEN + 1];
	int	iSeqNum = 0;

	if(!GetField_CString(hTxn,"filename",&csFileName)){
DEBUGLOG(("BOPayout:GetPayoutFilePath filename missing!!!!!\n"));
		iRet = INT_ERR;
	}
	if(!GetField_Int(hTxn,"seq_num",&iSeqNum)){
DEBUGLOG(("BOPayout:GetPayoutFilePath seq_num missing!!!!!\n"));
		iRet = INT_ERR;
	}
	if(!GetField_CString(hTxn,"file_date",&csDate)){
DEBUGLOG(("BOPayout:GetPayoutFilePath file_date missing!!!!!\n"));
		iRet = INT_ERR;
	}
	if(!GetField_CString(hTxn,"psp_id",&csPspId)){
DEBUGLOG(("BOPayout:GetPayoutFilePath psp_id missing!!!!!\n"));
		iRet = INT_ERR;
	}

	sprintf(csPayOutFilePath, "%s/%.*s/%.*s/%.*s/%d", getenv("OUTPUT_PAYOUT"),
							PD_YYYY_LEN,csDate,
							PD_YYYYMM_LEN,csDate,
							PD_DATE_LEN,csDate,
							iSeqNum);
DEBUGLOG(("BOPayout:GetPayoutFilePath FilePath[%s]\n",csPayOutFilePath));
	sprintf(csCmd, "mkdir %s/%.*s >/dev/null 2>&1",getenv("OUTPUT_PAYOUT"),PD_YYYY_LEN,csDate);
        system(csCmd);
	sprintf(csCmd, "mkdir %s/%.*s/%.*s >/dev/null 2>&1",getenv("OUTPUT_PAYOUT"),PD_YYYY_LEN,csDate,
										    PD_YYYYMM_LEN,csDate);
        system(csCmd);
	sprintf(csCmd, "mkdir %s/%.*s/%.*s/%.*s >/dev/null 2>&1",getenv("OUTPUT_PAYOUT"),PD_YYYY_LEN,csDate,
										    PD_YYYYMM_LEN,csDate,
										    PD_DATE_LEN,csDate);
        system(csCmd);
	sprintf(csCmd, "mkdir %s >/dev/null 2>&1",csPayOutFilePath);
        system(csCmd);

	sprintf(csPayOutFile, "%s/%s", csPayOutFilePath, csFileName);
DEBUGLOG(("BOPayout:GetPayoutFilePath Whole FilePath[%s]\n",csPayOutFile));
	sprintf(csTag,"%s_path",csPspId);
	PutField_CString(hTxn,csTag,csPayOutFile);

	return iRet;
}

int CreatePayoutFileDetail(const char* csPspId, hash_t* hContext)
{
	int iRet = PD_OK;

	char*    csDate;
	char*    csTmp;
	char*    csPspChannel;
	char    csPayOutFileName[PD_FILENAME_LEN + 1];
	char    csTag[PD_TAG_LEN +1];
	int     iSeqNum=0;
	unsigned long lFileId=0l;
        char    csNewFileId[PD_TXN_SEQ_LEN + 1];
	char    csPayOutFile[PD_MAX_FILE_LEN + 1];
	char    csPayOutFilePath[PD_MAX_FILE_LEN + 1];
	char	csCmd[PD_MAX_FILE_LEN + 1];

DEBUGLOG(("BOPayout:CreatePayoutFileDetail()\n"));

	hash_t* hPspDetail;
	hPspDetail = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hPspDetail,0);
	DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
	if ((*DBObjPtr)(csPspId,hPspDetail) == PD_OK) {
		if (GetField_CString(hPspDetail,"psp_channel_code",&csPspChannel)) {
			PutField_CString(hContext,"psp_channel",csPspChannel);
DEBUGLOG(("CreatePayoutFileDetail::channel [%s]!!\n",csPspChannel));
		}
		if (GetField_CString(hPspDetail,"client_id",&csTmp)) {
			PutField_CString(hContext,"psp_client",csTmp);
DEBUGLOG(("CreatePayoutFileDetail::psp_client [%s]!!\n",csTmp));
		}
	}
	FREE_ME(hPspDetail);


	if(GetField_CString(hContext,"PHDATE",&csDate)){
		//sprintf(csTag,"%s_file_date",csPspId);
		sprintf(csTag,"file_date");
		PutField_CString(hContext,csTag,csDate);
DEBUGLOG(("CreatePayoutFileDetail::File Date[%s], PID[%s]\n", csDate,csPspId));
	}

DEBUGLOG(("CreatePayoutFileDetail::DBPayoutGeneratedFileHD:GetNextSeq\n"));
	DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetNextSeq");
	if((unsigned long) ((*DBObjPtr)(csDate,csPspId,&iSeqNum))!=PD_OK){
		iRet = INT_ERR;
DEBUGLOG(("CreatePayoutFileDetail::DBPayoutGeneratedFileHD:GetNextSeq Failed\n"));
	}
	else{
		if(strcmp(csPspChannel,PD_CHANNEL_TWV))
			sprintf(csPayOutFileName, "%s_%s%02d.xls", csPspId, csDate,iSeqNum);
		else
			sprintf(csPayOutFileName, "%s_%s%02d.csv", csPspId, csDate,iSeqNum);

		//sprintf(csTag,"%s_seq_num",csPspId);
		sprintf(csTag,"seq_num");
		PutField_Int(hContext,csTag,iSeqNum);

		//sprintf(csTag,"%s_file",csPspId);
		sprintf(csTag,"filename");
		PutField_CString(hContext,csTag,csPayOutFileName);
	}

	if(iRet==PD_OK){
DEBUGLOG(("CreatePayoutFileDetail::DBPayoutGeneratedFileHD:GetNextFileId\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetNextFileId");
		if((unsigned long) ((*DBObjPtr)(&lFileId))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("CreatePayoutFileDetail::DBPayoutGeneratedFileHD:GetNextFileId Failed\n"));
		}
		else{
			sprintf(csNewFileId,"%ld",lFileId);
			PutField_CString(hContext,"file_id",csNewFileId);
		}
	}

	sprintf(csPayOutFilePath, "%s/%.*s/%.*s/%.*s/%d", getenv("OUTPUT_PAYOUT"),
							PD_YYYY_LEN,csDate,
							PD_YYYYMM_LEN,csDate,
							PD_DATE_LEN,csDate,
							iSeqNum);

DEBUGLOG(("CreatePayoutFileDetail: FilePath[%s]\n",csPayOutFilePath));
	sprintf(csCmd, "mkdir %s/%.*s >/dev/null 2>&1",getenv("OUTPUT_PAYOUT"),PD_YYYY_LEN,csDate);
        system(csCmd);
	sprintf(csCmd, "mkdir %s/%.*s/%.*s >/dev/null 2>&1",getenv("OUTPUT_PAYOUT"),PD_YYYY_LEN,csDate,
										    PD_YYYYMM_LEN,csDate);
        system(csCmd);
	sprintf(csCmd, "mkdir %s/%.*s/%.*s/%.*s >/dev/null 2>&1",getenv("OUTPUT_PAYOUT"),PD_YYYY_LEN,csDate,
										    PD_YYYYMM_LEN,csDate,
										    PD_DATE_LEN,csDate);
        system(csCmd);
	sprintf(csCmd, "mkdir %s >/dev/null 2>&1",csPayOutFilePath);
        system(csCmd);

	sprintf(csPayOutFile, "%s/%s", csPayOutFilePath, csPayOutFileName);
DEBUGLOG(("CreatePayoutFileDetail: Whole FilePath[%s]\n",csPayOutFile));
	sprintf(csTag,"file_path");
	PutField_CString(hContext,csTag,csPayOutFile);



DEBUGLOG(("BOPayout:CreatePayoutFileDetail() iRet=[%d]\n",iRet));
	return iRet;
}


int CreatePayoutFile(hash_t* hContext)
{
	int iRet = PD_OK;
	FILE    *fp;
	char    *csPayOutFile;
	char    *csPspId;
	char    *csPspChannel;
	char    csTag[PD_TAG_LEN +1];

	int	iCnt = 0;

DEBUGLOG(("BOPayout:CreatePayoutFile\n"));

	sprintf(csTag,"file_pid");
	if(GetField_CString(hContext,csTag,&csPspId)){
DEBUGLOG(("BOPayout:CreatePayoutFile() psp_id[%s]\n",csPspId));
	}

	sprintf(csTag,"psp_channel");
	if(GetField_CString(hContext,csTag,&csPspChannel)){
DEBUGLOG(("BOPayout:CreatePayoutFile() psp_channel[%s]\n",csPspChannel));
	}

	sprintf(csTag,"file_path");
	if(GetField_CString(hContext,csTag,&csPayOutFile)){
DEBUGLOG(("BOPayout:CreatePayoutFile() writ to file[%s]\n",csPayOutFile));
	}


	if(iRet==PD_OK) {
DEBUGLOG(("CreatePayoutFile::Open PayoutFile [%s] for psp id [%s]\n", csPayOutFile, csPspId));
		fp = fopen(csPayOutFile, "w");
		if (fp == NULL) {
DEBUGLOG(("CreatePayoutFile::Open Payoutfile [%s] problem\n", csPayOutFile));
ERRLOG("BOPayout:CreatePayoutFile::Open Payoutfile problem!!\n");
			iRet=INT_ERR;
		}
	}

	if(iRet==PD_OK &&
	   strcmp(csPspChannel,PD_CHANNEL_TWV) &&
	   strcmp(csPspChannel,PD_CHANNEL_YEEPAY) &&
	   strcmp(csPspChannel,PD_CHANNEL_GOPAY) &&
	   strcmp(csPspChannel,PD_CHANNEL_ECPSS)) {
		fprintf(fp, "<html><body><table>\n");
		fprintf(fp, "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"/>\n");
		fprintf(fp, "<style type=\"text/css\"> .format{ mso-number-format:'\\@';} </style>\n");
		fprintf(fp, "%s%s%s%s Payout Records%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s\n",
				PD_TR, PD_TD, PD_BOLD, csPspId, PD_BOLD_END, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TR_END);


		//fprintf(fp, "%s%sUploadFile Trans No.%s%sPayout Trans No.%s%sReceiver Name%s%sID Card No.%s%sMobile No.%s%sBank%s%sBranch%s%sBank Account%s%sAmount%s%sProvince%s%sCity%s%sRemarks%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);
		fprintf(fp, "%s%sPayout Trans No.%s%sReceiver Name%s%sID Card No.%s%sMobile No.%s%sBank%s%sBranch%s%sBank Account%s%sAmount%s%sProvince%s%sCity%s%sRemarks%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);

	}
	else if(iRet==PD_OK && !strcmp(csPspChannel,PD_CHANNEL_ECPSS)) {
		fprintf(fp, "<html><body><table>\n");
		fprintf(fp, "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"/>\n");
		fprintf(fp, "<style type=\"text/css\"> .format{ mso-number-format:'\\@';} </style>\n");
		fprintf(fp, "%s%s%s%s%s%s%s%s/%s%s%s%s%s%s%s%s%s%s%s%s%s%s\n",PD_TR,PD_TD, PD_TD_END,PD_TD, PD_TD_END,PD_TD, PD_TD_END,PD_TD, PD_TD_END,PD_TD, PD_TD_END,PD_TD, PD_TD_END,PD_TD, PD_TD_END,PD_TD, PD_TD_END,PD_TD, PD_TD_END,PD_TD, PD_TD_END,PD_TR_END);
	}
	else if(iRet==PD_OK && !strcmp(csPspChannel,PD_CHANNEL_YEEPAY)) {
		fprintf(fp, "<html><body><table>\n");
		fprintf(fp, "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"/>\n");
		fprintf(fp, "<style type=\"text/css\"> .format{ mso-number-format:'\\@';} </style>\n");
		//fprintf(fp, "%s%sBatch No.%s%sTransaction ID%s%sName%s%sBank Account%s%sBank%s%sProvince%s%sCity%s%sAmount%s%sReason%s%sBranch%s%sMobile No.%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);
		
		fprintf(fp, "%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);

	}
	else if(iRet==PD_OK && !strcmp(csPspChannel,PD_CHANNEL_GOPAY)){
		fprintf(fp, "<html><body><table>\n");
		fprintf(fp, "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"/>\n");
		fprintf(fp, "<style type=\"text/css\"> .format{ mso-number-format:'\\@';} </style>\n");
		fprintf(fp, "%s%s%s%s\n",PD_TR, PD_TD, PD_TD_END,PD_TR_END);
		fprintf(fp, "%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s (CNY)%s%s%s%s%s%s%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);
	}

	else if(iRet==PD_OK && !strcmp(csPspChannel,PD_CHANNEL_TWV)) {
		if(GetField_Int(hContext,"txn_cnt",&iCnt)){
			fprintf(fp,"%d\n",iCnt);
		}
	}

	fclose(fp);
DEBUGLOG(("BOPayout:CreatePayoutFile() iRet=[%d]\n",iRet));
	return iRet;
}


int WriteAssignedRecord(hash_t *hContext,
			hash_t* hRequest)
{
	int	iRet=PD_OK;
	int	i=0;
	int	iTmp=0;
	int	iTxnCnt=0;
	int	iCnt=0;
	//int	iBatchCnt=0;
	double	dTmp = 0.0;
	double	dAmt = 0.0;
	double	dPayoutAmt = 0.0;
	double	dRemainAmt = 0.0;
	double	dSplitAmt = 0.0;
	double	dTmpAmt = 0.0;
	double	dTmpTotalAmt = 0.0;
	char	cBatchMode;
	char	*csTmp;
	char	*csTmpBatch=strdup("");
	char	*csPspId;
	char	*csFilePath;
	char	*csTxnCcy;
	char	*csPayoutTxnSeq;
	char	csTag[PD_TAG_LEN +1];
	unsigned long lFileId=0l;
        char    csNewFileId[PD_TXN_SEQ_LEN + 1];
	hash_t  *hRec, *hDetail, *hHeader;

        hHeader= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hHeader,0);
        hDetail= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hDetail,0);
	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout:WriteAssignedRecord()\n"));
	if (GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hDetail,"add_user",csTmp);
		PutField_CString(hHeader,"add_user",csTmp);
	}

	if(!GetField_Char(hRequest,"batch_mode",&cBatchMode)){
		cBatchMode = PD_OFFLINE;
		PutField_Char(hRequest,"batch_mode",cBatchMode);
	}
	else{
DEBUGLOG(("BOPayout:WriteAssignedRecord() batch_mode [%c]\n",cBatchMode));
	}

DEBUGLOG(("WriteAssignedRecord::Call DBMerchantUploadFileDetail:GetPspAssignedTxn\n"));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetPspAssignedTxn");
	if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){

		GetField_Int(hContext,"psp_count",&iCnt);
                for(i=0; i<iCnt; i++){
                        sprintf(csTag,"psp_id_%d",i);
                        if(GetField_CString(hContext,csTag,&csPspId)){
                                PutField_CString(hHeader,"file_pid",csPspId);
                                sprintf(csTag, "%s_file_id", csPspId);
                                if(GetField_CString(hContext,csTag,&csTmp)){
                                        PutField_CString(hHeader,"file_id",csTmp);
                                }
                                sprintf(csTag, "%s_file", csPspId);
                                if(GetField_CString(hContext,csTag,&csTmp)){
                                        PutField_CString(hHeader,"filename",csTmp);
                                }
                                sprintf(csTag, "%s_file_date", csPspId);
                                if(GetField_CString(hContext,csTag,&csTmp)){
                                        PutField_CString(hHeader,"file_date",csTmp);
                                }
                                sprintf(csTag, "%s_seq_num", csPspId);
                                if(GetField_Int(hContext,csTag,&iTmp)){
                                        PutField_Int(hHeader,"seq_num",iTmp);
                                }
                                sprintf(csTag, "%s_txn_cnt", csPspId);
                                if(GetField_Int(hContext,csTag,&iTmp)){
                                        PutField_Int(hHeader,"txn_cnt",iTmp);
                                }
                                sprintf(csTag, "%s_txn_amt", csPspId);
                                if(GetField_Double(hContext,csTag,&dTmp)){
                                        PutField_Double(hHeader,"txn_amt",dTmp);
                                }
                                sprintf(csTag, "%s_payout_ccy", csPspId);
                                if(GetField_CString(hContext,csTag,&csTmp)){
                                        PutField_CString(hHeader,"ccy_id",csTmp);
                                }

                                if(iRet==PD_OK){
DEBUGLOG(("WriteAssignedRecord::DBPayoutGeneratedFileHD:GetNextFileId\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetNextFileId");
                                        if((unsigned long) ((*DBObjPtr)(&lFileId))!=PD_OK){
                                                iRet = INT_ERR;
DEBUGLOG(("WriteAssignedRecord::DBPayoutGeneratedFileHD:GetNextFileId Failed\n"));
                                        }
                                        else{
                                                sprintf(csNewFileId,"%ld",lFileId);
                                                sprintf(csTag,"%s_file_id",csPspId);
                                                PutField_CString(hHeader,"file_id",csNewFileId);
                                                PutField_CString(hContext,csTag,csNewFileId);
                                        }
                                }

                                DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Add");
                                if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("WriteAssignedRecord::PayoutGeneratedFileHD::Add Error!!!\n"));
                                        iRet = INT_ERR;
                                }

				if(iRet==PD_OK){
					if(cBatchMode==PD_OFFLINE)
                                		PutField_Int(hHeader,"status",PD_PAYOUTFILE_PRE_GENERATED);
					else
                                		PutField_Int(hHeader,"status",PD_PAYOUTFILE_PRE_SEND);
                                	DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
                                	if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("WriteAssignedRecord::PayoutGeneratedFileHD::Update Error!!!\n"));
                                       		iRet = INT_ERR;
                                	}
				}
                        }
                }

		i = 0;
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec && (iRet==PD_OK)) {
			if (GetField_CString(hRec, "psp_id", &csPspId)) {
				sprintf(csTag, "%s_file", csPspId);
				GetField_CString(hContext,csTag,&csTmp);
				
				//sprintf(csTag,"generated_file_name_%d", i);
				//PutField_CString(hRequest,csTag,csTmp);

				sprintf(csTag, "%s_file_id", csPspId);
				GetField_CString(hContext,csTag,&csTmp);
				sprintf(csTag,"pregen_file_id_%d", i);
				PutField_CString(hRequest,csTag,csTmp);
				PutField_CString(hDetail,"file_id",csTmp);

				sprintf(csTag, "%s_path", csPspId);
				GetField_CString(hContext,csTag,&csFilePath);
DEBUGLOG(("GetPspAssignedTxn::psp_id = [%s]\n",csPspId));
			}
			if (GetField_CString(hRec, "txn_id", &csTmp)) {
				PutField_CString(hDetail,"upload_txn_id",csTmp);
DEBUGLOG(("GetPspAssignedTxn::upload_txn_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "batch_id", &csTmp)) {
				sprintf(csTag, "batch_id_%d", i);
				PutField_CString(hRequest,csTag,csTmp);
				PutField_CString(hDetail,"batch_id",csTmp);
DEBUGLOG(("GetPspAssignedTxn::batch_id = [%s]\n",csTmp));
			}
			if (GetField_Int(hRec, "seq_num", &iTmp)) {
				sprintf(csTag, "seq_num_%d", i);
				PutField_Int(hRequest,csTag,iTmp);
				PutField_Int(hDetail,"seq_num",iTmp);
DEBUGLOG(("GetPspAssignedTxn::seq_num = [%d]\n",iTmp));
			}
			if (GetField_CString(hRec,"txn_country", &csTmp)) {
				sprintf(csTag, "%s_txn_country", csPspId);
				PutField_CString(hContext,csTag,csTmp);
				PutField_CString(hDetail,"txn_country",csTmp);
DEBUGLOG(("GetPspAssignedTxn::txn_country = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"request_ccy", &csTmp)) {
				PutField_CString(hDetail,"request_ccy",csTmp);
DEBUGLOG(("GetPspAssignedTxn::request_ccy = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"payout_ccy", &csTmp)) {
				if(strcmp(csTmp,"RMB"))
					csTxnCcy=strdup(csTmp);
				else
					csTxnCcy=strdup(PD_CCY_ISO_CNY);

				sprintf(csTag, "%s_payout_ccy", csPspId);
				PutField_CString(hContext,csTag,csTxnCcy);
				PutField_CString(hDetail,"payout_ccy",csTxnCcy);
				FREE_ME(csTxnCcy);
DEBUGLOG(("GetPspAssignedTxn::payout_ccy = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"account_name", &csTmp)) {
				PutField_CString(hDetail,"account_name",csTmp);
DEBUGLOG(("GetPspAssignedTxn::account_name = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"account_num", &csTmp)) {
				PutField_CString(hDetail,"account_num",csTmp);
DEBUGLOG(("GetPspAssignedTxn::account_num = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"bank_name", &csTmp)) {
				PutField_CString(hDetail,"bank_name",csTmp);
DEBUGLOG(("GetPspAssignedTxn::bank_name = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"branch", &csTmp)) {
				PutField_CString(hDetail,"branch",csTmp);
DEBUGLOG(("GetPspAssignedTxn::branch = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"identity_id", &csTmp)) {
				PutField_CString(hDetail,"identity_id",csTmp);
DEBUGLOG(("GetPspAssignedTxn::identity_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"phone_num", &csTmp)) {
				PutField_CString(hDetail,"phone_num",csTmp);
DEBUGLOG(("GetPspAssignedTxn::phone_num = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"merchant_ref", &csTmp)) {
				PutField_CString(hDetail,"merchant_ref",csTmp);
DEBUGLOG(("GetPspAssignedTxn::merchant_ref = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"remark", &csTmp)) {
DEBUGLOG(("GetPspAssignedTxn::remark = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"province", &csTmp)) {
				PutField_CString(hDetail,"province",csTmp);
DEBUGLOG(("GetPspAssignedTxn::province = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"city", &csTmp)) {
				PutField_CString(hDetail,"city",csTmp);
DEBUGLOG(("GetPspAssignedTxn::city = [%s]\n",csTmp));
			}
			if (GetField_Double(hRec,"request_amount", &dTmp)) {
				PutField_Double(hDetail,"request_amount",dTmp);
DEBUGLOG(("GetPspAssignedTxn::request_amount = [%lf]\n",dTmp));
			}
			if (GetField_Double(hRec,"payout_amount", &dPayoutAmt)) {
				dRemainAmt = dPayoutAmt;
				///PutField_Double(hDetail,"payout_amount",dTmp);
DEBUGLOG(("GetPspAssignedTxn::payout_amount = [%lf]\n",dPayoutAmt));

				sprintf(csTag,"org_dst_net_amt_%s",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dTmp;
				}
				else{
					dAmt = dTmp;
				}
				PutField_Double(hContext,csTag,dAmt);

				sprintf(csTag,"%s_txn_amt",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dPayoutAmt;
				}
				else{
					dAmt = dPayoutAmt;
				}
				PutField_Double(hContext,csTag,dAmt);
			}
			if (GetField_CString(hRec,"merchant_fee_ccy", &csTmp)) {
				sprintf(csTag,"%s_merchant_fee_ccy",csPspId);
				PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::merchant_fee_ccy = [%s]\n",csTmp));
			}
			if (GetField_Double(hRec,"merchant_fee", &dTmp)) {
				sprintf(csTag,"%s_merchant_fee",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dTmp;
				}
				else{
					dAmt = dTmp;
				}
				PutField_Double(hContext,csTag,dAmt);
DEBUGLOG(("GetPspAssignedTxn::merchant_fee = [%lf]\n",dTmp));
			}

			if (GetField_CString(hRec,"member_fee_ccy", &csTmp)) {
				sprintf(csTag,"%s_member_fee_ccy",csPspId);
				PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::member_fee_ccy = [%s]\n",csTmp));
			}

			if (GetField_Double(hRec,"markup_amt", &dTmp)) {
DEBUGLOG(("GetPspAssignedTxn::markup_amt = [%lf]\n",dTmp));
			}

			if (GetField_Double(hRec,"member_fee", &dTmp)) {
				sprintf(csTag,"%s_member_fee",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dTmp;
				}
				else{
					dAmt = dTmp;
				}
				PutField_Double(hContext,csTag,dAmt);
DEBUGLOG(("GetPspAssignedTxn::member_fee = [%lf]\n",dTmp));
			}
//////////
//split by average
			sprintf(csTag,"%s_split_amt",csPspId);
			dSplitAmt = 0.0;
			dTmpTotalAmt = 0.0;
			GetField_Double(hContext,csTag,&dSplitAmt);
			int iSplitCnt = 1;
			if(dSplitAmt>0){
				iSplitCnt = (int)(dPayoutAmt/dSplitAmt);
				if(dPayoutAmt>(dSplitAmt*iSplitCnt)){
					iSplitCnt ++;
				}

DEBUGLOG(("WriteAssignedRecord:: Split Count: [%d]\n",iSplitCnt));

				dTmpAmt = 0.0;
				dTmpTotalAmt = 0.0;

				dTmpAmt = newround(dPayoutAmt/iSplitCnt,0);
				for(iTmp=0;iTmp<(iSplitCnt-1);iTmp++){
					sprintf(csTag,"avag_split_amt_%d",iTmp);
					PutField_Double(hContext,csTag,dTmpAmt);
					dTmpTotalAmt += dTmpAmt;
				}
			}
			sprintf(csTag,"avag_split_amt_%d",(iSplitCnt-1));
			PutField_Double(hContext,csTag,dPayoutAmt-dTmpTotalAmt);

			for(iTmp=0;iTmp<iSplitCnt;iTmp++){
/*
				if(dRemainAmt>dSplitAmt && dSplitAmt>0.0){
					dRemainAmt -= dSplitAmt;
					PutField_Double(hDetail,"payout_amount",dSplitAmt);
				}
				else{
					PutField_Double(hDetail,"payout_amount",dRemainAmt);
					dRemainAmt -=dRemainAmt;
				}	
*/
				sprintf(csTag,"avag_split_amt_%d",iTmp);
				if(GetField_Double(hContext,csTag,&dTmp)){
					PutField_Double(hDetail,"payout_amount",dTmp);
				}
				
				DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextPayoutTxnSeq");
                        	csPayoutTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("WriteAssignedRecord:: GeneratePayoutSeq: [%d]=[%s]\n",i,csPayoutTxnSeq));
                        	PutField_CString(hDetail,"txn_id",csPayoutTxnSeq);
				if(cBatchMode==PD_OFFLINE)
					PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_PRE_GENERATED);
				else
					PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_PRE_SEND);
				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","Add");
				if ((unsigned long)(*DBObjPtr)(hDetail) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("WriteAssignedRecord:: DBPayoutGeneratedFileDT:Add Failed\n"));
				}

				iTxnCnt = 0;
				sprintf(csTag,"%s_gen_txn_cnt",csPspId);
				GetField_Int(hContext,csTag,&iTxnCnt);
				PutField_Int(hContext,csTag,iTxnCnt+1);


			}
			iTxnCnt = 0;
			sprintf(csTag,"%s_txn_cnt",csPspId);
			GetField_Int(hContext,csTag,&iTxnCnt);
			PutField_Int(hContext,csTag,iTxnCnt+1);


			i++;
			hRec = RecordSet_GetNext(rRecordSet);
		}
		PutField_Int(hRequest,"total_count",i);
		PutField_Int(hDetail,"total_count",i);
		PutField_Int(hContext,"total_cnt",i);
DEBUGLOG(("WriteAssignedRecord::total_count= [%d]\n",i));

		GetField_Int(hContext,"psp_count",&iCnt);
		for(i=0; i<iCnt; i++){
			sprintf(csTag,"psp_id_%d",i);
			if(GetField_CString(hContext,csTag,&csPspId)){

				sprintf(csTag, "%s_file_id", csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"file_id",csTmp);
				}
				sprintf(csTag, "%s_txn_cnt", csPspId);
				if(GetField_Int(hContext,csTag,&iTmp)){
					PutField_Int(hHeader,"txn_cnt",iTmp);
				}
				sprintf(csTag, "%s_txn_amt", csPspId);
				if(GetField_Double(hContext,csTag,&dTmp)){
					PutField_Double(hHeader,"txn_amt",dTmp);
				}
				sprintf(csTag, "%s_payout_ccy", csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"ccy_id",csTmp);
				}

				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
				if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("WriteAssignedRecord::PayoutGeneratedFileHD::Update Error!!!\n"));
					iRet = INT_ERR;
				}
				
			}
		}

	}
	else{
DEBUGLOG(("WriteAssignedRecord::GetpspAssignedTxn::Failed!!!!\n"));
ERRLOG("BOPayout:WriteAssignedRecord::GetPspAssignedTxn::Failed!!\n");
		iRet=INT_NOT_RECORD;
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hHeader);
	FREE_ME(hDetail);
	FREE_ME(csTmpBatch);
	FREE_ME(csPayoutTxnSeq);
DEBUGLOG(("WriteAssignedRecord::iRet=[%d]\n",iRet));
	return iRet;
}


int WritePayoutFile(const char* csPayOutFile, hash_t* hRec)
{
	int     iRet=PD_OK;
	int     iTmp;
	char*   csTmp;
	//char*   csPspId = NULL;
	char*   csPspChannel= NULL;
	char	csBankName[PD_BANK_NAME_LEN+1];
	double  dTmp;

DEBUGLOG(("BOPayout:WritePayoutFile()\n"));
	FILE    *fp;
	fp = fopen(csPayOutFile, "a");
	if (fp == NULL) {
DEBUGLOG(("WritePayoutFile::Open Payoutfile [%s] problem\n", csPayOutFile));
ERRLOG("BOPayout:WritePayoutFile::Open Payoutfile problem!!\n");
		iRet=INT_ERR;
	}

	if(iRet==PD_OK) {
		if(GetField_Int(hRec,"end_file",&iTmp)){
			if(iTmp==PD_TRUE){
				if(!GetField_CString(hRec,"psp_channel",&csTmp)){
					fprintf(fp, "</table></body></html>\n");
				}
				fclose(fp);
				return iRet;
			}
		}
	}

	if(GetField_CString(hRec,"psp_channel",&csPspChannel)){
DEBUGLOG(("WritePayoutFile::psp_channel [%s]\n", csPspChannel));
	}/*
	if(GetField_CString(hRec,"psp_id",&csPspId)){
DEBUGLOG(("WritePayoutFile::psp_id [%s]\n", csPspId));
	}*/


	if(iRet==PD_OK){
		if(!strcmp(csPspChannel,PD_CHANNEL_TWV)){
			if (!GetField_CString(hRec, "gen_txn_id", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:gen_txn_id [%s]\n", csTmp));
			fprintf(fp, "%s%c",csTmp,PD_TWV_DELIMETER);

			if (!GetField_CString(hRec, "bank_code", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:bank_code [%s]\n", csTmp));

			fprintf(fp, "%s%c",csTmp,PD_TWV_DELIMETER);
	
			if (!GetField_CString(hRec, "branch", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:branch [%s]\n", csTmp));
			fprintf(fp, "%s%c",csTmp,PD_TWV_DELIMETER);

			if (!GetField_CString(hRec, "identity_id", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:identity_id [%s]\n", csTmp));
			fprintf(fp, "%s%c",csTmp,PD_TWV_DELIMETER);

			if (!GetField_CString(hRec, "account_name", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_name [%s]\n", csTmp));
			fprintf(fp, "%s%c",csTmp,PD_TWV_DELIMETER);

			if (!GetField_CString(hRec, "account_num", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_id [%s]\n", csTmp));
			fprintf(fp, "%s%c",csTmp,PD_TWV_DELIMETER);
	
			if (!GetField_Double(hRec, "payout_amount", &dTmp)) {
				dTmp = 0.0;
			}
DEBUGLOG(("WritePayoutFile:payout_amount [%d]\n", (int)dTmp));
			fprintf(fp, "%d",(int)dTmp);
	
			fprintf(fp, "\n");
		}
		else if(!strcmp(csPspChannel,PD_CHANNEL_YEEPAY)){
			
			fprintf(fp, "%s", PD_TR);
			fprintf(fp, "%s%s",PD_TD,PD_TD_END);

			if (!GetField_CString(hRec, "txn_id", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:txn_id [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "account_name", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_name [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "account_num", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_num [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "bank_name", &csTmp)) {
				csTmp = strdup("");
				fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
			}
			else{
				csBankName[0]='\0';
				DBObjPtr = CreateObj(DBPtr,"DBBankNameMapping","BankNameConvert");
				if ((unsigned long)(*DBObjPtr)(csPspChannel,csTmp,csBankName)==FOUND) {
DEBUGLOG(("WritePayoutFile:bank_name [%s] (converted)\n", csBankName));
				}
				else{
					strcpy(csBankName,csTmp);
					csBankName[strlen(csTmp)]='\0';
DEBUGLOG(("WritePayoutFile:bank_name [%s] (same as input)\n", csBankName));
				}
				fprintf(fp, "%s%s%s",PD_TD,csBankName,PD_TD_END);
			}

			if (!GetField_CString(hRec, "province", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:province [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "city", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:city [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_Double(hRec, "payout_amount", &dTmp)) {
				dTmp = 0.0;
			}
DEBUGLOG(("WritePayoutFile:payout_amount [%f]\n", dTmp));
			fprintf(fp, "%s%f%s",PD_TD,dTmp,PD_TD_END);

			fprintf(fp, "%s%s",PD_TD,PD_TD_END);	

			if (!GetField_CString(hRec, "branch", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:branch [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "phone_num", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:phone_num [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			fprintf(fp, "%s\n", PD_TR_END);

		}
		else if(!strcmp(csPspChannel,PD_CHANNEL_GOPAY)){
			
			fprintf(fp, "%s", PD_TR);

			if (!GetField_CString(hRec, "txn_id", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:txn_id [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "account_name", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_name [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			fprintf(fp, "%s[0000000]%s",PD_TD,PD_TD_END);
			fprintf(fp, "%s[0000000]%s",PD_TD,PD_TD_END);

			if (!GetField_CString(hRec, "bank_name", &csTmp)) {
				csTmp = strdup("");
				fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
			}
			else{
				csBankName[0]='\0';
				DBObjPtr = CreateObj(DBPtr,"DBBankNameMapping","BankNameConvert");
				if ((unsigned long)(*DBObjPtr)(csPspChannel,csTmp,csBankName)==FOUND) {
DEBUGLOG(("WritePayoutFile:bank_name [%s] (converted)\n", csBankName));
				}
				else{
					strcpy(csBankName,csTmp);
					csBankName[strlen(csTmp)]='\0';
DEBUGLOG(("WritePayoutFile:bank_name [%s] (same as input)\n", csBankName));
				}
				fprintf(fp, "%s%s%s",PD_TD,csBankName,PD_TD_END);
			}

			if (!GetField_CString(hRec, "branch", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:branch [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "account_num", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_num [%s]\n", csTmp));
			fprintf(fp, "%s[%s]%s",PD_TD_STYLE,csTmp,PD_TD_END);

			if (!GetField_Double(hRec, "payout_amount", &dTmp)) {
				dTmp = 0.0;
			}
DEBUGLOG(("WritePayoutFile:payout_amount [%f]\n", dTmp));
			fprintf(fp, "%s%f%s",PD_TD,dTmp,PD_TD_END);

			if (!GetField_CString(hRec, "province", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:province [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "city", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:city [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			fprintf(fp, "%s[0]%s",PD_TD,PD_TD_END);
	
			fprintf(fp, "%s\n", PD_TR_END);

		}
		else if(!strcmp(csPspChannel,PD_CHANNEL_ECPSS)){
			
			fprintf(fp, "%s", PD_TR);

			if (!GetField_CString(hRec, "txn_id", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:txn_id [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "bank_name", &csTmp)) {
				csTmp = strdup("");
				fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
			}
			else{
				csBankName[0]='\0';
				DBObjPtr = CreateObj(DBPtr,"DBBankNameMapping","BankNameConvert");
				if ((unsigned long)(*DBObjPtr)(csPspChannel,csTmp,csBankName)==FOUND) {
DEBUGLOG(("WritePayoutFile:bank_name [%s] (converted)\n", csBankName));
				}
				else{
					strcpy(csBankName,csTmp);
					csBankName[strlen(csTmp)]='\0';
DEBUGLOG(("WritePayoutFile:bank_name [%s] (same as input)\n", csBankName));
				}
				fprintf(fp, "%s%s%s",PD_TD,csBankName,PD_TD_END);
			}

			if (!GetField_CString(hRec, "province", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:province [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "city", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:city [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "branch", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:branch [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "account_name", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_name [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "account_num", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_num [%s]\n", csTmp));
			fprintf(fp, "%s[%s]%s",PD_TD_STYLE,csTmp,PD_TD_END);

			if (!GetField_Double(hRec, "payout_amount", &dTmp)) {
				dTmp = 0.0;
			}
DEBUGLOG(("WritePayoutFile:payout_amount [%f]\n", dTmp));
			fprintf(fp, "%s%f%s",PD_TD,dTmp,PD_TD_END);
	
			fprintf(fp, "%s%s",PD_TD,PD_TD_END);
			fprintf(fp, "%s%s",PD_TD,PD_TD_END);
	
			fprintf(fp, "%s\n", PD_TR_END);

		}
		else{
	//		fprintf(fp, "%s%sPayout Trans No.%s%sReceiver Name%s%sID Card No.%s%sMobile No.%s%sBank%s%sBranch%s%sBank Account%s%sAmount%s%sProvince%s%sCity%s%sRemarks%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);

			fprintf(fp, "%s", PD_TR);
/*
			if (!GetField_CString(hRec, "upload_txn_id", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:upload_txn_id [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);
*/
			if (!GetField_CString(hRec, "txn_id", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:txn_id [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "account_name", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_name [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "identity_id", &csTmp)) {
				csTmp = strdup("0000000");
			}
DEBUGLOG(("WritePayoutFile:identity_id [%s]\n", csTmp));
			fprintf(fp, "%s[%s]%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "phone_num", &csTmp)) {
				csTmp = strdup("0000000");
			}
DEBUGLOG(("WritePayoutFile:phone_num [%s]\n", csTmp));
			fprintf(fp, "%s[%s]%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "bank_name", &csTmp)) {
				csTmp = strdup("");
				fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
			}
			else{
				csBankName[0]='\0';
				DBObjPtr = CreateObj(DBPtr,"DBBankNameMapping","BankNameConvert");
				if ((unsigned long)(*DBObjPtr)(csPspChannel,csTmp,csBankName)==FOUND) {
DEBUGLOG(("WritePayoutFile:bank_name [%s] (converted)\n", csBankName));
				}
				else{
					strcpy(csBankName,csTmp);
					csBankName[strlen(csTmp)]='\0';
DEBUGLOG(("WritePayoutFile:bank_name [%s] (same as input)\n", csBankName));
				}
				fprintf(fp, "%s%s%s",PD_TD,csBankName,PD_TD_END);
			}

			if (!GetField_CString(hRec, "branch", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:branch [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "account_num", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_num [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

			if (!GetField_Double(hRec, "payout_amount", &dTmp)) {
				dTmp = 0.0;
			}
DEBUGLOG(("WritePayoutFile:payout_amount [%f]\n", dTmp));
			fprintf(fp, "%s%f%s",PD_TD,dTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "province", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:province [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "city", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:city [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "remark", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:remark [%s]\n", csTmp));
			//fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
			fprintf(fp, "%s%s",PD_TD,csTmp);
			if (!GetField_CString(hRec, "upload_txn_id", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:upload_txn_id [%s]\n", csTmp));
			fprintf(fp, "[%s]%s",csTmp,PD_TD_END);
	
			fprintf(fp, "%s\n", PD_TR_END);
	
		}
	}
	FREE_ME(csTmp);
	fclose(fp);
DEBUGLOG(("WritePayoutFile: iRet[%d]\n", iRet));
	return iRet;
}


int HandleCancelGenerate(hash_t* hContext,
		         hash_t* hRequest,
			 hash_t* hResponse)
{
	int	iRet=PD_OK;
	int	i=0;
	int	iChk=0;
	int	iTmp=0;
	double	dTmp = 0.0;
	char	*csTmp;
	char	*csOrgTxnId;
	char	csNewTxnSeq[PD_TXN_SEQ_LEN+1];
	char	*csFileId;
	char	*csPspId;
	char	*csClient=NULL;
	char	*csUser;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec, *hTxn, *hOrgTxn, *hUploadTxn;
        hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
        hOrgTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hOrgTxn,0);
	hUploadTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hUploadTxn,0);
	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
DEBUGLOG(("HandleCancelGenerate()\n"));

	if(GetField_CString(hContext,"file_id",&csTmp)){
		PutField_CString(hTxn,"file_id",csTmp);
DEBUGLOG(("HandleCancelGenerate() file_id = [%s]\n",csTmp));
	}
	if(GetField_Int(hContext,"status",&iTmp)){
		PutField_Int(hTxn,"status",iTmp);
DEBUGLOG(("HandleCancelGenerate() status = [%d]\n",iTmp));
	}
	if(GetField_Int(hContext,"upload_status",&iTmp)){
		PutField_Int(hTxn,"upload_status",iTmp);
DEBUGLOG(("HandleCancelGenerate() upload_status = [%d]\n",iTmp));
	}
	if(GetField_CString(hRequest,"add_user",&csUser)){
		PutField_CString(hTxn,"update_user",csUser);
	}
	if(GetField_CString(hRequest,"psp_date",&csTmp)){
		PutField_CString(hContext,"psp_date",csTmp);
DEBUGLOG(("HandleCancelGenerate() psp_date= [%s]\n",csTmp));
        }


DEBUGLOG(("HandleCancelGenerate::Call DBPayoutGeneratedFileDT:GetDetailByCondition\n"));
	DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","GetDetailByCondition");
	iChk = (unsigned long)(*DBObjPtr)(hTxn,rRecordSet);
	if (iChk == PD_FOUND) {
		i = 0;
		hRec = RecordSet_GetFirst(rRecordSet);
		while ((hRec) && (iRet==PD_OK)){
			if (GetField_CString(hRec, "file_id", &csFileId)) {
DEBUGLOG(("GetDetail::file_id = [%s]\n",csFileId));
			}
			DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextMgtTxnSeq");
			strcpy(csNewTxnSeq,(*DBObjPtr)());
DEBUGLOG(("csNewTxnSeq [%s]!!!\n",csNewTxnSeq));
			PutField_CString(hContext,"txn_seq",csNewTxnSeq);
			PutField_CString(hTxn,"aux_txn_id",csNewTxnSeq);
			sprintf(csTag,"txn_seq_%d",i);
			PutField_CString(hContext,csTag,csNewTxnSeq);

			if (GetField_CString(hRec, "batch_id", &csTmp)) {
				sprintf(csTag, "batch_id_%d", i);
				PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetDetail::batch_id = [%s]\n",csTmp));
			}
			if (GetField_Int(hRec, "seq_num", &iTmp)) {
				sprintf(csTag, "seq_num_%d", i);
				PutField_Int(hRequest,csTag,iTmp);
DEBUGLOG(("GetDetail::seq_num = [%d]\n",iTmp));
			}
			if (GetField_CString(hRec, "txn_seq", &csOrgTxnId)) {
				//sprintf(csTag, "txn_id_%d", i);
				//PutField_CString(hContext,csTag,csTmp);
				PutField_CString(hContext,"org_txn_seq",csOrgTxnId);
				PutField_CString(hOrgTxn,"txn_seq",csOrgTxnId);
				PutField_CString(hTxn,"txn_id",csOrgTxnId);
DEBUGLOG(("GetDetail::txn_id = [%s]\n",csOrgTxnId));
			}
			if (GetField_CString(hRec, "upload_txn_seq", &csTmp)) {
				//sprintf(csTag, "upload_txn_id_%d", i);
				PutField_CString(hUploadTxn,"txn_seq",csTmp);
DEBUGLOG(("GetDetail::upload_txn_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "txn_country", &csTmp)) {
				sprintf(csTag, "txn_country_%d", i);
				PutField_CString(hRequest,csTag,csTmp);
				//PutField_CString(hContext,"org_txn_country",csTmp);
DEBUGLOG(("GetDetail::txn_country = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "payout_ccy", &csTmp)) {
				sprintf(csTag,"txn_ccy_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
				sprintf(csTag,"dst_txn_ccy_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
				//PutField_CString(hContext,"org_psp_txn_ccy",csTmp);
			}
			if(GetField_Double(hRec,"payout_amount",&dTmp)){
				sprintf(csTag, "gen_payout_amt_%d", i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetDetail::payout_amount = [%lf]\n",dTmp));
			}
			if (GetField_CString(hRec, "psp_id", &csPspId)) {
				sprintf(csTag,"psp_id_%d",i);
				PutField_CString(hRequest,csTag,csPspId);
				//PutField_CString(hContext,"org_psp_id",csTmp);
				//PutField_CString(hTxn,"org_psp_id",csTmp);
				//
				if(i==0){
					hash_t *hPsp;
					hPsp = (hash_t*) malloc (sizeof(hash_t));
					hash_init(hPsp,0);
					DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
					if (!(*DBObjPtr)(csPspId, hPsp)) {
						if (GetField_CString(hPsp,"client_id",&csClient)) {
							PutField_CString(hRequest,"client_id",csClient);
DEBUGLOG(("GetDetail:: GetPspDetail - client id = [%s]\n",csClient));
						}
					}
					FREE_ME(hPsp);
				}
				//PutField_CString(hRequest,"client_id",csClient);
			}
			if (GetField_CString(hRec, "file_name", &csTmp)) {
			}
			if (GetField_Int(hRec, "total_cnt", &iTmp)) {
				//PutField_Int(hContext,"total_count",iTmp);
			}
			if (GetField_Double(hRec, "total_amt", &dTmp)) {
			}

			hash_t* hOrgRec;
			recordset_t     *rOrgRecordSet;
			rOrgRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
			recordset_init(rOrgRecordSet,0);
			DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","GetTxnPspDetail");
			iRet = (unsigned long)(*DBObjPtr)(csOrgTxnId,rOrgRecordSet);
			if(iRet==PD_OK){
				hOrgRec = RecordSet_GetFirst(rOrgRecordSet);
				while(hOrgRec){
					if(GetField_Double(hOrgRec,"service_fee",&dTmp)){
						sprintf(csTag,"precal_fee_%d",i);
						PutField_Double(hRequest,csTag,dTmp);
					}
					hOrgRec = RecordSet_GetNext(rOrgRecordSet);
				}
			}


			if(iRet==PD_OK){			
				PutField_CString(hContext,"process_type","0000");
				PutField_CString(hContext,"process_code","000000");
				PutField_CString(hContext,"txn_code",PD_PAYOUT_CANCEL_PSP);
				PutField_Int(hContext,"do_logging",PD_TRUE);
				PutField_Int(hContext,"db_commit",PD_FALSE);
DEBUGLOG(("GetDetail::Call MGTChannel:AddTxnLog\n"));
				ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnLog");
				if((unsigned long) ((*ChannelObjPtr)(hContext,hRequest))!=PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("GetDetail::MGTChannel:AddTxnLog Failed\n"));
				}
				PutField_Int(hContext,"do_logging",PD_FALSE);
			}

			if(iRet==PD_OK){
				PutField_CString(hUploadTxn,"sub_status",PD_APPROVED_FOR_GENERATED);
DEBUGLOG(("GetDetail::Call DBTransaction:Update (UploadTxn)\n"));
				DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
				if((unsigned long) ((*DBObjPtr)(hUploadTxn))!=PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("GetDetail::DBTransaction:Update Failed\n"));
				}
			}
			if(iRet==PD_OK){
				PutField_CString(hOrgTxn,"sub_status",PD_VOID);
				PutField_Char(hOrgTxn,"status",PD_REVERSED);
DEBUGLOG(("GetDetail::Call DBTransaction:Update (OrgTxn)\n"));
				DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
				if((unsigned long) ((*DBObjPtr)(hOrgTxn))!=PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("GetDetail::DBTransaction:Update Failed\n"));
				}
			}
			if(iRet==PD_OK){
				PutField_CString(hRequest,"org_txn_code",PD_PAYOUT_GENERATE);
				PutField_Int(hRequest,"return_pspfee",PD_TRUE);
				BOObjPtr = CreateObj(BOPtr,"BOTxnElements","VoidOrgTxnElements");
				iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("GetDetail:: VoidOrgTxnElements iRet = [%d]\n",iRet));
			}

			if(iRet==PD_OK){
				PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_CANCELLED);
				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","UpdateByGenId");
				if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
					iRet=INT_ERR;
DEBUGLOG(("GetDetail::DBPayoutGeneratedFileDT Update Failed!!!\n"));
ERRLOG("BOPayout::GetDetail:DBPayoutGeneratedFileDT Update Failed!!!\n");
				}
			}

			i++;
			PutField_Int(hContext,"total_cnt",i);
			hRec = RecordSet_GetNext(rRecordSet);
		}

		if(i!=0){
DEBUGLOG(("Call DBMerchantUploadFileDetail to Resume FileId[%s]\n",csFileId));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","ResumeGeneratedFile");
			iRet = (unsigned long)(*DBObjPtr)(csFileId,csUser);

			if(iRet==PD_OK){
DEBUGLOG(("Call DBPayoutGeneratedFileHD:Update\n"));
				PutField_Int(hTxn,"status",PD_PAYOUTFILE_DECLINED);
				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
				iRet = (unsigned long)(*DBObjPtr)(hTxn);
			}
		}
	}

	if((iChk==PD_FOUND) && (iRet==PD_OK)){
		PutField_CString(hContext,"sub_status",PD_REFUND_APPROVED);
		PutField_Char(hContext,"response_mode",PD_REVERSED);
		PutField_CString(hContext,"desc","Payout Cancel(PSP)");
		PutField_Char(hContext,"party_type",PD_TYPE_PSP);
		if(GetField_CString(hContext,"PHDATE",&csTmp)){
			PutField_CString(hContext,"approval_date",csTmp);
		}

		if(HandlePayoutBalance(hContext,hRequest)!=PD_OK){
DEBUGLOG(("HandleCancelGenerate::HandlePayoutBalance Failed!!!\n"));
ERRLOG("BOPayout::HandleCancelGenerate:HandlePayoutBalance Failed!!!\n");
			iRet = INT_ERR;
		}
	}

	if(iChk!=PD_FOUND){
		iRet = INT_NO_PENDING_RECORD;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("HandleCancelGenerate::No record to cancel!!!\n"));
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);
	FREE_ME(hOrgTxn);
	FREE_ME(hUploadTxn);

DEBUGLOG(("HandleCancelGenerate: iRet[%d]\n", iRet));
	return iRet;
}

int GenerateBatchSeq(hash_t* hRequest)
{
	int	iRet=PD_OK;
	int	iCnt=0;
	int	i=0;
	char	*csTxnSeq;
	char	csTag[PD_TAG_LEN +1];

	if(GetField_Int(hRequest,"total_cnt",&iCnt)){
		for(i=0; i<iCnt; i++){
			DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextBatchTxnSeq");
			sprintf(csTag,"txn_seq_%d",i);
			csTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("GenerateBatchSeq: [%d]=[%s]\n",i,csTxnSeq));
			PutField_CString(hRequest,csTag,csTxnSeq);

			FREE_ME(csTxnSeq);
		}
	}
	return iRet;
}



int AddTxnLog(hash_t *hContext, hash_t *hRequest)
{
	int iRet= PD_OK;
	int i= 0;
	int iCnt= 0;
	char	*csTmp;
	char	*csTxnCode;
	double	dTmp;
	char	cPartyType;
	char	csTag[PD_TAG_LEN+1];
	char	csTxnDateTime[PD_DATETIME_LEN+1];
	hash_t	*hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	if (GetField_Char(hContext,"party_type",&cPartyType)) {
DEBUGLOG(("AddTxnLog:: party_type = [%c]\n",cPartyType));
	}
	if (GetField_CString(hContext,"channel_code",&csTmp)) {
DEBUGLOG(("AddTxnLog:: channel_code = [%s]\n",csTmp));
		PutField_CString(hTxn,"channel_code",csTmp);
	}
	if (GetField_CString(hContext,"txn_code",&csTxnCode)) {
DEBUGLOG(("AddTxnLog:: txn_code = [%s]\n",csTxnCode));
		PutField_CString(hTxn,"txn_code",csTxnCode);
	}

	if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("AddTxnLog:: host_posting_date = [%s]\n",csTmp));
		PutField_CString(hTxn,"host_posting_date",csTmp);
		PutField_CString(hTxn,"txn_date",csTmp);
	}
	if (GetField_CString(hContext,"local_tm_date",&csTmp)) {
DEBUGLOG(("AddTxnLog:: local_tm_date = [%s]\n",csTmp));
		PutField_CString(hTxn,"local_tm_date",csTmp);
		PutField_CString(hTxn,"tm_date",csTmp);
		strcpy(csTxnDateTime,csTmp);
	}
	if (GetField_CString(hContext,"local_tm_time",&csTmp)) {
DEBUGLOG(("AddTxnLog:: local_tm_time = [%s]\n",csTmp));
		PutField_CString(hTxn,"local_tm_time",csTmp);
		PutField_CString(hTxn,"tm_time",csTmp);
		strcat(csTxnDateTime,csTmp);
		csTxnDateTime[strlen(csTxnDateTime)]='\0';
	}
	PutField_CString(hTxn,"transmission_datetime",csTxnDateTime);

	if (GetField_CString(hContext,"add_user",&csTmp)) {
DEBUGLOG(("AddTxnLog:: add_user = [%s]\n",csTmp));
		PutField_CString(hTxn,"add_user",csTmp);
	}
	else{
		PutField_CString(hTxn,"add_user",PD_UPDATE_USER);
	}

	if(cPartyType==PD_TYPE_PSP){
		if(GetField_CString(hContext,"psp_client_id",&csTmp)){
			PutField_CString(hTxn,"client_id",csTmp);
		}
	}

	if (GetField_CString(hContext,"remark",&csTmp)) {
DEBUGLOG(("AddTxnLog:: remark = [%s]\n",csTmp));
                PutField_CString(hTxn,"remark",csTmp);
        }

	PutField_CString(hTxn,"process_type","0000");
	PutField_CString(hTxn,"process_code","000000");

	if(GetField_Int(hContext,"total_cnt",&iCnt)){
DEBUGLOG(("AddTxnLog:: total_cnt = [%d]\n",iCnt));
	}

	for(i=0; i<iCnt; i++){
		sprintf(csTag,"txn_seq_%d",i);
		if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_seq = [%s]\n",csTmp));
			PutField_CString(hTxn,"txn_seq",csTmp);
		}
		sprintf(csTag,"org_txn_id_%d",i);
		if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("AddTxnLog:: org_txn_seq = [%s]\n",csTmp));
			PutField_CString(hTxn,"org_txn_seq",csTmp);
		}

		sprintf(csTag,"merchant_id_%d",i);
		if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("AddTxnLog:: merchant_id = [%s]\n",csTmp));
			PutField_CString(hTxn,"merchant_id",csTmp);
		}

		sprintf(csTag,"merchant_ref_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("AddTxnLog:: merchant_ref = [%s]\n",csTmp));
			PutField_CString(hTxn,"merchant_ref",csTmp);
		}

		sprintf(csTag,"service_code_%d",i);
		if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("AddTxnLog:: service_code = [%s]\n",csTmp));
			PutField_CString(hTxn,"service_code",csTmp);
		}

		sprintf(csTag,"merchant_client_id_%d",i);
		if(GetField_CString(hContext,csTag,&csTmp)){
			PutField_CString(hTxn,"client_id",csTmp);
		}
		else{
			sprintf(csTag,"psp_client_id_%d",i);
			 if(GetField_CString(hContext,csTag,&csTmp))
				PutField_CString(hTxn,"client_id",csTmp);
		}

		if(cPartyType==PD_TYPE_MERCHANT){
			sprintf(csTag,"txn_amt_%d",i);
			if(GetField_Double(hRequest,csTag,&dTmp)){
				PutField_Double(hTxn,"txn_amt",dTmp);
DEBUGLOG(("AddTxnLog:: txn_amt = [%lf]\n",dTmp));
			}
		}
		else{
			sprintf(csTag,"payout_amt_%d",i);
			if(GetField_Double(hRequest,csTag,&dTmp)){
				PutField_Double(hTxn,"txn_amt",dTmp);
DEBUGLOG(("AddTxnLog:: txn_amt = [%lf]\n",dTmp));
			}
		}

		PutField_Char(hTxn,"status",PD_PROCESSING);

		DBObjPtr = CreateObj(DBPtr,"DBTransaction","Add");
		iRet = (unsigned long) ((*DBObjPtr)(hTxn));

	}

	FREE_ME(hTxn);
	return iRet;
}

int UpdateTxnLog(hash_t *hContext)
{
	int iRet= PD_OK;
	//int i= 0;
	//int iCnt= 0;
	char	*csTmp;
	double	dTmp;
	char	cPartyType;
	//char	csTag[PD_TAG_LEN+1];
	hash_t	*hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	if (GetField_Char(hContext,"party_type",&cPartyType)) {
DEBUGLOG(("UpdateTxnLog:: party_type = [%c]\n",cPartyType));
	}

	if (GetField_CString(hContext,"desc",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: desc = [%s]\n",csTmp));
		PutField_CString(hTxn,"desc",csTmp);
	}

	if (GetField_CString(hContext,"approval_date",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: approval_date = [%s]\n",csTmp));
                PutField_CString(hTxn,"approval_date",csTmp);
        }
	if (GetField_CString(hContext,"approval_timestamp",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: approval_timestamp= [%s]\n",csTmp));
		PutField_CString(hTxn,"approval_timestamp",csTmp);
	}

	if (GetField_CString(hContext,"add_user",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: add_user = [%s]\n",csTmp));
		PutField_CString(hTxn,"add_user",csTmp);
		PutField_CString(hTxn,"update_user",csTmp);
	}
	else{
		PutField_CString(hTxn,"add_user",PD_UPDATE_USER);
	}

	if (GetField_CString(hContext,"remark",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: remark = [%s]\n",csTmp));
                PutField_CString(hTxn,"remark",csTmp);
        }

	if (GetField_CString(hContext,"sub_status",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: sub_status = [%s]\n",csTmp));
                PutField_CString(hTxn,"sub_status",csTmp);
        }

	if (GetField_CString(hContext,"txn_id",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_seq = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_seq",csTmp);
	}
	if (GetField_CString(hContext,"org_txn_id",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: org_txn_seq = [%s]\n",csTmp));
		PutField_CString(hTxn,"org_txn_seq",csTmp);
	}

	if(GetField_CString(hContext,"merchant_client_id",&csTmp)){
		PutField_CString(hTxn,"client_id",csTmp);
	}
	else{
		if(GetField_CString(hContext,"psp_client_id",&csTmp))
			PutField_CString(hTxn,"client_id",csTmp);
	}

//txn_detail
	if (GetField_CString(hContext,"bank_name",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: bank_name = [%s]\n",csTmp));
		PutField_CString(hTxn,"bank_name",csTmp);
	}
	if (GetField_CString(hContext,"branch",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: branch = [%s]\n",csTmp));
		PutField_CString(hTxn,"branch_name",csTmp);
	}
	if (GetField_CString(hContext,"account_id",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: account_id = [%s]\n",csTmp));
		PutField_CString(hTxn,"account_id",csTmp);
	}
	if (GetField_CString(hContext,"account_name",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: account_name = [%s]\n",csTmp));
		PutField_CString(hTxn,"account_name",csTmp);
	}
	if (GetField_CString(hContext,"txn_ccy",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_ccy = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_ccy",csTmp);
	}
	if (GetField_CString(hContext,"txn_country",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_country = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_country",csTmp);
	}

	if(GetField_Double(hContext,"merchant_open_bal",&dTmp)){
		PutField_Double(hTxn,"open_bal",dTmp);
DEBUGLOG(("UpdateTxnLog:: open_bal= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"merchant_open_bal_settlement",&dTmp)){
		PutField_Double(hTxn,"open_bal_settlement",dTmp);
DEBUGLOG(("UpdateTxnLog:: open_bal_settlement= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"current_bal",&dTmp)){
		PutField_Double(hTxn,"current_bal",dTmp);
DEBUGLOG(("UpdateTxnLog:: current_bal= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"current_bal_settlement",&dTmp)){
		PutField_Double(hTxn,"current_bal_settlement",dTmp);
DEBUGLOG(("UpdateTxnLog:: current_bal_settlement= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_float",&dTmp)){
		PutField_Double(hTxn,"total_float",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_float= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_float_after_payout",&dTmp)){
		PutField_Double(hTxn,"total_float_after_payout",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_float_after_payout= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_float_settlement",&dTmp)){
		PutField_Double(hTxn,"total_float_settlement",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_float_settlement= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_reserved_amount",&dTmp)){
		PutField_Double(hTxn,"total_reserved_amount",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_reserved_amount= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_hold",&dTmp)){
		PutField_Double(hTxn,"total_hold",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_hold= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_hold_settlement",&dTmp)){
		PutField_Double(hTxn,"total_hold_settlement",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_hold_settlement= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"fundin_payout",&dTmp)){
		PutField_Double(hTxn,"fundin_payout",dTmp);
DEBUGLOG(("UpdateTxnLog:: fundin_payout= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"reserved_payout",&dTmp)){
		PutField_Double(hTxn,"reserved_payout",dTmp);
DEBUGLOG(("UpdateTxnLog:: reserved_payout= [%f]\n",dTmp));
	}

	if(cPartyType==PD_TYPE_MERCHANT){
		if(GetField_Double(hContext,"txn_amt",&dTmp)){
			PutField_Double(hTxn,"txn_amt",dTmp);
DEBUGLOG(("UpdateTxnLog:: txn_amt = [%lf]\n",dTmp));
		}
		if(GetField_Double(hContext,"net_amt",&dTmp)){
			PutField_Double(hTxn,"net_amt",dTmp);
DEBUGLOG(("UpdateTxnLog:: net_amt = [%lf]\n",dTmp));
		}
	}

//Txn Psp Detail
	if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_date = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_date",csTmp);
		PutField_CString(hTxn,"report_date",csTmp);
	}

	if (GetField_CString(hContext,"report_date",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: report_date = [%s]\n",csTmp));
		PutField_CString(hTxn,"report_date",csTmp);
	}

	if (GetField_CString(hContext,"org_psp_id",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: psp_id = [%s]\n",csTmp));
		PutField_CString(hTxn,"psp_id",csTmp);
	}

	if (GetField_CString(hContext,"org_psp_txn_ccy",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_ccy = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_ccy",csTmp);
		PutField_CString(hTxn,"net_ccy",csTmp);
	}
	
	if(GetField_Double(hContext,"org_dst_net_amt",&dTmp)){
		PutField_Double(hTxn,"txn_amt",dTmp);
		PutField_Double(hTxn,"net_amt",dTmp);
DEBUGLOG(("UpdateTxnLog:: txn_amt = [%lf]\n",dTmp));
	}

	if(GetField_Double(hContext,"precal_fee",&dTmp)){
		PutField_Double(hTxn,"service_fee",dTmp);
DEBUGLOG(("UpdateTxnLog:: service_fee = [%lf]\n",dTmp));
	}

	PutField_Char(hTxn,"status",PD_COMPLETE);
	PutField_Char(hTxn,"ar_ind",PD_ACCEPT);
	PutField_Int(hTxn,"internal_code",PD_OK);
	PutField_CString(hTxn,"response_code","0");

	DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
	iRet = (unsigned long) ((*DBObjPtr)(hTxn));

	if(iRet == PD_OK){
DEBUGLOG(("UpdateTxnLog::Call DBTransaction:AddDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("UpdateTxnLog::DBTransaction:AddDetail Failed\n"));
		}
	}

	if(iRet==PD_OK){
DEBUGLOG(("UpdateTxnLog::Call DBTransaction:UpdateDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("UpdateTxnLog::DBTransaction:UpdateDetail Failed\n"));
		}
	}

	if(iRet == PD_OK && cPartyType!=PD_TYPE_MERCHANT){
DEBUGLOG(("UpdateTxnLog::Call DBTxnPspDetail:Add\n"));
		if(GetField_CString(hContext,"psp_date",&csTmp)){
			PutField_CString(hTxn,"txn_date",csTmp);//if input psp_date, overwrite PHDATE
		}

		DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Add");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("UpdateTxnLog::DBTxnPspDetail:Add Failed\n"));
		}
	}

	if(iRet==PD_OK && cPartyType!=PD_TYPE_MERCHANT){
// psp_balance
	if (GetField_Double(hContext,"psp_balance",&dTmp)) {
		PutField_Double(hTxn,"bal",dTmp);
DEBUGLOG(("UpdateTxnLog:: psp_balance = [%f]\n",dTmp));
	}
// psp_total_float
	if (GetField_Double(hContext,"psp_total_float",&dTmp)) {
		PutField_Double(hTxn,"total_float",dTmp);
DEBUGLOG(("UpdateTxnLog:: psp_total_float = [%f]\n",dTmp));
	}
// psp_total_hold
	if (GetField_Double(hContext,"psp_total_hold",&dTmp)) {
		PutField_Double(hTxn,"total_hold",dTmp);
DEBUGLOG(("UpdateTxnLog:: psp_total_hold = [%f]\n",dTmp));
	}
DEBUGLOG(("UpdateTxnLog::Call DBTxnPspDetail:Update\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("UpdateTxnLog::DBTxnPspDetail:Update Failed\n"));
		}
	}


	FREE_ME(hTxn);
	return iRet;
}


int	HandlePayoutBalance(hash_t* hContext, hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iReturnFee = PD_FALSE;
	int	iCnt = 0;
	int	i = 0;
	double	dTmp = 0.0;
	double	dOrgFee=0.0;
	char	cTmp;
	char*	csTmp;
	char*	csTxnCode;
	char	csTag[PD_TAG_LEN+1];
	double	dRemainNetFloat = 0.0;
	double	dRemainResPo = 0.0;
	double	dFundIn = 0.0;
	double	dNetAmt = 0.0;
	hash_t	*hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	
	if(GetField_Char(hContext,"party_type",&cTmp)){
DEBUGLOG(("HandlePayoutBalance::party_type = [%c]\n",cTmp));
	}

	if(GetField_Char(hContext,"response_mode",&cTmp)){
DEBUGLOG(("HandlePayoutBalance::response_mode = [%c]\n",cTmp));
	}

	if(GetField_Int(hContext,"total_cnt",&iCnt)){
DEBUGLOG(("HandlePayoutBalance:: total_cnt = [%d]\n",iCnt));
	}

	if(GetField_CString(hRequest,"report_date",&csTmp)){
DEBUGLOG(("HandlePayoutBalance::report_date = [%s]\n",csTmp));
		PutField_CString(hContext,"report_date",csTmp);
	}

	if(GetField_CString(hContext,"txn_code",&csTxnCode)){
DEBUGLOG(("HandlePayoutBalance::txn_code = [%s]\n",csTxnCode));
	}

	if(!strcmp(csTxnCode,PD_PAYOUT_VOID_MERCHANT)){
		if(GetField_Int(hContext,"VPFEE",&iReturnFee)){
DEBUGLOG(("HandlePayoutBalance::return fee = [%d]\n",iReturnFee));
		}
	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_APPROVE)){
		if(GetField_Double(hContext,"merchant_net_float",&dTmp)){
			PutField_Double(hContext,"remain_merchant_net_float",dTmp);
DEBUGLOG(("HandlePayoutBalance::merchant_net_float = [%lf]\n",dTmp));
		}
		if(GetField_Double(hContext,"merchant_reserved_po",&dTmp)){
			PutField_Double(hContext,"remain_merchant_reserved_po",dTmp);
DEBUGLOG(("HandlePayoutBalance::merchant_reserved_po = [%lf]\n",dTmp));
		}
		if(GetField_Double(hContext,"merchant_fundin_po",&dFundIn)){
DEBUGLOG(("HandlePayoutBalance::merchant_fundin_po = [%lf]\n",dFundIn));
		}
	}

	for(i=0; i<iCnt; i++){
		if(!strcmp(csTxnCode,PD_PAYOUT_APPROVE)){
			GetField_Double(hContext,"remain_merchant_net_float",&dRemainNetFloat);
DEBUGLOG(("HandlePayoutBalance::remain_merchant_net_float = [%lf]\n",dRemainNetFloat));
			GetField_Double(hContext,"remain_merchant_reserved_po",&dRemainResPo);
DEBUGLOG(("HandlePayoutBalance::remain_merchant_reserved_po = [%lf]\n",dRemainResPo));
		}

		sprintf(csTag,"txn_seq_%d",i);
		if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::txn_seq = [%s]\n",csTmp));
			PutField_CString(hContext,"txn_id",csTmp);
		}
		sprintf(csTag,"bank_name_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
			PutField_CString(hContext,"bank_name",csTmp);
		}
		sprintf(csTag,"branch_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
			PutField_CString(hContext,"branch",csTmp);
		}
		sprintf(csTag,"account_id_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
			PutField_CString(hContext,"account_id",csTmp);
		}
		sprintf(csTag,"account_name_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
			PutField_CString(hContext,"account_name",csTmp);
		}
		sprintf(csTag,"txn_ccy_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::txn_ccy = [%s]\n",csTmp));
			PutField_CString(hContext,"org_txn_ccy",csTmp);
			PutField_CString(hContext,"txn_ccy",csTmp);
		}
		sprintf(csTag,"txn_country_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::txn_country = [%s]\n",csTmp));
			PutField_CString(hContext,"org_txn_country",csTmp);
			PutField_CString(hContext,"txn_country",csTmp);
		}
		sprintf(csTag,"merchant_id_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::merchant_id = [%s]\n",csTmp));
			PutField_CString(hContext,"org_merchant_id",csTmp);
		}
		sprintf(csTag,"service_code_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::service_code = [%s]\n",csTmp));
			PutField_CString(hContext,"org_service_code",csTmp);
		}
		sprintf(csTag,"psp_id_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::psp_id = [%s]\n",csTmp));
			PutField_CString(hContext,"org_psp_id",csTmp);
		}
		sprintf(csTag,"dst_txn_ccy_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::dst_txn_ccy = [%s]\n",csTmp));
			PutField_CString(hContext,"org_psp_txn_ccy",csTmp);
		}
		sprintf(csTag,"org_merchant_fee_%d",i);
		if (GetField_Double(hRequest,csTag,&dOrgFee)) {
DEBUGLOG(("HandlePayoutBalance::org_merchant_fee = [%lf]\n",dOrgFee));
		}
		sprintf(csTag,"net_amt_%d",i);
		if (GetField_Double(hRequest,csTag,&dNetAmt)) {
DEBUGLOG(("HandlePayoutBalance::net_amt(merchant) = [%lf]\n",dNetAmt));
			if(iReturnFee==PD_TRUE)
				PutField_Double(hContext,"net_amt",dNetAmt+dOrgFee);
			else
				PutField_Double(hContext,"net_amt",dNetAmt);

			if(!strcmp(csTxnCode,PD_PAYOUT_APPROVE)){
				RemoveField_Double(hContext,"deduct_fundin_po");
				RemoveField_Double(hContext,"deduct_reserved_po");

				if(dRemainNetFloat>0.0){
					if((dRemainNetFloat-dNetAmt)>=0.0){
						dRemainNetFloat = dRemainNetFloat-dNetAmt;
						PutField_Double(hContext,"remain_merchant_net_float",dRemainNetFloat);
DEBUGLOG(("HandlePayoutBalance:: deduct merchant net float only = [%lf]\n",dNetAmt));
						dNetAmt = 0.0;
					}
					else{
DEBUGLOG(("HandlePayoutBalance:: deduct all remaining merchant net float = [%lf]\n",dRemainNetFloat));
						dNetAmt = dNetAmt - dRemainNetFloat;
						PutField_Double(hContext,"remain_merchant_net_float",0.0);
						dRemainNetFloat = 0.0;
					}
				}
				
				if((dNetAmt>0.0) && (dRemainResPo>0.0)&& (dRemainNetFloat==0.0)){
					if((dRemainResPo-dNetAmt)>=0.0){
						dRemainResPo = dRemainResPo-dNetAmt;
						PutField_Double(hContext,"remain_merchant_reserved_po",dRemainResPo);
						PutField_Double(hContext,"deduct_reserved_po",dNetAmt);
DEBUGLOG(("HandlePayoutBalance:: deduct merchant reserved payout = [%lf]\n",dNetAmt));
						dNetAmt = 0.0;
					}
					else{
DEBUGLOG(("HandlePayoutBalance:: deduct all remaining merchant reserved payout = [%lf]\n",dRemainResPo));
						dNetAmt = dNetAmt - dRemainResPo;
						PutField_Double(hContext,"deduct_reserved_po",dRemainResPo);
						PutField_Double(hContext,"remain_merchant_reserved_po",0.0);
						dRemainResPo = 0.0;
					}
				}

				if((dNetAmt>0.0) && (dFundIn>0.0) && (dRemainResPo==0.0) && (dRemainNetFloat==0.0)){
					PutField_Double(hContext,"deduct_fundin_po",dNetAmt);
DEBUGLOG(("HandlePayoutBalance:: deduct merchant FundIn payout = [%lf]\n",dNetAmt));
					dNetAmt = 0.0;
				}
				
			}
		}
		sprintf(csTag,"payout_amt_%d",i);
		if (GetField_Double(hRequest,csTag,&dTmp)) {
DEBUGLOG(("HandlePayoutBalance::txn_amt(psp) = [%lf]\n",dTmp));
			PutField_Double(hContext,"org_dst_net_amt",dTmp);
		}
		else{
			sprintf(csTag,"gen_payout_amt_%d",i);
			if (GetField_Double(hRequest,csTag,&dTmp)) {
DEBUGLOG(("HandlePayoutBalance::txn_amt(psp) = [%lf]\n",dTmp));
				PutField_Double(hContext,"org_dst_net_amt",dTmp);
			}
		}
		sprintf(csTag,"precal_fee_%d",i);
		if (GetField_Double(hRequest,csTag,&dTmp)) {
DEBUGLOG(("HandlePayoutBalance::precal_fee = [%lf]\n",dTmp));
			PutField_Double(hContext,"precal_fee",dTmp);
		}
DEBUGLOG(("HandlePayoutBalance::Call BOBalance:UpdatePayoutAmount\n"));
		BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
		if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("HandlePayoutBalance::BOBalance:UpdatePayoutAmount Failed\n"));
			iRet = INT_ERR;
		}
		else{
			iRet = UpdateTxnLog(hContext);
			if(iRet!=PD_OK){
DEBUGLOG(("HandlePayoutBalance::BOBalance:UpdateTxnLog Failed\n"));
				break;
			}
			else{
				TxnCommit();
			}
		}
		if(iRet!=PD_OK){
DEBUGLOG(("HandlePayoutBalance::BOBalance:HandlePayoutBalance Failed\n"));
			break;
		}
	}

	FREE_ME(hTxn);
	return iRet;
}



int UpdateDetailByTxn(hash_t *hContext,
			hash_t* hRequest)
{
	int     iRet = PD_OK;
	int	iTmp = 0;
	int	iSeqNum = 0;
	char	*csBatchId;
	char	*csTmp;
	double	dTmp;

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	
	if (GetField_CString(hContext,"batch_id",&csBatchId)){
DEBUGLOG(("BOPayout::UpdateDetailByTxn for batch[%s]\n",csBatchId));
	}

	if (GetField_Int(hContext,"seq_num",&iSeqNum)){
DEBUGLOG(("BOPayout::UpdateDetailByTxn for seq_num[%d]\n",iSeqNum));
	}

	if (GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hTxn,"update_user",csTmp);
	}
	
	if (GetField_CString(hContext,"txn_seq",&csTmp)){
		PutField_CString(hTxn,"txn_seq",csTmp);
DEBUGLOG(("BOPayout::UpdateDetailByTxn txn_seq[%s]\n",csTmp));
	}

	if (GetField_CString(hContext,"aux_txn_seq",&csTmp)){
		PutField_CString(hTxn,"aux_txn_seq",csTmp);
DEBUGLOG(("BOPayout::UpdateDetailByTxn aux_txn_seq[%s]\n",csTmp));
	}

	if(GetField_Int(hContext,"approve_id",&iTmp)){
		PutField_Int(hTxn,"approve_id",iTmp);
DEBUGLOG(("BOPayout::UpdateDetailByTxn approve_id[%d]\n",iTmp));
	}

	if(GetField_Double(hContext,"dst_net_amt",&dTmp)){
	//if(GetField_Double(hContext,"payout_amt",&dTmp)){
		PutField_Double(hTxn,"payout_amt",dTmp);
DEBUGLOG(("BOPayout::UpdateDetailByTxn payout_amt[%lf]\n",dTmp));
	}

	if(GetField_CString(hContext,"src_txn_fee_ccy",&csTmp)){
		PutField_CString(hTxn,"merchant_fee_ccy",csTmp);
DEBUGLOG(("BOPayout::UpdateDetailByTxn merchant_fee_ccy[%s]\n",csTmp));
	}

	if(GetField_Double(hContext,"src_txn_fee",&dTmp)){
		PutField_Double(hTxn,"merchant_fee",dTmp);
DEBUGLOG(("BOPayout::UpdateDetailByTxn merchant_fee[%lf]\n",dTmp));
	}

	if(GetField_CString(hContext,"dst_txn_fee_ccy",&csTmp)){
		PutField_CString(hTxn,"member_fee_ccy",csTmp);
DEBUGLOG(("BOPayout::UpdateDetailByTxn member_fee_ccy[%s]\n",csTmp));
	}

	if(GetField_Double(hContext,"dst_txn_fee",&dTmp)){
		PutField_Double(hTxn,"member_fee",dTmp);
DEBUGLOG(("BOPayout::UpdateDetailByTxn member_fee[%lf]\n",dTmp));
	}

	if(GetField_CString(hContext,"markup_ccy",&csTmp)){
		PutField_CString(hTxn,"markup_ccy",csTmp);
	}
	
	if(GetField_Double(hContext,"markup_amt",&dTmp)){
		PutField_Double(hTxn,"markup_amt",dTmp);
	}

	if(GetField_Double(hContext,"ex_rate",&dTmp)){
		PutField_Double(hTxn,"ex_rate",dTmp);
	}

	if (GetField_Int(hContext,"status",&iTmp)){
		PutField_Int(hTxn,"status",iTmp);
DEBUGLOG(("BOPayout::UpdateDetailByTxn status[%d]\n",iTmp));
	}

	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","UpdateDetailByBatchId");
	if ((*DBObjPtr)(csBatchId,iSeqNum,hTxn) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOPayout::DBMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
	}

DEBUGLOG(("BOPayout:UpdateDetailByTxn iRet=[%d]\n",iRet));
	FREE_ME(hTxn);
	return  iRet;
}
//
int HandleCancelUpload(hash_t *hContext, hash_t *hRequest)
{
	int	iRet = PD_OK;
	int	iPos = 0;
	int	iTmp = 0;
	char	*csTmp;
	char	csTag[PD_TAG_LEN+1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	if (GetField_Int(hContext,"position",&iPos)){
DEBUGLOG(("BOPayout::HandleCancelUpload position[%d]\n",iPos));
	}
	
	sprintf(csTag,"batch_id_%d",iPos);
	if (GetField_CString(hRequest,csTag,&csTmp)){
		PutField_CString(hTxn,"batch_id",csTmp);
DEBUGLOG(("BOPayout::HandleCancelUpload batch[%s]\n",csTmp));
	}

	sprintf(csTag,"seq_num_%d",iPos);
	if (GetField_Int(hRequest,csTag,&iTmp)){
		PutField_Int(hTxn,"seq_num",iTmp);
DEBUGLOG(("BOPayout::HandleCancelUpload seq_num[%d]\n",iTmp));
	}

	PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_CANCELLED);

DEBUGLOG(("BOPayout:HandleCancelUpload Call UpdateDetailByTxn\n"));
	iRet = UpdateDetailByTxn(hTxn,hRequest);

	FREE_ME(hTxn);
DEBUGLOG(("BOPayout:HandleCancelUpload iRet[%d]\n",iRet));
	return	iRet;
}


int HandleCancelConfirm(hash_t *hContext, hash_t *hRequest)
{
	int	iRet = PD_OK;
	int	iPos = 0;
	int	iTmp = 0;
	//double	dTmp = 0.0;
	char	*csTmp;
	//char    *csTxnSeq;
	char	csTag[PD_TAG_LEN+1];
	//char	csSeqNum[PD_TAG_LEN+1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	if (GetField_Int(hContext,"position",&iPos)){
DEBUGLOG(("BOPayout::HandleCancelConfirm position[%d]\n",iPos));
	}

	sprintf(csTag,"batch_id_%d",iPos);
	if (GetField_CString(hRequest,csTag,&csTmp)){
		PutField_CString(hTxn,"batch_id",csTmp);
		//PutField_CString(hContext,"batch_id_0",csTmp);
DEBUGLOG(("BOPayout::HandleCancelConfirm batch[%s]\n",csTmp));
	}

	sprintf(csTag,"seq_num_%d",iPos);
	if (GetField_Int(hRequest,csTag,&iTmp)){
		PutField_Int(hTxn,"seq_num",iTmp);
		//sprintf(csSeqNum,"%d",iTmp);
		//PutField_CString(hContext,"seq_num_0",csSeqNum);
DEBUGLOG(("BOPayout::HandleCancelConfirm seq_num[%d]\n",iTmp));
	}
/*
	if(iRet==PD_OK){
DEBUGLOG(("HandleCancelConfirm: Call GetNextBatchTxnSeq\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextBatchTxnSeq");
		csTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("HandleCancelConfirm: GenerateBatchSeq: [%s]\n",csTxnSeq));
		PutField_CString(hContext,"txn_seq",csTxnSeq);
		PutField_CString(hTxn,"txn_seq",csTxnSeq);
		FREE_ME(csTxnSeq);
	}
	if(iRet==PD_OK){
		sprintf(csTag,"merchant_id_%d",iPos);
		if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"merchant_id",csTmp);
                }
		sprintf(csTag,"merchant_ref_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"merchant_ref",csTmp);
                }
		sprintf(csTag,"service_code_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"service_code",csTmp);
                }
		sprintf(csTag,"merchant_client_id_%d",iPos);
                if(GetField_CString(hContext,csTag,&csTmp)){
                        PutField_CString(hRequest,"client_id",csTmp);
                }
		sprintf(csTag,"txn_ccy_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"txn_ccy",csTmp);
                }
		sprintf(csTag,"txn_country_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"txn_country",csTmp);
                }
		sprintf(csTag,"bank_name_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"bank_name",csTmp);
                }
		sprintf(csTag,"branch_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"branch",csTmp);
                }
		sprintf(csTag,"account_name_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"account_name",csTmp);
                }
		sprintf(csTag,"account_id_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"account_id",csTmp);
                }
		sprintf(csTag,"txn_amt_%d",iPos);
                if(GetField_Double(hRequest,csTag,&dTmp)){
                        PutField_Double(hContext,"txn_amt",dTmp);
                        PutField_Double(hContext,"net_amt",dTmp);
                }

		PutField_CString(hContext,"txn_code",PD_PAYOUT_CANCEL);

		if (GetField_CString(hContext,"PHDATE",&csTmp)) {
			PutField_CString(hContext,"approval_date",csTmp);
		}

		PutField_CString(hContext,"process_type","0000");
                PutField_CString(hContext,"process_code","000000");
                PutField_Char(hContext,"party_type",PD_TYPE_MERCHANT);
                PutField_Char(hTxn,"party_type",PD_TYPE_MERCHANT);

                PutField_Int(hContext,"do_logging",PD_TRUE);

DEBUGLOG(("HandleCancelConfirm::Call MGTChannel:AddTxnLog\n"));
		RemoveField_CString(hContext,"org_txn_seq");
                ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnLog");
                if((unsigned long) ((*ChannelObjPtr)(hContext,hRequest))!=PD_OK){
                        iRet = INT_ERR;
DEBUGLOG(("HandleCancelConfirm::MGTChannel:AddTxnLog Failed\n"));
                }
	}
*/
	if(iRet==PD_OK){
		PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_CANCELLED);
DEBUGLOG(("BOPayout:HandleCancelConfirm Call UpdateDetailByTxn\n"));
		iRet = UpdateDetailByTxn(hTxn,hRequest);
	}

	if(iRet==PD_OK){
		sprintf(csTag,"org_txn_id_%d",iPos);
		if (GetField_CString(hContext,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_seq",csTmp);
DEBUGLOG(("BOPayout::HandleCancelConfirm txn_seq = [%s]\n",csTmp));
		}
	
                PutField_Int(hTxn,"do_logging",PD_TRUE);
		PutField_CString(hTxn,"sub_status",PD_ADMIN_CANCELLED);
		PutField_Char(hTxn,"status",PD_COMPLETE);
                PutField_Char(hTxn,"ar_ind",PD_REJECTED);
                PutField_Int(hTxn,"internal_code",PD_OK);
                PutField_CString(hTxn,"response_code","0");
DEBUGLOG(("Authorize::Call MGTChannel:UpdateTxnLog\n"));
                ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateTxnLog");
                if((unsigned long) ((*ChannelObjPtr)(hTxn,hRequest,hRequest))!=PD_OK){
                        iRet = INT_ERR;
DEBUGLOG(("Authorize::MGTChannel:UpdateTxnLog Failed\n"));
                }
/*
                if(iRet == PD_OK){
DEBUGLOG(("Authorize::Call MGTChannel:UpdateTxnDetailLog\n"));
                        ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateTxnDetailLog");
                        if((unsigned long) ((*ChannelObjPtr)(hContext,hRequest,hRequest))!=PD_OK){
                                iRet = INT_ERR;
DEBUGLOG(("Authorize::MGTChannel:AddTxnDetailLog Failed\n"));
                        }
                        else{
                                TxnCommit();
                        }
                }
*/
	}

	FREE_ME(hTxn);
DEBUGLOG(("BOPayout:HandleCancelConfirm iRet[%d]\n",iRet));
	return	iRet;
}


int HandleCancelApprove(hash_t *hContext, hash_t *hRequest)
{
	int	iRet = PD_OK;
	int	iPos = 0;
	int	iTmp = 0;
	int	iDayOfWeek = 0;
	int	iSameDate = PD_FALSE;
	double	dTmp;
	char	*csTmp;
	char	*csTxnSeq;
	char	*csPostDate;
	char	*csOrgPostDate;
	char	csTag[PD_TAG_LEN+1];
	//char	csSeqNum[PD_TAG_LEN+1];
	char	csRespCode[PD_RESPONSE_CODE_LEN+1];
	int	iInternalCode = 0;

	char *csTmpRemark;
	csTmpRemark = (char*) malloc (128);

	hash_t  *hOrg;
        hOrg = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hOrg,0);
	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	hash_t  *hRec;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

	if (GetField_CString(hContext,"response_code",&csTmp)) {
		sprintf(csRespCode,"%s",csTmp);
DEBUGLOG(("BOPayout::HandleCancelApprove response error_code [%s]\n",csRespCode));
	}
	else{
		sprintf(csRespCode,"%s","0");
	}
	if (GetField_Int(hContext,"internal_code",&iInternalCode)){
DEBUGLOG(("BOPayout::HandleCancelApprove internal_code[%d]\n",iInternalCode));
        	DBObjPtr = CreateObj(DBPtr,"DBMessages","GetInternalMessage");

        	if ((unsigned long)(*DBObjPtr)(iInternalCode,csTmpRemark) == PD_OK) {
DEBUGLOG(("BOPayout::HandleCancelApprove find remark = [%s]\n",csTmpRemark));
        	        PutField_CString(hRequest,"remark",csTmpRemark);
        	}
	}

	if (GetField_Int(hContext,"position",&iPos)){
DEBUGLOG(("BOPayout::HandleCancelApprove position[%d]\n",iPos));
	}
	
	sprintf(csTag,"batch_id_%d",iPos);
	if (GetField_CString(hRequest,csTag,&csTmp)){
		PutField_CString(hTxn,"batch_id",csTmp);
DEBUGLOG(("HandleCancelApprove batch[%s]\n",csTmp));
	}

	sprintf(csTag,"seq_num_%d",iPos);
	if (GetField_Int(hRequest,csTag,&iTmp)){
		PutField_Int(hTxn,"seq_num",iTmp);
DEBUGLOG(("HandleCancelApprove seq_num[%d]\n",iTmp));
	}

	if (GetField_CString(hContext,"PHDATE",&csPostDate)) {
		PutField_CString(hContext,"approval_date",csPostDate);
		iDayOfWeek=day_of_week((const unsigned char *)csPostDate);
DEBUGLOG(("HandleCancelApprove::day_of_week= [%d]\n",iDayOfWeek));
		PutField_Int(hContext,"day_of_week",iDayOfWeek);
	}

	if(iRet==PD_OK){
DEBUGLOG(("HandleCancelApprove: Call GetNextBatchTxnSeq\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextBatchTxnSeq");
		csTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("HandleCancelApprove: GenerateBatchSeq: [%s]\n",csTxnSeq));
		PutField_CString(hContext,"txn_seq",csTxnSeq);
		//PutField_CString(hTxn,"txn_seq",csTxnSeq);
		PutField_CString(hTxn,"aux_txn_seq",csTxnSeq);
		PutField_CString(hContext,"txn_id",csTxnSeq);
		FREE_ME(csTxnSeq);
	}

	if(iRet==PD_OK){
		sprintf(csTag,"org_txn_id_%d",iPos);
		if(GetField_CString(hContext,csTag,&csTmp)){
DEBUGLOG(("HandleCancelApprove::!!!!!!!!!!org_txn_seq = [%s]!!!!!!!!!!!!!\n",csTmp));
			PutField_CString(hContext,"org_txn_seq",csTmp);
			PutField_CString(hOrg,"txn_seq",csTmp);

			recordset_init(rRecordSet,0);
			DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
			if ((*DBObjPtr)(csTmp,rRecordSet) == PD_OK) {
DEBUGLOG(("GetTxnHeader::found record = [%s]\n",csTmp));
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if (GetField_CString(hRec,"host_posting_date",&csOrgPostDate)){
						if(!strcmp(csPostDate,csOrgPostDate)){
							iSameDate = PD_TRUE;
						}
					}
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
		}

		sprintf(csTag,"merchant_id_%d",iPos);
		if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"merchant_id",csTmp);
                }
		sprintf(csTag,"merchant_ref_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"merchant_ref",csTmp);
                }
		sprintf(csTag,"service_code_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"service_code",csTmp);
                }
		sprintf(csTag,"merchant_client_id_%d",iPos);
                if(GetField_CString(hContext,csTag,&csTmp)){
                        PutField_CString(hRequest,"client_id",csTmp);
                        PutField_CString(hContext,"merchant_client_id",csTmp);
                }
		sprintf(csTag,"txn_ccy_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"txn_ccy",csTmp);
                        PutField_CString(hContext,"txn_ccy",csTmp);
                        PutField_CString(hContext,"net_ccy",csTmp);
                }
		sprintf(csTag,"dst_txn_ccy_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"dst_txn_ccy",csTmp);
                }
		sprintf(csTag,"txn_country_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hContext,"txn_country",csTmp);
                        PutField_CString(hRequest,"txn_country",csTmp);
                }
		sprintf(csTag,"bank_name_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"bank_name",csTmp);
                }
		sprintf(csTag,"branch_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"branch",csTmp);
                }
		sprintf(csTag,"account_name_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"account_name",csTmp);
                }
		sprintf(csTag,"account_id_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"account_id",csTmp);
                }
		sprintf(csTag,"txn_amt_%d",iPos);
                if(GetField_Double(hRequest,csTag,&dTmp)){
                        PutField_Double(hRequest,"txn_amt",dTmp);
                        PutField_Double(hRequest,"net_amt",dTmp);
                }

		PutField_CString(hContext,"txn_code",PD_PAYOUT_VOID_MERCHANT);
		
		PutField_CString(hContext,"process_type","0000");
		PutField_CString(hContext,"process_code","000000");
		PutField_Char(hContext,"party_type",PD_TYPE_MERCHANT);

		PutField_Int(hContext,"do_logging",PD_TRUE);

DEBUGLOG(("HandleCancelApprove::Call MGTChannel:AddTxnLog\n"));
		ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnLog");
		if((unsigned long) ((*ChannelObjPtr)(hContext,hRequest))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("HandleCancelApprove::MGTChannel:AddTxnLog Failed\n"));
		}

	}

	if(iRet==PD_OK){
		//RemoveField_CString(hTxn,"txn_seq");
		PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_REVERSED);
DEBUGLOG(("HandleCancelApprove Call UpdateDetailByTxn\n"));
		iRet = UpdateDetailByTxn(hTxn,hRequest);
	}

	if(iRet==PD_OK){
		PutField_Int(hContext,"same_date_cancel",iSameDate);
		PutField_CString(hRequest,"org_txn_code",PD_PAYOUT_APPROVE);
		BOObjPtr = CreateObj(BOPtr,"BOTxnElements","VoidOrgTxnElements");
		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("HandleCancelApprove:: VoidOrgTxnElements iRet = [%d]\n",iRet));
	}

	if(iRet==PD_OK){
		iRet = GetPayoutFee(hContext,hRequest);
DEBUGLOG(("HandleCancelApprove:: GetPayoutFee iRet = [%d]\n",iRet));
	}

	if(iRet==PD_OK){
		//PutField_Int(hContext,"same_date_cancel",iSameDate);
		PutField_Char(hContext,"response_mode",PD_REVERSED);
		PutField_Char(hContext,"party_type",PD_TYPE_MERCHANT);
                iRet = HandleTxnPayoutBalance(hContext,hRequest);
DEBUGLOG(("HandleCancelApprove::HandleTxnPayoutBalance iRet = [%d]\n",iRet));
        }

	if(iRet==PD_OK){
DEBUGLOG(("HandleCancelApprove::call DBTransaction->Update (OrgTxn)\n"));
		PutField_Char(hOrg,"status",PD_REVERSED);
		PutField_CString(hOrg,"sub_status",PD_APPROVED_VOID);
		PutField_CString(hOrg,"response_code",csRespCode);
		PutField_Int(hOrg,"internal_code",iInternalCode);

		DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
		iRet = (unsigned long) ((*DBObjPtr)(hOrg));
	}

	if(iRet==PD_OK){
		PutField_CString(hContext,"desc","Payout Refund(Merchant)");
		PutField_CString(hContext,"sub_status",PD_REFUND_APPROVED);
		PutField_Char(hContext,"status",PD_COMPLETE);
		PutField_Char(hContext,"ar_ind",PD_ACCEPT);
		PutField_Int(hContext,"internal_code",iInternalCode);
		PutField_CString(hContext,"response_code",csRespCode);
DEBUGLOG(("Authorize::Call MGTChannel:UpdateTxnLog\n"));
                ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateTxnLog");
                if((unsigned long) ((*ChannelObjPtr)(hContext,hRequest,hRequest))!=PD_OK){
                        iRet = INT_ERR;
DEBUGLOG(("Authorize::MGTChannel:AddTxnLog Failed\n"));
                }
                PutField_Int(hContext,"do_logging",PD_FALSE);

                if(iRet == PD_OK){
DEBUGLOG(("Authorize::Call MGTChannel:UpdateTxnDetailLog\n"));
                        ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateTxnDetailLog");
                        if((unsigned long) ((*ChannelObjPtr)(hContext,hRequest,hRequest))!=PD_OK){
                                iRet = INT_ERR;
DEBUGLOG(("Authorize::MGTChannel:AddTxnDetailLog Failed\n"));
                        }
                        else{
                                TxnCommit();
                        }
                }

	}
	FREE_ME(hTxn);
	FREE_ME(hOrg);
	FREE_ME(csTmpRemark);
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
DEBUGLOG(("HandleCancelApprove iRet[%d]\n",iRet));
	return	iRet;
}


int isVoidWithFee(hash_t* hTxn)
{
	int	iRet = PD_OK;
	int	iTmp = PD_FALSE;
	char	*csServiceCode;
	hash_t  *hRec;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	if(GetField_CString(hTxn,"service_code",&csServiceCode)){
		DBObjPtr = CreateObj(DBPtr,"DBDefServiceCode","GetServiceCodeDetail");
		if ((*DBObjPtr)(csServiceCode,rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_Int(hRec,"VPFEE",&iTmp)) {
					PutField_Int(hTxn,"VPFEE",iTmp);
DEBUGLOG(("isVoidWithFee::Void Payout With Fee Return= [%d]\n",iTmp));
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}

		}
	}
	else{
		iRet = INT_ERR;
DEBUGLOG(("isVoidWithFee::Service Code not found!!!!!\n"));
	}

DEBUGLOG(("isVoidWithFee iRet = [%d]\n",iRet));
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	return iRet;
}


int	HandleTxnPayoutBalance(hash_t* hContext, hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iReturnFee = PD_FALSE;
	//int	iCnt = 0;
	//int	i = 0;
	double	dTmp = 0.0;
	double	dOrgFee=0.0;
	char	cTmp;
	char*	csTmp;
	char*	csTxnCode;
	//char	csTag[PD_TAG_LEN+1];
	double	dRemainNetFloat = 0.0;
	double	dRemainResPo = 0.0;
	double	dFundIn = 0.0;
	double	dNetAmt = 0.0;
	hash_t	*hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	
	if(GetField_Char(hContext,"party_type",&cTmp)){
DEBUGLOG(("HandleTxnPayoutBalance::party_type = [%c]\n",cTmp));
	}

	if(GetField_Char(hContext,"response_mode",&cTmp)){
DEBUGLOG(("HandleTxnPayoutBalance::response_mode = [%c]\n",cTmp));
	}

	if(GetField_CString(hContext,"txn_code",&csTxnCode)){
DEBUGLOG(("HandleTxnPayoutBalance::txn_code = [%s]\n",csTxnCode));
	}
	if(!strcmp(csTxnCode,PD_PAYOUT_VOID_MERCHANT)){
		if(GetField_Int(hContext,"VPFEE",&iReturnFee)){
DEBUGLOG(("HandleTxnPayoutBalance::return fee = [%d]\n",iReturnFee));
		}
	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_APPROVE)){
		GetField_Double(hContext,"remain_merchant_net_float",&dRemainNetFloat);
DEBUGLOG(("HandleTxnPayoutBalance::remain_merchant_net_float = [%lf]\n",dRemainNetFloat));
		GetField_Double(hContext,"remain_merchant_reserved_po",&dRemainResPo);
DEBUGLOG(("HandleTxnPayoutBalance::remain_merchant_reserved_po = [%lf]\n",dRemainResPo));
		GetField_Double(hContext,"merchant_fundin_po",&dFundIn);
DEBUGLOG(("HandleTxnPayoutBalance::merchant_fundin_po = [%lf]\n",dFundIn));
	}

	if (GetField_CString(hContext,"txn_seq",&csTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::txn_seq = [%s]\n",csTmp));
		PutField_CString(hContext,"txn_id",csTmp);
	}
	if (GetField_CString(hContext,"txn_ccy",&csTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::txn_ccy = [%s]\n",csTmp));
		PutField_CString(hContext,"org_txn_ccy",csTmp);
	}
	if (GetField_CString(hRequest,"txn_country",&csTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::txn_country = [%s]\n",csTmp));
		PutField_CString(hContext,"org_txn_country",csTmp);
	}
	if (GetField_CString(hRequest,"merchant_id",&csTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::merchant_id = [%s]\n",csTmp));
		PutField_CString(hContext,"org_merchant_id",csTmp);
	}
	if (GetField_CString(hRequest,"service_code",&csTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::service_code = [%s]\n",csTmp));
		PutField_CString(hContext,"org_service_code",csTmp);
	}

	if (GetField_CString(hRequest,"psp_id",&csTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::psp_id = [%s]\n",csTmp));
		PutField_CString(hContext,"org_psp_id",csTmp);
	}
	if (GetField_CString(hRequest,"dst_txn_ccy",&csTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::dst_txn_ccy = [%s]\n",csTmp));
		PutField_CString(hContext,"org_psp_txn_ccy",csTmp);
	}

	if (GetField_Double(hRequest,"org_merchant_fee",&dOrgFee)) {
DEBUGLOG(("HandleTxnPayoutBalance::org_merchant_fee = [%lf]\n",dOrgFee));
	}

	if (GetField_Double(hRequest,"net_amt",&dNetAmt)) {
DEBUGLOG(("HandleTxnPayoutBalance::net_amt(merchant) = [%lf]\n",dNetAmt));
		if(iReturnFee==PD_TRUE)
			PutField_Double(hContext,"net_amt",dNetAmt+dOrgFee);
		else
			PutField_Double(hContext,"net_amt",dNetAmt);

		if(!strcmp(csTxnCode,PD_PAYOUT_APPROVE)){
			RemoveField_Double(hContext,"deduct_fundin_po");
			RemoveField_Double(hContext,"deduct_reserved_po");

			if(dRemainNetFloat>0.0){
				if((dRemainNetFloat-dNetAmt)>=0.0){
					dRemainNetFloat = dRemainNetFloat-dNetAmt;
					PutField_Double(hContext,"remain_merchant_net_float",dRemainNetFloat);
DEBUGLOG(("HandleTxnPayoutBalance:: deduct merchant net float only = [%lf]\n",dNetAmt));
					dNetAmt = 0.0;
				}
				else{
DEBUGLOG(("HandleTxnPayoutBalance:: deduct all remaining merchant net float = [%lf]\n",dRemainNetFloat));
					dNetAmt = dNetAmt - dRemainNetFloat;
					PutField_Double(hContext,"remain_merchant_net_float",0.0);
					dRemainNetFloat = 0.0;
				}
			}

			if((dNetAmt>0.0) && (dRemainResPo>0.0)&& (dRemainNetFloat==0.0)){
				if((dRemainResPo-dNetAmt)>=0.0){
					dRemainResPo = dRemainResPo-dNetAmt;
					PutField_Double(hContext,"remain_merchant_reserved_po",dRemainResPo);
					PutField_Double(hContext,"deduct_reserved_po",dNetAmt);
DEBUGLOG(("HandleTxnPayoutBalance:: deduct merchant reserved payout = [%lf]\n",dNetAmt));
					dNetAmt = 0.0;
				}
				else{
DEBUGLOG(("HandleTxnPayoutBalance:: deduct all remaining merchant reserved payout = [%lf]\n",dRemainResPo));
					dNetAmt = dNetAmt - dRemainResPo;
					PutField_Double(hContext,"deduct_reserved_po",dRemainResPo);
					PutField_Double(hContext,"remain_merchant_reserved_po",0.0);
					dRemainResPo = 0.0;
				}
			}

			if((dNetAmt>0.0) && (dFundIn>0.0) && (dRemainResPo==0.0) && (dRemainNetFloat==0.0)){
				if((dNetAmt-dFundIn)>0.0){
					if(!strcmp(csTmp,"K000000001") || !strcmp(csTmp,"kkk")){
					//if(strcmp(csTmp,"M8000017")){
						iRet = INT_INSUFFICIENT_FUND;
						PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("HandleTxnPayoutBalance:: insufficient fund!!!!\n"));
ERRLOG("BOPayout::HandleTxnPayoutBalance: insufficient fund!!!!\n");
					}
					else{
                                                PutField_Double(hContext,"deduct_fundin_po",dFundIn);
                                                PutField_Double(hContext,"merchant_fundin_po",0.0);
                                        }
				}
				else{
					PutField_Double(hContext,"deduct_fundin_po",dNetAmt);
DEBUGLOG(("HandleTxnPayoutBalance:: deduct merchant FundIn payout = [%lf]\n",dNetAmt));
					dNetAmt = 0.0;
				}
			}
			
		}
	}

	if(iRet == PD_OK){
		if (GetField_Double(hRequest,"payout_amt",&dTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::txn_amt(psp) = [%lf]\n",dTmp));
			PutField_Double(hContext,"org_dst_net_amt",dTmp);
		}
		else{
			if (GetField_Double(hRequest,"gen_payout_amt",&dTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::txn_amt(psp) = [%lf]\n",dTmp));
				PutField_Double(hContext,"org_dst_net_amt",dTmp);
			}
		}
		if (GetField_Double(hContext,"precal_fee",&dTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::precal_fee = [%lf]\n",dTmp));
		}
DEBUGLOG(("HandleTxnPayoutBalance::Call BOBalance:UpdatePayoutAmount\n"));
		BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
		if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("HandleTxnPayoutBalance::BOBalance:UpdatePayoutAmount Failed\n"));
			iRet = INT_ERR;
		}
	}

DEBUGLOG(("HandleTxnPayoutBalance::iRet [%d]\n",iRet));
	FREE_ME(hTxn);
	return iRet;
}


int GetPreApproveRecord(hash_t* hContext,
			hash_t* hRequest,
			hash_t* hResponse)
{
	int     iRet  = PD_OK;
	int	iSeqNum = 0;
	//int	iIntErr= PD_OK;
	int	i= 0;
	int	iTmp= 0;
	int	iOnlineMode = PD_FALSE;
	int	iPreApproveId=0;
	char	*csMerchantId;
	char	*csServiceCode;
	char	*csTxnCountry=strdup("");
	char	*csTxnCcy;
	char	*csTxnId;
	char	*csTmp;
	char	*csMerchantClientId = NULL;
	//char	cInputInd;
	double	dTmp=0.0;
	double	dTotalAmt=0.0;
	//double	dLimitedAmt=0.0;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	char*   csPspTmp;
	csPspTmp = (char*) malloc (128);

DEBUGLOG(("BOPayout:GetPreApproveRecord()\n"));

	if(GetField_Int(hContext,"pre_approve_id",&iPreApproveId)){
DEBUGLOG(("BOPayout:GetPreApproveRecord::pre_approve_id = [%d]\n",iPreApproveId));
	}

DEBUGLOG(("GetPreApproveRecord::Call DBMerchantUploadFileDetail:GetDetailByPreApproveId\n"));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetailByPreApproveId");
	if ((unsigned long)(*DBObjPtr)(iPreApproveId,rRecordSet) == PD_FOUND) {
DEBUGLOG(("GetDetailByPreApproveId::found record\n"));
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if (GetField_CString(hRec,"txn_seq",&csTxnId)) {
				sprintf(csTag,"org_txn_id_%d",i);
				PutField_CString(hContext,csTag,csTxnId);
DEBUGLOG(("GetDetailByPreApproveId::org_txn_seq = [%s]\n",csTxnId));
			}
			if (GetField_CString(hRec,"merchant_id",&csMerchantId)) {
				sprintf(csTag,"merchant_id_%d",i);
				PutField_CString(hRequest,"merchant_id",csMerchantId);
				PutField_CString(hContext,"merchant_id",csMerchantId);
				PutField_CString(hRequest,csTag,csMerchantId);
				PutField_CString(hContext,csTag,csMerchantId);
				//sprintf(csTag,"org_merchant_id_%d",i);
				//PutField_CString(hContext,csTag,csMerchantId);
DEBUGLOG(("GetDetailByPreApproveId::merchant_id= [%s]\n",csMerchantId));

				if(i==0){
					if(!GetField_CString(hContext,"merchant_client_id",&csMerchantClientId)){
						BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantDetail");
						if((unsigned long)(*BOObjPtr)(hContext,hRequest)==PD_OK){
							if(GetField_CString(hContext,"merchant_client_id",&csMerchantClientId)){
DEBUGLOG(("GetMerchantDetail::client_id= [%s]\n",csMerchantClientId));
							}
						}
					}
				}
				sprintf(csTag,"merchant_client_id_%d",i);
				PutField_CString(hContext,csTag,csMerchantClientId);
			}
			else{
				iRet = INT_MERCHANT_ID_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
				break;
DEBUGLOG(("GetDetailByPreApproveId::merchant_id not found\n"));
			}
			if (GetField_CString(hRec,"txn_country",&csTxnCountry)) {
                                PutField_CString(hRequest,"txn_country",csTxnCountry);
                                PutField_CString(hContext,"txn_country",csTxnCountry);
                                sprintf(csTag,"txn_country_%d",i);
                                PutField_CString(hRequest,csTag,csTxnCountry);
                                PutField_CString(hContext,csTag,csTxnCountry);
DEBUGLOG(("GetDetailByPreApproveId ::txn_country= [%s]\n",csTxnCountry));
                        }
			if (GetField_CString(hRec,"service_code",&csServiceCode)) {
				PutField_CString(hRequest,"service_code",csServiceCode);
				PutField_CString(hContext,"service_code",csServiceCode);
				sprintf(csTag,"service_code_%d",i);
				PutField_CString(hRequest,csTag,csServiceCode);
				PutField_CString(hContext,csTag,csServiceCode);
				//sprintf(csTag,"org_service_code_%d",i);
				//PutField_CString(hContext,csTag,csServiceCode);
DEBUGLOG(("GetDetailByPreApproveId::service_code= [%s]\n",csServiceCode));

				if(i==0){
					if(!GetField_Int(hContext,"check_first_txn",&iTmp)){
						/*DBObjPtr = CreateObj(DBPtr,"DBService","FindCountryByService");
						if ((unsigned long)(DBObjPtr)(csServiceCode,csTxnCountry) == FOUND) {
DEBUGLOG(("GetDetailByPreApproveId::txn_country= [%s]\n",csTxnCountry));
							PutField_CString(hRequest,"txn_country",csTxnCountry);
							PutField_CString(hContext,"txn_country",csTxnCountry);
							//sprintf(csTag,"org_txn_country_%d",i);
							PutField_CString(hContext,"first_txn_country",csTxnCountry);
						}
						*/
						DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","ChkRuleExists");
						if ((unsigned long)(DBObjPtr)(csMerchantId,csServiceCode) == PD_FOUND) {
	
							DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","FindPsp");
							if ((unsigned long)(DBObjPtr)(csMerchantId,csServiceCode,csPspTmp) == PD_FOUND) {
								PutField_CString(hContext,"first_txn_psp",csPspTmp);
								iOnlineMode = PD_TRUE;
							}
						}
						PutField_Int(hContext,"check_first_txn",PD_TRUE);
						PutField_Int(hContext,"first_txn_mode",iOnlineMode);
					}
					else{
						//GetField_CString(hContext,"first_txn_country",&csTxnCountry);
						GetField_CString(hContext,"first_txn_psp",&csPspTmp);
						GetField_Int(hContext,"first_txn_mode",&iOnlineMode);
					}
				}
				//sprintf(csTag,"txn_country_%d",i);
				//PutField_CString(hRequest,csTag,csTxnCountry);
				//PutField_CString(hContext,csTag,csTxnCountry);

				if(iOnlineMode==PD_TRUE){
					sprintf(csTag,"batch_mode_%d",i);
					PutField_Char(hRequest,csTag,PD_ONLINE);

					sprintf(csTag,"pregen_psp_id_%d",i);
					PutField_CString(hRequest,csTag,csPspTmp);
					FREE_ME(csPspTmp);
				}
				else{
					sprintf(csTag,"batch_mode_%d",i);
					PutField_Char(hRequest,csTag,PD_OFFLINE);
				}
			}
			else{
				iRet = INT_SERVICE_CODE_MISSING;
				PutField_Int(hContext,"internal_error",iRet);
				break;
DEBUGLOG(("GetDetailByPreApproveId::service_code not found\n"));
			}
			if (GetField_CString(hRec,"merchant_ref",&csTmp)) {
				sprintf(csTag,"merchant_ref_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}

			if(GetField_Int(hRec,"seq_num",&iSeqNum)){
				sprintf(csTag,"seq_num_%d",i);
				PutField_Int(hRequest,csTag,iSeqNum);
				PutField_Int(hContext,"last_seq",iSeqNum);
DEBUGLOG(("GetDetailByPreApproveId::seq_num= [%i]\n",iSeqNum));
			}
			if (!GetField_CString(hRec,"txn_country",&csTmp)) {
				sprintf(csTag,"txn_country_%d",i);
				PutField_CString(hRequest,csTag,csTxnCountry);
				PutField_CString(hContext,csTag,csTxnCountry);
			}
			if (GetField_CString(hRec,"payout_ccy",&csTmp)){
				if(strcmp(csTmp,"RMB"))
					csTxnCcy = strdup(csTmp);
				else
					csTxnCcy = strdup(PD_CCY_ISO_CNY);

				sprintf(csTag,"dst_txn_ccy_%d",i);
				PutField_CString(hRequest,csTag,csTxnCcy);
				//sprintf(csTag,"txn_ccy_%d",i);
				//PutField_CString(hRequest,csTag,csTxnCcy);
				//PutField_CString(hContext,csTag,csTxnCcy);
				//sprintf(csTag,"org_txn_ccy_%d",i);
				//PutField_CString(hContext,csTag,csTxnCcy);
DEBUGLOG(("GetDetailByPreApproveId::payout_ccy= [%s]\n",csTmp));
				FREE_ME(csTxnCcy);
			}

			if(GetField_CString(hRec,"request_ccy",&csTmp)){
				if(strcmp(csTmp,"RMB"))
					csTxnCcy = strdup(csTmp);
				else
					csTxnCcy = strdup(PD_CCY_ISO_CNY);

				sprintf(csTag,"txn_ccy_%d",i);
				PutField_CString(hRequest,csTag,csTxnCcy);
				PutField_CString(hContext,csTag,csTxnCcy);
				PutField_CString(hRequest,"txn_ccy",csTxnCcy);
				PutField_CString(hContext,"txn_ccy",csTxnCcy);
				//PutField_CString(hContext,"txn_ccy",csTxnCcy);
				//sprintf(csTag,"org_txn_ccy_%d",i);
				//PutField_CString(hContext,csTag,csTxnCcy);
DEBUGLOG(("GetDetailByPreApproveId::request_ccy= [%s]\n",csTxnCcy));
				FREE_ME(csTxnCcy);
			}
			if (GetField_Double(hRec,"request_amount",&dTmp)) {
				sprintf(csTag,"txn_amt_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
				dTotalAmt += dTmp;
				PutField_Double(hContext,"total_net_amt",dTotalAmt);
DEBUGLOG(("GetDetailByPreApproveId::request_amount= [%lf]\n",dTmp));
			}
			if (GetField_Double(hRec,"payout_amount",&dTmp)) {
				sprintf(csTag,"payout_amount_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetDetailByPreApproveId::payout_amount= [%lf]\n",dTmp));
			}
			if (GetField_Double(hRec,"merchant_fee",&dTmp)) {
				sprintf(csTag,"org_merchant_fee_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetDetailByPreApproveId::merchant_fee= [%lf]\n",dTmp));
			}
			if (GetField_CString(hRec,"bank_name",&csTmp)){
				sprintf(csTag,"bank_name_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
				PutField_CString(hRequest,"bank_name",csTmp);
DEBUGLOG(("GetDetailByPreApproveId::bank_name= [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"bank_code",&csTmp)){
				sprintf(csTag,"bank_code_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetDetailByPreApproveId::bank_code= [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"branch",&csTmp)){
				sprintf(csTag,"branch_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}
			if (GetField_CString(hRec,"account_num",&csTmp)){
				sprintf(csTag,"account_id_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}
			if (GetField_CString(hRec,"account_name",&csTmp)){
				sprintf(csTag,"account_name_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}
			if(GetField_Int(hRec,"status",&iTmp)){
				sprintf(csTag,"status_%d",i);
				PutField_Int(hRequest,csTag,iTmp);
DEBUGLOG(("GetDetailByPreApproveId::status= [%i]\n",iTmp));
			}
			if (GetField_CString(hRec,"batch_id",&csTmp)){
				sprintf(csTag,"batch_id_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
				PutField_CString(hContext,"batch_id",csTmp);
			}

			hRec = RecordSet_GetNext(rRecordSet);
			i++;
			PutField_Int(hContext,"total_cnt",i);
		}
	}
	else{
DEBUGLOG(("GetDetailByPreApproveId:: no record found\n"));
ERRLOG("BOPayout::GetPreApproveRecord::GetDetailByPreApproveId::no record found!!\n");
		iRet=INT_NOT_RECORD;
		PutField_Int(hContext,"internal_error",iRet);
	}

	FREE_ME(csPspTmp);
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	return	iRet;
}






int     checkNationalID(const char* csID)
{
	int iRet = PD_OK;
	int iPos = 0;
	int iSex = 0;
	int iTotalSum = 0;
	int i;
	int iPow = 0;
	int iCheck= 0;

//check 2-10 digits, numeric
	if(iRet == PD_OK){
		if(is_numeric((char*)&csID[1])!=PD_TRUE)
			iRet = INT_ERR;
	}

//check 2nd digit, MALE or FEMALE
	if(iRet == PD_OK){
		iSex = atoi(&csID[1])/pow(10,8);
		if(!((iSex==PD_TW_MALE) || (iSex==PD_TW_FEMALE)))
			iRet = INT_ERR;
	}

//check digit
	if(iRet == PD_OK){
		for(iPos=0; iPos<26; iPos++){
			if(csID[0] == csCharSet[iPos])
				iTotalSum += atoi(csAddSet[iPos]);
		}

		for(i=8;i>0;i--){
			iPow= pow(10,i);
			iTotalSum += (atoi(&csID[PD_TW_IDENTITY_ID_LEN-1-i])/iPow)*i;
		}

		iCheck = (10-(iTotalSum%10))%10;
		if(atoi(&csID[9])!= iCheck)
			iRet = INT_ERR;
	}

	return iRet;
}


int     checkAlienID(const char* csID)
{
	int iRet = PD_OK;
	int iPos = 0;
	int iTotalSum = 0;
	int iCheck = 0;
	char csTmp[3];
	int iTmp;
	int i;

//check 3-10 digits, numeric
	if(is_numeric((char*)&csID[2])!=PD_TRUE)
		iRet = INT_ERR;

//check digit
	if(iRet == PD_OK){
		for(iPos=0;iPos<26;iPos++){
			if(csID[0] == csCharSet[iPos]){
				iTmp = atoi(&csIntSet[iPos][1])*9;
				sprintf(csTmp,"%d",iTmp);
				iTotalSum += atoi(csIntSet[iPos])/10 + atoi(&csTmp[1]);
			}
			if(csID[1] == csCharSet[iPos]){
				iTmp = atoi(&csIntSet[iPos][1])*8;
				sprintf(csTmp,"%d",iTmp);
				if(iTmp>9) iTotalSum += atoi(&csTmp[1]);
				else   iTotalSum += atoi(csTmp);
			}
		}

		for(i=7;i>0;i--){
			int iPow = pow(10,i);
			iTmp = (atoi(&csID[PD_TW_IDENTITY_ID_LEN-1-i])/iPow)*i;
			sprintf(csTmp,"%d",iTmp);
			if(iTmp>9) iTotalSum += atoi(&csTmp[1]);
			else iTotalSum += atoi(csTmp);

		}

		sprintf(csTmp,"%d",iTotalSum);
		if(iTotalSum>9) iCheck = 10 - atoi(&csTmp[1]);
		else    iCheck = 10 - atoi(csTmp);
		if(iCheck != atoi(&csID[PD_TW_IDENTITY_ID_LEN-1]))
			iRet = INT_ERR;
	}

        return iRet;
}

int     verifyIdentityId(const char* csID)
{
	int iRet = PD_OK;
	char cSecDigit;

//check ID length (10 digits)
	if(strlen(csID)!=PD_TW_IDENTITY_ID_LEN)
		iRet = INT_ERR;

//check 1st digit, between A-Z
	if(iRet == PD_OK){
		if(!isalpha(csID[0]))
			iRet = INT_ERR;
	}

//check 2nd digit, numeric ->NationalID; alphabet-> AlienID
	if(iRet == PD_OK){
		cSecDigit = csID[1];
		if(!isalpha(cSecDigit))
			iRet = checkNationalID(csID);
		else
			iRet = checkAlienID(csID);
	}
	return iRet;
}



int	Verify_header(char (*csList)[IMPORT_FIELD_LEN], hash_t *hTxn)
{
	int	iRet = PD_OK;
	char    csBuf[PD_MAX_BUFFER +1];
	char	*csMerchantId;
	char	*csServiceCode;
	int	iCount = 0;
	int	i = 0;

	GetField_Int(hTxn,"header_field",&iCount);
	for(i=0; i<iCount; i++){
DEBUGLOG(("Verify_header: [%s]\n",csList[i]));
		if(!strlen(csList[i])){
			iRet = INT_INVALID_FILE_FORMAT;
DEBUGLOG(("Verify_header: Header Field Missing!!!\n"));
		}
	}

	if(GetField_CString(hTxn,"merchant_id",&csMerchantId)){
DEBUGLOG(("Verify_header: input merchant_id[%s]\n",csMerchantId));

		if(strcmp(csMerchantId,csList[IDX_HEADER_MERCHANT_ID])){
DEBUGLOG(("Verify_header: merchant_id not match [%s]!=[%s]\n",csMerchantId,csList[IDX_HEADER_MERCHANT_ID]));
			iRet = INT_MERCHANT_ID_MISMATCH;
		}
	}
	
	if(GetField_CString(hTxn,"service_code",&csServiceCode)){
DEBUGLOG(("Verify_header: input service_code[%s]\n",csServiceCode));
		
		if(strcmp(csServiceCode,csList[IDX_HEADER_SERVICE_CODE])){
DEBUGLOG(("Verify_header: service_code not match [%s]!=[%s]\n",csServiceCode,csList[IDX_HEADER_SERVICE_CODE]));
			iRet = INT_SERVICE_MISMATCH;
		}
	}

        if (iRet == PD_OK)  {
                sprintf(csBuf,"%s",csList[IDX_HEADER_MERCHANT_ID]);
DEBUGLOG(("Verify_header: call BOSecurity:VerifyMD5Mac\n"));
		BOObjPtr = CreateObj(BOPtr,"BOSecurity","VerifyMD5Mac");
		iRet = (unsigned long int)(*BOObjPtr)(csList[IDX_HEADER_MAC],csList[IDX_HEADER_NUMOFREC],csBuf,strlen(csBuf));
                if(iRet != PD_OK){
			iRet = INT_CHECKSUM_ERROR;
DEBUGLOG(("Verify_header: Invalid Mac[%s]\n",csList[IDX_HEADER_MAC]));
		}
	}

DEBUGLOG(("Verify_header:: iRet = [%d]\n",iRet));
	return iRet;	
}

int	Verify_detail(char (*csList)[IMPORT_FIELD_LEN], hash_t *hTxn)
{

	int	iRet = PD_OK;
	char	csBuf[PD_MAX_BUFFER +1];
	char	csTag[PD_TAG_LEN+1];
	char	csErrMsg[PD_MAX_BUFFER+1];
	int	iRecord = 0;
	char	*csCountry;
	char	*csCcy;
	char	*csMerchantId;
	int	i = 0;
	int	iCount = 0;

	if(GetField_CString(hTxn,"merchant_id",&csMerchantId)){
DEBUGLOG(("Verify_detail:: merchant_id = [%s]\n",csMerchantId));
	}
	if(GetField_Int(hTxn,"detail_count",&iRecord)){
DEBUGLOG(("Verify_detail:: record = [%d]\n",iRecord));
	}
	sprintf(csTag,"%d_err_msg",iRecord);	


	GetField_Int(hTxn,"detail_field",&iCount);
	for(i=0; i<iCount; i++){
		if(strlen(csList[i])>iFieldLength[i]){
			sprintf(csErrMsg,"104 : Field format error(%s is too long(maximum is %d charaters))",csField[i],iFieldLength[i]);
			PutField_CString(hTxn,csTag,csErrMsg);
			iRet = INT_FORMAT_ERR;
DEBUGLOG(("Verify_detail: Detail Field too log [%s][%s]!!!\n",csField[i],csList[i]));
		}

		if((!(i==IDX_DETAIL_ID || i==IDX_DETAIL_BANK_CODE || i==IDX_DETAIL_PHONE_NO || i==IDX_DETAIL_PROVINCE || i==IDX_DETAIL_CITY)
		   || ((i==IDX_DETAIL_ID || i==IDX_DETAIL_BANK_CODE) && !strcmp(csList[IDX_DETAIL_COUNTRY],"TW"))
		   || ((i==IDX_DETAIL_PROVINCE || i==IDX_DETAIL_CITY) && !strcmp(csList[IDX_DETAIL_COUNTRY],"CN")))
		   && (!strlen(csList[i]))){
			PutField_CString(hTxn,csTag,"104 : Field format error");
			iRet = INT_FORMAT_ERR;
DEBUGLOG(("Verify_detail: Detail Field[%d] Missing!!!\n",i));
		}
	}

//check country
	if(GetField_CString(hTxn,"txn_country",&csCountry)){
		if(strcmp(csCountry,csList[IDX_DETAIL_COUNTRY])){
			PutField_CString(hTxn,csTag,"Country Mis-Match");
			iRet = INT_RECORD_MISMATCH;
DEBUGLOG(("Verify_detail: country mismatch[%s]!=[%s]\n",csCountry,csList[IDX_DETAIL_COUNTRY]));
		}
	}

//check currency
	if(GetField_CString(hTxn,"txn_ccy",&csCcy)){
		if(strcmp(csCcy,csList[IDX_DETAIL_PAYOUT_CCY])){
			PutField_CString(hTxn,csTag,"Currency Mis-Match");
			iRet = INT_RECORD_MISMATCH;
DEBUGLOG(("Verify_detail: currency mismatch[%s]!=[%s]\n",csCcy,csList[IDX_DETAIL_PAYOUT_CCY]));
		}
	}

//check ID no.
	if(iRet==PD_OK){
		if(strncmp(csList[IDX_DETAIL_COUNTRY],"TW",2)==0){
			iRet = verifyIdentityId(csList[IDX_DETAIL_ID]);
			if(iRet != PD_OK){
				PutField_CString(hTxn,csTag,"104 : Field format error (Invalid identity no.)");
				iRet = INT_FORMAT_ERR;
DEBUGLOG(("Verify_detail: Invalid Id[%s]\n",csList[IDX_DETAIL_ID]));
			}
                }
	}

//check amount, no decimal value
        if(iRet == PD_OK){
		double dAmt = myctod((const unsigned char *)csList[IDX_DETAIL_AMOUNT],strlen(csList[IDX_DETAIL_AMOUNT])-PD_DECIMAL_LEN,PD_DECIMAL_LEN);
		if(dAmt<=0.0){
			PutField_CString(hTxn,csTag,"104 : Field format error");
			iRet = INT_UNSUPPORTED_PAY_AMOUNT;
DEBUGLOG(("Verify_detail: Unspported pay amount[%f]\n",dAmt));
		}

		if((dAmt>0.0) && (strncmp(csList[IDX_DETAIL_COUNTRY],"TW",2)==0)){
			long lTmp = (long) dAmt;
			if (dAmt > lTmp){
				PutField_CString(hTxn,csTag,"104 : Field format error");
				iRet = INT_UNSUPPORTED_PAY_AMOUNT;
DEBUGLOG(("Verify_detail: Unspported pay amount[%f], country:[%s]\n",dAmt,csList[IDX_DETAIL_COUNTRY]));
			}
		}
	}

//check mac
	if(iRet==PD_OK){
		sprintf(csBuf,"%s%s%s",csList[IDX_DETAIL_SEQ_NUM],csList[IDX_DETAIL_MERCHANT_REF],csList[IDX_DETAIL_ID]);
DEBUGLOG(("Verify_detail: call BOSecurity:VerifyMD5Mac\n"));
		BOObjPtr = CreateObj(BOPtr,"BOSecurity","VerifyMD5Mac");
		iRet = (unsigned long int)(*BOObjPtr)(csList[IDX_DETAIL_MAC],csList[IDX_DETAIL_AMOUNT],csBuf,strlen(csBuf));
		if(iRet != PD_OK){	
			PutField_CString(hTxn,csTag,"104 : Checksum error");
			iRet = INT_CHECKSUM_ERROR;
DEBUGLOG(("Verify_detail: Invalid Mac[%s]\n",csList[IDX_DETAIL_MAC]));
		}
	}

//check duplicate
	if(iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","MatchUploadTxn");
		PutField_CString(hTxn,"merchant_ref",csList[IDX_DETAIL_MERCHANT_REF]);
		if ((unsigned long int)(*DBObjPtr)(hTxn) == PD_FOUND) {
			PutField_CString(hTxn,csTag,"106 : Duplicate Record(s)");
			iRet = INT_DUP_MERCHANT_REF;
DEBUGLOG(("Verify_detail: Duplicate Transaction[%s][%s]\n",csMerchantId,csList[IDX_DETAIL_MERCHANT_REF]));
		}
	}

DEBUGLOG(("Verify_detail:: iRet = [%d]\n",iRet));
	return iRet;	
}


int	ProcessPayoutRecords(FILE *fin, hash_t *hContext, hash_t *hRequest, hash_t *hTxn)
{
	int	iRet = INT_ERR;
	char    csList[DETAIL_FIELD_CNT][IMPORT_FIELD_LEN];
        char    cs_input_buf[PD_MAX_BUFFER +1];
        char    csTag[PD_TAG_LEN+1];
        char	*p;
        char	*csTmp;
        char	csBatchId[PD_TXN_SEQ_LEN+1];
	int     iCount = 0;
	int     iTotalCnt = 0;
	int     iRecord = 0;
	int     iFailCnt = 0;
	double	dAmt = 0.0;
	double	dTotalAmt = 0.0;
	double	dAvalPayoutBal = 0.0;
	double	dActualPayoutBal = 0.0;
	double	dMerchRemainAvaPO = 0.0;
	char	csErrString[PD_REMARK_LEN];

DEBUGLOG(("ProcessPayoutRecords: parse_file\n"));
	/* Header */
	iCount = 0;
	fgets(cs_input_buf,PD_MAX_BUFFER,fin);
	if ((cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A) || (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0D))
		cs_input_buf[strlen(cs_input_buf) - 1] = '\0';

	strcpy(cs_input_buf,TrimAllChar((const unsigned char*)cs_input_buf,strlen(cs_input_buf),0xEF));
	strcpy(cs_input_buf,TrimAllChar((const unsigned char*)cs_input_buf,strlen(cs_input_buf),0xBB));
	strcpy(cs_input_buf,TrimAllChar((const unsigned char*)cs_input_buf,strlen(cs_input_buf),0xBF));

	p = mystrtok(cs_input_buf,",");
	if (p == NULL){
DEBUGLOG(("ProcessPayoutRecords: parse_file error [%s]\n",cs_input_buf));
		iRet = INT_INVALID_FILE_FORMAT;
		PutField_Int(hContext,"internal_error",iRet);
		return iRet;
	}

	if(p[strlen(p) - 1] == 0x0D)
		p[strlen(p) - 1] = '\0';
	strcpy(csList[iCount],p);
	sprintf(csTag,"header_%d",iCount);
	PutField_CString(hTxn,csTag,p);
	iCount++;

	while ( (p = mystrtok(NULL,",")) != NULL) {
		if(p[strlen(p) - 1] == 0x0D)
			p[strlen(p) - 1] = '\0';
		strcpy(csList[iCount],p);
		sprintf(csTag,"header_%d",iCount);
		PutField_CString(hTxn,csTag,p);
		iCount++;
	}
	PutField_Int(hTxn,"header_field",iCount);

	if(iCount){
		if(iCount==HEADER_FIELD_CNT){
			iRet = Verify_header(csList,hTxn);
		}
		else{
			iRet = INT_INVALID_FILE_FORMAT;
		}
		if (iRet == PD_OK){
			/* Insert to header table */
DEBUGLOG(("ProcessPayoutRecords::DBMerchantUploadFileHeader:GenBatchId\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","GenBatchId");
			if((unsigned long) ((*DBObjPtr)(&csBatchId))!=PD_OK){
				iRet = INT_ERR;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessPayoutRecords::DBMerchantUploadFileHeader:GenBatchId Failed\n"));
ERRLOG("BOPayout:ProcessPayoutRecords::DBMerchantUploadFileHeader:GenBatchId Failed\n");
			}
			else{
				PutField_CString(hTxn,"batch_id",csBatchId);
				PutField_Int(hTxn,"txn_count",0);
				PutField_Double(hTxn,"txn_amt",0.0);
				PutField_Int(hTxn,"status",PD_PAYOUTFILE_PROCESSING);
DEBUGLOG(("ProcessPayoutRecords::DBMerchantUploadFileHeader:Add BatchId[%s]\n",csBatchId));
				DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","Add");
				if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessPayoutRecords::DBMerchantUploadFileHeader:Add Failed\n"));
ERRLOG("BOPayout:ProcessPayoutRecords::DBMerchantUploadFileHeader:Add Failed\n");
				}
			}
			
		}
		else{
			PutField_Int(hContext,"internal_error",iRet);
		}
	}
	if(iRet == PD_OK){
		/*Detail*/
		int	iChkDtl;
		char	csInputString[PD_MAX_BUFFER+1];
		while( fgets(cs_input_buf, PD_MAX_BUFFER, fin) != NULL ){
			if ((cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A) || (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0D))
				cs_input_buf[strlen(cs_input_buf) - 1] = '\0';

			if(cs_input_buf[strlen(cs_input_buf) - 1] == 0x00)
				continue;

			sprintf(csInputString,"%s",cs_input_buf);
			if(csInputString[strlen(csInputString)-1]==0x0D)
				csInputString[strlen(csInputString)-1] = '\0';
			iChkDtl = INT_NO_ERR;
			iCount = 0;

			p = mystrtok(cs_input_buf,",");
			if (p == NULL) {
DEBUGLOG(("ProcessPayoutRecords: parse_file error [%s]\n",cs_input_buf));
				iChkDtl = INT_INVALID_FILE_FORMAT;
			}
			iRecord++;
			sprintf(csTag,"%d_error",iRecord);
			PutField_Int(hTxn,csTag,iRet);
			if(iChkDtl!=PD_OK){
				sprintf(csTag,"%d_err_msg",iRecord);	
				PutField_CString(hTxn,csTag,"Invalid file format");
			}	
			else{
				if(p[strlen(p) - 1] == 0x0D)
					p[strlen(p) - 1] = '\0';
				strcpy(csList[iCount],p);
				sprintf(csTag,"%s",csFieldTag[iCount]);
				if(is_numeric(p)){
					PutField_Int(hTxn,csTag,atoi(p));
					iCount++;
				}
				else{
					iChkDtl = INT_INVALID_FILE_FORMAT;
					sprintf(csTag,"%d_error",iRecord);
					PutField_Int(hTxn,csTag,iChkDtl);
					sprintf(csTag,"%d_err_msg",iRecord);
					PutField_CString(hTxn,csTag,"104 : Field format error");
				}

				if(iChkDtl==PD_OK){
					while ( (p = mystrtok(NULL,",")) != NULL) {
						if(p[strlen(p) - 1] == 0x0D)
							p[strlen(p) - 1] = '\0';
						strcpy(csList[iCount],p);
						sprintf(csTag,"%s",csFieldTag[iCount]);
						if(iCount==IDX_DETAIL_AMOUNT){
							if(is_numeric(p)){
								dAmt = myctod((const unsigned char *)p,strlen(p)-PD_DECIMAL_LEN,PD_DECIMAL_LEN);
								PutField_Double(hTxn,csTag,dAmt);
							}
							else{
								iChkDtl = INT_INVALID_FILE_FORMAT;
								sprintf(csTag,"%d_error",iRecord);
								PutField_Int(hTxn,csTag,iChkDtl);
								sprintf(csTag,"%d_err_msg",iRecord);
								PutField_CString(hTxn,csTag,"104 : Field format error");
							}
						}
						else{
							if(strlen(p))
								PutField_CString(hTxn,csTag,p);
						}
						iCount++;
					}

				}
				if(iChkDtl == PD_OK){
					PutField_Int(hTxn,"detail_count",iRecord);
					PutField_Int(hTxn,"detail_field",iCount);
					if(iCount){
						if(iCount==DETAIL_FIELD_CNT){
							iChkDtl = Verify_detail(csList,hTxn);
						}
						else{
							iChkDtl = INT_INVALID_FILE_FORMAT;
							sprintf(csTag,"%d_err_msg",iRecord);	
							PutField_CString(hTxn,csTag,"Invalid file format");
						}
						if(iChkDtl == PD_OK){
							sprintf(csTag,"%d_error",iRecord);
							PutField_Int(hTxn,csTag,INT_NO_ERR);
						}
						else{
							sprintf(csTag,"%d_error",iRecord);
							PutField_Int(hTxn,csTag,iChkDtl);
						}
					}
				}
			}
			if(iChkDtl==PD_OK){
				//insert to detail table
				PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_UPLOADED);
				DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","Add");
				if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
DEBUGLOG(("ProcessPayoutRecords::DBMerchantUploadFileDetail:Add Failed [%s]\n",cs_input_buf));
ERRLOG("BOPayout:ProcessPayoutRecords::DBMerchantUploadFileDetail:Add Failed [%s]\n",cs_input_buf);
				}
				else{
					iTotalCnt ++;
					PutField_Int(hTxn,"total_txn_cnt",iTotalCnt);

					dTotalAmt += dAmt;
					PutField_Double(hTxn,"total_txn_amt",dTotalAmt);
					TxnCommit();
				}
			}
			else{
				//insert to error table
				sprintf(csTag,"%d_err_msg",iRecord);
				if(GetField_CString(hTxn,csTag,&csTmp)){
					sprintf(csErrString,"%s,%s",csInputString,csTmp);
					csErrString[PD_REMARK_LEN] = '\0';
DEBUGLOG(("ProcessPayoutRecords::DBMerchantUploadError:Add [%s]\n",csErrString));

					PutField_CString(hTxn,"record",csErrString);
					DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadError","Add");
					if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
DEBUGLOG(("ProcessPayoutRecords::DBMerchantUploadError:Add Failed [%s]\n",csErrString));
ERRLOG("BOPayout:ProcessPayoutRecords::DBMerchantUploadError:Add Failed [%s]\n",csErrString);
					}
					else{
						iFailCnt ++;
						PutField_Int(hTxn,"total_fail_cnt",iFailCnt);
						TxnCommit();
					}

				}
			}
		}
		PutField_Int(hTxn,"detail_count",iRecord);

		if(dTotalAmt>0.0){
			//compare with the available payout
DEBUGLOG(("ProcessPayoutRecords::Call BOOLBalance:GetAvalPayoutBalance\n"));
			BOObjPtr = CreateObj(BOPtr,"BOOLBalance","GetAvalPayoutBalance");
			if((unsigned long)(*BOObjPtr)(hTxn,
							hTxn,
							&dActualPayoutBal,
							&dAvalPayoutBal)==PD_OK){
				if (GetField_Double(hTxn, "merchant_remain_aval_po",&dMerchRemainAvaPO)) {
DEBUGLOG(("ProcessPayoutRecords::GetAvalBalance for payout=[%f]\n",dMerchRemainAvaPO));
				}
				if(dMerchRemainAvaPO<0.0){
					iRet=INT_INSUFFICIENT_FUND;
DEBUGLOG(("ProcessPayoutRecords::Aval Payout Amt[%f] < Total Request Amt[%f]\n",dMerchRemainAvaPO+dTotalAmt,dTotalAmt));
ERRLOG("BOOLPayout::CheckAvalBalance::insufficient aval payout balance!!\n");
				}
			}
			else{
DEBUGLOG(("ProcessPayoutRecords::GetAvalPayoutBalance Error\n"));
ERRLOG("BOOLPayout::ProcessPayoutRecords::GetAvalPayoutBalance Error!!\n");
				iRet = INT_ERR;
			}

			if(iRet == PD_OK){
				//update count and amount to header table
				if(iTotalCnt>0){
					PutField_Int(hTxn,"status",PD_PAYOUTFILE_UPLOADED);
					DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","UpdateHeader");
					if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
						iRet = INT_ERR;
						PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessPayoutRecords::DBMerchantUploadFileHeader:Add Failed\n"));
ERRLOG("BOPayout:ProcessPayoutRecords::DBMerchantUploadFileHeader:Add Failed\n");
					}
				}
			}
			else{
				PutField_Int(hContext,"internal_error",iRet);
				//delete the record added
				DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","Delete");
				if((unsigned long) ((*DBObjPtr)(csBatchId))!=PD_OK){
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessPayoutRecords::DBMerchantUploadFileDetail:Delete Failed\n"));
ERRLOG("BOPayout:ProcessPayoutRecords::DBMerchantUploadFileDetail:Delete Failed\n");
				}

				DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","Delete");
				if((unsigned long) ((*DBObjPtr)(csBatchId))!=PD_OK){
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessPayoutRecords::DBMerchantUploadFileHeader:Delete Failed\n"));
ERRLOG("BOPayout:ProcessPayoutRecords::DBMerchantUploadFileHeader:Delete Failed\n");
				}

				DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadError","Delete");
				if ((unsigned long)(*DBObjPtr)(csBatchId) != PD_OK) {
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessPayoutRecords::DBMerchantUploadError:Delete Failed [%s]\n"));
ERRLOG("BOPayout:ProcessPayoutRecords::DBMerchantUploadError:Delete Failed [%s]\n");
				}
			}
			//}
		}
		if(iRecord==iFailCnt){
			PutField_Int(hTxn,"status",PD_PAYOUTFILE_UPD_FAIL);
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","UpdateHeader");
			if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
				iRet = INT_ERR;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessPayoutRecords::DBMerchantUploadFileHeader:Add Failed\n"));
ERRLOG("BOPayout:ProcessPayoutRecords::DBMerchantUploadFileHeader:Add Failed\n");
			}
		}


	}

DEBUGLOG(("ProcessPayoutRecords: iRet = [%d]\n",iRet));
	return iRet;
}
