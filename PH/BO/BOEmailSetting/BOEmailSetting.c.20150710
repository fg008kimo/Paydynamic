/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/12/08              Elvis Wong
Change INT_EML_EMAIL_ADDR_NOT_FOUND
to INT_EML_EMAIL_ADDR_NOT_REG			   2015/06/10		   Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOEmailSetting.h"

#define	PD_EML_EMAIL_ID_DEFAULT 			0
#define	PD_EML_EMAIL_HISTORY_LOQ_SEQ_START 		1

char    cDebug;
OBJPTR(DB);
OBJPTR(BO);

void BOEmailSetting(char cdebug)
{
        cDebug = cdebug;
}

int SetEmailNotifyList(hash_t *hRls)
{
	int	iRet = PD_OK;
	int	iDtlRet = NOT_FOUND;

	int     iEmailId = 0;

DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord()\n"));
	DBObjPtr = CreateObj(DBPtr, "DBEmailNotifyList", "CheckEmailAddressRecord");
       	iDtlRet = (unsigned long)(*DBObjPtr)(hRls);
       	if (iDtlRet == FOUND) {
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord() email_addr found!!!\n"));

/* mail_id */
       		if (GetField_Int(hRls, "mail_id", &iEmailId)) {
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord() mail_id = [%d]\n", iEmailId));
       		}

     	} else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord() email_addr not found!!!\n"));

DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::GetLatestEmailId()\n"));	
		DBObjPtr = CreateObj(DBPtr, "DBEmailNotifyList", "GetLatestEmailId");
                iDtlRet = (unsigned long)(*DBObjPtr)(hRls);
                if ((iDtlRet == FOUND) || (iDtlRet == NOT_FOUND)) {
/* mail_id */
               		if (GetField_Int(hRls, "mail_id", &iEmailId)) {
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::GetLatestEmailId() mail_id = [%d]\n", iEmailId));
                      	}
					
            	} else {
                   	iRet = INT_ERR;
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::GetLatestEmailId() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ValidateProcess::Add::failed!!\n");
           	}

		if (iRet == PD_OK) {
/* mail_id */
             		iEmailId++;
                       	PutField_Int(hRls,"mail_id",iEmailId);
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::Add() mail_id = [%d]\n", iEmailId));

DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::Add()\n"));
                      	DBObjPtr = CreateObj(DBPtr, "DBEmailNotifyList", "Add");
                       	iRet = (unsigned long)(*DBObjPtr)(hRls);
                      	if (iRet != PD_OK) {
                        	iRet = INT_ERR;
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::Add() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ValidateProcess::Add::failed!!\n");
                      	}
              	}
 	} else {
		iRet = INT_ERR;
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ValidateProcess::CheckEmailAddressRecord::failed!!\n");
	}	

	return iRet;
}

int SetDefaultEmailNotifyList(hash_t *hRls)
{
	int     iRet = PD_OK;
	int	iDtlRet = NOT_FOUND;

        int     iEmailId = 0;

/* mail_id */
	iEmailId = PD_EML_EMAIL_ID_DEFAULT;
        PutField_Int(hRls,"mail_id",iEmailId);
DEBUGLOG(("SetDefaultEmailNotifyList() mail_id = [%d]\n", iEmailId));

DEBUGLOG(("SetDefaultEmailNotifyList() call DBEmailNotifyList::CheckEmailIdRecord()\n"));
        DBObjPtr = CreateObj(DBPtr, "DBEmailNotifyList", "CheckEmailIdRecord");
        iDtlRet = (unsigned long)(*DBObjPtr)(hRls);
        if (iDtlRet == FOUND) {
DEBUGLOG(("SetDefaultEmailNotifyList() call DBEmailNotifyList::CheckEmailIdRecord() email_id found!!!\n"));
        } else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("SetDefaultEmailNotifyList() call DBEmailNotifyList::CheckEmailIdRecord() email_id not found!!!\n"));

DEBUGLOG(("SetDefaultEmailNotifyList() call DBEmailNotifyList::Add()\n"));
              	DBObjPtr = CreateObj(DBPtr, "DBEmailNotifyList", "Add");
               	iRet = (unsigned long)(*DBObjPtr)(hRls);
               	if (iRet != PD_OK) {
                 	iRet = INT_ERR;
DEBUGLOG(("SetDefaultEmailNotifyList() call DBEmailNotifyList::Add() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ValidateProcess::Add::failed!!\n");
               	}
	} else {
                iRet = INT_ERR;
DEBUGLOG(("SetDefaultEmailNotifyList() call DBEmailNotifyList::CheckEmailIdRecord() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ValidateProcess::CheckEmailIdRecord::failed!!\n");
        }

        return iRet;
}

int SetEmailSetting(hash_t *hRls)
{
	int 	iRet = PD_OK;
	int	iDtlRet = NOT_FOUND;

	int	iDisabled = 0;

/* disabled */
        iDisabled = 0;
      	PutField_Int(hRls,"disabled",iDisabled);
DEBUGLOG(("SetEmailSetting() disabled = [%d]\n", iDisabled));

DEBUGLOG(("SetEmailSetting() call DBEmailSetting::CheckEmailSettingRecord()!!!\n"));
	DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "CheckEmailSettingRecord");
        iDtlRet = (unsigned long)(*DBObjPtr)(hRls);
       	if (iDtlRet == FOUND) {
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::CheckEmailSettingRecord() email_id found!!!\n"));	

DEBUGLOG(("SetEmailSetting() call DBEmailSetting::Update()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "Update");
              	iRet = (unsigned long)(*DBObjPtr)(hRls);
                if (iRet != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::Update() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ValidateProcess::Update::failed!!\n");
               	}						
	} else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::CheckEmailSettingRecord() email_id not found!!!\n"));

DEBUGLOG(("SetEmailSetting() call DBEmailSetting::Add()\n"));
              	DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "Add");
               	iRet = (unsigned long)(*DBObjPtr)(hRls);
               	if (iRet != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::Add() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ValidateProcess::Add::failed!!\n");
              	}	
	} else {
		iRet = INT_ERR;
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::CheckEmailSettingRecord() Failed!!!\n"));
	}

	return iRet;
}

int AddOriginalEmailSetting(hash_t *hRls)
{
	int	iRet = PD_OK;
	
	int 	iDisabled = 0;

/* disabled */
	iDisabled = 0;
       	PutField_Int(hRls,"disabled",iDisabled);
DEBUGLOG(("AddOriginalEmailSetting() disabled = [%d]\n", iDisabled));

DEBUGLOG(("AddOriginalEmailSetting() call DBEmailSetting::AddOriginal()\n"));
        DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "AddOriginal");
        iRet = (unsigned long)(*DBObjPtr)(hRls);
     	if (iRet != PD_OK) {
          	iRet = INT_ERR;
DEBUGLOG(("AddOriginalEmailSetting() call DBEmailSetting::AddOriginal() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ValidateProcess::AddOriginal::failed!!\n");
       	}

	return iRet;
}

int ProcessTpl(hash_t* hContext,
                hash_t* hRequest,
                hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iDtlRet = NOT_FOUND;

	char 	cAction;	
	int     i = 0;
	int 	iTotalEmailNum = 0;
	int	iLogSeq = 0;

	char	*csTmp;
	
	char    csTag[PD_TAG_LEN + 1];

/* action */
        if (GetField_Char(hContext, "action", &cAction)) {
DEBUGLOG(("ProcessTpl() action = [%c]\n", cAction));
        } else {
                iRet = INT_ACTION_NOT_FOUND;
DEBUGLOG(("ProcessTpl() action NOT FOUND!!!\n"));
ERRLOG("BOEmailSetting:: ProcessTpl() action NOT FOUND!!!\n");
        }

/* total_email_num */
	if (GetField_Int(hContext, "total_email_num", &iTotalEmailNum)) {
DEBUGLOG(("ProcessTpl() total_email_num = [%d]\n", iTotalEmailNum));
        }

	if (iRet == PD_OK) {	

// GetEmailSettingHistoryLogSeq
DEBUGLOG(("ProcessTpl() call DBEmailSettingHistory::GetLatestLogSeq()\n"));
        	DBObjPtr = CreateObj(DBPtr, "DBEmailSettingHistory", "GetLatestLogSeq");
               	iDtlRet = (unsigned long)(*DBObjPtr)(hContext);
              	if (iDtlRet == FOUND) {
DEBUGLOG(("ProcessTpl() call DBEmailSettingHistory::GetLatestLogSeq() found!!!\n"));			

/* log_seq */
			if (GetField_Int(hContext, "log_seq", &iLogSeq)) {
				iLogSeq++;
				PutField_Int(hContext,"log_seq",iLogSeq);
DEBUGLOG(("ProcessTpl() call DBEmailSettingHistory:: log_seq = [%d]\n", iLogSeq));
			}

		} else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("ProcessTpl() call DBEmailSettingHistory::GetLatestLogSeq() not found!!!\n"));

DEBUGLOG(("ProcessTpl() call DBEmailSettingHostory::AddOriginalLog()\n"));
			
/* log_seq */
			iLogSeq = PD_EML_EMAIL_HISTORY_LOQ_SEQ_START;
                        PutField_Int(hContext,"log_seq",iLogSeq);
DEBUGLOG(("ProcessTpl() call DBEmailSettingHistory:: log_seq = [%d]\n", iLogSeq));		
	
		} else {
			iRet = INT_ERR;
DEBUGLOG(("ProcessTpl() call DBEmailSettingHistory::GetLatestLogSeq() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ValidateProcess::GetLatestLogSeq::failed!!\n");
		}		

// CheckAction
		if (iRet == PD_OK) {
			if (cAction == PD_ACTION_UPDATE) {
DEBUGLOG(("ProcessTpl() action = update\n"));

// CheckTotalEmailNumber
				if (iTotalEmailNum == 0) {		
					iRet = INT_EML_EMAIL_ADDR_NOT_REG;
DEBUGLOG(("ProcessTpl() total_email_num = 0\n"));
ERRLOG("BOEmailSetting::ValidateProcess::total_email_num = 0!!\n");			
				} else {
// DisableEmailSetting	
					DEBUGLOG(("ProcessTpl() call DBEmailSetting::DisableEmailSettingRecord()\n"));
                        		DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "DisableEmailSettingRecord");
                        		iDtlRet = (unsigned long)(*DBObjPtr)(hContext);
					if (iDtlRet == PD_FOUND) {
						for (i=0; i<iTotalEmailNum; i++) {
/* mail_addr */	
							sprintf(csTag, "email_addr_%d", i+1);	
							if (GetField_CString(hContext, csTag, &csTmp)) {				
DEBUGLOG(("ProcessTpl() [%s] = [%s]\n", csTag, csTmp));
								PutField_CString(hContext,"mail_addr",csTmp);
							} else {
         							iRet = INT_ERR;
DEBUGLOG(("ProcessTpl() email_addr_%d NOT FOUND!!!\n", i+1));
ERRLOG("BOEmailSetting:: ProcessTpl() email_addr NOT FOUND!!!\n");
        						}

// SetEmailNotifyList
							if (iRet == PD_OK) {
								iRet = SetEmailNotifyList(hContext);
							}
				
// SetEmailSetting
							if (iRet == PD_OK) {
								iRet = SetEmailSetting(hContext);
							}
						}
					} else if (iDtlRet == PD_NOT_FOUND) {
						for (i=0; i<iTotalEmailNum; i++) {
/* mail_addr */
							sprintf(csTag, "email_addr_%d", i+1);
                                			if (GetField_CString(hContext, csTag, &csTmp)) {
DEBUGLOG(("ProcessTpl() [%s] = [%s]\n", csTag, csTmp));
                                        			PutField_CString(hContext,"mail_addr",csTmp);
                                			} else {
                                       				iRet = INT_ERR;
DEBUGLOG(("ProcessTpl() email_addr_%d NOT FOUND!!!\n", i+1));
ERRLOG("BOEmailSetting:: ProcessTpl() email_addr NOT FOUND!!!\n");
                                			}

// SetEmailNotifyList
							if (iRet == PD_OK) {
                                        			iRet = SetEmailNotifyList(hContext);
                                			}

// AddOriginalEmailSetting
							if (iRet == PD_OK) {
								iRet = AddOriginalEmailSetting(hContext);
							}
						}
					} else {
                                		iRet = INT_ERR;
DEBUGLOG(("ProcessTpl() call DBEmailSetting::DisableEmailSettingRecord() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ValidateProcess::DisableEmailSettingRecord::failed!!\n");
                        		}
				}
			} else if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("ProcessTpl() action = add\n"));

// UpdateEmailSettingDefault
				DEBUGLOG(("ProcessTpl() call DBEmailSetting::UpdateEmailSettingDefault()\n"));
                        	DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "UpdateEmailSettingDefault");
                        	iDtlRet = (unsigned long)(*DBObjPtr)(hContext);
				if (iDtlRet == PD_FOUND) {
DEBUGLOG(("ProcessTpl() call DBEmailSettingHostory::AddOriginalLog()\n"));
DBObjPtr = CreateObj(DBPtr, "DBEmailSettingHistory", "AddOriginalLog");
                                	iRet = (unsigned long)(*DBObjPtr)(hContext);
                                	if (iRet != PD_OK) {
                                        	iRet = INT_ERR;
DEBUGLOG(("ProcessTpl() call DBEmailSettingHistory::AddOriginalLog() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ValidateProcess::AddOriginalLog::failed!!\n");
                                	}
				} else if (iDtlRet == PD_NOT_FOUND) {
// SetDefaultNotifyList	
					iRet = SetDefaultEmailNotifyList(hContext);

// AddOriginalEmailSetting
					if (iRet == PD_OK) {
						iRet = AddOriginalEmailSetting(hContext);
					}
                        	} else {
                                	iRet = INT_ERR;
DEBUGLOG(("ProcessTpl() call DBEmailSetting::UpdateEmailSettingDefault() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ValidateProcess::UpdateEmailSettingDefault::failed!!\n");
                        	}
			}
		}
	}

	if (iRet != PD_OK) {
		PutField_Int(hContext, "internal_error", iRet);
	}

DEBUGLOG(("ProcessTpl() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;
}
