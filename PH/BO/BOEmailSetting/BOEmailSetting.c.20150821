/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/12/08              Elvis Wong
Change INT_EML_EMAIL_ADDR_NOT_FOUND
to INT_EML_EMAIL_ADDR_NOT_REG			   2015/06/10		   Elvis Wong
Add AddEmailSettingHistory			   2015/07/13		   Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOEmailSetting.h"

#define	PD_EML_EMAIL_ID_DEFAULT 			0
#define	PD_EML_EMAIL_HISTORY_LOQ_SEQ_START 		1

char    cDebug;
OBJPTR(DB);
OBJPTR(BO);

void BOEmailSetting(char cdebug)
{
        cDebug = cdebug;
}

int SetEmailNotifyList(hash_t *hRls)
{
	int	iRet = PD_OK;
	int	iDtlRet = NOT_FOUND;

	int     iEmailId = 0;

DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord()\n"));
	DBObjPtr = CreateObj(DBPtr, "DBEmailNotifyList", "CheckEmailAddressRecord");
       	iDtlRet = (unsigned long)(*DBObjPtr)(hRls);
       	if (iDtlRet == FOUND) {
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord() email_addr found!!!\n"));

/* mail_id */
       		if (GetField_Int(hRls, "mail_id", &iEmailId)) {
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord() mail_id = [%d]\n", iEmailId));
       		}

     	} else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord() email_addr not found!!!\n"));

DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::GetLatestEmailId()\n"));	
		DBObjPtr = CreateObj(DBPtr, "DBEmailNotifyList", "GetLatestEmailId");
                iDtlRet = (unsigned long)(*DBObjPtr)(hRls);
                if ((iDtlRet == FOUND) || (iDtlRet == NOT_FOUND)) {
/* mail_id */
               		if (GetField_Int(hRls, "mail_id", &iEmailId)) {
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::GetLatestEmailId() mail_id = [%d]\n", iEmailId));
                      	}
					
            	} else {
                   	iRet = INT_ERR;
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::GetLatestEmailId() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::SetEmailNotifyList::call DBEmailNotifyList::GetLatestEmailId::failed!!\n");
           	}

		if (iRet == PD_OK) {
/* mail_id */
             		iEmailId++;
                       	PutField_Int(hRls,"mail_id",iEmailId);
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::Add() mail_id = [%d]\n", iEmailId));

DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::Add()\n"));
                      	DBObjPtr = CreateObj(DBPtr, "DBEmailNotifyList", "Add");
                       	iRet = (unsigned long)(*DBObjPtr)(hRls);
                      	if (iRet != PD_OK) {
                        	iRet = INT_ERR;
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::Add() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::SetEmailNotifyList::call DBEmailNotifyList::Add::failed!!\n");
                      	}
              	}
 	} else {
		iRet = INT_ERR;
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::SetEmailNotifyList::call DBEmailNotifyList::CheckEmailAddressRecord::failed!!\n");
	}	

	return iRet;
}

int SetDefaultEmailNotifyList(hash_t *hRls)
{
	int     iRet = PD_OK;
	int	iDtlRet = NOT_FOUND;

        int     iEmailId = 0;

/* mail_id */
	iEmailId = PD_EML_EMAIL_ID_DEFAULT;
        PutField_Int(hRls,"mail_id",iEmailId);
DEBUGLOG(("SetDefaultEmailNotifyList() mail_id = [%d]\n", iEmailId));

DEBUGLOG(("SetDefaultEmailNotifyList() call DBEmailNotifyList::CheckEmailIdRecord()\n"));
        DBObjPtr = CreateObj(DBPtr, "DBEmailNotifyList", "CheckEmailIdRecord");
        iDtlRet = (unsigned long)(*DBObjPtr)(hRls);
        if (iDtlRet == FOUND) {
DEBUGLOG(("SetDefaultEmailNotifyList() call DBEmailNotifyList::CheckEmailIdRecord() email_id found!!!\n"));
        } else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("SetDefaultEmailNotifyList() call DBEmailNotifyList::CheckEmailIdRecord() email_id not found!!!\n"));

DEBUGLOG(("SetDefaultEmailNotifyList() call DBEmailNotifyList::Add()\n"));
              	DBObjPtr = CreateObj(DBPtr, "DBEmailNotifyList", "Add");
               	iRet = (unsigned long)(*DBObjPtr)(hRls);
               	if (iRet != PD_OK) {
                 	iRet = INT_ERR;
DEBUGLOG(("SetDefaultEmailNotifyList() call DBEmailNotifyList::Add() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::SetDefaultEmailNotifyList::call DBEmailNotifyList::Add::failed!!\n");
               	}
	} else {
                iRet = INT_ERR;
DEBUGLOG(("SetDefaultEmailNotifyList() call DBEmailNotifyList::CheckEmailIdRecord() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::SetDefaultEmailNotifyList::call DBEmailNotifyList::CheckEmailIdRecord::failed!!\n");
        }

        return iRet;
}

int SetEmailSetting(hash_t *hRls)
{
	int 	iRet = PD_OK;
	int	iDtlRet = NOT_FOUND;

	int	iDisabled = 0;
	int	iOrgDefault = 0;
	int	iDefault = 0;

/* disabled */
        iDisabled = 0;
      	PutField_Int(hRls,"disabled",iDisabled);
DEBUGLOG(("SetEmailSetting() disabled = [%d]\n", iDisabled));

/* default */
	if (GetField_Int(hRls, "default", &iDefault)) {
DEBUGLOG(("SetEmailSetting() default = [%d]\n", iDefault));
        }

DEBUGLOG(("SetEmailSetting() call DBEmailSetting::CheckEmailSettingRecord()!!!\n"));
	DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "CheckEmailSettingRecord");
        iDtlRet = (unsigned long)(*DBObjPtr)(hRls);
       	if (iDtlRet == FOUND) {
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::CheckEmailSettingRecord() email_id found!!!\n"));	

/* org_default */
                if (GetField_Int(hRls, "org_default", &iOrgDefault)) {
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::CheckEmailAddressRecord() org_default = [%d]\n", iOrgDefault));
                }

DEBUGLOG(("SetEmailSetting() call DBEmailSetting::Update()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "Update");
              	iRet = (unsigned long)(*DBObjPtr)(hRls);
                if (iRet != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::Update() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::SetEmailSetting::call DBEmailSetting::Update::failed!!\n");
               	}
	} else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::CheckEmailSettingRecord() email_id not found!!!\n"));

DEBUGLOG(("SetEmailSetting() call DBEmailSetting::Add()\n"));
              	DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "Add");
               	iRet = (unsigned long)(*DBObjPtr)(hRls);
               	if (iRet != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::Add() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::SetEmailSetting::call DBEmailSetting::Add::failed!!\n");
              	}	
	} else {
		iRet = INT_ERR;
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::CheckEmailSettingRecord() Failed!!!\n"));
	}

	return iRet;
}

int AddOriginalEmailSetting(hash_t *hRls)
{
	int	iRet = PD_OK;
	
	int 	iDisabled = 0;

/* disabled */
	iDisabled = 0;
       	PutField_Int(hRls,"disabled",iDisabled);
DEBUGLOG(("AddOriginalEmailSetting() disabled = [%d]\n", iDisabled));

DEBUGLOG(("AddOriginalEmailSetting() call DBEmailSetting::AddOriginal()\n"));
        DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "AddOriginal");
        iRet = (unsigned long)(*DBObjPtr)(hRls);
     	if (iRet != PD_OK) {
          	iRet = INT_ERR;
DEBUGLOG(("AddOriginalEmailSetting() call DBEmailSetting::AddOriginalEmailSetting() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::Call DBEmailSetting::AddOriginalEmailSetting::failed!!\n");
       	}

	return iRet;
}

int AddEmailSettingHistory(hash_t *hRls)
{
        int     iRet = PD_OK;

	int     iTmp = 0;

/* mail_id */
	iTmp = PD_EML_EMAIL_ID_DEFAULT;
	PutField_Int(hRls,"mail_id",iTmp);
DEBUGLOG(("AddEmailSettingHistory() mail_id = [%d]\n", iTmp));

/* disabled */
        iTmp = 0;
        PutField_Int(hRls,"disabled",iTmp);
DEBUGLOG(("AddEmailSettingHistory() disabled = [%d]\n", iTmp));

DEBUGLOG(("AddEmailSettingHistory() call DBEmailSettingHistory::AddLog()\n"));
        DBObjPtr = CreateObj(DBPtr, "DBEmailSettingHistory", "AddLog");
        iRet = (unsigned long)(*DBObjPtr)(hRls);
        if (iRet != PD_OK) {
                iRet = INT_ERR;
DEBUGLOG(("AddEmailSettingHistory() call DBEmailSettingHistory::AddLog() FAILURE!!!\n"));
ERRLOG("BOEmailSettingHistory::Call DBEmailSettingHistory::AddLog::failed!!\n");
        }

        return iRet;
}

int ProcessTpl(hash_t* hContext,
                hash_t* hRequest,
                hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iDtlRet = NOT_FOUND;

	char 	cAction;	
	int     i = 0;
	int 	iTotalEmailNum = 0;
	int	iLogSeq = 0;

	char	*csTmp;
	
	char    csTag[PD_TAG_LEN + 1];

/* action */
        if (GetField_Char(hContext, "action", &cAction)) {
DEBUGLOG(("ProcessTpl() action = [%c]\n", cAction));
        } else {
                iRet = INT_ACTION_NOT_FOUND;
DEBUGLOG(("ProcessTpl() action NOT FOUND!!!\n"));
ERRLOG("BOEmailSetting:: ProcessTpl() action NOT FOUND!!!\n");
        }

/* total_email_num */
	if (GetField_Int(hContext, "total_email_num", &iTotalEmailNum)) {
DEBUGLOG(("ProcessTpl() total_email_num = [%d]\n", iTotalEmailNum));
        }

	if (iRet == PD_OK) {	

// GetEmailSettingHistoryLogSeq
DEBUGLOG(("ProcessTpl() call DBEmailSettingHistory::GetLatestLogSeq()\n"));
        	DBObjPtr = CreateObj(DBPtr, "DBEmailSettingHistory", "GetLatestLogSeq");
               	iDtlRet = (unsigned long)(*DBObjPtr)(hContext);
              	if (iDtlRet == FOUND) {
DEBUGLOG(("ProcessTpl() call DBEmailSettingHistory::GetLatestLogSeq() found!!!\n"));			

/* log_seq */
			if (GetField_Int(hContext, "log_seq", &iLogSeq)) {
				iLogSeq++;
				PutField_Int(hContext,"log_seq",iLogSeq);
DEBUGLOG(("ProcessTpl() call DBEmailSettingHistory:: log_seq = [%d]\n", iLogSeq));
			}

		} else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("ProcessTpl() call DBEmailSettingHistory::GetLatestLogSeq() not found!!!\n"));

/* log_seq */
			iLogSeq = PD_EML_EMAIL_HISTORY_LOQ_SEQ_START;
                        PutField_Int(hContext,"log_seq",iLogSeq);
DEBUGLOG(("ProcessTpl() call DBEmailSettingHistory:: log_seq = [%d]\n", iLogSeq));		
	
		} else {
			iRet = INT_ERR;
DEBUGLOG(("ProcessTpl() call DBEmailSettingHistory::GetLatestLogSeq() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ProcessTpl::call DBEmailSettingHistory::GetLatestLogSeq::failed!!\n");
		}		

// CheckAction
		if (iRet == PD_OK) {
			if (cAction == PD_ACTION_UPDATE) {
DEBUGLOG(("ProcessTpl() action = update\n"));

// CheckTotalEmailNumber
				if (iTotalEmailNum == 0) {		
					iRet = INT_EML_EMAIL_ADDR_NOT_REG;
DEBUGLOG(("ProcessTpl() total_email_num = 0\n"));
ERRLOG("BOEmailSetting::ProcessTpl::total_email_num = 0!!\n");			
				} else {
// DisableEmailSetting	
					DEBUGLOG(("ProcessTpl() call DBEmailSetting::DisableEmailSettingRecord()\n"));
                        		DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "DisableEmailSettingRecord");
                        		iDtlRet = (unsigned long)(*DBObjPtr)(hContext);
					if (iDtlRet == PD_FOUND) {
						for (i=0; i<iTotalEmailNum; i++) {
/* mail_addr */	
							sprintf(csTag, "email_addr_%d", i+1);	
							if (GetField_CString(hContext, csTag, &csTmp)) {				
DEBUGLOG(("ProcessTpl() [%s] = [%s]\n", csTag, csTmp));
								PutField_CString(hContext,"mail_addr",csTmp);
							} else {
         							iRet = INT_ERR;
DEBUGLOG(("ProcessTpl() email_addr_%d NOT FOUND!!!\n", i+1));
ERRLOG("BOEmailSetting:: ProcessTpl() email_addr NOT FOUND!!!\n");
        						}

// SetEmailNotifyList
							if (iRet == PD_OK) {
								iRet = SetEmailNotifyList(hContext);
							}
				
// SetEmailSetting
							if (iRet == PD_OK) {
								iRet = SetEmailSetting(hContext);
							}
						}
// AddEmailSettingHistory
						if (iRet == PD_OK) {
                                                        iRet = AddEmailSettingHistory(hContext);
                                                }
					} else if (iDtlRet == PD_NOT_FOUND) {
						for (i=0; i<iTotalEmailNum; i++) {
/* mail_addr */
							sprintf(csTag, "email_addr_%d", i+1);
                                			if (GetField_CString(hContext, csTag, &csTmp)) {
DEBUGLOG(("ProcessTpl() [%s] = [%s]\n", csTag, csTmp));
                                        			PutField_CString(hContext,"mail_addr",csTmp);
                                			} else {
                                       				iRet = INT_ERR;
DEBUGLOG(("ProcessTpl() email_addr_%d NOT FOUND!!!\n", i+1));
ERRLOG("BOEmailSetting:: ProcessTpl() email_addr NOT FOUND!!!\n");
                                			}

// SetEmailNotifyList
							if (iRet == PD_OK) {
                                        			iRet = SetEmailNotifyList(hContext);
                                			}

// AddOriginalEmailSetting
							if (iRet == PD_OK) {
								iRet = AddOriginalEmailSetting(hContext);
							}
						}

// AddEmailSettingHistory
						if (iRet == PD_OK) {
                                                       	iRet = AddEmailSettingHistory(hContext);
                                                }				
					} else {
                                		iRet = INT_ERR;
DEBUGLOG(("ProcessTpl() call DBEmailSetting::DisableEmailSettingRecord() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ProcessTpl::call DBEmailSetting::DisableEmailSettingRecord::failed!!\n");
                        		}
				}
			} else if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("ProcessTpl() action = add\n"));

// UpdateEmailSettingDefault
DEBUGLOG(("ProcessTpl() call DBEmailSetting::UpdateEmailSettingDefault()\n"));
                        	DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "UpdateEmailSettingDefault");
                        	iDtlRet = (unsigned long)(*DBObjPtr)(hContext);
				if (iDtlRet == PD_FOUND) {

// AddEmailSettingHistory
					iRet = AddEmailSettingHistory(hContext);

				} else if (iDtlRet == PD_NOT_FOUND) {
// SetDefaultNotifyList	
					iRet = SetDefaultEmailNotifyList(hContext);

// AddOriginalEmailSetting
					if (iRet == PD_OK) {
						iRet = AddOriginalEmailSetting(hContext);
					}
// AddEmailSettingHistory
					if (iRet == PD_OK) {
                                                iRet = AddEmailSettingHistory(hContext);
                                        }				

                        	} else {
                                	iRet = INT_ERR;
DEBUGLOG(("ProcessTpl() call DBEmailSetting::UpdateEmailSettingDefault() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ProcessTpl::call DBEmailSetting::UpdateEmailSettingDefault::failed!!\n");
                        	}
			}
		}
	}

	if (iRet != PD_OK) {
		PutField_Int(hContext, "internal_error", iRet);
	}

DEBUGLOG(("ProcessTpl() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;
}

int ProcessEmailSettingBySettlement(hash_t* hContext, hash_t* hRls, int iSendEmail)
{
	int     iRet = PD_OK;
        int     iDtlRet = NOT_FOUND;

        int     iLogSeq = 0;
	int	iEmailId = 0;
	int	iTmp = 0;

	char	*csUser = NULL;

	hash_t  *hEmailIdRec = NULL;
        recordset_t *rEmailId = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rEmailId, 0);

/* user */
	if (GetField_CString(hRls,"update_user",&csUser)) {
DEBUGLOG(("ProcessEmailSettingBySettlement() update_user = [%s]\n",csUser));
        }

	// Get Latest Email Settting History Log Seq
DEBUGLOG(("ProcessEmailSettingBySettlement:: call DBEmailSettingHistory::GetLatestLogSeq()\n"));
     	DBObjPtr = CreateObj(DBPtr, "DBEmailSettingHistory", "GetLatestLogSeq");
     	iDtlRet = (unsigned long)(*DBObjPtr)(hRls);
     	if (iDtlRet == FOUND) {
DEBUGLOG(("ProcessEmailSettingBySettlement:: call DBEmailSettingHistory::GetLatestLogSeq() found!!!\n"));

/* log_seq */
           	if (GetField_Int(hRls, "log_seq", &iLogSeq)) {
                     	iLogSeq++;
                  	PutField_Int(hRls,"log_seq",iLogSeq);
DEBUGLOG(("ProcessEmailSettingBySettlement:: call DBEmailSettingHistory:: log_seq = [%d]\n", iLogSeq));
            	}

       	} else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("ProcessEmailSettingBySettlement:: call DBEmailSettingHistory::GetLatestLogSeq() NOT found!!!\n"));

    	} else {
           	iRet = INT_ERR;
             	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessEmailSettingBySettlement:: call DBEmailSettingHistory::GetLatestLogSeq() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ProcessEmailSettingBySettlement::call DBEmailSettingHistory::GetLatestLogSeq::failure!!!\n");
     	}

	// Get Email Setting Default and Email Id (Recordset)
       	if (iRet == PD_OK) {
DEBUGLOG(("ProcessEmailSettingBySettlement:: Call DBEmailSetting:: GetEmailId\n"));
            	DBObjPtr = CreateObj(DBPtr,"DBEmailSetting","GetEmailId");
             	iDtlRet = (unsigned long)(*DBObjPtr)(hRls, rEmailId);
         	if (iDtlRet == FOUND) {
DEBUGLOG(("ProcessEmailSettingBySettlement:: call DBEmailSetting::GetEmailId() found!!\n"));

                 	hEmailIdRec = RecordSet_GetFirst(rEmailId);
                   	while (hEmailIdRec) {

/* default */
                 		if (GetField_Int(hEmailIdRec, "default", &iTmp)) {
DEBUGLOG(("ProcessEmailSettingBySettlement:: Call DBEmailSetting:: default = [%d]\n", iTmp));

                     		}

/* email_id */
                  		if (iTmp != iSendEmail) {
                             		if (GetField_Int(hEmailIdRec, "mail_id", &iEmailId)) {
DEBUGLOG(("ProcessEmailSettingBySettlement:: Call DBEmailSetting:: email_id = [%d]\n", iEmailId));

                                     		PutField_Int(hRls,"mail_id",iEmailId);
                                      		PutField_Int(hRls,"default",iSendEmail);
                                    		PutField_Int(hRls,"disabled",PD_FALSE);
                                   		PutField_CString(hRls,"update_user",csUser);

						// Set Email Setting
DEBUGLOG(("ProcessEmailSettingBySettlement:: call DBEmailSetting::Update()\n"));
                                     		DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "Update");
                                      		iDtlRet = (unsigned long)(*DBObjPtr)(hRls);
                                    		if (iDtlRet == PD_OK) {
DEBUGLOG(("ProcessEmailSettingBySettlement:: call DBEmailSetting::Update() SUCCESS!!!\n"));

                                     		} else {
                                        	       	iRet = INT_ERR;
                                        	       	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessEmailSettingBySettlement:: call DBEmailSetting::Update() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::ProcessEmailSettingBySettlement::call DBEmailSetting::Update::failed!!\n");
                                    		}
                              		}
                     		}

                      		hEmailIdRec = RecordSet_GetNext(rEmailId);

				// Add Email Setting History
                      		if (!hEmailIdRec) {
                           		if (iRet == PD_OK) {
                                 		if (iTmp != iSendEmail) {

                                              		PutField_Int(hRls,"mail_id",0);
                                           		PutField_CString(hRls,"create_user",csUser);

DEBUGLOG(("ProcessEmailSettingBySettlement:: call DBEmailSettingHistory::AddLog()\n"));
                                           		DBObjPtr = CreateObj(DBPtr, "DBEmailSettingHistory", "AddLog");
                                              		iDtlRet = (unsigned long)(*DBObjPtr)(hRls);
                                           		if (iDtlRet == PD_OK) {
DEBUGLOG(("ProcessEmailSettingBySettlement:: call DBEmailSettingHistory::AddLog() SUCCESS!!!\n"));

                                               		} else {
                                                  		iRet = INT_ERR;
                                                    		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessEmailSettingBySettlement:: call DBEmailSettingHistory::AddLog() FAILURE!!!\n"));
ERRLOG("BOEmailSetting::Authorize::call DBEmailSettingHistory::AddLog::failed!!\n");
                                             		}
                                    		}
                               		}
                  		}	
            		}
     		} else if (iDtlRet == NOT_FOUND) {
            		if (iSendEmail == PD_TRUE) {
                          	iRet = INT_EML_EMAIL_ADDR_NOT_REG;
                            	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessEmailSettingBySettlement:: call DBEmailSetting::GetEmailId() Email Addr NOT Registered!!!\n"));
ERRLOG("BOEmailSetting::ProcessEmailSettingBySettlement::call DBEmailSetting::GetEmailId() Email Addr NOT Registered!!!\n");
                     	}
           	} else {
                     	iRet = INT_ERR;
                      	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessEmailSettingBySettlement:: call DBEmailSetting::GetEmailId() INT_ERR!!!\n"));
ERRLOG("BOEmailSetting::ProcessEmailSettingBySettlement::call DBEmailSetting::GetEmailId() INT_ERR!!\n");
             	}
     	}								

	RecordSet_Destroy(rEmailId);
        FREE_ME(rEmailId);

DEBUGLOG(("ProcessEmailSettingBySettlement() Normal Exit! iRet = [%d]\n", iRet));
        return iRet;
}
