/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/09/29              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOSecurity.h"
#include "md5.h"

#define	MY_FIELD_TOKEN	"|"
char    cDebug;

void BOSecurity(char    cdebug)
{
        cDebug = cdebug;
}



int VerifyXpaySign(hash_t *hContext,
                const hash_t* hRequest)
{
        int     iRet = PD_OK;
	char	*csBuf,*csOUT;
	char	*csPtr;
	char	*csSign = strdup("");
	
DEBUGLOG(("BOSecurity:VerifyXpaySign()\n"));
	csBuf = (char*) malloc (1024 * 2 +1);
	csOUT = (char*) malloc (1024 * 2 +1);

	csBuf[0]='\0';
	csOUT[0]='\0';
/* merchant_id */
	if (GetField_CString(hRequest,"merchant_id",&csPtr)) {
DEBUGLOG(("BOSecurity:VerifyXpaySign() merchant_id= [%s]\n",csPtr));
		strcat(csBuf,csPtr);
		strcat(csBuf,MY_FIELD_TOKEN);
	}

/* encrypt_type */
	if (GetField_CString(hRequest,"encrypt_type",&csPtr)) {
DEBUGLOG(("BOSecurity:VerifyXpaySign() encrypt_type= [%s]\n",csPtr));
		strcat(csBuf,csPtr);
		strcat(csBuf,MY_FIELD_TOKEN);
	}
/* plainttext_data */
	if (GetField_CString(hRequest,"plainttext_data",&csPtr)) {
DEBUGLOG(("BOSecurity:VerifyXpaySign() plainttext_data= [%s]\n",csPtr));
		strcat(csBuf,csPtr);
		strcat(csBuf,MY_FIELD_TOKEN);
	}
/* merchant_key */
	if (GetField_CString(hContext,"merchant_key",&csPtr)) {
DEBUGLOG(("BOSecurity:VerifyXpaySign() merchant_key= [%s]\n",csPtr));
		strcat(csBuf,csPtr);
	}
DEBUGLOG(("BOSecurity:VerifyXpaySign() verify_data= [%s]\n",csBuf));

	md5sum(csBuf,strlen(csBuf),csOUT);
DEBUGLOG(("BOSecurity:VerifyXpaySign() sign             = [%s]\n",csOUT));
	csBuf[0] = '\0';
	U2L(csOUT,strlen(csOUT),csBuf);
DEBUGLOG(("BOSecurity:VerifyXpaySign() sign             = [%s]\n",csBuf));


	if (GetField_CString(hRequest,"sign",&csSign)) {
DEBUGLOG(("BOSecurity:VerifyXpaySign() sign from Request= [%s]\n",csSign));
	}

	else {
errlog("BOSecurity:VerifyXpaySign sign not found\n");
DEBUGLOG(("BOSecurity:VerifyXpaySign sign not found\n"));
		iRet = INT_SIGN_DATA_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}
/* verify sign */
	if (memcmp(csSign,csBuf,PD_MD5_SUM_LEN) != 0) {
errlog("BOSecurity:verify sign error\n");
		iRet = INT_MAC_ERR;
		PutField_Int(hContext,"internal_error",iRet);
	}

	FREE_ME(csBuf);
	FREE_ME(csOUT);
DEBUGLOG(("BOSecurity:VerifyXpaySign() iRet = [%d]\n",iRet));

	
	return iRet;
}


int GenerateXpaySign(hash_t *hContext,
                hash_t* hOut)
{
        int     iRet = PD_OK;
        char    *csBuf,*csOUT;
        char    *csPtr;

DEBUGLOG(("BOSecurity:GenerateXpaySign()\n"));
        csBuf = (char*) malloc (1024 * 2 +1);
        csOUT = (char*) malloc (1024 * 2 +1);

        csBuf[0]='\0';
        csOUT[0]='\0';
/* merchant_id */
        if (GetField_CString(hOut,"merchant_id",&csPtr)) {
DEBUGLOG(("BOSecurity:GenerateXpaySign() merchant_id= [%s]\n",csPtr));
                strcat(csBuf,csPtr);
                strcat(csBuf,MY_FIELD_TOKEN);
        }

/* encrypt_type */
        if (GetField_CString(hOut,"encrypt_type",&csPtr)) {
DEBUGLOG(("BOSecurity:GenerateXpaySign() encrypt_type= [%s]\n",csPtr));
                strcat(csBuf,csPtr);
                strcat(csBuf,MY_FIELD_TOKEN);
        }
/* plainttext_data */
        if (GetField_CString(hOut,"plainttext_data",&csPtr)) {
DEBUGLOG(("BOSecurity:GenerateXpaySign() plainttext_data= [%s]\n",csPtr));
                strcat(csBuf,csPtr);
                strcat(csBuf,MY_FIELD_TOKEN);
        }
/* merchant_key */
        if (GetField_CString(hContext,"merchant_key",&csPtr)) {
DEBUGLOG(("BOSecurity:GenerateXpaySign() merchant_key= [%s]\n",csPtr));
                strcat(csBuf,csPtr);
        }
DEBUGLOG(("BOSecurity:GenerateXpaySign() sign_data= [%s]\n",csBuf));

        md5sum(csBuf,strlen(csBuf),csOUT);
        csBuf[0] = '\0';
        U2L(csOUT,strlen(csOUT),csBuf);
DEBUGLOG(("BOSecurity:GenerateXpaySign() sign             = [%s]\n",csOUT));
DEBUGLOG(("BOSecurity:GenerateXpaySign() sign             = [%s]\n",csBuf));
	PutField_CString(hOut,"sign",csBuf);


        FREE_ME(csBuf);
        FREE_ME(csOUT);
DEBUGLOG(("BOSecurity:GenerateXpaySign() iRet = [%d]\n",iRet));


        return iRet;
}

int GenerateMAC(const unsigned char* KEY,const unsigned char* DATA, const int DATA_LEN,unsigned char* OUT)
{
	int 	iRet = PD_OK;
	int	i;
        unsigned char   csKey[PD_KEY_LEN +1];
        unsigned char   csMAC[PD_KEY_LEN +1];
        unsigned char   csMac[PD_KEY_LEN +1];

DEBUGLOG(("GenerateMac() input = [%s][%s][%d]\n",KEY,DATA,strlen(DATA)));

        Ascii2Hex((char*)csKey,(unsigned char*)KEY,PD_KEY_LEN *2 );

	i = (PD_KEY_LEN / 2) - DATA_LEN % (PD_KEY_LEN /2);
        i += DATA_LEN; 

        EncryptKeyDIV(csKey,DATA,i,csMAC,NULL);

        Hex2Ascii((char*)csMac,csMAC,PD_KEY_LEN /2);
DEBUGLOG(("GenerateMac() Hex2Ascii = [%s][%d]\n",csMac,strlen(csMac)));
	memset(OUT,0,sizeof(OUT));
	strcpy(OUT,csMac);

DEBUGLOG(("BOSecurity:GenerateMac() iRet = [%d]\n",iRet));
	return iRet;
}
int VerifyMac(const unsigned char* MAC, const unsigned char* KEY,const unsigned char* DATA, const int DATA_LEN)
{
	int 		iRet = PD_OK;
        unsigned char   csKey[PD_KEY_LEN +1];
        unsigned char   csMAC[PD_KEY_LEN +1];
        unsigned char   csMac[PD_KEY_LEN +1];
	int	i;

        Ascii2Hex((char*)csKey,(unsigned char*)KEY,PD_KEY_LEN *2 );

	i = (PD_KEY_LEN/2) - DATA_LEN % (PD_KEY_LEN /2);
        i += DATA_LEN; 

        EncryptKeyDIV(csKey,DATA,i,csMAC,NULL);
        Hex2Ascii((char*)csMac,csMAC,PD_KEY_LEN /2);
	if (memcmp(csMac,MAC,PD_KEY_LEN) != 0 ) {
		iRet = INT_MAC_ERR;
DEBUGLOG(("BOSecurity:Invlide Mac\n"));
	}

DEBUGLOG(("BOSecurity:VerifyMac() iRet = [%d]\n",iRet));
	return iRet;
}
