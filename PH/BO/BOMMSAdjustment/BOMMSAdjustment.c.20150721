/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/06/25              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOMMSAdjustment.h"

#define PD_TXN_STATUS_MAP_TOTAL_NUMBER		3

char    cDebug;

OBJPTR(DB);
OBJPTR(BO);

void BOMMSAdjustment(char    cdebug)
{
        cDebug = cdebug;
}

int GetCurrentCode(hash_t *hRec)
{
        int     iRet = PD_OK;

        int     iMaxCodeInNum = -1;

DEBUGLOG(("GetCurrentCode::Call DBMmsAdjustmentType: GetMaxCode\n"));
        DBObjPtr = CreateObj(DBPtr,"DBMmsAdjustmentType","GetMaxCode");
        iRet = (unsigned long)((*DBObjPtr)(&iMaxCodeInNum));
	if (iRet == PD_OK) {
DEBUGLOG(("GetCurrentCode::CurrentCode Get [%d]\n", iMaxCodeInNum));

                /* No Current Code Found */
                if (iMaxCodeInNum < 0) {
                        iMaxCodeInNum = 0 ;
                } else {
                        iMaxCodeInNum++;

                        if (iMaxCodeInNum > PD_ADJ_TYPE_MAX_CODE) {
                                /* handle over 99 later */
                                iRet = INT_ERR;
                        }
                }

DEBUGLOG(("GetCurrentCode::CurrentCode Assigned CodeInNum [%d]\n", iMaxCodeInNum));
                PutField_Int(hRec, "code_in_num", iMaxCodeInNum);
        } else {
DEBUGLOG(("GetCurrentCode:GetMaxCode not found\n"));
//ERRLOG("BOMMSAdjustment::GetCurrentCode::GetMaxCode not found!!\n");
                iRet = INT_ERR;
        }

DEBUGLOG(("GetCurrentCode: return iRet [%d]\n", iRet));
        return  iRet;
}

int ValidateProcess(hash_t* hRec)
{
	int     iRet = PD_OK;
        int     iDtlRet = PD_OK;

        //int     iCodeInNum;
        int     iCurrentDisabled;
        int     iCurrentAllowModify;

        char    *csCode = NULL;

	hash_t  *hCurrAdjRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hCurrAdjRec,0);

/* code */
        if (GetField_CString(hRec,"code",&csCode)) {
DEBUGLOG(("ValidateProcess: code = [%s]\n",csCode));
        } else {
DEBUGLOG(("ValidateProcess:: code missing!!\n"));
//ERRLOG("BOMMSAdjustment:: ValidateProcess:: code missing!!\n");
                iRet = INT_MMS_ADJ_CODE_NOT_FOUND;
	}

/* code_in_num */
/*
        if (GetField_Int(hRec,"code_in_num",&iCodeInNum)) {
DEBUGLOG(("ValidateProcess: code_in_num = [%d]\n",iCodeInNum));
        } else {
DEBUGLOG(("ValidateProcess:: code_in_num missing!!\n"));
//ERRLOG("BOMMSAdjustment:: ValidateProcess:: code_in_num missing!!\n");
                iRet = INT_MMS_ADJ_CODE_NOT_FOUND;
        }
*/

	if (iRet == PD_OK) {

		// Get MMS Adjustment Type Record
DEBUGLOG(("ValidateProcess:: Call DBMmsAdjustmentType GetAdjustmentTypeRec\n"));
           	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","GetAdjustmentTypeRec");
             	iDtlRet = (unsigned long)(*DBObjPtr)(csCode,hCurrAdjRec);
              	if (iDtlRet == PD_OK) {
DEBUGLOG(("ValidateProcess:: Call DBMmsAdjustmentType:: Success!!!\n"));
		
/* disabled */
			if (GetField_Int(hCurrAdjRec, "disabled", &iCurrentDisabled)) {
DEBUGLOG(("ValidateProcess:: GetAdjustmentTypeRec:: disabled = [%d]\n",iCurrentDisabled));
			}

/* allow_modify */
			if (GetField_Int(hCurrAdjRec, "allow_modify", &iCurrentAllowModify)) {
DEBUGLOG(("ValidateProcess:: GetAdjustmentTypeRec:: allow_modify = [%d]\n",iCurrentAllowModify));

				if (iCurrentAllowModify != PD_TRUE) {
					iRet = INT_MMS_ADJ_TYPE_NOT_ALLOW_MODIFY;
				}
                       	}
           	} else {
                    	iRet = INT_ERR;
DEBUGLOG(("ValidateProcess:: Call DBMmsAdjustmentType:: Failure!!!\n"));
//ERRLOG("BOMMSAdjustment::ValidateProcess::Call DBMmsAdjustmentType:: Failure!!!\n");
           	}

		// Check Record Exists
		if (iRet == PD_OK) {
				
DEBUGLOG(("ValidateProcess:: Call DBMmsTransaction: ChkTxnCodeExist\n"));
                    	DBObjPtr = CreateObj(DBPtr,"DBMmsTransaction","ChkTxnCodeExist");
                    	iDtlRet = (unsigned long)(*DBObjPtr)(csCode);
                    	if (iDtlRet == PD_FOUND) {
DEBUGLOG(("ValidateProcess:: Call DBMmsTransaction: ChkTxnCodeExist: FOUND\n"));

                               	iRet = PD_FALSE;
                    	} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("ValidateProcess:: Call DBMmsTransaction: ChkTxnCodeExist: NOT FOUND\n"));
				
				iRet = PD_TRUE;
                    	} else {
DEBUGLOG(("ValidateProcess:: Call DBMmsTransaction: ChkTxnCodeExist: ERR\n"));
//ERRLOG("BOOLAdjustment:: ValidateProcess:: Call DBMmsTransaction: ChkTxnCode Exist :: Error!!\n");
                            	iRet = INT_ERR;
                     	}
		}
	}

	hash_destroy(hCurrAdjRec);
        FREE_ME(hCurrAdjRec);

DEBUGLOG(("ValidateProcess() normal exit iRet = [%d]\n",iRet));
        return iRet;
}

int AddAdjustmentType (hash_t* hContext, hash_t* hData)
{
	int	iRet = PD_OK;
	int	iDtlRet = PD_FOUND;

	int	iCurrentCode = 0;
	int	iEtypeCnt = 0;
	int	iTxnStatusMapCnt = 0;	
	int	iTmp = 0;
	int	i = 0;

	char	cETAction;	

	char*	csUser = NULL;
	char*	csTmp = NULL;

	char	csCode[PD_TXN_CODE_LEN + 1];
	char	csDesc[PD_DESC_LEN + 1];	
	char    csTag[PD_TAG_LEN + 1];

	hash_t  *hFindRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hFindRec,0);

	hash_t  *hTxnCodeRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnCodeRec,0);

	hash_t  *hTxnStatusMapRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnStatusMapRec,0);

	hash_t  *hTxnSubStatusMapRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnSubStatusMapRec,0);

	cETAction = ' ';

DEBUGLOG(("AddAdjustmentType() Start!\n"));

/* code */
        if (GetField_CString(hData,"code",&csTmp)) {
DEBUGLOG(("AddAdjustmentType: code = [%s]\n",csTmp));
		PutField_CString(hFindRec, "code", csTmp);
	
		iCurrentCode = atoi(csTmp + 1);
                PutField_Int(hData, "code_in_num", iCurrentCode);

DEBUGLOG(("AddAdjustmentType: CurrentCodeInNum = [%d]\n",iCurrentCode));
        } else {

		// Get Current Code
		iRet = GetCurrentCode(hData);
		if (iRet == PD_OK) {
			if (GetField_Int(hData, "code_in_num", &iCurrentCode)) {
                		PutField_Int(hData, "code_in_num", iCurrentCode);
DEBUGLOG(("AddAdjustmentType: CurrentCodeInNum [%d]\n", iCurrentCode));
				
				sprintf(csCode, "%c%02d", PD_ADJ_TXN_CODE_PREFIX, iCurrentCode); // 's'
DEBUGLOG(("AddAdjustmentType: CurrentCode [%s]\n", csCode));

                                PutField_CString(hData, "code", csCode);
                                PutField_CString(hFindRec, "code", csCode);
			}		
		} else {
DEBUGLOG(("AddAdjustmentType:: Get code Failure!!\n"));
ERRLOG("BOMMSAdjustment:: AddAdjustmentType:: Get code Failure!!\n");
                        iRet = INT_CODE_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
                }
	}

/* desc */
	if (GetField_CString(hData,"desc",&csTmp)) {
DEBUGLOG(("AddAdjustmentType: desc = [%s]\n",csTmp));
       
		// Desc Prefix
		if (strlen(PD_ADJ_DESC_PREFIX) + strlen(csTmp) > PD_DESC_LEN){
                     	iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                     	PutField_Int(hContext,"internal_error",iRet);
             	} else {
                    	memset(csDesc, 0, sizeof(csDesc));
                     	strcpy(csDesc, PD_ADJ_DESC_PREFIX); // "Adjustment - "
                      	strncpy(&csDesc[strlen(PD_ADJ_DESC_PREFIX)], csTmp, PD_DESC_LEN - strlen(PD_ADJ_DESC_PREFIX));
                     	PutField_CString(hData, "desc", csDesc);
              	}
        } else {
DEBUGLOG(("AddAdjustmentType:: desc missing!!\n"));
ERRLOG("BOMMSAdjustment:: Authorize:: desc missing!!\n");
            	iRet = INT_MMS_ADJ_NAME_NOT_FOUND;
             	PutField_Int(hContext,"internal_error",iRet);
	}

/* user */
        if (GetField_CString(hData,"user",&csUser)) {
DEBUGLOG(("AddAdjustmentType: user = [%s]\n",csUser));
        } else {
DEBUGLOG(("AddAdjustmentType:: user missing!!\n"));
ERRLOG("TBOMMSAdjustment:: AddAdjustmentType:: user missing!!\n");
                iRet = INT_USER_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/*
 * Txn Code (Foreign Key)
 */

	if (iRet == PD_OK) {

DEBUGLOG(("AddAdjustmentType: ===== Txn Code ===== Start!!\n"));

/* txn_code */
                PutField_CString(hTxnCodeRec, "txn_code", csCode);
DEBUGLOG(("AddAdjustmentType:: txn_code = [%s]\n",csCode));

/* txn_desc */
                PutField_CString(hTxnCodeRec, "txn_desc", csDesc);
DEBUGLOG(("AddAdjustmentType:: desc = [%s]\n",csDesc));

/* process_type */
                PutField_CString(hTxnCodeRec, "process_type", PD_PROCESS_TYPE_DEF);
DEBUGLOG(("AddAdjustmentType:: process_type = [%s]\n",PD_PROCESS_TYPE_DEF));

/* process_code */
                PutField_CString(hTxnCodeRec, "process_code", PD_PROCESS_CODE_DEF);
DEBUGLOG(("AddAdjustmentType:: process_code = [%s]\n",PD_PROCESS_CODE_DEF));

/* create_user */
               	PutField_CString(hTxnCodeRec, "create_user", csUser);
DEBUGLOG(("AddAdjustmentType:: create_user = [%s]\n",csUser));

		// Find Txn Code
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode Find\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Find");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Found!!!\n"));

			// Update Txn Code
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode Update\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Update");
                        iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                        if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Success!!!\n"));
                        } else {
                                iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                        }
                } else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Not Found!!!\n"));
					
			// Add Txn Code
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode Add\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Add");
                        iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                        if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Success!!!\n"));
                        } else {
                                iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                        }
                } else {
                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                }

DEBUGLOG(("AddAdjustmentType: ===== Txn Code ===== End!!\n"));
        }

/*
 * Txn Status Map: 	- type, txn_code, status, ar_ind, status_desc
 * 			- Admin, (s)99, C, A, Approved
 * 			- Admin, (s)99, C, R, Declined
 * 			- Admin, (s)99, R, A, Approved		
 */

	if (iRet == PD_OK) {	

DEBUGLOG(("AddAdjustmentType: ===== Txn Status Map ===== Start!!\n"));

/* txn_status_map_cnt */
		iTxnStatusMapCnt = PD_TXN_STATUS_MAP_TOTAL_NUMBER;
DEBUGLOG(("AddAdjustmentType:: txn_status_map_cnt = [%d]\n", iTxnStatusMapCnt));

		for (i = 0; i < iTxnStatusMapCnt; i++) {
DEBUGLOG(("AddAdjustmentType:: cnt = [%d]\n", i));

/* user */
                       	PutField_CString(hTxnStatusMapRec, "create_user", csUser);
DEBUGLOG(("AddAdjustmentType:: create_user = [%s]\n",csUser));

/* type */
			PutField_Char(hTxnStatusMapRec, "type", PD_STATUS_MAP_TYPE_ADMIN);
DEBUGLOG(("AddAdjustmentType:: type = [%c]\n", PD_STATUS_MAP_TYPE_ADMIN));

/* txn_code */
			PutField_CString(hTxnStatusMapRec, "txn_code", csCode);
DEBUGLOG(("AddAdjustmentType:: txn_code = [%s]\n", csCode));
	
			if (i == 0) {

/* status */
				PutField_Char(hTxnStatusMapRec, "status", PD_COMPLETE);
DEBUGLOG(("AddAdjustmentType:: status = [%c]\n", PD_COMPLETE));

/* ar_ind */
				PutField_Char(hTxnStatusMapRec, "ar_ind", PD_ACCEPT);
DEBUGLOG(("AddAdjustmentType:: ar_ind = [%c]\n", PD_ACCEPT));

/* status_desc */
				PutField_CString(hTxnStatusMapRec, "status_desc", PD_STATUS_MAP_DESC_ACCEPT);
DEBUGLOG(("AddAdjustmentType:: status_desc = [%s]\n", PD_STATUS_MAP_DESC_ACCEPT));

			} else if (i == 1) {

/* status */
                                PutField_Char(hTxnStatusMapRec, "status", PD_COMPLETE);
DEBUGLOG(("AddAdjustmentType:: status = [%c]\n", PD_COMPLETE));

/* ar_ind */
                                PutField_Char(hTxnStatusMapRec, "ar_ind", PD_REJECT);
DEBUGLOG(("AddAdjustmentType:: ar_ind = [%c]\n", PD_REJECT));

/* status_desc */
                                PutField_CString(hTxnStatusMapRec, "status_desc", PD_STATUS_MAP_DESC_DECLINED);
DEBUGLOG(("AddAdjustmentType:: status_desc = [%s]\n", PD_STATUS_MAP_DESC_DECLINED));
			
			} else if (i == 2) {

/* status */
                                PutField_Char(hTxnStatusMapRec, "status", PD_REVERSED);
DEBUGLOG(("AddAdjustmentType:: status = [%c]\n", PD_REVERSED));

/* ar_ind */
                                PutField_Char(hTxnStatusMapRec, "ar_ind", PD_ACCEPT);
DEBUGLOG(("AddAdjustmentType:: ar_ind = [%c]\n", PD_ACCEPT));

/* status_desc */
                                PutField_CString(hTxnStatusMapRec, "status_desc", PD_STATUS_MAP_DESC_ACCEPT);
DEBUGLOG(("AddAdjustmentType:: status_desc = [%s]\n", PD_STATUS_MAP_DESC_ACCEPT));

			}
	
			// Add Txn Status Map
DEBUGLOG(("AddAdjustmentType:: Call DBMmsDefTxnStatusMap Add\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBMmsDefTxnStatusMap","Add");
                        iDtlRet = (unsigned long)(*DBObjPtr)(hTxnStatusMapRec);
                        if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsDefTxnStatusMap:: Success!!!\n"));
                        } else {
                                iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsDefTxnStatusMap:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsDefTxnStatusMap:: Failure!!!\n");
                        }
		}

DEBUGLOG(("AddAdjustmentType: ===== Txn Status Map ===== End!!\n"));
	}

/*
 * Txn Sub Status Map
 */
       
	 if (iRet == PD_OK) {

DEBUGLOG(("AddAdjustmentType: ===== Txn Sub Status Map ===== Start!!\n"));

/* user */
               	PutField_CString(hTxnSubStatusMapRec, "create_user", csUser);
DEBUGLOG(("AddAdjustmentType:: create_user = [%s]\n",csUser));

/* txn_code */
            	PutField_CString(hTxnSubStatusMapRec, "txn_code", csCode);
DEBUGLOG(("AddAdjustmentType:: txn_code = [%s]\n", csCode));

/* sub_status */
                PutField_CString(hTxnSubStatusMapRec, "sub_status", PD_APPROVED);
DEBUGLOG(("AddAdjustmentType:: sub_status = [%s]\n", PD_APPROVED));

		// Add Txn Sub Status Map
DEBUGLOG(("AddAdjustmentType:: Call DBMmsDefTxnSubStatusMap Add\n"));
             	DBObjPtr = CreateObj(DBPtr, "DBMmsDefTxnSubStatusMap","Add");
               	iDtlRet = (unsigned long)(*DBObjPtr)(hTxnSubStatusMapRec);
            	if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsDefTxnSubStatusMap:: Success!!!\n"));
             	} else {
                   	iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                      	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsDefTxnSubStatusMap:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsDefTxnSubStatusMap:: Failure!!!\n");
             	}

DEBUGLOG(("AddAdjustmentType: ===== Txn Sub Status Map ===== End!!\n"));
	}

/*
 * Adjustment Type       
 */

	if (iRet == PD_OK) {

DEBUGLOG(("AddAdjustmentType: ===== Adjustment Type ===== Start!!\n"));

/* disabled */
		if (GetField_Int(hData,"disabled",&iTmp)) {
DEBUGLOG(("AddAdjustmentType: disabled = [%d]\n",iTmp));

        	} else {
DEBUGLOG(("AddAdjustmentType:: disabled missing!!\n"));
ERRLOG("BOMMSAdjustment:: AddAdjustmentType:: disabled missing!!\n");
                        iRet = INT_DISABLED_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
		}		

		// Find Adjustment Type
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType Find\n"));
       		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Find");
      		iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
       		if (iDtlRet == PD_FOUND) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Found!!!\n"));

/* disabled */
			if (GetField_Int(hFindRec,"disabled",&iTmp)) {	
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: disabled = [%d]\n", iTmp));
			}

			// Update Adjustment Type
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType Update\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Update");
                	iDtlRet = (unsigned long)(*DBObjPtr)(hData);
			if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));				
			} else {
				iRet = INT_ERR;
                        	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");		
			}
       		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
			
			// Add Adjustment Type
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType Add\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Add");
                        iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                        } else {
                                iRet = INT_ERR;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
       			}
		} else {
              		iRet = INT_ERR;
            		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
     		}

DEBUGLOG(("AddAdjustmentType: ===== Adjustment Type ===== End!!\n"));
	}

/*
 * Adjustment Type Entity
 */
		
	if (iRet == PD_OK) {

DEBUGLOG(("AddAdjustmentType: ===== Adjustment Type Entity ===== Start!!\n"));

/* etype_cnt */
        	if (GetField_Int(hData,"etype_cnt",&iEtypeCnt)) {
DEBUGLOG(("AddAdjustmentType: etype_cnt = [%d]\n",iEtypeCnt));
        	} else {
DEBUGLOG(("AddAdjustmentType:: etype_cnt missing!!\n"));
ERRLOG("TxnMmsByUsCEA:: Authorize:: etype_cnt missing!!\n");
        	        iRet = INT_MMS_ADJ_ETYPE_CNT_NOT_FOUND;
        	        PutField_Int(hContext,"internal_error",iRet);
        	}

		for (i=1; i<=iEtypeCnt; i++) {
/* et */
                    	sprintf(csTag,"etype.%d.et",i);
                        if (GetField_CString(hData,csTag,&csTmp)) {
DEBUGLOG(("AddAdjustmentType: etype.%d.et = [%s]\n",i,csTmp));
                		PutField_CString(hData,"entity_type",csTmp);
                		PutField_CString(hFindRec,"entity_type",csTmp);
			} else {
DEBUGLOG(("AddAdjustmentType:: et missing!!\n"));
ERRLOG("BOMMSAdjustment:: AddAdjustmentType:: et missing!!\n");
                		iRet = INT_MMS_ADJ_ETYPE_NOT_FOUND;
                		PutField_Int(hContext,"internal_error",iRet);
        		}

/* et_action */
			sprintf(csTag,"etype.%d.et_action",i);
                        if (GetField_Char(hData,csTag,&cETAction)) {
DEBUGLOG(("AddAdjustmentType: etype.%d.et_action = [%c]\n",i,cETAction));
				
				if (cETAction == PD_ACTION_ADD) {
					PutField_Int(hData,"disabled",0);
				} else if (cETAction == PD_ACTION_DELETE) {
					PutField_Int(hData,"disabled",1);
				}
                        } else {
DEBUGLOG(("AddAdjustmentType:: et_action missing!!\n"));
ERRLOG("BOMMSAdjustment:: AddAdjustmentType:: et_action missing!!\n");
                                iRet = INT_MMS_ADJ_ETYPE_ACTION_NOT_FOUND;
                                PutField_Int(hContext,"internal_error",iRet);
                        }

			if (iRet == PD_OK) {

                		// Find Adjustment Type Entity
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity Find\n"));
                		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Find");
                		iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
                		if (iDtlRet == PD_FOUND) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Found!!!\n"));

/* disabled */
                        		if (GetField_Int(hFindRec,"disabled",&iTmp)) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: disabled = [%d]\n", iTmp));
                        		}

					// Update Adjustment Type Entity
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity Update\n"));
                        		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Update");
                        		iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        		if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                        		} else {
                                		iRet = INT_ERR;
                                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
                        		}
                		} else if (iDtlRet == PD_NOT_FOUND) {		
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Not Found!!!\n"));

					// Add Adjustment Type Entity
					if (cETAction == PD_ACTION_ADD) {	
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity Add\n"));
                        			DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Add");
                        			iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        			if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                        			} else {
                                			iRet = INT_ERR;
                                			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
						}
					}
				} else {
                        		iRet = INT_ERR;
                        		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
                		}
			}
		}

DEBUGLOG(("AddAdjustmentType: ===== Adjustment Type Entity ===== End!!\n"));
	}	

	hash_destroy(hFindRec);
        FREE_ME(hFindRec);	

	hash_destroy(hTxnCodeRec);
        FREE_ME(hTxnCodeRec);
	
	hash_destroy(hTxnStatusMapRec);
        FREE_ME(hTxnStatusMapRec);

	hash_destroy(hTxnSubStatusMapRec);
        FREE_ME(hTxnSubStatusMapRec);
	
DEBUGLOG(("AddAdjustmentType() normal exit iRet = [%d]\n",iRet));
	return iRet;
}

int UpdateAdjustmentType (hash_t* hContext, hash_t* hData) 
{
	int     iRet = PD_OK;
        int     iDtlRet = PD_FOUND;
	int     iValidRet = PD_TRUE;

	int     iEtypeCnt = 0;
	int	iDisabled = 0;
        int     iTmp = 0;
	int	i = 0;

	char	cETAction;

	char*   csCode = NULL;
        char*   csUser = NULL;
        char*   csTmp = NULL;

	char    csDesc[PD_DESC_LEN + 1];
	char    csTag[PD_TAG_LEN + 1];

	hash_t  *hFindRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hFindRec,0);

	hash_t  *hAdjTypeRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hAdjTypeRec,0);

	hash_t  *hRuleTolLvlRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRuleTolLvlRec,0);

        hash_t  *hTxnCodeRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnCodeRec,0);

	cETAction = ' ';

DEBUGLOG(("UpdateAdjustmentType() Start!\n"));

/* code */
        if (GetField_CString(hData,"code",&csCode)) {
DEBUGLOG(("UpdateAdjustmentType: code = [%s]\n",csCode));
		PutField_CString(hFindRec, "code", csCode);
        } else {
DEBUGLOG(("UpdateAdjustmentType:: code missing!!\n"));
ERRLOG("BOMMSAdjustment:: UpdateAdjustmentType:: code missing!!\n");
                iRet = INT_MMS_ADJ_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* disabled */
      	if (GetField_Int(hData,"disabled",&iDisabled)) {
DEBUGLOG(("UpdateAdjustmentType:: disabled = [%d]\n", iDisabled));
       	 } else {
DEBUGLOG(("UpdateAdjustmentType:: disabled missing!!\n"));
ERRLOG("BOMMSAdjustment:: UpdateAdjustmentType:: disabled missing!!\n");
            	iRet = INT_DISABLED_NOT_FOUND;
           	PutField_Int(hContext,"internal_error",iRet);
	 }

/* user */
        if (GetField_CString(hData,"user",&csUser)) {
DEBUGLOG(("UpdateAdjustmentType: user = [%s]\n",csUser));
        } else {
DEBUGLOG(("UpdateAdjustmentType:: user missing!!\n"));
ERRLOG("TBOMMSAdjustment:: UpdateAdjustmentType:: user missing!!\n");
                iRet = INT_USER_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/*
 * Adjustment Type
 */

        if (iRet == PD_OK) {

DEBUGLOG(("UpdateAdjustmentType: ===== Adjustment Type ===== Start!!\n"));

		// Find Adjustment Type
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType Find\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Find");
                iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Found!!!\n"));

/* disabled */
                        if (GetField_Int(hFindRec,"disabled",&iTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: disabled = [%d]\n", iTmp));
                        }

			// Check Validate Process
			iValidRet = ValidateProcess(hData);
                        if (iValidRet == PD_FALSE) {
				
/* code */
                        	PutField_CString(hAdjTypeRec, "code", csCode);
DEBUGLOG(("UpdateAdjustmentType:: code = [%s]\n",csCode));

/* desc */
                		if (GetField_CString(hData, "desc", &csTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: desc = [%s]\n",csTmp));

					// Desc Prefix	
					if (strlen(PD_ADJ_DESC_PREFIX) + strlen(csTmp) > PD_DESC_LEN){
                        			iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        			PutField_Int(hContext,"internal_error",iRet);
                			} else {
                        			memset(csDesc, 0, sizeof(csDesc));
                        			strcpy(csDesc, PD_ADJ_DESC_PREFIX); // "Adjustment - "
                        			strncpy(&csDesc[strlen(PD_ADJ_DESC_PREFIX)], csTmp, PD_DESC_LEN - strlen(PD_ADJ_DESC_PREFIX));
                       	 			PutField_CString(hAdjTypeRec, "desc", csDesc);
                			}
               	 		}				

/* disabled */
				PutField_Int(hAdjTypeRec, "disabled", iDisabled);
DEBUGLOG(("UpdateAdjustmentType:: disabled = [%d]\n",iDisabled));

/* user */			
                               	PutField_CString(hAdjTypeRec, "update_user", csUser);
DEBUGLOG(("UpdateAdjustmentType:: update_user = [%s]\n",csTmp));
	
				// Update Adjustment Type (Desc Only)
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType Update (Desc Only)\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Update");
                                iDtlRet = (unsigned long)(*DBObjPtr)(hAdjTypeRec);
                                if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                                } else {
                                        iRet = INT_ERR;
                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
                                }				
			} else if (iValidRet == PD_TRUE) {
	
/* desc */
                                if (GetField_CString(hData, "desc", &csTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: desc = [%s]\n",csTmp));

					// Desc Prefix
					if (strlen(PD_ADJ_DESC_PREFIX) + strlen(csTmp) > PD_DESC_LEN){
                                                iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                                PutField_Int(hContext,"internal_error",iRet);
                                        } else {
                                                memset(csDesc, 0, sizeof(csDesc));
                                                strcpy(csDesc, PD_ADJ_DESC_PREFIX); // "Adjustment - "
                                                strncpy(&csDesc[strlen(PD_ADJ_DESC_PREFIX)], csTmp, PD_DESC_LEN - strlen(PD_ADJ_DESC_PREFIX));
                                                PutField_CString(hData, "desc", csDesc);
DEBUGLOG(("UpdateAdjustmentType:: desc (with Prefix) = [%s]\n",csDesc));
                                        }
				}
	
				// Update Adjustment Type
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType Update\n"));
                        	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Update");
                        	iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        	if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                        	} else {
                        	        iRet = INT_ERR;
                        	        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
                        	}
			} else {
				iRet = iDtlRet;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
			}	
		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
			iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Not Found!!!\n");
		} else {
			iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");	
		}

DEBUGLOG(("UpdateAdjustmentType: ===== Adjustment Type ===== End!!\n"));
	}

/*
 * Adjustment Type Entity
 */

	if ((iRet == PD_OK) && (iValidRet == PD_TRUE)) {

DEBUGLOG(("UpdateAdjustmentType: ===== Adjustment Type Entity ===== Start!!\n"));

/* etype_cnt */
                if (GetField_Int(hData,"etype_cnt",&iEtypeCnt)) {
DEBUGLOG(("UpdateAdjustmentType: etype_cnt = [%d]\n",iEtypeCnt));
                } else {
DEBUGLOG(("UpdateAdjustmentType:: etype_cnt missing!!\n"));
ERRLOG("BOMMSAdjustment:: UpdateAdjustmentType:: etype_cnt missing!!\n");
                        iRet = INT_MMS_ADJ_ETYPE_CNT_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
                }

		for (i=1; i<=iEtypeCnt; i++) {
/* et */
                        sprintf(csTag,"etype.%d.et",i);
                        if (GetField_CString(hData,csTag,&csTmp)) {
DEBUGLOG(("UpdateAdjustmentType: etype.%d.et = [%s]\n",i,csTmp));
                                PutField_CString(hData,"entity_type",csTmp);
                		PutField_CString(hFindRec,"entity_type",csTmp);
                        }

/* et_action */
                        sprintf(csTag,"etype.%d.et_action",i);
                        if (GetField_Char(hData,csTag,&cETAction)) {
DEBUGLOG(("UpdateAdjustmentType: etype.%d.et_action = [%c]\n",i,cETAction));

                                if (cETAction == PD_ACTION_ADD) {
                                        PutField_Int(hData,"disabled",0);
                                } else if (cETAction == PD_ACTION_DELETE) {
                                        PutField_Int(hData,"disabled",1);
                                }
                        }

			if (iRet == PD_OK) {

				// Find Adjustment Type Entity
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity Find\n"));
                		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Find");
                		iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
                		if (iDtlRet == PD_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Found!!!\n"));

/* disabled */
                        		if (GetField_Int(hFindRec,"disabled",&iTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: disabled = [%d]\n", iTmp));
                        		}

					// Update Adjustment Type Entity
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity Update\n"));
                        		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Update");
                        		iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        		if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                        		} else {
                                		iRet = INT_ERR;
                                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
                        		}
                		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Not Found!!!\n"));

					// Add Adjustment Type Entity
                                        if (cETAction == PD_ACTION_ADD) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity Add\n"));
                                                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Add");
                                                iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                                                if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                                                } else {
                                                        iRet = INT_ERR;
                                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
						}
 					}                                         
                		} else {
                        		iRet = INT_ERR;
                        		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Error!!!\n");
                		}
			}
		}		

DEBUGLOG(("UpdateAdjustmentType: ===== Adjustment Type Entity ===== End!!\n"));
	}

/*
 * Rule Tolerance Level
 */

        if (iRet == PD_OK) {

DEBUGLOG(("UpdateAdjustmentType: ===== Rule Tolerance Level ===== Start!!\n"));

		// Find Txn Code
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsRuleToleranceLevel FindTxnCode\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsRuleToleranceLevel","FindTxnCode");
                iDtlRet = (unsigned long)(*DBObjPtr)(csCode);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsRuleToleranceLevel:: Found!!!\n"));

/* txn_code */
                	PutField_CString(hRuleTolLvlRec, "txn_code", csCode);
DEBUGLOG(("UpdateAdjustmentType:: txn_code = [%s]\n",csCode));

/* disabled */
			PutField_Int(hRuleTolLvlRec,"disabled",iDisabled);
DEBUGLOG(("UpdateAdjustmentType:: disabled = [%d]\n", iDisabled));

/* update_user */
			PutField_CString(hRuleTolLvlRec, "update_user", csUser);
DEBUGLOG(("UpdateAdjustmentType:: update_user = [%s]\n",csUser));

			// Update Rule Tolerance Level Disabled
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsRuleToleranceLevel UpdateDisabledByTxnCode\n"));
                     	DBObjPtr = CreateObj(DBPtr, "DBMmsRuleToleranceLevel","UpdateDisabledByTxnCode");
                       	iDtlRet = (unsigned long)(*DBObjPtr)(hRuleTolLvlRec);
                    	if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsRuleToleranceLevel:: Success!!!\n"));
                    	} else {
                            	iRet = INT_ERR;
                          	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsRuleToleranceLevel:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsRuleToleranceLevel:: Failure!!!\n");
                   	}
		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsRuleToleranceLevel:: Not Found!!!\n"));
/*
			iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsRuleToleranceLevel:: Not Found!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsRuleToleranceLevel:: Not Found!!!\n");
*/
		} else {
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsRuleToleranceLevel:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsRuleToleranceLevel:: Error!!!\n");
                }			
		
DEBUGLOG(("UpdateAdjustmentType: ===== Rule Tolerance Level ===== End!!\n"));
	}

/*
 * Txn Code (Foreign Key)
 */

        if (iRet == PD_OK) {

DEBUGLOG(("UpdateAdjustmentType: ===== Txn Code ===== Start!!\n"));

/* txn_code */
               	PutField_CString(hTxnCodeRec, "txn_code", csCode);
DEBUGLOG(("UpdateAdjustmentType:: txn_code = [%s]\n",csCode));

/* txn_desc */
               	PutField_CString(hTxnCodeRec, "txn_desc", csDesc);
DEBUGLOG(("UpdateAdjustmentType:: desc = [%s]\n",csDesc));

/* process_type */
                PutField_CString(hTxnCodeRec, "process_type", PD_PROCESS_TYPE_DEF);
DEBUGLOG(("UpdateAdjustmentType:: process_type = [%s]\n",PD_PROCESS_TYPE_DEF));

/* process_code */
                PutField_CString(hTxnCodeRec, "process_code", PD_PROCESS_CODE_DEF);
DEBUGLOG(("UpdateAdjustmentType:: process_code = [%s]\n",PD_PROCESS_CODE_DEF));

/* update_user */
            PutField_CString(hTxnCodeRec, "update_user", csUser);
DEBUGLOG(("UpdateAdjustmentType:: update_user = [%s]\n",csUser));
		
		// Find Txn Code
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode Find\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Find");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                if (iDtlRet == FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode:: Found!!!\n"));

			// Update Txn Code
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode Update\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Update");
                	iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                	if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode:: Success!!!\n"));
                	} else {
                        	iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                	}
                } else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode:: Not Found!!!\n"));
			
			iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode:: Not Found!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsTxnCode:: Not Found!!!\n");
                } else {
                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                }

DEBUGLOG(("UpdateAdjustmentType: ===== Txn Code ===== End!!\n"));
        }

	hash_destroy(hFindRec);
        FREE_ME(hFindRec);

	hash_destroy(hRuleTolLvlRec);
        FREE_ME(hRuleTolLvlRec);

	hash_destroy(hAdjTypeRec);
        FREE_ME(hAdjTypeRec);

	hash_destroy(hTxnCodeRec);
        FREE_ME(hTxnCodeRec);

DEBUGLOG(("UpdateAdjustmentType() normal exit iRet = [%d]\n",iRet));
	return iRet;
}

int DeleteAdjustmentType (hash_t* hContext, hash_t* hData)
{
        int     iRet = PD_OK;
        int     iDtlRet = PD_FOUND;
	int	iValidRet = PD_TRUE;

        int     iTmp = 0;

	char*	csCode = NULL;
	char*	csUser = NULL;
        char*   csTmp = NULL;

	hash_t  *hFindRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hFindRec,0);

	hash_t  *hRuleTolLvlRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRuleTolLvlRec,0);	

        hash_t  *hTxnCodeRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnCodeRec,0);

	hash_t  *hTxnStatusMapRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnStatusMapRec,0);

	hash_t  *hTxnSubStatusMapRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnSubStatusMapRec,0);

	//hash_t  *hRec = NULL;
	recordset_t	*rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
	
DEBUGLOG(("DeleteAdjustmentType() Start!\n"));

/* code */
        if (GetField_CString(hData,"code",&csCode)) {
DEBUGLOG(("DeleteAdjustmentType: code = [%s]\n",csCode));
		PutField_CString(hFindRec,"code",csCode);
        } else {
DEBUGLOG(("DeleteAdjustmentType:: code missing!!\n"));
ERRLOG("BOMMSAdjustment:: DeleteAdjustmentType:: code missing!!\n");
                iRet = INT_MMS_ADJ_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* user */
        if (GetField_CString(hData,"user",&csUser)) {
DEBUGLOG(("DeleteAdjustmentType: user = [%s]\n",csUser));
        } else {
DEBUGLOG(("DeleteAdjustmentType:: user missing!!\n"));
ERRLOG("TBOMMSAdjustment:: DeleteAdjustmentType:: user missing!!\n");
                iRet = INT_USER_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/*
 * Adjustment Type
 */	

	if (iRet == PD_OK) {

DEBUGLOG(("DeleteAdjustmentType: ===== Adjustment Type ===== Start!!\n"));

		// Find Adjustment Type
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType Find\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Find");
                iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Found!!!\n"));

/* disabled */
                   	if (GetField_Int(hFindRec,"disabled",&iTmp)) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: disabled = [%d]\n", iTmp));
                      	}

			// Check Validate Process
			iValidRet = ValidateProcess(hData);
			if (iValidRet == PD_FALSE) {

/* disabled */
				PutField_Int(hData,"disabled",1);

                	        // Update Adjustment Type (Disabled)
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType Update\n"));
                        	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Update");
                        	iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        	if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                        	} else {
                        	        iRet = INT_ERR;
                        	        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
                        	}
			} else if (iValidRet == PD_TRUE) {

				// Delete Adjustment Type
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType Delete\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Delete");
                                iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                                if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                                } else {
                                        iRet = INT_ERR;
                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
                                }
			} else {
				iRet = iDtlRet;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
			}
                } else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Not Found!!!\n");
                } else {
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
                }

DEBUGLOG(("DeleteAdjustmentType: ===== Adjustment Type ===== End!!\n"));
	}

/*
 * Adjustment Type Entity
 */

	if (iRet == PD_OK) {

DEBUGLOG(("DeleteAdjustmentType: ===== Adjustment Type Entity ===== Start!!\n"));

		// Find All djustment Type Entity Type
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity FindEntityType\n"));
               	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","FindEntityType");
                iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec,rRecordSet);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Found!!!\n"));

			if (iValidRet == PD_TRUE) {
		
				// Delete Adjustment Type Entity
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity Delete\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Delete");
                                iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                                if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                                } else {
                                        iRet = INT_ERR;
                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
                                }
			} else if (iValidRet == PD_FALSE) {
/*
				hRec = RecordSet_GetFirst(rRecordSet);
                        	while (hRec) {

// adj_entity_type
					if (GetField_CString(hRec,"adj_entity_type",&csTmp)) {
DEBUGLOG(("DeleteAdjustmentType: adj_entity_type = [%s]\n",csTmp));
                                	        PutField_CString(hData,"adj_entity_type",csTmp);					 
					}

// disabled
					PutField_Int(hData,"disabled",1);

					// Update Adjustment Type Entity (Disabled)
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity Update\n"));
                     			DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Update");
                    			iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                     			if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                      			} else {
                             			iRet = INT_ERR;
                             			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
                    			}	
				
					hRec = RecordSet_GetNext(rRecordSet);
				}
*/
			}
		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
/*
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Not Found!!!\n");
*/  
              	} else {
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
                }

DEBUGLOG(("DeleteAdjustmentType: ===== Adjustment Type Entity ===== End!!\n"));
        }

/*
 * Rule Tolerance Level
 */

	if (iRet == PD_OK) {

DEBUGLOG(("DeleteAdjustmentType: ===== Rule Tolerance Level ===== Start!!\n"));

/* txn_code */
               	PutField_CString(hRuleTolLvlRec, "txn_code", csCode);
DEBUGLOG(("DeleteAdjustmentType:: txn_code = [%s]\n",csCode));

		// Find Txn Code
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsRuleToleranceLevel FindTxnCode\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsRuleToleranceLevel","FindTxnCode");
                iDtlRet = (unsigned long)(*DBObjPtr)(csCode);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsRuleToleranceLevel:: Found!!!\n"));

			if (iValidRet == PD_TRUE) {

				// Delete Rule Tolerance Level
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsRuleToleranceLevel DeleteByTxnCode\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBMmsRuleToleranceLevel","DeleteByTxnCode");
                                iDtlRet = (unsigned long)(*DBObjPtr)(hRuleTolLvlRec);
                                if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsRuleToleranceLevel:: Success!!!\n"));
                                } else {
                                        iRet = INT_ERR;
                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsRuleToleranceLevel:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsRuleToleranceLevel:: Failure!!!\n");
                                }
			} else if (iValidRet == PD_FALSE) {	

/* disabled */
                              	PutField_Int(hRuleTolLvlRec,"disabled",1);
DEBUGLOG(("DeleteAdjustmentType:: disabled = [1]\n"));

/* update_user */
				 PutField_CString(hRuleTolLvlRec, "update_user", csUser);
DEBUGLOG(("DeleteAdjustmentType:: update_user = [%s]\n",csUser));

                                // Update Rule Tolerance Level Disabled
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsRuleToleranceLevel UpdateDisabledByTxnCode\n"));
                             	DBObjPtr = CreateObj(DBPtr, "DBMmsRuleToleranceLevel","UpdateDisabledByTxnCode");
                            	iDtlRet = (unsigned long)(*DBObjPtr)(hRuleTolLvlRec);
                            	if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsRuleToleranceLevel:: Success!!!\n"));
                            	} else {
                                    	iRet = INT_ERR;
                                    	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsRuleToleranceLevel:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsRuleToleranceLevel:: Failure!!!\n");
                         	}
			}
		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsRuleToleranceLevel:: Not Found!!!\n"));
/*
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsRuleToleranceLevel:: Not Found!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsRuleToleranceLevel:: Not Found!!!\n");
*/
                } else {
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsRuleToleranceLevel:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsRuleToleranceLevel:: Error!!!\n");
                }
	
DEBUGLOG(("DeleteAdjustmentType: ===== Rule Tolerance Level ===== End!!\n"));
	}

/*
 * Txn Status Map
 */

	if ((iRet == PD_OK) && (iValidRet == PD_TRUE)) {	

DEBUGLOG(("DeleteAdjustmentType: ===== Txn Status Map ===== Start!!\n"));

/* txn_code */
            	PutField_CString(hTxnStatusMapRec, "txn_code", csCode);
DEBUGLOG(("DeleteAdjustmentType:: txn_code = [%s]\n", csCode));

		// Delete Txn Status Map
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnStatusMap Delete\n"));
            	DBObjPtr = CreateObj(DBPtr, "DBMmsDefTxnStatusMap","Delete");
             	iDtlRet = (unsigned long)(*DBObjPtr)(hTxnStatusMapRec);
            	if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnStatusMap:: Success!!!\n"));
           	} else {
                   	iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                     	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnStatusMap:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsDefTxnStatusMap:: Failure!!!\n");
             	}

DEBUGLOG(("DeleteAdjustmentType: ===== Txn Status Map ===== End!!\n"));
	}

/*
 * Txn Sub Status Map
 */

	if ((iRet == PD_OK) && (iValidRet == PD_TRUE)) {

DEBUGLOG(("DeleteAdjustmentType: ===== Txn Sub Status Map ===== Start!!\n"));

/* txn_code */
                PutField_CString(hTxnSubStatusMapRec, "txn_code", csCode);
DEBUGLOG(("DeleteAdjustmentType:: txn_code = [%s]\n", csCode));

		// Delete Txn Status Map
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnSubStatusMap Delete\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsDefTxnSubStatusMap","Delete");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTxnSubStatusMapRec);
                if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnSubStatusMap:: Success!!!\n"));
                } else {
                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnSubStatusMap:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsDefTxnSubStatusMap:: Failure!!!\n");
                }	

DEBUGLOG(("DeleteAdjustmentType: ===== Txn Sub Status Map ===== End!!\n"));
        }

/*
 * Txn Code (Foreign Key)
 */

	if ((iRet == PD_OK) && (iValidRet == PD_TRUE)) {

DEBUGLOG(("DeleteAdjustmentType: ===== Txn Code ===== Start!!\n"));

/* txn_code */
                PutField_CString(hTxnCodeRec, "txn_code", csCode);
DEBUGLOG(("DeleteAdjustmentType:: txn_code = [%s]\n",csCode));


/* txn_desc */
                if (GetField_CString(hData, "desc", &csTmp)) {
DEBUGLOG(("DeleteAdjustmentType:: desc = [%s]\n",csTmp));
                        PutField_CString(hTxnCodeRec, "txn_desc", csTmp);
                }

/* process_type */
                PutField_CString(hTxnCodeRec, "process_type", PD_PROCESS_TYPE_DEF);
DEBUGLOG(("DeleteAdjustmentType:: process_type = [%s]\n",PD_PROCESS_TYPE_DEF));


/* process_code */
                PutField_CString(hTxnCodeRec, "process_code", PD_PROCESS_CODE_DEF);
DEBUGLOG(("DeleteAdjustmentType:: process_code = [%s]\n",PD_PROCESS_CODE_DEF));

		// Find Txn Code
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode Find\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Find");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                if (iDtlRet == FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Found!!!\n"));

			// Delete Txn Code
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode Delete\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Delete");
                        iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                        if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Success!!!\n"));
                        } else {
                                iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                        }
                } else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Not Found!!!\n"));

                } else {
                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                }

DEBUGLOG(("DeleteAdjustmentType: ===== Txn Code ===== End!!\n"));
        }		

	hash_destroy(hFindRec);
        FREE_ME(hFindRec);

	hash_destroy(hRuleTolLvlRec);
        FREE_ME(hRuleTolLvlRec);

	hash_destroy(hTxnCodeRec);
        FREE_ME(hTxnCodeRec);

	hash_destroy(hTxnStatusMapRec);
        FREE_ME(hTxnStatusMapRec);

	hash_destroy(hTxnSubStatusMapRec);
        FREE_ME(hTxnSubStatusMapRec);

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("DeleteAdjustmentType() normal exit iRet = [%d]\n",iRet));
        return iRet;
}

int ProcessEntityNatureBalance(hash_t* hContext, hash_t* hData)
{
	int 	iRet = PD_OK;

	int     iDisabled = PD_DISABLED;
	int     iAllowBalNegative = PD_FALSE;
        int     iAllowModify = PD_FALSE;
	int	iSystemDefined = PD_FALSE;

	double	dTxnAmt = 0.0;
	double	dNetAmt = 0.0;

	char	cBalType;
	char	cNature;

	char	*csCode = NULL;
	char    *csCountry = NULL;
        char    *csCcy = NULL;
	char	*csUser = NULL;
	char    *csAmtType = NULL;

	hash_t  *hRec;
        hRec = (hash_t *)malloc(sizeof(hash_t));
        hash_init(hRec, 0);

	hash_t  *hInRec;
        hInRec = (hash_t *)malloc(sizeof(hash_t));
        hash_init(hInRec, 0);

	cBalType = ' ';
	cNature = ' ';

DEBUGLOG(("ProcessEntityNatureBalance() Start!\n"));

/* code */
        if (GetField_CString(hData,"code",&csCode)) {
DEBUGLOG(("ProcessEntityNatureBalance: code = [%s]\n",csCode));
        } else {
DEBUGLOG(("ProcessEntityNatureBalance:: code missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: code missing!!\n");
                iRet = INT_MMS_ADJ_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_country */
        if (GetField_CString(hData,"txn_country",&csCountry)) {
DEBUGLOG(("ProcessEntityNatureBalance: txn_country = [%s]\n",csCountry));
        } else {
DEBUGLOG(("ProcessEntityNatureBalance:: txn_country missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: txn_country missing!!\n");
                iRet = INT_MMS_COUNTRY_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_ccy */
        if (GetField_CString(hData,"txn_ccy",&csCcy)) {
DEBUGLOG(("ProcessEntityNatureBalance: txn_ccy = [%s]\n",csCcy));
        } else {
DEBUGLOG(("ProcessEntityNatureBalance:: txn_ccy missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: txn_ccy missing!!\n");
                iRet = INT_MMS_CCY_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_amt */
	if (GetField_Double(hData,"txn_amt",&dTxnAmt)) {
DEBUGLOG(("ProcessEntityNatureBalance: txn_amt = [%.2lf]\n",dTxnAmt));
        } else {
DEBUGLOG(("ProcessEntityNatureBalance:: txn_amt missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: txn_amt missing!!\n");
                iRet = INT_MMS_ADJ_AMT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* user */
        if(GetField_CString(hData,"user",&csUser)) {
DEBUGLOG(("ProcessEntityNatureBalance: user = [%s]\n",csUser));
        } else {
DEBUGLOG(("ProcessEntityNatureBalance:: user missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: user missing!!\n");
                iRet = INT_USER_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
	}

	// Get Adjustment Type
	if (iRet == PD_OK) {
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsAdjustmentType:GetAdjustmentTypeRec\n"));

                DBObjPtr = CreateObj(DBPtr,"DBMmsAdjustmentType","GetAdjustmentTypeRec");
                iRet = (unsigned long)(*DBObjPtr)(csCode, hRec);
                if (iRet == PD_OK) {

			if (GetField_Char(hRec, "nature", &cNature)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::nature = [%c]\n", cNature));
                        }

			if (GetField_Char(hRec, "bal_type", &cBalType)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::bal_type = [%c]\n", cBalType));
                        }

			if (GetField_CString(hRec, "amt_type", &csAmtType)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::amt_type = [%s]\n", csAmtType));
                        }			

			if (GetField_Int(hRec, "system_defined", &iSystemDefined)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::system_defined = [%d]\n", iSystemDefined));
                        }

                        if (GetField_Int(hRec, "allow_modify", &iAllowModify)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::allow_modify = [%d]\n", iAllowModify));
                        }

                        if (GetField_Int(hRec, "allow_bal_neg", &iAllowBalNegative)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::allow_bal_neg = [%d]\n", iAllowBalNegative));
                        }

                        if (GetField_Int(hRec, "disabled", &iDisabled)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::disabled = [%d]\n",iDisabled));

                                if (iDisabled == PD_DISABLED) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::not allow to use the code\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::GetAdjustmentTypeRec:: code in disabled!!\n");
                                        iRet = INT_CODE_DISABLED;
                                        PutField_Int(hContext, "internal_error", iRet);
                                }
                        }

                } else {
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsAdjustmentType:GetOLAdjustmentTypeRec:: Failure!!\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::Call DBMmsAdjustmentType::GetAdjustmentTypeRec:: Failure!!\n");
                        iRet = PD_ERR;
                        PutField_Int(hContext, "internal_error", iRet);
                }		
	}	
	
	// Update Entity Balance
	if (iRet == PD_OK) {

/* country */
		PutField_CString(hInRec,"country",csCountry);		
DEBUGLOG(("ProcessEntityNatureBalance:: country = [%s]\n",csCountry));

/* ccy */
		PutField_CString(hInRec,"ccy",csCcy);		
DEBUGLOG(("ProcessEntityNatureBalance:: ccy = [%s]\n",csCcy));

/* amt_type */
		PutField_CString(hContext,"amt_type",csAmtType); 	
DEBUGLOG(("ProcessEntityNatureBalance:: amt_type = [%s]\n",csAmtType));

/* bal_amt */
		if (cBalType == PD_MMS_BAL_TYPE_ACCT_BAL) {
			PutField_CString(hContext,"bal_amt","acct_bal"); 	
DEBUGLOG(("ProcessEntityNatureBalance:: bal_amt = [acct_bal]\n"));
		} else if (cBalType == PD_MMS_BAL_TYPE_INTRANSIT) {
                        PutField_CString(hContext,"bal_amt","intransit"); 
DEBUGLOG(("ProcessEntityNatureBalance:: bal_amt = [intransit]\n"));
		} else if (cBalType == PD_MMS_BAL_TYPE_LIEN) {
                        PutField_CString(hContext,"bal_amt","lien");
DEBUGLOG(("ProcessEntityNatureBalance:: bal_amt = [lien]\n"));
		} else if (cBalType == PD_MMS_BAL_TYPE_PREPAID) {
                        PutField_CString(hContext,"bal_amt","prepaid");
DEBUGLOG(("ProcessEntityNatureBalance:: bal_amt = [prepaid]\n"));
		}

/* txn_amt */
                PutField_Double(hContext,"txn_amt",dTxnAmt);
DEBUGLOG(("ProcessEntityNatureBalance:: txn_amt = [%.2lf]\n",dTxnAmt));

/* net_amt */
		dNetAmt = dTxnAmt;
		PutField_Double(hContext,"net_amt",dNetAmt);
DEBUGLOG(("ProcessEntityNatureBalance:: net_amt = [%.2lf]\n",dNetAmt));		

/* update_user */
		PutField_CString(hInRec,"update_user",csUser);		
DEBUGLOG(("ProcessEntityNatureBalance:: update_user = [%s]\n",csUser));
	
		// Update Entity Nature Balance
DEBUGLOG(("ProcessEntityNatureBalance::Call BOMMSEntityBalance:UpdateEntityNatureBalance\n"));
            	BOObjPtr = CreateObj(BOPtr,"BOMMSEntityBalance","UpdateEntityNatureBalance");
            	iRet = (unsigned long)(*BOObjPtr)(hContext, hInRec);
		if (iRet == PD_OK) {
DEBUGLOG(("ProcessEntityNatureBalance::call BOMMSEntityBalance:UpdateEntityNatureBalance Success!!\n"));
		} else {
DEBUGLOG(("ProcessEntityNatureBalance::call BOMMSEntityBalance:UpdateEntityNatureBalance Failure!!\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::call BOMMSEntityBalance:UpdateEntityNatureBalance Failure!!\n");
                   	iRet=INT_ERR;
           	}
        }	

	// FX Pool
	if (iRet == PD_OK) {
	
		// TBD...
	}

	hash_destroy(hRec);
	FREE_ME(hRec);

	hash_destroy(hInRec);
        FREE_ME(hInRec);

DEBUGLOG(("ProcessEntityNatureBalance() normal exit iRet = [%d]\n",iRet));
        return iRet;
}

