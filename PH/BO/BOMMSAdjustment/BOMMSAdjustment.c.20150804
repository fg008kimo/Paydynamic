/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/06/25              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOMMSAdjustment.h"

char    cDebug;

OBJPTR(DB);
OBJPTR(BO);

void BOMMSAdjustment(char    cdebug)
{
        cDebug = cdebug;
}

int GetCurrentCode(hash_t *hRec)
{
        int     iRet = PD_OK;

        int     iMaxCodeInNum = -1;

DEBUGLOG(("GetCurrentCode:: Call DBMmsAdjustmentType: GetMaxCode\n"));
        DBObjPtr = CreateObj(DBPtr,"DBMmsAdjustmentType","GetMaxCode");
        iRet = (unsigned long)((*DBObjPtr)(&iMaxCodeInNum));
	if (iRet == PD_OK) {
DEBUGLOG(("GetCurrentCode:: GetMaxCode:: current max_code_in_num [%d]\n", iMaxCodeInNum));

                /* No Current Code Found */
                if (iMaxCodeInNum < 0) {
                        iMaxCodeInNum = 0;
                } else {
                        iMaxCodeInNum++;

                        if (iMaxCodeInNum > PD_ADJ_TYPE_MAX_CODE) {
                                /* handle over 99 later */
                                iRet = INT_ADJ_TYPE_MAX_CODE_INVALID;
                        }
                }

                PutField_Int(hRec, "code_in_num", iMaxCodeInNum);
DEBUGLOG(("GetCurrentCode:: GetMaxCode:: assigned max_code_in_num [%d]\n", iMaxCodeInNum));
        } else {
DEBUGLOG(("GetCurrentCode:: Call DBMmsAdjustmentType: GetMaxCode not found\n"));
//ERRLOG("BOMMSAdjustment::GetCurrentCode::Call DBMmsAdjustmentType::GetMaxCode not found!!\n");
                iRet = INT_CODE_ERROR;
        }

DEBUGLOG(("GetCurrentCode:: return iRet [%d]\n", iRet));
        return  iRet;
}

int ValidateProcess(hash_t* hRec)
{
	int     iRet = PD_OK;
        int     iDtlRet = PD_OK;

        //int     iCodeInNum;
        int     iCurrentDisabled;
        int     iCurrentAllowModify;

        char    *csCode = NULL;

	hash_t  *hCurrAdjRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hCurrAdjRec,0);

/* code */
        if (GetField_CString(hRec,"code",&csCode)) {
DEBUGLOG(("ValidateProcess: code = [%s]\n",csCode));
        } else {
DEBUGLOG(("ValidateProcess:: code missing!!\n"));
//ERRLOG("BOMMSAdjustment:: ValidateProcess:: code missing!!\n");
                iRet = INT_MMS_TXN_CODE_NOT_FOUND;
	}

/* code_in_num */
/*
        if (GetField_Int(hRec,"code_in_num",&iCodeInNum)) {
DEBUGLOG(("ValidateProcess: code_in_num = [%d]\n",iCodeInNum));
        } else {
DEBUGLOG(("ValidateProcess:: code_in_num missing!!\n"));
//ERRLOG("BOMMSAdjustment:: ValidateProcess:: code_in_num missing!!\n");
                iRet = INT_MMS_TXN_CODE_NOT_FOUND;
        }
*/

	if (iRet == PD_OK) {

		// Get MMS Adjustment Type Record
DEBUGLOG(("ValidateProcess:: Call DBMmsAdjustmentType GetAdjustmentTypeRec\n"));
           	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","GetAdjustmentTypeRec");
             	iDtlRet = (unsigned long)(*DBObjPtr)(csCode,hCurrAdjRec);
              	if (iDtlRet == PD_OK) {
DEBUGLOG(("ValidateProcess:: Call DBMmsAdjustmentType:: Success!!!\n"));
		
/* disabled */
			if (GetField_Int(hCurrAdjRec, "disabled", &iCurrentDisabled)) {
DEBUGLOG(("ValidateProcess:: GetAdjustmentTypeRec:: disabled = [%d]\n",iCurrentDisabled));
			}

/* allow_modify */
			if (GetField_Int(hCurrAdjRec, "allow_modify", &iCurrentAllowModify)) {
DEBUGLOG(("ValidateProcess:: GetAdjustmentTypeRec:: allow_modify = [%d]\n",iCurrentAllowModify));

				if (iCurrentAllowModify != PD_TRUE) {
					iRet = INT_MMS_ADJ_TYPE_NOT_ALLOW_MODIFY;
				}
                       	}
           	} else {
                    	iRet = INT_ERR;
DEBUGLOG(("ValidateProcess:: Call DBMmsAdjustmentType:: Failure!!!\n"));
//ERRLOG("BOMMSAdjustment::ValidateProcess::Call DBMmsAdjustmentType:: Failure!!!\n");
           	}

		// Check Record Exists
		if (iRet == PD_OK) {
				
DEBUGLOG(("ValidateProcess:: Call DBMmsTransaction: ChkTxnCodeExist\n"));
                    	DBObjPtr = CreateObj(DBPtr,"DBMmsTransaction","ChkTxnCodeExist");
                    	iDtlRet = (unsigned long)(*DBObjPtr)(csCode);
                    	if (iDtlRet == PD_FOUND) {
DEBUGLOG(("ValidateProcess:: Call DBMmsTransaction: ChkTxnCodeExist: FOUND\n"));

                               	iRet = PD_FALSE;
                    	} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("ValidateProcess:: Call DBMmsTransaction: ChkTxnCodeExist: NOT FOUND\n"));
				
				iRet = PD_TRUE;
                    	} else {
DEBUGLOG(("ValidateProcess:: Call DBMmsTransaction: ChkTxnCodeExist: ERR\n"));
//ERRLOG("BOOLAdjustment:: ValidateProcess:: Call DBMmsTransaction: ChkTxnCode Exist :: Error!!\n");
                            	iRet = INT_ERR;
                     	}
		}
	}

	hash_destroy(hCurrAdjRec);
        FREE_ME(hCurrAdjRec);

DEBUGLOG(("ValidateProcess() normal exit iRet = [%d]\n",iRet));
        return iRet;
}

int AddAdjustmentType (hash_t* hContext, hash_t* hData)
{
	int	iRet = PD_OK;
	int	iDtlRet = PD_FOUND;

	int	iCurrentCode = 0;
	int	iDisabled = 0;
	int	iEtypeCnt = 0;
	int	iTxnStatusMapCnt = 3;	
	int	iTmp = 0;
	int	i = 0;

	char	cETAction;	

	char*	csUser = NULL;
	char*	csTmp = NULL;

	char	csCode[PD_TXN_CODE_LEN + 1];
	char	csDesc[PD_DESC_LEN + 1];	
	char    csTag[PD_TAG_LEN + 1];

	hash_t  *hFindRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hFindRec,0);

	hash_t  *hTxnCodeRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnCodeRec,0);

	hash_t  *hTxnStatusMapRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnStatusMapRec,0);

	hash_t  *hTxnSubStatusMapRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnSubStatusMapRec,0);

	cETAction = ' ';

DEBUGLOG(("AddAdjustmentType() Start!\n"));

/* code */
        if (GetField_CString(hData,"code",&csTmp)) {
DEBUGLOG(("AddAdjustmentType: code = [%s]\n",csTmp));
		PutField_CString(hFindRec, "code", csTmp);
	
		iCurrentCode = atoi(csTmp + 1);
                PutField_Int(hData, "code_in_num", iCurrentCode);

DEBUGLOG(("AddAdjustmentType: CurrentCodeInNum = [%d]\n",iCurrentCode));
        } else {

		// Get Current Code
		iRet = GetCurrentCode(hData);
		if (iRet == PD_OK) {
			if (GetField_Int(hData, "code_in_num", &iCurrentCode)) {
                		PutField_Int(hData, "code_in_num", iCurrentCode);
DEBUGLOG(("AddAdjustmentType: CurrentCodeInNum [%d]\n", iCurrentCode));
				
				sprintf(csCode, "%c%02d", PD_MMS_ADJ_TXN_CODE_PREFIX, iCurrentCode); // 's'
DEBUGLOG(("AddAdjustmentType: CurrentCode [%s]\n", csCode));

                                PutField_CString(hData, "code", csCode);
                                PutField_CString(hFindRec, "code", csCode);
			}		
		} else {
DEBUGLOG(("AddAdjustmentType:: Get code Failure!!\n"));
ERRLOG("BOMMSAdjustment:: AddAdjustmentType:: Get code Failure!!\n");
                        //iRet = INT_CODE_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
                }
	}

/* desc */
	if (GetField_CString(hData,"desc",&csTmp)) {
DEBUGLOG(("AddAdjustmentType: desc = [%s]\n",csTmp));
       
		// Desc Prefix
		if (strlen(PD_ADJ_DESC_PREFIX) + strlen(csTmp) > PD_DESC_LEN){
                     	iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                     	PutField_Int(hContext,"internal_error",iRet);
             	} else {
                    	memset(csDesc, 0, sizeof(csDesc));
                     	strcpy(csDesc, PD_ADJ_DESC_PREFIX); // "Adjustment - "
                      	strncpy(&csDesc[strlen(PD_ADJ_DESC_PREFIX)], csTmp, PD_DESC_LEN - strlen(PD_ADJ_DESC_PREFIX));
                     	PutField_CString(hData, "desc", csDesc);
              	}
        } else {
DEBUGLOG(("AddAdjustmentType:: desc missing!!\n"));
ERRLOG("BOMMSAdjustment:: Authorize:: desc missing!!\n");
            	iRet = INT_MMS_TXN_CODE_DESC_NOT_FOUND;
             	PutField_Int(hContext,"internal_error",iRet);
	}

/* disabled */
	if (GetField_Int(hData,"disabled",&iDisabled)) {
DEBUGLOG(("AddAdjustmentType: disabled = [%d]\n",iDisabled));
        } else {
DEBUGLOG(("AddAdjustmentType:: disabled missing!!\n"));
ERRLOG("BOMMSAdjustment:: AddAdjustmentType:: disabled missing!!\n");
                iRet = INT_DISABLED_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* user */
        if (GetField_CString(hData,"user",&csUser)) {
DEBUGLOG(("AddAdjustmentType: user = [%s]\n",csUser));	
		PutField_CString(hData, "add_user", csUser);
		PutField_CString(hData, "create_user", csUser);
		PutField_CString(hData, "update_user", csUser);
        } else {
DEBUGLOG(("AddAdjustmentType:: user missing!!\n"));
ERRLOG("BOMMSAdjustment:: AddAdjustmentType:: user missing!!\n");
                iRet = INT_USER_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/*
 * Txn Code (Foreign Key)
 */

	if (iRet == PD_OK) {

DEBUGLOG(("AddAdjustmentType: ===== Txn Code ===== Start!!\n"));

/* txn_code */
                PutField_CString(hTxnCodeRec, "txn_code", csCode);
DEBUGLOG(("AddAdjustmentType:: txn_code = [%s]\n",csCode));

/* txn_desc */
                PutField_CString(hTxnCodeRec, "txn_desc", csDesc);
DEBUGLOG(("AddAdjustmentType:: desc = [%s]\n",csDesc));

/* process_type */
                PutField_CString(hTxnCodeRec, "process_type", PD_PROCESS_TYPE_DEF);
DEBUGLOG(("AddAdjustmentType:: process_type = [%s]\n",PD_PROCESS_TYPE_DEF));

/* process_code */
                PutField_CString(hTxnCodeRec, "process_code", PD_PROCESS_CODE_DEF);
DEBUGLOG(("AddAdjustmentType:: process_code = [%s]\n",PD_PROCESS_CODE_DEF));

/* create_user */
               	PutField_CString(hTxnCodeRec, "create_user", csUser);
DEBUGLOG(("AddAdjustmentType:: create_user = [%s]\n",csUser));

		// Add Txn Code
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode Add\n"));
              	DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Add");
              	iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
              	if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Success!!!\n"));
           	} else {
                   	iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                     	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
             	}

DEBUGLOG(("AddAdjustmentType: ===== Txn Code ===== End!!\n"));
        }

/*
 * Txn Sub Status Map
 */
       
	 if (iRet == PD_OK) {

DEBUGLOG(("AddAdjustmentType: ===== Txn Sub Status Map ===== Start!!\n"));

/* user */
               	PutField_CString(hTxnSubStatusMapRec, "create_user", csUser);
DEBUGLOG(("AddAdjustmentType:: create_user = [%s]\n",csUser));

/* txn_code */
            	PutField_CString(hTxnSubStatusMapRec, "txn_code", csCode);
DEBUGLOG(("AddAdjustmentType:: txn_code = [%s]\n", csCode));

/* sub_status */
                PutField_CString(hTxnSubStatusMapRec, "sub_status", PD_APPROVED);
DEBUGLOG(("AddAdjustmentType:: sub_status = [%s]\n", PD_APPROVED));

		// Add Txn Sub Status Map
DEBUGLOG(("AddAdjustmentType:: Call DBMmsDefTxnSubStatusMap Add\n"));
             	DBObjPtr = CreateObj(DBPtr, "DBMmsDefTxnSubStatusMap","Add");
               	iDtlRet = (unsigned long)(*DBObjPtr)(hTxnSubStatusMapRec);
            	if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsDefTxnSubStatusMap:: Success!!!\n"));
             	} else {
                   	iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                      	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsDefTxnSubStatusMap:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsDefTxnSubStatusMap:: Failure!!!\n");
             	}

DEBUGLOG(("AddAdjustmentType: ===== Txn Sub Status Map ===== End!!\n"));
	}

/*
 * Txn Status Map: 	- type, txn_code, status, ar_ind, status_desc
 * 			- Admin, (s)99, C, A, Approved
 * 			- Admin, (s)99, C, R, Declined
 * 			- Admin, (s)99, R, A, Approved		
 */

	if (iRet == PD_OK) {	

DEBUGLOG(("AddAdjustmentType: ===== Txn Status Map ===== Start!!\n"));

/* txn_status_map_cnt */
		iTxnStatusMapCnt = 3;
DEBUGLOG(("AddAdjustmentType:: txn_status_map_cnt = [%d]\n", iTxnStatusMapCnt));

		for (i = 0; i < iTxnStatusMapCnt; i++) {
DEBUGLOG(("AddAdjustmentType:: cnt = [%d]\n", i));

/* user */
                       	PutField_CString(hTxnStatusMapRec, "create_user", csUser);
DEBUGLOG(("AddAdjustmentType:: create_user = [%s]\n",csUser));

/* type */
			PutField_Char(hTxnStatusMapRec, "type", PD_STATUS_MAP_TYPE_ADMIN);
DEBUGLOG(("AddAdjustmentType:: type = [%c]\n", PD_STATUS_MAP_TYPE_ADMIN));

/* txn_code */
			PutField_CString(hTxnStatusMapRec, "txn_code", csCode);
DEBUGLOG(("AddAdjustmentType:: txn_code = [%s]\n", csCode));
	
			if (i == 0) {

/* status */
				PutField_Char(hTxnStatusMapRec, "status", PD_COMPLETE);
DEBUGLOG(("AddAdjustmentType:: status = [%c]\n", PD_COMPLETE));

/* ar_ind */
				PutField_Char(hTxnStatusMapRec, "ar_ind", PD_ACCEPT);
DEBUGLOG(("AddAdjustmentType:: ar_ind = [%c]\n", PD_ACCEPT));

/* status_desc */
				PutField_CString(hTxnStatusMapRec, "status_desc", PD_STATUS_MAP_DESC_ACCEPT);
DEBUGLOG(("AddAdjustmentType:: status_desc = [%s]\n", PD_STATUS_MAP_DESC_ACCEPT));

			} else if (i == 1) {

/* status */
                                PutField_Char(hTxnStatusMapRec, "status", PD_COMPLETE);
DEBUGLOG(("AddAdjustmentType:: status = [%c]\n", PD_COMPLETE));

/* ar_ind */
                                PutField_Char(hTxnStatusMapRec, "ar_ind", PD_REJECT);
DEBUGLOG(("AddAdjustmentType:: ar_ind = [%c]\n", PD_REJECT));

/* status_desc */
                                PutField_CString(hTxnStatusMapRec, "status_desc", PD_STATUS_MAP_DESC_DECLINED);
DEBUGLOG(("AddAdjustmentType:: status_desc = [%s]\n", PD_STATUS_MAP_DESC_DECLINED));
			
			} else if (i == 2) {

/* status */
                                PutField_Char(hTxnStatusMapRec, "status", PD_REVERSED);
DEBUGLOG(("AddAdjustmentType:: status = [%c]\n", PD_REVERSED));

/* ar_ind */
                                PutField_Char(hTxnStatusMapRec, "ar_ind", PD_ACCEPT);
DEBUGLOG(("AddAdjustmentType:: ar_ind = [%c]\n", PD_ACCEPT));

/* status_desc */
                                PutField_CString(hTxnStatusMapRec, "status_desc", PD_STATUS_MAP_DESC_ACCEPT);
DEBUGLOG(("AddAdjustmentType:: status_desc = [%s]\n", PD_STATUS_MAP_DESC_ACCEPT));

			}
	
			// Add Txn Status Map
DEBUGLOG(("AddAdjustmentType:: Call DBMmsDefTxnStatusMap Add\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBMmsDefTxnStatusMap","Add");
                        iDtlRet = (unsigned long)(*DBObjPtr)(hTxnStatusMapRec);
                        if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsDefTxnStatusMap:: Success!!!\n"));
                        } else {
                                iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsDefTxnStatusMap:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsDefTxnStatusMap:: Failure!!!\n");
                        }
		}

DEBUGLOG(("AddAdjustmentType: ===== Txn Status Map ===== End!!\n"));
	}

/*
 * Adjustment Type Entity
 */
		
	if (iRet == PD_OK) {

DEBUGLOG(("AddAdjustmentType: ===== Adjustment Type Entity ===== Start!!\n"));

/* code */
DEBUGLOG(("AddAdjustmentType:: code = [%s]\n", csCode));

/* etype_cnt */
        	if (GetField_Int(hData,"etype_cnt",&iEtypeCnt)) {
DEBUGLOG(("AddAdjustmentType:: etype_cnt = [%d]\n",iEtypeCnt));
        	} else {
DEBUGLOG(("AddAdjustmentType:: etype_cnt missing!!\n"));
ERRLOG("TxnMmsByUsCEA:: Authorize:: etype_cnt missing!!\n");
        	        iRet = INT_MMS_ADJ_ETYPE_CNT_NOT_FOUND;
        	        PutField_Int(hContext,"internal_error",iRet);
        	}

		for (i=1; i<=iEtypeCnt; i++) {
/* et */
                    	sprintf(csTag,"etype.%d.et",i);
                        if (GetField_CString(hData,csTag,&csTmp)) {
DEBUGLOG(("AddAdjustmentType:: etype.%d.et = [%s]\n",i,csTmp));
                		PutField_CString(hData,"entity_type",csTmp);
                		PutField_CString(hFindRec,"entity_type",csTmp);
			} else {
DEBUGLOG(("AddAdjustmentType:: et missing!!\n"));
ERRLOG("BOMMSAdjustment:: AddAdjustmentType:: et missing!!\n");
                		iRet = INT_MMS_ADJ_ETYPE_NOT_FOUND;
                		PutField_Int(hContext,"internal_error",iRet);
        		}

/* et_action */
			sprintf(csTag,"etype.%d.et_action",i);
                        if (GetField_Char(hData,csTag,&cETAction)) {
DEBUGLOG(("AddAdjustmentType:: etype.%d.et_action = [%c]\n",i,cETAction));
				
				if (cETAction == PD_ACTION_ADD) {
					PutField_Int(hData,"disabled",0);
				} else if (cETAction == PD_ACTION_DELETE) {
					PutField_Int(hData,"disabled",1);
				}
                        } else {
DEBUGLOG(("AddAdjustmentType:: et_action missing!!\n"));
ERRLOG("BOMMSAdjustment:: AddAdjustmentType:: et_action missing!!\n");
                                iRet = INT_MMS_ADJ_ETYPE_ACTION_NOT_FOUND;
                                PutField_Int(hContext,"internal_error",iRet);
                        }

			if (iRet == PD_OK) {

                		// Find Adjustment Type Entity
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity Find\n"));
                		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Find");
                		iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
                		if (iDtlRet == PD_FOUND) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Found!!!\n"));

/* disabled */
                        		if (GetField_Int(hFindRec,"disabled",&iTmp)) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: disabled = [%d]\n", iTmp));
                        		}

					// Update Adjustment Type Entity
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity Update\n"));
                        		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Update");
                        		iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        		if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                        		} else {
                                		iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
                        		}
                		} else if (iDtlRet == PD_NOT_FOUND) {		
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Not Found!!!\n"));

					// Add Adjustment Type Entity
					if (cETAction == PD_ACTION_ADD) {	
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity Add\n"));
                        			DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Add");
                        			iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        			if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                        			} else {
                                			iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
						}
					}
				} else {
                        		iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
                		}
			}
		}

DEBUGLOG(("AddAdjustmentType: ===== Adjustment Type Entity ===== End!!\n"));
	}	

/*
 * Adjustment Type       
 */

	if (iRet == PD_OK) {

DEBUGLOG(("AddAdjustmentType: ===== Adjustment Type ===== Start!!\n"));


/* code */
DEBUGLOG(("AddAdjustmentType:: code = [%s]\n", csCode));

/* disabled */
              	PutField_Int(hData,"disabled",iDisabled);

		// Find Adjustment Type
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType Find\n"));
       		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Find");
      		iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
       		if (iDtlRet == PD_FOUND) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Found!!!\n"));

/* disabled */
			if (GetField_Int(hFindRec,"disabled",&iTmp)) {	
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: disabled = [%d]\n", iTmp));
			}

			// Update Adjustment Type
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType Update\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Update");
                	iDtlRet = (unsigned long)(*DBObjPtr)(hData);
			if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));				
			} else {
				iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");		
			}
       		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
			
			// Add Adjustment Type
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType Add\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Add");
                        iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                        } else {
                                iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
       			}
		} else {
              		iRet = INT_ADJUSTMENT_PROCESS_ERROR;
            		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
     		}

DEBUGLOG(("AddAdjustmentType: ===== Adjustment Type ===== End!!\n"));
	}

	hash_destroy(hFindRec);
        FREE_ME(hFindRec);	

	hash_destroy(hTxnCodeRec);
        FREE_ME(hTxnCodeRec);
	
	hash_destroy(hTxnStatusMapRec);
        FREE_ME(hTxnStatusMapRec);

	hash_destroy(hTxnSubStatusMapRec);
        FREE_ME(hTxnSubStatusMapRec);
	
DEBUGLOG(("AddAdjustmentType() normal exit iRet = [%d]\n",iRet));
	return iRet;
}

int UpdateAdjustmentType (hash_t* hContext, hash_t* hData) 
{
	int     iRet = PD_OK;
        int     iDtlRet = PD_FOUND;
	int     iValidRet = PD_TRUE;

	int     iEtypeCnt = 0;
	int	iDisabled = 0;
        int     iTmp = 0;
	int	i = 0;

	char	cETAction;

	char*   csCode = NULL;
        char*   csUser = NULL;
        char*   csTmp = NULL;

	char    csDesc[PD_DESC_LEN + 1];
	char    csTag[PD_TAG_LEN + 1];

	hash_t  *hFindRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hFindRec,0);

	hash_t  *hAdjTypeRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hAdjTypeRec,0);

        hash_t  *hTxnCodeRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnCodeRec,0);

	cETAction = ' ';

DEBUGLOG(("UpdateAdjustmentType() Start!\n"));

/* code */
        if (GetField_CString(hData,"code",&csCode)) {
DEBUGLOG(("UpdateAdjustmentType: code = [%s]\n",csCode));
		PutField_CString(hFindRec, "code", csCode);
        } else {
DEBUGLOG(("UpdateAdjustmentType:: code missing!!\n"));
ERRLOG("BOMMSAdjustment:: UpdateAdjustmentType:: code missing!!\n");
                iRet = INT_MMS_TXN_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* disabled */
      	if (GetField_Int(hData,"disabled",&iDisabled)) {
DEBUGLOG(("UpdateAdjustmentType: disabled = [%d]\n", iDisabled));
       	 } else {
DEBUGLOG(("UpdateAdjustmentType:: disabled missing!!\n"));
ERRLOG("BOMMSAdjustment:: UpdateAdjustmentType:: disabled missing!!\n");
            	iRet = INT_DISABLED_NOT_FOUND;
           	PutField_Int(hContext,"internal_error",iRet);
	 }

/* user */
        if (GetField_CString(hData,"user",&csUser)) {
DEBUGLOG(("UpdateAdjustmentType: user = [%s]\n",csUser));
		PutField_CString(hData, "add_user", csUser);
                PutField_CString(hData, "create_user", csUser);
                PutField_CString(hData, "update_user", csUser);
        } else {
DEBUGLOG(("UpdateAdjustmentType:: user missing!!\n"));
ERRLOG("TBOMMSAdjustment:: UpdateAdjustmentType:: user missing!!\n");
                iRet = INT_USER_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/*
 * Adjustment Type
 */

        if (iRet == PD_OK) {

DEBUGLOG(("UpdateAdjustmentType: ===== Adjustment Type ===== Start!!\n"));

/* code */
DEBUGLOG(("UpdateAdjustmentType:: code = [%s]\n", csCode));

		// Find Adjustment Type
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType Find\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Find");
                iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Found!!!\n"));

/* disabled */
                        if (GetField_Int(hFindRec,"disabled",&iTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: disabled = [%d]\n", iTmp));
                        }

			// Check Validate Process
			iValidRet = ValidateProcess(hData);
                        if (iValidRet == PD_FALSE) {
				
/* code */
                        	PutField_CString(hAdjTypeRec, "code", csCode);
DEBUGLOG(("UpdateAdjustmentType:: code = [%s]\n",csCode));

/* desc */
                		if (GetField_CString(hData, "desc", &csTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: desc = [%s]\n",csTmp));

					// Desc Prefix	
					if (strlen(PD_ADJ_DESC_PREFIX) + strlen(csTmp) > PD_DESC_LEN){
                        			iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        			PutField_Int(hContext,"internal_error",iRet);
                			} else {
                        			memset(csDesc, 0, sizeof(csDesc));
                        			strcpy(csDesc, PD_ADJ_DESC_PREFIX); // "Adjustment - "
                        			strncpy(&csDesc[strlen(PD_ADJ_DESC_PREFIX)], csTmp, PD_DESC_LEN - strlen(PD_ADJ_DESC_PREFIX));
                       	 			PutField_CString(hAdjTypeRec, "desc", csDesc);
                			}
               	 		}				

/* disabled */
				PutField_Int(hAdjTypeRec, "disabled", iDisabled);
DEBUGLOG(("UpdateAdjustmentType:: disabled = [%d]\n",iDisabled));

/* user */			
                               	PutField_CString(hAdjTypeRec, "update_user", csUser);
DEBUGLOG(("UpdateAdjustmentType:: update_user = [%s]\n",csTmp));
	
				// Update Adjustment Type (Desc Only)
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType Update (Desc Only)\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Update");
                                iDtlRet = (unsigned long)(*DBObjPtr)(hAdjTypeRec);
                                if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                                } else {
                                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
                                }				
			} else if (iValidRet == PD_TRUE) {
	
/* desc */
                                if (GetField_CString(hData, "desc", &csTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: desc = [%s]\n",csTmp));

					// Desc Prefix
					if (strlen(PD_ADJ_DESC_PREFIX) + strlen(csTmp) > PD_DESC_LEN){
                                                iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                                PutField_Int(hContext,"internal_error",iRet);
                                        } else {
                                                memset(csDesc, 0, sizeof(csDesc));
                                                strcpy(csDesc, PD_ADJ_DESC_PREFIX); // "Adjustment - "
                                                strncpy(&csDesc[strlen(PD_ADJ_DESC_PREFIX)], csTmp, PD_DESC_LEN - strlen(PD_ADJ_DESC_PREFIX));
                                                PutField_CString(hData, "desc", csDesc);
DEBUGLOG(("UpdateAdjustmentType:: desc (with Prefix) = [%s]\n",csDesc));
                                        }
				}
	
				// Update Adjustment Type
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType Update\n"));
                        	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Update");
                        	iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        	if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                        	} else {
                        	        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        	        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
                        	}
			} else {
				iRet = iValidRet;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
			}	
		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
			iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Not Found!!!\n");
		} else {
			iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");	
		}

DEBUGLOG(("UpdateAdjustmentType: ===== Adjustment Type ===== End!!\n"));
	}

/*
 * Adjustment Type Entity
 */

	if ((iRet == PD_OK) && (iValidRet == PD_TRUE)) {

DEBUGLOG(("UpdateAdjustmentType: ===== Adjustment Type Entity ===== Start!!\n"));

/* code */
DEBUGLOG(("UpdateAdjustmentType:: code = [%s]\n", csCode));

/* etype_cnt */
                if (GetField_Int(hData,"etype_cnt",&iEtypeCnt)) {
DEBUGLOG(("UpdateAdjustmentType:: etype_cnt = [%d]\n",iEtypeCnt));
                } else {
DEBUGLOG(("UpdateAdjustmentType:: etype_cnt missing!!\n"));
ERRLOG("BOMMSAdjustment:: UpdateAdjustmentType:: etype_cnt missing!!\n");
                        iRet = INT_MMS_ADJ_ETYPE_CNT_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
                }

		for (i=1; i<=iEtypeCnt; i++) {
/* et */
                        sprintf(csTag,"etype.%d.et",i);
                        if (GetField_CString(hData,csTag,&csTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: etype.%d.et = [%s]\n",i,csTmp));
                                PutField_CString(hData,"entity_type",csTmp);
                		PutField_CString(hFindRec,"entity_type",csTmp);
                        }

/* et_action */
                        sprintf(csTag,"etype.%d.et_action",i);
                        if (GetField_Char(hData,csTag,&cETAction)) {
DEBUGLOG(("UpdateAdjustmentType:: etype.%d.et_action = [%c]\n",i,cETAction));

                                if (cETAction == PD_ACTION_ADD) {
                                        PutField_Int(hData,"disabled",0);
                                } else if (cETAction == PD_ACTION_DELETE) {
                                        PutField_Int(hData,"disabled",1);
                                }
                        }

			if (iRet == PD_OK) {

				// Find Adjustment Type Entity
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity Find\n"));
                		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Find");
                		iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
                		if (iDtlRet == PD_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Found!!!\n"));

/* disabled */
                        		if (GetField_Int(hFindRec,"disabled",&iTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: disabled = [%d]\n", iTmp));
                        		}

					// Update Adjustment Type Entity
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity Update\n"));
                        		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Update");
                        		iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        		if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                        		} else {
                                		iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
                        		}
                		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Not Found!!!\n"));

					// Add Adjustment Type Entity
                                        if (cETAction == PD_ACTION_ADD) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity Add\n"));
                                                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Add");
                                                iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                                                if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                                                } else {
                                                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
						}
 					}                                         
                		} else {
                        		iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Error!!!\n");
                		}
			}
		}		

DEBUGLOG(("UpdateAdjustmentType: ===== Adjustment Type Entity ===== End!!\n"));
	}

/*
 * Txn Code (Foreign Key)
 */

        if (iRet == PD_OK) {

DEBUGLOG(("UpdateAdjustmentType: ===== Txn Code ===== Start!!\n"));

/* txn_code */
               	PutField_CString(hTxnCodeRec, "txn_code", csCode);
DEBUGLOG(("UpdateAdjustmentType:: txn_code = [%s]\n",csCode));

/* txn_desc */
               	PutField_CString(hTxnCodeRec, "txn_desc", csDesc);
DEBUGLOG(("UpdateAdjustmentType:: desc = [%s]\n",csDesc));

/* process_type */
                PutField_CString(hTxnCodeRec, "process_type", PD_PROCESS_TYPE_DEF);
DEBUGLOG(("UpdateAdjustmentType:: process_type = [%s]\n",PD_PROCESS_TYPE_DEF));

/* process_code */
                PutField_CString(hTxnCodeRec, "process_code", PD_PROCESS_CODE_DEF);
DEBUGLOG(("UpdateAdjustmentType:: process_code = [%s]\n",PD_PROCESS_CODE_DEF));

/* update_user */
            	PutField_CString(hTxnCodeRec, "update_user", csUser);
DEBUGLOG(("UpdateAdjustmentType:: update_user = [%s]\n",csUser));
		
		// Update Txn Code
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode Update\n"));
        	DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Update");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode:: Success!!!\n"));
                } else {
                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                }

DEBUGLOG(("UpdateAdjustmentType: ===== Txn Code ===== End!!\n"));
        }

	hash_destroy(hFindRec);
        FREE_ME(hFindRec);

	hash_destroy(hAdjTypeRec);
        FREE_ME(hAdjTypeRec);

	hash_destroy(hTxnCodeRec);
        FREE_ME(hTxnCodeRec);

DEBUGLOG(("UpdateAdjustmentType() normal exit iRet = [%d]\n",iRet));
	return iRet;
}

int DeleteAdjustmentType (hash_t* hContext, hash_t* hData)
{
        int     iRet = PD_OK;
        int     iDtlRet = PD_FOUND;
	int	iValidRet = PD_TRUE;

        int     iTmp = 0;

	char*	csCode = NULL;
	char*	csUser = NULL;
        char*   csTmp = NULL;

	hash_t  *hFindRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hFindRec,0);

        hash_t  *hTxnCodeRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnCodeRec,0);

	hash_t  *hTxnStatusMapRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnStatusMapRec,0);

	hash_t  *hTxnSubStatusMapRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnSubStatusMapRec,0);

	//hash_t  *hRec = NULL;
	recordset_t	*rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
	
DEBUGLOG(("DeleteAdjustmentType() Start!\n"));

/* code */
        if (GetField_CString(hData,"code",&csCode)) {
DEBUGLOG(("DeleteAdjustmentType: code = [%s]\n",csCode));
		PutField_CString(hFindRec,"code",csCode);
        } else {
DEBUGLOG(("DeleteAdjustmentType:: code missing!!\n"));
ERRLOG("BOMMSAdjustment:: DeleteAdjustmentType:: code missing!!\n");
                iRet = INT_MMS_TXN_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* user */
        if (GetField_CString(hData,"user",&csUser)) {
DEBUGLOG(("DeleteAdjustmentType: user = [%s]\n",csUser));
		PutField_CString(hData, "add_user", csUser);
                PutField_CString(hData, "create_user", csUser);
                PutField_CString(hData, "update_user", csUser);
        } else {
DEBUGLOG(("DeleteAdjustmentType:: user missing!!\n"));
ERRLOG("TBOMMSAdjustment:: DeleteAdjustmentType:: user missing!!\n");
                iRet = INT_USER_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/*
 * Adjustment Type
 */	

	if (iRet == PD_OK) {

DEBUGLOG(("DeleteAdjustmentType: ===== Adjustment Type ===== Start!!\n"));

/* code */
DEBUGLOG(("DeleteAdjustmentType:: code = [%s]\n", csCode));

		// Find Adjustment Type
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType Find\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Find");
                iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Found!!!\n"));

/* disabled */
                   	if (GetField_Int(hFindRec,"disabled",&iTmp)) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: disabled = [%d]\n", iTmp));
                      	}

			// Check Validate Process
			iValidRet = ValidateProcess(hData);
			if (iValidRet == PD_FALSE) {

/* disabled */
				PutField_Int(hData,"disabled",1);
DEBUGLOG(("DeleteAdjustmentType:: disabled = [1]\n"));

                	        // Update Adjustment Type (Disabled)
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType Update\n"));
                        	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Update");
                        	iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        	if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                        	} else {
                        	        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        	        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
                        	}
			} else if (iValidRet == PD_TRUE) {

				// Delete Adjustment Type
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType Delete\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Delete");
                                iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                                if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                                } else {
                                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
                                }
			} else {
				iRet = iValidRet;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
			}
                } else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
                
		} else {
                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
                }

DEBUGLOG(("DeleteAdjustmentType: ===== Adjustment Type ===== End!!\n"));
	}

/*
 * Adjustment Type Entity
 */

	if (iRet == PD_OK) {

DEBUGLOG(("DeleteAdjustmentType: ===== Adjustment Type Entity ===== Start!!\n"));

/* code */
DEBUGLOG(("DeleteAdjustmentType:: code = [%s]\n", csCode));

		// Find All djustment Type Entity Type
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity FindEntityType\n"));
               	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","FindEntityType");
                iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec,rRecordSet);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Found!!!\n"));

			if (iValidRet == PD_TRUE) {
		
				// Delete Adjustment Type Entity
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity Delete\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Delete");
                                iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                                if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                                } else {
                                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
                                }
			} else if (iValidRet == PD_FALSE) {
/*
				hRec = RecordSet_GetFirst(rRecordSet);
                        	while (hRec) {

// adj_entity_type
					if (GetField_CString(hRec,"adj_entity_type",&csTmp)) {
DEBUGLOG(("DeleteAdjustmentType: adj_entity_type = [%s]\n",csTmp));
                                	        PutField_CString(hData,"adj_entity_type",csTmp);					 
					}

// disabled
					PutField_Int(hData,"disabled",1);
DEBUGLOG(("DeleteAdjustmentType: disabled = [1]\n"));

					// Update Adjustment Type Entity (Disabled)
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity Update\n"));
                     			DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Update");
                    			iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                     			if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                      			} else {
                             			iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                             			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
                    			}	
				
					hRec = RecordSet_GetNext(rRecordSet);
				}
*/
			}
		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
              	
		} else {
                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
                }

DEBUGLOG(("DeleteAdjustmentType: ===== Adjustment Type Entity ===== End!!\n"));
        }

/*
 * Txn Status Map
 */

	if ((iRet == PD_OK) && (iValidRet == PD_TRUE)) {	

DEBUGLOG(("DeleteAdjustmentType: ===== Txn Status Map ===== Start!!\n"));

/* txn_code */
            	PutField_CString(hTxnStatusMapRec, "txn_code", csCode);
DEBUGLOG(("DeleteAdjustmentType:: txn_code = [%s]\n", csCode));

		// Check Txn Code Exist
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnStatusMap ChkTxnCodeExist\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsDefTxnStatusMap","ChkTxnCodeExist");
                iDtlRet = (unsigned long)(*DBObjPtr)(csCode);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnStatusMap:: Found!!!\n"));

			// Delete Txn Status Map
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnStatusMap Delete\n"));
            		DBObjPtr = CreateObj(DBPtr, "DBMmsDefTxnStatusMap","Delete");
             		iDtlRet = (unsigned long)(*DBObjPtr)(hTxnStatusMapRec);
            		if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnStatusMap:: Success!!!\n"));
           		} else {
                   		iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                     		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnStatusMap:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsDefTxnStatusMap:: Failure!!!\n");
             		}
		} else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnStatusMap:: Not Found!!!\n"));

                } else {
                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnSubStatusMap:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsDefTxnStatusMap:: Failure!!!\n");
                }
DEBUGLOG(("DeleteAdjustmentType: ===== Txn Status Map ===== End!!\n"));
	}

/*
 * Txn Sub Status Map
 */

	if ((iRet == PD_OK) && (iValidRet == PD_TRUE)) {

DEBUGLOG(("DeleteAdjustmentType: ===== Txn Sub Status Map ===== Start!!\n"));

/* txn_code */
                PutField_CString(hTxnSubStatusMapRec, "txn_code", csCode);
DEBUGLOG(("DeleteAdjustmentType:: txn_code = [%s]\n", csCode));

		// Check Txn Code Exist
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnSubStatusMap ChkTxnCodeExist\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsDefTxnSubStatusMap","ChkTxnCodeExist");
                iDtlRet = (unsigned long)(*DBObjPtr)(csCode);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnSubStatusMap:: Found!!!\n"));

			// Delete Txn Status Map
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnSubStatusMap Delete\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBMmsDefTxnSubStatusMap","Delete");
                	iDtlRet = (unsigned long)(*DBObjPtr)(hTxnSubStatusMapRec);
                	if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnSubStatusMap:: Success!!!\n"));
                	} else {
                        	iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnSubStatusMap:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsDefTxnSubStatusMap:: Failure!!!\n");
                	}
		} else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnSubStatusMap:: Not Found!!!\n"));

                } else {
                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsDefTxnSubStatusMap:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsDefTxnSubStatusMap:: Failure!!!\n");
                }	
DEBUGLOG(("DeleteAdjustmentType: ===== Txn Sub Status Map ===== End!!\n"));
        }

/*
 * Txn Code (Foreign Key)
 */

	if ((iRet == PD_OK) && (iValidRet == PD_TRUE)) {

DEBUGLOG(("DeleteAdjustmentType: ===== Txn Code ===== Start!!\n"));

/* txn_code */
                PutField_CString(hTxnCodeRec, "txn_code", csCode);
DEBUGLOG(("DeleteAdjustmentType:: txn_code = [%s]\n",csCode));


/* txn_desc */
                if (GetField_CString(hData, "desc", &csTmp)) {
DEBUGLOG(("DeleteAdjustmentType:: desc = [%s]\n",csTmp));
                        PutField_CString(hTxnCodeRec, "txn_desc", csTmp);
                }

/* process_type */
                PutField_CString(hTxnCodeRec, "process_type", PD_PROCESS_TYPE_DEF);
DEBUGLOG(("DeleteAdjustmentType:: process_type = [%s]\n",PD_PROCESS_TYPE_DEF));


/* process_code */
                PutField_CString(hTxnCodeRec, "process_code", PD_PROCESS_CODE_DEF);
DEBUGLOG(("DeleteAdjustmentType:: process_code = [%s]\n",PD_PROCESS_CODE_DEF));

		// Check Txn Code Exist
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode Find\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Find");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                if (iDtlRet == FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Found!!!\n"));

			// Delete Txn Code
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode Delete\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Delete");
                        iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                        if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Success!!!\n"));
                        } else {
                                iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                        }
                } else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Not Found!!!\n"));

                } else {
                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                }

DEBUGLOG(("DeleteAdjustmentType: ===== Txn Code ===== End!!\n"));
        }		

	hash_destroy(hFindRec);
        FREE_ME(hFindRec);

	hash_destroy(hTxnCodeRec);
        FREE_ME(hTxnCodeRec);

	hash_destroy(hTxnStatusMapRec);
        FREE_ME(hTxnStatusMapRec);

	hash_destroy(hTxnSubStatusMapRec);
        FREE_ME(hTxnSubStatusMapRec);

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("DeleteAdjustmentType() normal exit iRet = [%d]\n",iRet));
        return iRet;
}

int ProcessEntityNatureBalance(hash_t* hContext, hash_t* hData)
{
	int 	iRet = PD_OK;
	int 	iDtlRet = PD_FOUND;

	int     iDisabled = PD_DISABLED;
	int     iAllowBalNegative = PD_FALSE;
        int     iAllowModify = PD_FALSE;
	int	iSystemDefined = PD_FALSE;
	int	iFxCnt = 0;
	int	iAcrInd = PD_TRUE;
	int	i = 0;

	double	dTxnAmt = 0.00;
	double	dFeeAmt = 0.00;
	double	dNetAmt = 0.00;
	double	dAffFxAmt = 0.00;
	double	dNonAffFxAmt = 0.00;
	double	dFxAmt = 0.00;

	char	cBalType;
	char	cNature;

	char	*csTxnSeq = NULL;
	char	*csCode = NULL;
        char    *csCcy = NULL;
	char	*csUser = NULL;
	char    *csAmtType = NULL;
	char    *csEntityId = NULL;
	char    *csEntityType = NULL;
	char	*csFxOccy = NULL;
	char 	*csFxCcy = NULL;

	char    csTag[PD_TAG_LEN + 1];

	hash_t  *hEntityRec = NULL;
	hEntityRec = (hash_t *)malloc(sizeof(hash_t));
        hash_init(hEntityRec, 0);

	hash_t  *hAdjTypeRec;
        hAdjTypeRec = (hash_t *)malloc(sizeof(hash_t));
        hash_init(hAdjTypeRec, 0);

	hash_t  *hAdjTypeEntityRec;
        hAdjTypeEntityRec = (hash_t *)malloc(sizeof(hash_t));
        hash_init(hAdjTypeEntityRec, 0);
	
	hash_t  *hNatBalRec;
        hNatBalRec = (hash_t *)malloc(sizeof(hash_t));
        hash_init(hNatBalRec, 0);

	hash_t  *hTxnElementRec;
        hTxnElementRec = (hash_t *)malloc(sizeof(hash_t));
        hash_init(hTxnElementRec, 0);

	cBalType = ' ';
	cNature = ' ';

DEBUGLOG(("ProcessEntityNatureBalance() Start!\n"));

/* txn_seq */
	if (GetField_CString(hData,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("ProcessEntityNatureBalance: txn_seq = [%s]\n",csTxnSeq));
        } else {
DEBUGLOG(("ProcessEntityNatureBalance:: txn_id missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: txn_id missing!!\n");
                iRet = INT_TXN_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* code */
        if (GetField_CString(hData,"code",&csCode)) {
DEBUGLOG(("ProcessEntityNatureBalance: code = [%s]\n",csCode));
        } else {
DEBUGLOG(("ProcessEntityNatureBalance:: code missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: code missing!!\n");
                iRet = INT_MMS_TXN_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_ccy */
        if (GetField_CString(hData,"txn_ccy",&csCcy)) {
DEBUGLOG(("ProcessEntityNatureBalance: txn_ccy = [%s]\n",csCcy));
        } else {
DEBUGLOG(("ProcessEntityNatureBalance:: txn_ccy missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: txn_ccy missing!!\n");
                iRet = INT_MMS_CCY_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_amt */
	if (GetField_Double(hData,"txn_amt",&dTxnAmt)) {
DEBUGLOG(("ProcessEntityNatureBalance: txn_amt = [%.2lf]\n",dTxnAmt));
        } else {
DEBUGLOG(("ProcessEntityNatureBalance:: txn_amt missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: txn_amt missing!!\n");
                iRet = INT_MMS_AMT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* fee_amt */
	if (GetField_Double(hData,"fee_amt",&dFeeAmt)) {
DEBUGLOG(("ProcessEntityNatureBalance: fee_amt = [%.2lf]\n",dFeeAmt));
        } else {
		dFeeAmt = 0.00;
DEBUGLOG(("ProcessEntityNatureBalance: fee_amt (by default) = [%.2lf]\n",dFeeAmt));		
	}

/* entity_id */
        if (GetField_CString(hData,"entity_id",&csEntityId)) {
DEBUGLOG(("ProcessEntityNatureBalance: entity_id = [%s]\n",csEntityId));
        } else {
DEBUGLOG(("ProcessEntityNatureBalance:: entity_id missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: entity_id missing!!\n");
                iRet = INT_MMS_ENTITY_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* user */
        if(GetField_CString(hData,"user",&csUser)) {
DEBUGLOG(("ProcessEntityNatureBalance: user = [%s]\n",csUser));
        } else {
DEBUGLOG(("ProcessEntityNatureBalance:: user missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: user missing!!\n");
                iRet = INT_USER_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
	}

	// Get Adjustment Type Info
	if (iRet == PD_OK) {
	
/* code */
                PutField_CString(hAdjTypeRec, "code", csCode);					
DEBUGLOG(("ProcessEntityNatureBalance: code = [%s]\n",csCode));
	
		// Find Adjustment Type Record
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsAdjustmentType:Find\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMmsAdjustmentType","Find");
                iDtlRet = (unsigned long)(*DBObjPtr)(hAdjTypeRec);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsAdjustmentType::Find::Found!!!\n"));
	
			// Get Adjustment Type Record
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsAdjustmentType:GetAdjustmentTypeRec\n"));
                	DBObjPtr = CreateObj(DBPtr,"DBMmsAdjustmentType","GetAdjustmentTypeRec");
                	iDtlRet = (unsigned long)(*DBObjPtr)(csCode, hAdjTypeRec);
                	if (iDtlRet == PD_OK) {

/* nature */
				if (GetField_Char(hAdjTypeRec, "nature", &cNature)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::nature = [%c]\n", cNature));
                        	}

/* bal_type */
				if (GetField_Char(hAdjTypeRec, "bal_type", &cBalType)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::bal_type = [%c]\n", cBalType));
                        	}

/* amt_type */
				if (GetField_CString(hAdjTypeRec, "amt_type", &csAmtType)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::amt_type = [%s]\n", csAmtType));
                        	}			

/* system_defined */
				if (GetField_Int(hAdjTypeRec, "system_defined", &iSystemDefined)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::system_defined = [%d]\n", iSystemDefined));
                        	}

/* allow_modify */
                        	if (GetField_Int(hAdjTypeRec, "allow_modify", &iAllowModify)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::allow_modify = [%d]\n", iAllowModify));
                        	}

/* allow_bal_neg */
                        	if (GetField_Int(hAdjTypeRec, "allow_bal_neg", &iAllowBalNegative)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::allow_bal_neg = [%d]\n", iAllowBalNegative));
                        	}

/* disabled */
                        	if (GetField_Int(hAdjTypeRec, "disabled", &iDisabled)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::disabled = [%d]\n",iDisabled));

					// Check disabled
                                	if (iDisabled == PD_DISABLED) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::not allow to use the code\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::GetAdjustmentTypeRec:: code in disabled!!\n");
                                	        iRet = INT_CODE_DISABLED;
                               		        PutField_Int(hContext, "internal_error", iRet);
                                	}
                        	}

                	} else {
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsAdjustmentType:GetOLAdjustmentTypeRec:: Failure!!\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::Call DBMmsAdjustmentType::GetAdjustmentTypeRec:: Failure!!\n");
                        	iRet = INT_ERR;
                        	PutField_Int(hContext, "internal_error", iRet);
                	}
		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsAdjustmentType::Find::Not Found!!!\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::Call DBMmsAdjustmentType::Find::Not Found!!\n");
                        iRet = INT_MMS_TXN_CODE_NOT_FOUND;
                        PutField_Int(hContext, "internal_error", iRet);			
                } else {
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsAdjustmentType::Find::Error!!\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::Call DBMmsAdjustmentType::Find::Error!!\n");
                      	iRet = INT_ERR;
                        PutField_Int(hContext, "internal_error", iRet);
                }		
	}	

	// Check Entity Type
	if (iRet == PD_OK) {

		// Get Entity Type
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsEntity:GetEntityId\n"));
              	DBObjPtr = CreateObj(DBPtr,"DBMmsEntity","GetEntityId");
              	iDtlRet = (unsigned long)(*DBObjPtr)(csEntityId, hEntityRec);
              	if (iDtlRet == PD_FOUND) {
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsEntity::GetEntityId::Found!!!\n"));

/* entity_type */
			if (GetField_CString(hEntityRec, "entity_type", &csEntityType)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetEntityId::entity_type = [%s]\n", csEntityType));
                       	}

		} else {
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsEntity::GetEntityId::Not Found!!!\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::Call DBMmsEntity::GetEntityId:: Not Found!!\n");
                      	iRet = INT_MMS_ENTITY_ID_NOT_FOUND;
               		PutField_Int(hContext, "internal_error", iRet);
		}

		// Find Adjustment Type Entity (Entity Type)
		if (iRet == PD_OK) {

/* code */
			PutField_CString(hAdjTypeEntityRec, "code", csCode);
DEBUGLOG(("ProcessEntityNatureBalance: code = [%s]\n",csCode));		

/* entity_type */
			PutField_CString(hAdjTypeEntityRec, "entity_type", csEntityType);
DEBUGLOG(("ProcessEntityNatureBalance: entity_type = [%s]\n",csEntityType));	

			// Find Adjustment Type Entity Record
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsAdjustmentTypeEntity:Find\n"));
                	DBObjPtr = CreateObj(DBPtr,"DBMmsAdjustmentTypeEntity","Find");
                	iDtlRet = (unsigned long)(*DBObjPtr)(hAdjTypeEntityRec);
                	if (iDtlRet == PD_FOUND) {
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsAdjustmentTypeEntity::Find::Found!!!\n"));

/* disabled */
                    		if (GetField_Int(hAdjTypeEntityRec, "disabled", &iDisabled)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::disabled = [%d]\n",iDisabled));
                       
					// Check disabled
					if (iDisabled == PD_DISABLED) {	
DEBUGLOG(("ProcessEntityNatureBalance::GetOLAdjustmentTypeEntityRec:: Entity Type Not Match!!\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::GetAdjustmentTypeEntityRec:: Entity Type Not Match!!\n");
                                	        iRet = INT_MMS_ENTITY_TYPE_NOT_MATCH;
                                        	PutField_Int(hContext, "internal_error", iRet);
					}
				}
			} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsAdjustmentTypeEntity::Find::Not Found!!!\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::Call DBMmsAdjustmentTypeEntity::Find::Not Found!!\n");
                        	iRet = INT_MMS_ENTITY_TYPE_NOT_MATCH;
                        	PutField_Int(hContext, "internal_error", iRet);
                	} else {
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsAdjustmentTypeEntity::Find::Error!!\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::Call DBMmsAdjustmentTypeEntity::Find::Error!!\n");
                        	iRet = INT_ERR;
                        	PutField_Int(hContext, "internal_error", iRet);
                	}
		}
	}

	// Calcaulate Net Amount
	if (iRet == PD_OK) {
		if (!strcmp(csAmtType, PD_CR)) {
                        dNetAmt = dTxnAmt - dFeeAmt;
                } else if (!strcmp(csAmtType, PD_DR)) {
                        dNetAmt = dTxnAmt + dFeeAmt;
                }
                dNetAmt = newround(dNetAmt, 2);
	}

	// Update Entity Balance
	if (iRet == PD_OK) {

/* ccy */
		PutField_CString(hNatBalRec,"ccy",csCcy);		
DEBUGLOG(("ProcessEntityNatureBalance:: ccy = [%s]\n",csCcy));

/* amt_type */
DEBUGLOG(("ProcessEntityNatureBalance:: amt_type = [%s]\n",csAmtType));

/* bal_amt */
DEBUGLOG(("ProcessEntityNatureBalance:: bal_type = [%c]\n",cBalType));

/* txn_amt */
                PutField_Double(hContext,"txn_amt",dTxnAmt);
DEBUGLOG(("ProcessEntityNatureBalance:: txn_amt = [%.2lf]\n",dTxnAmt));

/* fee_amt */
		if (dFeeAmt > 0.00) {		
			PutField_Double(hContext,"fee_amt",dFeeAmt);
DEBUGLOG(("ProcessEntityNatureBalance:: fee_amt = [%.2lf]\n",dFeeAmt));		
		}

/* net_amt */
               	PutField_Double(hContext,"net_amt",dNetAmt);
DEBUGLOG(("ProcessEntityNatureBalance:: net_amt = [%.2lf]\n",dNetAmt));		

/* allow_bal_neg */
		PutField_Int(hNatBalRec,"allow_bal_neg",iAllowBalNegative);
DEBUGLOG(("ProcessEntityNatureBalance:: allow_bal_neg = [%d]\n",iAllowBalNegative)); 
		
/* update_user */
		PutField_CString(hNatBalRec,"update_user",csUser);		
DEBUGLOG(("ProcessEntityNatureBalance:: update_user = [%s]\n",csUser));

		// Check Credit/Debit, AcctBal/Intransit/Lien/Prepaid
		if (!strcmp(csAmtType, PD_CR)) {
		
			// Credit
			memset(csTag, 0, sizeof(csTag));
                        switch (cBalType) {
                                case PD_MMS_BAL_TYPE_ACCT_BAL:
                                        sprintf(csTag, "%s", "CreditAcctBal");
                                        break;
                                case PD_MMS_BAL_TYPE_INTRANSIT:
                                        sprintf(csTag, "%s", "CreditIntransit");
                                        break;
                                case PD_MMS_BAL_TYPE_LIEN:
                                        sprintf(csTag, "%s", "CreditLien");
                                        break;
                                case PD_MMS_BAL_TYPE_PREPAID:
                                        sprintf(csTag, "%s", "CreditPrepaid");
                                        break;
                                default:
                                        iRet = INT_MMS_BAL_TYPE_NOT_FOUND;
                                        PutField_Int(hContext,"internal_error",iRet);
                                        break;
                        }
		} else if (!strcmp(csAmtType, PD_DR)) {
		
			// Debit
			memset(csTag, 0, sizeof(csTag));
                	switch (cBalType) {
                        	case PD_MMS_BAL_TYPE_ACCT_BAL:
                                	sprintf(csTag, "%s", "DebitAcctBal");
                                	break;
                        	case PD_MMS_BAL_TYPE_INTRANSIT:
                         	       	sprintf(csTag, "%s", "DebitIntransit");
                                	break;
                        	case PD_MMS_BAL_TYPE_LIEN:
                                	sprintf(csTag, "%s", "DebitLien");
                                	break;
				case PD_MMS_BAL_TYPE_PREPAID:
                                	sprintf(csTag, "%s", "DebitPrepaid");
                                	break;
                        	default:
                                	iRet = INT_MMS_BAL_TYPE_NOT_FOUND;
                                	PutField_Int(hContext,"internal_error",iRet);
                                	break;
                	}		
		} else {
			iRet = INT_AMT_TYPE_NOT_FOUND;
                       	PutField_Int(hContext,"internal_error",iRet);
		}

		// Update Entity Nature Balance (acct_bal/intransit/lien/prepaid)
DEBUGLOG(("ProcessEntityNatureBalance::Call BOMMSEntityBalance:%s\n", csTag));
            	BOObjPtr = CreateObj(BOPtr,"BOMMSEntityBalance",csTag);
            	iRet = (unsigned long)(*BOObjPtr)(hContext, hNatBalRec);
		if (iRet == PD_OK) {
DEBUGLOG(("ProcessEntityNatureBalance::call BOMMSEntityBalance:%s Success!!\n",csTag));
		} else {
DEBUGLOG(("ProcessEntityNatureBalance::call BOMMSEntityBalance:%s Failure!!\n",csTag));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::call BOMMSEntityBalance:UpdateEntityNatureBalance(acct_bal/intransit/lien/prepaid) Failure!!\n");
           	}
        }	

	// Update Entity Transaction
	if (iRet == PD_OK) {
		
/* sub_status */
                PutField_CString(hContext, "sub_status", PD_APPROVED);

/* allow_prepaid */
/*
		if (cBalType == PD_MMS_BAL_TYPE_PREPAID) {
			PutField_Char(hContext, "allow_prepaid", PD_YES);
                } else {
			PutField_Char(hContext, "allow_prepaid", PD_NO);
		}
*/

/* user */
              	PutField_CString(hContext,"add_user",csUser);
              	PutField_CString(hContext,"create_user",csUser);
              	PutField_CString(hContext,"update_user",csUser);
	}

	// Add Txn Element for Fee
	if (iRet == PD_OK) {

		// Check if contains fee
		if (dFeeAmt > 0.00) {
			
/* txn_seq */
			PutField_CString(hTxnElementRec,"txn_seq",csTxnSeq);
DEBUGLOG(("ProcessEntityNatureBalance:: txn_seq = [%s]\n",csTxnSeq));
		
/* txn_element_type */
			PutField_CString(hTxnElementRec, "txn_element_type", PD_ELEMENT_TXN_FEE);
DEBUGLOG(("ProcessEntityNatureBalance:: txn_element_type = [%s]\n",PD_ELEMENT_TXN_FEE));

/* amount */	
			PutField_Double(hTxnElementRec,"amount",dFeeAmt);
DEBUGLOG(("ProcessEntityNatureBalance:: amount = [%.2lf]\n",dFeeAmt));	

/* ccy */
			PutField_CString(hTxnElementRec,"ccy",csCcy);
DEBUGLOG(("ProcessEntityNatureBalance:: ccy = [%s]\n",csCcy));			

/* add_user */		
			//PutField_CString(hTxnElementRec,"add_user",csUser);
//DEBUGLOG(("ProcessEntityNatureBalance:: add_user = [%s]\n",csUser));

			// Add Txn Element
DEBUGLOG(("ProcessEntityNatureBalance:: Call BOMMSTxnElement AddTxnElement\n"));
                	BOObjPtr = CreateObj(BOPtr, "BOMMSTxnElement","AddTxnElement");
                	iRet = (unsigned long)(*BOObjPtr)(hTxnElementRec);
                	if (iRet == PD_OK) {
DEBUGLOG(("ProcessEntityNatureBalance:: Call BOMMSTxnElement:: Success!!!\n"));
                	} else {
                        	iRet = INT_ERR;
DEBUGLOG(("ProcessEntityNatureBalance:: Call BOMMSTxnElement:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::Call BOMMSTxnElement:: Failure!!!\n");
                	}
		}
	}	

	// FX Pool
	if (iRet == PD_OK) {

/* aff_fx_amt */
        	if (GetField_Double(hData,"aff_fx_amt",&dAffFxAmt)) {
DEBUGLOG(("ProcessEntityNatureBalance: aff_fx_amt = [%.2lf]\n",dAffFxAmt));
        	} else {
DEBUGLOG(("ProcessEntityNatureBalance:: aff_fx_amt missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: aff_fx_amt missing!!\n");
                	iRet = INT_MMS_AFF_FX_AMT_NOT_FOUND;
        	}

/* non_aff_fx_amt */
        	if (GetField_Double(hData,"non_aff_fx_amt",&dNonAffFxAmt)) {
DEBUGLOG(("ProcessEntityNatureBalance: non_aff_fx_amt = [%.2lf]\n",dNonAffFxAmt));
        	} else {
DEBUGLOG(("ProcessEntityNatureBalance:: non_aff_fx_amt missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: non_aff_fx_amt missing!!\n");
                	iRet = INT_MMS_NON_AFF_FX_AMT_NOT_FOUND;
        	}

/* fx_cnt */
        	if (GetField_Int(hData,"fx_cnt",&iFxCnt)) {
DEBUGLOG(("ProcessEntityNatureBalance: fx_cnt = [%d]\n",iFxCnt));
        	} else {
DEBUGLOG(("ProcessEntityNatureBalance:: fx_cnt missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: fx_cnt missing!!\n");
                	iRet = INT_MMS_FX_CNT_NOT_FOUND;
        	}

		if (iRet == PD_OK) {

                	for (i=1; i<=iFxCnt; i++)
                	{
/* fx_acr_ind */
                        	sprintf(csTag,"fx.%d.acr_ind",i);
                        	if (GetField_Int(hData,csTag,&iAcrInd)) {
DEBUGLOG(("ProcessEntityNatureBalance: fx_acr_ind_%d = [%d]\n",i,iAcrInd));
                                	PutField_Int(hData, csTag, iAcrInd);
                        	} else {
DEBUGLOG(("ProcessEntityNatureBalance:: fx_acr_ind missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: fx_acr_ind missing!!\n");
                                	iRet = INT_MMS_FX_ACR_IND_NOT_FOUND;
                        	}

/* fx_occy */
                        	sprintf(csTag,"fx.%d.occy",i);
                        	if (GetField_CString(hData,csTag,&csFxOccy)) {
DEBUGLOG(("ProcessEntityNatureBalance: fx_occy_%d = [%s]\n",i,csFxOccy));
                        	} else {
DEBUGLOG(("ProcessEntityNatureBalance:: fx_occy missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: fx_occy missing!!\n");
                                	iRet = INT_MMS_FX_ORG_CCY_NOT_FOUND;
                        	}

/* fx_ccy */
                        	sprintf(csTag,"fx.%d.ccy",i);
                        	if (GetField_CString(hData,csTag,&csFxCcy)) {
DEBUGLOG(("ProcessEntityNatureBalance: fx_ccy_%d = [%s]\n",i,csFxCcy));
                        	} else {
DEBUGLOG(("ProcessEntityNatureBalance:: fx_ccy missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: fx_ccy missing!!\n");
                                	iRet = INT_MMS_FX_CCY_NOT_FOUND;
                        	}

/* fx_amt */
                        	sprintf(csTag,"fx.%d.amt",i);
                        	if (GetField_Double(hData,csTag,&dFxAmt)) {
DEBUGLOG(("ProcessEntityNatureBalance: fx_amt_%d = [%.2lf]\n",i,dFxAmt));
                        	} else {
DEBUGLOG(("ProcessEntityNatureBalance:: fx_amt missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: fx_amt missing!!\n");
                                	iRet = INT_MMS_FX_AMT_NOT_FOUND;
                        	}

				// TBD...
                	}
        	}
	}

	hash_destroy(hEntityRec);
	FREE_ME(hEntityRec);

	hash_destroy(hAdjTypeRec);
	FREE_ME(hAdjTypeRec);

	hash_destroy(hAdjTypeEntityRec);
	FREE_ME(hAdjTypeEntityRec);

	hash_destroy(hNatBalRec);
        FREE_ME(hNatBalRec);

	hash_destroy(hTxnElementRec);
        FREE_ME(hTxnElementRec);

DEBUGLOG(("ProcessEntityNatureBalance() normal exit iRet = [%d]\n",iRet));
        return iRet;
}

