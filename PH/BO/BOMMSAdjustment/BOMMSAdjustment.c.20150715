/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/06/25              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOMMSAdjustment.h"

char    cDebug;

OBJPTR(DB);
OBJPTR(BO);

void BOMMSAdjustment(char    cdebug)
{
        cDebug = cdebug;
}

int GetCurrentCode(hash_t *hRec)
{
        int     iRet = PD_OK;

        int     iMaxCodeInNum = -1;

DEBUGLOG(("GetCurrentCode::Call DBMmsAdjustmentType: GetMaxCode\n"));
        DBObjPtr = CreateObj(DBPtr,"DBMmsAdjustmentType","GetMaxCode");
        iRet = (unsigned long)((*DBObjPtr)(&iMaxCodeInNum));
	if (iRet == PD_OK) {
DEBUGLOG(("GetCurrentCode::CurrentCode Get [%d]\n", iMaxCodeInNum));

                /* No Current Code Found */
                if (iMaxCodeInNum < 0) {
                        iMaxCodeInNum = 0 ;
                } else {
                        iMaxCodeInNum++;

                        if (iMaxCodeInNum > PD_ADJ_TYPE_MAX_CODE) {
                                /* handle over 99 later */
                                iRet = INT_ERR;
                        }
                }

DEBUGLOG(("GetCurrentCode::CurrentCode Assigned CodeInNum [%d]\n", iMaxCodeInNum));
                PutField_Int(hRec, "code_in_num", iMaxCodeInNum);
        } else {
DEBUGLOG(("GetCurrentCode:GetMaxCode not found\n"));
//ERRLOG("BOMMSAdjustment::GetCurrentCode::GetMaxCode not found!!\n");
                iRet = INT_ERR;
        }

DEBUGLOG(("GetCurrentCode: return iRet [%d]\n", iRet));
        return  iRet;
}

int ValidateProcess(hash_t* hRec)
{
	int     iRet = PD_OK;
        int     iDtlRet = PD_OK;

        //int     iCodeInNum;
        //int     iNewDisabled;
        int     iCurrentDisabled;
        int     iCurrentAllowModify;

        char    *csCode = NULL;

	hash_t  *hCurrAdjRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hCurrAdjRec,0);

/* adj_code */
        if (GetField_CString(hRec,"adj_code",&csCode)) {
DEBUGLOG(("ValidateProcess: adj_code = [%s]\n",csCode));
        } else {
DEBUGLOG(("ValidateProcess:: code missing!!\n"));
//ERRLOG("BOMMSAdjustment:: ValidateProcess:: code missing!!\n");
                iRet = INT_MMS_ADJ_CODE_NOT_FOUND;
	}

/* code_in_num */
/*
        if (GetField_Int(hRec,"code_in_num",&iCodeInNum)) {
DEBUGLOG(("ValidateProcess: code_in_num = [%d]\n",iCodeInNum));
        } else {
DEBUGLOG(("ValidateProcess:: code_in_num missing!!\n"));
ERRLOG("BOMMSAdjustment:: ValidateProcess:: code_in_num missing!!\n");
                iRet = INT_MMS_ADJ_CODE_NOT_FOUND;
        }
*/

	if (iRet == PD_OK) {

		// Get MMS Adjustment Type Record
DEBUGLOG(("ValidateProcess:: Call DBMmsAdjustmentType GetAdjustmentTypeRec\n"));
           	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","GetAdjustmentTypeRec");
             	iDtlRet = (unsigned long)(*DBObjPtr)(csCode,hCurrAdjRec);
              	if (iDtlRet == PD_OK) {
DEBUGLOG(("ValidateProcess:: Call DBMmsAdjustmentType:: Success!!!\n"));
		
/* disabled */
			if (GetField_Int(hCurrAdjRec, "disabled", &iCurrentDisabled)) {
DEBUGLOG(("ValidateProcess:: GetOLAdjustmentTypeRec:: disabled = [%d]\n",iCurrentDisabled));
			}

/* allow_modify */
			if (GetField_Int(hCurrAdjRec, "allow_modify", &iCurrentAllowModify)) {
DEBUGLOG(("ValidateProcess:: GetOLAdjustmentTypeRec:: allow_modify = [%d]\n",iCurrentAllowModify));

				if (iCurrentAllowModify != PD_TRUE) {
					iRet = INT_MMS_ADJ_TYPE_NOT_ALLOW_MODIFY;
				}
                       	}
           	} else {
                    	iRet = INT_ERR;
DEBUGLOG(("ValidateProcess:: Call DBMmsAdjustmentType:: Failure!!!\n"));
//ERRLOG("BOMMSAdjustment::ValidateProcess::Call DBMmsAdjustmentType:: Failure!!!\n");
           	}

		// Check Record Exists
		if (iRet == PD_OK) {
				
DEBUGLOG(("ValidateProcess:: Call DBMmsTransaction: ChkTxnCodeExist\n"));
                    	DBObjPtr = CreateObj(DBPtr,"DBMmsTransaction","ChkTxnCodeExist");
                    	iDtlRet = (unsigned long)(*DBObjPtr)(csCode);
                    	if (iDtlRet == PD_FOUND) {
DEBUGLOG(("ValidateProcess:: Call DBMmsTransaction: ChkTxnCodeExist: FOUND\n"));

                               	iRet = PD_FALSE;
                    	} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("ValidateProcess:: Call DBMmsTransaction: ChkTxnCodeExist: NOT FOUND\n"));
				
				iRet = PD_TRUE;
                    	} else {
DEBUGLOG(("ValidateProcess:: Call DBMmsTransaction: ChkTxnCodeExist: ERR\n"));
//ERRLOG("BOOLAdjustment:: ValidateProcess:: Call DBMmsTransaction: ChkTxnCode Exist :: Error!!\n");
                            	iRet = INT_ERR;
                     	}
		}
	}

	hash_destroy(hCurrAdjRec);
        FREE_ME(hCurrAdjRec);

DEBUGLOG(("ValidateProcess() normal exit iRet = [%d]\n",iRet));
        return iRet;
}

int AddAdjustmentType (hash_t* hData, hash_t* hContext)
{
	int	iRet = PD_OK;
	int	iDtlRet = PD_FOUND;

	int	iAdjEtypeCnt = 0;
	int	iCurrentCode = 0;
	int	iTmp = 0;
	int	i = 0;

	char	cAdjEtypeAction;	

	char*	csTmp = NULL;

	char	csTxnCode[PD_TXN_CODE_LEN + 1];
	char	csDesc[PD_DESC_LEN + 1];	
	char    csTag[PD_TAG_LEN + 1];

	hash_t  *hFindRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hFindRec,0);

	hash_t  *hTxnCodeRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnCodeRec,0);

	cAdjEtypeAction = ' ';

DEBUGLOG(("AddAdjustmentType() Start!\n"));

/* adj_code */
        if (GetField_CString(hData,"adj_code",&csTmp)) {
DEBUGLOG(("AddAdjustmentType: adj_code = [%s]\n",csTmp));
		PutField_CString(hFindRec, "adj_code", csTmp);
	
		iCurrentCode = atoi(csTmp + 1);
                PutField_Int(hData, "code_in_num", iCurrentCode);

DEBUGLOG(("AddAdjustmentType: CurrentCodeInNum = [%d]\n",iCurrentCode));
        } else {

		// Get Current Code
		iRet = GetCurrentCode(hData);
		if (iRet == PD_OK) {
			if (GetField_Int(hData, "code_in_num", &iCurrentCode)) {
                		PutField_Int(hData, "code_in_num", iCurrentCode);
DEBUGLOG(("AddAdjustmentType: CurrentCodeInNum [%d]\n", iCurrentCode));
				
				sprintf(csTxnCode, "%c%02d", PD_ADJ_TXN_CODE_PREFIX, iCurrentCode); // 's'
DEBUGLOG(("AddAdjustmentType: CurrentCode [%s]\n", csTxnCode));

                                PutField_CString(hData, "adj_code", csTxnCode);
                                PutField_CString(hFindRec, "adj_code", csTxnCode);
			}		
		} else {
DEBUGLOG(("AddAdjustmentType:: Get adj_code Failure!!\n"));
ERRLOG("BOMMSAdjustment:: AddAdjustmentType:: Get adj_code Failure!!\n");
                        iRet = INT_CODE_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
                }
	}

/* adj_desc */
	if (GetField_CString(hData,"adj_desc",&csTmp)) {
DEBUGLOG(("AddAdjustmentType: adj_desc = [%s]\n",csTmp));
       
		// Desc Prefix
		if (strlen(PD_ADJ_DESC_PREFIX) + strlen(csTmp) > PD_DESC_LEN){
                     	iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                     	PutField_Int(hContext,"internal_error",iRet);
             	} else {
                    	memset(csDesc, 0, sizeof(csDesc));
                     	strcpy(csDesc, PD_ADJ_DESC_PREFIX); // "Adjustment - "
                      	strncpy(&csDesc[strlen(PD_ADJ_DESC_PREFIX)], csTmp, PD_DESC_LEN - strlen(PD_ADJ_DESC_PREFIX));
                     	PutField_CString(hData, "adj_desc", csDesc);
              	}
        } else {
DEBUGLOG(("AddAdjustmentType:: adj_desc missing!!\n"));
ERRLOG("BOMMSAdjustment:: Authorize:: adj_desc missing!!\n");
            	iRet = INT_MMS_ADJ_NAME_NOT_FOUND;
             	PutField_Int(hContext,"internal_error",iRet);
	}

/*
 * Adjustment Type       
 */

	if (iRet == PD_OK) {

/* disabled */
		if (GetField_Int(hData,"disabled",&iTmp)) {
DEBUGLOG(("AddAdjustmentType: disabled = [%d]\n",iTmp));

        	} else {
DEBUGLOG(("AddAdjustmentType:: disabled missing!!\n"));
ERRLOG("BOMMSAdjustment:: AddAdjustmentType:: disabled missing!!\n");
                        iRet = INT_DISABLED_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
		}		

		// Find Adjustment Type
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType Find\n"));
       		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Find");
      		iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
       		if (iDtlRet == PD_FOUND) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Found!!!\n"));

/* disabled */
			if (GetField_Int(hFindRec,"disabled",&iTmp)) {	
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: disabled = [%d]\n", iTmp));
			}

			// Update Adjustment Type
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType Update\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Update");
                	iDtlRet = (unsigned long)(*DBObjPtr)(hData);
			if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));				
			} else {
				iRet = INT_ERR;
                        	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");		
			}
       		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
			
			// Add Adjustment Type
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType Add\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Add");
                        iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                        } else {
                                iRet = INT_ERR;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
       			}
		} else {
              		iRet = INT_ERR;
            		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
     		}
	}

/*
 * Adjustment Type Entity
 */
		
	if (iRet == PD_OK) {

/* adj_etype_cnt */
        	if (GetField_Int(hData,"adj_etype_cnt",&iAdjEtypeCnt)) {
DEBUGLOG(("AddAdjustmentType: adj_etype_cnt = [%d]\n",iAdjEtypeCnt));
        	} else {
DEBUGLOG(("AddAdjustmentType:: adj_etype_cnt missing!!\n"));
ERRLOG("TxnMmsByUsCEA:: Authorize:: adj_etype_cnt missing!!\n");
        	        iRet = INT_MMS_ADJ_ETYPE_CNT_NOT_FOUND;
        	        PutField_Int(hContext,"internal_error",iRet);
        	}

		for (i=1; i<=iAdjEtypeCnt; i++) {
/* etype */
                    	sprintf(csTag,"adj_etype.%d.etype",i);
                        if (GetField_CString(hData,csTag,&csTmp)) {
DEBUGLOG(("AddAdjustmentType: adj_etype.%d.etype = [%s]\n",i,csTmp));
                		PutField_CString(hData,"adj_entity_type",csTmp);
                		PutField_CString(hFindRec,"adj_entity_type",csTmp);
			} else {
DEBUGLOG(("AddAdjustmentType:: adj_entity_type missing!!\n"));
ERRLOG("BOMMSAdjustment:: AddAdjustmentType:: adj_entity_type missing!!\n");
                		iRet = INT_MMS_ADJ_ETYPE_NOT_FOUND;
                		PutField_Int(hContext,"internal_error",iRet);
        		}

/* etype_action */
			sprintf(csTag,"adj_etype.%d.etype_action",i);
                        if (GetField_Char(hData,csTag,&cAdjEtypeAction)) {
DEBUGLOG(("AddAdjustmentType: adj_etype.%d.etype_action = [%c]\n",i,cAdjEtypeAction));
				
				if (cAdjEtypeAction == PD_ACTION_ADD) {
					PutField_Int(hData,"disabled",0);
				} else if (cAdjEtypeAction == PD_ACTION_DELETE) {
					PutField_Int(hData,"disabled",1);
				}
                        } else {
DEBUGLOG(("AddAdjustmentType:: adj_entity_type_action missing!!\n"));
ERRLOG("BOMMSAdjustment:: AddAdjustmentType:: adj_entity_type_action missing!!\n");
                                iRet = INT_MMS_ADJ_ETYPE_ACTION_NOT_FOUND;
                                PutField_Int(hContext,"internal_error",iRet);
                        }

			if (iRet == PD_OK) {
                		// Find Adjustment Type Entity
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity Find\n"));
                		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Find");
                		iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
                		if (iDtlRet == PD_FOUND) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Found!!!\n"));

/* disabled */
                        		if (GetField_Int(hFindRec,"disabled",&iTmp)) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: disabled = [%d]\n", iTmp));
                        		}

					// Update Adjustment Type Entity
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity Update\n"));
                        		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Update");
                        		iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        		if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                        		} else {
                                		iRet = INT_ERR;
                                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
                        		}
                		} else if (iDtlRet == PD_NOT_FOUND) {		
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Not Found!!!\n"));

					// Add Adjustment Type Entity
					if (cAdjEtypeAction == PD_ACTION_ADD) {	
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity Add\n"));
                        			DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Add");
                        			iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        			if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                        			} else {
                                			iRet = INT_ERR;
                                			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
						}
					}
				} else {
                        		iRet = INT_ERR;
                        		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
                		}
			}
		}
	}	

/*
 * Txn Code
 */
	if (iRet == PD_OK) {	
	
/* txn_code */
                if (GetField_CString(hData, "adj_code", &csTmp)) {
DEBUGLOG(("AddAdjustmentType:: txn_code = [%s]\n",csTmp));
                        PutField_CString(hTxnCodeRec, "txn_code", csTmp);
                }

/* txn_desc */
                if (GetField_CString(hData, "adj_desc", &csTmp)) {
DEBUGLOG(("AddAdjustmentType:: desc = [%s]\n",csTmp));
                        PutField_CString(hTxnCodeRec, "txn_desc", csTmp);
                }

/* process_type */
		PutField_CString(hTxnCodeRec, "process_type", "0000");
DEBUGLOG(("AddAdjustmentType:: process_type = [0000]\n"));

/* process_code */
              	PutField_CString(hTxnCodeRec, "process_code", "000000");
DEBUGLOG(("AddAdjustmentType:: process_code = [000000]\n"));

/* create_user */
                if (GetField_CString(hData, "user", &csTmp)) {
DEBUGLOG(("AddAdjustmentType:: create_user = [%s]\n",csTmp));
                        PutField_CString(hTxnCodeRec, "create_user", csTmp);
                        PutField_CString(hTxnCodeRec, "update_user", csTmp);
                }

		// Find Txn Code
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode Find\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Find");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Found!!!\n"));

			// Update Txn Code
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode Update\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Update");
                        iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                        if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Success!!!\n"));
                        } else {
                                iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                        }			
		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Not Found!!!\n"));

			// Add Txn Code
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode Add\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Add");
                	iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                	if (iDtlRet == PD_OK) {
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Success!!!\n"));
                	} else {
                        	iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                	}			
                } else {
                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::AddAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                }		
	}

	hash_destroy(hFindRec);
        FREE_ME(hFindRec);	

	hash_destroy(hTxnCodeRec);
        FREE_ME(hTxnCodeRec);

DEBUGLOG(("AddAdjustmentType() normal exit iRet = [%d]\n",iRet));
	return iRet;
}

int UpdateAdjustmentType (hash_t* hData, hash_t* hContext) 
{
	int     iRet = PD_OK;
        int     iDtlRet = PD_FOUND;

	int     iAdjEtypeCnt = 0;
        int     iTmp = 0;
	int	i = 0;

	char	cAdjEtypeAction;

        char*   csTmp = NULL;

	char    csDesc[PD_DESC_LEN + 1];
	char    csTag[PD_TAG_LEN + 1];

	hash_t  *hFindRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hFindRec,0);

	hash_t  *hAdjTypeRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hAdjTypeRec,0);

        hash_t  *hTxnCodeRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnCodeRec,0);

	cAdjEtypeAction = ' ';

DEBUGLOG(("UpdateAdjustmentType() Start!\n"));

/* adj_code */
        if (GetField_CString(hData,"adj_code",&csTmp)) {
DEBUGLOG(("AddAdjustmentType: adj_code = [%s]\n",csTmp));
		PutField_CString(hFindRec, "adj_code", csTmp);
        } else {
DEBUGLOG(("AddAdjustmentType:: adj_code missing!!\n"));
ERRLOG("BOMMSAdjustment:: AddAdjustmentType:: adj_code missing!!\n");
                iRet = INT_MMS_ADJ_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/*
 * Adjustment Type
 */

        if (iRet == PD_OK) {
	
/* disabled */
                if (GetField_Int(hData,"disabled",&iTmp)) {
DEBUGLOG(("UpdateAdjustmentType: disabled = [%d]\n",iTmp));

                } else {
DEBUGLOG(("UpdateAdjustmentType:: disabled missing!!\n"));
ERRLOG("BOMMSAdjustment:: UpdateAdjustmentType:: disabled missing!!\n");
                        iRet = INT_DISABLED_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
                }
	
		// Find Adjustment Type
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType Find\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Find");
                iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Found!!!\n"));

/* disabled */
                        if (GetField_Int(hFindRec,"disabled",&iTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: disabled = [%d]\n", iTmp));
                        }

			// Check Validate Process
			iDtlRet = ValidateProcess(hData);
                        if (iDtlRet == PD_FALSE) {
				
/* adj_code */
                		if (GetField_CString(hData, "adj_code", &csTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: adj_code = [%s]\n",csTmp));
                        		PutField_CString(hAdjTypeRec, "adj_code", csTmp);
                		}

/* adj_desc */
                		if (GetField_CString(hData, "adj_desc", &csTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: adj_desc = [%s]\n",csTmp));

					// Desc Prefix	
					if (strlen(PD_ADJ_DESC_PREFIX) + strlen(csTmp) > PD_DESC_LEN){
                        			iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        			PutField_Int(hContext,"internal_error",iRet);
                			} else {
                        			memset(csDesc, 0, sizeof(csDesc));
                        			strcpy(csDesc, PD_ADJ_DESC_PREFIX); // "Adjustment - "
                        			strncpy(&csDesc[strlen(PD_ADJ_DESC_PREFIX)], csTmp, PD_DESC_LEN - strlen(PD_ADJ_DESC_PREFIX));
                       	 			PutField_CString(hAdjTypeRec, "adj_desc", csDesc);
                			}

                        		//PutField_CString(hAdjTypeRec, "adj_desc", csTmp);
               	 		}				

/* user */			
                                if (GetField_CString(hData, "user", &csTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: update_user = [%s]\n",csTmp));
                                        PutField_CString(hAdjTypeRec, "update_user", csTmp);
                                }	
	
				// Update Adjustment Type (Desc Only)
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType Update (Desc Only)\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Update");
                                iDtlRet = (unsigned long)(*DBObjPtr)(hAdjTypeRec);
                                if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                                } else {
                                        iRet = INT_ERR;
                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
                                }				
			} else if (iDtlRet == PD_TRUE) {
	
/* adj_desc */
                                if (GetField_CString(hData, "adj_desc", &csTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: adj_desc = [%s]\n",csTmp));

					// Desc Prefix
					if (strlen(PD_ADJ_DESC_PREFIX) + strlen(csTmp) > PD_DESC_LEN){
                                                iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                                                PutField_Int(hContext,"internal_error",iRet);
                                        } else {
                                                memset(csDesc, 0, sizeof(csDesc));
                                                strcpy(csDesc, PD_ADJ_DESC_PREFIX); // "Adjustment - "
                                                strncpy(&csDesc[strlen(PD_ADJ_DESC_PREFIX)], csTmp, PD_DESC_LEN - strlen(PD_ADJ_DESC_PREFIX));
                                                PutField_CString(hData, "adj_desc", csDesc);
DEBUGLOG(("UpdateAdjustmentType:: adj_desc (with Prefix) = [%s]\n",csDesc));
                                        }
				}
	
				// Update Adjustment Type
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType Update\n"));
                        	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Update");
                        	iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        	if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                        	} else {
                        	        iRet = INT_ERR;
                        	        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
                        	}
			} else {
				iRet = iDtlRet;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
			}	
		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
			iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Not Found!!!\n");
		} else {
			iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");	
		}
	}

/*
 * Adjustment Type Entity
 */

	if (iRet == PD_OK) {

/* adj_etype_cnt */
                if (GetField_Int(hData,"adj_etype_cnt",&iAdjEtypeCnt)) {
DEBUGLOG(("UpdateAdjustmentType: adj_etype_cnt = [%d]\n",iAdjEtypeCnt));
                } else {
DEBUGLOG(("UpdateAdjustmentType:: adj_etype_cnt missing!!\n"));
ERRLOG("BOMMSAdjustment:: UpdateAdjustmentType:: adj_etype_cnt missing!!\n");
                        iRet = INT_MMS_ADJ_ETYPE_CNT_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
                }

		for (i=1; i<=iAdjEtypeCnt; i++) {
/* etype */
                        sprintf(csTag,"adj_etype.%d.etype",i);
                        if (GetField_CString(hData,csTag,&csTmp)) {
DEBUGLOG(("UpdateAdjustmentType: adj_etype.%d.etype = [%s]\n",i,csTmp));
                                PutField_CString(hData,"adj_entity_type",csTmp);
                		PutField_CString(hFindRec,"adj_entity_type",csTmp);
                        }

/* etype_action */
                        sprintf(csTag,"adj_etype.%d.etype_action",i);
                        if (GetField_Char(hData,csTag,&cAdjEtypeAction)) {
DEBUGLOG(("UpdateAdjustmentType: adj_etype.%d.etype_action = [%c]\n",i,cAdjEtypeAction));

                                if (cAdjEtypeAction == PD_ACTION_ADD) {
                                        PutField_Int(hData,"disabled",0);
                                } else if (cAdjEtypeAction == PD_ACTION_DELETE) {
                                        PutField_Int(hData,"disabled",1);
                                }
                        }

			if (iRet == PD_OK) {
				// Find Adjustment Type Entity
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity Find\n"));
                		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Find");
                		iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
                		if (iDtlRet == PD_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Found!!!\n"));

/* disabled */
                        		if (GetField_Int(hFindRec,"disabled",&iTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: disabled = [%d]\n", iTmp));
                        		}

					// Update Adjustment Type Entity
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity Update\n"));
                        		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Update");
                        		iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        		if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                        		} else {
                                		iRet = INT_ERR;
                                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
                        		}
                		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Not Found!!!\n"));

					// Add Adjustment Type Entity
                                        if (cAdjEtypeAction == PD_ACTION_ADD) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity Add\n"));
                                                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Add");
                                                iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                                                if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                                                } else {
                                                        iRet = INT_ERR;
                                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
						}
 					}                                         
                		} else {
                        		iRet = INT_ERR;
                        		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Error!!!\n");
                		}
			}
		}		
	}

/*
 * Txn Code
 */
        if (iRet == PD_OK) {

/* txn_code */
                if (GetField_CString(hData, "adj_code", &csTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: txn_code = [%s]\n",csTmp));
                        PutField_CString(hTxnCodeRec, "txn_code", csTmp);
                }

/* txn_desc */
                if (GetField_CString(hData, "adj_desc", &csTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: desc = [%s]\n",csTmp));
                        PutField_CString(hTxnCodeRec, "txn_desc", csTmp);
                }

/* process_type */
                PutField_CString(hTxnCodeRec, "process_type", "0000");
DEBUGLOG(("UpdateAdjustmentType:: process_type = [0000]\n"));

/* process_code */
                PutField_CString(hTxnCodeRec, "process_code", "000000");
DEBUGLOG(("UpdateAdjustmentType:: process_code = [000000]\n"));

/* update_user */
                if (GetField_CString(hData, "user", &csTmp)) {
DEBUGLOG(("UpdateAdjustmentType:: update_user = [%s]\n",csTmp));
                        PutField_CString(hTxnCodeRec, "update_user", csTmp);
                }
		
		// Find Txn Code
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode Find\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Find");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                if (iDtlRet == FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode:: Found!!!\n"));

			// Update Txn Code
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode Update\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Update");
                	iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                	if (iDtlRet == PD_OK) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode:: Success!!!\n"));
                	} else {
                        	iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                	}
                } else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode:: Not Found!!!\n"));
			
			iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode:: Not Found!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsTxnCode:: Not Found!!!\n");
                } else {
                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("UpdateAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::UpdateAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                }
        }

	hash_destroy(hFindRec);
        FREE_ME(hFindRec);

	hash_destroy(hAdjTypeRec);
        FREE_ME(hAdjTypeRec);

	hash_destroy(hTxnCodeRec);
        FREE_ME(hTxnCodeRec);

DEBUGLOG(("UpdateAdjustmentType() normal exit iRet = [%d]\n",iRet));
	return iRet;
}

int DeleteAdjustmentType (hash_t* hData, hash_t* hContext)
{
        int     iRet = PD_OK;
        int     iDtlRet = PD_FOUND;
	int	iValidRet = PD_TRUE;

        int     iTmp = 0;

	char*	csAdjCode = NULL;
        char*   csTmp = NULL;

	hash_t  *hFindRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hFindRec,0);

        hash_t  *hTxnCodeRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnCodeRec,0);

	hash_t  *hRec = NULL;
	recordset_t	*rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
	
DEBUGLOG(("DeleteAdjustmentType() Start!\n"));

/* adj_code */
        if (GetField_CString(hData,"adj_code",&csAdjCode)) {
DEBUGLOG(("DeleteAdjustmentType: adj_code = [%s]\n",csAdjCode));
		PutField_CString(hFindRec,"adj_code",csAdjCode);
        } else {
DEBUGLOG(("DeleteAdjustmentType:: adj_code missing!!\n"));
ERRLOG("BOMMSAdjustment:: DeleteAdjustmentType:: adj_code missing!!\n");
                iRet = INT_MMS_ADJ_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/*
 * Adjustment Type
 */
	
	if (iRet == PD_OK) {

		// Find Adjustment Type
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType Find\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Find");
                iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Found!!!\n"));

/* disabled */
                   	if (GetField_Int(hFindRec,"disabled",&iTmp)) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: disabled = [%d]\n", iTmp));
                      	}

			// Check Validate Process
			iValidRet = ValidateProcess(hData);
			if (iValidRet == PD_FALSE) {

                	        // Update Adjustment Type (Disabled)
				PutField_Int(hData,"disabled",1);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType Update\n"));
                        	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Update");
                        	iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                        	if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                        	} else {
                        	        iRet = INT_ERR;
                        	        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
                        	}
			} else if (iValidRet == PD_TRUE) {

				// Delete Adjustment Type
				PutField_Int(hData,"disabled",1);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType Delete\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentType","Delete");
                                iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                                if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Success!!!\n"));
                                } else {
                                        iRet = INT_ERR;
                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Failure!!!\n");
                                }
			} else {
				iRet = iDtlRet;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
			}
                } else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Not Found!!!\n");
                } else {
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
                }
	}

/*
 * Adjustment Type Entity
 */

	if (iRet == PD_OK) {

		// Find All djustment Type Entity Type
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity FindEntityType\n"));
               	DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","FindEntityType");
                iDtlRet = (unsigned long)(*DBObjPtr)(hFindRec,rRecordSet);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Found!!!\n"));

			hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* adj_entity_type */
				if (GetField_CString(hRec,"adj_entity_type",&csTmp)) {
DEBUGLOG(("DeleteAdjustmentType: adj_entity_type = [%s]\n",csTmp));
                                        PutField_CString(hData,"adj_entity_type",csTmp);					 
				}

/* disabled */
				PutField_Int(hData,"disabled",1);

				// Update Adjustment Type Entity (Disabled)
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity Update\n"));
                     		DBObjPtr = CreateObj(DBPtr, "DBMmsAdjustmentTypeEntity","Update");
                    		iDtlRet = (unsigned long)(*DBObjPtr)(hData);
                     		if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Success!!!\n"));
                      		} else {
                             		iRet = INT_ERR;
                             		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentTypeEntity:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentTypeEntity:: Failure!!!\n");
                    		}	
				
				hRec = RecordSet_GetNext(rRecordSet);
			}
		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
/*
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Not Found!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Not Found!!!\n");
*/  
              	} else {
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsAdjustmentType:: Error!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsAdjustmentType:: Error!!!\n");
                }
        }

/*
 * Txn Code
 */
	if ((iRet == PD_OK) && (iValidRet == PD_TRUE)) {

/* txn_code */
/*
                if (GetField_CString(hData, "adj_code", &csTmp)) {
DEBUGLOG(("DeleteAdjustmentType:: txn_code = [%s]\n",csTmp));
                        PutField_CString(hTxnCodeRec, "txn_code", csTmp);
                }
*/

/* txn_desc */
/*
                if (GetField_CString(hData, "adj_desc", &csTmp)) {
DEBUGLOG(("DeleteAdjustmentType:: desc = [%s]\n",csTmp));
                        PutField_CString(hTxnCodeRec, "txn_desc", csTmp);
                }
*/

/* process_type */
/*
                PutField_CString(hTxnCodeRec, "process_type", "0000");
DEBUGLOG(("DeleteAdjustmentType:: process_type = [0000]\n"));
*/

/* process_code */
/*
                PutField_CString(hTxnCodeRec, "process_code", "000000");
DEBUGLOG(("DeleteAdjustmentType:: process_code = [000000]\n"));
*/

/*
		// Find Txn Code
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode Find\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Find");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                if (iDtlRet == FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Found!!!\n"));

			// Delete Txn Code
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode Delete\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBMmsTxnCode","Delete");
                	iDtlRet = (unsigned long)(*DBObjPtr)(hTxnCodeRec);
                	if (iDtlRet == PD_OK) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Success!!!\n"));
                	} else {
                        	iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                	}

                } else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Not Found!!!\n"));

                } else {
                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("DeleteAdjustmentType:: Call DBMmsTxnCode:: Failure!!!\n"));
ERRLOG("BOMMSAdjustment::DeleteAdjustmentType::Call DBMmsTxnCode:: Failure!!!\n");
                }		
*/
        }

	hash_destroy(hFindRec);
        FREE_ME(hFindRec);

	hash_destroy(hTxnCodeRec);
        FREE_ME(hTxnCodeRec);

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("DeleteAdjustmentType() normal exit iRet = [%d]\n",iRet));
        return iRet;
}

int ProcessEntityNatureBalance(hash_t* hContext, hash_t* hData)
{
	int 	iRet = PD_OK;

	int     iDisabled = PD_DISABLED;
	int     iAllowBalNegative = PD_FALSE;
        int     iAllowModify = PD_FALSE;

	char	cBalType;
	char	cNature;

	char	*csCode = NULL;
	char    *csCountry = NULL;
        char    *csCcy = NULL;
	char	*csUser = NULL;
	char    *csAmtType = NULL;

	hash_t  *hRec;
        hRec = (hash_t *)malloc(sizeof(hash_t));
        hash_init(hRec, 0);

	hash_t  *hInRec;
        hInRec = (hash_t *)malloc(sizeof(hash_t));
        hash_init(hInRec, 0);

	cBalType = ' ';
	cNature = ' ';

DEBUGLOG(("ProcessEntityNatureBalance() Start!\n"));

/* code */
        if (GetField_CString(hData,"code",&csCode)) {
DEBUGLOG(("ProcessEntityNatureBalance: code = [%s]\n",csCode));
        } else {
DEBUGLOG(("ProcessEntityNatureBalance:: code missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: code missing!!\n");
                iRet = INT_MMS_ADJ_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_country */
        if (GetField_CString(hData,"txn_country",&csCountry)) {
DEBUGLOG(("ProcessEntityNatureBalance: txn_country = [%s]\n",csCountry));
        } else {
DEBUGLOG(("ProcessEntityNatureBalance:: txn_country missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: txn_country missing!!\n");
                iRet = INT_MMS_COUNTRY_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_ccy */
        if (GetField_CString(hData,"txn_ccy",&csCcy)) {
DEBUGLOG(("ProcessEntityNatureBalance: txn_ccy = [%s]\n",csCcy));
        } else {
DEBUGLOG(("ProcessEntityNatureBalance:: txn_ccy missing!!\n"));
ERRLOG("BOMMSAdjustment:: ProcessEntityNatureBalance:: txn_ccy missing!!\n");
                iRet = INT_MMS_CCY_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* user */
        if(GetField_CString(hData,"user",&csUser)) {
DEBUGLOG(("ProcessEntityNatureBalance: user = [%s]\n",csUser));
        }

	// Get Adjustment Type
	if (iRet == PD_OK) {
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsAdjustmentType:GetAdjustmentTypeRec\n"));

                DBObjPtr = CreateObj(DBPtr,"DBMmsAdjustmentType","GetAdjustmentTypeRec");
                iRet = (unsigned long)(*DBObjPtr)(csCode, hRec);
                if (iRet == PD_OK) {

			if (GetField_Char(hRec, "nature", &cNature)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::nature = [%c]\n", cNature));
                        }

			if (GetField_Char(hRec, "bal_type", &cBalType)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::bal_type = [%c]\n", cBalType));
                        }

			if (GetField_CString(hRec, "amt_type", &csAmtType)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::amt_type = [%s]\n", csAmtType));
                        }			

                        if (GetField_Int(hRec, "allow_modify", &iAllowModify)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::allow_modify = [%d]\n", iAllowModify));
                        }

                        if (GetField_Int(hRec, "allow_bal_neg", &iAllowBalNegative)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::allow_bal_neg = [%d]\n", iAllowBalNegative));
                        }

                        if (GetField_Int(hRec, "disabled", &iDisabled)) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::disabled = [%d]\n",iDisabled));

                                if (iDisabled == PD_DISABLED) {
DEBUGLOG(("ProcessEntityNatureBalance::GetAdjustmentTypeRec::not allow to use the code\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::GetAdjustmentTypeRec:: code in disabled!!\n");
                                        iRet = INT_CODE_DISABLED;
                                        PutField_Int(hContext, "internal_error", iRet);
                                }
                        }

                } else {
DEBUGLOG(("ProcessEntityNatureBalance::Call DBMmsAdjustmentType:GetOLAdjustmentTypeRec:: Failure!!\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::Call DBMmsAdjustmentType::GetAdjustmentTypeRec:: Failure!!\n");
                        iRet = PD_ERR;
                        PutField_Int(hContext, "internal_error", iRet);
                }		
	}	
	
	// Entity Balance
	if (iRet == PD_OK) {

		PutField_CString(hInRec,"country",csCountry);		
		PutField_CString(hInRec,"ccy",csCcy);		
		PutField_CString(hContext,"amt_type",csAmtType); 	
		if (cBalType == PD_MMS_BAL_TYPE_ACCT_BAL) {
			PutField_CString(hContext,"bal_amt","acct_bal"); 	
		} else if (cBalType == PD_MMS_BAL_TYPE_INTRANSIT) {
                        PutField_CString(hContext,"bal_amt","intransit"); 
		} else if (cBalType == PD_MMS_BAL_TYPE_LIEN) {
                        PutField_CString(hContext,"bal_amt","lien");
		} else if (cBalType == PD_MMS_BAL_TYPE_PREPAID) {
                        PutField_CString(hContext,"bal_amt","prepaid");
		}
		PutField_CString(hInRec,"update_user",csUser);		
	
		// Update Entity Nature Balance
DEBUGLOG(("ProcessEntityNatureBalance::Call BOMMSEntityBalance:UpdateEntityNatureBalance\n"));
            	BOObjPtr = CreateObj(BOPtr,"BOMMSEntityBalance","UpdateEntityNatureBalance");
            	iRet = (unsigned long)(*BOObjPtr)(hContext, hInRec);
		if (iRet == PD_OK) {
DEBUGLOG(("ProcessEntityNatureBalance::call BOMMSEntityBalance:UpdateEntityNatureBalance Success!!\n"));
		} else {
DEBUGLOG(("ProcessEntityNatureBalance::call BOMMSEntityBalance:UpdateEntityNatureBalance Failure!!\n"));
ERRLOG("BOMMSAdjustment::ProcessEntityNatureBalance::call BOMMSEntityBalance:UpdateEntityNatureBalance Failure!!\n");
                   	iRet=INT_ERR;
           	}
        }	

	// FX Pool
	if (iRet == PD_OK) {
	
		// TBD...
	}

	hash_destroy(hRec);
	FREE_ME(hRec);

	hash_destroy(hInRec);
        FREE_ME(hInRec);

DEBUGLOG(("ProcessEntityNatureBalance() normal exit iRet = [%d]\n",iRet));
        return iRet;
}

