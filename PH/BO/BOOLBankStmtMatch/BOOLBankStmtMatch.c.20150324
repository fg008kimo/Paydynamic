/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/02/27              Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "BOOLBankStmtMatch.h"
#include "myrecordset.h"
#include "myhash.h"
#include "math.h"
#include "time.h"

#define PD_DEFAULT_DATE_FORMAT "%Y%m%d"
#define PD_DEFAULT_TIME_FORMAT "%H%M%S"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void BOOLBankStmtMatch(char cdebug)
{
	cDebug = cdebug;
}

int MatchStmtWithSms(hash_t *hContext, hash_t *hRequest, hash_t *hFile)
{
	int iRet = PD_OK, iDtlRet = PD_NOT_FOUND, iTmpRet;
	char *csInFileName = NULL, *csFileId = NULL;
	char *csPspId = NULL, *csBAID = NULL, *csIntBankCode = NULL, *csBankAcctNum = NULL;
	char *csAcctCcy = NULL, *csAmtType = NULL, *csUser=NULL;
	int iSmsMatchThreshold, iTxnHoldInd = 0;
	int iFoundDstTxnId = 0;
	char *csSysDate = NULL, *csSysTime = NULL;
	char csTxnDateTime[PD_DATETIME_LEN + 1];
	int iIsClassified = PD_FALSE;
	char *csBankAcctType = NULL;
	char *csFirstBaidTxnCode = NULL;
	char *csSecondBaidTxnCode = NULL;
	char *csNextEngineAction = NULL;
	char *csNextEngineTxnCode = NULL;
	char *csNextEngineReconType = NULL;
	char *csFailedBaidTxnCode = NULL;

	char *csOrgTxnCode=NULL, *csOrgSubStatus=NULL;
	char *csTxnCode=NULL, *csTxnAmt=NULL;
	char *csStmtRef=NULL, *csStatTxnId=NULL, *csBAIDTxnId=NULL, *csSecondBAIDTxnId=NULL;
	char *csInputChannel=NULL;
	char csTxnCountry[PD_COUNTRY_LEN + 1];
	double dEstNetAmount=0.0;
	char csDstTxnId[PD_TXN_SEQ_LEN + 1];

	int iCurrLine = 0;

	double dOpenBal=0.0, dCurrBal=0.0, dTxnAmt;

	int iTxnCodeFirstMatch = PD_TRUE;

	char *csTmp = NULL;
	int iTmp;
	double dTmp=0.0;
	double dTmp2=0.0;

	char csSysCmd[PD_TMP_BUF_LEN*3];

	recordset_t *rTxn;

	hash_t *hRec = (hash_t*) malloc (sizeof(hash_t));
	hash_t *hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_t *hStmtEngine = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hStmtEngine, 0);

/* in_file_name */
	if (GetField_CString(hContext, "in_file_name", &csInFileName)) {
// DEBUGLOG(("MatchStmtWithSms() in_file_name = [%s]\n", csInFileName));
	} else {
DEBUGLOG(("MatchStmtWithSms() in_file_name NOT FOUND!!!\n"));
		iRet = PD_ERR;
	}

/* file_id */
	if (GetField_CString(hContext, "file_id", &csFileId)) {
// DEBUGLOG(("MatchStmtWithSms() file_id = [%s]\n", csFileId));
	} else {
DEBUGLOG(("MatchStmtWithSms() file_id NOT FOUND!!!\n"));
		iRet = PD_ERR;
	}

/* psp_id */
	if (GetField_CString(hContext, "psp_id", &csPspId)) {
// DEBUGLOG(("MatchStmtWithSms() psp_id = [%s]\n", csPspId));
	} else {
DEBUGLOG(("MatchStmtWithSms() psp_id NOT FOUND!!!\n"));
		iRet = PD_ERR;
	}

/* baid */
	if (GetField_CString(hContext, "baid", &csBAID)) {
// DEBUGLOG(("MatchStmtWithSms() baid = [%s]\n", csBAID));
	} else {
DEBUGLOG(("MatchStmtWithSms() baid NOT FOUND!!!\n"));
		iRet = PD_ERR;
	}

/* int_bank_code */
	if (GetField_CString(hContext, "int_bank_code", &csIntBankCode)) {
// DEBUGLOG(("MatchStmtWithSms() int_bank_code = [%s]\n", csIntBankCode));
	} else {
DEBUGLOG(("MatchStmtWithSms() int_bank_code NOT FOUND!!!\n"));
		iRet = PD_ERR;
	}

/* bank_acct_num */
	if (GetField_CString(hContext, "bank_acct_num", &csBankAcctNum)) {
// DEBUGLOG(("MatchStmtWithSms() bank_acct_num = [%s]\n", csBankAcctNum));
	} else {
DEBUGLOG(("MatchStmtWithSms() bank_acct_num NOT FOUND!!!\n"));
		iRet = PD_ERR;
	}

/* acct_ccy */
	if (GetField_CString(hContext, "acct_ccy", &csAcctCcy)) {
// DEBUGLOG(("MatchStmtWithSms() ccy = [%s]\n", csAcctCcy));
	} else {
DEBUGLOG(("MatchStmtWithSms() ccy NOT FOUND!!!\n"));
		iRet = PD_ERR;
	}

/* user */
	if (GetField_CString(hContext, "create_user", &csUser)) {
// DEBUGLOG(("MatchStmtWithSms() user = [%s]\n", csUser));
	} else {
DEBUGLOG(("MatchStmtWithSms() user NOT FOUND!!!\n"));
		iRet = PD_ERR;
	}

/* sms_match_threshold */
	if (GetField_Int(hContext, "sms_match_threshold", &iSmsMatchThreshold)) {
// DEBUGLOG(("MatchStmtWithSms() sms_match_threshold = [%d]\n", iSmsMatchThreshold));
	} else {
DEBUGLOG(("MatchStmtWithSms() sms_match_threshold NOT FOUND!!!\n"));
		iRet = PD_ERR;
	}

/* SYS_DATE */
	if (GetField_CString(hContext,"SYS_DATE",&csSysDate)){
// DEBUGLOG(("MatchStmtWithSms() SYS_DATE = [%s]\n", csSysDate));
	} else {
DEBUGLOG(("MatchStmtWithSms() SYS_DATE NOT FOUND!!!\n"));
		iRet = PD_ERR;
	}

/* SYS_TIME */
	if (GetField_CString(hContext,"SYS_TIME",&csSysTime)){
// DEBUGLOG(("MatchStmtWithSms() SYS_TIME = [%s]\n", csSysTime));
	} else {
DEBUGLOG(("MatchStmtWithSms() SYS_TIME NOT FOUND!!!\n"));
		iRet = PD_ERR;
	}

/* dOpenBal */
/*
	if (GetField_Double(hContext, "balance", &dOpenBal)) {
DEBUGLOG(("MatchStmtWithSms() dOpenBal = [%.2lf]\n", dOpenBal));
	} else {
DEBUGLOG(("MatchStmtWithSms() dOpenBal NOT FOUND!!!\n"));
		iRet = PD_ERR;
	}
*/

/*
 * Statement Detail Add
 */
	if (iRet == PD_OK) {
		GetField_Int(hFile, "txn_code_first_match", &iTxnCodeFirstMatch);
DEBUGLOG(("MatchStmtWithSms() Is Txn Code First Match = [%d]\n", iTxnCodeFirstMatch));
		GetField_Int(hFile, "line", &iCurrLine);
DEBUGLOG(("MatchStmtWithSms() Match Start at line %d\n",iCurrLine));
		GetField_CString(hFile,"amt_type",&csAmtType);
		GetField_CString(hFile,"txn_amount",&csTmp);
		GetField_CString(hContext, "bank_acct_type", &csBankAcctType);
		dTxnAmt = atof(csTmp);

	/* STMT-SMS Match */
DEBUGLOG(("MatchStmtWithSms() bank_acct_type = [%s]\n", csBankAcctType));
		// if (!strcmp(csAmtType, PD_CR)) {
		if (!strcmp(csBankAcctType, PD_NATURE_DEPOSIT) &&
			!strcmp(csAmtType, PD_CR)) {
			// backup input channel (SMS_STMT/BNK_STMT)
			GetField_CString(hFile, "input_channel", &csInputChannel);

			PutField_CString(hFile, "trigger_type", PD_TRIGGER_SYSTEM);
			PutField_CString(hFile, "input_channel", PD_CHANNEL_OMT);
			PutField_CString(hFile, "bank_acct_type", PD_NATURE_DEPOSIT);
			PutField_CString(hFile, "baid_txn_code", PD_BANK_DEPOSIT_TXN_CODE);

DEBUGLOG(("MatchStmtWithSms() call BOOLStmtEngine::ProcessMatching()\n"));
			BOObjPtr = CreateObj(BOPtr, "BOOLStmtEngine", "ProcessMatching");
			iDtlRet = (unsigned long)(*BOObjPtr)(hFile);
			if (iDtlRet == PD_FOUND) {
DEBUGLOG(("MatchStmtWithSms() sms statement found\n"));
				if (!GetField_CString(hFile, "stat_txn_id", &csStatTxnId)) {
					iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call BOOLStmtEngine::ProcessMatching() stat_txn_id NOT FOUND!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call BOOLStmtEngine::ProcessMatching() stat_txn_id NOT FOUND!!!\n");
				}
				if (iRet == PD_OK) {
					DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "GetTxnIdByStatTxnId");
					iRet = (unsigned long)(*DBObjPtr)(hFile);
					if (!GetField_CString(hFile, "txn_id", &csBAIDTxnId)) {
						iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call BOOLStmtEngine::ProcessMatching() txn_id NOT FOUND!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call BOOLStmtEngine::ProcessMatching() txn_id NOT FOUND!!!\n");
					}
				}
			} else if (iDtlRet != PD_NOT_FOUND) {
				iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call BOOLStmtEngine::ProcessMatching() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call BOOLStmtEngine::ProcessMatching() FAILURE!!!\n");
			} else {
				if (GetField_CString(hFile, "first_baid_txn_code", &csFirstBaidTxnCode)) {
DEBUGLOG(("MatchStmtWithSms() first_baid_txn_code = [%s]\n", csFirstBaidTxnCode));
				}
				if (GetField_CString(hFile, "second_baid_txn_code", &csSecondBaidTxnCode)) {
DEBUGLOG(("MatchStmtWithSms() second_baid_txn_code = [%s]\n", csSecondBaidTxnCode));
				}
				if (GetField_CString(hFile, "next_engine_action", &csNextEngineAction)) {
DEBUGLOG(("MatchStmtWithSms() next_engine_action = [%s]\n", csNextEngineAction));
				}
				if (GetField_CString(hFile, "next_engine_txn_code", &csNextEngineTxnCode)) {
DEBUGLOG(("MatchStmtWithSms() next_engine_txn_code [%s]\n", csNextEngineTxnCode));
				}
				if (GetField_CString(hFile, "next_engine_recon_type", &csNextEngineReconType)) {
DEBUGLOG(("MatchStmtWithSms() next_engine_recon_type = [%s]\n", csNextEngineReconType));
				}
			}

/*
		// 1st Match
DEBUGLOG(("MatchStmtWithSms() call DBOLStatement::MatchStmt() same day\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "MatchStmt");
			iDtlRet = (unsigned long)(*DBObjPtr)(hFile);
			if (iDtlRet == PD_FOUND) {
				if (!GetField_CString(hFile,"stat_txn_id",&csStatTxnId)) {
					iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLStatement::MatchStmt() stat_txn_id NOT FOUND!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLStatement::MatchStmt() stat_txn_id NOT FOUND!!!\n");
				}
				if (!GetField_CString(hFile,"txn_id",&csBAIDTxnId)) {
					iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLStatement::MatchStmt() txn_id NOT FOUND!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLStatement::MatchStmt() txn_id NOT FOUND!!!\n");
				}

		// 2nd Match
			} else if (iDtlRet == PD_NOT_FOUND) {
				PutField_Int(hFile,"sms_match_threshold",iSmsMatchThreshold); //
				PutField_CString(hFile,"SYS_DATE",csSysDate); //
				PutField_CString(hFile,"SYS_TIME",csSysTime); //
DEBUGLOG(("MatchStmtWithSms() call DBOLStatement::MatchStmt() within [%d] mins\n",iSmsMatchThreshold));
				DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "MatchStmt");
				iDtlRet = (unsigned long)(*DBObjPtr)(hFile);
				if (iDtlRet == PD_FOUND) {
					if (!GetField_CString(hFile,"stat_txn_id",&csStatTxnId)) {
						iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLStatement::MatchStmt() stat_txn_id NOT FOUND!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLStatement::MatchStmt() stat_txn_id NOT FOUND!!!\n");
					}
					if (!GetField_CString(hFile,"txn_id",&csBAIDTxnId)) {
						iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLStatement::MatchStmt() txn_id NOT FOUND!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLStatement::MatchStmt() txn_id NOT FOUND!!!\n");
					}

				} else if (iDtlRet != PD_NOT_FOUND) {
					iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLStatement::MatchStmt() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLStatement::MatchStmt() FAILURE!!!\n");
				}

			} else {
				iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLStatement::MatchStmt() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLStatement::MatchStmt() FAILURE!!!\n");

			}
*/

		/* MatchRespTxn */
			if (iRet == PD_OK && iDtlRet == PD_FOUND) {
				/* Voided SMS */
DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::MatchRespTxn()\n"));
				DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "MatchRespTxn");
				if ((unsigned long)(*DBObjPtr)(csBAIDTxnId,PD_COMPLETE) != PD_FOUND) {
					iDtlRet = PD_NOT_FOUND; //***
					csStatTxnId = NULL;
					csBAIDTxnId = NULL;
					RemoveField_CString(hFile,"stat_txn_id");
					RemoveField_CString(hFile,"txn_id");
DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::MatchRespTxn() Not Found\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLBAIDTxn::MatchRespTxn() Not Found\n");
				}
			}

			// restore input channel (SMS_STMT/BNK_STMT)
			PutField_CString(hFile, "input_channel", csInputChannel);

			RemoveField_CString(hFile, "trigger_type");
			RemoveField_CString(hFile, "bank_acct_type");
			RemoveField_CString(hFile, "baid_txn_code");
		}

	/* Process */
		if (iRet == PD_OK) {
			if (iDtlRet == PD_FOUND) {
			/* SMS */
DEBUGLOG(("MatchStmtWithSms() SMS FOUND\n"));
				PutField_Int(hFile,"sms",1);

				DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextStmtRef");
				csStmtRef = (*DBObjPtr)();

				/* Get BAID Txn */
				if (iRet == PD_OK) {
					hash_init(hTxn,0);

DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::GetBaidTxn()\n"));
					DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "GetBaidTxn");
					if ((unsigned long)(*DBObjPtr)(csBAIDTxnId,hTxn) != PD_OK) {
						iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::GetBaidTxn() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLBAIDTxn::GetBaidTxn() FAILURE!!!\n");
					} else {
						if (GetField_CString(hTxn,"txn_code",&csOrgTxnCode)) {
						}
					}

					hash_destroy(hTxn);
				}

				/* Get Dst Txn Id */
				if (iRet == PD_OK) {
DEBUGLOG(("MatchStmtWithSms() call OLStmtTxnRelation::GetTxnIdByStmtTxnId()\n"));
					DBObjPtr = CreateObj(DBPtr, "DBOLStmtTxnRelation", "GetTxnIdByStmtTxnId");
					iTmpRet = (unsigned long)(*DBObjPtr)(csBAIDTxnId, csDstTxnId);
					if (iTmpRet != PD_FOUND) {
DEBUGLOG(("MatchStmtWithSms() call OLStmtTxnRelation::GetTxnIdByStmtTxnId() failed\n"));
						iRet = PD_ERR;
					} else {
DEBUGLOG(("MatchStmtWithSms() dst_txn_id = [%s]\n", csDstTxnId));
						iFoundDstTxnId = 1;
					}
				}

				/* Get Transaction */
				if (iRet == PD_OK) {
					//if (csDstTxnId != NULL) {
					if (iFoundDstTxnId) {
						rTxn = (recordset_t*) malloc (sizeof(recordset_t));
						recordset_init(rTxn, 0);

DEBUGLOG(("MatchStmtWithSms() call DBOLTransaction::GetTxnHeader()\n"));
						DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnHeader");
						if ((unsigned long)(*DBObjPtr)(csDstTxnId,rTxn) != PD_OK) {
							iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLTransaction::GetTxnHeader() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLTransaction::GetTxnHeader() FAILURE!!!\n");
						} else {
							hTxn = RecordSet_GetFirst(rTxn);
							if (hTxn) {
								GetField_CString(hFile,"format_txn_code",&csTxnCode);
								if (!strcmp(csOrgTxnCode,PD_BANK_DEPOSIT_TXN_CODE) &&
								     strcmp(csTxnCode,PD_BANK_DEPOSIT_TXN_CODE)) {
									iTxnHoldInd = 1;

									GetField_CString(hTxn,"sub_status",&csOrgSubStatus);
									if (strcmp(csOrgSubStatus,PD_UNALLOCATED)) {
									/* email alert */
										GetField_CString(hFile,"txn_amount",&csTxnAmt);
										snprintf(csSysCmd, sizeof(csSysCmd), "gen_bank_stmt_hold_alert.sh \"%s\" \"<td>%s</td><td>%s</td>\"",csInFileName,csStmtRef,csTxnAmt);
DEBUGLOG(("MatchStmtWithSms() call email alert\n"));
DEBUGLOG(("MatchStmtWithSms() call system command [%s][%d]\n", csSysCmd, strlen(csSysCmd)));
										iDtlRet = system(csSysCmd);

										int errsv = errno;
										if (errsv != 0) {
DEBUGLOG(("MatchStmtWithSms() ERRNO = [%d] (%s)...!!!\n",errsv,strerror(errsv)));
										}

										if (WIFEXITED(iDtlRet)) {
											int status = WEXITSTATUS(iDtlRet);
											if (status == SUCCESS) {
DEBUGLOG(("MatchStmtWithSms() Exited, status %d, No email sent\n",status));
											} else if (status == FAILURE) {
DEBUGLOG(("MatchStmtWithSms() Exited, status %d, Email sent\n",status));
											} else {
DEBUGLOG(("MatchStmtWithSms() Exited, status %d, Email FAILURE!!!\n",status));
											}

										} else if (WIFSIGNALED(iDtlRet)) {
DEBUGLOG(("MatchStmtWithSms() Killed by signal %d...!!!\n", WTERMSIG(iDtlRet)));

										} else {
DEBUGLOG(("MatchStmtWithSms() Others...!!!\n"));

										}

										iTxnHoldInd = 0;
									}
DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::GetBaidTxn() OrgTxnCode [%s][%s] Stmt TxnCode [%s] HoldInd [%d]\n",csOrgTxnCode,csOrgSubStatus,csTxnCode,iTxnHoldInd));
								} else {
									iTxnHoldInd = 0;
DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::GetBaidTxn() OrgTxnCode [%s] Stmt TxnCode [%s]\n",csOrgTxnCode,csTxnCode));
								}
							}
						}

						RecordSet_Destroy(rTxn);
						FREE_ME(rTxn);
					}
				}

				/* Get Transaction for update */
				if (iRet == PD_OK) {
					//if (csDstTxnId != NULL) {
					if (iFoundDstTxnId) {
DEBUGLOG(("MatchStmtWithSms() call DBOLTransaction::GetTxnIdForUpdate()\n"));
						DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnIdForUpdate");
						if ((unsigned long)(*DBObjPtr)(csDstTxnId) != PD_OK) {
							iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLTransaction::GetTxnIdForUpdate() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLTransaction::GetTxnIdForUpdate() FAILURE!!!\n");
						}
					}
				}

				/* Update Statement Detail */
				if (iRet == PD_OK) {
					PutField_CString(hFile,"file_id",csFileId);
					PutField_CString(hFile, "stat_txn_id", csStatTxnId);
					PutField_CString(hFile,"statement_ref",csStmtRef);

DEBUGLOG(("MatchStmtWithSms() call DBOLStatement::UpdateSmsDetail()\n"));
					DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "UpdateSmsDetail");
					if ((unsigned long)(*DBObjPtr)(hFile) != PD_OK) {
						iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLStatement::UpdateSmsDetail() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLStatement::UpdateSmsDetail() FAILURE!!!\n");
					}
				}

				/* Update BAID Txn */
				if (iRet == PD_OK) {
					hash_init(hRec,0);

					PutField_CString(hRec,"txn_seq",csBAIDTxnId);
					PutField_Char(hRec,"recon_status",PD_RECONCILED);
					if (GetField_Int(hFile,"sys_match_ind",&iTmp)) {
						PutField_Int(hRec,"pid_sys_match_ind",iTmp);
					}
					PutField_CString(hRec,"update_user",csUser);
DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::Update()\n"));
					DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Update");
					if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
						iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::Update() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLBAIDTxn::Update() FAILURE!!!\n");
					}

					hash_destroy(hRec);
				}

				/* Update transaction if exists */
				if (iRet == PD_OK) {
					if (iFoundDstTxnId) {
						hash_init(hRec, 0);

						PutField_CString(hRec, "txn_seq", csDstTxnId);
						PutField_Char(hRec, "recon_status", PD_RECONCILED);

						time_t tNow = time(NULL);
						struct tm tStruct = *localtime(&tNow);
						char csDate[PD_DATE_LEN + 1] = "", csTime[PD_TIME_LEN + 1] = "";
						strftime(csDate, sizeof(csDate), PD_DEFAULT_DATE_FORMAT, &tStruct);
						strftime(csTime, sizeof(csTime), PD_DEFAULT_TIME_FORMAT, &tStruct);
DEBUGLOG(("MatchStmtWithSms() System datetime = [%s %s]\n", csDate, csTime));
						PutField_CString(hRec,"recon_date",csDate);
						PutField_CString(hRec,"recon_time",csTime);

						PutField_CString(hRec, "update_user", csUser);
DEBUGLOG(("MatchStmtWithSms() call DBOLTransaction::Update()\n"));
						DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
						if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
							iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLTransaction::Update() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLTransaction::Update() FAILURE!!!\n");
						}

						hash_destroy(hRec);
					}
				}

				/* Update transaction if exists */
				if (iRet == PD_OK) {
					//if (csDstTxnId != NULL) {
					if (iFoundDstTxnId) {
						hash_init(hRec,0);

						PutField_CString(hRec,"txn_seq",csDstTxnId);
					//	if (GetField_CString(hFile,"statement_date",&csTmp)) {
					//		PutField_CString(hRec,"txn_date",csTmp);
					//	}
					//	if (GetField_CString(hFile,"statement_time",&csTmp)) {
					//		PutField_CString(hRec,"txn_time",csTmp);
					//	}
						if (GetField_Int(hFile,"sys_match_ind",&iTmp)) {
							PutField_Int(hRec,"sys_match_ind",iTmp);
						}
						if (GetField_CString(hFile,"tfr_customer_text",&csTmp)) {
							PutField_CString(hRec,"customer_text",csTmp);
						}
						if (GetField_CString(hFile,"sender_name",&csTmp)) {
							PutField_CString(hRec,"sender_name",csTmp);
						}
						if (GetField_CString(hFile,"txn_ref_num",&csTmp)) {
							PutField_CString(hRec,"txn_ref_num",csTmp);
						}

						if (iTxnHoldInd == 1) {
							PutField_Int(hRec,"txn_hold_ind",iTxnHoldInd);
						}

						PutField_CString(hRec,"update_user",csUser);
DEBUGLOG(("MatchStmtWithSms() call DBOLTxnPspDetail::Update()\n"));
						DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Update");
						if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
							iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLTxnPspDetail::Update() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLTxnPspDetail::Update() FAILURE!!!\n");
						}

						hash_destroy(hRec);
					}
				}

				/* Add Ol Txn Remarks */
				if (iRet == PD_OK) {
					//if (csDstTxnId != NULL) {
					if (iFoundDstTxnId) {
						if (iTxnHoldInd == 1) {
							hash_init(hRec,0);

							PutField_CString(hRec,"txn_seq",csDstTxnId);
							PutField_Int(hRec,"txn_hold_ind",iTxnHoldInd);
							PutField_CString(hRec,"stat_txn_id",csStatTxnId);
							PutField_CString(hRec,"remark","System Hold");
							PutField_CString(hRec,"add_user",PD_UPDATE_USER);

DEBUGLOG(("MatchStmtWithSms() call DBOLTxnDepositHoldLog::Add()\n"));
							DBObjPtr = CreateObj(DBPtr, "DBOLTxnDepositHoldLog", "Add");
							if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
								iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLTxnDepositHoldLog::Add() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLTxnDepositHoldLog::Add() FAILURE!!!\n");
							}
							PutField_Int(hFile,"hold",1);

							hash_destroy(hRec);
						}
					}
				}

				iIsClassified = PD_TRUE;

			} else {
			/* Statement */

				// Support Multimatch, check first match
				if (iTxnCodeFirstMatch == PD_TRUE) {
					/* Add Statement Detail */
					DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextStmtTxnSeq");
					csStatTxnId = (*DBObjPtr)();

					DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextStmtRef");
					csStmtRef = (*DBObjPtr)();

					DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextBaidTxnSeq");
					csBAIDTxnId = (*DBObjPtr)();

					if (iRet == PD_OK) {
						PutField_CString(hFile,"file_id",csFileId);
						PutField_CString(hFile,"stat_txn_id",csStatTxnId);
						PutField_CString(hFile,"statement_ref",csStmtRef);
						PutField_CString(hFile,"new_baid_txn_id",csBAIDTxnId);

DEBUGLOG(("MatchStmtWithSms() call DBOLStatement::AddDetail()\n"));
						DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "AddDetail");
						if ((unsigned long)(*DBObjPtr)(hFile) != PD_OK) {
							iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLStatement::AddDetail() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLStatement::AddDetail() FAILURE!!!\n");
						}
					}

					// get baid country
					if (iRet == PD_OK) {
DEBUGLOG(("MatchStmtWithSms() call DBOLBankAcctId::GetBankAcctIdCountry()\n"));
						DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetBankAcctIdCountry");
						iTmpRet = (unsigned long)(*DBObjPtr)(csBAID, csTxnCountry);
						if (iTmpRet != FOUND) {
DEBUGLOG(("MatchStmtWithSms() call DBOLBankAcctId::GetBankAcctIdCountry() failed\n"));
							iRet = INT_ERR;
						} else {
DEBUGLOG(("MatchStmtWithSms() country = [%s]\n", csTxnCountry));
						}
					}

					// calculate estimate net amount (txn amount - bank charge)
					if (iRet == PD_OK && !strcmp(csAmtType, PD_DR)) {
						hash_init(hRec,0);

						/* txn_amt */
						PutField_Double(hRec, "txn_amt", dTxnAmt);

						/* bank_code */
						PutField_CString(hRec, "bank_code", csIntBankCode);

						/* txn_country */
						PutField_CString(hRec, "txn_country", csTxnCountry);

						/* txn_ccy */
						PutField_CString(hRec, "txn_ccy", csAcctCcy);

						/* channel_code */
						if (GetField_CString(hContext, "channel_code", &csTmp)) {
							PutField_CString(hRec, "channel_code", csTmp);
						}
	
						/* txn_code */
						if (GetField_CString(hFile, "format_txn_code", &csTmp)) {
							PutField_CString(hRec, "txn_code", csTmp);
						}

DEBUGLOG(("MatchStmtWithSms() call BOBankCharge::GetTxnBankCharge()\n"));
						BOObjPtr = CreateObj(BOPtr, "BOBankCharge", "GetTxnBankCharge");
						iTmpRet = (unsigned long)(*BOObjPtr)(hRec);
						if (iTmpRet != PD_OK) {
DEBUGLOG(("MatchStmtWithSms() call BOBankCharge::GetTxnBankCharge() failed\n"));
							iRet = INT_ERR;
						} else {
							GetField_Double(hRec, "txn_bank_charge", &dTmp);
DEBUGLOG(("MatchStmtWithSms() txn_bank_charge = [%lf]\n", dTmp));
							dEstNetAmount = dTxnAmt - dTmp;
DEBUGLOG(("MatchStmtWithSms() dEstNetAmount = [%lf]\n", dEstNetAmount));
						}

						hash_destroy(hRec);
					}

					/* Add BAID Txn */
					if (iRet == PD_OK) {
						if (!strcmp(csAmtType, PD_DR)) {
							dCurrBal = dOpenBal - dTxnAmt;
DEBUGLOG(("MatchStmtWithSms() open_bal=[%.2lf], txn_amt=[DR%.2lf], curr_bal=[%.2lf]\n",dOpenBal,dTxnAmt,dCurrBal));
						} else if (!strcmp(csAmtType, PD_CR)) {
							dCurrBal = dOpenBal + dTxnAmt;
DEBUGLOG(("MatchStmtWithSms() open_bal=[%.2lf], txn_amt=[CR%.2lf], curr_bal=[%.2lf]\n",dOpenBal,dTxnAmt,dCurrBal));
						}
	
						hash_init(hRec,0);

						PutField_Int(hRec, "db_commit", PD_FALSE);

						/* txn_seq */
						PutField_CString(hRec,"txn_seq",csBAIDTxnId);

						/* channel_code */
						if (GetField_CString(hContext, "channel_code", &csTmp)) {
							PutField_CString(hRec, "channel_code", csTmp);
						}

						/* status */
						PutField_Char(hRec, "status", PD_COMPLETE);

						/* ar_ind */
						PutField_Char(hRec, "ar_ind", PD_ACCEPT);

						/* sub_status */
						PutField_CString(hRec, "sub_status", PD_APPROVED);

						/* txn_code */
						//if (GetField_CString(hFile,"format_txn_code",&csTmp)) {
						//	PutField_CString(hRec, "txn_code", csTmp);
						//}
						if (!strcmp(csAmtType, PD_CR)) {
							PutField_CString(hRec, "txn_code", PD_TXN_CODE_UNKNOWN_CREDIT);
						} else {
							PutField_CString(hRec, "txn_code", PD_TXN_CODE_UNKNOWN_DEBIT);
						}

						PutField_CString(hRec, "stat_txn_id", csStatTxnId);

						/* pid */
						PutField_CString(hRec, "pid", csPspId);

						/* baid */
						PutField_CString(hRec, "baid", csBAID);

						/* transmission_datetime */
						if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
							strcpy(csTxnDateTime, csTmp);
							PutField_CString(hRec, "transmission_datetime", csTxnDateTime);
						}

						/* transmission_datetime */
						if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
							strcat(csTxnDateTime, csTmp);
							PutField_CString(hRec, "transmission_datetime", csTxnDateTime);
						}

						/* txn_ccy */
						PutField_CString(hRec, "txn_ccy", csAcctCcy);

						/* txn_amt */
						PutField_Double(hRec, "txn_amt", dTxnAmt);

						/* open_bal */
						PutField_Double(hRec, "open_bal", 0.0);

						/* curr_bal */
						PutField_Double(hRec, "curr_bal", 0.0);

						/* approval_date */
						if (GetField_CString(hContext, "PHDATE", &csTmp)) {
							PutField_CString(hRec, "posting_date", csTmp);
							PutField_CString(hRec, "approval_date", csTmp);
						}

						/* approval_timestamp */
						DBObjPtr = CreateObj(DBPtr, "DBSystemControl", "GetApprovalDT");
						(*DBObjPtr)(hRec);

						/* bank_code */
						PutField_CString(hRec, "bank_code", csIntBankCode);

						/* bank_acct_num */
						PutField_CString(hRec, "bank_acct_num", csBankAcctNum);

						/* pid_txn_hold_ind */
						PutField_Int(hRec, "pid_txn_hold_ind", 0);

						/* pid_sys_match_ind */
						PutField_Int(hRec, "pid_sys_match_ind", 1);

						/* posted_ind */
						PutField_Int(hRec, "posted_ind", 0);

						/* create_user */
						PutField_CString(hRec, "add_user", csUser);

						/* recon_status */
						PutField_Char(hRec, "recon_status", PD_UNRECONCILED);

						/* classified_status */
						PutField_Char(hRec, "classified_status", PD_UNCLASSIFIED);

						/* est_net_amount */
						if (dEstNetAmount != 0.0) {
							PutField_Double(hRec, "est_net_amount", dEstNetAmount);
						}

DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::Add()\n"));
						DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Add");
						if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
							iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::Add() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLBAIDTxn::Add() FAILURE!!!\n");
						}
						hash_destroy(hRec);
					}
	
					if (iRet == PD_OK) {
						hash_init(hRec, 0);

						PutField_CString(hRec, "txn_id", csBAIDTxnId);
						PutField_CString(hRec, "stat_txn_id", csStatTxnId);
						PutField_CString(hRec, "update_user", csUser);

DEBUGLOG(("MatchStmtWithSms() call DBOLStatement::UpdateTxnId()\n"));
						DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "UpdateTxnId");
						if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
							iRet = INT_ERR;
DEBUGLOG(("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLStatement::UpdateTxnId() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLStatement::UpdateTxnId() FAILURE!!!\n");
						}
						hash_destroy(hRec);
					}
				} else {
					GetField_CString(hFile,"file_id",&csFileId);
					GetField_CString(hFile,"stat_txn_id",&csStatTxnId);
					GetField_CString(hFile,"statement_ref",&csStmtRef);
					GetField_CString(hFile,"new_baid_txn_id",&csBAIDTxnId);
				}

/******************************
* start stmt engine
******************************/
DEBUGLOG(("MatchStmtWithSms() call stmt engine\n"));
				if (iRet == PD_OK) {
					GetField_CString(hFile, "format_txn_code", &csTxnCode);
DEBUGLOG(("MatchStmtWithSms() format_txn_code = [%s]\n", csTxnCode));
					if (!strcmp(csTxnCode, PD_TXN_CODE_UNKNOWN_CREDIT) || !strcmp(csTxnCode, PD_TXN_CODE_UNKNOWN_DEBIT)) {
DEBUGLOG(("MatchStmtWithSms() unknown credit/debit, skip calling engines\n"));
					} else {
						if (strcmp(csTxnCode, PD_BANK_DEPOSIT_TXN_CODE)) {
							// trigger_type
DEBUGLOG(("MatchStmtWithSms() trigger_type = [%s]\n", PD_TRIGGER_SYSTEM));
							PutField_CString(hStmtEngine, "trigger_type", PD_TRIGGER_SYSTEM);

							// channel_code
							if (GetField_CString(hContext, "channel_code", &csTmp)) {
DEBUGLOG(("MatchStmtWithSms() input_channel = [%s]\n", csTmp));
								PutField_CString(hStmtEngine, "input_channel", csTmp);
							}

							// bank_acct_type
							if (GetField_CString(hContext, "bank_acct_type", &csTmp)) {
DEBUGLOG(("MatchStmtWithSms() bank_acct_type = [%s]\n", csTmp));
								PutField_CString(hStmtEngine, "bank_acct_type", csTmp);
							}

							// baid_txn_code
DEBUGLOG(("MatchStmtWithSms() baid_txn_code = [%s]\n", csTxnCode));
							PutField_CString(hStmtEngine, "baid_txn_code", csTxnCode);

							// baid_txn_id_1
DEBUGLOG(("MatchStmtWithSms() baid_txn_id_1 = [%s]\n", csBAIDTxnId));
							PutField_CString(hStmtEngine, "baid_txn_id_1", csBAIDTxnId);

DEBUGLOG(("MatchStmtWithSms() call BOOLStmtEngine::ProcessMatching()\n"));
							BOObjPtr = CreateObj(BOPtr, "BOOLStmtEngine", "ProcessMatching");
							iTmpRet = (unsigned long)(*BOObjPtr)(hStmtEngine);
							if (iTmpRet == PD_FOUND) {
DEBUGLOG(("MatchStmtWithSms() statement found\n"));
								iIsClassified = PD_TRUE;
								if (GetField_CString(hStmtEngine, "first_baid_txn_code", &csFirstBaidTxnCode)) {
DEBUGLOG(("MatchStmtWithSms() first_baid_txn_code = [%s]\n", csFirstBaidTxnCode));
								}
								if (GetField_CString(hStmtEngine, "second_baid_txn_code", &csSecondBaidTxnCode)) {
DEBUGLOG(("MatchStmtWithSms() second_baid_txn_code = [%s]\n", csSecondBaidTxnCode));
								}
								if (GetField_CString(hStmtEngine, "baid_txn_id_2", &csSecondBAIDTxnId)) {
DEBUGLOG(("MatchStmtWithSms() baid_txn_id_2 = [%s]\n", csSecondBAIDTxnId));
								}
								if (GetField_CString(hStmtEngine, "next_engine_action", &csNextEngineAction)) {
DEBUGLOG(("MatchStmtWithSms() next_engine_action = [%s]\n", csNextEngineAction));
								}
								if (GetField_CString(hStmtEngine, "next_engine_txn_code", &csNextEngineTxnCode)) {
DEBUGLOG(("MatchStmtWithSms() next_engine_txn_code = [%s]\n", csNextEngineTxnCode));
								}
								if (GetField_CString(hStmtEngine, "next_engine_recon_type", &csNextEngineReconType)) {
DEBUGLOG(("MatchStmtWithSms() next_engine_recon_type = [%s]\n", csNextEngineReconType));
								}
							} else if (iTmpRet != PD_NOT_FOUND) {
								iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call BOOLStmtEngine::ProcessMatching() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call BOOLStmtEngine::ProcessMatching() FAILURE!!!\n");
							} else {
								if (GetField_CString(hStmtEngine, "failed_baid_txn_code", &csFailedBaidTxnCode)) {
DEBUGLOG(("MatchStmtWithSms() failed_baid_txn_code = [%s]\n", csFailedBaidTxnCode));
								}
							}
						} else {
							iIsClassified = PD_TRUE;
						}
					}
				}

				// Update BAID Txn
				if (iRet == PD_OK) {
					if (iIsClassified) {
						hash_init(hRec, 0);

						PutField_CString(hRec, "txn_seq", csBAIDTxnId);
						PutField_CString(hRec, "new_txn_code", csFirstBaidTxnCode);
						PutField_Char(hRec, "classified_status", PD_CLASSIFIED);
						PutField_CString(hRec, "update_user", csUser);

						DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Update");
						if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
							iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::Update() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLBAIDTxn::Update() FAILURE!!!\n");
						}

						hash_destroy(hRec);

						if (iRet == PD_OK) {
							if (csSecondBaidTxnCode != NULL && csSecondBAIDTxnId != NULL) {
								hash_init(hRec, 0);

								PutField_CString(hRec, "txn_seq", csSecondBAIDTxnId);
								PutField_CString(hRec, "new_txn_code", csSecondBaidTxnCode);
								PutField_Char(hRec, "classified_status", PD_CLASSIFIED);
								PutField_CString(hRec, "update_user", csUser);

								DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Update");
								if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
									iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::Update() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLBAIDTxn::Update() FAILURE!!!\n");
								}

								hash_destroy(hRec);
							} else if ((!strcmp(csFirstBaidTxnCode, PD_TXN_CODE_RETURNED_DEPOSIT)) && csSecondBAIDTxnId != NULL) {
								hash_init(hRec, 0);

								PutField_CString(hRec, "txn_seq", csSecondBAIDTxnId);
								PutField_Int(hRec, "pid_txn_hold_ind", PD_TRUE);
								PutField_CString(hRec, "update_user", csUser);

								DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Update");
								if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
									iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::Update() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLBAIDTxn::Update() FAILURE!!!\n");
								}

								hash_destroy(hRec);
							}
						}
					} else {
						if (csFailedBaidTxnCode != NULL) {
							hash_init(hRec, 0);

							PutField_CString(hRec, "txn_seq", csBAIDTxnId);
							PutField_CString(hRec, "new_txn_code", csFailedBaidTxnCode);
							PutField_CString(hRec, "update_user", csUser);

							DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Update");
							if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
								iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::Update() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLBAIDTxn::Update() FAILURE!!!\n");
							}

							hash_destroy(hRec);
						}
					}
				}
/******************************
* end stmt engine
******************************/

				/* Auto Post Transaction */
				/*
				if (iRet == PD_OK) {
					if (iIsClassified) {
DEBUGLOG(("MatchStmtWithSms() call BOOLBaid::PostBaidTxn()\n"));
						BOObjPtr = CreateObj(BOPtr, "BOOLBaid", "PostBaidTxn");
						if ((unsigned long)(*BOObjPtr)(csBAIDTxnId) != PD_OK) {
							iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call BOOLBaid::PostBaidTxn() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call BOOLBaid::PostBaidTxn() FAILURE!!!\n");
						} else {
							PutField_Int(hFile,"post",1);
						}
					}
				}
				*/
/******************************
* start txn engine
******************************/

				if (iRet == PD_OK) {
					if (iIsClassified) {
						if (GetField_Int(hStmtEngine, "get_baid_txn_2_charge", &iTmp)) {
							hash_init(hRec, 0);

DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::GetBaidTxn()\n"));
							DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "GetBaidTxn");
							if ((unsigned long)(*DBObjPtr)(csSecondBAIDTxnId, hRec) != PD_OK) {
								iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLBAIDTxn::GetBaidTxn() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLBAIDTxn::GetBaidTxn() FAILURE!!!\n");
							} else {
								GetField_Double(hRec, "txn_amt", &dTmp);
DEBUGLOG(("MatchStmtWithSms() txn_amt = [%lf]\n", dTmp));
								GetField_Double(hRec, "est_net_amount", &dTmp2);
DEBUGLOG(("MatchStmtWithSms() est_net_amount = [%lf]\n", dTmp2));
								PutField_Double(hStmtEngine, "bank_charge", dTmp - dTmp2);
							}

							hash_destroy(hRec);
						}
					}
				}

				if (iRet == PD_OK) {
					if (iIsClassified) {
						hash_init(hRec, 0);

/*
						// get txn_grp
DEBUGLOG(("MatchStmtWithSms() call DBOLTxnEngineTxnCodeGrp::GetTxnGroup()\n"));
						DBObjPtr = CreateObj(DBPtr, "DBOLTxnEngineTxnCodeGrp", "GetTxnGroup");
						iTmpRet = (unsigned long)(*DBObjPtr)(csNextEngineTxnCode, hRec);
						if (iTmpRet != PD_OK) {
							iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLTxnEngineTxnCodeGrp::GetTxnGroup() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLTxnEngineTxnCodeGrp::GetTxnGroup() FAILURE!!!\n");
						} else {
							if (GetField_CString(hRec, "txn_grp", &csTmp)) {
DEBUGLOG(("MatchStmtWithSms() txn_grp = [%s]\n", csTmp));
								PutField_CString(hRec, "bank_stmt_type", csTmp);
								RemoveField_CString(hRec, "txn_grp");
							}
                				}
*/

						// call txn engine
					        if (iRet == PD_OK) {
							// activity
							PutField_CString(hRec, "activity", csNextEngineAction);
DEBUGLOG(("MatchStmtWithSms() activity = [%s]\n", csNextEngineAction));

							// bank_stmt_type
							PutField_CString(hRec, "bank_stmt_type", csNextEngineTxnCode);
DEBUGLOG(("MatchStmtWithSms() bank_stmt_type = [%s]\n", csNextEngineTxnCode));

							// recon_type
							PutField_CString(hRec, "recon_type", csNextEngineReconType);
DEBUGLOG(("MatchStmtWithSms() recon_type = [%s]\n", csNextEngineReconType));

							// trigger_type
							PutField_CString(hRec, "trigger_type", PD_TRIGGER_SYSTEM);
DEBUGLOG(("MatchStmtWithSms() trigger_type = [%s]\n", PD_TRIGGER_SYSTEM));

							// input_channel
							if (GetField_CString(hContext, "channel_code", &csTmp)) {
								PutField_CString(hRec, "input_channel", csTmp);
DEBUGLOG(("MatchStmtWithSms() input_channel = [%s]\n", csTmp));
							}

							// baid txn
							PutField_Int(hRec, "baid_txn_cnt", 1);
							PutField_CString(hRec, "baid_txn_id_0", csBAIDTxnId);
DEBUGLOG(("MatchStmtWithSms() baid_txn_id_0 = [%s]\n", csBAIDTxnId));
							if (GetField_CString(hStmtEngine, "baid_txn_id_2", &csTmp)) {
								PutField_Int(hRec, "baid_txn_cnt", 2);
								// need to reverse baid_txn_id 0 & 1 for RETURN
								if (!strcmp(csNextEngineReconType, PD_ENGINE_RECON_RETURN)) {
									PutField_CString(hRec, "baid_txn_id_1", csBAIDTxnId);
									PutField_CString(hRec, "baid_txn_id_0", csTmp);
								} else {
									PutField_CString(hRec, "baid_txn_id_1", csTmp);
								}
DEBUGLOG(("MatchStmtWithSms() baid_txn_id_1 = [%s]\n", csTmp));
							}

							// psp txn
							PutField_Int(hRec, "txn_cnt", 0);
							if (GetField_CString(hStmtEngine, "psp_txn_id_1", &csTmp)) {
								PutField_Int(hRec, "txn_cnt", 1);
								PutField_CString(hRec, "txn_id_0", csTmp);
DEBUGLOG(("MatchStmtWithSms() txn_id_0 = [%s]\n", csTmp));
							}
							if (GetField_CString(hStmtEngine, "psp_txn_id_2", &csTmp)) {
								PutField_Int(hRec, "txn_cnt", 2);
								PutField_CString(hRec, "txn_id_1", csTmp);
DEBUGLOG(("MatchStmtWithSms() txn_id_1 = [%s]\n", csTmp));
							}

							// bank charge
							if (GetField_Double(hStmtEngine, "bank_charge", &dTmp)) {
								PutField_Int(hRec, "include_bank_charge", 1);
								PutField_Double(hRec, "bank_charge", dTmp);
							}

DEBUGLOG(("MatchStmtWithSms() call BOOLTxnEngine::DoAction()\n"));
							BOObjPtr = CreateObj(BOPtr, "BOOLTxnEngine", "DoAction");
							iTmpRet = (unsigned long)(*BOObjPtr)(hRec);
							if (iTmpRet != PD_OK) {
								iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call BOOLTxnEngine::DoAction() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call BOOLTxnEngine::DoAction() FAILURE!!!\n");
							}
						}

						hash_destroy(hRec);
					}
				}
/******************************
* end txn engine
******************************/
			}
		}

	/* hold */
		if (iRet == PD_OK) {
			if (GetField_CString(hFile,"format_txn_code",&csTmp)) {
                        	/* Returned Deposit */
                        	if (!strcmp(csTmp,PD_TXN_CODE_RETURNED_DEPOSIT)) {
                                	PutField_CString(hFile,"to_hold",PD_CR);
                        	}
			}

			if (GetField_CString(hFile,"to_hold",&csTmp)) {
				hash_init(hRec,0);

				PutField_CString(hRec, "stat_txn_id", csStatTxnId);
				PutField_CString(hRec,"txn_ccy",csAcctCcy);
				PutField_Double(hRec,"txn_amount",dTxnAmt);
				if (GetField_CString(hFile,"statement_date",&csTmp)) {
					PutField_CString(hRec,"txn_date",csTmp);
				}
				if (GetField_CString(hFile,"statement_time",&csTmp)) {
					PutField_CString(hRec,"txn_time",csTmp);
				}
				PutField_CString(hRec,"bank_code",csIntBankCode);
				PutField_CString(hRec,"bank_acct_num",csBankAcctNum);

				PutField_CString(hRec,"remark","Hold");

DEBUGLOG(("MatchStmtWithSms() call DBOLTxnPspDetail::GetDepositTxnToHold()\n"));
				DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "GetDepositTxnToHold");
				if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("MatchStmtWithSms() call DBOLTxnPspDetail::GetDepositTxnToHold() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLTxnPspDetail::GetDepositTxnToHold() FAILURE!!!\n");
				} else {
					if (GetField_CString(hRec,"txn_id",&csTmp)) {
						iDtlRet = PD_FOUND;
DEBUGLOG(("MatchStmtWithSms() call DBOLTxnPspDetail::GetDepositTxnToHold() txn_id = [%s]\n",csTmp));
						PutField_Int(hFile,"hold",1);
					} else {
						iDtlRet = PD_NOT_FOUND;
DEBUGLOG(("MatchStmtWithSms() call DBOLTxnPspDetail::GetDepositTxnToHold() txn_id NOT FOUND\n",csTmp));
					}
				}

				hash_destroy(hRec);
			}
		}

DEBUGLOG(("MatchStmtWithSms() Match End\n"));
	}


	FREE_ME(hTxn);
	FREE_ME(hRec);
	hash_destroy(hStmtEngine);
	FREE_ME(hStmtEngine);

	if (iIsClassified) {
		iRet = PD_FOUND;
	} else {
		iRet = PD_NOT_FOUND;
	}

DEBUGLOG(("MatchStmtWithSms() iRet = [%d]\n",iRet));
	return iRet;
}

