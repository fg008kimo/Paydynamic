/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/11/15              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOOLTxnElements.h"
#include "queue_utility.h"
#include "mq_db.h"

char    cDebug;

OBJPTR(DB);

void BOOLTxnElements(char    cdebug)
{
        cDebug = cdebug;
}

int     AddPspTxnElement(hash_t* hRequest);
int     AddTxnAmtElement(hash_t* hContext)
{
         int     iRet = PD_OK;

        char    *csOrgTxnSeq;
        char    *csOrgTxnCcy;
        double  dTmp;
	char	cTmp;
	char	*csTmp;

        hash_t  *hRec;
        hRec = (hash_t*)  malloc (sizeof(hash_t));

        if (GetField_CString(hContext,"from_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("AddTxnAmtElement:: org_txn_seq = [%s]\n",csOrgTxnSeq));
        }

        if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("AddTxnAmtElement:: org_txn_ccy= [%s]\n",csOrgTxnCcy));
        }
        else {
DEBUGLOG((" AddTxnAmtElement:: org_txn_ccy is missing!!!, skip  AddTxnAmtElement\n"));
		FREE_ME(hRec);
		return iRet;
        }

        if (GetField_Double(hContext,"org_txn_amt",&dTmp) && iRet == PD_OK) {
DEBUGLOG(("AddPspTxnElement:: txn_amt = [%lf]\n", dTmp));
                hash_init(hRec,0);

/* txn seq */
                PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                PutField_CString(hRec,"txn_element_type",PD_ELEMENT_TXN_AMT);

/* party type */
		if (GetField_Char(hContext, "party_type", &cTmp)) {
	                PutField_Char(hRec,"party_type",cTmp);
DEBUGLOG(("AddTxnAmtElement:: party_type = [%c]\n",cTmp));
		} else {
	                PutField_Char(hRec,"party_type",PD_TYPE_MERCHANT);
DEBUGLOG(("AddTxnAmtElement:: [default] party_type = [%c]\n", PD_TYPE_MERCHANT));
		}

/* txn_ccy */
                PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* amount */
                PutField_Double(hRec,"amount",dTmp);

/* user */      
		if (GetField_CString(hContext, "add_user", &csTmp)) {
			PutField_CString(hRec, "add_user", csTmp);
DEBUGLOG(("AddTxnAmtElement:: add_user = [%s]\n", csTmp));
		} else {
			PutField_CString(hRec, "add_user", PD_UPDATE_USER);
DEBUGLOG(("AddTxnAmtElement:: [default] add_user = [%s]\n", PD_UPDATE_USER));
		}

/* amount type */
		if (GetField_CString(hContext, "amount_type", &csTmp)) {
	                PutField_CString(hRec,"amount_type",csTmp);
DEBUGLOG(("AddTxnAmtElement:: amount_type = [%s]\n",csTmp));
		} else {
	                PutField_CString(hRec,"amount_type",PD_CR);
DEBUGLOG(("AddTxnAmtElement:: [default] amount_type = [%s]\n", PD_CR))
		}

		DBObjPtr = CreateObj(DBPtr,"DBOLTxnElements","Add");
                iRet = (unsigned long)(*DBObjPtr)(hRec);
                hash_destroy(hRec);
        }

        FREE_ME(hRec);
DEBUGLOG(("AddTxnAmtElement:: iRet = [%d]\n",iRet));
        return  iRet;
}




int     AddTxnFeeElements(hash_t* hContext)
{
        int     iRet = PD_OK;

        char    *csOrgTxnSeq;
        char    *csOrgTxnCcy;
        char    *csOrgDstTxnCcy;
        double  dTmp;
	char	cTmp;
	char	*csTmp;
	

        hash_t  *hRec;
        hRec = (hash_t*)  malloc (sizeof(hash_t));

        if (GetField_CString(hContext,"from_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("AddTxnFeeElements:: org_txn_seq = [%s]\n",csOrgTxnSeq));
        }

        if (GetField_CString(hContext,"src_txn_fee_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("AddTxnFeeElements:: src_txn_fee_ccy= [%s]\n",csOrgTxnCcy));
        }
        else {
DEBUGLOG(("AddTxnFeeElements:: src_txn_fee_ccy is missing!!!, skip AddTxnFeeElements\n"));
		FREE_ME(hRec);
		return iRet;
        }

        if (GetField_CString(hContext,"dst_txn_fee_ccy",&csOrgDstTxnCcy)) {
DEBUGLOG(("AddTxnFeeElements:: dst_txn_fee_ccy= [%s]\n",csOrgDstTxnCcy));
        }
/* merchant fee */
        if (GetField_Double(hContext,"src_txn_fee",&dTmp) && iRet == PD_OK) {

                if(dTmp>0){
DEBUGLOG(("AddTxnFeeElements:: src txn fee = [%lf]\n",dTmp));

                        hash_init(hRec,0);
                        DBObjPtr = CreateObj(DBPtr,"DBOLTxnElements","Add");

/* txn seq */
                        PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                        PutField_CString(hRec,"txn_element_type",PD_ELEMENT_TXN_FEE);

/* party type */
			if (GetField_Char(hContext, "party_type", &cTmp)) {
	                        PutField_Char(hRec,"party_type",cTmp);
			} else {
	                        PutField_Char(hRec,"party_type",PD_TYPE_MERCHANT);
			}

/* txn_ccy */
                        PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* fee */
                        PutField_Double(hRec,"amount",dTmp);

/* user */              PutField_CString(hRec,"add_user",PD_UPDATE_USER);

/* amount type */
			if (GetField_CString(hContext, "amount_type", &csTmp)) {
	                        PutField_CString(hRec,"amount_type",csTmp);
			} else {
	                        PutField_CString(hRec,"amount_type",PD_DR);
			}

                        iRet = (unsigned long)(*DBObjPtr)(hRec);
                        hash_destroy(hRec);
                }
        }


/* customer fee */
        if (GetField_Double(hContext,"dst_txn_fee",&dTmp) && iRet == PD_OK) {
DEBUGLOG(("AddTxnFeeElements:: dst_txn_fee = [%lf]\n",dTmp));

                if(dTmp>0){
                        hash_init(hRec,0);
                        DBObjPtr = CreateObj(DBPtr,"DBOLTxnElements","Add");

/* txn seq */
                        PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                        PutField_CString(hRec,"txn_element_type",PD_ELEMENT_TXN_FEE);


/* party type */
                        PutField_Char(hRec,"party_type",PD_TYPE_CUSTOMER);

/* txn_ccy */
                        PutField_CString(hRec,"ccy",csOrgDstTxnCcy);

/* fee */
                        PutField_Double(hRec,"amount",dTmp);
/* user */              PutField_CString(hRec,"add_user",PD_UPDATE_USER);
/* amount type */
			if (GetField_CString(hContext, "amount_type", &csTmp)) {
	                        PutField_CString(hRec,"amount_type",csTmp);
			} else {
                        	PutField_CString(hRec,"amount_type",PD_DR);
			}

                        iRet = (unsigned long)(*DBObjPtr)(hRec);
                        hash_destroy(hRec);
                }
        }


        FREE_ME(hRec);
DEBUGLOG(("AddFeeTxnChgLog:: iRet = [%d]\n",iRet));
        return  iRet;
}
int     AddReserveAmtElement(hash_t* hContext)
{
         int     iRet = PD_OK;

        char    *csOrgTxnSeq;
        char    *csOrgTxnCcy;
	char	*csTmp;
        double  dTmp;

        hash_t  *hRec;
        hRec = (hash_t*)  malloc (sizeof(hash_t));

        if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("AddReserveAmt:: org_txn_seq = [%s]\n",csOrgTxnSeq));
        }

        if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("AddReserveAmt:: org_txn_ccy= [%s]\n",csOrgTxnCcy));
        }
        else {
DEBUGLOG((" AddReserveAmt:: org_txn_ccy is missing!!!, skip  AddTxnAmtElement\n"));
		FREE_ME(hRec);
		return iRet;
        }

        if (GetField_Double(hContext,"reserve_amt",&dTmp) && iRet == PD_OK) {
                hash_init(hRec,0);
                DBObjPtr = CreateObj(DBPtr,"DBOLTxnElements","Add");

/* txn seq */
                PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                PutField_CString(hRec,"txn_element_type",PD_ELEMENT_RES_AMT);

/* party type */
                PutField_Char(hRec,"party_type",PD_TYPE_MERCHANT);

/* txn_ccy */
                PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* amount */
                PutField_Double(hRec,"amount",dTmp);

/* user */      PutField_CString(hRec,"add_user",PD_UPDATE_USER);

/* amount type */
		if (GetField_CString(hContext, "amount_type", &csTmp)) {
                	PutField_CString(hRec,"amount_type",csTmp);
		}
		else {
DEBUGLOG(("AddReserAmt: count not find amount_type\n"));
		}

		if (dTmp > 0.0) {
                	iRet = (unsigned long)(*DBObjPtr)(hRec);
		}
                hash_destroy(hRec);
        }

        FREE_ME(hRec);
DEBUGLOG(("AddReserveAmt:: iRet = [%d]\n",iRet));
        return  iRet;
}


int     AddHoldAmtElement(hash_t* hContext)
{
         int     iRet = PD_OK;

        char    *csOrgTxnSeq;
        char    *csOrgTxnCcy;
        double  dTmp;
        char	cHold;
        char	cTmp;
	char	*csTmp;

        hash_t  *hRec;
        hRec = (hash_t*)  malloc (sizeof(hash_t));

        if (GetField_CString(hContext,"txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("AddHoldAmt:: txn_seq = [%s]\n",csOrgTxnSeq));
        }

        if (GetField_CString(hContext,"txn_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("AddHoldAmt:: txn_ccy= [%s]\n",csOrgTxnCcy));
        }
        else {
DEBUGLOG((" AddHoldAmt:: txn_ccy is missing!!!, skip  AddHoldAmtElement\n"));
		FREE_ME(hRec);
		return iRet;
        }
	if(GetField_Char(hContext,"hold_type",&cHold)){
DEBUGLOG(("AddHoldAmt:: hold_type = [%c]\n",cHold));
	}
        else {
DEBUGLOG((" AddHoldAmt:: hold_type is missing!!!, skip  AddHoldAmtElement\n"));
		FREE_ME(hRec);
		return iRet;
        }

        if (GetField_Double(hContext,"txn_amt",&dTmp) && iRet == PD_OK) {
                hash_init(hRec,0);
                DBObjPtr = CreateObj(DBPtr,"DBOLTxnElements","Add");

/* txn seq */
                PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
		if(cHold==PD_HOLD){
			PutField_CString(hRec,"txn_element_type",PD_ELEMENT_HOLD_AMT);
		}else if(cHold==PD_UNHOLD){
			PutField_CString(hRec,"txn_element_type",PD_ELEMENT_UNHOLD_AMT);
		}
/* party type */
		if(GetField_Char(hContext,"party_type",&cTmp)){
DEBUGLOG(("AddHoldAmt:: party_type= [%c]\n",cTmp));
                	PutField_Char(hRec,"party_type",cTmp);
		}
		else
                	PutField_Char(hRec,"party_type",PD_TYPE_MERCHANT);

/* txn_ccy */
                PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* amount */
                PutField_Double(hRec,"amount",dTmp);

/* user */      PutField_CString(hRec,"add_user",PD_UPDATE_USER);

/*amount_type */
		if (GetField_CString(hContext, "amount_type", &csTmp)) {
			PutField_CString(hRec,"amount_type",csTmp);
		}

                iRet = (unsigned long)(*DBObjPtr)(hRec);
                hash_destroy(hRec);
        }

        FREE_ME(hRec);
DEBUGLOG(("AddHoldAmt:: iRet = [%d]\n",iRet));
        return  iRet;
}

int     AddTransferAmtElement(hash_t* hContext)
{
         int     iRet = PD_OK;

        char    *csOrgTxnSeq;
        char    *csOrgTxnCcy;
        double  dTmp;
	char	cTmp;

        hash_t  *hRec;
        hRec = (hash_t*)  malloc (sizeof(hash_t));

        if (GetField_CString(hContext,"from_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("AddTransferAmt:: from_txn_seq = [%s]\n",csOrgTxnSeq));
        }

        if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("AddTransferAmt:: org_txn_ccy= [%s]\n",csOrgTxnCcy));
        }
        else {
DEBUGLOG((" AddTransferAmt:: org_txn_ccy is missing!!!, skip  AddTxnAmtElement\n"));
		FREE_ME(hRec);
		return iRet;
        }

        if (GetField_Double(hContext,"transfer_amt",&dTmp) && iRet == PD_OK) {
                hash_init(hRec,0);
                DBObjPtr = CreateObj(DBPtr,"DBOLTxnElements","Add");

/* txn seq */
                PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                PutField_CString(hRec,"txn_element_type",PD_ELEMENT_TRF_AMT);

/* party type */
		if(GetField_Char(hContext,"party_type",&cTmp)){
			PutField_Char(hRec,"party_type",cTmp);
		}
		else
			PutField_Char(hRec,"party_type",PD_TYPE_PSP);

/* txn_ccy */
                PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* amount */
                PutField_Double(hRec,"amount",dTmp);

/* user */      PutField_CString(hRec,"add_user",PD_UPDATE_USER);


                iRet = (unsigned long)(*DBObjPtr)(hRec);
                hash_destroy(hRec);
        }

        FREE_ME(hRec);
DEBUGLOG(("AddTransferAmt:: iRet = [%d]\n",iRet));
        return  iRet;
}


int     AddPspTxnElement(hash_t* hRequest)
{
         int     iRet = PD_OK;

        char    *csOrgTxnSeq;
        char    *csOrgTxnCcy;
        double  dTmp;
        char	cTmp;
	char	*csTmp;

        hash_t  *hRec;
        hRec = (hash_t*)  malloc (sizeof(hash_t));

        if (GetField_CString(hRequest,"txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("AddPspTxnElement:: txn_seq = [%s]\n",csOrgTxnSeq));
        }

        if (GetField_CString(hRequest,"txn_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("AddPspTxnElement:: txn_ccy= [%s]\n",csOrgTxnCcy));
        }
        else {
DEBUGLOG((" AddPspTxnElement:: txn_ccy is missing!!!, skip  AddPspTxnElement\n"));
		FREE_ME(hRec);
		return iRet;
        }

        if (GetField_Double(hRequest,"txn_amt",&dTmp) && iRet == PD_OK) {
DEBUGLOG(("AddPspTxnElement:: txn_amt = [%lf]\n", dTmp));
                hash_init(hRec,0);
                DBObjPtr = CreateObj(DBPtr,"DBOLTxnElements","Add");

/* txn seq */
                PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
		if(GetField_CString(hRequest,"txn_element_type",&csTmp)){
			PutField_CString(hRec,"txn_element_type",csTmp);
		}

/* party type */
		if(GetField_Char(hRequest,"party_type",&cTmp)){
DEBUGLOG(("AddHoldAmt:: party_type= [%c]\n",cTmp));
                	PutField_Char(hRec,"party_type",cTmp);
		}
		else
                	PutField_Char(hRec,"party_type",PD_TYPE_PSP);

/* txn_ccy */
                PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* amount */
                PutField_Double(hRec,"amount",dTmp);

/* user */      PutField_CString(hRec,"add_user",PD_UPDATE_USER);

/*amount_type */
		if (GetField_CString(hRequest, "amount_type", &csTmp)) {
			PutField_CString(hRec,"amount_type",csTmp);
		}

                iRet = (unsigned long)(*DBObjPtr)(hRec);
                hash_destroy(hRec);
        }

        FREE_ME(hRec);
DEBUGLOG(("AddPspTxnElement:: iRet = [%d]\n",iRet));
        return  iRet;
}


int     AddMarkupAmtElement(hash_t* hContext)
{
         int     iRet = PD_OK;

        char    *csOrgTxnSeq;
        char    *csDstTxnCcy;
        char    *csTmp;
        double  dTmp;
        char    cTmp;

        hash_t  *hRec;
        hRec = (hash_t*)  malloc (sizeof(hash_t));

        if (GetField_CString(hContext,"from_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("AddMarkupAmtElement:: org_txn_seq = [%s]\n",csOrgTxnSeq));
        }
        if (GetField_CString(hContext,"dst_txn_ccy",&csDstTxnCcy)) {
DEBUGLOG(("AddMarkupAmtElement:: Dst_txn_ccy= [%s]\n",csDstTxnCcy));
        }
        else {
DEBUGLOG((" AddMarkupAmtElement:: Dst_txn_ccy is missing!!!, skip  AddTxnAmtElement\n"));
                FREE_ME(hRec);
                return iRet;
        }

        if (GetField_Double(hContext,"markup_amt",&dTmp) && iRet == PD_OK) {
                hash_init(hRec,0);
                DBObjPtr = CreateObj(DBPtr,"DBOLTxnElements","Add");

/* txn seq */
                PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                PutField_CString(hRec,"txn_element_type",PD_ELEMENT_MARKUP_AMT);

/* party type */
                if (GetField_Char(hContext, "org_party_type", &cTmp)) {
                        PutField_Char(hRec,"party_type",cTmp);
                } else {
                        PutField_Char(hRec,"party_type",PD_TYPE_CUSTOMER);
                }
/* txn_ccy */
                PutField_CString(hRec,"ccy",csDstTxnCcy);

/* amount */
                PutField_Double(hRec,"amount",dTmp);

/*markup rate*/
                if(GetField_Double(hContext,"markup_rate",&dTmp)){
                        PutField_Double(hRec,"rate",dTmp);
                }


/* user */      PutField_CString(hRec,"add_user",PD_UPDATE_USER);
		if (GetField_CString(hContext, "amount_type", &csTmp)) {
                        PutField_CString(hRec,"amount_type",csTmp);
                } else {
                        PutField_CString(hRec,"amount_type",PD_DR);
                }

                iRet = (unsigned long)(*DBObjPtr)(hRec);
                hash_destroy(hRec);
        }

        FREE_ME(hRec);
DEBUGLOG(("AddMarkupAmtElement:: iRet = [%d]\n",iRet));
        return  iRet;
}
