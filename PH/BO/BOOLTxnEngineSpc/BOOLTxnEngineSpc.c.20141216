/*
Partnerdelight (c)2014. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/12/9              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "dbutility.h"
#include "BOOLTxnEngineSpc.h"
#include "myrecordset.h"
#include "myhash.h"
#include "math.h"
#include <time.h>

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);


void BOOLTxnEngineSpc(char cdebug)
{
	cDebug = cdebug;
}


int	RunSpecialAction(const int iAction, hash_t* hTxn);
int	GetBaidAmt(hash_t* hTxn);
int	GetPspAmt(hash_t* hTxn);
int	GetDiffAmt(hash_t* hTxn);
int	OverrideTagValue(hash_t* hTxn);


int	RunSpecialAction(const int iAction, hash_t* hTxn)
{
	int	iRet = PD_OK;

	hash_t          *hAct;
	hAct = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hAct,0);

	hash_t          *hRec;
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

DEBUGLOG(("RunSpecialAction:: [%d]\n",iAction));
	PutField_Int(hAct,"spc_action_id",iAction);

	DBObjPtr = CreateObj(DBPtr,"DBOLTxnEngineSpcActionMap","GetSpcAction");
	if ((*DBObjPtr)(hAct,rRecordSet) == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {

			//get default return tag & value and put in hTxn first
			
			//get check_tag1, check_tag2 and expected_value
			//if check_tag2 exist, compare check_tag1 and check_tag2
			//else, compare check_tag1 and expected value

			//if the compare result is TRUE, put the return value to the return tag in hTxn or call the return function
			//else, break the loop when terminate_when_error=TRUE or do nothing when terminate_when_error=FALSE


			hRec = RecordSet_GetNext(rRecordSet);
		}
	}

	FREE_ME(hAct);
	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
DEBUGLOG(("RunSpecialAction() exit iRet = [%d]\n", iRet));
	return iRet;
}



int	GetBaidAmt(hash_t* hTxn)
{
	int iRet = PD_OK;
	char	*csTag;
	double	dAmt = 0.0;

	if(GetField_Double(hTxn,"baid_txn_amt",&dAmt) &&
	   GetField_CString(hTxn,"returned_tag",&csTag)){
DEBUGLOG(("GetBaidAmt [%s] = [%lf]\n",csTag,dAmt));
		PutField_Double(hTxn,csTag,dAmt);
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("GetBaidAmt NOT FOUND!!!!\n"));
	}

	return iRet;
}

int	GetPspAmt(hash_t* hTxn)
{
	int iRet = PD_OK;
	char	*csTag;
	double	dAmt = 0.0;

	if(GetField_Double(hTxn,"psp_txn_amt",&dAmt) &&
	   GetField_CString(hTxn,"returned_tag",&csTag)){
DEBUGLOG(("GetPspAmt [%s] = [%lf]\n",csTag,dAmt));
		PutField_Double(hTxn,csTag,dAmt);
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("GetPspAmt NOT FOUND!!!!\n"));
	}

	return iRet;
}

int	GetDiffAmt(hash_t* hTxn)
{
	int iRet = PD_OK;
	char	*csTag;
	char	*csIn1Tag;
	char	*csIn2Tag;
	double	d1Amt = 0.0;
	double	d2Amt = 0.0;
	double	dDiff = 0.0;

	if(GetField_CString(hTxn,"p1_check_tag",&csIn1Tag) &&
	   GetField_CString(hTxn,"p2_check_tag",&csIn2Tag)){

		if(GetField_Double(hTxn,csIn1Tag,&d1Amt) &&
		   GetField_Double(hTxn,csIn2Tag,&d2Amt) &&
		   GetField_CString(hTxn,"returned_tag",&csTag)){

DEBUGLOG(("GetDiffAmt [%s][%lf] and [%s][%lf]\n",csIn1Tag,d1Amt,csIn2Tag,d2Amt));

			if(d1Amt>d2Amt)
				dDiff = d1Amt - d2Amt;
			else
				dDiff = d2Amt - d1Amt;
			
			PutField_Double(hTxn,csTag,dDiff);
DEBUGLOG(("GetDiffAmt [%s] = [%lf]\n",csTag,dDiff));
		}
		else{
			iRet = PD_ERR;
		}
	}
	else{
		iRet = PD_ERR;
	}

DEBUGLOG(("GetDiffAmt exit iRet = [%d]\n",iRet));
	return iRet;
}


int	OverrideTagValue(hash_t* hTxn)
{
	int iRet = PD_OK;
	char	*csInTag;
	char	*csRetTag;
	char	*csTmp;
	int	iTmp = 0;
	double	dTmp = 0.0;

	if(GetField_CString(hTxn,"p1_check_tag",&csInTag) &&
	   GetField_CString(hTxn,"returned_tag",&csRetTag) &&
	   GetField_CString(hTxn,"return_type",&csType)){

		if(!strcmp(csType,PD_STRING_TYPE)){
			if(GetField_CString(hTxn,csInTag,&csTmp)){
				PutField_CString(hTxn,csRetTag,csTmp);
DEBUGLOG(("OverrideTagValue [%s]->[%s][%s]\n",csInTag,csRetTag,csTmp));
			}
		}
		else if(!strcmp(csType,PD_INT_TYPE)){
			if(GetField_Int(hTxn,csInTag,&iTmp)){
				PutField_Int(hTxn,csRetTag,iTmp);
DEBUGLOG(("OverrideTagValue [%s]->[%s][%d]\n",csInTag,csRetTag,iTmp));
			}
		}
		else if(!strcmp(csType,PD_DOUBLE_TYPE)){
			if(GetField_Double(hTxn,csInTag,&dTmp)){
				PutField_Double(hTxn,csRetTag,dTmp);
DEBUGLOG(("OverrideTagValue [%s]->[%s][%lf]\n",csInTag,csRetTag,dTmp));
			}
		}
	}
	else{
		iRet = PD_ERR;
	}

DEBUGLOG(("OverrideTagValue exit iRet = [%d]\n",iRet));
	return iRet;
}
