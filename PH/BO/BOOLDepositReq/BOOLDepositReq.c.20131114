/*
Partnerdelight (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/27              Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "mymd5.h"
#include "ctype.h"
#include "BOOLDepositReq.h"

#define	PD_FILE_DELIMITER	","

char    cDebug;

void BOOLDepositReq(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(DB);

int strcicmp(char const *a, char const *b)
{
	for (;; a++, b++) {
		int d = tolower(*a) - tolower(*b);
		if (d != 0 || !*a)
			return d;
	}
}

int splitLine(char *cs_input_buf, char *csTag[], int iSize, char *csCheckSum[], int iCheckSize, hash_t *hContext);
int ProcessDepositReq(hash_t *hContext)
{
        int     iRet = PD_OK, iDtlRet = PD_OK;
	char	*csMerchantID, *csIntBankCode, *csBankAcctNum;
	char	*csInFileName, *csFileName, *csUser;
	char	*csServiceCode, *csDefaultCcy, *csDefaultCountry;
	int	iDepositReqVer; 

	double	dAcceptAmount = 0.0;
	int	iTotalCount = 0, iAcceptCount = 0;

/* File Format Version 2 */
	char *csHeaderTagV2[4] = {"merchant_id","service_code","total_count","check_sum"};
	char *csHeaderCheckSumV2[2] = {"merchant_id","total_count"};
	char *csDetailTagV2[8] = {"deposit_seq","merch_ref","country","deposit_amount","deposit_ccy","deposit_bank","deposit_ref","check_sum"};
	char *csDetailCheckSumV2[4] = {"deposit_seq","merch_ref","deposit_amount","deposit_bank"};

/* File Format Version 1 */
	char *csDetailTagV1[6] = {"deposit_timestamp","merch_ref","deposit_ccy","deposit_amount","deposit_bank","deposit_ref"};

	FILE	*fin = NULL;
	char	*csTmp;
	int	iTmp;
	char	cs_input_buf[PD_TMP_MSG_BUF_LEN];
	char	cs_tmp_buf1[PD_TMP_BUF_LEN];
	char	cs_tmp_buf2[PD_TMP_BUF_LEN];
	strcpy(cs_tmp_buf2, "");

	char	*csTag = (char*) malloc (64);
	hash_t	*hRec;

/* merchant_id */
	if (GetField_CString(hContext, "merchant_id", &csMerchantID)) {
DEBUGLOG(("ProcessDepositReq() merchant_id = [%s]\n", csMerchantID));
	} else {
		iRet = INT_ERR;
DEBUGLOG(("ProcessDepositReq() merchant_id NOT FOUND!!!\n"));
	}
/* int_bank_code */
	if (GetField_CString(hContext, "int_bank_code", &csIntBankCode)) {
DEBUGLOG(("ProcessDepositReq() int_bank_code = [%s]\n", csIntBankCode));
	} else {
		iRet = INT_ERR;
DEBUGLOG(("ProcessDepositReq() int_bank_code NOT FOUND!!!\n"));
	}
/* bank_acct_num */
	if (GetField_CString(hContext, "bank_acct_num", &csBankAcctNum)) {
DEBUGLOG(("ProcessDepositReq() bank_acct_num = [%s]\n", csBankAcctNum));
	} else {
		iRet = INT_ERR;
DEBUGLOG(("ProcessDepositReq() bank_acct_num NOT FOUND!!!\n"));
	}
/* in_file_name */
	if (GetField_CString(hContext, "filename", &csInFileName)) {
DEBUGLOG(("ProcessDepositReq() in_file_name = [%s]\n", csInFileName));
	} else {
		iRet = INT_ERR;
DEBUGLOG(("ProcessDepositReq() in_file_name NOT FOUND!!!\n"));
	}
/* in_full_file_name */
	if (GetField_CString(hContext, "in_full_filename", &csFileName)) {
DEBUGLOG(("ProcessDepositReq() in_full_filename = [%s]\n", csFileName));
	} else {
		iRet = INT_ERR;
DEBUGLOG(("ProcessDepositReq() in_full_filename NOT FOUND!!!\n"));
	}
/* user */
	if (GetField_CString(hContext, "create_user", &csUser)) {
DEBUGLOG(("ProcessDepositReq() user = [%s]\n", csUser));
	} else {
		iRet = INT_ERR;
DEBUGLOG(("ProcessDepositReq()  NOT FOUND!!!\n"));
	}

/* deposit_request_ver */
	if (GetField_Int(hContext, "deposit_req_ver", &iDepositReqVer)) {
DEBUGLOG(("ProcessDepositReq() deposit_request_ver = [%d]\n", iDepositReqVer));
	} else {
		iRet = INT_ERR;
DEBUGLOG(("ProcessDepositReq() deposit_request_ver NOT FOUND!!!\n"));
	}
/* service_code */
	if (GetField_CString(hContext, "service_code", &csServiceCode)) {
DEBUGLOG(("ProcessDepositReq() service_code = [%s]\n", csServiceCode));
	} else {
		iRet = INT_ERR;
DEBUGLOG(("ProcessDepositReq() service_code NOT FOUND!!!\n"));
	}
/* acct_ccy */
	if (GetField_CString(hContext, "acct_ccy", &csDefaultCcy)) {
DEBUGLOG(("ProcessDepositReq() acct_ccy = [%s]\n", csDefaultCcy));
	} else {
		iRet = INT_ERR;
DEBUGLOG(("ProcessDepositReq() acct_ccy NOT FOUND!!!\n"));
	}
/* country */
	if (GetField_CString(hContext, "country", &csDefaultCountry)) {
DEBUGLOG(("ProcessDepositReq() country = [%s]\n", csDefaultCountry));
	} else {
		iRet = INT_ERR;
DEBUGLOG(("ProcessDepositReq() country NOT FOUND!!!\n"));
	}

/* file */
	if (iRet == PD_OK) {
		fin = fopen(csFileName, "r");
		if (fin == NULL) {
DEBUGLOG(("ProcessDepositReq() cannot open file [%s]!!!\n", csInFileName));
ERRLOG("BOOLDepositReq:: ProcessDepositReq() cannot open file [%s]!!!\n", csInFileName);
			iRet = INT_ERR;
		}
	}

/* Add Deposit Header */
	if (iRet == PD_OK) {
		strcpy(cs_tmp_buf2, "");
		hRec = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hRec, 0);

		if (iDepositReqVer==2) {
			fgets(cs_input_buf, sizeof(cs_input_buf), fin); 
			if (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A) cs_input_buf[strlen(cs_input_buf) - 1] = '\0';
			if (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0D) cs_input_buf[strlen(cs_input_buf) - 1] = '\0';
			int iHeaderSize = (int)sizeof(csHeaderTagV2) / (int)sizeof(*csHeaderTagV2);
			int iCheckSize = (int)sizeof(csHeaderCheckSumV2) / (int)sizeof(*csHeaderCheckSumV2);
			iDtlRet = splitLine(cs_input_buf, csHeaderTagV2, iHeaderSize, csHeaderCheckSumV2, iCheckSize, hRec);
			PutField_Int(hContext, "line_1", 1);
			PutField_CString(hContext, "line_1", cs_input_buf);
			if (iDtlRet != PD_OK) {
				iRet = INT_CHECKSUM_ERROR;
				PutField_Int(hContext, "result_cnt", 1);
				PutField_CString(hContext, "msg_1", "Header Field Error");
				PutField_CString(hContext, "desc_1", "(CheckSum)");
DEBUGLOG(("ProcessDepositReq() Header Field Error!!!\n"));
			}
		}

		while (fgets(cs_input_buf, sizeof(cs_input_buf), fin) != NULL) {
			if (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A) cs_input_buf[strlen(cs_input_buf) - 1] = '\0';
			if (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0D) cs_input_buf[strlen(cs_input_buf) - 1] = '\0';
			if (strcmp(cs_input_buf,"")) iTotalCount++;
		}

		if (iRet == PD_OK && iDepositReqVer==2) {
			GetField_CString(hRec,"merchant_id",&csTmp);
			if (strcmp(csTmp, csMerchantID)) {
				snprintf(cs_tmp_buf1,sizeof(cs_tmp_buf1),"(Merchant ID[%s])",csTmp);
				strncat(cs_tmp_buf2,cs_tmp_buf1,sizeof(cs_tmp_buf2)-strlen(cs_tmp_buf2)-1);
				iRet = INT_HEADER_FIELD_ERROR;
DEBUGLOG(("ProcessDepositReq() merchant_id [%s] FAILURE!!!\n",csTmp));
			}
			GetField_CString(hRec,"service_code",&csTmp);
			if (strcmp(csTmp, csServiceCode)) {
				snprintf(cs_tmp_buf1,sizeof(cs_tmp_buf1),"(Service Code[%s])",csTmp);
				strncat(cs_tmp_buf2,cs_tmp_buf1,sizeof(cs_tmp_buf2)-strlen(cs_tmp_buf2)-1);
				iRet = INT_HEADER_FIELD_ERROR;
DEBUGLOG(("ProcessDepositReq() service_code[%s] FAILURE!!!\n",csTmp));
			}
			GetField_CString(hRec,"total_count",&csTmp);
			iTmp = atoi(csTmp);
			if (iTmp != iTotalCount) {
				snprintf(cs_tmp_buf1,sizeof(cs_tmp_buf1),"(Count[%i])",iTmp);
				strncat(cs_tmp_buf2,cs_tmp_buf1,sizeof(cs_tmp_buf2)-strlen(cs_tmp_buf2)-1);
				iRet = INT_HEADER_FIELD_ERROR;
DEBUGLOG(("ProcessDepositReq() count[%s] FAILURE!!!\n",csTmp));
			}

			if (iRet != PD_OK) {
				iRet = INT_HEADER_FIELD_ERROR;
				PutField_Int(hContext, "result_cnt", 1);
				PutField_CString(hContext, "msg_1", "Header Field Error");
				PutField_CString(hContext, "desc_1", cs_tmp_buf2);
DEBUGLOG(("ProcessDepositReq() Header Field ERROR!!!\n"));
			}
		}

		hash_destroy(hRec);
		FREE_ME(hRec);
	}


/* Add Deposit Detail */
	if (iRet == PD_OK) {
		int	iDepositSeq = 1, iCurrLine = 0;
		int	iSkipHeader = 1, iCount = 0;
		double	dAmount = 0.0;
		char	csCountry[PD_COUNTRY_LEN], csOrgCcy[PD_CCY_ID_LEN], csCcy[PD_CCY_ID_LEN];

		strcpy(csCountry,"");
		strcpy(csOrgCcy,"");
		strcpy(csCcy,"");

		rewind(fin);
		while (fgets(cs_input_buf, sizeof(cs_input_buf), fin) != NULL) {
			strcpy(cs_tmp_buf2, "");
			iCurrLine++;
			if (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A) cs_input_buf[strlen(cs_input_buf) - 1] = '\0';
			if (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0D) cs_input_buf[strlen(cs_input_buf) - 1] = '\0';
			if (!strcmp(cs_input_buf,"")) continue;
			else if(iDepositReqVer == 2 && iSkipHeader == 1) {
				iSkipHeader = 0;
				continue;
			}

			hRec = (hash_t*) malloc (sizeof(hash_t));
			hash_init(hRec, 0);

			if (iDepositReqVer==2) {
				int iDetailSize = (int)sizeof(csDetailTagV2) / (int)sizeof(*csDetailTagV2);
				int iCheckSize = (int)sizeof(csDetailCheckSumV2) / (int)sizeof(*csDetailCheckSumV2);
				iDtlRet = splitLine(cs_input_buf, csDetailTagV2, iDetailSize, csDetailCheckSumV2, iCheckSize, hRec);
			} else {
				int iDetailSize = (int)sizeof(csDetailTagV1) / (int)sizeof(*csDetailTagV1);
				int iCheckSize = 0;
				iDtlRet = splitLine(cs_input_buf, csDetailTagV1, iDetailSize, NULL, iCheckSize, hRec);
			}

			if (iDtlRet == PD_OK) {
				if (GetField_CString(hRec,"country",&csTmp) && strcmp(csTmp,"")) {
					if (strcmp(csCountry,csTmp) || !strcmp(csCountry,"")) {
						strcpy(csCountry,csTmp);
						DBObjPtr = CreateObj(DBPtr,"DBCountry","FindCountry");
						if ((unsigned long)(*DBObjPtr)(csCountry) != PD_FOUND) {
							snprintf(cs_tmp_buf1,sizeof(cs_tmp_buf1),"(Country[%s])",csCountry);
							strncat(cs_tmp_buf2,cs_tmp_buf1,sizeof(cs_tmp_buf2)-strlen(cs_tmp_buf2)-1);
							iDtlRet = INT_DETAIL_FIELD_ERROR;
DEBUGLOG(("ProcessDepositReq() country [%s] FAILURE!!!\n",csCountry));
						}
					}
				} else {
					PutField_CString(hRec,"country",csDefaultCountry);
				}
				if (GetField_CString(hRec,"deposit_ccy",&csTmp) && strcmp(csTmp,"")) {
					if ((strcmp(csOrgCcy,csTmp) && strcmp(csCcy,csTmp)) || !strcmp(csOrgCcy,"")) {
						strcpy(csOrgCcy, csTmp);
						if (!strcmp(csOrgCcy, PD_CCY_ISO_RMB)) {
							strcpy(csCcy, PD_CCY_ISO_CNY);
						} else {
							strcpy(csCcy, csOrgCcy);
						}
						DBObjPtr = CreateObj(DBPtr,"DBCurrency","FindCurrency");
						if ((unsigned long)(*DBObjPtr)(csCcy) != FOUND) {
							snprintf(cs_tmp_buf1,sizeof(cs_tmp_buf1),"(Currency[%s])",csCcy);
							strncat(cs_tmp_buf2,cs_tmp_buf1,sizeof(cs_tmp_buf2)-strlen(cs_tmp_buf2)-1);
							iDtlRet = INT_DETAIL_FIELD_ERROR;
DEBUGLOG(("ProcessDepositReq() currency [%s] FAILURE!!!\n",csOrgCcy));
						}
					}
					PutField_CString(hRec,"deposit_ccy",csCcy);
				} else {
					PutField_CString(hRec,"deposit_ccy",csDefaultCcy);
				}
				if (GetField_CString(hRec,"deposit_amount",&csTmp)) {
					dAmount = atof(csTmp);
					if (dAmount < 0.01-1E-9) {
						snprintf(cs_tmp_buf1,sizeof(cs_tmp_buf1),"(Amount[%s])",csTmp);
						strncat(cs_tmp_buf2,cs_tmp_buf1,sizeof(cs_tmp_buf2)-strlen(cs_tmp_buf2)-1);
						iDtlRet = INT_DETAIL_FIELD_ERROR;
DEBUGLOG(("ProcessDepositReq() amount [%s] FAILURE!!!\n",csTmp));
					} else {
						PutField_Double(hRec,"deposit_amount",dAmount);
					}
				} else {
					snprintf(cs_tmp_buf1,sizeof(cs_tmp_buf1),"(Amount Not Found)");
					strncat(cs_tmp_buf2,cs_tmp_buf1,sizeof(cs_tmp_buf2)-strlen(cs_tmp_buf2)-1);
					iDtlRet = INT_DETAIL_FIELD_ERROR;
DEBUGLOG(("ProcessDepositReq() amount NOT FOUND!!!\n"));
				}
			}

			if (iDtlRet == PD_OK) {
DEBUGLOG(("ProcessDepositReq() call DBOLDepositRequest::AddDetail()\n"));
				PutField_CString(hRec,"filename",csInFileName);
				PutField_Int(hRec,"deposit_seq",iDepositSeq);
				PutField_CString(hRec,"create_user",csUser);

				DBObjPtr = CreateObj(DBPtr,"DBOLDepositRequest","AddDetail");
				if ((*DBObjPtr)(hRec) != PD_OK) {
					iDtlRet = INT_ERR;
DEBUGLOG(("ProcessDepositReq() call DBOLDepositRequest::AddDetail() FAILURE!!!\n"));
				} else {
					iAcceptCount++;
					dAcceptAmount+=dAmount;
				}
			}

			if (iDtlRet != PD_OK) {
				iRet = iDtlRet;
				iAcceptCount = 0;
				dAcceptAmount = 0.0;
				if (iDtlRet == INT_CHECKSUM_ERROR) {
					sprintf(cs_tmp_buf2,"(CheckSum)");
				}
				iCount++;
				PutField_Int(hContext, "result_cnt", iCount);
				sprintf(csTag, "msg_%d", iCount);
				PutField_CString(hContext, csTag, "Detail Field Error");
				sprintf(csTag, "desc_%d", iCount);
				PutField_CString(hContext, csTag, cs_tmp_buf2);
				sprintf(csTag, "line_%d", iCount);
				PutField_CString(hContext, csTag, cs_input_buf);
				PutField_Int(hContext, csTag, iCurrLine);
DEBUGLOG(("ProcessDepositReq() Detail Field Error!!!\n"));
			}
			iDepositSeq++;

			hash_destroy(hRec);
			FREE_ME(hRec);
		}
	}

	if(fin) {
		fclose(fin);
		fin = NULL;
	}

	PutField_Int(hContext,"accept_count",iAcceptCount);
	PutField_Double(hContext,"accept_amount",dAcceptAmount);
	PutField_Int(hContext,"total_count",iTotalCount);
DEBUGLOG(("ProcessStmtFile Result: Accept[%d](%.2lf)/Total[%d]\n", iAcceptCount, dAcceptAmount, iTotalCount));

	FREE_ME(csTag);

DEBUGLOG(("iRet = [%d]\n",iRet));
	return iRet;
}

int splitLine(char *cs_input_buf, char *csTag[], int iSize, char *csCheckSum[], int iCheckSize, hash_t *hContext)
{
	int	iRet = PD_OK;
	char	csTmpBuf[PD_TMP_MSG_BUF_LEN];
	char	csTmpField[PD_TMP_MSG_BUF_LEN];
	char	csCalMD5[PD_MD5_SUM_LEN + 1];
	char	*csField;
	int	i = 0;

	strcpy(csTmpBuf, cs_input_buf);
	csField = mystrtok(csTmpBuf, PD_FILE_DELIMITER);
	while (csField != NULL && i < iSize) { 
		strcpy(csTmpField, TrimAll((const unsigned char*)csField, strlen(csField)));
/* UTF-8 BOM */
		if (i==0 && (unsigned char)csTmpField[0] == 0xEF
			 && (unsigned char)csTmpField[1] == 0xBB && (unsigned char)csTmpField[2] == 0xBF) {
			char *src, *dst = csTmpField;
			for (src = csTmpField+3; *src != '\0'; src++) {
				*dst = *src;
				dst++;
			}
			*dst = '\0';
		}
// DEBUGLOG(("[%s] [%s]\n",csTag[i],csTmpField));
		PutField_CString(hContext,csTag[i],csTmpField);
		csField = mystrtok(NULL, PD_FILE_DELIMITER);
		i++;
	}

/* CheckSum */
	if (iRet == PD_OK && iCheckSize > 0) {
		strcpy(csTmpField,"");
		for (i=0; i<iCheckSize; i++) {
			if (GetField_CString(hContext,csCheckSum[i],&csField)) {
				strncat(csTmpField,csField,sizeof(csTmpField)-strlen(csTmpField)-1);
			} else {
				iRet = INT_CHECKSUM_ERROR;
DEBUGLOG(("ProcessDepositReq() check field NOT FOUND!!!\n"));
			}
		}
		md5sum(csTmpField,strlen(csTmpField),csCalMD5);
		if (!GetField_CString(hContext,"check_sum",&csField)) {
			iRet = INT_CHECKSUM_ERROR;
DEBUGLOG(("ProcessDepositReq() check_sum NOT FOUND!!!\n"));
		}

		if (iRet == PD_OK) {
			if(strcicmp(csCalMD5,csField)) {
DEBUGLOG(("ProcessDepositReq() MD5(%s) = [%s] FAILURE!!!\n",csTmpField,csCalMD5));
				iRet = INT_CHECKSUM_ERROR;
			} else {
DEBUGLOG(("ProcessDepositReq() MD5(%s) = [%s] Passed\n",csTmpField,csCalMD5));
			}
		}
	}

	return iRet;
}


int EditDepositReq(hash_t *hContext)
{
	int 	iRet = PD_OK;
	char	csBankCode[PD_BANK_CODE_LEN + 1];
	char	*csDepositBank, *csTmp;
	double	dTmp;

/* txn_id */
        if (GetField_CString(hContext,"txn_seq",&csTmp)) {
DEBUGLOG(("EditDepositReq() txn_id = [%s]\n",csTmp));
	}

/* deposit_amount */
	if (GetField_Double(hContext, "deposit_amount", &dTmp)) {
DEBUGLOG(("EditDepositReq() deposit_amount = [%.2lf]\n", dTmp));
	}

/* deposit_datetime */
	if (GetField_CString(hContext, "deposit_datetime", &csTmp)) {
DEBUGLOG(("EditDepositReq() deposit_datetime = [%s]\n", csTmp));
	}

/* int_bank_code */
	if (GetField_CString(hContext, "int_bank_code", &csTmp)) {
DEBUGLOG(("EditDepositReq() int_bank_code = [%s]\n", csTmp));
	}

/* bank_acct_num */
	if (GetField_CString(hContext, "bank_acct_num", &csTmp)) {
DEBUGLOG(("EditDepositReq() bank_acct_num = [%s]\n", csTmp));
	}

/* deposit_bank */
	if (GetField_CString(hContext, "deposit_bank", &csDepositBank)) {
DEBUGLOG(("EditDepositReq() deposit_bank = [%s]\n", csDepositBank));
	}

/* deposit_ref */
	if (GetField_CString(hContext, "deposit_ref", &csTmp)) {
DEBUGLOG(("EditDepositReq() deposit_ref = [%s]\n", csTmp));
	}

/* update_user */
	if (GetField_CString(hContext, "update_user", &csTmp)) {
DEBUGLOG(("EditDepositReq() update_user = [%s]\n", csTmp));
	}

	DBObjPtr = CreateObj(DBPtr,"DBOLDepositRequest","GetBankCode");
	if ((unsigned long)(*DBObjPtr)(csDepositBank,csBankCode) == PD_FOUND) {
DEBUGLOG(("Authorize() call DBOLDepositRequest::GetBankCode() FOUND\n"));
	} else {
		strcpy(csBankCode,"");
		PutField_CString(hContext,"deposit_bank","");
DEBUGLOG(("Authorize() call DBOLDepositRequest::GetBankCode() NOT FOUND\n"));
	}
	PutField_CString(hContext,"deposit_bank_code",csBankCode);

DEBUGLOG(("EditDepositReq() call DBOLTransaction::TxnDepositEdit()\n"));
	DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","TxnDepositEdit");
	if ((*DBObjPtr)(hContext) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("EditDepositReq() call DBOLTransaction::TxnDepositEdit() FAILURE!!!\n"));
	}

	return iRet;
}

