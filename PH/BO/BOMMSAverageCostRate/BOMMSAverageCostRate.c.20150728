/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/07/13              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "BOMMMAverageCostRate.h"

char    cDebug;

OBJPTR(DB);
OBJPTR(BO);

int DebitEntityFx(const hash_t* hIn);
int DebitACR(const hash_t* hIn);
int CreditEntityFx(const hash_t* hIn);
int CreditACR(const hash_t* hIn);


void BOMMMAverageCostRate(char    cdebug)
{
        cDebug = cdebug;
}

int GetEntityFxBalForUpdate(const hash_t* hIn, hash_t* hOut)
{
	int	iRet = PD_OK;
	char	*csTmp = NULL;
	int	iTmp = 0;
	double	dTmp = 0.0;

	if(GetField_CString(hIn,"entity_id",&csTmp)){
DEBUGLOG(("GetEntityFxBalForUpdate() entity_id = [%s]\n",csTmp));
	}
	else{
		iRet = INT_ERR;
DEBUGLOG(("GetEntityFxBalForUpdate() entity_id is missing\n"));
	}

	if(GetField_CString(hIn,"org_ccy",&csTmp)){
DEBUGLOG(("GetEntityFxBalForUpdate() org_ccy = [%s]\n",csTmp));
	}
	else{
		iRet = INT_ERR;
DEBUGLOG(("GetEntityFxBalForUpdate() org_ccy is missing\n"));
	}

	if(GetField_CString(hIn,"ccy",&csTmp)){
DEBUGLOG(("GetEntityFxBalForUpdate() ccy = [%s]\n",csTmp));
	}
	else{
		iRet = INT_ERR;
DEBUGLOG(("GetEntityFxBalForUpdate() ccy is missing\n"));
	}

	if(GetField_Int(hIn,"acr_ind",&iTmp)){
DEBUGLOG(("GetEntityFxBalForUpdate() = [%d]\n",iTmp));
	}
	else{
		iRet = INT_ERR;
DEBUGLOG(("GetEntityFxBalForUpdate() acr_ind is missing\n"));
	}

	if(iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBMmsEntityFXBal","GetFxBalForUpdate");
		iRet = (unsigned long)(*DBObjPtr)(hIn, hOut);
		if(iRet == PD_FOUND){
			if(GetField_Double(hOut,"bal",&dTmp)){
DEBUGLOG(("GetFxBalForUpdate() Balance = [%lf]\n",dTmp));
			}
			if(GetField_Double(hOut,"rate",&dTmp)){
DEBUGLOG(("GetFxBalForUpdate() Rate = [%lf]\n",dTmp));
			}
			if(GetField_Double(hOut,"ratio",&dTmp)){
DEBUGLOG(("GetFxBalForUpdate() Ratio = [%lf]\n",dTmp));
			}
		}
		else if(iRet == PD_NOT_FOUND){
			//insert record
			DBObjPtr = CreateObj(DBPtr,"DBMmsEntityFXBal","Add");
			iRet = (unsigned long)(*DBObjPtr)(hIn);
			if(iRet == PD_OK){
				PutField_Double(hOut,"bal",0.0);
				PutField_Double(hOut,"rate",0.0);
				PutField_Double(hOut,"ratio",0.0);
			}
			else{
DEBUGLOG(("DBMmsEntityFXBal: Add() Failed!!!\n"));
			}
		}
		else{
DEBUGLOG(("DBMmsEntityFXBal: GetFxBalForUpdate() Failed!!!\n"));
		}
	}

DEBUGLOG(("GetEntityFxBalForUpdate() iRet = [%d]\n",iRet));
	return iRet;
}



int RecordAffectFXDT(const hash_t* hIn)
{
	int	iRet = PD_OK;
	char    *csTmp = NULL;
	char    *csEntityId = NULL;
	char    *csUser = NULL;
	char	*csFxId;
	char	cDirection = 'x';
	double	dTmp = 0.0;
	int	iTmp = 0;
	int	i = 0;
	int	iCnt = 0;

	hash_t	*hData;
	hData = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hData,0);

DEBUGLOG(("RecordAffectFXDT:: ()\n"));

	if(GetField_CString(hIn,"fx_id",&csFxId)){
DEBUGLOG(("RecordAffectFXDT() fx_id = [%s]\n",csFxId));
	}
	else{
		iRet = INT_ERR;
DEBUGLOG(("RecordAffectFXDT() fx_id not found\n"));
ERRLOG("BOMMMAverageCostRate::RecordAffectFXDT() fx_id not found\n");
	}

	if(GetField_CString(hIn,"entity_id",&csEntityId)){
DEBUGLOG(("RecordAffectFXDT() entity_id = [%s]\n",csEntityId));
	}
	else{
		iRet = INT_MMS_ENTITY_ID_NOT_FOUND;
DEBUGLOG(("RecordAffectFXDT() entity_id not found\n"));
ERRLOG("BOMMMAverageCostRate::RecordAffectFXDT() entity_id not found\n");
	}

	if(GetField_Char(hIn,"direction",&cDirection)){
		//PD_FUNDS_OUT or PD_FUNDS_IN
DEBUGLOG(("RecordAffectFXDT() direction = [%c]\n",cDirection));
	}

	if(GetField_CString(hIn,"add_user",&csUser)){
DEBUGLOG(("RecordAffectFXDT() add_user = [%s]\n",csUser));
	}

	if(iRet==PD_OK && cDirection == PD_FUNDS_OUT){
//Record down funds out information
		iCnt = 0;
		GetField_Int(hIn,"fundsout_cnt",&iCnt);

		if(iCnt > 0){
			/*
			DBObjPtr = CreateObj(DBPtr,"DBMmsAffectFXDT","GetNextFxIdSeq");
			csFxId  = strdup((*DBObjPtr)());
DEBUGLOG(("RecordAffectFXDT() GetNextFxIdSeq: [%s]\n",csFxId));

			PutField_CString(hOut,"fx_id",csFxId);
			*/
			PutField_CString(hData,"fx_id",csFxId);
			PutField_Char(hData,"direction",cDirection);
			PutField_CString(hData,"entity_id",csEntityId);
			PutField_Int(hData,"calculate_ind",PD_FALSE);
			PutField_CString(hData,"create_user",csUser);

			for(i=1; i<=iCnt; i++){
				sprintf(csTag,"out.%d.occy",i);
				if(GetField_CString(hIn,csTag,&csTmp)){
					PutField_CString(hData,"org_ccy",csTmp);
				}
				sprintf(csTag,"out.%d.ccy",i);
				if(GetField_CString(hIn,csTag,&csTmp)){
					PutField_CString(hData,"ccy",csTmp);
				}
				sprintf(csTag,"out.%d.amt",i);
				if(GetField_Double(hIn,csTag,&dTmp)){
					PutField_Double(hData,"amount",dTmp);
				}
				sprintf(csTag,"out.%d.acr_ind",i);
				if(GetField_Int(hIn,csTag,&iTmp)){
					PutField_Int(hData,"acr_ind",iTmp);
				}

				DBObjPtr = CreateObj(DBPtr,"DBMmsAffectFXDT","Add");
				if((unsigned long)(*DBObjPtr)(hData)!=PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("RecordAffectFXDT() DBMmsAffectFXDT:Add Failed!!!\n"));
ERRLOG("BOMMMAverageCostRate: RecordAffectFXDT() DBMmsAffectFXDT:Add Failed!!!\n");
					break;
				}
			}


		}

	}


	else if(iRet==PD_OK && cDirection == PD_FUNDS_IN){
//Record down funds in information
		iCnt = 0;
		GetField_Int(hIn,"fundsin_cnt",&iCnt);

		if(iCnt > 0){
			/*
			DBObjPtr = CreateObj(DBPtr,"DBMmsAffectFXDT","GetNextFxIdSeq");
			csFxId  = strdup((*DBObjPtr)());
DEBUGLOG(("RecordAffectFXDT() GetNextFxIdSeq: [%s]\n",csFxId));

			PutField_CString(hOut,"fx_id",csFxId);
			*/
			PutField_CString(hData,"fx_id",csFxId);
			PutField_Char(hData,"direction",cDirection);
			PutField_CString(hData,"entity_id",csEntityId);
			PutField_Int(hData,"calculate_ind",PD_FALSE);
			PutField_CString(hData,"create_user",csUser);

			for(i=1; i<=iCnt; i++){
				sprintf(csTag,"in.%d.occy",i);
				if(GetField_CString(hIn,csTag,&csTmp)){
					PutField_CString(hData,"org_ccy",csTmp);
				}
				sprintf(csTag,"in.%d.ccy",i);
				if(GetField_CString(hIn,csTag,&csTmp)){
					PutField_CString(hData,"ccy",csTmp);
				}
				sprintf(csTag,"in.%d.framt",i);
				if(GetField_Double(hIn,csTag,&dTmp)){
					PutField_Double(hData,"org_amount",dTmp);
				}
				sprintf(csTag,"in.%d.amt",i);
				if(GetField_Double(hIn,csTag,&dTmp)){
					PutField_Double(hData,"amount",dTmp);
				}
				sprintf(csTag,"in.%d.acr_ind",i);
				if(GetField_Int(hIn,csTag,&iTmp)){
					PutField_Int(hData,"acr_ind",iTmp);
				}

				DBObjPtr = CreateObj(DBPtr,"DBMmsAffectFXDT","Add");
				if((unsigned long)(*DBObjPtr)(hData)!=PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("RecordAffectFXDT() DBMmsAffectFXDT:Add Failed!!!\n"));
ERRLOG("BOMMMAverageCostRate: RecordAffectFXDT() DBMmsAffectFXDT:Add Failed!!!\n");
					break;
				}
			}


		}

	}

	else{
		if(iRet == PD_OK){
DEBUGLOG(("RecordAffectFXDT() Invalid direction!!!!\n"));
ERRLOG("BOMMMAverageCostRate: RecordAffectFXDT() Invalid direction!!!!\n");
		}
	}


	FREE_ME(hData);

DEBUGLOG(("RecordAffectFXDT:: () Noraml Exit iRet = [%d]\n",iRet));
	return iRet;
}



int CalculateAffectFXDT(const hash_t* hIn)
{
	int	iRet = PD_OK;
	int	iTmp = 0;
	int	iCal = 0;
	int	iACR = 0;
	double	dTmp = 0.0;
	char	cDirection = 'x';
	char	*csTmp = NULL;
	char	*csFxId = NULL;
	char	*csOrgFxId = NULL;
	char	*csUser = NULL;
	char	*csEntityId = NULL;
	char	*csACRType;
	csACRType = (char*) malloc (128);

	hash_t	*hRec;
	hash_t	*hDetail;
	hDetail = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hDetail,0);

	hash_t	*hUpd;
	hUpd = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hUpd,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

DEBUGLOG(("CalculateAffectFXDT:: ()\n"));

	if(GetField_CString(hIn,"fx_id",&csFxId)){
DEBUGLOG(("CalculateAffectFXDT() fx_id = [%s]\n",csFxId));
	}
	else{
		iRet = INT_ERR;
DEBUGLOG(("CalculateAffectFXDT() fx_id not found\n"));
ERRLOG("BOMMMAverageCostRate::CalculateAffectFXDT() fx_id not found\n");
	}

	if(GetField_CString(hIn,"org_fx_id",&csOrgFxId)){
		PutField_CString(hDetail,"org_fx_id",csOrgFxId);
DEBUGLOG(("CalculateAffectFXDT() org_fx_id = [%s]\n",csOrgFxId));
	}

	if(GetField_CString(hIn,"update_user",&csUser)){
		PutField_CString(hDetail,"update_user",csUser);
DEBUGLOG(("CalculateAffectFXDT() update_user = [%s]\n",csUser));
	}

	if(iRet == PD_OK){
		//get fx detail by fx_id
		PutField_CString(hDetail,"fx_id",csFxId);
		PutField_CString(hUpd,"fx_id",csFxId);
		DBObjPtr = CreateObj(DBPtr,"DBMmsAffectFXDT","GetAffectFXDT");
		iRet = (unsigned long)(*DBObjPtr)(hDetail, rRecordSet);
		if(iRet == PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec && (iRet == PD_OK)) {
				if(GetField_Int(hRec,"fx_seq",&iTmp)){
					PutField_Int(hUpd,"fx_seq",iTmp);
					PutField_Int(hDetail,"fx_seq",iTmp);
DEBUGLOG(("CalculateAffectFXDT() >>> fx_seq = [%d] <<<\n",iTmp));
				}
				if(GetField_Char(hRec,"direction",&cDirection)){
					PutField_Char(hDetail,"direction",cDirection);
DEBUGLOG(("CalculateAffectFXDT() direction = [%c]\n",cDirection));
				}
				if(GetField_Int(hRec,"calculate_ind",&iCal)){
DEBUGLOG(("CalculateAffectFXDT() calculate_ind = [%d]\n",iCal));
				}
				if(GetField_CString(hRec,"entity_id",&csEntityId)){
DEBUGLOG(("CalculateAffectFXDT() entity_id = [%s]\n",csEntityId));
					PutField_CString(hDetail,"entity_id",csEntityId);

					memset(csACRType,0,sizeof(csACRType));
					DBObjPtr = CreateObj(DBPtr,"DBMmsEntity","GetACRType");
					if((unsigned long)(*DBObjPtr)(csEntityId,csACRType) == PD_FOUND){
DEBUGLOG(("CalculateAffectFXDT() Affect ACR Type = [%s]\n",csACRType));
					}
				}
				if(GetField_CString(hRec,"org_ccy",&csTmp)){
					PutField_CString(hDetail,"org_ccy",csTmp);
DEBUGLOG(("CalculateAffectFXDT() org_ccy = [%s]\n",csTmp));
				}
				if(GetField_Double(hRec,"org_amount",&dTmp)){
					PutField_Double(hDetail,"org_amount",dTmp);
DEBUGLOG(("CalculateAffectFXDT() org_amount = [%lf]\n",dTmp));
				}
				if(GetField_CString(hRec,"ccy",&csTmp)){
					PutField_CString(hDetail,"ccy",csTmp);
DEBUGLOG(("CalculateAffectFXDT() ccy = [%s]\n",csTmp));
				}
				if(GetField_Double(hRec,"amount",&dTmp)){
					PutField_Double(hDetail,"amount",dTmp);
DEBUGLOG(("CalculateAffectFXDT() amount = [%lf]\n",dTmp));
				}
				if(GetField_Int(hRec,"acr_ind",&iACR)){
					PutField_Int(hDetail,"acr_ind",iACR);
DEBUGLOG(("CalculateAffectFXDT() acr_ind = [%d]\n",iACR));
				}

				if(cDirection == PD_FUNDS_OUT && !iCal){
					if(!strcmp(csACRType,PD_ENTITY_FX)){
						iRet = DebitEntityFx(hDetail);
					}
					else if(!strcmp(csACRType,PD_ACR) && iACR){
						iRet = DebitACR(hDetail);
					}
					else{
DEBUGLOG(("CalculateAffectFXDT() Not Affect Any ACR Pool. Do nothing\n"));
					}
				}
				else if(cDirection == PD_FUNDS_IN && !iCal){

					if(!strcmp(csACRType,PD_ENTITY_FX)){
						iRet = CreditEntityFx(hDetail);
					}
					else if(!strcmp(csACRType,PD_ACR) && iACR){
						iRet = CreditACR(hDetail);
					}
					else{
DEBUGLOG(("CalculateAffectFXDT() Not Affect Any ACR Pool. Do nothing\n"));
					}
				}


				if(iRet == PD_OK){
					DBObjPtr = CreateObj(DBPtr,"DBMmsAffectFXDT","Update");
					iRet = (unsigned long)(*DBObjPtr)(hUpd);
				}

				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		else{
			iRet = INT_ERR;
DEBUGLOG(("CalculateAffectFXDT() GetAffectFXDT Failed!!!!!\n"));
ERRLOG("BOMMMAverageCostRate::CalculateAffectFXDT() GetAffectFXDT Failed!!!!!\n");
		}
		
	}


	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hDetail);
	FREE_ME(hUpd);

DEBUGLOG(("CalculateAffectFXDT:: () Noraml Exit iRet = [%d]\n",iRet));
	return iRet;
}



int DebitEntityFx(const hash_t* hIn)
{
	int	iRet = PD_OK;
	double	dBalance = 0.0;
	double	dNewBalance = 0.0;
	double	dTmp = 0.0;
	int	iTmp = 0;
	char	*csTmp = NULL;

	hash_t	*hRec;
	hash_t	*hBal;
	hBal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hBal,0);

	hash_t	*hOrgBal;
	hBal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hOrgBal,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
DEBUGLOG(("DebitEntityFx:: ()\n"));

	if(GetField_CString(hIn,"fx_id",&csTmp)){
		PutField_CString(hBal,"fx_id",csTmp);
	}
	if(GetField_Int(hIn,"fx_seq",&iTmp)){
		PutField_Int(hBal,"fx_seq",iTmp);
	}
	if(GetField_CString(hIn,"entity_id",&csTmp)){
		PutField_CString(hBal,"entity_id",csTmp);
	}
	if(GetField_CString(hIn,"org_ccy",&csTmp)){
		PutField_CString(hBal,"org_ccy",csTmp);
	}
	if(GetField_CString(hIn,"ccy",&csTmp)){
		PutField_CString(hBal,"ccy",csTmp);
	}
	if(GetField_Int(hIn,"acr_ind",&iTmp)){
		PutField_Int(hBal,"acr_ind",iTmp);
	}
	if(GetField_Char(hIn,"direction",&cTmp)){
		PutField_Char(hBal,"direction",cTmp);
	}
	if(GetField_CString(hIn,"update_user",&csTmp)){
		PutField_CString(hBal,"update_user",csTmp);
	}

	iRet = GetEntityFxBalForUpdate(hIn,hOrgBal);
	if(iRet == PD_OK){
		if(GetField_Double(hOrgBal,"bal",&dBalance)){
			PutField_Double(hBal,"old_bal",dBalance);
DEBUGLOG(("GetFxBalForUpdate() Balance = [%lf]\n",dBalance));
		}
		if(GetField_Double(hOrgBal,"rate",&dTmp)){
			PutField_Double(hBal,"old_rate",dTmp);
			PutField_Double(hBal,"new_rate",dTmp);
DEBUGLOG(("GetFxBalForUpdate() Rate = [%lf]\n",dTmp));
		}
		if(GetField_Double(hOrgBal,"ratio",&dTmp)){
			PutField_Double(hBal,"old_ratio",dTmp);
			PutField_Double(hBal,"new_ratio",dTmp);
DEBUGLOG(("GetFxBalForUpdate() Ratio = [%lf]\n",dTmp));
		}

		if(GetField_Double(hIn,"amount",&dTmp)){
			dNewBalance = dBalance - dTmp;
			PutField_Double(hBal,"bal",dNewBalance);
			PutField_Double(hBal,"new_bal",dNewBalance);
DEBUGLOG(("New Balance = [%lf]\n",dNewBalance));
		}

		DBObjPtr = CreateObj(DBPtr,"DBMmsEntityFXBal","Update");
		iRet = (unsigned long)(*DBObjPtr)(hBal);
		if(iRet != PD_OK){
DEBUGLOG(("DBMmsEntityFXBal: Update() Failed!!!!\n"));
		}

		if(iRet == PD_OK){
			DBObjPtr = CreateObj(DBPtr,"DBMmsEntityFXBalHistory","Add");
			iRet = (unsigned long)(*DBObjPtr)(hBal);
			if(iRet != PD_OK){
DEBUGLOG(("DBMmsEntityFXBalHistory: Add() Failed!!!!\n"));
			}
		}
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hBal);
	FREE_ME(hOrgBal);

DEBUGLOG(("DebitEntityFx:: () Noraml Exit iRet = [%d]\n",iRet));
	return iRet;
}


int DebitACR(const hash_t* hIn)
{
	int	iRet = PD_OK;
	double	dAmt = 0.0;
	double	dBalance = 0.0;
	double	dNewBalance = 0.0;
	double	dTmp = 0.0;
	int	iTmp = 0;
	char	*csTmp = NULL;

	hash_t	*hRec;
	hash_t	*hBal;
	hBal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hBal,0);

	hash_t	*hOrgBal;
	hBal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hOrgBal,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
DEBUGLOG(("DebitACR:: ()\n"));

	if(GetField_CString(hIn,"fx_id",&csTmp)){
		PutField_CString(hBal,"fx_id",csTmp);
	}
	if(GetField_Int(hIn,"fx_seq",&iTmp)){
		PutField_Int(hBal,"fx_seq",iTmp);
	}
	if(GetField_CString(hIn,"entity_id",&csTmp)){
		PutField_CString(hBal,"entity_id",csTmp);
	}
	if(GetField_CString(hIn,"org_ccy",&csTmp)){
		PutField_CString(hBal,"org_ccy",csTmp);
	}
	if(GetField_CString(hIn,"ccy",&csTmp)){
		PutField_CString(hBal,"ccy",csTmp);
	}
	if(GetField_Char(hIn,"direction",&cTmp)){
		PutField_Char(hBal,"direction",cTmp);
	}
	if(GetField_Double(hIn,"amount",&dAmt)){
		PutField_Double(hBal,"amount",dAmt);
	}

	DBObjPtr = CreateObj(DBPtr,"DBMmsAcrBal","GetOwnAcrBalForUpdate");
	iRet = (unsigned long)(*DBObjPtr)(hIn, hOrgBal);
	if(iRet != INT_ERR){
		if(iRet == PD_FOUND){
			if(GetField_Double(hOrgBal,"bal",&dBalance)){
				PutField_Double(hBal,"old_bal",dBalance);
DEBUGLOG(("GetOwnAcrBalForUpdate() Balance = [%lf]\n",dBalance));
			}
			if(GetField_Double(hOrgBal,"rate",&dTmp)){
				PutField_Double(hBal,"old_rate",dTmp);
				PutField_Double(hBal,"new_rate",dTmp);
DEBUGLOG(("GetOwnAcrBalForUpdate() Rate = [%lf]\n",dTmp));
			}
			if(GetField_Double(hOrgBal,"ratio",&dTmp)){
				PutField_Double(hBal,"old_ratio",dTmp);
				PutField_Double(hBal,"new_ratio",dTmp);
DEBUGLOG(("GetOwnAcrBalForUpdate() Ratio = [%lf]\n",dTmp));
			}

			dNewBalance = dBalance - dAmt;
			PutField_Double(hBal,"bal",dNewBalance);
			PutField_Double(hBal,"new_bal",dNewBalance);
DEBUGLOG(("New Balance = [%lf]\n",dNewBalance));
		}
		else{
			PutField_Double(hBal,"rate",0.0);
			PutField_Double(hBal,"ratio",0.0);
			PutField_Double(hBal,"new_rate",0.0);
			PutField_Double(hBal,"new_ratio",0.0);

			dNewBalance = dBalance - dAmt;
			PutField_Double(hBal,"bal",dNewBalance);
			PutField_Double(hBal,"new_bal",dNewBalance);
		}

		DBObjPtr = CreateObj(DBPtr,"DBMmsAcrBal","Update");
		iRet = (unsigned long)(*DBObjPtr)(hBal);
		if(iRet != PD_OK){
DEBUGLOG(("DBMmsAcrBal: Update() Failed!!!!\n"));
		}

		if(iRet == PD_OK){
			DBObjPtr = CreateObj(DBPtr,"DBMmsAcrBalHistory","Add");
			iRet = (unsigned long)(*DBObjPtr)(hBal);
			if(iRet != PD_OK){
DEBUGLOG(("DBMmsAcrBalHistory: Add() Failed!!!!\n"));
			}
		}
	}
	else{
DEBUGLOG(("GetOwnAcrBalForUpdate() Failed!!!!\n"));
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hBal);
	FREE_ME(hOrgBal);

DEBUGLOG(("DebitACR:: () Noraml Exit iRet = [%d]\n",iRet));
	return iRet;
}



int CreditEntityFx(const hash_t* hIn)
{
	int	iRet = PD_OK;
	int	iChk = PD_OK;
	int	iNewEntityFx = PD_FALSE;
	double	dBalance = 0.0;
	double	dNewBalance = 0.0;
	double	dTmp = 0.0;
	int	iTmp = 0;
	int	iACR = 0;
	int	iOrgACR = 0;
	char	*csTmp = NULL;
	char	*csOrgFxId = NULL;
	char	*csEntityId = NULL;
	char	*csOrgEntityId = NULL;
	char	*csFromCcy = NULL;
	char	*csOrgFromCcy = NULL;
	char	*csToCcy = NULL;
	char	*csOrgToCcy = NULL;

	hash_t	*hRec;
	hash_t	*hBal;
	hBal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hBal,0);

	hash_t	*hOrgBal;
	hBal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hOrgBal,0);

	hash_t	*hOrgDetail;
	hOrgDetail = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hOrgDetail,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
DEBUGLOG(("CreditEntityFx:: ()\n"));

	if(!GetField_CString(hIn,"org_fx_id",&csOrgFxId)){
		iRet = INT_ERR;
DEBUGLOG(("CreditEntityFx() org_fx_id is missing!!!!!\n"));
ERRLOG("BOMMMAverageCostRate: CreditEntityFx() org_fx_id is missing!!!!!\n");
	}

	if(GetField_CString(hIn,"fx_id",&csTmp)){
		PutField_CString(hBal,"fx_id",csTmp);
	}
	if(GetField_Int(hIn,"fx_seq",&iTmp)){
		PutField_Int(hBal,"fx_seq",iTmp);
	}
	if(GetField_CString(hIn,"entity_id",&csEntityId)){
		PutField_CString(hBal,"entity_id",csEntityId);
	}
	if(GetField_CString(hIn,"org_ccy",&csFromCcy)){
		PutField_CString(hBal,"org_ccy",csFromCcy);
	}
	if(GetField_CString(hIn,"ccy",&csToCcy)){
		PutField_CString(hBal,"ccy",csToCcy);
	}
	if(GetField_Int(hIn,"acr_ind",&iACR)){
		PutField_Int(hBal,"acr_ind",iACR);
	}
	if(GetField_Char(hIn,"direction",&cTmp)){
		PutField_Char(hBal,"direction",cTmp);
	}
	if(GetField_CString(hIn,"update_user",&csTmp)){
		PutField_CString(hBal,"update_user",csTmp);
	}

	DBObjPtr = CreateObj(DBPtr,"DBMmsEntityFXBal","GetFxBalForUpdate");
	iChk = (unsigned long)(*DBObjPtr)(hIn, hOrgBal);
	if(iChk == PD_FOUND){
		if(GetField_Double(hOrgBal,"bal",&dBalance)){
			PutField_Double(hBal,"old_bal",dBalance);
DEBUGLOG(("GetFxBalForUpdate() Balance = [%lf]\n",dBalance));
		}
		if(GetField_Double(hOrgBal,"rate",&dRate)){
			PutField_Double(hBal,"old_rate",dRate);
DEBUGLOG(("GetFxBalForUpdate() Rate = [%lf]\n",dRate));
		}
		if(GetField_Double(hOrgBal,"ratio",&dRatio)){
			PutField_Double(hBal,"old_ratio",dRatio);
DEBUGLOG(("GetFxBalForUpdate() Ratio = [%lf]\n",dRatio));
		}

	}
	else if{
		iNewEntityFx = PD_TRUE;
DEBUGLOG(("GetFxBalForUpdate() No record found.\n"));
	}
	else{
		iRet = iChk;
DEBUGLOG(("GetFxBalForUpdate() Failed!!!\n"));
	}


	if(iRet == PD_OK && !iACR){
		if(GetField_Double(hIn,"amount",&dTmp)){
			dNewBalance = dBalance + dTmp;
			PutField_Double(hBal,"bal",dNewBalance);
			PutField_Double(hBal,"new_bal",dNewBalance);
DEBUGLOG(("New Balance = [%lf]\n",dNewBalance));
		}

		DBObjPtr = CreateObj(DBPtr,"DBMmsEntityFXBal","Update");
		iRet = (unsigned long)(*DBObjPtr)(hBal);
		if(iRet != PD_OK){
DEBUGLOG(("DBMmsEntityFXBal: Update() Failed!!!!\n"));
		}

		if(iRet == PD_OK){
			DBObjPtr = CreateObj(DBPtr,"DBMmsEntityFXBalHistory","Add");
			iRet = (unsigned long)(*DBObjPtr)(hBal);
			if(iRet != PD_OK){
DEBUGLOG(("DBMmsEntityFXBalHistory: Add() Failed!!!!\n"));
			}
		}
	}

	else if(iRet == PD_OK && iACR){
		PutField_CString(hOrgDetail,"fx_id",csOrgFxId);
		DBObjPtr = CreateObj(DBPtr,"DBMmsAffectFXDT","GetAffectFXDT");
		iRet = (unsigned long)(*DBObjPtr)(hOrgDetail, rRecordSet);
		if(iRet == PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if(GetField_CString(hRec,"entity_id",&csOrgEntityId)){
				}
				if(GetField_CString(hRec,"org_ccy",&csOrgFromCcy)){
				}
				if(GetField_CString(hRec,"ccy",&csOrgToCcy)){
				}
				if(GetField_Int(hRec,"acr_ind",&iOrgACR)){
				}
				

				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}


	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hBal);
	FREE_ME(hOrgBal);
	FREE_ME(hOrgDetail);

DEBUGLOG(("CreditEntityFx:: () Noraml Exit iRet = [%d]\n",iRet));
	return iRet;
}


int CreditACR(const hash_t* hIn)
{
	int	iRet = PD_OK;


DEBUGLOG(("CreditACR:: () Noraml Exit iRet = [%d]\n",iRet));
	return iRet;
}
