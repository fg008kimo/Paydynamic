/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/07/13              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "BOMMMAverageCostRate.h"

char    cDebug;

OBJPTR(DB);
OBJPTR(BO);


void BOMMMAverageCostRate(char    cdebug)
{
        cDebug = cdebug;
}


int ProcessACR(const hash_t* hContext, const hash_t* hRequest, hash_t* hOut)
{
	int	iRet = PD_OK;
/*	char	*csPtr;
	char	*csBalAmt;
	char	*csAmtType;
	char	*csTxnCcy;
	char	*csEntityId;
	char	*csTxnCountry;
	char	csTag[PD_TAG_LEN + 1];
	double	dTxnAmt,dNatureTxnAmt;
	double	dTmp;
	int 	i,iBalCnt = 0;

	hash_t	*hData,*hRsp;

	hData = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hData,0);

	hRsp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRsp,0);
*/
	char    *csTmp = NULL;
	char    *csTxnSeq = NULL;
	char    *csTxnCode = NULL;
	char    *csEntityId = NULL;
	char    *csUser = NULL;
	char	cAction = 'x';
	double	dTmp = 0.0;
	double	dAffectFXAmt = 0.0;
	double	dNonAffectFXAmt = 0.0;
	int	i = 0;
	int	iCnt = 0;

	hash_t	*hData;

	hData = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hData,0);

DEBUGLOG(("ProcessACR:: ()\n"));

	if(GetField_CString(hContext,"txn_seq",&csTxnSeq)){
DEBUGLOG(("ProcessACR() txn_seq = [%s]\n",csTxnSeq));
	}

	if(GetField_CString(hContext,"txn_code",&csTxnCode)){
DEBUGLOG(("ProcessACR() txn_code = [%s]\n",csTxnCode));
	
		if(!strcmp(csTxnCode,PD_TXN_CODE_MMS_REMIT)){
			cAction = PD_FUNDS_OUT;
		}
		else if(!strcmp(csTxnCode,PD_TXN_CODE_MMS_RECV)){
			cAction = PD_FUNDS_IN;
		}
		else{
			iRet = INT_TXN_CODE_NOT_AVAILABLE;
DEBUGLOG(("ProcessACR() TxnCode invalid!!!\n"));
ERRLOG("BOMMMAverageCostRate::ProcessACR() TxnCode invalid!!!\n");
		}
	}

	if(GetField_CString(hContext,"entity_id",&csEntityId)){
DEBUGLOG(("ProcessACR() entity_id = [%s]\n",csEntityId));
	}

	if(GetField_Double(hContext,"aff_fx_amt",&dAffectFXAmt)){
DEBUGLOG(("ProcessACR() aff_fx_amt = [%lf]\n",dAffectFXAmt));
	}

	if(GetField_Double(hContext,"non_aff_fx_amt",&dNonAffectFXAmt)){
DEBUGLOG(("ProcessACR() non_aff_fx_amt = [%lf]\n",dNonAffectFXAmt));
	}

	if(GetField_CString(hRequest,"add_user",&csUser)){
DEBUGLOG(("ProcessACR() add_user = [%s]\n",csUser));
	}

	if(iRet==PD_OK){
///////--------------Remit--------------/////
//Record down funds out information
		if(cAction==PD_FUNDS_OUT){
			char	*csFxSeq;
			iCnt = 0;
			GetField_Int(hContext,"fx_cnt",&iCnt);

			DBObjPtr = CreateObj(DBPtr,"DBMmsAffectFXDT","GetNextFxIdSeq");
			csFxSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("ProcessACR() GetNextFxIdSeq: [%s]\n",csFxSeq));

			PutField_CString(hData,"fx_id",csFxSeq);
			PutField_CString(hOut,"fx_id",csFxSeq);
			PutField_Char(hData,"direction",PD_FUNDS_OUT);
			PutField_CString(hData,"entity_id",csEntityId);
			PutField_Int(hData,"calculate_ind",PD_FALSE);
			PutField_Double(hData,"aff_fx_amt",dAffectFXAmt);
			PutField_Double(hData,"non_aff_fx_amt",dNonAffectFXAmt);
			PutField_CString(hData,"create_user",csUser);

			for(i=1; i<=iCnt; i++){
				sprintf(csTag,"fx.%d.occy",i);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hData,"org_ccy",csTmp);
				}
				sprintf(csTag,"fx.%d.ccy",i);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hData,"ccy",csTmp);
				}
				sprintf(csTag,"fx.%d.amt",i);
				if(GetField_Double(hContext,csTag,&dTmp)){
					PutField_Double(hData,"amount",dTmp);
				}

				DBObjPtr = CreateObj(DBPtr,"DBMmsAffectFXDT","Add");
				if((unsigned long)(*DBObjPtr)(hData)!=PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("ProcessACR() DBMmsAffectFXDT:Add Failed!!!\n"));
ERRLOG("BOMMMAverageCostRate: ProcessACR() DBMmsAffectFXDT:Add Failed!!!\n");
					break;
				}
			}

//for Remit from PSP case: no input fx pool but affect fx
			if(iCnt == 0){
				if(GetField_CString(hContext,"txn_ccy",&csTmp)){
					PutField_CString(hData,"ccy",csTmp);
				}
				PutField_Double(hData,"amount",0.0);
				PutField_Int(hData,"calculate_ind",PD_TRUE);
				DBObjPtr = CreateObj(DBPtr,"DBMmsAffectFXDT","Add");
				if((unsigned long)(*DBObjPtr)(hData)!=PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("ProcessACR() DBMmsAffectFXDT:Add Failed!!!\n"));
ERRLOG("BOMMMAverageCostRate: ProcessACR() DBMmsAffectFXDT:Add Failed!!!\n");
				}
			}
			else{
//if there are non-affect fx amount, need to put to "000"-> CCY pool
				if(dNonAffectFXAmt>0.0){
					if(GetField_CString(hContext,"txn_ccy",&csTmp)){
						PutField_CString(hData,"ccy",csTmp);
						PutField_CString(hData,"occy",PD_CCY_UNKNOWN);
					}
					PutField_Double(hData,"amount",dNonAffectFXAmt);
					DBObjPtr = CreateObj(DBPtr,"DBMmsAffectFXDT","Add");
					if((unsigned long)(*DBObjPtr)(hData)!=PD_OK){
						iRet = INT_ERR;
DEBUGLOG(("ProcessACR() DBMmsAffectFXDT:Add Failed!!!\n"));
ERRLOG("BOMMMAverageCostRate: ProcessACR() DBMmsAffectFXDT:Add Failed!!!\n");
					}
				}
			}

			FREE_ME(csFxSeq);

		}

///////--------------Receive--------------/////
//Record down funds in information
		else if(cAction==PD_FUNDS_IN){

			if(GetField_CString(hContext,"txn_ccy",&csTmp)){
				PutField_CString(hData,"ccy",csTmp);
DEBUGLOG(("ProcessACR() txn_ccy = [%s]\n",csTmp));
			}
			if(GetField_Double(hContext,"txn_amt",&dTmp)){
				PutField_Double(hData,"amount",dTmp);
DEBUGLOG(("ProcessACR() txn_amt = [%lf]\n",dTmp));
			}



		}

		else{
			//no such action, do nothing
		}
	}

	/*
	   if (GetField_CString(hTxn,"action",&csAction)) {
DEBUGLOG(("ProcessACR() action = [%s]\n",csAction));
        }

// entity id
        if (GetField_CString(hContext,"entity_id",&csEntityId)) {
DEBUGLOG(("ProcessACR() Entity ID = [%s]\n",csEntityId));
      	}
       	else {
DEBUGLOG(("ProcessACR() Entity ID nto found\n"));
ERRLOG("BOMMMAverageCostRate::ProcessACR() Entity ID not found\n");
       		iRet = INT_MMS_ENTITY_ID_NOT_FOUND;
       	}

// from_ccy
       	if (GetField_CString(hTxn,"from_ccy",&csFromCcy)) {
DEBUGLOG(("ProcessACR() from_ccy = [%s]\n",csFromCcy));
       	}
       	else {
		iRet = INT_MMS_CCY_NOT_FOUND;
DEBUGLOG(("ProcessACR() from_ccy not found\n"));
ERRLOG("BOMMMAverageCostRate::ProcessACR() txn_ccy not found\n");
       	}


// to_ccy
	if (GetField_CString(hTxn,"to_ccy",&csToCcy)) {
DEBUGLOG(("ProcessACR() to_ccy = [%s]\n",csToCcy));
	}
	else{
		if(!strcmp(csAction,PD_MMM_CONVERT)){
			iRet = INT_MMS_CCY_NOT_FOUND;
DEBUGLOG(("ProcessACR() to_ccy not found\n"));
ERRLOG("BOMMMAverageCostRate::ProcessACR() to_ccy not found\n");
		}
	}

//from_amt
	if(GetField_Double(hTxn,"from_amt",&dFromAmt)){
DEBUGLOG(("ProcessACR() from_amt = [%lf]\n",dFromAmt));
	}
	else{
		iRet = INT_TXN_AMT_MISSING;
DEBUGLOG(("ProcessACR() from_amt not found\n"));
ERRLOG("BOMMMAverageCostRate::ProcessACR() from_amt not found\n");
	}

//to_amt
	if(GetField_Double(hTxn,"to_amt",&dToAmt)){
DEBUGLOG(("ProcessACR() to_amt = [%lf]\n",dToAmt));
	}
	else{
		if(!strcmp(csAction,PD_MMM_CONVERT)){
			iRet = INT_TXN_AMT_MISSING;
DEBUGLOG(("ProcessACR() to_amt not found\n"));
ERRLOG("BOMMMAverageCostRate::ProcessACR() to_amt not found\n");
		}
	}


//acr_ind
	if(GetField_Int(hTxn,"acr_ind",&iACRInd)){
DEBUGLOG(("ProcessACR() acr_ind = [%d]\n",iACRInd));
	}
	else{
		iRet = INT_ERR;
DEBUGLOG(("ProcessACR() acr_ind not found\n"));
ERRLOG("BOMMMAverageCostRate::ProcessACR() acr_ind not found\n");
	}
*/








	FREE_ME(hData);

DEBUGLOG(("ProcessACR:: () Noraml Exit iRet = [%d]\n",iRet));
	return iRet;
}
