/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/04/14              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOBalance.h"

char    cDebug;
OBJPTR(DB);

void BOBalance(char    cdebug)
{
        cDebug = cdebug;
}
int CreditDepositAmount(const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode, 
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dMerchantAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee) ;

int PayoutVoided(const char* csCountry, 
		const char* csServiceCode, 
		const char* csMerchantCCY, 
		const char* csMerchantID,
		double dMerchantAmount,
		const char* csPspCCY,
		const char* csPspID,
		double dPspAmount);

int PayoutSuccess(const char* csCountry, 
			const char* csServiceCode, 
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dMerchantAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount);

int UpdateTxnAmount(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csTxnCode;
	char	*csPostingDate;
	char	*csOrgTxnSeq;
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgPspCcy;
	char	*csOrgPspId;
	char	*csOrgServiceCode;
	double	dOrgNetAmt;
	double	dOrgPspTxnAmt;
	double	dReserveAmt = 0;
	double	dPspFee = 0;
	double	dTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:UpdateTxnAmount()\n"));
/*posting date*/
	if (GetField_CString(hContext,"PHDATE",&csPostingDate)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() posting_date = [%s]\n",csPostingDate));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() posting_date is missing!!!\n"));
	}
/*txn code */
	if (GetField_CString(hContext,"txn_code",&csTxnCode)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() txn_code = [%s]\n",csTxnCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() txn_code is missing!!!\n"));
	}
/*org txn seq */
	if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_seq = [%s]\n",csOrgTxnSeq));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_seq is missing!!!\n"));
	}

/*org txn country */
	if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_country is missing!!!\n"));
	}

/*org txn ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_ccy is missing!!!\n"));
	}
/*org service Code */
	if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_service_code is missing!!!\n"));
	}

/*org merchant id */
	if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_merchant_id is missing!!!\n"));
	}

/*org psp ccy */
	if (GetField_CString(hContext,"org_psp_txn_ccy",&csOrgPspCcy)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_psp_txn_ccy = [%s]\n",csOrgPspCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_psp_txn_ccy is missing!!!\n"));
	}


/*org psp id */
	if (GetField_CString(hContext,"org_psp_id",&csOrgPspId)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_psp_id = [%s]\n",csOrgPspId));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_psp_id is missing!!!\n"));
	}

/*org net amount */
	if (GetField_Double(hContext,"net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() net_amt = [%lf]\n",dOrgNetAmt));
	}
	else {
		if (GetField_Double(hContext,"org_net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_net_amt = [%lf]\n",dOrgNetAmt));
		}
		else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_net_amt is missing!!!\n"));
		}
	}

/*org psp txn amount */
	if (GetField_Double(hContext,"org_psp_txn_amt",&dOrgPspTxnAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_psp_txn_amt = [%lf]\n",dOrgPspTxnAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_psp_txn_amt is missing!!!\n"));
	}

/*reserved amt */
	if (GetField_Double(hContext,"reserve_amt",&dReserveAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() reserve_amt = [%lf]\n",dReserveAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() not reserve_amt\n"));
	}

/* psp_fee */
	if (GetField_Double(hContext,"precal_fee",&dPspFee)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() precal_fee = [%lf]\n",dPspFee));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() precal_fee not found, try to get from request\n"));
		if (GetField_Double(hRequest,"service_fee",&dPspFee)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() service_fee = [%lf]\n",dPspFee));
		}
		else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() service_fee is missing!!!\n"));
		}
	}


	if (!strcmp(csTxnCode,PD_DEPOSIT_TXN_CODE) || 
            !strcmp(csTxnCode,PD_INITIAL_TXN_CODE)) {
DEBUGLOG(("BOBalance:UpdateTxnAmount() Update Deposit Txn\n"));
		iRet =CreditDepositAmount(csPostingDate,
					csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt,
					csOrgPspCcy,
					csOrgPspId,
					dOrgPspTxnAmt,
					dReserveAmt,
					dPspFee);
		
		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csOrgMerchantId,csOrgTxnCcy,csOrgTxnCountry,csOrgServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"payout_bal",&dTmp)){
				PutField_Double(hContext,"payout_bal",dTmp);
DEBUGLOG(("BOBalance: payout_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"settlement_bal",&dTmp)){
				PutField_Double(hContext,"settlement_bal",dTmp);
DEBUGLOG(("BOBalance: settlement_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_tfr_hold",&dTmp)){
				PutField_Double(hContext,"total_tfr_hold",dTmp);
DEBUGLOG(("BOBalance: total_tfr_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_payout_hold",&dTmp)){
				PutField_Double(hContext,"total_payout_hold",dTmp);
DEBUGLOG(("BOBalance: total_payout_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_settlement_hold",&dTmp)){
				PutField_Double(hContext,"total_settlement_hold",dTmp);
DEBUGLOG(("BOBalance: total_settlement_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"payout_in_transit",&dTmp)){
				PutField_Double(hContext,"payout_in_transit",dTmp);
DEBUGLOG(("BOBalance: payout_in_transit= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"settlement_in_transit",&dTmp)){
				PutField_Double(hContext,"settlement_in_transit",dTmp);
DEBUGLOG(("BOBalance: settlement_in_transit= [%f]\n",dTmp));
			}
		}
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalance");
		if((unsigned long)(*DBObjPtr)(csOrgPspId,csOrgTxnCountry,csOrgPspCcy,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"balance",&dTmp)){
				PutField_Double(hContext,"psp_balance",dTmp);
DEBUGLOG(("BOBalance:psp_balance = [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"psp_total_float",dTmp);
DEBUGLOG(("BOBalance:psp_total_float = [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"psp_total_hold",dTmp);
DEBUGLOG(("BOBalance:psp_total_hold = [%f]\n",dTmp));
			}
		}

		FREE_ME(hVal);
	}
	else {
DEBUGLOG(("BOBalance:None DSP txn\n"));
	}
	
	return iRet;
}

int CreditDepositAmount(const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dMerchantAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee) 
{
	int iRet = PD_OK;

DEBUGLOG(("BOBalance:CreditDepositAmount()\n"));
DEBUGLOG(("BOBalance:CreditDepositAmount() merchant = [%lf], psp = [%lf], res = [%lf]\n",dMerchantAmount,dPspAmount,dReserveAmount));

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBucket","CreditMerchantAmount");
        if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			csPspID,
			PD_BUCKET_TYPE_FLOAT,
			dMerchantAmount - dReserveAmount,
			PD_UPDATE_USER) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() CreditMerchantAmount [Float]Failed\n"));
	}

	if (iRet == PD_OK && dReserveAmount > 0) {
 	       if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			csPspID,
			PD_BUCKET_TYPE_RESERVED,
			dReserveAmount,
			PD_UPDATE_USER) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() CreditMerchantAmount [Reserved]Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:CreditDepositAmount UpdateFloat\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateFloat");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dMerchantAmount - dReserveAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() UpdateFloat Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:CreditDepositAmount UpdateReserved\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateReserved");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dReserveAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() UpdateFloat Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:CreditDepositAmount CreditPSP Balance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","CreditBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				csServiceCode,
				dPspAmount - dPspFee,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() UpdateFloat Failed\n"));
		}
	}

DEBUGLOG(("BOBalance:CreditDepositAmount() iRet = [%d]\n",iRet));
	return iRet;
}


int UpdatePayoutAmount(const hash_t *hContext)
{
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgServiceCode;
	char	cBalTrfMode;
	double	dOrgMerchantAmt;

	int iRet = PD_OK;

/*org txn country */
	if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_country is missing!!!\n"));
	}

/*org txn ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_ccy is missing!!!\n"));
	}
/*org service code */
	if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_service_code is missing!!!\n"));
	}

/*org merchant id */
	if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_merchant_id is missing!!!\n"));
	}

/*pay_amt*/
	if (GetField_Double(hContext,"org_merchant_txn_amt",&dOrgMerchantAmt)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_merchant_txn_amt = [%f]\n",dOrgMerchantAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_merchant_txn_amt is missing!!!\n"));
	}

/*bal_trf_mode*/
	if (GetField_Char(hContext,"bal_trf_mode",&cBalTrfMode)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() bal_trf_mode = [%c]\n",cBalTrfMode));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() bal_trf_mode is missing!!!\n"));
	}
	
	if(cBalTrfMode==PD_P2I){
DEBUGLOG(("BOBalance:CreditPayoutAmount Payout to In-transit\n"));
	}
	else{
DEBUGLOG(("BOBalance:DebitPayoutAmount In-transit to Payout\n"));
	}

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","Payout2InTransit");
       	if ((*DBObjPtr)(csOrgMerchantId,
			csOrgTxnCountry,
			csOrgTxnCcy,
			csOrgServiceCode,
			dOrgMerchantAmt,
			cBalTrfMode,
			PD_UPDATE_USER) != PD_OK) {

			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBMerchantBalance::Payout2InTransit() Failed\n"));
	}
	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() iRet = [%d]\n",iRet));
	return iRet;
}



int UpdatePayoutResponse(const hash_t* hContext)
{
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgServiceCode;
	char	*csOrgPspCcy;
	char	*csOrgPspId;
	char	cRespMode;
	double	dOrgMerchantAmt;
	double	dOrgPspTxnAmt;
	double	dPrecalFee=0;

	int iRet = PD_OK;

/*org txn country */
	if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_txn_country is missing!!!\n"));
	}

/*org txn ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_txn_ccy is missing!!!\n"));
	}
/*org service code */
	if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_service_code is missing!!!\n"));
	}

/*org merchant id */
	if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_merchant_id is missing!!!\n"));
	}

/*org_txn_amt*/
	if (GetField_Double(hContext,"org_merchant_txn_amt",&dOrgMerchantAmt)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_merchant_txn_amt = [%f]\n",dOrgMerchantAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_merchant_txn_amt is missing!!!\n"));
	}

/*response_mode*/
	if (GetField_Char(hContext,"response_mode",&cRespMode)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() response_mode = [%s]\n",cRespMode));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() response_mode is missing!!!\n"));
	}
	
/*org psp id */
	if (GetField_CString(hContext,"org_psp_id",&csOrgPspId)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_psp_id = [%s]\n",csOrgPspId));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_psp_id is missing!!!\n"));
	}

/*org psp ccy */
	if (GetField_CString(hContext,"org_psp_txn_ccy",&csOrgPspCcy)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_psp_txn_ccy = [%s]\n",csOrgPspCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_psp_txn_ccy is missing!!!\n"));
	}

/*org psp txn amount */
	if (GetField_Double(hContext,"org_psp_txn_amt",&dOrgPspTxnAmt)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_psp_txn_amt = [%lf]\n",dOrgPspTxnAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_psp_txn_amt is missing!!!\n"));
	}

/*org psp precal fee*/
	if (GetField_Double(hContext,"precal_fee",&dPrecalFee)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() psp precal_fee = [%lf]\n",dPrecalFee));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() psp precal_fee is missing!!!\n"));
	}

	if(cRespMode==PD_ACCEPT){
		iRet = PayoutSuccess(csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgMerchantAmt,
					csOrgPspCcy,
					csOrgPspId,
					dOrgPspTxnAmt+dPrecalFee);
	}
	else if(cRespMode==PD_REVERSED){
		iRet = PayoutVoided(csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgMerchantAmt,
					csOrgPspCcy,
					csOrgPspId,
					dOrgPspTxnAmt+dPrecalFee);
	}

	return iRet;

}


int PayoutSuccess(const char* csCountry, 
			const char* csServiceCode,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dMerchantAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount)
{
	int iRet = PD_OK;

DEBUGLOG(("BOBalance:PayoutSuccess()\n"));
DEBUGLOG(("BOBalance:PayoutSuccess() merchant = [%lf], psp = [%lf]\n",dMerchantAmount,dPspAmount));


	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdatePayoutIntransit");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dMerchantAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBMerchantBalance::UpdatePayoutIntransit()  Failed\n"));
		}
	}


	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:PayoutSuccess DebitPSP Balance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				dPspAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBPspBalance::DebitBalance() Failed\n"));
		}
	}


DEBUGLOG(("BOBalance:PayoutSuccess() iRet = [%d]\n",iRet));
	return iRet;
}



int PayoutVoided(const char* csCountry, 
		const char* csServiceCode,
		const char* csMerchantCCY, 
		const char* csMerchantID,
		double dMerchantAmount,
		const char* csPspCCY,
		const char* csPspID,
		double dPspAmount)
{
	int iRet = PD_OK;

DEBUGLOG(("BOBalance:PayoutVoided()\n"));
DEBUGLOG(("BOBalance:PayoutVoided() merchant = [%lf], psp = [%lf]\n",dMerchantAmount,dPspAmount));


	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","VoidPayout");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dMerchantAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBMerchantBalance::VoidPayout() Failed\n"));
		}
	}


	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:PayoutVoided CreditPSP Balance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","CreditBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				dPspAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBPspBalance::CreditBalance() Failed\n"));
		}
	}

DEBUGLOG(("BOBalance:PayoutVoided() iRet = [%d]\n",iRet));
	return iRet;
}


int ProcessHold(const char *csTxnCountry,
		const char *csServiceCode,
		const char *csTxnCcy,
		const char *csMerchantId,
		const char *csHoldType,
		double dHoldAmt)
{
	int iRet = PD_OK;

	char csCheckHoldType[PD_HOLD_TYPE_LEN+1];
	double dPayoutBal=0;
	double dMinPayoutBal=0;
	double dSettleBal=0;
	double dPayoutHold=0;
	double dSettleHold=0;
	double dHoldRemain;
	double dTmp;
	int i = 0;

	hash_t *hVal;
	hash_t *hTxn;

	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

DEBUGLOG(("BOBalance: ProcessHold: HoldType[%s] HoldAmt[%f]\n",csHoldType,dHoldAmt));

/////hold values from MerchantBalance/////

DEBUGLOG(("BOBalance: ProcessHold: DBMerchantBalance->GetCurrentValues\n"));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
	if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){
		if(GetField_Double(hVal,"payout_bal",&dTmp)){
			
/*TODO: Get the minimum payout balance value*/

			dPayoutBal = dTmp - dMinPayoutBal;
DEBUGLOG(("BOBalance: payout_bal= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"settlement_bal",&dSettleBal)){
DEBUGLOG(("BOBalance: settlement_bal= [%f]\n",dSettleBal));
		}
		if(GetField_Double(hVal,"total_payout_hold",&dPayoutHold)){
DEBUGLOG(("BOBalance: total_payout_hold= [%f]\n",dPayoutHold));
		}
		if(GetField_Double(hVal,"total_settlement_hold",&dSettleHold)){
DEBUGLOG(("BOBalance: total_settlement_hold= [%f]\n",dSettleHold));
		}
	}

	dHoldRemain = dHoldAmt;
	strcpy(csCheckHoldType,csHoldType);
	csCheckHoldType[PD_HOLD_TYPE_LEN]='\0';

	do{
		i ++;
		if(!strcmp(csCheckHoldType,PD_HOLD_SETTLEMENT)){
			if(dSettleBal>=dHoldRemain){
				dSettleHold += dHoldRemain;
				dSettleBal -= dHoldRemain;
				dHoldRemain = 0;
			}
			else{
				dHoldRemain -= dSettleBal;
				dSettleHold += dSettleBal;
				dSettleBal = 0;
				strcpy(csCheckHoldType,PD_HOLD_PAYOUT);
			}
DEBUGLOG(("BOBalance: New Settlement Balance[%f] Settlement Hold[%f] Remain Hold[%f]\n",dSettleBal,dSettleHold,dHoldRemain));

///////Update Hold Amount Table
			DBObjPtr = CreateObj(DBPtr,"DBHoldAmount","UpdateHoldAmount");
			if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCountry,
							csTxnCcy,csServiceCode,
							csCheckHoldType,dSettleHold,PD_UPDATE_USER)!=PD_OK){
				iRet = PD_ERR;
			}
		}
		else if(!strcmp(csCheckHoldType,PD_HOLD_PAYOUT)){
			if(dPayoutBal>=dHoldRemain){
				dPayoutHold += dHoldRemain;
				dPayoutBal -= dHoldRemain;
				dHoldRemain = 0;
			}
			else{
				dHoldRemain -= dPayoutBal;
				dPayoutHold += dPayoutBal;
				dPayoutBal = 0;
				strcpy(csCheckHoldType,PD_HOLD_SETTLEMENT);
			}
DEBUGLOG(("BOBalance: New Payout Balance[%f] Payout Hold[%f] Remain Hold[%f]\n",dPayoutBal+dMinPayoutBal,dPayoutHold,dHoldRemain));

///////Update Hold Amount Table
			DBObjPtr = CreateObj(DBPtr,"DBHoldAmount","UpdateHoldAmount");
			if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCountry,
							csTxnCcy,csServiceCode,
							csCheckHoldType,dPayoutHold,PD_UPDATE_USER)!=PD_OK){
				iRet = PD_ERR;
			}
		}
		else{
DEBUGLOG(("BOBalance: Invalid Hold Type\n"));
			iRet = PD_ERR;
		}

		if((i>=2)||(dHoldRemain==0)){
			break;
		}

	}while(PD_TRUE);

	if(iRet==PD_OK){
///////Update MerchantBalance Table
		hTxn = (hash_t*) malloc (sizeof(hash_t));
                hash_init(hTxn,0);

		PutField_CString(hTxn,"merchant_id",csMerchantId);
		PutField_CString(hTxn,"country_id",csTxnCountry);
		PutField_CString(hTxn,"ccy_id",csTxnCcy);
		PutField_CString(hTxn,"service_code",csServiceCode);
		PutField_Double(hTxn,"payout_bal",dPayoutBal+dMinPayoutBal);
		PutField_Double(hTxn,"payout_hold",dPayoutHold);
		PutField_Double(hTxn,"settlement_bal",dSettleBal);
		PutField_Double(hTxn,"settlement_hold",dSettleHold);
		PutField_CString(hTxn,"update_user",PD_UPDATE_USER);

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateBalanceAndHold");
		if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
			iRet = PD_ERR;
DEBUGLOG(("BOBalance: DBMerchantBalance::UpdateBalanceAndHold Error\n"));
		}

		FREE_ME(hTxn);
	}

	FREE_ME(hVal);	
	return iRet;
}
