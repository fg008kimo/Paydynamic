/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/04/14              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOBalance.h"

char    cDebug;
OBJPTR(DB);

void BOBalance(char    cdebug)
{
        cDebug = cdebug;
}
int UpdatetMerchantAvalAmt(const char* csCountry,
                        const char* csServiceCode,
                        const char* csMerchantCCY,
                        const char* csMerchantID,
                        double dTxnAmt);

int CreditDepositAmount(const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode, 
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dMerchantAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee);

int DebitDepositAmount(const char* csPostingDate,
                       const char* csCountry,
		       const char* csServiceCode,
		       const char* csMerchantCCY,
		       const char* csMerchantID,
		       double dMerchantAmount,
		       const char* csPspCCY,
		       const char* csPspID,
		       double dPspAmount,
		       double dReserveAmount,
		       double dPspFee);

int PayoutVoided(const char* csCountry, 
		const char* csServiceCode, 
		const char* csMerchantCCY, 
		const char* csMerchantID,
		double dMerchantAmount,
		const char* csPspCCY,
		const char* csPspID,
		double dPspAmount,
		char   cParty,
		const int iDayOfWeek);

int PayoutSuccess(const char* csCountry, 
			const char* csServiceCode, 
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dMerchantAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			char   cParty,
			const int iDayOfWeek);

int UpdateTxnAmount(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csTxnCode;
	char	*csPostingDate;
	char	*csOrgTxnSeq;
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgDstCcy;
	char	*csOrgPspId;
	char	*csOrgServiceCode;
	double	dOrgNetAmt;
	double	dOrgDstTxnAmt;
	double	dReserveAmt = 0;
	double	dPspFee = 0;
	double	dTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:UpdateTxnAmount()\n"));
/*posting date*/
	if (GetField_CString(hContext,"PHDATE",&csPostingDate)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() posting_date = [%s]\n",csPostingDate));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() posting_date is missing!!!\n"));
	}
/*txn code */
	if (GetField_CString(hContext,"txn_code",&csTxnCode)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() txn_code = [%s]\n",csTxnCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() txn_code is missing!!!\n"));
	}
/*org txn seq */
	if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_seq = [%s]\n",csOrgTxnSeq));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_seq is missing!!!\n"));
	}

/*org txn country */
	if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_country is missing!!!\n"));
	}

/*org txn ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_ccy is missing!!!\n"));
	}
/*org service Code */
	if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_service_code is missing!!!\n"));
	}

/*org merchant id */
	if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_merchant_id is missing!!!\n"));
	}

/*org psp ccy */
	if (GetField_CString(hContext,"org_dst_txn_ccy",&csOrgDstCcy)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_dst_txn_ccy = [%s]\n",csOrgDstCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_dst_txn_ccy is missing!!!\n"));
	}


/*org psp id */
	if (GetField_CString(hContext,"org_psp_id",&csOrgPspId)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_psp_id = [%s]\n",csOrgPspId));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_psp_id is missing!!!\n"));
	}

/*org net amount */
	if (GetField_Double(hContext,"net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() net_amt = [%lf]\n",dOrgNetAmt));
	}
	else {
		if (GetField_Double(hContext,"org_net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_net_amt = [%lf]\n",dOrgNetAmt));
		}
		else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_net_amt is missing!!!\n"));
		}
	}

/*org psp txn amount */
	if (GetField_Double(hContext,"org_dst_net_amt",&dOrgDstTxnAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_dst_net_amt = [%lf]\n",dOrgDstTxnAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_dst_net_amt is missing!!!\n"));
	}

/*reserved amt */
	if (GetField_Double(hContext,"reserve_amt",&dReserveAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() reserve_amt = [%lf]\n",dReserveAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() not reserve_amt\n"));
	}

/* psp_fee */
	if (GetField_Double(hContext,"precal_fee",&dPspFee)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() precal_fee = [%lf]\n",dPspFee));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() precal_fee not found, try to get from request\n"));
		if (GetField_Double(hRequest,"service_fee",&dPspFee)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() service_fee = [%lf]\n",dPspFee));
		}
		else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() service_fee is missing!!!\n"));
		}
	}


	if (!strcmp(csTxnCode,PD_DEPOSIT_TXN_CODE) || 
            !strcmp(csTxnCode,PD_INITIAL_TXN_CODE)) {
DEBUGLOG(("BOBalance:UpdateTxnAmount() Update Deposit Txn\n"));
		iRet =CreditDepositAmount(csPostingDate,
					csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt,
					csOrgDstCcy,
					csOrgPspId,
					dOrgDstTxnAmt,
					dReserveAmt,
					dPspFee);
	}
	else if(!strcmp(csTxnCode,PD_VOID_TXN_CODE)){

DEBUGLOG(("BOBalance:UpdateTxnAmount() Update Deposit Txn (Void)\n"));
		iRet =DebitDepositAmount(csPostingDate,
                                        csOrgTxnCountry,
                                        csOrgServiceCode,
                                        csOrgTxnCcy,
                                        csOrgMerchantId,
                                        dOrgNetAmt,
                                        csOrgDstCcy,
                                        csOrgPspId,
                                        dOrgDstTxnAmt,
                                        dReserveAmt,
                                        dPspFee);
	}
	else {
DEBUGLOG(("BOBalance:None DSP txn\n"));
	}
	
	if(iRet==PD_OK){

		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csOrgMerchantId,csOrgTxnCcy,csOrgTxnCountry,csOrgServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"current_bal",&dTmp)){
				PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOBalance: current_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOBalance: total_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"settlement_in_transit",&dTmp)){
				PutField_Double(hContext,"settlement_in_transit",dTmp);
DEBUGLOG(("BOBalance: settlement_in_transit= [%f]\n",dTmp));
			}
		}
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalance");
		if((unsigned long)(*DBObjPtr)(csOrgPspId,csOrgTxnCountry,csOrgDstCcy,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"balance",&dTmp)){
				PutField_Double(hContext,"psp_balance",dTmp);
DEBUGLOG(("BOBalance:psp_balance = [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"psp_total_float",dTmp);
DEBUGLOG(("BOBalance:psp_total_float = [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"psp_total_hold",dTmp);
DEBUGLOG(("BOBalance:psp_total_hold = [%f]\n",dTmp));
			}
		}

		FREE_ME(hVal);
	}
	
	return iRet;
}

int CreditDepositAmount(const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dMerchantAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee) 
{
	int iRet = PD_OK;

DEBUGLOG(("BOBalance:CreditDepositAmount()\n"));
DEBUGLOG(("BOBalance:CreditDepositAmount() merchant = [%lf], psp = [%lf], res = [%lf]\n",dMerchantAmount,dPspAmount,dReserveAmount));

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBucket","CreditMerchantAmount");
        if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			csPspID,
			PD_BUCKET_TYPE_FLOAT,
			dMerchantAmount - dReserveAmount,
			PD_UPDATE_USER) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() CreditMerchantAmount [Float]Failed\n"));
	}

	if (iRet == PD_OK && dReserveAmount > 0) {
 	       if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			csPspID,
			PD_BUCKET_TYPE_RESERVED,
			dReserveAmount,
			PD_UPDATE_USER) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() CreditMerchantAmount [Reserved]Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:CreditDepositAmount UpdateFloat\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateFloat");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dMerchantAmount - dReserveAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() UpdateFloat Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:CreditDepositAmount UpdateReserved\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateReserved");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dReserveAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() UpdateFloat Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:CreditDepositAmount CreditPSP Balance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","CreditBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				PD_PSP_FLOAT,
				dPspAmount - dPspFee,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() UpdateFloat Failed\n"));
		}
	}

DEBUGLOG(("BOBalance:CreditDepositAmount() iRet = [%d]\n",iRet));
	return iRet;
}



int UpdatePayoutAmount(hash_t* hContext)
{
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgServiceCode;
	char	*csOrgDstCcy;
	char	*csOrgPspId;
	char	cRespMode;
	char	cParty;
	double	dOrgNetAmt=0.0;
	double	dOrgDstTxnAmt=0.0;
	double	dPrecalFee=0.0;
	double	dTmp;
	int	iDayOfWeek=0;
	hash_t* hVal;

	int iRet = PD_OK;

/*org txn country */
	if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_country is missing!!!\n"));
	}

/*org txn ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_ccy is missing!!!\n"));
	}
/*org service code */
	if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_service_code is missing!!!\n"));
	}

/*org merchant id */
	if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_merchant_id is missing!!!\n"));
	}

/*org net amount */
	if (GetField_Double(hContext,"net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() net_amt = [%lf]\n",dOrgNetAmt));
	}
	else {
		if (GetField_Double(hContext,"org_net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_net_amt = [%lf]\n",dOrgNetAmt));
		}
		else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_net_amt is missing!!!\n"));
		}
	}

/*response_mode*/
	if (GetField_Char(hContext,"response_mode",&cRespMode)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() response_mode = [%c]\n",cRespMode));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() response_mode is missing!!!\n"));
	}
	
/*party_type*/
	if(GetField_Char(hContext,"party_type",&cParty)){
DEBUGLOG(("BOBalance:UpdatePayoutAmount() party_type = [%c]\n",cParty));
	}
	else{
		cParty = PD_TYPE_GLOBAL;
	}

/*org psp id */
	if (GetField_CString(hContext,"org_psp_id",&csOrgPspId)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_psp_id = [%s]\n",csOrgPspId));
	}
	else {
		if(cParty==PD_TYPE_MERCHANT){
			csOrgPspId = strdup("NA");
		}
		else{
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_psp_id is missing!!!\n"));
		}
	}

/*org psp ccy */
	if (GetField_CString(hContext,"org_psp_txn_ccy",&csOrgDstCcy)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_psp_txn_ccy = [%s]\n",csOrgDstCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_psp_txn_ccy is missing!!!\n"));
	}

/*org psp txn amount */
	if (GetField_Double(hContext,"org_dst_net_amt",&dOrgDstTxnAmt)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_dst_net_amt = [%lf]\n",dOrgDstTxnAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_dst_net_amt is missing!!!\n"));
	}

/*org psp precal fee*/
	if (GetField_Double(hContext,"precal_fee",&dPrecalFee)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() psp precal_fee = [%lf]\n",dPrecalFee));
	}

/*DayOfWeek*/
	if (GetField_Int(hContext,"day_of_week",&iDayOfWeek)) {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() day_of_week = [%d]\n",iDayOfWeek));
	}

	if(cRespMode==PD_ACCEPT){
		iRet = PayoutSuccess(csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt,
					csOrgDstCcy,
					csOrgPspId,
					dOrgDstTxnAmt+dPrecalFee,
					cParty,
					iDayOfWeek);
	}
	else if(cRespMode==PD_REVERSED){
		iRet = PayoutVoided(csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt,
					csOrgDstCcy,
					csOrgPspId,
					dOrgDstTxnAmt+dPrecalFee,
					cParty,
					iDayOfWeek);
	}


	if(cParty!=PD_TYPE_PSP){
		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csOrgMerchantId,csOrgTxnCcy,csOrgTxnCountry,csOrgServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"current_bal",&dTmp)){
				PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOBalance: current_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOBalance: total_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"settlement_in_transit",&dTmp)){
				PutField_Double(hContext,"settlement_in_transit",dTmp);
DEBUGLOG(("BOBalance: settlement_in_transit= [%f]\n",dTmp));
			}
		}

		FREE_ME(hVal);

		if(cParty==PD_TYPE_MERCHANT)
			FREE_ME(csOrgPspId);
	}

	return iRet;

}


int PayoutSuccess(const char* csCountry, 
			const char* csServiceCode,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dMerchantAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			char   cParty,
			const int iDayOfWeek)
{
	int iRet = PD_OK;

DEBUGLOG(("BOBalance:PayoutSuccess()\n"));
DEBUGLOG(("BOBalance:PayoutSuccess() merchant = [%lf], psp = [%lf]\n",dMerchantAmount,dPspAmount));


	if (cParty==PD_TYPE_MERCHANT || cParty==PD_TYPE_GLOBAL) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateAvalBal");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				-dMerchantAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBMerchantBalance::UpdateAvalBal()  Failed\n"));
		}

		DBObjPtr = CreateObj(DBPtr,"DBMerchantReservedAmt","UpdateReserved");
		if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				iDayOfWeek,
				-dMerchantAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBMerchantReservedAmt::UpdateReserved()  Failed\n"));
                }

	}


	if (cParty==PD_TYPE_PSP || cParty==PD_TYPE_GLOBAL) {
DEBUGLOG(("BOBalance:PayoutSuccess DebitPSP AvalBalance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				PD_PSP_BAL,
				dPspAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBPspBalance::DebitBalance() Failed\n"));
		}
	}


DEBUGLOG(("BOBalance:PayoutSuccess() iRet = [%d]\n",iRet));
	return iRet;
}



int PayoutVoided(const char* csCountry, 
		const char* csServiceCode,
		const char* csMerchantCCY, 
		const char* csMerchantID,
		double dMerchantAmount,
		const char* csPspCCY,
		const char* csPspID,
		double dPspAmount,
		char   cParty,
		const int iDayOfWeek)
{
	int iRet = PD_OK;

DEBUGLOG(("BOBalance:PayoutVoided()\n"));
DEBUGLOG(("BOBalance:PayoutVoided() merchant = [%lf], psp = [%lf]\n",dMerchantAmount,dPspAmount));


	if (cParty==PD_TYPE_MERCHANT || cParty==PD_TYPE_GLOBAL) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateAvalBal");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dMerchantAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBMerchantBalance::VoidPayout() Failed\n"));
		}

		DBObjPtr = CreateObj(DBPtr,"DBMerchantReservedAmt","UpdateReserved");
		if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				iDayOfWeek,
				dMerchantAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBMerchantReservedAmt::UpdateReserved()  Failed\n"));
                }
	}


	if (cParty==PD_TYPE_PSP || cParty==PD_TYPE_GLOBAL) {
DEBUGLOG(("BOBalance:PayoutVoided CreditPSP AvalBalance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","CreditBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				PD_PSP_BAL,
				dPspAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBPspBalance::CreditBalance() Failed\n"));
		}
	}

DEBUGLOG(("BOBalance:PayoutVoided() iRet = [%d]\n",iRet));
	return iRet;
}


int ProcessHold(const char *csTxnCountry,
		const char *csServiceCode,
		const char *csTxnCcy,
		const char *csMerchantId,
		char  cHoldUnholdInd,
		const char *csHoldType,
		double dHoldAmt)
{
	int iRet = PD_OK;

	char csCheckHoldType[PD_HOLD_TYPE_LEN+1];
	double dPayoutBal=0;
	double dMinPayoutBal=0;
	double dSettleBal=0;
	double dPayoutHold=0;
	double dSettleHold=0;
	double dHoldRemain;
	double dTmp;
	int i = 0;

	hash_t *hVal;
	hash_t *hTxn;

	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

DEBUGLOG(("BOBalance: ProcessHold: HoldType[%s] HoldAmt[%f]\n",csHoldType,dHoldAmt));

/////hold values from MerchantBalance/////

DEBUGLOG(("BOBalance: ProcessHold: DBMerchantBalance->GetCurrentValues\n"));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
	if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){
		if(GetField_Double(hVal,"payout_bal",&dTmp)){
			
/*TODO: Get the minimum payout balance value*/

			dPayoutBal = dTmp - dMinPayoutBal;
DEBUGLOG(("BOBalance: payout_bal= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"settlement_bal",&dSettleBal)){
DEBUGLOG(("BOBalance: settlement_bal= [%f]\n",dSettleBal));
		}
		if(GetField_Double(hVal,"total_settlement_hold",&dSettleHold)){
DEBUGLOG(("BOBalance: total_settlement_hold= [%f]\n",dSettleHold));
		}
	}

	if(cHoldUnholdInd==PD_PROCESS_HOLD){
		dHoldRemain = dHoldAmt;
		strcpy(csCheckHoldType,csHoldType);
		csCheckHoldType[PD_HOLD_TYPE_LEN]='\0';

		do{
			i ++;
			if(!strcmp(csCheckHoldType,PD_HOLD_SETTLEMENT)){
				if(dSettleBal>=dHoldRemain){
					dSettleHold += dHoldRemain;
					dSettleBal -= dHoldRemain;
					dHoldRemain = 0;
				}
				else{
					dHoldRemain -= dSettleBal;
					dSettleHold += dSettleBal;
					dSettleBal = 0;
				}
DEBUGLOG(("BOBalance: New Settlement Balance[%f] Settlement Hold[%f] Remain Hold[%f]\n",dSettleBal,dSettleHold,dHoldRemain));

///////Update Hold Amount Table
				DBObjPtr = CreateObj(DBPtr,"DBHoldAmount","UpdateHoldAmount");
				if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCountry,
								csTxnCcy,csServiceCode,
								csCheckHoldType,dSettleHold,PD_UPDATE_USER)!=PD_OK){
					iRet = PD_ERR;
				}

				strcpy(csCheckHoldType,PD_HOLD_PAYOUT);

			}
			else if(!strcmp(csCheckHoldType,PD_HOLD_PAYOUT)){
			if(dPayoutBal>=dHoldRemain){
				dPayoutHold += dHoldRemain;
				dPayoutBal -= dHoldRemain;
				dHoldRemain = 0;
				}
				else{
					dHoldRemain -= dPayoutBal;
					dPayoutHold += dPayoutBal;
					dPayoutBal = 0;
					strcpy(csCheckHoldType,PD_HOLD_SETTLEMENT);
				}
DEBUGLOG(("BOBalance: New Payout Balance[%f] Payout Hold[%f] Remain Hold[%f]\n",dPayoutBal+dMinPayoutBal,dPayoutHold,dHoldRemain));

///////Update Hold Amount Table
				DBObjPtr = CreateObj(DBPtr,"DBHoldAmount","UpdateHoldAmount");
				if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCountry,
								csTxnCcy,csServiceCode,
								csCheckHoldType,dPayoutHold,PD_UPDATE_USER)!=PD_OK){
					iRet = PD_ERR;
				}

				strcpy(csCheckHoldType,PD_HOLD_SETTLEMENT);

			}
			else{
DEBUGLOG(("BOBalance: Invalid Hold Type\n"));
				iRet = PD_ERR;
			}

			if((i>=2)||(dHoldRemain==0)){
				break;
			}

		}while(PD_TRUE);
	}
	else if(cHoldUnholdInd==PD_PROCESS_UNHOLD){
		dSettleBal += dHoldAmt;
DEBUGLOG(("BOBalance: New Settlement Balance[%f]\n",dSettleBal));

///////Update Hold Amount Table
		DBObjPtr = CreateObj(DBPtr,"DBHoldAmount","UpdateUnHoldAmount");
		if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCountry,
						csTxnCcy,csServiceCode,
						csHoldType,dHoldAmt,PD_UPDATE_USER)!=PD_OK){
			iRet = PD_ERR;
		}

	}	


	if(iRet==PD_OK){
///////Update MerchantBalance Table
		hTxn = (hash_t*) malloc (sizeof(hash_t));
                hash_init(hTxn,0);

		PutField_CString(hTxn,"merchant_id",csMerchantId);
		PutField_CString(hTxn,"country_id",csTxnCountry);
		PutField_CString(hTxn,"ccy_id",csTxnCcy);
		PutField_CString(hTxn,"service_code",csServiceCode);
		PutField_Double(hTxn,"payout_bal",dPayoutBal+dMinPayoutBal);
		PutField_Double(hTxn,"payout_hold",dPayoutHold);
		PutField_Double(hTxn,"settlement_bal",dSettleBal);
		PutField_Double(hTxn,"settlement_hold",dSettleHold);
		PutField_CString(hTxn,"update_user",PD_UPDATE_USER);

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateBalanceAndHold");
		if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
			iRet = PD_ERR;
DEBUGLOG(("BOBalance: DBMerchantBalance::UpdateBalanceAndHold Error\n"));
		}

		FREE_ME(hTxn);
	}

	FREE_ME(hVal);	
	return iRet;
}



int DebitDepositAmount(const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dMerchantAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee) 
{
	int iRet = PD_OK;

DEBUGLOG(("BOBalance:DebitDepositAmount()\n"));
DEBUGLOG(("BOBalance:DebitDepositAmount() merchant = [%lf], psp = [%lf], res = [%lf]\n",dMerchantAmount,dPspAmount,dReserveAmount));

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBucket","CreditMerchantAmount");
        if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			csPspID,
			PD_BUCKET_TYPE_FLOAT,
			- dMerchantAmount + dReserveAmount,
			PD_UPDATE_USER) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() CreditMerchantAmount [Float]Failed\n"));
	}

	if (iRet == PD_OK && dReserveAmount > 0) {
 	       if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			csPspID,
			PD_BUCKET_TYPE_RESERVED,
			- dReserveAmount,
			PD_UPDATE_USER) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() CreditMerchantAmount [Reserved]Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:DebitDepositAmount UpdateFloat\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateFloat");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				- dMerchantAmount + dReserveAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() UpdateFloat Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:DebitDepositAmount UpdateReserved\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateReserved");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				-dReserveAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() UpdateFloat Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:DebitDepositAmount DebitPSP Balance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				PD_PSP_FLOAT,
				dPspAmount - dPspFee,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() UpdateFloat Failed\n"));
		}
	}

DEBUGLOG(("BOBalance:DebitDepositAmount() iRet = [%d]\n",iRet));
	return iRet;
}

int UpdateSettlementAmount(hash_t *hContext)
{
	int	iRet = PD_OK;
	char	*csTxnCode;
	char	*csOrgTxnSeq;
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgServiceCode;
	double	dOrgNetAmt;
	double	dFee=0.0;
	double	dTmp;
	//char	cTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:UpdateSettlementAmount()\n"));

//txn code 
	if (GetField_CString(hContext,"txn_code",&csTxnCode)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_code = [%s]\n",csTxnCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_code is missing!!!\n"));
	}
//org txn seq 
	if (GetField_CString(hContext,"txn_seq",&csOrgTxnSeq)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_seq = [%s]\n",csOrgTxnSeq));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_seq is missing!!!\n"));
	}

//org txn country 
	if (GetField_CString(hContext,"txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_country is missing!!!\n"));
	}

///org txn ccy 
	if (GetField_CString(hContext,"request_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
		if (GetField_CString(hContext,"txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_ccy = [%s]\n",csOrgTxnCcy));
		}
		else{
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_ccy is missing!!!\n"));
		}
	}
///org service Code 
	if (GetField_CString(hContext,"service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() service_code is missing!!!\n"));
	}

///org merchant id 
	if (GetField_CString(hContext,"merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() merchant_id is missing!!!\n"));
	}


///org net amount //
	if (GetField_Double(hContext,"net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() net_amt = [%lf]\n",dOrgNetAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() net_amt is missing!!!\n"));
	}

///fee//
	if (GetField_Double(hContext,"src_txn_fee",&dFee)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() fee = [%lf]\n",dFee));
	}

DEBUGLOG(("BOBalance:UpdateSettlementAmount() Update Avi Settlement Balance\n"));

	if(!strcmp(csTxnCode,PD_SETTLEMENT_REQUEST)){
		iRet = PD_OK;
	}

	else if(!strcmp(csTxnCode,PD_SETTLEMENT_CANCEL)){
		iRet = PD_OK;
	}

	else if(!strcmp(csTxnCode,PD_SETTLEMENT_APPROVAL)){
DEBUGLOG(("BOBalance:UpdateSettlementAmount() Call DBMerchantBalance:Settlement2InTransit[%c]\n",PD_S2I));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","Settlement2InTransit");
		iRet = (unsigned long)(*DBObjPtr)(csOrgMerchantId,
						csOrgTxnCountry,
						csOrgTxnCcy,
						csOrgServiceCode,
						dOrgNetAmt,
						dFee,
						PD_S2I,
						PD_UPDATE_USER); 

	}

	else if(!strcmp(csTxnCode,PD_SETTLEMENT_DELIVERY)){
DEBUGLOG(("BOBalance:UpdateSettlementAmount() Call DBMerchantBalance:UpdateIntransit\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateIntransit");
			iRet = (unsigned long)(*DBObjPtr)(csOrgMerchantId,
                                                csOrgTxnCountry,
                                                csOrgTxnCcy,
                                                csOrgServiceCode,
                                                (dOrgNetAmt)*(-1),
                                                PD_UPDATE_USER);

	}


	else {
DEBUGLOG(("BOBalance:None Settlement txn\n"));
		return iRet;
	}

	//if(iRet==PD_OK){

		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csOrgMerchantId,csOrgTxnCcy,csOrgTxnCountry,csOrgServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"current_bal",&dTmp)){
				PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOBalance: current_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOBalance: total_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"settlement_in_transit",&dTmp)){
				PutField_Double(hContext,"settlement_in_transit",dTmp);
DEBUGLOG(("BOBalance: settlement_in_transit= [%f]\n",dTmp));
			}
		}

		FREE_ME(hVal);
	//}
	
DEBUGLOG(("BOBalance iRet=[%d]\n",iRet));
	return iRet;
}

int GetAvalBalanceForUpdate(const char* csTxnCountry,
                        const char* csTxnCcy,
                        const char* csService,
                        const char* csMerchantId,
                        double  *dBalance)
{
	int	iRet = PD_OK;
DEBUGLOG(("BOBalance:GetBalanceForUpdate()\n"));

DEBUGLOG(("BOBalance:GetBalanceForUpdate() mid=[%s]\n",csMerchantId));
DEBUGLOG(("BOBalance:GetBalanceForUpdate() txn_ccy=[%s]\n",csTxnCcy));
DEBUGLOG(("BOBalance:GetBalanceForUpdate() txn_country=[%s]\n",csTxnCountry));
DEBUGLOG(("BOBalance:GetBalanceForUpdate() service=[%s]\n",csService));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetAvalBalance");
        if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csService,dBalance)==PD_OK){
DEBUGLOG(("Balance = [%lf]\n",*dBalance));
        }
        else{
DEBUGLOG(("BOBalance:GetBalanceForUpdate()  balance for [%s] [%s] [%s] not found\n",csMerchantId,csTxnCcy,csService));
ERRLOG("BOBalance:GetBalanceForUpdate()  balance for [%s] [%s] [%s] not found\n",csMerchantId,csTxnCcy,csService);
		*dBalance = 0.0;
        }
	

	return iRet;
}

int GetAvalPayoutBalance(hash_t *hContext, 
			const hash_t *hRequest, 
			double *dActualBalance, 
			double *dAvalBalance)
{
	int	iRet = PD_OK;
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgServiceCode;
	double	dReservedAmt=0;
	double	dBal=0;
	double	dFeeRate=0;
	int	iDayOfWeek;
	
//org txn country 
	if (GetField_CString(hContext,"txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() txn_country is missing!!!\n"));
	}

///org txn ccy 
	if (GetField_CString(hContext,"txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else{
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() txn_ccy is missing!!!\n"));
	}
///org service Code 
	if (GetField_CString(hContext,"service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() service_code is missing!!!\n"));
	}

///org merchant id 
	if (GetField_CString(hContext,"merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() merchant_id is missing!!!\n"));
	}

///day of week
	if (GetField_Int(hContext,"day_of_week",&iDayOfWeek)) {	
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() day_of_week = [%d]\n",iDayOfWeek));
	}
	else {
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() day_of_week is missing!!!\n"));
	}

///approximate_fee_rate
	if (GetField_Double(hContext,"approximate_fee_rate",&dFeeRate)) {	
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() approximate_fee_rate = [%lf]\n",dFeeRate));
	}
	else {
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() approximate_fee_rate is missing!!!\n"));
	}


	if(iRet ==PD_OK){
DEBUGLOG(("BOBalance::Call DBMerchantReservedAmt:GetReservedAmt\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchantReservedAmt","GetReservedAmt");
                if((unsigned long)(*DBObjPtr)(csOrgMerchantId,
                                                csOrgTxnCountry,
                                                csOrgTxnCcy,
                                                csOrgServiceCode,
                                                iDayOfWeek,
                                                &dReservedAmt)==PD_OK){
DEBUGLOG(("GetReservedAmt reserved_amt =[%lf]\n",dReservedAmt));
                        *dActualBalance = dReservedAmt;
                }
                else{
DEBUGLOG(("GetReservedAmt Error\n"));
ERRLOG("BOBalance:GetAvalPayoutBalance::GetReservedAmt Error!!\n");
                        *dActualBalance = 0.0;
                        *dAvalBalance= 0.0;
			iRet = PD_ERR;
                }
	}

	if(iRet ==PD_OK){
DEBUGLOG(("BOBalance::Call DBMerchantBalance:GetAvalBalance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetAvalBalance");
        	if((unsigned long)(*DBObjPtr)(csOrgMerchantId,
					csOrgTxnCcy,
					csOrgTxnCountry,
					csOrgServiceCode,
					&dBal)==PD_OK){
DEBUGLOG(("GetAvalBalance balance = [%lf]\n",dBal));
			if(dBal<*dActualBalance){
                                *dActualBalance = dBal;
				PutField_Int(hContext,"merchant_balance",PD_TRUE);
                        }
			else
				PutField_Int(hContext,"reserved_amount",PD_TRUE);
        	}
        	else{
DEBUGLOG(("BOBalance:GetAvalPayoutBalance()  balance for [%s] [%s] [%s] not found\n",csOrgMerchantId,csOrgTxnCcy,csOrgServiceCode));
ERRLOG("BOBalance:GetAvalPayoutBalance()  balance for [%s] [%s] [%s] not found\n",csOrgMerchantId,csOrgTxnCcy,csOrgServiceCode);
			*dActualBalance = 0.0;
			*dAvalBalance= 0.0;
			iRet = PD_ERR;
        	}
	}

	if(iRet==PD_OK){
			*dAvalBalance = (*dActualBalance)/(1 + (dFeeRate/100));
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() Aval balance = [%lf]\n",*dAvalBalance));
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() Actual balance = [%lf]\n",*dActualBalance));
	}

	
	return iRet;
}

int UpdatetMerchantAvalAmt(const char* csCountry,
                        const char* csServiceCode,
                        const char* csMerchantCCY,
                        const char* csMerchantID,
                        double dTxnAmt)
{
	int	iRet = PD_OK;
	
DEBUGLOG(("BOBalance:UpdatetMerchantAvalAmt Amount to be updated = [%lf]\n",dTxnAmt));
        if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:UpdatetMerchantAvalAmt: UpdateAvalBal\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateAvalBal");
                if ((*DBObjPtr)(csMerchantID,
                                csCountry,
                                csMerchantCCY,
                                csServiceCode,
                                dTxnAmt,
                                PD_UPDATE_USER) != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("BOBalance:UpdatetMerchantAvalAmt() UpdateAvalBal Failed\n"));
                }
        }

	return iRet;
}


int DebitMerchantAvalAmount(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csTxnCountry;
	char	*csTxnCcy;
	char	*csMerchantId;
	char	*csServiceCode;
	double	dNetAmt;
	double	dTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:DebitMerchantAvalAmount()\n"));

/*txn country */
	if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {	
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() txn_country = [%s]\n",csTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() txn_country is missing!!!\n"));
	}

/*txn ccy */
	if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {	
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() txn_ccy = [%s]\n",csTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() txn_ccy is missing!!!\n"));
	}
/*service Code */
	if (GetField_CString(hContext,"service_code",&csServiceCode)) {	
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() service_code = [%s]\n",csServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() service_code is missing!!!\n"));
	}

/*merchant id */
	if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {	
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() merchant_id = [%s]\n",csMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() merchant_id is missing!!!\n"));
	}


/* net amount */
	if (GetField_Double(hContext,"net_amt",&dNetAmt)) {	
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() net_amt = [%lf]\n",dNetAmt));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() net_amt is missing!!!\n"));
	}



DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() Update merchant aval balance \n"));
	iRet = UpdatetMerchantAvalAmt( csTxnCountry,
				csServiceCode,
				csTxnCcy,
				csMerchantId,
				dNetAmt * (-1));
		
	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
	if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){
		if(GetField_Double(hVal,"current_bal",&dTmp)){
			PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOBalance: current_bal= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_float",&dTmp)){
			PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
			PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_hold",&dTmp)){
			PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOBalance: total_hold= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"settlement_in_transit",&dTmp)){
			PutField_Double(hContext,"settlement_in_transit",dTmp);
DEBUGLOG(("BOBalance: settlement_in_transit= [%f]\n",dTmp));
		}
	}
	FREE_ME(hVal);
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount()  exit = [%d]\n",iRet));
	
	return iRet;
}

int CreditMerchantAvalAmount(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csTxnCountry;
	char	*csTxnCcy;
	char	*csMerchantId;
	char	*csServiceCode;
	double	dNetAmt;
	double	dTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:CreditMerchantAvalAmount()\n"));

/* txn country */
	if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {	
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() txn_country = [%s]\n",csTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() txn_country is missing!!!\n"));
	}

/*txn ccy */
	if (GetField_CString(hContext,"bal_ccy",&csTxnCcy)) {	
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() txn_ccy = [%s]\n",csTxnCcy));
	}
	else if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {	
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() txn_ccy = [%s]\n",csTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() txn_ccy is missing!!!\n"));
	}
/*service Code */
	if (GetField_CString(hContext,"service_code",&csServiceCode)) {	
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() service_code = [%s]\n",csServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() service_code is missing!!!\n"));
	}

/*merchant id */
	if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {	
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() merchant_id = [%s]\n",csMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() merchant_id is missing!!!\n"));
	}


/*net amount */
	if (GetField_Double(hContext,"net_amt",&dNetAmt)) {	
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() net_amt = [%lf]\n",dNetAmt));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() net_amt is missing!!!\n"));
	}



DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() Update merchant aval balance \n"));
	iRet = UpdatetMerchantAvalAmt( csTxnCountry,
				csServiceCode,
				csTxnCcy,
				csMerchantId,
				dNetAmt);
		
	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
	if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){
		if(GetField_Double(hVal,"current_bal",&dTmp)){
			PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOBalance: current_bal= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_float",&dTmp)){
			PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
			PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_hold",&dTmp)){
			PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOBalance: total_hold= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"settlement_in_transit",&dTmp)){
			PutField_Double(hContext,"settlement_in_transit",dTmp);
DEBUGLOG(("BOBalance: settlement_in_transit= [%f]\n",dTmp));
		}
	}
	FREE_ME(hVal);
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount()  exit = [%d]\n",iRet));
	
	return iRet;
}



int TransferPspBalance(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgPspId;
	char	cTmp;
	double	dAmt;
	double	dPspFee = 0;
	double	dTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:TransferPspBalance()\n"));

/*txn country */
	if (GetField_CString(hContext,"txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:TransferPspBalance() txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:TransferPspBalance() txn_country is missing!!!\n"));
	}

/*txn ccy */
	if (GetField_CString(hContext,"txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:TransferPspBalance() txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:TransferPspBalance() txn_ccy is missing!!!\n"));
	}

/*psp id */
	if (GetField_CString(hContext,"psp_id",&csOrgPspId)) {	
DEBUGLOG(("BOBalance:TransferPspBalance() psp_id = [%s]\n",csOrgPspId));
	}
	else {
DEBUGLOG(("BOBalance:TransferPspBalance() psp_id is missing!!!\n"));
	}

/*net amount */
	if (GetField_Double(hContext,"txn_amt",&dAmt)) {	
DEBUGLOG(("BOBalance:TransferPspBalance() txn_amt = [%lf]\n",dAmt));
	}
	else {
DEBUGLOG(("BOBalance:TransferPspBalance() txn_amt is missing!!!\n"));
	}

/* psp_fee */
	if (GetField_Double(hContext,"service_fee",&dPspFee)) {	
DEBUGLOG(("BOBalance:TransferPspBalance() service_fee = [%lf]\n",dPspFee));
	}
	else {
DEBUGLOG(("BOBalance:TransferPspBalance() service_fee is missing!!!\n"));
	}

/* transfer from */
	if(GetField_Char(hContext,"transfer_from",&cTmp)){
DEBUGLOG(("BOBalance:TransferPspBalance() transfer_from = [%c]\n",cTmp));
	}
	else {
DEBUGLOG(("BOBalance:TransferPspBalance() transfer_from is missing!!!\n"));
	}


	DBObjPtr = CreateObj(DBPtr,"DBPspBalance","TransferBalance");
	if((unsigned long)(*DBObjPtr)(csOrgPspId,
				      csOrgTxnCountry,
				      csOrgTxnCcy,
				      dAmt-dPspFee,
				      cTmp,
				      PD_UPDATE_USER)!=PD_OK){
DEBUGLOG(("BOBalance:TransferPspBalance() Failed\n"));
		iRet = INT_ERR;
	}
	
	if(iRet==PD_OK){

		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalance");
		if((unsigned long)(*DBObjPtr)(csOrgPspId,csOrgTxnCountry,csOrgTxnCcy,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"balance",&dTmp)){
				PutField_Double(hContext,"psp_balance",dTmp);
DEBUGLOG(("BOBalance:psp_balance = [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"psp_total_float",dTmp);
DEBUGLOG(("BOBalance:psp_total_float = [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"psp_total_hold",dTmp);
DEBUGLOG(("BOBalance:psp_total_hold = [%f]\n",dTmp));
			}
		}

		FREE_ME(hVal);
	}
	
	return iRet;
}
