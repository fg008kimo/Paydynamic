/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/04/14              Cody Chan
Add ProcessHold					   2011/12/13		   LokMan Chow
Add GetAvalPspBalanceForUpdate			   2011/12/15	           Virginia Yun	
Add Txn Elements				   2012/02/02		   Cody Chan
Void before/after recon, debit float/bal	   2012/07/26		   LokMan Chow 
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOBalance.h"

char    cDebug;
OBJPTR(DB);
OBJPTR(BO);

void BOBalance(char    cdebug)
{
        cDebug = cdebug;
}
int UpdateMerchantAvalAmt(hash_t* hContext,
			const char* csCountry,
                        const char* csServiceCode,
                        const char* csMerchantCCY,
                        const char* csMerchantID,
			double dNetAmt);

int CreditDepositAmount(hash_t *hContext,
			const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode, 
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dNetAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee);

int DebitDepositAmount(hash_t* hContext,
			const char* csPostingDate,
                       const char* csCountry,
		       const char* csServiceCode,
		       const char* csMerchantCCY,
		       const char* csMerchantID,
		       double dNetAmount,
		       const char* csPspCCY,
		       const char* csPspID,
		       double dPspAmount,
		       double dReserveAmount,
		       double dPspFee);

int PayoutVoided(hash_t* hContext,
		const char* csCountry, 
		const char* csServiceCode, 
		const char* csMerchantCCY, 
		const char* csMerchantID,
		double dNetAmount,
		const char* csPspCCY,
		const char* csPspID,
		double dPspAmount,
		char   cParty);
		//const int iDayOfWeek);

int PayoutSuccess(hash_t* hContext,
			const char* csCountry, 
			const char* csServiceCode, 
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dNetAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			char   cParty);
			//const int iDayOfWeek);

int GetAvalPspBalanceForUpdate(const char* csTxnCountry,
                        const char* csTxnCcy,
                        const char* csPspId,
                        double  *dBalance);

int UpdateTxnAmount(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csTxnCode;
	char	*csPostingDate;
	char	*csOrgTxnSeq;
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgDstCcy;
	char	*csOrgPspId;
	char	*csOrgServiceCode;
	//double	dOrgTxnAmt= 0.0;
	double	dOrgNetAmt= 0.0;
	double	dOrgDstTxnAmt= 0.0;
	double	dReserveAmt = 0.0;
	double	dPspFee = 0.0;
	double	dTmp= 0.0;
	int	iRecon = PD_FALSE;
	hash_t* hVal;


DEBUGLOG(("BOBalance:UpdateTxnAmount()\n"));
/*posting date*/
	if (GetField_CString(hContext,"PHDATE",&csPostingDate)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() posting_date = [%s]\n",csPostingDate));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() posting_date is missing!!!\n"));
	}
/*txn code */
	if (GetField_CString(hContext,"txn_code",&csTxnCode)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() txn_code = [%s]\n",csTxnCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() txn_code is missing!!!\n"));
	}
/*org txn seq */
	if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_seq = [%s]\n",csOrgTxnSeq));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_seq is missing!!!\n"));
	}

/*org txn country */
	if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_country is missing!!!\n"));
	}

/*org txn ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_ccy is missing!!!\n"));
	}
/*org service Code */
	if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_service_code is missing!!!\n"));
	}

/*org merchant id */
	if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_merchant_id is missing!!!\n"));
	}

/*org psp ccy */
	if (GetField_CString(hContext,"org_dst_txn_ccy",&csOrgDstCcy)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_dst_txn_ccy = [%s]\n",csOrgDstCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_dst_txn_ccy is missing!!!\n"));
	}


/*org psp id */
	if (GetField_CString(hContext,"org_psp_id",&csOrgPspId)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_psp_id = [%s]\n",csOrgPspId));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_psp_id is missing!!!\n"));
	}

/*org txn amount 
	if (GetField_Double(hContext,"org_txn_amt",&dOrgTxnAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_amt = [%lf]\n",dOrgTxnAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_amt is missing!!!\n"));
	}
*/

/*org net amount */
	if (GetField_Double(hContext,"net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() net_amt = [%lf]\n",dOrgNetAmt));
	}
	else {
		if (GetField_Double(hContext,"org_net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_net_amt = [%lf]\n",dOrgNetAmt));
		}
		else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_net_amt is missing!!!\n"));
		}
	}

/*org psp txn amount */
	if (GetField_Double(hContext,"org_dst_net_amt",&dOrgDstTxnAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_dst_net_amt = [%lf]\n",dOrgDstTxnAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_dst_net_amt is missing!!!\n"));
	}

/*reserved amt */
	if (GetField_Double(hContext,"reserve_amt",&dReserveAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() reserve_amt = [%lf]\n",dReserveAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() not reserve_amt\n"));
	}

/* psp_fee */
	if (GetField_Double(hContext,"precal_fee",&dPspFee)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() precal_fee = [%lf]\n",dPspFee));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() precal_fee not found, try to get from request\n"));
		if (GetField_Double(hRequest,"service_fee",&dPspFee)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() service_fee = [%lf]\n",dPspFee));
		}
		else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() service_fee is missing!!!\n"));
		}
	}

/* recon_ind */
	if(GetField_Int(hContext,"recon_ind",&iRecon)){
DEBUGLOG(("BOBalance:UpdateTxnAmount() recon_ind = [%d]\n",iRecon));
	}

	if (!strcmp(csTxnCode,PD_DEPOSIT_TXN_CODE) || 
            !strcmp(csTxnCode,PD_INITIAL_TXN_CODE)) {
DEBUGLOG(("BOBalance:UpdateTxnAmount() Update Deposit Txn\n"));
		iRet =CreditDepositAmount(hContext,
					csPostingDate,
					csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt,
					csOrgDstCcy,
					csOrgPspId,
					dOrgDstTxnAmt,
					dReserveAmt,
					dPspFee);
	}
	else if(!strcmp(csTxnCode,PD_VOID_TXN_CODE)){

DEBUGLOG(("BOBalance:UpdateTxnAmount() Update Deposit Txn (Void)\n"));
		iRet =DebitDepositAmount(hContext,
					csPostingDate,
                                        csOrgTxnCountry,
                                        csOrgServiceCode,
                                        csOrgTxnCcy,
                                        csOrgMerchantId,
					dOrgNetAmt,
                                        csOrgDstCcy,
                                        csOrgPspId,
                                        dOrgDstTxnAmt,
                                        dReserveAmt,
                                        dPspFee);
	}
	else {
DEBUGLOG(("BOBalance:None DSP txn\n"));
	}
	
	if(iRet==PD_OK){

		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csOrgMerchantId,csOrgTxnCcy,csOrgTxnCountry,csOrgServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"current_bal",&dTmp)){
				PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOBalance: current_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOBalance: total_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"current_bal_settlement",&dTmp)){
				PutField_Double(hContext,"current_bal_settlement",dTmp);
DEBUGLOG(("BOBalance: current_bal_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float_settlement",&dTmp)){
				PutField_Double(hContext,"total_float_settlement",dTmp);
DEBUGLOG(("BOBalance: total_float_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold_settlement",&dTmp)){
				PutField_Double(hContext,"total_hold_settlement",dTmp);
DEBUGLOG(("BOBalance: total_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"fundin_payout",&dTmp)){
				PutField_Double(hContext,"fundin_payout",dTmp);
DEBUGLOG(("BOBalance: fundin_payout= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"reserved_payout",&dTmp)){
				PutField_Double(hContext,"reserved_payout",dTmp);
DEBUGLOG(("BOBalance: reserved_payout= [%f]\n",dTmp));
			}

			if(GetField_Double(hVal,"total_float_after_payout",&dTmp)){
				PutField_Double(hContext,"total_float_after_payout",dTmp);
DEBUGLOG(("BOBalance: total_float_after_payout= [%f]\n",dTmp));
			}

		}
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalance");
		if((unsigned long)(*DBObjPtr)(csOrgPspId,csOrgTxnCountry,csOrgDstCcy,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"balance",&dTmp)){
				PutField_Double(hContext,"psp_balance",dTmp);
DEBUGLOG(("BOBalance:psp_balance = [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"psp_total_float",dTmp);
DEBUGLOG(("BOBalance:psp_total_float = [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"psp_total_hold",dTmp);
DEBUGLOG(("BOBalance:psp_total_hold = [%f]\n",dTmp));
			}
		}

		FREE_ME(hVal);
	}
	
	return iRet;
}

int CreditDepositAmount(hash_t* hContext,
			const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dNetAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee) 
{
	int iRet = PD_OK;

DEBUGLOG(("BOBalance:CreditDepositAmount()\n"));
DEBUGLOG(("BOBalance:CreditDepositAmount() merchant = [%lf], psp = [%lf], res = [%lf]\n",dNetAmount,dPspAmount,dReserveAmount));

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBucket","CreditMerchantAmount");
        if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			csPspID,
			PD_BUCKET_TYPE_FLOAT,
			dNetAmount - dReserveAmount,
			PD_UPDATE_USER) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() CreditMerchantAmount [Float]Failed\n"));
	}
	

	if (iRet == PD_OK && dReserveAmount > 0) {
 	       	if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			csPspID,
			PD_BUCKET_TYPE_RESERVED,
			dReserveAmount,
			PD_UPDATE_USER) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() CreditMerchantAmount [Reserved]Failed\n"));
		}
	}
/* lock opening balance */
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetOpenBalanceForUpdate");
        	if ((*DBObjPtr)(hContext,
				csMerchantID,
				csMerchantCCY,
				csCountry,
				csServiceCode) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() GetOpenBalanceForUpdate Failed\n"));
		}
	}
	
	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:CreditDepositAmount UpdateFloat\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateFloat");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dNetAmount,
				dReserveAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() UpdateFloat Failed\n"));
		}
/* update txn element for float Amount */
                if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:CreditDepositAmount() UpdateFloat Element\n"));
                        PutField_Double(hContext,"float_amt",dNetAmount - dReserveAmount);
                        BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddMerchantFloatAmtElement");
                        iRet = (unsigned long)(*BOObjPtr)(hContext);
                }
	}

	if (iRet == PD_OK) {
/* no need to update resreved amount anymore since update float has already handled it /
DEBUGLOG(("BOBalance:CreditDepositAmount UpdateReserved\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateReserved");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dReserveAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() UpdateReserved Failed\n"));
		}
*/
/* update txn element for Reserved Amount */
                if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:CreditDepositAmount() Update Reserve Element\n"));
                        PutField_Double(hContext,"reserve_amt",dReserveAmount);
			PutField_CString(hContext,"amount_type",PD_DR);
                        BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddReserveAmtElement");
                        iRet = (unsigned long)(*BOObjPtr)(hContext);
                }
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:CreditDepositAmount CreditPSP Balance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","CreditBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				PD_PSP_FLOAT,
				dPspAmount - dPspFee,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() UpdateFloat Failed\n"));
		}
	}

DEBUGLOG(("BOBalance:CreditDepositAmount() iRet = [%d]\n",iRet));
	return iRet;
}



int UpdatePayoutAmount(hash_t* hContext)
{
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgServiceCode;
	char	*csOrgDstCcy;
	char	*csOrgPspId;
	char	cRespMode;
	char	cParty;
	//double	dOrgTxnAmt=0.0;
	double	dOrgNetAmt=0.0;
	double	dOrgDstTxnAmt=0.0;
	double	dPrecalFee=0.0;
	double	dTmp;
	//int	iDayOfWeek=0;
	hash_t* hVal;

	int iRet = PD_OK;

/*org txn country */
	if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_country is missing!!!\n"));
	}

/*org txn ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_ccy is missing!!!\n"));
	}
/*org service code */
	if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_service_code is missing!!!\n"));
	}

/*org merchant id */
	if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_merchant_id is missing!!!\n"));
	}

/*org net amount
	if (GetField_Double(hContext,"txn_amt",&dOrgTxnAmt)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() txn_amt = [%lf]\n",dOrgTxnAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() txn_amt is missing!!!\n"));
	}
*/

/*org net amount */
	if (GetField_Double(hContext,"net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() net_amt = [%lf]\n",dOrgNetAmt));
	}
	else {
		if (GetField_Double(hContext,"org_net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_net_amt = [%lf]\n",dOrgNetAmt));
		}
		else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_net_amt is missing!!!\n"));
		}
	}

/*response_mode*/
	if (GetField_Char(hContext,"response_mode",&cRespMode)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() response_mode = [%c]\n",cRespMode));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() response_mode is missing!!!\n"));
	}
	
/*party_type*/
	if(GetField_Char(hContext,"party_type",&cParty)){
DEBUGLOG(("BOBalance:UpdatePayoutAmount() party_type = [%c]\n",cParty));
	}
	else{
		cParty = PD_TYPE_GLOBAL;
	}

/*org psp id */
	if (GetField_CString(hContext,"org_psp_id",&csOrgPspId)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_psp_id = [%s]\n",csOrgPspId));
	}
	else {
		if(cParty==PD_TYPE_MERCHANT){
			csOrgPspId = strdup("NA");
		}
		else{
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_psp_id is missing!!!\n"));
		}
	}

/*org psp ccy */
	if (GetField_CString(hContext,"org_psp_txn_ccy",&csOrgDstCcy)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_psp_txn_ccy = [%s]\n",csOrgDstCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_psp_txn_ccy is missing!!!\n"));
	}

/*org psp txn amount */
	if (GetField_Double(hContext,"org_dst_net_amt",&dOrgDstTxnAmt)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_dst_net_amt = [%lf]\n",dOrgDstTxnAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_dst_net_amt is missing!!!\n"));
	}

/*org psp precal fee*/
	if (GetField_Double(hContext,"precal_fee",&dPrecalFee)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() psp precal_fee = [%lf]\n",dPrecalFee));
	}

/*DayOfWeek*/
//	if (GetField_Int(hContext,"day_of_week",&iDayOfWeek)) {
//DEBUGLOG(("BOBalance:UpdatePayoutAmount() day_of_week = [%d]\n",iDayOfWeek));
//	}

	if(cRespMode==PD_ACCEPT){
		iRet = PayoutSuccess(hContext,
					csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt,
					csOrgDstCcy,
					csOrgPspId,
					dOrgDstTxnAmt+dPrecalFee,
					cParty);
					//iDayOfWeek);
	}
	else if(cRespMode==PD_REVERSED){
		iRet = PayoutVoided(hContext,
					csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt,
					csOrgDstCcy,
					csOrgPspId,
					dOrgDstTxnAmt+dPrecalFee,
					cParty);
					//iDayOfWeek);
	}


	if(cParty!=PD_TYPE_PSP){
		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csOrgMerchantId,csOrgTxnCcy,csOrgTxnCountry,csOrgServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"current_bal",&dTmp)){
				PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOBalance: current_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOBalance: total_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float_after_payout",&dTmp)){
				PutField_Double(hContext,"total_float_after_payout",dTmp);
DEBUGLOG(("BOBalance: total_float_after_payout= [%f]\n",dTmp));
			}

			if(GetField_Double(hVal,"current_bal_settlement",&dTmp)){
                                PutField_Double(hContext,"current_bal_settlement",dTmp);
DEBUGLOG(("BOBalance: current_bal_settlement= [%f]\n",dTmp));
                        }
                        if(GetField_Double(hVal,"total_float_settlement",&dTmp)){
                                PutField_Double(hContext,"total_float_settlement",dTmp);
DEBUGLOG(("BOBalance: total_float_settlement= [%f]\n",dTmp));
                        }
                        if(GetField_Double(hVal,"total_hold_settlement",&dTmp)){
                                PutField_Double(hContext,"total_hold_settlement",dTmp);
DEBUGLOG(("BOBalance: total_hold_settlement= [%f]\n",dTmp));
                        }
                        if(GetField_Double(hVal,"fundin_payout",&dTmp)){
                                PutField_Double(hContext,"fundin_payout",dTmp);
DEBUGLOG(("BOBalance: fundin_payout= [%f]\n",dTmp));
                        }
                        if(GetField_Double(hVal,"reserved_payout",&dTmp)){
                                PutField_Double(hContext,"reserved_payout",dTmp);
DEBUGLOG(("BOBalance: reserved_payout= [%f]\n",dTmp));
                        }
		}

		FREE_ME(hVal);

		if(cParty==PD_TYPE_MERCHANT)
			FREE_ME(csOrgPspId);
	}

	if(cParty!=PD_TYPE_MERCHANT){

                hVal = (hash_t*) malloc (sizeof(hash_t));
                hash_init(hVal,0);

                DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalance");
                if((unsigned long)(*DBObjPtr)(csOrgPspId,csOrgTxnCountry,csOrgDstCcy,hVal)!=PD_ERR){
                        if(GetField_Double(hVal,"balance",&dTmp)){
                                PutField_Double(hContext,"psp_balance",dTmp);
DEBUGLOG(("BOBalance:psp_balance = [%f]\n",dTmp));
                        }
                        if(GetField_Double(hVal,"total_float",&dTmp)){
                                PutField_Double(hContext,"psp_total_float",dTmp);
DEBUGLOG(("BOBalance:psp_total_float = [%f]\n",dTmp));
                        }
                        if(GetField_Double(hVal,"total_hold",&dTmp)){
                                PutField_Double(hContext,"psp_total_hold",dTmp);
DEBUGLOG(("BOBalance:psp_total_hold = [%f]\n",dTmp));
                        }
                }

                FREE_ME(hVal);
        }

	return iRet;

}


int PayoutSuccess(hash_t* hContext,
			const char* csCountry, 
			const char* csServiceCode,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dNetAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			char   cParty)
			//const int iDayOfWeek)
{
	int iRet = PD_OK;

DEBUGLOG(("BOBalance:PayoutSuccess()\n"));
DEBUGLOG(("BOBalance:PayoutSuccess() merchant = [%lf], psp = [%lf]\n",dNetAmount,dPspAmount));

/* lock opening balance */
	if (cParty!=PD_TYPE_PSP) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetOpenBalanceForUpdate");
        	if ((*DBObjPtr)(hContext,
				csMerchantID,
				csMerchantCCY,
				csCountry,
				csServiceCode) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:PayoutSuccess() GetOpenBalanceForUpdate Failed\n"));
		}
	}
	
	if (cParty==PD_TYPE_MERCHANT || cParty==PD_TYPE_GLOBAL) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateCurrBal");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				(-1)*dNetAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBMerchantBalance::UpdateCurrBal()  Failed\n"));
		}
	}

	if (cParty==PD_TYPE_PSP || cParty==PD_TYPE_GLOBAL) {
DEBUGLOG(("BOBalance:PayoutSuccess DebitPSP AvalBalance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				PD_PSP_BAL,
				dPspAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBPspBalance::DebitBalance() Failed\n"));
		}
	}


DEBUGLOG(("BOBalance:PayoutSuccess() iRet = [%d]\n",iRet));
	return iRet;
}



int PayoutVoided(hash_t* hContext,
		const char* csCountry, 
		const char* csServiceCode,
		const char* csMerchantCCY, 
		const char* csMerchantID,
		double dNetAmount,
		const char* csPspCCY,
		const char* csPspID,
		double dPspAmount,
		char   cParty)
		//const int iDayOfWeek)
{
	int iRet = PD_OK;
	char	*csPostingDate;

DEBUGLOG(("BOBalance:PayoutVoided()\n"));
DEBUGLOG(("BOBalance:PayoutVoided() merchant = [%lf], psp = [%lf]\n",dNetAmount,dPspAmount));

/* lock opening balance */
	if (cParty!=PD_TYPE_PSP) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetOpenBalanceForUpdate");
        	if ((*DBObjPtr)(hContext,
				csMerchantID,
				csMerchantCCY,
				csCountry,
				csServiceCode) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:PayoutVoided() GetOpenBalanceForUpdate Failed\n"));
		}
	}
	

	if (cParty==PD_TYPE_MERCHANT) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateCurrBal");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dNetAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBMerchantBalance::UpdateCurrBal() Failed\n"));
		}

	}

	if (cParty==PD_TYPE_GLOBAL) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateFloat");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dNetAmount,
				0.0,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBMerchantBalance::UpdateFloat() Failed\n"));
		}

		if(GetField_CString(hContext,"PHDATE",&csPostingDate)){
DEBUGLOG(("BOBalance::PayoutVoided() posting_date[%s]\n",csPostingDate));
		}

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBucket","CreditMerchantAmount");
		if ((*DBObjPtr)(csPostingDate,
				csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				csPspID,
				PD_BUCKET_TYPE_FLOAT,
				dNetAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:PayoutVoid() CreditMerchantAmount [Float]Failed\n"));
		}
	}

	if (cParty==PD_TYPE_PSP || cParty==PD_TYPE_GLOBAL) {
DEBUGLOG(("BOBalance:PayoutVoided CreditPSP AvalBalance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","CreditBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				PD_PSP_BAL,
				dPspAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBPspBalance::CreditBalance() Failed\n"));
		}
	}

DEBUGLOG(("BOBalance:PayoutVoided() iRet = [%d]\n",iRet));
	return iRet;
}


int ProcessHold(hash_t *hContext,
		const hash_t *hRequest)
{
	int iRet = PD_OK;

	char	*csTxnCcy;
	char	*csTxnCountry;
	char	*csPspId;
	char	*csMerchantId;
	char	*csServiceCode;
	char	*csUser;
	char	cType;
	char	cHold;
	char	cMHind;
	double	dAmt=0.0;
	double	dBal=0.0;
	double	dHold=0.0;
	double	dAval=0.0;
	double	dTmp=0.0;

	hash_t *hVal;
	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

/*party_type*/
	if(GetField_Char(hContext,"party_type",&cType)){
DEBUGLOG(("BOBalance:ProcessHold() party_type = [%c]\n",cType));
	}

/*hold_type*/
	if(GetField_Char(hContext,"hold_type",&cHold)){
DEBUGLOG(("BOBalance:ProcessHold() hold_type = [%c]\n",cHold));
	}

/*txn country */
	if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {	
DEBUGLOG(("BOBalance:ProcessHold() txn_country = [%s]\n",csTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:ProcessHold() txn_country is missing!!!\n"));
	}

/*txn ccy */
	if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {	
DEBUGLOG(("BOBalance:ProcessHold() txn_ccy = [%s]\n",csTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:ProcessHold() txn_ccy is missing!!!\n"));
	}
/*service code */
	if (GetField_CString(hContext,"service_code",&csServiceCode)) {	
DEBUGLOG(("BOBalance:ProcessHold() service_code = [%s]\n",csServiceCode));
	}

/*merchant id */
	if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {	
DEBUGLOG(("BOBalance:ProcessHold() merchant_id = [%s]\n",csMerchantId));
	}

/*psp id */
	if (GetField_CString(hContext,"psp_id",&csPspId)) {	
DEBUGLOG(("BOBalance:ProcessHold() psp_id = [%s]\n",csPspId));
	}

/*amount */
	if (GetField_Double(hContext,"txn_amt",&dAmt)) {	
DEBUGLOG(("BOBalance:ProcessHold() txn_amt = [%lf]\n",dAmt));
	}

/*update_user*/
	if (GetField_CString(hContext,"update_user",&csUser)) {	
DEBUGLOG(("BOBalance:ProcessHold() update_user = [%s]\n",csUser));
	}

/* mh_ind */ 
	if (GetField_Char(hContext, "mh_ind", &cMHind)) {
DEBUGLOG(("BOBalance:ProcessHold() mh_ind = [%c]\n",cMHind));
	}


	if(cType==PD_TYPE_MERCHANT){
//DEBUGLOG(("BOBalance: ProcessHold: DBMerchantBalance->GetCurrentValues\n"));
//		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
//		if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR)
//

DEBUGLOG(("BOBalance: ProcessHold: DBMerchantBalance->GetOpenBalanceForUpdate\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetOpenBalanceForUpdate");
		if((unsigned long)(*DBObjPtr)(hVal, csMerchantId,csTxnCcy,csTxnCountry,csServiceCode)!=PD_ERR) {

			if (cMHind == PD_TYPE_PAYOUT) {
				if(GetField_Double(hVal,"merchant_open_bal",&dBal)){
DEBUGLOG(("BOBalance: current_bal (P) = [%lf]\n",dBal));
				}
				if(GetField_Double(hVal,"total_hold",&dHold)){
DEBUGLOG(("BOBalance: total_hold (P) = [%lf]\n",dHold));
				}
				dAval=dBal-dHold;
			}
			else {
				if(GetField_Double(hVal,"merchant_open_bal_settlement",&dBal)){
DEBUGLOG(("BOBalance: current_bal (S) = [%lf]\n",dBal));
				}
				if(GetField_Double(hVal,"total_hold_settlement",&dHold)){
DEBUGLOG(("BOBalance: total_hold (S) = [%lf]\n",dHold));
				}
				dAval=dBal-dHold;
			}
		}
                else{
DEBUGLOG(("BOBalance: ProcessHold: DBMerchantBalance->GetOpenBalanceForUpdate Failed\n"));
ERRLOG("BOBalance: ProcessHold: DBMerchantBalance->GetOpenBalanceForUpdate Failed\n");
                        iRet=PD_ERR;
                }

		if (iRet == PD_OK) {
			if(GetField_Double(hVal,"merchant_open_bal",&dTmp)){
DEBUGLOG(("BOBalance: open_bal = [%f]\n",dTmp));
				PutField_Double(hContext, "open_bal", dTmp);
			}

			if(GetField_Double(hVal,"merchant_open_bal_settlement",&dTmp)){
DEBUGLOG(("BOBalance: open_bal_settlement = [%f]\n",dTmp));
				PutField_Double(hContext, "open_bal_settlement", dTmp);
			}
		}
	}
        else if(cType==PD_TYPE_PSP){
DEBUGLOG(("BOBalance: ProcessHold: DBPspBalance->GetBalance\n"));
                DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalanceForUpdate");
                if ((unsigned long)(*DBObjPtr)(csPspId,csTxnCountry,csTxnCcy,hVal)==PD_OK) {
                        if (GetField_Double(hVal,"balance",&dBal)) {
DEBUGLOG(("BOBalance::balance = [%f]\n",dBal));
                        }
                        if (GetField_Double(hVal,"total_hold",&dHold)) {
DEBUGLOG(("BOBalance::total_hold = [%f]\n",dHold));
                        }
                        dAval=dBal-dHold;
                }
                else{
DEBUGLOG(("BOBalance: ProcessHold: DBPspBalance->GetBalance Failed\n"));
ERRLOG("BOBalance: ProcessHold: DBPspBalance->GetBalance Failed\n");
                        iRet=INT_ERR;
                }
        }

	if(iRet==PD_OK){
                if(cHold==PD_HOLD){
			 if(dAval<dAmt){
DEBUGLOG(("BOBalance: ProcessHold: Hold Amount[%lf] > Balance[%lf]\n",dAmt,dAval));
ERRLOG("BOBalance: ProcessHold: Hold Amount[%lf] > Balance[%lf]\n",dAmt,dAval);
				iRet = INT_INVALID_PAY_AMOUNT;
			}
		}
		else if(cHold==PD_UNHOLD){
			if(dHold<dAmt){
DEBUGLOG(("BOBalance: ProcessHold: Original Hold[%lf] < Unhold Amt[%lf]\n",dHold,dAmt));
ERRLOG("BOBalance: ProcessHold: Original Hold[%lf] < Unhold Amt[%lf]\n",dHold,dAmt);
				iRet = INT_INVALID_PAY_AMOUNT;
			}
		}
	}

	if(iRet==PD_OK){
		if(cType==PD_TYPE_MERCHANT){
DEBUGLOG(("BOBalance: ProcessHold: DBMerchantBalance->HoldBalance\n"));
                	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateHoldBalance");
                	iRet = (unsigned long)(*DBObjPtr)(csMerchantId,
							  csTxnCountry,
							  csTxnCcy,
							  csServiceCode,
							  cMHind,
							  cHold,
							  dAmt,
							  csUser);

			if(iRet==PD_OK){
				hash_init(hVal,0);
				DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
				if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){
					if(GetField_Double(hVal,"current_bal",&dTmp)){
						PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOBalance: current_bal= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_float",&dTmp)){
						PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"current_bal_settlement",&dTmp)){
						PutField_Double(hContext,"current_bal_settlement",dTmp);
DEBUGLOG(("BOBalance: current_bal_settlement= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_float_settlement",&dTmp)){
						PutField_Double(hContext,"total_float_settlement",dTmp);
DEBUGLOG(("BOBalance: total_float_settlement= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
						PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_hold",&dTmp)){
						PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOBalance: total_hold= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_hold_settlement",&dTmp)){
						PutField_Double(hContext,"total_hold_settlement",dTmp);
DEBUGLOG(("BOBalance: total_hold_settlement= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_float_after_payout",&dTmp)){
						PutField_Double(hContext,"total_float_after_payout",dTmp);
DEBUGLOG(("BOBalance: total_float_after_payout= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"fundin_payout",&dTmp)){
						PutField_Double(hContext,"fundin_payout",dTmp);
DEBUGLOG(("BOBalance: fundin_payout= [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"reserved_payout",&dTmp)){
						PutField_Double(hContext,"reserved_payout",dTmp);
DEBUGLOG(("BOBalance: reserved_payout= [%f]\n",dTmp));
					}
				}
			}


		}
		else if(cType==PD_TYPE_PSP){
			hash_init(hVal,0);
DEBUGLOG(("BOBalance: ProcessHold: DBPspBalance->HoldBalance\n"));
                	DBObjPtr = CreateObj(DBPtr,"DBPspBalance","UpdateHoldBalance");
                	iRet = (unsigned long)(*DBObjPtr)(csPspId,
							  csTxnCountry,
							  csTxnCcy,
							  cHold,
							  dAmt,
							  csUser);

			if(iRet==PD_OK){
				DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalance");
				if((unsigned long)(*DBObjPtr)(csPspId,csTxnCountry,csTxnCcy,hVal)!=PD_ERR){
					if(GetField_Double(hVal,"balance",&dTmp)){
						PutField_Double(hContext,"bal",dTmp);
DEBUGLOG(("BOBalance:psp_balance = [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_float",&dTmp)){
						PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance:psp_total_float = [%f]\n",dTmp));
					}
					if(GetField_Double(hVal,"total_hold",&dTmp)){
						PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOBalance:psp_total_hold = [%f]\n",dTmp));
					}
				}
			}
		}
	}
	FREE_ME(hVal);


	if(iRet==PD_OK){
		if(cHold==PD_HOLD){
			PutField_CString(hContext, "amount_type", PD_DR);
		} else {
			PutField_CString(hContext, "amount_type", PD_CR);
		}

DEBUGLOG(("BOBalance:ProcessHold() AddHold Element\n"));
		BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddHoldAmtElement");
		iRet = (unsigned long)(*BOObjPtr)(hContext);
	}

	return iRet;
}



int DebitDepositAmount(hash_t* hContext,
			const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dNetAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee) 
{
	int iRet = PD_OK;
	int iRecon = PD_FALSE;
	double dAvaBalance = 0.0;

DEBUGLOG(("BOBalance:DebitDepositAmount()\n"));
DEBUGLOG(("BOBalance:DebitDepositAmount() merchant = [%lf], psp = [%lf], res = [%lf]\n",dNetAmount,dPspAmount,dReserveAmount));

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBucket","CreditMerchantAmount");
        if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			csPspID,
			PD_BUCKET_TYPE_FLOAT,
			- dNetAmount + dReserveAmount,
			PD_UPDATE_USER) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() CreditMerchantAmount [Float]Failed\n"));
	}

	if (iRet == PD_OK && dReserveAmount > 0) {
 	       if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			csPspID,
			PD_BUCKET_TYPE_RESERVED,
			(-1)*dReserveAmount,
			PD_UPDATE_USER) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() CreditMerchantAmount [Reserved]Failed\n"));
		}
	}

/* lock opening balance */
        if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetOpenBalanceForUpdate");
                if ((*DBObjPtr)(hContext,
                                csMerchantID,
                                csMerchantCCY,
                                csCountry,
                                csServiceCode) != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() GetOpenBalanceForUpdate Failed\n"));
                }
        }

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:DebitDepositAmount UpdateFloat\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateFloat");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				(-1)*dNetAmount,
				(-1)*dReserveAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() UpdateFloat Failed\n"));
		}
	}
/*
	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:DebitDepositAmount UpdateReserved\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateReserved");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				-dReserveAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() UpdateFloat Failed\n"));
		}
	}
*/
	if (iRet == PD_OK) {
		if(GetField_Int(hContext,"recon_ind",&iRecon)){
DEBUGLOG(("BOBalance:DebitDepositAmount() recon_ind = [%d]\n",iRecon));
		}

		if(iRecon){
DEBUGLOG(("BOBalance:DebitDepositAmount() Call GetAvalPspBalanceForUpdate\n"));
                        if(GetAvalPspBalanceForUpdate(csCountry, csPspCCY, csPspID, &dAvaBalance)!=PD_OK) {
DEBUGLOG(("BOBalance:GetAvalPspBalanceForUpdate Failed\n"));
ERRLOG("BOBalance:GetAvalPspBalanceForUpdate Failed\n");
                                iRet=INT_ERR;
                        }
                        else {
DEBUGLOG(("BOBalance::DebitDepositAmount() PSP Balance [%lf]\n", dAvaBalance));
				if(dAvaBalance<(dPspAmount-dPspFee)){
DEBUGLOG(("BOBalance::DebitDepositAmount() PSP Balance [%lf] < debit balance [%lf]\n", dAvaBalance,(dPspAmount-dPspFee)));
ERRLOG("BOBalance::DebitDepositAmount() PSP Balance [%lf] < debit balance [%lf]\n", dAvaBalance,(dPspAmount-dPspFee));
					iRet = INT_INSUFFICIENT_FUND;
					PutField_Int(hContext,"internal_error",iRet);
				}
                        }

			if(iRet==PD_OK){
DEBUGLOG(("BOBalance:DebitDepositAmount DebitPSP Ava Balance\n"));
				DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
        			if ((*DBObjPtr)(csPspID,
						csCountry,
						csPspCCY,
						PD_PSP_BAL,
						dPspAmount - dPspFee,
						PD_UPDATE_USER) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() DebitBalance Failed\n"));
				}
			}
		}
		else{
DEBUGLOG(("BOBalance:DebitDepositAmount DebitPSP Float\n"));
			DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
        		if ((*DBObjPtr)(csPspID,
					csCountry,
					csPspCCY,
					PD_PSP_FLOAT,
					dPspAmount - dPspFee,
					PD_UPDATE_USER) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() DebitBalance Failed\n"));
			}
		}
	}

DEBUGLOG(("BOBalance:DebitDepositAmount() iRet = [%d]\n",iRet));
	return iRet;
}

int UpdateSettlementAmount(hash_t *hContext)
{
	int	iRet = PD_OK;
	char	*csTxnCode;
	char	*csOrgTxnSeq;
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgServiceCode;
	double	dOrgNetAmt=0.0;
	//double	dOrgTxnAmt=0.0;
	double	dFee=0.0;
	//double	dMarkupAmt=0.0;
	double	dTmp;
	//char	cTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:UpdateSettlementAmount()\n"));

//txn code 
	if (GetField_CString(hContext,"txn_code",&csTxnCode)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_code = [%s]\n",csTxnCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_code is missing!!!\n"));
	}
//org txn seq 
	if (GetField_CString(hContext,"txn_seq",&csOrgTxnSeq)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_seq = [%s]\n",csOrgTxnSeq));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_seq is missing!!!\n"));
	}

//org txn country 
	if (GetField_CString(hContext,"txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_country is missing!!!\n"));
	}

///org txn ccy 
	if (GetField_CString(hContext,"request_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
		if (GetField_CString(hContext,"txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_ccy = [%s]\n",csOrgTxnCcy));
		}
		else{
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_ccy is missing!!!\n"));
		}
	}
///org service Code 
	if (GetField_CString(hContext,"service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() service_code is missing!!!\n"));
	}

///org merchant id 
	if (GetField_CString(hContext,"merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() merchant_id is missing!!!\n"));
	}

/*
///org txn amount //
	if (GetField_Double(hContext,"txn_amt",&dOrgTxnAmt)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_amt = [%lf]\n",dOrgTxnAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_amt is missing!!!\n"));
	}
*/

///org net amount //
	if (GetField_Double(hContext,"net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() net_amt = [%lf]\n",dOrgNetAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() net_amt is missing!!!\n"));
	}

///markup//
//	if (GetField_Double(hContext,"markup_amt",&dMarkupAmt)) {	
//DEBUGLOG(("BOBalance:UpdateSettlementAmount() markup_amt = [%lf]\n",dMarkupAmt));
//	}

///fee//
	if (GetField_Double(hContext,"src_txn_fee",&dFee)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() fee = [%lf]\n",dFee));
	}

DEBUGLOG(("BOBalance:UpdateSettlementAmount() Update Avi Settlement Balance\n"));

	if(!strcmp(csTxnCode,PD_SETTLEMENT_REQUEST)){
		iRet = PD_OK;
	}

	else if(!strcmp(csTxnCode,PD_SETTLEMENT_CANCEL)){
		iRet = PD_OK;
	}

	else if(!strcmp(csTxnCode,PD_SETTLEMENT_DELIVERY)){
		iRet = PD_OK;
	}
	else if(!strcmp(csTxnCode,PD_SETTLEMENT_APPROVAL)){

/* lock opening balance */
                DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetOpenBalanceForUpdate");
                if ((*DBObjPtr)(hContext,
                                csOrgMerchantId,
                                csOrgTxnCcy,
                                csOrgTxnCountry,
                                csOrgServiceCode) != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("BOBalance:UpdateSettlementAmount() GetOpenBalanceForUpdate Failed\n"));
                }

DEBUGLOG(("BOBalance:UpdateSettlementAmount() Call DBMerchantBalance:UpdateSettBal[%c]\n",PD_IND_DEBIT));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateSettBal");
		iRet = (unsigned long)(*DBObjPtr)(csOrgMerchantId,
						csOrgTxnCountry,
						csOrgTxnCcy,
						csOrgServiceCode,
						dOrgNetAmt,
						dFee,
						PD_IND_DEBIT,
						PD_UPDATE_USER); 
	}
/*
	else if(!strcmp(csTxnCode,PD_SETTLEMENT_APPROVAL)){
DEBUGLOG(("BOBalance:UpdateSettlementAmount() Call DBMerchantBalance:Settlement2InTransit[%c]\n",PD_S2I));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","Settlement2InTransit");
		iRet = (unsigned long)(*DBObjPtr)(csOrgMerchantId,
						csOrgTxnCountry,
						csOrgTxnCcy,
						csOrgServiceCode,
						dOrgNetAmt,
						dFee,
						PD_S2I,
						PD_UPDATE_USER); 

	}
*/
/*
	else if(!strcmp(csTxnCode,PD_SETTLEMENT_DELIVERY)){
DEBUGLOG(("BOBalance:UpdateSettlementAmount() Call DBMerchantBalance:UpdateIntransit\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateIntransit");
			iRet = (unsigned long)(*DBObjPtr)(csOrgMerchantId,
                                                csOrgTxnCountry,
                                                csOrgTxnCcy,
                                                csOrgServiceCode,
                                                (dOrgNetAmt)*(-1),
                                                PD_UPDATE_USER);

	}
*/

	else {
DEBUGLOG(("BOBalance:None Settlement txn\n"));
		return iRet;
	}

	//if(iRet==PD_OK){

		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csOrgMerchantId,csOrgTxnCcy,csOrgTxnCountry,csOrgServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"current_bal",&dTmp)){
				PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOBalance: current_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"current_bal_settlement",&dTmp)){
				PutField_Double(hContext,"current_bal_settlement",dTmp);
DEBUGLOG(("BOBalance: current_bal_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float_after_payout",&dTmp)){
				PutField_Double(hContext,"total_float_after_payout",dTmp);
DEBUGLOG(("BOBalance: total_float_after_payout= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float_settlement",&dTmp)){
				PutField_Double(hContext,"total_float_settlement",dTmp);
DEBUGLOG(("BOBalance: total_float_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOBalance: total_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold_settlement",&dTmp)){
				PutField_Double(hContext,"total_hold_settlement",dTmp);
DEBUGLOG(("BOBalance: total_hold_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"fundin_payout",&dTmp)){
				PutField_Double(hContext,"fundin_payout",dTmp);
DEBUGLOG(("BOBalance: fundin_payout= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"reserved_payout",&dTmp)){
				PutField_Double(hContext,"reserved_payout",dTmp);
DEBUGLOG(("BOBalance: reserved_payout= [%f]\n",dTmp));
			}
		}

		FREE_ME(hVal);
	//}
	
DEBUGLOG(("BOBalance iRet=[%d]\n",iRet));
	return iRet;
}

int GetAvalBalanceForUpdate(const char* csTxnCountry,
                        const char* csTxnCcy,
                        const char* csService,
                        const char* csMerchantId,
                        double  *dBalance)
{
	int	iRet = PD_OK;
DEBUGLOG(("BOBalance:GetBalanceForUpdate()\n"));

DEBUGLOG(("BOBalance:GetBalanceForUpdate() mid=[%s]\n",csMerchantId));
DEBUGLOG(("BOBalance:GetBalanceForUpdate() txn_ccy=[%s]\n",csTxnCcy));
DEBUGLOG(("BOBalance:GetBalanceForUpdate() txn_country=[%s]\n",csTxnCountry));
DEBUGLOG(("BOBalance:GetBalanceForUpdate() service=[%s]\n",csService));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetAvalBalance");
        if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csService,dBalance)==PD_OK){
DEBUGLOG(("Balance = [%lf]\n",*dBalance));
        }
        else{
DEBUGLOG(("BOBalance:GetBalanceForUpdate()  balance for [%s] [%s] [%s] not found\n",csMerchantId,csTxnCcy,csService));
ERRLOG("BOBalance:GetBalanceForUpdate()  balance for [%s] [%s] [%s] not found\n",csMerchantId,csTxnCcy,csService);
		*dBalance = 0.0;
        }
	

	return iRet;
}

int GetAvalPayoutBalance(hash_t *hContext, 
			const hash_t *hRequest, 
			double *dActualBalance, 
			double *dAvalBalance)
{
	int	iRet = PD_OK;
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgServiceCode;
	double	dReservedAmt=0;
	double	dBal=0;
	double	dFeeRate=0;
	int	iDayOfWeek;
	
//org txn country 
	if (GetField_CString(hContext,"txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() txn_country is missing!!!\n"));
	}

///org txn ccy 
	if (GetField_CString(hContext,"txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else{
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() txn_ccy is missing!!!\n"));
	}
///org service Code 
	if (GetField_CString(hContext,"service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() service_code is missing!!!\n"));
	}

///org merchant id 
	if (GetField_CString(hContext,"merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() merchant_id is missing!!!\n"));
	}

///day of week
	if (GetField_Int(hContext,"day_of_week",&iDayOfWeek)) {	
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() day_of_week = [%d]\n",iDayOfWeek));
	}
	else {
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() day_of_week is missing!!!\n"));
	}

///approximate_fee_rate
	if (GetField_Double(hContext,"approximate_fee_rate",&dFeeRate)) {	
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() approximate_fee_rate = [%lf]\n",dFeeRate));
	}
	else {
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() approximate_fee_rate is missing!!!\n"));
	}


	if(iRet ==PD_OK){
DEBUGLOG(("BOBalance::Call DBMerchantReservedAmt:GetMinReservedAmt\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchantReservedAmt","GetMinReservedAmt");
                if((unsigned long)(*DBObjPtr)(csOrgMerchantId,
                                                csOrgTxnCountry,
                                                csOrgTxnCcy,
                                                csOrgServiceCode,
                                                iDayOfWeek,
                                                &dReservedAmt)==PD_OK){
DEBUGLOG(("GetReservedAmt reserved_amt =[%lf]\n",dReservedAmt));
                        *dActualBalance = dReservedAmt;
                }
                else{
DEBUGLOG(("GetReservedAmt Error\n"));
ERRLOG("BOBalance:GetAvalPayoutBalance::GetReservedAmt Error!!\n");
                        *dActualBalance = 0.0;
                        *dAvalBalance= 0.0;
			iRet = PD_ERR;
                }
	}

	if(iRet ==PD_OK){
DEBUGLOG(("BOBalance::Call DBMerchantBalance:GetPOAvalBalance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetPOAvalBalance");
        	if((unsigned long)(*DBObjPtr)(hContext,
					csOrgMerchantId,
					csOrgTxnCcy,
					csOrgTxnCountry,
					csOrgServiceCode,
					&dBal)==PD_OK){
DEBUGLOG(("GetAvalBalance balance = [%lf]\n",dBal));
			if(dBal<*dActualBalance || *dActualBalance==0.0){
                                *dActualBalance = dBal;
				PutField_Int(hContext,"merchant_balance",PD_TRUE);
                        }
			else
				PutField_Int(hContext,"reserved_amount",PD_TRUE);
        	}
        	else{
DEBUGLOG(("BOBalance:GetAvalPayoutBalance()  balance for [%s] [%s] [%s] not found\n",csOrgMerchantId,csOrgTxnCcy,csOrgServiceCode));
ERRLOG("BOBalance:GetAvalPayoutBalance()  balance for [%s] [%s] [%s] not found\n",csOrgMerchantId,csOrgTxnCcy,csOrgServiceCode);
			*dActualBalance = 0.0;
			*dAvalBalance= 0.0;
			iRet = PD_ERR;
        	}
	}

	if(iRet==PD_OK){
			*dAvalBalance = (*dActualBalance)/(1 + (dFeeRate/100));
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() Aval balance = [%lf]\n",*dAvalBalance));
DEBUGLOG(("BOBalance:GetAvalPayoutBalance() Actual balance = [%lf]\n",*dActualBalance));
	}

	
	return iRet;
}

int UpdateMerchantAvalAmt(hash_t* hContext,
			const char* csCountry,
                        const char* csServiceCode,
                        const char* csMerchantCCY,
                        const char* csMerchantID,
			double dNetAmt)
{
	int	iRet = PD_OK;
	
DEBUGLOG(("BOBalance:UpdateMerchantAvalAmt Amount to be updated = [%lf]\n",dNetAmt));
        if (iRet == PD_OK) {
/* lock opening balance */
                DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetOpenBalanceForUpdate");
                if ((*DBObjPtr)(hContext,
                                csMerchantID,
                                csMerchantCCY,
                                csCountry,
                                csServiceCode) != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("BOBalance:UpdateSettlementAmount() GetOpenBalanceForUpdate Failed\n"));
                }

DEBUGLOG(("BOBalance:UpdateSettlementAmount() Call DBMerchantBalance:UpdateSettBal[%c]\n",PD_IND_DEBIT));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateSettBal");
DEBUGLOG(("BOBalance:UpdateMerchantAvalAmt: UpdateCurrBal\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateCurrBal");
                if ((*DBObjPtr)(csMerchantID,
                                csCountry,
                                csMerchantCCY,
                                csServiceCode,
				dNetAmt,
                                PD_UPDATE_USER) != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("BOBalance:UpdateMerchantAvalAmt() UpdateCurrBal Failed\n"));
                }
        }

	

	return iRet;
}


int DebitMerchantAvalAmount(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csTxnCountry;
	char	*csTxnCcy;
	char	*csMerchantId;
	char	*csServiceCode;
	double	dNetAmt=0.0;
	//double	dTxnAmt=0.0;
	double	dTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:DebitMerchantAvalAmount()\n"));

/*txn country */
	if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {	
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() txn_country = [%s]\n",csTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() txn_country is missing!!!\n"));
	}

/*txn ccy */
	if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {	
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() txn_ccy = [%s]\n",csTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() txn_ccy is missing!!!\n"));
	}
/*service Code */
	if (GetField_CString(hContext,"service_code",&csServiceCode)) {	
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() service_code = [%s]\n",csServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() service_code is missing!!!\n"));
	}

/*merchant id */
	if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {	
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() merchant_id = [%s]\n",csMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() merchant_id is missing!!!\n"));
	}


/* txn amount 
	if (GetField_Double(hContext,"txn_amt",&dTxnAmt)) {	
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() txn_amt = [%lf]\n",dTxnAmt));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() txn_amt is missing!!!\n"));
	}
*/

/* net amount */
	if (GetField_Double(hContext,"net_amt",&dNetAmt)) {	
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() net_amt = [%lf]\n",dNetAmt));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() net_amt is missing!!!\n"));
	}



DEBUGLOG(("BOBalance:DebitMerchantAvalAmount() Update merchant aval balance \n"));
	iRet = UpdateMerchantAvalAmt(hContext,
				csTxnCountry,
				csServiceCode,
				csTxnCcy,
				csMerchantId,
				dNetAmt * (-1));
		
	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
	if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){
		if(GetField_Double(hVal,"current_bal",&dTmp)){
			PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOBalance: current_bal= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_float",&dTmp)){
			PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"current_bal_settlement",&dTmp)){
			PutField_Double(hContext,"current_bal_settlement",dTmp);
DEBUGLOG(("BOBalance: current_bal_settlement= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_float_settlement",&dTmp)){
			PutField_Double(hContext,"total_float_settlement",dTmp);
DEBUGLOG(("BOBalance: total_float_settlement= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
			PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_hold",&dTmp)){
			PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOBalance: total_hold= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_hold_settlement",&dTmp)){
			PutField_Double(hContext,"total_hold_settlement",dTmp);
DEBUGLOG(("BOBalance: total_hold_settlement= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_float_after_payout",&dTmp)){
			PutField_Double(hContext,"total_float_after_payout",dTmp);
DEBUGLOG(("BOBalance: total_float_after_payout= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"fundin_payout",&dTmp)){
			PutField_Double(hContext,"fundin_payout",dTmp);
DEBUGLOG(("BOBalance: fundin_payout= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"reserved_payout",&dTmp)){
			PutField_Double(hContext,"reserved_payout",dTmp);
DEBUGLOG(("BOBalance: reserved_payout= [%f]\n",dTmp));
		}
	}
	FREE_ME(hVal);
DEBUGLOG(("BOBalance:DebitMerchantAvalAmount()  exit = [%d]\n",iRet));
	
	return iRet;
}

int CreditMerchantAvalAmount(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csTxnCountry;
	char	*csTxnCcy;
	char	*csMerchantId;
	char	*csServiceCode;
	double	dNetAmt=0.0;
	double	dTxnAmt=0.0;
	double	dTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:CreditMerchantAvalAmount()\n"));

/* txn country */
	if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {	
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() txn_country = [%s]\n",csTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() txn_country is missing!!!\n"));
	}

/*txn ccy */
	if (GetField_CString(hContext,"bal_ccy",&csTxnCcy)) {	
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() txn_ccy = [%s]\n",csTxnCcy));
	}
	else if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {	
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() txn_ccy = [%s]\n",csTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() txn_ccy is missing!!!\n"));
	}
/*service Code */
	if (GetField_CString(hContext,"service_code",&csServiceCode)) {	
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() service_code = [%s]\n",csServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() service_code is missing!!!\n"));
	}

/*merchant id */
	if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {	
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() merchant_id = [%s]\n",csMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() merchant_id is missing!!!\n"));
	}

/* txn amount */
	if (GetField_Double(hContext,"txn_amt",&dTxnAmt)) {	
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() txn_amt = [%lf]\n",dTxnAmt));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() txn_amt is missing!!!\n"));
	}


/*net amount */
	if (GetField_Double(hContext,"net_amt",&dNetAmt)) {	
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() net_amt = [%lf]\n",dNetAmt));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() net_amt is missing!!!\n"));
	}

DEBUGLOG(("BOBalance:CreditMerchantAvalAmount() Update merchant aval balance \n"));
	iRet = UpdateMerchantAvalAmt(hContext,
				csTxnCountry,
				csServiceCode,
				csTxnCcy,
				csMerchantId,
				dNetAmt);


		
	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
	if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){
		if(GetField_Double(hVal,"current_bal",&dTmp)){
			PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOBalance: current_bal= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_float",&dTmp)){
			PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"current_bal_settlement",&dTmp)){
			PutField_Double(hContext,"current_bal_settlement",dTmp);
DEBUGLOG(("BOBalance: current_bal_settlement= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_float_settlement",&dTmp)){
			PutField_Double(hContext,"total_float_settlement",dTmp);
DEBUGLOG(("BOBalance: total_float_settlement= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
			PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_hold",&dTmp)){
			PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOBalance: total_hold= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_hold_settlement",&dTmp)){
			PutField_Double(hContext,"total_hold_settlement",dTmp);
DEBUGLOG(("BOBalance: total_hold_settlement= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_float_after_payout",&dTmp)){
			PutField_Double(hContext,"total_float_after_payout",dTmp);
DEBUGLOG(("BOBalance: total_float_after_payout= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"fundin_payout",&dTmp)){
			PutField_Double(hContext,"fundin_payout",dTmp);
DEBUGLOG(("BOBalance: fundin_payout= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"reserved_payout",&dTmp)){
			PutField_Double(hContext,"reserved_payout",dTmp);
DEBUGLOG(("BOBalance: reserved_payout= [%f]\n",dTmp));
		}
	}
	FREE_ME(hVal);


DEBUGLOG(("BOBalance:CreditMerchantAvalAmount()  exit = [%d]\n",iRet));
	
	return iRet;
}



int TransferPspBalance(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgPspId;
	char	cTmp;
	double	dAmt;
	double	dPspFee = 0;
	double	dTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:TransferPspBalance()\n"));

/*txn country */
	if (GetField_CString(hContext,"txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:TransferPspBalance() txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:TransferPspBalance() txn_country is missing!!!\n"));
	}

/*txn ccy */
	if (GetField_CString(hContext,"txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:TransferPspBalance() txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:TransferPspBalance() txn_ccy is missing!!!\n"));
	}

/*psp id */
	if (GetField_CString(hContext,"psp_id",&csOrgPspId)) {	
DEBUGLOG(("BOBalance:TransferPspBalance() psp_id = [%s]\n",csOrgPspId));
	}
	else {
DEBUGLOG(("BOBalance:TransferPspBalance() psp_id is missing!!!\n"));
	}

/*net amount */
	if (GetField_Double(hContext,"txn_amt",&dAmt)) {	
DEBUGLOG(("BOBalance:TransferPspBalance() txn_amt = [%lf]\n",dAmt));
	}
	else {
DEBUGLOG(("BOBalance:TransferPspBalance() txn_amt is missing!!!\n"));
	}

/* psp_fee */
	if (GetField_Double(hContext,"service_fee",&dPspFee)) {	
DEBUGLOG(("BOBalance:TransferPspBalance() service_fee = [%lf]\n",dPspFee));
	}
	else {
DEBUGLOG(("BOBalance:TransferPspBalance() service_fee is missing!!!\n"));
	}

/* transfer from */
	if(GetField_Char(hContext,"transfer_from",&cTmp)){
DEBUGLOG(("BOBalance:TransferPspBalance() transfer_from = [%c]\n",cTmp));
	}
	else {
DEBUGLOG(("BOBalance:TransferPspBalance() transfer_from is missing!!!\n"));
	}


	DBObjPtr = CreateObj(DBPtr,"DBPspBalance","TransferBalance");
	if((unsigned long)(*DBObjPtr)(csOrgPspId,
				      csOrgTxnCountry,
				      csOrgTxnCcy,
				      dAmt-dPspFee,
				      cTmp,
				      PD_UPDATE_USER)!=PD_OK){
DEBUGLOG(("BOBalance:TransferPspBalance() Failed\n"));
		iRet = INT_ERR;
	}
	
	if(iRet==PD_OK){

		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalance");
		if((unsigned long)(*DBObjPtr)(csOrgPspId,csOrgTxnCountry,csOrgTxnCcy,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"balance",&dTmp)){
				PutField_Double(hContext,"psp_balance",dTmp);
DEBUGLOG(("BOBalance:psp_balance = [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"psp_total_float",dTmp);
DEBUGLOG(("BOBalance:psp_total_float = [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"psp_total_hold",dTmp);
DEBUGLOG(("BOBalance:psp_total_hold = [%f]\n",dTmp));
			}
		}

		FREE_ME(hVal);
	}
	
	return iRet;
}

int GetAvalPspBalanceForUpdate(const char* csTxnCountry,
                        const char* csTxnCcy,
                        const char* csPspId,
                        double  *dBalance)
{
        int     iRet = PD_OK;
DEBUGLOG(("BOBalance:GetAvalPspBalanceForUpdate()\n"));

DEBUGLOG(("BOBalance:GetAvalPspBalanceForUpdate() psp_id = [%s]\n",csPspId));
DEBUGLOG(("BOBalance:GetAvalPspBalanceForUpdate() txn_ccy=[%s]\n",csTxnCcy));
DEBUGLOG(("BOBalance:GetAvalPspBalanceForUpdate() txn_country=[%s]\n",csTxnCountry));
        DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetAvalPspBalance");
        if((unsigned long)(*DBObjPtr)(csPspId,csTxnCcy,csTxnCountry,dBalance)==PD_OK){
DEBUGLOG(("Balance = [%lf]\n",*dBalance));
        }
        else{
DEBUGLOG(("BOBalance:GetAvalPspBalanceForUpdate()  balance for [%s] [%s] not found\n",csPspId,csTxnCcy));
ERRLOG("BOBalance:GetAvalpspBalanceForUpdate()  balance for [%s] [%s] not found\n",csPspId,csTxnCcy);
                *dBalance = 0.0;
        }

        return iRet;
}

int UpdateMerchantAdjAmount(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csTxnCountry;
	char	*csTxnCcy;
	char	*csMerchantId;
	char	*csServiceCode;
	char	cDCType;
	double	dNetAmt=0.0;
	char	*csUser;
	double	dTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount()\n"));

/*txn country */
	if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {	
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() txn_country = [%s]\n",csTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() txn_country is missing!!!\n"));
	}

/*txn ccy */
	if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() txn_ccy = [%s]\n",csTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() txn_ccy is missing!!!\n"));
	}
/*service Code */
	if (GetField_CString(hContext,"service_code",&csServiceCode)) {	
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() service_code = [%s]\n",csServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() service_code is missing!!!\n"));
	}

/*merchant id */
	if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {	
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() merchant_id = [%s]\n",csMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() merchant_id is missing!!!\n"));
	}

/* net amount */
	if (GetField_Double(hContext,"net_amt",&dNetAmt)) {	
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() net_amt = [%lf]\n",dNetAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() net_amt is missing!!!\n"));
	}

/* credit or debit */
	if (GetField_Char(hContext, "dc_type", &cDCType)) {
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() cDCType = [%c]\n",cDCType));
	}
	else {
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() cDCType is missing !!!\n"));
	}

	if (GetField_CString(hContext, "add_user", &csUser)) {
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() User = [%s]\n",csUser));
	}
	else {
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() User is missing !!!\n"));
	}



DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() Update merchant sett balance \n"));

	DBObjPtr = CreateObj(DBPtr, "DBMerchantBalance", "UpdateSettlement");
	if((unsigned long)(*DBObjPtr)(hContext, csMerchantId,csTxnCountry, csTxnCcy,csServiceCode, dNetAmt, 0.0, cDCType, csUser)!=PD_ERR){
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() UpdateSettlement Failed !\n"));
		iRet = INT_ERR;
	}
	else {
		if (GetField_Double(hContext, "merchant_open_bal", &dTmp)) {
DEBUGLOG(("BOBalance: UpdateMerchantAdjAmount() merchant_open_bal= [%f]\n",dTmp));
		}

		if (GetField_Double(hContext, "merchant_open_bal_settlement", &dTmp)) {
DEBUGLOG(("BOBalance: UpdateMerchantAdjAmount() merchant_open_bal_settlement = [%f]\n",dTmp));
		}
	}

	if (iRet == PD_OK) {
		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"current_bal",&dTmp)){
				PutField_Double(hContext,"current_bal",dTmp);
DEBUGLOG(("BOBalance: UpdateMerchantAdjAmount() current_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: UpdateMerchantAdjAmount() total_float= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"current_bal_settlement",&dTmp)){
				PutField_Double(hContext,"current_bal_settlement",dTmp);
DEBUGLOG(("BOBalance: UpdateMerchantAdjAmount() current_bal_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float_settlement",&dTmp)){
				PutField_Double(hContext,"total_float_settlement",dTmp);
DEBUGLOG(("BOBalance: UpdateMerchantAdjAmount() total_float_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: UpdateMerchantAdjAmount() total_reserved_amount= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"total_hold",dTmp);
DEBUGLOG(("BOBalance: UpdateMerchantAdjAmount() total_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold_settlement",&dTmp)){
				PutField_Double(hContext,"total_hold_settlement",dTmp);
DEBUGLOG(("BOBalance: UpdateMerchantAdjAmount() total_hold_settlement= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float_after_payout",&dTmp)){
				PutField_Double(hContext,"total_float_after_payout",dTmp);
DEBUGLOG(("BOBalance: UpdateMerchantAdjAmount() total_float_after_payout= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"fundin_payout",&dTmp)){
				PutField_Double(hContext,"fundin_payout",dTmp);
DEBUGLOG(("BOBalance: UpdateMerchantAdjAmount() fundin_payout= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"reserved_payout",&dTmp)){
				PutField_Double(hContext,"reserved_payout",dTmp);
DEBUGLOG(("BOBalance: UpdateMerchantAdjAmount() reserved_payout= [%f]\n",dTmp));
			}
		}
		else {
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount() GetCurrentValue Failed !\n"));
			iRet = INT_ERR;
		}
	}
	FREE_ME(hVal);
DEBUGLOG(("BOBalance:UpdateMerchantAdjAmount()  exit = [%d]\n",iRet));
	
	return iRet;
}

int  ProcessFundinPayout(hash_t *hContext)
{
        int iRet = PD_OK;

        char    *csTxnCcy;
        char    *csTxnCountry;
	char	cPartyType;
        char    *csPspId;
        char    *csMerchantId;
        char    *csServiceCode;
        char    *csUser;
	char	cDCInd;
	int	cChgBalMode;
	double	dFundinAmt = 0.0;

	double	dTmp = 0.0;
	double  dOrgFundinAmt = 0.0;

        hash_t *hVal;
        hVal = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hVal,0);

/* party_type */
        if(GetField_Char(hContext,"party_type",&cType)){
DEBUGLOG(("BOBalance:ProcessFundinPayout() party_type = [%c]\n",cType));
        }

/*merchant id */
        if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {
DEBUGLOG(("BOBalance:ProcessFundinPayout() merchant_id = [%s]\n",csMerchantId));
        }

/*psp id */
        if (GetField_CString(hContext,"psp_id",&csPspId)) {
DEBUGLOG(("BOBalance:ProcessFundinPayout () psp_id = [%s]\n",csPspId));
        }

/*txn country */
        if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {
DEBUGLOG(("BOBalance:ProcessFundinPayout() txn_country = [%s]\n",csTxnCountry));
        }
        else {
DEBUGLOG(("BOBalance:ProcessFundinPayout() txn_country is missing!!!\n"));
        }

/* txn ccy */
        if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {
DEBUGLOG(("BOBalance:ProcessFundinPayout() txn_ccy = [%s]\n",csTxnCcy));
        }
        else {
DEBUGLOG(("BOBalance:ProcessFundinPayout() txn_ccy is missing!!!\n"));
        }

/*service code */
        if (GetField_CString(hContext,"service_code",&csServiceCode)) {
DEBUGLOG(("BOBalance:ProcessFundinPayout() service_code = [%s]\n",csServiceCode));
        }

/* dc_ind */
	if (GetField_Char(hContext, "dc_ind", &cDCInd)) {
DEBUGLOG(("BOBalance:ProcessFundinPayout() dc_ind = [%c]\n",cDCInd));
	} 
	else {
DEBUGLOG(("BOBalance:ProcessFundinPayout() dc_ind is missing!!!\n"));
		iRet = INT_ERR;
		PutField_Int(hContext, "fn_internal_error", iRet);
        }

/* chg_bal_mode */
	if (GetField_Int(hContext, "chg_bal_mode", &cChgBalMode)) {
DEBUGLOG(("BOBalance:ProcessFundinPayout() chg_bal_mode = [%c]\n",cChgBalMode));
	}
	else {
DEBUGLOG(("BOBalance:ProcessFundinPayout() chg_bal_mode is missing!!!\n"));
		iRet = INT_ERR;
		PutField_Int(hContext, "fn_internal_error", iRet);
	}

/*amount */
        if (GetField_Double(hContext,"txn_amt",&dFundinAmt)) {
DEBUGLOG(("BOBalance:ProcessFundinPayout() fundin_amt = [%lf]\n",dFundinAmt));
        }

/*update_user*/
        if (GetField_CString(hContext,"update_user",&csUser)) {
DEBUGLOG(("BOBalance:ProcessFundinPayout() update_user = [%s]\n",csUser));
        }


	// Check Valid to process
	if (cType == PD_TYPE_MERCHANT) {
DEBUGLOG(("BOBalance: ProcessHold: DBMerchantBalance->GetOpenBalanceForUpdate\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetOpenBalanceForUpdate");
                if((unsigned long)(*DBObjPtr)(hVal, csMerchantId,csTxnCcy,csTxnCountry,csServiceCode)!=PD_ERR) {

			if (GetField_Double(hVal, "merchant_open_bal", &dTmp)) {
DEBUGLOG(("BOBalance: ProcessFundinPayout open_bal = [%f]\n",dTmp));
				PutField_Double(hContext, "open_bal", dTmp);
			}

			if (GetField_Double(hVal, "merchant_open_bal_settlement", &dTmp)) {
DEBUGLOG(("BOBalance: ProcessFundinPayout open_bal_settlement = [%f]\n",dTmp));
				PutField_Double(hContext,"open_bal_settlement",dTmp);
			}

			if (GetField_Double(hVal, "fundin_payout", &dOrgFundinAmt)) {
DEBUGLOG(("BOBalance: ProcessFundinPayout fundin_payout = [%f]\n",dOrgFundinAmt));
			}
			
			
			if (cDCInd == PD_IND_CREDIT) {
DEBUGLOG(("BOBalance: ProcessFundinPayout Credit, no need check org fundin_payout\n"));
			} else if (cDCInd == PD_IND_DEBIT) {

				if (dOrgFundinAmt < dFundinAmt) {
DEBUGLOG(("BOBalance: ProcessFundinPayout: Original Fundin [%lf] < Debit Fundin [%lf]\n",dOrgFundinAmt, dFundinAmt));
ERRLOG("BOBalance: ProcessFundinPayout: Original Fundin [%lf] < Debit Fundin [%lf]\n",dOrgFundinAmt, dFundinAmt);
	                                iRet = INT_INVALID_PAY_AMOUNT;
					PutField_Int(hContext, "fn_internal_error", iRet);
				}
			}
		}
		else {
DEBUGLOG(("BOBalance: ProcessFundinPayout: DBMerchantBalance->GetOpenBalanceForUpdate Failed\n"));
ERRLOG("BOBalance: ProcessFundinPayout: DBMerchantBalance->GetOpenBalanceForUpdate Failed\n");
                        iRet=PD_ERR;
                }
		
	} else if (cType == PD_TYPE_PSP) {
DEBUGLOG(("BOBalance: ProcessFundinPayout: DBPspBalance->GetBalanceForUpdate\n"));
                DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalanceForUpdate");
                if ((unsigned long)(*DBObjPtr)(csPspId,csTxnCountry,csTxnCcy,hVal)==PD_OK) {

                        if (GetField_Double(hVal,"balance",&dTmp)) {
DEBUGLOG(("BOBalance::ProcessFundinPayout PSP balance = [%f]\n",dTmp));
                        }
                        if (GetField_Double(hVal,"total_hold",&dTmp)) {
DEBUGLOG(("BOBalance::ProcessFundinPayout PSP total_hold = [%f]\n",dTmp));
                        }

			// PSP no amend to Debit, just having fund-in only!!!
		}
		else {
DEBUGLOG(("BOBalance: ProcessHold: DBPspBalance->GetBalance Failed\n"));
ERRLOG("BOBalance: ProcessHold: DBPspBalance->GetBalance Failed\n");
                        iRet=INT_ERR;
			PutField_Int(hContext, "fn_internal_error", iRet);
                }

	}

	// Handle Balance / Fundin payout
	if (iRet == PD_OK) {
		if (cType == PD_TYPE_MERCHANT) {

		} 
		else if (cType == PD_TYPE_PSP) {
		}
	}
	FREE_ME(hVal);

	if (iRet == PD_OK) {
		if (cChgBalMode == PD_TRUE) {
			if (cDCInd == PD_IND_CREDIT) {
				PutField_CString(hContext, "amount_type", PD_CR);
			}  else {
				// Not expect debit
				iRet = INT_ERR;
			}

			// TxnElements!!

		}
	}
}
