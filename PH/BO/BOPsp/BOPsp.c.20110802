/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/09/16              Cody Chan
Update 0.0.1 (add PK: client)			   2011/01/07		   LokMan Chow
Update 0.0.2 (get psp key)			   2011/01/07		   LokMan Chow
Add STP PSP				           2011/02/28		   Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOPsp.h"

char    cDebug;

void BOPsp(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(DB);


int GetTxnPsp(hash_t *hContext,
                const hash_t* hRequest)
{
        int     iRet = PD_OK;
	int	iSTP = PD_FALSE;
	char*	csTxnCountry = NULL;
	char*	csPspId = NULL;
	char*	csClientId = NULL;
	char*	csTxnCode = NULL;
	char*	csTmp = NULL;
	char	cOnline = PD_OFFLINE;
	char*	csMerchantClientId = NULL;
	char*	csMerchantId = NULL;

	char*	csPtr;
	int	iTmp;

	hash_t  *hRec;	
	hash_t  *hKey;	
	hash_t  *hPsp;	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	recordset_t     *rKeySet;
        rKeySet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rKeySet,0);


	if (!GetField_CString(hContext,"org_txn_code",&csTxnCode))
		GetField_CString(hContext,"txn_code",&csTxnCode);

DEBUGLOG(("BOPsp: TxnCode = [%s]\n",csTxnCode));

	if (GetField_CString(hRequest,"txn_country",&csTxnCountry)) {
DEBUGLOG(("BOPsp: GetMerchatDetail- txn_country = [%s]\n",csTxnCountry));
	}
	else  {
		if (GetField_CString(hContext,"org_txn_country",&csTxnCountry)) {
DEBUGLOG(("BOPsp: GetMerchatDetail- txn_country = [%s]\n",csTxnCountry));
		}
		else {
DEBUGLOG(("BOPsp: GetTxnPsp- txn_country not found\n"));
ERRLOG("BOPsp: GetMerchatDetail- txn_country not found\n");
		iRet = INT_ERR;
		}
	}
	if (iRet == PD_OK) {
DEBUGLOG(("BOPsp STP\n"));
/* merchant client id */
		if (GetField_CString(hContext,"merchant_client_id",&csMerchantClientId)) {
DEBUGLOG(("BOPsp: merchant client id = [%s]\n",csMerchantClientId));
		}
		else {
DEBUGLOG(("BOPsp: merchant client id not found\n"));
		}

/* merchantid */
		if (!GetField_CString(hContext,"merchant_id",&csMerchantId)) 
			GetField_CString(hRequest,"merchant_id",&csMerchantId);
DEBUGLOG(("BOPsp: merchant id = [%s]\n",csMerchantId));
			
DEBUGLOG(("BOPsp STP call GetStpPsp\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTxnLbStp","GetStpPsp");
       		if ((*DBObjPtr)(csTxnCountry,
				csMerchantId,
				rRecordSet) != PD_OK) {
		}
		else {
               		hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				iSTP = PD_TRUE;
DEBUGLOG(("BOPsp: found STP\n"));
				if (GetField_CString(hRec,"psp_id",&csPspId)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_id = [%s]\n",csPspId));
                      			PutField_CString(hContext,"psp_id",csPspId);
                              	}
                       	        if (GetField_CString(hRec,"psp_client_id",&csClientId)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_client_id = [%s]\n",csClientId));
                       	       		PutField_CString(hContext,"psp_client_id",csClientId);
                       	        }
                       		if (GetField_Char(hRec,"online",&cOnline)) {
DEBUGLOG(("BOPsp: GetTxnPsp - online = [%c]\n",cOnline));
                       			PutField_Char(hContext,"online",cOnline);
                       	        }


                       	        if (GetField_CString(hRec,"psp_channel_code",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - channel_code  = [%s]\n",csPtr));
                       		      	PutField_CString(hContext,"psp_channel_code",csPtr);
                       		}
                       		else {
DEBUGLOG(("BOPsp: GetTxnPsp - channel_code not found\n"));
                       	    	}

                       	        if (GetField_CString(hRec,"psp_ccy",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_ccy (dst_txn_ccy)  = [%s]\n",csPtr));
//                       		      	PutField_CString(hContext,"psp_ccy",csPtr);
                       		      	PutField_CString(hContext,"dst_txn_ccy",csPtr);
                       		}
                       		else {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_ccy not found\n"));
                       	    	}


                       	        if (GetField_CString(hRec,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_merchant id = [%s]\n",csPtr));
                       	        	PutField_CString(hContext,"psp_merchant_id",csPtr);
                       	        }
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	if (iRet == PD_OK && iSTP == PD_FALSE ) {
		DBObjPtr = CreateObj(DBPtr,"DBPsp","GetCountryPsp");
         	if ((*DBObjPtr)(csTxnCountry,
       	                 rRecordSet) != PD_OK) {
               	 	iRet = INT_TXN_COUNTRY_NOT_FOUND;
ERRLOG("BOPsp: txn country [%s] not found\n",csTxnCountry);
DEBUGLOG(("BOPsp: txn country [%s] not found\n",csTxnCountry));
               	}               
		else {
DEBUGLOG(("BOPsp:  else \n"));
               	 	iRet = INT_COUNTRY_PSP_NOT_AVABILE;
                	hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_Int(hRec,"disabled",&iTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp - disabled = [%d]\n",iTmp));

					if (iTmp != PD_DISPABLED) {
						iRet = PD_OK;
						if (GetField_CString(hRec,"psp_id",&csPspId)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_id = [%s]\n",csPspId));
							PutField_CString(hContext,"psp_id",csPspId);
						}
						if (GetField_CString(hRec,"psp_client_id",&csClientId)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_client_id = [%s]\n",csClientId));
							PutField_CString(hContext,"psp_client_id",csClientId);
						}
						if (GetField_CString(hRec,"psp_ccy",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_ccy (dst_txn_ccy) = [%s]\n",csClientId));
//							PutField_CString(hContext,"psp_ccy",csPtr);
							PutField_CString(hContext,"dst_txn_ccy",csPtr);
						}

						if (GetField_Char(hRec,"online",&cOnline)) {
DEBUGLOG(("BOPsp: GetTxnPsp - online = [%c]\n",cOnline));
							PutField_Char(hContext,"online",cOnline);
						}


						if (GetField_CString(hRec,"psp_channel_code",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - channel_code  = [%s]\n",csPtr));
							PutField_CString(hContext,"psp_channel_code",csPtr);
						}
						else {
DEBUGLOG(("BOPsp: GetTxnPsp - channel_code not found\n"));
						}

						if (GetField_CString(hRec,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_merchant id = [%s]\n",csPtr));
							PutField_CString(hContext,"psp_merchant_id",csPtr);
						}
					}
					else {
ERRLOG("BOPsp: psp [%s] disabled\n",csTxnCountry);
						iRet = INT_ACCOUNT_DISABLED;
					}
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		if (cOnline == PD_OFFLINE_MODE) {
			iRet = INT_COUNTRY_PSP_NOT_AVABILE;
DEBUGLOG(("BOPsp: all PSPs for [%s] are not avablie\n",csTxnCountry));
ERRLOG("BOPsp: all PSPs for [%s] are not avablie\n",csTxnCountry);
		}
	}

/* Get PSP Detail */
	hPsp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hPsp,0);
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
		if (!(*DBObjPtr)(csPspId, hPsp)) {
			if (GetField_CString(hPsp,"psp_name",&csTmp)) {
				PutField_CString(hContext,"psp_name",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - PSP NAME = [%s]\n",csTmp));
			}
		}
	}

/*Get Psp Key*/
	if(iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBPspKeys","GetPspKey");
		if (!(*DBObjPtr)(csPspId,PD_PTK_KEY_NAME,rKeySet)) {
			hKey = RecordSet_GetFirst(rKeySet);
			while(hKey){
				if (GetField_CString(hKey,"key_value",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_key = [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_key",csTmp);
				}
				if (GetField_CString(hKey,"key_id",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_key_id= [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_key_id",csTmp);
				}
				hKey = RecordSet_GetNext(rKeySet);
			}
		}
		else{
ERRLOG("BOPsp: GetTxnPSP - no psp_key for [%s]\n",csPspId);
DEBUGLOG(("BOPsp: GetTxnPSP - no psp_key for [%s]\n",csPspId));
		}
	}

////////////////////////	

/* Get PSP URL */
	 if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBPspUrl","GetPspUrl");
                if (!(*DBObjPtr)(csPspId,hPsp)) {
                        if (GetField_CString(hPsp,"url",&csTmp)) {
                                PutField_CString(hContext,"psp_url",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - psp_url = [%s]\n",csTmp));
                        }
                        else {
ERRLOG("BOPsp: GetTxnPSP - no such for [%s]\n",csPspId);
                                iRet = INT_ERR;
                        }
                }
        }


/* Get PSP Reqest Txn URL */
	if (iRet == PD_OK) {
DEBUGLOG(("BOPsp: GetTxnPsp - GetPspRequestTxnUrl\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspRequestTxnUrl","GetPspRequestTxnUrl");
         	if (!(*DBObjPtr)(csPspId,csTxnCode, hPsp)) {
			if (GetField_CString(hPsp,"request_function",&csTmp)) {
				PutField_CString(hContext,"request_function",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - request_function = [%s]\n",csTmp));
			}
			else {
ERRLOG("BOPsp: GetTxnPSP - no such function url for [%s] [%s]\n",csPspId,csTxnCode);
				iRet = INT_ERR;
			}
			if (GetField_CString(hPsp,"action",&csTmp)) {
				PutField_CString(hContext,"action",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - action = [%s]\n",csTmp));
			}
			
			if(GetField_CString(hPsp,"url_method",&csTmp)){
				PutField_CString(hContext,"url_method",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - url_method = [%s]\n",csTmp));
			}
		}
	}


	if (iRet != PD_OK) {
		PutField_Int(hContext,"internal_error",iRet);
	}
	hash_destroy(hPsp);
        FREE_ME(hPsp);

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	RecordSet_Destroy(rKeySet);
	FREE_ME(rKeySet);

	FREE_ME(csTxnCountry);
	FREE_ME(csPspId);
	FREE_ME(csTxnCode);
	FREE_ME(csTmp);
DEBUGLOG(("BOPsp: Normal exit = [%d]\n",iRet));
	return iRet;
}

int GetTxnPspByPspId(hash_t *hContext,
                const hash_t* hRequest,
		const char* csPspId,
		const char* csTxnCode)
{
        int     iRet = PD_OK;
	char*	csTmp = NULL;


	hash_t  *hKey;	
	hash_t  *hPsp;	

	recordset_t     *rKeySet;
        rKeySet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rKeySet,0);



/* Get PSP Detail */
	hPsp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hPsp,0);

	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
		if (!(*DBObjPtr)(csPspId, hPsp)) {
			if (GetField_CString(hPsp,"psp_name",&csTmp)) {
				PutField_CString(hContext,"psp_name",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - PSP NAME = [%s]\n",csTmp));
			}
			if (GetField_CString(hPsp,"psp_merchant_id",&csTmp)) {
				PutField_CString(hContext,"psp_merchant_id",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - merchant_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hPsp,"psp_channel_code",&csTmp)) {
				PutField_CString(hContext,"psp_channel_code",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - psp_channel_code = [%s]\n",csTmp));
			}
		}
	}

/*Get Psp Key*/
	if(iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBPspKeys","GetPspKey");
		if (!(*DBObjPtr)(csPspId,"PTK",rKeySet)) {
			hKey = RecordSet_GetFirst(rKeySet);
			while(hKey){
				if (GetField_CString(hKey,"key_value",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPspByPspId - psp_key = [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_key",csTmp);
				}
				if (GetField_CString(hKey,"key_id",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPspByPspId - psp_key_id = [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_key_id",csTmp);
				}
				hKey = RecordSet_GetNext(rKeySet);
			}
		}
		else{
ERRLOG("BOPsp: GetTxnPSPByPspId - no psp_key for [%s]\n",csPspId);
DEBUGLOG(("BOPsp: GetTxnPSPByPspId - no psp_key for [%s]\n",csPspId));
		}
	}

/* Get PSP URL */
	 if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBPspUrl","GetPspUrl");
                if (!(*DBObjPtr)(csPspId,hPsp)) {
                        if (GetField_CString(hPsp,"url",&csTmp)) {
                                PutField_CString(hContext,"psp_url",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - psp_url = [%s]\n",csTmp));
                        }
                        else {
ERRLOG("BOPsp: GetTxnPSPByPspId - no such for [%s]\n",csPspId);
                                iRet = INT_ERR;
                        }
                }
        }


/* Get PSP Reqest Txn URL */
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBPspRequestTxnUrl","GetPspRequestTxnUrl");
         	if (!(*DBObjPtr)(csPspId,csTxnCode, hPsp)) {
			if (GetField_CString(hPsp,"request_function",&csTmp)) {
				PutField_CString(hContext,"request_function",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - request_function = [%s]\n",csTmp));
			}
			else {
ERRLOG("BOPsp: GetTxnPSPByPspId - no such function url for [%s] [%s]\n",csPspId,PD_INQ_TXN_CODE);
				iRet = INT_ERR;
			}
			if (GetField_CString(hPsp,"action",&csTmp)) {
				PutField_CString(hContext,"action",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - action = [%s]\n",csTmp));
			}

                        if(GetField_CString(hPsp,"url_method",&csTmp)){
                                PutField_CString(hContext,"url_method",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - url_method = [%s]\n",csTmp));
                        }
		}
	}


	if (iRet != PD_OK) {
		PutField_Int(hContext,"internal_error",iRet);
	}

	hash_destroy(hPsp);
        FREE_ME(hPsp);

	RecordSet_Destroy(rKeySet);
	FREE_ME(rKeySet);

	FREE_ME(csTmp);
DEBUGLOG(("BOPspByPspId: Normal exit = [%d]\n",iRet));
	return iRet;
}

int CalPspFee(hash_t *hContext,
                const hash_t* hRequest)
{
	int	iRet = PD_OK;
	hash_t  *hPsp;

	char	*csOrgPspId;
	int	iPreCal = PD_FALSE;
	char	cPreCalType;
	double	dPreCalValue;
	double	dPreCalAddValue;
	double	dOrgTxnAmt;
	double	dFee;

DEBUGLOG(("BOPsp:CalPspFee()\n"));

 	if (GetField_Double(hContext,"org_psp_txn_amt",&dOrgTxnAmt)) {
DEBUGLOG(("BOPsp::CalPspFee() org_psp_txn_amt = [%f]\n",dOrgTxnAmt));
        }
        else {
DEBUGLOG(("BOPsp::CalPspFee() org_psp_txn_amt not found!!!\n"));
        }

/*org psp id */
        if (GetField_CString(hContext,"org_psp_id",&csOrgPspId)) {
DEBUGLOG(("BOPsp:CalPspFee() org_psp_id = [%s]\n",csOrgPspId));
        }
        else {
DEBUGLOG(("BOPsp:CalPspFee() org_psp_id is missing!!!\n"));
        }

	hPsp = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hPsp,0);
	DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
	if (!(*DBObjPtr)(csOrgPspId, hPsp)) {
		if (GetField_Int(hPsp,"precal_fee",&iPreCal)) {
DEBUGLOG(("BOPsp:CalPspFee() Precal_fee = [%d]\n",iPreCal));
		}
		if (GetField_Char(hPsp,"precal_type",&cPreCalType)) {
DEBUGLOG(("BOPsp:CalPspFee() Precal_type = [%c]\n",cPreCalType));
		}
		if (GetField_Double(hPsp,"precal_value",&dPreCalValue)) {
DEBUGLOG(("BOPsp:CalPspFee() Precal_value = [%f]\n",dPreCalValue));
		}
		if (GetField_Double(hPsp,"precal_additional_value",&dPreCalAddValue)) {
DEBUGLOG(("BOPsp:CalPspFee() Precal_additional_value = [%f]\n",dPreCalAddValue));
		}
        }

	if (iPreCal) {
DEBUGLOG(("BOPsp:CalPspFee() Precal fee Now!!!\n"));
		if (cPreCalType == PD_PRECENTAGE) {
                        double dTmp = 0;
                        dTmp = dOrgTxnAmt * (dPreCalValue/100);
                        dFee = newround(dTmp,PD_DECIMAL_LEN);
                }
                else if (cPreCalType == PD_FIXED_AMOUNT) {
                        dFee = newround(dPreCalValue,PD_DECIMAL_LEN);
                }
DEBUGLOG(("BOPsp:CalPspFee() Precal fee = [%f]\n",dFee));
		PutField_Double(hContext,"precal_fee",dFee);
	}

	hash_destroy(hPsp);
        FREE_ME(hPsp);

DEBUGLOG(("BOPsp:CalPspFee() exit = [%d]\n",iRet));
	return iRet;

}
