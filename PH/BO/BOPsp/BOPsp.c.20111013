/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/09/16              Cody Chan
Update 0.0.1 (add PK: client)			   2011/01/07		   LokMan Chow
Update 0.0.2 (get psp key)			   2011/01/07		   LokMan Chow
Add STP PSP				           2011/02/28		   Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOPsp.h"

char    cDebug;

void BOPsp(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(DB);


int GetTxnPsp(hash_t *hContext,
                const hash_t* hRequest)
{
        int     iRet = PD_OK;
	int	iSTP = PD_FALSE;
	char*	csTxnCountry;
	char*	csPspId;
	char*	csClientId;
	char*	csTxnCode;
	char*	csPayMethod;
	char*	csTmp;
	char	cOnline = PD_OFFLINE;
	char*	csMerchantClientId;
	char*	csMerchantId;

	char*	csPtr;
	//int	iTmp;

	hash_t  *hRec;	
	hash_t  *hKey;	
	hash_t  *hPsp;	
	hash_t  *hClient;	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	recordset_t     *rKeySet;
        rKeySet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rKeySet,0);


	if (!GetField_CString(hContext,"org_txn_code",&csTxnCode))
		GetField_CString(hContext,"txn_code",&csTxnCode);

DEBUGLOG(("BOPsp: TxnCode = [%s]\n",csTxnCode));

	if (GetField_CString(hRequest,"txn_country",&csTxnCountry)) {
DEBUGLOG(("BOPsp: GetMerchatDetail- txn_country = [%s]\n",csTxnCountry));
	}
	else  {
		if (GetField_CString(hContext,"org_txn_country",&csTxnCountry)) {
DEBUGLOG(("BOPsp: GetMerchatDetail- txn_country = [%s]\n",csTxnCountry));
		}
		else {
DEBUGLOG(("BOPsp: GetTxnPsp- txn_country not found\n"));
ERRLOG("BOPsp: GetMerchatDetail- txn_country not found\n");
		iRet = INT_ERR;
		}
	}
/* pay method */
	if (GetField_CString(hRequest,"pay_method",&csPayMethod)) {
DEBUGLOG(("BOPsp: GetTxnPsp- pay method = [%s]\n",csPayMethod));
	}
	else if (GetField_CString(hContext,"selected_pay_method",&csPayMethod)) {
DEBUGLOG(("BOPsp: GetTxnPsp- pay method = [%s]\n",csPayMethod));
	}
	else 
	{
DEBUGLOG(("BOPsp: GetTxnPsp- pay_method not found\n"));
ERRLOG("BOPsp: GetTxnPsp- pay_method not found\n");
		iRet = INT_ERR;
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOPsp STP\n"));
/* merchant client id */
		if (GetField_CString(hContext,"merchant_client_id",&csMerchantClientId)) {
DEBUGLOG(("BOPsp: merchant client id = [%s]\n",csMerchantClientId));
		}
		else {
DEBUGLOG(("BOPsp: merchant client id not found\n"));
		}

/* merchantid */
		if (!GetField_CString(hContext,"merchant_id",&csMerchantId)) 
			GetField_CString(hRequest,"merchant_id",&csMerchantId);
DEBUGLOG(("BOPsp: merchant id = [%s]\n",csMerchantId));
			
DEBUGLOG(("BOPsp STP call GetStpPsp\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTxnLbStp","GetStpPsp");
       		if ((*DBObjPtr)(csTxnCountry,
				csMerchantId,
				rRecordSet) != PD_OK) {
		}
		else {
               		hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				iSTP = PD_TRUE;
DEBUGLOG(("BOPsp: found STP\n"));
				if (GetField_CString(hRec,"psp_id",&csPspId)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_id = [%s]\n",csPspId));
                      			PutField_CString(hContext,"psp_id",csPspId);
                              	}
                       	        if (GetField_CString(hRec,"psp_client_id",&csClientId)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_client_id = [%s]\n",csClientId));
                       	       		PutField_CString(hContext,"psp_client_id",csClientId);
                       	        }
                       		if (GetField_Char(hRec,"online",&cOnline)) {
DEBUGLOG(("BOPsp: GetTxnPsp - online = [%c]\n",cOnline));
                       			PutField_Char(hContext,"online",cOnline);
                       	        }


                       	        if (GetField_CString(hRec,"psp_channel_code",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - channel_code  = [%s]\n",csPtr));
                       		      	PutField_CString(hContext,"psp_channel_code",csPtr);
                       		}
                       		else {
DEBUGLOG(("BOPsp: GetTxnPsp - channel_code not found\n"));
                       	    	}

                       	        if (GetField_CString(hRec,"psp_ccy",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_ccy = [%s]\n",csPtr));
					PutField_CString(hContext,"psp_ccy",csPtr);
					PutField_CString(hContext,"dst_txn_ccy",csPtr);
                       		}
                       		else {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_ccy not found\n"));
                       	    	}


                       	        if (GetField_CString(hRec,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_merchant id = [%s]\n",csPtr));
                       	        	PutField_CString(hContext,"psp_merchant_id",csPtr);
                       	        }
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

/* to be replaced by Load Balancer */
	if (iRet == PD_OK && iSTP == PD_FALSE ) {
ERRLOG("BOPsp: STP undefine\n");
DEBUGLOG(("BOPsp: STP undefine\n"));
	}
/*
	if (iRet == PD_OK && iSTP == PD_FALSE ) {
		DBObjPtr = CreateObj(DBPtr,"DBPsp","GetCountryPsp");
         	if ((*DBObjPtr)(csTxnCountry,
       	                 rRecordSet) != PD_OK) {
               	 	iRet = INT_TXN_COUNTRY_NOT_FOUND;
ERRLOG("BOPsp: txn country [%s] not found\n",csTxnCountry);
DEBUGLOG(("BOPsp: txn country [%s] not found\n",csTxnCountry));
               	}               
		else {
DEBUGLOG(("BOPsp:  else \n"));
               	 	iRet = INT_COUNTRY_PSP_NOT_AVABILE;
                	hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_Int(hRec,"disabled",&iTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp - disabled = [%d]\n",iTmp));

					if (iTmp != PD_DISPABLED) {
						iRet = PD_OK;
						if (GetField_CString(hRec,"psp_id",&csPspId)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_id = [%s]\n",csPspId));
							PutField_CString(hContext,"psp_id",csPspId);
						}
						if (GetField_CString(hRec,"psp_client_id",&csClientId)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_client_id = [%s]\n",csClientId));
							PutField_CString(hContext,"psp_client_id",csClientId);
						}
						if (GetField_CString(hRec,"psp_ccy",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_ccy (dst_txn_ccy) = [%s]\n",csClientId));
//							PutField_CString(hContext,"psp_ccy",csPtr);
							PutField_CString(hContext,"dst_txn_ccy",csPtr);
						}

						if (GetField_Char(hRec,"online",&cOnline)) {
DEBUGLOG(("BOPsp: GetTxnPsp - online = [%c]\n",cOnline));
							PutField_Char(hContext,"online",cOnline);
						}


						if (GetField_CString(hRec,"psp_channel_code",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - channel_code  = [%s]\n",csPtr));
							PutField_CString(hContext,"psp_channel_code",csPtr);
						}
						else {
DEBUGLOG(("BOPsp: GetTxnPsp - channel_code not found\n"));
						}

						if (GetField_CString(hRec,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_merchant id = [%s]\n",csPtr));
							PutField_CString(hContext,"psp_merchant_id",csPtr);
						}
					}
					else {
ERRLOG("BOPsp: psp [%s] disabled\n",csTxnCountry);
						iRet = INT_ACCOUNT_DISABLED;
					}
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		if (cOnline == PD_OFFLINE_MODE) {
			iRet = INT_COUNTRY_PSP_NOT_AVABILE;
DEBUGLOG(("BOPsp: all PSPs for [%s] are not avablie\n",csTxnCountry));
ERRLOG("BOPsp: all PSPs for [%s] are not avablie\n",csTxnCountry);
		}
	}

*/
/* Get PSP Detail */
	hPsp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hPsp,0);
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
		if (!(*DBObjPtr)(csPspId, hPsp)) {
			if (GetField_CString(hPsp,"psp_name",&csTmp)) {
				PutField_CString(hContext,"psp_name",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - PSP NAME = [%s]\n",csTmp));
			}
			if (GetField_CString(hPsp,"client_id",&csClientId)) {
DEBUGLOG(("BOPsp: GetTxnPsp - client id = [%s]\n",csClientId));
			}
			if (GetField_CString(hPsp,"status",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp - Status = [%s]\n",csTmp));
				if(strcmp(csTmp,PD_ACC_OPEN)){
DEBUGLOG(("BOPsp: GetTxnPsp psp account [%s] not opened\n",csPspId));
					iRet = INT_ACCOUNT_DISABLED;
				}
			}
		}
	}

/*Get Client*/
	if(iRet == PD_OK){
		hClient = (hash_t*) malloc (sizeof(hash_t));
                hash_init(hClient,0);
                DBObjPtr = CreateObj(DBPtr,"DBClients","GetClients");
                if ((*DBObjPtr)(csClientId,hClient) != PD_OK){
                        iRet = INT_ERR;
ERRLOG("BOPsp: GetTxnPsp Client ID for Account[%s] not found\n",csPspId);
DEBUGLOG(("BOPsp: GetTxnPsp Client ID Account[%s] not found\n",csPspId));
                }
                else{
                        if (GetField_CString(hClient,"status",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp GetClients - status = [%s]\n",csTmp));
                                        if(strcmp(csTmp,PD_ACC_OPEN)){
ERRLOG("BOPsp: GetTxnPsp Client Account [%s] not opened\n",csClientId);
                                                iRet = INT_ACCOUNT_DISABLED;
                                        }
                        }
                }
        	FREE_ME(hClient);
	}

/*Get Psp Key*/
	if(iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBPspKeys","GetPspKey");
		if (!(*DBObjPtr)(csPspId,PD_PTK_KEY_NAME,rKeySet)) {
			hKey = RecordSet_GetFirst(rKeySet);
			while(hKey){
				if (GetField_CString(hKey,"key_value",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_key = [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_key",csTmp);
				}
				if (GetField_CString(hKey,"key_id",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_key_id= [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_key_id",csTmp);
				}
				hKey = RecordSet_GetNext(rKeySet);
			}
		}
		else{
ERRLOG("BOPsp: GetTxnPSP - no psp_key for [%s]\n",csPspId);
DEBUGLOG(("BOPsp: GetTxnPSP - no psp_key for [%s]\n",csPspId));
		}
	}

////////////////////////	

/* Get PSP URL */
	 if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBPspUrl","GetPspUrl");
                if (!(*DBObjPtr)(csPspId,hPsp)) {
                        if (GetField_CString(hPsp,"url",&csTmp)) {
                                PutField_CString(hContext,"psp_url",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - psp_url = [%s]\n",csTmp));
                        }
                        else {
ERRLOG("BOPsp: GetTxnPSP - no such for [%s]\n",csPspId);
                                iRet = INT_ERR;
                        }
                }
        }


/* Get PSP Reqest Txn URL */
	if (iRet == PD_OK) {
DEBUGLOG(("BOPsp: GetTxnPsp - GetPspRequestTxnUrl\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspRequestTxnUrl","GetPspRequestTxnUrl");
         	if (!(*DBObjPtr)(csPspId,csTxnCode,csPayMethod, hPsp)) {
			if (GetField_CString(hPsp,"request_function",&csTmp)) {
				PutField_CString(hContext,"request_function",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - request_function = [%s]\n",csTmp));
			}
			else {
ERRLOG("BOPsp: GetTxnPSP - no such function url for [%s] [%s]\n",csPspId,csTxnCode);
				iRet = INT_ERR;
			}
			if (GetField_CString(hPsp,"action",&csTmp)) {
				PutField_CString(hContext,"action",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - action = [%s]\n",csTmp));
			}
			
			if(GetField_CString(hPsp,"url_method",&csTmp)){
				PutField_CString(hContext,"url_method",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - url_method = [%s]\n",csTmp));
			}
		}
	}


	if (iRet != PD_OK) {
		PutField_Int(hContext,"internal_error",iRet);
	}
	hash_destroy(hPsp);
        FREE_ME(hPsp);

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	RecordSet_Destroy(rKeySet);
	FREE_ME(rKeySet);

DEBUGLOG(("BOPsp: Normal exit = [%d]\n",iRet));
	return iRet;
}

int GetTxnPspByPspId(hash_t *hContext,
                const hash_t* hRequest,
		const char* csPspId,
		const char* csTxnCode)
{
        int     iRet = PD_OK;
	char*	csTmp;
	char*	csPayMethod;
	char*	csClientId;


	hash_t  *hKey;	
	hash_t  *hPsp;	
	hash_t  *hClient;	

	recordset_t     *rKeySet;
        rKeySet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rKeySet,0);

/* pay method */
	if (GetField_CString(hRequest,"pay_method",&csPayMethod)) {
DEBUGLOG(("BOPsp: GetTxnPspByPspId- pay method = [%s]\n",csPayMethod));
	}
	else if (GetField_CString(hContext,"selected_pay_method",&csPayMethod)) {
DEBUGLOG(("BOPsp: GetTxnPspByPspId- pay method = [%s]\n",csPayMethod));
	}
	else 
	{
DEBUGLOG(("BOPsp: GetTxnPspByPspId- pay_method not found\n"));
ERRLOG("BOPsp: GetTxnPspByPspId- pay_method not found\n");
		iRet = INT_ERR;
	}



/* Get PSP Detail */
	hPsp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hPsp,0);

	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
		if (!(*DBObjPtr)(csPspId, hPsp)) {
			if (GetField_CString(hPsp,"psp_name",&csTmp)) {
				PutField_CString(hContext,"psp_name",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - PSP NAME = [%s]\n",csTmp));
			}
			if (GetField_CString(hPsp,"psp_merchant_id",&csTmp)) {
				PutField_CString(hContext,"psp_merchant_id",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - merchant_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hPsp,"psp_channel_code",&csTmp)) {
				PutField_CString(hContext,"psp_channel_code",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - psp_channel_code = [%s]\n",csTmp));
			}
			if (GetField_CString(hPsp,"client_id",&csClientId)) {
DEBUGLOG(("BOPsp: GetTxnPspByPspId - client_id = [%s]\n",csClientId));
			}
			if (GetField_CString(hPsp,"status",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPspByPspId - Status = [%s]\n",csTmp));
				if(strcmp(csTmp,PD_ACC_OPEN)){
DEBUGLOG(("BOPsp: GetTxnPspByPspId psp account [%s] not opened\n",csPspId));
					iRet = INT_ACCOUNT_DISABLED;
				}
			}
		}
	}

/*Get Client*/
	if(iRet == PD_OK){
		hClient = (hash_t*) malloc (sizeof(hash_t));
                hash_init(hClient,0);
                DBObjPtr = CreateObj(DBPtr,"DBClients","GetClients");
                if ((*DBObjPtr)(csClientId,hClient) != PD_OK){
                        iRet = INT_ERR;
ERRLOG("BOPsp: GetTxnPsp Client ID for Account[%s] not found\n",csPspId);
DEBUGLOG(("BOPsp: GetTxnPsp Client ID Account[%s] not found\n",csPspId));
                }
                else{
                        if (GetField_CString(hClient,"status",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp GetClients - status = [%s]\n",csTmp));
                                        if(strcmp(csTmp,PD_ACC_OPEN)){
ERRLOG("BOPsp: GetTxnPsp Client Account [%s] not opened\n",csClientId);
                                                iRet = INT_ACCOUNT_DISABLED;
                                        }
                        }
                }
        	FREE_ME(hClient);
	}


/*Get Psp Key*/
	if(iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBPspKeys","GetPspKey");
		if (!(*DBObjPtr)(csPspId,"PTK",rKeySet)) {
			hKey = RecordSet_GetFirst(rKeySet);
			while(hKey){
				if (GetField_CString(hKey,"key_value",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPspByPspId - psp_key = [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_key",csTmp);
				}
				if (GetField_CString(hKey,"key_id",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPspByPspId - psp_key_id = [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_key_id",csTmp);
				}
				hKey = RecordSet_GetNext(rKeySet);
			}
		}
		else{
ERRLOG("BOPsp: GetTxnPSPByPspId - no psp_key for [%s]\n",csPspId);
DEBUGLOG(("BOPsp: GetTxnPSPByPspId - no psp_key for [%s]\n",csPspId));
		}
	}

/* Get PSP URL */
	 if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBPspUrl","GetPspUrl");
                if (!(*DBObjPtr)(csPspId,hPsp)) {
                        if (GetField_CString(hPsp,"url",&csTmp)) {
                                PutField_CString(hContext,"psp_url",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - psp_url = [%s]\n",csTmp));
                        }
                        else {
ERRLOG("BOPsp: GetTxnPSPByPspId - no such for [%s]\n",csPspId);
                                iRet = INT_ERR;
                        }
                }
        }


/* Get PSP Reqest Txn URL */
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBPspRequestTxnUrl","GetPspRequestTxnUrl");
         	if (!(*DBObjPtr)(csPspId,csTxnCode,csPayMethod,hPsp)) {
			if (GetField_CString(hPsp,"request_function",&csTmp)) {
				PutField_CString(hContext,"request_function",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - request_function = [%s]\n",csTmp));
			}
			else {
ERRLOG("BOPsp: GetTxnPSPByPspId - no such function url for [%s] [%s]\n",csPspId,PD_INQ_TXN_CODE);
				iRet = INT_ERR;
			}
			if (GetField_CString(hPsp,"action",&csTmp)) {
				PutField_CString(hContext,"action",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - action = [%s]\n",csTmp));
			}

                        if(GetField_CString(hPsp,"url_method",&csTmp)){
                                PutField_CString(hContext,"url_method",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - url_method = [%s]\n",csTmp));
                        }
		}
	}


	if (iRet != PD_OK) {
		PutField_Int(hContext,"internal_error",iRet);
	}

	hash_destroy(hPsp);
        FREE_ME(hPsp);

	RecordSet_Destroy(rKeySet);
	FREE_ME(rKeySet);

DEBUGLOG(("BOPspByPspId: Normal exit = [%d]\n",iRet));
	return iRet;
}

int CalPspFee(hash_t *hContext,
                const hash_t* hRequest)
{
	int	iRet = PD_OK;
	hash_t  *hRec;

	char	*csOrgPspId;
	char	cPreCalType;
	double	dPreCalValue=0.0;
	double	dPreCalAddValue=0.0;
	double	dPreCalMinValue=0.0;
	double	dPreCalMaxValue=0.0;
	double	dOrgTxnAmt;
	double	dFee=0.0;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPsp:CalPspFee()\n"));

 	if (GetField_Double(hContext,"org_dst_net_amt",&dOrgTxnAmt)) {
DEBUGLOG(("BOPsp::CalPspFee() org_dst_net_amt = [%f]\n",dOrgTxnAmt));
        }
        else {
DEBUGLOG(("BOPsp::CalPspFee() org_dst_net_amt not found!!!\n"));
        }

/*org psp id */
        if (GetField_CString(hContext,"org_psp_id",&csOrgPspId)) {
DEBUGLOG(("BOPsp:CalPspFee() org_psp_id = [%s]\n",csOrgPspId));
        }
        else {
DEBUGLOG(("BOPsp:CalPspFee() org_psp_id is missing!!!\n"));
        }

	DBObjPtr = CreateObj(DBPtr,"DBPspDetail","FindPspFee");
	if ((unsigned long)(*DBObjPtr)(csOrgPspId, rRecordSet)==PD_FOUND) {
		hRec = RecordSet_GetFirst(rRecordSet);
		while(hRec){
			if (GetField_Char(hRec,"type",&cPreCalType)) {
DEBUGLOG(("BOPsp:CalPspFee() Precal_type = [%c]\n",cPreCalType));
			}
			if (GetField_Double(hRec,"value",&dPreCalValue)) {
DEBUGLOG(("BOPsp:CalPspFee() Precal_value = [%f]\n",dPreCalValue));
			}
			if (GetField_Double(hRec,"add_value",&dPreCalAddValue)) {
DEBUGLOG(("BOPsp:CalPspFee() Precal_additional_value = [%f]\n",dPreCalAddValue));
			}
			if (GetField_Double(hRec,"min_value",&dPreCalMinValue)) {
DEBUGLOG(("BOPsp:CalPspFee() Precal_min_value = [%f]\n",dPreCalMinValue));
			}
			if (GetField_Double(hRec,"max_value",&dPreCalMaxValue)) {
DEBUGLOG(("BOPsp:CalPspFee() Precal_max_value = [%f]\n",dPreCalMaxValue));
			}

DEBUGLOG(("BOPsp:CalPspFee() Precal fee Now!!!\n"));
			if (cPreCalType == PD_PRECENTAGE) {
				double dTmp = 0;
				dTmp = dOrgTxnAmt * (dPreCalValue/100);
				dFee = newround(dTmp,PD_DECIMAL_LEN);
			}
			else if (cPreCalType == PD_FIXED_AMOUNT) {
				dFee = newround(dPreCalValue,PD_DECIMAL_LEN);
			}
			else if(cPreCalType == PD_PRECENT_WITH_FIX){
				double dTmp = 0;
                                dTmp = dOrgTxnAmt * (dPreCalValue/100);
				dTmp += dPreCalAddValue;
				dFee = newround(dTmp,PD_DECIMAL_LEN);
			}

			if(dFee<dPreCalMinValue && dPreCalMinValue>0){
				dFee = dPreCalMinValue;
			}
			if(dFee>dPreCalMaxValue && dPreCalMaxValue>0){
				dFee = dPreCalMaxValue;
			}
			
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}

DEBUGLOG(("BOPsp:CalPspFee() Precal fee = [%f]\n",dFee));
	PutField_Double(hContext,"precal_fee",dFee);

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("BOPsp:CalPspFee() exit = [%d]\n",iRet));
	return iRet;

}


int GetPayoutPsp(hash_t *hContext,
                const hash_t* hRequest)
{
	int	iRet = PD_OK;
	hash_t  *hRec;

	char	csTag[PD_TAG_LEN+1];
	char	*csBankName;
	char	*csPspId;
	char	*csOperType;
	double	dOrgTxnAmt;
	double	dPspAmt=0.0;
	double	dTotalPayoutAmt=0.0;
	double	dTierAmt=0.0;
	double	dPct=0.0;
	double	dMinAmt=0.0;
	double	dMaxAmt=0.0;
	int	iTier = 0;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPsp:GetPayoutPsp()\n"));

 	if (GetField_CString(hContext,"bank_name",&csBankName)) {
DEBUGLOG(("BOPsp::GetPayoutPsp() bank_name = [%s]\n",csBankName));
        }
        else {
DEBUGLOG(("BOPsp::GetPayoutPsp() bank_name not found!!!\n"));
		iRet = INT_BANK_CODE_NOT_FOUND;
        }

 	if (GetField_Double(hContext,"txn_amt",&dOrgTxnAmt)) {
DEBUGLOG(("BOPsp::GetPayoutPsp() txn_amt = [%lf]\n",dOrgTxnAmt));
        }
        else {
DEBUGLOG(("BOPsp::GetPayoutPsp() txn_amt not found!!!\n"));
		iRet = INT_TXN_AMT_MISSING;
        }

//BankPayoutPsp:GetBankPayoutPsp()
	DBObjPtr = CreateObj(DBPtr,"DBBankPayoutPsp","GetBankPayoutPsp");
	if ((unsigned long)(*DBObjPtr)(csBankName, rRecordSet)==PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		while(hRec){
			if (GetField_CString(hRec,"operator_type",&csOperType)) {
DEBUGLOG(("BOPsp:GetPayoutPsp() operator_type = [%s]\n",csOperType));
			}
			if (GetField_CString(hRec,"psp_id",&csPspId)) {
DEBUGLOG(("BOPsp:GetPayoutPsp() psp_id = [%s]\n",csPspId));
				PutField_CString(hContext,"psp_id",csPspId);
			}
			if (GetField_Double(hRec,"total_amt",&dPspAmt)) {
DEBUGLOG(("BOPsp:GetPayoutPsp() total_amt = [%f]\n",dPspAmt));
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}
	else{
		iRet = INT_ERR;
DEBUGLOG(("BOPsp:GetBankPayoutPsp() Failed!!\n"));
	}
	RecordSet_Destroy(rRecordSet);

	sprintf(csTag,"%s_total_payout_amt_%s",csPspId,csBankName);
 	if (GetField_Double(hContext,csTag,&dTotalPayoutAmt)) {
DEBUGLOG(("BOPsp::GetPayoutPsp() org total_payout_amt = [%lf]\n",dTotalPayoutAmt));
        }


	if(iRet == PD_OK){
//PayoutOperatorTypeDetail:GetPayoutOperatorTypeDetail()
		DBObjPtr = CreateObj(DBPtr,"DBPayoutOperatorTypeDetail","GetPayoutOperatorTypeDetail");
		if ((unsigned long)(*DBObjPtr)(csOperType, rRecordSet)==PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if (GetField_Double(hRec,"amt_min",&dMinAmt)) {
DEBUGLOG(("BOPsp:GetPayoutPsp() amount_min = [%f]\n",dMinAmt));
				}
				if (GetField_Double(hRec,"amt_max",&dMaxAmt)) {
DEBUGLOG(("BOPsp:GetPayoutPsp() amount_max = [%f]\n",dMaxAmt));
				}

				if(dOrgTxnAmt>=dMinAmt && dOrgTxnAmt<=dMaxAmt){
					if (GetField_Int(hRec,"tier_id",&iTier)) {
DEBUGLOG(("BOPsp:GetPayoutPsp() tier_id = [%d]\n",iTier));
					}
					if (GetField_Double(hRec,"amt_pct",&dPct)) {
DEBUGLOG(("BOPsp:GetPayoutPsp() amount_pct = [%lf]\n",dPct));
DEBUGLOG(("BOPsp:GetPayoutPsp() amount for tier[%d] = [%lf]\n",iTier,(dPspAmt*dPct/100)));
					}
				}

				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	if(iRet == PD_OK){
//no rules
		if(!strcmp(csOperType,PD_NO_RULE)){
			//do nothing
		}

//Less Than or Daily Limit
		else if(!strcmp(csOperType,PD_LESS_THAN) || !strcmp(csOperType,PD_DAILY_LIMIT)){
			if((dTotalPayoutAmt + dOrgTxnAmt) >= dPspAmt){
DEBUGLOG(("BOPsp:GetPayoutPsp() Payout Amt[%lf] >= Limited PSP Amt[%f]!!!\n",(dTotalPayoutAmt + dOrgTxnAmt),dPspAmt));
ERRLOG("Payout amount exceeded limited psp amount!!!\n");
				iRet = INT_EXCEED_LIMIT_PSP_AMT;
			}
			else{
				sprintf(csTag,"%s_total_payout_amt_%s",csPspId,csBankName);
				PutField_Double(hContext,csTag,(dTotalPayoutAmt+dOrgTxnAmt));
DEBUGLOG(("BOPsp::GetPayoutPsp() %s (org) = [%lf], (new) = [%lf]\n",csTag,dTotalPayoutAmt,(dTotalPayoutAmt+dOrgTxnAmt)));
			}
		}

//customer rules
		else{
			sprintf(csTag,"%s_tier_%d_amt_%s",csPspId,iTier,csBankName);
 			if (GetField_Double(hContext,csTag,&dTierAmt)) {
        		}
DEBUGLOG(("BOPsp::GetPayoutPsp() %s (org) = [%lf], (new) = [%lf]\n",csTag,dTierAmt,(dTierAmt+dOrgTxnAmt)));

			if((dTierAmt+dOrgTxnAmt)>(dPspAmt*dPct/100)){
DEBUGLOG(("BOPsp:GetPayoutPsp() Payout Amt[%lf] > Limited PSP Amt[%f]!!!\n",(dTierAmt+dOrgTxnAmt),(dPspAmt*dPct/100)));
ERRLOG("Payout amount exceeded limited psp amount!!!\n");
				iRet = INT_EXCEED_LIMIT_PSP_AMT;
			}
			else{
				PutField_Double(hContext,csTag,(dTierAmt+dOrgTxnAmt));
			}

			
		}
	}

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("BOPsp:GetPayoutPsp() exit = [%d]\n",iRet));
	return iRet;
}

