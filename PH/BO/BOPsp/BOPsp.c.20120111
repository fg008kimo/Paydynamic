/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/09/16              Cody Chan
Update 0.0.1 (add PK: client)			   2011/01/07		   LokMan Chow
Update 0.0.2 (get psp key)			   2011/01/07		   LokMan Chow
Add STP PSP				           2011/02/28		   Cody Chan
Add BOTxnLb					   2012/01/04		   Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOPsp.h"

char    cDebug;

void BOPsp(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(DB);
OBJPTR(Txn);
OBJPTR(BO);


int GetTxnPsp(hash_t *hContext,
                const hash_t* hRequest)
{
        int     iRet = PD_OK;
	int	iSTP = PD_FALSE;
	char*	csTxnCountry;
	char*	csPspId;
	char*	csClientId;
	char*	csTxnCode;
	char*	csPayMethod;
	char*	csTmp;
	char	cOnline = PD_OFFLINE;
	char*	csMerchantClientId;
	char*	csMerchantId;

	char*	csPtr;
	//int	iTmp;

	hash_t  *hRec;	
	hash_t  *hKey;	
	hash_t  *hPsp;	
	hash_t  *hClient;	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	recordset_t     *rKeySet;
        rKeySet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rKeySet,0);


	if (!GetField_CString(hContext,"org_txn_code",&csTxnCode))
		GetField_CString(hContext,"txn_code",&csTxnCode);

DEBUGLOG(("BOPsp: TxnCode = [%s]\n",csTxnCode));

	if (GetField_CString(hRequest,"txn_country",&csTxnCountry)) {
DEBUGLOG(("BOPsp: GetMerchatDetail- txn_country = [%s]\n",csTxnCountry));
	}
	else  {
		if (GetField_CString(hContext,"org_txn_country",&csTxnCountry)) {
DEBUGLOG(("BOPsp: GetMerchatDetail- txn_country = [%s]\n",csTxnCountry));
		}
		else {
DEBUGLOG(("BOPsp: GetTxnPsp- txn_country not found\n"));
ERRLOG("BOPsp: GetMerchatDetail- txn_country not found\n");
		iRet = INT_ERR;
		}
	}
/* pay method */
	if (GetField_CString(hRequest,"pay_method",&csPayMethod)) {
DEBUGLOG(("BOPsp: GetTxnPsp- pay method = [%s]\n",csPayMethod));
	}
	else if (GetField_CString(hContext,"selected_pay_method",&csPayMethod)) {
DEBUGLOG(("BOPsp: GetTxnPsp- pay method = [%s]\n",csPayMethod));
	}
	else 
	{
DEBUGLOG(("BOPsp: GetTxnPsp- pay_method not found\n"));
ERRLOG("BOPsp: GetTxnPsp- pay_method not found\n");
		iRet = INT_ERR;
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOPsp STP\n"));
/* merchant client id */
		if (GetField_CString(hContext,"merchant_client_id",&csMerchantClientId)) {
DEBUGLOG(("BOPsp: merchant client id = [%s]\n",csMerchantClientId));
		}
		else {
DEBUGLOG(("BOPsp: merchant client id not found\n"));
		}

/* merchantid */
		if (!GetField_CString(hContext,"merchant_id",&csMerchantId)) 
			GetField_CString(hRequest,"merchant_id",&csMerchantId);
DEBUGLOG(("BOPsp: merchant id = [%s]\n",csMerchantId));
			
DEBUGLOG(("BOPsp STP call GetStpPsp\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTxnLbStp","GetStpPsp");
       		if ((*DBObjPtr)(csTxnCountry,
				csMerchantId,
				rRecordSet) != PD_OK) {
		}
		else {
               		hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				iSTP = PD_TRUE;
DEBUGLOG(("BOPsp: found STP\n"));
				if (GetField_CString(hRec,"psp_id",&csPspId)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_id = [%s]\n",csPspId));
                      			PutField_CString(hContext,"psp_id",csPspId);
                              	}
                       	        if (GetField_CString(hRec,"psp_client_id",&csClientId)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_client_id = [%s]\n",csClientId));
                       	       		PutField_CString(hContext,"psp_client_id",csClientId);
                       	        }
                       		if (GetField_Char(hRec,"online",&cOnline)) {
DEBUGLOG(("BOPsp: GetTxnPsp - online = [%c]\n",cOnline));
                       			PutField_Char(hContext,"online",cOnline);
                       	        }


                       	        if (GetField_CString(hRec,"psp_channel_code",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - channel_code  = [%s]\n",csPtr));
                       		      	PutField_CString(hContext,"psp_channel_code",csPtr);
                       		}
                       		else {
DEBUGLOG(("BOPsp: GetTxnPsp - channel_code not found\n"));
                       	    	}

                       	        if (GetField_CString(hRec,"psp_ccy",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_ccy = [%s]\n",csPtr));
					PutField_CString(hContext,"psp_ccy",csPtr);
					PutField_CString(hContext,"dst_txn_ccy",csPtr);
                       		}
                       		else {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_ccy not found\n"));
                       	    	}


                       	        if (GetField_CString(hRec,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_merchant id = [%s]\n",csPtr));
                       	        	PutField_CString(hContext,"psp_merchant_id",csPtr);
                       	        }
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

/* to be replaced by Load Balancer */
	if (iRet == PD_OK && iSTP == PD_FALSE ) {
DEBUGLOG(("BOPsp: call BOTxnLb\n"));
		BOObjPtr = CreateObj(BOPtr,"BOTxnLb","GetTxnPsp");
		iRet = (unsigned long)(*BOObjPtr)(hContext, hRequest);
DEBUGLOG(("BOPsp: return from BOTxnLb = [%d]\n",iRet));
	}
/* Get PSP Detail */
	hPsp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hPsp,0);
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
		if (!(*DBObjPtr)(csPspId, hPsp)) {
			if (GetField_CString(hPsp,"psp_name",&csTmp)) {
				PutField_CString(hContext,"psp_name",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - PSP NAME = [%s]\n",csTmp));
			}
			if (GetField_CString(hPsp,"client_id",&csClientId)) {
DEBUGLOG(("BOPsp: GetTxnPsp - client id = [%s]\n",csClientId));
			}
			if (GetField_CString(hPsp,"status",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp - Status = [%s]\n",csTmp));
				if(strcmp(csTmp,PD_ACC_OPEN)){
DEBUGLOG(("BOPsp: GetTxnPsp psp account [%s] not opened\n",csPspId));
					iRet = INT_ACCOUNT_DISABLED;
				}
			}
		}
	}

/*Get Client*/
	if(iRet == PD_OK){
		hClient = (hash_t*) malloc (sizeof(hash_t));
                hash_init(hClient,0);
                DBObjPtr = CreateObj(DBPtr,"DBClients","GetClients");
                if ((*DBObjPtr)(csClientId,hClient) != PD_OK){
                        iRet = INT_ERR;
ERRLOG("BOPsp: GetTxnPsp Client ID for Account[%s] not found\n",csPspId);
DEBUGLOG(("BOPsp: GetTxnPsp Client ID Account[%s] not found\n",csPspId));
                }
                else{
                        if (GetField_CString(hClient,"status",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp GetClients - status = [%s]\n",csTmp));
                                        if(strcmp(csTmp,PD_ACC_OPEN)){
ERRLOG("BOPsp: GetTxnPsp Client Account [%s] not opened\n",csClientId);
                                                iRet = INT_ACCOUNT_DISABLED;
                                        }
                        }
                }
        	FREE_ME(hClient);
	}

/*Get Psp Key*/
	if(iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBPspKeys","GetPspKey");
		if (!(*DBObjPtr)(csPspId,PD_PTK_KEY_NAME,rKeySet)) {
			hKey = RecordSet_GetFirst(rKeySet);
			while(hKey){
				if (GetField_CString(hKey,"key_value",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_key = [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_key",csTmp);
				}
				if (GetField_CString(hKey,"key_id",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_key_id= [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_key_id",csTmp);
				}
				if (GetField_CString(hKey,"key_uid",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_key_uid= [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_key_uid",csTmp);
				}
				if (GetField_CString(hKey,"privatepem",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_privatepem= [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_privatepem",csTmp);
				}
				if (GetField_CString(hKey,"publiccert",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_publiccert= [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_publiccert",csTmp);
				}
				if (GetField_CString(hKey,"passphrase",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp - psp_passphrase= [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_passphrase",csTmp);
				}
				hKey = RecordSet_GetNext(rKeySet);
			}
		}
		else{
ERRLOG("BOPsp: GetTxnPSP - no psp_key for [%s]\n",csPspId);
DEBUGLOG(("BOPsp: GetTxnPSP - no psp_key for [%s]\n",csPspId));
		}
	}

////////////////////////	

/* Get PSP URL */
	 if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBPspUrl","GetPspUrl");
                if (!(*DBObjPtr)(csPspId,hPsp)) {
                        if (GetField_CString(hPsp,"url",&csTmp)) {
                                PutField_CString(hContext,"psp_url",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - psp_url = [%s]\n",csTmp));
                        }
                        else {
ERRLOG("BOPsp: GetTxnPSP - no such for [%s]\n",csPspId);
                                iRet = INT_ERR;
                        }
                }
        }


/* Get PSP Reqest Txn URL */
	if (iRet == PD_OK) {
DEBUGLOG(("BOPsp: GetTxnPsp - GetPspRequestTxnUrl\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspRequestTxnUrl","GetPspRequestTxnUrl");
         	if (!(*DBObjPtr)(csPspId,csTxnCode,csPayMethod, hPsp)) {
			if (GetField_CString(hPsp,"request_function",&csTmp)) {
				PutField_CString(hContext,"request_function",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - request_function = [%s]\n",csTmp));
			}
			else {
ERRLOG("BOPsp: GetTxnPSP - no such function url for [%s] [%s]\n",csPspId,csTxnCode);
				iRet = INT_ERR;
			}
			if (GetField_CString(hPsp,"action",&csTmp)) {
				PutField_CString(hContext,"action",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - action = [%s]\n",csTmp));
			}
			
			if(GetField_CString(hPsp,"url_method",&csTmp)){
				PutField_CString(hContext,"url_method",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - url_method = [%s]\n",csTmp));
			}
		}
	}


	if (iRet != PD_OK) {
		PutField_Int(hContext,"internal_error",iRet);
	}
	hash_destroy(hPsp);
        FREE_ME(hPsp);

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	RecordSet_Destroy(rKeySet);
	FREE_ME(rKeySet);

DEBUGLOG(("BOPsp: Normal exit = [%d]\n",iRet));
	return iRet;
}

int GetTxnPspByPspId(hash_t *hContext,
                const hash_t* hRequest,
		const char* csPspId,
		const char* csTxnCode)
{
        int     iRet = PD_OK;
	char*	csTmp;
	char*	csPayMethod;
	char*	csClientId;


	hash_t  *hKey;	
	hash_t  *hPsp;	
	hash_t  *hClient;	

	recordset_t     *rKeySet;
        rKeySet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rKeySet,0);

/* pay method */
	if (GetField_CString(hRequest,"pay_method",&csPayMethod)) {
DEBUGLOG(("BOPsp: GetTxnPspByPspId- pay method = [%s]\n",csPayMethod));
	}
	else if (GetField_CString(hContext,"selected_pay_method",&csPayMethod)) {
DEBUGLOG(("BOPsp: GetTxnPspByPspId- pay method = [%s]\n",csPayMethod));
	}
	else 
	{
DEBUGLOG(("BOPsp: GetTxnPspByPspId- pay_method not found\n"));
ERRLOG("BOPsp: GetTxnPspByPspId- pay_method not found\n");
		iRet = INT_ERR;
	}



/* Get PSP Detail */
	hPsp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hPsp,0);

	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
		if (!(*DBObjPtr)(csPspId, hPsp)) {
			if (GetField_CString(hPsp,"psp_name",&csTmp)) {
				PutField_CString(hContext,"psp_name",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - PSP NAME = [%s]\n",csTmp));
			}
			if (GetField_CString(hPsp,"psp_merchant_id",&csTmp)) {
				PutField_CString(hContext,"psp_merchant_id",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - merchant_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hPsp,"psp_channel_code",&csTmp)) {
				PutField_CString(hContext,"psp_channel_code",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - psp_channel_code = [%s]\n",csTmp));
			}
			if (GetField_CString(hPsp,"client_id",&csClientId)) {
DEBUGLOG(("BOPsp: GetTxnPspByPspId - client_id = [%s]\n",csClientId));
			}
			if (GetField_CString(hPsp,"status",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPspByPspId - Status = [%s]\n",csTmp));
				if(strcmp(csTmp,PD_ACC_OPEN)){
DEBUGLOG(("BOPsp: GetTxnPspByPspId psp account [%s] not opened\n",csPspId));
					iRet = INT_ACCOUNT_DISABLED;
				}
			}
		}
	}

/*Get Client*/
	if(iRet == PD_OK){
		hClient = (hash_t*) malloc (sizeof(hash_t));
                hash_init(hClient,0);
                DBObjPtr = CreateObj(DBPtr,"DBClients","GetClients");
                if ((*DBObjPtr)(csClientId,hClient) != PD_OK){
                        iRet = INT_ERR;
ERRLOG("BOPsp: GetTxnPsp Client ID for Account[%s] not found\n",csPspId);
DEBUGLOG(("BOPsp: GetTxnPsp Client ID Account[%s] not found\n",csPspId));
                }
                else{
                        if (GetField_CString(hClient,"status",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPsp GetClients - status = [%s]\n",csTmp));
                                        if(strcmp(csTmp,PD_ACC_OPEN)){
ERRLOG("BOPsp: GetTxnPsp Client Account [%s] not opened\n",csClientId);
                                                iRet = INT_ACCOUNT_DISABLED;
                                        }
                        }
                }
        	FREE_ME(hClient);
	}


/*Get Psp Key*/
	if(iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBPspKeys","GetPspKey");
		if (!(*DBObjPtr)(csPspId,"PTK",rKeySet)) {
			hKey = RecordSet_GetFirst(rKeySet);
			while(hKey){
				if (GetField_CString(hKey,"key_value",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPspByPspId - psp_key = [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_key",csTmp);
				}
				if (GetField_CString(hKey,"key_id",&csTmp)) {
DEBUGLOG(("BOPsp: GetTxnPspByPspId - psp_key_id = [%s]\n",csTmp));
                                        PutField_CString(hContext,"psp_key_id",csTmp);
				}
				hKey = RecordSet_GetNext(rKeySet);
			}
		}
		else{
ERRLOG("BOPsp: GetTxnPSPByPspId - no psp_key for [%s]\n",csPspId);
DEBUGLOG(("BOPsp: GetTxnPSPByPspId - no psp_key for [%s]\n",csPspId));
		}
	}

/* Get PSP URL */
	 if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBPspUrl","GetPspUrl");
                if (!(*DBObjPtr)(csPspId,hPsp)) {
                        if (GetField_CString(hPsp,"url",&csTmp)) {
                                PutField_CString(hContext,"psp_url",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - psp_url = [%s]\n",csTmp));
                        }
                        else {
ERRLOG("BOPsp: GetTxnPSPByPspId - no such for [%s]\n",csPspId);
                                iRet = INT_ERR;
                        }
                }
        }


/* Get PSP Reqest Txn URL */
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBPspRequestTxnUrl","GetPspRequestTxnUrl");
         	if (!(*DBObjPtr)(csPspId,csTxnCode,csPayMethod,hPsp)) {
			if (GetField_CString(hPsp,"request_function",&csTmp)) {
				PutField_CString(hContext,"request_function",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - request_function = [%s]\n",csTmp));
			}
			else {
ERRLOG("BOPsp: GetTxnPSPByPspId - no such function url for [%s] [%s]\n",csPspId,PD_INQ_TXN_CODE);
				iRet = INT_ERR;
			}
			if (GetField_CString(hPsp,"action",&csTmp)) {
				PutField_CString(hContext,"action",csTmp);
DEBUGLOG(("BOPsp: GetTxnPspByPspId - action = [%s]\n",csTmp));
			}

                        if(GetField_CString(hPsp,"url_method",&csTmp)){
                                PutField_CString(hContext,"url_method",csTmp);
DEBUGLOG(("BOPsp: GetTxnPsp - url_method = [%s]\n",csTmp));
                        }
		}
	}


	if (iRet != PD_OK) {
		PutField_Int(hContext,"internal_error",iRet);
	}

	hash_destroy(hPsp);
        FREE_ME(hPsp);

	RecordSet_Destroy(rKeySet);
	FREE_ME(rKeySet);

DEBUGLOG(("BOPspByPspId: Normal exit = [%d]\n",iRet));
	return iRet;
}

int CalPspFee(hash_t *hContext,
                const hash_t* hRequest)
{
	int	iRet = PD_OK;
	hash_t  *hRec;

	char	*csOrgPspId;
	char	cPreCalType;
	double	dPreCalValue=0.0;
	double	dPreCalAddValue=0.0;
	double	dPreCalMinValue=0.0;
	double	dPreCalMaxValue=0.0;
	double	dOrgTxnAmt;
	double	dFee=0.0;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPsp:CalPspFee()\n"));

 	if (GetField_Double(hContext,"org_dst_net_amt",&dOrgTxnAmt)) {
DEBUGLOG(("BOPsp::CalPspFee() org_dst_net_amt = [%f]\n",dOrgTxnAmt));
        }
        else {
DEBUGLOG(("BOPsp::CalPspFee() org_dst_net_amt not found!!!\n"));
        }

/*org psp id */
        if (GetField_CString(hContext,"org_psp_id",&csOrgPspId)) {
DEBUGLOG(("BOPsp:CalPspFee() org_psp_id = [%s]\n",csOrgPspId));
        }
        else {
DEBUGLOG(("BOPsp:CalPspFee() org_psp_id is missing!!!\n"));
        }

	DBObjPtr = CreateObj(DBPtr,"DBPspDetail","FindPspFee");
	if ((unsigned long)(*DBObjPtr)(csOrgPspId, rRecordSet)==PD_FOUND) {
		hRec = RecordSet_GetFirst(rRecordSet);
		while(hRec){
			if (GetField_Char(hRec,"type",&cPreCalType)) {
DEBUGLOG(("BOPsp:CalPspFee() Precal_type = [%c]\n",cPreCalType));
			}
			if (GetField_Double(hRec,"value",&dPreCalValue)) {
DEBUGLOG(("BOPsp:CalPspFee() Precal_value = [%f]\n",dPreCalValue));
			}
			if (GetField_Double(hRec,"add_value",&dPreCalAddValue)) {
DEBUGLOG(("BOPsp:CalPspFee() Precal_additional_value = [%f]\n",dPreCalAddValue));
			}
			if (GetField_Double(hRec,"min_value",&dPreCalMinValue)) {
DEBUGLOG(("BOPsp:CalPspFee() Precal_min_value = [%f]\n",dPreCalMinValue));
			}
			if (GetField_Double(hRec,"max_value",&dPreCalMaxValue)) {
DEBUGLOG(("BOPsp:CalPspFee() Precal_max_value = [%f]\n",dPreCalMaxValue));
			}

DEBUGLOG(("BOPsp:CalPspFee() Precal fee Now!!!\n"));
			if (cPreCalType == PD_PRECENTAGE) {
				double dTmp = 0;
				dTmp = dOrgTxnAmt * (dPreCalValue/100);
				dFee = newround(dTmp,PD_DECIMAL_LEN);
			}
			else if (cPreCalType == PD_FIXED_AMOUNT) {
				dFee = newround(dPreCalValue,PD_DECIMAL_LEN);
			}
			else if(cPreCalType == PD_PRECENT_WITH_FIX){
				double dTmp = 0;
                                dTmp = dOrgTxnAmt * (dPreCalValue/100);
				dTmp += dPreCalAddValue;
				dFee = newround(dTmp,PD_DECIMAL_LEN);
			}

			if(dFee<dPreCalMinValue && dPreCalMinValue>0){
				dFee = dPreCalMinValue;
			}
			if(dFee>dPreCalMaxValue && dPreCalMaxValue>0){
				dFee = dPreCalMaxValue;
			}
			
			hRec = RecordSet_GetNext(rRecordSet);
		}

DEBUGLOG(("BOPsp:CalPspFee() Precal fee = [%f]\n",dFee));
		PutField_Double(hContext,"precal_fee",dFee);
	}


	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("BOPsp:CalPspFee() exit = [%d]\n",iRet));
	return iRet;

}


int GetPspReconTxnDetail(hash_t *hContext,
			const hash_t *hRequest, 
			hash_t *hResponse)
{
	int iRet = PD_OK;
	hash_t *hRec;
	char	csTag[PD_TAG_LEN+1];
	char	*csTmp;
	char	*csTxnId;
	char	*csReconId;
	char	*csPspId;
	char	*csTxnCcy;
	char	*csTxnCode;
	char	*csDate;
	int	iCnt=0;
	int	iTotalCnt=0;
	double	dTmp=0.0;
	double	dPspAmt=0.0;
	double	dPspFee=0.0;
	double	dInputAmt=0.0;
	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPsp:GetPspReconTxnDetail()\n"));
	if(GetField_CString(hContext,"txn_code",&csTxnCode)){
DEBUGLOG(("BOPsp:GetPspReconTxnDetail() txn_code = [%s]\n",csTxnCode));
	}
	if(GetField_CString(hRequest,"psp_id",&csPspId)){
DEBUGLOG(("BOPsp::GetPspReconTxnDetail::psp_id = [%s]\n",csPspId));
	}
	if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
DEBUGLOG(("BOPsp::GetPspReconTxnDetail::txn_ccy = [%s]\n",csTxnCcy));
	}
	if(GetField_CString(hRequest,"select_date",&csDate)){
DEBUGLOG(("BOPsp::GetPspReconTxnDetail::select_date = [%s]\n",csDate));
	}


/* Psp Balance Transfer */
	if(!strcmp(csTxnCode,"PBU")){
		DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","GetTxnPspDetailForReconUpdate");
		if((unsigned long) ((*DBObjPtr)(csPspId,
						csTxnCcy,
						csDate,
						rRecordSet))==PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				iCnt++;
				if(GetField_CString(hRec,"txn_seq",&csTxnId)){
DEBUGLOG(("GetTxnPspDetailForReconByReconInd: txn_id = [%s]\n",csTxnId));
					sprintf(csTag,"txn_seq_%d",iCnt);
					PutField_CString(hContext,csTag,csTxnId);
				}
				if(GetField_Double(hRec,"txn_amt",&dTmp)){
DEBUGLOG(("GetTxnPspDetailForReconByReconInd: txn_amt = [%lf]\n",dTmp));
					dPspAmt += dTmp;

					sprintf(csTag,"txn_amt_%d",iCnt);
					PutField_Double(hContext,csTag,dTmp);
				}
				if(GetField_Double(hRec,"service_fee",&dTmp)){
DEBUGLOG(("GetTxnPspDetailForReconByReconInd: service_fee = [%lf]\n",dTmp));
					dPspFee +=dTmp;

					sprintf(csTag,"service_fee_%d",iCnt);
					PutField_Double(hContext,csTag,dTmp);
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
			PutField_Int(hContext,"total_cnt",iCnt);
		}
		else{
DEBUGLOG(("BOPsp::GetPspReconTxnDetail::Call DBTxnPspDetail:GetTxnPspDetailForRecon Failed\n"));
ERRLOG("BOPsp::GetPspReconTxnDetail::Call DBTxnPspDetail:GetTxnPspDetailForRecon Failed\n");
			iRet = INT_ERR;
		}

		if(iRet == PD_OK){
			if(GetField_Int(hContext,"total_cnt",&iTotalCnt)){
				if(iTotalCnt!=iCnt){
DEBUGLOG(("Input Count[%d] and PH Count[%d] not match\n",iTotalCnt,iCnt));
ERRLOG("BOPsp::GetPspReconTxnDetail::Input Count[%d] and PH Count[%d] not match\n",iTotalCnt,iCnt);
					iRet = INT_ERR;
				}
			}
		}
		if(iRet == PD_OK){
			if(GetField_Double(hContext,"txn_amt",&dInputAmt)){
				if(dInputAmt!=dPspAmt){
DEBUGLOG(("Input Amt[%lf] and PH Amt[%lf] not match\n",dInputAmt,dPspAmt));
ERRLOG("BOPsp::GetPspReconTxnDetail::Input Amt[%lf] and PH Amt[%lf] not match\n",dInputAmt,dPspAmt);
					iRet = INT_INVALID_PAY_AMOUNT;
				}
			}
		}
	}
/* Psp Balance Recon */
	else if(!strcmp(csTxnCode,"PRC")){
		//DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","ResumeReconInd");
		//iRet = (unsigned long)(*DBObjPtr)(csDate);

		if(iRet==PD_OK){
DEBUGLOG(("BOPsp::GetPspReconTxnDetail::Call DBTxnPspDetail:GetTxnPspDetailForRecon\n"));
                	DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","GetTxnPspDetailForRecon");
                	if((unsigned long) ((*DBObjPtr)(csPspId,
                        	                        csTxnCcy,
                        	                        csDate,
                        	                        rRecordSet))==PD_OK){
                        	hRec = RecordSet_GetFirst(rRecordSet);
                        	while(hRec){
                        	        iCnt++;
                                	if(GetField_CString(hRec,"txn_seq",&csTmp)){
DEBUGLOG(("GetTxnPspDetailForRecon: txn_seq = [%s]\n",csTmp));
                                	}
                                	if(GetField_Double(hRec,"txn_amt",&dTmp)){
DEBUGLOG(("GetTxnPspDetailForRecon: txn_amt = [%lf]\n",dTmp));
                                        	dPspAmt += dTmp;
                                	}
                                	if(GetField_Double(hRec,"service_fee",&dTmp)){
DEBUGLOG(("GetTxnPspDetailForRecon: service_fee = [%lf]\n",dTmp));
                                	        dPspFee +=dTmp;
                                	}

					/*DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","AddReconInd");
					if((unsigned long)(*DBObjPtr)(csTmp,csDate)!=PD_OK){
DEBUGLOG(("AddReconInd: Failed [%s]\n",csTmp));
					}*/

                                	hRec = RecordSet_GetNext(rRecordSet);
                        	}

                        	PutField_Int(hResponse,"total_cnt",iCnt);
                        	PutField_Double(hResponse,"txn_amt",dPspAmt);
                        	PutField_Double(hResponse,"service_fee",dPspFee);
                        	PutField_Double(hResponse,"psp_balance",dPspAmt-dPspFee);
                	}
                	else{
                        	iRet = INT_ERR;
DEBUGLOG(("BOPsp::GetPspReconTxnDetail::Call DBTxnPspDetail:GetTxnPspDetailForRecon Failed\n"));
ERRLOG("BOPsp::GetPspReconTxnDetail::Call DBTxnPspDetail:GetTxnPspDetailForRecon Failed\n");
                	}
		}
	}

/* Reverse Psp Balance Transfer */
	else if(!strcmp(csTxnCode,"PBR")){
		if(GetField_CString(hRequest,"org_txn_seq",&csReconId)){
DEBUGLOG(("BOPsp::GetPspReconTxnDetail:: org_txn_id = [%s]\n",csReconId));
                }

		if(iRet==PD_OK){
			iCnt = 0;
			double dAmt=0.0;
			DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","GetReconDetail");
                	if((unsigned long) ((*DBObjPtr)(csReconId,
                                                	rRecordSet))==PD_OK){
                        	hRec = RecordSet_GetFirst(rRecordSet);
                        	while(hRec){
                                        iCnt ++;
                                	if(GetField_CString(hRec,"psp_id",&csTmp)){
						PutField_CString(hContext,"psp_id",csTmp);
DEBUGLOG(("GetReconDetail: psp_id = [%s]\n",csTmp));
					}
                                	if(GetField_CString(hRec,"txn_ccy",&csTmp)){
						PutField_CString(hContext,"txn_ccy",csTmp);
DEBUGLOG(("GetReconDetail: txn_ccy = [%s]\n",csTmp));
					}
                                	if(GetField_CString(hRec,"txn_country",&csTmp)){
						PutField_CString(hContext,"txn_country",csTmp);
DEBUGLOG(("GetReconDetail: txn_country = [%s]\n",csTmp));
					}
					if(GetField_CString(hRec,"txn_seq",&csTmp)){
                                                sprintf(csTag,"txn_seq_%d",iCnt);
                                                PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetReconDetail: txn_id = [%s]\n",csTmp));
                                        }
                                        if(GetField_Double(hRec,"txn_amt",&dTmp)){
                                                sprintf(csTag,"txn_amt_%d",iCnt);
                                                PutField_Double(hContext,csTag,dTmp);
						dAmt +=dTmp;
DEBUGLOG(("GetReconDetail: txn_amt = [%lf]\n",dTmp));
                                        }
                                        if(GetField_Double(hRec,"service_fee",&dTmp)){
                                                sprintf(csTag,"service_fee_%d",iCnt);
                                                PutField_Double(hContext,csTag,dTmp);
DEBUGLOG(("GetReconDetail: service_fee = [%lf]\n",dTmp));
                                        }
                                        hRec = RecordSet_GetNext(rRecordSet);
                                        PutField_Int(hContext,"total_cnt",iCnt);
                                        PutField_Double(hContext,"txn_amt",dAmt);

				}
                	}
                	else{
                        	iRet = INT_INVALID_TXN;
DEBUGLOG(("BOPsp::GetReconDetailFailed[%s]\n",csReconId));
ERRLOG("BOPsp::GetPspReconTxnDetail::GetReconDetail Failed[%s]\n",csReconId);
                	}
		}
		
	}

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("BOPsp:GetPspReconTxnDetail() exit = [%d]\n",iRet));
	return iRet;
}

