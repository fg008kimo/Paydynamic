/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/10/23              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "dbutility.h"
#include "BOOLDepositMatch.h"
#include "myrecordset.h"
#include "myhash.h"
#include "math.h"
#include <time.h>

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void BOOLDepositMatch(char cdebug)
{
	cDebug = cdebug;
}


int StmtMatchDeposit(const char* csMerchantId)
{
	int iRet = PD_OK;

	char *csTmp, *csTmp2, *csIntBankCode, *csBankAcctNum, *csServiceCode, *csCountry, *csStmtRef, *csStmtDate, *csTxnAmount, *csFldName, *csValue;
	char *csTxnId = strdup("");
	char *csDepositDatetime = strdup("");
	char *csTag = (char*) malloc (64);

	int iMatchFifo, iFieldCnt, iIndex, iMatched, iInsertPair;

	double dMatchFifoAmtLimit;

	recordset_t *rMatchCriteria;
	rMatchCriteria = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rMatchCriteria, 0);

	recordset_t *rBankAcct;
	rBankAcct = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rBankAcct, 0);

	recordset_t *rStmtDtl;
	rStmtDtl = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rStmtDtl, 0);

	recordset_t *rMatchResult;
	rMatchResult = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rMatchResult, 0);

	hash_t *hMatchCriteria;

	hash_t *hBankAcct;

	hash_t *hStmtDtl;

	hash_t *hMatchResult;

	hash_t *hMatchBfAf;
	hMatchBfAf = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hMatchBfAf, 0);

	hash_t *hMatchValue;
	hMatchValue = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hMatchValue, 0);

DEBUGLOG(("StmtMatchDeposit:: input csMerchantId = [%s]\n", csMerchantId));

	// get match criteria
	if (iRet == PD_OK) {
DEBUGLOG(("StmtMatchDeposit:: call DBOLAutoMatch::GetAutoMatchCriteria()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLAutoMatch", "GetAutoMatchCriteria");
		iRet = (unsigned long)(*DBObjPtr)(csMerchantId, rMatchCriteria);

		if (iRet != PD_OK) {
DEBUGLOG(("StmtMatchDeposit:: call DBOLAutoMatch::GetAutoMatchCriteria() failed!!!\n"));
ERRLOG("BOOLDepositMatch:: StmtMatchDeposit:: call DBOLAutoMatch::GetAutoMatchCriteria() failed!!!\n");
			iRet = PD_ERR;
		}
	}

	// get bank accts
	if (iRet == PD_OK) {
DEBUGLOG(("StmtMatchDeposit:: call DBOLMerchantBankAcct::GetAllAvaDepositBankAccts()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLMerchantBankAcct", "GetAllAvaDepositBankAccts");
		iRet = (unsigned long)(*DBObjPtr)(csMerchantId, rBankAcct);

		if (iRet != PD_OK) {
DEBUGLOG(("StmtMatchDeposit:: call DBOLMerchantBankAcct::GetAllAvaDepositBankAccts() failed!!!\n"));
ERRLOG("BOOLDepositMatch:: StmtMatchDeposit:: call DBOLMerchantBankAcct::GetAllAvaDepositBankAccts() failed!!!\n");
			iRet = PD_ERR;
		}
	}

	// loop bank accts
	if (iRet == PD_OK) {
		hBankAcct = RecordSet_GetFirst(rBankAcct);
		while (hBankAcct) {

			// reset rStmtDtl
			RecordSet_Destroy(rStmtDtl);
			recordset_init(rStmtDtl, 0);

			// get int_bank_code
			if (GetField_CString(hBankAcct, "int_bank_code", &csIntBankCode)) {
DEBUGLOG(("StmtMatchDeposit:: int_bank_code = [%s]\n", csIntBankCode));
			} else {
DEBUGLOG(("StmtMatchDeposit:: int_bank_code not found\n"));
				hBankAcct = RecordSet_GetNext(rBankAcct);
				continue;;
			}

			// get bank_acct_num
			if (GetField_CString(hBankAcct, "bank_acct_num", &csBankAcctNum)) {
DEBUGLOG(("StmtMatchDeposit:: bank_acct_num = [%s]\n", csBankAcctNum));
			} else {
DEBUGLOG(("StmtMatchDeposit:: bank_acct_num not found\n"));
				hBankAcct = RecordSet_GetNext(rBankAcct);
				continue;
			}

			// get service_code
			if (GetField_CString(hBankAcct, "service_code", &csServiceCode)) {
DEBUGLOG(("StmtMatchDeposit:: service_code = [%s]\n", csServiceCode));
			} else {
DEBUGLOG(("StmtMatchDeposit:: service_code not found\n"));
				hBankAcct = RecordSet_GetNext(rBankAcct);
				continue;
			}

			// get country
			if (GetField_CString(hBankAcct, "country", &csCountry)) {
DEBUGLOG(("StmtMatchDeposit:: country = [%s]\n", csCountry));
			} else {
DEBUGLOG(("StmtMatchDeposit:: country not found\n"));
				hBankAcct = RecordSet_GetNext(rBankAcct);
				continue;
			}

			// get match_fifo
			if (GetField_Int(hBankAcct, "match_fifo", &iMatchFifo)) {
DEBUGLOG(("StmtMatchDeposit:: match_fifo = [%d]\n", iMatchFifo));

				if (iMatchFifo) {
					if (GetField_Double(hBankAcct, "match_fifo_amt_limit", &dMatchFifoAmtLimit)) {
DEBUGLOG(("StmtMatchDeposit:: match_fifo_amt_limit = [%lf]\n", dMatchFifoAmtLimit));
					} else {
DEBUGLOG(("StmtMatchDeposit:: match_fifo_amt_limit not found\n"));
						hBankAcct = RecordSet_GetNext(rBankAcct);
						continue;
					}
				}
			} else {
DEBUGLOG(("StmtMatchDeposit:: match_fifo not found\n"));
				hBankAcct = RecordSet_GetNext(rBankAcct);
				continue;
			}

			// get unallocated stmt records
DEBUGLOG(("StmtMatchDeposit:: call DBOLStatement::GetUnallocatedRecords()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "GetUnallocatedRecords");
			iRet = (unsigned long)(*DBObjPtr)(csIntBankCode, csBankAcctNum, rStmtDtl);

			if (iRet != PD_OK) {
DEBUGLOG(("StmtMatchDeposit:: call DBOLStatement::GetUnallocatedRecords() failed!!!\n"));
				hBankAcct = RecordSet_GetNext(rBankAcct);
				continue;
			}

			// loop unallocated stmt records
			if (iRet == PD_OK) {
				hStmtDtl = RecordSet_GetFirst(rStmtDtl);
				while (hStmtDtl) {

					// get statement_ref
					if (GetField_CString(hStmtDtl, "statement_ref", &csStmtRef)) {
DEBUGLOG(("StmtMatchDeposit:: statement_ref = [%s]\n", csStmtRef));
					} else {
DEBUGLOG(("StmtMatchDeposit:: statement_ref not found\n"));
						hStmtDtl = RecordSet_GetNext(rStmtDtl);
						continue;
					}

					// get statement_date
					if (GetField_CString(hStmtDtl, "statement_date", &csStmtDate)) {
DEBUGLOG(("StmtMatchDeposit:: statement_date = [%s]\n", csStmtDate));
					} else {
DEBUGLOG(("StmtMatchDeposit:: statement_date not found\n"));
						hStmtDtl = RecordSet_GetNext(rStmtDtl);
						continue;
					}

					// get txn_amount
					if (GetField_CString(hStmtDtl, "txn_amount", &csTxnAmount)) {
DEBUGLOG(("StmtMatchDeposit:: txn_amount = [%s]\n", csTxnAmount));
					} else {
DEBUGLOG(("StmtMatchDeposit:: txn_amount not found\n"));
						hStmtDtl = RecordSet_GetNext(rStmtDtl);
						continue;
					}

					// get matching period by date
DEBUGLOG(("StmtMatchDeposit:: call DBOLRuleDepositMatching::GetRuleDepositMatchingByDate()\n"));
					DBObjPtr = CreateObj(DBPtr, "DBOLRuleDepositMatching", "GetRuleDepositMatchingByDate");
					iRet = (unsigned long)(*DBObjPtr)(csMerchantId, csIntBankCode, csCountry, csStmtDate, hMatchBfAf);

					if (iRet != PD_OK) {
DEBUGLOG(("StmtMatchDeposit:: call DBOLRuleDepositMatching::GetRuleDepositMatchingByDate() failed!!!\n"));
						hStmtDtl = RecordSet_GetNext(rStmtDtl);
						continue;
					}

					// loop match criteria
					hMatchCriteria = RecordSet_GetFirst(rMatchCriteria);
					while (hMatchCriteria) {

						// reset hMatchValue
						hash_destroy(hMatchValue);
						hash_init(hMatchValue, 0);

						// reset rMatchResult
						RecordSet_Destroy(rMatchResult);
						recordset_init(rMatchResult, 0);

						iMatched = 0;
						iInsertPair = 0;

						PutField_CString(hMatchValue, "merchant_id", csMerchantId);
						PutField_CString(hMatchValue, "service_code", csServiceCode);

						// get field_cnt
						if (GetField_Int(hMatchCriteria, "field_cnt", &iFieldCnt)) {
DEBUGLOG(("StmtMatchDeposit:: field_cnt = [%d]\n", iFieldCnt));
							PutField_Int(hMatchValue, "field_cnt", iFieldCnt);
						} else {
DEBUGLOG(("StmtMatchDeposit:: field_cnt not found\n"));
							hMatchCriteria = RecordSet_GetNext(rMatchCriteria);
							continue;
						}

						// get tag_name
						for (iIndex = 1; iIndex <= iFieldCnt; iIndex++) {

							sprintf(csTag, "tag_name_%d", iIndex);
							if (GetField_CString(hMatchCriteria, csTag, &csFldName)) {
DEBUGLOG(("StmtMatchDeposit:: [%s] = [%s]\n", csTag, csFldName));
							} else {
								// to be implemented:
								// 	skip to next hMatchCriteria
							}

							if (GetField_CString(hStmtDtl, csFldName, &csValue)) {
DEBUGLOG(("StmtMatchDeposit:: [%s] = [%s]\n", csFldName, csValue));
								PutField_CString(hMatchValue, csFldName, csValue);
							} else {
								// to be implemented:
								// 	skip to next hMatchCriteria
							}
						}

						// match deposit
DEBUGLOG(("StmtMatchDeposit:: call DBOLTransaction::MatchStmt()\n"));
						DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "MatchStmt");
						iRet = (unsigned long)(*DBObjPtr)(hMatchValue, hMatchBfAf, rMatchResult);

						if (iRet != PD_OK) {
DEBUGLOG(("StmtMatchDeposit:: call DBOLTransaction::MatchStmt() failed!!!\n"));
							// to be implemented:
							// 	match stmt failed
						}

						hMatchResult = RecordSet_GetFirst(rMatchResult);
						while (hMatchResult) {

							if (GetField_CString(hMatchResult, "txn_id", &csTmp) &&
								GetField_CString(hMatchResult, "deposit_datetime", &csTmp2)) {
DEBUGLOG(("StmtMatchDeposit:: txn_id = [%s]\n", csTmp));
								if (!iMatched) {
									iMatched = 1;
									strcpy(csTxnId, csTmp);
									strcpy(csDepositDatetime, csTmp2);
								} else {
									// match more than one deposit req
									if (iMatchFifo) {
										if (atof(csTxnAmount) < dMatchFifoAmtLimit) {
											// FIFO
DEBUGLOG(("StmtMatchDeposit:: FIFO\n"));
											if (strcmp(csTmp2, csDepositDatetime) < 0) {
												strcpy(csTxnId, csTmp);
												strcpy(csDepositDatetime, csTmp2);
											}
										} else {
											// insert into ol_deposit_match_pair
DEBUGLOG(("StmtMatchDeposit:: FIFO but over amt limit\n"));
											iInsertPair = 1;
											break;
										}
									} else {
										// insert into ol_deposit_match_pair
DEBUGLOG(("StmtMatchDeposit:: not FIFO\n"));
										iInsertPair = 1;
										break;
									}
								}
							}

							hMatchResult = RecordSet_GetNext(rMatchResult);
						}

						if (iMatched) {
							if (iInsertPair) {
// insert all records to ol_deposit_match_pair
								hMatchResult = RecordSet_GetFirst(rMatchResult);
								while (hMatchResult) {
									PutField_CString(hMatchResult, "stmt_ref", csStmtRef);
									PutField_CString(hMatchResult, "create_user", PD_UPDATE_USER);
									DBObjPtr = CreateObj(DBPtr, "DBOLDepositMatchPair", "Add");
									iRet = (unsigned long)(*DBObjPtr)(hMatchResult);

									// to be implemented: handle error

									hMatchResult = RecordSet_GetNext(rMatchResult);
								}
							} else {
// match the record
								iRet = CompleteMatching(csStmtRef, csTxnId, 0);
 							}

							break;
						}

						hMatchCriteria = RecordSet_GetNext(rMatchCriteria);
					}

					// process match stmt

					hStmtDtl = RecordSet_GetNext(rStmtDtl);
				}
			}

			hBankAcct = RecordSet_GetNext(rBankAcct);
		}
	}

	free(csTag);

	// hash destroy
	// recordset destroy

	return iRet;
}


int CompleteMatching(const char* csStmtRef, const char* csTxnSeq, const int iOverrideAmt) {
	int iRet = PD_OK;

	char* csTxnCode;
	char* csTxnCcy;
	char* csClientId;
	char* csOrgMerchantId;
	char* csOrgChannelCode;
	char* csOrgServiceCode;
	char* csPayMethod;
	char* csOrgTxnCountry;
	double dTxnAmt;

	recordset_t *rRecordSet;
	hash_t *hRec, *hTxn;

	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn, 0);

	if (iRet == PD_OK) {
		recordset_init(rRecordSet, 0);

		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnHeader");
		if ((DBObjPtr)(csTxnSeq, rRecordSet) == PD_OK) {
DEBUGLOG(("CompleteMatching::txn header found record = [%s]\n", csTxnSeq));
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {

				// txn_seq
				PutField_CString(hTxn, "from_txn_seq", csTxnSeq);

				// txn_code
				if (GetField_CString(hRec, "txn_code", &csTxnCode)) {
DEBUGLOG(("CompleteMatching::GetTxnHeader - txn_code = [%s]\n", csTxnCode));
					PutField_CString(hTxn, "txn_code", csTxnCode);
				}

				// txn_amt
				if (GetField_Double(hRec, "txn_amt", &dTxnAmt)) {
DEBUGLOG(("CompleteMatching::GetTxnHeader - txn_amt = [%lf]\n", dTxnAmt));
					PutField_Double(hTxn, "org_txn_amt", dTxnAmt);
					PutField_Double(hTxn, "txn_amt", dTxnAmt);
				}

				// net_ccy
				if (GetField_CString(hRec, "net_ccy", &csTxnCcy)) {
DEBUGLOG(("CompleteMatching::GetTxnHeader - net_ccy = [%s]\n", csTxnCcy));
					PutField_CString(hTxn, "txn_ccy", csTxnCcy);
					PutField_CString(hTxn, "org_txn_ccy", csTxnCcy);
				}

				// client_id
				if (GetField_CString(hRec, "client_id", &csClientId)) {
DEBUGLOG(("CompleteMatching::GetTxnHeader - client_id = [%s]\n", csClientId));
					PutField_CString(hTxn, "merchant_client_id", csClientId);
				}

				// merchant_id
				if (GetField_CString(hRec, "merchant_id", &csOrgMerchantId)) {
DEBUGLOG(("CompleteMatching::GetTxnHeader - merchant_id = [%s]\n", csOrgMerchantId));
					PutField_CString(hTxn, "merchant_id", csOrgMerchantId);
				}

				// channel_code
				if (GetField_CString(hRec, "channel_code", &csOrgChannelCode)) {
DEBUGLOG(("CompleteMatching::GetTxnHeader - channel_code = [%s]\n", csOrgChannelCode));
					PutField_CString(hTxn, "channel_code", csOrgChannelCode);
				}

				// service_code
				if (GetField_CString(hRec, "service_code", &csOrgServiceCode)) {
DEBUGLOG(("CompleteMatching::GetTxnHeader - service code = [%s]\n", csOrgServiceCode));
					PutField_CString(hTxn, "service_code", csOrgServiceCode);
				}

				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		RecordSet_Destroy(rRecordSet);
	}

	if (iRet == PD_OK) {
		recordset_init(rRecordSet, 0);

		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnDetail");
		if ((DBObjPtr)(csTxnSeq, rRecordSet) == PD_OK) {
DEBUGLOG(("CompleteMatching::txn detail found record = [%s]\n", csTxnSeq));
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {

				// selected_pay_method
				if (GetField_CString(hRec, "selected_pay_method", &csPayMethod)) {
DEBUGLOG(("CompleteMatching::GetTxnDetail - selected_pay_method = [%s]\n", csPayMethod));
					PutField_CString(hTxn, "selected_pay_method", csPayMethod);
				}

				// txn_country
				if (GetField_CString(hRec, "txn_country", &csOrgTxnCountry)) {
DEBUGLOG(("CompleteMatching::GetTxnDetail - txn_country = [%s]\n", csOrgTxnCountry));
					PutField_CString(hTxn, "txn_country", csOrgTxnCountry);
				}

				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		RecordSet_Destroy(rRecordSet);
	}

	if (iRet == PD_OK) {
		BOObjPtr = CreateObj(BOPtr, "BOOLTxnElements", "AddTxnAmtElement");
		if ((unsigned long)((*BOObjPtr)(hTxn)) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("CompleteMatching() BOOLTxnElements:AddTxnAmtElement failed!!!\n"));
ERRLOG("BOOLDepositMatch: CompleteMatching() BOOLTxnElements:AddTxnAmtElement failed!!!\n");
		}
	}

	FREE_ME(hTxn);
	FREE_ME(rRecordSet);
DEBUGLOG(("CompleteMatching() normal exit = [%d]\n", iRet));
	return iRet;
}
