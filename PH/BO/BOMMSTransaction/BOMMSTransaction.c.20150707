/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/07/03              Dirk Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOMMSTransaction.h"

char    cDebug;
OBJPTR(DB);
OBJPTR(BO);

void BOMMSTransaction(char    cdebug)
{
	cDebug = cdebug;
}


int     GetTxnInfo(char* csOrgTxnSeq, hash_t *hData)
{
	int	iRet = PD_OK;

	hash_t	*hRec;
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	char	*csTmp;
	char	cTmp;
	double	dTmp;

	//GetTxnHeader
DEBUGLOG(("GetTxnInfo:: Call DBMmsTransaction:GetTxnHeader [%s]\n", csOrgTxnSeq));
	DBObjPtr = CreateObj(DBPtr, "DBMmsTransaction", "GetTxnHeader");
	if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {

			if (GetField_CString(hRec, "txn_code", &csTmp)) {
				PutField_CString(hData, "txn_code", csTmp);
DEBUGLOG(("GetTxnInfo (Header):: txn_code = [%s]\n", csTmp));
			}

			if (GetField_Char(hRec, "status", &cTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: status = [%c]\n", cTmp));
				if (cTmp != PD_COMPLETE) {
ERRLOG("TxnOmtByUsCPC::GetTxnInfo (Header):: status = [%c]\n", cTmp);
					iRet = INT_INVALID_TXN;
					break;
				} 
			}

			if (GetField_Char(hRec, "ar_ind", &cTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: ar_ind = [%c]\n", cTmp));
				if (cTmp != PD_ACCEPT) {
ERRLOG("TxnOmtByUsCPC::GetTxnInfo (Header):: ar_ind = [%c]\n", cTmp);
					iRet = INT_INVALID_TXN;
					break;
				}
			}

			if (GetField_CString(hRec, "sub_status", &csTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: sub_status = [%s]\n", csTmp));
				if (strcmp(csTmp, PD_APPROVED)) {
ERRLOG("TxnOmtByUsCPC::GetTxnInfo (Header):: sub_status = [%s]\n", csTmp);
					iRet = INT_INVALID_TXN;
					break;
				}
			}
					
			if (GetField_Char(hRec, "recon_status", &cTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: recon_status = [%c]\n", cTmp));
				if (cTmp != PD_UNRECONCILED) {
ERRLOG("TxnOmtByUsCPC::GetTxnInfo (Header):: recon_status = [%s]\n", cTmp);
					iRet = INT_INVALID_TXN;
				break;
				}
			}

			if (GetField_Double(hRec, "txn_amt", &dTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: txn_amt = [%lf]\n", dTmp));
				PutField_Double(hData, "txn_amt", dTmp);
			}

			if (GetField_Double(hRec, "remaining_amt", &dTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: remaining_amt = [%lf]\n", dTmp));
				PutField_Double(hData, "remaining_amt", dTmp);
			}

			if (GetField_Double(hRec, "net_amt", &dTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: net_amt = [%lf]\n", dTmp));
				PutField_Double(hData, "net_amt", dTmp);
			}

			if (GetField_CString(hRec, "net_ccy", &csTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: net_ccy = [%lf]\n",csTmp));
				PutField_CString(hData,"net_ccy",csTmp);
			}

                       	hRec = RecordSet_GetNext(rRecordSet);

		}
	} else {
DEBUGLOG(("GetTxnInfo (Header):: not found record for [%s]\n",csOrgTxnSeq));
		iRet = INT_INVALID_TXN;
	}

	RecordSet_Destroy(rRecordSet);

	return iRet;
}


int	ProcessNewTxn(char* csOrgTxnSeq, hash_t *hData)
{
	int iRet = PD_OK;

	iRet = GetTxnInfo(csOrgTxnSeq, hData);

	char    csNewTxnSeq[PD_TXN_SEQ_LEN +1];
DEBUGLOG(("ProcessToTxn() Call DBTxnSeq::GetNextMmmTxnSeq()\n"));
	DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextMmmTxnSeq");
	strcpy(csNewTxnSeq,(*DBObjPtr)());
	PutField_CString(hData,"txn_seq",csNewTxnSeq);
DEBUGLOG(("ProcessNewTxn() txn_seq = [%s]\n",csNewTxnSeq));



	return iRet;
}


/*
int     AddTxnElement(hash_t *hReq)
{
	int 	iRet = PD_OK;
	hash_t	*hData;
	char	*csTxnSeq;
	char	*csPtr;
	double	dTmp;
	
DEBUGLOG(("BOMMSTransaction::AddTxnElement ()\n"));
	hData = (hash_t*)  malloc (sizeof(hash_t));
	hash_init(hData,0);

// txn seq   
	if (GetField_CString(hReq,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("BOMMSTransaction::AddTxnElement txn_seq = [%s]\n",csTxnSeq));
		PutField_CString(hData,"txn_id",csTxnSeq);
	}
	else {
DEBUGLOG(("BOMMSTransaction::AddTxnElement txn_seq not found\n"));
ERRLOG("BOMMSTransaction::AddTxnElement txn_seq not found\n");
		iRet = PD_ERR;
	}


// txn_element_type   
	if (GetField_CString(hReq,"txn_element_type",&csPtr)) {
DEBUGLOG(("BOMMSTransaction::AddTxnElement txn_elelemt_type = [%s]\n",csPtr));
		PutField_CString(hData,"txn_element_type",csPtr);
	}

// amt   
	if (GetField_Double(hReq,"amount",&dTmp)) {
DEBUGLOG(("BOMMSTransaction::AddTxnElement amount = [%lf]\n",dTmp));
		if (dTmp >= 0.0)  {
			PutField_CString(hData,"amt_type",PD_CR);
			PutField_Double(hData,"amount",dTmp);
		}
		else {
			PutField_CString(hData,"amt_type",PD_DR);
			PutField_Double(hData,"amount",dTmp *(-1));
		}
	}
		
// ccy   
	if (GetField_CString(hReq,"ccy",&csPtr)) {
DEBUGLOG(("BOMMSTransaction::AddTxnElement elelemt_type = [%s]\n",csPtr));
		PutField_CString(hData,"ccy",csPtr);
	}
		

	DBObjPtr = CreateObj(BOPtr,"DBMmsTxnElement","Add");
       	iRet = (unsigned long)((DBObjPtr)(hData));
DEBUGLOG(("BOMMSTransaction::AddTxnElement return from DBMmsTxnElement:Add iRet = [%d]\n",iRet));
	
	FREE_ME(hData);
DEBUGLOG(("BOMMSTransaction::AddTxnElement () iRet = [%d]\n",iRet));
	return iRet;	
}
*/

int AddDetail (hash_t* hContext, hash_t* hReq)
{
	int     iRet = PD_OK;

        int     iBalCnt = 0;
        int     i = 0;

        double  dTmp = 0.00;

        char*   csTmp = NULL;

        char    csTag[PD_TAG_LEN + 1];

        hash_t  *hData = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hData,0);




	hash_destroy(hData);
        FREE_ME(hData);

DEBUGLOG(("BOMMSTransaction::AddDetail () iRet = [%d]\n",iRet));
        return iRet;
}

int UpdateDetail (hash_t* hContext, hash_t* hReq)
{
	int     iRet = PD_OK;

        int     iBalCnt = 0;
        int     i = 0;

        double  dTmp = 0.00;

        char*   csTmp = NULL;

        char    csTag[PD_TAG_LEN + 1];

        hash_t  *hData = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hData,0);




	hash_destroy(hData);
        FREE_ME(hData);

DEBUGLOG(("BOMMSTransaction::UpdateDetail () iRet = [%d]\n",iRet));
        return iRet;
}

int AddNatureDetail (hash_t* hContext, hash_t* hReq)
{
        int     iRet = PD_OK;

	int	iBalCnt = 0;
        int     i = 0;

	double	dTmp = 0.00;

        char*   csTmp = NULL;

	char    csTag[PD_TAG_LEN + 1];

	hash_t  *hData = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hData,0);

DEBUGLOG(("AddNatureDetail() Start!\n"));

/* txn_seq */
        if (GetField_CString(hContext,"txn_seq",&csTmp)) {
DEBUGLOG(("AddNatureDetail: txn_seq = [%s]\n",csTmp));
                PutField_CString(hData, "txn_seq", csTmp);
        } else {
DEBUGLOG(("AddNatureDetail:: txn_id not found!!\n"));
ERRLOG("BOMMSTransaction:: AddNatureDetail:: txn_id not found!!\n");
                iRet = PD_ERR;
        }

/* entity_id */
        if (GetField_CString(hContext,"entity_id",&csTmp)) {
DEBUGLOG(("AddNatureDetail: entity_id = [%s]\n",csTmp));
                PutField_CString(hData, "entity_id", csTmp);
        } else {
DEBUGLOG(("AddNatureDetail:: entity_id not found!!\n"));
ERRLOG("BOMMSTransaction:: AddNatureDetail:: entity_id not found!!\n");
        	iRet = PD_ERR;
	}

/* ccy */
      	if (GetField_CString(hReq,"txn_ccy",&csTmp)) {
DEBUGLOG(("AddNatureDetail: txn_ccy = [%s]\n",csTmp));
              	PutField_CString(hData,"txn_ccy",csTmp);
              	PutField_CString(hData,"net_ccy",csTmp);
     	} else {
DEBUGLOG(("AddNatureDetail:: ccy not found!!\n"));
ERRLOG("BOMMSTransaction:: AddNatureDetail:: ccy not found!!\n");
              	iRet = PD_ERR;
      	}

/* add_user */
        if (GetField_CString(hData,"user",&csTmp)) {
DEBUGLOG(("AddNatureDetail: add_user = [%s]\n",csTmp));
              	PutField_CString(hData,"add_user",csTmp);
        } else {
DEBUGLOG(("AddNatureDetail:: user not found!!\n"));
ERRLOG("BOMMSTransaction:: AddNatureDetail:: user not found!!\n");
              	iRet = PD_ERR;
        }

/* bal_cnt */
        if (GetField_Int(hReq,"bal_cnt",&iBalCnt)){
DEBUGLOG(("AddNatureDetail: bal_cnt = [%d]\n",iBalCnt));
        } else {
DEBUGLOG(("AddNatureDetail:: bal_cnt not found!!\n"));
ERRLOG("BOMMSTransaction:: AddNatureDetail:: bal_cnt not found!!\n");
                iRet = PD_ERR;
        }

	if (iRet == PD_OK) {

                for (i=1; i<=iBalCnt; i++)
                {
/* txn_amt */
                        sprintf(csTag,"bal.%d.txn_amt",i);
                        if (GetField_CString(hReq,csTag,&dTmp)) {
DEBUGLOG(("AddNatureDetail: txn_amt = [%.2lf]\n",dTmp));
				PutField_Double(hData,"txn_amt",dTmp);
				PutField_Double(hData,"net_amt",dTmp);
                        } else {
DEBUGLOG(("AddNatureDetail:: txn_amt not found!!\n"));
ERRLOG("BOMMSTransaction:: AddNatureDetail:: txn_amt not found!!\n");
                                iRet = PD_ERR;
                        }

/* nature_id */
                        sprintf(csTag,"bal.%d.nature_id",i);
                        if (GetField_CString(hReq,csTag,&csTmp)) {
DEBUGLOG(("AddNatureDetail: nature_id = [%s]\n",csTmp));
				PutField_CString(hData,"nature_id",csTmp);
                        } else {
DEBUGLOG(("AddNatureDetail:: nature_id not found!!\n"));
ERRLOG("BOMMSTransaction:: AddNatureDetail:: nature_id not found!!\n");
                                iRet = PD_ERR;
                        }
		
			// Add Nature Detail
DEBUGLOG(("AddNatureDetail:: Call DBMmsTransaction AddNatureDetail\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBMMSTransaction","AddNatureDetail");
                		iRet = (unsigned long)(*DBObjPtr)(hData);
                	if (iRet == PD_OK) {
DEBUGLOG(("AddNatureDetail:: Call DBMmsTransaction:: Success!!!\n"));
                	} else {
                        	iRet = INT_ERR;
                        	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("AddNatureDetail:: Call DBMmsTransaction:: Failure!!!\n"));
ERRLOG("BOMMSTransaction::AddNatureDetail::Call DBMmsTransaction:: Failure!!!\n");
			}
                }
	}

	hash_destroy(hData);
        FREE_ME(hData);

DEBUGLOG(("BOMMSTransaction::AddNatureDetail () iRet = [%d]\n",iRet));
        return iRet;
}
