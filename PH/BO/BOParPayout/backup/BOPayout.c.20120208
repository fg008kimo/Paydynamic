/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/10/24              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOPayout.h"

#define PD_SPACE 0x20
#define PD_TR           "<tr>"
#define PD_TD           "<td>"
#define PD_BOLD         "<b>"
#define PD_TD_STYLE     "<td class=\"format\">"
#define PD_TR_END       "</tr>"
#define PD_TD_END       "</td>"
#define PD_BOLD_END     "</b>"

char    cDebug;

void BOPayout(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

int GetPayoutRecords(const unsigned long lBatchId,
                        hash_t *hContext,
                        hash_t* hRequest);

int UpdateDetail(hash_t *hContext,
                hash_t* hRequest);

int UpdateHeader(hash_t *hContext,
		 hash_t* hRequest);

int CheckAvalBalance(hash_t *hContext,
                     const hash_t* hRequest);

int GetPayoutFee(hash_t *hContext,
                 hash_t* hRequest);

int GetPayoutRule(hash_t *hContext,
                  hash_t* hRequest);

int AssignPsp(hash_t *hContext,
              hash_t* hRequest,
	      hash_t* hResponse);

int FormatResponse(const hash_t *hContext,
		   hash_t* hResponse);

int CreatePayoutFile(const char* csPspId,
		     hash_t* hContext);

int WritePayoutFile(const char* csPayOutFile,
		    hash_t* hRec);

int WriteAssignedRecord(hash_t *hContext,
			hash_t* hRequest);

int GetGenFileDetail(hash_t *hContext,
		     hash_t* hRequest);

int GenerateBatchSeq(hash_t* hRequest);

int handle_PayoutConfirm(const unsigned long lBatchId,hash_t* hContext,hash_t* hRequest);
int handle_PayoutApprove(const unsigned long lBatchId,hash_t* hContext,hash_t* hRequest);
int handle_PayoutPreGenerate(hash_t* hContext,hash_t* hRequest,hash_t* hResponse);
int handle_PayoutGenerate(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
int handle_PayoutCancel(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);

int ProcessPayoutTxn(hash_t *hContext,
		 hash_t* hRequest,
		 hash_t* hResponse)
{
	int     iRet = PD_OK;
	char	*csTmp;
	char	*csTxnCode;
	int	iTmp= 0;
	int	iMerch = PD_FALSE;
	unsigned long lBatchId = 0l;

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	hash_t  *hHeader;
        hHeader = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hHeader,0);

DEBUGLOG(("BOPayout:ProcessPayoutTxn()\n"));

 	if (GetField_CString(hRequest,"batch_id",&csTmp)) {
		lBatchId = ctol((const unsigned char *)csTmp,strlen(csTmp));
		PutField_CString(hTxn,"batch_id",csTmp);
DEBUGLOG(("BOPayout::ProcessPayoutTxn() batch_id = [%s]\n",csTmp));
        }

	if(GetField_CString(hContext,"approval_date",&csTmp)){
DEBUGLOG(("BOPayout::ProcessPayoutTxn() approval_date = [%s]\n",csTmp));
	}

	if(GetField_Int(hContext,"day_of_week",&iTmp)){
DEBUGLOG(("BOPayout::ProcessPayoutTxn() day_of_week = [%d]\n",iTmp));
	}

 	if (GetField_CString(hRequest,"merchant_id",&csTmp)) {
		iMerch = PD_TRUE;
DEBUGLOG(("BOPayout::ProcessPayoutTxn() merchant_id = [%s]\n",csTmp));
        }
	PutField_Int(hRequest,"mid_present",iMerch);

 	if (GetField_CString(hRequest,"file_id",&csTmp)) {
		PutField_CString(hHeader,"file_id",csTmp);
DEBUGLOG(("BOPayout::ProcessPayoutTxn() file_id = [%s]\n",csTmp));
        }

 	if (GetField_CString(hRequest,"add_user",&csTmp)) {
		PutField_CString(hTxn,"update_user",csTmp);
		PutField_CString(hHeader,"update_user",csTmp);
DEBUGLOG(("BOPayout::ProcessPayoutTxn() add_user = [%s]\n",csTmp));
	}

	if(GetField_CString(hRequest,"txn_code",&csTxnCode)){
DEBUGLOG(("BOPayout::ProcessPayoutTxn() txn_code = [%s]\n",csTxnCode));
	}

/*---------Payout Confirm---------*/
	if(!strcmp(csTxnCode,"POC")){
		iRet = handle_PayoutConfirm(lBatchId,hContext,hRequest);
	}
/*---------Payout Approve---------*/
	else if(!strcmp(csTxnCode,"POA")){
		iRet = handle_PayoutApprove(lBatchId, hContext, hRequest);
	}
/*---------Payout Pre-Generate---------*/
	else if(!strcmp(csTxnCode,"POP")){
		iRet = handle_PayoutPreGenerate(hContext,hRequest,hResponse);
	}
/*---------Payout Generate---------*/
	else if(!strcmp(csTxnCode,"POG")){
		iRet = handle_PayoutGenerate(hContext,hRequest,hHeader);
	}
/*---------Payout Cancel---------*/
	else if(!strcmp(csTxnCode,"PON")){
		iRet = handle_PayoutCancel(hContext,hRequest,hHeader);
	}

	else{
DEBUGLOG(("BOPayout::ProcessPayoutTxn() unknown txn_code!!!\n"));
ERRLOG("BOPayout::ProcessPayoutTxn() unknown txn_code!!!\n");
		iRet = INT_ERR;
	}


	if((iRet == PD_OK) && (strcmp(csTxnCode,"POP"))){
		iRet = UpdateHeader(hContext,hRequest);
	}

DEBUGLOG(("BOPayout::ProcessPayoutTxn() iRet[%d]\n",iRet));
	FREE_ME(hTxn);
	FREE_ME(hHeader);
	return	iRet;
}

int handle_PayoutConfirm(const unsigned long lBatchId,
                         hash_t *hContext,
                         hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iStatus=0;
	int	iTmp;

DEBUGLOG(("BOPayout::handle_PayoutConfirm()\n"));
	iRet = GetPayoutRecords(lBatchId, hContext, hRequest);

	if(GetField_Int(hRequest,"status",&iStatus)){
		if(iStatus!=PD_PAYOUTFILE_UPLOADED){
			iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("handle_PayoutConfirm() GetPayoutRecords:invalid status!!!\n"));
ERRLOG("BOPayout::handle_PayoutConfirm() GetPayoutRecords:invalid status!!!\n");
		}
	}

	if(iRet == PD_OK){
DEBUGLOG(("handle_PayoutConfirm::call BOMerchant->GetMerchantTxnInfo\n"));
		BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantTxnInfo");
		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);

		if(GetField_Int(hContext,"allow_payout",&iTmp)){
			if(iTmp!=PD_TRUE){
				iRet = INT_INVALID_TXN;
				PutField_Int(hContext,"internal_error",iRet);
ERRLOG("BOPayout::handle_PayoutConfirm() merchant acct not allow payout\n");
DEBUGLOG(("handle_PayoutConfirm() merchat acct not allow payout\n"));
			}
		}
	}

	if(iRet == PD_OK){
		iRet = UpdateDetail(hContext,hRequest);
	}

	return iRet;
}

int handle_PayoutApprove(const unsigned long lBatchId,
                         hash_t *hContext,
                         hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iStatus=0;
	double	dTmp;

DEBUGLOG(("BOPayout::handle_PayoutApprove()\n"));
	iRet = GetPayoutRecords(lBatchId, hContext, hRequest);

	if(GetField_Int(hRequest,"status",&iStatus)){
		if(iStatus!=PD_PAYOUTFILE_PROCESSING){
			iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("handle_PayoutApprove() GetPayoutRecords:invalid status!!!\n"));
ERRLOG("BOPayout::handle_PayoutApprove() GetPayoutRecords:invalid status!!!\n");
		}
	}


	if(iRet == PD_OK){
DEBUGLOG(("handle_PayoutApprove::call BOMerchant->GetMerchantTxnInfo\n"));
		BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantTxnInfo");
		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
	}

	if(iRet == PD_OK){
		iRet = GetPayoutFee(hContext,hRequest);
	}

	if(iRet == PD_OK){
		iRet = CheckAvalBalance(hContext,hRequest);
	}

	if(iRet == PD_OK){
		iRet = UpdateDetail(hContext,hRequest);
	}

	if(iRet==PD_OK){
		if(GetField_Double(hContext,"total_src_txn_fee",&dTmp)){
			PutField_Double(hContext,"src_txn_fee",dTmp);
		}
		if(GetField_Double(hContext,"total_dst_txn_fee",&dTmp)){
			PutField_Double(hContext,"dst_txn_fee",dTmp);
		}
		ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnFeeChgLog");
		iRet = (unsigned long)((*ChannelObjPtr)(hContext));
	}

	if(iRet == PD_OK){
DEBUGLOG(("handle_PayoutApprove::Call BOBalance:UpdatePayoutAmount (Merchant)\n"));
		PutField_Char(hContext,"response_mode",PD_ACCEPT);
		PutField_Char(hContext,"party_type",PD_TYPE_MERCHANT);

		BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
		if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("handle_PayoutApprove::BOBalance:UpdatePayoutAmount Failed\n"));
			iRet = INT_ERR;
		}
	}

	if(iRet == PD_OK){
DEBUGLOG(("handle_PayoutApprove::Call DBTransaction:AddDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
		if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("handle_PayoutApprove::DBTransaction:AddDetail Failed\n"));
		}
	}

	if(iRet==PD_OK){
DEBUGLOG(("handle_PayoutApprove::Call DBTransaction:UpdateDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
		if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("handle_PayoutApprove::DBTransaction:UpdateDetail Failed\n"));
		}
	}

	return iRet;
}


int handle_PayoutPreGenerate(hash_t *hContext,
			     hash_t* hRequest,
			     hash_t* hResponse)
{
	int	iRet = PD_OK;

DEBUGLOG(("BOPayout::handle_PayoutPreGenerate()\n"));

	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","ResumeAssignedPsp");
	iRet = (unsigned long)(*DBObjPtr)();

	if(iRet==PD_OK){
		iRet = GetPayoutRule(hContext,hRequest);
	}
	if(iRet==PD_OK){
		iRet = AssignPsp(hContext,hRequest,hResponse);
	}
	if(iRet==PD_OK){
		iRet = FormatResponse(hContext,hResponse);
	}

	return iRet;
}

int handle_PayoutGenerate(hash_t *hContext,
			  hash_t* hRequest,
			  hash_t* hHeader)
{
	int	iRet = PD_OK;
	int	i=0;
	int	iTmp=0;
	int	iCnt=0;
	char*	csTmp;
	char*	csPspId;
	char*	csFilePath;
	char	csTag[PD_TAG_LEN +1];
	double	dAmt=0.0;
	double	dTmp=0.0;

DEBUGLOG(("BOPayout::handle_PayoutGenerate()\n"));

	hash_t  *hRec;

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

DEBUGLOG(("handle_PayoutGenerate::Call DBMerchantUploadFileDetail:GetExistingPsp\n"));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetExistingPsp");
	if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
		i = 0;
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if (GetField_CString(hRec, "psp_id", &csTmp)) {
				sprintf(csTag, "psp_id_%d", i);
				PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetExistingPsp::psp_id = [%s]\n",csTmp));

DEBUGLOG(("handle_PayoutGenerate::Call CreatePayoutFile\n"));
				if(CreatePayoutFile(csTmp,hContext)!=PD_OK){
					iRet=INT_ERR;
DEBUGLOG(("CreatePayoutFile for[%s] Failed!!!!\n",csTmp));
				}
			}
			i++;
			hRec = RecordSet_GetNext(rRecordSet);
			PutField_Int(hContext,"psp_count",i);
		}
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

	if(iRet==PD_OK){
		iRet = WriteAssignedRecord(hContext,hRequest);
	}
	if(iRet==PD_OK){
		iRet = UpdateDetail(hContext,hRequest); 
	}
	if(iRet==PD_OK){
		GetField_Int(hContext,"psp_count",&iCnt);
		for(i=0; i<iCnt; i++){
			sprintf(csTag,"psp_id_%d",i);
			if(GetField_CString(hContext,csTag,&csPspId)){
				sprintf(csTag, "%s_file_id", csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"file_id",csTmp);
				}
				sprintf(csTag, "%s_txn_cnt", csPspId);
				if(GetField_Int(hContext,csTag,&iTmp)){
					PutField_Int(hHeader,"txn_cnt",iTmp);
				}
				sprintf(csTag, "%s_txn_amt", csPspId);
				if(GetField_Double(hContext,csTag,&dTmp)){
					PutField_Double(hHeader,"txn_amt",dTmp);
				}
				sprintf(csTag, "%s_merchant_fee_ccy", csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"merchant_fee_ccy",csTmp);
				}
				sprintf(csTag, "%s_member_fee_ccy", csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"member_fee_ccy",csTmp);
				}
				sprintf(csTag, "%s_merchant_fee", csPspId);
				if(GetField_Double(hContext,csTag,&dTmp)){
					PutField_Double(hHeader,"merchant_fee",dTmp);
				}
				sprintf(csTag, "%s_member_fee", csPspId);
				if(GetField_Double(hContext,csTag,&dTmp)){
					PutField_Double(hHeader,"member_fee",dTmp);
				}
				sprintf(csTag, "%s_path", csPspId);
				GetField_CString(hContext,csTag,&csFilePath);

				PutField_Int(hContext,"end_file",PD_TRUE);
				iRet = WritePayoutFile(csFilePath,hContext);

				sprintf(csTag, "%s_txn_country", csPspId);
				GetField_CString(hContext,csTag,&csTmp);
				PutField_CString(hContext,"org_txn_country",csTmp);

				sprintf(csTag, "%s_payout_ccy", csPspId);
				GetField_CString(hContext,csTag,&csTmp);
				PutField_CString(hContext,"org_psp_txn_ccy",csTmp);

				sprintf(csTag,"org_dst_net_amt_%s",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					PutField_CString(hContext,"org_psp_id",csPspId);
					PutField_Double(hContext,"org_dst_net_amt",dAmt);
					PutField_Char(hContext,"response_mode",PD_ACCEPT);
					PutField_Char(hContext,"party_type",PD_TYPE_PSP);

					BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
					if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("handle_PayoutGenerate::UpdatePayoutAmount Failed[%s][%lf]!!!\n",csTmp,dAmt));
ERRLOG("BOPayout::handle_PayoutGenerate:UpdatePayoutAmount Failed!!!\n");
						iRet = INT_ERR;
					}
				}

				PutField_Int(hHeader,"status",PD_PAYOUTFILE_GENERATED);

				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
				if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
					DEBUGLOG(("Authorize::PayoutGeneratedFileHD::Add Error!!!\n"));
					iRet = INT_ERR;
				}

				if(iRet!=PD_OK)
					break;
			}
		}

	}

	return iRet;
}


int handle_PayoutCancel(hash_t *hContext,
			hash_t* hRequest,
			hash_t* hHeader)
{
	int	iRet = PD_OK;


DEBUGLOG(("BOPayout::handle_PayoutCancel()\n"));
	iRet = GetGenFileDetail(hContext,hRequest);

	if(iRet==PD_OK){
		PutField_Char(hContext,"response_mode",PD_REVERSED);
		PutField_Char(hContext,"party_type",PD_TYPE_PSP);

		BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
		if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("handle_PayoutGenerate::UpdatePayoutAmount Failed!!!\n"));
ERRLOG("BOPayout::handle_PayoutGenerate:UpdatePayoutAmount Failed!!!\n");
			iRet = INT_ERR;
		}
	}

	if(iRet==PD_OK){
		PutField_Int(hHeader,"status",PD_PAYOUTFILE_DECLINED);

		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
		if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("handle_PayoutGenerate::PayoutGeneratedFileHD::Update Error!!!\n"));
			iRet = INT_ERR;
		}
	}

	if(iRet==PD_OK){
		iRet = UpdateDetail(hContext,hRequest);
	}

	return iRet;
}

int UpdateHeader(hash_t *hContext,
		hash_t* hRequest)
{
	int     iRet  = PD_OK;
	int	iCnt=0;
	int	i=0;
	int	iResult=0;
	char	*csTmp;
	char	*csTxnCode;
	char	*csBatchId;
	char	csTag[PD_TAG_LEN +1];
	unsigned long lBatchId = 0l;
	unsigned long lTmp=0l;

	hash_t  *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

DEBUGLOG(("BOPayout::UpdateHeader()\n"));

	///for POA/POC, only update one batch	
	if(GetField_CString(hRequest,"batch_id",&csTmp)){
		sprintf(csTag,"batch_id_%d",0);
		PutField_CString(hRequest,csTag,csTmp);
		PutField_Int(hRequest,"total_count",1);
	}

	GetField_CString(hRequest,"txn_code",&csTxnCode);
	if(!strcmp(csTxnCode,"POA")){
		if(GetField_CString(hContext,"txn_seq",&csTmp))
			PutField_CString(hTxn,"txn_seq",csTmp);
		if(GetField_CString(hContext,"posting_date",&csTmp))
			PutField_CString(hTxn,"posting_date",csTmp);

		PutField_Int(hTxn,"status",PD_PAYOUTFILE_APPROVED);
	}
	else if(!strcmp(csTxnCode,"POC")){
		PutField_Int(hTxn,"status",PD_PAYOUTFILE_PROCESSING);
	}
	
	if(GetField_Int(hRequest,"total_count",&iCnt)){
DEBUGLOG(("UpdateHeader::total_count= [%d]\n",iCnt));
	}
	for(i=0; i<iCnt; i++){
		sprintf(csTag, "batch_id_%d", i);
		GetField_CString(hRequest,csTag,&csBatchId);
		PutField_CString(hTxn,"batch_id",csBatchId);

		lBatchId = ctol((const unsigned char *)csBatchId,strlen(csBatchId));
		if (lTmp==lBatchId)
			continue;

		lTmp = lBatchId;

		if(!strcmp(csTxnCode,"POG") || !strcmp(csTxnCode,"PON")){
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","MatchCount");
			if(!strcmp(csTxnCode,"POG")){
				iResult = (unsigned long) ((*DBObjPtr)(lBatchId,PAYOUT_MASTER_TRANSACTION_GENERATED));
				if(iResult!=PD_ERR && iResult!=PD_NOT_FOUND){
					if(iResult==PD_TRUE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_GENERATED);
					else if (iResult==PD_FALSE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_PARTIAL_GENERATED);
				}
			}
			else{
				iResult = (unsigned long) ((*DBObjPtr)(lBatchId,PAYOUT_MASTER_TRANSACTION_APPROVED));
				if(iResult!=PD_ERR && iResult!=PD_NOT_FOUND){
					if(iResult==PD_TRUE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_APPROVED);
					else if (iResult==PD_FALSE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_PARTIAL_GENERATED);
				}
			}
		}
DEBUGLOG(("UpdateHeader::DBMerchantUploadFileHeader:UpdateHeader\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","UpdateHeader");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("UpdateHeader::DBMerchantUploadFileHeader:UpdateHeader Failed\n"));
		}
	}

	FREE_ME(hTxn);
DEBUGLOG(("BOPayout::UpdateHeader() iRet=[%d]\n",iRet));
	return  iRet;
}


int GetPayoutRecords(const unsigned long lBatchId,
			hash_t *hContext,
			hash_t* hRequest)
{
	int	iRet  = PD_OK;
	int	iStatus = 0;
	int	iSeqNum = 0;
	int	iIntErr= PD_OK;
	int	i= 0;
	char	*csMerchantId;
	char	*csServiceCode;
	char	*csTxnCountry=strdup("");
	char	*csTxnCcy;
	char	*csTmp;
	double	dTmp=0.0;
	double	dTotalAmt=0.0;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout:GetPayoutRecords()\n"));

DEBUGLOG(("BOPayout::Call DBMerchantUploadFileHeader:GetHeader\n"));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","GetHeader");
	if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
DEBUGLOG(("GetHeader::found record = [%ld]\n",lBatchId));
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if (GetField_CString(hRec,"merchant_id",&csMerchantId)) {
				PutField_CString(hRequest,"merchant_id",csMerchantId);
				PutField_CString(hContext,"merchant_id",csMerchantId);
				PutField_CString(hContext,"org_merchant_id",csMerchantId);
DEBUGLOG(("GetHeader::merchant_id= [%s]\n",csMerchantId));
			}
			else{
				iRet = INT_MERCHANT_ID_NOT_FOUND;
DEBUGLOG(("GetHeader::merchant_id not found\n"));
			}
			if (GetField_CString(hRec,"service_code",&csServiceCode)) {
				PutField_CString(hRequest,"service_code",csServiceCode);
				PutField_CString(hContext,"service_code",csServiceCode);
				PutField_CString(hContext,"org_service_code",csServiceCode);
DEBUGLOG(("GetHeader::service_code= [%s]\n",csServiceCode));

				DBObjPtr = CreateObj(DBPtr,"DBService","FindCountryByService");
				if ((unsigned long)(DBObjPtr)(csServiceCode,csTxnCountry) == FOUND) {
DEBUGLOG(("GetHeader::txn_country= [%s]\n",csTxnCountry));
					PutField_CString(hRequest,"txn_country",csTxnCountry);
					PutField_CString(hContext,"txn_country",csTxnCountry);
					PutField_CString(hContext,"org_txn_country",csTxnCountry);
				}

				/*hard code, edit later*/
				if(!strcmp(csServiceCode,"TLN")){
					PutField_Char(hRequest,"batch_mode",PD_ONLINE);
					PutField_CString(hRequest,"psp_id","TWV");
				}
				else{
					PutField_Char(hRequest,"batch_mode",PD_OFFLINE);
				}
			}
			else{
				iRet = INT_SERVICE_CODE_MISSING;
DEBUGLOG(("GetHeader::service_code not found\n"));
			}
			if (GetField_Int(hRec,"status",&iStatus)){
DEBUGLOG(("GetHeader::status= [%d]\n",iStatus));
				PutField_Int(hRequest,"status",iStatus);
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}
	else{
DEBUGLOG(("GetHeader:: not found record for [%ld]\n",lBatchId));
ERRLOG("BOPayout::GetPayoutRecords() GetHeader::not found record!!\n");
		iRet=INT_NOT_RECORD;
	}
	RecordSet_Destroy(rRecordSet);

	if(iRet==PD_OK){
		recordset_init(rRecordSet,0);
DEBUGLOG(("BOPayout::Call DBMerchantUploadFileDetail:GetDetail\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetail");
                if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
                        i = 0;
DEBUGLOG(("GetDetail::found record = [%ld]\n",lBatchId));
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
                                iIntErr = PD_OK;
                                if(GetField_Int(hRec,"seq_num",&iSeqNum)){
                                        sprintf(csTag,"seq_num_%d",i);
                                        PutField_Int(hRequest,csTag,iSeqNum);
DEBUGLOG(("GetDetail::seq_num= [%i]\n",iSeqNum));
                                }
                                if (!GetField_CString(hRec,"txn_country",&csTmp)) {
                                        sprintf(csTag,"txn_country_%d",i);
                                        PutField_CString(hRequest,csTag,csTxnCountry);
                                }
                                if (GetField_CString(hRec,"payout_ccy",&csTmp)){
                                        if(strcmp(csTmp,"RMB"))
                                                csTxnCcy = strdup(csTmp);
                                        else
                                                csTxnCcy = strdup(PD_CCY_ISO_CNY);

                                        sprintf(csTag,"dst_txn_ccy_%d",i);
                                        PutField_CString(hRequest,csTag,csTxnCcy);
DEBUGLOG(("GetDetail::payout_ccy= [%s]\n",csTmp));
                                        FREE_ME(csTxnCcy);
                                }

				if(GetField_CString(hRec,"request_ccy",&csTmp)){
                                        if(strcmp(csTmp,"RMB"))
                                                csTxnCcy = strdup(csTmp);
                                        else
                                                csTxnCcy = strdup(PD_CCY_ISO_CNY);

                                        sprintf(csTag,"txn_ccy_%d",i);
                                        PutField_CString(hRequest,csTag,csTxnCcy);
                                        PutField_CString(hRequest,"txn_ccy",csTxnCcy);
                                        PutField_CString(hContext,"txn_ccy",csTxnCcy);
                                        PutField_CString(hContext,"org_txn_ccy",csTxnCcy);
DEBUGLOG(("GetDetail::request_ccy= [%s]\n",csTxnCcy));
					FREE_ME(csTxnCcy);
                                }
                                else{
                                        iIntErr = INT_CURRENCY_CODE_NOT_FOUND;
DEBUGLOG(("GetDetail::ccy not found\n"));
                                }

				if (GetField_Double(hRec,"request_amount",&dTmp)) {
					sprintf(csTag,"txn_amt_%d",i);
                                        PutField_Double(hRequest,csTag,dTmp);
					dTotalAmt += dTmp;
DEBUGLOG(("GetDetail::request_amount= [%lf]\n",dTmp));
                                }
                                if (GetField_Double(hRec,"payout_amount",&dTmp)) {
					//sprintf(csTag,"payout_amount_%d",i);
                                        //PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetDetail::payout_amount= [%lf]\n",dTmp));
                                }
				if (GetField_CString(hRec,"bank_name",&csTmp)){
					sprintf(csTag,"bank_name_%d",i);
                                        PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetDetail::bank_name= [%s]\n",csTmp));
                                }
                                if (GetField_CString(hRec,"bank_code",&csTmp)){
					sprintf(csTag,"bank_code_%d",i);
                                        PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetDetail::bank_code= [%s]\n",csTmp));
				}

                                sprintf(csTag,"int_error_%d",i);
                                PutField_Int(hRequest,csTag,iIntErr);

                                i++;
                                PutField_Int(hRequest,"total_count",i);
                                PutField_Double(hRequest,"total_txn_amt",dTotalAmt);

				hRec = RecordSet_GetNext(rRecordSet);
                        }

                }
                else{
DEBUGLOG(("GetDetail:: not found record for [%ld]\n",lBatchId));
ERRLOG("BOPayout::GetPayoutRecords::GetDetail::not found record!!\n");
                        iRet=INT_NOT_RECORD;
                }

	}

	if(i==0){
DEBUGLOG(("GetDetail::no record for [%ld]\n",lBatchId));
		iRet = INT_NO_PENDING_RECORD;
	}

	FREE_ME(csTxnCountry);	
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
DEBUGLOG(("BOPayout:GetPayoutRecords() iRet=[%d]\n",iRet));
	return	iRet;
}

int UpdateDetail(hash_t *hContext,
		hash_t* hRequest)
{
	int     iRet = PD_OK;
	int	iCnt = 0;
	int	i = 0;
	int	iSeqNum = 0;
	int	iIntErr= PD_OK;
	char	*csBatchId;
	char	*csTxnCode;
	char	*csTmp;
	char	cTmp;
	double	dTmp=0.0;
	char	csTag[PD_TAG_LEN +1];
	char    csResp[PD_RESPONSE_CODE_LEN +1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	if (GetField_CString(hRequest,"batch_id",&csBatchId)){
DEBUGLOG(("BOPayout::UpdateDetail for batch[%s]\n",csBatchId));
	}
	if (GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hTxn,"update_user",csTmp);
	}
	
	
	if(GetField_CString(hRequest,"txn_code",&csTxnCode)){
		if(!strcmp(csTxnCode,"POC")){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_PENDING);
		}
		else if(!strcmp(csTxnCode,"POA")){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_APPROVED);
			iRet=GenerateBatchSeq(hRequest);
		}
		else if(!strcmp(csTxnCode,"POG")){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
		}
		else if(!strcmp(csTxnCode,"PON")){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_APPROVED);
		}
	}

	if(GetField_Char(hRequest,"batch_mode",&cTmp)){
		PutField_Char(hTxn,"batch_mode",cTmp);
	}
	if(GetField_CString(hRequest,"psp_id",&csTmp)){
		PutField_CString(hTxn,"psp_id",csTmp);
	}

	GetField_Int(hRequest,"total_count", &iCnt);
	for(i=0; i<iCnt; i++){
		sprintf(csTag,"batch_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csBatchId)){
DEBUGLOG(("BOPayout::UpdateDetail for batch[%s]\n",csBatchId));
		}
		sprintf(csTag,"seq_num_%d",i);
		if(GetField_Int(hRequest,csTag,&iSeqNum)){
DEBUGLOG(("BOPayout::UpdateDetail seq_num[%d]\n",iSeqNum));
		}
		else{
DEBUGLOG(("BOPayout::UpdateDetail seq_num is missing!!!\n"));
			continue;
		}

		sprintf(csTag,"txn_seq_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_seq",csTmp);
		}
		sprintf(csTag,"psp_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"psp_id",csTmp);
		}
		sprintf(csTag,"txn_country_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_country",csTmp);
		}
		sprintf(csTag,"payout_amt_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"payout_amt",dTmp);
		}
		sprintf(csTag,"txn_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"merchant_fee_ccy",csTmp);
		}
		sprintf(csTag,"dst_txn_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"member_fee_ccy",csTmp);
		}
		sprintf(csTag,"member_fee_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"member_fee",dTmp);
		}
		sprintf(csTag,"merchant_fee_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"merchant_fee",dTmp);
		}
		sprintf(csTag,"markup_amt_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"markup_amt",dTmp);
		}
		sprintf(csTag,"markup_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"markup_ccy",csTmp);
		}
		sprintf(csTag,"ex_rate_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"ex_rate",dTmp);
		}
		sprintf(csTag,"generated_file_name_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"generated_file_name",csTmp);
		}

		sprintf(csTag,"int_error_%d",i);
		if(GetField_Int(hRequest,csTag,&iIntErr)){
			sprintf(csResp,"%d",iIntErr);
			PutField_CString(hTxn,"resp_code",csResp);
			if(iIntErr!=PD_OK){
				PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_DECLINED);
			}
		}

		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","UpdateDetailByBatchId");
		if ((*DBObjPtr)(csBatchId,iSeqNum,hTxn) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOPayout::DBMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
		}

	}

DEBUGLOG(("BOPayout:UpdateDetail iRet=[%d]\n",iRet));
	FREE_ME(hTxn);
	return  iRet;
}

int InsertGenFileDT(const hash_t* hRequest)
{
	int     iRet = PD_OK;
	int	iCnt = 0;
	int	i = 0;
	int	iTmp = 0;
	char	*csTmp;
	double	dTmp=0.0;
	char	csTag[PD_TAG_LEN +1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	
DEBUGLOG(("BOPayout:InsertGenFileDT\n"));
	GetField_Int(hRequest,"total_count", &iCnt);
	for(i=0; i<iCnt; i++){
		sprintf(csTag,"batch_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"batch_id",csTmp);
		}
		sprintf(csTag,"seq_num_%d",i);
		if(GetField_Int(hRequest,csTag,&iTmp)){
			PutField_Int(hTxn,"seq_num",iTmp);
		}
		sprintf(csTag,"txn_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_id",csTmp);
		}
		sprintf(csTag,"file_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"file_id",csTmp);
		}
		sprintf(csTag,"txn_country_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_country",csTmp);
		}
		sprintf(csTag,"request_amount_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"request_amount",dTmp);
		}
		sprintf(csTag,"payout_amount_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"payout_amount",dTmp);
		}
		sprintf(csTag,"request_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"request_ccy",csTmp);
		}
		sprintf(csTag,"payout_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"payout_ccy",csTmp);
		}
		sprintf(csTag,"account_name_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"account_name",csTmp);
		}
		sprintf(csTag,"account_num_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"account_num",csTmp);
		}
		sprintf(csTag,"bank_name_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"bank_name",csTmp);
		}
		sprintf(csTag,"branch_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"branch",csTmp);
		}
		sprintf(csTag,"identity_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"identity_id",csTmp);
		}
		sprintf(csTag,"phone_num_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"phone_num",csTmp);
		}
		sprintf(csTag,"merchant_ref_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"merchant_ref",csTmp);
		}
		sprintf(csTag,"province_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"province",csTmp);
		}
		sprintf(csTag,"city_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"city",csTmp);
		}

	
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","Add");
		if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("InsertGenFileDT::DBPayoutGeneratedFileDT:Add Failed\n"));
		}
	}	

	FREE_ME(hTxn);
DEBUGLOG(("BOPayout:InsertGenFileDT iRet=[%d]\n",iRet));
	return  iRet;
}

int CheckAvalBalance(hash_t *hContext,
		     const hash_t* hRequest)
{	
	int	iRet = PD_OK;
	double	dTotalSrcNetAmt = 0.0;
	double	dActualPayoutBal = 0.0;
	double	dAvalPayoutBal = 0.0;

DEBUGLOG(("CheckAvalBalance::Call BOBalance:GetAvalPayoutBalance\n"));
	BOObjPtr = CreateObj(BOPtr,"BOBalance","GetAvalPayoutBalance");
	if((unsigned long)(*BOObjPtr)(hContext,
				hRequest,
				&dActualPayoutBal,
				&dAvalPayoutBal)==PD_OK){
DEBUGLOG(("CheckAvalBalance::GetAvalBalance for payout=[%f]\n",dActualPayoutBal));
	}
	else{
DEBUGLOG(("CheckAvalBalance::GetAvalPayoutBalance Error\n"));
ERRLOG("BOPayout::CheckAvalBalance::GetAvalPayoutBalance Error!!\n");
		iRet = INT_ERR;
	}

	if(iRet==PD_OK){
		if(GetField_Double(hContext,"net_amt",&dTotalSrcNetAmt)){
			if(dAvalPayoutBal<dTotalSrcNetAmt){
				iRet=INT_INSUFFICIENT_FUND;
DEBUGLOG(("CheckAvalBalance::Aval Payout Amt[%f] < Request Net Amt[%f]\n",dActualPayoutBal,dTotalSrcNetAmt));
ERRLOG("BOPayout::CheckAvalBalance::insufficient aval payout balance!!\n");
			}
		}
	}

	return  iRet;
}

int GetPayoutFee(hash_t *hContext,
		 hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iIntErr = PD_OK;
	int	i= 0;
	int	iCnt= 0;
	double	dTmp= 0.0;
	double	dTotalSrcNetAmt = 0.0;
	double	dTotalDstNetAmt = 0.0;
	char	*csTmp;
	char	csTag[PD_TAG_LEN +1];

DEBUGLOG(("BOPayout:GetPayoutFee()\n"));
	PutField_CString(hContext,"txn_code",PD_WITHDRAW_BATCH_TXN_CODE);

	GetField_Int(hRequest,"total_count", &iCnt);
	for(i=0; i<iCnt; i++){
		sprintf(csTag,"txn_amt_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hContext,"txn_amt",dTmp);
		}
		sprintf(csTag,"txn_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hRequest,"txn_ccy",csTmp);
		}
		sprintf(csTag,"dst_txn_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hContext,"dst_txn_ccy",csTmp);
		}

DEBUGLOG(("GetPayoutFee::Call BOExchange:GetExchangeInfo\n"));
		BOObjPtr = CreateObj(DBPtr,"BOExchange","GetExchangeInfo");
		if ((*BOObjPtr)(hContext,hRequest) == PD_OK) {
DEBUGLOG(("GetPayoutFee::GetExternalExchangeInfo Success\n"));
			if(GetField_Double(hContext,"dst_txn_amt",&dTmp)){
DEBUGLOG(("GetPayoutFee::Destination Amount=[%lf]\n",dTmp));
			}
			if(GetField_CString(hContext,"markup_ccy",&csTmp)){
				sprintf(csTag,"markup_ccy_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetPayoutFee::Markup Ccy=[%s]\n",csTmp));
			}
			if(GetField_Double(hContext,"markup_amt",&dTmp)){
				sprintf(csTag,"markup_amt_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::Markup Amount=[%lf]\n",dTmp));
			}
			if(GetField_Double(hContext,"markup_rate",&dTmp)){
DEBUGLOG(("GetPayoutFee::Markup rate=[%lf]\n",dTmp));
			}
			if(GetField_Double(hContext,"ex_rate",&dTmp)){
				sprintf(csTag,"ex_rate_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::Exchange rate=[%lf]\n",dTmp));
			}
		}
		else{
			iIntErr = INT_ERR;
DEBUGLOG(("GetPayoutFee:::GetExchangeInfo Error\n"));
ERRLOG("BOPayout:GetPayoutFee::::GetExchangeInfo Error\n");
		}

DEBUGLOG(("GetPayoutFee::Call BOFee:GetTxnFee\n"));
		BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
		if((unsigned long)(*BOObjPtr)(hContext,hRequest)==PD_OK){
			if(GetField_Double(hContext,"src_txn_fee",&dTmp)){
				sprintf(csTag,"merchant_fee_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::src txn fee=[%f]\n",dTmp));
			}
			if(GetField_Double(hContext,"net_amt",&dTmp)){
				dTotalSrcNetAmt += dTmp;
DEBUGLOG(("GetPayoutFee::src net amt=[%f]\n",dTmp));
			}
			if(GetField_Double(hContext,"dst_txn_fee",&dTmp)){
				sprintf(csTag,"member_fee_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::dst txn fee=[%f]\n",dTmp));
			}
			if(GetField_Double(hContext,"dst_net_amt",&dTmp)){
				sprintf(csTag,"payout_amt_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
				dTotalDstNetAmt += dTmp;

DEBUGLOG(("GetPayoutFee::dst net amt=[%lf]\n",dTmp));
DEBUGLOG(("GetPayoutFee::total dst net amt for [%s]=[%lf]\n",csTmp,dTotalDstNetAmt));
			}
		}
		else{
			iIntErr = INT_ERR;
DEBUGLOG(("GetPayoutFee::GetTxnFee Error\n"));
ERRLOG("BOPayout::GetPayoutFee:GetTxnFee Error\n");
		}

		sprintf(csTag,"int_error_%d",i);
		PutField_Int(hRequest,csTag,iIntErr);
	}

	if(GetField_Double(hRequest,"total_txn_amt",&dTmp)){
		PutField_Double(hContext,"txn_amt",dTmp);
	}
	PutField_Double(hContext,"net_amt",dTotalSrcNetAmt);	
	PutField_Double(hContext,"org_net_amt",dTotalSrcNetAmt);	
	PutField_Double(hContext,"dst_txn_amt",dTotalDstNetAmt);	

	PutField_CString(hContext,"txn_code","POA");

DEBUGLOG(("BOPayout:GetPayoutFee() iRet=[%d]\n",iRet));
	return 	iRet;
}

int GetPayoutPsp(hash_t *hContext,
                const hash_t* hRequest)
{
	int	iRet = PD_OK;
	hash_t  *hRec;

	char	csTag[PD_TMP_BUF_LEN+1];
	char	*csBankName;
	char	*csPspId;
	char	*csOperType;
	double	dOrgTxnAmt;
	double	dPspAmt=0.0;
	double	dTotalPayoutAmt=0.0;
	double	dTierAmt=0.0;
	double	dPct=0.0;
	double	dMinAmt=0.0;
	double	dMaxAmt=0.0;
	int	iTier = 0;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout:GetPayoutPsp()\n"));

 	if (GetField_CString(hContext,"bank_name",&csBankName)) {
DEBUGLOG(("BOPayout::GetPayoutPsp() bank_name = [%s]\n",csBankName));
        }
        else {
DEBUGLOG(("BOPayout::GetPayoutPsp() bank_name not found!!!\n"));
		iRet = INT_BANK_CODE_NOT_FOUND;
        }

 	if (GetField_Double(hContext,"txn_amt",&dOrgTxnAmt)) {
DEBUGLOG(("BOPayout::GetPayoutPsp() txn_amt = [%lf]\n",dOrgTxnAmt));
        }
        else {
DEBUGLOG(("BOPayout::GetPayoutPsp() txn_amt not found!!!\n"));
		iRet = INT_TXN_AMT_MISSING;
        }

	if (GetField_CString(hContext,"operator_type",&csOperType)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() operator_type = [%s]\n",csOperType));
	}
	if (GetField_CString(hContext,"psp_id",&csPspId)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() psp_id = [%s]\n",csPspId));
	}
	if (GetField_Double(hContext,"total_amt",&dPspAmt)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() total_amt = [%f]\n",dPspAmt));
	}

	sprintf(csTag,"%s_total_payout_amt_%s",csPspId,csBankName);
 	if (GetField_Double(hContext,csTag,&dTotalPayoutAmt)) {
DEBUGLOG(("BOPayout::GetPayoutPsp() org total_payout_amt = [%lf]\n",dTotalPayoutAmt));
        }


	if(iRet == PD_OK){
//RuleOperatorTypeDetail:GetRuleOperatorTypeDetail()
		DBObjPtr = CreateObj(DBPtr,"DBRuleOperatorTypeDetail","GetRuleOperatorTypeDetail");
		if ((unsigned long)(*DBObjPtr)(csOperType, rRecordSet)==PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if (GetField_Double(hRec,"amt_min",&dMinAmt)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() amount_min = [%f]\n",dMinAmt));
				}
				if (GetField_Double(hRec,"amt_max",&dMaxAmt)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() amount_max = [%f]\n",dMaxAmt));
				}

				if(dOrgTxnAmt>=dMinAmt && dOrgTxnAmt<=dMaxAmt){
					if (GetField_Int(hRec,"tier_id",&iTier)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() tier_id = [%d]\n",iTier));
					}
					if (GetField_Double(hRec,"amt_pct",&dPct)) {
DEBUGLOG(("BOPayout:GetPayoutPsp() amount_pct = [%lf]\n",dPct));
DEBUGLOG(("BOPayout:GetPayoutPsp() amount for tier[%d] = [%lf]\n",iTier,(dPspAmt*dPct/100)));
					}
				}

				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	if(iRet == PD_OK){
//no rules
		if(!strcmp(csOperType,PD_NO_RULE)){
			//do nothing
		}

//Less Than or Daily Limit
		else if(!strcmp(csOperType,PD_LESS_THAN) || !strcmp(csOperType,PD_DAILY_LIMIT)){
			if((dTotalPayoutAmt + dOrgTxnAmt) >= dPspAmt){
DEBUGLOG(("BOPayout:GetPayoutPsp() Payout Amt[%lf] >= Limited PSP Amt[%f]!!!\n",(dTotalPayoutAmt + dOrgTxnAmt),dPspAmt));
//ERRLOG("Payout amount exceeded limited psp amount!!!\n");
				iRet = INT_EXCEED_LIMIT_PSP_AMT;
			}
			else{
				sprintf(csTag,"%s_total_payout_amt_%s",csPspId,csBankName);
				PutField_Double(hContext,csTag,(dTotalPayoutAmt+dOrgTxnAmt));
DEBUGLOG(("BOPayout::GetPayoutPsp() %s (org) = [%lf], (new) = [%lf]\n",csTag,dTotalPayoutAmt,(dTotalPayoutAmt+dOrgTxnAmt)));
			}
		}

//customer rules
		else{
			sprintf(csTag,"%s_tier_%d_amt_%s",csPspId,iTier,csBankName);
 			if (GetField_Double(hContext,csTag,&dTierAmt)) {
        		}
DEBUGLOG(("BOPayout::GetPayoutPsp() %s (org) = [%lf], (new) = [%lf]\n",csTag,dTierAmt,(dTierAmt+dOrgTxnAmt)));

			if((dTierAmt+dOrgTxnAmt)>(dPspAmt*dPct/100)){
DEBUGLOG(("BOPayout:GetPayoutPsp() Payout Amt[%lf] > Limited PSP Amt[%f]!!!\n",(dTierAmt+dOrgTxnAmt),(dPspAmt*dPct/100)));
//ERRLOG("Payout amount exceeded limited psp amount!!!\n");
				iRet = INT_EXCEED_LIMIT_PSP_AMT;
			}
			else{
				PutField_Double(hContext,csTag,(dTierAmt+dOrgTxnAmt));
			}

			
		}
	}

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("BOPayout:GetPayoutPsp() exit = [%d]\n",iRet));
	return iRet;
}


int GetPayoutRule(hash_t *hContext,
		  hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iCnt = 0;
	int	iBank = PD_FALSE;
	double	dTmp=0.0;
	char	csBankName[PD_BANK_NAME_LEN+1];
	char	*csTmp;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout:GetPayoutRule()\n"));
DEBUGLOG(("BOPayout::Call DBRulePayoutPsp:GetRulePayoutPspWithPriority\n"));
	DBObjPtr = CreateObj(DBPtr,"DBRulePayoutPsp","GetRulePayoutPspWithPriority");
	if ((unsigned long)(*DBObjPtr)(rRecordSet) == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		iCnt = 0;
		while (hRec) {
			iBank=PD_FALSE;
			if (GetField_CString(hRec, "bank_name", &csTmp)) {
				strcpy(csBankName,TrimAllChar((const unsigned char*)csTmp,strlen(csTmp),PD_SPACE));
				if(strlen(csBankName)>0){
					//PutField_CString(hContext,"bank_name",csBankName);
					sprintf(csTag,"bank%d_bank_name",iCnt);
					PutField_CString(hRequest,csTag,csBankName);
					iBank=PD_TRUE;
DEBUGLOG(("GetRulePayoutPspWithPriority::bank_name = [%s]\n",csBankName));
				}
			}
			if (GetField_CString(hRec, "psp_id", &csTmp)) {
				sprintf(csTag,"bank%d_psp_id",iCnt);
				PutField_CString(hRequest,csTag,csTmp);
				//PutField_CString(hContext,"psp_id",csPspId);
//DEBUGLOG(("GetRulePayoutPspWithPriority::psp_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "operator_type", &csTmp)) {
				sprintf(csTag,"bank%d_operator_type",iCnt);
				PutField_CString(hRequest,csTag,csTmp);
				//PutField_CString(hContext,"operator_type",csTmp);
//DEBUGLOG(("GetRulePayoutPspWithPriority::operator_type = [%s]\n",csTmp));
			}
			if (GetField_Double(hRec, "total_amt", &dTmp)) {
				sprintf(csTag,"bank%d_total_amt",iCnt);
				PutField_Double(hRequest,csTag,dTmp);
				//PutField_Double(hContext,"total_amt",dTmp);
//DEBUGLOG(("GetRulePayoutPspWithPriority::total_amt = [%lf]\n",dTmp));
			}
			sprintf(csTag,"bank%d_present",iCnt);
			PutField_Int(hRequest,csTag,iBank);

			iCnt++;
			hRec = RecordSet_GetNext(rRecordSet);

			PutField_Int(hRequest,"bank_cnt",iCnt);
		}
	}
	else{
DEBUGLOG(("GetRulePayoutPspWithPriority::not found record!!\n"));
ERRLOG("BOPayout::GetPayoutRule:GetRulePayoutPspWithPriority::not found record!!\n");
		iRet=INT_ERR;
	}
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
DEBUGLOG(("BOPayout:GetPayoutPsp() iRet=[%d]\n",iRet));
	return iRet;
}



int AssignPsp(hash_t *hContext,
	      hash_t* hRequest,
	      hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iCnt = 0;
	int	i = 0;
	int	iTotal = 0;
	int	iTmp = 0;
	int	iResult = 0;
	int	iSeqNum = 0;
	int	iBank = PD_FALSE;
	int	iMerch = PD_FALSE;
	int	iResCnt = 0;
	int	iStatus = PD_FALSE;
	double	dResAmt = 0.0;
	double	dTmp=0.0;
	double	dTxnAmt=0.0;
	char	*csTmp;
	char	*csMerchantId;
	char	*csBatchId;
	char	*csBankName;
	char	*csPspId;
	char	*csPspCcy;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec, *hTxn;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	
DEBUGLOG(("BOPayout:AssignPsp()\n"));

	GetField_Int(hRequest,"bank_cnt",&iCnt);
	GetField_Int(hRequest,"mid_present",&iMerch);
	if(iMerch==PD_TRUE){
		GetField_CString(hRequest,"merchant_id",&csMerchantId);
	}

	for(i=0; i<iCnt;i++){
        	recordset_init(rRecordSet,0);

		sprintf(csTag,"bank%d_present",i);
		GetField_Int(hRequest,csTag,&iBank);
		if(iBank==PD_TRUE){
			sprintf(csTag,"bank%d_bank_name",i);
			if(GetField_CString(hRequest,csTag,&csBankName)){
				PutField_CString(hContext,"bank_name",csBankName);
DEBUGLOG(("AssignPsp::bank_name = [%s]\n",csBankName));
			}
		}
		sprintf(csTag,"bank%d_psp_id",i);
		if(GetField_CString(hRequest,csTag,&csPspId)){
			PutField_CString(hContext,"psp_id",csPspId);
DEBUGLOG(("AssignPsp::psp_id = [%s]\n",csPspId));
		}
		sprintf(csTag,"bank%d_operator_type",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hContext,"operator_type",csTmp);
DEBUGLOG(("AssignPsp::operator_type = [%s]\n",csTmp));
		}
		sprintf(csTag,"bank%d_total_amt",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hContext,"total_amt",dTmp);
DEBUGLOG(("AssignPsp::total_amt = [%lf]\n",dTmp));
		}

		if(iBank==PD_TRUE && iMerch==PD_TRUE){
DEBUGLOG(("AssignPsp::Call DBMerchantUploadFileDetail:GetDetailByRandomWithBankMerchant\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetailByRandomWithBankMerchant");
			iResult = (unsigned long)(*DBObjPtr)(csBankName,csMerchantId,rRecordSet);
		}
		else if(iBank==PD_FALSE && iMerch==PD_TRUE){
DEBUGLOG(("AssignPsp::Call DBMerchantUploadFileDetail:GetDetailByRandomWithMerchant\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetailByRandomWithMerchant");
			iResult = (unsigned long)(*DBObjPtr)(csMerchantId,rRecordSet);
		}
		else if(iBank==PD_TRUE && iMerch==PD_FALSE){
DEBUGLOG(("AssignPsp::Call DBMerchantUploadFileDetail:GetDetailByRandomWithBank\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetailByRandomWithBank");
			iResult = (unsigned long)(*DBObjPtr)(csBankName,rRecordSet);
		}
		else{
DEBUGLOG(("AssignPsp::Call DBMerchantUploadFileDetail:GetDetailByRandom\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetailByRandom");
			iResult = (unsigned long)(*DBObjPtr)(rRecordSet);
		}

		if(iResult == PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			iTmp = 0;
			while(hRec){
				if(GetField_CString(hRec,"batch_id",&csBatchId)){
					sprintf(csTag,"batch_id_%d",iTmp);
					PutField_CString(hTxn,csTag,csBatchId);
DEBUGLOG(("GetDetail::batch_id = [%s]\n",csBatchId));
				}
				if(GetField_Int(hRec,"seq_num",&iSeqNum)){
					sprintf(csTag,"seq_num_%d",iTmp);
					PutField_Int(hTxn,csTag,iSeqNum);
DEBUGLOG(("GetDetail::seq_num = [%d]\n",iSeqNum));
				}
				if(GetField_CString(hRec,"bank_name",&csTmp)){
					if(iBank!=PD_TRUE){
						PutField_CString(hContext,"bank_name",csTmp);
DEBUGLOG(("GetDetail::bank_name = [%s]\n",csTmp));
					}
				}
				if(GetField_CString(hRec,"payout_ccy",&csPspCcy)){
DEBUGLOG(("GetDetail::payout_ccy= [%s]\n",csPspCcy));
				}
				if (GetField_Double(hRec, "payout_amount", &dTxnAmt)) {
					PutField_Double(hContext,"txn_amt",dTxnAmt);
DEBUGLOG(("GetDetail::txn_amt = [%lf]\n",dTxnAmt));
				}

DEBUGLOG(("AssignPsp::Call GetPayoutPsp\n"));
				iResCnt = 0;
				dResAmt = 0.0;
				sprintf(csTag,"psp_id_%d",iTmp);
				if((unsigned long)GetPayoutPsp(hContext,hRequest)==PD_OK){
					PutField_CString(hTxn,csTag,csPspId);

					sprintf(csTag,"%s_payout_ccy",csPspId);
					PutField_CString(hContext,csTag,csPspCcy);

					sprintf(csTag,"%s_accept_cnt",csPspId);
					GetField_Int(hContext,csTag,&iResCnt);
					iResCnt ++;
					PutField_Int(hContext,csTag,iResCnt);

					sprintf(csTag,"%s_accept_amt",csPspId);
					GetField_Double(hContext,csTag,&dResAmt);
					dResAmt += dTxnAmt;
					PutField_Double(hContext,csTag,dResAmt);

//check if the record was failed in the previous rule, update the pending count
					sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
					if(GetField_Int(hContext,csTag,&iStatus)){
						if(iStatus==PD_TRUE){
							iResCnt=0;
							dResAmt=0.0;
							sprintf(csTag,"%s%d_psp",csBatchId,iSeqNum);
							if(GetField_CString(hContext,csTag,&csTmp)){
								sprintf(csTag,"%s_pending_cnt",csTmp);
								GetField_Int(hContext,csTag,&iResCnt);
								iResCnt --;
								PutField_Int(hContext,csTag,iResCnt);

								sprintf(csTag,"%s_pending_amt",csTmp);
								GetField_Double(hContext,csTag,&dResAmt);
								dResAmt -= dTxnAmt;
								PutField_Double(hContext,csTag,dResAmt);
							}
						}
					}
DEBUGLOG(("AssignPsp::Call GetPayoutPsp Success\n"));
				}
				else{
					PutField_CString(hTxn,csTag,"");

//check if the record was failed in the previous rule, not to update the pending count.
					sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
					if(!GetField_Int(hContext,csTag,&iStatus)){
						sprintf(csTag,"%s_pending_cnt",csPspId);
						GetField_Int(hContext,csTag,&iResCnt);
						iResCnt ++;
						PutField_Int(hContext,csTag,iResCnt);

						sprintf(csTag,"%s_pending_amt",csPspId);
						GetField_Double(hContext,csTag,&dResAmt);
						dResAmt += dTxnAmt;
						PutField_Double(hContext,csTag,dResAmt);

						sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
						PutField_Int(hContext,csTag,PD_TRUE);
						sprintf(csTag,"%s%d_psp",csBatchId,iSeqNum);
						PutField_CString(hContext,csTag,csPspId);
					}
DEBUGLOG(("AssignPsp::Call GetPayoutPsp Failed\n"));
				}

				hRec = RecordSet_GetNext(rRecordSet);
				iTmp++;
				iTotal++;
				PutField_Int(hTxn,"total_count",iTmp);
			}

			if(iTmp>0){
				if((unsigned long)UpdateDetail(hContext,hTxn)==PD_OK){
DEBUGLOG(("AssignPsp::Update Detail Success\n"));
				}
			}
		}

	}//end for loop

	if(iTotal==0){
DEBUGLOG(("AssignPsp::No Pending record\n"));
                PutField_Int(hResponse,"total_cnt",iTotal);
                iRet = INT_NO_PENDING_RECORD;
        }

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);

DEBUGLOG(("BOPayout:AssignPsp() iRet=[%d]\n",iRet));
	return iRet;
}

int FormatResponse(const hash_t *hContext,
		   hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	i = 1;
	int	iAcceptCnt,iPendingCnt;
	double	dAcceptAmt,dPendingAmt;
	char	*csPspId;
	char	*csCcy;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout:FormatResponse()\n"));

	DBObjPtr = CreateObj(DBPtr,"DBRulePayoutPsp","GetExistingPsp");
	if((unsigned long) ((*DBObjPtr)(rRecordSet))==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
		while(hRec){
			iAcceptCnt = 0;
			iPendingCnt = 0;
			dAcceptAmt = 0.0;
			dPendingAmt = 0.0;

			if(GetField_CString(hRec,"psp_id",&csPspId)){
				sprintf(csTag,"psp_id_%d",i);
				PutField_CString(hResponse,csTag,csPspId);

				sprintf(csTag,"%s_accept_cnt",csPspId);
				GetField_Int(hContext,csTag,&iAcceptCnt);
				sprintf(csTag,"accept_cnt_%d",i);
				PutField_Int(hResponse,csTag,iAcceptCnt);

				sprintf(csTag,"%s_pending_cnt",csPspId);
				GetField_Int(hContext,csTag,&iPendingCnt);
				sprintf(csTag,"pending_cnt_%d",i);
				PutField_Int(hResponse,csTag,iPendingCnt);

				sprintf(csTag,"%s_payout_ccy",csPspId);
				if(GetField_CString(hContext,csTag,&csCcy)){
					sprintf(csTag,"ccy_%d",i);
					PutField_CString(hResponse,csTag,csCcy);
				}
				else{
					sprintf(csTag,"ccy_%d",i);
					PutField_CString(hResponse,csTag,"-");
				}

				sprintf(csTag,"%s_accept_amt",csPspId);
				GetField_Double(hContext,csTag,&dAcceptAmt);
				sprintf(csTag,"accept_amt_%d",i);
				PutField_Double(hResponse,csTag,dAcceptAmt);
				
				sprintf(csTag,"%s_pending_amt",csPspId);
				GetField_Double(hContext,csTag,&dPendingAmt);
				sprintf(csTag,"pending_amt_%d",i);
				PutField_Double(hResponse,csTag,dPendingAmt);

				PutField_Int(hResponse,"total_cnt",i);
				i++;
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

DEBUGLOG(("BOPayout:FormatResponse() iRet=[%d]\n",iRet));
	return iRet;
}


int CreatePayoutFile(const char* csPspId, hash_t* hContext)
{
	int iRet = PD_OK;

	FILE    *fp;
	char*    csDate;
	char    csPayOutFile[PD_MAX_FILE_LEN + 1];
	char    csPayOutFilePath[PD_MAX_FILE_LEN + 1];
	char    csPayOutFileName[PD_FILENAME_LEN + 1];
	char    csTag[PD_TAG_LEN +1];
	char    csFileId[PD_TXN_SEQ_LEN + 1];
	unsigned long lFileId=0l;
	int     iSeqNum=0;

DEBUGLOG(("BOPayout:CreatePayoutFile()\n"));

	memset(csPayOutFilePath, 0, sizeof(csPayOutFilePath));
	memset(csPayOutFileName, 0, sizeof(csPayOutFileName));
	memset(csFileId, 0, sizeof(csFileId));


	if(GetField_CString(hContext,"PHDATE",&csDate)){
		PutField_CString(hContext,"file_date",csDate);
		PutField_CString(hContext,"file_pid",csPspId);
DEBUGLOG(("CreatePayoutFile::File Date[%s], PID[%s]\n", csDate,csPspId));
	}

DEBUGLOG(("CreatePayoutFile::DBPayoutGeneratedFileHD:GetNextSeq\n"));
	DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetNextSeq");
	if((unsigned long) ((*DBObjPtr)(csDate,csPspId,&iSeqNum))!=PD_OK){
		iRet = INT_ERR;
DEBUGLOG(("CreatePayoutFile::DBPayoutGeneratedFileHD:GetNextSeq Failed\n"));
	}
	else{
		sprintf(csPayOutFilePath, "%s", getenv("OUTPUT_PAYOUT"));
		sprintf(csPayOutFileName, "%s_%s%02d.xls", csPspId, csDate,iSeqNum);

		sprintf(csTag,"%s_seq_num",csPspId);
		PutField_Int(hContext,csTag,iSeqNum);
		PutField_Int(hContext,"seq_num",iSeqNum);

		sprintf(csTag,"%s_file",csPspId);
		PutField_CString(hContext,csTag,csPayOutFileName);
		PutField_CString(hContext,"filename",csPayOutFileName);

		sprintf(csPayOutFile, "%s/%s", csPayOutFilePath, csPayOutFileName);
		sprintf(csTag,"%s_path",csPspId);
		PutField_CString(hContext,csTag,csPayOutFile);
	}

	if(iRet==PD_OK){
DEBUGLOG(("CreatePayoutFile::DBPayoutGeneratedFileHD:GetNextFileId\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetNextFileId");
		if((unsigned long) ((*DBObjPtr)(&lFileId))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("CreatePayoutFile::DBPayoutGeneratedFileHD:GetNextFileId Failed\n"));
		}
		else{
			sprintf(csFileId,"%ld",lFileId);
			sprintf(csTag,"%s_file_id",csPspId);
			PutField_CString(hContext,csTag,csFileId);
			PutField_CString(hContext,"file_id",csFileId);
		}
	}


	if(iRet==PD_OK) {
DEBUGLOG(("CreatePayoutFile::Open PayoutFile [%s] for psp id [%s]\n", csPayOutFile, csPspId));
		fp = fopen(csPayOutFile, "w");
		if (fp == NULL) {
DEBUGLOG(("CreatePayoutFile::Open Payoutfile [%s] problem\n", csPayOutFile));
ERRLOG("BOPayout:CreatePayoutFile::Open Payoutfile problem!!\n");
			iRet=INT_ERR;
		}
	}

	if(iRet==PD_OK) {
		fprintf(fp, "<html><body><table>\n");
		fprintf(fp, "<style type=\"text/css\"> .format{ mso-number-format:'\\@';} </style>\n");
		fprintf(fp, "%s%s%s%s Payout Records%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s\n",
				PD_TR, PD_TD, PD_BOLD, csPspId, PD_BOLD_END, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TR_END);

		fclose(fp);
	}

	if(iRet==PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Add");
		if((unsigned long)(*DBObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("CreatePayoutFile::PayoutGeneratedFileHD::Add Error!!!\n"));
			iRet = INT_ERR;
		}

	}

DEBUGLOG(("BOPayout:CreatePayoutFile() iRet=[%d]\n",iRet));
	return iRet;
}


int WriteAssignedRecord(hash_t *hContext,
			hash_t* hRequest)
{
	int	iRet=PD_OK;
	int	i=0;
	int	iTmp=0;
	int	iTxnCnt=0;
	double	dTmp = 0.0;
	double	dAmt = 0.0;
	char	*csTmp;
	char	*csPspId;
	char	*csFilePath;
	char	*csTxnCcy;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec, *hDetail;

        hDetail= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hDetail,0);
	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOPayout:WriteAssignedRecord()\n"));
	if (GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hDetail,"add_user",csTmp);
	}

DEBUGLOG(("WriteAssignedRecord::Call DBMerchantUploadFileDetail:GetPspAssignedTxn\n"));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetPspAssignedTxn");
	if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
		i = 0;
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec && (iRet==PD_OK)) {
			if (GetField_CString(hRec, "psp_id", &csPspId)) {
				sprintf(csTag, "%s_file", csPspId);
				GetField_CString(hContext,csTag,&csTmp);
				
				sprintf(csTag,"generated_file_name_%d", i);
				PutField_CString(hRequest,csTag,csTmp);

				sprintf(csTag, "%s_file_id", csPspId);
				GetField_CString(hContext,csTag,&csTmp);
				sprintf(csTag,"file_id_%d", i);
				PutField_CString(hDetail,csTag,csTmp);

				sprintf(csTag, "%s_path", csPspId);
				GetField_CString(hContext,csTag,&csFilePath);
DEBUGLOG(("GetPspAssignedTxn::psp_id = [%s]\n",csPspId));
			}
			if (GetField_CString(hRec, "txn_id", &csTmp)) {
				sprintf(csTag, "txn_id_%d", i);
				PutField_CString(hDetail,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::txn_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "batch_id", &csTmp)) {
				sprintf(csTag, "batch_id_%d", i);
				PutField_CString(hRequest,csTag,csTmp);
				PutField_CString(hDetail,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::batch_id = [%s]\n",csTmp));
			}
			if (GetField_Int(hRec, "seq_num", &iTmp)) {
				sprintf(csTag, "seq_num_%d", i);
				PutField_Int(hRequest,csTag,iTmp);
				PutField_Int(hDetail,csTag,iTmp);
DEBUGLOG(("GetPspAssignedTxn::seq_num = [%d]\n",iTmp));
			}
			if (GetField_CString(hRec,"txn_country", &csTmp)) {
				sprintf(csTag, "%s_txn_country", csPspId);
				PutField_CString(hContext,csTag,csTmp);
				sprintf(csTag, "txn_country_%d", i);
				PutField_CString(hDetail,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::txn_country = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"request_ccy", &csTmp)) {
				sprintf(csTag, "request_ccy_%d", i);
				PutField_CString(hDetail,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::request_ccy = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"payout_ccy", &csTmp)) {
				if(strcmp(csTmp,"RMB"))
					csTxnCcy=strdup(csTmp);
				else
					csTxnCcy=strdup(PD_CCY_ISO_CNY);

				sprintf(csTag, "%s_payout_ccy", csPspId);
				PutField_CString(hContext,csTag,csTxnCcy);
				sprintf(csTag, "payout_ccy_%d", i);
				PutField_CString(hDetail,csTag,csTmp);
				FREE_ME(csTxnCcy);
DEBUGLOG(("GetPspAssignedTxn::payout_ccy = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"account_name", &csTmp)) {
				sprintf(csTag, "account_name_%d", i);
				PutField_CString(hDetail,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::account_name = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"account_num", &csTmp)) {
				sprintf(csTag, "account_num_%d", i);
				PutField_CString(hDetail,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::account_num = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"bank_name", &csTmp)) {
				sprintf(csTag, "bank_name_%d", i);
				PutField_CString(hDetail,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::bank_name = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"branch", &csTmp)) {
				sprintf(csTag, "branch_%d", i);
				PutField_CString(hDetail,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::branch = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"identity_id", &csTmp)) {
				sprintf(csTag, "identity_id_%d", i);
				PutField_CString(hDetail,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::identity_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"phone_num", &csTmp)) {
				sprintf(csTag, "phone_num_%d", i);
				PutField_CString(hDetail,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::phone_num = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"merchant_ref", &csTmp)) {
				sprintf(csTag, "merchant_ref_%d", i);
				PutField_CString(hDetail,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::merchant_ref = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"remark", &csTmp)) {
DEBUGLOG(("GetPspAssignedTxn::remark = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"province", &csTmp)) {
				sprintf(csTag, "province_%d", i);
				PutField_CString(hDetail,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::province = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"city", &csTmp)) {
				sprintf(csTag, "city_%d", i);
				PutField_CString(hDetail,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::city = [%s]\n",csTmp));
			}
			if (GetField_Double(hRec,"request_amount", &dTmp)) {
				sprintf(csTag, "request_amount_%d", i);
				PutField_Double(hDetail,csTag,dTmp);
DEBUGLOG(("GetPspAssignedTxn::request_amount = [%lf]\n",dTmp));
			}
			if (GetField_Double(hRec,"payout_amount", &dTmp)) {
				sprintf(csTag, "payout_amount_%d", i);
				PutField_Double(hDetail,csTag,dTmp);
DEBUGLOG(("GetPspAssignedTxn::payout_amount = [%lf]\n",dTmp));

				sprintf(csTag,"org_dst_net_amt_%s",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dTmp;
				}
				else{
					dAmt = dTmp;
				}
				PutField_Double(hContext,csTag,dAmt);

				sprintf(csTag,"%s_txn_amt",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dTmp;
				}
				else{
					dAmt = dTmp;
				}
				PutField_Double(hContext,csTag,dAmt);
			}
			if (GetField_CString(hRec,"merchant_fee_ccy", &csTmp)) {
				sprintf(csTag,"%s_merchant_fee_ccy",csPspId);
				PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::merchant_fee_ccy = [%s]\n",csTmp));
			}
			if (GetField_Double(hRec,"merchant_fee", &dTmp)) {
				sprintf(csTag,"%s_merchant_fee",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dTmp;
				}
				else{
					dAmt = dTmp;
				}
				PutField_Double(hContext,csTag,dAmt);
DEBUGLOG(("GetPspAssignedTxn::merchant_fee = [%lf]\n",dTmp));
			}

			if (GetField_CString(hRec,"member_fee_ccy", &csTmp)) {
				sprintf(csTag,"%s_member_fee_ccy",csPspId);
				PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::member_fee_ccy = [%s]\n",csTmp));
			}

			if (GetField_Double(hRec,"markup_amt", &dTmp)) {
DEBUGLOG(("GetPspAssignedTxn::markup_amt = [%lf]\n",dTmp));
			}

			if (GetField_Double(hRec,"member_fee", &dTmp)) {
				sprintf(csTag,"%s_member_fee",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dTmp;
				}
				else{
					dAmt = dTmp;
				}
				PutField_Double(hContext,csTag,dAmt);
DEBUGLOG(("GetPspAssignedTxn::member_fee = [%lf]\n",dTmp));
			}
			iTxnCnt = 0;
			sprintf(csTag,"%s_txn_cnt",csPspId);
			GetField_Int(hContext,csTag,&iTxnCnt);
			PutField_Int(hContext,csTag,iTxnCnt+1);

			if(WritePayoutFile(csFilePath,hRec)!=PD_OK){
				iRet = INT_ERR;
DEBUGLOG(("GetpspAssignedTxn::WritePayoutFile Error!!!\n"));
ERRLOG("BOPayout::WriteAssignedRecord::GetpspAssignedTxn:WritePayoutFile Error!!!\n");
			}

			i++;
			hRec = RecordSet_GetNext(rRecordSet);
		}
		PutField_Int(hRequest,"total_count",i);
		PutField_Int(hDetail,"total_count",i);
DEBUGLOG(("GetPspAssignedTxn::total_count= [%d]\n",i));

DEBUGLOG(("GetPspAssignedTxn::Call InsertGenFileDT\n"));
		if (InsertGenFileDT(hDetail)!= PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("GetPspAssignedTxn::InsertGenFileDT Failed\n"));
		}
	}
	else{
DEBUGLOG(("GetpspAssignedTxn::Failed!!!!\n"));
ERRLOG("BOPayout:WriteAssignedRecord::GetPspAssignedTxn::Failed!!\n");
		iRet=INT_NOT_RECORD;
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hDetail);
DEBUGLOG(("GetpspAssignedTxn::iRet=[%d]\n",iRet));
	return iRet;
}


int WritePayoutFile(const char* csPayOutFile, hash_t* hRec)
{
	int     iRet=PD_OK;
	int     iTmp;
	char*   csTmp;
	double  dTmp;

DEBUGLOG(("BOPayout:WritePayoutFile()\n"));
	FILE    *fp;
	fp = fopen(csPayOutFile, "a");
	if (fp == NULL) {
DEBUGLOG(("WritePayoutFile::Open Payoutfile [%s] problem\n", csPayOutFile));
ERRLOG("BOPayout:WritePayoutFile::Open Payoutfile problem!!\n");
		iRet=INT_ERR;
	}

	if(iRet==PD_OK) {
		if(GetField_Int(hRec,"end_file",&iTmp)){
			if(iTmp==PD_TRUE){
				fprintf(fp, "</table></body></html>\n");
				fclose(fp);
				return iRet;
			}
		}
	}

	if(iRet==PD_OK) {
		fprintf(fp, "%s%sPayout Trans No.%s%sReceiver Name%s%sID Card No.%s%sMobile No.%s%sBank%s%sBranch%s%sBank Account%s%sAmount%s%sProvince%s%sCity%s%sRemarks%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);

		fprintf(fp, "%s", PD_TR);

		if (!GetField_CString(hRec, "merchant_ref", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:merchant_ref [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "account_name", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:account_name [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "identity_id", &csTmp)) {
			csTmp = strdup("0000000");
		}
DEBUGLOG(("WritePayoutFile:identity_id [%s]\n", csTmp));
		fprintf(fp, "%s[%s]%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "phone_num", &csTmp)) {
			csTmp = strdup("0000000");
		}
DEBUGLOG(("WritePayoutFile:phone_num [%s]\n", csTmp));
		fprintf(fp, "%s[%s]%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "bank_name", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:bank_name [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "branch", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:branch [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "account_num", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:account_num [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

		if (!GetField_Double(hRec, "payout_amount", &dTmp)) {
			dTmp = 0.0;
		}
DEBUGLOG(("WritePayoutFile:payout_amount [%f]\n", dTmp));
		fprintf(fp, "%s%f%s",PD_TD,dTmp,PD_TD_END);

		if (!GetField_CString(hRec, "province", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:province [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "city", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:city [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "remark", &csTmp)) {
			csTmp = strdup("");
		}
DEBUGLOG(("WritePayoutFile:remark [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		fprintf(fp, "%s\n", PD_TR_END);

	}

	FREE_ME(csTmp);
	fclose(fp);
DEBUGLOG(("WritePayoutFile: iRet[%d]\n", iRet));
	return iRet;
}


int GetGenFileDetail(hash_t *hContext,
		     hash_t* hRequest)
{
	int	iRet=PD_OK;
	int	i=0;
	int	iTmp=0;
	double	dTmp = 0.0;
	double	dAmt = 0.0;
	char	*csTmp;
	char	*csPhDate;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;
	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
DEBUGLOG(("GetGenFileDetail()\n"));

DEBUGLOG(("GetGenFileDetail::Call DBPayoutGeneratedFileHD:GetHeader\n"));
	DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetHeader");
	iRet = (unsigned long)(*DBObjPtr)(hRequest,rRecordSet);
	if (iRet == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if (GetField_CString(hRec, "psp_id", &csTmp)) {
				PutField_CString(hContext,"org_psp_id",csTmp);
DEBUGLOG(("GetHeader::psp_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "file_date", &csTmp)) {
				if(GetField_CString(hContext,"PHDATE",&csPhDate)){
					if(strcmp(csPhDate,csTmp)){
						iRet = INT_INVALID_TXN;
DEBUGLOG(("GetHeader::file date expired. Cannot cancel file!!!\n"));
					}
				}
DEBUGLOG(("GetHeader::file_date = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "filename", &csTmp)) {
DEBUGLOG(("GetHeader::filename = [%s]\n",csTmp));
			}
			if (GetField_Int(hRec, "status", &iTmp)) {
DEBUGLOG(("GetHeader::status = [%d]\n",iTmp));
				if(iTmp!=PD_PAYOUTFILE_GENERATED){
					iRet = INT_INVALID_TXN;
DEBUGLOG(("GetHeader::invalid status. Cannot cancel file[%s]!!!\n",csTmp));
				}
			}
			if (GetField_Int(hRec, "txn_count", &iTmp)) {
				PutField_Int(hContext,"total_count",iTmp);
DEBUGLOG(("GetHeader::txn_cnt = [%d]\n",iTmp));
			}
			if (GetField_Double(hRec, "total_txn_amt", &dTmp)) {
DEBUGLOG(("GetHeader::total_txn_amt = [%lf]\n",dTmp));
			}
			if (GetField_CString(hRec, "payout_ccy", &csTmp)) {
				PutField_CString(hContext,"org_psp_txn_ccy",csTmp);
DEBUGLOG(("GetHeader::payout_ccy = [%s]\n",csTmp));
			}

			hRec = RecordSet_GetNext(rRecordSet);
		}
	}
	RecordSet_Destroy(rRecordSet);

	if(iRet==PD_OK){
		recordset_init(rRecordSet,0);
DEBUGLOG(("GetGenFileDetail::Call DBPayoutGeneratedFileDT:GetDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","GetDetail");
		iRet = (unsigned long)(*DBObjPtr)(hRequest,rRecordSet);
		if (iRet == PD_OK) {
			i = 0;
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec, "batch_id", &csTmp)) {
					sprintf(csTag, "batch_id_%d", i);
					PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetDetail::batch_id = [%s]\n",csTmp));
				}
				if (GetField_Int(hRec, "seq_num", &iTmp)) {
					sprintf(csTag, "seq_num_%d", i);
					PutField_Int(hRequest,csTag,iTmp);
DEBUGLOG(("GetDetail::seq_num = [%d]\n",iTmp));
				}
				if (GetField_CString(hRec, "txn_country", &csTmp)) {
					PutField_CString(hContext,"org_txn_country",csTmp);
DEBUGLOG(("GetDetail::txn_country = [%s]\n",csTmp));
				}
				if(GetField_Double(hRec,"payout_amount",&dTmp)){
DEBUGLOG(("GetDetail::payout_amount = [%lf]\n",dTmp));
					if(GetField_Double(hContext,"org_dst_net_amt",&dAmt))
						dAmt += dTmp;
					else
						dAmt = dTmp;

					PutField_Double(hContext,"org_dst_net_amt",dAmt);
				}

				sprintf(csTag, "psp_id_%d", i);
				PutField_CString(hRequest,csTag,"");
				sprintf(csTag, "generated_file_name_%d", i);
				PutField_CString(hRequest,csTag,"");

				i++;	
				PutField_Int(hRequest,"total_count",i);
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

DEBUGLOG(("GetGenFileDetail: iRet[%d]\n", iRet));
	return iRet;
}

int GenerateBatchSeq(hash_t* hRequest)
{
	int	iRet=PD_OK;
	int	iCnt=0;
	int	i=0;
	char	*csTxnSeq;
	char	csTag[PD_TAG_LEN +1];

	if(GetField_Int(hRequest,"total_count",&iCnt)){
		for(i=0; i<iCnt; i++){
			DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextBatchTxnSeq");
			sprintf(csTag,"txn_seq_%d",i);
			csTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("GenerateBatchSeq: [%d]=[%s]\n",i,csTxnSeq));
			PutField_CString(hRequest,csTag,csTxnSeq);

			FREE_ME(csTxnSeq);
		}
	}
	return iRet;
}
