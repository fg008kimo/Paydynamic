/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/08/31              Cody Chan
update 0.0.1 (Get Merchant Key)			   2011/01/07              LokMan Chow
add ccy and country checking			   2011/02/18		   LokMan Chow
replaced ccy and country with merchanbalacct	   2011/06/08		   Cody Chan
check status of merchant and client		   2011/09/15		   LokMan Chow
Amend GetMerchantTxnInfo with pay_method checking  2012/03/16              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOMerchant.h"

char    cDebug;

void BOMerchant(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(DB);


int GetMerchantTxnInfo(hash_t *hContext,
                const hash_t* hRequest)
{
        int     iRet = PD_OK;
	char*	csServiceCode;
	char*	csMerchantId;
	char*	csTmp;
	char*	csTxnCcy;
	char*	csTxnCountry;
	char*	csMerchantClientId;
	int	iTmp;
	double	dTmp;
	hash_t  *hClient;	
	char*	csPayMethod;

	hash_t  *hRec;	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	if (GetField_CString(hRequest,"service_code",&csServiceCode)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() service_code = [%s]\n",csServiceCode));
	}
	else  {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() service_code is missing!!!\n"));
ERRLOG("BOMerchant::GetMerchantTxnInfo() service_code is missing!!!\n");
		iRet = INT_ERR;
	}

	if (GetField_CString(hRequest,"merchant_id",&csMerchantId)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() merchant_id = [%s]\n",csMerchantId));
	}
	else 
		iRet = INT_MERCHANT_ID_NOT_FOUND;



	if (iRet == PD_OK ) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GetMerchant");
         	if ((*DBObjPtr)(csMerchantId,
       	                 rRecordSet) != PD_OK) {
               	 	iRet = INT_MERCHANT_ID_NOT_FOUND;
ERRLOG("BOMerchant::GetMerchantTxnInfo() Merchant Account [%s] not found\n",csMerchantId);
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Merchant Account [%s] not found\n",csMerchantId));
               	}               
		else {
			
               	 	iRet = INT_MERCHANT_ID_NOT_FOUND;
                	hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_Int(hRec,"disabled",&iTmp)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetMerchantDetail - disabled = [%d]\n",iTmp));
				}
				if(GetField_CString(hRec,"status",&csTmp)){
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetMerchantDetail - status = [%s]\n",csTmp));
				}

				if (iTmp != PD_DISABLED) {
					if(!strcmp(csTmp,PD_ACC_OPEN)){
						iRet = PD_OK;
						if (GetField_CString(hRec,"merchant_name",&csTmp)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetMerchantDetail - merchant_name = [%s]\n",csTmp));
						}
						if (GetField_CString(hRec,"merchant_client_id",&csMerchantClientId)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetMerchantDetail - merchant_client_id = [%s]\n",csMerchantClientId));
							PutField_CString(hContext,"merchant_client_id",csMerchantClientId);
						}
						if (GetField_Double(hRec,"approximate_fee_rate",&dTmp)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetMerchantDetail - approximate_fee_rate = [%lf]\n",dTmp));
							PutField_Double(hContext,"approximate_fee_rate",dTmp);
						}
					}
					else{
ERRLOG("BOMerchant::GetMerchantTxnInfo() Merchant Account [%s] not opened\n",csMerchantId);
						iRet = INT_ACCOUNT_DISABLED;
					}
				}
				else {
ERRLOG("BOMerchant::GetMerchantTxnInfo() Merchant Account [%s] disabled\n",csMerchantId);
					iRet = INT_ACCOUNT_DISABLED;
				}


				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}
	//RecordSet_Destroy(rRecordSet);


	if(iRet == PD_OK){
		hClient = (hash_t*) malloc (sizeof(hash_t));
        	hash_init(hClient,0);
		DBObjPtr = CreateObj(DBPtr,"DBClients","GetClients");
		if ((*DBObjPtr)(csMerchantClientId,hClient) != PD_OK){
			iRet = INT_ERR;
ERRLOG("BOMerchant::GetMerchantTxnInfo() Client ID for Account[%s] not found\n",csMerchantId);
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Client ID Account[%s] not found\n",csMerchantId));
		}
		else{
			if (GetField_CString(hClient,"status",&csTmp)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetClients - status = [%s]\n",csTmp));
					if(strcmp(csTmp,PD_ACC_OPEN)){
ERRLOG("BOMerchant::GetMerchantTxnInfo() Client Account [%s] not opened\n",csMerchantClientId);
						iRet = INT_ACCOUNT_DISABLED;
					}
			}
		}
		FREE_ME(hClient);
	}

	if (iRet == PD_OK ) {
		recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBMerchKeys","GetMerchantKey");
                if ((*DBObjPtr)(csMerchantId,"PTK",rRecordSet) != PD_OK) {
			iRet = INT_ERR;
ERRLOG("BOMerchant::GetMerchantTxnInfo() Merchant Key for Account[%s] not found\n",csMerchantId);
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Merchant key for Account[%s] not found\n",csMerchantId));
		}
		else{
			iRet = INT_ERR;
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if (GetField_CString(hRec,"key_value",&csTmp)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetMerchantKey - merchant_key_value = [%s]\n",csTmp));
					PutField_CString(hContext,"merchant_key",csTmp);
					iRet = PD_OK;
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	if(iRet == PD_OK){
		if (!GetField_CString(hRequest,"txn_ccy",&csTxnCcy)) {
			iRet = INT_ERR;
ERRLOG("BOMerchant::GetMerchantTxnInfo() Currency for Account is missing\n");
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Currency for Account is missing\n"));
		}
		else {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() txn ccy = [%s]\n",csTxnCcy));
		}
		if (!GetField_CString(hRequest,"txn_country",&csTxnCountry)) {
			iRet = INT_ERR;
ERRLOG("BOMerchant::GetMerchantTxnInfo() Txn Country for Account is missing\n");
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Txn Country for Account is missing\n"));
		}
		else {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() txn country = [%s]\n",csTxnCountry));
		}
		if (iRet == PD_OK) {
			DBObjPtr = CreateObj(DBPtr,"DBMerchantBalAcct","CheckMerchantBalAcct");
                	if ((unsigned long)((*DBObjPtr)(csMerchantId,
							csTxnCountry,
							csTxnCcy,
							csServiceCode,
							hContext)) != PD_FOUND) {
				iRet = INT_INVALID_TXN;
ERRLOG("BOMerchant::GetMerchantTxnInfo() Invalid txn acct [%d] [%s] [%s] [%s]\n",iRet,csMerchantId,csTxnCountry,csTxnCcy);
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Invalid txn acct  [%d] [%s] [%s] [%s]\n",iRet,csMerchantId,csTxnCountry,csTxnCcy));
			}
		}
	}


	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "pay_method", &csPayMethod)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() pay_method = [%s]\n",csPayMethod));
			int iMaxField = (int)(PD_PAY_METHOD_LIST_LEN/PD_PAY_METHOD_LEN);
                        char csList[iMaxField][PD_PAY_METHOD_LEN];
                        char *p;
                        int iFieldCnt = 0;
                        int iValidCnt = 0;
                        int i;

                        p = strtok (csPayMethod,",");
                        while (p != NULL)
                        {
                                strcpy(csList[iFieldCnt],p);
                                csList[iFieldCnt][strlen(p)]='\0';
                                p = strtok (NULL,",");
                                iFieldCnt++;
                        }

                        for(i=0;i<iFieldCnt;i++){
                                DBObjPtr = CreateObj(DBPtr,"DBMerchantPayMethod","FindMerchantPayMethod");
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() call DBMerchantPayMethod:FindMerchantPayMethod [%s] [%s]\n", csMerchantId, csList[i]));
                                if ((unsigned long)((*DBObjPtr)(csMerchantId, csList[i])) != PD_OK) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Unsupport Pay Method [%d] [%s] [%s]\n",iRet,csMerchantId,csList[i]));
                                }
                                else {
                                        iValidCnt ++;
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Support Pay Method [%d] [%s] [%s]\n",iRet,csMerchantId,csList[i]));
                                }
                        }
                        if(iValidCnt==0){
                                        iRet = INT_UNSUPPORTED_PAY_METHOD;
ERRLOG("BOMerchant::GetMerchantTxnInfo() All Pay Method UnSupported[%d] [%s]\n",iRet,csMerchantId);
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() All Pay Method UnSupported[%d] [%s]\n",iRet,csMerchantId));
                        }
		}
	}


DEBUGLOG(("BOMerchant::testing 2~~~~~~~~~~~~\n"));

	if (iRet != PD_OK) {
		PutField_Int(hContext,"internal_error",iRet);
	}

	//FREE_ME(hClient);
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

DEBUGLOG(("iRet = [%d]\n",iRet));
	return iRet;
}
int GetMerchantDetail(hash_t *hContext,
                const hash_t* hRequest)
{
        int     iRet = PD_OK;
	char*	csMerchantId;
	char*	csMerchantClientId;
	char*	csTmp;
	double	dTmp;
	int	iTmp;

	hash_t  *hClient;	
	hash_t  *hRec;	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	if (GetField_CString(hRequest,"merchant_id",&csMerchantId)) {
DEBUGLOG(("BOMerchant: GetMerchatDetail- merchant_id = [%s]\n",csMerchantId));
	}
	else 
		iRet = INT_MERCHANT_ID_NOT_FOUND;
	if (iRet == PD_OK ) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GetMerchant");
         	if ((unsigned long)(*DBObjPtr)(csMerchantId,
       	                 rRecordSet) != PD_OK) {
               	 	iRet = INT_MERCHANT_ID_NOT_FOUND;
ERRLOG("BOMerchant: Merchant Account [%s] not found\n",csMerchantId);
DEBUGLOG(("BOMerchant: Merchant Account [%s] not found\n",csMerchantId));
               	}               
		else {
			
               	 	iRet = INT_MERCHANT_ID_NOT_FOUND;
                	hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				iRet = PD_OK;
				if (GetField_Int(hRec,"disabled",&iTmp)) {
DEBUGLOG(("BOMerchant: GetMerchantDetail - disabled = [%d]\n",iTmp));
				}
				if(GetField_CString(hRec,"status",&csTmp)){
DEBUGLOG(("BOMerchant: GetMerchantDetail - status = [%s]\n",csTmp));
					PutField_CString(hContext,"merchant_status",csTmp);
				}
				if (iTmp != PD_DISABLED) {
					if(strcmp(csTmp,PD_ACC_OPEN)){
DEBUGLOG(("BOMerchant:: Merchant Account [%s] not opened\n",csMerchantId));
//ERRLOG("BOMerchant:: Merchant Account [%s] not opened\n",csMerchantId);
//						iRet = INT_ACCOUNT_DISABLED;
					}
				}
				else {
ERRLOG("BOMerchant:: Merchant Account [%s] disabled\n",csMerchantId);
					iRet = INT_ACCOUNT_DISABLED;
				}

				if (GetField_CString(hRec,"merchant_name",&csTmp)) {
DEBUGLOG(("BOMerchant: GetMerchantDetail - merchant_name = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"merchant_short_name",&csTmp)) {
					PutField_CString(hContext,"merchant_short_name",csTmp);
DEBUGLOG(("BOMerchant: GetMerchantDetail - merchant_short_name = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"merchant_client_id",&csMerchantClientId)) {
DEBUGLOG(("BOMerchant: GetMerchantDetail - merchant_client_id = [%s]\n",csMerchantClientId));
					PutField_CString(hContext,"merchant_client_id",csMerchantClientId);
				}
				if (GetField_Double(hRec,"approximate_fee_rate",&dTmp)) {
DEBUGLOG(("BOMerchant: GetMerchantDetail - approximate_fee_rate = [%lf]\n",dTmp));
					PutField_Double(hContext,"approximate_fee_rate",dTmp);
				}
				if (GetField_CString(hRec, "merchant_success_callback_url", &csTmp)) {
					PutField_CString(hContext, "merchant_success_callback_url", csTmp);
DEBUGLOG(("BOMerchant: GetMerchantDetail - merchant_success_callback_url = [%s]\n", csTmp));
				}
				if (GetField_CString(hRec, "merchant_failure_callback_url", &csTmp)) {
					PutField_CString(hContext, "merchant_failure_callback_url", csTmp);
DEBUGLOG(("BOMerchant: GetMerchantDetail - merchant_failure_callback_url = [%s]\n", csTmp));
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}
	RecordSet_Destroy(rRecordSet);

	if(iRet == PD_OK){
		hClient = (hash_t*) malloc (sizeof(hash_t));
        	hash_init(hClient,0);
		DBObjPtr = CreateObj(DBPtr,"DBClients","GetClients");
		if ((*DBObjPtr)(csMerchantClientId,hClient) != PD_OK){
			iRet = INT_ERR;
ERRLOG("BOMerchant::Client ID for Account[%s] not found\n",csMerchantId);
DEBUGLOG(("BOMerchant::Client ID Account[%s] not found\n",csMerchantId));
		}
		else{
			if (GetField_CString(hClient,"status",&csTmp)) {
DEBUGLOG(("BOMerchant: GetClients - status = [%s]\n",csTmp));
					if(strcmp(csTmp,PD_ACC_OPEN)){
ERRLOG("BOMerchant::Client Account [%s] not opened\n",csMerchantClientId);
						iRet = INT_ACCOUNT_DISABLED;
					}
			}
		}
	}

	if (iRet == PD_OK ) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchKeys","GetMerchantKey");
                if ((*DBObjPtr)(csMerchantId,"PTK",rRecordSet) != PD_OK) {
			iRet = INT_ERR;
ERRLOG("BOMerchant: Merchant Key for Account[%s] not found\n",csMerchantId);
DEBUGLOG(("BOMerchant: Merchant key for Account[%s] not found\n",csMerchantId));
		}
		else{
			iRet = INT_ERR;
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if (GetField_CString(hRec,"key_value",&csTmp)) {
DEBUGLOG(("BOMerchant: GetMerchantKey - merchant_key_value = [%s]\n",csTmp));
					PutField_CString(hContext,"merchant_key",csTmp);
					iRet = PD_OK;
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	if (iRet != PD_OK) {
		PutField_Int(hContext,"internal_error",iRet);
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

DEBUGLOG(("iRet = [%d]\n",iRet));
	return iRet;
}



int GetMerchantReservedAmt(hash_t *hContext,
			   const hash_t* hRequest,
			   hash_t* hResponse)
{
        int     iRet = PD_OK;
	char*	csServiceCode;
	char*	csMerchantId;
	char*	csTxnCcy;
	char*	csTxnCountry;
	char*	csOptionType;
	char*	csTxnCode;
	char    csTag[PD_TAG_LEN +1];
	int	iDayOfWeek;
	int	i, j;

	double	dDailyCap=0.0;
	double	dMerchantAmt=0.0;

	char	cStatusOpt;
        int	iFoundStatusOption = PD_FALSE; // PD_FALSE means ALL status
	char	cTargetStatus;

	int	iCnt = 0;
	int	iTmp;
	char	cTmp;
	char	*csTmp = NULL;

	hash_t	*hMyRec;
	hMyRec = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hMyRec,0);


	hash_t  *hRec;	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

	if(GetField_CString(hContext,"txn_code",&csTxnCode)){
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() txn_code = [%s]\n",csTxnCode));
	}

	if(GetField_CString(hRequest,"service_code",&csServiceCode)){
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() service_code = [%s]\n",csServiceCode));
		PutField_CString(hMyRec, "service_code", csServiceCode);
	}

	if(GetField_CString(hRequest,"merchant_id",&csMerchantId)){
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() merchant_id = [%s]\n",csMerchantId));
		PutField_CString(hMyRec, "merchant_id", csMerchantId);
	}

	if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() txn_ccy = [%s]\n",csTxnCcy));
		PutField_CString(hMyRec, "txn_ccy", csTxnCcy);
	}

	if(GetField_CString(hRequest,"txn_country",&csTxnCountry)){
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() txn_country = [%s]\n",csTxnCountry));
		PutField_CString(hMyRec, "txn_country", csTxnCountry);
	}

	if(GetField_CString(hRequest,"option_type",&csOptionType)){
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() option_type = [%s]\n",csOptionType));
	}

	if(GetField_Int(hContext,"dow",&iDayOfWeek)){
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() day_of_week = [%d]\n",iDayOfWeek));
	}

	if(GetField_Char(hContext, "status_option", &cStatusOpt)) {
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() status_option = [%c]\n",cStatusOpt));
		iFoundStatusOption = PD_TRUE;
	}


	for (i = 1; i <= PD_TOT_DAY_PER_WEEK; i++) {

	        if (!strcmp(csOptionType, PD_RES_AMT_OPTION_DAY) && (iDayOfWeek != i - 1)) {
			continue;
		}


		// for status
		for (j = 1; j <= 2; j++) {
			if (j == 1) {
DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmt set pending\n"));
				cTargetStatus = PD_RES_AMT_STATUS_PENDING;
		        }	
			if (j == 2) {
DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmt set approve\n"));
				cTargetStatus = PD_RES_AMT_STATUS_APPROVE;
			}

			PutField_Int(hResponse, "total_cnt", iCnt);

			if ( ((iFoundStatusOption == PD_TRUE) && (cStatusOpt == cTargetStatus)) ||
                      		(iFoundStatusOption == PD_FALSE) ) {

		        	recordset_init(rRecordSet,0);

				PutField_Int(hMyRec, "dow", i - 1);

DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmt get_status [%c]\n", cTargetStatus));
				PutField_Char(hMyRec, "status", cTargetStatus);

DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmt\n"));
				DBObjPtr = CreateObj(DBPtr,"DBMerchantReservedAmt","GetReservedAmt");
				if((unsigned long) ((*DBObjPtr)(hMyRec, rRecordSet))!=PD_OK) {
DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmt FAILED!\n"));
					iRet = INT_ERR;
				}
				else {
DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmt FETCHING!\n"));

					hRec = RecordSet_GetFirst(rRecordSet);
					while (hRec) {

						GetField_Int(hRec, "rec_count", &iTmp);
DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmt rec_count [%d]!\n", iTmp));

						if (iTmp > 0) {

							if ( (iFoundStatusOption == PD_FALSE) &&
							     (cTargetStatus == PD_RES_AMT_STATUS_APPROVE) &&
							     (GetField_Double(hRec, "daily_cap_amount", &dDailyCap)) &&
                                                             !(GetField_Double(hRec, "reserved_amount", &dMerchantAmt)) ) {

DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmt not count record\n"));

							} else {
				
								iCnt++;

								PutField_Int(hResponse, "total_cnt", iCnt);

DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmt total_cnt [%d]!\n", iCnt));

								sprintf(csTag, "dow_%d", iCnt);
								PutField_Int(hResponse, csTag, i - 1);

DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmt dow [%d]!\n", i - 1));

								if (GetField_Double(hRec, "daily_cap_amount", &dDailyCap)) {
	
									sprintf(csTag, "daily_cap_%d", iCnt);
									PutField_Double(hResponse, csTag, dDailyCap);

DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmt daily_cap [%lf]!\n", dDailyCap));
								}

								if (GetField_Char(hRec, "rec_status", &cTmp)) {
									sprintf(csTag, "status_%d", iCnt);
									PutField_Char(hResponse, csTag, cTmp);

DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmt status [%c]!\n", cTmp));
								} 

								if (GetField_Double(hRec, "reserved_amount", &dMerchantAmt)) {
									sprintf(csTag, "po_res_%d", iCnt);
									PutField_Double(hResponse, csTag, dMerchantAmt);

DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmt po_res [%lf]!\n", dMerchantAmt));
								}
							
								if (GetField_CString(hRec, "effect_date", &csTmp)) {
									sprintf(csTag, "eff_date_%d", iCnt);
									PutField_CString(hResponse, csTag, csTmp);

DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmt eff_date [%s]!\n", csTmp));
								}
							}
						}
						hRec = RecordSet_GetNext(rRecordSet);
					}
				}
				RecordSet_Destroy(rRecordSet);
			}
		}
	}

	hash_destroy(hMyRec);
	FREE_ME(hMyRec);

	FREE_ME(rRecordSet);
	return iRet;
}
