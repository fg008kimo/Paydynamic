/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/08/31              Cody Chan
update 0.0.1 (Get Merchant Key)			   2011/01/07              LokMan Chow
add ccy and country checking			   2011/02/18		   LokMan Chow
replaced ccy and country with merchanbalacct	   2011/06/08		   Cody Chan
check status of merchant and client		   2011/09/15		   LokMan Chow
Amend GetMerchantTxnInfo with pay_method checking  2012/03/16              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOMerchant.h"

char    cDebug;

void BOMerchant(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(DB);


int GetMerchantTxnInfo(hash_t *hContext,
                const hash_t* hRequest)
{
        int     iRet = PD_OK;
	char*	csServiceCode;
	char*	csMerchantId;
	char*	csTmp;
	char*	csTxnCcy;
	char*	csTxnCountry;
	char*	csMerchantClientId;
	int	iTmp;
	double	dTmp;
	hash_t  *hClient;	
	char*	csPayMethod;

	hash_t  *hRec;	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	if (GetField_CString(hRequest,"service_code",&csServiceCode)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() service_code = [%s]\n",csServiceCode));
	}
	else  {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() service_code is missing!!!\n"));
ERRLOG("BOMerchant::GetMerchantTxnInfo() service_code is missing!!!\n");
		iRet = INT_ERR;
	}

	if (GetField_CString(hRequest,"merchant_id",&csMerchantId)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() merchant_id = [%s]\n",csMerchantId));
	}
	else 
		iRet = INT_MERCHANT_ID_NOT_FOUND;



	if (iRet == PD_OK ) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GetMerchant");
         	if ((*DBObjPtr)(csMerchantId,
       	                 rRecordSet) != PD_OK) {
               	 	iRet = INT_MERCHANT_ID_NOT_FOUND;
ERRLOG("BOMerchant::GetMerchantTxnInfo() Merchant Account [%s] not found\n",csMerchantId);
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Merchant Account [%s] not found\n",csMerchantId));
               	}               
		else {
			
               	 	iRet = INT_MERCHANT_ID_NOT_FOUND;
                	hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_Int(hRec,"disabled",&iTmp)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetMerchantDetail - disabled = [%d]\n",iTmp));
				}
				if(GetField_CString(hRec,"status",&csTmp)){
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetMerchantDetail - status = [%s]\n",csTmp));
				}

				if (iTmp != PD_DISABLED) {
					if(!strcmp(csTmp,PD_ACC_OPEN)){
						iRet = PD_OK;
						if (GetField_CString(hRec,"merchant_name",&csTmp)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetMerchantDetail - merchant_name = [%s]\n",csTmp));
						}
						if (GetField_CString(hRec,"merchant_client_id",&csMerchantClientId)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetMerchantDetail - merchant_client_id = [%s]\n",csMerchantClientId));
							PutField_CString(hContext,"merchant_client_id",csMerchantClientId);
						}
						if (GetField_Double(hRec,"approximate_fee_rate",&dTmp)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetMerchantDetail - approximate_fee_rate = [%lf]\n",dTmp));
							PutField_Double(hContext,"approximate_fee_rate",dTmp);
						}
					}
					else{
ERRLOG("BOMerchant::GetMerchantTxnInfo() Merchant Account [%s] not opened\n",csMerchantId);
						iRet = INT_ACCOUNT_DISABLED;
					}
				}
				else {
ERRLOG("BOMerchant::GetMerchantTxnInfo() Merchant Account [%s] disabled\n",csMerchantId);
					iRet = INT_ACCOUNT_DISABLED;
				}


				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}
	RecordSet_Destroy(rRecordSet);

	if(iRet == PD_OK){
		hClient = (hash_t*) malloc (sizeof(hash_t));
        	hash_init(hClient,0);
		DBObjPtr = CreateObj(DBPtr,"DBClients","GetClients");
		if ((*DBObjPtr)(csMerchantClientId,hClient) != PD_OK){
			iRet = INT_ERR;
ERRLOG("BOMerchant::GetMerchantTxnInfo() Client ID for Account[%s] not found\n",csMerchantId);
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Client ID Account[%s] not found\n",csMerchantId));
		}
		else{
			if (GetField_CString(hClient,"status",&csTmp)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetClients - status = [%s]\n",csTmp));
					if(strcmp(csTmp,PD_ACC_OPEN)){
ERRLOG("BOMerchant::GetMerchantTxnInfo() Client Account [%s] not opened\n",csMerchantClientId);
						iRet = INT_ACCOUNT_DISABLED;
					}
			}
		}
	}

	if (iRet == PD_OK ) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchKeys","GetMerchantKey");
                if ((*DBObjPtr)(csMerchantId,"PTK",rRecordSet) != PD_OK) {
			iRet = INT_ERR;
ERRLOG("BOMerchant::GetMerchantTxnInfo() Merchant Key for Account[%s] not found\n",csMerchantId);
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Merchant key for Account[%s] not found\n",csMerchantId));
		}
		else{
			iRet = INT_ERR;
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if (GetField_CString(hRec,"key_value",&csTmp)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetMerchantKey - merchant_key_value = [%s]\n",csTmp));
					PutField_CString(hContext,"merchant_key",csTmp);
					iRet = PD_OK;
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	if(iRet == PD_OK){
		if (!GetField_CString(hRequest,"txn_ccy",&csTxnCcy)) {
			iRet = INT_ERR;
ERRLOG("BOMerchant::GetMerchantTxnInfo() Currency for Account is missing\n");
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Currency for Account is missing\n"));
		}
		else {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() txn ccy = [%s]\n",csTxnCcy));
		}
		if (!GetField_CString(hRequest,"txn_country",&csTxnCountry)) {
			iRet = INT_ERR;
ERRLOG("BOMerchant::GetMerchantTxnInfo() Txn Country for Account is missing\n");
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Txn Country for Account is missing\n"));
		}
		else {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() txn country = [%s]\n",csTxnCountry));
		}
		if (iRet == PD_OK) {
			DBObjPtr = CreateObj(DBPtr,"DBMerchantBalAcct","CheckMerchantBalAcct");
                	if ((unsigned long)((*DBObjPtr)(csMerchantId,
							csTxnCountry,
							csTxnCcy,
							csServiceCode,
							hContext)) != PD_FOUND) {
				iRet = INT_INVALID_TXN;
ERRLOG("BOMerchant::GetMerchantTxnInfo() Invalid txn acct [%d] [%s] [%s] [%s]\n",iRet,csMerchantId,csTxnCountry,csTxnCcy);
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() txn acct  [%d] [%s] [%s] [%s]\n",iRet,csMerchantId,csTxnCountry,csTxnCcy));
			}
		}
	}


	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "pay_method", &csPayMethod)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() pay_method = [%s]\n",csPayMethod));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantPayMethod","FindMerchantPayMethod");
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() call DBMerchantPayMethod:FindMerchantPayMethod [%s] [%s]\n", csMerchantId, csPayMethod));
			if ((unsigned long)((*DBObjPtr)(csMerchantId, csPayMethod)) != PD_OK) {
				iRet = INT_UNSUPPORTED_PAY_METHOD;
ERRLOG("BOMerchant::GetMerchantTxnInfo() Unsupport Pay Method [%d] [%s] [%s]\n",iRet,csMerchantId, csPayMethod);
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Unsupport Pay Method [%d] [%s] [%s]\n",iRet,csMerchantId,csPayMethod));
		
			}
			else {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() Support Pay Method [%d] [%s] [%s]\n",iRet,csMerchantId,csPayMethod));
			}
		}
	}



	if (iRet != PD_OK) {
		PutField_Int(hContext,"internal_error",iRet);
	}

	FREE_ME(hClient);
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

DEBUGLOG(("iRet = [%d]\n",iRet));
	return iRet;
}
int GetMerchantDetail(hash_t *hContext,
                const hash_t* hRequest)
{
        int     iRet = PD_OK;
	char*	csMerchantId;
	char*	csMerchantClientId;
	char*	csTmp;
	double	dTmp;
	int	iTmp;

	hash_t  *hClient;	
	hash_t  *hRec;	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	if (GetField_CString(hRequest,"merchant_id",&csMerchantId)) {
DEBUGLOG(("BOMerchant: GetMerchatDetail- merchant_id = [%s]\n",csMerchantId));
	}
	else 
		iRet = INT_MERCHANT_ID_NOT_FOUND;
	if (iRet == PD_OK ) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GetMerchant");
         	if ((unsigned long)(*DBObjPtr)(csMerchantId,
       	                 rRecordSet) != PD_OK) {
               	 	iRet = INT_MERCHANT_ID_NOT_FOUND;
ERRLOG("BOMerchant: Merchant Account [%s] not found\n",csMerchantId);
DEBUGLOG(("BOMerchant: Merchant Account [%s] not found\n",csMerchantId));
               	}               
		else {
			
               	 	iRet = INT_MERCHANT_ID_NOT_FOUND;
                	hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				iRet = PD_OK;
				if (GetField_Int(hRec,"disabled",&iTmp)) {
DEBUGLOG(("BOMerchant: GetMerchantDetail - disabled = [%d]\n",iTmp));
				}
				if(GetField_CString(hRec,"status",&csTmp)){
DEBUGLOG(("BOMerchant: GetMerchantDetail - status = [%s]\n",csTmp));
					PutField_CString(hContext,"merchant_status",csTmp);
				}
				if (iTmp != PD_DISABLED) {
					if(strcmp(csTmp,PD_ACC_OPEN)){
DEBUGLOG(("BOMerchant:: Merchant Account [%s] not opened\n",csMerchantId));
//ERRLOG("BOMerchant:: Merchant Account [%s] not opened\n",csMerchantId);
//						iRet = INT_ACCOUNT_DISABLED;
					}
				}
				else {
ERRLOG("BOMerchant:: Merchant Account [%s] disabled\n",csMerchantId);
					iRet = INT_ACCOUNT_DISABLED;
				}

				if (GetField_CString(hRec,"merchant_name",&csTmp)) {
DEBUGLOG(("BOMerchant: GetMerchantDetail - merchant_name = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"merchant_client_id",&csMerchantClientId)) {
DEBUGLOG(("BOMerchant: GetMerchantDetail - merchant_client_id = [%s]\n",csMerchantClientId));
					PutField_CString(hContext,"merchant_client_id",csMerchantClientId);
				}
				if (GetField_Double(hRec,"approximate_fee_rate",&dTmp)) {
DEBUGLOG(("BOMerchant: GetMerchantDetail - approximate_fee_rate = [%lf]\n",dTmp));
					PutField_Double(hContext,"approximate_fee_rate",dTmp);
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}
	RecordSet_Destroy(rRecordSet);

	if(iRet == PD_OK){
		hClient = (hash_t*) malloc (sizeof(hash_t));
        	hash_init(hClient,0);
		DBObjPtr = CreateObj(DBPtr,"DBClients","GetClients");
		if ((*DBObjPtr)(csMerchantClientId,hClient) != PD_OK){
			iRet = INT_ERR;
ERRLOG("BOMerchant::Client ID for Account[%s] not found\n",csMerchantId);
DEBUGLOG(("BOMerchant::Client ID Account[%s] not found\n",csMerchantId));
		}
		else{
			if (GetField_CString(hClient,"status",&csTmp)) {
DEBUGLOG(("BOMerchant: GetClients - status = [%s]\n",csTmp));
					if(strcmp(csTmp,PD_ACC_OPEN)){
ERRLOG("BOMerchant::Client Account [%s] not opened\n",csMerchantClientId);
						iRet = INT_ACCOUNT_DISABLED;
					}
			}
		}
	}

	if (iRet == PD_OK ) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchKeys","GetMerchantKey");
                if ((*DBObjPtr)(csMerchantId,"PTK",rRecordSet) != PD_OK) {
			iRet = INT_ERR;
ERRLOG("BOMerchant: Merchant Key for Account[%s] not found\n",csMerchantId);
DEBUGLOG(("BOMerchant: Merchant key for Account[%s] not found\n",csMerchantId));
		}
		else{
			iRet = INT_ERR;
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if (GetField_CString(hRec,"key_value",&csTmp)) {
DEBUGLOG(("BOMerchant: GetMerchantKey - merchant_key_value = [%s]\n",csTmp));
					PutField_CString(hContext,"merchant_key",csTmp);
					iRet = PD_OK;
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	if (iRet != PD_OK) {
		PutField_Int(hContext,"internal_error",iRet);
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

DEBUGLOG(("iRet = [%d]\n",iRet));
	return iRet;
}



int GetMerchantReservedAmt(hash_t *hContext,
			   const hash_t* hRequest,
			   hash_t* hResponse)
{
        int     iRet = PD_OK;
	char*	csServiceCode;
	char*	csMerchantId;
	char*	csTxnCcy;
	char*	csTxnCountry;
	char*	csOptionType;
	char*	csTxnCode;
	char    csTag[PD_TAG_LEN +1];
	int	iDayOfWeek;
	int	i;
	double	dAmt=0.0;
	double	dMerchantAmt=0.0;

	hash_t  *hRec;	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	if(GetField_CString(hContext,"txn_code",&csTxnCode)){
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() txn_code = [%s]\n",csTxnCode));
	}

	if(GetField_CString(hRequest,"service_code",&csServiceCode)){
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() service_code = [%s]\n",csServiceCode));
	}

	if(GetField_CString(hRequest,"merchant_id",&csMerchantId)){
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() merchant_id = [%s]\n",csMerchantId));
	}

	if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() txn_ccy = [%s]\n",csTxnCcy));
	}

	if(GetField_CString(hRequest,"txn_country",&csTxnCountry)){
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() txn_country = [%s]\n",csTxnCountry));
	}

	if(GetField_CString(hRequest,"option_type",&csOptionType)){
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() option_type = [%s]\n",csOptionType));
	}

	if(GetField_Int(hContext,"day_of_week",&iDayOfWeek)){
DEBUGLOG(("BOMerchant::GetMerchantReservedAmt() day_of_week = [%d]\n",iDayOfWeek));
	}


	if (!strcmp(csOptionType, PD_RES_AMT_OPTION_DAY)) {
DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetAllReservedAmt\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantReservedAmt","GetAllReservedAmt");
		if((unsigned long) ((*DBObjPtr)(csMerchantId,csTxnCountry,csTxnCcy,
						csServiceCode,iDayOfWeek,&dAmt,&dMerchantAmt))!=PD_OK)
			iRet = INT_ERR;
		else{
			PutField_Int(hResponse, "total_cnt", 1);
			PutField_Double(hResponse, "reserved_amt_1", dAmt);
			PutField_Double(hResponse, "merchant_amt_1", dMerchantAmt);
		}
	}
	else if(!strcmp(csOptionType, PD_RES_AMT_OPTION_WEEK)){
		PutField_Int(hResponse, "total_cnt", PD_TOT_DAY_PER_WEEK);

		for (i = 1; i <= PD_TOT_DAY_PER_WEEK; i++) {
			memset(csTag, 0, sizeof(csTag));
			sprintf(csTag, "reserved_amt_%d", i);
			PutField_Double(hResponse, csTag, dAmt);
			sprintf(csTag, "merchant_amt_%d", i);
			PutField_Double(hResponse, csTag, dMerchantAmt);
		}

DEBUGLOG(("Authorize::Call DBMerchantReservedAmt: GetReservedAmtByWeek\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantReservedAmt","GetReservedAmtByWeek");
		if((unsigned long) ((*DBObjPtr)(csMerchantId,csTxnCountry,csTxnCcy,
						csServiceCode, rRecordSet))!=PD_OK)
			iRet = INT_ERR;
		else{
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {

				GetField_Int(hRec,"day_of_week",&iDayOfWeek);
DEBUGLOG(("GetReservedAmtByWeek::day_of_week = [%d]\n",iDayOfWeek));

				if (!GetField_Double(hRec, "reserved_amt", &dAmt)) {
					dAmt = 0.0;
				}
DEBUGLOG(("GetReservedAmtByWeek::resreved_amt = [%.f]\n",dAmt));
				if (!GetField_Double(hRec, "merchant_amt", &dMerchantAmt)) {
					dMerchantAmt = 0.0;
				}
DEBUGLOG(("GetReservedAmtByWeek::merchant_amt = [%.f]\n",dMerchantAmt));
				if (iDayOfWeek >= 0  && iDayOfWeek < PD_TOT_DAY_PER_WEEK) {
					memset(csTag, 0, sizeof(csTag));
					sprintf(csTag,"reserved_amt_%d", iDayOfWeek+1);
					PutField_Double(hResponse, csTag, dAmt);
					sprintf(csTag,"merchant_amt_%d", iDayOfWeek+1);
					PutField_Double(hResponse, csTag, dMerchantAmt);
				}

				hRec = RecordSet_GetNext(rRecordSet);
			}

		}
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	return iRet;
}
