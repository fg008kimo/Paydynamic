/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/08/31              Cody Chan
update 0.0.1 (Get Merchant Key)			   2011/01/07              LokMan Chow
add ccy and country checking			   2011/02/18		   LokMan Chow
replaced ccy and country with merchanbalacct	   2011/06/08		   Cody Chan

*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOMerchant.h"

char    cDebug;

void BOMerchant(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(DB);


int GetMerchantTxnInfo(hash_t *hContext,
                const hash_t* hRequest)
{
        int     iRet = PD_OK;
	char*	csServiceCode;
	char*	csMerchantID = NULL;
	char*	csTmp = NULL;
	char*	csTxnCcy;
	char*	csTxnCountry;
	int	iTmp;

	hash_t  *hRec;	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	if (GetField_CString(hRequest,"service_code",&csServiceCode)) {
DEBUGLOG(("BOMerchant::GetMerchatTxnInfo() service_code = [%s]\n",csServiceCode));
	}
	else  {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() service_code is missing!!!\n"));
ERRLOG("BOMerchant::GetMerchantTxnInfo() service_code is missing!!!\n");
		iRet = INT_ERR;
	}

	if (GetField_CString(hRequest,"merchant_id",&csMerchantID)) {
DEBUGLOG(("BOMerchant::GetMerchatTxnInfo() merchant_id = [%s]\n",csMerchantID));
	}
	else 
		iRet = INT_MERCHANT_ID_NOT_FOUND;
	if (iRet == PD_OK ) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GetMerchant");
         	if ((*DBObjPtr)(csMerchantID,
       	                 rRecordSet) != PD_OK) {
               	 	iRet = INT_MERCHANT_ID_NOT_FOUND;
ERRLOG("BOMerchant::GetMerchatTxnInfo() Merchant Account [%s] not found\n",csMerchantID);
DEBUGLOG(("BOMerchant::GetMerchatTxnInfo() Merchant Account [%s] not found\n",csMerchantID));
               	}               
		else {
			
               	 	iRet = INT_MERCHANT_ID_NOT_FOUND;
                	hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_Int(hRec,"disabled",&iTmp)) {
DEBUGLOG(("BOMerchant::GetMerchatTxnInfo() GetMerchantDetail - disabled = [%d]\n",iTmp));
					if (iTmp != PD_DISABLED) {
						iRet = PD_OK;
						if (GetField_CString(hRec,"merchant_name",&csTmp)) {
DEBUGLOG(("BOMerchant::GetMerchatTxnInfo() GetMerchantDetail - merchant_name = [%s]\n",csTmp));
						}
						if (GetField_CString(hRec,"merchant_client_id",&csTmp)) {
DEBUGLOG(("BOMerchant::GetMerchatTxnInfo() GetMerchantDetail - merchant_client_id = [%s]\n",csTmp));
							PutField_CString(hContext,"merchant_client_id",csTmp);
						}
					}
					else {
ERRLOG("BOMerchant::GetMerchatTxnInfo() Merchant Account [%s] disabled\n",csMerchantID);
						iRet = INT_ACCOUNT_DISABLED;
					}
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	RecordSet_Destroy(rRecordSet);

	if (iRet == PD_OK ) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchKeys","GetMerchantKey");
                if ((*DBObjPtr)(csMerchantID,"PTK",rRecordSet) != PD_OK) {
			iRet = INT_ERR;
ERRLOG("BOMerchant::GetMerchatTxnInfo() Merchant Key for Account[%s] not found\n",csMerchantID);
DEBUGLOG(("BOMerchant::GetMerchatTxnInfo() Merchant key for Account[%s] not found\n",csMerchantID));
		}
		else{
			iRet = INT_ERR;
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if (GetField_CString(hRec,"key_value",&csTmp)) {
DEBUGLOG(("BOMerchant::GetMerchatTxnInfo() GetMerchantKey - merchant_key_value = [%s]\n",csTmp));
					PutField_CString(hContext,"merchant_key",csTmp);
					iRet = PD_OK;
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	if(iRet == PD_OK){
		if (!GetField_CString(hRequest,"txn_ccy",&csTxnCcy)) {
			iRet = INT_ERR;
ERRLOG("BOMerchant::GetMerchatTxnInfo() Currency for Account is missing\n");
DEBUGLOG(("BOMerchant::GetMerchatTxnInfo() Currency for Account is missing\n"));
		}
		else {
DEBUGLOG(("BOMerchant::GetMerchatTxnInfo() txn ccy = [%s]\n",csTxnCcy));
		}
		if (!GetField_CString(hRequest,"txn_country",&csTxnCountry)) {
			iRet = INT_ERR;
ERRLOG("BOMerchant::GetMerchatTxnInfo() Txn Country for Account is missing\n");
DEBUGLOG(("BOMerchant::GetMerchatTxnInfo() Txn Country for Account is missing\n"));
		}
		else {
DEBUGLOG(("BOMerchant::GetMerchatTxnInfo() txn country = [%s]\n",csTxnCountry));
		}
		if (iRet == PD_OK) {
			DBObjPtr = CreateObj(DBPtr,"DBMerchantBalAcct","CheckMerchantBalAcct");
                	if ((unsigned long)((*DBObjPtr)(csMerchantID,csTxnCountry,csTxnCcy,csServiceCode)) != PD_FOUND) {
				iRet = INT_INVALID_TXN;
ERRLOG("BOMerchant::GetMerchatTxnInfo() Invalid txn acct [%d] [%s] [%s] [%s]\n",iRet,csMerchantID,csTxnCountry,csTxnCcy);
DEBUGLOG(("BOMerchant::GetMerchatTxnInfo() txn acct  [%d] [%s] [%s] [%s]\n",iRet,csMerchantID,csTxnCountry,csTxnCcy));
			}
		}
	}



	if (iRet != PD_OK) {
		PutField_Int(hContext,"internal_error",iRet);
	}

	FREE_ME(csMerchantID);
	FREE_ME(csTmp);
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

DEBUGLOG(("iRet = [%d]\n",iRet));
	return iRet;
}
int GetMerchantDetail(hash_t *hContext,
                const hash_t* hRequest)
{
        int     iRet = PD_OK;
	char*	csMerchantID = NULL;
	char*	csTmp = NULL;

	hash_t  *hRec;	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	if (GetField_CString(hRequest,"merchant_id",&csMerchantID)) {
DEBUGLOG(("BOMerchant: GetMerchatDetail- merchant_id = [%s]\n",csMerchantID));
	}
	else 
		iRet = INT_MERCHANT_ID_NOT_FOUND;
	if (iRet == PD_OK ) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GetMerchant");
         	if ((*DBObjPtr)(csMerchantID,
       	                 rRecordSet) != PD_OK) {
               	 	iRet = INT_MERCHANT_ID_NOT_FOUND;
ERRLOG("BOMerchant: Merchant Account [%s] not found\n",csMerchantID);
DEBUGLOG(("BOMerchant: Merchant Account [%s] not found\n",csMerchantID));
               	}               
		else {
			
               	 	iRet = INT_MERCHANT_ID_NOT_FOUND;
                	hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				iRet = PD_OK;
				if (GetField_CString(hRec,"merchant_name",&csTmp)) {
DEBUGLOG(("BOMerchant: GetMerchantDetail - merchant_name = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"merchant_client_id",&csTmp)) {
DEBUGLOG(("BOMerchant: GetMerchantDetail - merchant_client_id = [%s]\n",csTmp));
					PutField_CString(hContext,"merchant_client_id",csTmp);
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	RecordSet_Destroy(rRecordSet);

	if (iRet == PD_OK ) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchKeys","GetMerchantKey");
                if ((*DBObjPtr)(csMerchantID,"PTK",rRecordSet) != PD_OK) {
			iRet = INT_ERR;
ERRLOG("BOMerchant: Merchant Key for Account[%s] not found\n",csMerchantID);
DEBUGLOG(("BOMerchant: Merchant key for Account[%s] not found\n",csMerchantID));
		}
		else{
			iRet = INT_ERR;
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if (GetField_CString(hRec,"key_value",&csTmp)) {
DEBUGLOG(("BOMerchant: GetMerchantKey - merchant_key_value = [%s]\n",csTmp));
					PutField_CString(hContext,"merchant_key",csTmp);
					iRet = PD_OK;
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	if (iRet != PD_OK) {
		PutField_Int(hContext,"internal_error",iRet);
	}

	FREE_ME(csMerchantID);
	FREE_ME(csTmp);
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

DEBUGLOG(("iRet = [%d]\n",iRet));
	return iRet;
}
