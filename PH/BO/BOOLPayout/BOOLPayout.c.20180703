/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/01/08              LokMan Chow
No need to create pending POG transaction	   2014/01/22		   LokMan Chow
compare merch_remain_ava_po when upload file	   2014/01/29		   LokMan Chow
add flag to on/off checksum verification	   2014/04/23		   LokMan Chow
Enhancement for OPA				   2014/05/21		   LokMan Chow
handle return payout by batch			   2014/07/04		   LokMan Chow
enhancement for POP and POG                        2014/08/11              LokMan Chow
Add precal psp cost when generate and file cancel  2015/01/23		   LokMan Chow
Tracking Txn ID handling                           2015/02/25		   Virginia Yun
Temp solution of large payout for specified acct   2015/03/19              LokMan Chow
for return batch payout verify the txn status also 2015/03/20		   LokMan Chow
sync with online enhancement			   2015/06/02		   LokMan Chow
bug fix for payout group generate		   2015/06/05		   LokMan Chow
Add display amount                                 2015/06/09              David Wong
free memory bug fix                                2015/12/11              LokMan Chow
add checking for txn_date in Verify_return_detail  2016/02/16		   LokMan Chow
add trim space for every detail field		   2016/03/09		   Dirk Wong
add check merchant ref against API request	   2017/03/13		   David Wong
add handle cancel payout API			   2017/03/16		   Elvis Wong
add handle pre-generate payout API		   2017/03/21		   Elvis Wong
add handle generate payout API		   	   2017/03/29		   Elvis Wong
update HandleCancelGenerate			   2017/04/19		   LokMan Chow
Add ack batch_txn_seq                              2017/04/26              LokMan Chow
Get pregen info by action_id                       2017/07/06              Elvis Wong
Pregen API Slow: Reduce logs and
       reduce loop "ChkRuleExistsByMerchant"	   2017/11/02		   Dirk Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOOLPayout.h"
#include <math.h>
#include <ctype.h>
#include <sys/time.h>

#define PD_SPACE ' '
#define PD_TAB '\t'
#define PD_TR           "<tr>"
#define PD_TD           "<td>"
#define PD_BOLD         "<b>"
#define PD_TD_STYLE     "<td class=\"format\">"
#define PD_TR_END       "</tr>"
#define PD_TD_END       "</td>"
#define PD_BOLD_END     "</b>"

#define	PD_TMP_SPLIT_AMT 3000
#define PD_TWV_DELIMETER ','

#define NUM_OF_CHAR                     26
#define IMPORT_FIELD_LEN                151


/*Merchant Payout File*/
#define HEADER_FIELD_CNT                4
#define DETAIL_FIELD_CNT                16
#define MAX_NUM_OF_RECORD               2000
#define PD_MAX_NON_ASCII_CHAR		5

#define IDX_HEADER_MERCHANT_ID          0
#define IDX_HEADER_NUMOFREC             2
#define IDX_HEADER_MAC                  3
#define IDX_HEADER_SERVICE_CODE         1

#define IDX_DETAIL_SEQ_NUM              0
#define IDX_DETAIL_MERCHANT_REF         1
#define IDX_DETAIL_COUNTRY              2
#define IDX_DETAIL_ID                   3
#define IDX_DETAIL_ACC_NO               4
#define IDX_DETAIL_BANK_CODE            7
#define IDX_DETAIL_BANK_NAME            6
#define IDX_DETAIL_ACC_NAME             5
#define IDX_DETAIL_BRANCH_NAME          8
#define IDX_DETAIL_PHONE_NO             9
#define IDX_DETAIL_PROVINCE             10
#define IDX_DETAIL_CITY                 11
#define IDX_DETAIL_AMOUNT               12
#define IDX_DETAIL_PAYOUT_CCY           13
#define IDX_DETAIL_DST_CCY              14
#define IDX_DETAIL_MAC                  15
#define IDX_DETAIL_RESPONSE_CODE        16

/*Return Payout File*/
#define RT_DETAIL_FIELD_CNT		13
#define RT_IDX_DETAIL_TXN_DATE		0
#define RT_IDX_DETAIL_TXN_ID		1
#define RT_IDX_DETAIL_REV_NAME		2
#define RT_IDX_DETAIL_BANK_NAME		5
#define RT_IDX_DETAIL_BRANCH		6
#define RT_IDX_DETAIL_BANK_ACCT		7
#define RT_IDX_DETAIL_AMOUNT		8
#define RT_IDX_DETAIL_PROVINCE		9
#define RT_IDX_DETAIL_CITY		10
#define RT_IDX_DETAIL_REASON		11
#define RT_IDX_DETAIL_PROC_BANK_NAME	12

char    csCharSet[NUM_OF_CHAR]={'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'};
char    csIntSet[NUM_OF_CHAR][3]={"10","11","12","13","14","15","16","17","34","18","19","20","21","22","35","23","24","25","26","27","28","29","32","30","31","33"};
char    csAddSet[NUM_OF_CHAR][3]={"1","10","19","28","37","46","55","64","39","73","82","2","11","20","48","29","38","47","56","65","74","83","21","3","12","30"};
char	csField[DETAIL_FIELD_CNT][PD_TAG_LEN]={"Sequence Num","Merchant Reference","Country","Identity ID","Bank Acct Num","Bank Acct Name","Bank Name","Bank Code","Branch","Phone Num","Province","City","Amount","Request Currency","Payout Currency","Checksum"};

char	csFieldTag[DETAIL_FIELD_CNT-1][PD_TAG_LEN]={"seq_num","merchant_ref","country","identity_id","account_num","account_name","bank_name","bank_code","branch","phone_num","province","city","request_amount","request_currency","payout_currency"};

int	iFieldLength[DETAIL_FIELD_CNT]={6,25,2,25,25,100,150,25,150,25,100,100,14,3,3,32};

char	csReturnField[RT_DETAIL_FIELD_CNT][PD_TAG_LEN]={"TxnDate","TxnID","RevName","IdentityID","MobileNum","BankName","Branch","AccountNum","Amount","Province","City","Reason","ProcessBankName"};

char    cDebug;

void BOOLPayout(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);
OBJPTR(Channel);

int UpdateHeader(hash_t *hContext,
                 hash_t* hRequest);

int GetPayoutRule(hash_t *hContext,
                  hash_t* hRequest);

int AssignPsp(hash_t *hContext,
              hash_t* hRequest,
              hash_t* hResponse);

int FormatResponse(const hash_t *hContext,
                   hash_t* hResponse);

int CreatePayoutFileDetail(const char* csPspId, const char* csBankCode,
                           hash_t* hContext);
int CreatePayoutFile(const int iFormat,const char* csPspId, const char* csBankCode,
                     hash_t* hContext);

int WritePayoutFile(const char* csPayOutFile,
                    hash_t* hRec);

int WriteAssignedRecord(hash_t *hContext,
                        hash_t* hRequest);

int GetGenFileDetail(hash_t *hContext,
                     hash_t* hRequest);

int GetPayoutFilePath(hash_t* hTxn);

int GetPayoutRecords(hash_t* hTxn,
                        hash_t* hContext,
                        hash_t* hRequest);

int UpdateDetail(hash_t *hContext,
                hash_t* hRequest);

int AddTxnLog(hash_t *hContext, hash_t *hRequest);

int UpdateDetailByTxn(hash_t *hContext,
                        hash_t* hRequest);

int isVoidWithFee(hash_t* hContext);

int HandlePayoutBalance(hash_t* hContext, hash_t* hRequest);
int HandleTxnPayoutBalance(hash_t* hContext, hash_t* hRequest);

//int handle_PayoutUpload(const unsigned long lBatchId,hash_t* hContext,hash_t* hRequest);
//int handle_PayoutConfirm(const unsigned long lBatchId,hash_t* hContext,hash_t* hRequest);
//int handle_PayoutApprove(const unsigned long lBatchId,hash_t* hContext,hash_t* hRequest);
int handle_PayoutPreGenerate(hash_t* hContext,hash_t* hRequest,hash_t* hResponse);
int handle_PayoutGenerate(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
int handle_to_PayoutGenerate(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
//int handle_PayoutCancel(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
//int handle_PayoutCancelBeforeApproved(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
//int handle_PayoutCancelApproved(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
//int handle_PayoutCancelGenerated(hash_t* hContext,hash_t* hRequest,hash_t* hHeader);
int handle_PayoutPreSend(hash_t *hContext,hash_t* hRequest,hash_t* hResponse);
int handle_PayoutSend(hash_t *hContext,hash_t* hRequest,hash_t* hResponse);
int handle_PayoutReGenerate(hash_t *hContext,hash_t* hRequest,hash_t* hResponse);

int ProcessPayoutRule(hash_t *hContext, hash_t *hRequest);
int ProcessOnlinePayout(hash_t *hContext, hash_t *hRequest);
int UpdateTxnLog(hash_t *hContext);


int GetPayoutApiGenRecords(hash_t *hContext, hash_t *hRequest, hash_t *hResponse);
int ProcessOfflineApiPayoutRule(hash_t *hContext, hash_t *hRequest);
int ProcessOnlineApiPayoutRule(hash_t *hContext, hash_t *hRequest);

int ProcessPayoutTxn(hash_t *hContext,
		 hash_t* hRequest,
		 hash_t* hResponse)
{
	int     iRet = PD_OK;
	char	*csTmp;
	char	*csTxnCode;
	char	*csMerchantId;
	int	iTmp= 0;
	//int	i= 0;
	//int	iChk= PD_FALSE;
	int	iMerch = PD_FALSE;
	unsigned long lBatchId = 0l;
	//char    csTag[PD_TAG_LEN +1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	hash_t  *hHeader;
        hHeader = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hHeader,0);

DEBUGLOG(("BOOLPayout:ProcessPayoutTxn()\n"));

 	if (GetField_CString(hRequest,"batch_id",&csTmp)) {
		lBatchId = ctol((const unsigned char *)csTmp,strlen(csTmp));
		PutField_CString(hTxn,"batch_id",csTmp);
DEBUGLOG(("BOOLPayout::ProcessPayoutTxn() batch_id = [%s]\n",csTmp));
        }

	if(GetField_CString(hContext,"approval_date",&csTmp)){
DEBUGLOG(("BOOLPayout::ProcessPayoutTxn() approval_date = [%s]\n",csTmp));
	}

	if(GetField_Int(hContext,"day_of_week",&iTmp)){
DEBUGLOG(("BOOLPayout::ProcessPayoutTxn() day_of_week = [%d]\n",iTmp));
	}

 	if (GetField_CString(hRequest,"merchant_id",&csMerchantId)) {
		iMerch = PD_TRUE;
DEBUGLOG(("BOOLPayout::ProcessPayoutTxn() merchant_id = [%s]\n",csMerchantId));
        }
	PutField_Int(hRequest,"mid_present",iMerch);

 	if (GetField_CString(hRequest,"file_id",&csTmp)) {
		PutField_CString(hHeader,"file_id",csTmp);
DEBUGLOG(("BOOLPayout::ProcessPayoutTxn() file_id = [%s]\n",csTmp));
        }

 	if (GetField_CString(hRequest,"add_user",&csTmp)) {
		PutField_CString(hTxn,"update_user",csTmp);
		PutField_CString(hHeader,"update_user",csTmp);
DEBUGLOG(("BOOLPayout::ProcessPayoutTxn() add_user = [%s]\n",csTmp));
	}

	if(GetField_CString(hRequest,"txn_code",&csTxnCode)){
DEBUGLOG(("BOOLPayout::ProcessPayoutTxn() txn_code = [%s]\n",csTxnCode));
	}

	if (GetField_CString(hRequest,"remark",&csTmp)) {
                PutField_CString(hContext,"remark",csTmp);
DEBUGLOG(("BOOLPayout::ProcessPayoutTxn() remark = [%s]\n",csTmp));
        }

/*---------Payout Pre-Generate---------*/
	else if(!strcmp(csTxnCode,PD_PAYOUT_PRE_GEN)){
		PutField_Int(hContext,"online_payout",PD_FALSE);
		if(iMerch==PD_TRUE){
			DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","ChkRuleExistsByMerchant");
			if ((unsigned long)(DBObjPtr)(csMerchantId) == PD_FOUND){
				PutField_Int(hContext,"online_payout",PD_TRUE);
			}
		}
		iRet = handle_PayoutPreGenerate(hContext,hRequest,hResponse);
	}
/*---------Payout Generate---------*/
	else if(!strcmp(csTxnCode,PD_OL_PAYOUT_GENERATE)){
		PutField_Int(hContext,"online_payout",PD_FALSE);
		if(iMerch==PD_TRUE){
			DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","ChkRuleExistsByMerchant");
			if ((unsigned long)(DBObjPtr)(csMerchantId) == PD_FOUND){
				PutField_Int(hContext,"online_payout",PD_TRUE);
			}
		}
		iRet = handle_PayoutGenerate(hContext,hRequest,hResponse);
	}


	else{
DEBUGLOG(("BOOLPayout::ProcessPayoutTxn() unknown txn_code!!!\n"));
ERRLOG("BOOLPayout::ProcessPayoutTxn() unknown txn_code!!!\n");
		iRet = INT_ERR;
	}


DEBUGLOG(("BOOLPayout::ProcessPayoutTxn() iRet[%d]\n",iRet));
	FREE_ME(hTxn);
	FREE_ME(hHeader);
	return	iRet;
}

int handle_PayoutPreGenerate(hash_t *hContext,
                             hash_t* hRequest,
                             hash_t* hResponse)
{
        int     iRet = PD_OK;
        char    *csBatchId;
        char    *csBankCode;
        char    csTag[PD_TAG_LEN +1];
        char    csBatchList[PD_TMP_MSG_BUF_LEN+1];
        int     iGenId = 0;
        int     iCnt = 0;
        int     i = 0;
        int     iTmp = 0;
        int     iOnlinePayout = PD_FALSE;
	char	cPspGrp;
	char	*csMID = NULL;
        hash_t* hRec;
        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

        hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));

DEBUGLOG(("BOOLPayout::handle_PayoutPreGenerate()\n"));
        if(iRet==PD_OK){
                if(GetField_Int(hContext,"online_payout",&iOnlinePayout)){
DEBUGLOG(("BOOLPayout:: online_payout = [%d]\n",iOnlinePayout));
                }
        }

        if(iRet==PD_OK){
		//get pre generate id (from table "payout_generated_tmp")
DEBUGLOG(("Authorize::DBOLPayoutGeneratedTmp:GetNexteId\n"));
                DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedTmp","GetNextId");
                if((unsigned long) ((*DBObjPtr)(&iGenId))!=PD_OK){
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::DBOLPayoutGeneratedTmp:GetNextId Failed\n"));
                }
                else{
DEBUGLOG(("Authorize:::GetNextId [%d]\n",iGenId));
                        PutField_Int(hContext,"pregen_id",iGenId);
                        PutField_Int(hResponse,"preview_id",iGenId);
                }
        }

        PutField_Int(hResponse,"total_cnt",0);//init psp count = 0

        if(iRet==PD_OK){
                int iProcess = 0;
                csBatchList[0] = '\0';
                //get input batch list
                //select for update, check upload header status = 6
                //update upload header status = 8 (lock header)
                GetField_Int(hContext, "total_cnt", &iCnt);//total batch count

		if(iCnt == 0
		   && GetField_Char(hContext,"psp_group",&cPspGrp)
		   && GetField_CString(hRequest,"merchant_id",&csMID)){
DEBUGLOG(("BOOLPayout:: psp_group = [%c]\n",cPspGrp));
			//get all batch id have the input psp_group
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","GetBatchIdByPayouyGrp");
			if((unsigned long) ((*DBObjPtr)(csMID,cPspGrp,rRecordSet))==PD_OK){
				hRec = RecordSet_GetFirst(rRecordSet);
				while(hRec){
					if(GetField_CString(hRec,"batch_id",&csBatchId)){
						sprintf(csTag, "batch_id_%d",iCnt);
						PutField_CString(hContext,csTag,csBatchId);
DEBUGLOG(("BOOLPayout:: batch_id = [%s]\n",csBatchId));
					}
					iCnt++;
					PutField_Int(hContext,"total_cnt",iCnt);
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
		}

                for (i = 0; i < iCnt; i++) {
                        sprintf(csTag, "batch_id_%d",i);
                        if(GetField_CString(hContext,csTag,&csBatchId)){
                                int iChk = 0;
                                DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileHeader","MatchBatchStatus_ForUpdate");
                                iChk = (unsigned long) ((*DBObjPtr)(csBatchId,PD_PAYOUTFILE_APPROVED));
                                if(iChk==PD_FOUND){
                                        sprintf(csTag, "process_batch_%d",iProcess);
                                        PutField_CString(hContext,csTag,csBatchId);
                                        iProcess ++;
                                        PutField_Int(hContext, "total_process_cnt", iProcess);
                                        if(i>0) strcat(csBatchList,",");
                                        strcat(csBatchList,csBatchId);
                                        csBatchList[strlen(csBatchList)]= '\0';
                                        PutField_CString(hContext,"batch_list",csBatchList);

                                        hash_init(hTxn,0);

                                        PutField_CString(hTxn,"batch_id",csBatchId);
                                        PutField_Int(hTxn,"status",PD_PAYOUTFILE_PRE_GENERATED);
                                        DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileHeader","UpdateHeader");
                                        if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
                                                iRet = INT_ERR;
                                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::DBOLMerchantUploadFileHeader:Update Failed\n"));
ERRLOG("Authorize::DBOLMerchantUploadFileHeader:Update Failed\n");
                                                break;
                                        }

                                }
                                else{
DEBUGLOG(("Authorize::the batch[%s] is not for generate!!\n",csBatchId));
				}
			}
		}
		if(iProcess==0){
			iRet=INT_NO_PENDING_RECORD;
			PutField_Int(hContext,"internal_error",iRet);
		}
	}

	if(iRet==PD_OK){
		if(!iOnlinePayout){
			iRet = ProcessPayoutRule(hContext,hRequest);
		}
		else{
			iRet = ProcessOnlinePayout(hContext,hRequest);
		}
	}

//--------------------
        if(iRet==PD_OK){
                //double  dBal=0.0;
                //double  dAvalBal=0.0;
                char    *csPspId;
                char    *csCcy;
                char    *csCountry;
                iCnt = 0;

                recordset_init(rRecordSet,0);
                if(!iOnlinePayout)
                        DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedTmp","GetExistingPsp");
                else
                        DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedTmp","GetExistingPspOnlineMode");

                if((unsigned long) ((*DBObjPtr)(iGenId,rRecordSet))==PD_OK){
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while(hRec){
                                hash_init(hTxn,0);
                                if(GetField_CString(hRec,"psp_id",&csPspId)){
                                        sprintf(csTag, "psp_id_%d", iCnt);
                                        PutField_CString(hContext,csTag,csPspId);
DEBUGLOG(("GetExistingPsp psp_id [%s]\n",csPspId));
                                }
                                if(GetField_CString(hRec,"bank_code",&csBankCode)){
                                        sprintf(csTag, "bank_code_%d", iCnt);
                                        PutField_CString(hContext,csTag,csBankCode);
DEBUGLOG(("GetExistingPsp bank_code [%s]\n",csBankCode));
                                }
                                if(GetField_CString(hRec,"psp_ccy",&csCcy)){
                                        sprintf(csTag, "%s_%s_payout_ccy", csPspId,csBankCode);
                                        PutField_CString(hContext,csTag,csCcy);
DEBUGLOG(("GetExistingPsp psp_ccy [%s]\n",csCcy));
                                }
                                if(GetField_CString(hRec,"psp_country",&csCountry)){
DEBUGLOG(("GetExistingPsp psp_country [%s]\n",csCountry));
                                }
                                if(GetField_Int(hRec,"txn_count",&iTmp)){
                                        PutField_Int(hTxn,"txn_cnt",iTmp);
DEBUGLOG(("GetExistingPsp txn_count [%d]\n",iTmp));
                                }
/*
DEBUGLOG(("Call DBPspBalance:GetAvalPspBalance [%s]\n",csPspId));
                                DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetAvalPspBalance");
                                if((unsigned long)(*DBObjPtr)(csPspId,
                                                        csCcy,
                                                        csCountry,
                                                        &dBal)==PD_OK){
DEBUGLOG(("GetAvalPspBalance balance = [%lf]\n",dBal));
                                        PutField_Double(hTxn,"org_psp_bal",dBal);
                                }

DEBUGLOG(("Call BOPsp:GetAvalPspBalanceForPO\n"));
                                BOObjPtr = CreateObj(BOPtr,"BOPsp","GetAvalPspBalanceForPO");
                                if((unsigned long)(*BOObjPtr)(hTxn,hTxn)==PD_OK){
                                        if(GetField_Double(hTxn,"aval_psp_bal",&dAvalBal)){
DEBUGLOG(("GetAvalPspBalanceForPO aval psp balance = [%lf]\n",dAvalBal));
                                        }
                                }
                                sprintf(csTag, "%s_aval_psp_bal", csPspId);
                                PutField_Double(hContext,csTag,dAvalBal);
*/
                                iCnt++;
                                PutField_Int(hResponse,"total_cnt",iCnt);//total psp count
                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                }
        }

        if(iRet==PD_OK){
                iRet = FormatResponse(hContext,hResponse);
        }

        if(iRet==PD_OK || iRet==INT_NO_PAYOUT_MATCH_RULE){
                //get input batch list
                //select for update, check upload header status = 8
                //update upload header status = 6 (unlock header)
                iCnt = 0;
                GetField_Int(hContext, "total_cnt", &iCnt);//total batch count

                for (i = 0; i < iCnt; i++) {
                        sprintf(csTag, "batch_id_%d",i);
                        if(GetField_CString(hContext,csTag,&csBatchId)){
                                int iChk = 0;
                                DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileHeader","MatchBatchStatus_ForUpdate");
                                iChk = (unsigned long) ((*DBObjPtr)(csBatchId,PD_PAYOUTFILE_PRE_GENERATED));
                                if(iChk==PD_FOUND){
                                        hash_init(hTxn,0);
                                        PutField_CString(hTxn,"batch_id",csBatchId);
                                        PutField_Int(hTxn,"status",PD_PAYOUTFILE_APPROVED);
                                        DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileHeader","UpdateHeader");
                                        if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
                                                break;
                                        }
                                }
                        }
                }
        }

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
        FREE_ME(hTxn);
DEBUGLOG(("handle_PayoutPreGenerate:: iRet = [%d]\n",iRet));
        return iRet;
}








/*
int handle_PayoutPreGenerate(hash_t *hContext,
			     hash_t* hRequest,
			     hash_t* hResponse)
{
	int	iRet = PD_OK;
	char	*csFileId;
	//char	*csTmp;
	//char	*csPspId;
	//char	*csTxnCcy;
	char    csTag[PD_TAG_LEN +1];
	int	i;//, iOnlineCnt;
	//int	iOnlineResp = PD_FALSE;
	//double	dPayoutAmt=0.0;
	//double	dTmpAmt=0.0;
	char	*csTmpPsp;
	char	*csTmpBankCode;
	hash_t*	hRec;
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOOLPayout::handle_PayoutPreGenerate()\n"));

	DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","GetPreGeneratedFileId");
	if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {
			if(GetField_CString(hRec,"file_id",&csFileId)){
DEBUGLOG(("DBOLMerchantUploadFileDetail Resume FileId[%s]\n",csFileId));
				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","ResumePreGenFile");
				iRet = (unsigned long)(*DBObjPtr)(csFileId);

				if(iRet==PD_OK){
DEBUGLOG(("DBOLPayoutGeneratedFileHD Resume FileId[%s]\n",csFileId));
					DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Delete");
					iRet = (unsigned long)(*DBObjPtr)(csFileId);
				}
				if(iRet==PD_OK){
DEBUGLOG(("DBOLPayoutGeneratedFileDT Resume FileId[%s]\n",csFileId));
					DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileDT","Delete");
					iRet = (unsigned long)(*DBObjPtr)(csFileId);
				}
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}

	if(iRet==PD_OK){
		iRet = GetPayoutRule(hContext,hRequest);

		if(iRet==PD_OK){
			iRet = AssignPsp(hContext,hRequest,hResponse);
		}

		if(iRet==PD_OK){
			i = 0;
			recordset_init(rRecordSet,0);
			PutField_Char(hRequest,"batch_mode",PD_OFFLINE);
DEBUGLOG(("handle_PayoutPreGenerate::Call DBOLMerchantUploadFileDetail:GetPreAssignedPsp\n"));
        		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","GetPreAssignedPsp");
			if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if (GetField_CString(hRec,"psp_id",&csTmpPsp) &&
					    GetField_CString(hRec,"bank_code",&csTmpBankCode)) {
						sprintf(csTag,"psp_id_%d",i);
						PutField_CString(hContext,csTag,csTmpPsp);
DEBUGLOG(("GetPreAssignedPsp::psp_id = [%s]\n",csTmpPsp));

						sprintf(csTag,"bank_code_%d",i);
						PutField_CString(hContext,csTag,csTmpBankCode);
DEBUGLOG(("GetPreAssignedPsp::bank_code = [%s]\n",csTmpBankCode));

DEBUGLOG(("handle_PayoutPreGenerate::Call CreatePayoutFileDetail\n"));
						if(CreatePayoutFileDetail(csTmpPsp,csTmpBankCode,hContext)!=PD_OK){
							iRet=INT_ERR;
DEBUGLOG(("CreatePayoutFile for[%s][%s] Failed!!!!\n",csTmpPsp,csTmpBankCode));
						}
					}
					i++;
					hRec = RecordSet_GetNext(rRecordSet);
					PutField_Int(hContext,"psp_count",i);
				}
			}
			if(!i){
DEBUGLOG(("handle_PayoutPreGenerate::No Pending record\n"));
				iRet = INT_NO_PAYOUT_MATCH_RULE;
			}
		}
		if(iRet==PD_OK){
			iRet = WriteAssignedRecord(hContext,hRequest);
		}

	}
	if(iRet==PD_OK){
		iRet = UpdateDetail(hContext,hRequest); 
	}
	if(iRet==PD_OK){
		iRet = FormatResponse(hContext,hResponse);
	}


	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
DEBUGLOG(("handle_PayoutPreGenerate:: iRet = [%d]\n",iRet));
	return iRet;
}
*/


int handle_PayoutPreSend(hash_t *hContext,
                          hash_t* hRequest,
                          hash_t* hResponse)
{
	int     iRet = PD_OK;
	//char	*csFileId;
	char	*csTmp;
	char	*csPspId;
	char	*csTxnCcy;
	char	*csCountry;
	char    csTag[PD_TAG_LEN +1];
	int	i, iOnlineCnt;
	int	iOnlineResp = PD_FALSE;
	double	dPayoutAmt=0.0;
	double	dTmpAmt=0.0;
	double	dBal=0.0;
	double	dAvalBal=0.0;
	hash_t*	hRec;
	hash_t*	hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOOLPayout::handle_PayoutPreSend()\n"));
	if(GetField_CString(hRequest,"merchant_id",&csTmp)){
DEBUGLOG(("BOOLPayout::handle_PayoutPreSend() merchant_id [%s]\n",csTmp));
	}

	if(iRet==PD_OK){
		PutField_Char(hRequest,"batch_mode",PD_ONLINE);
DEBUGLOG(("handle_PayoutPreSend::Call DBOLMerchantUploadFileDetail:GetPspAssignedTxn\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","GetPspAssignedTxn");
		if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				iOnlineCnt = 0;
				if (GetField_CString(hRec, "psp_id", &csPspId)) {
					
					if (GetField_CString(hRec,"payout_ccy", &csTmp)) {
						if(strcmp(csTmp,"RMB"))
							csTxnCcy=strdup(csTmp);
						else
							csTxnCcy=strdup(PD_CCY_ISO_CNY);

						sprintf(csTag, "%s_payout_ccy", csPspId);
						PutField_CString(hContext,csTag,csTxnCcy);
						FREE_ME(csTxnCcy);
DEBUGLOG(("GetPspAssignedTxn::payout_ccy = [%s]\n",csTmp));
					}

					if (GetField_Double(hRec,"payout_amount", &dPayoutAmt)) {
						sprintf(csTag,"%s_accept_amt",csPspId);
						GetField_Double(hContext,csTag,&dTmpAmt);
						PutField_Double(hContext,csTag,dTmpAmt+dPayoutAmt);
DEBUGLOG(("GetPspAssignedTxn::payout_amount = [%lf]\n",dPayoutAmt));
					}

					if (GetField_CString(hRec,"txn_country", &csTmp)) {
						sprintf(csTag,"%s_country",csPspId);
						PutField_CString(hContext,csTag,csTmp);
					}
					sprintf(csTag,"%s_accept_cnt",csPspId);
					GetField_Int(hContext,csTag,&iOnlineCnt);
					PutField_Int(hContext,csTag,iOnlineCnt+1);
				}

				iOnlineResp = PD_TRUE;
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		else{
			iRet = INT_NO_PENDING_RECORD;
DEBUGLOG(("handle_PayoutPreSend:: No Online Payout Records\n"));
		}

		if(iOnlineResp){
			iRet = PD_OK;
			iOnlineCnt = 0;
			dPayoutAmt = 0.0;
			recordset_init(rRecordSet,0);
DEBUGLOG(("handle_PayoutPreSend::Call DBOLMerchantUploadFileDetail:GetPreAssignedPsp\n"));
        		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","GetPreAssignedPsp");
			if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){
				//if(!GetField_Int(hResponse,"total_cnt",&i))
				i=0;
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					i ++;
					if (GetField_CString(hRec, "psp_id", &csPspId)) {
						sprintf(csTag, "psp_id_%d", i);
						PutField_CString(hResponse,csTag,csPspId);
DEBUGLOG(("GetPreAssignedPsp::psp_id = [%s]\n",csPspId));
						sprintf(csTag, "psp_id_%d", i-1);
						PutField_CString(hContext,csTag,csPspId);

						sprintf(csTag,"%s_accept_cnt",csPspId);
						GetField_Int(hContext,csTag,&iOnlineCnt);
						sprintf(csTag,"accept_cnt_%d",i);
						PutField_Int(hResponse,csTag,iOnlineCnt);
DEBUGLOG(("GetPreAssignedPsp::accept_cnt = [%d]\n",iOnlineCnt));

						sprintf(csTag,"%s_accept_amt",csPspId);
						GetField_Double(hContext,csTag,&dPayoutAmt);
						sprintf(csTag,"accept_amt_%d",i);
						PutField_Double(hResponse,csTag,dPayoutAmt);
DEBUGLOG(("GetPreAssignedPsp::accept_amt = [%lf]\n",dPayoutAmt));

						sprintf(csTag, "%s_payout_ccy", csPspId);
						GetField_CString(hContext,csTag,&csTxnCcy);
						sprintf(csTag,"ccy_%d",i);
						PutField_CString(hResponse,csTag,csTxnCcy);
DEBUGLOG(("GetPreAssignedPsp::payout_ccy = [%s]\n",csTxnCcy));

						sprintf(csTag, "%s_country", csPspId);
						GetField_CString(hContext,csTag,&csCountry);
					}
					PutField_Int(hResponse,"total_cnt",i);
					PutField_Int(hContext,"psp_count",i);

					PutField_CString(hTxn,"psp_id",csPspId);
					PutField_Int(hTxn,"txn_cnt",iOnlineCnt);
DEBUGLOG(("handle_PayoutPreSend::Call DBPspBalance:GetAvalPspBalance\n"));
					DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetAvalPspBalance");
					if((unsigned long)(*DBObjPtr)(csPspId,
								csTxnCcy,
								csCountry,
								&dBal)==PD_OK){
DEBUGLOG(("GetAvalPspBalance balance = [%lf]\n",dBal));
						PutField_Double(hTxn,"org_psp_bal",dBal);

DEBUGLOG(("handle_PayoutPreSend::Call BOPsp:GetAvalPspBalanceForPO\n"));
						BOObjPtr = CreateObj(BOPtr,"BOPsp","GetAvalPspBalanceForPO");
						if((unsigned long)(*BOObjPtr)(hTxn,hTxn)==PD_OK){
							if(GetField_Double(hTxn,"aval_psp_bal",&dAvalBal)){
DEBUGLOG(("GetAvalPspBalanceForPO aval psp balance = [%lf]\n",dAvalBal));
							}
						}
						else{
DEBUGLOG(("GetAvalPspBalanceForPO find aval psp balance failed!!!!\n"));
						}
					}
					sprintf(csTag, "aval_psp_bal_%d", i);
					PutField_Double(hResponse,csTag,dAvalBal);


					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
		}
	}


	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);
DEBUGLOG(("handle_PayoutPreSend:: iRet = [%d]\n",iRet));
	return iRet;


}

int handle_PayoutSend(hash_t *hContext,
			  hash_t* hRequest,
			  hash_t* hResponse)
{
	int	iRet = PD_OK;
	//int	iChk = PD_FALSE;
	int	i=0;
	int	b=0;
	int	iTmp=0;
	int	iTmpCnt=0;
	int	iTxnCnt=0;
	int	iOrgCnt=0;
	int	iTotal=0;
	int	iTxnTotal=0;
	int	iBatchCnt=0;
	char*	csTmp;
	char*	csTmpBID;
	char*	csBatchId;
	char*	csPspId;
	//char*	csPspChannel;
	char	csNewFileId[PD_TXN_SEQ_LEN+1];
	char*	csPayoutTxnSeq;
	char*	csFilePath;
	char	csTag[PD_TAG_LEN +1];
	double	dAmt=0.0;
	double	dRemainAmt=0.0;
	double	dSplitAmt=0.0;
	double	dTmp=0.0;
	double	dTmpTotalAmt=0.0;
	double	dTmpAmt=0.0;
	double	dTotal=0.0;
	unsigned long lBatchId = 0l;
        unsigned long lTmp=0l;
        unsigned long lFileId=0l;
	int	iFormat = 0;

DEBUGLOG(("BOOLPayout::handle_PayoutSend()\n"));

	hash_t  *hRec, *hDetail, *hHeader, *hTxn, *hOrgHd;
	
	hOrgHd= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hOrgHd,0);

	hHeader= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hHeader,0);

	hDetail= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hDetail,0);

	hTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	csTmpBID = (char*) malloc (128);

	if(GetField_CString(hContext,"PHDATE",&csTmp)){
		PutField_CString(hHeader,"txn_date",csTmp);
	}

	if(GetField_CString(hRequest,"merchant_id",&csTmp)){
DEBUGLOG(("handle_PayoutSend::merchant_id [%s]\n",csTmp));
	}

DEBUGLOG(("handle_PayoutSend::Call DBOLMerchantUploadFileDetail:GetOnlineBatchRecord\n"));
	DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","GetOnlineBatchRecord");
	if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_FOUND){
		
		//iChk = PD_TRUE;

		PutField_Int(hDetail,csTag,i);
		PutField_Int(hDetail,"batch_cnt",b);
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec && (iRet==PD_OK)) {
			sprintf(csTag,"batch_id_%d",b);
			if(GetField_CString(hRec,"batch_id",&csBatchId)){
				PutField_CString(hDetail,"batch_id",csBatchId);
				PutField_CString(hTxn,"batch_id",csBatchId);
				PutField_CString(hHeader,csTag,csBatchId);
				if(strcmp(csBatchId,csTmpBID)){
					b++;
					i=0;
					iOrgCnt=0;
					sprintf(csTmpBID,"%s",csBatchId);

DEBUGLOG(("handle_PayoutSend::DBOLPayoutGeneratedFileHD:GetNextFileId\n"));
					DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","GetNextFileId");
					if((unsigned long) ((*DBObjPtr)(&lFileId))!=PD_OK){
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutSend::DBOLPayoutGeneratedFileHD:GetNextFileId Failed\n"));
						PutField_Int(hContext,"internal_error",iRet);
						break;
					}
					else{
						sprintf(csNewFileId,"%ld",lFileId);
						sprintf(csTag,"%s_file_id",csBatchId);
						PutField_CString(hHeader,csTag,csNewFileId);
						PutField_CString(hHeader,"generated_file_id",csNewFileId);
DEBUGLOG(("handle_PayoutSend::DBOLPayoutGeneratedFileHD:GetNextFileId [%s]\n",csNewFileId));
					}
					sprintf(csTag,"%s_merchant_id",csBatchId);
					if(GetField_CString(hRec,"merchant_id",&csTmp)){
						PutField_CString(hHeader,csTag,csTmp);
					}
					sprintf(csTag,"%s_psp_id",csBatchId);
					if(GetField_CString(hRec,"psp_id",&csPspId)){
						PutField_CString(hHeader,csTag,csPspId);
						PutField_CString(hTxn,csTag,csPspId);
					}
					//////get split amount///
					dTmp = 0.0;
					RemoveField_Double(hTxn,"payout_split_limit");
					DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspPayoutSplitAmt");
					if ((*DBObjPtr)(csPspId,hTxn) == PD_OK) {
						if (GetField_Double(hTxn,"payout_split_limit",&dTmp)) {
DEBUGLOG(("handle_PayoutSend:: GetPspPayoutSplitAmt - split amount= [%lf]\n",dTmp));
						}
					}
					sprintf(csTag,"%s_split_amt",csBatchId);
					PutField_Double(hTxn,csTag,dTmp);
				}
				PutField_CString(hDetail,"file_id",csNewFileId);
				PutField_CString(hTxn,"file_id",csNewFileId);
			}
			if(GetField_Int(hRec,"seq_num",&iTmp)){
				PutField_Int(hDetail,"seq_num",iTmp);
			}
			if(GetField_CString(hRec,"txn_seq",&csTmp)){
				PutField_CString(hDetail,"upload_txn_id",csTmp);
				//PutField_CString(hDetail,"txn_id",csTmp);
				PutField_CString(hOrgHd,"txn_seq",csTmp);
			}
			if(GetField_CString(hRec,"merchant_ref",&csTmp)){
				PutField_CString(hDetail,"merchant_ref",csTmp);
			}
			if(GetField_CString(hRec,"txn_country",&csTmp)){
				PutField_CString(hDetail,"country",csTmp);
				PutField_CString(hDetail,"txn_country",csTmp);
			}
			if(GetField_CString(hRec,"bank_name",&csTmp)){
				PutField_CString(hDetail,"bank_name",csTmp);
			}
			if(GetField_CString(hRec,"phone_num",&csTmp)){
				PutField_CString(hDetail,"phone_num",csTmp);
			}
			else{
				RemoveField_CString(hDetail,"phone_num");
			}
			if(GetField_CString(hRec,"province",&csTmp)){
				PutField_CString(hDetail,"province",csTmp);
			}
			else{
				RemoveField_CString(hDetail,"province");
			}
			if(GetField_CString(hRec,"city",&csTmp)){
				PutField_CString(hDetail,"city",csTmp);
			}
			else{
				RemoveField_CString(hDetail,"city");
			}
			if(GetField_CString(hRec,"request_ccy",&csTmp)){
				PutField_CString(hDetail,"request_ccy",csTmp);
			}
			if(GetField_Double(hRec,"request_amount",&dTmp)){
				PutField_Double(hDetail,"request_amount",dTmp);
			}
			if(GetField_CString(hRec,"payout_ccy",&csTmp)){
				PutField_CString(hDetail,"payout_currency",csTmp);
				PutField_CString(hDetail,"payout_ccy",csTmp);
				sprintf(csTag,"%s_txn_ccy",csBatchId);
				PutField_CString(hHeader,csTag,csTmp);
				sprintf(csTag,"%s_txn_ccy",csPspId);
				PutField_CString(hHeader,csTag,csTmp);
			}
			if(GetField_Double(hRec,"payout_amount",&dTmp)){
				sprintf(csTag,"%s_txn_amt",csBatchId);
				dAmt = 0.0;
				GetField_Double(hHeader,csTag,&dAmt);
				dAmt+=dTmp;
				PutField_Double(hHeader,csTag,dAmt);

				dRemainAmt = dTmp;
			}
//////////////////////////
//split by average
			sprintf(csTag,"%s_split_amt",csBatchId);
                        GetField_Double(hTxn,csTag,&dSplitAmt);
                        int iSplitCnt = 1;
                        if(dSplitAmt>0){
                                iSplitCnt = (int)(dRemainAmt/dSplitAmt);
                                if(dRemainAmt>(dSplitAmt*iSplitCnt)){
                                        iSplitCnt ++;
                                }

DEBUGLOG(("handle_PayoutSend:: Split Count: [%d]\n",iSplitCnt));

                                dTmpAmt = 0.0;
                                dTmpTotalAmt = 0.0;

                                dTmpAmt = newround(dRemainAmt/iSplitCnt,0);
                                for(iTmpCnt=0;iTmpCnt<(iSplitCnt-1);iTmpCnt++){
                                        sprintf(csTag,"avag_split_amt_%d",iTmpCnt);
                                        PutField_Double(hContext,csTag,dTmpAmt);
                                        dTmpTotalAmt += dTmpAmt;
                                }
                        }
                        sprintf(csTag,"avag_split_amt_%d",(iSplitCnt-1));
                        PutField_Double(hContext,csTag,dRemainAmt-dTmpTotalAmt);

                        for(iTmpCnt=0;iTmpCnt<iSplitCnt;iTmpCnt++){
			/*while(dRemainAmt>0.0){
				sprintf(csTag,"%s_split_amt",csBatchId);
				GetField_Double(hTxn,csTag,&dSplitAmt);
				if(dRemainAmt>dSplitAmt && dSplitAmt>0.0){
					dRemainAmt = dRemainAmt - dSplitAmt;
					PutField_Double(hDetail,"payout_amount",dSplitAmt);
					PutField_Double(hDetail,"amount",dSplitAmt);
					sprintf(csTag,"%s_%d_payout_amount",csBatchId,i);
					PutField_Double(hDetail,csTag,dSplitAmt);
				}
				else{
					PutField_Double(hDetail,"payout_amount",dRemainAmt);
					PutField_Double(hDetail,"amount",dRemainAmt);
					sprintf(csTag,"%s_%d_payout_amount",csBatchId,i);
					PutField_Double(hDetail,csTag,dRemainAmt);
					dRemainAmt = 0.0;
				}	
			*/
				sprintf(csTag,"avag_split_amt_%d",iTmpCnt);
                                if(GetField_Double(hContext,csTag,&dTmp)){
                                        PutField_Double(hDetail,"payout_amount",dTmp);
					PutField_Double(hDetail,"amount",dTmp);
					sprintf(csTag,"%s_%d_payout_amount",csBatchId,i);
					PutField_Double(hDetail,csTag,dTmp);
                                }

				if(GetField_CString(hRec,"identity_id",&csTmp)){
					PutField_CString(hDetail,"identity_id",csTmp);
					sprintf(csTag,"%s_%d_identity_id",csBatchId,i);
					PutField_CString(hDetail,csTag,csTmp);
				}
				if(GetField_CString(hRec,"account_num",&csTmp)){
					PutField_CString(hDetail,"account_num",csTmp);
					sprintf(csTag,"%s_%d_account_num",csBatchId,i);
					PutField_CString(hDetail,csTag,csTmp);
				}
				if(GetField_CString(hRec,"account_name",&csTmp)){
					PutField_CString(hDetail,"account_name",csTmp);
					sprintf(csTag,"%s_%d_account_name",csBatchId,i);
					PutField_CString(hDetail,csTag,csTmp);
				}
				if(GetField_CString(hRec,"bank_code",&csTmp)){
					PutField_CString(hDetail,"bank_code",csTmp);
					sprintf(csTag,"%s_%d_bank_code",csBatchId,i);
					PutField_CString(hDetail,csTag,csTmp);
				}
				if(GetField_CString(hRec,"branch",&csTmp)){
					PutField_CString(hDetail,"branch",csTmp);
					sprintf(csTag,"%s_%d_branch",csBatchId,i);
					PutField_CString(hDetail,csTag,csTmp);
				}

				PutField_Char(hDetail,"status",PD_INIT);
				PutField_Char(hHeader,"status",PD_INIT);

				i++;
				sprintf(csTag,"%s_txn_count",csBatchId);
				PutField_Int(hHeader,csTag,i);
				PutField_Int(hHeader,"batch_cnt",b);
				//iTotal++;
				//sprintf(csTag,"%s_file_count",csNewFileId);
				//PutField_Int(hHeader,csTag,iTotal);

				if(iRet==PD_OK){
					DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextPayoutTxnSeq");
                        		csPayoutTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("handle_PayoutSend::GeneratePayoutSeq: [%d]=[%s]\n",i,csPayoutTxnSeq));
                        		PutField_CString(hDetail,"txn_id",csPayoutTxnSeq);
					sprintf(csTag,"%s_%d_gen_txn_id",csBatchId,i);
					PutField_CString(hDetail,csTag,csPayoutTxnSeq);
				}

				//insert DBPayoutQueueDt 
				DBObjPtr = CreateObj(DBPtr,"DBPayoutQueueDt","Add");
				if((unsigned long)(*DBObjPtr)(hDetail)==PD_OK){
DEBUGLOG(("handle_PayoutSend::Add PayoutQueueDt Success\n"));
				}
				else{
					iRet=INT_ERR;
DEBUGLOG(("handle_PayoutSend::Add PayoutQueueDt Failed!!!!\n"));
					PutField_Int(hContext,"internal_error",iRet);
					break;
				}

				//insert PayoutGeneratedFileDT 
				if(iRet==PD_OK){
					//PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_SENT);
					PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_SENDING);
					DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileDT","Add");
					if ((unsigned long)(*DBObjPtr)(hDetail) != PD_OK) {
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutSend::Add BPayoutGeneratedFileDT Failed!!!!\n"));
						PutField_Int(hContext,"internal_error",iRet);
						break;
					}
				}
			}
/////////////////////////////(end while)
			iOrgCnt++;
			sprintf(csTag,"%s_org_txn_cnt",csPspId);
			PutField_Int(hHeader,csTag,iOrgCnt);

			if(iRet==PD_OK){
				//update status, file_id and psp_id
				PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
				PutField_CString(hTxn,"psp_id",csPspId);
				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","UpdateDetailByBatchId");
				if ((*DBObjPtr)(csBatchId,iTmp,hTxn) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("BOOLPayout::DBOLMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
					PutField_Int(hContext,"internal_error",iRet);
					break;
				}
			}

			if(iRet==PD_OK){
				PutField_CString(hOrgHd,"sub_status",PD_APPROVED_AND_SENDING);
				DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
				if ((unsigned long)(*DBObjPtr)(hOrgHd) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("BOOLPayout::DBTransaction:Update Failed\n"));
				}
			}
			iTxnTotal ++;
			PutField_Int(hHeader,"org_total_txn_count",iTxnTotal);
			hRec = RecordSet_GetNext(rRecordSet);
		}


		if(iRet==PD_OK){
			//insert header
			iTotal = 0;
			GetField_Int(hHeader,"batch_cnt",&iBatchCnt);
			for(i=0; i<iBatchCnt; i++){
				sprintf(csTag,"batch_id_%d",i);
				if(GetField_CString(hHeader,csTag,&csBatchId)){
					PutField_CString(hHeader,"batch_id",csBatchId);
			
					lBatchId = ctol((const unsigned char *)csBatchId,strlen(csBatchId));
DEBUGLOG(("******************lBatchId[%ld]  lTmp[%ld]\n",lBatchId,lTmp));
					if (lTmp!=lBatchId){
						lTmp = lBatchId;

						recordset_init(rRecordSet,0);
						DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileHeader","GetHeader");
						if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
							hRec = RecordSet_GetFirst(rRecordSet);
							while (hRec) {
								if(GetField_CString(hRec,"service_code",&csTmp)){
									PutField_CString(hHeader,"service_code",csTmp);
								}
								hRec = RecordSet_GetNext(rRecordSet);
							}
						}

						if(iRet==PD_OK){
							sprintf(csTag,"%s_psp_id",csBatchId);
							if(GetField_CString(hHeader,csTag,&csPspId)){
								PutField_CString(hHeader,"psp_id",csPspId);
							}
							sprintf(csTag,"%s_merchant_id",csBatchId);
							if(GetField_CString(hHeader,csTag,&csTmp)){
								PutField_CString(hHeader,"merchant_id",csTmp);
							}
							sprintf(csTag,"%s_txn_count",csBatchId);
							if(GetField_Int(hHeader,csTag,&iTmp)){
								PutField_Int(hHeader,"num_of_record",iTmp);
								//PutField_Int(hHeader,"txn_cnt",iTmp);

								iTotal+=iTmp;
								PutField_Int(hHeader,"file_total_txn_count",iTotal);
							}
							sprintf(csTag,"%s_txn_amt",csBatchId);
							if(GetField_Double(hHeader,csTag,&dTmp)){
								PutField_Double(hHeader,"txn_amt",dTmp);

								dTotal+=dTmp;
								PutField_Double(hHeader,"file_total_txn_amt",dTotal);
							}

							DBObjPtr = CreateObj(DBPtr,"DBPayoutQueueHd","Add");
							if((unsigned long)(*DBObjPtr)(hHeader)==PD_OK){
DEBUGLOG(("BOOLPayout::handle_PayoutSend Add PayoutQueueHd Success\n"));
							}
							else{
								iRet=INT_ERR;
DEBUGLOG(("BOOLPayout::handle_PayoutSend Add PayoutQueueHd Failed!!!!\n"));
								PutField_Int(hContext,"internal_error",iRet);
								break;
							}

							
						}
/*
						if(iRet==PD_OK){
DEBUGLOG(("handle_PayoutSend::Call CreatePayoutFileDetail\n"));
							if(CreatePayoutFileDetail(csPspId,hContext)!=PD_OK){
DEBUGLOG(("CreatePayoutFile for[%s] Failed!!!!\n",csTmp));
								iRet=INT_ERR;
								PutField_Int(hContext,"internal_error",iRet);
								break;
							}
						}
*/
/*
						if(iRet==PD_OK){
							sprintf(csTag,"%s_file_id",csBatchId);
							if(GetField_CString(hHeader,csTag,&csTmp)){
								PutField_CString(hHeader,"file_id",csTmp);
							}
							
							sprintf(csTag,"%s_file",csPspId);
							if(GetField_CString(hContext,csTag,&csTmp)){
								PutField_CString(hHeader,"filename",csTmp);
							}
							
							sprintf(csTag,"%s_file_date",csPspId);
							if(GetField_CString(hContext,csTag,&csTmp)){
								PutField_CString(hHeader,"file_date",csTmp);
							}

							sprintf(csTag,"%s_seq_num",csPspId);
							if(GetField_Int(hContext,csTag,&iTmp)){
								PutField_Int(hHeader,"seq_num",iTmp);
							}

							sprintf(csTag,"%s_txn_ccy",csBatchId);
							if(GetField_CString(hHeader,csTag,&csTmp)){
								PutField_CString(hHeader,"ccy_id",csTmp);
							}

							sprintf(csTag,"%s_txn_amt",csBatchId);
							if(GetField_Double(hHeader,csTag,&dTmp)){
								PutField_Double(hHeader,"txn_amt",dTmp);
							}

							PutField_CString(hHeader,"file_pid",csPspId);
							PutField_Int(hHeader,"status",PD_PAYOUTFILE_PRE_SEND);
							DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Add");
							if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("handle_PayoutSend::PayoutGeneratedFileHD::Add Error!!!\n"));
								iRet = INT_ERR;
								PutField_Int(hContext,"internal_error",iRet);
								break;
							}
							DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Update");
							if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("handle_PayoutSend::PayoutGeneratedFileHD::Update Error!!!\n"));
								iRet = INT_ERR;
								PutField_Int(hContext,"internal_error",iRet);
								break;
							}
							
							PutField_CString(hHeader,"psp_id",csPspId);
							if(GetPayoutFilePath(hHeader)==PD_OK){
								if(CreatePayoutFile(csPspId,hHeader)!=PD_OK){
DEBUGLOG(("handle_PayoutSend::CreatePayoutFile failed for [%s]!!\n",csPspId));
									iRet= INT_ERR;
									break;
								}
							}
							
						}
*/
/*
						////////TODO:
						if(iRet==PD_OK && !strcmp(csPspId,PD_CHANNEL_TWV)){
							hash_t *hFile;
							hFile= (hash_t*) malloc (sizeof(hash_t));
							hash_init(hFile,0);

							sprintf(csTag, "%s_path", csPspId);
							GetField_CString(hHeader,csTag,&csFilePath);

							iTxnCnt = 0;
							sprintf(csTag,"%s_txn_count",csBatchId);
							GetField_Int(hHeader,csTag,&iTxnCnt);
							for(i=0; i<iTxnCnt; i++){
								hash_init(hFile,0);
								sprintf(csTag,"%s_%d_gen_txn_id",csBatchId,i+1);
								if(GetField_CString(hDetail,csTag,&csTmp)){
									PutField_CString(hFile,"gen_txn_id",csTmp);
								}

								sprintf(csTag,"%s_%d_bank_code",csBatchId,i);
								if(GetField_CString(hDetail,csTag,&csTmp)){
									PutField_CString(hFile,"bank_code",csTmp);
								}

								sprintf(csTag,"%s_%d_branch",csBatchId,i);
								if(GetField_CString(hDetail,csTag,&csTmp)){
									PutField_CString(hFile,"branch",csTmp);
								}

								sprintf(csTag,"%s_%d_account_name",csBatchId,i);
								if(GetField_CString(hDetail,csTag,&csTmp)){
									PutField_CString(hFile,"account_name",csTmp);
								}

								sprintf(csTag,"%s_%d_account_num",csBatchId,i);
								if(GetField_CString(hDetail,csTag,&csTmp)){
									PutField_CString(hFile,"account_num",csTmp);
								}

								sprintf(csTag,"%s_%d_identity_id",csBatchId,i);
								if(GetField_CString(hDetail,csTag,&csTmp)){
									PutField_CString(hFile,"identity_id",csTmp);
								}

								sprintf(csTag,"%s_%d_payout_amount",csBatchId,i);
								if(GetField_Double(hDetail,csTag,&dTmp)){
									PutField_Double(hFile,"payout_amount",dTmp);
								}

								PutField_CString(hFile,"psp_id",csPspId);
								if(WritePayoutFile(csFilePath,hFile)!=PD_OK){
									iRet = INT_ERR;
DEBUGLOG(("handle_PayoutSend::WritePayoutFile Error!!!\n"));
ERRLOG("BOOLPayout::handle_PayoutSend:WritePayoutFile Error!!!\n");
								}
							}//end for
							FREE_ME(hFile);
						}


*/					}//end if same batch
				}//end if get hHeader batch_id
			}//end for loop
		}
		
		if(iRet==PD_OK){
			if(GetField_CString(hHeader,"psp_id",&csPspId)){
				PutField_CString(hHeader,"file_pid",csPspId);
			}
			if(GetField_CString(hHeader,"generated_file_id",&csTmp)){
				PutField_CString(hHeader,"file_id",csTmp);
			}
			//if(GetField_Int(hHeader,"file_total_txn_count",&iTmp)){
			if(GetField_Int(hHeader,"org_total_txn_count",&iTmp)){
				PutField_Int(hHeader,"txn_cnt",iTmp);
			}
			if(GetField_Double(hHeader,"file_total_txn_amt",&dTmp)){
				PutField_Double(hHeader,"txn_amt",dTmp);
			}


DEBUGLOG(("handle_PayoutSend::Call CreatePayoutFileDetail\n"));
			if(CreatePayoutFileDetail(csPspId,NULL,hContext)!=PD_OK){
DEBUGLOG(("CreatePayoutFile for[%s] Failed!!!!\n",csPspId));
					iRet=INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
			}


			if(iRet==PD_OK){
				sprintf(csTag,"%s_file",csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"filename",csTmp);
					PutField_CString(hHeader,"generated_file_name",csTmp);
				}

				sprintf(csTag,"%s_file_date",csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"file_date",csTmp);
				}

				sprintf(csTag,"%s_seq_num",csPspId);
				if(GetField_Int(hContext,csTag,&iTmp)){
					PutField_Int(hHeader,"seq_num",iTmp);
				}

				sprintf(csTag,"%s_txn_ccy",csPspId);
				if(GetField_CString(hHeader,csTag,&csTmp)){
					PutField_CString(hHeader,"ccy_id",csTmp);
				}
/*
				sprintf(csTag,"%s_org_txn_cnt",csPspId);
				if(GetField_Int(hHeader,csTag,&iTmp)){
					PutField_Int(hHeader,"txn_cnt",iTmp);
				}
*/
				PutField_Int(hHeader,"status",PD_PAYOUTFILE_PRE_SEND);
				DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Add");
				if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("handle_PayoutSend::PayoutGeneratedFileHD::Add Error!!!\n"));
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
				}
				DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Update");
				if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("handle_PayoutSend::PayoutGeneratedFileHD::Update Error!!!\n"));
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
				}

				//PutField_CString(hHeader,"psp_id",csPspId);
				if(GetPayoutFilePath(hHeader)==PD_OK){
					hash_t* hPspDetail;
                                        hPspDetail = (hash_t*) malloc (sizeof(hash_t));
                                        hash_init(hPspDetail,0);
                                        DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
                                        if ((*DBObjPtr)(csPspId,hPspDetail) == PD_OK) {
                                                if (GetField_Int(hPspDetail,"payout_format",&iFormat)) {
							if(CreatePayoutFile(iFormat,csPspId,NULL,hHeader)!=PD_OK){
DEBUGLOG(("handle_PayoutSend::CreatePayoutFile failed for [%d][%s]!!\n",iFormat,csPspId));
								iRet= INT_ERR;
							}
						}
					}
					else{
						iRet= INT_ERR;
DEBUGLOG(("handle_PayoutSend::cannot find channel for [%s]!!\n",csPspId));
					}
					FREE_ME(hPspDetail);
				}
				if(iRet==PD_OK){
					//update file_id and file_name
					DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","UpdateFileNameByFileId");
					if ((*DBObjPtr)(hHeader) != PD_OK) {
DEBUGLOG(("BOOLPayout::DBOLMerchantUploadFileDetail:UpdateFileNameByFileId Failed\n"));
					}
				}


			}

			if(iRet==PD_OK && iFormat==PD_TWV_PAYOUT_FORMAT){
				iBatchCnt = 0;
				int j=0;
				hash_t *hFile;
				hFile= (hash_t*) malloc (sizeof(hash_t));
				hash_init(hFile,0);

				sprintf(csTag, "%s_path", csPspId);
				GetField_CString(hHeader,csTag,&csFilePath);

				GetField_Int(hHeader,"batch_cnt",&iBatchCnt);
				for(j=0; j<iBatchCnt; j++){
					sprintf(csTag,"batch_id_%d",j);
					if(GetField_CString(hHeader,csTag,&csBatchId)){
DEBUGLOG(("handle_PayoutSend::Process BatchId[%s]\n",csBatchId));

						iTxnCnt = 0;
						sprintf(csTag,"%s_txn_count",csBatchId);
						GetField_Int(hHeader,csTag,&iTxnCnt);
DEBUGLOG(("handle_PayoutSend::Record Count[%d]\n",iTxnCnt));
						for(i=0; i<iTxnCnt; i++){
							hash_init(hFile,0);
							sprintf(csTag,"%s_%d_gen_txn_id",csBatchId,i+1);
							if(GetField_CString(hDetail,csTag,&csTmp)){
								PutField_CString(hFile,"gen_txn_id",csTmp);
							}

							sprintf(csTag,"%s_%d_bank_code",csBatchId,i);
							if(GetField_CString(hDetail,csTag,&csTmp)){
								PutField_CString(hFile,"bank_code",csTmp);
							}

							sprintf(csTag,"%s_%d_branch",csBatchId,i);
							if(GetField_CString(hDetail,csTag,&csTmp)){
								PutField_CString(hFile,"branch",csTmp);
							}

							sprintf(csTag,"%s_%d_account_name",csBatchId,i);
							if(GetField_CString(hDetail,csTag,&csTmp)){
								PutField_CString(hFile,"account_name",csTmp);
							}

							sprintf(csTag,"%s_%d_account_num",csBatchId,i);
							if(GetField_CString(hDetail,csTag,&csTmp)){
								PutField_CString(hFile,"account_num",csTmp);
							}

							sprintf(csTag,"%s_%d_identity_id",csBatchId,i);
							if(GetField_CString(hDetail,csTag,&csTmp)){
								PutField_CString(hFile,"identity_id",csTmp);
							}

							sprintf(csTag,"%s_%d_payout_amount",csBatchId,i);
							if(GetField_Double(hDetail,csTag,&dTmp)){
								PutField_Double(hFile,"payout_amount",dTmp);
							}

							//PutField_CString(hFile,"psp_id",csPspId);
							PutField_Int(hFile,"payout_format",iFormat);
							if(WritePayoutFile(csFilePath,hFile)!=PD_OK){
								iRet = INT_ERR;
DEBUGLOG(("handle_PayoutSend::WritePayoutFile Error!!!\n"));
ERRLOG("BOOLPayout::handle_PayoutSend:WritePayoutFile Error!!!\n");
							}
						}//end for
						hash_init(hFile,0);
					}
				}//end for batch
				FREE_ME(hFile);
			}

		}
		FREE_ME(csPayoutTxnSeq);
	}
	else{
		iRet = INT_NO_PENDING_RECORD;
DEBUGLOG(("BOOLPayout::handle_PayoutSend: No Online Payout Records \n"));
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hOrgHd);
	FREE_ME(hHeader);
	FREE_ME(hDetail);
	FREE_ME(hTxn);
	FREE_ME(csTmpBID);
	//FREE_ME(csPayoutTxnSeq);

	//PutField_Int(hContext,"return_send",iRet);
	//return iChk;
	return iRet;

}

int handle_to_PayoutGenerate(hash_t *hContext,
			  hash_t* hRequest,
			  hash_t* hHeader)
{
DEBUGLOG(("BOOLPayout::handle_to_PayoutGenerate()\n"));

	int     iRet = PD_OK;
	char	*csTmp;
	hash_t  *hRec, *hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
	
DEBUGLOG(("handle_to_PayoutGenerate::Call DBOLPayoutGeneratedFileHD:GetPreGenHeader\n"));
	DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","GetPreGenHeader");
	if((unsigned long)(*DBObjPtr)(PD_PAYOUTFILE_PRE_GENERATED,rRecordSet)==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
		while ((hRec) && (iRet==PD_OK)) {
			if(GetField_CString(hRec,"file_id",&csTmp)){
				PutField_CString(hTxn,"file_id",csTmp);
DEBUGLOG(("GetPreGenHeader::file_id = [%s]\n",csTmp));

				PutField_Int(hTxn,"status",PD_PAYOUTFILE_WAITING_GENERATE);
				DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Update");
				if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
DEBUGLOG(("Authorize::PayoutGeneratedFileHD::Update Error!!!\n"));
					iRet = INT_ERR;
				}
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}

	FREE_ME(hTxn);
	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
	return iRet;
}


int handle_PayoutGenerate(hash_t *hContext,
			  hash_t* hRequest,
			  hash_t* hResponse)
{
	int     iRet = PD_OK;
	int     iChk= PD_OK;
	int	iGenId = 0;
	int	iCnt= 0;
	int	iTmp= 0;
	int	iSeqNum= 0;
	int	iFormat= 0;
	char	*csTmp;
	char	*csPspId;
	char	*csTxnCcy;
	char	*csFilePath;
	char	*csPayoutTxnSeq;
	char	*csBatchId;
	char	cBatchMode= PD_OFFLINE;
	double	dTmp;
	double	dPayoutAmt = 0.0;
	double	dSplitAmt = 0.0;
	double	dTmpSplit = 0.0;
	double	dRemainAmt= 0.0;
	double	dAmt= 0.0;
	double	dTmpAmt= 0.0;
	double	dTmpTotalAmt= 0.0;
	double	dUniqueAmt = 0.0;
	char	csTag[PD_TAG_LEN +1];
	char	csTagTwo[PD_TAG_LEN +1];
	int	iOnlinePayout =PD_FALSE;
	char	*csPayoutCcy;
	char	*csPspCountry;
	char	*csToBank;
	char	*csBankCode;
	char	*csBaid;
	char	cTmp;
	int	iCostTmp = 0;
	char    *csAcctNum;
	double  dLeftAmt = 0.0;

	hash_t  *hRec, *hTxn, *hDetail, *hUploadTxn, *hElement, *hBal, *hCost;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);
	hDetail= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hDetail,0);
	hUploadTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hUploadTxn,0);
	hElement= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hElement,0);
	hBal= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hBal,0);
	hCost= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hCost,0);
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

DEBUGLOG(("BOOLPayout::handle_PayoutGenerate()\n"));

	if(GetField_CString(hRequest,"preview_id",&csTmp)){
		iGenId = atoi(csTmp);
DEBUGLOG(("handle_PayoutGenerate::Preview Id = [%d]\n",iGenId));
	}
	else{
		iRet = INT_ERR;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("handle_PayoutGenerate::Preview Id Not found!!!!!\n"));
ERRLOG("handle_PayoutGenerate::Preview Id Not found!!!!!\n");
	}

	if(iRet==PD_OK){
		if(GetField_Int(hContext,"online_payout",&iOnlinePayout)){
DEBUGLOG(("BOOLPayout:: online_payout = [%d]\n",iOnlinePayout));
		}
		if(iOnlinePayout)
			cBatchMode = PD_ONLINE;
		else
			cBatchMode = PD_OFFLINE;
	}

	if(iRet == PD_OK){
		//hold gen id
DEBUGLOG(("handle_PayoutGenerate::Call DBOLPayoutGeneratedTmp:GetPreGenIdForUpdate\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedTmp","GetPreGenIdForUpdate");
		iChk = (unsigned long) ((*DBObjPtr)(iGenId,PD_OK));
		if(iChk ==PD_FOUND){
DEBUGLOG(("handle_PayoutGenerate::Call DBOLPayoutGeneratedTmp:HoldPreGenId\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedTmp","HoldPreGenId");
			if((unsigned long) ((*DBObjPtr)(iGenId))==PD_OK){
				TxnCommit();
			}
			else{
				iRet = INT_ERR;
				PutField_Int(hContext,"internal_error",iRet);
			}
		}
		else{
			iRet = INT_NOT_RECORD;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("handle_PayoutGenerate::the pregen id is not available now\n"));
		}
		
	}

	if(iRet == PD_OK){
		iCnt = 0;
		recordset_init(rRecordSet,0);
		if(!iOnlinePayout)
			DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedTmp","GetExistingPsp");
		else
			DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedTmp","GetExistingPspOnlineMode");
DEBUGLOG(("handle_PayoutGenerate::Call DBOLPayoutGeneratedTmp:GetExistingPsp\n"));
		if((unsigned long) ((*DBObjPtr)(iGenId,rRecordSet))==PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				hash_init(hTxn,0);
				hash_init(hBal,0);
				if(GetField_CString(hRec,"psp_id",&csPspId) &&
				   GetField_CString(hRec,"bank_code",&csBankCode)
				){
					PutField_CString(hTxn,"file_bank_code",csBankCode);
					sprintf(csTag,"bank_code_%d",iCnt);
					PutField_CString(hContext,csTag,csBankCode);

					PutField_CString(hTxn,"file_pid",csPspId);
					sprintf(csTag,"psp_id_%d",iCnt);
					PutField_CString(hContext,csTag,csPspId);
					PutField_CString(hBal,"psp_id",csPspId);
DEBUGLOG(("GetExistingPsp psp_id [%s]\n",csPspId));

					dTmpSplit = 0.0;
					DBObjPtr = CreateObj(DBPtr,"DBOLPspDetail","GetPayoutTmpAcct");
					if ((*DBObjPtr)(csPspId,hTxn) == PD_OK) {
						if (GetField_Double(hTxn,"payout_split_limit",&dTmpSplit)) {
DEBUGLOG(("BOOLPayout::GetPayoutTmpAcct - split amount= [%lf]\n",dTmpSplit));
						}
						else{
DEBUGLOG(("BOOLPayout::GetPayoutTmpAcct - no split amount found\n"));
						}
						if (GetField_CString(hTxn,"client_id",&csTmp)) {
							sprintf(csTag,"%s_psp_client",csPspId);
							PutField_CString(hContext,csTag,csTmp);
							//PutField_CString(hContext,"psp_client_id",csTmp);
DEBUGLOG(("BOOLPayout::GetPayoutTmpAcct - client id = [%s]\n",csTmp));
						}
						if (GetField_Int(hTxn,"payout_format",&iFormat)) {
DEBUGLOG(("BOOLPayout::GetPayoutTmpAcct - payout_format = [%d]\n",iFormat));
						}
						if (GetField_CString(hTxn,"baid",&csBaid)) {
							sprintf(csTag,"%s_baid",csPspId);
							PutField_CString(hContext,csTag,csBaid);
DEBUGLOG(("BOOLPayout::GetPayoutTmpAcct - baid = [%s]\n",csBaid));
						}
						//if (GetField_CString(hTxn,"bank_acct_num",&csTmp)) {
//DEBUGLOG(("BOOLPayout::GetPayoutTmpAcct - bank_acct_num = [%s]\n",csTmp));
						//}
					}
					sprintf(csTag,"%s_split_amt",csPspId);
					PutField_Double(hContext,csTag,dTmpSplit);

					if(GetField_CString(hRec,"psp_ccy",&csPayoutCcy)){
						PutField_CString(hTxn,"ccy_id",csPayoutCcy);
DEBUGLOG(("GetExistingPsp psp_ccy [%s]\n",csPayoutCcy));
					}
					if(GetField_CString(hRec,"psp_country",&csPspCountry)){
DEBUGLOG(("GetExistingPsp psp_country [%s]\n",csPspCountry));
					}
					if(GetField_Int(hRec,"txn_count",&iTmp)){
						PutField_Int(hTxn,"txn_cnt",iTmp);
						PutField_Int(hBal,"txn_cnt",iTmp);
DEBUGLOG(("GetExistingPsp txn_count [%d]\n",iTmp));
					}

					if(GetField_Double(hRec,"total_amt",&dAmt)){
DEBUGLOG(("GetExistingPsp total_amt [%lf]\n",dAmt));
					}
/*
					double dBal = 0.0;
DEBUGLOG(("handle_PayoutGenerate::Call DBPspBalance:GetAvalPspBalance\n"));
					DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetAvalPspBalance");
					if((unsigned long)(*DBObjPtr)(csPspId,
								csPayoutCcy,
								csPspCountry,
								&dBal)==PD_OK){
DEBUGLOG(("GetAvalPspBalance balance = [%lf]\n",dBal));
						PutField_Double(hBal,"org_psp_bal",dBal);
						double dAvalBal = 0.0;
DEBUGLOG(("handle_PayoutGenerate::Call BOPsp:GetAvalPspBalanceForPO\n"));
						BOObjPtr = CreateObj(BOPtr,"BOPsp","GetAvalPspBalanceForPO");
						if((unsigned long)(*BOObjPtr)(hBal,hBal)==PD_OK){
							if(GetField_Double(hBal,"aval_psp_bal",&dAvalBal)){
DEBUGLOG(("GetAvalPspBalanceForPO aval psp balance = [%.2f]\n",dAvalBal));
								if(dAmt>dAvalBal){
									iRet = INT_INSUFFICIENT_FUND;
									PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetAvalPspBalanceForPO aval psp balance[%.2f] less than total generate amount[%lf]!!!!\n",dAvalBal,dAmt));
ERRLOG("BOOLPayout:handle_PayoutGenerate:GetAvalPspBalanceForPO aval psp balance[%.2f] less than total generate amount[%lf]!!!!\n",dAvalBal,dAmt);
									break;
								}
							}
						}
						else{
							iRet = INT_ERR;
DEBUGLOG(("GetAvalPspBalanceForPO find aval psp balance failed!!!!\n"));
ERRLOG("BOOLPayout:handle_PayoutGenerate:GetAvalPspBalanceForPO find aval psp balance failed!!!!\n");
							break;
						}
					}
					else{
						iRet = INT_ERR;
DEBUGLOG(("GetAvalPspBalance find balance failed!!!!\n"));
ERRLOG("BOOLPayout:handle_PayoutGenerate:GetAvalPspBalance find balance failed!!!!\n");
						break;
					}
*/
					if(GetField_CString(hContext,"PHDATE",&csTmp)){
						PutField_CString(hTxn,"PHDATE",csTmp);
					}

					if(GetField_CString(hRequest,"add_user",&csTmp)){
						PutField_CString(hTxn,"add_user",csTmp);
					}

DEBUGLOG(("handle_PayoutGenerate::Call CreatePayoutFileDetail\n"));
					if(CreatePayoutFileDetail(csPspId,csBankCode,hTxn)!=PD_OK){
DEBUGLOG(("CreatePayoutFileDetail for[%s] Failed!!!!\n",csPspId));
						iRet=INT_ERR;
						PutField_Int(hContext,"internal_error",iRet);
						break;
					}

					if(iOnlinePayout)
						PutField_Int(hTxn,"status",PD_PAYOUTFILE_PRE_SEND);
					else
						PutField_Int(hTxn,"status",PD_PAYOUTFILE_PROCESSING_GENERATE);
					//insert gen header
					DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Add");
					if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
DEBUGLOG(("handle_PayoutGenerate::OLPayoutGeneratedFileHD::Add Error!!!\n"));
						iRet = INT_ERR;
						PutField_Int(hContext,"internal_error",iRet);
						break;
					}

					//create file and write header
DEBUGLOG(("handle_PayoutGenerate::Call CreatePayoutFile\n"));
					if(CreatePayoutFile(iFormat,csPspId,csBankCode,hTxn)!=PD_OK){
DEBUGLOG(("handle_PayoutGenerate::CreatePayoutFile failed for [%s][%s]!!\n",csPspId,csBankCode));
						iRet= INT_ERR;
						break;
					}


					if(GetField_CString(hTxn,"file_id",&csTmp)){
						sprintf(csTag,"%s_%s_file_id",csPspId,csBankCode);
						PutField_CString(hContext,csTag,csTmp);
					}

					if(GetField_CString(hTxn,"file_path",&csTmp)){
						sprintf(csTag, "%s_%s_file_path", csPspId,csBankCode);
						PutField_CString(hContext,csTag,csTmp);
					}

					if(GetField_CString(hTxn,"filename",&csTmp)){
						sprintf(csTag,"%s_%s_filename",csPspId,csBankCode);
						PutField_CString(hContext,csTag,csTmp);
					}
/*
					if(GetField_CString(hTxn,"psp_channel",&csTmp)){
						sprintf(csTag,"%s_psp_channel",csPspId);
						PutField_CString(hContext,csTag,csTmp);
					}

					if(GetField_CString(hTxn,"psp_client",&csTmp)){
						sprintf(csTag,"%s_psp_client",csPspId);
						PutField_CString(hContext,csTag,csTmp);
					}
*/
					iCnt ++;
					PutField_Int(hContext,"psp_count",iCnt);
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		if(iRet==PD_OK && !iCnt){
			iRet = INT_NO_PENDING_RECORD;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("handle_PayoutGenerate::No pre-gen record found!!!\n"));
		}
	}

	//get all records from payout_generated_tmp with details (for update)
	if(iRet == PD_OK){
		int i, iTxnCnt;
		recordset_init(rRecordSet,0);
DEBUGLOG(("handle_PayoutGenerate::Call DBOLMerchantUploadFileDetail:GetPregeneratedRecords\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","GetPregeneratedRecords");
		if((unsigned long)(*DBObjPtr)(iGenId,cBatchMode,rRecordSet)==PD_OK){
			i = 0;
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec && (iRet==PD_OK)) {
				hash_init(hTxn,0);
				hash_init(hDetail,0);
				hash_init(hUploadTxn,0);
				hash_init(hElement,0);
				hash_init(hCost,0);
				if(GetField_CString(hRequest,"add_user",&csTmp)){
					PutField_CString(hDetail,"add_user",csTmp);
					PutField_CString(hContext,"add_user",csTmp);
					PutField_CString(hTxn,"update_user",csTmp);
					PutField_CString(hTxn,"add_user",csTmp);
				}
				if (GetField_CString(hRec, "psp_id", &csPspId) &&
				    GetField_CString(hRec, "to_bank_code", &csToBank)
				) {
					PutField_CString(hTxn,"psp_id",csPspId);
					PutField_CString(hTxn,"org_psp_id",csPspId);
					PutField_CString(hCost,"psp_id",csPspId);
DEBUGLOG(("GetPregeneratedRecords::psp_id = [%s]\n",csPspId));

					sprintf(csTag, "%s_%s_filename", csPspId,csToBank);
					GetField_CString(hContext,csTag,&csTmp);
					PutField_CString(hTxn,"generated_file_name",csTmp);

					sprintf(csTag, "%s_%s_file_id", csPspId,csToBank);
					GetField_CString(hContext,csTag,&csTmp);
					//sprintf(csTag,"pregen_file_id_%d", i);
					//PutField_CString(hRequest,csTag,csTmp);
					PutField_CString(hDetail,"file_id",csTmp);
					PutField_CString(hTxn,"file_id",csTmp);

					sprintf(csTag, "%s_psp_channel", csPspId);
					GetField_CString(hContext,csTag,&csTmp);
					PutField_CString(hDetail,"psp_channel",csTmp);

					sprintf(csTag, "%s_baid", csPspId);
					GetField_CString(hContext,csTag,&csTmp);
					PutField_CString(hTxn,"org_baid",csTmp);
					PutField_CString(hCost,"baid",csTmp);

					sprintf(csTag, "%s_psp_client", csPspId);//for update txn_header
					GetField_CString(hContext,csTag,&csTmp);
					PutField_CString(hDetail,"client_id",csTmp);
					PutField_CString(hCost,"provider_id",csTmp);

					sprintf(csTag, "%s_%s_file_path", csPspId,csToBank);
					GetField_CString(hContext,csTag,&csFilePath);
				}
				if (GetField_CString(hRec, "txn_id", &csTmp)) {
					PutField_CString(hDetail,"upload_txn_id",csTmp);
					PutField_CString(hUploadTxn,"txn_seq",csTmp);

					PutField_CString(hTxn, "grp_tracking_txn_seq", csTmp);
DEBUGLOG(("GetPregeneratedRecords::upload_txn_id = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec, "batch_id", &csBatchId)) {
					//sprintf(csTag, "batch_id_%d", i);
					//PutField_CString(hRequest,csTag,csBatchId);
					PutField_CString(hDetail,"batch_id",csBatchId);
DEBUGLOG(("GetPregeneratedRecords::batch_id = [%s]\n",csBatchId));
				}
				if (GetField_Int(hRec, "seq_num", &iSeqNum)) {
					//sprintf(csTag, "seq_num_%d", i);
					//PutField_Int(hRequest,csTag,iSeqNum);
					PutField_Int(hDetail,"seq_num",iSeqNum);
DEBUGLOG(("GetPregeneratedRecords::seq_num = [%d]\n",iSeqNum));
				}
				if (GetField_CString(hRec,"txn_country", &csTmp)) {
					sprintf(csTag, "%s_txn_country", csPspId);
					PutField_CString(hContext,csTag,csTmp);
					PutField_CString(hDetail,"txn_country",csTmp);
					PutField_CString(hDetail,"country",csTmp);
					PutField_CString(hTxn,"txn_country",csTmp);
					PutField_CString(hTxn,"org_txn_country",csTmp);
DEBUGLOG(("GetPregeneratedRecords::txn_country = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"request_ccy", &csTmp)) {
					PutField_CString(hDetail,"request_ccy",csTmp);
DEBUGLOG(("GetPregeneratedRecords::request_ccy = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"payout_ccy", &csTmp)) {
					if(strcmp(csTmp,"RMB"))
						csTxnCcy=strdup(csTmp);
					else
						csTxnCcy=strdup(PD_CCY_ISO_CNY);

					sprintf(csTag, "%s_payout_ccy", csPspId);
					PutField_CString(hContext,csTag,csTxnCcy);
					PutField_CString(hDetail,"payout_ccy",csTxnCcy);
					PutField_CString(hDetail,"payout_currency",csTxnCcy);
					PutField_CString(hTxn,"txn_ccy",csTxnCcy);
					PutField_CString(hTxn,"org_psp_txn_ccy",csTxnCcy);
					PutField_CString(hElement,"org_txn_ccy",csTxnCcy);
                                        PutField_CString(hElement,"src_txn_fee_ccy",csTxnCcy);
					FREE_ME(csTxnCcy);
DEBUGLOG(("GetPregeneratedRecords::payout_ccy = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"account_name", &csTmp)) {
					PutField_CString(hDetail,"account_name",csTmp);
DEBUGLOG(("GetPregeneratedRecords::account_name = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"account_num", &csAcctNum)) {
					PutField_CString(hDetail,"account_num",csAcctNum);
DEBUGLOG(("GetPregeneratedRecords::account_num = [%s]\n",csAcctNum));
				}
				if (GetField_CString(hRec,"bank_code", &csTmp)) {
					PutField_CString(hDetail,"bank_code",csTmp);
DEBUGLOG(("GetPregeneratedRecords::bank_code = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"bank_name", &csTmp)) {
					PutField_CString(hDetail,"bank_name",csTmp);
DEBUGLOG(("GetPregeneratedRecords::bank_name = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"branch", &csTmp)) {
					PutField_CString(hDetail,"branch",csTmp);
DEBUGLOG(("GetPregeneratedRecords::branch = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"identity_id", &csTmp)) {
					PutField_CString(hDetail,"identity_id",csTmp);
DEBUGLOG(("GetPregeneratedRecords::identity_id = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"phone_num", &csTmp)) {
					PutField_CString(hDetail,"phone_num",csTmp);
DEBUGLOG(("GetPregeneratedRecords::phone_num = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"merchant_ref", &csTmp)) {
					PutField_CString(hDetail,"merchant_ref",csTmp);
DEBUGLOG(("GetPregeneratedRecords::merchant_ref = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"remark", &csTmp)) {
DEBUGLOG(("GetPregeneratedRecords::remark = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"province", &csTmp)) {
					PutField_CString(hDetail,"province",csTmp);
DEBUGLOG(("GetPregeneratedRecords::province = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"city", &csTmp)) {
					PutField_CString(hDetail,"city",csTmp);
DEBUGLOG(("GetPregeneratedRecords::city = [%s]\n",csTmp));
				}
				if (GetField_Double(hRec,"request_amount", &dTmp)) {
					PutField_Double(hDetail,"request_amount",dTmp);
DEBUGLOG(("GetPregeneratedRecords::request_amount = [%lf]\n",dTmp));
				}
				if (GetField_Double(hRec,"payout_amount", &dPayoutAmt)) {
					dRemainAmt = dPayoutAmt;
DEBUGLOG(("GetPregeneratedRecords::payout_amount = [%lf]\n",dPayoutAmt));

				/*	sprintf(csTag,"org_dst_net_amt_%s_%s",csPspId,csToBank);
					if(GetField_Double(hContext,csTag,&dAmt)){
						dAmt += dTmp;
					}
					else{
						dAmt = dTmp;
					}
					PutField_Double(hContext,csTag,dAmt);
				*/
				/*	sprintf(csTag,"%s_%s_txn_amt",csPspId,csToBank);
					if(GetField_Double(hContext,csTag,&dAmt)){
						dAmt += dPayoutAmt;
					}
					else{
						dAmt = dPayoutAmt;
					}
					PutField_Double(hContext,csTag,dAmt);
				*/
				}

				int iSplitCnt = 1;
				int iSpcialSplit = PD_FALSE;
				//check acct num in the special handle list
				DBObjPtr = CreateObj(DBPtr,"DBPayoutSpcSplitAcct","InSpecialList");
				iSpcialSplit = (unsigned long)(*DBObjPtr)(csAcctNum);

				if(!iSpcialSplit){// || dPayoutAmt <300000.00){
//////////
//split by average
					sprintf(csTag,"%s_split_amt",csPspId);
					dSplitAmt = 0.0;
					dTmpTotalAmt = 0.0;
					GetField_Double(hContext,csTag,&dSplitAmt);
					iSplitCnt = 1;
					if(dSplitAmt>0){
						iSplitCnt = (int)(dPayoutAmt/dSplitAmt);
						if(dPayoutAmt>(dSplitAmt*iSplitCnt)){
							iSplitCnt ++;
						}

DEBUGLOG(("handle_PayoutGenerate:: Split Count: [%d]\n",iSplitCnt));

						dTmpAmt = 0.0;
						dTmpTotalAmt = 0.0;
						dLeftAmt = dPayoutAmt;

						dTmpAmt = newround(dPayoutAmt/iSplitCnt,2);
DEBUGLOG(("WriteAssignedRecord:: dTmpAmt: [%lf]\n",dTmpAmt));
						for(iTmp=0;iTmp<(iSplitCnt-1);iTmp++){
							dLeftAmt = dLeftAmt - dTmpAmt;
						}
DEBUGLOG(("WriteAssignedRecord:: dLeftAmt: [%lf]\n",dLeftAmt));
						if(dLeftAmt>dSplitAmt){
							for(iTmp=0;iTmp<(iSplitCnt-1);iTmp++){
								sprintf(csTag,"avag_split_amt_%d",iTmp);
								PutField_Double(hContext,csTag,dTmpAmt+0.01);
								dTmpTotalAmt += dTmpAmt+0.01;
							}
						}
						else{
							for(iTmp=0;iTmp<(iSplitCnt-1);iTmp++){
								sprintf(csTag,"avag_split_amt_%d",iTmp);
								PutField_Double(hContext,csTag,dTmpAmt);
								dTmpTotalAmt += dTmpAmt;
							}
						}

					}
					sprintf(csTag,"avag_split_amt_%d",(iSplitCnt-1));
					PutField_Double(hContext,csTag,dPayoutAmt-dTmpTotalAmt);
/////split by average end
				}
				else{
////special split
					iSplitCnt = 8;  //default
					double dBaseAmt = 30000.0;//default
					double dAddAmt = 3000.0;//default
					int iRandMax = 32767; //default max
					double dIdx = 3.2;
					char*   csValueTmp;
					csValueTmp = (char*) malloc (128);
					sprintf(csTag,"%s_PO_SPLIT_CNT",csPspId);
					DBObjPtr = CreateObj(DBPtr,"DBSystemParameter","FindCode");
					if ((unsigned long)(DBObjPtr)(csTag,csValueTmp) == FOUND) {
						iSplitCnt = atoi(csValueTmp);
DEBUGLOG(("Find Special Split Parameter:: [%s] = [%d]\n",csTag,iSplitCnt));
					}
					sprintf(csTag,"PO_SPLIT_BASE_AMT");
					if ((unsigned long)(DBObjPtr)(csTag,csValueTmp) == FOUND) {
						sscanf(csValueTmp,"%lf",&dBaseAmt);
DEBUGLOG(("Find Special Split Parameter:: [%s] = [%lf]\n",csTag,dBaseAmt));
					}
					sprintf(csTag,"PO_SPLIT_ADD_AMT");
					if ((unsigned long)(DBObjPtr)(csTag,csValueTmp) == FOUND) {
						sscanf(csValueTmp,"%lf",&dAddAmt);
DEBUGLOG(("Find Special Split Parameter:: [%s] = [%lf]\n",csTag,dAddAmt));
					}
					sprintf(csTag,"PO_SPLIT_RANDOM_IDX");
					if ((unsigned long)(DBObjPtr)(csTag,csValueTmp) == FOUND) {
						sscanf(csValueTmp,"%lf",&dIdx);
DEBUGLOG(("Find Special Split Parameter:: [%s] = [%lf]\n",csTag,dIdx));
					}

					dTmpAmt = 0.0;
					dTmpTotalAmt = 0.0;
					dLeftAmt = dPayoutAmt;

					//double dBaseAmt = (double)((int)(dPayoutAmt/(iSplitCnt*10000))*10000);
					//double dTotalRandom = dPayoutAmt - (double)dBaseAmt*iSplitCnt;

					iCnt = 0;

					while(iCnt<iSplitCnt-1){
						//struct timespec tv;
						//clock_gettime(CLOCK_REALTIME, &tv);
						struct timeval  tv;
						gettimeofday(&tv, NULL);

						unsigned int time_msec = (tv.tv_sec)*1000 + (tv.tv_usec)/1000;
						srand(time_msec+iCnt);

						int iRand = (int)(rand()%iRandMax);
						double dRandAmt = newround(((double)iRand/dIdx),2) + dAddAmt;

						dTmpAmt = dBaseAmt + dRandAmt;
						sprintf(csTag,"avag_split_amt_%d",iCnt);
						PutField_Double(hContext,csTag,dTmpAmt);

						if(dLeftAmt>dTmpAmt){
							dLeftAmt = dLeftAmt-dTmpAmt;
							iCnt++;
						}
						else{
							break;
						}
					}

					sprintf(csTag,"avag_split_amt_%d",iCnt);
					PutField_Double(hContext,csTag,dLeftAmt);
					iCnt++;

					if(iSplitCnt>iCnt) iSplitCnt=iCnt;
/////special split end
				}

				for(iTmp=0;iTmp<iSplitCnt;iTmp++){
					sprintf(csTag,"avag_split_amt_%d",iTmp);
					if(GetField_Double(hContext,csTag,&dTmp)){
						//generate unique amount
						dUniqueAmt = dTmp;
						if(GetField_CString(hContext,"txn_code",&csTmp)){
							PutField_CString(hContext,"org_txn_code",csTmp);
						}
						sprintf(csTag, "%s_payout_ccy", csPspId);
						if(GetField_CString(hContext,csTag,&csTmp)){
							PutField_CString(hContext,"txn_ccy",csTmp);
						}
						if (GetField_CString(hRec,"merchant_id", &csTmp)) {
							PutField_CString(hContext,"merchant_id",csTmp);
						}
						PutField_CString(hContext,"baid",csBaid);
						PutField_Double(hContext,"org_txn_amt",dTmp);
						BOObjPtr = CreateObj(BOPtr,"BOUniqueNumber","GetUniqueAmt");
						if((unsigned long)(*BOObjPtr)(hContext,hRequest,hResponse)==PD_OK){
							if(GetField_Double(hResponse,"display_amt",&dUniqueAmt)){
DEBUGLOG(("handle_PayoutGenerate:: Unique payout amount: [%lf]\n",dUniqueAmt));
							}
						}
						RemoveField_CString(hContext,"merchant_id");

						PutField_Double(hDetail,"payout_amount",dUniqueAmt);
						PutField_Double(hDetail,"unique_amount",dUniqueAmt);
						PutField_Double(hTxn,"unique_amount",dUniqueAmt);

						PutField_Double(hDetail,"amount",dUniqueAmt);
						PutField_Double(hTxn,"org_dst_net_amt",dUniqueAmt);
						PutField_Double(hElement,"org_txn_amt",dUniqueAmt);
						PutField_Double(hCost,"txn_amt",dUniqueAmt);

						sprintf(csTag,"%s_%s_txn_amt",csPspId,csToBank);
						if(GetField_Double(hContext,csTag,&dAmt)){
							dAmt += dUniqueAmt;
						}
						else{
							dAmt = dUniqueAmt;
						}
						PutField_Double(hContext,csTag,dAmt);
					}

					//import to payout_generated_file_dt
					DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextPayoutTxnSeq");
					csPayoutTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("handle_PayoutGenerate:: GeneratePayoutSeq: [%d]=[%s]\n",i,csPayoutTxnSeq));
                        		PutField_CString(hDetail,"txn_id",csPayoutTxnSeq);
                        		PutField_CString(hDetail,"gen_txn_id",csPayoutTxnSeq);
                        		PutField_CString(hContext,"txn_seq",csPayoutTxnSeq);
                        		PutField_CString(hTxn,"txn_id",csPayoutTxnSeq);
					PutField_CString(hElement,"from_txn_seq",csPayoutTxnSeq);

					PutField_CString(hTxn, "tracking_txn_seq", csPayoutTxnSeq);

					if(cBatchMode==PD_OFFLINE)
						PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
					else
						PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_SENDING);
					DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileDT","Add");
					if ((unsigned long)(*DBObjPtr)(hDetail) != PD_OK) {
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate:: DBOLPayoutGeneratedFileDT:Add Failed\n"));
ERRLOG("handle_PayoutGenerate:: DBOLPayoutGeneratedFileDT:Add Failed\n");
						break;
					}

					//write to file
					if(WritePayoutFile(csFilePath,hDetail)!=PD_OK){
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::WritePayoutFile Error!!!\n"));
ERRLOG("BOOLPayout::handle_PayoutGenerate:WritePayoutFile Error!!!\n");
						break;
					}

					if(!iOnlinePayout){
						//create txn to txn_header and detail
						if(iRet==PD_OK){
							PutField_CString(hContext,"process_type","0000");
							PutField_CString(hContext,"process_code","000000");
							PutField_Int(hContext,"do_logging",PD_TRUE);
							PutField_Int(hContext,"db_commit",PD_FALSE);

DEBUGLOG(("handle_PayoutGenerate::Call OMTChannel:AddTxnLog\n"));
							ChannelObjPtr = CreateObj(ChannelPtr,"OMTChannel","AddTxnLog");
							if((unsigned long) ((*ChannelObjPtr)(hContext,hDetail))!=PD_OK){
								iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::OMTChannel:AddTxnLog Failed\n"));
							}
							PutField_Int(hContext,"do_logging",PD_FALSE);
						}
						if(iRet==PD_OK){
							//calulate cost

							PutField_CString(hCost,"org_txn_code",PD_OL_PAYOUT_GENERATE);
DEBUGLOG(("handle_PayoutGenerate::Call BOOLPspCosts: CalOLPspCostsByParty\n"));
                                                	BOObjPtr = CreateObj(BOPtr,"BOOLPspCosts","CalOLPspCostsByParty");
							if((unsigned long)(*BOObjPtr)(hCost,hCost)==PD_OK){
								if(GetField_Int(hCost,"rule_id",&iCostTmp)){
									PutField_Int(hTxn,"charge_rule_id",iCostTmp);
DEBUGLOG(("handle_PayoutGenerate::cost rule id[%d]\n",iCostTmp));
								}
								if(GetField_Char(hCost,"charge_period_type",&cTmp)){
									PutField_Char(hTxn,"charge_period_type",cTmp);
DEBUGLOG(("handle_PayoutGenerate::charge_period_type[%c]\n",cTmp));
								}
								if(GetField_Double(hCost,"precal_fee",&dTmp)){
									PutField_Double(hTxn,"pre_cal_charge",dTmp);
DEBUGLOG(("handle_PayoutGenerate::payout_cost[%lf]\n",dTmp));
								}
							}
						}
						//add txn_element
						if(iRet==PD_OK){
							PutField_Char(hElement,"party_type",PD_TYPE_PSP);
							PutField_CString(hElement,"amount_type",PD_DR);
DEBUGLOG(("handle_PayoutGenerate::Call BOOLTxnElements:AddTxnAmtElement\n"));
							BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddTxnAmtElement");
							iRet = (unsigned long)(*BOObjPtr)(hElement);

							if(iRet==PD_OK){
DEBUGLOG(("handle_PayoutGenerate::Call BOOLTxnElements:AddTxnFeeElements\n"));
								BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddTxnFeeElements");
								iRet = (unsigned long)(*BOObjPtr)(hElement);
							}
						}

						//update txn_header and txn_psp_detail
						if(iRet==PD_OK){
DEBUGLOG(("handle_PayoutGenerate::Call BOOLBalance:UpdatePayoutAmount\n"));
							PutField_Char(hTxn,"party_type",PD_TYPE_PSP);
							PutField_Char(hTxn,"response_mode",PD_ACCEPT);
							PutField_CString(hTxn,"sub_status",PD_APPROVED);
							PutField_Char(hTxn,"recon_status",PD_UNRECONCILED);
							BOObjPtr = CreateObj(BOPtr,"BOOLBalance","UpdatePayoutAmount");
							if((unsigned long)(*BOObjPtr)(hTxn)!=PD_OK){
DEBUGLOG(("handle_PayoutGenerate::BOOLBalance:UpdatePayoutAmount Failed\n"));
								iRet = INT_ERR;
							}
							else{
								if(GetField_CString(hContext,"PHDATE",&csTmp)){
									PutField_CString(hTxn,"PHDATE",csTmp);
								}
								if(GetField_CString(hContext,"local_tm_time",&csTmp)){
									PutField_CString(hTxn,"local_tm_time",csTmp);
								}
								if(GetField_CString(hRequest,"report_date",&csTmp)){
									PutField_CString(hTxn,"report_date",csTmp);
								}
								PutField_CString(hTxn,"desc","Payout (PSP)");
								PutField_CString(hTxn,"to_bank_code",csToBank);
								PutField_Char(hTxn,"ex_supplier",PD_INT_EX);
								PutField_Double(hTxn,"ex_rate",1.0);
								iRet = UpdateTxnLog(hTxn);
								if(iRet!=PD_OK){
DEBUGLOG(("handle_PayoutGenerate::BOBalance:UpdateTxnLog Failed\n"));
									break;
								}
								else{
									TxnCommit();
								}
							}
						}
					}
					/*else{ //Online Payout//TW case
						//Add to PayoutQueueDt 
						PutField_Char(hDetail,"status",PD_INIT);
						DBObjPtr = CreateObj(DBPtr,"DBPayoutQueueDt","Add");
						if((unsigned long)(*DBObjPtr)(hDetail)==PD_OK){
DEBUGLOG(("handle_PayoutGenerate::Add PayoutQueueDt Success\n"));
						}
						else{
							iRet=INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::Add PayoutQueueDt Failed!!!!\n"));
							break;
						}
					}*/

					iTxnCnt = 0;
					sprintf(csTag,"%s_%s_gen_txn_cnt",csPspId,csToBank);
					GetField_Int(hContext,csTag,&iTxnCnt);
					PutField_Int(hContext,csTag,iTxnCnt+1);

				}

				//update txn status+detail to merchant_upload_file_dt and update status to txn header
				if(iRet == PD_OK){
					PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
					DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","UpdateDetailByBatchId");
					if ((*DBObjPtr)(csBatchId,iSeqNum,hTxn) != PD_OK) {
						iRet = INT_ERR;
DEBUGLOG(("BOOLPayout::DBOLMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
					}
				}
				if(iRet == PD_OK){
					if(iOnlinePayout)
						PutField_CString(hUploadTxn,"sub_status",PD_APPROVED_AND_SENDING);
					else
						PutField_CString(hUploadTxn,"sub_status",PD_APPROVED_AND_GENERATED);
DEBUGLOG(("handle_PayoutGenerate::Call DBOLTransaction:Update (UploadTxn)\n"));
					DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Update");
					if((unsigned long) ((*DBObjPtr)(hUploadTxn))!=PD_OK){
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::DBOLTransaction:Update Failed\n"));
					}
				}
				
				iTxnCnt = 0;
				sprintf(csTag,"%s_%s_txn_cnt",csPspId,csToBank);
				GetField_Int(hContext,csTag,&iTxnCnt);
				PutField_Int(hContext,csTag,iTxnCnt+1);

				i++;
				hRec = RecordSet_GetNext(rRecordSet);
				hash_destroy(hTxn);
				hash_destroy(hDetail);
				hash_destroy(hUploadTxn);
				hash_destroy(hElement);
				hash_destroy(hCost);
			}

			if(iRet == PD_OK && i>0 && !iOnlinePayout){
				hash_init(hTxn,0);
				PutField_Int(hTxn,"end_file",PD_TRUE);
				iRet = WritePayoutFile(csFilePath,hTxn);
			}
			if(i==0){
				iRet = INT_NOT_RECORD;
				PutField_Int(hTxn,"internal_error",iRet);
			}

		}
	}

	//update total amount and status to payout_generated_file_hd
	if(iRet == PD_OK){
		iCnt = 0;
		int i;
		GetField_Int(hContext,"psp_count",&iCnt);
		for(i=0; i<iCnt; i++){
			hash_init(hTxn,0);
			sprintf(csTag,"psp_id_%d",i);
			sprintf(csTagTwo,"bank_code_%d",i);
			if(GetField_CString(hContext,csTag,&csPspId) &&
			   GetField_CString(hContext,csTagTwo,&csBankCode)
			){
				sprintf(csTag,"%s_%s_txn_amt",csPspId,csBankCode);
				GetField_Double(hContext,csTag,&dTmp);
				PutField_Double(hTxn,"txn_amt",dTmp);

				sprintf(csTag,"%s_%s_file_id",csPspId,csBankCode);
				GetField_CString(hContext,csTag,&csTmp);
				PutField_CString(hTxn,"file_id",csTmp);

				if(!iOnlinePayout)
					PutField_Int(hTxn,"status",PD_PAYOUTFILE_GENERATED);

				DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Update");
				if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
DEBUGLOG(("BOOLPayout::handle_PayoutGenerate:OLPayoutGeneratedFileHD::Update Error!!!\n"));
ERRLOG("BOOLPayout::handle_PayoutGenerate:OLPayoutGeneratedFileHD::Update Error!!!\n");
					iRet = INT_ERR;
					break;
				}
			}
		}
	}
/*
	//Add to PayoutQueueHd
	if(iRet == PD_OK && iOnlinePayout){
		recordset_init(rRecordSet,0);
DEBUGLOG(("handle_PayoutGenerate::Call DBOLMerchantUploadFileDetail:GetPregenSummary\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","GetPregenSummary");
		if((unsigned long)(*DBObjPtr)(iGenId,rRecordSet)==PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec && (iRet==PD_OK)) {
				hash_init(hTxn,0);
				if (GetField_CString(hRec, "batch_id", &csBatchId)) {
					PutField_CString(hTxn,"batch_id",csBatchId);
DEBUGLOG(("GetPregenSummary::batch_id = [%s]\n",csBatchId));
				}
				if (GetField_CString(hRec, "psp_id", &csPspId)) {
					PutField_CString(hTxn,"psp_id",csPspId);
DEBUGLOG(("GetPregenSummary::psp_id = [%s]\n",csPspId));
				}
				if (GetField_CString(hRec, "file_id", &csTmp)) {
					PutField_CString(hTxn,"queue_seq",csTmp);
DEBUGLOG(("GetPregenSummary::queue_seq = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec, "merchant_id", &csTmp)) {
					PutField_CString(hTxn,"merchant_id",csTmp);
DEBUGLOG(("GetPregenSummary::merchant_id = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec, "service_code", &csTmp)) {
					PutField_CString(hTxn,"service_code",csTmp);
DEBUGLOG(("GetPregenSummary::service_code = [%s]\n",csTmp));
				}
				if (GetField_Int(hRec, "count", &iTmp)) {
					PutField_Int(hTxn,"num_of_record",iTmp);
DEBUGLOG(("GetPregenSummary::num_of_record = [%d]\n",iTmp));
				}
				if(GetField_CString(hContext,"PHDATE",&csTmp)){
					PutField_CString(hTxn,"txn_date",csTmp);
				}
				PutField_Char(hTxn,"status",PD_INIT);
				DBObjPtr = CreateObj(DBPtr,"DBPayoutQueueHd","Add");
				if((unsigned long)(*DBObjPtr)(hTxn)==PD_OK){
DEBUGLOG(("handle_PayoutGenerate: Add PayoutQueueHd Success\n"));
				}
				else{
					iRet=INT_ERR;
DEBUGLOG(("handle_PayoutGenerate: Add PayoutQueueHd Failed!!!!\n"));
					break;
				}
				
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}
*/

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
        FREE_ME(hTxn);
        FREE_ME(hDetail);
        FREE_ME(hUploadTxn);
        FREE_ME(hElement);
        FREE_ME(hBal);
        FREE_ME(hCost);
DEBUGLOG(("BOOLPayout::handle_PayoutGenerate: [%d]\n",iRet));
	return iRet;
}


/*
int handle_PayoutGenerate(hash_t *hContext,
			  hash_t* hRequest,
			  hash_t* hHeader)
{
	int	iRet = PD_OK;
	int	i=0;
	int	iTmp=0;
	int	iPspCnt=0;
	char*	csTmp;
	char*	csPspId;
	char*	csBaid;
	char*	csBankCode;
	char*	csFilePath;
	char*	csPayoutCcy;
	char	csTag[PD_TAG_LEN +1];
	char	csTmpBatch[PD_TXN_SEQ_LEN +1];
	double	dAmt=0.0;
	double	dBatchAmt=0.0;
	double	dPayoutAmt=0.0;
	int	iBatchCnt = 0;
	int	iFormat = 0;
	char	*csCountry;

DEBUGLOG(("BOOLPayout::handle_PayoutGenerate()\n"));

	hash_t  *hRec, *hDetail, *hTxn, *hUploadTxn;
	hash_t  *hElement;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);
	hUploadTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hUploadTxn,0);
	hElement= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hElement,0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
	recordset_t     *rDetailSet;
	rDetailSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rDetailSet,0);
	recordset_t     *rTmpSet;
	rTmpSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rTmpSet,0);

DEBUGLOG(("handle_PayoutGenerate::Call DBOLPayoutGeneratedFileHD:GetPreGenHeader\n"));
	DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","GetPreGenHeader");
	if((unsigned long)(*DBObjPtr)(PD_PAYOUTFILE_PRE_GENERATED,rRecordSet)==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
		while ((hRec) && (iRet==PD_OK)) {
			if(GetField_CString(hRec,"file_id",&csTmp)){
				PutField_CString(hHeader,"file_id",csTmp);
				PutField_CString(hTxn,"file_id",csTmp);
				PutField_CString(hRequest,"file_id",csTmp);
DEBUGLOG(("GetPreGenHeader::file_id = [%s]\n",csTmp));
			}
			if(GetField_Int(hRec,"seq_num",&iTmp)){
				PutField_Int(hTxn,"seq_num",iTmp);
DEBUGLOG(("GetPreGenHeader::seq_num = [%d]\n",iTmp));
			}
			if(GetField_CString(hRec,"file_date",&csTmp)){
				PutField_CString(hTxn,"file_date",csTmp);
DEBUGLOG(("GetPreGenHeader::file_date = [%s]\n",csTmp));
			}
			if(GetField_CString(hRec,"file_bank_code",&csBankCode)){
				PutField_CString(hTxn,"file_bank_code",csBankCode);
DEBUGLOG(("GetPreGenHeader::file_bank_code = [%s]\n",csBankCode));
			}
			if(GetField_Int(hRec,"txn_count",&iTmp)){
				PutField_Int(hTxn,"txn_cnt",iTmp);
DEBUGLOG(("GetPreGenHeader::txn_count = [%d]\n",iTmp));
			}
			if(GetField_CString(hRec,"psp_id",&csPspId)){
				PutField_CString(hRequest,"psp_id",csPspId);
				PutField_CString(hTxn,"psp_id",csPspId);
				PutField_CString(hTxn,"org_psp_id",csPspId);
				iPspCnt++;
				PutField_Int(hContext,"psp_count",iPspCnt);
DEBUGLOG(("GetPreGenHeader::psp_id = [%s]\n",csPspId));
			}
			
			if(GetField_CString(hRec,"payout_ccy",&csPayoutCcy)){
				PutField_CString(hContext,"org_psp_txn_ccy",csPayoutCcy);
				PutField_CString(hContext,"org_txn_ccy",csPayoutCcy);
DEBUGLOG(("GetPreGenHeader::payout_ccy = [%s]\n",csPayoutCcy));
			}

			if(GetField_Double(hRec,"total_txn_amt",&dAmt)){
				PutField_Double(hContext,"org_dst_net_amt",dAmt);
DEBUGLOG(("GetPreGenHeader::total_txn_amt = [%lf]\n",dAmt));
			}

			RemoveField_Int(hTxn,"txn_cnt");

			if(GetField_CString(hRec,"filename",&csTmp)){
				PutField_CString(hTxn,"filename",csTmp);
				PutField_CString(hRequest,"generated_file_name",csTmp);
DEBUGLOG(("GetPreGenHeader::filename = [%s]\n",csTmp));
			}
			
			if (iRet == PD_OK) {
				hash_t *hPsp;
				hPsp = (hash_t*) malloc (sizeof(hash_t));
				hash_init(hPsp,0);
				DBObjPtr = CreateObj(DBPtr,"DBOLPspDetail","GetPayoutTmpAcct");
				if (!(*DBObjPtr)(csPspId, hPsp)) {
					if (GetField_CString(hPsp,"client_id",&csTmp)) {
						PutField_CString(hContext,"psp_client_id",csTmp);
DEBUGLOG(("BOOLPayout::handle_PayoutGenerate: GetPayoutTmpAcct - client id = [%s]\n",csTmp));
					}
					if (GetField_Int(hPsp,"payout_format",&iFormat)) {
DEBUGLOG(("BOOLPayout::handle_PayoutGenerate: GetPayoutTmpAcct - payout_format = [%d]\n",iFormat));
					}
					if (GetField_CString(hPsp,"baid",&csBaid)) {
DEBUGLOG(("BOOLPayout::handle_PayoutGenerate: GetPayoutTmpAcct - baid = [%s]\n",csBaid));
					}
					if (GetField_CString(hPsp,"bank_acct_num",&csTmp)) {
DEBUGLOG(("BOOLPayout::handle_PayoutGenerate: GetPayoutTmpAcct - bank_acct_num = [%s]\n",csTmp));
					}
				}
				FREE_ME(hPsp);
			}

			if(GetPayoutFilePath(hTxn)==PD_OK){
				if(CreatePayoutFile(iFormat,csPspId,csBankCode,hTxn)!=PD_OK){
DEBUGLOG(("GetPreGenHeader::CreatePayoutFile failed for [%s][%s]!!\n",csPspId,csBankCode));
					iRet= INT_ERR;
					break;
				}
			}
			else{
DEBUGLOG(("GetPreGenHeader::GetPayoutFilePath failed for [%s][%s]!!\n",csPspId,csTmp));
				iRet= INT_ERR;
				break;
			}
			sprintf(csTag, "%s_%s_path", csPspId,csBankCode);
			GetField_CString(hTxn,csTag,&csFilePath);

			i =0;
			csTmpBatch[0]='\0';
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_APPROVED);
			recordset_init(rDetailSet,0);
			hash_init(hUploadTxn,0);
DEBUGLOG(("handle_PayoutGenerate::Call DBOLPayoutGeneratedFileDT:GetDetail\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileDT","GetDetail");
			if((unsigned long)(*DBObjPtr)(hTxn,rDetailSet)==PD_OK){
				hDetail = RecordSet_GetFirst(rDetailSet);
				while ((hDetail) && (iRet==PD_OK)){
					if(GetField_CString(hDetail,"txn_id",&csTmp)){
						sprintf(csTag,"txn_seq_%d",i);
						PutField_CString(hContext,csTag,csTmp);
						PutField_CString(hContext,"txn_seq",csTmp);
						PutField_CString(hElement,"from_txn_seq",csTmp);
					}
					if(GetField_CString(hDetail,"upload_txn_id",&csTmp)){
						PutField_CString(hUploadTxn,"txn_seq",csTmp);
					}
					if(GetField_CString(hDetail,"merchant_ref",&csTmp)){
						PutField_CString(hRequest,"merchant_ref",csTmp);
					}
					if(GetField_CString(hDetail,"service_code",&csTmp)){
						sprintf(csTag,"service_code_%d",i);
						PutField_CString(hContext,csTag,csTmp);
					}
					sprintf(csTag,"dst_txn_ccy_%d",i);
					PutField_CString(hRequest,csTag,csPayoutCcy);
					sprintf(csTag,"txn_ccy_%d",i);
					PutField_CString(hRequest,csTag,csPayoutCcy);
					PutField_CString(hElement,"org_txn_ccy",csPayoutCcy);
					PutField_CString(hElement,"src_txn_fee_ccy",csPayoutCcy);

					sprintf(csTag,"psp_id_%d",i);
					PutField_CString(hRequest,csTag,csPspId);

					sprintf(csTag,"baid_%d",i);
					PutField_CString(hRequest,csTag,csBaid);

					if(GetField_CString(hDetail,"batch_id",&csTmp)){
						if(strcmp(csTmpBatch,csTmp)){
							strcpy(csTmpBatch,csTmp);
							csTmpBatch[strlen(csTmp)]='\0';
							sprintf(csTag,"assign_batch_%d",iBatchCnt);
							PutField_CString(hContext,csTag,csTmpBatch);
							iBatchCnt++;
							PutField_Int(hContext,"assign_batch_cnt",iBatchCnt);
						}
						sprintf(csTag,"batch_id_%d",i);
						PutField_CString(hRequest,csTag,csTmpBatch);
DEBUGLOG(("handle_PayoutGenerate::GetDetail batch_id[%s]\n",csTmp));
					}
					if(GetField_Double(hDetail,"payout_amount",&dPayoutAmt)){
						dBatchAmt=0;
						sprintf(csTag,"%s_total_amt",csTmpBatch);
						GetField_Double(hContext,csTag,&dBatchAmt);
						dBatchAmt+=dPayoutAmt;
						PutField_Double(hContext,csTag,dBatchAmt);

						sprintf(csTag,"gen_payout_amt_%d",i);
						PutField_Double(hRequest,csTag,dPayoutAmt);
						PutField_Double(hElement,"org_txn_amt",dPayoutAmt);

DEBUGLOG(("handle_PayoutGenerate::GetDetail payout_amt[%lf]\n",dPayoutAmt));

						PutField_Double(hTxn,"org_dst_net_amt",dPayoutAmt);
					}
					if(GetField_Int(hDetail,"seq_num",&iTmp)){
						sprintf(csTag,"seq_num_%d",i);
						PutField_Int(hRequest,csTag,iTmp);
DEBUGLOG(("handle_PayoutGenerate::GetDetail seq_num[%d]\n",iTmp));
					}
					if(GetField_CString(hDetail,"txn_country",&csCountry)){
						sprintf(csTag,"txn_country_%d",i);
						PutField_CString(hRequest,csTag,csCountry);
DEBUGLOG(("handle_PayoutGenerate::GetDetail txn_country[%s]\n",csCountry));
					}

					PutField_Int(hDetail,"payout_format",iFormat);
					if(WritePayoutFile(csFilePath,hDetail)!=PD_OK){
						iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::WritePayoutFile Error!!!\n"));
ERRLOG("BOOLPayout::handle_PayoutGenerate:WritePayoutFile Error!!!\n");
					}

/// need to create pending POG transaction
					if(iRet==PD_OK){
						PutField_CString(hContext,"process_type","0000");
						PutField_CString(hContext,"process_code","000000");
						PutField_Int(hContext,"do_logging",PD_TRUE);
						PutField_Int(hContext,"db_commit",PD_FALSE);

DEBUGLOG(("handle_PayoutGenerate::Call OMTChannel:AddTxnLog\n"));
						ChannelObjPtr = CreateObj(ChannelPtr,"OMTChannel","AddTxnLog");
						if((unsigned long) ((*ChannelObjPtr)(hContext,hRequest))!=PD_OK){
							iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::OMTChannel:AddTxnLog Failed\n"));
						}
						PutField_Int(hContext,"do_logging",PD_FALSE);
					}


					if(iRet==PD_OK){
						PutField_CString(hUploadTxn,"sub_status",PD_APPROVED_AND_GENERATED);
DEBUGLOG(("handle_PayoutGenerate::Call DBOLTransaction:Update (UploadTxn)\n"));
						DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Update");
						if((unsigned long) ((*DBObjPtr)(hUploadTxn))!=PD_OK){
							iRet = INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::DBOLTransaction:Update Failed\n"));
						}
					}

					if(iRet==PD_OK){
						PutField_Char(hElement,"party_type",PD_TYPE_PSP);
						PutField_CString(hElement,"amount_type",PD_DR);
DEBUGLOG(("handle_PayoutGenerate::Call BOOLTxnElements:AddTxnAmtElement\n"));
						BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddTxnAmtElement");
                                                iRet = (unsigned long)(*BOObjPtr)(hElement);

                                                if(iRet==PD_OK){
DEBUGLOG(("handle_PayoutGenerate::Call BOOLTxnElements:AddTxnFeeElements\n"));
                                                        BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddTxnFeeElements");
                                                        iRet = (unsigned long)(*BOObjPtr)(hElement);
                                                }
                                        }

					i++;
					PutField_Int(hRequest,"total_count",i);
					PutField_Int(hContext,"total_cnt",i);
					hDetail = RecordSet_GetNext(rDetailSet);
				}

				if(iRet==PD_OK){
					PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
					DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileDT","UpdateByFileId");
					if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
						iRet=INT_ERR;
DEBUGLOG(("handle_PayoutGenerate::DBOLPayoutGeneratedFileDT Update Failed!!!\n"));
ERRLOG("BOOLPayout::handle_PayoutGenerate:DBOLPayoutGeneratedFileDT Update Failed!!!\n");
					}
				}
			}

			if(iRet == PD_OK && i>0){
				PutField_Int(hTxn,"end_file",PD_TRUE);
				iRet = WritePayoutFile(csFilePath,hTxn);
			}

			hRec = RecordSet_GetNext(rRecordSet);

			if(iRet == PD_OK && i>0){
				PutField_Char(hContext,"response_mode",PD_ACCEPT);
				PutField_CString(hContext,"desc","Payout (PSP)");
				PutField_Char(hContext,"party_type",PD_TYPE_PSP);

///need to update balance
				if(HandlePayoutBalance(hContext,hRequest)!=PD_OK){
DEBUGLOG(("handle_PayoutGenerate::HandlePayoutBalance Failed!!!\n"));
ERRLOG("BOOLPayout::handle_PayoutGenerate:HandlePayoutBalance Failed!!!\n");
					iRet = INT_ERR;
				}

			}

			if(iRet==PD_OK && i>0){
				PutField_Int(hHeader,"status",PD_PAYOUTFILE_GENERATED);
				DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Update");
				if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("Authorize::PayoutGeneratedFileHD::Update Error!!!\n"));
					iRet = INT_ERR;
				}
			}
		
			if(iRet==PD_OK && i>0){
				iRet = UpdateDetail(hContext,hRequest); 
			}
			PutField_Int(hRequest,"total_count",0);
			PutField_Int(hContext,"total_cnt",0);
		}

	}


	FREE_ME(hTxn);
	FREE_ME(hUploadTxn);
	FREE_ME(hElement);
	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
	RecordSet_Destroy(rDetailSet);
        FREE_ME(rDetailSet);
	RecordSet_Destroy(rTmpSet);
        FREE_ME(rTmpSet);
	return iRet;
}
*/

int UpdateHeader(hash_t *hContext,
		hash_t* hRequest)
{
	int     iRet  = PD_OK;
	int	iCnt=0;
	int	i=0;
	int	iResult=0;
	//int	iUpdate=PD_FALSE;
	char	*csTmp;
	char	*csTxnCode;
	char	*csTxnId;
	char	*csBatchId;
	char	csTag[PD_TAG_LEN +1];
	unsigned long lBatchId = 0l;
	unsigned long lTmp=0l;
	double	dTmp;
	double	dBatchAmt=0.0;

	hash_t  *hRec;
	hash_t  *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);
	hash_t  *hHeader;
	hHeader = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hHeader,0);

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOOLPayout::UpdateHeader()\n"));

	///for POU/POA/POC/PCA, only update one batch	
	if(GetField_CString(hRequest,"batch_id",&csTmp)){
		sprintf(csTag,"batch_id_%d",0);
		PutField_CString(hRequest,csTag,csTmp);
		PutField_Int(hRequest,"total_count",1);
	}

	GetField_CString(hRequest,"txn_code",&csTxnCode);
	if(!strcmp(csTxnCode,PD_OL_PAYOUT_APPROVE)){
		PutField_Int(hTxn,"status",PD_PAYOUTFILE_APPROVED);
 		if(GetField_CString(hContext,"org_txn_id",&csTxnId)){
			PutField_CString(hContext,"txn_seq",csTxnId);
DEBUGLOG(("UpdateHeader::txn_id = [%s]\n",csTxnId));
		}
	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_CONFIRM)){
		PutField_Int(hTxn,"status",PD_PAYOUTFILE_PROCESSING);
	}
	else if(!strcmp(csTxnCode,PD_OL_PAYOUT_GENERATE)){
 		if(GetField_CString(hContext,"org_txn_id",&csTxnId)){
			PutField_CString(hContext,"txn_seq",csTxnId);
DEBUGLOG(("UpdateHeader::txn_id = [%s]\n",csTxnId));
		}
	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_UPLOAD)){
		if(GetField_CString(hContext,"txn_seq",&csTmp))
			PutField_CString(hTxn,"txn_seq",csTmp);
		if(GetField_CString(hContext,"PHDATE",&csTmp))
			PutField_CString(hTxn,"posting_date",csTmp);

	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_APPROVED)){
		PutField_Int(hTxn,"status",PD_PAYOUTFILE_REVERSED);
	}
	else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_BEFORE_APPROVED)){
		PutField_Int(hTxn,"status",PD_PAYOUTFILE_DECLINED);
	}
	
	
	if(GetField_Int(hRequest,"total_count",&iCnt)){
DEBUGLOG(("UpdateHeader::total_count= [%d]\n",iCnt));
	}
	for(i=0; i<iCnt; i++){
		dBatchAmt=0;
		sprintf(csTag, "batch_id_%d", i);
		GetField_CString(hRequest,csTag,&csBatchId);
		PutField_CString(hTxn,"batch_id",csBatchId);

		lBatchId = ctol((const unsigned char *)csBatchId,strlen(csBatchId));
		if (lTmp==lBatchId)
			continue;

		lTmp = lBatchId;

        	recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileHeader","GetHeader");
		if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec,"txn_seq",&csTmp)) {
					//PutField_CString(hHeader,"txn_seq",csTmp);
DEBUGLOG(("UpdateHeader::org_txn_seq = [%s]\n",csTmp));
				}
				if(GetField_Double(hRec,"txn_amt",&dTmp)){
					if(!strcmp(csTxnCode,PD_OL_PAYOUT_APPROVE)){
						PutField_Double(hTxn,"remain_amt",dTmp);
					}
				}
				if(GetField_Double(hRec,"remain_amt",&dTmp)){
					if(!strcmp(csTxnCode,PD_OL_PAYOUT_GENERATE)){
						sprintf(csTag, "%s_total_amt",csBatchId);
						GetField_Double(hContext,csTag,&dBatchAmt);
DEBUGLOG(("UpdateHeader::[%s] = [%lf]\n",csTag,dBatchAmt));
						dTmp -= dBatchAmt;
						PutField_Double(hTxn,"remain_amt",dTmp);
DEBUGLOG(("UpdateHeader::remain_amt = [%lf]\n",dTmp));
					}
					else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_GENERATED)||
						!strcmp(csTxnCode,PD_PAYOUT_INDV_CANCEL)){
						sprintf(csTag, "%s_cancel_amt",csBatchId);
						GetField_Double(hContext,csTag,&dBatchAmt);
DEBUGLOG(("UpdateHeader::[%s] = [%lf]\n",csTag,dBatchAmt));
						dTmp += dBatchAmt;
						PutField_Double(hTxn,"remain_amt",dTmp);
DEBUGLOG(("UpdateHeader::remain_amt = [%lf]\n",dTmp));
					}
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}

		if(!strcmp(csTxnCode,PD_OL_PAYOUT_GENERATE) || !strcmp(csTxnCode,PD_PAYOUT_CANCEL_GENERATED)){
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","MatchCount");
			if(!strcmp(csTxnCode,PD_OL_PAYOUT_GENERATE)){
				iResult = (unsigned long) ((*DBObjPtr)(lBatchId,PAYOUT_MASTER_TRANSACTION_GENERATED));
				if(iResult!=PD_ERR && iResult!=PD_NOT_FOUND){
					if(iResult==PD_TRUE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_GENERATED);
					else if (iResult==PD_FALSE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_PARTIAL_GENERATED);

					PutField_CString(hContext,"sub_status",PD_APPROVED_AND_GENERATED);
					//PutField_CString(hHeader,"sub_status",PD_APPROVED_AND_GENERATED);
					//iUpdate=PD_TRUE;
				}
			}
			else{
				iResult = (unsigned long) ((*DBObjPtr)(lBatchId,PAYOUT_MASTER_TRANSACTION_APPROVED));
				if(iResult!=PD_ERR && iResult!=PD_NOT_FOUND){
					if(iResult==PD_TRUE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_APPROVED);
					else if (iResult==PD_FALSE)
						PutField_Int(hTxn, "status", PD_PAYOUTFILE_PARTIAL_GENERATED);

					PutField_CString(hContext,"sub_status",PD_APPROVED_FOR_GENERATED);
					//PutField_CString(hHeader,"sub_status",PD_APPROVED_FOR_GENERATED);
					//iUpdate=PD_TRUE;
				}
			}
		}
DEBUGLOG(("UpdateHeader::DBOLMerchantUploadFileHeader:UpdateHeader\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileHeader","UpdateHeader");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("UpdateHeader::DBOLMerchantUploadFileHeader:UpdateHeader Failed\n"));
		}
	}

	FREE_ME(hTxn);
	FREE_ME(hHeader);
	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
DEBUGLOG(("BOOLPayout::UpdateHeader() iRet=[%d]\n",iRet));
	return  iRet;
}


int GetPayoutRecordsByMode(hash_t *hContext,
			hash_t* hRequest,
			hash_t* hResponse)
{
	int     iRet  = PD_OK;
	int	i= 0;
	int	iCnt= 0;
	int	iTmp= 0;
	char	*csTmp;
	char	cInputInd;
	double	dTmp=0.0;
	double	dTotalAmt=0.0;
	double	dMin=0.0;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

DEBUGLOG(("BOOLPayout:GetPayoutRecordsByMode()\n"));

	if(GetField_Char(hContext,"input_ind",&cInputInd)){
DEBUGLOG(("GetPayoutRecordsByMode::input_ind = [%c]\n",cInputInd));
	}

	if(GetField_Int(hContext,"status",&iTmp)){
DEBUGLOG(("GetPayoutRecordsByMode::status= [%d]\n",iTmp));
		PutField_Int(hTxn,"status",iTmp);
	}

	if(cInputInd == PD_BY_TXN){
		if (GetField_Int(hContext, "total_cnt", &iCnt)) {
DEBUGLOG(("GetPayoutRecordsByMode::total_cnt = [%d]\n", iCnt));
                }
		for (i = 0; i < iCnt; i++) {
			sprintf(csTag, "batch_id_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
				PutField_CString(hTxn,"batch_id",csTmp);
			}
			sprintf(csTag, "seq_num_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
				PutField_Int(hTxn,"seq_num",atoi(csTmp));
			}

			PutField_Int(hTxn,"current_index",i);
			iRet = GetPayoutRecords(hTxn,hContext,hRequest);
			if(GetField_Double(hContext,"total_net_amt",&dTmp))
				dTotalAmt += dTmp;
		}
		PutField_Int(hContext,"total_cnt",iCnt);
		PutField_Double(hContext,"total_net_amt",dTotalAmt);
	}
	else{
		if(GetField_CString(hContext,"bank_name",&csTmp)){
			PutField_CString(hTxn,"bank_name",csTmp);
DEBUGLOG(("GetPayoutRecordsByMode::bank_name = [%s]\n",csTmp));
		}
		if(GetField_CString(hContext,"batch_id",&csTmp)){
			PutField_CString(hTxn,"batch_id",csTmp);
DEBUGLOG(("GetPayoutRecordsByMode::batch_id = [%s]\n",csTmp));
		}
		if(GetField_Double(hContext,"total_amt",&dTmp)){
			if(dTmp>0.0)
				PutField_Double(hTxn,"total_amt",dTmp);
DEBUGLOG(("GetPayoutRecordsByMode::total_amt = [%lf]\n",dTmp));
		}
		if(GetField_Double(hContext,"min_amt",&dMin)){
			if(dMin>0.0)
				PutField_Double(hTxn,"min_amt",dMin);
DEBUGLOG(("GetPayoutRecordsByMode::min_amt = [%lf]\n",dMin));
		}
		if(GetField_Double(hContext,"max_amt",&dTmp)){
			if(dTmp>0.0){
				PutField_Double(hTxn,"max_amt",dTmp);
				if(dMin==0.0)
					PutField_Double(hTxn,"min_amt",dMin);
			}
DEBUGLOG(("GetPayoutRecordsByMode::max_amt = [%lf]\n",dTmp));
		}
		if(GetField_CString(hContext,"file_id",&csTmp)){
			PutField_CString(hTxn,"file_id",csTmp);
DEBUGLOG(("GetPayoutRecordsByMode::file_id = [%s]\n",csTmp));
		}

		//PD_BY_SELECTED_TXN
		if(GetField_CString(hContext,"tmp_batch_id",&csTmp)){
			PutField_CString(hTxn,"tmp_batch_id",csTmp);
DEBUGLOG(("GetPayoutRecordsByMode::tmp_batch_id = [%s]\n",csTmp));
		}

		iRet = GetPayoutRecords(hTxn,hContext,hRequest);

	}

	FREE_ME(hTxn);
	return iRet;
}


int GetPayoutRecords(hash_t* hTxn,
			hash_t* hContext,
			hash_t* hRequest)
{
	int     iRet  = PD_OK;
	int	iSeqNum = 0;
	//int	iIntErr= PD_OK;
	int	i= 0;
	int	iTmp= 0;
	int	iOnlineMode = PD_FALSE;
	char	*csMerchantId;
	char	*csServiceCode;
	char	*csTxnCountry=strdup("");
	char	*csTxnCcy;
	char	*csTxnId;
	char	*csTmp;
	char	*csMerchantClientId = NULL;
	char	cInputInd;
	double	dTmp=0.0;
	double	dTotalAmt=0.0;
	double	dLimitedAmt=0.0;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	char*   csPspTmp =strdup("");
	//csPspTmp = (char*) malloc (128);

DEBUGLOG(("BOOLPayout:GetPayoutRecords()\n"));

	if(GetField_Int(hTxn,"current_index",&i)){
DEBUGLOG(("BOOLPayout:GetPayoutRecords: current_index [%d]\n",i));
	}
	if(GetField_Double(hTxn,"total_amt",&dLimitedAmt)){
DEBUGLOG(("BOOLPayout:GetPayoutRecords: total_amt [%lf]\n",dLimitedAmt));
	}
	if(GetField_Char(hContext,"input_ind",&cInputInd)){
DEBUGLOG(("BOOLPayout:GetPayoutRecords::input_ind = [%c]\n",cInputInd));
	}

	if(cInputInd==PD_BY_SELECTED_TXN){
DEBUGLOG(("GetPayoutRecords::Call DBOLPayoutApproveTmp:GetDetailBySelectedTxn\n"));
                DBObjPtr = CreateObj(DBPtr,"DBOLPayoutApproveTmp","GetDetailBySelectedTxn");
        }
        else{
DEBUGLOG(("GetPayoutRecords::Call DBOLMerchantUploadFileDetail:GetDetailByCondition\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","GetDetailByCondition");
	}

	if ((unsigned long)(*DBObjPtr)(hTxn,rRecordSet) == PD_FOUND) {
DEBUGLOG(("GetDetailByCondition::found record\n"));
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if (GetField_CString(hRec,"txn_seq",&csTxnId)) {
				sprintf(csTag,"org_txn_id_%d",i);
				PutField_CString(hContext,csTag,csTxnId);
DEBUGLOG(("GetDetailByCondition::org_txn_seq = [%s]\n",csTxnId));
			}
			if (GetField_CString(hRec,"merchant_id",&csMerchantId)) {
				sprintf(csTag,"merchant_id_%d",i);
				PutField_CString(hRequest,"merchant_id",csMerchantId);
				PutField_CString(hContext,"merchant_id",csMerchantId);
				PutField_CString(hRequest,csTag,csMerchantId);
				PutField_CString(hContext,csTag,csMerchantId);
				//sprintf(csTag,"org_merchant_id_%d",i);
				//PutField_CString(hContext,csTag,csMerchantId);
DEBUGLOG(("GetDetailByCondition::merchant_id= [%s]\n",csMerchantId));

				if((i==0)||(cInputInd==PD_BY_TXN)){
					if(!GetField_CString(hContext,"merchant_client_id",&csMerchantClientId)){
						BOObjPtr = CreateObj(BOPtr,"BOOLMerchant","GetMerchantDetail");
						if((unsigned long)(*BOObjPtr)(hContext,hRequest)==PD_OK){
							if(GetField_CString(hContext,"merchant_client_id",&csMerchantClientId)){
DEBUGLOG(("GetMerchantDetail::client_id= [%s]\n",csMerchantClientId));
							}
						}
					}
				}
				sprintf(csTag,"merchant_client_id_%d",i);
				PutField_CString(hContext,csTag,csMerchantClientId);
			}
			else{
				iRet = INT_MERCHANT_ID_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
				break;
DEBUGLOG(("GetDetailByCondition::merchant_id not found\n"));
			}
			if (GetField_CString(hRec,"txn_country",&csTxnCountry)) {
				PutField_CString(hRequest,"txn_country",csTxnCountry);
				PutField_CString(hContext,"txn_country",csTxnCountry);
				sprintf(csTag,"txn_country_%d",i);
				PutField_CString(hRequest,csTag,csTxnCountry);
				PutField_CString(hContext,csTag,csTxnCountry);
DEBUGLOG(("GetDetailByCondition::txn_country= [%s]\n",csTxnCountry));
			}
			if (GetField_CString(hRec,"service_code",&csServiceCode)) {
				PutField_CString(hRequest,"service_code",csServiceCode);
				PutField_CString(hContext,"service_code",csServiceCode);
				sprintf(csTag,"service_code_%d",i);
				PutField_CString(hRequest,csTag,csServiceCode);
				PutField_CString(hContext,csTag,csServiceCode);
				//sprintf(csTag,"org_service_code_%d",i);
				//PutField_CString(hContext,csTag,csServiceCode);
DEBUGLOG(("GetDetailByCondition::service_code= [%s]\n",csServiceCode));

				if((i==0)||(cInputInd==PD_BY_TXN)){
					if(!GetField_Int(hContext,"check_first_txn",&iTmp)){
						//iRet = isVoidWithFee(hContext);
/*
						DBObjPtr = CreateObj(DBPtr,"DBService","FindCountryByService");
						if ((unsigned long)(DBObjPtr)(csServiceCode,csTxnCountry) == FOUND) {
DEBUGLOG(("GetDetailByCondition::txn_country= [%s]\n",csTxnCountry));
							PutField_CString(hRequest,"txn_country",csTxnCountry);
							PutField_CString(hContext,"txn_country",csTxnCountry);
							//sprintf(csTag,"org_txn_country_%d",i);
							PutField_CString(hContext,"first_txn_country",csTxnCountry);
						}

*/						DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","ChkRuleExists");
						if ((unsigned long)(DBObjPtr)(csMerchantId,csServiceCode) == PD_FOUND) {
	
							DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","FindPsp");
							if ((unsigned long)(DBObjPtr)(csMerchantId,csServiceCode,csPspTmp) == PD_FOUND) {
								PutField_CString(hContext,"first_txn_psp",csPspTmp);
								iOnlineMode = PD_TRUE;
DEBUGLOG(("GetDetailByCondition::psp_id = [%s]\n",csPspTmp));
							}
						}
						PutField_Int(hContext,"check_first_txn",PD_TRUE);
						PutField_Int(hContext,"first_txn_mode",iOnlineMode);
					}
					else{
						//GetField_CString(hContext,"first_txn_country",&csTxnCountry);
						GetField_CString(hContext,"first_txn_psp",&csPspTmp);
						GetField_Int(hContext,"first_txn_mode",&iOnlineMode);
					}
				}
				//sprintf(csTag,"txn_country_%d",i);
				//PutField_CString(hRequest,csTag,csTxnCountry);
				//PutField_CString(hContext,csTag,csTxnCountry);

				if(iOnlineMode==PD_TRUE){
					sprintf(csTag,"batch_mode_%d",i);
					PutField_Char(hRequest,csTag,PD_ONLINE);

					sprintf(csTag,"pregen_psp_id_%d",i);
					PutField_CString(hRequest,csTag,csPspTmp);
					//FREE_ME(csPspTmp);
				}
				else{
					sprintf(csTag,"batch_mode_%d",i);
					PutField_Char(hRequest,csTag,PD_OFFLINE);
				}
			}
			else{
				iRet = INT_SERVICE_CODE_MISSING;
				PutField_Int(hContext,"internal_error",iRet);
				break;
DEBUGLOG(("GetDetailByCondition::service_code not found\n"));
			}

			if(GetField_CString(hRec,"identity_id",&csTmp)){
				sprintf(csTag,"identity_id_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetDetailByCondition::identity_id= [%s]\n",csTmp));
			}

			if (GetField_CString(hRec,"merchant_ref",&csTmp)) {
				sprintf(csTag,"merchant_ref_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}

			if(GetField_Int(hRec,"seq_num",&iSeqNum)){
				sprintf(csTag,"seq_num_%d",i);
				PutField_Int(hRequest,csTag,iSeqNum);
DEBUGLOG(("GetDetailByCondition::seq_num= [%i]\n",iSeqNum));
			}
			/*if (!GetField_CString(hRec,"txn_country",&csTmp)) {
				sprintf(csTag,"txn_country_%d",i);
				PutField_CString(hRequest,csTag,csTxnCountry);
				PutField_CString(hContext,csTag,csTxnCountry);
			}*/
			if (GetField_CString(hRec,"payout_ccy",&csTmp)){
				if(strcmp(csTmp,"RMB"))
					csTxnCcy = strdup(csTmp);
				else
					csTxnCcy = strdup(PD_CCY_ISO_CNY);

				sprintf(csTag,"dst_txn_ccy_%d",i);
				PutField_CString(hRequest,csTag,csTxnCcy);
				//sprintf(csTag,"txn_ccy_%d",i);
				//PutField_CString(hRequest,csTag,csTxnCcy);
				//PutField_CString(hContext,csTag,csTxnCcy);
				//sprintf(csTag,"org_txn_ccy_%d",i);
				//PutField_CString(hContext,csTag,csTxnCcy);
DEBUGLOG(("GetDetailByCondition::payout_ccy= [%s]\n",csTmp));
				FREE_ME(csTxnCcy);
			}

			if(GetField_CString(hRec,"request_ccy",&csTmp)){
				if(strcmp(csTmp,"RMB"))
					csTxnCcy = strdup(csTmp);
				else
					csTxnCcy = strdup(PD_CCY_ISO_CNY);

				sprintf(csTag,"txn_ccy_%d",i);
				PutField_CString(hRequest,csTag,csTxnCcy);
				PutField_CString(hContext,csTag,csTxnCcy);
				PutField_CString(hRequest,"txn_ccy",csTxnCcy);
				PutField_CString(hContext,"txn_ccy",csTxnCcy);
				//PutField_CString(hContext,"txn_ccy",csTxnCcy);
				//sprintf(csTag,"org_txn_ccy_%d",i);
				//PutField_CString(hContext,csTag,csTxnCcy);
DEBUGLOG(("GetDetailByCondition::request_ccy= [%s]\n",csTxnCcy));
				FREE_ME(csTxnCcy);
			}
			if (GetField_Double(hRec,"request_amount",&dTmp)) {
				sprintf(csTag,"txn_amt_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
				dTotalAmt += dTmp;
				PutField_Double(hContext,"total_net_amt",dTotalAmt);
DEBUGLOG(("GetDetailByCondition::request_amount= [%lf]\n",dTmp));
			
				if((dLimitedAmt>0.0) && (dTotalAmt>dLimitedAmt)){
					PutField_Double(hContext,"total_net_amt",dTotalAmt-dTmp);
DEBUGLOG(("GetDetailByCondition::total amount[%lf] > limited amount[%lf]. Stop counting Txn\n",dTotalAmt,dLimitedAmt));
					if(i==0){
DEBUGLOG(("GetDetailByCondition:: no record found\n"));
ERRLOG("BOOLPayout::GetPayoutRecords::GetDetailByCondition::no record found!!\n");
						iRet=INT_NOT_RECORD;
						PutField_Int(hContext,"internal_error",iRet);
					}
					break;
				}
			}
			if (GetField_Double(hRec,"payout_amount",&dTmp)) {
				sprintf(csTag,"payout_amount_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetDetailByCondition::payout_amount= [%lf]\n",dTmp));
			}
			if (GetField_Double(hRec,"merchant_fee",&dTmp)) {
				sprintf(csTag,"org_merchant_fee_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetDetailByCondition::merchant_fee= [%lf]\n",dTmp));
			}
			if (GetField_CString(hRec,"bank_name",&csTmp)){
				sprintf(csTag,"bank_name_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
				PutField_CString(hRequest,"bank_name",csTmp);
DEBUGLOG(("GetDetailByCondition::bank_name= [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"bank_code",&csTmp)){
				sprintf(csTag,"bank_code_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetDetailByCondition::bank_code= [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"branch",&csTmp)){
				sprintf(csTag,"branch_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}
			if (GetField_CString(hRec,"account_num",&csTmp)){
				sprintf(csTag,"account_id_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}
			if (GetField_CString(hRec,"account_name",&csTmp)){
				sprintf(csTag,"account_name_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}
			if(GetField_Int(hRec,"status",&iTmp)){
				sprintf(csTag,"status_%d",i);
				PutField_Int(hRequest,csTag,iTmp);
DEBUGLOG(("GetDetailByCondition::status= [%i]\n",iTmp));
			}
			if (GetField_CString(hRec,"batch_id",&csTmp)){
				sprintf(csTag,"batch_id_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}

			hRec = RecordSet_GetNext(rRecordSet);
			i++;
			PutField_Int(hContext,"last_seq",iSeqNum);
			PutField_Int(hContext,"total_cnt",i);
		}
	}
	else{
DEBUGLOG(("GetDetailByCondition:: no record found\n"));
ERRLOG("BOOLPayout::GetPayoutRecords::GetDetailByCondition::no record found!!\n");
		iRet=INT_NOT_RECORD;
		PutField_Int(hContext,"internal_error",iRet);
	}

	FREE_ME(csPspTmp);
	FREE_ME(csTxnCountry);
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	return	iRet;
}



int UpdateDetail(hash_t *hContext,
		hash_t* hRequest)
{
	int     iRet = PD_OK;
	int	iCnt = 0;
	int	i = 0;
	int	iTmp = 0;
	int	iSeqNum = 0;
	int	iIntErr= PD_OK;
	char	*csBatchId;
	char	*csTxnCode;
	char	*csTmp;
	char	cTmp;
	double	dTmp=0.0;
	char	csTag[PD_TAG_LEN +1];
	char    csResp[PD_RESPONSE_CODE_LEN +1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	if (GetField_CString(hRequest,"batch_id",&csBatchId)){
DEBUGLOG(("BOOLPayout::UpdateDetail for batch[%s]\n",csBatchId));
	}
	if (GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hTxn,"update_user",csTmp);
	}
	
	if(GetField_Int(hContext,"approve_id",&iTmp)){
DEBUGLOG(("BOOLPayout::UpdateDetail approve_id[%d]\n",iTmp));
		PutField_Int(hTxn,"approve_id",iTmp);
	}
	
	if(GetField_CString(hRequest,"txn_code",&csTxnCode)){
		if(!strcmp(csTxnCode,PD_PAYOUT_CONFIRM)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_CONFIRMED);
		}
		else if(!strcmp(csTxnCode,PD_PAYOUT_UPLOAD)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_UPLOADED);
		}
		else if(!strcmp(csTxnCode,PD_OL_PAYOUT_APPROVE)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_APPROVED);
			//iRet=GenerateBatchSeq(hRequest);
		}
		else if(!strcmp(csTxnCode,PD_OL_PAYOUT_GENERATE)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
		}
		else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_GENERATED)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_APPROVED);
		}
		else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_APPROVED)){
			if(GetField_CString(hContext,"txn_id",&csTmp)){
				PutField_CString(hTxn,"aux_txn_seq",csTmp);
			}
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_REVERSED);
		}
		else if(!strcmp(csTxnCode,PD_PAYOUT_CANCEL_BEFORE_APPROVED)){
			PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_CANCELLED);
		}
	}

	if(GetField_Char(hRequest,"batch_mode",&cTmp)){
		PutField_Char(hTxn,"batch_mode",cTmp);
	}
	if(GetField_CString(hRequest,"psp_id",&csTmp)){
		PutField_CString(hTxn,"psp_id",csTmp);
	}
	if(GetField_CString(hRequest,"file_id",&csTmp)){
		PutField_CString(hTxn,"file_id",csTmp);
	}
	if(GetField_CString(hRequest,"generated_file_name",&csTmp)){
		PutField_CString(hTxn,"generated_file_name",csTmp);
	}

	GetField_Int(hContext,"total_cnt", &iCnt);
	for(i=0; i<iCnt; i++){
		sprintf(csTag,"batch_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csBatchId)){
DEBUGLOG(("BOOLPayout::UpdateDetail for batch[%s]\n",csBatchId));
		}
		sprintf(csTag,"seq_num_%d",i);
		if(GetField_Int(hRequest,csTag,&iSeqNum)){
DEBUGLOG(("BOOLPayout::UpdateDetail seq_num[%d]\n",iSeqNum));
		}
		else{
DEBUGLOG(("BOOLPayout::UpdateDetail seq_num is missing!!!\n"));
			continue;
		}

		if(strcmp(csTxnCode,PD_OL_PAYOUT_GENERATE)){
			sprintf(csTag,"txn_seq_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
				PutField_CString(hTxn,"txn_seq",csTmp);
			}
		}
		sprintf(csTag,"pregen_psp_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"pregen_psp_id",csTmp);
		}
		sprintf(csTag,"psp_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"psp_id",csTmp);
		}
		sprintf(csTag,"txn_country_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_country",csTmp);
		}
		sprintf(csTag,"payout_amt_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"payout_amt",dTmp);
		}
		if(!strcmp(csTxnCode,PD_OL_PAYOUT_APPROVE)){
			sprintf(csTag,"txn_ccy_%d",i);
			if(GetField_CString(hRequest,csTag,&csTmp)){
				PutField_CString(hTxn,"merchant_fee_ccy",csTmp);
			}
			sprintf(csTag,"dst_txn_ccy_%d",i);
			if(GetField_CString(hRequest,csTag,&csTmp)){
				PutField_CString(hTxn,"member_fee_ccy",csTmp);
			}
		}
		sprintf(csTag,"member_fee_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"member_fee",dTmp);
		}
		sprintf(csTag,"merchant_fee_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"merchant_fee",dTmp);
		}
		sprintf(csTag,"markup_amt_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"markup_amt",dTmp);
		}
		sprintf(csTag,"markup_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"markup_ccy",csTmp);
		}
		sprintf(csTag,"ex_rate_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"ex_rate",dTmp);
		}
		sprintf(csTag,"generated_file_name_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"generated_file_name",csTmp);
		}
		sprintf(csTag,"pregen_file_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"pregen_file_id",csTmp);
		}
		sprintf(csTag,"file_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"file_id",csTmp);
		}
		sprintf(csTag,"batch_mode_%d",i);
		if(GetField_Char(hRequest,csTag,&cTmp)){
			PutField_Char(hTxn,"batch_mode",cTmp);
		}
		sprintf(csTag,"generate_id_%d",i);
		if(GetField_Int(hRequest,csTag,&iTmp)){
			PutField_Int(hTxn,"generate_id",iTmp);
		}
		sprintf(csTag,"identity_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"identity_id",csTmp);
DEBUGLOG(("UpdateDetail::identity_id= [%s]\n",csTmp));
		}
		sprintf(csTag,"pregen_to_bank_code_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"pregen_bank_code",csTmp);
		}

		sprintf(csTag,"int_error_%d",i);
		if(GetField_Int(hRequest,csTag,&iIntErr)){
			sprintf(csResp,"%d",iIntErr);
			PutField_CString(hTxn,"resp_code",csResp);
			if(iIntErr!=PD_OK){
				//PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_DECLINED);
			}
		}

		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","UpdateDetailByBatchId");
		if ((*DBObjPtr)(csBatchId,iSeqNum,hTxn) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLPayout::DBOLMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
		}

	}

DEBUGLOG(("BOOLPayout:UpdateDetail iRet=[%d]\n",iRet));
	FREE_ME(hTxn);
	return  iRet;
}

int InsertGenFileDT(const hash_t* hRequest)
{
	int     iRet = PD_OK;
	int	iCnt = 0;
	int	i = 0;
	int	iTmp = 0;
	char	*csTmp;
	double	dTmp=0.0;
	char	csTag[PD_TAG_LEN +1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	
DEBUGLOG(("BOOLPayout:InsertGenFileDT\n"));
	GetField_Int(hRequest,"total_count", &iCnt);
	for(i=0; i<iCnt; i++){
		sprintf(csTag,"batch_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"batch_id",csTmp);
		}
		sprintf(csTag,"seq_num_%d",i);
		if(GetField_Int(hRequest,csTag,&iTmp)){
			PutField_Int(hTxn,"seq_num",iTmp);
		}
		sprintf(csTag,"txn_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_id",csTmp);
		}
		sprintf(csTag,"file_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"file_id",csTmp);
		}
		sprintf(csTag,"txn_country_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_country",csTmp);
		}
		sprintf(csTag,"request_amount_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"request_amount",dTmp);
		}
		sprintf(csTag,"payout_amount_%d",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hTxn,"payout_amount",dTmp);
		}
		sprintf(csTag,"request_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"request_ccy",csTmp);
		}
		sprintf(csTag,"payout_ccy_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"payout_ccy",csTmp);
		}
		sprintf(csTag,"account_name_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"account_name",csTmp);
		}
		sprintf(csTag,"account_num_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"account_num",csTmp);
		}
		sprintf(csTag,"bank_name_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"bank_name",csTmp);
		}
		sprintf(csTag,"branch_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"branch",csTmp);
		}
		sprintf(csTag,"identity_id_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"identity_id",csTmp);
		}
		sprintf(csTag,"phone_num_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"phone_num",csTmp);
		}
		sprintf(csTag,"merchant_ref_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"merchant_ref",csTmp);
		}
		sprintf(csTag,"province_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"province",csTmp);
		}
		sprintf(csTag,"city_%d",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hTxn,"city",csTmp);
		}

	
		DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileDT","Add");
		if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("InsertGenFileDT::DBOLPayoutGeneratedFileDT:Add Failed\n"));
		}
	}	

	FREE_ME(hTxn);
DEBUGLOG(("BOOLPayout:InsertGenFileDT iRet=[%d]\n",iRet));
	return  iRet;
}

int CheckAvalBalance(hash_t *hContext,
		     const hash_t* hRequest)
{	
	int	iRet = PD_OK;
	double	dTotalSrcNetAmt = 0.0;
	double	dActualPayoutBal = 0.0;
	double	dAvalPayoutBal = 0.0;
	//double	dFundIn = 0.0;

DEBUGLOG(("CheckAvalBalance::Call BOOLBalance:GetAvalPayoutBalance\n"));
	BOObjPtr = CreateObj(BOPtr,"BOOLBalance","GetAvalPayoutBalance");
	if((unsigned long)(*BOObjPtr)(hContext,
				hRequest,
				&dActualPayoutBal,
				&dAvalPayoutBal)==PD_OK){
DEBUGLOG(("CheckAvalBalance::GetAvalBalance for payout=[%f]\n",dActualPayoutBal));
	}
	else{
DEBUGLOG(("CheckAvalBalance::GetAvalPayoutBalance Error\n"));
ERRLOG("BOOLPayout::CheckAvalBalance::GetAvalPayoutBalance Error!!\n");
		iRet = INT_ERR;
	}

	if(iRet==PD_OK){
		if(GetField_Double(hContext,"total_net_amt",&dTotalSrcNetAmt)){
DEBUGLOG(("CheckAvalBalance::Compare Aval Payout Amt[%f] with Request Net Amt[%f]\n",dAvalPayoutBal,dTotalSrcNetAmt));
			if(dAvalPayoutBal<dTotalSrcNetAmt){
				iRet=INT_INSUFFICIENT_FUND;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("CheckAvalBalance::Aval Payout Amt[%f] < Request Net Amt[%f]\n",dAvalPayoutBal,dTotalSrcNetAmt));
ERRLOG("BOOLPayout::CheckAvalBalance::insufficient aval payout balance!!\n");
			}
		}
	}

DEBUGLOG(("CheckAvalBalance::GetAvalPayoutBalance iRet [%d]\n",iRet));
	return  iRet;
}

int GetPayoutFee(hash_t *hContext,
		 hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iIntErr = PD_OK;
	//int	i= 0;
	//int	iCnt= 0;
	double	dTmp= 0.0;
	//double	dTotalSrcNetAmt = 0.0;
	//double	dTotalDstNetAmt = 0.0;
	char	*csTmp;
	char	*csTxnCode;
	char	csTag[PD_TAG_LEN +1];

DEBUGLOG(("BOOLPayout:GetPayoutFee()\n"));
	if(GetField_CString(hContext,"txn_code",&csTxnCode)){
DEBUGLOG(("GetPayoutFee::txn_code [%s]\n",csTxnCode));
	}

	if(GetField_CString(hContext,"txn_seq",&csTmp)){
		PutField_CString(hContext,"from_txn_seq",csTmp);
	}
	if(GetField_Double(hRequest,"txn_amt",&dTmp)){
		PutField_Double(hContext,"txn_amt",dTmp);
		PutField_Double(hContext,"org_txn_amt",dTmp);
	}
	if(GetField_CString(hRequest,"txn_ccy",&csTmp)){
		PutField_CString(hContext,"org_txn_ccy",csTmp);
	}
	if(GetField_CString(hRequest,"dst_txn_ccy",&csTmp)){
		PutField_CString(hContext,"dst_txn_ccy",csTmp);
	}

	if(strcmp(csTxnCode,PD_PAYOUT_VOID_MERCHANT)){
		//Add AddTxnAmtElement
		PutField_CString(hContext,"amount_type",PD_DR);
		BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddTxnAmtElement");
		iRet = (unsigned long)(*BOObjPtr)(hContext);

		if(iRet==PD_OK){
DEBUGLOG(("GetPayoutFee::Call BOExchange:GetExchangeInfo\n"));
			BOObjPtr = CreateObj(DBPtr,"BOExchange","GetExchangeInfo");
			if ((*BOObjPtr)(hContext,hRequest) == PD_OK) {
DEBUGLOG(("GetPayoutFee::GetExternalExchangeInfo Success\n"));
				if(GetField_Double(hContext,"dst_txn_amt",&dTmp)){
DEBUGLOG(("GetPayoutFee::Destination Amount=[%lf]\n",dTmp));
				}
				if(GetField_CString(hContext,"markup_ccy",&csTmp)){
					sprintf(csTag,"markup_ccy");
					PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetPayoutFee::Markup Ccy=[%s]\n",csTmp));
				}
				if(GetField_Double(hContext,"markup_amt",&dTmp)){
					sprintf(csTag,"markup_amt");
					PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::Markup Amount=[%lf]\n",dTmp));
				}
				if(GetField_Double(hContext,"markup_rate",&dTmp)){
DEBUGLOG(("GetPayoutFee::Markup rate=[%lf]\n",dTmp));
				}
				if(GetField_Double(hContext,"ex_rate",&dTmp)){
					sprintf(csTag,"ex_rate");
					PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::Exchange rate=[%lf]\n",dTmp));
				}
			}
			else{
				iIntErr = INT_ERR;
DEBUGLOG(("GetPayoutFee:::GetExchangeInfo Error\n"));
ERRLOG("BOOLPayout:GetPayoutFee::::GetExchangeInfo Error\n");
			}
		}
	}
	//else{
		///for void case , do not doExchange
	//}

	if(iRet==PD_OK){
DEBUGLOG(("GetPayoutFee::Call BOFee:GetTxnFee\n"));
		BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
		if((unsigned long)(*BOObjPtr)(hContext,hRequest)==PD_OK){
			if(GetField_Double(hContext,"src_txn_fee",&dTmp)){
				sprintf(csTag,"merchant_fee");
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::src txn fee=[%f]\n",dTmp));
			}
			if(GetField_Double(hContext,"net_amt",&dTmp)){
				sprintf(csTag,"net_amt");
				PutField_Double(hRequest,csTag,dTmp);
				//dTotalSrcNetAmt += dTmp;
DEBUGLOG(("GetPayoutFee::src net amt=[%f]\n",dTmp));
			}
			if(GetField_Double(hContext,"dst_txn_fee",&dTmp)){
				sprintf(csTag,"member_fee");
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetPayoutFee::dst txn fee=[%f]\n",dTmp));
			}
			if(GetField_Double(hContext,"dst_net_amt",&dTmp)){
				sprintf(csTag,"payout_amt");
				PutField_Double(hRequest,csTag,dTmp);
				//dTotalDstNetAmt += dTmp;

DEBUGLOG(("GetPayoutFee::dst net amt=[%lf]\n",dTmp));
//DEBUGLOG(("GetPayoutFee::total dst net amt for [%s]=[%lf]\n",csTmp,dTotalDstNetAmt));
			}


			//Add TxnFeeElements
			BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddTxnFeeElements");
			iRet = (unsigned long)(*BOObjPtr)(hContext);
			if(iRet!=PD_OK){
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetPayoutFee::GetTxnFee Error\n"));
ERRLOG("BOOLPayout::GetPayoutFee:GetTxnFee Error\n");
			}
		}
		else{
			iIntErr = INT_ERR;
DEBUGLOG(("GetPayoutFee::GetTxnFee Error\n"));
ERRLOG("BOOLPayout::GetPayoutFee:GetTxnFee Error\n");
		}
		sprintf(csTag,"int_error");
		PutField_Int(hRequest,csTag,iIntErr);
	}

	//if(GetField_Double(hRequest,"total_txn_amt",&dTmp)){
	//	PutField_Double(hContext,"txn_amt",dTmp);
	//}
	//PutField_Double(hContext,"net_amt",dTotalSrcNetAmt);	
	//PutField_Double(hContext,"total_net_amt",dTotalSrcNetAmt);	
	//PutField_Double(hContext,"org_net_amt",dTotalSrcNetAmt);	
	//PutField_Double(hContext,"dst_txn_amt",dTotalDstNetAmt);	


DEBUGLOG(("BOOLPayout:GetPayoutFee() iRet=[%d]\n",iRet));
	return 	iRet;
}

int GetPayoutPsp(hash_t *hContext,
                const hash_t* hRequest)
{
	int	iRet = PD_OK;
	hash_t  *hRec;

	char	csTag[PD_TMP_BUF_LEN+1];
	char	*csBankName;
	char	*csPspId;
	char	*csToBankCode;
	char	*csOperType;
	double	dOrgTxnAmt;
	double	dPspAmt=0.0;
	double	dTotalPayoutAmt=0.0;
	double	dTierAmt=0.0;
	double	dPct=0.0;
	double	dMinAmt=0.0;
	double	dMaxAmt=0.0;
	int	iTier = 0;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOOLPayout:GetPayoutPsp()\n"));

 	if (GetField_CString(hContext,"bank_name",&csBankName)) {
DEBUGLOG(("BOOLPayout::GetPayoutPsp() bank_name = [%s]\n",csBankName));
        }
        else {
DEBUGLOG(("BOOLPayout::GetPayoutPsp() bank_name not found!!!\n"));
		iRet = INT_BANK_CODE_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
        }

 	if (GetField_Double(hContext,"txn_amt",&dOrgTxnAmt)) {
DEBUGLOG(("BOOLPayout::GetPayoutPsp() txn_amt = [%lf]\n",dOrgTxnAmt));
        }
        else {
DEBUGLOG(("BOOLPayout::GetPayoutPsp() txn_amt not found!!!\n"));
		iRet = INT_TXN_AMT_MISSING;
		PutField_Int(hContext,"internal_error",iRet);
        }

	if (GetField_CString(hContext,"operator_type",&csOperType)) {
DEBUGLOG(("BOOLPayout:GetPayoutPsp() operator_type = [%s]\n",csOperType));
	}
	if (GetField_CString(hContext,"psp_id",&csPspId)) {
DEBUGLOG(("BOOLPayout:GetPayoutPsp() psp_id = [%s]\n",csPspId));
	}
	if (GetField_CString(hContext,"to_bank_code",&csToBankCode)) {
DEBUGLOG(("BOOLPayout:GetPayoutPsp() to_bank_code = [%s]\n",csToBankCode));
	}
	if (GetField_Double(hContext,"total_amt",&dPspAmt)) {
DEBUGLOG(("BOOLPayout:GetPayoutPsp() total_amt = [%f]\n",dPspAmt));
	}

	sprintf(csTag,"%s_%s_total_payout_amt_%s",csPspId,csToBankCode,csBankName);
 	if (GetField_Double(hContext,csTag,&dTotalPayoutAmt)) {
DEBUGLOG(("BOOLPayout::GetPayoutPsp() org total_payout_amt = [%lf]\n",dTotalPayoutAmt));
        }


	if(iRet == PD_OK){
//RuleOperatorTypeDetail:GetRuleOperatorTypeDetail()
		DBObjPtr = CreateObj(DBPtr,"DBRuleOperatorTypeDetail","GetRuleOperatorTypeDetail");
		if ((unsigned long)(*DBObjPtr)(csOperType, rRecordSet)==PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if (GetField_Double(hRec,"amt_min",&dMinAmt)) {
DEBUGLOG(("BOOLPayout:GetPayoutPsp() amount_min = [%f]\n",dMinAmt));
				}
				if (GetField_Double(hRec,"amt_max",&dMaxAmt)) {
DEBUGLOG(("BOOLPayout:GetPayoutPsp() amount_max = [%f]\n",dMaxAmt));
				}

				if(dOrgTxnAmt>=dMinAmt && dOrgTxnAmt<=dMaxAmt){
					if (GetField_Int(hRec,"tier_id",&iTier)) {
DEBUGLOG(("BOOLPayout:GetPayoutPsp() tier_id = [%d]\n",iTier));
					}
					if (GetField_Double(hRec,"amt_pct",&dPct)) {
DEBUGLOG(("BOOLPayout:GetPayoutPsp() amount_pct = [%lf]\n",dPct));
DEBUGLOG(("BOOLPayout:GetPayoutPsp() amount for tier[%d] = [%lf]\n",iTier,(dPspAmt*dPct/100)));
					}
				}

				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	if(iRet == PD_OK){
//no rules
		if(!strcmp(csOperType,PD_NO_RULE)){
			//do nothing
		}

//Less Than or Daily Limit
		else if(!strcmp(csOperType,PD_LESS_THAN) || !strcmp(csOperType,PD_DAILY_LIMIT)){
			if((dTotalPayoutAmt + dOrgTxnAmt) > dPspAmt){
DEBUGLOG(("BOOLPayout:GetPayoutPsp() Payout Amt[%lf] > Limited PSP Amt[%f]!!!\n",(dTotalPayoutAmt + dOrgTxnAmt),dPspAmt));
//ERRLOG("Payout amount exceeded limited psp amount!!!\n");
				iRet = INT_EXCEED_LIMIT_PSP_AMT;
				PutField_Int(hContext,"internal_error",iRet);
			}
			else{
				sprintf(csTag,"%s_%s_total_payout_amt_%s",csPspId,csToBankCode,csBankName);
				PutField_Double(hContext,csTag,(dTotalPayoutAmt+dOrgTxnAmt));
DEBUGLOG(("BOOLPayout::GetPayoutPsp() %s (org) = [%lf], (new) = [%lf]\n",csTag,dTotalPayoutAmt,(dTotalPayoutAmt+dOrgTxnAmt)));
			}
		}

//customer rules
		else{
			sprintf(csTag,"%s_%s_tier_%d_amt_%s",csPspId,csToBankCode,iTier,csBankName);
 			if (GetField_Double(hContext,csTag,&dTierAmt)) {
        		}
DEBUGLOG(("BOOLPayout::GetPayoutPsp() %s (org) = [%lf], (new) = [%lf]\n",csTag,dTierAmt,(dTierAmt+dOrgTxnAmt)));

			if((dTierAmt+dOrgTxnAmt)>(dPspAmt*dPct/100)){
DEBUGLOG(("BOOLPayout:GetPayoutPsp() Payout Amt[%lf] > Limited PSP Amt[%f]!!!\n",(dTierAmt+dOrgTxnAmt),(dPspAmt*dPct/100)));
//ERRLOG("Payout amount exceeded limited psp amount!!!\n");
				iRet = INT_EXCEED_LIMIT_PSP_AMT;
				PutField_Int(hContext,"internal_error",iRet);
			}
			else{
				PutField_Double(hContext,csTag,(dTierAmt+dOrgTxnAmt));
			}

			
		}
	}

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("BOOLPayout:GetPayoutPsp() exit = [%d]\n",iRet));
	return iRet;
}

//--------------------------

int ProcessPayoutRule(hash_t *hContext,
		  hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iCnt = 0;
	//int	iBank = PD_FALSE;
	double	dTmp=0.0;
	char	csBankName[PD_BANK_NAME_LEN+1];
	char	*csTmp;
	char	*csPspId;
	char	*csOperType;
	char	*csTxnId;
	char	*csToBank;
	char	*csTmpBank;
	char	csTag[PD_TAG_LEN +1];
	char	csTagTwo[PD_TAG_LEN +1];
	hash_t  *hRec;
	hash_t  *hDtl;
	int	iTmp = 0;
	int	i = 0;
	int	iResult = 0;
	int	iAccept = PD_FALSE;
	int	iTier = 0;
	double	dTxnAmt = 0.0;
	double	dPspAmt = 0.0;
	double	dTotalTierAmt = 0.0;
	double	dTotalPayoutAmt = 0.0;
	int	iChk = PD_OK;
	int	iStatus = PD_FALSE;
	char	cTmp;

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	recordset_t     *rDetailSet;
        rDetailSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rDetailSet,0);


DEBUGLOG(("BOOLPayout:ProcessPayoutRule()\n"));

DEBUGLOG(("BOOLPayout::Call DBOLRulePayoutPsp:GetRulePayoutPspWithPriority\n"));
	DBObjPtr = CreateObj(DBPtr,"DBOLRulePayoutPsp","GetRulePayoutPspWithPriority");
	if ((unsigned long)(*DBObjPtr)(rRecordSet) == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec && iChk == PD_OK) {
			hash_destroy(hTxn);
			hash_init(hTxn,0);
			if (GetField_CString(hRec, "bank_name", &csTmp)) {
				strcpy(csBankName,TrimAllChar((const unsigned char*)csTmp,strlen(csTmp),PD_SPACE));
				if(strlen(csBankName)>0){
                                        if(strcmp(csBankName,"*")){
						PutField_CString(hTxn,"bank_name",csBankName);
						PutField_Int(hTxn,"bank_present",PD_TRUE);
DEBUGLOG(("GetRulePayoutPspWithPriority::bank_name = [%s]\n",csBankName));
                                        }
                                        else{
						PutField_Int(hTxn,"bank_present",PD_FALSE);
                                        }
                                }
			}
			if (GetField_CString(hRec, "psp_id", &csPspId)) {
				PutField_CString(hTxn,"psp_id",csPspId);
DEBUGLOG(("GetRulePayoutPspWithPriority::psp_id = [%s]\n",csPspId));
			}
			if (GetField_CString(hRec, "to_bank_code", &csToBank)) {
				PutField_CString(hTxn,"to_bank_code",csToBank);
DEBUGLOG(("GetRulePayoutPspWithPriority::to_bank_code = [%s]\n",csToBank));
			}

			if (GetField_CString(hRec, "psp_ccy", &csTmp)) {
				PutField_CString(hTxn,"payout_ccy",csTmp);
DEBUGLOG(("GetRulePayoutPspWithPriority::psp_ccy = [%s]\n",csTmp));
			}

			if (GetField_Double(hRec, "total_amt", &dPspAmt)) {
				PutField_Double(hTxn,"total_amt",dPspAmt);
DEBUGLOG(("GetRulePayoutPspWithPriority::total_amt = [%lf]\n",dPspAmt));
			}
			if (GetField_CString(hRec, "operator_type", &csOperType)) {
				PutField_CString(hTxn,"operator_type",csOperType);
DEBUGLOG(("GetRulePayoutPspWithPriority::operator_type = [%s]\n",csOperType));

				if(strcmp(csOperType,PD_NO_RULE) && strcmp(csOperType,PD_LESS_THAN) && strcmp(csOperType,PD_DAILY_LIMIT)){
					i = 0;
					double dPct = 0.0;
					hash_t  *hOper;
					recordset_t     *rOperSet;
					rOperSet = (recordset_t*) malloc (sizeof(recordset_t));
					recordset_init(rOperSet,0);
					DBObjPtr = CreateObj(DBPtr,"DBRuleOperatorTypeDetail","GetRuleOperatorTypeDetail");
					if ((unsigned long)(*DBObjPtr)(csOperType, rOperSet)==PD_OK) {
						hOper = RecordSet_GetFirst(rOperSet);
						while(hOper){
							if (GetField_Int(hOper,"tier_id",&iTier)) {
								sprintf(csTag,"tier_id_%d",i);
								PutField_Int(hTxn,csTag,iTier);
DEBUGLOG(("BOOLPayout:GetRuleOperatorTypeDetail() tier_id = [%d]\n",iTier));
							}
							if (GetField_Double(hOper,"amt_min",&dTmp)) {
								sprintf(csTag,"tier_%d_min",iTier);
								PutField_Double(hTxn,csTag,dTmp);
DEBUGLOG(("BOOLPayout:GetRuleOperatorTypeDetail() amount_min = [%f]\n",dTmp));
							}
							if (GetField_Double(hOper,"amt_max",&dTmp)) {
								sprintf(csTag,"tier_%d_max",iTier);
								PutField_Double(hTxn,csTag,dTmp);
DEBUGLOG(("BOOLPayout:GetRuleOperatorTypeDetail() amount_max = [%f]\n",dTmp));
							}

							if (GetField_Double(hOper,"amt_pct",&dPct)) {
DEBUGLOG(("BOOLPayout:GetRuleOperatorTypeDetail() amount_pct = [%lf]\n",dPct));
								sprintf(csTag,"tier_%d_pct_amt",iTier);
								PutField_Double(hTxn,csTag,(dPspAmt*dPct/100));
DEBUGLOG(("BOOLPayout:GetRuleOperatorTypeDetail() amount for tier[%d] = [%lf]\n",iTier,(dPspAmt*dPct/100)));
							}
							i++;
							PutField_Int(hTxn,"num_of_tier",i);
							hOper = RecordSet_GetNext(rOperSet);
						}
					}
					else{
						iChk = PD_ERR;
					}
					RecordSet_Destroy(rOperSet);
					FREE_ME(rOperSet);
				}
			}

			if(GetField_Int(hContext,"pregen_id",&iTmp)){
				PutField_Int(hTxn,"pregen_id",iTmp);
			}
			if(GetField_CString(hContext,"batch_list",&csTmp)){
				PutField_CString(hTxn,"batch_list",csTmp);
			}
			if(GetField_CString(hRequest,"merchant_id",&csTmp)){
				PutField_CString(hTxn,"merchant_id",csTmp);
			}
			if(GetField_Char(hContext,"psp_group",&cTmp)){
				PutField_Char(hTxn,"psp_group",cTmp);
			}
			dTotalPayoutAmt = 0.0;
			dTotalTierAmt = 0.0;
			recordset_init(rDetailSet,0);

			hash_t  *hGenTmp;
			hGenTmp = (hash_t*) malloc (sizeof(hash_t));

			//get approved transaction by the above rule
DEBUGLOG(("ProcessPayoutRule::Call DBOLMerchantUploadFileDetail:GetRecordByRandomWithPara\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","GetRecordByRandomWithPara");
			iResult = (unsigned long)(*DBObjPtr)(hTxn,rDetailSet);
			if(iResult == PD_OK){
				hDtl = RecordSet_GetFirst(rDetailSet);
				while(hDtl && iChk == PD_OK){
					iAccept = PD_FALSE;
					hash_init(hGenTmp,0);
					if(GetField_CString(hDtl,"txn_seq",&csTxnId)){
						PutField_CString(hGenTmp,"txn_id",csTxnId);
DEBUGLOG(("GetRecordByRandomWithPara::txn_id = [%s]\n",csTxnId));
					}
					if(GetField_Double(hDtl,"payout_amount",&dTxnAmt)){
DEBUGLOG(("GetRecordByRandomWithPara::payout_amount = [%lf]\n",dTxnAmt));
					}

					//no rules
					if(!strcmp(csOperType,PD_NO_RULE)){
						iAccept = PD_TRUE;
					}
					//Less Than or Daily Limit
					else if(!strcmp(csOperType,PD_LESS_THAN) || !strcmp(csOperType,PD_DAILY_LIMIT)){
						if(((dTotalPayoutAmt + dTxnAmt) > dPspAmt)  && (dPspAmt>0.0)){
DEBUGLOG(("BOOLPayout:GetRecordByRandomWithPara() Payout Amt[%lf] > Limited PSP Amt[%f]!!!\n",(dTotalPayoutAmt + dTxnAmt),dPspAmt));

						}
						else{
							iAccept = PD_TRUE;
							dTotalPayoutAmt = dTotalPayoutAmt + dTxnAmt;
						}
					}
					//customer rules
					else{
						int iTierCnt = 0;
						double dMinAmt= 0.0;
						double dMaxAmt= 0.0;
						double dPctAmt= 0.0;
						GetField_Int(hTxn,"num_of_tier",&iTierCnt);
						for(i=0; i<iTierCnt; i++){
							dMinAmt = 0.0;
							dMaxAmt = 0.0;
							dPctAmt= 0.0;
							sprintf(csTag,"tier_id_%d",i);
							if(GetField_Int(hTxn,csTag,&iTier)){
								sprintf(csTag,"tier_%d_min",iTier);
								GetField_Double(hTxn,csTag,&dMinAmt);
								sprintf(csTag,"tier_%d_max",iTier);
								GetField_Double(hTxn,csTag,&dMaxAmt);
								if(dTxnAmt>=dMinAmt && dTxnAmt<=dMaxAmt){
									sprintf(csTag,"tier_%d_pct_amt",iTier);
									GetField_Double(hTxn,csTag,&dPctAmt);
									break;
								}
							}
						}

						if((dTotalTierAmt+dTxnAmt)>dPctAmt){
DEBUGLOG(("BOOLPayout:GetRecordByRandomWithPara () Payout Amt[%lf] > Limited PSP Amt[%f]!!!\n",(dTotalTierAmt+dTxnAmt),dPctAmt));
						}
						else{
							iAccept = PD_TRUE;
							dTotalTierAmt = dTotalTierAmt + dTxnAmt;
						}
					}
					
					if(iAccept){
						iStatus = PD_FALSE;
						sprintf(csTag,"%s_pending",csTxnId);
						GetField_Int(hContext,csTag,&iStatus);
						if(iStatus){
							PutField_Int(hContext,csTag,PD_FALSE);

							sprintf(csTag,"%s_psp",csTxnId);
							sprintf(csTagTwo,"%s_to_bank",csTxnId);
							if(GetField_CString(hContext,csTag,&csTmp) &&
							   GetField_CString(hContext,csTagTwo,&csTmpBank)
							){
								sprintf(csTag,"%s_%s_pending_cnt",csTmp,csTmpBank);
								iCnt = 0;
								GetField_Int(hContext,csTag,&iCnt);
								PutField_Int(hContext,csTag,iCnt-1);

								sprintf(csTag,"%s_%s_pending_amt",csTmp,csTmpBank);
								dTmp = 0;
								GetField_Double(hContext,csTag,&dTmp);
								PutField_Double(hContext,csTag,dTmp-dTxnAmt);
							}
						}

						if(GetField_CString(hTxn,"psp_id",&csPspId) &&
						   GetField_CString(hTxn,"to_bank_code",&csToBank)
						){
							PutField_CString(hGenTmp,"psp_id",csPspId);
							PutField_CString(hGenTmp,"bank_code",csToBank);

							sprintf(csTag,"%s_%s_accept_cnt",csPspId,csToBank);
							iCnt = 0;
							GetField_Int(hContext,csTag,&iCnt);
							PutField_Int(hContext,csTag,iCnt+1);

							sprintf(csTag,"%s_%s_accept_amt",csPspId,csToBank);
							dTmp = 0;
							GetField_Double(hContext,csTag,&dTmp);
							PutField_Double(hContext,csTag,dTmp+dTxnAmt);
						}

						if(GetField_Int(hContext,"pregen_id",&iTmp)){
							PutField_Int(hGenTmp,"gen_id",iTmp);
						}
						if(GetField_CString(hRequest,"add_user",&csTmp)){
							PutField_CString(hGenTmp,"add_user",csTmp);
						}

						//insert to payout_generated_tmp
						DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedTmp","Add");
						if((unsigned long)(*DBObjPtr)(hGenTmp)!=PD_OK){
DEBUGLOG(("ProcessPayoutRule::DBOLPayoutGeneratedTmp::Add Error!!!\n"));
ERRLOG("BOOLPayout:ProcessPayoutRule::DBOLPayoutGeneratedTmp::Add Error!!!\n");
							iChk= PD_ERR;
						}
					}
					else{
						iStatus = PD_FALSE;
						sprintf(csTag,"%s_pending",csTxnId);
						GetField_Int(hContext,csTag,&iStatus);
						if(!iStatus){
							PutField_Int(hContext,csTag,PD_TRUE);

							sprintf(csTag,"%s_psp",csTxnId);
							PutField_CString(hContext,csTag,csPspId);
							sprintf(csTag,"%s_to_bank",csTxnId);
							PutField_CString(hContext,csTag,csToBank);

							sprintf(csTag,"%s_%s_pending_cnt",csPspId,csToBank);
							iCnt = 0;
							GetField_Int(hContext,csTag,&iCnt);
							PutField_Int(hContext,csTag,iCnt+1);

							sprintf(csTag,"%s_%s_pending_amt",csPspId,csToBank);
							dTmp = 0;
							GetField_Double(hContext,csTag,&dTmp);
							PutField_Double(hContext,csTag,dTmp+dTxnAmt);
						}
					}
					hDtl = RecordSet_GetNext(rDetailSet);
				}
			}
			FREE_ME(hGenTmp);

			RecordSet_Destroy(rDetailSet);

			hRec = RecordSet_GetNext(rRecordSet);
		}
	}
	else{
DEBUGLOG(("GetRulePayoutPspWithPriority::not found record!!\n"));
ERRLOG("BOOLPayout::ProcessPayoutRule:GetRulePayoutPspWithPriority::not found record!!\n");
		iRet=INT_NO_PAYOUT_MATCH_RULE;
		PutField_Int(hContext,"internal_error",iRet);
	}

	if(iChk!=PD_OK){
		iRet=INT_ERR;
		PutField_Int(hContext,"internal_error",iRet);
	}

	FREE_ME(hTxn);
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	RecordSet_Destroy(rDetailSet);
	FREE_ME(rDetailSet);
DEBUGLOG(("BOOLPayout:ProcessPayoutRule() iRet=[%d]\n",iRet));
	return iRet;
}


int ProcessOnlinePayout(hash_t *hContext,
		  hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iCnt = 0;
	double	dTmp=0.0;
	char	*csTmp;
	char	*csPspId;
	char	*csTxnId;
	char	*csBatchId;
	char	*csMerchantId;
	char	*csServiceCode;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;
	hash_t  *hDtl;
	int	iTmp = 0;
	int	i = 0;
	int	iResult = 0;
	int	iAccept = PD_FALSE;
	//int	iTier = 0;
	double	dTxnAmt = 0.0;
	//double	dPspAmt = 0.0;
	double	dTotalPayoutAmt = 0.0;
	int	iChk = PD_OK;
	//int	iStatus = PD_FALSE;
	unsigned long lBatchId = 0l;
	char    csNewList[PD_TMP_MSG_BUF_LEN+1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

	hash_t  *hPsp;
        hPsp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hPsp,0);

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	recordset_t     *rDetailSet;
        rDetailSet = (recordset_t*) malloc (sizeof(recordset_t));


DEBUGLOG(("BOOLPayout:ProcessOnlinePayout()\n"));

	if(GetField_Int(hContext,"pregen_id",&iTmp)){
		PutField_Int(hTxn,"pregen_id",iTmp);
	}
	if(GetField_CString(hContext,"batch_list",&csTmp)){
		PutField_CString(hTxn,"batch_list",csTmp);
	}
	if(GetField_CString(hRequest,"merchant_id",&csMerchantId)){
		PutField_CString(hTxn,"merchant_id",csMerchantId);
	}

	PutField_Char(hTxn,"batch_mode",PD_ONLINE);
	PutField_Int(hTxn,"bank_present",PD_FALSE);


	//get service from batch id/list
	int iPspCnt = 0;
	char*   csPrePsp=strdup(""); 
	char*   csPspTmp;
	
	GetField_Int(hContext, "total_cnt", &iCnt);//total batch count
DEBUGLOG(("BOOLPayout:ProcessOnlinePayout() total batch count = [%d]\n",iCnt));
	for (i = 0; i < iCnt; i++) {
		csNewList[0] ='\0';
		sprintf(csTag, "batch_id_%d",i);
		if(GetField_CString(hContext,csTag,&csBatchId)){
			lBatchId = ctol((const unsigned char *)csBatchId,strlen(csBatchId));

			recordset_init(rRecordSet,0);
			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","GetHeader");
			if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if(GetField_CString(hRec,"service_code",&csServiceCode)){
DEBUGLOG(("BOOLPayout:ProcessOnlinePayout() Find PSP by [%s][%s]\n",csMerchantId,csServiceCode));
						//get psp_id+payout_ccy from merchant+service
						csPrePsp[0]='\0';
						hash_init(hPsp,0);
						DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","FindPspInfo");
						if ((unsigned long)(DBObjPtr)(csMerchantId,csServiceCode,hPsp) == PD_FOUND) {
							if(GetField_CString(hPsp,"psp_id",&csPspTmp)){
								if(strcmp(csPspTmp,csPrePsp)){
									sprintf(csPrePsp,"%s",csPspTmp);
									sprintf(csTag,"psp_id_%d",iPspCnt);
									PutField_CString(hContext,csTag,csPspTmp);
DEBUGLOG(("BOOLPayout:ProcessOnlinePayout() PSP Found[%d][%s]\n",iPspCnt,csPspTmp));
									iPspCnt++;
								}
								sprintf(csTag,"%s_batch_list",csPspTmp);
								if(GetField_CString(hContext,csTag,&csTmp)){
									strcat(csNewList,csTmp);
									strcat(csNewList,",");
								}
								strcat(csNewList,csBatchId);
								PutField_CString(hContext,csTag,csNewList);

								if(GetField_CString(hPsp,"psp_ccy",&csTmp)){
									sprintf(csTag,"%s_psp_ccy",csPspTmp);
									PutField_CString(hContext,csTag,csTmp);
//DEBUGLOG(("BOOLPayout:ProcessOnlinePayout() PSP Found[%d][%s]\n",iPspCnt,csTmp));
								}
							}
						}
					}
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
		}
	}
	FREE_ME(csPrePsp);
	
	if(iRet==PD_OK){
		for(i=0; i<iPspCnt; i++){
			sprintf(csTag,"psp_id_%d",i);
			if(GetField_CString(hContext,csTag,&csPspId)){
				PutField_CString(hTxn,"psp_id",csPspId);

				sprintf(csTag,"%s_psp_ccy",csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hTxn,"payout_ccy",csTmp);
				}
			}

			dTotalPayoutAmt = 0.0;
			recordset_init(rDetailSet,0);

			hash_t  *hGenTmp;
			hGenTmp = (hash_t*) malloc (sizeof(hash_t));

			//get approved transactions
DEBUGLOG(("ProcessOnlinePayout::Call DBOLMerchantUploadFileDetail:GetRecordByRandomWithPara[%s][%s][%s]\n",csMerchantId,csPspId,csTmp));
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","GetRecordByRandomWithPara");
			iResult = (unsigned long)(*DBObjPtr)(hTxn,rDetailSet);
			if(iResult == PD_OK){
				hDtl = RecordSet_GetFirst(rDetailSet);
				while(hDtl && iChk == PD_OK){
					iAccept = PD_FALSE;
					hash_init(hGenTmp,0);
					if(GetField_CString(hDtl,"txn_seq",&csTxnId)){
						PutField_CString(hGenTmp,"txn_id",csTxnId);
DEBUGLOG(("GetRecordByRandomWithPara::txn_id = [%s]\n",csTxnId));
					}
					if(GetField_Double(hDtl,"payout_amount",&dTxnAmt)){
DEBUGLOG(("GetRecordByRandomWithPara::payout_amount = [%lf]\n",dTxnAmt));
					}

					iAccept = PD_TRUE;
					dTotalPayoutAmt = dTotalPayoutAmt + dTxnAmt;
					
					if(iAccept){
						if(GetField_CString(hTxn,"psp_id",&csPspId)){
							PutField_CString(hGenTmp,"psp_id",csPspId);

							sprintf(csTag,"%s_accept_cnt",csPspId);
							iCnt = 0;
							GetField_Int(hContext,csTag,&iCnt);
							PutField_Int(hContext,csTag,iCnt+1);

							sprintf(csTag,"%s_accept_amt",csPspId);
							dTmp = 0;
							GetField_Double(hContext,csTag,&dTmp);
							PutField_Double(hContext,csTag,dTmp+dTxnAmt);
						}

						if(GetField_Int(hContext,"pregen_id",&iTmp)){
							PutField_Int(hGenTmp,"gen_id",iTmp);
						}
						if(GetField_CString(hRequest,"add_user",&csTmp)){
							PutField_CString(hGenTmp,"add_user",csTmp);
						}

						//insert to payout_generated_tmp
						DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedTmp","Add");
						if((unsigned long)(*DBObjPtr)(hGenTmp)!=PD_OK){
DEBUGLOG(("ProcessOnlinePayout::DBOLPayoutGeneratedTmp::Add Error!!!\n"));
ERRLOG("BOOLPayout:ProcessOnlinePayout::DBOLPayoutGeneratedTmp::Add Error!!!\n");
							iChk= PD_ERR;
						}
					}
					hDtl = RecordSet_GetNext(rDetailSet);
				}
			}
			FREE_ME(hGenTmp);
		}
	}

	if(iChk!=PD_OK || iPspCnt == 0){
		iRet=INT_ERR;
		PutField_Int(hContext,"internal_error",iRet);
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	RecordSet_Destroy(rDetailSet);
	FREE_ME(rDetailSet);
	FREE_ME(hTxn);
	FREE_ME(hPsp);
DEBUGLOG(("BOOLPayout:ProcessOnlinePayout() iRet=[%d]\n",iRet));
	return iRet;
}



//--------------------------

int GetPayoutRule(hash_t *hContext,
		  hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iCnt = 0;
	int	iBank = PD_FALSE;
	double	dTmp=0.0;
	char	csBankName[PD_BANK_NAME_LEN+1];
	char	*csTmp;
	char	*csPspId;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOOLPayout:GetPayoutRule()\n"));
DEBUGLOG(("BOOLPayout::Call DBOLRulePayoutPsp:GetRulePayoutPspWithPriority\n"));
	DBObjPtr = CreateObj(DBPtr,"DBOLRulePayoutPsp","GetRulePayoutPspWithPriority");
	if ((unsigned long)(*DBObjPtr)(rRecordSet) == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		iCnt = 0;
		while (hRec) {
			iBank=PD_FALSE;
			if (GetField_CString(hRec, "bank_name", &csTmp)) {
				strcpy(csBankName,TrimAllChar((const unsigned char*)csTmp,strlen(csTmp),PD_SPACE));
				if(strlen(csBankName)>0){
                                        //PutField_CString(hContext,"bank_name",csBankName);
                                        if(strcmp(csBankName,"*")){
                                                sprintf(csTag,"bank%d_bank_name",iCnt);
                                                PutField_CString(hRequest,csTag,csBankName);
                                                iBank=PD_TRUE;
DEBUGLOG(("GetRulePayoutPspWithPriority::bank_name = [%s]\n",csBankName));
                                        }
                                        else{
                                                sprintf(csTag,"bank%d_bank_name",iCnt);
                                                PutField_CString(hRequest,csTag,"ALL_BANK");
DEBUGLOG(("GetRulePayoutPspWithPriority::All Bank\n"));
                                        }
                                }
			}
			if (GetField_CString(hRec, "psp_id", &csPspId)) {
				sprintf(csTag,"bank%d_psp_id",iCnt);
				PutField_CString(hRequest,csTag,csPspId);
//DEBUGLOG(("GetRulePayoutPspWithPriority::psp_id = [%s]\n",csPspId));

        			hash_init(hTxn,0);
				dTmp = 0.0;
				DBObjPtr = CreateObj(DBPtr,"DBOLPspDetail","GetPspPayoutSplitAmt");
				if ((*DBObjPtr)(csPspId,hTxn) == PD_OK) {
					if (GetField_Double(hTxn,"payout_split_limit",&dTmp)) {
DEBUGLOG(("BOOLPayout: GetPspPayoutSplitAmt - split amount= [%lf]\n",dTmp));
					}
					else{
DEBUGLOG(("BOOLPayout: GetPspPayoutSplitAmt - no split amount found\n"));
					}
				}
				sprintf(csTag,"%s_split_amt",csPspId);
				PutField_Double(hContext,csTag,dTmp);
			}
			if (GetField_CString(hRec, "to_bank_code", &csTmp)) {
				sprintf(csTag,"bank%d_to_bank_code",iCnt);
				PutField_CString(hRequest,csTag,csTmp);
//DEBUGLOG(("GetRulePayoutPspWithPriority::to_bank_code = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "operator_type", &csTmp)) {
				sprintf(csTag,"bank%d_operator_type",iCnt);
				PutField_CString(hRequest,csTag,csTmp);
				//PutField_CString(hContext,"operator_type",csTmp);
//DEBUGLOG(("GetRulePayoutPspWithPriority::operator_type = [%s]\n",csTmp));
			}
			if (GetField_Double(hRec, "total_amt", &dTmp)) {
				sprintf(csTag,"bank%d_total_amt",iCnt);
				PutField_Double(hRequest,csTag,dTmp);
				//PutField_Double(hContext,"total_amt",dTmp);
//DEBUGLOG(("GetRulePayoutPspWithPriority::total_amt = [%lf]\n",dTmp));
			}
			sprintf(csTag,"bank%d_present",iCnt);
			PutField_Int(hRequest,csTag,iBank);

			iCnt++;
			hRec = RecordSet_GetNext(rRecordSet);

			PutField_Int(hRequest,"bank_cnt",iCnt);
		}
	}
	else{
DEBUGLOG(("GetRulePayoutPspWithPriority::not found record!!\n"));
ERRLOG("BOOLPayout::GetPayoutRule:GetRulePayoutPspWithPriority::not found record!!\n");
		iRet=INT_NO_PAYOUT_MATCH_RULE;
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);
DEBUGLOG(("BOOLPayout:GetPayoutPsp() iRet=[%d]\n",iRet));
	return iRet;
}



int AssignPsp(hash_t *hContext,
	      hash_t* hRequest,
	      hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iCnt = 0;
	int	i = 0;
	int	iTotal = 0;
	int	iTmp = 0;
	int	iFailedCnt = 0;
	int	iResult = 0;
	int	iSeqNum = 0;
	int	iBank = PD_FALSE;
	int	iMerch = PD_FALSE;
	int	iResCnt = 0;
	int	iStatus = PD_FALSE;
	double	dResAmt = 0.0;
	double	dTmp=0.0;
	double	dTxnAmt=0.0;
	char	*csTmp;
	char	*csMerchantId;
	char	*csBatchId;
	char	*csBankName;
	char	*csPspId;
	char	*csPspCcy;
	char	*csCountry;
	char	cGrp;
	char	csTag[PD_TAG_LEN +1];
	char	*csToBankCode;
	hash_t  *hRec, *hTxn, *hDetail;
	int	iBatchCnt = 0;
	char	*csTmpPsp;
	char	*csTmpBankCode;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	
        hDetail = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hDetail,0);
DEBUGLOG(("BOOLPayout:AssignPsp()\n"));

	GetField_Int(hRequest,"bank_cnt",&iCnt);
	GetField_Int(hRequest,"mid_present",&iMerch);
	if(iMerch==PD_TRUE){
		GetField_CString(hRequest,"merchant_id",&csMerchantId);
		PutField_CString(hDetail,"merchant_id",csMerchantId);
DEBUGLOG(("Authorize:: merchant_id = [%s]\n",csMerchantId));
	}

	if(GetField_Char(hContext,"psp_group",&cGrp)){
		PutField_Char(hDetail,"psp_group",cGrp);
DEBUGLOG(("Authorize:: psp_group = [%c]\n",cGrp));
	}

	if (GetField_Int(hContext, "total_batch_cnt", &iBatchCnt)) {
		PutField_Int(hDetail,"batch_cnt",iBatchCnt);
DEBUGLOG(("Authorize::total_batch_cnt = [%d]\n", iBatchCnt));
	}
	for(i=0; i<iBatchCnt;i++){
		sprintf(csTag,"batch_id_%d",i);
		if (GetField_CString(hContext, csTag, &csTmp)) {
DEBUGLOG(("Authorize::() [%s] = [%s]\n", csTag, csTmp));
			PutField_CString(hDetail,csTag,csTmp);
		}
	}

	for(i=0; i<iCnt;i++){
        	recordset_init(rRecordSet,0);
		RemoveField_CString(hDetail,"bank_name");

		sprintf(csTag,"bank%d_present",i);
		GetField_Int(hRequest,csTag,&iBank);
		//if(iBank==PD_TRUE){
			sprintf(csTag,"bank%d_bank_name",i);
			if(GetField_CString(hRequest,csTag,&csBankName)){
				PutField_CString(hContext,"bank_name",csBankName);
				if(iBank==PD_TRUE)
					PutField_CString(hDetail,"bank_name",csBankName);
			}
		//}
		sprintf(csTag,"bank%d_psp_id",i);
		if(GetField_CString(hRequest,csTag,&csPspId)){
			PutField_CString(hContext,"psp_id",csPspId);
DEBUGLOG(("AssignPsp::psp_id = [%s]\n",csPspId));
		}

		sprintf(csTag,"bank%d_to_bank_code",i);
		if(GetField_CString(hRequest,csTag,&csToBankCode)){
			PutField_CString(hContext,"to_bank_code",csToBankCode);
DEBUGLOG(("AssignPsp::to_bank_code = [%s]\n",csToBankCode));
		}

		/*
		hash_t* hTmpRec;
		recordset_t *rTmpSet;
		rTmpSet = (recordset_t*) malloc (sizeof(recordset_t));
		recordset_init(rTmpSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBPspCountry","GetPspCountry");
		if((unsigned long) ((*DBObjPtr)(csPspId,rTmpSet))==PD_OK){
			hTmpRec = RecordSet_GetFirst(rTmpSet);
			while(hTmpRec){
				if (GetField_CString(hTmpRec,"ccy_id",&csTmp)) {
					sprintf(csTag,"%s_support_ccy_id",csPspId);
					PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("AssignPsp::psp_id support ccy = [%s]\n",csTmp));
				}
				hTmpRec = RecordSet_GetNext(rTmpSet);
			}
		}
		RecordSet_Destroy(rTmpSet);
		FREE_ME(rTmpSet);
		*/

		sprintf(csTag,"bank%d_operator_type",i);
		if(GetField_CString(hRequest,csTag,&csTmp)){
			PutField_CString(hContext,"operator_type",csTmp);
DEBUGLOG(("AssignPsp::operator_type = [%s]\n",csTmp));
		}
		sprintf(csTag,"bank%d_total_amt",i);
		if(GetField_Double(hRequest,csTag,&dTmp)){
			PutField_Double(hContext,"total_amt",dTmp);
DEBUGLOG(("AssignPsp::total_amt = [%lf]\n",dTmp));
		}

DEBUGLOG(("AssignPsp::Call DBOLMerchantUploadFileDetail:GetDetailByRandomWithPara\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","GetDetailByRandomWithPara");
		iResult = (unsigned long)(*DBObjPtr)(hDetail,rRecordSet);

		if(iResult == PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			iTmp = 0;
			iFailedCnt = 0;
			while(hRec){
				if(GetField_CString(hRec,"batch_id",&csBatchId)){
					sprintf(csTag,"batch_id_%d",iTmp);
					PutField_CString(hTxn,csTag,csBatchId);
DEBUGLOG(("GetDetail::batch_id = [%s]\n",csBatchId));
				}
				if(GetField_Int(hRec,"seq_num",&iSeqNum)){
					sprintf(csTag,"seq_num_%d",iTmp);
					PutField_Int(hTxn,csTag,iSeqNum);
DEBUGLOG(("GetDetail::seq_num = [%d]\n",iSeqNum));
				}
				if(GetField_CString(hRec,"bank_name",&csTmp)){
					//if(iBank!=PD_TRUE){
					//	PutField_CString(hContext,"bank_name",csTmp);
DEBUGLOG(("GetDetail::bank_name = [%s]\n",csTmp));
					//}
				}
				if(GetField_CString(hRec,"txn_country",&csCountry)){
DEBUGLOG(("GetDetail::txn_country = [%s]\n",csCountry));
				}
				if(GetField_CString(hRec,"payout_ccy",&csPspCcy)){
DEBUGLOG(("GetDetail::payout_ccy = [%s]\n",csPspCcy));
				}
				if (GetField_Double(hRec, "payout_amount", &dTxnAmt)) {
					PutField_Double(hContext,"txn_amt",dTxnAmt);
DEBUGLOG(("GetDetail::txn_amt = [%lf]\n",dTxnAmt));
				}

DEBUGLOG(("AssignPsp::Call GetPayoutPsp\n"));
				iResCnt = 0;
				dResAmt = 0.0;
				sprintf(csTag,"pregen_psp_id_%d",iTmp);
				if((unsigned long)GetPayoutPsp(hContext,hRequest)==PD_OK){
					PutField_CString(hTxn,csTag,csPspId);

					sprintf(csTag,"pregen_to_bank_code_%d",iTmp);
					PutField_CString(hTxn,csTag,csToBankCode);

					sprintf(csTag,"%s_%s_payout_country",csPspId,csToBankCode);
					PutField_CString(hContext,csTag,csCountry);

					sprintf(csTag,"%s_%s_payout_ccy",csPspId,csToBankCode);
					PutField_CString(hContext,csTag,csPspCcy);

					/*sprintf(csTag,"%s_support_ccy_id",csPspId);
					if(GetField_CString(hContext,csTag,&csTmp)){
						if(strcmp(csPspCcy,csTmp)){
							iTmp = 0;
							iRet = INT_CURRENCY_ID_NOT_MATCH;
							PutField_Int(hContext,"internal_error",iRet);
							break;
						}
					}*/

					sprintf(csTag,"%s_%s_accept_cnt",csPspId,csToBankCode);
					GetField_Int(hContext,csTag,&iResCnt);
					iResCnt ++;
					PutField_Int(hContext,csTag,iResCnt);

					sprintf(csTag,"%s_%s_accept_amt",csPspId,csToBankCode);
					GetField_Double(hContext,csTag,&dResAmt);
					dResAmt += dTxnAmt;
					PutField_Double(hContext,csTag,dResAmt);

//check if the record was failed in the previous rule, update the pending count
					sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
					if(GetField_Int(hContext,csTag,&iStatus)){
						if(iStatus==PD_TRUE){
							iResCnt=0;
							dResAmt=0.0;
							sprintf(csTag,"%s%d_psp",csBatchId,iSeqNum);
							if(GetField_CString(hContext,csTag,&csTmpPsp)){
								sprintf(csTag,"%s%d_to_bank_code",csBatchId,iSeqNum);
								if(GetField_CString(hContext,csTag,&csTmpBankCode)){
									sprintf(csTag,"%s_%s_pending_cnt",csTmpPsp,csTmpBankCode);
									GetField_Int(hContext,csTag,&iResCnt);
									iResCnt --;
									PutField_Int(hContext,csTag,iResCnt);

									sprintf(csTag,"%s_%s_pending_amt",csTmpPsp,csTmpBankCode);
									GetField_Double(hContext,csTag,&dResAmt);
									dResAmt -= dTxnAmt;
									PutField_Double(hContext,csTag,dResAmt);
								}
							}
						}
					}
DEBUGLOG(("AssignPsp::Call GetPayoutPsp Success\n"));
				}
				else{
					PutField_CString(hTxn,csTag,"");

//check if the record was failed in the previous rule, not to update the pending count.
					sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
					if(!GetField_Int(hContext,csTag,&iStatus)){
						sprintf(csTag,"%s_%s_pending_cnt",csPspId,csToBankCode);
						GetField_Int(hContext,csTag,&iResCnt);
						iResCnt ++;
						PutField_Int(hContext,csTag,iResCnt);

						sprintf(csTag,"%s_%s_pending_amt",csPspId,csToBankCode);
						GetField_Double(hContext,csTag,&dResAmt);
						dResAmt += dTxnAmt;
						PutField_Double(hContext,csTag,dResAmt);

						sprintf(csTag,"%s%d_pending",csBatchId,iSeqNum);
						PutField_Int(hContext,csTag,PD_TRUE);
						sprintf(csTag,"%s%d_psp",csBatchId,iSeqNum);
						PutField_CString(hContext,csTag,csPspId);
						sprintf(csTag,"%s%d_to_bank_code",csBatchId,iSeqNum);
						PutField_CString(hContext,csTag,csToBankCode);
					}

					iFailedCnt ++;
DEBUGLOG(("AssignPsp::Call GetPayoutPsp Failed\n"));
				}

				hRec = RecordSet_GetNext(rRecordSet);
				iTmp++;
				iTotal++;
				PutField_Int(hTxn,"total_count",iTmp);
				PutField_Int(hContext,"total_cnt",iTmp);
			}

			if(iTmp>iFailedCnt){
				if((unsigned long)UpdateDetail(hContext,hTxn)==PD_OK){
DEBUGLOG(("AssignPsp::Update Detail Success\n"));
				}
			}
		}

	}//end for loop

	if(iTotal==iFailedCnt && iRet == PD_OK){
DEBUGLOG(("AssignPsp::No Pending record\n"));
		PutField_Int(hContext,"total_cnt",0);
                PutField_Int(hResponse,"total_cnt",iTotal);
                //iRet = INT_NO_PENDING_RECORD;
                iRet = INT_NO_PAYOUT_MATCH_RULE;
        }

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);

DEBUGLOG(("BOOLPayout:AssignPsp() iRet=[%d]\n",iRet));
	return iRet;
}

//------

int FormatResponse(const hash_t *hContext,
                   hash_t* hResponse)
{
        int     iRet = PD_OK;
        int     i = 1;
        int     iCnt = 0;
        int     iAcceptCnt,iPendingCnt;
        double  dAcceptAmt,dPendingAmt,dAvalBal;
        //char    *csTmp;
        char    *csPspId;
        char    *csBankCode;
        char    *csCcy;
        char    csTag[PD_TAG_LEN +1];
        char    csTagTwo[PD_TAG_LEN +1];

DEBUGLOG(("BOOLPayout:FormatResponse()\n"));

        GetField_Int(hResponse,"total_cnt",&iCnt);
DEBUGLOG(("BOOLPayout:FormatResponse:: total_cnt = [%d]\n", iCnt));
        hash_t* hPspDetail;
        hPspDetail = (hash_t*) malloc (sizeof(hash_t));

        for(i=0; i<iCnt; i++){
                iAcceptCnt = 0;
                iPendingCnt = 0;
                dAcceptAmt = 0.0;
                dPendingAmt = 0.0;

                sprintf(csTag,"psp_id_%d",i);
                sprintf(csTagTwo,"bank_code_%d",i);
                if(GetField_CString(hContext,csTag,&csPspId) &&
		   GetField_CString(hContext,csTagTwo,&csBankCode)
		){
                        sprintf(csTag,"psp_id_%d",i+1);
                        PutField_CString(hResponse,csTag,csPspId);
DEBUGLOG(("BOOLPayout:FormatResponse:: psp_id = [%d][%s]\n", i, csPspId));
                        sprintf(csTag,"bank_%d",i+1);
                        PutField_CString(hResponse,csTag,csBankCode);
DEBUGLOG(("BOOLPayout:FormatResponse:: bank_id = [%d][%s]\n", i, csBankCode));
/*
                        hash_init(hPspDetail,0);
                        DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
                        if ((*DBObjPtr)(csPspId,hPspDetail) == PD_OK) {
                                if (GetField_CString(hPspDetail,"psp_name",&csTmp)) {
                                        sprintf(csTag,"psp_name_%d",i+1);
                                        PutField_CString(hResponse,csTag,csTmp);
                                }
                        }
*/

                        sprintf(csTag,"%s_%s_accept_cnt",csPspId,csBankCode);
                        GetField_Int(hContext,csTag,&iAcceptCnt);
                        sprintf(csTag,"accept_cnt_%d",i+1);
                        PutField_Int(hResponse,csTag,iAcceptCnt);
DEBUGLOG(("BOOLPayout:FormatResponse:: accept_cnt = [%d][%d]\n", i, iAcceptCnt));

                        sprintf(csTag,"%s_%s_pending_cnt",csPspId,csBankCode);
                        GetField_Int(hContext,csTag,&iPendingCnt);
                        sprintf(csTag,"pending_cnt_%d",i+1);
                        PutField_Int(hResponse,csTag,iPendingCnt);
DEBUGLOG(("BOOLPayout:FormatResponse:: pending_cnt = [%d][%d]\n", i, iPendingCnt));

                        sprintf(csTag,"%s_%s_payout_ccy",csPspId,csBankCode);
                        if(GetField_CString(hContext,csTag,&csCcy)){
                                sprintf(csTag,"ccy_%d",i+1);
                                PutField_CString(hResponse,csTag,csCcy);
DEBUGLOG(("BOOLPayout:FormatResponse:: ccy_id = [%d][%s]\n", i, csCcy));
                        }
                        else{
                                sprintf(csTag,"ccy_%d",i+1);
                                PutField_CString(hResponse,csTag,"-");
DEBUGLOG(("BOOLPayout:FormatResponse:: ccy_id = [%d][%s]\n", i, "-"));
                        }

                        sprintf(csTag,"%s_%s_accept_amt",csPspId,csBankCode);
                        GetField_Double(hContext,csTag,&dAcceptAmt);
                        sprintf(csTag,"accept_amt_%d",i+1);
                        PutField_Double(hResponse,csTag,dAcceptAmt);
DEBUGLOG(("BOOLPayout:FormatResponse:: accept_amt = [%d][%.2f]\n", i, dAcceptAmt));

                        sprintf(csTag,"%s_%s_pending_amt",csPspId,csBankCode);
                        GetField_Double(hContext,csTag,&dPendingAmt);
                        sprintf(csTag,"pending_amt_%d",i+1);
                        PutField_Double(hResponse,csTag,dPendingAmt);
DEBUGLOG(("BOOLPayout:FormatResponse:: pending_amt = [%d][%.2f]\n", i, dPendingAmt));

                        sprintf(csTag,"%s_%s_aval_psp_bal",csPspId,csBankCode);
                        GetField_Double(hContext,csTag,&dAvalBal);
                        sprintf(csTag,"aval_psp_bal_%d",i+1);
                        PutField_Double(hResponse,csTag,dAvalBal);
DEBUGLOG(("BOOLPayout:FormatResponse:: aval_bal = [%d][%.2f]\n", i, dAvalBal));

                }
        }
        FREE_ME(hPspDetail);


DEBUGLOG(("BOOLPayout:FormatResponse() iRet=[%d]\n",iRet));
        return iRet;
}




/*
int FormatResponse(const hash_t *hContext,
		   hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	i = 1;
	int	iAcceptCnt,iPendingCnt;
	double	dAcceptAmt,dPendingAmt;
	char	*csPspId;
	char	*csBankCode;
	char	*csCcy;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOOLPayout:FormatResponse()\n"));

	DBObjPtr = CreateObj(DBPtr,"DBOLRulePayoutPsp","GetExistingPsp");
	if((unsigned long) ((*DBObjPtr)(rRecordSet))==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
		while(hRec){
			iAcceptCnt = 0;
			iPendingCnt = 0;
			dAcceptAmt = 0.0;
			dPendingAmt = 0.0;

			if(GetField_CString(hRec,"psp_id",&csPspId) &&
			   GetField_CString(hRec,"to_bank_code",&csBankCode)){
				sprintf(csTag,"psp_id_%d",i);
				PutField_CString(hResponse,csTag,csPspId);

				sprintf(csTag,"bank_%d",i);
				PutField_CString(hResponse,csTag,csBankCode);

				sprintf(csTag,"%s_%s_accept_cnt",csPspId,csBankCode);
				GetField_Int(hContext,csTag,&iAcceptCnt);
				sprintf(csTag,"accept_cnt_%d",i);
				PutField_Int(hResponse,csTag,iAcceptCnt);

				sprintf(csTag,"%s_%s_pending_cnt",csPspId,csBankCode);
				GetField_Int(hContext,csTag,&iPendingCnt);
				sprintf(csTag,"pending_cnt_%d",i);
				PutField_Int(hResponse,csTag,iPendingCnt);

				sprintf(csTag,"%s_%s_payout_ccy",csPspId,csBankCode);
				if(GetField_CString(hContext,csTag,&csCcy)){
					sprintf(csTag,"ccy_%d",i);
					PutField_CString(hResponse,csTag,csCcy);
				}
				else{
					sprintf(csTag,"ccy_%d",i);
					PutField_CString(hResponse,csTag,"-");
				}

				sprintf(csTag,"%s_%s_accept_amt",csPspId,csBankCode);
				GetField_Double(hContext,csTag,&dAcceptAmt);
				sprintf(csTag,"accept_amt_%d",i);
				PutField_Double(hResponse,csTag,dAcceptAmt);
				
				sprintf(csTag,"%s_%s_pending_amt",csPspId,csBankCode);
				GetField_Double(hContext,csTag,&dPendingAmt);
				sprintf(csTag,"pending_amt_%d",i);
				PutField_Double(hResponse,csTag,dPendingAmt);

				PutField_Int(hResponse,"total_cnt",i);
				i++;
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

DEBUGLOG(("BOOLPayout:FormatResponse() iRet=[%d]\n",iRet));
	return iRet;
}
*/

int GetPayoutFilePath(hash_t* hTxn)
{
	int iRet=PD_OK;
	char	*csFileName;
	char	*csDate;
	char	*csPspId;
	char	*csBankCode;
	char    csPayOutFile[PD_MAX_FILE_LEN + 1];
	char    csPayOutFilePath[PD_MAX_FILE_LEN + 1];
	char    csTag[PD_TAG_LEN +1];
	char	csCmd[PD_MAX_FILE_LEN + 1];
	int	iSeqNum = 0;

	if(!GetField_CString(hTxn,"filename",&csFileName)){
DEBUGLOG(("BOOLPayout:GetPayoutFilePath filename missing!!!!!\n"));
		iRet = INT_ERR;
	}
	if(!GetField_Int(hTxn,"seq_num",&iSeqNum)){
DEBUGLOG(("BOOLPayout:GetPayoutFilePath seq_num missing!!!!!\n"));
		iRet = INT_ERR;
	}
	if(!GetField_CString(hTxn,"file_date",&csDate)){
DEBUGLOG(("BOOLPayout:GetPayoutFilePath file_date missing!!!!!\n"));
		iRet = INT_ERR;
	}
	if(!GetField_CString(hTxn,"psp_id",&csPspId)){
DEBUGLOG(("BOOLPayout:GetPayoutFilePath psp_id missing!!!!!\n"));
		iRet = INT_ERR;
	}
	if(!GetField_CString(hTxn,"file_bank_code",&csBankCode)){
DEBUGLOG(("BOOLPayout:GetPayoutFilePath bank_code missing!!!!!\n"));
		iRet = INT_ERR;
	}

	sprintf(csPayOutFilePath, "%s/%.*s/%.*s/%.*s/%d", getenv("OUTPUT_PAYOUT"),
							PD_YYYY_LEN,csDate,
							PD_YYYYMM_LEN,csDate,
							PD_DATE_LEN,csDate,
							iSeqNum);
DEBUGLOG(("BOOLPayout:GetPayoutFilePath FilePath[%s]\n",csPayOutFilePath));
	sprintf(csCmd, "mkdir %s/%.*s >/dev/null 2>&1",getenv("OUTPUT_PAYOUT"),PD_YYYY_LEN,csDate);
        system(csCmd);
	sprintf(csCmd, "mkdir %s/%.*s/%.*s >/dev/null 2>&1",getenv("OUTPUT_PAYOUT"),PD_YYYY_LEN,csDate,
										    PD_YYYYMM_LEN,csDate);
        system(csCmd);
	sprintf(csCmd, "mkdir %s/%.*s/%.*s/%.*s >/dev/null 2>&1",getenv("OUTPUT_PAYOUT"),PD_YYYY_LEN,csDate,
										    PD_YYYYMM_LEN,csDate,
										    PD_DATE_LEN,csDate);
        system(csCmd);
	sprintf(csCmd, "mkdir %s >/dev/null 2>&1",csPayOutFilePath);
        system(csCmd);

	sprintf(csPayOutFile, "%s/%s", csPayOutFilePath, csFileName);
DEBUGLOG(("BOOLPayout:GetPayoutFilePath Whole FilePath[%s]\n",csPayOutFile));
	sprintf(csTag,"%s_%s_path",csPspId,csBankCode);
	PutField_CString(hTxn,csTag,csPayOutFile);

	return iRet;
}

int CreatePayoutFileDetail(const char* csPspId, const char* csBankCode, hash_t* hContext)
{
	int iRet = PD_OK;

	char*    csDate;
	//char*    csPspChannel;
	char    csPayOutFile[PD_MAX_FILE_LEN + 1];
	char    csPayOutFilePath[PD_MAX_FILE_LEN + 1];
	char    csPayOutFileName[PD_FILENAME_LEN + 1];
	char    csTag[PD_TAG_LEN +1];
	//char    csFileId[PD_TXN_SEQ_LEN + 1];
	unsigned long lFileId=0l;
        char    csNewFileId[PD_TXN_SEQ_LEN + 1];
	int     iSeqNum=0;
	int     iFormat=0;
	char    csCmd[PD_MAX_FILE_LEN + 1];

DEBUGLOG(("BOOLPayout:CreatePayoutFileDetail()\n"));

	//memset(csPayOutFilePath, 0, sizeof(csPayOutFilePath));
	//memset(csPayOutFileName, 0, sizeof(csPayOutFileName));
	//memset(csFileId, 0, sizeof(csFileId));

	hash_t* hPspDetail;
	hPspDetail = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hPspDetail,0);
	DBObjPtr = CreateObj(DBPtr,"DBOLPspDetail","GetPspDetail");
	if ((*DBObjPtr)(csPspId,hPspDetail) == PD_OK) {
		if (GetField_Int(hPspDetail,"payout_format",&iFormat)) {
DEBUGLOG(("CreatePayoutFileDetail::payout_format [%d]!!\n",iFormat));
		}
	}
	FREE_ME(hPspDetail);


	if(GetField_CString(hContext,"PHDATE",&csDate)){
		//sprintf(csTag,"%s_%s_file_date",csPspId,csBankCode);
		sprintf(csTag,"file_date");
		PutField_CString(hContext,csTag,csDate);
		//PutField_CString(hContext,"file_pid",csPspId);
DEBUGLOG(("CreatePayoutFileDetail::File Date[%s], PID[%s]\n", csDate,csPspId));
	}

DEBUGLOG(("CreatePayoutFileDetail::DBOLPayoutGeneratedFileHD:GetNextSeq\n"));
	DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","GetNextSeq");
	if((unsigned long) ((*DBObjPtr)(csDate,csPspId,csBankCode,&iSeqNum))!=PD_OK){
		iRet = INT_ERR;
DEBUGLOG(("CreatePayoutFileDetail::DBOLPayoutGeneratedFileHD:GetNextSeq Failed\n"));
	}
	else{
		//sprintf(csPayOutFilePath, "%s", getenv("OUTPUT_PAYOUT"));
		if(iFormat!=PD_TWV_PAYOUT_FORMAT)
			sprintf(csPayOutFileName, "%s_%s_%s%02d.xls", csPspId,csBankCode,csDate,iSeqNum);
		else
			sprintf(csPayOutFileName, "%s_%s_%s%02d.csv", csPspId,csBankCode,csDate,iSeqNum);

		//sprintf(csTag,"%s_%s_seq_num",csPspId,csBankCode);
		//PutField_Int(hContext,csTag,iSeqNum);
		PutField_Int(hContext,"seq_num",iSeqNum);

		//sprintf(csTag,"%s_%s_file",csPspId,csBankCode);
		//PutField_CString(hContext,csTag,csPayOutFileName);
		PutField_CString(hContext,"filename",csPayOutFileName);

		//sprintf(csPayOutFile, "%s/%s", csPayOutFilePath, csPayOutFileName);
		//sprintf(csTag,"%s_path",csPspId);
		//PutField_CString(hContext,csTag,csPayOutFile);
	}
	if(iRet==PD_OK){
DEBUGLOG(("CreatePayoutFileDetail::DBOLPayoutGeneratedFileHD:GetNextFileId\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","GetNextFileId");
                if((unsigned long) ((*DBObjPtr)(&lFileId))!=PD_OK){
                        iRet = INT_ERR;
DEBUGLOG(("CreatePayoutFileDetail::DBOLPayoutGeneratedFileHD:GetNextFileId Failed\n"));
                }
                else{
                        sprintf(csNewFileId,"%ld",lFileId);
			//sprintf(csTag,"%s_%s_file_id",csPspId,csBankCode);
			sprintf(csTag,"file_id");
                        PutField_CString(hContext,csTag,csNewFileId);
                }
        }

        sprintf(csPayOutFilePath, "%s/%.*s/%.*s/%.*s/%d", getenv("OUTPUT_PAYOUT"),
                                                        PD_YYYY_LEN,csDate,
                                                        PD_YYYYMM_LEN,csDate,
                                                        PD_DATE_LEN,csDate,
                                                        iSeqNum);
DEBUGLOG(("BOOLPayout:GetPayoutFilePath FilePath[%s]\n",csPayOutFilePath));
        sprintf(csCmd, "mkdir %s/%.*s >/dev/null 2>&1",getenv("OUTPUT_PAYOUT"),PD_YYYY_LEN,csDate);
        system(csCmd);
        sprintf(csCmd, "mkdir %s/%.*s/%.*s >/dev/null 2>&1",getenv("OUTPUT_PAYOUT"),PD_YYYY_LEN,csDate,
                                                                                    PD_YYYYMM_LEN,csDate);
        system(csCmd);
        sprintf(csCmd, "mkdir %s/%.*s/%.*s/%.*s >/dev/null 2>&1",getenv("OUTPUT_PAYOUT"),PD_YYYY_LEN,csDate,
                                                                                    PD_YYYYMM_LEN,csDate,
                                                                                    PD_DATE_LEN,csDate);
        system(csCmd);
        sprintf(csCmd, "mkdir %s >/dev/null 2>&1",csPayOutFilePath);
        system(csCmd);

        sprintf(csPayOutFile, "%s/%s", csPayOutFilePath, csPayOutFileName);
DEBUGLOG(("BOOLPayout:GetPayoutFilePath Whole FilePath[%s]\n",csPayOutFile));
        //sprintf(csTag,"%s_%s_path",csPspId,csBankCode);
        sprintf(csTag,"file_path");
        PutField_CString(hContext,csTag,csPayOutFile);

DEBUGLOG(("BOOLPayout:CreatePayoutFileDetail() iRet=[%d]\n",iRet));
	return iRet;
}


int CreatePayoutFile(const int iFormat, const char* csPspId, const char* csBankCode, hash_t* hContext)
{
	int iRet = PD_OK;
	FILE    *fp;
	char    *csPayOutFile;
	char    csTag[PD_TAG_LEN +1];

	int	iCnt = 0;

DEBUGLOG(("BOOLPayout:CreatePayoutFile(%d,%s,%s)\n",iFormat,csPspId,csBankCode));

	//sprintf(csTag,"%s_%s_path",csPspId,csBankCode);
        sprintf(csTag,"file_path");
	if(GetField_CString(hContext,csTag,&csPayOutFile)){
DEBUGLOG(("BOOLPayout:CreatePayoutFile() writ to file[%s]\n",csPayOutFile));
	}


	if(iRet==PD_OK) {
DEBUGLOG(("CreatePayoutFile::Open PayoutFile [%s] for psp id [%s][%s]\n", csPayOutFile, csPspId,csBankCode));
		fp = fopen(csPayOutFile, "w");
		if (fp == NULL) {
DEBUGLOG(("CreatePayoutFile::Open Payoutfile [%s] problem\n", csPayOutFile));
ERRLOG("BOOLPayout:CreatePayoutFile::Open Payoutfile problem!!\n");
			iRet=INT_ERR;
		}
	}

	if((iRet==PD_OK) && (iFormat==PD_DEFAULT_PAYOUT_FORMAT)){
DEBUGLOG(("CreatePayoutFile::Format [%d]\n",iFormat));
		fprintf(fp, "<html><body><table>\n");
		fprintf(fp, "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"/>\n");
		fprintf(fp, "<style type=\"text/css\"> .format{ mso-number-format:'\\@';} </style>\n");
		fprintf(fp, "%s%s%s%s Payout Records%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s\n",
				PD_TR, PD_TD, PD_BOLD, csPspId, PD_BOLD_END, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TR_END);


		//fprintf(fp, "%s%sUploadFile Trans No.%s%sPayout Trans No.%s%sReceiver Name%s%sID Card No.%s%sMobile No.%s%sBank%s%sBranch%s%sBank Account%s%sAmount%s%sProvince%s%sCity%s%sRemarks%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);
		fprintf(fp, "%s%sPayout Trans No.%s%sReceiver Name%s%sID Card No.%s%sMobile No.%s%sBank%s%sBranch%s%sBank Account%s%sAmount%s%sProvince%s%sCity%s%sRemarks%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);

	}
	else if((iRet==PD_OK) && (iFormat==PD_YPY_PAYOUT_FORMAT)) {
DEBUGLOG(("CreatePayoutFile::Format [%d]\n",iFormat));
		fprintf(fp, "<html><body><table>\n");
		fprintf(fp, "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"/>\n");
		fprintf(fp, "<style type=\"text/css\"> .format{ mso-number-format:'\\@';} </style>\n");
		//fprintf(fp, "%s%sBatch No.%s%sTransaction ID%s%sName%s%sBank Account%s%sBank%s%sProvince%s%sCity%s%sAmount%s%sReason%s%sBranch%s%sMobile No.%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);
		
		fprintf(fp, "%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);

	}

	else if((iRet==PD_OK) && (iFormat==PD_TWV_PAYOUT_FORMAT)) {
DEBUGLOG(("CreatePayoutFile::Format [%d]\n",iFormat));
		if(GetField_Int(hContext,"txn_cnt",&iCnt)){
			fprintf(fp,"%d\n",iCnt);
		}
	}

	fclose(fp);
DEBUGLOG(("BOOLPayout:CreatePayoutFile() iRet=[%d]\n",iRet));
	return iRet;
}


int WriteAssignedRecord(hash_t *hContext,
			hash_t* hRequest)
{
	int	iRet=PD_OK;
	int	i=0;
	int	iTmp=0;
	int	iTxnCnt=0;
	int	iCnt=0;
	//int	iBatchCnt=0;
	double	dTmp = 0.0;
	double	dAmt = 0.0;
	double	dPayoutAmt = 0.0;
	double	dRemainAmt = 0.0;
	double	dSplitAmt = 0.0;
	double	dTmpAmt = 0.0;
	double	dTmpTotalAmt = 0.0;
	char	cBatchMode;
	char	*csTmp;
	char	*csTmpBatch=strdup("");
	char	*csPspId;
	char	*csBankCode;
	char	*csFilePath;
	char	*csTxnCcy;
	char	*csPayoutTxnSeq;
	char	csTag[PD_TAG_LEN +1];
	char	cs2Tag[PD_TAG_LEN +1];
	unsigned long lFileId=0l;
        char    csNewFileId[PD_TXN_SEQ_LEN + 1];
	hash_t  *hRec, *hDetail, *hHeader;

        hHeader= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hHeader,0);
        hDetail= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hDetail,0);
	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOOLPayout:WriteAssignedRecord()\n"));
	if (GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hDetail,"add_user",csTmp);
		PutField_CString(hHeader,"add_user",csTmp);
	}

	if(!GetField_Char(hRequest,"batch_mode",&cBatchMode)){
		cBatchMode = PD_OFFLINE;
		PutField_Char(hRequest,"batch_mode",cBatchMode);
	}
	else{
DEBUGLOG(("BOOLPayout:WriteAssignedRecord() batch_mode [%c]\n",cBatchMode));
	}

DEBUGLOG(("WriteAssignedRecord::Call DBOLMerchantUploadFileDetail:GetPspAssignedTxn\n"));
	DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","GetPspAssignedTxn");
	if((unsigned long)(*DBObjPtr)(hRequest,rRecordSet)==PD_OK){

		GetField_Int(hContext,"psp_count",&iCnt);
                for(i=0; i<iCnt; i++){
                        sprintf(csTag,"psp_id_%d",i);
                        sprintf(cs2Tag,"bank_code_%d",i);
                        if(GetField_CString(hContext,csTag,&csPspId) &&
			   GetField_CString(hContext,cs2Tag,&csBankCode)){
                                PutField_CString(hHeader,"file_pid",csPspId);
                                PutField_CString(hHeader,"file_bank_code",csBankCode);

                                sprintf(csTag, "%s_%s_file", csPspId,csBankCode);
                                if(GetField_CString(hContext,csTag,&csTmp)){
                                        PutField_CString(hHeader,"filename",csTmp);
                                }
                                sprintf(csTag, "%s_%s_file_date", csPspId,csBankCode);
                                if(GetField_CString(hContext,csTag,&csTmp)){
                                        PutField_CString(hHeader,"file_date",csTmp);
                                }
                                sprintf(csTag, "%s_%s_seq_num", csPspId,csBankCode);
                                if(GetField_Int(hContext,csTag,&iTmp)){
                                        PutField_Int(hHeader,"seq_num",iTmp);
                                }
                                sprintf(csTag, "%s_%s_payout_ccy", csPspId,csBankCode);
                                if(GetField_CString(hContext,csTag,&csTmp)){
                                        PutField_CString(hHeader,"ccy_id",csTmp);
                                }

                                if(iRet==PD_OK){
DEBUGLOG(("WriteAssignedRecord::DBOLPayoutGeneratedFileHD:GetNextFileId\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","GetNextFileId");
                                        if((unsigned long) ((*DBObjPtr)(&lFileId))!=PD_OK){
                                                iRet = INT_ERR;
DEBUGLOG(("WriteAssignedRecord::DBOLPayoutGeneratedFileHD:GetNextFileId Failed\n"));
                                        }
                                        else{
                                                sprintf(csNewFileId,"%ld",lFileId);
                                                sprintf(csTag,"%s_%s_file_id",csPspId,csBankCode);
                                                PutField_CString(hHeader,"file_id",csNewFileId);
                                                PutField_CString(hContext,csTag,csNewFileId);
                                        }
                                }

                                DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Add");
                                if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("WriteAssignedRecord::OLPayoutGeneratedFileHD::Add Error!!!\n"));
                                        iRet = INT_ERR;
                                }

				if(iRet==PD_OK){
					if(cBatchMode==PD_OFFLINE)
                                		PutField_Int(hHeader,"status",PD_PAYOUTFILE_PRE_GENERATED);
					else
                                		PutField_Int(hHeader,"status",PD_PAYOUTFILE_PRE_SEND);
                                	DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Update");
                                	if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("WriteAssignedRecord::OLPayoutGeneratedFileHD::Update Error!!!\n"));
                                       		iRet = INT_ERR;
                                	}
				}
                        }
                }

		i = 0;
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec && (iRet==PD_OK)) {
			if (GetField_CString(hRec, "psp_id", &csPspId)&&
			    GetField_CString(hRec, "pregen_bank_code", &csBankCode)) {

				sprintf(csTag, "%s_%s_file_id", csPspId,csBankCode);
				GetField_CString(hContext,csTag,&csTmp);
				sprintf(csTag,"pregen_file_id_%d", i);
				PutField_CString(hRequest,csTag,csTmp);
				PutField_CString(hDetail,"file_id",csTmp);

				sprintf(csTag, "%s_%s_path", csPspId,csBankCode);
				GetField_CString(hContext,csTag,&csFilePath);
DEBUGLOG(("GetPspAssignedTxn::psp_id = [%s] bank_code = [%s]\n",csPspId,csBankCode));
			}
			if (GetField_CString(hRec, "txn_id", &csTmp)) {
				PutField_CString(hDetail,"upload_txn_id",csTmp);
DEBUGLOG(("GetPspAssignedTxn::upload_txn_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "batch_id", &csTmp)) {
				sprintf(csTag, "batch_id_%d", i);
				PutField_CString(hRequest,csTag,csTmp);
				PutField_CString(hDetail,"batch_id",csTmp);
DEBUGLOG(("GetPspAssignedTxn::batch_id = [%s]\n",csTmp));
			}
			if (GetField_Int(hRec, "seq_num", &iTmp)) {
				sprintf(csTag, "seq_num_%d", i);
				PutField_Int(hRequest,csTag,iTmp);
				PutField_Int(hDetail,"seq_num",iTmp);
DEBUGLOG(("GetPspAssignedTxn::seq_num = [%d]\n",iTmp));
			}
			if (GetField_CString(hRec,"txn_country", &csTmp)) {
				sprintf(csTag, "%s_txn_country", csPspId);
				PutField_CString(hContext,csTag,csTmp);
				PutField_CString(hDetail,"txn_country",csTmp);
DEBUGLOG(("GetPspAssignedTxn::txn_country = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"request_ccy", &csTmp)) {
				PutField_CString(hDetail,"request_ccy",csTmp);
DEBUGLOG(("GetPspAssignedTxn::request_ccy = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"payout_ccy", &csTmp)) {
				if(strcmp(csTmp,"RMB"))
					csTxnCcy=strdup(csTmp);
				else
					csTxnCcy=strdup(PD_CCY_ISO_CNY);

				sprintf(csTag, "%s_%s_payout_ccy", csPspId,csBankCode);
				PutField_CString(hContext,csTag,csTxnCcy);
				PutField_CString(hDetail,"payout_ccy",csTxnCcy);
				FREE_ME(csTxnCcy);
DEBUGLOG(("GetPspAssignedTxn::payout_ccy = [%s]\n",csTxnCcy));
			}
			if (GetField_CString(hRec,"account_name", &csTmp)) {
				PutField_CString(hDetail,"account_name",csTmp);
DEBUGLOG(("GetPspAssignedTxn::account_name = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"account_num", &csTmp)) {
				PutField_CString(hDetail,"account_num",csTmp);
DEBUGLOG(("GetPspAssignedTxn::account_num = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"bank_name", &csTmp)) {
				PutField_CString(hDetail,"bank_name",csTmp);
DEBUGLOG(("GetPspAssignedTxn::bank_name = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"branch", &csTmp)) {
				PutField_CString(hDetail,"branch",csTmp);
DEBUGLOG(("GetPspAssignedTxn::branch = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"identity_id", &csTmp)) {
				PutField_CString(hDetail,"identity_id",csTmp);
DEBUGLOG(("GetPspAssignedTxn::identity_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"phone_num", &csTmp)) {
				PutField_CString(hDetail,"phone_num",csTmp);
DEBUGLOG(("GetPspAssignedTxn::phone_num = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"merchant_ref", &csTmp)) {
				PutField_CString(hDetail,"merchant_ref",csTmp);
DEBUGLOG(("GetPspAssignedTxn::merchant_ref = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"remark", &csTmp)) {
DEBUGLOG(("GetPspAssignedTxn::remark = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"province", &csTmp)) {
				PutField_CString(hDetail,"province",csTmp);
DEBUGLOG(("GetPspAssignedTxn::province = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"city", &csTmp)) {
				PutField_CString(hDetail,"city",csTmp);
DEBUGLOG(("GetPspAssignedTxn::city = [%s]\n",csTmp));
			}
			if (GetField_Double(hRec,"request_amount", &dTmp)) {
				PutField_Double(hDetail,"request_amount",dTmp);
DEBUGLOG(("GetPspAssignedTxn::request_amount = [%lf]\n",dTmp));
			}
			if (GetField_Double(hRec,"payout_amount", &dPayoutAmt)) {
				dRemainAmt = dPayoutAmt;
				///PutField_Double(hDetail,"payout_amount",dTmp);
DEBUGLOG(("GetPspAssignedTxn::payout_amount = [%lf]\n",dPayoutAmt));

				sprintf(csTag,"org_dst_net_amt_%s_%s",csPspId,csBankCode);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dTmp;
				}
				else{
					dAmt = dTmp;
				}
				PutField_Double(hContext,csTag,dAmt);

				sprintf(csTag,"%s_%s_txn_amt",csPspId,csBankCode);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dPayoutAmt;
				}
				else{
					dAmt = dPayoutAmt;
				}
				PutField_Double(hContext,csTag,dAmt);
			}
			if (GetField_CString(hRec,"merchant_fee_ccy", &csTmp)) {
				sprintf(csTag,"%s_%s_merchant_fee_ccy",csPspId,csBankCode);
				PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::merchant_fee_ccy = [%s]\n",csTmp));
			}
			if (GetField_Double(hRec,"merchant_fee", &dTmp)) {
				sprintf(csTag,"%s_%s_merchant_fee",csPspId,csBankCode);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dTmp;
				}
				else{
					dAmt = dTmp;
				}
				PutField_Double(hContext,csTag,dAmt);
DEBUGLOG(("GetPspAssignedTxn::merchant_fee = [%lf]\n",dTmp));
			}

			if (GetField_CString(hRec,"member_fee_ccy", &csTmp)) {
				sprintf(csTag,"%s_%s_member_fee_ccy",csPspId,csBankCode);
				PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::member_fee_ccy = [%s]\n",csTmp));
			}

			if (GetField_Double(hRec,"markup_amt", &dTmp)) {
DEBUGLOG(("GetPspAssignedTxn::markup_amt = [%lf]\n",dTmp));
			}

			if (GetField_Double(hRec,"member_fee", &dTmp)) {
				sprintf(csTag,"%s_%s_member_fee",csPspId,csBankCode);
				if(GetField_Double(hContext,csTag,&dAmt)){
					dAmt += dTmp;
				}
				else{
					dAmt = dTmp;
				}
				PutField_Double(hContext,csTag,dAmt);
DEBUGLOG(("GetPspAssignedTxn::member_fee = [%lf]\n",dTmp));
			}
//////////
//split by average
			sprintf(csTag,"%s_split_amt",csPspId);
			dSplitAmt = 0.0;
			dTmpTotalAmt = 0.0;
			GetField_Double(hContext,csTag,&dSplitAmt);
			int iSplitCnt = 1;
			if(dSplitAmt>0){
				iSplitCnt = (int)(dPayoutAmt/dSplitAmt);
				if(dPayoutAmt>(dSplitAmt*iSplitCnt)){
					iSplitCnt ++;
				}

DEBUGLOG(("WriteAssignedRecord:: Split Count: [%d]\n",iSplitCnt));

				dTmpAmt = 0.0;
				dTmpTotalAmt = 0.0;

				dTmpAmt = newround(dPayoutAmt/iSplitCnt,2);
				for(iTmp=0;iTmp<(iSplitCnt-1);iTmp++){
					sprintf(csTag,"avag_split_amt_%d",iTmp);
					PutField_Double(hContext,csTag,dTmpAmt);
					dTmpTotalAmt += dTmpAmt;
				}
			}
			sprintf(csTag,"avag_split_amt_%d",(iSplitCnt-1));
			PutField_Double(hContext,csTag,dPayoutAmt-dTmpTotalAmt);

			for(iTmp=0;iTmp<iSplitCnt;iTmp++){
/*
				if(dRemainAmt>dSplitAmt && dSplitAmt>0.0){
					dRemainAmt -= dSplitAmt;
					PutField_Double(hDetail,"payout_amount",dSplitAmt);
				}
				else{
					PutField_Double(hDetail,"payout_amount",dRemainAmt);
					dRemainAmt -=dRemainAmt;
				}	
*/
				sprintf(csTag,"avag_split_amt_%d",iTmp);
				if(GetField_Double(hContext,csTag,&dTmp)){
					PutField_Double(hDetail,"payout_amount",dTmp);
				}
				
				DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextPayoutTxnSeq");
                        	csPayoutTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("WriteAssignedRecord:: GeneratePayoutSeq: [%d]=[%s]\n",i,csPayoutTxnSeq));
                        	PutField_CString(hDetail,"txn_id",csPayoutTxnSeq);
				if(cBatchMode==PD_OFFLINE)
					PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_PRE_GENERATED);
				else
					PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_PRE_SEND);
				DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileDT","Add");
				if ((unsigned long)(*DBObjPtr)(hDetail) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("WriteAssignedRecord:: DBOLPayoutGeneratedFileDT:Add Failed\n"));
				}

				iTxnCnt = 0;
				sprintf(csTag,"%s_%s_gen_txn_cnt",csPspId,csBankCode);
				GetField_Int(hContext,csTag,&iTxnCnt);
				PutField_Int(hContext,csTag,iTxnCnt+1);


			}
			iTxnCnt = 0;
			sprintf(csTag,"%s_%s_txn_cnt",csPspId,csBankCode);
			GetField_Int(hContext,csTag,&iTxnCnt);
			PutField_Int(hContext,csTag,iTxnCnt+1);


			i++;
			hRec = RecordSet_GetNext(rRecordSet);
		}
		PutField_Int(hRequest,"total_count",i);
		PutField_Int(hDetail,"total_count",i);
		PutField_Int(hContext,"total_cnt",i);
DEBUGLOG(("WriteAssignedRecord::total_count= [%d]\n",i));

		GetField_Int(hContext,"psp_count",&iCnt);
		for(i=0; i<iCnt; i++){
			sprintf(csTag,"psp_id_%d",i);
                        sprintf(cs2Tag,"bank_code_%d",i);
			if(GetField_CString(hContext,csTag,&csPspId) &&
			   GetField_CString(hContext,cs2Tag,&csBankCode)){

				hash_init(hHeader,0);
				sprintf(csTag, "%s_%s_file_id", csPspId,csBankCode);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"file_id",csTmp);
				}
				sprintf(csTag, "%s_%s_txn_cnt", csPspId,csBankCode);
				if(GetField_Int(hContext,csTag,&iTmp)){
					PutField_Int(hHeader,"txn_cnt",iTmp);
				}
				sprintf(csTag, "%s_%s_txn_amt", csPspId,csBankCode);
				if(GetField_Double(hContext,csTag,&dTmp)){
					PutField_Double(hHeader,"txn_amt",dTmp);
				}
				sprintf(csTag, "%s_%s_payout_ccy", csPspId,csBankCode);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"ccy_id",csTmp);
				}

				DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Update");
				if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("WriteAssignedRecord::OLPayoutGeneratedFileHD::Update Error!!!\n"));
					iRet = INT_ERR;
				}
				
			}
		}

	}
	else{
DEBUGLOG(("WriteAssignedRecord::GetpspAssignedTxn::Failed!!!!\n"));
ERRLOG("BOOLPayout:WriteAssignedRecord::GetPspAssignedTxn::Failed!!\n");
		iRet=INT_NOT_RECORD;
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hHeader);
	FREE_ME(hDetail);
	FREE_ME(csTmpBatch);
	FREE_ME(csPayoutTxnSeq);
DEBUGLOG(("WriteAssignedRecord::iRet=[%d]\n",iRet));
	return iRet;
}


int WritePayoutFile(const char* csPayOutFile, hash_t* hRec)
{
	int     iRet=PD_OK;
	int     iTmp;
	char*   csTmp;
	//char*   csPspId = NULL;
	//char*   csPspChannel= NULL;
	char	csBankName[PD_BANK_NAME_LEN+1];
	double  dTmp;
	int	iFormat;

DEBUGLOG(("BOOLPayout:WritePayoutFile()\n"));
	FILE    *fp;
	fp = fopen(csPayOutFile, "a");
	if (fp == NULL) {
DEBUGLOG(("WritePayoutFile::Open Payoutfile [%s] problem\n", csPayOutFile));
ERRLOG("BOOLPayout:WritePayoutFile::Open Payoutfile problem!!\n");
		iRet=INT_ERR;
	}

	if(iRet==PD_OK) {
		if(GetField_Int(hRec,"end_file",&iTmp)){
			if(iTmp==PD_TRUE){
				if(!GetField_Int(hRec,"payout_format",&iFormat)){
					fprintf(fp, "</table></body></html>\n");
				}
				fclose(fp);
				return iRet;
			}
		}
	}

	if(GetField_Int(hRec,"payout_format",&iFormat)){
DEBUGLOG(("WritePayoutFile::payout_format[%d]\n", iFormat));
	}/*
	if(GetField_CString(hRec,"psp_id",&csPspId)){
DEBUGLOG(("WritePayoutFile::psp_id [%s]\n", csPspId));
	}*/


	if(iRet==PD_OK){
		if(iFormat == PD_TWV_PAYOUT_FORMAT){
			if (!GetField_CString(hRec, "gen_txn_id", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:gen_txn_id [%s]\n", csTmp));
			fprintf(fp, "%s%c",csTmp,PD_TWV_DELIMETER);

			if (!GetField_CString(hRec, "bank_code", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:bank_code [%s]\n", csTmp));

			fprintf(fp, "%s%c",csTmp,PD_TWV_DELIMETER);
	
			if (!GetField_CString(hRec, "branch", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:branch [%s]\n", csTmp));
			fprintf(fp, "%s%c",csTmp,PD_TWV_DELIMETER);

			if (!GetField_CString(hRec, "identity_id", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:identity_id [%s]\n", csTmp));
			fprintf(fp, "%s%c",csTmp,PD_TWV_DELIMETER);

			if (!GetField_CString(hRec, "account_name", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_name [%s]\n", csTmp));
			fprintf(fp, "%s%c",csTmp,PD_TWV_DELIMETER);

			if (!GetField_CString(hRec, "account_num", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_id [%s]\n", csTmp));
			fprintf(fp, "%s%c",csTmp,PD_TWV_DELIMETER);
	
			if (!GetField_Double(hRec, "payout_amount", &dTmp)) {
				dTmp = 0.0;
			}
DEBUGLOG(("WritePayoutFile:payout_amount [%d]\n", (int)dTmp));
			fprintf(fp, "%d",(int)dTmp);
	
			fprintf(fp, "\n");
		}
		else if(iFormat == PD_YPY_PAYOUT_FORMAT){
			
			fprintf(fp, "%s", PD_TR);
			fprintf(fp, "%s%s",PD_TD,PD_TD_END);

			if (!GetField_CString(hRec, "txn_id", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:txn_id [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "account_name", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_name [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "account_num", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_num [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "bank_name", &csTmp)) {
				csTmp = strdup("");
			}
			else{
				csBankName[0]='\0';
				DBObjPtr = CreateObj(DBPtr,"DBBankNameMapping","BankNameConvert");
				if ((unsigned long)(*DBObjPtr)(csTmp,csBankName)==FOUND) {
DEBUGLOG(("WritePayoutFile:bank_name [%s] (converted)\n", csBankName));
				}
				else{
					strcpy(csBankName,csTmp);
					csBankName[strlen(csTmp)]='\0';
DEBUGLOG(("WritePayoutFile:bank_name [%s] (same as input)\n", csBankName));
				}
			}
			fprintf(fp, "%s%s%s",PD_TD,csBankName,PD_TD_END);

			if (!GetField_CString(hRec, "province", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:province [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "city", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:city [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_Double(hRec, "payout_amount", &dTmp)) {
				dTmp = 0.0;
			}
DEBUGLOG(("WritePayoutFile:payout_amount [%f]\n", dTmp));
			fprintf(fp, "%s%f%s",PD_TD,dTmp,PD_TD_END);

			fprintf(fp, "%s%s",PD_TD,PD_TD_END);	

			if (!GetField_CString(hRec, "branch", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:branch [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "phone_num", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:phone_num [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			fprintf(fp, "%s\n", PD_TR_END);

		}
		else{
	//		fprintf(fp, "%s%sPayout Trans No.%s%sReceiver Name%s%sID Card No.%s%sMobile No.%s%sBank%s%sBranch%s%sBank Account%s%sAmount%s%sProvince%s%sCity%s%sRemarks%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);

			fprintf(fp, "%s", PD_TR);
/*
			if (!GetField_CString(hRec, "upload_txn_id", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:upload_txn_id [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);
*/
			if (!GetField_CString(hRec, "txn_id", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:txn_id [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "account_name", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_name [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "identity_id", &csTmp)) {
				csTmp = strdup("0000000");
			}
DEBUGLOG(("WritePayoutFile:identity_id [%s]\n", csTmp));
			fprintf(fp, "%s[%s]%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "phone_num", &csTmp)) {
				csTmp = strdup("0000000");
			}
DEBUGLOG(("WritePayoutFile:phone_num [%s]\n", csTmp));
			fprintf(fp, "%s[%s]%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "bank_name", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:bank_name [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "branch", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:branch [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

			if (!GetField_CString(hRec, "account_num", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:account_num [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

			if (!GetField_Double(hRec, "payout_amount", &dTmp)) {
				dTmp = 0.0;
			}
DEBUGLOG(("WritePayoutFile:payout_amount [%f]\n", dTmp));
			fprintf(fp, "%s%f%s",PD_TD,dTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "province", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:province [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "city", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:city [%s]\n", csTmp));
			fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
	
			if (!GetField_CString(hRec, "remark", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:remark [%s]\n", csTmp));
			//fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);
			fprintf(fp, "%s%s",PD_TD,csTmp);
			if (!GetField_CString(hRec, "upload_txn_id", &csTmp)) {
				csTmp = strdup("");
			}
DEBUGLOG(("WritePayoutFile:upload_txn_id [%s]\n", csTmp));
			fprintf(fp, "[%s]%s",csTmp,PD_TD_END);
	
			fprintf(fp, "%s\n", PD_TR_END);
	
		}
	}
	FREE_ME(csTmp);
	fclose(fp);
DEBUGLOG(("WritePayoutFile: iRet[%d]\n", iRet));
	return iRet;
}


int HandleCancelGenerate(hash_t* hContext,
		         hash_t* hRequest,
			 hash_t* hResponse)
{
	int	iRet=PD_OK;
	int	i=0;
	int	iChk=0;
	int	iTmp=0;
	double	dTmp = 0.0;
	char	*csTmp;
	char	*csOrgTxnId;
	char	csNewTxnSeq[PD_TXN_SEQ_LEN+1];
	char	*csFileId;
	char	*csPspId;
	char	*csBaid;
	char	*csClient=NULL;
	char	*csUser;
	char	csTag[PD_TAG_LEN +1];
	char	cTmp;
	int	iVersionNo;
	char	*csGenId = NULL;
	int	iTmpRet=PD_OK;

	hash_t  *hRec, *hTxn, *hOrgTxn, *hUploadTxn;
        hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
        hOrgTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hOrgTxn,0);
	hUploadTxn= (hash_t*) malloc (sizeof(hash_t));
	hash_init(hUploadTxn,0);
	hash_t* hOrgRec;
	hOrgRec = (hash_t*) malloc (sizeof(hash_t));
	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
DEBUGLOG(("HandleCancelGenerate()\n"));

	if(GetField_CString(hContext,"file_id",&csTmp)){
		PutField_CString(hTxn,"file_id",csTmp);
DEBUGLOG(("HandleCancelGenerate() file_id = [%s]\n",csTmp));
	}
	if(GetField_Int(hContext,"status",&iTmp)){
		PutField_Int(hTxn,"status",iTmp);
DEBUGLOG(("HandleCancelGenerate() status = [%d]\n",iTmp));
	}
	if(GetField_Int(hContext,"upload_status",&iTmp)){
		PutField_Int(hTxn,"upload_status",iTmp);
DEBUGLOG(("HandleCancelGenerate() upload_status = [%d]\n",iTmp));
	}
	if(GetField_CString(hRequest,"add_user",&csUser)){
		PutField_CString(hTxn,"update_user",csUser);
	}
	if(GetField_CString(hRequest,"psp_date",&csTmp)){
		PutField_CString(hContext,"psp_date",csTmp);
DEBUGLOG(("HandleCancelGenerate() psp_date= [%s]\n",csTmp));
        }

DEBUGLOG(("HandleCancelGenerate::Call DBOLPayoutGeneratedFileDT:GetBlockCancelCount\n"));
	DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileDT","GetBlockCancelCount");
	iChk = (unsigned long)(*DBObjPtr)(hTxn);
	if (iChk < 0) {
		iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("HandleCancelGenerate::internal error!!!\n"));
	} else if (iChk > 0) {
		iRet = INT_RECON_PAYOUT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("HandleCancelGenerate::Reconciled payout found!!!\n"));
	} else {

DEBUGLOG(("HandleCancelGenerate::Call DBOLPayoutGeneratedFileDT:GetDetailByCondition\n"));
	DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileDT","GetDetailByCondition");
	iChk = (unsigned long)(*DBObjPtr)(hTxn,rRecordSet);
	if (iChk == PD_FOUND) {
		i = 0;
		hRec = RecordSet_GetFirst(rRecordSet);
		while ((hRec) && (iRet==PD_OK)){
			if (GetField_CString(hRec, "file_id", &csFileId)) {
DEBUGLOG(("GetDetail::file_id = [%s]\n",csFileId));
			}
			if (GetField_Int(hRec, "version_no", &iVersionNo)) {
DEBUGLOG(("GetDetail::version_no = [%d]\n",iVersionNo));
			}
			if (iVersionNo != 1) {
				DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextOmtTxnSeq");
				strcpy(csNewTxnSeq,(*DBObjPtr)());
DEBUGLOG(("csNewTxnSeq [%s]!!!\n",csNewTxnSeq));
				PutField_CString(hContext,"txn_seq",csNewTxnSeq);
				PutField_CString(hTxn,"aux_txn_id",csNewTxnSeq);
				sprintf(csTag,"txn_seq_%d",i);
				PutField_CString(hContext,csTag,csNewTxnSeq);
			}

			if (GetField_CString(hRec, "batch_id", &csTmp)) {
				sprintf(csTag, "batch_id_%d", i);
				PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetDetail::batch_id = [%s]\n",csTmp));
			}
			if (GetField_Int(hRec, "seq_num", &iTmp)) {
				sprintf(csTag, "seq_num_%d", i);
				PutField_Int(hRequest,csTag,iTmp);
DEBUGLOG(("GetDetail::seq_num = [%d]\n",iTmp));
			}
			if (GetField_CString(hRec, "txn_seq", &csOrgTxnId)) {
				//sprintf(csTag, "txn_id_%d", i);
				//PutField_CString(hContext,csTag,csTmp);
				PutField_CString(hContext,"org_txn_seq",csOrgTxnId);
				PutField_CString(hOrgTxn,"txn_seq",csOrgTxnId);
				PutField_CString(hTxn,"txn_id",csOrgTxnId);
DEBUGLOG(("GetDetail::txn_id = [%s]\n",csOrgTxnId));

DEBUGLOG(("GetDetail::call DBOLTransaction::GetTxnIdForUpdateNoWait()\n"));
				DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnIdForUpdateNoWait");
				iTmpRet = (unsigned long)(*DBObjPtr)(csOrgTxnId);
				if (iTmpRet != PD_OK) {
DEBUGLOG(("GetDetail::call DBOLTransaction::GetTxnIdForUpdateNoWait() failed\n"));
					iRet = INT_ERR;
                			PutField_Int(hContext,"internal_error",iRet);
					TxnAbort();
					i = 0;
					break;
				}
			}
			if (GetField_CString(hRec, "upload_txn_seq", &csTmp)) {
				//sprintf(csTag, "upload_txn_id_%d", i);
				PutField_CString(hUploadTxn,"txn_seq",csTmp);
DEBUGLOG(("GetDetail::upload_txn_id = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "txn_country", &csTmp)) {
				sprintf(csTag, "txn_country_%d", i);
				PutField_CString(hRequest,csTag,csTmp);
				//PutField_CString(hContext,"org_txn_country",csTmp);
DEBUGLOG(("GetDetail::txn_country = [%s]\n",csTmp));
			}
			if (GetField_CString(hRec, "payout_ccy", &csTmp)) {
				sprintf(csTag,"txn_ccy_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
				sprintf(csTag,"dst_txn_ccy_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
				//PutField_CString(hContext,"org_psp_txn_ccy",csTmp);
			}
			if(GetField_Double(hRec,"payout_amount",&dTmp)){
				sprintf(csTag, "gen_payout_amt_%d", i);
				PutField_Double(hRequest,csTag,dTmp);
				sprintf(csTag, "unique_amount_%d", i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetDetail::payout_amount = [%lf]\n",dTmp));
			}
			if (GetField_CString(hRec, "psp_id", &csPspId)) {
				sprintf(csTag,"psp_id_%d",i);
				PutField_CString(hRequest,csTag,csPspId);
				if (iVersionNo != 1) {
					if(i==0){
						hash_t *hPsp;
						hPsp = (hash_t*) malloc (sizeof(hash_t));
						hash_init(hPsp,0);
						DBObjPtr = CreateObj(DBPtr,"DBOLPspDetail","GetPayoutTmpAcct");
						if (!(*DBObjPtr)(csPspId, hPsp)) {
							if (GetField_CString(hPsp,"client_id",&csClient)) {
								PutField_CString(hRequest,"client_id",csClient);
DEBUGLOG(("GetDetail:: GetPspDetail - client id = [%s]\n",csClient));
							}
							if (GetField_CString(hPsp,"baid",&csBaid)) {
								sprintf(csTag,"baid_%d",i);
								PutField_CString(hRequest,csTag,csBaid);
DEBUGLOG(("GetDetail:: GetPspDetail - baid = [%s]\n",csBaid));
							}
						}
						FREE_ME(hPsp);
					}

					sprintf(csTag,"baid_%d",i);
					PutField_CString(hRequest,csTag,csBaid);
				}
			}
			if (GetField_CString(hRec, "file_name", &csTmp)) {
			}
			if (GetField_Int(hRec, "total_cnt", &iTmp)) {
				//PutField_Int(hContext,"total_count",iTmp);
			}
			if (GetField_Double(hRec, "total_amt", &dTmp)) {
			}
			if (GetField_CString(hRec, "gen_id", &csGenId)) {
DEBUGLOG(("GetDetail:: gen_id = [%s]\n", csGenId));
			}
		  if (iVersionNo != 1) {

			hash_init(hOrgRec,0);
			DBObjPtr = CreateObj(DBPtr,"DBOLTxnPspDetail","GetTxnPspDetail");
			iRet = (unsigned long)(*DBObjPtr)(csGenId,hOrgRec);
			if(iRet==PD_OK){
				/*
				   if(GetField_Double(hOrgRec,"service_fee",&dTmp)){
				   sprintf(csTag,"precal_fee_%d",i);
				   PutField_Double(hRequest,csTag,dTmp);
				   }
				   */
				if(GetField_Int(hOrgRec,"charge_rule_id",&iTmp)){
					sprintf(csTag,"charge_rule_id_%d",i);
					PutField_Int(hRequest,csTag,iTmp);
				}
				if(GetField_Double(hOrgRec,"pre_cal_charge",&dTmp)){
					sprintf(csTag,"precal_charge_%d",i);
					PutField_Double(hRequest,csTag,dTmp);
				}
				if(GetField_Char(hOrgRec,"charge_period_type",&cTmp)){
					sprintf(csTag,"charge_period_type_%d",i);
					PutField_Char(hRequest,csTag,cTmp);
				}

				if (GetField_CString(hOrgRec, "grp_tracking_txn_seq", &csTmp)) {
					sprintf(csTag, "grp_tracking_txn_seq_%d", i);
					PutField_CString(hRequest, csTag, csTmp);
				}
				if (GetField_CString(hOrgRec, "tracking_txn_seq", &csTmp)) {
					sprintf(csTag, "tracking_txn_seq_%d", i);
					PutField_CString(hRequest, csTag, csTmp);
				}

			}
			hash_destroy(hOrgRec);

			if(iRet==PD_OK){			
				PutField_CString(hContext,"process_type","0000");
				PutField_CString(hContext,"process_code","000000");
				PutField_CString(hContext,"txn_code",PD_OL_PAYOUT_CANCEL_PSP);
				PutField_Int(hContext,"do_logging",PD_TRUE);
				PutField_Int(hContext,"db_commit",PD_FALSE);
DEBUGLOG(("GetDetail::Call OMTChannel:AddTxnLog\n"));
				ChannelObjPtr = CreateObj(ChannelPtr,"OMTChannel","AddTxnLog");
				if((unsigned long) ((*ChannelObjPtr)(hContext,hRequest))!=PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("GetDetail::OMTChannel:AddTxnLog Failed\n"));
				}
				PutField_Int(hContext,"do_logging",PD_FALSE);
			}

		  }

			if(iRet==PD_OK){
				PutField_CString(hUploadTxn,"sub_status",PD_APPROVED_FOR_GENERATED);
DEBUGLOG(("GetDetail::Call DBOLTransaction:Update (UploadTxn)\n"));
				DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Update");
				if((unsigned long) ((*DBObjPtr)(hUploadTxn))!=PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("GetDetail::DBOLTransaction:Update Failed\n"));
				}
			}
			if(iRet==PD_OK){
				PutField_CString(hOrgTxn,"sub_status",PD_VOID);
				PutField_Char(hOrgTxn,"status",PD_REVERSED);
				//PutField_Char(hOrgTxn,"status",PD_COMPLETE);
				//PutField_Char(hOrgTxn,"ar_ind",PD_REJECT);
DEBUGLOG(("GetDetail::Call DBOLTransaction:Update (OrgTxn)\n"));
				DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Update");
				if((unsigned long) ((*DBObjPtr)(hOrgTxn))!=PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("GetDetail::DBOLTransaction:Update Failed\n"));
				}
			}
			if (iVersionNo != 1) {
				if(iRet==PD_OK){
					PutField_CString(hRequest,"org_txn_code",PD_OL_PAYOUT_GENERATE);
					PutField_Int(hRequest,"return_pspfee",PD_TRUE);
					BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","VoidOrgTxnElements");
					iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("GetDetail:: VoidOrgTxnElements iRet = [%d]\n",iRet));
				}
			}

			if(iRet==PD_OK){
				PutField_CString(hTxn,"txn_id",csGenId);
				PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_CANCELLED);
				DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileDT","UpdateByGenId");
				if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
					iRet=INT_ERR;
DEBUGLOG(("GetDetail::DBOLPayoutGeneratedFileDT Update Failed!!!\n"));
ERRLOG("BOOLPayout::GetDetail:DBOLPayoutGeneratedFileDT Update Failed!!!\n");
				}
			}

			i++;
			PutField_Int(hContext,"total_cnt",i);
			hRec = RecordSet_GetNext(rRecordSet);
		}

		if(i!=0){
DEBUGLOG(("Call DBOLMerchantUploadFileDetail to Resume FileId[%s]\n",csFileId));
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","ResumeGeneratedFile");
			iRet = (unsigned long)(*DBObjPtr)(csFileId,csUser);

			if(iRet == PD_OK){
DEBUGLOG(("Call DBOLPayoutRequest to Resume FileId[%s]\n",csFileId));
				DBObjPtr = CreateObj(DBPtr,"DBOLPayoutRequest","ResumeGeneratedFile");
				iRet = (unsigned long)(*DBObjPtr)(csFileId,csUser);
			}

			if(iRet==PD_OK){
DEBUGLOG(("Call DBOLPayoutGeneratedFileHD:Update\n"));
				PutField_Int(hTxn,"status",PD_PAYOUTFILE_DECLINED);
				DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Update");
				iRet = (unsigned long)(*DBObjPtr)(hTxn);
			}
		}
	}

	if((iChk==PD_FOUND) && (iRet==PD_OK) && (iVersionNo != 1)){
		PutField_CString(hContext,"sub_status",PD_REFUND_APPROVED);
		PutField_Char(hContext,"response_mode",PD_REVERSED);
		PutField_CString(hContext,"desc","Offline Payout Cancel(PSP)");
		PutField_Char(hContext,"party_type",PD_TYPE_PSP);
		if(GetField_CString(hContext,"PHDATE",&csTmp)){
			PutField_CString(hContext,"approval_date",csTmp);
		}

		if(HandlePayoutBalance(hContext,hRequest)!=PD_OK){
DEBUGLOG(("HandleCancelGenerate::HandlePayoutBalance Failed!!!\n"));
ERRLOG("BOOLPayout::HandleCancelGenerate:HandlePayoutBalance Failed!!!\n");
			iRet = INT_ERR;
		}
	}

	if(iChk!=PD_FOUND){
		iRet = INT_NO_PENDING_RECORD;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("HandleCancelGenerate::No record to cancel!!!\n"));
	}

	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);
	FREE_ME(hOrgTxn);
	FREE_ME(hUploadTxn);
	FREE_ME(hOrgRec);

DEBUGLOG(("HandleCancelGenerate: iRet[%d]\n", iRet));
	return iRet;
}

int GenerateBatchSeq(hash_t* hRequest)
{
	int	iRet=PD_OK;
	int	iCnt=0;
	int	i=0;
	char	*csTxnSeq;
	char	csTag[PD_TAG_LEN +1];

	if(GetField_Int(hRequest,"total_cnt",&iCnt)){
		for(i=0; i<iCnt; i++){
			DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextBatchTxnSeq");
			sprintf(csTag,"txn_seq_%d",i);
			csTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("GenerateBatchSeq: [%d]=[%s]\n",i,csTxnSeq));
			PutField_CString(hRequest,csTag,csTxnSeq);

			FREE_ME(csTxnSeq);
		}
	}
	return iRet;
}



int AddTxnLog(hash_t *hContext, hash_t *hRequest)
{
	int iRet= PD_OK;
	int i= 0;
	int iCnt= 0;
	char	*csTmp;
	char	*csTxnCode;
	double	dTmp;
	char	cPartyType;
	char	csTag[PD_TAG_LEN+1];
	char	csTxnDateTime[PD_DATETIME_LEN+1];
	hash_t	*hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	if (GetField_Char(hContext,"party_type",&cPartyType)) {
DEBUGLOG(("AddTxnLog:: party_type = [%c]\n",cPartyType));
	}
	if (GetField_CString(hContext,"channel_code",&csTmp)) {
DEBUGLOG(("AddTxnLog:: channel_code = [%s]\n",csTmp));
		PutField_CString(hTxn,"channel_code",csTmp);
	}
	if (GetField_CString(hContext,"txn_code",&csTxnCode)) {
DEBUGLOG(("AddTxnLog:: txn_code = [%s]\n",csTxnCode));
		PutField_CString(hTxn,"txn_code",csTxnCode);
	}

	if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("AddTxnLog:: host_posting_date = [%s]\n",csTmp));
		PutField_CString(hTxn,"host_posting_date",csTmp);
		PutField_CString(hTxn,"txn_date",csTmp);
	}
	if (GetField_CString(hContext,"local_tm_date",&csTmp)) {
DEBUGLOG(("AddTxnLog:: local_tm_date = [%s]\n",csTmp));
		PutField_CString(hTxn,"local_tm_date",csTmp);
		PutField_CString(hTxn,"tm_date",csTmp);
		strcpy(csTxnDateTime,csTmp);
	}
	if (GetField_CString(hContext,"local_tm_time",&csTmp)) {
DEBUGLOG(("AddTxnLog:: local_tm_time = [%s]\n",csTmp));
		PutField_CString(hTxn,"local_tm_time",csTmp);
		PutField_CString(hTxn,"tm_time",csTmp);
		strcat(csTxnDateTime,csTmp);
		csTxnDateTime[strlen(csTxnDateTime)]='\0';
	}
	PutField_CString(hTxn,"transmission_datetime",csTxnDateTime);

	if (GetField_CString(hContext,"add_user",&csTmp)) {
DEBUGLOG(("AddTxnLog:: add_user = [%s]\n",csTmp));
		PutField_CString(hTxn,"add_user",csTmp);
	}
	else{
		PutField_CString(hTxn,"add_user",PD_UPDATE_USER);
	}

	if(cPartyType==PD_TYPE_PSP){
		if(GetField_CString(hContext,"psp_client_id",&csTmp)){
			PutField_CString(hTxn,"client_id",csTmp);
		}
	}

	if (GetField_CString(hContext,"remark",&csTmp)) {
DEBUGLOG(("AddTxnLog:: remark = [%s]\n",csTmp));
                PutField_CString(hTxn,"remark",csTmp);
        }

	PutField_CString(hTxn,"process_type","0000");
	PutField_CString(hTxn,"process_code","000000");

	if(GetField_Int(hContext,"total_cnt",&iCnt)){
DEBUGLOG(("AddTxnLog:: total_cnt = [%d]\n",iCnt));
	}

	for(i=0; i<iCnt; i++){
		sprintf(csTag,"txn_seq_%d",i);
		if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_seq = [%s]\n",csTmp));
			PutField_CString(hTxn,"txn_seq",csTmp);
		}
		sprintf(csTag,"org_txn_id_%d",i);
		if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("AddTxnLog:: org_txn_seq = [%s]\n",csTmp));
			PutField_CString(hTxn,"org_txn_seq",csTmp);
		}

		sprintf(csTag,"merchant_id_%d",i);
		if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("AddTxnLog:: merchant_id = [%s]\n",csTmp));
			PutField_CString(hTxn,"merchant_id",csTmp);
		}

		sprintf(csTag,"merchant_ref_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("AddTxnLog:: merchant_ref = [%s]\n",csTmp));
			PutField_CString(hTxn,"merchant_ref",csTmp);
		}

		sprintf(csTag,"service_code_%d",i);
		if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("AddTxnLog:: service_code = [%s]\n",csTmp));
			PutField_CString(hTxn,"service_code",csTmp);
		}

		sprintf(csTag,"merchant_client_id_%d",i);
		if(GetField_CString(hContext,csTag,&csTmp)){
			PutField_CString(hTxn,"client_id",csTmp);
		}
		else{
			sprintf(csTag,"psp_client_id_%d",i);
			 if(GetField_CString(hContext,csTag,&csTmp))
				PutField_CString(hTxn,"client_id",csTmp);
		}

		if(cPartyType==PD_TYPE_MERCHANT){
			sprintf(csTag,"txn_amt_%d",i);
			if(GetField_Double(hRequest,csTag,&dTmp)){
				PutField_Double(hTxn,"txn_amt",dTmp);
DEBUGLOG(("AddTxnLog:: txn_amt = [%lf]\n",dTmp));
			}
		}
		else{
			sprintf(csTag,"payout_amt_%d",i);
			if(GetField_Double(hRequest,csTag,&dTmp)){
				PutField_Double(hTxn,"txn_amt",dTmp);
DEBUGLOG(("AddTxnLog:: txn_amt = [%lf]\n",dTmp));
			}
		}

		PutField_Char(hTxn,"status",PD_PROCESSING);

		DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Add");
		iRet = (unsigned long) ((*DBObjPtr)(hTxn));

	}

	FREE_ME(hTxn);
	return iRet;
}

int UpdateTxnLog(hash_t *hContext)
{
	int iRet= PD_OK;
	//int i= 0;
	//int iCnt= 0;
	int	iTmp = 0;
	char	*csTmp;
	double	dTmp;
	char	cPartyType;
	char	cTmp;
	//char	csTag[PD_TAG_LEN+1];
	hash_t	*hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	if (GetField_Char(hContext,"party_type",&cPartyType)) {
DEBUGLOG(("UpdateTxnLog:: party_type = [%c]\n",cPartyType));
	}

	if (GetField_CString(hContext,"desc",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: desc = [%s]\n",csTmp));
		PutField_CString(hTxn,"desc",csTmp);
	}

	if (GetField_CString(hContext,"approval_date",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: approval_date = [%s]\n",csTmp));
                PutField_CString(hTxn,"approval_date",csTmp);
        }
	if (GetField_CString(hContext,"approval_timestamp",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: approval_timestamp= [%s]\n",csTmp));
		PutField_CString(hTxn,"approval_timestamp",csTmp);
	}

	if (GetField_CString(hContext,"add_user",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: add_user = [%s]\n",csTmp));
		PutField_CString(hTxn,"add_user",csTmp);
		PutField_CString(hTxn,"update_user",csTmp);
	}
	else{
		PutField_CString(hTxn,"add_user",PD_UPDATE_USER);
	}

	if (GetField_CString(hContext,"remark",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: remark = [%s]\n",csTmp));
                PutField_CString(hTxn,"remark",csTmp);
        }

	if (GetField_CString(hContext,"sub_status",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: sub_status = [%s]\n",csTmp));
                PutField_CString(hTxn,"sub_status",csTmp);
        }

	if (GetField_Char(hContext,"recon_status",&cTmp)) {
DEBUGLOG(("UpdateTxnLog:: recon_status = [%c]\n",cTmp));
                PutField_Char(hTxn,"recon_status",cTmp);
        }

	if (GetField_CString(hContext,"txn_id",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_seq = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_seq",csTmp);
	}
	if (GetField_CString(hContext,"org_txn_id",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: org_txn_seq = [%s]\n",csTmp));
		PutField_CString(hTxn,"org_txn_seq",csTmp);
	}

	if(GetField_CString(hContext,"merchant_client_id",&csTmp)){
		PutField_CString(hTxn,"client_id",csTmp);
	}
	else{
		if(GetField_CString(hContext,"psp_client_id",&csTmp))
			PutField_CString(hTxn,"client_id",csTmp);
	}

	if(GetField_Double(hContext,"unique_amount",&dTmp)){
		PutField_Double(hTxn,"display_amt",dTmp);
DEBUGLOG(("UpdateTxnLog:: display_amt = [%f]\n",dTmp));
	}

//txn_detail
	if (GetField_CString(hContext,"bank_name",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: bank_name = [%s]\n",csTmp));
		PutField_CString(hTxn,"bank_name",csTmp);
	}
	if (GetField_CString(hContext,"branch",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: branch = [%s]\n",csTmp));
		PutField_CString(hTxn,"branch_name",csTmp);
	}
	if (GetField_CString(hContext,"account_id",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: account_id = [%s]\n",csTmp));
		PutField_CString(hTxn,"account_id",csTmp);
	}
	if (GetField_CString(hContext,"account_name",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: account_name = [%s]\n",csTmp));
		PutField_CString(hTxn,"account_name",csTmp);
	}
	if (GetField_CString(hContext,"txn_ccy",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_ccy = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_ccy",csTmp);
	}
	if (GetField_CString(hContext,"txn_country",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_country = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_country",csTmp);
	}

	if(GetField_Double(hContext,"merchant_open_bal",&dTmp)){
		PutField_Double(hTxn,"open_bal",dTmp);
DEBUGLOG(("UpdateTxnLog:: open_bal= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"merchant_open_bal_settlement",&dTmp)){
		PutField_Double(hTxn,"open_bal_settlement",dTmp);
DEBUGLOG(("UpdateTxnLog:: open_bal_settlement= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"current_bal",&dTmp)){
		PutField_Double(hTxn,"current_bal",dTmp);
DEBUGLOG(("UpdateTxnLog:: current_bal= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"current_bal_settlement",&dTmp)){
		PutField_Double(hTxn,"current_bal_settlement",dTmp);
DEBUGLOG(("UpdateTxnLog:: current_bal_settlement= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_float",&dTmp)){
		PutField_Double(hTxn,"total_float",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_float= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_float_after_payout",&dTmp)){
		PutField_Double(hTxn,"total_float_after_payout",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_float_after_payout= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_float_settlement",&dTmp)){
		PutField_Double(hTxn,"total_float_settlement",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_float_settlement= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_reserved_amount",&dTmp)){
		PutField_Double(hTxn,"total_reserved_amount",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_reserved_amount= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_hold",&dTmp)){
		PutField_Double(hTxn,"total_hold",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_hold= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"total_hold_settlement",&dTmp)){
		PutField_Double(hTxn,"total_hold_settlement",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_hold_settlement= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"fundin_payout",&dTmp)){
		PutField_Double(hTxn,"fundin_payout",dTmp);
DEBUGLOG(("UpdateTxnLog:: fundin_payout= [%f]\n",dTmp));
	}
	if(GetField_Double(hContext,"reserved_payout",&dTmp)){
		PutField_Double(hTxn,"reserved_payout",dTmp);
DEBUGLOG(("UpdateTxnLog:: reserved_payout= [%f]\n",dTmp));
	}

	if(cPartyType==PD_TYPE_MERCHANT){
		if(GetField_Double(hContext,"txn_amt",&dTmp)){
			PutField_Double(hTxn,"txn_amt",dTmp);
DEBUGLOG(("UpdateTxnLog:: txn_amt = [%lf]\n",dTmp));
		}
		if(GetField_Double(hContext,"net_amt",&dTmp)){
			PutField_Double(hTxn,"net_amt",dTmp);
DEBUGLOG(("UpdateTxnLog:: net_amt = [%lf]\n",dTmp));
		}
	}

//Txn Psp Detail
	if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_date = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_date",csTmp);
		PutField_CString(hTxn,"report_date",csTmp);
	}

	if (GetField_CString(hContext,"report_date",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: report_date = [%s]\n",csTmp));
		PutField_CString(hTxn,"report_date",csTmp);
	}

	if (GetField_CString(hContext,"org_psp_id",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: psp_id = [%s]\n",csTmp));
		PutField_CString(hTxn,"psp_id",csTmp);
	}

	if (GetField_CString(hContext,"org_baid",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: baid = [%s]\n",csTmp));
		PutField_CString(hTxn,"baid",csTmp);
	}


	if (GetField_CString(hContext,"org_psp_txn_ccy",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_ccy = [%s]\n",csTmp));
		PutField_CString(hTxn,"txn_ccy",csTmp);
		PutField_CString(hTxn,"net_ccy",csTmp);
	}
	
	if(GetField_Double(hContext,"org_dst_net_amt",&dTmp)){
		PutField_Double(hTxn,"txn_amt",dTmp);
		PutField_Double(hTxn,"net_amt",dTmp);
		PutField_Double(hTxn,"txn_amount",dTmp);
DEBUGLOG(("UpdateTxnLog:: txn_amt = [%lf]\n",dTmp));
	}
/*
	if(GetField_Double(hContext,"precal_fee",&dTmp)){
		PutField_Double(hTxn,"service_fee",dTmp);
		PutField_Double(hTxn,"cost",dTmp);
DEBUGLOG(("UpdateTxnLog:: service_fee = [%lf]\n",dTmp));
	}
*/
	if(GetField_Char(hContext,"ex_supplier",&cTmp)){
		PutField_Char(hTxn,"ex_supplier",cTmp);
	}

	if(GetField_Double(hContext,"ex_rate",&dTmp)){
		PutField_Double(hTxn,"ex_rate",dTmp);
	}


	PutField_Char(hTxn,"status",PD_COMPLETE);
	PutField_Char(hTxn,"ar_ind",PD_ACCEPT);
	PutField_Int(hTxn,"internal_code",PD_OK);
	PutField_CString(hTxn,"response_code","0");

	DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Update");
	iRet = (unsigned long) ((*DBObjPtr)(hTxn));

	if(iRet == PD_OK){
DEBUGLOG(("UpdateTxnLog::Call DBOLTransaction:AddDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","AddDetail");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("UpdateTxnLog::DBOLTransaction:AddDetail Failed\n"));
		}
	}

	if(iRet==PD_OK){
DEBUGLOG(("UpdateTxnLog::Call DBOLTransaction:UpdateDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","UpdateDetail");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("UpdateTxnLog::DBTransaction:UpdateDetail Failed\n"));
		}
	}

	if(iRet == PD_OK && cPartyType!=PD_TYPE_MERCHANT){
DEBUGLOG(("UpdateTxnLog::Call DBOLTxnPspDetail:Add\n"));
		if(GetField_CString(hContext,"psp_date",&csTmp)){
			PutField_CString(hTxn,"txn_date",csTmp);//if input psp_date, overwrite PHDATE
		}
		if(GetField_CString(hContext,"local_tm_time",&csTmp)){
			PutField_CString(hTxn,"txn_time",csTmp);
		}
		if(GetField_CString(hContext,"to_bank_code",&csTmp)){
			PutField_CString(hTxn,"bank_code",csTmp);
		}

		DBObjPtr = CreateObj(DBPtr,"DBOLTxnPspDetail","Add");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("UpdateTxnLog::DBOLTxnPspDetail:Add Failed\n"));
		}
	}

	if(iRet==PD_OK && cPartyType!=PD_TYPE_MERCHANT){
// psp_open_balance
	if (GetField_Double(hContext,"psp_open_bal",&dTmp)) {
		PutField_Double(hTxn,"open_bal",dTmp);
DEBUGLOG(("UpdateTxnLog:: psp_open_balance = [%f]\n",dTmp));
	}
// psp_balance
	if (GetField_Double(hContext,"psp_balance",&dTmp)) {
		PutField_Double(hTxn,"bal",dTmp);
DEBUGLOG(("UpdateTxnLog:: psp_balance = [%f]\n",dTmp));
	}
// psp_total_float
	if (GetField_Double(hContext,"psp_total_float",&dTmp)) {
		PutField_Double(hTxn,"total_float",dTmp);
DEBUGLOG(("UpdateTxnLog:: psp_total_float = [%f]\n",dTmp));
	}
// psp_total_hold
	if (GetField_Double(hContext,"psp_total_hold",&dTmp)) {
		PutField_Double(hTxn,"total_hold",dTmp);
DEBUGLOG(("UpdateTxnLog:: psp_total_hold = [%f]\n",dTmp));
	}

	if (GetField_Double(hContext,"prepaid",&dTmp)) {
		PutField_Double(hTxn,"prepaid",dTmp);
DEBUGLOG(("UpdateTxnLog:: prepaid = [%f]\n",dTmp));
	}

	if (GetField_Double(hContext,"open_in_transit",&dTmp)) {
		PutField_Double(hTxn,"open_in_transit",dTmp);
DEBUGLOG(("UpdateTxnLog:: open_in_transit = [%f]\n",dTmp));
	}

	if (GetField_Double(hContext,"in_transit",&dTmp)) {
		PutField_Double(hTxn,"in_transit",dTmp);
DEBUGLOG(("UpdateTxnLog:: in_transit = [%f]\n",dTmp));
	}

	if (GetField_Int(hContext,"charge_rule_id",&iTmp)) {
		PutField_Int(hTxn,"charge_rule_id",iTmp);
DEBUGLOG(("UpdateTxnLog:: charge_rule_id = [%d]\n",iTmp));
	}

	if (GetField_Char(hContext,"charge_period_type",&cTmp)) {
		PutField_Char(hTxn,"charge_period_type",cTmp);
DEBUGLOG(("UpdateTxnLog:: charge_period_type = [%c]\n",cTmp));
	}

	if (GetField_Double(hContext,"pre_cal_charge",&dTmp)) {
		PutField_Double(hTxn,"pre_cal_charge",dTmp);
DEBUGLOG(("UpdateTxnLog:: pre_cal_charge = [%f]\n",dTmp));
	}

	PutField_Int(hTxn,"charge_txn_created",PD_FALSE);

	if (GetField_CString(hContext, "grp_tracking_txn_seq", &csTmp)) {
		PutField_CString(hTxn, "grp_tracking_txn_seq", csTmp);
DEBUGLOG(("UpdateTxnLog:: grp_tracking_txn_seq = [%f]\n",dTmp));
	}

	if (GetField_CString(hContext, "tracking_txn_seq", &csTmp)) {
		PutField_CString(hTxn, "tracking_txn_seq", csTmp);
DEBUGLOG(("UpdateTxnLog:: tracking_txn_seq = [%f]\n",dTmp));
	}


DEBUGLOG(("UpdateTxnLog::Call DBOLTxnPspDetail:Update\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLTxnPspDetail","Update");
		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("UpdateTxnLog::DBOLTxnPspDetail:Update Failed\n"));
		}
	}


	FREE_ME(hTxn);
	return iRet;
}


int	HandlePayoutBalance(hash_t* hContext, hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iReturnFee = PD_FALSE;
	int	iCnt = 0;
	int	i = 0;
	int	iTmp = 0;
	double	dTmp = 0.0;
	double	dOrgFee=0.0;
	char	cTmp;
	char*	csTmp;
	char*	csTxnCode;
	char	csTag[PD_TAG_LEN+1];
	double	dRemainNetFloat = 0.0;
	double	dRemainResPo = 0.0;
	double	dFundIn = 0.0;
	double	dNetAmt = 0.0;
	hash_t	*hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	
	if(GetField_Char(hContext,"party_type",&cTmp)){
DEBUGLOG(("HandlePayoutBalance::party_type = [%c]\n",cTmp));
	}

	if(GetField_Char(hContext,"response_mode",&cTmp)){
DEBUGLOG(("HandlePayoutBalance::response_mode = [%c]\n",cTmp));
	}

	if(GetField_Int(hContext,"total_cnt",&iCnt)){
DEBUGLOG(("HandlePayoutBalance:: total_cnt = [%d]\n",iCnt));
	}

	if(GetField_CString(hRequest,"report_date",&csTmp)){
DEBUGLOG(("HandlePayoutBalance::report_date = [%s]\n",csTmp));
		PutField_CString(hContext,"report_date",csTmp);
	}

	if(GetField_CString(hContext,"txn_code",&csTxnCode)){
DEBUGLOG(("HandlePayoutBalance::txn_code = [%s]\n",csTxnCode));
	}

	if(!strcmp(csTxnCode,PD_PAYOUT_VOID_MERCHANT)){
		if(GetField_Int(hContext,"VPFEE",&iReturnFee)){
DEBUGLOG(("HandlePayoutBalance::return fee = [%d]\n",iReturnFee));
		}
	}
	else if(!strcmp(csTxnCode,PD_OL_PAYOUT_APPROVE)){
		if(GetField_Double(hContext,"merchant_net_float",&dTmp)){
			PutField_Double(hContext,"remain_merchant_net_float",dTmp);
DEBUGLOG(("HandlePayoutBalance::merchant_net_float = [%lf]\n",dTmp));
		}
		if(GetField_Double(hContext,"merchant_reserved_po",&dTmp)){
			PutField_Double(hContext,"remain_merchant_reserved_po",dTmp);
DEBUGLOG(("HandlePayoutBalance::merchant_reserved_po = [%lf]\n",dTmp));
		}
		if(GetField_Double(hContext,"merchant_fundin_po",&dFundIn)){
DEBUGLOG(("HandlePayoutBalance::merchant_fundin_po = [%lf]\n",dFundIn));
		}
	}

	for(i=0; i<iCnt; i++){
		if(!strcmp(csTxnCode,PD_OL_PAYOUT_APPROVE)){
			GetField_Double(hContext,"remain_merchant_net_float",&dRemainNetFloat);
DEBUGLOG(("HandlePayoutBalance::remain_merchant_net_float = [%lf]\n",dRemainNetFloat));
			GetField_Double(hContext,"remain_merchant_reserved_po",&dRemainResPo);
DEBUGLOG(("HandlePayoutBalance::remain_merchant_reserved_po = [%lf]\n",dRemainResPo));
		}

		sprintf(csTag,"txn_seq_%d",i);
		if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::txn_seq = [%s]\n",csTmp));
			PutField_CString(hContext,"txn_id",csTmp);
		}
		sprintf(csTag,"bank_name_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
			PutField_CString(hContext,"bank_name",csTmp);
		}
		sprintf(csTag,"branch_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
			PutField_CString(hContext,"branch",csTmp);
		}
		sprintf(csTag,"account_id_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
			PutField_CString(hContext,"account_id",csTmp);
		}
		sprintf(csTag,"account_name_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
			PutField_CString(hContext,"account_name",csTmp);
		}
		sprintf(csTag,"txn_ccy_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::txn_ccy = [%s]\n",csTmp));
			PutField_CString(hContext,"org_txn_ccy",csTmp);
			PutField_CString(hContext,"txn_ccy",csTmp);
		}
		sprintf(csTag,"txn_country_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::txn_country = [%s]\n",csTmp));
			PutField_CString(hContext,"org_txn_country",csTmp);
			PutField_CString(hContext,"txn_country",csTmp);
		}
		sprintf(csTag,"merchant_id_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::merchant_id = [%s]\n",csTmp));
			PutField_CString(hContext,"org_merchant_id",csTmp);
		}
		sprintf(csTag,"service_code_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::service_code = [%s]\n",csTmp));
			PutField_CString(hContext,"org_service_code",csTmp);
		}
		sprintf(csTag,"psp_id_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::psp_id = [%s]\n",csTmp));
			PutField_CString(hContext,"org_psp_id",csTmp);
		}
		sprintf(csTag,"baid_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::baid = [%s]\n",csTmp));
			PutField_CString(hContext,"org_baid",csTmp);
		}
		sprintf(csTag,"dst_txn_ccy_%d",i);
		if (GetField_CString(hRequest,csTag,&csTmp)) {
DEBUGLOG(("HandlePayoutBalance::dst_txn_ccy = [%s]\n",csTmp));
			PutField_CString(hContext,"org_psp_txn_ccy",csTmp);
		}
		sprintf(csTag,"org_merchant_fee_%d",i);
		if (GetField_Double(hRequest,csTag,&dOrgFee)) {
DEBUGLOG(("HandlePayoutBalance::org_merchant_fee = [%lf]\n",dOrgFee));
		}
		sprintf(csTag,"net_amt_%d",i);
		if (GetField_Double(hRequest,csTag,&dNetAmt)) {
DEBUGLOG(("HandlePayoutBalance::net_amt(merchant) = [%lf]\n",dNetAmt));
			if(iReturnFee==PD_TRUE)
				PutField_Double(hContext,"net_amt",dNetAmt+dOrgFee);
			else
				PutField_Double(hContext,"net_amt",dNetAmt);

			if(!strcmp(csTxnCode,PD_OL_PAYOUT_APPROVE)){
				RemoveField_Double(hContext,"deduct_fundin_po");
				RemoveField_Double(hContext,"deduct_reserved_po");

				if(dRemainNetFloat>0.0){
					if((dRemainNetFloat-dNetAmt)>=0.0){
						dRemainNetFloat = dRemainNetFloat-dNetAmt;
						PutField_Double(hContext,"remain_merchant_net_float",dRemainNetFloat);
DEBUGLOG(("HandlePayoutBalance:: deduct merchant net float only = [%lf]\n",dNetAmt));
						dNetAmt = 0.0;
					}
					else{
DEBUGLOG(("HandlePayoutBalance:: deduct all remaining merchant net float = [%lf]\n",dRemainNetFloat));
						dNetAmt = dNetAmt - dRemainNetFloat;
						PutField_Double(hContext,"remain_merchant_net_float",0.0);
						dRemainNetFloat = 0.0;
					}
				}
				
				if((dNetAmt>0.0) && (dRemainResPo>0.0)&& (dRemainNetFloat==0.0)){
					if((dRemainResPo-dNetAmt)>=0.0){
						dRemainResPo = dRemainResPo-dNetAmt;
						PutField_Double(hContext,"remain_merchant_reserved_po",dRemainResPo);
						PutField_Double(hContext,"deduct_reserved_po",dNetAmt);
DEBUGLOG(("HandlePayoutBalance:: deduct merchant reserved payout = [%lf]\n",dNetAmt));
						dNetAmt = 0.0;
					}
					else{
DEBUGLOG(("HandlePayoutBalance:: deduct all remaining merchant reserved payout = [%lf]\n",dRemainResPo));
						dNetAmt = dNetAmt - dRemainResPo;
						PutField_Double(hContext,"deduct_reserved_po",dRemainResPo);
						PutField_Double(hContext,"remain_merchant_reserved_po",0.0);
						dRemainResPo = 0.0;
					}
				}

				if((dNetAmt>0.0) && (dFundIn>0.0) && (dRemainResPo==0.0) && (dRemainNetFloat==0.0)){
					PutField_Double(hContext,"deduct_fundin_po",dNetAmt);
DEBUGLOG(("HandlePayoutBalance:: deduct merchant FundIn payout = [%lf]\n",dNetAmt));
					dNetAmt = 0.0;
				}
				
			}
		}
		sprintf(csTag,"payout_amt_%d",i);
		if (GetField_Double(hRequest,csTag,&dTmp)) {
DEBUGLOG(("HandlePayoutBalance::txn_amt(psp) = [%lf]\n",dTmp));
			PutField_Double(hContext,"org_dst_net_amt",dTmp);
		}
		else{
			sprintf(csTag,"gen_payout_amt_%d",i);
			if (GetField_Double(hRequest,csTag,&dTmp)) {
DEBUGLOG(("HandlePayoutBalance::txn_amt(psp) = [%lf]\n",dTmp));
				PutField_Double(hContext,"org_dst_net_amt",dTmp);
			}
		}
/*
		sprintf(csTag,"precal_fee_%d",i);
		if (GetField_Double(hRequest,csTag,&dTmp)) {
DEBUGLOG(("HandlePayoutBalance::precal_fee = [%lf]\n",dTmp));
			PutField_Double(hContext,"precal_fee",dTmp);
		}
*/
		sprintf(csTag,"charge_rule_id_%d",i);
		if (GetField_Int(hRequest,csTag,&iTmp)) {
DEBUGLOG(("HandlePayoutBalance::charge_rule_id = [%d]\n",iTmp));
			PutField_Int(hContext,"charge_rule_id",iTmp);
		}
		sprintf(csTag,"precal_charge_%d",i);
		if (GetField_Double(hRequest,csTag,&dTmp)) {
DEBUGLOG(("HandlePayoutBalance::precal_charge = [%lf]\n",dTmp));
			PutField_Double(hContext,"pre_cal_charge",dTmp);
		}
		sprintf(csTag,"charge_period_type_%d",i);
		if (GetField_Char(hRequest,csTag,&cTmp)) {
DEBUGLOG(("HandlePayoutBalance::charge_period_type = [%c]\n",cTmp));
			PutField_Char(hContext,"charge_period_type",cTmp);
		}
		PutField_Int(hContext,"charge_txn_created",PD_FALSE);


		sprintf(csTag, "grp_tracking_txn_seq_%d", i);
		if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("HandlePayoutBalance::grp_tracking_txn_seq = [%s]\n", csTmp));
			PutField_CString(hContext, "grp_tracking_txn_seq", csTmp);
		}
		sprintf(csTag, "tracking_txn_seq_%d", i);
		if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("HandlePayoutBalance::tracking_txn_seq = [%s]\n", csTmp));
			PutField_CString(hContext, "tracking_txn_seq", csTmp);
		}

		sprintf(csTag, "unique_amount_%d", i);
		if (GetField_Double(hRequest, csTag, &dTmp)) {
DEBUGLOG(("HandlePayoutBalance::unique_amount = [%lf]\n", dTmp));
			PutField_Double(hContext, "unique_amount", dTmp);
		}


DEBUGLOG(("HandlePayoutBalance::Call BOOLBalance:UpdatePayoutAmount\n"));
		BOObjPtr = CreateObj(BOPtr,"BOOLBalance","UpdatePayoutAmount");
		if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("HandlePayoutBalance::BOOLBalance:UpdatePayoutAmount Failed\n"));
			iRet = INT_ERR;
		}
		else{
			iRet = UpdateTxnLog(hContext);
			if(iRet!=PD_OK){
DEBUGLOG(("HandlePayoutBalance::BOBalance:UpdateTxnLog Failed\n"));
				break;
			}
			else{
				TxnCommit();
			}
		}
		if(iRet!=PD_OK){
DEBUGLOG(("HandlePayoutBalance::BOBalance:HandlePayoutBalance Failed\n"));
			break;
		}
	}

	FREE_ME(hTxn);
	return iRet;
}



int UpdateDetailByTxn(hash_t *hContext,
			hash_t* hRequest)
{
	int     iRet = PD_OK;
	int	iTmp = 0;
	int	iSeqNum = 0;
	char	*csBatchId;
	char	*csTmp;
	double	dTmp;

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	
	if (GetField_CString(hContext,"batch_id",&csBatchId)){
DEBUGLOG(("BOOLPayout::UpdateDetailByTxn for batch[%s]\n",csBatchId));
	}

	if (GetField_Int(hContext,"seq_num",&iSeqNum)){
DEBUGLOG(("BOOLPayout::UpdateDetailByTxn for seq_num[%d]\n",iSeqNum));
	}

	if (GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hTxn,"update_user",csTmp);
	}
	
	if (GetField_CString(hContext,"txn_seq",&csTmp)){
		PutField_CString(hTxn,"txn_seq",csTmp);
DEBUGLOG(("BOOLPayout::UpdateDetailByTxn txn_seq[%s]\n",csTmp));
	}

	if (GetField_CString(hContext,"aux_txn_seq",&csTmp)){
		PutField_CString(hTxn,"aux_txn_seq",csTmp);
DEBUGLOG(("BOOLPayout::UpdateDetailByTxn aux_txn_seq[%s]\n",csTmp));
	}

	if(GetField_Int(hContext,"approve_id",&iTmp)){
		PutField_Int(hTxn,"approve_id",iTmp);
DEBUGLOG(("BOOLPayout::UpdateDetailByTxn approve_id[%d]\n",iTmp));
	}

	if(GetField_Double(hContext,"dst_net_amt",&dTmp)){
	//if(GetField_Double(hContext,"payout_amt",&dTmp)){
		PutField_Double(hTxn,"payout_amt",dTmp);
DEBUGLOG(("BOOLPayout::UpdateDetailByTxn payout_amt[%lf]\n",dTmp));
	}

	if(GetField_CString(hContext,"src_txn_fee_ccy",&csTmp)){
		PutField_CString(hTxn,"merchant_fee_ccy",csTmp);
DEBUGLOG(("BOOLPayout::UpdateDetailByTxn merchant_fee_ccy[%s]\n",csTmp));
	}

	if(GetField_Double(hContext,"src_txn_fee",&dTmp)){
		PutField_Double(hTxn,"merchant_fee",dTmp);
DEBUGLOG(("BOOLPayout::UpdateDetailByTxn merchant_fee[%lf]\n",dTmp));
	}

	if(GetField_CString(hContext,"dst_txn_fee_ccy",&csTmp)){
		PutField_CString(hTxn,"member_fee_ccy",csTmp);
DEBUGLOG(("BOOLPayout::UpdateDetailByTxn member_fee_ccy[%s]\n",csTmp));
	}

	if(GetField_Double(hContext,"dst_txn_fee",&dTmp)){
		PutField_Double(hTxn,"member_fee",dTmp);
DEBUGLOG(("BOOLPayout::UpdateDetailByTxn member_fee[%lf]\n",dTmp));
	}

	if(GetField_CString(hContext,"markup_ccy",&csTmp)){
		PutField_CString(hTxn,"markup_ccy",csTmp);
	}
	
	if(GetField_Double(hContext,"markup_amt",&dTmp)){
		PutField_Double(hTxn,"markup_amt",dTmp);
	}

	if(GetField_Double(hContext,"ex_rate",&dTmp)){
		PutField_Double(hTxn,"ex_rate",dTmp);
	}

	if (GetField_Int(hContext,"status",&iTmp)){
		PutField_Int(hTxn,"status",iTmp);
DEBUGLOG(("BOOLPayout::UpdateDetailByTxn status[%d]\n",iTmp));
	}

	DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","UpdateDetailByBatchId");
	if ((*DBObjPtr)(csBatchId,iSeqNum,hTxn) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOOLPayout::DBOLMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
	}

DEBUGLOG(("BOOLPayout:UpdateDetailByTxn iRet=[%d]\n",iRet));
	FREE_ME(hTxn);
	return  iRet;
}
//
int HandleCancelUpload(hash_t *hContext, hash_t *hRequest)
{
	int	iRet = PD_OK;
	int	iPos = 0;
	int	iTmp = 0;
	char	*csTmp;
	char	csTag[PD_TAG_LEN+1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	if (GetField_Int(hContext,"position",&iPos)){
DEBUGLOG(("BOOLPayout::HandleCancelUpload position[%d]\n",iPos));
	}
	
	sprintf(csTag,"batch_id_%d",iPos);
	if (GetField_CString(hRequest,csTag,&csTmp)){
		PutField_CString(hTxn,"batch_id",csTmp);
DEBUGLOG(("BOOLPayout::HandleCancelUpload batch[%s]\n",csTmp));
	}

	sprintf(csTag,"seq_num_%d",iPos);
	if (GetField_Int(hRequest,csTag,&iTmp)){
		PutField_Int(hTxn,"seq_num",iTmp);
DEBUGLOG(("BOOLPayout::HandleCancelUpload seq_num[%d]\n",iTmp));
	}

	PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_CANCELLED);

DEBUGLOG(("BOOLPayout:HandleCancelUpload Call UpdateDetailByTxn\n"));
	iRet = UpdateDetailByTxn(hTxn,hRequest);

	FREE_ME(hTxn);
DEBUGLOG(("BOOLPayout:HandleCancelUpload iRet[%d]\n",iRet));
	return	iRet;
}


int HandleCancelConfirm(hash_t *hContext, hash_t *hRequest)
{
	int	iRet = PD_OK;
	int	iPos = 0;
	int	iTmp = 0;
	//double	dTmp = 0.0;
	char	*csTmp;
	//char    *csTxnSeq;
	char	csTag[PD_TAG_LEN+1];
	//char	csSeqNum[PD_TAG_LEN+1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	if (GetField_Int(hContext,"position",&iPos)){
DEBUGLOG(("BOOLPayout::HandleCancelConfirm position[%d]\n",iPos));
	}

	sprintf(csTag,"batch_id_%d",iPos);
	if (GetField_CString(hRequest,csTag,&csTmp)){
		PutField_CString(hTxn,"batch_id",csTmp);
		//PutField_CString(hContext,"batch_id_0",csTmp);
DEBUGLOG(("BOOLPayout::HandleCancelConfirm batch[%s]\n",csTmp));
	}

	sprintf(csTag,"seq_num_%d",iPos);
	if (GetField_Int(hRequest,csTag,&iTmp)){
		PutField_Int(hTxn,"seq_num",iTmp);
		//sprintf(csSeqNum,"%d",iTmp);
		//PutField_CString(hContext,"seq_num_0",csSeqNum);
DEBUGLOG(("BOOLPayout::HandleCancelConfirm seq_num[%d]\n",iTmp));
	}

	if(GetField_CString(hContext,"update_user",&csTmp)){
		PutField_CString(hTxn,"update_user",csTmp);
	}
/*
	if(iRet==PD_OK){
DEBUGLOG(("HandleCancelConfirm: Call GetNextBatchTxnSeq\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextBatchTxnSeq");
		csTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("HandleCancelConfirm: GenerateBatchSeq: [%s]\n",csTxnSeq));
		PutField_CString(hContext,"txn_seq",csTxnSeq);
		PutField_CString(hTxn,"txn_seq",csTxnSeq);
		FREE_ME(csTxnSeq);
	}
	if(iRet==PD_OK){
		sprintf(csTag,"merchant_id_%d",iPos);
		if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"merchant_id",csTmp);
                }
		sprintf(csTag,"merchant_ref_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"merchant_ref",csTmp);
                }
		sprintf(csTag,"service_code_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"service_code",csTmp);
                }
		sprintf(csTag,"merchant_client_id_%d",iPos);
                if(GetField_CString(hContext,csTag,&csTmp)){
                        PutField_CString(hRequest,"client_id",csTmp);
                }
		sprintf(csTag,"txn_ccy_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"txn_ccy",csTmp);
                }
		sprintf(csTag,"txn_country_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"txn_country",csTmp);
                }
		sprintf(csTag,"bank_name_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"bank_name",csTmp);
                }
		sprintf(csTag,"branch_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"branch",csTmp);
                }
		sprintf(csTag,"account_name_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"account_name",csTmp);
                }
		sprintf(csTag,"account_id_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"account_id",csTmp);
                }
		sprintf(csTag,"txn_amt_%d",iPos);
                if(GetField_Double(hRequest,csTag,&dTmp)){
                        PutField_Double(hContext,"txn_amt",dTmp);
                        PutField_Double(hContext,"net_amt",dTmp);
                }

		PutField_CString(hContext,"txn_code",PD_PAYOUT_CANCEL);

		if (GetField_CString(hContext,"PHDATE",&csTmp)) {
			PutField_CString(hContext,"approval_date",csTmp);
		}

		PutField_CString(hContext,"process_type","0000");
                PutField_CString(hContext,"process_code","000000");
                PutField_Char(hContext,"party_type",PD_TYPE_MERCHANT);
                PutField_Char(hTxn,"party_type",PD_TYPE_MERCHANT);

                PutField_Int(hContext,"do_logging",PD_TRUE);

DEBUGLOG(("HandleCancelConfirm::Call OMTChannel:AddTxnLog\n"));
		RemoveField_CString(hContext,"org_txn_seq");
                ChannelObjPtr = CreateObj(ChannelPtr,"OMTChannel","AddTxnLog");
                if((unsigned long) ((*ChannelObjPtr)(hContext,hRequest))!=PD_OK){
                        iRet = INT_ERR;
DEBUGLOG(("HandleCancelConfirm::OMTChannel:AddTxnLog Failed\n"));
                }
	}
*/
	if(iRet==PD_OK){
		PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_CANCELLED);
DEBUGLOG(("BOOLPayout:HandleCancelConfirm Call UpdateDetailByTxn\n"));
		iRet = UpdateDetailByTxn(hTxn,hRequest);
	}

	if(iRet==PD_OK){
		sprintf(csTag,"org_txn_id_%d",iPos);
		if (GetField_CString(hContext,csTag,&csTmp)){
			PutField_CString(hTxn,"txn_seq",csTmp);
DEBUGLOG(("BOOLPayout::HandleCancelConfirm txn_seq = [%s]\n",csTmp));
		}
	
                PutField_Int(hTxn,"do_logging",PD_TRUE);
		PutField_CString(hTxn,"sub_status",PD_ADMIN_CANCELLED);
		PutField_Char(hTxn,"status",PD_COMPLETE);
                PutField_Char(hTxn,"ar_ind",PD_REJECTED);
                PutField_Int(hTxn,"internal_code",PD_OK);
                PutField_CString(hTxn,"response_code","0");
DEBUGLOG(("Authorize::Call OMTChannel:UpdateTxnLog\n"));
                ChannelObjPtr = CreateObj(ChannelPtr,"OMTChannel","UpdateTxnLog");
                if((unsigned long) ((*ChannelObjPtr)(hTxn,hRequest,hRequest))!=PD_OK){
                        iRet = INT_ERR;
DEBUGLOG(("Authorize::OMTChannel:UpdateTxnLog Failed\n"));
                }
/*
                if(iRet == PD_OK){
DEBUGLOG(("Authorize::Call OMTChannel:UpdateTxnDetailLog\n"));
                        ChannelObjPtr = CreateObj(ChannelPtr,"OMTChannel","UpdateTxnDetailLog");
                        if((unsigned long) ((*ChannelObjPtr)(hContext,hRequest,hRequest))!=PD_OK){
                                iRet = INT_ERR;
DEBUGLOG(("Authorize::OMTChannel:AddTxnDetailLog Failed\n"));
                        }
                        else{
                                TxnCommit();
                        }
                }
*/
	}

	FREE_ME(hTxn);
DEBUGLOG(("BOOLPayout:HandleCancelConfirm iRet[%d]\n",iRet));
	return	iRet;
}


int HandleCancelApprove(hash_t *hContext, hash_t *hRequest)
{
	int	iRet = PD_OK;
	int	iPos = 0;
	int	iTmp = 0;
	int	iDayOfWeek = 0;
	int	iSameDate = PD_FALSE;
	double	dTmp;
	char	*csTmp;
	char	*csTxnSeq;
	char	*csPostDate;
	char	*csOrgPostDate;
	char	csTag[PD_TAG_LEN+1];
	//char	csSeqNum[PD_TAG_LEN+1];
	char	csRespCode[PD_RESPONSE_CODE_LEN+1];
	int	iInternalCode = 0;

	char *csTmpRemark;
	csTmpRemark = (char*) malloc (128);

	hash_t  *hOrg;
        hOrg = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hOrg,0);
	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	hash_t  *hRec;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

	if (GetField_CString(hContext,"response_code",&csTmp)) {
		sprintf(csRespCode,"%s",csTmp);
DEBUGLOG(("BOOLPayout::HandleCancelApprove response error_code [%s]\n",csRespCode));
	}
	else{
		sprintf(csRespCode,"%s","0");
	}
	if (GetField_Int(hContext,"internal_code",&iInternalCode)){
DEBUGLOG(("BOOLPayout::HandleCancelApprove internal_code[%d]\n",iInternalCode));
        	DBObjPtr = CreateObj(DBPtr,"DBMessages","GetInternalMessage");

        	if ((unsigned long)(*DBObjPtr)(iInternalCode,csTmpRemark) == PD_OK) {
DEBUGLOG(("BOOLPayout::HandleCancelApprove find remark = [%s]\n",csTmpRemark));
        	        PutField_CString(hRequest,"remark",csTmpRemark);
        	}
	}

	if (GetField_Int(hContext,"position",&iPos)){
DEBUGLOG(("BOOLPayout::HandleCancelApprove position[%d]\n",iPos));
	}
	
	sprintf(csTag,"batch_id_%d",iPos);
	if (GetField_CString(hRequest,csTag,&csTmp)){
		PutField_CString(hTxn,"batch_id",csTmp);
DEBUGLOG(("HandleCancelApprove batch[%s]\n",csTmp));
	}

	sprintf(csTag,"seq_num_%d",iPos);
	if (GetField_Int(hRequest,csTag,&iTmp)){
		PutField_Int(hTxn,"seq_num",iTmp);
DEBUGLOG(("HandleCancelApprove seq_num[%d]\n",iTmp));
	}

	if (GetField_CString(hContext,"PHDATE",&csPostDate)) {
		PutField_CString(hContext,"approval_date",csPostDate);
		iDayOfWeek=day_of_week((const unsigned char *)csPostDate);
DEBUGLOG(("HandleCancelApprove::day_of_week= [%d]\n",iDayOfWeek));
		PutField_Int(hContext,"day_of_week",iDayOfWeek);
	}

	if(iRet==PD_OK){
DEBUGLOG(("HandleCancelApprove: Call GetNextBatchTxnSeq\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextBatchTxnSeq");
		csTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("HandleCancelApprove: GenerateBatchSeq: [%s]\n",csTxnSeq));
		PutField_CString(hContext,"txn_seq",csTxnSeq);
		//PutField_CString(hTxn,"txn_seq",csTxnSeq);
		PutField_CString(hTxn,"aux_txn_seq",csTxnSeq);
		PutField_CString(hContext,"txn_id",csTxnSeq);
		FREE_ME(csTxnSeq);
	}

	if(iRet==PD_OK){
		sprintf(csTag,"org_txn_id_%d",iPos);
		if(GetField_CString(hContext,csTag,&csTmp)){
DEBUGLOG(("HandleCancelApprove::!!!!!!!!!!org_txn_seq = [%s]!!!!!!!!!!!!!\n",csTmp));
			PutField_CString(hContext,"org_txn_seq",csTmp);
			PutField_CString(hOrg,"txn_seq",csTmp);

			recordset_init(rRecordSet,0);
			DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
			if ((*DBObjPtr)(csTmp,rRecordSet) == PD_OK) {
DEBUGLOG(("GetTxnHeader::found record = [%s]\n",csTmp));
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if (GetField_CString(hRec,"host_posting_date",&csOrgPostDate)){
						if(!strcmp(csPostDate,csOrgPostDate)){
							iSameDate = PD_TRUE;
						}
					}
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
		}

		sprintf(csTag,"merchant_id_%d",iPos);
		if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"merchant_id",csTmp);
                }
		sprintf(csTag,"merchant_ref_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"merchant_ref",csTmp);
                }
		sprintf(csTag,"service_code_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"service_code",csTmp);
                }
		sprintf(csTag,"merchant_client_id_%d",iPos);
                if(GetField_CString(hContext,csTag,&csTmp)){
                        PutField_CString(hRequest,"client_id",csTmp);
                        PutField_CString(hContext,"merchant_client_id",csTmp);
                }
		sprintf(csTag,"txn_ccy_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"txn_ccy",csTmp);
                        PutField_CString(hContext,"txn_ccy",csTmp);
                        PutField_CString(hContext,"net_ccy",csTmp);
                }
		sprintf(csTag,"dst_txn_ccy_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"dst_txn_ccy",csTmp);
                }
		sprintf(csTag,"txn_country_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hContext,"txn_country",csTmp);
                        PutField_CString(hRequest,"txn_country",csTmp);
                }
		sprintf(csTag,"bank_name_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"bank_name",csTmp);
                }
		sprintf(csTag,"branch_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"branch",csTmp);
                }
		sprintf(csTag,"account_name_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"account_name",csTmp);
                }
		sprintf(csTag,"account_id_%d",iPos);
                if(GetField_CString(hRequest,csTag,&csTmp)){
                        PutField_CString(hRequest,"account_id",csTmp);
                }
		sprintf(csTag,"txn_amt_%d",iPos);
                if(GetField_Double(hRequest,csTag,&dTmp)){
                        PutField_Double(hRequest,"txn_amt",dTmp);
                        PutField_Double(hRequest,"net_amt",dTmp);
                }

		PutField_CString(hContext,"txn_code",PD_PAYOUT_VOID_MERCHANT);
		
		PutField_CString(hContext,"process_type","0000");
		PutField_CString(hContext,"process_code","000000");
		PutField_Char(hContext,"party_type",PD_TYPE_MERCHANT);

		PutField_Int(hContext,"do_logging",PD_TRUE);

DEBUGLOG(("HandleCancelApprove::Call OMTChannel:AddTxnLog\n"));
		ChannelObjPtr = CreateObj(ChannelPtr,"OMTChannel","AddTxnLog");
		if((unsigned long) ((*ChannelObjPtr)(hContext,hRequest))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("HandleCancelApprove::OMTChannel:AddTxnLog Failed\n"));
		}

	}

	if(iRet==PD_OK){
		//RemoveField_CString(hTxn,"txn_seq");
		PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_REVERSED);
DEBUGLOG(("HandleCancelApprove Call UpdateDetailByTxn\n"));
		iRet = UpdateDetailByTxn(hTxn,hRequest);
	}

	if(iRet==PD_OK){
		PutField_Int(hContext,"same_date_cancel",iSameDate);
		PutField_CString(hRequest,"org_txn_code",PD_OL_PAYOUT_APPROVE);
		BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","VoidOrgTxnElements");
		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("HandleCancelApprove:: VoidOrgTxnElements iRet = [%d]\n",iRet));
	}

	if(iRet==PD_OK){
		iRet = GetPayoutFee(hContext,hRequest);
DEBUGLOG(("HandleCancelApprove:: GetPayoutFee iRet = [%d]\n",iRet));
	}

	if(iRet==PD_OK){
		//PutField_Int(hContext,"same_date_cancel",iSameDate);
		PutField_Char(hContext,"response_mode",PD_REVERSED);
		PutField_Char(hContext,"party_type",PD_TYPE_MERCHANT);
                iRet = HandleTxnPayoutBalance(hContext,hRequest);
DEBUGLOG(("HandleCancelApprove::HandleTxnPayoutBalance iRet = [%d]\n",iRet));
        }

	if(iRet==PD_OK){
DEBUGLOG(("HandleCancelApprove::call DBTransaction->Update (OrgTxn)\n"));
		PutField_Char(hOrg,"status",PD_REVERSED);
		PutField_CString(hOrg,"sub_status",PD_APPROVED_VOID);
		PutField_CString(hOrg,"response_code",csRespCode);
		PutField_Int(hOrg,"internal_code",iInternalCode);

		DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
		iRet = (unsigned long) ((*DBObjPtr)(hOrg));
	}

	if(iRet==PD_OK){
		PutField_CString(hContext,"desc","Payout Refund(Merchant)");
		PutField_CString(hContext,"sub_status",PD_REFUND_APPROVED);
		PutField_Char(hContext,"status",PD_COMPLETE);
		PutField_Char(hContext,"ar_ind",PD_ACCEPT);
		PutField_Int(hContext,"internal_code",iInternalCode);
		PutField_CString(hContext,"response_code",csRespCode);
DEBUGLOG(("Authorize::Call OMTChannel:UpdateTxnLog\n"));
                ChannelObjPtr = CreateObj(ChannelPtr,"OMTChannel","UpdateTxnLog");
                if((unsigned long) ((*ChannelObjPtr)(hContext,hRequest,hRequest))!=PD_OK){
                        iRet = INT_ERR;
DEBUGLOG(("Authorize::OMTChannel:AddTxnLog Failed\n"));
                }
                PutField_Int(hContext,"do_logging",PD_FALSE);

                if(iRet == PD_OK){
DEBUGLOG(("Authorize::Call OMTChannel:UpdateTxnDetailLog\n"));
                        ChannelObjPtr = CreateObj(ChannelPtr,"OMTChannel","UpdateTxnDetailLog");
                        if((unsigned long) ((*ChannelObjPtr)(hContext,hRequest,hRequest))!=PD_OK){
                                iRet = INT_ERR;
DEBUGLOG(("Authorize::OMTChannel:AddTxnDetailLog Failed\n"));
                        }
                        else{
                                TxnCommit();
                        }
                }

	}
	FREE_ME(hTxn);
	FREE_ME(hOrg);
	FREE_ME(csTmpRemark);
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
DEBUGLOG(("HandleCancelApprove iRet[%d]\n",iRet));
	return	iRet;
}


int isVoidWithFee(hash_t* hTxn)
{
	int	iRet = PD_OK;
	int	iTmp = PD_FALSE;
	char	*csServiceCode;
	hash_t  *hRec;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	if(GetField_CString(hTxn,"service_code",&csServiceCode)){
		DBObjPtr = CreateObj(DBPtr,"DBDefServiceCode","GetServiceCodeDetail");
		if ((*DBObjPtr)(csServiceCode,rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_Int(hRec,"VPFEE",&iTmp)) {
					PutField_Int(hTxn,"VPFEE",iTmp);
DEBUGLOG(("isVoidWithFee::Void Payout With Fee Return= [%d]\n",iTmp));
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}

		}
	}
	else{
		iRet = INT_ERR;
DEBUGLOG(("isVoidWithFee::Service Code not found!!!!!\n"));
	}

DEBUGLOG(("isVoidWithFee iRet = [%d]\n",iRet));
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	return iRet;
}


int	HandleTxnPayoutBalance(hash_t* hContext, hash_t* hRequest)
{
	int	iRet = PD_OK;
	int	iReturnFee = PD_FALSE;
	//int	iCnt = 0;
	//int	i = 0;
	double	dTmp = 0.0;
	double	dOrgFee=0.0;
	char	cTmp;
	char*	csTmp;
	char*	csTxnCode;
	//char	csTag[PD_TAG_LEN+1];
	double	dRemainNetFloat = 0.0;
	double	dRemainResPo = 0.0;
	double	dFundIn = 0.0;
	double	dNetAmt = 0.0;
	hash_t	*hTxn;
	hTxn= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	
	if(GetField_Char(hContext,"party_type",&cTmp)){
DEBUGLOG(("HandleTxnPayoutBalance::party_type = [%c]\n",cTmp));
	}

	if(GetField_Char(hContext,"response_mode",&cTmp)){
DEBUGLOG(("HandleTxnPayoutBalance::response_mode = [%c]\n",cTmp));
	}

	if(GetField_CString(hContext,"txn_code",&csTxnCode)){
DEBUGLOG(("HandleTxnPayoutBalance::txn_code = [%s]\n",csTxnCode));
	}
	if(!strcmp(csTxnCode,PD_PAYOUT_VOID_MERCHANT)){
		if(GetField_Int(hContext,"VPFEE",&iReturnFee)){
DEBUGLOG(("HandleTxnPayoutBalance::return fee = [%d]\n",iReturnFee));
		}
	}
	else if(!strcmp(csTxnCode,PD_OL_PAYOUT_APPROVE)){
		GetField_Double(hContext,"remain_merchant_net_float",&dRemainNetFloat);
DEBUGLOG(("HandleTxnPayoutBalance::remain_merchant_net_float = [%lf]\n",dRemainNetFloat));
		GetField_Double(hContext,"remain_merchant_reserved_po",&dRemainResPo);
DEBUGLOG(("HandleTxnPayoutBalance::remain_merchant_reserved_po = [%lf]\n",dRemainResPo));
		GetField_Double(hContext,"merchant_fundin_po",&dFundIn);
DEBUGLOG(("HandleTxnPayoutBalance::merchant_fundin_po = [%lf]\n",dFundIn));
	}

	if (GetField_CString(hContext,"txn_seq",&csTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::txn_seq = [%s]\n",csTmp));
		PutField_CString(hContext,"txn_id",csTmp);
	}
	if (GetField_CString(hContext,"txn_ccy",&csTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::txn_ccy = [%s]\n",csTmp));
		PutField_CString(hContext,"org_txn_ccy",csTmp);
	}
	if (GetField_CString(hRequest,"txn_country",&csTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::txn_country = [%s]\n",csTmp));
		PutField_CString(hContext,"org_txn_country",csTmp);
	}
	if (GetField_CString(hRequest,"merchant_id",&csTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::merchant_id = [%s]\n",csTmp));
		PutField_CString(hContext,"org_merchant_id",csTmp);
	}
	if (GetField_CString(hRequest,"service_code",&csTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::service_code = [%s]\n",csTmp));
		PutField_CString(hContext,"org_service_code",csTmp);
	}

	if (GetField_CString(hRequest,"psp_id",&csTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::psp_id = [%s]\n",csTmp));
		PutField_CString(hContext,"org_psp_id",csTmp);
	}
	if (GetField_CString(hRequest,"dst_txn_ccy",&csTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::dst_txn_ccy = [%s]\n",csTmp));
		PutField_CString(hContext,"org_psp_txn_ccy",csTmp);
	}

	if (GetField_Double(hRequest,"org_merchant_fee",&dOrgFee)) {
DEBUGLOG(("HandleTxnPayoutBalance::org_merchant_fee = [%lf]\n",dOrgFee));
	}

	if (GetField_Double(hRequest,"net_amt",&dNetAmt)) {
DEBUGLOG(("HandleTxnPayoutBalance::net_amt(merchant) = [%lf]\n",dNetAmt));
		if(iReturnFee==PD_TRUE)
			PutField_Double(hContext,"net_amt",dNetAmt+dOrgFee);
		else
			PutField_Double(hContext,"net_amt",dNetAmt);

		if(!strcmp(csTxnCode,PD_OL_PAYOUT_APPROVE)){
			RemoveField_Double(hContext,"deduct_fundin_po");
			RemoveField_Double(hContext,"deduct_reserved_po");

			if(dRemainNetFloat>0.0){
				if((dRemainNetFloat-dNetAmt)>=0.0){
					dRemainNetFloat = dRemainNetFloat-dNetAmt;
					PutField_Double(hContext,"remain_merchant_net_float",dRemainNetFloat);
DEBUGLOG(("HandleTxnPayoutBalance:: deduct merchant net float only = [%lf]\n",dNetAmt));
					dNetAmt = 0.0;
				}
				else{
DEBUGLOG(("HandleTxnPayoutBalance:: deduct all remaining merchant net float = [%lf]\n",dRemainNetFloat));
					dNetAmt = dNetAmt - dRemainNetFloat;
					PutField_Double(hContext,"remain_merchant_net_float",0.0);
					dRemainNetFloat = 0.0;
				}
			}

			if((dNetAmt>0.0) && (dRemainResPo>0.0)&& (dRemainNetFloat==0.0)){
				if((dRemainResPo-dNetAmt)>=0.0){
					dRemainResPo = dRemainResPo-dNetAmt;
					PutField_Double(hContext,"remain_merchant_reserved_po",dRemainResPo);
					PutField_Double(hContext,"deduct_reserved_po",dNetAmt);
DEBUGLOG(("HandleTxnPayoutBalance:: deduct merchant reserved payout = [%lf]\n",dNetAmt));
					dNetAmt = 0.0;
				}
				else{
DEBUGLOG(("HandleTxnPayoutBalance:: deduct all remaining merchant reserved payout = [%lf]\n",dRemainResPo));
					dNetAmt = dNetAmt - dRemainResPo;
					PutField_Double(hContext,"deduct_reserved_po",dRemainResPo);
					PutField_Double(hContext,"remain_merchant_reserved_po",0.0);
					dRemainResPo = 0.0;
				}
			}

			if((dNetAmt>0.0) && (dFundIn>0.0) && (dRemainResPo==0.0) && (dRemainNetFloat==0.0)){
				if((dNetAmt-dFundIn)>0.0){
					iRet = INT_INSUFFICIENT_FUND;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("HandleTxnPayoutBalance:: insufficient fund!!!!\n"));
ERRLOG("BOOLPayout::HandleTxnPayoutBalance: insufficient fund!!!!\n");
				}
				else{
					PutField_Double(hContext,"deduct_fundin_po",dNetAmt);
DEBUGLOG(("HandleTxnPayoutBalance:: deduct merchant FundIn payout = [%lf]\n",dNetAmt));
					dNetAmt = 0.0;
				}
			}
			
		}
	}

	if(iRet == PD_OK){
		if (GetField_Double(hRequest,"payout_amt",&dTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::txn_amt(psp) = [%lf]\n",dTmp));
			PutField_Double(hContext,"org_dst_net_amt",dTmp);
		}
		else{
			if (GetField_Double(hRequest,"gen_payout_amt",&dTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::txn_amt(psp) = [%lf]\n",dTmp));
				PutField_Double(hContext,"org_dst_net_amt",dTmp);
			}
		}
		if (GetField_Double(hContext,"precal_fee",&dTmp)) {
DEBUGLOG(("HandleTxnPayoutBalance::precal_fee = [%lf]\n",dTmp));
		}
DEBUGLOG(("HandleTxnPayoutBalance::Call BOOLBalance:UpdatePayoutAmount\n"));
		BOObjPtr = CreateObj(BOPtr,"BOOLBalance","UpdatePayoutAmount");
		if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("HandleTxnPayoutBalance::BOOLBalance:UpdatePayoutAmount Failed\n"));
			iRet = INT_ERR;
		}
	}

DEBUGLOG(("HandleTxnPayoutBalance::iRet [%d]\n",iRet));
	FREE_ME(hTxn);
	return iRet;
}


int GetPreApproveRecord(hash_t* hContext,
			hash_t* hRequest,
			hash_t* hResponse)
{
	int     iRet  = PD_OK;
	int	iSeqNum = 0;
	//int	iIntErr= PD_OK;
	int	i= 0;
	int	iTmp= 0;
	int	iOnlineMode = PD_FALSE;
	int	iPreApproveId=0;
	char	*csMerchantId;
	char	*csServiceCode;
	char	*csTxnCountry=strdup("");
	char	*csTxnCcy;
	char	*csTxnId;
	char	*csTmp;
	char	*csMerchantClientId = NULL;
	//char	cInputInd;
	double	dTmp=0.0;
	double	dTotalAmt=0.0;
	//double	dLimitedAmt=0.0;
	char	csTag[PD_TAG_LEN +1];
	hash_t  *hRec;

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	char*   csPspTmp;
	csPspTmp = (char*) malloc (128);

DEBUGLOG(("BOOLPayout:GetPreApproveRecord()\n"));

	if(GetField_Int(hContext,"pre_approve_id",&iPreApproveId)){
DEBUGLOG(("BOOLPayout:GetPreApproveRecord::pre_approve_id = [%d]\n",iPreApproveId));
	}

DEBUGLOG(("GetPreApproveRecord::Call DBOLMerchantUploadFileDetail:GetDetailByPreApproveId\n"));
	DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","GetDetailByPreApproveId");
	if ((unsigned long)(*DBObjPtr)(iPreApproveId,rRecordSet) == PD_FOUND) {
DEBUGLOG(("GetDetailByPreApproveId::found record\n"));
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if (GetField_CString(hRec,"txn_seq",&csTxnId)) {
				sprintf(csTag,"org_txn_id_%d",i);
				PutField_CString(hContext,csTag,csTxnId);
DEBUGLOG(("GetDetailByPreApproveId::org_txn_seq = [%s]\n",csTxnId));
			}
			if (GetField_CString(hRec,"merchant_id",&csMerchantId)) {
				sprintf(csTag,"merchant_id_%d",i);
				PutField_CString(hRequest,"merchant_id",csMerchantId);
				PutField_CString(hContext,"merchant_id",csMerchantId);
				PutField_CString(hRequest,csTag,csMerchantId);
				PutField_CString(hContext,csTag,csMerchantId);
				//sprintf(csTag,"org_merchant_id_%d",i);
				//PutField_CString(hContext,csTag,csMerchantId);
DEBUGLOG(("GetDetailByPreApproveId::merchant_id= [%s]\n",csMerchantId));

				if(i==0){
					if(!GetField_CString(hContext,"merchant_client_id",&csMerchantClientId)){
						BOObjPtr = CreateObj(BOPtr,"BOOLMerchant","GetMerchantDetail");
						if((unsigned long)(*BOObjPtr)(hContext,hRequest)==PD_OK){
							if(GetField_CString(hContext,"merchant_client_id",&csMerchantClientId)){
DEBUGLOG(("GetMerchantDetail::client_id= [%s]\n",csMerchantClientId));
							}
						}
					}
				}
				sprintf(csTag,"merchant_client_id_%d",i);
				PutField_CString(hContext,csTag,csMerchantClientId);
			}
			else{
				iRet = INT_MERCHANT_ID_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
				break;
DEBUGLOG(("GetDetailByPreApproveId::merchant_id not found\n"));
			}
			if (GetField_CString(hRec,"txn_country",&csTxnCountry)) {
                                PutField_CString(hRequest,"txn_country",csTxnCountry);
                                PutField_CString(hContext,"txn_country",csTxnCountry);
                                sprintf(csTag,"txn_country_%d",i);
                                PutField_CString(hRequest,csTag,csTxnCountry);
                                PutField_CString(hContext,csTag,csTxnCountry);
DEBUGLOG(("GetDetailByPreApproveId::txn_country= [%s]\n",csTxnCountry));
                        }
			if (GetField_CString(hRec,"service_code",&csServiceCode)) {
				PutField_CString(hRequest,"service_code",csServiceCode);
				PutField_CString(hContext,"service_code",csServiceCode);
				sprintf(csTag,"service_code_%d",i);
				PutField_CString(hRequest,csTag,csServiceCode);
				PutField_CString(hContext,csTag,csServiceCode);
				//sprintf(csTag,"org_service_code_%d",i);
				//PutField_CString(hContext,csTag,csServiceCode);
DEBUGLOG(("GetDetailByPreApproveId::service_code= [%s]\n",csServiceCode));

				if(i==0){
					if(!GetField_Int(hContext,"check_first_txn",&iTmp)){
						/*DBObjPtr = CreateObj(DBPtr,"DBService","FindCountryByService");
						if ((unsigned long)(DBObjPtr)(csServiceCode,csTxnCountry) == FOUND) {
DEBUGLOG(("GetDetailByPreApproveId::txn_country= [%s]\n",csTxnCountry));
							PutField_CString(hRequest,"txn_country",csTxnCountry);
							PutField_CString(hContext,"txn_country",csTxnCountry);
							//sprintf(csTag,"org_txn_country_%d",i);
							PutField_CString(hContext,"first_txn_country",csTxnCountry);
						}*/

						DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","ChkRuleExists");
						if ((unsigned long)(DBObjPtr)(csMerchantId,csServiceCode) == PD_FOUND) {
	
							DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","FindPsp");
							if ((unsigned long)(DBObjPtr)(csMerchantId,csServiceCode,csPspTmp) == PD_FOUND) {
								PutField_CString(hContext,"first_txn_psp",csPspTmp);
								iOnlineMode = PD_TRUE;
							}
						}
						PutField_Int(hContext,"check_first_txn",PD_TRUE);
						PutField_Int(hContext,"first_txn_mode",iOnlineMode);
					}
					else{
						//GetField_CString(hContext,"first_txn_country",&csTxnCountry);
						GetField_CString(hContext,"first_txn_psp",&csPspTmp);
						GetField_Int(hContext,"first_txn_mode",&iOnlineMode);
					}
				}
				//sprintf(csTag,"txn_country_%d",i);
				//PutField_CString(hRequest,csTag,csTxnCountry);
				//PutField_CString(hContext,csTag,csTxnCountry);

				if(iOnlineMode==PD_TRUE){
					sprintf(csTag,"batch_mode_%d",i);
					PutField_Char(hRequest,csTag,PD_ONLINE);

					sprintf(csTag,"pregen_psp_id_%d",i);
					PutField_CString(hRequest,csTag,csPspTmp);
					FREE_ME(csPspTmp);
				}
				else{
					sprintf(csTag,"batch_mode_%d",i);
					PutField_Char(hRequest,csTag,PD_OFFLINE);
				}
			}
			else{
				iRet = INT_SERVICE_CODE_MISSING;
				PutField_Int(hContext,"internal_error",iRet);
				break;
DEBUGLOG(("GetDetailByPreApproveId::service_code not found\n"));
			}
			if (GetField_CString(hRec,"merchant_ref",&csTmp)) {
				sprintf(csTag,"merchant_ref_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}

			if(GetField_Int(hRec,"seq_num",&iSeqNum)){
				sprintf(csTag,"seq_num_%d",i);
				PutField_Int(hRequest,csTag,iSeqNum);
				PutField_Int(hContext,"last_seq",iSeqNum);
DEBUGLOG(("GetDetailByPreApproveId::seq_num= [%i]\n",iSeqNum));
			}
			if (!GetField_CString(hRec,"txn_country",&csTmp)) {
				sprintf(csTag,"txn_country_%d",i);
				PutField_CString(hRequest,csTag,csTxnCountry);
				PutField_CString(hContext,csTag,csTxnCountry);
			}
			if (GetField_CString(hRec,"payout_ccy",&csTmp)){
				if(strcmp(csTmp,"RMB"))
					csTxnCcy = strdup(csTmp);
				else
					csTxnCcy = strdup(PD_CCY_ISO_CNY);

				sprintf(csTag,"dst_txn_ccy_%d",i);
				PutField_CString(hRequest,csTag,csTxnCcy);
				//sprintf(csTag,"txn_ccy_%d",i);
				//PutField_CString(hRequest,csTag,csTxnCcy);
				//PutField_CString(hContext,csTag,csTxnCcy);
				//sprintf(csTag,"org_txn_ccy_%d",i);
				//PutField_CString(hContext,csTag,csTxnCcy);
DEBUGLOG(("GetDetailByPreApproveId::payout_ccy= [%s]\n",csTmp));
				FREE_ME(csTxnCcy);
			}

			if(GetField_CString(hRec,"request_ccy",&csTmp)){
				if(strcmp(csTmp,"RMB"))
					csTxnCcy = strdup(csTmp);
				else
					csTxnCcy = strdup(PD_CCY_ISO_CNY);

				sprintf(csTag,"txn_ccy_%d",i);
				PutField_CString(hRequest,csTag,csTxnCcy);
				PutField_CString(hContext,csTag,csTxnCcy);
				PutField_CString(hRequest,"txn_ccy",csTxnCcy);
				PutField_CString(hContext,"txn_ccy",csTxnCcy);
				//PutField_CString(hContext,"txn_ccy",csTxnCcy);
				//sprintf(csTag,"org_txn_ccy_%d",i);
				//PutField_CString(hContext,csTag,csTxnCcy);
DEBUGLOG(("GetDetailByPreApproveId::request_ccy= [%s]\n",csTxnCcy));
				FREE_ME(csTxnCcy);
			}
			if (GetField_Double(hRec,"request_amount",&dTmp)) {
				sprintf(csTag,"txn_amt_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
				dTotalAmt += dTmp;
				PutField_Double(hContext,"total_net_amt",dTotalAmt);
DEBUGLOG(("GetDetailByPreApproveId::request_amount= [%lf]\n",dTmp));
			}
			if (GetField_Double(hRec,"payout_amount",&dTmp)) {
				sprintf(csTag,"payout_amount_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetDetailByPreApproveId::payout_amount= [%lf]\n",dTmp));
			}
			if (GetField_Double(hRec,"merchant_fee",&dTmp)) {
				sprintf(csTag,"org_merchant_fee_%d",i);
				PutField_Double(hRequest,csTag,dTmp);
DEBUGLOG(("GetDetailByPreApproveId::merchant_fee= [%lf]\n",dTmp));
			}
			if (GetField_CString(hRec,"bank_name",&csTmp)){
				sprintf(csTag,"bank_name_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
				PutField_CString(hRequest,"bank_name",csTmp);
DEBUGLOG(("GetDetailByPreApproveId::bank_name= [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"bank_code",&csTmp)){
				sprintf(csTag,"bank_code_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
DEBUGLOG(("GetDetailByPreApproveId::bank_code= [%s]\n",csTmp));
			}
			if (GetField_CString(hRec,"branch",&csTmp)){
				sprintf(csTag,"branch_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}
			if (GetField_CString(hRec,"account_num",&csTmp)){
				sprintf(csTag,"account_id_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}
			if (GetField_CString(hRec,"account_name",&csTmp)){
				sprintf(csTag,"account_name_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
			}
			if(GetField_Int(hRec,"status",&iTmp)){
				sprintf(csTag,"status_%d",i);
				PutField_Int(hRequest,csTag,iTmp);
DEBUGLOG(("GetDetailByPreApproveId::status= [%i]\n",iTmp));
			}
			if (GetField_CString(hRec,"batch_id",&csTmp)){
				sprintf(csTag,"batch_id_%d",i);
				PutField_CString(hRequest,csTag,csTmp);
				PutField_CString(hContext,"batch_id",csTmp);
			}

			hRec = RecordSet_GetNext(rRecordSet);
			i++;
			PutField_Int(hContext,"total_cnt",i);
		}
	}
	else{
DEBUGLOG(("GetDetailByPreApproveId:: no record found\n"));
ERRLOG("BOOLPayout::GetPreApproveRecord::GetDetailByPreApproveId::no record found!!\n");
		iRet=INT_NOT_RECORD;
		PutField_Int(hContext,"internal_error",iRet);
	}

	FREE_ME(csPspTmp);
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	return	iRet;
}






int     checkNationalID(const char* csID)
{
	int iRet = PD_OK;
	int iPos = 0;
	int iSex = 0;
	int iTotalSum = 0;
	int i;
	int iPow = 0;
	int iCheck= 0;

//check 2-10 digits, numeric
	if(iRet == PD_OK){
		if(is_numeric((char*)&csID[1])!=PD_TRUE)
			iRet = INT_ERR;
	}

//check 2nd digit, MALE or FEMALE
	if(iRet == PD_OK){
		iSex = atoi(&csID[1])/pow(10,8);
		if(!((iSex==PD_TW_MALE) || (iSex==PD_TW_FEMALE)))
			iRet = INT_ERR;
	}

//check digit
	if(iRet == PD_OK){
		for(iPos=0; iPos<26; iPos++){
			if(csID[0] == csCharSet[iPos])
				iTotalSum += atoi(csAddSet[iPos]);
		}

		for(i=8;i>0;i--){
			iPow= pow(10,i);
			iTotalSum += (atoi(&csID[PD_TW_IDENTITY_ID_LEN-1-i])/iPow)*i;
		}

		iCheck = (10-(iTotalSum%10))%10;
		if(atoi(&csID[9])!= iCheck)
			iRet = INT_ERR;
	}

	return iRet;
}


int     checkAlienID(const char* csID)
{
	int iRet = PD_OK;
	int iPos = 0;
	int iTotalSum = 0;
	int iCheck = 0;
	char csTmp[3];
	int iTmp;
	int i;

//check 3-10 digits, numeric
	if(is_numeric((char*)&csID[2])!=PD_TRUE)
		iRet = INT_ERR;

//check digit
	if(iRet == PD_OK){
		for(iPos=0;iPos<26;iPos++){
			if(csID[0] == csCharSet[iPos]){
				iTmp = atoi(&csIntSet[iPos][1])*9;
				sprintf(csTmp,"%d",iTmp);
				iTotalSum += atoi(csIntSet[iPos])/10 + atoi(&csTmp[1]);
			}
			if(csID[1] == csCharSet[iPos]){
				iTmp = atoi(&csIntSet[iPos][1])*8;
				sprintf(csTmp,"%d",iTmp);
				if(iTmp>9) iTotalSum += atoi(&csTmp[1]);
				else   iTotalSum += atoi(csTmp);
			}
		}

		for(i=7;i>0;i--){
			int iPow = pow(10,i);
			iTmp = (atoi(&csID[PD_TW_IDENTITY_ID_LEN-1-i])/iPow)*i;
			sprintf(csTmp,"%d",iTmp);
			if(iTmp>9) iTotalSum += atoi(&csTmp[1]);
			else iTotalSum += atoi(csTmp);

		}

		sprintf(csTmp,"%d",iTotalSum);
		if(iTotalSum>9) iCheck = 10 - atoi(&csTmp[1]);
		else    iCheck = 10 - atoi(csTmp);
		if(iCheck != atoi(&csID[PD_TW_IDENTITY_ID_LEN-1]))
			iRet = INT_ERR;
	}

        return iRet;
}

int     verifyIdentityId(const char* csID)
{
	int iRet = PD_OK;
	char cSecDigit;

//check ID length (10 digits)
	if(strlen(csID)!=PD_TW_IDENTITY_ID_LEN)
		iRet = INT_ERR;

//check 1st digit, between A-Z
	if(iRet == PD_OK){
		if(!isalpha(csID[0]))
			iRet = INT_ERR;
	}

//check 2nd digit, numeric ->NationalID; alphabet-> AlienID
	if(iRet == PD_OK){
		cSecDigit = csID[1];
		if(!isalpha(cSecDigit))
			iRet = checkNationalID(csID);
		else
			iRet = checkAlienID(csID);
	}
	return iRet;
}



int	Verify_header(char (*csList)[IMPORT_FIELD_LEN], hash_t *hTxn)
{
	int	iRet = PD_OK;
	char    csBuf[PD_MAX_BUFFER +1];
	char	*csMerchantId;
	char	*csServiceCode;
	int	iCount = 0;
	int	i = 0;
	int	iChk = 0;

	GetField_Int(hTxn,"header_field",&iCount);
	for(i=0; i<iCount; i++){
DEBUGLOG(("Verify_header: [%s]\n",csList[i]));
		if(!strlen(csList[i])){
			iRet = INT_INVALID_FILE_FORMAT;
DEBUGLOG(("Verify_header: Header Field Missing!!!\n"));
		}
	}

	if(GetField_CString(hTxn,"merchant_id",&csMerchantId)){
DEBUGLOG(("Verify_header: input merchant_id[%s]\n",csMerchantId));

		iChk = strncmp(csMerchantId,csList[IDX_HEADER_MERCHANT_ID],strlen(csMerchantId));
DEBUGLOG(("Verify_header: compare result[%d]\n",iChk));
		if(iChk){
DEBUGLOG(("Verify_header: merchant_id not match [%s]!=[%s]\n",csMerchantId,csList[IDX_HEADER_MERCHANT_ID]));
			iRet = INT_MERCHANT_ID_MISMATCH;
		}
	}
	
	if(GetField_CString(hTxn,"service_code",&csServiceCode)){
DEBUGLOG(("Verify_header: input service_code[%s]\n",csServiceCode));
		
		if(strncmp(csServiceCode,csList[IDX_HEADER_SERVICE_CODE],strlen(csServiceCode))){
DEBUGLOG(("Verify_header: service_code not match [%s]!=[%s]\n",csServiceCode,csList[IDX_HEADER_SERVICE_CODE]));
			iRet = INT_SERVICE_MISMATCH;
		}
	}

        if (iRet == PD_OK)  {
                sprintf(csBuf,"%s",csList[IDX_HEADER_MERCHANT_ID]);
DEBUGLOG(("Verify_header: call BOSecurity:VerifyMD5Mac\n"));
		BOObjPtr = CreateObj(BOPtr,"BOSecurity","VerifyMD5Mac");
		iRet = (unsigned long int)(*BOObjPtr)(csList[IDX_HEADER_MAC],csList[IDX_HEADER_NUMOFREC],csBuf,strlen(csBuf));
                if(iRet != PD_OK){
			iRet = INT_CHECKSUM_ERROR;
DEBUGLOG(("Verify_header: Invalid Mac[%s]\n",csList[IDX_HEADER_MAC]));
		}
	}

DEBUGLOG(("Verify_header:: iRet = [%d]\n",iRet));
	return iRet;	
}

int	Verify_detail(char (*csList)[IMPORT_FIELD_LEN], hash_t *hTxn)
{

	int	iRet = PD_OK;
	char	csBuf[PD_MAX_BUFFER +1];
	char	csTag[PD_TAG_LEN+1];
	char	csErrMsg[PD_MAX_BUFFER+1];
	int	iRecord = 0;
	char	*csCountry;
	char	*csCcy;
	char	*csMerchantId;
	int	i = 0;
	int	iCount = 0;
	int	iChecksum = PD_TRUE;

	if(GetField_CString(hTxn,"merchant_id",&csMerchantId)){
DEBUGLOG(("Verify_detail:: merchant_id = [%s]\n",csMerchantId));
	}
	if(GetField_Int(hTxn,"po_checksum",&iChecksum)){
DEBUGLOG(("Verify_detail:: payout_checksum = [%d]\n",iChecksum));
	}
	if(GetField_Int(hTxn,"detail_count",&iRecord)){
DEBUGLOG(("Verify_detail:: record = [%d]\n",iRecord));
	}
	sprintf(csTag,"%d_err_msg",iRecord);	


	GetField_Int(hTxn,"detail_field",&iCount);
	for(i=0; i<iCount; i++){
		if(strlen(csList[i])>iFieldLength[i]){
			sprintf(csErrMsg,"104 : Field format error(%s is too long(maximum is %d charaters))",csField[i],iFieldLength[i]);
			PutField_CString(hTxn,csTag,csErrMsg);
			iRet = INT_FORMAT_ERR;
DEBUGLOG(("Verify_detail: Detail Field too log [%s][%s]!!!\n",csField[i],csList[i]));
		}

		if((!(i==IDX_DETAIL_ID || i==IDX_DETAIL_BANK_CODE || i==IDX_DETAIL_PHONE_NO || i==IDX_DETAIL_PROVINCE || i==IDX_DETAIL_CITY)
		   || ((i==IDX_DETAIL_ID || i==IDX_DETAIL_BANK_CODE) && !strcmp(csList[IDX_DETAIL_COUNTRY],"TW"))
		   || ((i==IDX_DETAIL_PROVINCE || i==IDX_DETAIL_CITY) && !strcmp(csList[IDX_DETAIL_COUNTRY],"CN")))
		   && (!strlen(csList[i]))){

			if (iChecksum == PD_FALSE && i == IDX_DETAIL_MAC) {
DEBUGLOG(("Verify_detail: Detail Field[%d] Allow Empty!!!\n",i));
			} else {

				PutField_CString(hTxn,csTag,"104 : Field format error");
				iRet = INT_FORMAT_ERR;
DEBUGLOG(("Verify_detail: Detail Field[%d] Missing!!!\n",i));
			} 
		}
	}

//check country
	if(GetField_CString(hTxn,"txn_country",&csCountry)){
		if(strcmp(csCountry,csList[IDX_DETAIL_COUNTRY])){
			PutField_CString(hTxn,csTag,"Country Mis-Match");
			iRet = INT_RECORD_MISMATCH;
DEBUGLOG(("Verify_detail: country mismatch[%s]!=[%s]\n",csCountry,csList[IDX_DETAIL_COUNTRY]));
		}
	}

//check currency
	if(GetField_CString(hTxn,"txn_ccy",&csCcy)){
		if(strcmp(csCcy,csList[IDX_DETAIL_PAYOUT_CCY])){
			PutField_CString(hTxn,csTag,"Currency Mis-Match");
			iRet = INT_RECORD_MISMATCH;
DEBUGLOG(("Verify_detail: currency mismatch[%s]!=[%s]\n",csCcy,csList[IDX_DETAIL_PAYOUT_CCY]));
		}
	}

//check ID no.
	if(iRet==PD_OK){
		if(strncmp(csList[IDX_DETAIL_COUNTRY],"TW",2)==0){
			iRet = verifyIdentityId(csList[IDX_DETAIL_ID]);
			if(iRet != PD_OK){
				PutField_CString(hTxn,csTag,"104 : Field format error (Invalid identity no.)");
				iRet = INT_FORMAT_ERR;
DEBUGLOG(("Verify_detail: Invalid Id[%s]\n",csList[IDX_DETAIL_ID]));
			}
                }
	}

//check Bank Account Name
	if(iRet==PD_OK){
		int	iCheckName = PD_TRUE;
		char    *p;
		char*   csValueTmp;
		csValueTmp = (char*) malloc (PD_SP_LONG_VALUE_LEN);

		DBObjPtr = CreateObj(DBPtr,"DBSystemParameter","FindCode");
		if ((unsigned long)(DBObjPtr)("SKIP_CHECK_ACCT_NAME",csValueTmp) == FOUND) {
DEBUGLOG(("Verify_detail::merchants not check bank account name  = [%s]\n",csValueTmp));
			p = strtok (csValueTmp,",");
			while (p != NULL){
				if(strcmp(csMerchantId,p)){
					p = strtok (NULL,",");
				}
				else{
					iCheckName = PD_FALSE;
					break;
				}
			}
		}
		FREE_ME(csValueTmp);

		if(iCheckName){
			int iCnt = 0;
			int j = 0;
			for(j=0; j<strlen(csList[IDX_DETAIL_ACC_NAME]); j++){
				if (!isascii(csList[IDX_DETAIL_ACC_NAME][j])){
					iCnt ++;
				}
			}
			if(iCnt>=(3*PD_MAX_NON_ASCII_CHAR)){
				DBObjPtr = CreateObj(DBPtr,"DBOLRulePayoutWhiteList","InWhiteList");
				if ((unsigned long)(DBObjPtr)(csMerchantId,csList[IDX_DETAIL_ACC_NAME]) == PD_TRUE){
DEBUGLOG(("Verify_detail::bank account name in white list = [%s]\n",csList[IDX_DETAIL_ACC_NAME]));
				}
				else{
					PutField_CString(hTxn,csTag,"104 : Field format error (Invalid Bank Account Name)");
					iRet = INT_FORMAT_ERR;
DEBUGLOG(("Verify_detail: Invalid Bank Account Name[%s], Non-ASCII Charaters[%d]\n",csList[IDX_DETAIL_ACC_NAME], (int)(iCnt/3)));
				}
			}
		}

	}

//check amount, non-negative ;no decimal value for TW
        if(iRet == PD_OK){
		double dAmt = myctod((const unsigned char *)csList[IDX_DETAIL_AMOUNT],strlen(csList[IDX_DETAIL_AMOUNT])-PD_DECIMAL_LEN,PD_DECIMAL_LEN);
		if(dAmt<=0.0){
			PutField_CString(hTxn,csTag,"104 : Field format error");
			iRet = INT_UNSUPPORTED_PAY_AMOUNT;
DEBUGLOG(("Verify_detail: Unspported pay amount[%f]\n",dAmt));
		}

		if((dAmt>0.0) && (strncmp(csList[IDX_DETAIL_COUNTRY],"TW",2)==0)){
			long lTmp = (long) dAmt;
			if (dAmt > lTmp){
				PutField_CString(hTxn,csTag,"104 : Field format error");
				iRet = INT_UNSUPPORTED_PAY_AMOUNT;
DEBUGLOG(("Verify_detail: Unspported pay amount[%f], country:[%s]\n",dAmt,csList[IDX_DETAIL_COUNTRY]));
			}
		}
	}

//check mac
	if(iRet==PD_OK && iChecksum){
		sprintf(csBuf,"%s%s%s",csList[IDX_DETAIL_SEQ_NUM],csList[IDX_DETAIL_MERCHANT_REF],csList[IDX_DETAIL_ID]);
DEBUGLOG(("Verify_detail: call BOSecurity:VerifyMD5Mac\n"));
		BOObjPtr = CreateObj(BOPtr,"BOSecurity","VerifyMD5Mac");
		iRet = (unsigned long int)(*BOObjPtr)(csList[IDX_DETAIL_MAC],csList[IDX_DETAIL_AMOUNT],csBuf,strlen(csBuf));
		if(iRet != PD_OK){	
			PutField_CString(hTxn,csTag,"104 : Checksum error");
			iRet = INT_CHECKSUM_ERROR;
DEBUGLOG(("Verify_detail: Invalid Mac[%s]\n",csList[IDX_DETAIL_MAC]));
		}
	}

//check duplicate (against upload file)
	if(iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","MatchUploadTxn");
		PutField_CString(hTxn,"merchant_ref",csList[IDX_DETAIL_MERCHANT_REF]);
		if ((unsigned long int)(*DBObjPtr)(hTxn) == PD_FOUND) {
			PutField_CString(hTxn,csTag,"106 : Duplicate Record(s)");
			iRet = INT_DUP_MERCHANT_REF;
DEBUGLOG(("Verify_detail: Duplicate Transaction[%s][%s]\n",csMerchantId,csList[IDX_DETAIL_MERCHANT_REF]));
		}
	}

//check duplicate (against API request)
	if(iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","MatchPayoutMerchantRef");
		if ((unsigned long)(DBObjPtr)(csMerchantId,csList[IDX_DETAIL_MERCHANT_REF]) != NOT_FOUND) {
			PutField_CString(hTxn,csTag,"106 : Duplicate Record(s)");
			iRet = INT_DUP_MERCHANT_REF;
DEBUGLOG(("Verify_detail: Duplicate Transaction[%s][%s]\n",csMerchantId,csList[IDX_DETAIL_MERCHANT_REF]));
		}
	}

DEBUGLOG(("Verify_detail:: iRet = [%d]\n",iRet));
	return iRet;	
}


int	ProcessPayoutRecords(FILE *fin, hash_t *hContext, hash_t *hRequest, hash_t *hTxn)
{
	int	iRet = INT_ERR;
	char    csList[DETAIL_FIELD_CNT][IMPORT_FIELD_LEN];
        char    cs_input_buf[PD_MAX_BUFFER +1];
        char    csTag[PD_TAG_LEN+1];
        char	*p;
        char	*csTmp;
	char    *csPayoutFile;
        char	csBatchId[PD_TXN_SEQ_LEN+1];
	int     iCount = 0;
	int     iTotalCnt = 0;
	int     iRecord = 0;
	int     iFailCnt = 0;
	double	dAmt = 0.0;
	double	dTotalAmt = 0.0;
	double	dAvalPayoutBal = 0.0;
	double	dActualPayoutBal = 0.0;
	double	dMerchRemainAvaPO = 0.0;
	char	csErrString[PD_REMARK_LEN*4];
	int	iChecksum = PD_TRUE;
	int	iCheckBal = PD_TRUE;

	FILE    *fp;

DEBUGLOG(("ProcessPayoutRecords: open file\n"));
	if(GetField_CString(hTxn,"payout_file_fullpath",&csPayoutFile)){
DEBUGLOG(("ProcessPayoutRecords:: = [%s]\n",csPayoutFile));
	}

	fp = fopen(csPayoutFile, "r");
	if (fp == NULL) {
DEBUGLOG(("ProcessPayoutRecords: open_file error\n"));
		return INT_ERR;
	}

DEBUGLOG(("ProcessPayoutRecords: parse_file\n"));
	/* Header */
	iCount = 0;
	fgets(cs_input_buf,PD_MAX_BUFFER,fp);
	if ((cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A) || (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0D))
		cs_input_buf[strlen(cs_input_buf) - 1] = '\0';

	strcpy(cs_input_buf,TrimLeftChar((const unsigned char*)cs_input_buf,strlen(cs_input_buf),0xEF));
	strcpy(cs_input_buf,TrimLeftChar((const unsigned char*)cs_input_buf,strlen(cs_input_buf),0xBB));
	strcpy(cs_input_buf,TrimLeftChar((const unsigned char*)cs_input_buf,strlen(cs_input_buf),0xBF));

	p = mystrtok(cs_input_buf,",");
	if (p == NULL){
DEBUGLOG(("ProcessPayoutRecords: parse_file error [%s]\n",cs_input_buf));
		iRet = INT_INVALID_FILE_FORMAT;
		PutField_Int(hContext,"internal_error",iRet);
		return iRet;
	}

	if(p[strlen(p) - 1] == 0x0D)
		p[strlen(p) - 1] = '\0';
	strcpy(csList[iCount],p);
	sprintf(csTag,"header_%d",iCount);
	PutField_CString(hTxn,csTag,p);
	iCount++;

	while ( (p = mystrtok(NULL,",")) != NULL) {
		if(p[strlen(p) - 1] == 0x0D)
			p[strlen(p) - 1] = '\0';
		strcpy(csList[iCount],p);
		sprintf(csTag,"header_%d",iCount);
		PutField_CString(hTxn,csTag,p);
		iCount++;
	}
	PutField_Int(hTxn,"header_field",iCount);

	if(GetField_Int(hContext,"po_checksum",&iChecksum)){
		PutField_Int(hTxn,"po_checksum",iChecksum);
DEBUGLOG(("ProcessPayoutRecords::payout_checksum = [%d]\n",iChecksum));
	}
	else{
		PutField_Int(hTxn,"po_checksum",iChecksum);
DEBUGLOG(("ProcessPayoutRecords::payout_checksum = [%d](default)\n",iChecksum));
	}

	if(iCount){
		if(iChecksum){
			if(iCount==HEADER_FIELD_CNT){
				iRet = Verify_header(csList,hTxn);
			}
			else{
				iRet = INT_INVALID_FILE_FORMAT;
			}
		}
		else{
			iRet = PD_OK;
		}

		if (iRet == PD_OK){
			/* Insert to header table */
DEBUGLOG(("ProcessPayoutRecords::DBOLMerchantUploadFileHeader:GenBatchId\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileHeader","GenBatchId");
			if((unsigned long) ((*DBObjPtr)(&csBatchId))!=PD_OK){
				iRet = INT_ERR;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessPayoutRecords::DBOLMerchantUploadFileHeader:GenBatchId Failed\n"));
ERRLOG("BOOLPayout:ProcessPayoutRecords::DBOLMerchantUploadFileHeader:GenBatchId Failed\n");
			}
			else{
				PutField_CString(hTxn,"batch_id",csBatchId);
				PutField_Int(hTxn,"txn_count",0);
				PutField_Double(hTxn,"txn_amt",0.0);
				PutField_Int(hTxn,"status",PD_PAYOUTFILE_PROCESSING);
DEBUGLOG(("ProcessPayoutRecords::DBOLMerchantUploadFileHeader:Add BatchId[%s]\n",csBatchId));
				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileHeader","Add");
				if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessPayoutRecords::DBOLMerchantUploadFileHeader:Add Failed\n"));
ERRLOG("BOOLPayout:ProcessPayoutRecords::DBOLMerchantUploadFileHeader:Add Failed\n");
				}
			}
			
		}
		else{
			PutField_Int(hContext,"internal_error",iRet);
		}
	}
	if(iRet == PD_OK){
		/*Detail*/
		int	iChkDtl;
		char	csInputString[PD_MAX_BUFFER+1];
		while( fgets(cs_input_buf, PD_MAX_BUFFER, fp) != NULL ){
			if ((cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A) || (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0D))
				cs_input_buf[strlen(cs_input_buf) - 1] = '\0';

			if(cs_input_buf[strlen(cs_input_buf) - 1] == 0x00)
				continue;

			sprintf(csInputString,"%s",cs_input_buf);
			if(csInputString[strlen(csInputString)-1]==0x0D)
				csInputString[strlen(csInputString)-1] = '\0';
			iChkDtl = INT_NO_ERR;
			iCount = 0;

			p = mystrtok(cs_input_buf,",");
			if (p == NULL) {
DEBUGLOG(("ProcessPayoutRecords: parse_file error [%s]\n",cs_input_buf));
				iChkDtl = INT_INVALID_FILE_FORMAT;
			}
			iRecord++;
			sprintf(csTag,"%d_error",iRecord);
			PutField_Int(hTxn,csTag,iRet);
			if(iChkDtl!=PD_OK){
				sprintf(csTag,"%d_err_msg",iRecord);	
				PutField_CString(hTxn,csTag,"Invalid file format");
			}	
			else{
				if(p[strlen(p) - 1] == 0x0D)
					p[strlen(p) - 1] = '\0';
				strcpy(csList[iCount],p);
				sprintf(csTag,"%s",csFieldTag[iCount]);
				if(is_numeric(p)){
					PutField_Int(hTxn,csTag,atoi(p));
					iCount++;
				}
				else{
					iChkDtl = INT_INVALID_FILE_FORMAT;
					sprintf(csTag,"%d_error",iRecord);
					PutField_Int(hTxn,csTag,iChkDtl);
					sprintf(csTag,"%d_err_msg",iRecord);
					PutField_CString(hTxn,csTag,"104 : Field format error");
				}

				if(iChkDtl==PD_OK){
					while ( (p = mystrtok(NULL,",")) != NULL) {
						if(p[strlen(p) - 1] == 0x0D)
							p[strlen(p) - 1] = '\0';
						strcpy(csList[iCount],p);

						p = TrimAllChar((const unsigned char*)p,strlen(p),PD_SPACE);
						p = TrimAllChar((const unsigned char*)p,strlen(p),PD_TAB);

						sprintf(csTag,"%s",csFieldTag[iCount]);
						if(iCount==IDX_DETAIL_AMOUNT){
							if(is_numeric(p)){
								dAmt = myctod((const unsigned char *)p,strlen(p)-PD_DECIMAL_LEN,PD_DECIMAL_LEN);
								PutField_Double(hTxn,csTag,dAmt);
							}
							else{
								iChkDtl = INT_INVALID_FILE_FORMAT;
								sprintf(csTag,"%d_error",iRecord);
								PutField_Int(hTxn,csTag,iChkDtl);
								sprintf(csTag,"%d_err_msg",iRecord);
								PutField_CString(hTxn,csTag,"104 : Field format error");
							}
						}
						else{
							if(strlen(p))
								PutField_CString(hTxn,csTag,p);
						}
						iCount++;
					}

				}
				if(iChkDtl == PD_OK){
					PutField_Int(hTxn,"detail_count",iRecord);
					PutField_Int(hTxn,"detail_field",iCount);
					int iFieldCnt = 0;
					if(iCount){
						if(iChecksum)
							iFieldCnt = DETAIL_FIELD_CNT; 
						else	iFieldCnt = DETAIL_FIELD_CNT - 1;
					
						if(iCount>=iFieldCnt && iCount<=DETAIL_FIELD_CNT){
							iChkDtl = Verify_detail(csList,hTxn);
						}
						else{
							iChkDtl = INT_INVALID_FILE_FORMAT;
							sprintf(csTag,"%d_err_msg",iRecord);	
							PutField_CString(hTxn,csTag,"Invalid file format");
						}
						if(iChkDtl == PD_OK){
							sprintf(csTag,"%d_error",iRecord);
							PutField_Int(hTxn,csTag,INT_NO_ERR);
						}
						else{
							sprintf(csTag,"%d_error",iRecord);
							PutField_Int(hTxn,csTag,iChkDtl);
						}
					}
				}
			}
			if(iChkDtl==PD_OK){
				//insert to detail table
				PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_UPLOADED);
				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","Add");
				if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
					sprintf(csErrString,"%s,104 : Field format error",csInputString);
					PutField_CString(hTxn,"record",csErrString);

					DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadError","Add");
					if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
DEBUGLOG(("ProcessPayoutRecords::DBOLMerchantUploadError:Add Failed [%s]\n",csErrString));
ERRLOG("BOOLPayout:ProcessPayoutRecords::DBOLMerchantUploadError:Add Failed [%s]\n",csErrString);
					}

					iFailCnt ++;
					PutField_Int(hTxn,"total_fail_cnt",iFailCnt);
DEBUGLOG(("ProcessPayoutRecords::DBOLMerchantUploadFileDetail:Add Failed [%s]\n",cs_input_buf));
ERRLOG("BOOLPayout:ProcessPayoutRecords::DBOLMerchantUploadFileDetail:Add Failed [%s]\n",cs_input_buf);
				}
				else{
					iTotalCnt ++;
					PutField_Int(hTxn,"total_txn_cnt",iTotalCnt);

					dTotalAmt += dAmt;
					PutField_Double(hTxn,"total_txn_amt",dTotalAmt);
					TxnCommit();
				}
			}
			else{
				//insert to error table
				sprintf(csTag,"%d_err_msg",iRecord);
				if(GetField_CString(hTxn,csTag,&csTmp)){
					sprintf(csErrString,"%s,%s",csInputString,csTmp);
					csErrString[PD_REMARK_LEN*4] = '\0';
DEBUGLOG(("ProcessPayoutRecords::DBOLMerchantUploadError:Add [%s]\n",csErrString));

					PutField_CString(hTxn,"record",csErrString);
					DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadError","Add");
					if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
DEBUGLOG(("ProcessPayoutRecords::DBOLMerchantUploadError:Add Failed [%s]\n",csErrString));
ERRLOG("BOOLPayout:ProcessPayoutRecords::DBOLMerchantUploadError:Add Failed [%s]\n",csErrString);
					}
					else{
						iFailCnt ++;
						PutField_Int(hTxn,"total_fail_cnt",iFailCnt);
						TxnCommit();
					}

				}
			}
		}
		PutField_Int(hTxn,"detail_count",iRecord);

		if(dTotalAmt>0.0){
			char*   csValueTmp;
			char*   csMerchantId;
			csValueTmp = (char*) malloc (PD_SP_LONG_VALUE_LEN);

			if(GetField_CString(hRequest,"merchant_id",&csMerchantId)){
DEBUGLOG(("ProcessPayoutRecords::merchant_id = [%s]\n",csMerchantId));
			}
			DBObjPtr = CreateObj(DBPtr,"DBSystemParameter","FindCode");
			if ((unsigned long)(DBObjPtr)("MERCH_NOT_CHECK_BAL",csValueTmp) == FOUND) {
DEBUGLOG(("ProcessPayoutRecords::merchants not check balance  = [%s]\n",csValueTmp));
				p = strtok (csValueTmp,",");
				while (p != NULL){
					if(strcmp(csMerchantId,p)){
						p = strtok (NULL,",");
					}
					else{
						iCheckBal = PD_FALSE;
						break;
					}
				}
			}
			FREE_ME(csValueTmp);

			if(iCheckBal){
//compare with the available payout (not check due to mantis 853, temp solution)
DEBUGLOG(("ProcessPayoutRecords::Call BOOLBalance:GetAvalPayoutBalance\n"));
				BOObjPtr = CreateObj(BOPtr,"BOOLBalance","GetAvalPayoutBalance");
				if((unsigned long)(*BOObjPtr)(hTxn,
							hTxn,
							&dActualPayoutBal,
							&dAvalPayoutBal)==PD_OK){
					if (GetField_Double(hTxn, "merchant_remain_aval_po",&dMerchRemainAvaPO)) {
DEBUGLOG(("ProcessPayoutRecords::GetAvalBalance for payout=[%f]\n",dMerchRemainAvaPO));
					}
					if(dMerchRemainAvaPO<0.0){
						iRet=INT_INSUFFICIENT_FUND;
DEBUGLOG(("ProcessPayoutRecords::Aval Payout Amt[%f] < Total Request Amt[%f]\n",dMerchRemainAvaPO+dTotalAmt,dTotalAmt));
ERRLOG("BOOLPayout::CheckAvalBalance::insufficient aval payout balance!!\n");
					}
				}
				else{
DEBUGLOG(("ProcessPayoutRecords::GetAvalPayoutBalance Error\n"));
ERRLOG("BOOLPayout::ProcessPayoutRecords::GetAvalPayoutBalance Error!!\n");
					iRet = INT_ERR;
				}
			}

			if(iRet == PD_OK){
				//update count and amount to header table
				if(iTotalCnt>0){
					PutField_Int(hTxn,"status",PD_PAYOUTFILE_UPLOADED);
					DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileHeader","UpdateHeader");
					if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
						iRet = INT_ERR;
						PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessPayoutRecords::DBOLMerchantUploadFileHeader:Add Failed\n"));
ERRLOG("BOOLPayout:ProcessPayoutRecords::DBOLMerchantUploadFileHeader:Add Failed\n");
					}
				}
			}
			else{
				PutField_Int(hContext,"internal_error",iRet);
				//delete the record added
				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileDetail","Delete");
				if((unsigned long) ((*DBObjPtr)(csBatchId))!=PD_OK){
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessPayoutRecords::DBOLMerchantUploadFileDetail:Delete Failed\n"));
ERRLOG("BOOLPayout:ProcessPayoutRecords::DBOLMerchantUploadFileDetail:Delete Failed\n");
				}

				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileHeader","Delete");
				if((unsigned long) ((*DBObjPtr)(csBatchId))!=PD_OK){
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessPayoutRecords::DBOLMerchantUploadFileHeader:Delete Failed\n"));
ERRLOG("BOOLPayout:ProcessPayoutRecords::DBOLMerchantUploadFileHeader:Delete Failed\n");
				}

				DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadError","Delete");
				if ((unsigned long)(*DBObjPtr)(csBatchId) != PD_OK) {
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessPayoutRecords::DBOLMerchantUploadError:Delete Failed [%s]\n"));
ERRLOG("BOOLPayout:ProcessPayoutRecords::DBOLMerchantUploadError:Delete Failed [%s]\n");
				}
			}
			//}
		}
		if(iRecord==iFailCnt){
			PutField_Int(hTxn,"status",PD_PAYOUTFILE_UPD_FAIL);
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantUploadFileHeader","UpdateHeader");
			if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
				iRet = INT_ERR;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("ProcessPayoutRecords::DBOLMerchantUploadFileHeader:Add Failed\n"));
ERRLOG("BOOLPayout:ProcessPayoutRecords::DBOLMerchantUploadFileHeader:Add Failed\n");
			}
		}

	}

	fclose(fp);
DEBUGLOG(("ProcessPayoutRecords: iRet = [%d]\n",iRet));
	return iRet;
}



int check_valid_date(const char *date)
{
        int i;
        int year, month, day;
	int vday[] = {-1, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31, 29};

        if(strlen(date)!=PD_DATE_LEN)
                return PD_ERR;

        for (i = 0; i < PD_DATE_LEN; i++)
                if (!isdigit(date[i]))
                        return PD_ERR;

        year = (date[CC0] - '0') * 1000 +  (date[CC1] - '0') * 100 +
           (date[YY0] - '0') * 10 + (date[YY1] - '0');

        month = (date[MM1] - '0') + (date[MM0] - '0') * 10;
        if (month < 0 || month > 12)
                return PD_ERR;

        day = (date[DD1] - '0') + (date[DD0] - '0') * 10;
        if (month == 2 && isleap(year))
                        month = 13;     // Handle the special case of February in leap years
        if (day < 0 || day > vday[month])
                return PD_ERR;

        return PD_OK;
}


int	Verify_return_detail(char (*csList)[IMPORT_FIELD_LEN], hash_t* hTxn)
{
	int	iRet = PD_OK;
	char	csTag[PD_TAG_LEN+1];
	char	csErrMsg[PD_MAX_BUFFER+1];
	char	*csTmp;
	char	*csCcy;
	char	*csCountry;
	int	i = 0;
	int	iCount = 0;
	int	iRecord = 0;
	double	dTmp= 0.0;
	double	dAmt = 0.0;
	int	iReCnt= 0;
	int	iChkDtl = INT_INVALID_TXN;
	int iVersionNo;

	hash_t	*hRec;
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	hash_t	*hRec_2;
	recordset_t     *rRecordSet_2;
	rRecordSet_2 = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet_2,0);

	GetField_Int(hTxn,"return_count",&iRecord);
	GetField_Int(hTxn,"detail_field",&iCount);

	for(i=0; i<iCount; i++){
		if((i==RT_IDX_DETAIL_TXN_ID||
		    i==RT_IDX_DETAIL_REV_NAME ||
		    i==RT_IDX_DETAIL_BANK_ACCT ||
		    i==RT_IDX_DETAIL_AMOUNT ||
		    i==RT_IDX_DETAIL_TXN_DATE)
		 && (!strlen(csList[i]))){
				iRet = INT_FORMAT_ERR;
				sprintf(csErrMsg,"[%s] is Missing",csReturnField[i]);
				PutField_CString(hTxn,"error_msg",csErrMsg);
DEBUGLOG(("Verify_return_detail: Field[%s] is Missing!!!\n",csReturnField[i]));
				break;
		} 
	}

//check duplicate record
	if(iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBOLPayoutReturnBatchDt","MatchRespTxn");
		if((unsigned long)(*DBObjPtr)(csList[RT_IDX_DETAIL_TXN_ID])==PD_FOUND){
			sprintf(csErrMsg,"Duplicated record");
			PutField_CString(hTxn,"error_msg",csErrMsg);
			iRet = INT_INVALID_TXN;
DEBUGLOG(("Verify_return_detail: Duplicated record!!!\n"));
		}
	}

//check valid txn_date
	if(iRet == PD_OK){
		if(check_valid_date(csList[RT_IDX_DETAIL_TXN_DATE]) != PD_OK) {
			sprintf(csErrMsg,"Invalid Date");
			PutField_CString(hTxn,"error_msg",csErrMsg);
			iRet = INT_INVALID_TXN;
DEBUGLOG(("Verify_return_detail: Invalid Transaction Date [%s]!!!\n",csList[RT_IDX_DETAIL_TXN_DATE]));
		}
	}


//check amount, non-negative, no char;
        if(iRet == PD_OK){
		dAmt = string2double((const unsigned char *)csList[RT_IDX_DETAIL_AMOUNT]);
		if(dAmt<=0.0){
			iRet = INT_UNSUPPORTED_PAY_AMOUNT;
			sprintf(csErrMsg,"Unspported pay amount[%f]",dAmt);
			PutField_CString(hTxn,"error_msg",csErrMsg);
DEBUGLOG(("Verify_return_detail: Unspported pay amount[%f]\n",dAmt));
		}
		PutField_Double(hTxn,"file_amount",dAmt);
	}

//check txn_id, bank_acct, rev_name, amount is matched with system record
        if(iRet == PD_OK){
		int	iStatus = 0;
		iReCnt= 0;
		iChkDtl = INT_INVALID_TXN;
		DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileDT","GetDetailByGenId");
		iRet = (unsigned long)(*DBObjPtr)(csList[RT_IDX_DETAIL_TXN_ID],rRecordSet);
		if(iRet == PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				iReCnt ++;
				if(GetField_Int(hRec,"status",&iStatus)){
					if(iStatus==PAYOUT_MASTER_TRANSACTION_GENERATED){
						iChkDtl = PD_OK;
					}
					else{
						sprintf(csErrMsg,"Invalid Status[%d]",iStatus);
						PutField_CString(hTxn,"error_msg",csErrMsg);
DEBUGLOG(("Verify_return_detail: Invalid Status[%d]\n",iStatus));
					}
				}
				if(iChkDtl== PD_OK){
					if(GetField_CString(hRec,"upload_txn_id",&csTmp)){
						PutField_CString(hTxn,"upload_txn_id",csTmp);
DEBUGLOG(("Verify_return_detail: upload_txn_id[%s]\n",csTmp));
					}

					if(GetField_CString(hRec,"account_num",&csTmp)){
						if(strcmp(csTmp,csList[RT_IDX_DETAIL_BANK_ACCT])){
							iChkDtl = INT_INVALID_TXN;
							sprintf(csErrMsg,"bank account num not match");
							PutField_CString(hTxn,"error_msg",csErrMsg);
DEBUGLOG(("Verify_return_detail: bank account num not match[%s][%s]\n",csTmp,csList[RT_IDX_DETAIL_BANK_ACCT]));
							iChkDtl = INT_INVALID_TXN;
							break;
						}
DEBUGLOG(("Verify_return_detail: bank account num [%s][%s]\n",csTmp,csList[RT_IDX_DETAIL_BANK_ACCT]));
					}
					if(GetField_CString(hRec,"account_name",&csTmp)){
						if(strcmp(csTmp,csList[RT_IDX_DETAIL_REV_NAME])){
							iChkDtl = INT_INVALID_TXN;
							sprintf(csErrMsg,"bank account name not match");
							PutField_CString(hTxn,"error_msg",csErrMsg);
DEBUGLOG(("Verify_return_detail: bank account name not match[%s][%s]\n",csTmp,csList[RT_IDX_DETAIL_REV_NAME]));
							iChkDtl = INT_INVALID_TXN;
							break;
						}
DEBUGLOG(("Verify_return_detail: bank account name[%s][%s]\n",csTmp,csList[RT_IDX_DETAIL_REV_NAME]));
					}
					if(GetField_Double(hRec,"unique_amount",&dTmp)){
						if(dTmp!=dAmt){
							iChkDtl = INT_INVALID_TXN;
							sprintf(csErrMsg,"amount not match");
							PutField_CString(hTxn,"error_msg",csErrMsg);
DEBUGLOG(("Verify_return_detail: amount not match[%lf][%lf]\n",dTmp,dAmt));
							iChkDtl = INT_INVALID_TXN;
							break;
						}
DEBUGLOG(("Verify_return_detail: amount [%lf][%lf]\n",dTmp,dAmt));
					}
					if(GetField_CString(hRec,"request_ccy",&csCcy)){
DEBUGLOG(("Verify_return_detail: request_ccy [%s]\n",csCcy));
					}
					if(GetField_CString(hRec,"txn_country",&csCountry)){
DEBUGLOG(("Verify_return_detail: txn_country [%s]\n",csCountry));
					}
					if(GetField_Int(hRec,"version_no",&iVersionNo)){
DEBUGLOG(("Verify_return_detail: version_no [%d]\n",iVersionNo));
					}
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		iRet = iChkDtl;
		if(!iReCnt){
			sprintf(csErrMsg,"Transaction not found");
			PutField_CString(hTxn,"error_msg",csErrMsg);
DEBUGLOG(("Verify_return_detail: Transaction not found\n"));
		}

	}

//check txn is unreconed
	if(iRet == PD_OK && iVersionNo != 1){
		char *csSubStatus = NULL;
		char cStatus = '1';
		char cArInd = '1';
		char cReconStatus = '1';
		iReCnt= 0;
		iChkDtl = INT_INVALID_TXN;

		DBObjPtr = CreateObj(DBPtr, "DBOLPayoutReturn", "GetPayoutRtnList");
		iRet = (unsigned long)(*DBObjPtr)(csList[RT_IDX_DETAIL_TXN_ID], rRecordSet_2);
		if (iRet == PD_OK) {
			hRec_2 = RecordSet_GetFirst(rRecordSet_2);
			while (hRec_2) {
				GetField_CString(hRec_2, "txn_seq", &csTmp);
DEBUGLOG(("FOR DEBUG: txn_seq = [%s]\n", csTmp));

				RecordSet_Destroy(rRecordSet);
				recordset_init(rRecordSet, 0);
				DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","GetTxnHeader");
				iRet = (unsigned long)(*DBObjPtr)(csTmp,rRecordSet);
				if(iRet == PD_OK){
					hRec = RecordSet_GetFirst(rRecordSet);
					while (hRec) {
						iReCnt ++;
		
						if(GetField_Char(hRec,"status",&cStatus)){
DEBUGLOG(("Verify_return_detail: status [%c]\n",cStatus));
						}
		
						if(GetField_Char(hRec,"ar_ind",&cArInd)){
DEBUGLOG(("Verify_return_detail: ar_ind [%c]\n",cArInd));
						}
		
						if(GetField_CString(hRec,"sub_status",&csSubStatus)){
DEBUGLOG(("Verify_return_detail: sub_status [%s]\n",csSubStatus));
						}
		
						if(GetField_Char(hRec,"recon_status",&cReconStatus)){
DEBUGLOG(("Verify_return_detail: recon_status [%c]\n",cReconStatus));
						}
						
						if(cStatus == PD_COMPLETE &&
						   cArInd == PD_ACCEPT &&
						   !strcmp(csSubStatus,PD_APPROVED) &&
						   cReconStatus == PD_UNRECONCILED){
DEBUGLOG(("Verify_return_detail: Valid Transaction Status[%c][%c][%s][%c]\n",cStatus,cArInd,csSubStatus,cReconStatus));
							iChkDtl = PD_OK;
						}
		
		
						if(iChkDtl!=PD_OK){
							sprintf(csErrMsg,"Invalid Transaction Status[%c][%c][%s][%c]",cStatus,cArInd,csSubStatus,cReconStatus);
							PutField_CString(hTxn,"error_msg",csErrMsg);
DEBUGLOG(("Verify_return_detail: Invalid Transaction Status[%c][%c][%s][%c]!!!\n",cStatus,cArInd,csSubStatus,cReconStatus));
						}
		
						hRec = RecordSet_GetNext(rRecordSet);
					}
				}
				iRet = iChkDtl;
		                if(!iReCnt){
		                        sprintf(csErrMsg,"Transaction not found");
		                        PutField_CString(hTxn,"error_msg",csErrMsg);
DEBUGLOG(("Verify_return_detail: Transaction not found\n"));
		                }

				hRec_2 = RecordSet_GetNext(rRecordSet_2);
			}
		}
		iRet = iChkDtl;
		if(!iReCnt){
			sprintf(csErrMsg,"Transaction not found");
			PutField_CString(hTxn,"error_msg",csErrMsg);
DEBUGLOG(("Verify_return_detail: Transaction not found\n"));
		}
	}

/*
	if(iRet == PD_OK){
		sprintf(csTag,"txn_ccy_%d",iRecord);
		PutField_CString(hTxn,csTag,csCcy);

		sprintf(csTag,"txn_country_%d",iRecord);
		PutField_CString(hTxn,csTag,csCountry);

		sprintf(csTag,"txn_id_%d",iRecord);
		PutField_CString(hTxn,csTag,csList[RT_IDX_DETAIL_TXN_ID]);

	}
*/

//check Reason, if null, put default value ""//
        if(iRet == PD_OK){
		sprintf(csTag,"remark_%d",iRecord);
		if(!strlen(csList[RT_IDX_DETAIL_REASON])){
			PutField_CString(hTxn,csTag,"");
			PutField_CString(hTxn,"reason","");
		}
		else{
			PutField_CString(hTxn,csTag,csList[RT_IDX_DETAIL_REASON]);
		}
	}

	if(iRet == PD_OK){
		iRecord++;
		PutField_Int(hTxn,"return_count",iRecord);
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	RecordSet_Destroy(rRecordSet_2);
	FREE_ME(rRecordSet_2);
DEBUGLOG(("Verify_return_detail:: iRet = [%d]\n",iRet));
	return iRet;	
}

int	CheckReturnPayoutFile(FILE *fin, hash_t *hContext, hash_t *hRequest)
{
	int	iRet = PD_OK;
	char    csList[RT_DETAIL_FIELD_CNT][IMPORT_FIELD_LEN];
        char    cs_input_buf[PD_MAX_BUFFER +1];
	char	csInputString[PD_MAX_BUFFER+1];
	char	csErrMsg[PD_MAX_BUFFER+1];
	char	csTmpMsg[PD_MAX_BUFFER+1];
	char	csTag[PD_TAG_LEN+1];
	char	*csTmp;
	char	*csUser;
        char	*p;
	int     iCount = 0;
	int     iErrCnt= 0;
	int     iRecord = 0;
	int     iBatchId = 0;
	double	dTmp = 0.0;

	hash_t  *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);


	if(GetField_Int(hContext,"return_batch_id",&iBatchId)){
DEBUGLOG(("CheckReturnPayoutFile: return_batch_id = [%d]\n",iBatchId));
	}
	if(GetField_CString(hRequest,"add_user",&csUser)){
DEBUGLOG(("CheckReturnPayoutFile: add_user = [%s]\n",csUser));
	}

	PutField_Int(hContext,"return_count",iRecord);

DEBUGLOG(("CheckReturnPayoutFile: parse_file\n"));
	/* Header */
	iCount = 0;
	fgets(cs_input_buf,PD_MAX_BUFFER,fin);

	if ((cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A) || (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0D))
		cs_input_buf[strlen(cs_input_buf) - 1] = '\0';

	sprintf(csInputString,"%s",cs_input_buf);
	if(csInputString[strlen(csInputString)-1]==0x0D)
		csInputString[strlen(csInputString)-1] = '\0';

	p = mystrtok(cs_input_buf,",");
	if (p == NULL){
DEBUGLOG(("CheckReturnPayoutFile: parse_file error [%s]\n",cs_input_buf));
		iRet = INT_INVALID_FILE_FORMAT;
		PutField_Int(hContext,"internal_error",iRet);
		sprintf(csErrMsg,"%s ,[invalid header]",csInputString);
		sprintf(csTag,"error_msg_%d",iErrCnt);
		PutField_CString(hContext,csTag,csErrMsg);
		iErrCnt ++;
		PutField_Int(hContext,"error_count",iErrCnt);
		return iRet;
	}

	if(p[strlen(p) - 1] == 0x0D)
		p[strlen(p) - 1] = '\0';
	//strcpy(csList[iCount],p);
	iCount++;

	while (( (p = mystrtok(NULL,",")) != NULL) && iCount<RT_DETAIL_FIELD_CNT){
		if(p[strlen(p) - 1] == 0x0D)
			p[strlen(p) - 1] = '\0';
	//	strcpy(csList[iCount],p);
		iCount++;
	}

	if(iCount){
		/*Detail*/
		int	iChkDtl;
		while( fgets(cs_input_buf, PD_MAX_BUFFER, fin) != NULL){
			iChkDtl = PD_OK;
			if ((cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A) || (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0D))
				cs_input_buf[strlen(cs_input_buf) - 1] = '\0';

			strcpy(cs_input_buf,TrimLeftChar((const unsigned char*)cs_input_buf,strlen(cs_input_buf),0xEF));
			strcpy(cs_input_buf,TrimLeftChar((const unsigned char*)cs_input_buf,strlen(cs_input_buf),0xBB));
			strcpy(cs_input_buf,TrimLeftChar((const unsigned char*)cs_input_buf,strlen(cs_input_buf),0xBF));
			hash_init(hTxn,0);

			if(cs_input_buf[strlen(cs_input_buf) - 1] == 0x00)
				continue;

			sprintf(csInputString,"%s",cs_input_buf);
			if(csInputString[strlen(csInputString)-1]==0x0D)
				csInputString[strlen(csInputString)-1] = '\0';
			iCount = 0;

			p = mystrtok(cs_input_buf,",");
			if (p == NULL) {
DEBUGLOG(("CheckReturnPayoutFile: parse_file error [%s]\n",csInputString));
				iChkDtl = INT_INVALID_FILE_FORMAT;
			}
			iRecord++;
			if(iChkDtl == PD_OK){
				if(p[strlen(p) - 1] == 0x0D)
					p[strlen(p) - 1] = '\0';
				strcpy(csList[iCount],TrimAllChar((const unsigned char*)p,strlen(p),'"'));
				iCount++;
				csList[iCount][0] = '\0';

				while (((p = mystrtok(NULL,",")) != NULL) && iCount<RT_DETAIL_FIELD_CNT) {
					if(p[strlen(p) - 1] == 0x0D)
						p[strlen(p) - 1] = '\0';
					strcpy(csList[iCount],TrimAllChar((const unsigned char*)p,strlen(p),'"'));
					iCount++;
					if(iCount<=RT_DETAIL_FIELD_CNT) csList[iCount][0] = '\0';
				}


				PutField_Int(hContext,"detail_field",RT_DETAIL_FIELD_CNT);
DEBUGLOG(("CheckReturnPayoutFile: Verify Record #[%d]\n",iRecord));
				iChkDtl = Verify_return_detail(csList,hContext);

				if(iChkDtl != PD_OK){
					PutField_Int(hTxn,"is_valid",PD_FALSE);
					if(GetField_CString(hContext,"error_msg",&csTmp)){
						sprintf(csErrMsg,"%d: %s ,[%s]",iRecord,csInputString,csTmp);
						sprintf(csTag,"error_msg_%d",iErrCnt);
						PutField_CString(hContext,csTag,csErrMsg);
						iErrCnt ++;
					}
				}
				else{
					sprintf(csTmpMsg,"%d: %s",iRecord,csInputString);
					sprintf(csTag,"input_%s",csList[RT_IDX_DETAIL_TXN_ID]);
					PutField_CString(hContext,csTag,csTmpMsg);

					//insert detail
DEBUGLOG(("CheckReturnPayoutFile:: Insert Detail\n"));
					PutField_Int(hTxn,"batch_id",iBatchId);
					PutField_Int(hTxn,"seq",iRecord);
					PutField_CString(hTxn,"txn_date",csList[RT_IDX_DETAIL_TXN_DATE]);
					PutField_CString(hTxn,"txn_id",csList[RT_IDX_DETAIL_TXN_ID]);
					PutField_CString(hTxn,"bank_name",csList[RT_IDX_DETAIL_BANK_NAME]);
					PutField_CString(hTxn,"branch",csList[RT_IDX_DETAIL_BRANCH]);
					PutField_CString(hTxn,"account_name",csList[RT_IDX_DETAIL_REV_NAME]);
					PutField_CString(hTxn,"account_num",csList[RT_IDX_DETAIL_BANK_ACCT]);
					PutField_CString(hTxn,"province",csList[RT_IDX_DETAIL_PROVINCE]);
					PutField_CString(hTxn,"city",csList[RT_IDX_DETAIL_CITY]);
					PutField_CString(hTxn,"process_bank_name",csList[RT_IDX_DETAIL_PROC_BANK_NAME]);
					PutField_Int(hTxn,"is_valid",PD_TRUE);
					PutField_CString(hTxn,"add_user",csUser);

					if(GetField_Double(hContext,"file_amount",&dTmp))
						PutField_Double(hTxn,"amount",dTmp);

					if(GetField_CString(hContext,"upload_txn_id",&csTmp))
						PutField_CString(hTxn,"upload_txn_id",csTmp);

					if(!strlen(csList[RT_IDX_DETAIL_REASON])){
						if(GetField_CString(hContext,"reason",&csTmp))
							PutField_CString(hTxn,"reason",csTmp);
					}
					else{
						PutField_CString(hTxn,"reason",csList[RT_IDX_DETAIL_REASON]);
					}

					PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_UPLOADED);
					DBObjPtr = CreateObj(DBPtr,"DBOLPayoutReturnBatchDt","Add");
					if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
DEBUGLOG(("CheckReturnPayoutFile:: Insert Detail failed\n"));
					}
				}
			}
			else{
				sprintf(csErrMsg,"%d: %s ,[invalid content]",iRecord,csInputString);
				sprintf(csTag,"error_msg_%d",iErrCnt);
				PutField_CString(hContext,csTag,csErrMsg);
				iErrCnt ++;
			}
	
		}

		//iRet = iChkDtl;
	}

	/*if(iRet!=PD_OK){
		//clear detail
DEBUGLOG(("CheckReturnPayoutFile:: Clear Detail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLPayoutReturnBatchDt","DeleteByBatch");
		if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
DEBUGLOG(("CheckReturnPayoutFile:: Clear Detail failed\n"));
		}
	}*/

	PutField_Int(hContext,"error_count",iErrCnt);

	FREE_ME(hTxn);
DEBUGLOG(("CheckReturnPayoutFile: iRet = [%d]\n",iRet));
	return iRet;
}



int	CheckReturnSplitRecord(hash_t *hContext, hash_t *hRequest)
{
	int	iRet = PD_OK;
	int	iBatchId = 0;
	int	iErrCnt = 0;
	int	iRetCnt = 0;
	char	*csTmp;
	char	*csTmpMsg;
	char	csErrMsg[PD_MAX_BUFFER+1];
	char	csTag[PD_TAG_LEN+1];

	hash_t	*hRec;
	hash_t	*hSplit;
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	recordset_t     *rSplitSet;
	rSplitSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rSplitSet,0);

	if(GetField_Int(hContext,"return_batch_id",&iBatchId)){
DEBUGLOG(("CheckReturnSplitRecord: return_batch_id = [%d]\n",iBatchId));
	}

	GetField_Int(hContext,"error_count",&iErrCnt);
	GetField_Int(hContext,"return_count",&iRetCnt);

DEBUGLOG(("CheckReturnSplitRecord: org error_count = [%d]\n",iErrCnt));
DEBUGLOG(("CheckReturnSplitRecord: org return_count = [%d]\n",iRetCnt));

	if(iRetCnt>0){
DEBUGLOG(("CheckReturnSplitRecord: Call GetInvalidSplitReturn\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLPayoutReturnBatchDt","GetInvalidSplitReturn");
		if((unsigned long)(*DBObjPtr)(iBatchId,rRecordSet)==PD_FOUND){
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if(GetField_CString(hRec,"upload_txn_id",&csTmp)){
DEBUGLOG(("CheckReturnSplitRecord: Call GetGenIdByUploadId [%s]\n",csTmp));
					recordset_init(rSplitSet,0);
					DBObjPtr = CreateObj(DBPtr,"DBOLPayoutReturnBatchDt","GetGenIdByUploadId");
					if((unsigned long)(*DBObjPtr)(iBatchId,csTmp,rSplitSet)==PD_FOUND){
						hSplit = RecordSet_GetFirst(rSplitSet);
						while (hSplit) {
							if(GetField_CString(hSplit,"txn_id",&csTmp)){
								sprintf(csTag,"input_%s",csTmp);
								if(GetField_CString(hContext,csTag,&csTmpMsg)){
									sprintf(csErrMsg,"%s ,[split count not match]",csTmpMsg);
									sprintf(csTag,"error_msg_%d",iErrCnt);
									PutField_CString(hContext,csTag,csErrMsg);
									iErrCnt ++;
								}
DEBUGLOG(("CheckReturnSplitRecord: Call DeleteByTxnId [%s]\n",csTmp));
								DBObjPtr = CreateObj(DBPtr,"DBOLPayoutReturnBatchDt","DeleteByTxnId");
								if((unsigned long)(*DBObjPtr)(csTmp)==PD_OK){
									iRetCnt = iRetCnt - 1;
								}
								else{
DEBUGLOG(("CheckReturnSplitRecord: DeleteByTxnId Failed!!!!!\n"));
								}
							}
							hSplit = RecordSet_GetNext(rSplitSet);
						}

					}

				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		PutField_Int(hContext,"error_count",iErrCnt);
DEBUGLOG(("CheckReturnSplitRecord: new error_count = [%d]\n",iErrCnt));
		PutField_Int(hContext,"return_count",iRetCnt);
DEBUGLOG(("CheckReturnSplitRecord: new return_count = [%d]\n",iRetCnt));
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	RecordSet_Destroy(rSplitSet);
	FREE_ME(rSplitSet);
DEBUGLOG(("CheckReturnSplitRecord: iRet = [%d]\n",iRet));
	return	iRet;
}

int HandleReconGenerate(hash_t* hContext,
			hash_t* hRequest,
			hash_t* hResponse)
{
	int iRet = PD_OK;
	int iTmp = 0;
	char *csTmp;
	int iChk = 0;
	int i = 0;
	double dTmp = 0.0;

	char *csUser;
	//char *csFileId;
	char csNewTxnSeq[PD_TXN_SEQ_LEN + 1];
	char *csOrgTxnId;
	char csTag[PD_TAG_LEN + 1];
	char *csPspId;
	char *csBaid;
	char *csClient = NULL;
	hash_t *hRec;

	hash_t *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn, 0);

	hash_t *hOrgTxn;
	hOrgTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hOrgTxn, 0);

	// hash_t *hUploadTxn;
	// hUploadTxn = (hash_t*) malloc (sizeof(hash_t));
	// hash_init(hUploadTxn, 0);

	recordset_t *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet, 0);

DEBUGLOG(("HandleReconGenerate()\n"));

	// status
	if (GetField_Int(hContext, "status", &iTmp)) {
		PutField_Int(hTxn, "status", iTmp);
DEBUGLOG(("HandleReconGenerate() status = [%d]\n", iTmp));
	}

	// upload_status
	if (GetField_Int(hContext, "upload_status", &iTmp)) {
		PutField_Int(hTxn, "upload_status", iTmp);
DEBUGLOG(("HandleReconGenerate() upload_status = [%d]\n", iTmp));
	}

	// txn_list
	if (GetField_CString(hContext, "txn_list", &csTmp)) {
		PutField_CString(hTxn, "txn_list", csTmp);
DEBUGLOG(("HandleReconGenerate() txn_list = [%s]\n", csTmp));
	}

	// user
	if (GetField_CString(hRequest, "add_user", &csUser)) {
		PutField_CString(hTxn, "update_user", csUser);
DEBUGLOG(("HandleReconGenerate() user = [%s]\n", csUser));
	}

	// psp_date
	// if (GetField_CString(hRequest, "psp_date", &csTmp)) {
		// PutField_CString(hContext, "psp_date", csTmp);
// DEBUGLOG(("HandleReconGenerate() psp_date = [%s]\n", csTmp));
	// }

DEBUGLOG(("HandleReconGenerate:: Call DBOLPayoutGeneratedFileDT: GetDetailByCondition\n"));
	DBObjPtr = CreateObj(DBPtr, "DBOLPayoutGeneratedFileDT", "GetDetailByCondition");
	iChk = (unsigned long)(*DBObjPtr)(hTxn, rRecordSet);
	if (iChk == PD_FOUND) {
		i = 0;
		hRec = RecordSet_GetFirst(rRecordSet);
		while ((hRec) && (iRet == PD_OK)) {
			// if (GetField_CString(hRec, "file_id", &csFileId)) {
// DEBUGLOG(("GetDetailByCondition:: file_id = [%s]\n", csFileId));
			// }

			DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextOmtTxnSeq");
			strcpy(csNewTxnSeq, (*DBObjPtr)());
DEBUGLOG(("GetDetailByCondition:: csNewTxnSeq = [%s]\n", csNewTxnSeq));
			PutField_CString(hContext, "txn_seq", csNewTxnSeq);
			PutField_CString(hTxn, "aux_txn_id", csNewTxnSeq);
			sprintf(csTag, "txn_seq_%d", i);
			PutField_CString(hContext, csTag, csNewTxnSeq);

			if (GetField_CString(hRec, "batch_id", &csTmp)) {
				sprintf(csTag, "batch_id_%d", i);
				PutField_CString(hRequest, csTag, csTmp);
DEBUGLOG(("GetDetailByCondition:: batch_id = [%s]\n", csTmp));
			}

			if (GetField_Int(hRec, "seq_num", &iTmp)) {
				sprintf(csTag, "seq_num_%d", i);
				PutField_Int(hRequest, csTag, iTmp);
DEBUGLOG(("GetDetailByCondition:: seq_num = [%d]\n", iTmp));
			}

			if (GetField_CString(hRec, "txn_seq", &csOrgTxnId)) {
				PutField_CString(hContext, "org_txn_seq", csOrgTxnId);
				PutField_CString(hOrgTxn, "txn_seq", csOrgTxnId);
				PutField_CString(hTxn, "txn_id", csOrgTxnId);
DEBUGLOG(("GetDetailByCondition:: txn_seq = [%s]\n", csOrgTxnId));
			}

			// if (GetField_CString(hRec, "upload_txn_seq", &csTmp)) {
				// PutField_CString(hUploadTxn, "txn_seq", csTmp);
// DEBUGLOG(("GetDetailByCondition:: upload_txn_seq = [%s]\n", csTmp));
			// }

			if (GetField_CString(hRec, "txn_country", &csTmp)) {
				sprintf(csTag, "txn_country_%d", i);
				PutField_CString(hRequest, csTag, csTmp);
DEBUGLOG(("GetDetailByCondition:: txn_country = [%s]\n", csTmp));
			}

			if (GetField_CString(hRec, "payout_ccy", &csTmp)) {
				sprintf(csTag, "txn_ccy_%d", i);
				PutField_CString(hRequest, csTag, csTmp);
				sprintf(csTag, "dst_txn_ccy_%d", i);
				PutField_CString(hRequest, csTag, csTmp);
DEBUGLOG(("GetDetailByCondition:: payout_ccy = [%s]\n", csTmp));
			}

			if (GetField_Double(hRec, "payout_amount", &dTmp)) {
				sprintf(csTag, "gen_payout_amt_%d", i);
				PutField_Double(hRequest, csTag, dTmp);
DEBUGLOG(("GetDetailByCondition:: payout_amount = [%lf]\n", dTmp));
			}

			if (GetField_CString(hRec, "psp_id", &csPspId)) {
				sprintf(csTag, "psp_id_%d", i);
				PutField_CString(hRequest, csTag, csPspId);

				if (i == 0) {
					hash_t *hPsp;
					hPsp = (hash_t*) malloc (sizeof(hash_t));
					hash_init(hPsp, 0);
					DBObjPtr = CreateObj(DBPtr, "DBOLPspDetail", "GetPayoutTmpAcct");
					if (!(*DBObjPtr)(csPspId, hPsp)) {
						if (GetField_CString(hPsp, "client_id", &csClient)) {
							PutField_CString(hRequest, "client_id", csClient);
DEBUGLOG(("GetDetailByCondition:: GetPspDetail - client id = [%s]\n", csClient));
						}
						if (GetField_CString(hPsp, "baid", &csBaid)) {
							sprintf(csTag, "baid_%d", i);
							PutField_CString(hRequest, csTag, csBaid);
DEBUGLOG(("GetDetailByCondition:: GetPspDetail - baid = [%s]\n", csBaid));
						}
					}
					FREE_ME(hPsp);
				}

				sprintf(csTag, "baid_%d", i);
				PutField_CString(hRequest, csTag, csBaid);
			}

			// get precal_fee
/*
			hash_t* hOrgRec;
			recordset_t *rOrgRecordSet;
			rOrgRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
			recordset_init(rOrgRecordSet, 0);
			DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "GetTxnPspDetail");
			iRet = (unsigned long)(*DBObjPtr)(csOrgTxnId, rOrgRecordSet);
			if (iRet == PD_OK) {
				hOrgRec = RecordSet_GetFirst(rOrgRecordSet);
				while (hOrgRec) {
					if (GetField_Double(hOrgRec, "service_fee", &dTmp)) {
						sprintf(csTag, "precal_fee_%d", i);
						PutField_Double(hRequest, csTag, dTmp);
					}
					hOrgRec = RecordSet_GetNext(rOrgRecordSet);
				}
			}
*/

			// add txn log
			if (iRet == PD_OK) {
				PutField_CString(hContext, "process_type", "0000");
				PutField_CString(hContext, "process_code", "000000");
				PutField_CString(hContext, "txn_code", PD_OL_PAYOUT_CANCEL_PSP);
				PutField_Int(hContext, "do_logging", PD_TRUE);
				PutField_Int(hContext, "db_commit", PD_FALSE);
DEBUGLOG(("GetDetailByCondition:: Call OMTChannel: AddTxnLog\n"));
				ChannelObjPtr = CreateObj(ChannelPtr, "OMTChannel", "AddTxnLog");
				if ((unsigned long)(*ChannelObjPtr)(hContext, hRequest) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("GetDetailByCondition:: Call OMTChannel: AddTxnLog Failed\n"));
				}
				PutField_Int(hContext, "do_logging", PD_FALSE);
			}

			// add hist
			if (iRet == PD_OK) {
DEBUGLOG(("GetDetailByCondition:: Call DBOLPayoutGenFileDtHist: Add\n"));
				DBObjPtr = CreateObj(DBPtr, "DBOLPayoutGenFileDtHist", "Add");
				if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("GetDetailByCondition:: Call DBOLPayoutGenFileDtHist: Add Failed\n"));
				}
			}

			// update OPA sub_status
/*
			if (iRet == PD_OK) {
				PutField_CString(hUploadTxn, "sub_status", PD_APPROVED_FOR_GENERATED);
DEBUGLOG(("GetDetailByCondition:: Call DBOLTransaction: Update\n"));
				DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
				if ((unsigned long)(*DBObjPtr)(hUploadTxn) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("GetDetailByCondition:: Call DBOLTransaction: Update Failed\n"));
				}
			}
*/

			// update OPG status & sub_status
			if (iRet == PD_OK) {
				PutField_Char(hOrgTxn, "status", PD_REVERSED);
				PutField_CString(hOrgTxn, "sub_status", PD_VOID);
DEBUGLOG(("GetDetailByCondition:: Call DBOLTransaction: Update\n"));
				DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
				if ((unsigned long)(*DBObjPtr)(hOrgTxn) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("GetDetailByCondition:: Call DBOLTransaction: Update Failed\n"));
				}
			}

			// void txn elements
			if (iRet == PD_OK) {
				PutField_CString(hRequest, "org_txn_code", PD_OL_PAYOUT_GENERATE);
				PutField_Int(hRequest, "return_pspfee", PD_FALSE);
DEBUGLOG(("GetDetailByCondition:: Call BOOLTxnElements: VoidOrgTxnElements\n"));
				BOObjPtr = CreateObj(BOPtr, "BOOLTxnElements", "VoidOrgTxnElements");
				if ((unsigned long)(*BOObjPtr)(hContext, hRequest) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("GetDetailByCondition:: Call BOOLTxnElements: VoidOrgTxnElements Failed\n"));
				}
			}

			// update payout generated file detail status & aux_txn_id
/*
			if (iRet == PD_OK) {
				PutField_Int(hTxn, "status", PAYOUT_MASTER_TRANSACTION_CANCELLED);
DEBUGLOG(("GetDetailByCondition:: Call DBOLPayoutGeneratedFileDT: UpdateByGenId\n"));
				DBObjPtr = CreateObj(DBPtr, "DBOLPayoutGeneratedFileDT", "UpdateByGenId");
				if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("GetDetailByCondition:: Call DBOLPayoutGeneratedFileDT: UpdateByGenId Failed\n"));
				}
			}
*/

			i++;
			PutField_Int(hContext, "total_cnt", i);
			hRec = RecordSet_GetNext(rRecordSet);
		}

		// update merchant upload file detail status
/*
		if (i != 0) {
DEBUGLOG(("HandleReconGenerate:: Call DBOLMerchantUploadFileDetail: ResumeGeneratedFile\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLMerchantUploadFileDetail", "ResumeGeneratedFile");
			iRet = (unsigned long)(*DBObjPtr)(csFileId, csUser);
			if (iRet == PD_OK){
				PutField_Int(hTxn, "status", PD_PAYOUTFILE_DECLINED);
DEBUGLOG(("HandleReconGenerate:: Call DBOLPayoutGeneratedFileHD: Update\n"));
				DBObjPtr = CreateObj(DBPtr, "DBOLPayoutGeneratedFileHD", "Update");
				iRet = (unsigned long)(*DBObjPtr)(hTxn);
			}
		}
*/
	}

	if ((iChk == PD_FOUND) && (iRet == PD_OK)) {
		PutField_CString(hContext, "sub_status", PD_REFUND_APPROVED);
		PutField_Char(hContext, "response_mode", PD_REVERSED);
		// PutField_CString(hContext, "desc", "Offline Payout Cancel(PSP)");
		PutField_Char(hContext, "party_type", PD_TYPE_PSP);
		if (GetField_CString(hContext, "PHDATE", &csTmp)) {
			PutField_CString(hContext, "approval_date", csTmp);
		}

		if (HandlePayoutBalance(hContext, hRequest) != PD_OK) {
DEBUGLOG(("HandleReconGenerate:: Call HandlePayoutBalance Failed\n"));
ERRLOG("BOOLPayout:: HandleReconGenerate: Call HandlePayoutBalance Failed\n");
			iRet = INT_ERR;
		}
	}

	if (iChk != PD_FOUND) {
		iRet = INT_NO_PENDING_RECORD;
		PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("HandleReconGenerate: No record to cancel\n"));
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hTxn);
	FREE_ME(hOrgTxn);
	// FREE_ME(hUploadTxn);

DEBUGLOG(("HandleReconGenerate: iRet = [%d]\n", iRet));
	return iRet;
}


int GetPayoutApiRecords(hash_t *hContext,
		hash_t *hRequest,
		hash_t *hResponse)
{
	int iRet = PD_OK;
	int iTmpRet;
	int iSeqNum = 0;
	int i = 0;
	int iTmp = 0;
	int iOnlineMode = PD_FALSE;
	int iIsProcessApprove = PD_FALSE;
	char *csTxnCode;
	char *csBatchId;
	char *csMerchantId;
	char *csServiceCode;
	char *csTxnCountry;
	char *csTxnCcy;
	char *csTxnId;
	char *csTmp;
	char *csMerchantClientId = NULL;
	double dTmp = 0.0;
	double dTotalAmt = 0.0;
	char csTag[PD_TAG_LEN + 1];

	hash_t *hTmp;
	hTmp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTmp, 0);

	recordset_t *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet, 0);
	hash_t *hRec;

	recordset_t *rTxn;
	rTxn = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rTxn, 0);
	hash_t *hTxn;

	hash_t *hPoReq;
	hPoReq = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hPoReq, 0);

	char* csPspTmp = strdup("");

DEBUGLOG(("BOOLPayout: GetPayoutApiRecords start\n"));

	if (GetField_CString(hContext, "txn_code", &csTxnCode)) {
DEBUGLOG(("txn_code = [%s]\n", csTxnCode));
	} else {
DEBUGLOG(("txn_code not found\n"));
ERRLOG("BOOLPayout: GetPayoutApiRecords:: txn_code not found\n");
		iRet = INT_TXN_CODE_NOT_MATCH;
		PutField_Int(hContext, "internal_error", iRet);
	}

	if (GetField_CString(hContext, "batch_id", &csBatchId)) {
DEBUGLOG(("batch_id = [%s]\n", csBatchId));
		PutField_CString(hTmp, "batch_id", csBatchId);
	} else {
DEBUGLOG(("batch_id not found\n"));
ERRLOG("BOOLPayout: GetPayoutApiRecords:: batch_id not found\n");
		iRet = INT_BATCH_ID_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
	}

	if (GetField_Int(hContext, "is_process_approve", &iIsProcessApprove)) {
DEBUGLOG(("is_process_approve = [%d]\n", iIsProcessApprove));
	}

/* get payout api batch header */
	if ((iRet == PD_OK) && (!iIsProcessApprove)) {
DEBUGLOG(("call DBOLPayoutApiBatchHD: MatchBatchStatus\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiBatchHD", "MatchBatchStatus");
		iTmpRet = (unsigned long)(*DBObjPtr)(csBatchId, csTxnCode, PD_OL_PO_API_PENDING);
		if (iTmpRet != PD_FOUND) {
DEBUGLOG(("call DBOLPayoutApiBatchHD: MatchBatchStatus not found\n"));
ERRLOG("BOOLPayout: GetPayoutApiRecords:: call DBOLPayoutApiBatchHD: MatchBatchStatus not found\n");
			iRet = INT_BATCH_ID_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

/* get payout api batch detail & transaction information */
	if (iRet == PD_OK) {
		RecordSet_Destroy(rRecordSet);
		recordset_init(rRecordSet, 0);

DEBUGLOG(("call DBOLPayoutApiBatchDT: GetDetailByBatchId\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiBatchDT", "GetDetailByBatchId");
		if ((unsigned long)(*DBObjPtr)(hTmp, rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);

			while (hRec) {
				if (GetField_CString(hRec, "txn_seq", &csTxnId) && GetField_Int(hRec, "seq", &iSeqNum)) {
					if (!iIsProcessApprove) {
						/* match payout request */
DEBUGLOG(("call DBOLPayoutRequest: MatchOLPayoutRequestStatus\n"));
						DBObjPtr = CreateObj(DBPtr, "DBOLPayoutRequest", "MatchOLPayoutRequestStatus");
						iTmpRet = (unsigned long)(*DBObjPtr)(csTxnId, PAYOUT_MASTER_TRANSACTION_CONFIRMED);
						if (iTmpRet != PD_FOUND) {
DEBUGLOG(("call DBOLPayoutRequest: MatchOLPayoutRequestStatus not found\n"));
ERRLOG("BOOLPayout: GetPayoutApiRecords:: call DBOLPayoutRequest: MatchOLPayoutRequestStatus not found\n");
							iRet = INT_PAYOUT_STATUS_NOT_SUPPORT;
							PutField_Int(hContext, "internal_error", iRet);
							break;
						}
					}

DEBUGLOG(("batch_id = [%s]\n", csBatchId));
					sprintf(csTag, "batch_id_%d", i); 
					PutField_CString(hRequest, csTag, csBatchId);

DEBUGLOG(("seq_num = [%d]\n", iSeqNum));
					sprintf(csTag, "seq_num_%d", i);
					PutField_Int(hRequest, csTag, iSeqNum);

DEBUGLOG(("org_txn_id = [%s]\n", csTxnId));
					sprintf(csTag, "org_txn_id_%d", i);
					PutField_CString(hContext, csTag, csTxnId);

					/* get payout request */
					hash_destroy(hPoReq);
					hash_init(hPoReq, 0);
DEBUGLOG(("call DBOLPayoutRequest: GetOLPayoutRequest\n"));
					DBObjPtr = CreateObj(DBPtr, "DBOLPayoutRequest", "GetOLPayoutRequest");
					if ((unsigned long)(*DBObjPtr)(csTxnId, hPoReq) == PD_OK) {
						if (GetField_CString(hPoReq, "payout_currency", &csTmp)) {
DEBUGLOG(("payout_currency = [%s]\n", csTmp));
							if (strcmp(csTmp, "RMB"))
								csTxnCcy = strdup(csTmp);
							else
								csTxnCcy = strdup(PD_CCY_ISO_CNY);

							sprintf(csTag, "dst_txn_ccy_%d", i);
							PutField_CString(hRequest, csTag, csTxnCcy);
							FREE_ME(csTxnCcy);
						}

						if (GetField_CString(hPoReq, "request_currency", &csTmp)) {
DEBUGLOG(("request_currency = [%s]\n", csTmp));
							if (strcmp(csTmp, "RMB"))
								csTxnCcy = strdup(csTmp);
							else
								csTxnCcy = strdup(PD_CCY_ISO_CNY);

							PutField_CString(hRequest, "txn_ccy", csTxnCcy);
							PutField_CString(hContext, "txn_ccy", csTxnCcy);
							sprintf(csTag, "txn_ccy_%d", i);
							PutField_CString(hRequest, csTag, csTxnCcy);
							PutField_CString(hContext, csTag, csTxnCcy);
							FREE_ME(csTxnCcy);
						}

						if (GetField_Double(hPoReq, "request_amount", &dTmp)) {
DEBUGLOG(("request_amount = [%lf]\n", dTmp));
							sprintf(csTag, "txn_amt_%d", i);
							PutField_Double(hRequest, csTag, dTmp);
							dTotalAmt += dTmp;
							PutField_Double(hContext, "total_net_amt", dTotalAmt);
						}

						if (GetField_Double(hPoReq, "payout_amount", &dTmp)) {
DEBUGLOG(("payout_amount = [%lf]\n", dTmp));
							sprintf(csTag, "payout_amount_%d", i);
							PutField_Double(hRequest, csTag, dTmp);
						}

						if (GetField_Double(hPoReq, "merchant_fee", &dTmp)) {
DEBUGLOG(("merchant_fee = [%lf]\n", dTmp));
							sprintf(csTag, "org_merchant_fee_%d", i);
							PutField_Double(hRequest, csTag, dTmp);
						}

						if (GetField_Int(hPoReq, "status", &iTmp)) {
DEBUGLOG(("status = [%i]\n", iTmp));
							sprintf(csTag, "status_%d", i);
							PutField_Int(hRequest, csTag, iTmp);
						}
					} else {
DEBUGLOG(("call DBOLPayoutRequest: GetOLPayoutRequest txn_id not found\n"));
ERRLOG("BOOLPayout: GetPayoutApiRecords:: call DBOLPayoutRequest: GetOLPayoutRequest txn_id not found\n");
						iRet = INT_TXN_ID_NOT_FOUND;
						PutField_Int(hContext, "internal_error", iRet);
						break;
					}

					/* get txn header */
					RecordSet_Destroy(rTxn);
					recordset_init(rTxn, 0);
DEBUGLOG(("call DBOLTransaction: GetTxnHeader\n"));
					DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnHeader");
					if ((unsigned long)(*DBObjPtr)(csTxnId, rTxn) == PD_OK) {
						hTxn = RecordSet_GetFirst(rTxn);

						if (GetField_CString(hTxn, "merchant_id", &csMerchantId)) {
DEBUGLOG(("merchant_id = [%s]\n", csMerchantId));
							PutField_CString(hRequest, "merchant_id", csMerchantId);
							PutField_CString(hContext, "merchant_id", csMerchantId);
							sprintf(csTag, "merchant_id_%d", i);
							PutField_CString(hRequest, csTag, csMerchantId);
							PutField_CString(hContext, csTag, csMerchantId);

							if (i == 0) {
								if (!GetField_CString(hContext, "merchant_client_id", &csMerchantClientId)) {
DEBUGLOG(("call BOOLMerchant: GetMerchantDetail\n"));
									BOObjPtr = CreateObj(BOPtr, "BOOLMerchant", "GetMerchantDetail");
									if ((unsigned long)(*BOObjPtr)(hContext, hRequest) == PD_OK) {
										if (GetField_CString(hContext, "merchant_client_id", &csMerchantClientId)) {
DEBUGLOG(("merchant_client_id = [%s]\n", csMerchantClientId));
										}
									}
								}
							}
							sprintf(csTag, "merchant_client_id_%d", i);
							PutField_CString(hContext, csTag, csMerchantClientId);
						} else {
DEBUGLOG(("merchant_id not found\n"));
							iRet = INT_MERCHANT_ID_NOT_FOUND;
							PutField_Int(hContext, "internal_error", iRet);
							break;
						}

						if (GetField_CString(hTxn, "service_code", &csServiceCode)) {
DEBUGLOG(("service_code = [%s]\n", csServiceCode));
							PutField_CString(hRequest, "service_code", csServiceCode);
							PutField_CString(hContext, "service_code", csServiceCode);
							sprintf(csTag, "service_code_%d", i);
							PutField_CString(hRequest, csTag, csServiceCode);
							PutField_CString(hContext, csTag, csServiceCode);

							// logic to be checked : start
							if (i == 0) {
								if (!GetField_Int(hContext, "check_first_txn", &iTmp)) {
DEBUGLOG(("call DBRulePayoutOnlineMode: ChkRuleExists\n"));
									DBObjPtr = CreateObj(DBPtr, "DBRulePayoutOnlineMode", "ChkRuleExists");
									if ((unsigned long)(DBObjPtr)(csMerchantId, csServiceCode) == PD_FOUND) {
DEBUGLOG(("call DBRulePayoutOnlineMode: FindPsp\n"));
										DBObjPtr = CreateObj(DBPtr, "DBRulePayoutOnlineMode", "FindPsp");
										if ((unsigned long)(DBObjPtr)(csMerchantId, csServiceCode, csPspTmp) == PD_FOUND) {
											PutField_CString(hContext, "first_txn_psp", csPspTmp);
											iOnlineMode = PD_TRUE;
DEBUGLOG(("psp_id = [%s]\n", csPspTmp));
										}
									}
									PutField_Int(hContext, "check_first_txn", PD_TRUE);
									PutField_Int(hContext, "first_txn_mode", iOnlineMode);
								} else {
									GetField_CString(hContext, "first_txn_psp", &csPspTmp);
									GetField_Int(hContext, "first_txn_mode", &iOnlineMode);
								}
							}

							if (iOnlineMode == PD_TRUE) {
								sprintf(csTag, "batch_mode_%d", i);
								PutField_Char(hRequest, csTag, PD_ONLINE);

								sprintf(csTag, "pregen_psp_id_%d", i);
								PutField_CString(hRequest, csTag, csPspTmp);
							} else {
								sprintf(csTag, "batch_mode_%d", i);
								PutField_Char(hRequest, csTag, PD_OFFLINE);
							}
							// logic to be checked : end
						} else {
DEBUGLOG(("service_code not found\n"));
							iRet = INT_SERVICE_CODE_MISSING;
							PutField_Int(hContext, "internal_error", iRet);
							break;
						}

						if (GetField_CString(hTxn, "merchant_ref", &csTmp)) {
DEBUGLOG(("merchant_ref = [%s]\n", csTmp));
							sprintf(csTag, "merchant_ref_%d", i);
							PutField_CString(hRequest, csTag, csTmp);
						}
					} else {
DEBUGLOG(("call DBOLTransaction: GetTxnHeader txn_id not found\n"));
ERRLOG("BOOLPayout: GetPayoutApiRecords:: call DBOLTransaction: GetTxnHeader txn_id not found\n");
						iRet = INT_TXN_ID_NOT_FOUND;
						PutField_Int(hContext, "internal_error", iRet);
						break;
					}

					/* get txn detail */
					RecordSet_Destroy(rTxn);
					recordset_init(rTxn, 0);
DEBUGLOG(("call DBOLTransaction: GetTxnDetail\n"));
					DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnDetail");
					if ((unsigned long)(*DBObjPtr)(csTxnId, rTxn) == PD_OK) {
						hTxn = RecordSet_GetFirst(rTxn);

						if (GetField_CString(hTxn, "txn_country", &csTxnCountry)) {
							PutField_CString(hRequest, "txn_country", csTxnCountry);
							PutField_CString(hContext, "txn_country", csTxnCountry);
							sprintf(csTag, "txn_country_%d", i);
							PutField_CString(hRequest, csTag, csTxnCountry);
							PutField_CString(hContext, csTag, csTxnCountry);
DEBUGLOG(("txn_country = [%s]\n", csTxnCountry));
						}

						if (GetField_CString(hTxn, "identity_id", &csTmp)) {
DEBUGLOG(("identity_id = [%s]\n", csTmp));
							sprintf(csTag, "identity_id_%d", i);
							PutField_CString(hRequest, csTag, csTmp);
						}

						if (GetField_CString(hTxn, "bank_name", &csTmp)) {
DEBUGLOG(("bank_name = [%s]\n", csTmp));	
							PutField_CString(hRequest, "bank_name", csTmp);
							sprintf(csTag, "bank_name_%d", i);
							PutField_CString(hRequest, csTag, csTmp);
						}

						if (GetField_CString(hTxn, "bank_code", &csTmp)) {
DEBUGLOG(("bank_code = [%s]\n", csTmp));
							sprintf(csTag, "bank_code_%d", i);
							PutField_CString(hRequest, csTag, csTmp);
						}

						if (GetField_CString(hTxn, "branch", &csTmp)) {
DEBUGLOG(("branch = [%s]\n", csTmp));
							sprintf(csTag, "branch_%d", i);
							PutField_CString(hRequest, csTag, csTmp);
						}

						if (GetField_CString(hTxn, "bank_acct_num", &csTmp)) {
DEBUGLOG(("account_id = [%s]\n", csTmp));
							sprintf(csTag, "account_id_%d", i);
							PutField_CString(hRequest, csTag, csTmp);
						}

						if (GetField_CString(hTxn, "account_name", &csTmp)) {
DEBUGLOG(("account_name = [%s]\n", csTmp));
							sprintf(csTag, "account_name_%d", i);
							PutField_CString(hRequest, csTag, csTmp);
						}
					} else {
DEBUGLOG(("call DBOLTransaction: GetTxnDetail txn_id not found\n"));
ERRLOG("BOOLPayout: GetPayoutApiRecords:: call DBOLTransaction: GetTxnDetail txn_id not found\n");
						iRet = INT_TXN_ID_NOT_FOUND;
						PutField_Int(hContext, "internal_error", iRet);
						break;
					}

					i++;
					PutField_Int(hContext, "last_seq", iSeqNum);
					PutField_Int(hContext, "total_cnt", i);
				} else {
DEBUGLOG(("call DBOLPayoutApiBatchDT: txn_id or seq not found\n"));
ERRLOG("BOOLPayout: GetPayoutApiRecords:: call DBOLPayoutApiBatchDT: txn_id or seq not found\n");
					iRet = INT_TXN_ID_NOT_FOUND;
					PutField_Int(hContext, "internal_error", iRet);
					break;
				}

				hRec = RecordSet_GetNext(rRecordSet);
			}
		} else {
DEBUGLOG(("call DBOLPayoutApiBatchDT: GetDetailByBatchId not found\n"));
ERRLOG("BOOLPayout: GetPayoutApiRecords:: call DBOLPayoutApiBatchDT: GetDetailByBatchId not found\n");
			iRet = INT_BATCH_ID_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	FREE_ME(csPspTmp);
	hash_destroy(hPoReq);
	FREE_ME(hPoReq);
	RecordSet_Destroy(rTxn);
	FREE_ME(rTxn);
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	hash_destroy(hTmp);
	FREE_ME(hTmp);
	return iRet;
}


int HandleCancelPayoutApi(hash_t *hContext, 
		hash_t *hRequest, 
		hash_t *hResponse)
{
        int     iRet = PD_OK;
        int     iDtlRet = PD_FOUND;

	int	i = 0;
	int     iTotalCnt = 0;

	char    *csBatchId= strdup("");	
	char	*csUser = NULL;
	char	*csTxnId = NULL;
	char	*csTmp = NULL;

	char 	csTag[PD_TAG_LEN + 1];
	char 	csRespCode[PD_TAG_LEN + 1];

	hash_t *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn, 0);

DEBUGLOG(("BOOLPayout:HandleCancelPayoutApi start\n"));

/* total_cnt */
        if (GetField_Int(hContext, "total_cnt", &iTotalCnt)) {
DEBUGLOG(("total_cnt = [%d]\n", iTotalCnt));
        } else {
DEBUGLOG(("total_cnt not found!!\n"));
ERRLOG("BOOLPayout:HandleCancelPayoutApi::total_cnt not found!!\n");
                iRet = INT_ERR;
	}	

/* batch_id */
	if (iRet == PD_OK) {
              	if (GetField_CString(hContext, "batch_id", &csBatchId)){
DEBUGLOG(("batch_id = [%s]\n", csBatchId));
		} else {
DEBUGLOG(("batch_id not found!!\n"));
ERRLOG("BOOLPayout:HandleCancelPayoutApi::batch_id not found!!\n");
                	iRet = INT_BATCH_ID_NOT_FOUND;
		}
	}

/* user */
 	if (iRet == PD_OK) {
		if(GetField_CString(hContext, "update_user", &csUser)){
DEBUGLOG(("update_user = [%s]\n", csUser));
		} else {
DEBUGLOG(("update_user not found!!\n"));
ERRLOG("BOOLPayout:HandleCancelPayoutApi:: update_user not found!!\n");
                        iRet = INT_USER_NOT_FOUND;
                }
	}

// Update OL_PAYOUT_API_BATCH_HD			
	if (iRet == PD_OK) {

		hash_destroy(hTxn);
		hash_init(hTxn, 0);
		
		PutField_CString(hTxn,"batch_id",csBatchId);
		PutField_Char(hTxn,"status",PD_OL_PO_API_PROCESSING);
		PutField_CString(hTxn,"update_user",csUser);

DEBUGLOG(("Call DBOLPayoutApiBatchHD:: Update\n"));
             	DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiBatchHD", "Update");
              	iRet = (unsigned long)(*DBObjPtr)(hTxn);
            	if (iRet != PD_OK) {
DEBUGLOG(("Call DBOLPayoutApiBatchHD:: Update Failure!!!\n"));
ERRLOG("BOOLPayout::HandleCancelPayoutApi::Call DBOLPayoutApiBatchHD:: Update Failure!!!\n");
                   	iRet = INT_ERR;
          	}
	}

// Update Payout API Records By Txn Seq
	if (iRet == PD_OK) {

		for (i=0; i<iTotalCnt; i++) {
	
			hash_destroy(hTxn);
			hash_init(hTxn, 0);
		
/* txn_seq */
			sprintf(csTag,"org_txn_id_%d",i);
                        if (GetField_CString(hContext,csTag,&csTxnId)){
				PutField_CString(hTxn,"org_txn_seq",csTxnId);
				PutField_CString(hTxn,"org_txn_id",csTxnId);
                                PutField_CString(hTxn,"txn_seq",csTxnId);
                                PutField_CString(hTxn,"txn_id",csTxnId);
DEBUGLOG(("txn_seq = [%s]\n",csTxnId));
                        }

/* user */
			PutField_CString(hTxn,"update_user",csUser);	

// Update OL_PAYOUT_REQUEST
                        if (iRet == PD_OK) {

DEBUGLOG(("Call DBOLPayoutRequest:: MatchOLPayoutRequestStatus_ForUpdate\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBOLPayoutRequest", "MatchOLPayoutRequestStatus_ForUpdate");
                                iDtlRet = (unsigned long)(*DBObjPtr)(csTxnId, PAYOUT_MASTER_TRANSACTION_CONFIRMED);
				if (iDtlRet == PD_FOUND) {
				
					PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_CANCELLED);

DEBUGLOG(("Call DBOLPayoutRequest:: Update\n"));
                                	DBObjPtr = CreateObj(DBPtr, "DBOLPayoutRequest", "Update");
                                	iRet = (unsigned long)(*DBObjPtr)(hTxn);
                                	if (iRet != PD_OK) {
DEBUGLOG(("Call DBOLPayoutRequest:: Update Failure!!!\n"));
ERRLOG("BOOLPayout::HandleCancelPayoutApi::Call DBOLPayoutRequest:: Update Failure!!!\n");
                                        	iRet = INT_ERR;
						break;
                                	}
				} else {
DEBUGLOG(("Call DBOLPayoutRequest:: MatchOLPayoutRequestStatus_ForUpdate not found\n"));
ERRLOG("BOOLPayout::HandleCancelPayoutApi::Call DBOLPayoutRequest:: MatchOLPayoutRequestStatus_ForUpdate not found\n");
                                       	iRet = INT_PAYOUT_STATUS_NOT_SUPPORT;
					break;
				}
                        }

// Update OL_TXN_HEADER
			if (iRet == PD_OK) {

				RemoveField_CString(hTxn, "org_txn_seq");
				RemoveField_Int(hTxn, "status");
		                PutField_Char(hTxn,"status",PD_COMPLETE);
        		        PutField_Char(hTxn,"ar_ind",PD_REJECTED);
				PutField_CString(hTxn,"sub_status",PD_ADMIN_CANCELLED);
                		PutField_Int(hTxn,"internal_code",INT_OPERATION_AGENT_DECLINED);
                		sprintf(csRespCode,"%d", INT_OPERATION_AGENT_DECLINED);
				PutField_CString(hTxn,"response_code",csRespCode);

DEBUGLOG(("Call OMTChannel:: UpdateTxnLog\n"));
                		ChannelObjPtr = CreateObj(ChannelPtr,"OMTChannel","UpdateTxnLog");
                		iRet = (unsigned long)(*ChannelObjPtr)(hTxn,hRequest,hRequest);
				if (iRet != PD_OK) {
DEBUGLOG(("Call OMTChannel:: UpdateTxnLog Failure!!!\n"));
ERRLOG("BOOLPayout::HandleCancelPayoutApi::Call OMTChannel:: UpdateTxnLog Failure!!!\n");                        	
					iRet = INT_ERR;
					break;
                		}
			}
		}
	}

// Handle Payout API Callback
	if (iRet == PD_OK) {

		if(!GetField_CString(hContext,"batch_txn_seq",&csTmp)){
			char    csBatchTxnSeq[PD_TXN_SEQ_LEN +1];
			DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextOmtTxnSeq");
			strcpy(csBatchTxnSeq,(*DBObjPtr)());
			PutField_CString(hContext,"batch_txn_seq",csBatchTxnSeq);
		}

		for (i=0; i<iTotalCnt; i++) {

/* txn_seq */
                        sprintf(csTag,"org_txn_id_%d",i);
                        if (GetField_CString(hContext,csTag,&csTxnId)){
			
				PutField_CString(hContext,"org_txn_seq",csTxnId);
DEBUGLOG(("txn_seq = [%s]\n",csTxnId));

DEBUGLOG(("Call TxnOplByUsACK::Authorize\n"));
                                TxnObjPtr = CreateObj(TxnPtr,"TxnOplByUsACK","Authorize");
                                iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
                                if (iRet != PD_OK) {
DEBUGLOG(("Call TxnOplByUsACK::Authorize Failure!!!\n"));
ERRLOG("BOOLPayout::HandleCancelPayoutApi::Call TxnOplByUsACK::Authorize Failure!!!\n");
                                        iRet = INT_ERR;
                                        break;
                                }

				RemoveField_CString(hContext, "org_txn_seq");
			} else {
DEBUGLOG(("Call TxnOplByUsACK::Authorize Not Found!!!\n"));
ERRLOG("BOOLPayout::HandleCancelPayoutApi::Call TxnOplByUsACK::Authorize Not Found!!!\n");
                            	iRet = INT_ERR;
                              	break;
			}
		}
	}

// Update OL_PAYOUT_API_BATCH_HD and OL_PAYOUT_API_BATCH_DT
        if (iRet == PD_OK) {

                hash_destroy(hTxn);
                hash_init(hTxn, 0);

                if (iRet == PD_OK) {
                        PutField_Char(hTxn,"status",PD_OL_PO_API_COMPLETE);
                }
                PutField_CString(hTxn,"batch_id",csBatchId);
                PutField_Int(hTxn,"ret_code",PD_OK);
                PutField_CString(hTxn,"update_user",csUser);

DEBUGLOG(("Call DBOLPayoutApiBatchDT:: UpdateByBatchId\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiBatchDT", "UpdateByBatchId");
                iRet = (unsigned long)(*DBObjPtr)(hTxn);
                if (iRet != PD_OK) {
DEBUGLOG(("Call DBOLPayoutApiBatchDT:: UpdateByBatchId Failure!!!\n"));
ERRLOG("BOOLPayout::HandleCancelPayoutApi::Call DBOLPayoutApiBatchDT:: UpdateByBatchId Failure!!!\n");
                        iRet = INT_ERR;
                }

                if (iRet == PD_OK) {
DEBUGLOG(("Call DBOLPayoutApiBatchHD:: Update\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiBatchHD", "Update");
                        iRet = (unsigned long)(*DBObjPtr)(hTxn);
                        if (iRet != PD_OK) {
DEBUGLOG(("Call DBOLPayoutApiBatchHD:: Update Failure!!!\n"));
ERRLOG("BOOLPayout::HandleCancelPayoutApi::Call DBOLPayoutApiBatchHD:: Update Failure!!!\n");
                                iRet = INT_ERR;
                        }
                }
        }

	FREE_ME(csBatchId);
	
	hash_destroy(hTxn);
	FREE_ME(hTxn);

DEBUGLOG(("BOOLPayout:HandleCancelPayoutApi iRet[%d]\n",iRet));
        return  iRet;
}


int GetPayoutApiPregenRecords(hash_t *hContext,
                hash_t *hRequest,
                hash_t *hResponse)
{
	int iRet = PD_OK;
        int iTmpRet = PD_FOUND;

        int iTxnCnt = 0;
        int iSeqNum = 0;
	int iPayoutGenMode = PD_FALSE;
        int iOnlineMode = PD_FALSE;
	int iOnlinePayout = PD_FALSE;
        int iTmp = 0;
        
	double dTmp = 0.0;
        double dTotalAmt = 0.0;
	
        char *csMerchantId = NULL;
        char *csServiceCode = NULL;
        char *csTxnCountry = NULL;
        char *csTxnCcy = NULL;
        char *csTxnId = NULL;
        char *csMerchantClientId = NULL;
        char *csTmp = NULL;
        char *csGetRecords = strdup("");
	char *csPspTmp = strdup("");
	char *csPspCcyTmp = strdup("");
        
	char csTag[PD_TAG_LEN + 1];
        
	hash_t  *hPsp;
        hPsp = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hPsp,0);

	hash_t *hPregen;
        hPregen = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hPregen, 0);

        hash_t *hRec;
        recordset_t *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet, 0);

	hash_t *hValues;
	hValues = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hValues, 0);

DEBUGLOG(("BOOLPayout:GetPayoutApiPregenRecords start\n"));

/* payout_gen_mode */ 
	if (GetField_Int(hRequest, "payout_gen_mode", &iPayoutGenMode)) {
DEBUGLOG(("payout_gen_mode = [%d]\n", iPayoutGenMode));
		PutField_Char(hPregen, "status", PD_OL_PO_API_PREVIEW);
		sprintf(csGetRecords, "GetRecordsForGen");
	} else {
DEBUGLOG(("payout_gen_mode = [%d]\n", iPayoutGenMode));
		PutField_Char(hPregen, "status", PD_OL_PO_API_PENDING);
		sprintf(csGetRecords, "GetRecordsForPregen");
	}

/* action_id */
	if (iRet == PD_OK) {
		if (GetField_CString(hContext, "action_id", &csTmp)) {
DEBUGLOG(("action_id = [%s]\n", csTmp));
                        PutField_CString(hPregen, "action_id", csTmp);
                } else {
DEBUGLOG(("action_id not found\n"));
ERRLOG("BOOLPayout:: GetPayoutApiPregenRecords:: action_id not found\n");
                	iRet = INT_BATCH_ID_NOT_FOUND;
                	PutField_Int(hContext, "internal_error", iRet);
		}
	}

/* match payout api pregen status */
	if (iRet == PD_OK) {
DEBUGLOG(("Call DBOLPayoutApiPregenHD:MatchPregenStatus\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiPregenHD", "MatchPregenStatus");
                iTmpRet = (unsigned long)(*DBObjPtr)(hPregen);
		if (iTmpRet != PD_FOUND) {
DEBUGLOG(("Call DBOLPayoutApiPregenHD:MatchPregenStatus not found\n"));
ERRLOG("BOOLPayout: GetPayoutApiPregenRecords:: Call DBOLPayoutApiPregenHD: MatchPregenStatus not found\n");
                        iRet = INT_BATCH_ID_NOT_FOUND;
                        PutField_Int(hContext, "internal_error", iRet);
		}
        }

/* get payout api pregen header, payout api pregen detail, payout request & transaction information */
	if (iRet == PD_OK) {

                RecordSet_Destroy(rRecordSet);
                recordset_init(rRecordSet, 0);

DEBUGLOG(("Call DBOLPayoutApiPregenDT: %s\n",csGetRecords));
               	DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiPregenDT",csGetRecords);
                if ((unsigned long)(*DBObjPtr)(hPregen, rRecordSet) == PD_OK) {
                        hRec = RecordSet_GetFirst(rRecordSet);	
			while (hRec) {

/* txn_id and seq */
                                if (GetField_CString(hRec, "txn_id", &csTxnId) && GetField_Int(hRec, "seq", &iSeqNum)) {
//DEBUGLOG(("seq_num = [%d]\n", iSeqNum));
                                        sprintf(csTag, "seq_num_%d", iTxnCnt);
                                        PutField_Int(hRequest, csTag, iSeqNum);

//DEBUGLOG(("txn_id = [%s]\n", csTxnId));
DEBUGLOG(("  seq_num [%05d] txn_id = [%s]\n", iSeqNum,csTxnId));
                                        sprintf(csTag, "org_txn_id_%d", iTxnCnt);
                                        PutField_CString(hRequest, csTag, csTxnId);
                                        PutField_CString(hContext, csTag, csTxnId);
                                } else {
DEBUGLOG(("Call DBOLPayoutApiPregenDT: txn_id or seq not found\n"));
ERRLOG("BOOLPayout: GetPayoutApiPregenRecords:: call DBOLPayoutApiPregenDT: txn_id or seq not found\n");
                                        iRet = INT_ERR;
                                        PutField_Int(hContext, "internal_error", iRet);
                                        break;
                                }

/* batch_id */
				if (GetField_CString(hRec, "batch_id", &csTmp)) {
//DEBUGLOG(("batch_id = [%s]\n", csTmp));
                                     	sprintf(csTag, "batch_id_%d", iTxnCnt);
                                    	PutField_CString(hRequest, csTag, csTmp);
                                    	PutField_CString(hContext, csTag, csTmp);
				}

/* payout_group */
                            	if (GetField_CString(hRec, "payout_group", &csTmp)) {
//DEBUGLOG(("payout_group = [%s]\n", csTmp));
					sprintf(csTag, "payout_group_%d", iTxnCnt);
                                       	PutField_CString(hContext, csTag, csTmp);
                              	}

/* pregen_ret_code */
                             	if (GetField_Int(hRec, "pregen_ret_code", &iTmp)) {
//DEBUGLOG(("pregen_ret_code = [%d]\n", iTmp));
					sprintf(csTag, "pregen_ret_code_%d", iTxnCnt);
                                    	PutField_Int(hContext, csTag, iTmp);
                               	}

/* gen_ret_code */
                                if (GetField_Int(hRec, "gen_ret_code", &iTmp)) {
//DEBUGLOG(("gen_ret_code = [%d]\n", iTmp));
                                        sprintf(csTag, "pregen_ret_code_%d", iTxnCnt);
                                        PutField_Int(hContext, csTag, iTmp);
                                }

/* psp_id */
				if (GetField_CString(hRec, "psp_id", &csTmp)) {
//DEBUGLOG(("psp_id = [%s]\n", csTmp));
                                       	sprintf(csTag, "psp_id_%d", iTxnCnt);
                                       	PutField_CString(hRequest, csTag, csTmp);						
				}

/* to_bank_code */
                           	if (GetField_CString(hRec, "to_bank_code", &csTmp)) {
//DEBUGLOG(("to_bank_code = [%s]\n", csTmp));
                                       	sprintf(csTag, "to_bank_code_%d", iTxnCnt);
                                     	PutField_CString(hRequest, csTag, csTmp);                
                               	}

/* file_id */
				if (GetField_Int(hRec, "file_id", &iTmp)) {
//DEBUGLOG(("file_id = [%d]\n", iTmp));
                                     	sprintf(csTag, "file_id_%d", iTxnCnt);
                                   	PutField_Int(hRequest, csTag, iTmp);
                               	}
				
/* merchant_payout_grp */
                             	if (GetField_CString(hRec, "merchant_payout_grp", &csTmp)) {
//DEBUGLOG(("merchant_payout_grp = [%s]\n", csTmp));
                                  	PutField_CString(hRequest, "merchant_payout_grp", csTmp);
                                   	sprintf(csTag, "merchant_payout_grp_%d", iTxnCnt);
                                    	PutField_CString(hRequest, csTag, csTmp);
                             	}

/* psp_payout_grp */
                            	if (GetField_CString(hRec, "psp_payout_grp", &csTmp)) {
//DEBUGLOG(("psp_payout_grp = [%s]\n", csTmp));
                                     	PutField_CString(hRequest, "psp_payout_grp", csTmp);
                                       	sprintf(csTag, "psp_payout_grp_%d", iTxnCnt);
                                      	PutField_CString(hRequest, csTag, csTmp);
                            	}

/* request_currency */
                             	if (GetField_CString(hRec, "request_currency", &csTmp)) {
//DEBUGLOG(("request_currency = [%s]\n", csTmp));
                                      	if (strcmp(csTmp, "RMB"))
                                               	csTxnCcy = strdup(csTmp);
                                       	else
                                         	csTxnCcy = strdup(PD_CCY_ISO_CNY);

                                       	PutField_CString(hRequest, "txn_ccy", csTxnCcy);
                                        PutField_CString(hContext, "txn_ccy", csTxnCcy);
                                        sprintf(csTag, "txn_ccy_%d", iTxnCnt);
                                        PutField_CString(hRequest, csTag, csTxnCcy);
                                 	PutField_CString(hContext, csTag, csTxnCcy);
                                      	sprintf(csTag, "request_ccy_%d", iTxnCnt);
                                       	PutField_CString(hRequest, csTag, csTxnCcy);
                                       	FREE_ME(csTxnCcy);
                              	}

/* request_amount */
                        	if (GetField_Double(hRec, "request_amount", &dTmp)) {
//DEBUGLOG(("request_amount = [%lf]\n", dTmp));
                                  	sprintf(csTag, "txn_amt_%d", iTxnCnt);
                                       	PutField_Double(hRequest, csTag, dTmp);
                                     	sprintf(csTag, "request_amount_%d", iTxnCnt);
                                      	PutField_Double(hRequest, csTag, dTmp);
                                      	dTotalAmt += dTmp;
                                      	PutField_Double(hContext, "total_net_amt", dTotalAmt);
                             	}

/* payout_currency */

                           	if (GetField_CString(hRec, "payout_currency", &csTmp)) {
//DEBUGLOG(("payout_currency = [%s]\n", csTmp));
                                  	if (strcmp(csTmp, "RMB"))
                                              	csTxnCcy = strdup(csTmp);
                                      	else
                                           	csTxnCcy = strdup(PD_CCY_ISO_CNY);

                                  	sprintf(csTag, "dst_txn_ccy_%d", iTxnCnt);
                                    	PutField_CString(hRequest, csTag, csTxnCcy);
                                     	sprintf(csTag, "payout_ccy_%d", iTxnCnt);
                                     	PutField_CString(hRequest, csTag, csTxnCcy);
                                     	FREE_ME(csTxnCcy);
                              	}

/* payout_amount */
				if (GetField_Double(hRec, "payout_amount", &dTmp)) {
//DEBUGLOG(("payout_amount = [%lf]\n", dTmp));
                                       	sprintf(csTag, "payout_amount_%d", iTxnCnt);
                                    	PutField_Double(hRequest, csTag, dTmp);
                            	}
				
/* merchant_fee_ccy */
				if (GetField_CString(hRec, "merchant_fee_ccy", &csTmp)) {
//DEBUGLOG(("merchant_fee_ccy = [%s]\n", csTmp));
                                        sprintf(csTag, "org_merchant_fee_%d", iTxnCnt);
                                        PutField_CString(hRequest, csTag, csTmp);
                                }

/* merchant_fee */
                              	if (GetField_Double(hRec, "merchant_fee", &dTmp)) {
//DEBUGLOG(("merchant_fee = [%lf]\n", dTmp));
                                       	sprintf(csTag, "org_merchant_fee_%d", iTxnCnt);
                                      	PutField_Double(hRequest, csTag, dTmp);
                           	}

/* status */
                             	if (GetField_Int(hRec, "status", &iTmp)) {
//DEBUGLOG(("status = [%i]\n", iTmp));
                                       	sprintf(csTag, "status_%d", iTxnCnt);
                                      	PutField_Int(hRequest, csTag, iTmp);
                            	}

/* merchant_id */
				if (GetField_CString(hRec, "merchant_id", &csMerchantId)) {
//DEBUGLOG(("merchant_id = [%s]\n", csMerchantId));
                                    	PutField_CString(hRequest, "merchant_id", csMerchantId);
                                    	PutField_CString(hContext, "merchant_id", csMerchantId);
                                     	sprintf(csTag, "merchant_id_%d", iTxnCnt);
                                      	PutField_CString(hRequest, csTag, csMerchantId);
                                     	PutField_CString(hContext, csTag, csMerchantId);

					sprintf(csTag,"%s_online_payout",csMerchantId);
					if (GetField_Int(hValues,csTag,&iOnlinePayout)) {
						PutField_Int(hContext,"online_payout",iOnlinePayout);
						sprintf(csTag, "online_payout_%d", iTxnCnt);
						PutField_Int(hContext,csTag,iOnlinePayout);
					} else {

					// Check Rule Payout Online Mode
        				if (iRet == PD_OK) {
                				PutField_Int(hContext,"online_payout",iOnlinePayout);
						sprintf(csTag, "online_payout_%d", iTxnCnt);
                                               	PutField_Int(hContext,csTag,iOnlinePayout);

//DEBUGLOG(("Call DBRulePayoutOnlineMode::ChkRuleExistsByMerchant\n"));
                        			DBObjPtr = CreateObj(DBPtr,"DBRulePayoutOnlineMode","ChkRuleExistsByMerchant");
                        			iTmpRet = (unsigned long)(DBObjPtr)(csMerchantId);
                        			if (iTmpRet == PD_FOUND){
                                			iOnlinePayout = PD_TRUE;
                                			PutField_Int(hContext,"online_payout",iOnlinePayout);
							sprintf(csTag, "online_payout_%d", iTxnCnt);
							PutField_Int(hContext,csTag,iOnlinePayout);
//DEBUGLOG(("Call DBRulePayoutOnlineMode::ChkRuleExistsByMerchant iOnlinePayout = 1\n"));
DEBUGLOG(("  iOnlinePayout = 1\n"));
                        			}
        				}

					sprintf(csTag,"%s_online_payout",csMerchantId);
					PutField_Int(hValues,csTag,iOnlinePayout);
DEBUGLOG(("  [%s] [%d]\n",csTag,iOnlinePayout));
					}

                                    	if (iTxnCnt == 0) {
                                            	if (!GetField_CString(hContext, "merchant_client_id", &csMerchantClientId)) {
DEBUGLOG(("Call BOOLMerchant: GetMerchantDetail\n"));
                                                    	BOObjPtr = CreateObj(BOPtr, "BOOLMerchant", "GetMerchantDetail");
                                                   	if ((unsigned long)(*BOObjPtr)(hContext, hRequest) == PD_OK) {
                                                             	if (GetField_CString(hContext, "merchant_client_id", &csMerchantClientId)) {
//DEBUGLOG(("merchant_client_id = [%s]\n", csMerchantClientId));
                                                             	}
                                                     	} else {
DEBUGLOG(("Call BOOLMerchant: GetMerchantDetail not found\n"));
ERRLOG("BOOLPayout: GetPayoutApiPregenRecords:: call BOOLMerchant: GetMerchantDetail not found\n");
                                                     	}
                                             	}
                                   	}
                                        sprintf(csTag, "merchant_client_id_%d", iTxnCnt);
                                      	PutField_CString(hContext, csTag, csMerchantClientId);
                          	} else {
DEBUGLOG(("merchant_id not found\n"));
ERRLOG("BOOLPayout: merchant_id not found\n");
                                    	iRet = INT_MERCHANT_ID_NOT_FOUND;
                                     	PutField_Int(hContext, "internal_error", iRet);
                                     	break;
                           	}

/* merchant_ref */
				if (GetField_CString(hRec, "merchant_ref", &csTmp)) {
//DEBUGLOG(("merchant_ref = [%s]\n", csTmp));
                                   	sprintf(csTag, "merchant_ref_%d", iTxnCnt);
                                     	PutField_CString(hRequest, csTag, csTmp);
                            	}

/* servcice_code */
				if (GetField_CString(hRec, "service_code", &csServiceCode)) {
//DEBUGLOG(("service_code = [%s]\n", csServiceCode));
					PutField_CString(hRequest, "service_code", csServiceCode);
					PutField_CString(hContext, "service_code", csServiceCode);
					sprintf(csTag, "service_code_%d", iTxnCnt);
					PutField_CString(hRequest, csTag, csServiceCode);
					PutField_CString(hContext, csTag, csServiceCode);

// logic to be checked : start
					if (iTxnCnt == 0) {
						if (!GetField_Int(hContext, "check_first_txn", &iTmp)) {

							hash_destroy(hPsp);
							hash_init(hPsp,0);

DEBUGLOG(("Call DBRulePayoutOnlineMode:ChkRuleExists\n"));
							DBObjPtr = CreateObj(DBPtr, "DBRulePayoutOnlineMode", "ChkRuleExists");
							if ((unsigned long)(DBObjPtr)(csMerchantId, csServiceCode) == PD_FOUND) {
DEBUGLOG(("Call DBRulePayoutOnlineMode:FindPspInfo\n"));
								DBObjPtr = CreateObj(DBPtr, "DBRulePayoutOnlineMode", "FindPspInfo");
								if ((unsigned long)(DBObjPtr)(csMerchantId, csServiceCode, hPsp) == PD_FOUND) {

									if(GetField_CString(hPsp,"psp_id",&csPspTmp)){
										PutField_CString(hContext, "first_txn_psp", csPspTmp);
										PutField_CString(hRequest, "pregen_psp_id", csPspTmp);
//DEBUGLOG(("FindPspInfo: psp_id = [%s]\n", csPspTmp));

										if(GetField_CString(hPsp,"psp_ccy",&csPspCcyTmp)){
											PutField_CString(hRequest, "pregen_psp_ccy", csPspCcyTmp);
//DEBUGLOG(("FindPspInfo: psp_ccy = [%s]\n", csPspCcyTmp));
										}

										iOnlineMode = PD_TRUE;
//DEBUGLOG(("FindPspInfo: online_mode = [%d]\n", PD_TRUE));
									}
								}
							}
							PutField_Int(hContext, "check_first_txn", PD_TRUE);
							PutField_Int(hContext, "first_txn_mode", iOnlineMode);
						} else {
							GetField_CString(hContext, "first_txn_psp", &csPspTmp);
							GetField_Int(hContext, "first_txn_mode", &iOnlineMode);
						}
					}

					if (iOnlineMode == PD_TRUE) {
						sprintf(csTag, "pregen_psp_id_%d", iTxnCnt);
						PutField_CString(hRequest, csTag, csPspTmp);

						sprintf(csTag, "pregen_psp_ccy_%d", iTxnCnt);
						PutField_CString(hRequest, csTag, csPspCcyTmp);
					}
// logic to be checked : end
				} else {
DEBUGLOG(("service_code not found\n"));
ERRLOG("BOOLPayout: service_code not found\n");
					iRet = INT_SERVICE_CODE_MISSING;
					PutField_Int(hContext, "internal_error", iRet);
					break;
				}

/* txn_country */
				if (GetField_CString(hRec, "txn_country", &csTxnCountry)) {
                                     	PutField_CString(hRequest, "txn_country", csTxnCountry);
                                   	PutField_CString(hContext, "txn_country", csTxnCountry);
                                     	sprintf(csTag, "txn_country_%d", iTxnCnt);
                                       	PutField_CString(hRequest, csTag, csTxnCountry);
                                   	PutField_CString(hContext, csTag, csTxnCountry);
//DEBUGLOG(("txn_country = [%s]\n", csTxnCountry));
                             	}

/* identity_id */

                             	if (GetField_CString(hRec, "identity_id", &csTmp)) {
//DEBUGLOG(("identity_id = [%s]\n", csTmp));
                                       	sprintf(csTag, "identity_id_%d", iTxnCnt);
                                   	PutField_CString(hRequest, csTag, csTmp);
                            	}

/* bank_name */
                                if (GetField_CString(hRec, "bank_name", &csTmp)) {
//DEBUGLOG(("bank_name = [%s]\n", csTmp));
                                    	PutField_CString(hRequest, "bank_name", csTmp);
                                    	sprintf(csTag, "bank_name_%d", iTxnCnt);
                                     	PutField_CString(hRequest, csTag, csTmp);
                            	}

/* bank_code */
                               	if (GetField_CString(hRec, "bank_code", &csTmp)) {
//DEBUGLOG(("bank_code = [%s]\n", csTmp));
                                    	sprintf(csTag, "bank_code_%d", iTxnCnt);
                                     	PutField_CString(hRequest, csTag, csTmp);
                           	}

/* branch */
                           	if (GetField_CString(hRec, "branch", &csTmp)) {
//DEBUGLOG(("branch = [%s]\n", csTmp));
                                    	sprintf(csTag, "branch_%d", iTxnCnt);
                                     	PutField_CString(hRequest, csTag, csTmp);
                            	}

/* bank_acct_num */
                            	if (GetField_CString(hRec, "bank_acct_num", &csTmp)) {
//DEBUGLOG(("account_num_ = [%s]\n", csTmp));
                                    	sprintf(csTag, "account_num_%d", iTxnCnt);
                                      	PutField_CString(hRequest, csTag, csTmp);
                             	}

/* account_name */
                             	if (GetField_CString(hRec, "account_name", &csTmp)) {
//DEBUGLOG(("account_name = [%s]\n", csTmp));
                                    	sprintf(csTag, "account_name_%d", iTxnCnt);
                                      	PutField_CString(hRequest, csTag, csTmp);
                            	}

/* account_id */
				if (GetField_CString(hRec, "account_id", &csTmp)) {
//DEBUGLOG(("account_id = [%s]\n", csTmp));
                                    	sprintf(csTag, "account_id_%d", iTxnCnt);
                                       	PutField_CString(hRequest, csTag, csTmp);
                            	}

/* remark */
                            	if (GetField_CString(hRec, "remark", &csTmp)) {
//DEBUGLOG(("remark = [%s]\n", csTmp));
                                   	sprintf(csTag, "remark_%d", iTxnCnt);
                                    	PutField_CString(hRequest, csTag, csTmp);
                             	}

/* province */
                           	if (GetField_CString(hRec, "province", &csTmp)) {
//DEBUGLOG(("province = [%s]\n", csTmp));
                                     	sprintf(csTag, "province_%d", iTxnCnt);
                                      	PutField_CString(hRequest, csTag, csTmp);
                          	}

/* phone_no */
                          	if (GetField_CString(hRec, "phone_no", &csTmp)) {
//DEBUGLOG(("phone_no = [%s]\n", csTmp));
                                    	sprintf(csTag, "phone_num_%d", iTxnCnt);
                                     	PutField_CString(hRequest, csTag, csTmp);
                             	}

/* city */
                             	if (GetField_CString(hRec, "city", &csTmp)) {
//DEBUGLOG(("city = [%s]\n", csTmp));
                                   	sprintf(csTag, "city_%d", iTxnCnt);
                                      	PutField_CString(hRequest, csTag, csTmp);
                           	}

				iTxnCnt++;
                                PutField_Int(hContext, "last_seq", iSeqNum);
                                PutField_Int(hContext, "txn_cnt", iTxnCnt);

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                } else {
DEBUGLOG(("Call DBOLPayoutApiPregenDT: %s not found\n", csGetRecords));
ERRLOG("BOOLPayout: GetPayoutApiPregenRecords:: call DBOLPayoutApiPregenDT: %s not found\n", csGetRecords);
                        iRet = INT_ERR;
                        PutField_Int(hContext, "internal_error", iRet);
                }
	}

	FREE_ME(csGetRecords);
	FREE_ME(csPspTmp);
	FREE_ME(csPspCcyTmp);

	hash_destroy(hPsp);
        FREE_ME(hPsp);
	hash_destroy(hPregen);
        FREE_ME(hPregen);

	hash_destroy(hValues);
        FREE_ME(hValues);

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("BOOLPayout::GetPayoutApiPregenRecords iRet[%d]\n",iRet));
        return  iRet;
}


int GetPayoutApiGenRecords(hash_t *hContext,
                hash_t *hRequest,
                hash_t *hResponse)
{
	int     iRet = PD_OK;

DEBUGLOG(("BOOLPayout:GetPayoutApiGenRecords start\n"));

	PutField_Int(hRequest, "payout_gen_mode", PD_TRUE);

	iRet = GetPayoutApiPregenRecords(hContext, hRequest, hResponse);
	
DEBUGLOG(("BOOLPayout::GetPayoutApiGenRecords iRet[%d]\n",iRet));
        return  iRet;
}


int HandlePreGeneratePayoutApi(hash_t *hContext,
                 hash_t* hRequest,
                 hash_t* hResponse)
{
        int     iRet = PD_OK;
	int	iTmpRet = PD_FOUND;

	int	iOnlinePayout = PD_FALSE;
        int     iTotalTxnCnt = 0;

	char    *csActionId = strdup("");
	char    *csMerchantId = strdup("");
        char    *csUser = NULL;

	char 	csTag[PD_TAG_LEN + 1];

	hash_t *hPregen;
        hPregen = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hPregen, 0);

        hash_t *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn, 0);	

DEBUGLOG(("BOOLPayout:HandlePreGeneratePayoutApi start\n"));

/* action_id */
       	if (GetField_CString(hContext, "action_id", &csActionId)) {
DEBUGLOG(("action_id = [%s]\n", csActionId));
              	PutField_CString(hPregen, "action_id", csActionId);
      	} else {
DEBUGLOG(("action_id not found\n"));
ERRLOG("BOOLPayout:: HandlePreGeneratePayoutApi:: action_id not found\n");
              	iRet = INT_BATCH_ID_NOT_FOUND;
        }

/* txn_cnt */
	if (iRet == PD_OK) {
        	if (GetField_Int(hContext, "txn_cnt", &iTotalTxnCnt)) {
DEBUGLOG(("txn_cnt = [%d]\n", iTotalTxnCnt));
        	} else {
DEBUGLOG(("txn_cnt not found!!\n"));
ERRLOG("BOOLPayout:HandlePreGeneratePayoutApi::txn_cnt not found!!\n");
			iRet = INT_ERR;
		}
	}

/* online_payout */
        if (iRet == PD_OK) {
                if (GetField_Int(hContext,"online_payout",&iOnlinePayout)) {
DEBUGLOG(("online_payout = [%d]\n",iOnlinePayout));
                }
        }

/* user */
        if (iRet == PD_OK) {
                if(GetField_CString(hContext, "update_user", &csUser)){
DEBUGLOG(("update_user = [%s]\n", csUser));
                } else {
DEBUGLOG(("update_user not found!!\n"));
ERRLOG("BOOLPayout:HandlePreGeneratePayoutApi::update_user not found!!\n");
                        iRet = INT_USER_NOT_FOUND;
                }
        }

	// init psp count = 0
	if (iRet == PD_OK) {
		PutField_Int(hResponse,"total_cnt",0);
	}

	// Update OL_PAYOUT_API_PREGEN_HD
        if (iRet == PD_OK) {

		// status
		PutField_Char(hPregen, "status", PD_OL_PO_API_PENDING);

DEBUGLOG(("Call DBOLPayoutApiPregenHD: MatchPregenStatus_ForUpdate\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiPregenHD", "MatchPregenStatus_ForUpdate");
                iTmpRet = (unsigned long)(*DBObjPtr)(hPregen);
		if (iTmpRet == PD_FOUND) {
	
			hash_destroy(hTxn);
                	hash_init(hTxn, 0);	

                        PutField_CString(hTxn, "action_id", csActionId);
                	PutField_Char(hTxn,"status",PD_OL_PO_API_PROCESSING);
                	PutField_CString(hTxn,"update_user",csUser);
	
DEBUGLOG(("Call DBOLPayoutApiPregenHD:: Update\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiPregenHD", "Update");
                	iRet = (unsigned long)(*DBObjPtr)(hTxn);
			if (iRet == PD_OK) {
DEBUGLOG(("Call DBOLPayoutApiPregenHD:: TxnCommit\n"));
                                TxnCommit();
                	} else {
DEBUGLOG(("Call DBOLPayoutApiPregenHD:: Update Failure!!!\n"));
ERRLOG("BOOLPayout::HandlePreGeneratePayoutApi::Call DBOLPayoutApiPregenHD:: Update Failure!!!\n");
                	        iRet = INT_ERR;
                	}           
		} else {
DEBUGLOG(("Call DBOLPayoutApiPregenHD: MatchPregenStatus_ForUpdate not found\n"));
ERRLOG("BOOLPayout: HandlePreGeneratePayoutApi:: call DBOLPayoutApiPregenHD: MatchPregenStatus_ForUpdate not found\n");
                        iRet = INT_TXN_STATUS_NOT_MATCH;
                }
        }

	// Process Payout Group Rule
        if (iRet == PD_OK) {
                if(!iOnlinePayout){
                        iRet = ProcessOfflineApiPayoutRule(hContext,hRequest);
                } else {
                        iRet = ProcessOnlineApiPayoutRule(hContext,hRequest);
                }
      	}

	// Get Existing Psp Details
	if (iRet == PD_OK) {
                int	iPspCnt = 0;
		int	iPspTxnCnt = 0;

                char    *csPspId = NULL;
                char    *csBankCode = NULL;
                char    *csCcy = NULL;
                char    *csCountry = NULL;

		hash_t *hRec;
        	recordset_t *rRecordSet;
        	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        	recordset_init(rRecordSet, 0);
	
                if(!iOnlinePayout) {
DEBUGLOG(("Call DBOLPayoutApiPregenDT: GetExistingPsp\n"));
                        DBObjPtr = CreateObj(DBPtr,"DBOLPayoutApiPregenDT","GetExistingPsp");
                } else {
DEBUGLOG(("Call DBOLPayoutApiPregenDT: GetExistingPspOnlineMode\n"));
                        DBObjPtr = CreateObj(DBPtr,"DBOLPayoutApiPregenDT","GetExistingPspOnlineMode");
		}

                if((unsigned long) ((*DBObjPtr)(hPregen,rRecordSet))==PD_OK){
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while(hRec){

/* psp_id */
                                if(GetField_CString(hRec,"psp_id",&csPspId)){
                                        sprintf(csTag, "psp_id_%d", iPspCnt);
                                        PutField_CString(hContext,csTag,csPspId);
DEBUGLOG(("GetExistingPsp psp_id [%s]\n",csPspId));
                                }

/* bank_code */
                                if(GetField_CString(hRec,"bank_code",&csBankCode)){
                                        sprintf(csTag, "bank_code_%d", iPspCnt);
                                        PutField_CString(hContext,csTag,csBankCode);
DEBUGLOG(("GetExistingPsp bank_code [%s]\n",csBankCode));
                                }

/* psp_ccy */
                                if(GetField_CString(hRec,"psp_ccy",&csCcy)){
                                        sprintf(csTag, "%s_%s_payout_ccy", csPspId,csBankCode);
                                        PutField_CString(hContext,csTag,csCcy);
DEBUGLOG(("GetExistingPsp psp_ccy [%s]\n",csCcy));
                                }

/* psp_country */
                                if(GetField_CString(hRec,"psp_country",&csCountry)){
DEBUGLOG(("GetExistingPsp psp_country [%s]\n",csCountry));
                                }

/* txn_count */
                                if(GetField_Int(hRec,"txn_count",&iPspTxnCnt)){ //total txn count in psp
DEBUGLOG(("GetExistingPsp txn_count [%d]\n",iPspTxnCnt));
                                }

				iPspCnt++;
                                PutField_Int(hResponse,"total_cnt",iPspCnt); //total psp count

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
		}

		RecordSet_Destroy(rRecordSet);
        	FREE_ME(rRecordSet);
	}

	// Update Response
	if (iRet == PD_OK) {
                iRet = FormatResponse(hContext,hResponse);
        }

	// Update OL_PAYOUT_API_PREGEN_HD
        if ((iRet == PD_OK) || (iRet == INT_NO_PAYOUT_MATCH_RULE)) {

		// status
		PutField_Char(hPregen, "status", PD_OL_PO_API_PROCESSING);
		
DEBUGLOG(("Call DBOLPayoutApiPregenHD: MatchPregenStatus_ForUpdate\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiPregenHD", "MatchPregenStatus_ForUpdate");
              	iTmpRet = (unsigned long)(*DBObjPtr)(hPregen);
                if (iTmpRet == PD_FOUND) {

			hash_destroy(hTxn);
                	hash_init(hTxn, 0);

                       	PutField_CString(hTxn, "action_id", csActionId);
                	PutField_Char(hTxn,"status",PD_OL_PO_API_PREVIEW);
                	PutField_Int(hTxn,"pregen_ret_code",iRet);
                	PutField_CString(hTxn,"update_user",csUser);

DEBUGLOG(("Call DBOLPayoutApiPregenHD:: Update\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiPregenHD", "Update");
                	iRet = (unsigned long)(*DBObjPtr)(hTxn);
                	if (iRet != PD_OK) {
DEBUGLOG(("Call DBOLPayoutApiPregenHD:: Update Failure!!!\n"));
ERRLOG("BOOLPayout::HandlePreGeneratePayoutApi::Call DBOLPayoutApiPregenHD:: Update Failure!!!\n");
                	        iRet = INT_ERR;
               	 	}
		} else {
DEBUGLOG(("Call DBOLPayoutApiPregenHD: MatchPregenStatus_ForUpdate not found\n"));
ERRLOG("BOOLPayout: HandlePreGeneratePayoutApi:: call DBOLPayoutApiPregenHD: MatchPregenStatus_ForUpdate not found\n");
                        iRet = INT_TXN_STATUS_NOT_MATCH;
               }
        }

	FREE_ME(csActionId);
	FREE_ME(csMerchantId);

	hash_destroy(hPregen);
        FREE_ME(hPregen);

	hash_destroy(hTxn);
	FREE_ME(hTxn);

DEBUGLOG(("BOOLPayout::HandlePreGeneratePayoutApi iRet[%d]\n",iRet));
        return  iRet;
}


int ProcessOfflineApiPayoutRule(hash_t *hContext, hash_t *hRequest)
{
        int     iRet = PD_OK;

	int	iPreGenFileId = 0;
        int     i = 0;
	int     iCnt = 0;
        int     iTier = 0;
        int     iResult = 0;
	int     iChk = PD_OK;
        int     iAccept = PD_FALSE;
        int     iStatus = PD_FALSE;
	int     iTmp = 0;

	double  dTxnAmt = 0.0;
        double  dPspAmt = 0.0;
        double  dTotalTierAmt = 0.0;
        double  dTotalPayoutAmt = 0.0;
	double  dTmp=0.0;
       
        char    *csBatchId = NULL;
        char    *csTxnId = NULL;
        char    *csPspId = NULL;
        char    *csOperType = NULL;
        char    *csToBank = NULL;
        char    *csTmpBank = NULL;
        char    *csTmp = NULL;

	char    csBankName[PD_BANK_NAME_LEN+1];
        char    csTag[PD_TAG_LEN +1];
        char    csTagTwo[PD_TAG_LEN +1];

        hash_t  *hRec;
        hash_t  *hDtl;

        hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

        recordset_t     *rDetailSet;
        rDetailSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rDetailSet,0);

DEBUGLOG(("BOOLPayout:ProcessOfflineApiPayoutRule()\n"));
	
DEBUGLOG(("Call DBOLRulePayoutPsp:GetRulePayoutPspWithPriority\n"));
        DBObjPtr = CreateObj(DBPtr,"DBOLRulePayoutPsp","GetRulePayoutPspWithPriority");
        if ((unsigned long)(*DBObjPtr)(rRecordSet) == PD_OK) {
	
		hRec = RecordSet_GetFirst(rRecordSet);

		while (hRec && iChk == PD_OK) {

			hash_destroy(hTxn);
                        hash_init(hTxn,0);

/* action_id */
			if (GetField_CString(hContext,"action_id",&csTmp)) {
                                PutField_CString(hTxn,"action_id",csTmp);
DEBUGLOG(("GetRulePayoutPspWithPriority::action_id = [%s]\n",csTmp));
			}	

/* file_id */
			// Set Pregen File Id
			iPreGenFileId = 0;
                	PutField_Int(hContext,"file_id",iPreGenFileId);
                	PutField_Int(hTxn,"file_id",iPreGenFileId);
DEBUGLOG(("GetRulePayoutPspWithPriority::Call DBOLPayoutApiPregenHD::GetNextSeq [%d]\n",iPreGenFileId));

/* bank_name */
			if (GetField_CString(hRec, "bank_name", &csTmp)) {
                                strcpy(csBankName,TrimAllChar((const unsigned char*)csTmp,strlen(csTmp),PD_SPACE));
                                if(strlen(csBankName)>0){
                                        if(strcmp(csBankName,"*")){

                                                PutField_CString(hTxn,"bank_name",csBankName);
DEBUGLOG(("GetRulePayoutPspWithPriority::bank_name = [%s]\n",csBankName));

                                                PutField_Int(hTxn,"bank_present",PD_TRUE);
                                        }
                                        else{
                                                PutField_Int(hTxn,"bank_present",PD_FALSE);
                                        }
                                }
                        }

/* psp_id */
			if (GetField_CString(hRec, "psp_id", &csPspId)) {
                                PutField_CString(hTxn,"psp_id",csPspId);
DEBUGLOG(("GetRulePayoutPspWithPriority::psp_id = [%s]\n",csPspId));
                        }

/* to_bank_code */
                        if (GetField_CString(hRec, "to_bank_code", &csToBank)) {
                                PutField_CString(hTxn,"to_bank_code",csToBank);
DEBUGLOG(("GetRulePayoutPspWithPriority::to_bank_code = [%s]\n",csToBank));
                        }

/* psp_ccy */
                        if (GetField_CString(hRec, "psp_ccy", &csTmp)) {
                                PutField_CString(hTxn,"payout_ccy",csTmp);
DEBUGLOG(("GetRulePayoutPspWithPriority::psp_ccy = [%s]\n",csTmp));
                        }

/* total_amt */             
           		if (GetField_Double(hRec, "total_amt", &dPspAmt)) {
                                PutField_Double(hTxn,"total_amt",dPspAmt);
DEBUGLOG(("GetRulePayoutPspWithPriority::total_amt = [%lf]\n",dPspAmt));
                        }

/* operator_type */
			if (GetField_CString(hRec, "operator_type", &csOperType)) {
                                PutField_CString(hTxn,"operator_type",csOperType);
DEBUGLOG(("GetRulePayoutPspWithPriority::operator_type = [%s]\n",csOperType));

                                if(strcmp(csOperType,PD_NO_RULE) && strcmp(csOperType,PD_LESS_THAN) && strcmp(csOperType,PD_DAILY_LIMIT)){
                                        i = 0;
                                        double dPct = 0.0;
                                     
				   	hash_t  *hOper;
                                        recordset_t     *rOperSet;
                                        rOperSet = (recordset_t*) malloc (sizeof(recordset_t));
                                        recordset_init(rOperSet,0);

DEBUGLOG(("Call DBRuleOperatorTypeDetail:GetRuleOperatorTypeDetail()\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBRuleOperatorTypeDetail","GetRuleOperatorTypeDetail");
                                        if ((unsigned long)(*DBObjPtr)(csOperType, rOperSet)==PD_OK) {
                                                hOper = RecordSet_GetFirst(rOperSet);
                                                while(hOper){
                                                        if (GetField_Int(hOper,"tier_id",&iTier)) {
                                                                sprintf(csTag,"tier_id_%d",i);
                                                                PutField_Int(hTxn,csTag,iTier);
DEBUGLOG(("GetRuleOperatorTypeDetail() tier_id = [%d]\n",iTier));
                                                        }
                                                        if (GetField_Double(hOper,"amt_min",&dTmp)) {
                                                                sprintf(csTag,"tier_%d_min",iTier);
                                                                PutField_Double(hTxn,csTag,dTmp);
DEBUGLOG(("GetRuleOperatorTypeDetail() amount_min = [%f]\n",dTmp));
                                                        }
                                                        if (GetField_Double(hOper,"amt_max",&dTmp)) {
                                                                sprintf(csTag,"tier_%d_max",iTier);
                                                                PutField_Double(hTxn,csTag,dTmp);
DEBUGLOG(("GetRuleOperatorTypeDetail() amount_max = [%f]\n",dTmp));
                                                        }

                                                        if (GetField_Double(hOper,"amt_pct",&dPct)) {
DEBUGLOG(("GetRuleOperatorTypeDetail() amount_pct = [%lf]\n",dPct));
                                                                sprintf(csTag,"tier_%d_pct_amt",iTier);
                                                                PutField_Double(hTxn,csTag,(dPspAmt*dPct/100));
DEBUGLOG(("GetRuleOperatorTypeDetail() amount for tier[%d] = [%lf]\n",iTier,(dPspAmt*dPct/100)));
                                                        }

                                                        i++;
                                                        PutField_Int(hTxn,"num_of_tier",i);
                                                        hOper = RecordSet_GetNext(rOperSet);
                                                }
                                        } else {
                                                iChk = PD_ERR;
                                        }

                                        RecordSet_Destroy(rOperSet);
                                        FREE_ME(rOperSet);
                                }
                        }

			// Get approved transaction by the above Payout Rule
                        dTotalPayoutAmt = 0.0;
                        dTotalTierAmt = 0.0;

			RecordSet_Destroy(rDetailSet);
                        recordset_init(rDetailSet,0);

                        hash_t  *hGenTmp;
                        hGenTmp = (hash_t*) malloc (sizeof(hash_t));
			hash_init(hGenTmp,0);

//DEBUGLOG(("Call DBOLPayoutApiPregenDT:GetRecordByRandomWithPara\n"));
DEBUGLOG(("Call DBOLPayoutApiPregenDT:GetRecordByRandomWithPara LOOP...\n"));
                        DBObjPtr = CreateObj(DBPtr,"DBOLPayoutApiPregenDT","GetRecordByRandomWithPara");
                        iResult = (unsigned long)(*DBObjPtr)(hTxn,rDetailSet);
                        if(iResult == PD_OK){
                                hDtl = RecordSet_GetFirst(rDetailSet);
                                while(hDtl && iChk == PD_OK){

                                        iAccept = PD_FALSE;

					hash_destroy(hGenTmp);
                                        hash_init(hGenTmp,0);

/* batch_id */
					if(GetField_CString(hDtl,"batch_id",&csBatchId)){
                                        	PutField_CString(hGenTmp,"batch_id",csBatchId);
//DEBUGLOG(("GetRecordByRandomWithPara::batch_id = [%s]\n",csBatchId));
					}

/* txn_seq */
                                        if(GetField_CString(hDtl,"txn_seq",&csTxnId)){
                                                PutField_CString(hGenTmp,"txn_id",csTxnId);
//DEBUGLOG(("GetRecordByRandomWithPara::txn_id = [%s]\n",csTxnId));
                                        }

/* payout_amount */
                                        if(GetField_Double(hDtl,"payout_amount",&dTxnAmt)){
//DEBUGLOG(("GetRecordByRandomWithPara::payout_amount = [%lf]\n",dTxnAmt));
                                        }

					// No Rules
					if(!strcmp(csOperType,PD_NO_RULE)){
                                                iAccept = PD_TRUE;
                                        }

					// Less Than or Daily Limit
					else if(!strcmp(csOperType,PD_LESS_THAN) || !strcmp(csOperType,PD_DAILY_LIMIT)){
                                                if(((dTotalPayoutAmt + dTxnAmt) > dPspAmt)  && (dPspAmt>0.0)){
DEBUGLOG(("GetRecordByRandomWithPara() Payout Amt[%lf] > Limited PSP Amt[%f]!!!\n",(dTotalPayoutAmt + dTxnAmt),dPspAmt));

                                                }
                                                else{
                                                        iAccept = PD_TRUE;
                                                        dTotalPayoutAmt = dTotalPayoutAmt + dTxnAmt;
                                                }
                                        }

					// Customer Rules
					else{
                                                int iTierCnt = 0;
                                                double dMinAmt= 0.0;
                                                double dMaxAmt= 0.0;
                                                double dPctAmt= 0.0;
                                                GetField_Int(hTxn,"num_of_tier",&iTierCnt);
                                                for(i=0; i<iTierCnt; i++){
                                                        dMinAmt = 0.0;
                                                        dMaxAmt = 0.0;
                                                        dPctAmt= 0.0;
                                                        sprintf(csTag,"tier_id_%d",i);
                                                        if(GetField_Int(hTxn,csTag,&iTier)){
                                                                sprintf(csTag,"tier_%d_min",iTier);
                                                                GetField_Double(hTxn,csTag,&dMinAmt);
                                                                sprintf(csTag,"tier_%d_max",iTier);
                                                                GetField_Double(hTxn,csTag,&dMaxAmt);
                                                                if(dTxnAmt>=dMinAmt && dTxnAmt<=dMaxAmt){
                                                                        sprintf(csTag,"tier_%d_pct_amt",iTier);
                                                                        GetField_Double(hTxn,csTag,&dPctAmt);
                                                                        break;
                                                                }
                                                        }
                                                }

                                                if((dTotalTierAmt+dTxnAmt)>dPctAmt){
DEBUGLOG(("GetRecordByRandomWithPara () Payout Amt[%lf] > Limited PSP Amt[%f]!!!\n",(dTotalTierAmt+dTxnAmt),dPctAmt));
                                                }else{
                                                        iAccept = PD_TRUE;
                                                        dTotalTierAmt = dTotalTierAmt + dTxnAmt;
                                                }
                                        }

					if(iAccept){
					        iStatus = PD_FALSE;
                                                sprintf(csTag,"%s_pending",csTxnId);
                                                GetField_Int(hContext,csTag,&iStatus);
                                                if(iStatus){
                                                        PutField_Int(hContext,csTag,PD_FALSE);

                                                        sprintf(csTag,"%s_psp",csTxnId);
                                                        sprintf(csTagTwo,"%s_to_bank",csTxnId);
                                                        if(GetField_CString(hContext,csTag,&csTmp) &&
                                                           GetField_CString(hContext,csTagTwo,&csTmpBank)
                                                        ){
                                                                sprintf(csTag,"%s_%s_pending_cnt",csTmp,csTmpBank);
                                                                iCnt = 0;
                                                                GetField_Int(hContext,csTag,&iCnt);
                                                                PutField_Int(hContext,csTag,iCnt-1);

                                                                sprintf(csTag,"%s_%s_pending_amt",csTmp,csTmpBank);
                                                                dTmp = 0;
                                                                GetField_Double(hContext,csTag,&dTmp);
                                                                PutField_Double(hContext,csTag,dTmp-dTxnAmt);
                                                        }
                                                }

/* psp_id and to_bank_code */
                                                if(GetField_CString(hTxn,"psp_id",&csPspId) &&
                                                   GetField_CString(hTxn,"to_bank_code",&csToBank)
                                                ){
                                                        PutField_CString(hGenTmp,"psp_id",csPspId);
                                                        PutField_CString(hGenTmp,"bank_code",csToBank);

                                                        sprintf(csTag,"%s_%s_accept_cnt",csPspId,csToBank);
                                                        iCnt = 0;
                                                        GetField_Int(hContext,csTag,&iCnt);
                                                        PutField_Int(hContext,csTag,iCnt+1);

                                                        sprintf(csTag,"%s_%s_accept_amt",csPspId,csToBank);
                                                        dTmp = 0;
                                                        GetField_Double(hContext,csTag,&dTmp);
                                                        PutField_Double(hContext,csTag,dTmp+dTxnAmt);
                                                }

/* file_id */
                                                if(GetField_Int(hContext,"file_id",&iTmp)){
                                                        PutField_Int(hGenTmp,"file_id",iTmp);
                                                }

/* update_user */
                                                if(GetField_CString(hRequest,"add_user",&csTmp)){
                                                        PutField_CString(hGenTmp,"update_user",csTmp);
                                                }
						
						// Update OL_PAYOUT_API_PREGEN_DT	
//DEBUGLOG(("Call DBOLPayoutApiPregenDT::GetTxnIdForUpdate\n"));						
						DBObjPtr = CreateObj(DBPtr,"DBOLPayoutApiPregenDT","GetTxnIdForUpdate");
						if((unsigned long)(*DBObjPtr)(csBatchId,csTxnId)==PD_OK){
//DEBUGLOG(("Call DBOLPayoutApiPregenDT::UpdateByTxnId\n"));
							DBObjPtr = CreateObj(DBPtr,"DBOLPayoutApiPregenDT","UpdateByTxnId");
                                                	if((unsigned long)(*DBObjPtr)(hGenTmp)!=PD_OK){
DEBUGLOG(("Call DBOLPayoutApiPregenDT::UpdateByTxnId Error!!!\n"));
DEBUGLOG(("  Error batch_id [%s], txn_id [%s], payout_amount [%lf]\n",csBatchId,csTxnId,dTxnAmt));
ERRLOG("BOOLPayout:ProcessOfflineApiPayoutRule::DBOLPayoutApiPregenDT::UpdateByTxnId Error!!!\n");
                                                        	iChk= INT_ERR;
                                                	}
						}else{
DEBUGLOG(("Call DBOLPayoutApiPregenDT::GetTxnIdForUpdate Error!!!\n"));
DEBUGLOG(("  Error batch_id [%s], txn_id [%s], payout_amount [%lf]\n",csBatchId,csTxnId,dTxnAmt));
ERRLOG("BOOLPayout:ProcessOfflineApiPayoutRule::DBOLPayoutApiPregenDT::GetTxnIdForUpdate Error!!!\n");
                                                  	iChk= INT_ERR;
						}
					}
                                        else{
                                                iStatus = PD_FALSE;
                                                sprintf(csTag,"%s_pending",csTxnId);
                                                GetField_Int(hContext,csTag,&iStatus);
                                                if(!iStatus){
                                                        PutField_Int(hContext,csTag,PD_TRUE);

                                                        sprintf(csTag,"%s_psp",csTxnId);
                                                        PutField_CString(hContext,csTag,csPspId);
                                                        sprintf(csTag,"%s_to_bank",csTxnId);
                                                        PutField_CString(hContext,csTag,csToBank);

                                                        sprintf(csTag,"%s_%s_pending_cnt",csPspId,csToBank);
                                                        iCnt = 0;
                                                        GetField_Int(hContext,csTag,&iCnt);
                                                        PutField_Int(hContext,csTag,iCnt+1);

                                                        sprintf(csTag,"%s_%s_pending_amt",csPspId,csToBank);
                                                        dTmp = 0;
                                                        GetField_Double(hContext,csTag,&dTmp);
                                                        PutField_Double(hContext,csTag,dTmp+dTxnAmt);
                                                }
                                        }
                                        hDtl = RecordSet_GetNext(rDetailSet);
                                }
                        }
                        FREE_ME(hGenTmp);

                        hRec = RecordSet_GetNext(rRecordSet);
		}
	} else {
DEBUGLOG(("Call DBRuleOperatorTypeDetail::GetRulePayoutPspWithPriority::no payout match rule!!\n"));
//ERRLOG("BOOLPayout::ProcessOfflineApiPayoutRule::Call DBRuleOperatorTypeDetail::GetRulePayoutPspWithPriority::no payout match rule!!\n");
                iRet=INT_NO_PAYOUT_MATCH_RULE;
        }

	if(iChk!=PD_OK){
                iRet=INT_ERR;
        }

	FREE_ME(hTxn);

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
        RecordSet_Destroy(rDetailSet);
        FREE_ME(rDetailSet);

DEBUGLOG(("BOOLPayout::ProcessOfflineApiPayoutRule iRet[%d]\n",iRet));
        return  iRet;
}


int ProcessOnlineApiPayoutRule(hash_t *hContext, hash_t *hRequest)
{
        int     iRet = PD_OK;
        int     iChk = PD_OK;

	int     iPreGenFileId = 0;
	int     i = 0;
	int     iCnt = 0;	
	int     iTotalTxnCnt = 0;		
	int 	iPspCnt = 0;
        int     iResult = 0;
        int     iAccept = PD_FALSE;
        int     iTmp = 0;

	double  dTxnAmt = 0.0;
	double  dTotalPayoutAmt = 0.0;
        double  dTmp=0.0;
        
        char    *csBatchId = strdup("");
        char    *csTxnId = NULL;
        char	*csPrePsp = strdup("");
        char	*csPspTmp = NULL;
        char    *csPspId = NULL;
	char    *csTmp = NULL;
        
	char    csTag[PD_TAG_LEN +1];
       
        hash_t  *hDtl;

        hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

        hash_t  *hPsp;
        hPsp = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hPsp,0);

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

        recordset_t     *rDetailSet;
        rDetailSet = (recordset_t*) malloc (sizeof(recordset_t));
       	recordset_init(rDetailSet,0);

DEBUGLOG(("BOOLPayout:ProcessOnlineApiPayoutRule()\n"));

/* action_id */
       	if (GetField_CString(hContext, "action_id", &csTmp)) {
DEBUGLOG(("action_id = [%s]\n", csTmp));
             	PutField_CString(hTxn, "action_id", csTmp);
       	} else {
DEBUGLOG(("action_id not found\n"));
ERRLOG("BOOLPayout:: ProcessOnlineApiPayoutRule:: action_id not found\n");
             	iRet = INT_BATCH_ID_NOT_FOUND;
        }

/* txn_cnt */
        if (iRet == PD_OK) {
                if (GetField_Int(hContext, "txn_cnt", &iTotalTxnCnt)) {
DEBUGLOG(("txn_cnt = [%d]\n", iTotalTxnCnt));
                } else {
DEBUGLOG(("txn_cnt not found!!\n"));
ERRLOG("BOOLPayout:ProcessOnlineApiPayoutRule::txn_cnt not found!!\n");
                        iRet = INT_ERR;
                }
        }

/* merchant_id */
	if (iRet == PD_OK) {
        	if(GetField_CString(hRequest,"merchant_id",&csTmp)){
                	PutField_CString(hTxn,"merchant_id",csTmp);
DEBUGLOG(("merchant_id = [%s]\n", csTmp));
        	}
	}

/* user */
	if (iRet == PD_OK) {
		if(GetField_CString(hRequest,"add_user",&csTmp)){
			PutField_CString(hTxn,"update_user",csTmp);
DEBUGLOG(("update_user = [%s]\n", csTmp));
		}
	}

/* bank_present */
	if (iRet == PD_OK) {
        	PutField_Int(hTxn,"bank_present",PD_FALSE);
	}

/* psp_id and psp_ccy */
	if (iRet == PD_OK) {

		iPspCnt = 0;
		csPrePsp[0]='\0';

 		for (i=0; i<iTotalTxnCnt; i++) {
			
			sprintf(csTag,"pregen_psp_id_%d",i);
			if(GetField_CString(hRequest,csTag,&csPspTmp)){
				if(strcmp(csPspTmp,csPrePsp)){
					sprintf(csPrePsp,"%s",csPspTmp);
					sprintf(csTag,"psp_id_%d",iPspCnt);
					PutField_CString(hContext,csTag,csPspTmp);
DEBUGLOG(("PSP Found[%d][%s]\n",iPspCnt,csPspTmp));
					iPspCnt++;
				}
			
				sprintf(csTag,"pregen_psp_ccy_%d",i);
				if(GetField_CString(hRequest,csTag,&csTmp)){
                                 	sprintf(csTag,"%s_psp_ccy",csPspTmp);
                                      	PutField_CString(hContext,csTag,csTmp);
//DEBUGLOG(("PSP Found[%d][%s]\n",iPspCnt,csTmp));
                           	}
			}
		}
		FREE_ME(csPrePsp);
	}

	if(iRet==PD_OK){

		// PSP Count
                for(i=0; i<iPspCnt; i++){
                        sprintf(csTag,"psp_id_%d",i);
                        if(GetField_CString(hContext,csTag,&csPspId)){
                                PutField_CString(hTxn,"psp_id",csPspId);

                                sprintf(csTag,"%s_psp_ccy",csPspId);
                                if(GetField_CString(hContext,csTag,&csTmp)){
                                        PutField_CString(hTxn,"payout_ccy",csTmp);
                                }
                        }

			// Set Pregen File Id
			iPreGenFileId = 0;
                        PutField_Int(hContext,"file_id",iPreGenFileId);
                        PutField_Int(hTxn,"file_id",iPreGenFileId);
DEBUGLOG(("Call DBOLPayoutApiPregenHD::GetNextSeq [%d]\n",iPreGenFileId));


			// Get approved transaction	
			dTotalPayoutAmt = 0.0;

			RecordSet_Destroy(rDetailSet);		
                        recordset_init(rDetailSet,0);

                        hash_t  *hGenTmp;
                        hGenTmp = (hash_t*) malloc (sizeof(hash_t));
                       	hash_init(hGenTmp,0);

DEBUGLOG(("Call DBOLPayoutApiPregenDT:GetRecordByRandomWithPara\n"));
                        DBObjPtr = CreateObj(DBPtr,"DBOLPayoutApiPregenDT","GetRecordByRandomWithPara");
                        iResult = (unsigned long)(*DBObjPtr)(hTxn,rDetailSet);
                        if(iResult == PD_OK){
                                hDtl = RecordSet_GetFirst(rDetailSet);
                                while(hDtl && iChk == PD_OK){

					iAccept = PD_FALSE;

					hash_destroy(hGenTmp);
                                        hash_init(hGenTmp,0);


/* batch_id */
                                        if(GetField_CString(hDtl,"batch_id",&csBatchId)){
                                                PutField_CString(hGenTmp,"batch_id",csBatchId);
DEBUGLOG(("GetRecordByRandomWithPara::batch_id = [%s]\n",csBatchId));
                                        }

/* txn_seq */
                                        if(GetField_CString(hDtl,"txn_seq",&csTxnId)){
                                                PutField_CString(hGenTmp,"txn_id",csTxnId);
DEBUGLOG(("GetRecordByRandomWithPara::txn_id = [%s]\n",csTxnId));
                                        }

/* payout_amount */
                                        if(GetField_Double(hDtl,"payout_amount",&dTxnAmt)){
DEBUGLOG(("GetRecordByRandomWithPara::payout_amount = [%lf]\n",dTxnAmt));
                                        }

                                        iAccept = PD_TRUE;
                                        dTotalPayoutAmt = dTotalPayoutAmt + dTxnAmt;

                                        if(iAccept){

/* psp_id */
                                                if(GetField_CString(hTxn,"psp_id",&csPspId)){
                                                        PutField_CString(hGenTmp,"psp_id",csPspId);
DEBUGLOG(("GetRecordByRandomWithPara::psp_id = [%s]\n",csPspId));

                                                        sprintf(csTag,"%s_accept_cnt",csPspId);
                                                        iCnt = 0;
                                                        GetField_Int(hContext,csTag,&iCnt);
                                                        PutField_Int(hContext,csTag,iCnt+1);

                                                        sprintf(csTag,"%s_accept_amt",csPspId);
                                                        dTmp = 0;
                                                        GetField_Double(hContext,csTag,&dTmp);
                                                        PutField_Double(hContext,csTag,dTmp+dTxnAmt);
                                                }

/* file_id */
						if(GetField_Int(hContext,"file_id",&iTmp)){
                                                        PutField_Int(hGenTmp,"file_id",iTmp);
                                                }

/* update_user */
                                                if(GetField_CString(hRequest,"add_user",&csTmp)){
                                                        PutField_CString(hGenTmp,"update_user",csTmp);
                                                }

						// Update OL_PAYOUT_API_PREGEN_DT
DEBUGLOG(("Call DBOLPayoutApiPregenDT::GetTxnIdForUpdate\n"));
                                                DBObjPtr = CreateObj(DBPtr,"DBOLPayoutApiPregenDT","GetTxnIdForUpdate");
                                                if((unsigned long)(*DBObjPtr)(csBatchId,csTxnId)==PD_OK){
DEBUGLOG(("Call DBOLPayoutApiPregenDT::UpdateByTxnId\n"));
                                                        DBObjPtr = CreateObj(DBPtr,"DBOLPayoutApiPregenDT","UpdateByTxnId");
                                                        if((unsigned long)(*DBObjPtr)(hGenTmp)!=PD_OK){
DEBUGLOG(("Call DBOLPayoutApiPregenDT::UpdateByTxnId Error!!!\n"));
ERRLOG("BOOLPayout:ProcessOnlineApiPayoutRule::DBOLPayoutApiPregenDT::UpdateByTxnId Error!!!\n");
                                                                iChk= INT_ERR;
                                                        }
                                                }else{
DEBUGLOG(("Call DBOLPayoutApiPregenDT::GetTxnIdForUpdate Error!!!\n"));
ERRLOG("BOOLPayout:ProcessOnlineApiPayoutRule::DBOLPayoutApiPregenDT::GetTxnIdForUpdate Error!!!\n");
                                                        iChk= INT_ERR;
                                                }
                                        }
                                        hDtl = RecordSet_GetNext(rDetailSet);
                                }
                        }
                        FREE_ME(hGenTmp);
		 }
        }

        if(iChk!=PD_OK || iPspCnt == 0){
                iRet=INT_ERR;
        }	

	FREE_ME(csBatchId);	

        FREE_ME(hTxn);
	FREE_ME(hPsp);
		
	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
        RecordSet_Destroy(rDetailSet);
        FREE_ME(rDetailSet);
       
DEBUGLOG(("BOOLPayout::ProcessOnlineApiPayoutRule iRet[%d]\n",iRet));
        return  iRet;
}


int HandleGeneratePayoutApi(hash_t *hContext,
                 hash_t* hRequest,
                 hash_t* hResponse)
{
        int     iRet = PD_OK;
        
	int     iTmpRet = PD_FOUND;

	int	i = 0;
	int	iTotalTxnCnt = 0;
        int     iOnlinePayout = PD_FALSE;
        int     iSeqNum = 0;
        int     iFormat = 0;
        int     iCostTmp = 0;
        int     iTmp= 0;

	double  dPayoutAmt = 0.0;
        double  dSplitAmt = 0.0;
        double  dTmpSplit = 0.0;
        double  dRemainAmt = 0.0;
        double  dAmt= 0.0;
        double  dTmpAmt= 0.0;
        double  dTmpTotalAmt = 0.0;
        double  dUniqueAmt = 0.0;
        double  dLeftAmt = 0.0;
	double  dTmp;

        char    cBatchMode = PD_OFFLINE;
        char    cTmp;
       
	char    *csActionId = strdup(""); 
	char    *csBatchId = strdup(""); 
	char    *csOrgTxnId = strdup(""); 
        char    *csPspId = NULL;
        char    *csTxnCcy = NULL;
        char    *csFilePath = NULL;
        char    *csPayoutTxnSeq = NULL;
        char    *csPayoutCcy = NULL;
        char    *csPspCountry = NULL;
        char    *csToBank = NULL;
        char    *csBankCode = NULL;
        char    *csBaid = NULL;
        char    *csAcctNum = NULL;
        char    *csUser = NULL;
	char    *csTmp = NULL;

	char    csTag[PD_TAG_LEN +1];
        char    csTagTwo[PD_TAG_LEN +1];

 	hash_t 	*hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	hash_t  *hPregen;
        hPregen = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hPregen,0);

	hash_t  *hPregenDT;
        hPregenDT = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hPregenDT,0);

	hash_t 	*hDetail;
        hDetail = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hDetail,0);

	hash_t 	*hUploadTxn;
        hUploadTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hUploadTxn,0);

	hash_t 	*hElement;
        hElement = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hElement,0);

	hash_t 	*hBal;
        hBal = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBal,0);

	hash_t 	*hCost;
        hCost = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hCost,0);

        hash_t  *hRec;
        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOOLPayout:HandleGeneratePayoutApi start\n"));

/* action_id */
        if (GetField_CString(hContext, "action_id", &csActionId)) {
DEBUGLOG(("action_id = [%s]\n", csActionId));
                PutField_CString(hPregen, "action_id", csActionId);
       	} else {
DEBUGLOG(("action_id not found\n"));
ERRLOG("BOOLPayout:: HandleGeneratePayoutApi:: action_id not found\n");
             	iRet = INT_BATCH_ID_NOT_FOUND;
        }

/* txn_cnt */
        if (iRet == PD_OK) {
                if (GetField_Int(hContext, "txn_cnt", &iTotalTxnCnt)) {
DEBUGLOG(("txn_cnt = [%d]\n", iTotalTxnCnt));
                } else {
DEBUGLOG(("txn_cnt not found!!\n"));
ERRLOG("BOOLPayout:HandleGeneratePayoutApi::txn_cnt not found!!\n");
                        iRet = INT_ERR;
                }
        }

/* online_payout */
	if (iRet == PD_OK) {
                if(GetField_Int(hContext,"online_payout",&iOnlinePayout)){
DEBUGLOG(("online_payout = [%d]\n",iOnlinePayout));
                }

                if(iOnlinePayout){
                        cBatchMode = PD_ONLINE;
                }else{
                        cBatchMode = PD_OFFLINE;
		}
        }

/* user */
        if (iRet == PD_OK) {
                if(GetField_CString(hContext, "update_user", &csUser)){
DEBUGLOG(("update_user = [%s]\n", csUser));
                } else {
DEBUGLOG(("update_user not found!!\n"));
ERRLOG("BOOLPayout:HandleGeneratePayoutApi::update_user not found!!\n");
                        iRet = INT_USER_NOT_FOUND;
                }
        }

	// Update DBOLPayoutApiPregenHD
	if (iRet == PD_OK) {

		// status
		PutField_Char(hPregen,"status",PD_OL_PO_API_PREVIEW);

DEBUGLOG(("Call DBOLPayoutApiPregenHD: MatchPregenStatus_ForUpdate\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiPregenHD", "MatchPregenStatus_ForUpdate");
                iTmpRet = (unsigned long)(*DBObjPtr)(hPregen);
                if (iTmpRet == PD_FOUND) {

                        hash_destroy(hTxn);
                        hash_init(hTxn, 0);

                       	PutField_CString(hTxn, "action_id", csActionId);
                        PutField_Char(hTxn,"status",PD_OL_PO_API_PROCESSING);
                        PutField_CString(hTxn,"update_user",csUser);

DEBUGLOG(("Call DBOLPayoutApiPregenHD:: Update\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiPregenHD", "Update");
                        iRet = (unsigned long)(*DBObjPtr)(hTxn);
                        if (iRet == PD_OK) {
DEBUGLOG(("Call DBOLPayoutApiPregenHD:: TxnCommit\n"));
				TxnCommit();
			} else {
DEBUGLOG(("Call DBOLPayoutApiPregenHD:: Update Failure!!!\n"));
ERRLOG("BOOLPayout::HandleGeneratePayoutApi::Call DBOLPayoutApiPregenHD:: Update Failure!!!\n");
                                iRet = INT_ERR;
                        }
                } else {
DEBUGLOG(("Call DBOLPayoutApiPregenHD: MatchPregenStatus_ForUpdate not found\n"));
ERRLOG("BOOLPayout: HandleGeneratePayoutApi:: call DBOLPayoutApiPregenHD: MatchPregenStatus_ForUpdate not found\n");
                        iRet = INT_TXN_STATUS_NOT_MATCH;
                }
        }

	// Get Existing Psp Details
	if (iRet == PD_OK) {
                int iPspCnt = 0;

		RecordSet_Destroy(rRecordSet);
                recordset_init(rRecordSet, 0);

                if(!iOnlinePayout) {
DEBUGLOG(("Call DBOLPayoutApiPregenDT: GetExistingPsp\n"));
                        DBObjPtr = CreateObj(DBPtr,"DBOLPayoutApiPregenDT","GetExistingPsp");
                } else {
DEBUGLOG(("Call DBOLPayoutApiPregenDT: GetExistingPspOnlineMode\n"));
                        DBObjPtr = CreateObj(DBPtr,"DBOLPayoutApiPregenDT","GetExistingPspOnlineMode");
                }

                if((unsigned long) ((*DBObjPtr)(hPregen,rRecordSet))==PD_OK){
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while(hRec){

                                hash_destroy(hTxn);
                                hash_init(hTxn,0);
		
				hash_destroy(hBal);
                                hash_init(hBal,0);

/* psp_id and bank_code */
				if(GetField_CString(hRec,"psp_id",&csPspId) &&
                                   GetField_CString(hRec,"bank_code",&csBankCode)
                                ){
					PutField_CString(hTxn,"file_bank_code",csBankCode);
                                        sprintf(csTag,"bank_code_%d",iPspCnt);
                                        PutField_CString(hContext,csTag,csBankCode);
DEBUGLOG(("GetExistingPsp bank_code [%s]\n",csBankCode));

                                        PutField_CString(hTxn,"file_pid",csPspId);
                                        sprintf(csTag,"psp_id_%d",iPspCnt);
                                        PutField_CString(hContext,csTag,csPspId);
                                        PutField_CString(hBal,"psp_id",csPspId);
DEBUGLOG(("GetExistingPsp psp_id [%s]\n",csPspId));

					// Get Psp Payout Tmp Account					
					dTmpSplit = 0.0;
					
DEBUGLOG(("Call DBOLPspDetail: GetPayoutTmpAcct\n"));
					DBObjPtr = CreateObj(DBPtr,"DBOLPspDetail","GetPayoutTmpAcct");
					if ((unsigned long)(*DBObjPtr)(csPspId,hTxn) == PD_OK) {

/* payout_split_limit */					
						if (GetField_Double(hTxn,"payout_split_limit",&dTmpSplit)) {
DEBUGLOG(("GetPayoutTmpAcct - split amount = [%lf]\n",dTmpSplit));
                                                }
                                                else{
DEBUGLOG(("GetPayoutTmpAcct - split amount not found\n"));
                                                }

/* client_id */
						if (GetField_CString(hTxn,"client_id",&csTmp)) {
                                                        sprintf(csTag,"%s_psp_client",csPspId);
                                                        PutField_CString(hContext,csTag,csTmp);
							//PutField_CString(hContext,"psp_client_id",csTmp);
DEBUGLOG(("GetPayoutTmpAcct - client id = [%s]\n",csTmp));
                                                }

/* payout_format */
						if (GetField_Int(hTxn,"payout_format",&iFormat)) {
DEBUGLOG(("GetPayoutTmpAcct - payout_format = [%d]\n",iFormat));
                                                }

/* baid */
						if (GetField_CString(hTxn,"baid",&csBaid)) {
                                                        sprintf(csTag,"%s_baid",csPspId);
                                                        PutField_CString(hContext,csTag,csBaid);
DEBUGLOG(("GetPayoutTmpAcct - baid = [%s]\n",csBaid));
                                                }

/* bank_acct_num */
/*
						if (GetField_CString(hTxn,"bank_acct_num",&csTmp)) {
DEBUGLOG(("GetPayoutTmpAcct - bank_acct_num = [%s]\n",csTmp));
						}
*/
					}
					sprintf(csTag,"%s_split_amt",csPspId);
                                        PutField_Double(hContext,csTag,dTmpSplit);
DEBUGLOG(("GetExistingPsp split_amt [%d]\n",dTmpSplit));

/* psp_ccy */
					if(GetField_CString(hRec,"psp_ccy",&csPayoutCcy)){
                                                PutField_CString(hTxn,"ccy_id",csPayoutCcy);
DEBUGLOG(("GetExistingPsp psp_ccy [%s]\n",csPayoutCcy));
                                        }

/* psp_country */
                                        if(GetField_CString(hRec,"psp_country",&csPspCountry)){
DEBUGLOG(("GetExistingPsp psp_country [%s]\n",csPspCountry));
                                        }

/* txn_count */
                                        if(GetField_Int(hRec,"txn_count",&iTmp)){
                                                PutField_Int(hTxn,"txn_cnt",iTmp);
                                                PutField_Int(hBal,"txn_cnt",iTmp);
DEBUGLOG(("GetExistingPsp txn_count [%d]\n",iTmp));
                                        }

/* total_amt */
					if(GetField_Double(hRec,"total_amt",&dAmt)){
DEBUGLOG(("GetExistingPsp total_amt [%lf]\n",dAmt));
                                        }

/* PHDATE */
					if(GetField_CString(hContext,"PHDATE",&csTmp)){
                                                PutField_CString(hTxn,"PHDATE",csTmp);
DEBUGLOG(("GetExistingPsp PHDATE [%s]\n",csTmp));
                                        }

/* add_user */
                                       	PutField_CString(hTxn,"add_user",csUser);
DEBUGLOG(("GetExistingPsp add_user [%s]\n",csUser));
		
					// Create Payout File Detail (Generate OLPayoutGeneratedFileHD seq_num and file_id)
					if (iRet == PD_OK) {
						/********** Create Payout File Detail **********/
DEBUGLOG(("Call CreatePayoutFileDetail()\n"));
                                        	if (CreatePayoutFileDetail(csPspId,csBankCode,hTxn) != PD_OK) {
DEBUGLOG(("Call CreatePayoutFileDetail() for[%s] Failed!!!!\n",csPspId));
ERRLOG("BOOLPayout: HandleGeneratePayoutApi:: call CreatePayoutFileDetail for[%s] Failed!!!!\n",csPspId);
                                                	iRet=INT_ERR;
                                                	break;
                                        	}
						/********** Create Payout File Detail **********/
					}				

					// Add OLPayoutGeneratedFileHD
					if (iRet == PD_OK) {
						if (iOnlinePayout) {
                                                	PutField_Int(hTxn,"status",PD_PAYOUTFILE_PRE_SEND);
DEBUGLOG(("status = [%d]\n",PD_PAYOUTFILE_PRE_SEND));
                                        	} else {
                                                	PutField_Int(hTxn,"status",PD_PAYOUTFILE_PROCESSING_GENERATE);
DEBUGLOG(("status = [%d]\n",PD_PAYOUTFILE_PROCESSING_GENERATE));
						}
						
DEBUGLOG(("Call OLPayoutGeneratedFileHD::Add\n"));
						DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Add");
                                        	if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
DEBUGLOG(("Call OLPayoutGeneratedFileHD::Add Error!!!\n"));
ERRLOG("BOOLPayout: HandleGeneratePayoutApi:: call OLPayoutGeneratedFileHD: Add Error!!\n");
                                         	       iRet = INT_ERR;
                                         	       break;
                                        	}
					}	

					// Create Payout File (Generate Payout File Format)
					if (iRet == PD_OK) {
						/********** Create Payout File **********/
DEBUGLOG(("Call CreatePayoutFile()\n"));
                                        	if (CreatePayoutFile(iFormat,csPspId,csBankCode,hTxn) != PD_OK) {
DEBUGLOG(("Call CreatePayoutFile() failed for [%s][%s]!!\n",csPspId,csBankCode));
                                                	iRet= INT_ERR;
                                                	break;
                                        	}
						/********** Create Payout File **********/
					}

					// Write Header

/* file_id */
					if(GetField_CString(hTxn,"file_id",&csTmp)){
DEBUGLOG(("file_id = [%s]\n",csTmp));
                                                sprintf(csTag,"%s_%s_file_id",csPspId,csBankCode);
                                                PutField_CString(hContext,csTag,csTmp);
                                        }

/* file_path */
                                        if(GetField_CString(hTxn,"file_path",&csTmp)){
DEBUGLOG(("file_path = [%s]\n",csTmp));
                                                sprintf(csTag, "%s_%s_file_path", csPspId,csBankCode);
                                                PutField_CString(hContext,csTag,csTmp);
                                        }

/* filename */
                                        if(GetField_CString(hTxn,"filename",&csTmp)){
DEBUGLOG(("filename = [%s]\n",csTmp));
                                                sprintf(csTag,"%s_%s_filename",csPspId,csBankCode);
                                                PutField_CString(hContext,csTag,csTmp);
                                        }

/* psp_channel */
/*
					if(GetField_CString(hTxn,"psp_channel",&csTmp)){
DEBUGLOG(("psp_channel = [%s]\n",csTmp));
                                                sprintf(csTag,"%s_psp_channel",csPspId);
                                                PutField_CString(hContext,csTag,csTmp);
                                        }
*/

/* psp_client */
/*
					if(GetField_CString(hTxn,"psp_client",&csTmp)){
DEBUGLOG(("psp_client = [%s]\n",csTmp));
                                                sprintf(csTag,"%s_psp_client",csPspId);
                                                PutField_CString(hContext,csTag,csTmp);
                                        }
*/

					iPspCnt ++;
                                        PutField_Int(hContext,"psp_count",iPspCnt);
				}

                                hRec = RecordSet_GetNext(rRecordSet);
                        }

			if(!iPspCnt){
                        	iRet = INT_NO_PENDING_RECORD;
DEBUGLOG(("GetExistingPsp: No pre-gen record found!!!\n"));
                	}
                } else {
DEBUGLOG(("Call DBOLPayoutApiPregenDT: GetExistingPsp Error!!\n"));
ERRLOG("BOOLPayout: HandleGeneratePayoutApi:: call DBOLPayoutApiPregenDT: GetExistingPsp Error!!\n");
                        iRet = INT_ERR;
                }				
        }

	// Get All Pregen Records (for Update)
	if (iRet == PD_OK) {
        	int iCnt= 0;

		int iTxnRec = 0;

		int iTxnCnt = 0;
		int iGenTxnCnt = 0;
	
DEBUGLOG(("Get All Pregen Records for Update - Start\n"));				
		for (i=0; i<iTotalTxnCnt; i++) {		

			hash_destroy(hTxn);
			hash_init(hTxn,0);

			hash_destroy(hPregenDT);
                        hash_init(hPregenDT,0);

			hash_destroy(hDetail);
                        hash_init(hDetail,0);

			hash_destroy(hUploadTxn);
                        hash_init(hUploadTxn,0);
			
			hash_destroy(hElement);
                      	hash_init(hElement,0);
				
			hash_destroy(hCost);
                      	hash_init(hCost,0);

/* psp_id & to_bank_code */

			sprintf(csTag,"psp_id_%d",i);
			sprintf(csTagTwo,"to_bank_code_%d",i);
			if (GetField_CString(hRequest, csTag, &csPspId) &&
                            GetField_CString(hRequest, csTagTwo, &csToBank)
                     	) {
DEBUGLOG(("psp_id = [%d][%s]\n",i,csPspId));				
DEBUGLOG(("to_bank_code = [%d][%s]\n",i,csToBank));				

				PutField_CString(hTxn,"psp_id",csPspId);
                                PutField_CString(hTxn,"org_psp_id",csPspId);
                                PutField_CString(hCost,"psp_id",csPspId);

				sprintf(csTag, "%s_%s_filename", csPspId, csToBank);
				if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("[%s] = [%d][%s]\n", csTag, i, csTmp));
                              		PutField_CString(hTxn,"generated_file_name",csTmp);
				}

				sprintf(csTag, "%s_%s_file_id", csPspId, csToBank);
                                if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("[%s] = [%d][%s]\n", csTag, i, csTmp));
                                        PutField_CString(hTxn,"file_id",csTmp);
					iTmp = atoi((char*)csTmp);
                                        PutField_Int(hTxn,"generated_file_id",iTmp);
					PutField_Int(hPregenDT,"file_id",iTmp);
					PutField_CString(hDetail,"file_id",csTmp);
				}
			
				sprintf(csTag, "%s_psp_channel", csPspId);
                                if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("[%s] = [%d][%s]\n", csTag, i, csTmp));
                                        PutField_CString(hDetail,"psp_channel",csTmp);	
				}

				sprintf(csTag, "%s_baid", csPspId);
                                if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("[%s] = [%d][%s]\n", csTag, i, csTmp));
                                        PutField_CString(hTxn,"org_baid",csTmp);
                                        PutField_CString(hDetail,"psp_channel",csTmp);	
                                        PutField_CString(hCost,"baid",csTmp);
				}

				sprintf(csTag, "%s_psp_client", csPspId);
				if (GetField_CString(hContext,csTag,&csTmp)) {
DEBUGLOG(("[%s] = [%d][%s]\n", csTag, i, csTmp));
                                        PutField_CString(hDetail,"client_id",csTmp);
                                        PutField_CString(hCost,"provider_id",csTmp);
				}

				sprintf(csTag, "%s_%s_file_path", csPspId,csToBank);
				if (GetField_CString(hContext,csTag,&csFilePath)) {
DEBUGLOG(("[%s] = [%d][%s]\n", csTag, i, csTmp));
				
				}
			}

/* txn_id */
			sprintf(csTag,"org_txn_id_%d",i);
			if (GetField_CString(hRequest, csTag, &csOrgTxnId)) {
DEBUGLOG(("txn_id = [%d][%s]\n",i,csOrgTxnId));			
                         	PutField_CString(hTxn, "grp_tracking_txn_seq", csOrgTxnId);
				PutField_CString(hPregenDT,"txn_id",csOrgTxnId);
				PutField_CString(hDetail,"upload_txn_id",csOrgTxnId);
                              	PutField_CString(hUploadTxn,"txn_seq",csOrgTxnId);
			}

/* batch_id */
			sprintf(csTag,"batch_id_%d",i);
                        if (GetField_CString(hRequest, csTag, &csBatchId)) {
DEBUGLOG(("batch_id = [%d][%s]\n",i,csBatchId));
				//PutField_CString(hDetail,"batch_id",csBatchId);
				PutField_CString(hPregenDT,"batch_id",csBatchId);
			}

/* seq_num */
			sprintf(csTag,"seq_num_%d",i);
			if (GetField_Int(hRequest, csTag, &iSeqNum)) {
DEBUGLOG(("seq_num = [%d][%d]\n",i,iSeqNum));
				//PutField_Int(hDetail,"seq_num",iSeqNum);
			}

/* txn_country */
			sprintf(csTag,"txn_country_%d",i);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("txn_country = [%d][%s]\n",i,csTmp));

				sprintf(csTag, "%s_txn_country", csPspId);
                              	PutField_CString(hContext,csTag,csTmp);

                            	PutField_CString(hTxn,"txn_country",csTmp);
                              	PutField_CString(hTxn,"org_txn_country",csTmp);
                               	PutField_CString(hDetail,"txn_country",csTmp);
                              	PutField_CString(hDetail,"country",csTmp);
			}

/* request_ccy */
			sprintf(csTag,"request_ccy_%d",i);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("request_ccy = [%d][%s]\n",i,csTmp));
				PutField_CString(hDetail,"request_ccy",csTmp);
			}

/* payout_ccy */
			sprintf(csTag,"payout_ccy_%d",i);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("payout_ccy = [%d][%s]\n",i,csTmp));

				if(strcmp(csTmp,"RMB")){
                                        csTxnCcy=strdup(csTmp);
                                }else{
                                   	csTxnCcy=strdup(PD_CCY_ISO_CNY);
				}
		
                                sprintf(csTag, "%s_payout_ccy", csPspId);
                              	PutField_CString(hContext,csTag,csTxnCcy);

                             	PutField_CString(hTxn,"txn_ccy",csTxnCcy);
                             	PutField_CString(hTxn,"org_psp_txn_ccy",csTxnCcy);
                              	PutField_CString(hDetail,"payout_ccy",csTxnCcy);
                              	PutField_CString(hDetail,"payout_currency",csTxnCcy);
                               	PutField_CString(hElement,"org_txn_ccy",csTxnCcy);
                             	PutField_CString(hElement,"src_txn_fee_ccy",csTxnCcy);
                                        
				FREE_ME(csTxnCcy);
			}

/* account_name */
			sprintf(csTag,"account_name_%d",i);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("account_name = [%d][%s]\n",i,csTmp));
				PutField_CString(hDetail,"account_name",csTmp);
			}

/* account_id */
			sprintf(csTag,"account_id_%d",i);
			if (GetField_CString(hRequest, csTag, &csAcctNum)) {
DEBUGLOG(("account_id = [%d][%s]\n",i,csAcctNum));
				PutField_CString(hDetail,"account_num",csAcctNum);
			}

/* bank_code */
			sprintf(csTag,"bank_code_%d",i);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("bank_code = [%d][%s]\n",i,csTmp));
				PutField_CString(hDetail,"bank_code",csTmp);
			}

/* bank_name */
			sprintf(csTag,"bank_name_%d",i);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("bank_name = [%d][%s]\n",i,csTmp));
				PutField_CString(hDetail,"bank_name",csTmp);
			}

/* branch */
			sprintf(csTag,"branch_%d",i);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("branch = [%d][%s]\n",i,csTmp));
				PutField_CString(hDetail,"branch",csTmp);
			}

/* identity_id */
			sprintf(csTag,"identity_id_%d",i);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("identity_id = [%d][%s]\n",i,csTmp));
				PutField_CString(hDetail,"identity_id",csTmp);
			}

/* phone_num */ 
			sprintf(csTag,"phone_num_%d",i);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("phone_num = [%d][%s]\n",i,csTmp));
				PutField_CString(hDetail,"phone_num",csTmp);
			}

/* merchant_ref */
			sprintf(csTag,"merchant_ref_%d",i);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("merchant_ref = [%d][%s]\n",i,csTmp));
				PutField_CString(hDetail,"merchant_ref",csTmp);
			}

/* remark */
			sprintf(csTag,"remark_%d",i);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("remark = [%d][%s]\n",i,csTmp));
			}

/* province */
			sprintf(csTag,"province_%d",i);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("province = [%d][%s]\n",i,csTmp));
				PutField_CString(hDetail,"province",csTmp);
			}

/* city */
			sprintf(csTag,"city_%d",i);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("city = [%d][%s]\n",i,csTmp));
				PutField_CString(hDetail,"city",csTmp);
			}

/* request_amount */
			sprintf(csTag,"request_amount_%d",i);
			if (GetField_Double(hRequest, csTag, &dTmp)) {
DEBUGLOG(("request_amount = [%d][%.2f]\n",i,dTmp));
				PutField_Double(hDetail,"request_amount",dTmp);
			}

/* payout_amount */
			sprintf(csTag,"payout_amount_%d",i);
			if (GetField_Double(hRequest,csTag, &dPayoutAmt)) {
DEBUGLOG(("payout_amount = [%d][%.2f]\n",i,dPayoutAmt));
				dRemainAmt = dPayoutAmt;
			}

/* user */
			PutField_CString(hDetail,"add_user",csUser);
			PutField_CString(hDetail,"update_user",csUser);
			PutField_CString(hTxn,"add_user",csUser);
			PutField_CString(hTxn,"update_user",csUser);
			//PutField_CString(hUploadTxn,"add_user",csUser);
                        PutField_CString(hUploadTxn,"update_user",csUser);

			// Lock OLTxnHeader Records
			if (iRet == PD_OK) {
DEBUGLOG(("Call DBOLTransaction::GetTxnIdForUpdateNoWaitWithSubStatus\n"));
	                        DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnIdForUpdateNoWaitWithSubStatus");
        	                if ((unsigned long)(*DBObjPtr)(csOrgTxnId, PD_COMPLETE, PD_APPROVED_FOR_GENERATED) != PD_OK) {
DEBUGLOG(("Call DBOLTransaction::GetTxnIdForUpdateNoWaitWithSubStatus not able to lock records\n"));        	                    
ERRLOG("BOOLPayout: HandleGeneratePayoutApi:: call DBOLTransaction::GetTxnIdForUpdateNoWaitWithSubStatus not able to lock records\n");
                        		iRet = INT_INVALID_TXN;
					break;
        	                }
			}
			
			// Check Account Number in the Special Handle List
			if (iRet == PD_OK) {

				int iSplitCnt = 1;
                                int iSpecialSplit = PD_FALSE;

/******************************************* Check Split::Start *******************************************/ 

DEBUGLOG(("Call DBPayoutSpcSplitAcct::InSpecialList\n"));
				DBObjPtr = CreateObj(DBPtr,"DBPayoutSpcSplitAcct","InSpecialList");
                                iSpecialSplit = (unsigned long)(*DBObjPtr)(csAcctNum);	
				if(!iSpecialSplit){

//split by average
                                        iSplitCnt = 1;
                                        dSplitAmt = 0.0;
                                        dTmpTotalAmt = 0.0;

					sprintf(csTag,"%s_split_amt",csPspId);
                                        if (GetField_Double(hContext,csTag,&dSplitAmt)){
DEBUGLOG(("InSpecialList:: %s_split_amt = [%.2f]\n",csPspId, dSplitAmt));			                                        	
					} 

					if(dSplitAmt>0){
                                                iSplitCnt = (int)(dPayoutAmt/dSplitAmt);
                                                if(dPayoutAmt>(dSplitAmt*iSplitCnt)){
                                                        iSplitCnt ++;
                                                }
DEBUGLOG(("InSpecialList:: split_count: [%d]\n",iSplitCnt));

                                                dTmpAmt = 0.0;
                                                dTmpTotalAmt = 0.0;

						dLeftAmt = dPayoutAmt;
                                                dTmpAmt = newround(dPayoutAmt/iSplitCnt,2);
DEBUGLOG(("InSpecialList:: dTmpAmt: [%lf]\n",dTmpAmt));

                                                for(iTmp=0;iTmp<(iSplitCnt-1);iTmp++){
                                                        dLeftAmt = dLeftAmt - dTmpAmt;
                                                }
DEBUGLOG(("InSpecialList:: dLeftAmt: [%lf]\n",dLeftAmt));

                                                if(dLeftAmt>dSplitAmt){
                                                        for(iTmp=0;iTmp<(iSplitCnt-1);iTmp++){
                                                                sprintf(csTag,"avag_split_amt_%d",iTmp);
                                                                PutField_Double(hContext,csTag,dTmpAmt+0.01);
                                                                dTmpTotalAmt += dTmpAmt+0.01;
                                                        }
                                                }else{
                                                        for(iTmp=0;iTmp<(iSplitCnt-1);iTmp++){
                                                                sprintf(csTag,"avag_split_amt_%d",iTmp);
                                                                PutField_Double(hContext,csTag,dTmpAmt);
                                                                dTmpTotalAmt += dTmpAmt;
                                                        }
                                                }

                                        }
                                        sprintf(csTag,"avag_split_amt_%d",(iSplitCnt-1));
                                        PutField_Double(hContext,csTag,dPayoutAmt-dTmpTotalAmt);
				}else{
	
//special split					

					/************************************************/
					iSplitCnt = 8;  		//By default
					double dBaseAmt = 30000.0;	//By default
					double dAddAmt = 3000.0;	//By default
					int iRandMax = 32767; 		//By default max
					double dIdx = 3.2;		//By default
					/************************************************/

					char*   csValueTmp;
                                        csValueTmp = (char*) malloc (128);

DEBUGLOG(("InSpecialList::Call DBSystemParameter::FindCode\n"));
					DBObjPtr = CreateObj(DBPtr,"DBSystemParameter","FindCode");
					sprintf(csTag,"%s_PO_SPLIT_CNT",csPspId);
					if ((unsigned long)(DBObjPtr)(csTag,csValueTmp) == FOUND) {
						iSplitCnt = atoi(csValueTmp);
DEBUGLOG(("Find Special Split Parameter:: [%s] = [%d]\n",csTag,iSplitCnt));
                                        }	
					sprintf(csTag,"PO_SPLIT_BASE_AMT");
                                        if ((unsigned long)(DBObjPtr)(csTag,csValueTmp) == FOUND) {
                                                sscanf(csValueTmp,"%lf",&dBaseAmt);
DEBUGLOG(("Find Special Split Parameter:: [%s] = [%lf]\n",csTag,dBaseAmt));
                                        }
                                        sprintf(csTag,"PO_SPLIT_ADD_AMT");
                                        if ((unsigned long)(DBObjPtr)(csTag,csValueTmp) == FOUND) {
                                                sscanf(csValueTmp,"%lf",&dAddAmt);
DEBUGLOG(("Find Special Split Parameter:: [%s] = [%lf]\n",csTag,dAddAmt));
                                        }
                                        sprintf(csTag,"PO_SPLIT_RANDOM_IDX");
                                        if ((unsigned long)(DBObjPtr)(csTag,csValueTmp) == FOUND) {
                                                sscanf(csValueTmp,"%lf",&dIdx);
DEBUGLOG(("Find Special Split Parameter:: [%s] = [%lf]\n",csTag,dIdx));
                                        }				

					dTmpAmt = 0.0;
                                        dTmpTotalAmt = 0.0;
                                        dLeftAmt = dPayoutAmt;
		
					//double dBaseAmt = (double)((int)(dPayoutAmt/(iSplitCnt*10000))*10000);
					//double dTotalRandom = dPayoutAmt - (double)dBaseAmt*iSplitCnt;
					
					iCnt = 0;

                                        while(iCnt<iSplitCnt-1){
						//struct timespec tv;
						//clock_gettime(CLOCK_REALTIME, &tv);	
			
						struct timeval  tv;
                                                gettimeofday(&tv, NULL);

                                                unsigned int time_msec = (tv.tv_sec)*1000 + (tv.tv_usec)/1000;
                                                srand(time_msec+iCnt);

                                                int iRand = (int)(rand()%iRandMax);
                                                double dRandAmt = newround(((double)iRand/dIdx),2) + dAddAmt;

                                                dTmpAmt = dBaseAmt + dRandAmt;
                                                sprintf(csTag,"avag_split_amt_%d",iCnt);
                                                PutField_Double(hContext,csTag,dTmpAmt);

                                                if(dLeftAmt>dTmpAmt){
                                                        dLeftAmt = dLeftAmt-dTmpAmt;
                                                        iCnt++;
                                                }
                                                else{
                                                        break;
                                                }
                                        }
				
					sprintf(csTag,"avag_split_amt_%d",iCnt);
                                        PutField_Double(hContext,csTag,dLeftAmt);
                                        
					iCnt++;

                                        if(iSplitCnt>iCnt) {
						iSplitCnt=iCnt;
					}
				}

/******************************************* Check Split::End *******************************************/ 

/******************************************* Handle Split Txn::Start *******************************************/
				for(iTmp=0;iTmp<iSplitCnt;iTmp++){				

					// Generate unique amount
					sprintf(csTag,"avag_split_amt_%d",iTmp);
                                        if(GetField_Double(hContext,csTag,&dTmp)){
						
						// generate unique amount
						dUniqueAmt = dTmp;

/* txn_code */
                                                if(GetField_CString(hContext,"txn_code",&csTmp)){
                                                        PutField_CString(hContext,"org_txn_code",csTmp);
                                                }

/* txn_ccy */
                                                sprintf(csTag, "%s_payout_ccy", csPspId);
                                                if(GetField_CString(hContext,csTag,&csTmp)){
                                                        PutField_CString(hContext,"txn_ccy",csTmp);
                                                }

/* merchant_id */
                                                if (GetField_CString(hRequest,"merchant_id", &csTmp)) {
                                                        PutField_CString(hContext,"merchant_id",csTmp);
                                                }

/* baid */
                                                PutField_CString(hContext,"baid",csBaid);

/* org_txn_amt */
                                                PutField_Double(hContext,"org_txn_amt",dTmp);

						// Get Unique Amount
DEBUGLOG(("Call BOUniqueNumber::GetUniqueAmt\n"));
                                                BOObjPtr = CreateObj(BOPtr,"BOUniqueNumber","GetUniqueAmt");
                                                if ((unsigned long)(*BOObjPtr)(hContext,hRequest,hResponse) == PD_OK) {

/* display_amt */
                                                        if(GetField_Double(hResponse,"display_amt",&dUniqueAmt)){
DEBUGLOG(("GetUniqueAmt:: Unique payout amount = [%lf]\n",dUniqueAmt));
                                                        }
                                                } else {
DEBUGLOG(("Call BOUniqueNumber::GetUniqueAmt not found!!\n"));
						}

						// Remove merchant_id
                                                RemoveField_CString(hContext,"merchant_id");

						PutField_Double(hTxn,"unique_amount",dUniqueAmt);
                                                PutField_Double(hTxn,"org_dst_net_amt",dUniqueAmt);
                                                
						PutField_Double(hDetail,"payout_amount",dUniqueAmt);
                                                PutField_Double(hDetail,"unique_amount",dUniqueAmt);
                                                PutField_Double(hDetail,"amount",dUniqueAmt);
                                                
						PutField_Double(hElement,"org_txn_amt",dUniqueAmt);
                                                
						PutField_Double(hCost,"txn_amt",dUniqueAmt);

                                                sprintf(csTag,"%s_%s_txn_amt",csPspId,csToBank);
                                                if(GetField_Double(hContext,csTag,&dAmt)){
                                                        dAmt += dUniqueAmt;
                                                }else{
                                                        dAmt = dUniqueAmt;
                                                }
                                                PutField_Double(hContext,csTag,dAmt);
                                        }

					// Add DBOLPayoutGeneratedFileDT
                                       	if (iRet == PD_OK) {

						// Generate PayoutTxnSeq
DEBUGLOG(("Call DBOLTxnSeq::GetNextPayoutTxnSeq\n"));
                                        	DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextPayoutTxnSeq");
                                        	csPayoutTxnSeq  = strdup((*DBObjPtr)());
DEBUGLOG(("Call DBOLTxnSeq::GetNextPayoutTxnSeq, GeneratePayoutSeq: [%d]=[%s]\n",i,csPayoutTxnSeq));

						// txn_seq
                                        	PutField_CString(hContext,"txn_seq",csPayoutTxnSeq);
                                       
                                        	PutField_CString(hTxn,"txn_id",csPayoutTxnSeq);
                                        	PutField_CString(hTxn, "tracking_txn_seq", csPayoutTxnSeq);
				 	
						PutField_CString(hDetail,"txn_id",csPayoutTxnSeq);
                                        	PutField_CString(hDetail,"gen_txn_id",csPayoutTxnSeq);
                           
						PutField_CString(hElement,"from_txn_seq",csPayoutTxnSeq);

						// status
                                        	if (cBatchMode == PD_OFFLINE) {
                                                	PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
                                        	} else {
                                                	PutField_Int(hDetail,"status",PAYOUT_MASTER_TRANSACTION_SENDING);
						}
					
DEBUGLOG(("Call DBOLPayoutGeneratedFileDT::Add\n"));
                                        	DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileDT","Add");
                                        	if ((unsigned long)(*DBObjPtr)(hDetail) != PD_OK) {
DEBUGLOG(("Call DBOLPayoutGeneratedFileDT::Add Failed!!\n"));
ERRLOG("BOOLPayout::HandleGeneratePayoutApi::Call DBOLPayoutGeneratedFileDT::Add Failed!!\n");
                                                	iRet = INT_ERR;
                                                	break;
                                        	}
					}

					// Write Payout File (Write Detail)
					if (iRet == PD_OK) {
						/********** Write Payout File **********/
DEBUGLOG(("Call WritePayoutFile()\n"));
                                        	if (WritePayoutFile(csFilePath,hDetail) != PD_OK) {
DEBUGLOG(("Call WritePayoutFile() Error!!!\n"));
ERRLOG("BOOLPayout::HandleGeneratePayoutApi::Call WritePayoutFile Error!!!\n");
                                                	iRet = INT_ERR;
                                                	break;
                                        	}
						/********** Write Payout file **********/
					}

					// Check Online/Offline Payout
					if(!iOnlinePayout){

						// Add Txn Header and Txn Detail
                                                if (iRet == PD_OK) {
                                                        PutField_CString(hContext,"process_type","0000");
                                                        PutField_CString(hContext,"process_code","000000");
                                                        PutField_Int(hContext,"do_logging",PD_TRUE);
                                                        PutField_Int(hContext,"db_commit",PD_FALSE);

DEBUGLOG(("Call OMTChannel:AddTxnLog\n"));
                                                        ChannelObjPtr = CreateObj(ChannelPtr,"OMTChannel","AddTxnLog");
                                                        if ((unsigned long)(*ChannelObjPtr)(hContext,hDetail) != PD_OK) {
DEBUGLOG(("Call OMTChannel:AddTxnLog Failed!!\n"));
ERRLOG("BOOLPayout::HandleGeneratePayoutApi::Call OMTChannel:AddTxnLog Failed!!\n");
                                                                iRet = INT_ERR;
								break;
                                                        }

                                                        PutField_Int(hContext,"do_logging",PD_FALSE);
                                                }

						// Calculate Cost
						if (iRet == PD_OK) {

							PutField_CString(hCost,"org_txn_code",PD_OL_PAYOUT_API_GEN);

DEBUGLOG(("Call BOOLPspCosts::CalOLPspCostsByParty\n"));
                                                        BOObjPtr = CreateObj(BOPtr,"BOOLPspCosts","CalOLPspCostsByParty");
                                                        if ((unsigned long)(*BOObjPtr)(hCost,hCost) == PD_OK) {

/* rule_id */
                                                                if(GetField_Int(hCost,"rule_id",&iCostTmp)){
                                                                        PutField_Int(hTxn,"charge_rule_id",iCostTmp);
DEBUGLOG(("CalOLPspCostsByParty::cost rule id[%d]\n",iCostTmp));
                                                                }

/* charge_period_type */
                                                                if(GetField_Char(hCost,"charge_period_type",&cTmp)){
                                                                        PutField_Char(hTxn,"charge_period_type",cTmp);
DEBUGLOG(("CalOLPspCostsByParty::charge_period_type[%c]\n",cTmp));
                                                                }

/* precal_fee */
                                                                if(GetField_Double(hCost,"precal_fee",&dTmp)){
                                                                        PutField_Double(hTxn,"pre_cal_charge",dTmp);
DEBUGLOG(("CalOLPspCostsByParty::payout_cost[%lf]\n",dTmp));
                                                                }
                                                        }
                                                }			
						
						// Add Txn Element
						if (iRet == PD_OK) {

                                                        PutField_Char(hElement,"party_type",PD_TYPE_PSP);
                                                        PutField_CString(hElement,"amount_type",PD_DR);

DEBUGLOG(("Call BOOLTxnElements:AddTxnAmtElement\n"));
                                                        BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddTxnAmtElement");
                                                        if ((unsigned long)(*BOObjPtr)(hElement) == PD_OK) {

DEBUGLOG(("Call BOOLTxnElements:AddTxnFeeElements\n"));
                                                                BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddTxnFeeElements");
                                                                if ((unsigned long)(*BOObjPtr)(hElement) != PD_OK) {
DEBUGLOG(("Call BOOLTxnElements:AddTxnFeeElements Failed!!\n"));
ERRLOG("BOOLPayout::HandleGeneratePayoutApi::Call BOOLTxnElements:AddTxnFeeElements Failed!!\n");
                                                                	iRet = INT_ERR;
                                                                	break;					
								}			
                                                        } else {
DEBUGLOG(("Call BOOLTxnElements:AddTxnAmtElement Failed!!\n"));
ERRLOG("BOOLPayout::HandleGeneratePayoutApi::Call BOOLTxnElements:AddTxnAmtElement Failed!!\n");
                                                                iRet = INT_ERR;
                                                                break;
							}
                                                }

						// Update Txn Header and Txn Psp Detail
						if (iRet == PD_OK) {

                                                        PutField_Char(hTxn,"party_type",PD_TYPE_PSP);
                                                        PutField_Char(hTxn,"response_mode",PD_ACCEPT);
                                                        PutField_CString(hTxn,"sub_status",PD_APPROVED);
                                                        PutField_Char(hTxn,"recon_status",PD_UNRECONCILED);

DEBUGLOG(("Call BOOLBalance:UpdatePayoutAmount\n"));
                                                        BOObjPtr = CreateObj(BOPtr,"BOOLBalance","UpdatePayoutAmount");
                                                        if ((unsigned long)(*BOObjPtr)(hTxn) == PD_OK) {

/* PHDATE */
                                                                if(GetField_CString(hContext,"PHDATE",&csTmp)){
                                                                        PutField_CString(hTxn,"PHDATE",csTmp);
                                                                }

/* local_tm_time */
                                                                if(GetField_CString(hContext,"local_tm_time",&csTmp)){
                                                                        PutField_CString(hTxn,"local_tm_time",csTmp);
                                                                }

/* report_date */
                                                                if(GetField_CString(hRequest,"report_date",&csTmp)){
                                                                        PutField_CString(hTxn,"report_date",csTmp);
                                                                }

                                                                PutField_CString(hTxn,"desc","Payout (PSP)");
                                                                PutField_CString(hTxn,"to_bank_code",csToBank);
                                                                PutField_Char(hTxn,"ex_supplier",PD_INT_EX);
                                                                PutField_Double(hTxn,"ex_rate",1.0);

DEBUGLOG(("Call UpdateTxnLog()\n"));
                                                                iRet = UpdateTxnLog(hTxn);
                                                                if (iRet == PD_OK) {
DEBUGLOG(("Call UpdateTxnLog() TxnCommit\n"));
                                                                        TxnCommit();
								} else {
DEBUGLOG(("Call UpdateTxnLog() Failed!!\n"));
ERRLOG("BOOLPayout::HandleGeneratePayoutApi::UpdateTxnLog Failed!!\n");
                                                                        break;
                                                                }
                                                        } else {
DEBUGLOG(("Call BOOLBalance:UpdatePayoutAmount Failed!!\n"));
ERRLOG("BOOLPayout::HandleGeneratePayoutApi::Call BOOLBalance:UpdatePayoutAmount Failed!!\n");
                                                                iRet = INT_ERR;
                                                                break;
							}
                                                }
					}

					iGenTxnCnt = 0;
                                        sprintf(csTag,"%s_%s_gen_txn_cnt",csPspId,csToBank);
                                        GetField_Int(hContext,csTag,&iGenTxnCnt);
                                        PutField_Int(hContext,csTag,iGenTxnCnt+1);
				}
/******************************************* Handle Split Txn::End *******************************************/
			}

			// Update DBOLPayoutRequest
			if(iRet == PD_OK){

				PutField_CString(hTxn,"txn_seq",csOrgTxnId);
                              	PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);

DEBUGLOG(("Call DBOLPayoutRequest::Update\n"));
                               	DBObjPtr = CreateObj(DBPtr,"DBOLPayoutRequest","Update");
                              	if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
DEBUGLOG(("Call DBOLPayoutRequest::Update Failed!!\n"));
ERRLOG("BOOLPayout::HandleGeneratePayoutApi::Call DBOLPayoutRequest::Update Failed!!\n");
                                      	iRet = INT_ERR;
					break;
                             	}
                    	}

			// Update DBOLTransaction
                       	if(iRet == PD_OK){

                             	if (iOnlinePayout) {
                                      	PutField_CString(hUploadTxn,"sub_status",PD_APPROVED_AND_SENDING);
                               	} else {
                                     	PutField_CString(hUploadTxn,"sub_status",PD_APPROVED_AND_GENERATED);
				}

DEBUGLOG(("Call DBOLTransaction::Update\n"));
                               	DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Update");
                              	if ((unsigned long)(*DBObjPtr)(hUploadTxn) != PD_OK) {
DEBUGLOG(("Call DBOLTransaction::Update Failed!!\n"));
ERRLOG("BOOLPayout::HandleGeneratePayoutApi::Call DBOLTransaction::Update Failed!!\n");
                                      	iRet = INT_ERR;
					break;
                               	}
                     	}	
			
			// Update DBOLPayoutApiPregenDT
			if(iRet == PD_OK){

DEBUGLOG(("Call DBOLPayoutApiPregenDT::UpdateByTxnId\n"));
                           	DBObjPtr = CreateObj(DBPtr,"DBOLPayoutApiPregenDT","UpdateByTxnId");
                               	if((unsigned long)(*DBObjPtr)(hPregenDT)!=PD_OK){
DEBUGLOG(("Call DBOLPayoutApiPregenDT::UpdateByTxnId Error!!!\n"));
ERRLOG("BOOLPayout:HandleGeneratePayoutApi::DBOLPayoutApiPregenDT::UpdateByTxnId Error!!!\n");
                                     	iRet = INT_ERR;
					break;
                            	}
			}

			iTxnCnt = 0;
                       	sprintf(csTag,"%s_%s_txn_cnt",csPspId,csToBank);
                     	GetField_Int(hContext,csTag,&iTxnCnt);
                      	PutField_Int(hContext,csTag,iTxnCnt+1);

			// Txn Record Increment
                      	iTxnRec++;
		}

		// Write Payout File (End Payout File)
		if (iRet == PD_OK && iTxnRec>0 && !iOnlinePayout) {

                  	hash_destroy(hTxn);
                     	hash_init(hTxn,0);

                     	PutField_Int(hTxn,"end_file",PD_TRUE);

			/********** Write Payout File **********/
DEBUGLOG(("Call WritePayoutFile()\n"));
                       	iRet = WritePayoutFile(csFilePath,hTxn);
			if (iRet != PD_OK) { 
DEBUGLOG(("Call WritePayoutFile() Error!!!\n"));
ERRLOG("BOOLPayout::HandleGeneratePayoutApi::Call WritePayoutFile Error!!!\n");
                              	iRet = INT_ERR;
                    	}	
			/********** Write Payout File **********/
            	}

            	if (iTxnRec==0) {
DEBUGLOG(("No Record Found!!!\n"));
                  	iRet = INT_NOT_RECORD;
               	}
DEBUGLOG(("Get All Pregen Records for Update - End\n"));				
        }

	// Update DBOLPayoutGeneratedFileHD (total amunt and status)
	if (iRet == PD_OK) {
		
                int j = 0;
		int iCnt = 0;
		
		char *csFileId = NULL;

		if (GetField_Int(hContext,"psp_count",&iCnt)) {
DEBUGLOG(("psp_count = [%d]\n", iCnt));
                }

		for(j=0; j<iCnt; j++){

			hash_destroy(hTxn);
                        hash_init(hTxn,0);

/* psp_id and bank_code */
                        sprintf(csTag,"psp_id_%d",j);
                        sprintf(csTagTwo,"bank_code_%d",j);
                        if(GetField_CString(hContext,csTag,&csPspId) &&
                           GetField_CString(hContext,csTagTwo,&csBankCode)
                        ){

/* file_id */
                                sprintf(csTag,"%s_%s_file_id",csPspId,csBankCode);
                                GetField_CString(hContext,csTag,&csFileId);
                                PutField_CString(hTxn,"file_id",csFileId);

DEBUGLOG(("Call DBOLPayoutGeneratedFileHD::MatchGenStatus_ForUpdate\n"));
                		DBObjPtr = CreateObj(DBPtr, "DBOLPayoutGeneratedFileHD", "MatchGenStatus_ForUpdate");
                		iTmpRet = (unsigned long)(*DBObjPtr)(csFileId, PD_PAYOUTFILE_PROCESSING_GENERATE);
                		if (iTmpRet == PD_FOUND) {

/* txn_amt */
                                	sprintf(csTag,"%s_%s_txn_amt",csPspId,csBankCode);
                                	GetField_Double(hContext,csTag,&dTmp);
                                	PutField_Double(hTxn,"txn_amt",dTmp);

/* status */
                                	if(!iOnlinePayout){
                                        	PutField_Int(hTxn,"status",PD_PAYOUTFILE_GENERATED);
					}
					
					PutField_CString(hTxn,"update_user",csUser);

DEBUGLOG(("Call DBOLPayoutGeneratedFileHD::Update psp_id [%d][%s]\n", j,csPspId));
                                	DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGeneratedFileHD","Update");
                                	if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
DEBUGLOG(("Call DBOLPayoutGeneratedFileHD::Update Error!!!\n"));
ERRLOG("BOOLPayout::HandleGeneratePayoutApi:Call OLPayoutGeneratedFileHD::Update Error!!!\n");
                                        	iRet = INT_ERR;
                                        	break;
                                	}
				} else {
DEBUGLOG(("Call DBOLPayoutGeneratedFileHD::MatchGenStatus_ForUpdate not found\n"));
ERRLOG("BOOLPayout::HandleGeneratePayoutApi:Call DBOLPayoutGeneratedFileHD::MatchGenStatus_ForUpdate not found\n");
                                	iRet = INT_TXN_STATUS_NOT_MATCH;
                                     	break;
				}
                        }
                }
	}

	// Update DBOLPayoutApiPregenHD
	if (iRet == PD_OK) {

		// status
                PutField_Char(hPregen,"status",PD_OL_PO_API_PROCESSING);

DEBUGLOG(("Call DBOLPayoutApiPregenHD: MatchPregenStatus_ForUpdate\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiPregenHD", "MatchPregenStatus_ForUpdate");
                iTmpRet = (unsigned long)(*DBObjPtr)(hPregen);
                if (iTmpRet == PD_FOUND) {

                        hash_destroy(hTxn);
                        hash_init(hTxn, 0);

                       	PutField_CString(hTxn, "action_id", csActionId);
                        PutField_Char(hTxn,"status",PD_OL_PO_API_COMPLETE);
                        PutField_Int(hTxn,"gen_ret_code",0);
                        PutField_CString(hTxn,"update_user",csUser);

DEBUGLOG(("Call DBOLPayoutApiPregenHD:: Update\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBOLPayoutApiPregenHD", "Update");
                        iRet = (unsigned long)(*DBObjPtr)(hTxn);
                        if (iRet != PD_OK) {
DEBUGLOG(("Call DBOLPayoutApiPregenHD:: Update Failure!!!\n"));
ERRLOG("BOOLPayout::HandleGeneratePayoutApi::Call DBOLPayoutApiPregenHD:: Update Failure!!!\n");
                                iRet = INT_ERR;
                        }
                } else {
DEBUGLOG(("Call DBOLPayoutApiPregenHD: MatchPregenStatus_ForUpdate not found\n"));
ERRLOG("BOOLPayout: HandleGeneratePayoutApi:: call DBOLPayoutApiPregenHD: MatchPregenStatus_ForUpdate not found\n");
                        iRet = INT_TXN_STATUS_NOT_MATCH;
                }
        }

	FREE_ME(csActionId);
	FREE_ME(csBatchId);
	FREE_ME(csOrgTxnId);

	hash_destroy(hTxn);
        FREE_ME(hTxn);
	hash_destroy(hPregen);
        FREE_ME(hPregen);
	hash_destroy(hPregenDT);
        FREE_ME(hPregenDT);
	hash_destroy(hDetail);
        FREE_ME(hDetail);
	hash_destroy(hUploadTxn);
        FREE_ME(hUploadTxn);
	hash_destroy(hElement);
        FREE_ME(hElement);
	hash_destroy(hBal);
        FREE_ME(hBal);
	hash_destroy(hCost);
        FREE_ME(hCost);

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("BOOLPayout::HandleGeneratePayoutApi iRet[%d]\n",iRet));
        return  iRet;
}

