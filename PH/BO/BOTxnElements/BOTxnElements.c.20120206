/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/01/31              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOTxnElements.h"
#include "queue_utility.h"
#include "mq_db.h"

char    cDebug;

OBJPTR(DB);

void BOTxnElements(char    cdebug)
{
        cDebug = cdebug;
}


int     AddTxnAmtElement(hash_t* hContext)
{
         int     iRet = PD_OK;

        char    *csOrgTxnSeq;
        char    *csOrgTxnCcy;
        double  dTmp;
	char	cTmp;
	char	*csTmp;

        hash_t  *hRec;
        hRec = (hash_t*)  malloc (sizeof(hash_t));

        if (GetField_CString(hContext,"from_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("AddTxnAmtElement:: org_txn_seq = [%s]\n",csOrgTxnSeq));
        }

        if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("AddTxnAmtElement:: org_txn_ccy= [%s]\n",csOrgTxnCcy));
        }
        else {
DEBUGLOG((" AddTxnAmtElement:: org_txn_ccy is missing!!!, skip  AddTxnAmtElement\n"));
        }

        if (GetField_Double(hContext,"org_txn_amt",&dTmp) && iRet == PD_OK) {
                hash_init(hRec,0);
                DBObjPtr = CreateObj(DBPtr,"DBTxnElements","Add");

/* txn seq */
                PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                PutField_CString(hRec,"txn_element_type",PD_ELEMENT_TXN_AMT);

/* party type */
		if (GetField_Char(hContext, "party_type", &cTmp)) {
	                PutField_Char(hRec,"party_type",cTmp);
DEBUGLOG(("AddTxnAmtElement:: party_type = [%c]\n",cTmp));
		} else {
	                PutField_Char(hRec,"party_type",PD_TYPE_MERCHANT);
		}

/* txn_ccy */
                PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* amount */
                PutField_Double(hRec,"amount",dTmp);

/* user */      PutField_CString(hRec,"add_user",PD_UPDATE_USER);

/* amount type */
		if (GetField_CString(hContext, "amount_type", &csTmp)) {
	                PutField_CString(hRec,"amount_type",csTmp);
DEBUGLOG(("AddTxnAmtElement:: amount_type = [%s]\n",csTmp));
		} else {
	                PutField_CString(hRec,"amount_type",PD_CR);
		}

                iRet = (unsigned long)(*DBObjPtr)(hRec);
                hash_destroy(hRec);
        }

        FREE_ME(hRec);
DEBUGLOG(("AddTxnAmtElement:: iRet = [%d]\n",iRet));
        return  iRet;
}




int     AddTxnFeeElements(hash_t* hContext)
{
        int     iRet = PD_OK;

        char    *csOrgTxnSeq;
        char    *csOrgTxnCcy;
        char    *csOrgDstTxnCcy;
        double  dTmp;
	char	cTmp;
	char	*csTmp;
	

        hash_t  *hRec;
        hRec = (hash_t*)  malloc (sizeof(hash_t));

        if (GetField_CString(hContext,"from_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("AddTxnFeeElements:: org_txn_seq = [%s]\n",csOrgTxnSeq));
        }

        if (GetField_CString(hContext,"src_txn_fee_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("AddTxnFeeElements:: src_txn_fee_ccy= [%s]\n",csOrgTxnCcy));
        }
        else {
DEBUGLOG(("AddTxnFeeElements:: src_txn_fee_ccy is missing!!!, skip AddTxnFeeElements\n"));
        }

        if (GetField_CString(hContext,"dst_txn_fee_ccy",&csOrgDstTxnCcy)) {
DEBUGLOG(("AddTxnFeeElements:: dst_txn_fee_ccy= [%s]\n",csOrgDstTxnCcy));
        }
/* merchant fee */
        if (GetField_Double(hContext,"src_txn_fee",&dTmp) && iRet == PD_OK) {

                if(dTmp>0){
DEBUGLOG(("AddTxnFeeElements:: src txn fee = [%lf]\n",dTmp));

                        hash_init(hRec,0);
                        DBObjPtr = CreateObj(DBPtr,"DBTxnElements","Add");

/* txn seq */
                        PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                        PutField_CString(hRec,"txn_element_type",PD_ELEMENT_TXN_FEE);

/* party type */
			if (GetField_Char(hContext, "party_type", &cTmp)) {
	                        PutField_Char(hRec,"party_type",cTmp);
			} else {
	                        PutField_Char(hRec,"party_type",PD_TYPE_MERCHANT);
			}

/* txn_ccy */
                        PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* fee */
                        PutField_Double(hRec,"amount",dTmp);

/* user */              PutField_CString(hRec,"add_user",PD_UPDATE_USER);

/* amount type */
			if (GetField_CString(hContext, "amount_type", &csTmp)) {
	                        PutField_CString(hRec,"amount_type",csTmp);
			} else {
	                        PutField_CString(hRec,"amount_type",PD_DR);
			}

                        iRet = (unsigned long)(*DBObjPtr)(hRec);
                        hash_destroy(hRec);
                }
        }


/* customer fee */
        if (GetField_Double(hContext,"dst_txn_fee",&dTmp) && iRet == PD_OK) {
DEBUGLOG(("AddTxnFeeElements:: dst_txn_fee = [%lf]\n",dTmp));

                if(dTmp>0){
                        hash_init(hRec,0);
                        DBObjPtr = CreateObj(DBPtr,"DBTxnElements","Add");

/* txn seq */
                        PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                        PutField_CString(hRec,"txn_element_type",PD_ELEMENT_TXN_FEE);


/* party type */
                        PutField_Char(hRec,"party_type",PD_TYPE_CUSTOMER);

/* txn_ccy */
                        PutField_CString(hRec,"ccy",csOrgDstTxnCcy);

/* fee */
                        PutField_Double(hRec,"amount",dTmp);
/* user */              PutField_CString(hRec,"add_user",PD_UPDATE_USER);
/* amount type */
			if (GetField_CString(hContext, "amount_type", &csTmp)) {
	                        PutField_CString(hRec,"amount_type",csTmp);
			} else {
                        	PutField_CString(hRec,"amount_type",PD_DR);
			}

                        iRet = (unsigned long)(*DBObjPtr)(hRec);
                        hash_destroy(hRec);
                }
        }


        FREE_ME(hRec);
DEBUGLOG(("AddFeeTxnChgLog:: iRet = [%d]\n",iRet));
        return  iRet;
}
int     AddReserveAmtElement(hash_t* hContext)
{
         int     iRet = PD_OK;

        char    *csOrgTxnSeq;
        char    *csOrgTxnCcy;
        double  dTmp;

        hash_t  *hRec;
        hRec = (hash_t*)  malloc (sizeof(hash_t));

        if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("AddReserveAmt:: org_txn_seq = [%s]\n",csOrgTxnSeq));
        }

        if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("AddReserveAmt:: org_txn_ccy= [%s]\n",csOrgTxnCcy));
        }
        else {
DEBUGLOG((" AddReserveAmt:: org_txn_ccy is missing!!!, skip  AddTxnAmtElement\n"));
        }

        if (GetField_Double(hContext,"reserve_amt",&dTmp) && iRet == PD_OK) {
                hash_init(hRec,0);
                DBObjPtr = CreateObj(DBPtr,"DBTxnElements","Add");

/* txn seq */
                PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                PutField_CString(hRec,"txn_element_type",PD_ELEMENT_RES_AMT);

/* party type */
                PutField_Char(hRec,"party_type",PD_TYPE_MERCHANT);

/* txn_ccy */
                PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* amount */
                PutField_Double(hRec,"amount",dTmp);

/* user */      PutField_CString(hRec,"add_user",PD_UPDATE_USER);


                iRet = (unsigned long)(*DBObjPtr)(hRec);
                hash_destroy(hRec);
        }

        FREE_ME(hRec);
DEBUGLOG(("AddReserveAmt:: iRet = [%d]\n",iRet));
        return  iRet;
}


int     AddMarkupAmtElement(hash_t* hContext)
{
         int     iRet = PD_OK;

        char    *csOrgTxnSeq;
	char	*csOrgTxnCcy;
	char	*csTxnCode;
        char    *csTmp;
        double  dTmp;

        hash_t  *hRec;
        hRec = (hash_t*)  malloc (sizeof(hash_t));

        if (GetField_CString(hContext,"from_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("AddMarkupAmtElement:: org_txn_seq = [%s]\n",csOrgTxnSeq));
        }

	if(GetField_CString(hContext,"txn_code", &csTxnCode)){
DEBUGLOG(("AddMarkupAmtElement:: txn_code = [%s]\n",csTxnCode));
	}

        if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("AddMarkupAmtElement:: org_txn_ccy= [%s]\n",csOrgTxnCcy));
        }
        else {
DEBUGLOG((" AddMarkupAmtElement:: org_txn_ccy is missing!!!, skip  AddTxnAmtElement\n"));
        }

        if (GetField_Double(hContext,"markup_amt",&dTmp) && iRet == PD_OK) {
                hash_init(hRec,0);
                DBObjPtr = CreateObj(DBPtr,"DBTxnElements","Add");

/* txn seq */
                PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                PutField_CString(hRec,"txn_element_type",PD_ELEMENT_MARKUP_AMT);

/* party type */
                PutField_Char(hRec,"party_type",PD_TYPE_CUSTOMER);

/* txn_ccy */
                PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* amount */
                PutField_Double(hRec,"amount",dTmp);

/*markup rate*/
		if(GetField_Double(hContext,"markup_rate",&dTmp)){
                	PutField_Double(hRec,"rate",dTmp);
		}


/* user */      PutField_CString(hRec,"add_user",PD_UPDATE_USER);

		if (GetField_CString(hContext, "amount_type", &csTmp)) {
			PutField_CString(hRec,"amount_type",csTmp);
		} else {

			//if(!strcmp(csTxnCode))
			PutField_CString(hRec,"amount_type",PD_CR);
		}

                iRet = (unsigned long)(*DBObjPtr)(hRec);
                hash_destroy(hRec);
        }

        FREE_ME(hRec);
DEBUGLOG(("AddMarkupAmtElement:: iRet = [%d]\n",iRet));
        return  iRet;
}


int     AddMerchantFloatAmtElement(hash_t* hContext)
{
         int     iRet = PD_OK;

        char    *csOrgTxnSeq;
        char    *csOrgTxnCcy;
        double  dTmp;

        hash_t  *hRec;
        hRec = (hash_t*)  malloc (sizeof(hash_t));

        if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("AddMerchantFloatAmtElement:: org_txn_seq = [%s]\n",csOrgTxnSeq));
        }

        if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("AddMerchantFloatAmtElement:: org_txn_ccy= [%s]\n",csOrgTxnCcy));
        }
        else {
DEBUGLOG((" AddMerchantFloatAmtElement:: org_txn_ccy is missing!!!, skip  AddTxnAmtElement\n"));
        }

        if (GetField_Double(hContext,"float_amt",&dTmp) && iRet == PD_OK) {
                hash_init(hRec,0);
                DBObjPtr = CreateObj(DBPtr,"DBTxnElements","Add");

/* txn seq */
                PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                PutField_CString(hRec,"txn_element_type",PD_ELEMENT_FLOAT_AMT);

/* party type */
                PutField_Char(hRec,"party_type",PD_TYPE_MERCHANT);

/* txn_ccy */
                PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* amount */
                PutField_Double(hRec,"amount",dTmp);

/* user */      PutField_CString(hRec,"add_user",PD_UPDATE_USER);


                iRet = (unsigned long)(*DBObjPtr)(hRec);
                hash_destroy(hRec);
        }

        FREE_ME(hRec);
DEBUGLOG(("AddMerchantFloatAmtElement:: iRet = [%d]\n",iRet));
        return  iRet;
}


