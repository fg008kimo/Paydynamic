/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/04/27              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOReserve.h"

char    cDebug;
OBJPTR(DB);
OBJPTR(BO);

void BOReserve(char    cdebug)
{
        cDebug = cdebug;
}

int GetReserveAmount(hash_t *hContext, const hash_t *hRequest)
{
	int iRet = 0;
	double	dVal = 0;
	double	dReservedAmt = 0;
	double	dOrgTxnAmt = 0;
	char	cType = ' ';
	char	*csOrgTxnCountry;
	char	*csOrgChannelCode;
	char	*csOrgServiceCode;
	char	*csOrgMerchantId;
	char	*csOrgMerchantClientId;
	char	*csTxnCode;
	

	if (GetField_Double(hContext,"org_txn_amt",&dOrgTxnAmt)) {
DEBUGLOG(("BOReserve::GetReserveAmount() org_txn_amt = [%f]\n",dOrgTxnAmt));
	}
	else {
DEBUGLOG(("BOReserve::GetReserveAmount() org_txn_amt not found!!!\n"));
	}

	if (GetField_CString(hContext,"txn_code",&csTxnCode)) {
DEBUGLOG(("BOReserve::GetReserveAmount() txn_code = [%s]\n",csTxnCode));
	}
	else {
DEBUGLOG(("BOReserve::GetReserveAmount() txn_code not found!!!\n"));
	}

/*org txn country */
        if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {
DEBUGLOG(("BOReserve::GetReserveAmount() org_txn_country = [%s]\n",csOrgTxnCountry));
        }
        else {
DEBUGLOG(("BOReserve::GetReserveAmount() org_txn_country is missing!!!\n"));
        }

/*org channel code */
        if (GetField_CString(hContext,"org_channel_code",&csOrgChannelCode)) {
DEBUGLOG(("BOReserve::GetReserveAmount() org_channel_code = [%s]\n",csOrgChannelCode));
        }
        else {
DEBUGLOG(("BOReserve::GetReserveAmount() org_channel_code is missing!!!\n"));
        }

/*org service code */
        if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {
DEBUGLOG(("BOReserve::GetReserveAmount() org_service_code = [%s]\n",csOrgServiceCode));
        }
        else {
DEBUGLOG(("BOReserve::GetReserveAmount() org_service_code is missing!!!\n"));
        }


/* org merchant id */
        if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {
DEBUGLOG(("BOReserve::GetReserveAmount() org_merchant_id = [%s]\n",csOrgMerchantId));
        }
        else {
DEBUGLOG(("BOReserve::GetReserveAmount() org_merchant_id is missing!!!\n"));
        }

/* org merchant client id */
        if (GetField_CString(hContext,"org_client_id",&csOrgMerchantClientId)) {
DEBUGLOG(("BOReserve::GetReserveAmount() org_merchant_Clientid = [%s]\n",csOrgMerchantClientId));
        }
        else {
DEBUGLOG(("BOReserve::GetReserveAmount() org_merchant_Clientid is missing!!!\n"));
        }

	
	DBObjPtr = CreateObj(DBPtr,"DBRuleTxnRes","Find");
        if ((*DBObjPtr)( csOrgTxnCountry, 
			csOrgChannelCode,
			csOrgServiceCode,
                        csTxnCode,
                        csOrgMerchantId,
                        csOrgMerchantClientId,
                        &cType,
                        &dVal) != PD_OK) {
        //        iRet = INT_ERR;
DEBUGLOG(("BOReserve::GetReserveAmount() call FindReserve failed!!!\n"));
        }
	else {
DEBUGLOG(("BOReserve::GetReserveAmount() amount type = [%c]\n",cType));
DEBUGLOG(("BOReserve::GetReserveAmount() amount value = [%f]\n",dVal));
		if (cType == PD_PRECENTAGE) {
			double dTmp = 0;
			dTmp = dOrgTxnAmt * (dVal/100);
			dReservedAmt = newround(dTmp,PD_DECIMAL_LEN);
		}
		else if (cType == PD_FIXED_AMOUNT) {
			dReservedAmt = newround(dVal,PD_DECIMAL_LEN);
		}
		PutField_Double(hContext,"reserve_amt",dReservedAmt);
DEBUGLOG(("BOReserve::GetReserveAmount() reserve amount = [%f]\n",dReservedAmt));
	}

DEBUGLOG(("BOReserve::GetReserveAmount() exit iRet = [%d]\n",iRet));
	return iRet = iRet;
}
