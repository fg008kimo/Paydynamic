/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/04/27              Cody Chan
Handle MCR Merchant Level Reserve Rate		   2012/12/12		   Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOReserve.h"

char    cDebug;
OBJPTR(DB);
OBJPTR(BO);

void BOReserve(char    cdebug)
{
        cDebug = cdebug;
}

int GetReserveAmount(hash_t *hContext, const hash_t *hRequest)
{
	int iRet = 0;
	double	dVal = 0;
	double	dReservedAmt = 0;
	double	dOrgTxnAmt = 0;
	char	cType = ' ';
	//char	*csOrgTxnCountry;
	//char	*csOrgChannelCode;
	//char	*csOrgServiceCode;
	char	*csOrgMerchantId;
	char	*csOrgMerchantClientId;
	//char	*csTxnCode;
	

	if (GetField_Double(hContext,"org_txn_amt",&dOrgTxnAmt)) {
DEBUGLOG(("BOReserve::GetReserveAmount() org_txn_amt = [%f]\n",dOrgTxnAmt));
	}
	else {
DEBUGLOG(("BOReserve::GetReserveAmount() org_txn_amt not found!!!\n"));
	}
/*
	if (GetField_CString(hContext,"txn_code",&csTxnCode)) {
DEBUGLOG(("BOReserve::GetReserveAmount() txn_code = [%s]\n",csTxnCode));
	}
	else {
DEBUGLOG(("BOReserve::GetReserveAmount() txn_code not found!!!\n"));
	}

//org txn country 
        if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {
DEBUGLOG(("BOReserve::GetReserveAmount() org_txn_country = [%s]\n",csOrgTxnCountry));
        }
        else {
DEBUGLOG(("BOReserve::GetReserveAmount() org_txn_country is missing!!!\n"));
        }

//org channel code 
        if (GetField_CString(hContext,"org_channel_code",&csOrgChannelCode)) {
DEBUGLOG(("BOReserve::GetReserveAmount() org_channel_code = [%s]\n",csOrgChannelCode));
        }
        else {
DEBUGLOG(("BOReserve::GetReserveAmount() org_channel_code is missing!!!\n"));
        }

//org service code
        if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {
DEBUGLOG(("BOReserve::GetReserveAmount() org_service_code = [%s]\n",csOrgServiceCode));
        }
        else {
DEBUGLOG(("BOReserve::GetReserveAmount() org_service_code is missing!!!\n"));
        }
*/

/* org merchant id */
        if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {
DEBUGLOG(("BOReserve::GetReserveAmount() org_merchant_id = [%s]\n",csOrgMerchantId));
        }
        else {
DEBUGLOG(("BOReserve::GetReserveAmount() org_merchant_id is missing!!!\n"));
        }

/* org merchant client id */
        if (GetField_CString(hContext,"org_client_id",&csOrgMerchantClientId)) {
DEBUGLOG(("BOReserve::GetReserveAmount() org_merchant_Clientid = [%s]\n",csOrgMerchantClientId));
        }
        else {
DEBUGLOG(("BOReserve::GetReserveAmount() org_merchant_Clientid is missing!!!\n"));
        }

	
	DBObjPtr = CreateObj(DBPtr,"DBRuleTxnRes","Find");
        if ((*DBObjPtr)( //csOrgTxnCountry, 
			//csOrgChannelCode,
			//csOrgServiceCode,
                        //csTxnCode,
                        csOrgMerchantId,
                        csOrgMerchantClientId,
                        &cType,
                        &dVal) != PD_OK) {
        //        iRet = INT_ERR;
DEBUGLOG(("BOReserve::GetReserveAmount() call FindReserve failed!!!\n"));
        }
	else {
DEBUGLOG(("BOReserve::GetReserveAmount() amount type = [%c]\n",cType));
DEBUGLOG(("BOReserve::GetReserveAmount() amount value = [%f]\n",dVal));
		if (cType == PD_PRECENTAGE || cType == PD_PRECENT_WITH_FIX) {
			double dTmp = 0;
			dTmp = dOrgTxnAmt * (dVal/100);
			dReservedAmt = newround(dTmp,PD_DECIMAL_LEN);
		}
		else if (cType == PD_FIXED_AMOUNT) {
			dReservedAmt = newround(dVal,PD_DECIMAL_LEN);
		}
		PutField_Double(hContext,"reserve_amt",dReservedAmt);
DEBUGLOG(("BOReserve::GetReserveAmount() reserve amount = [%f]\n",dReservedAmt));
	}

DEBUGLOG(("BOReserve::GetReserveAmount() exit iRet = [%d]\n",iRet));
	return iRet = iRet;
}

int HandleReserveAmount(hash_t *hContext)
{
	int	iRet = -1;
	int	iAmtId = 0;

	char	cPartyType;
	char*	csPartyId;

	int	iTmp = 0;
	double	dTmp = 0.0;
	char*	csTmp;
	
/* ind_reserve */
	if (GetField_Int(hContext,"ind_reserve",&iTmp)) {
DEBUGLOG(("BOReserve::HandleReserveAmount() ind_reserve = [%d]\n",iTmp));
	}
	else {
DEBUGLOG(("BOReserve::HandleReserveAmount() ind_reserve not found!!!\n"));
	}

	if(iTmp != PD_TRUE){
DEBUGLOG(("BOReserve::GetReserveAmount() exit ok\n"));
		return iRet = PD_OK;
	}


/* party_type */
	if (GetField_Char(hContext,"party_type",&cPartyType)) {
DEBUGLOG(("BOReserve::HandleReserveAmount() party_type = [%c]\n",cPartyType));
	}
	else {
DEBUGLOG(("BOReserve::HandleReserveAmount() party_type not found!!!\n"));
	}

/* party_id */
	if (GetField_CString(hContext,"party_id",&csPartyId)) {
DEBUGLOG(("BOReserve::HandleReserveAmount() party_id = [%s]\n",csPartyId));
	}
	else {
DEBUGLOG(("BOReserve::HandleReserveAmount() party_id not found!!!\n"));
	}

/* reserve_rate  */
	if (GetField_Double(hContext,"reserve_rate",&dTmp)) {
DEBUGLOG(("BOReserve::HandleReserveAmount() reserve_rate = [%f]\n",dTmp));
		PutField_Double(hContext,"value",dTmp);//
	}
	else {
DEBUGLOG(("BOReserve::HandleReserveAmount() reserve_rate not found!!!\n"));
	}

/* create_user  */
	if (GetField_CString(hContext,"create_user",&csTmp)) {
DEBUGLOG(("BOReserve::HandleReserveAmount() create_user = [%s]\n",csTmp));
	}
	else {
DEBUGLOG(("BOReserve::HandleReserveAmount() create_user not found!!!\n"));
	}

/* update_user  */
	if (GetField_CString(hContext,"update_user",&csTmp)) {
DEBUGLOG(("BOReserve::HandleReserveAmount() update_user = [%s]\n",csTmp));
	}
	else {
DEBUGLOG(("BOReserve::HandleReserveAmount() update_user not found!!!\n"));
	}

	/* FindById DBRuleTxnRes */
DEBUGLOG(("BOReserve::HandleReserveAmount() Call DBRuleTxnRes FindById\n"));
	DBObjPtr = CreateObj(DBPtr,"DBRuleTxnRes","FindById");
        if ((*DBObjPtr)(cPartyType,
			csPartyId, 
                        &iAmtId) != PD_OK) {
DEBUGLOG(("BOReserve::HandleReserveAmount() Call DBRuleTxnRes FindById failed!!!\n"));
                return iRet = INT_ERR;
	}
DEBUGLOG(("BOReserve::HandleReserveAmount() return amount_id = [%i]\n",iAmtId));
	
	if(iAmtId<0){

		PutField_Char(hContext,"type",PD_PRECENT_WITH_FIX);
		PutField_Double(hContext,"add_value",0.0);
		PutField_CString(hContext,"desc","Reserve Amount Rule.\0");
		PutField_Int(hContext,"disabled", PD_FALSE);
		PutField_Double(hContext,"min_value",0.0);
		PutField_Double(hContext,"max_value",0.0);

		/* Add DBRuleAmount & DBRuleTxnRes*/
DEBUGLOG(("BOReserve::HandleReserveAmount() Call DBRuleAmount Add\n"));
		DBObjPtr = CreateObj(DBPtr,"DBRuleAmount","Add");
        	if ((*DBObjPtr)(hContext,
                        	&iAmtId) != PD_OK) {
DEBUGLOG(("BOReserve::HandleReserveAmount() Call DBRuleAmount Add failed!!!\n"));
                	return iRet = INT_ERR;
		}else{

			PutField_Int(hContext,"amount_id",iAmtId);

DEBUGLOG(("BOReserve::HandleReserveAmount() return amount_id = [%i]\n",iAmtId));
DEBUGLOG(("BOReserve::HandleReserveAmount() Call DBRuleTxnRes Add\n"));
			DBObjPtr = CreateObj(DBPtr,"DBRuleTxnRes","Add");
        		if ((*DBObjPtr)(hContext) != PD_OK) {
DEBUGLOG(("BOReserve::HandleReserveAmount() Call DBRuleTxnRes Add failed!!!\n"));
                		return iRet = INT_ERR;
			}
		}
	}else{

		/* Update DBRuleAmount */
		PutField_Int(hContext,"id",iAmtId);
		PutField_Int(hContext,"amount_id",iAmtId);
DEBUGLOG(("BOReserve::HandleReserveAmount() Call DBRuleAmount Update\n"));
		DBObjPtr = CreateObj(DBPtr,"DBRuleAmount","Update");
        	if ((*DBObjPtr)(hContext) != PD_OK) {
DEBUGLOG(("BOReserve::HandleReserveAmount() Call DBRuleAmount Update failed!!!\n"));
                	return iRet = INT_ERR;
		}else {

DEBUGLOG(("BOReserve::HandleReserveAmount() Call DBRuleTxnRes Update\n"));
			DBObjPtr = CreateObj(DBPtr,"DBRuleTxnRes","Update");
        		if ((*DBObjPtr)(hContext) != PD_OK) {
DEBUGLOG(("BOReserve::HandleReserveAmount() Call DBRuleTxnRes Update failed!!!\n"));
                		return iRet = INT_ERR;
			}

		}
	}

DEBUGLOG(("BOReserve::HandleReserveAmount() exit ok\n"));
	return iRet = PD_OK;
}
