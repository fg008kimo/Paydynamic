/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/01/04              Cody Chan
Add Override value ratio and Priority from pool    2012/02/01		   Cody Chan
Mapping
CheckScheduler more than one rule		   2012/02/13		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOTxnLb.h"

char    cDebug;

OBJPTR(DB);
OBJPTR(BO);
void BOTxnLb(char    cdebug)
{
        cDebug = cdebug;
}

int CheckAmountTier(double dMinTxnAmt, double dMaxTxnAmt, double dTxnAmt);
int CheckScheduler(int iId,const char* csDateTime);
int GetPool(int iId,recordset_t* rRs);
int CheckPools(double dTxnAmt,
		const char* csServiceCode,
                const char* csTxnCountry,
                const char* csTxnCcy,
                const char* csPayMethod,
		const char* csBankCode,
		hash_t*	hPsp,
		recordset_t *,
		char*);
int CheckPoolLimit(int iId,
		const char* csServiceCode,
		const char* csTxnCountry,
		const char* csTxnCcy,
		const char* csPayMethod,
		double	dTxnAmt,
		double dLimit,
		double *dCurr,
		double *dTotalCurr,
		double *dReqCurr,
		double *dTotalReqCurr);
int PickPsp(int iId,
		const char* csPayMethod,
		const char* csServiceCode,
		const char* csTxnCountry,
		const char* csTxnCcy,
		char*	csSelectedPspId);
int CheckPspLimit(const char* csId,
		const char* csServiceCode,
		const char* csTxnCountry,
		const char* csTxnCcy,
		const char* csPayMethod,
		double dLimit,
		double *dCurr,
		double *dTotalCurr,
		double *dReqCurr,
		double *dTotalReqCurr);

int GetTxnPsp(hash_t *hContext,
                const hash_t* hRequest)
{
	int	iRet = PD_OK;
	char	*csPtr;
	char	cPtr;
	char	*csServiceCode;
	char	*csTxnCountry;
	char	*csTxnCcy;
	char	*csPayMethod;
	char	*csOrgDateTime;
	char	*csBankCode;
	char	csSelectedPspId[PD_PSP_ID_LEN +1];
	double	dTxnAmt = 0.0;
	
	hash_t	*hReq;
	hash_t	*hPsp;
	recordset_t     *rRecordSet;
	recordset_t     *rRs;


DEBUGLOG(("GetTxnPsp()\n"));
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
       	recordset_init(rRecordSet,0);	

	rRs = (recordset_t*) malloc (sizeof(recordset_t));
       	recordset_init(rRs,0);	
 
	hReq = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hReq,0);

	hPsp = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hPsp,0);

/* channel Code */
	if (GetField_CString(hContext,"channel_code",&csPtr)) {
DEBUGLOG(("GetTxnPsp() Channel Code = [%s]\n",csPtr));
		PutField_CString(hReq,"channel_code",csPtr);
	}
	else {
DEBUGLOG(("GetTxnPsp() channel Code is missing!!!\n"));
ERRLOG("BOTxnLb::GetTxnPsp() channel Code is missing!!!\n");
		iRet = PD_ERR;
	}

/* service code  */
	if (GetField_CString(hRequest,"service_code",&csServiceCode)) {
DEBUGLOG(("GetTxnPsp() service_code = [%s]\n",csServiceCode));
		PutField_CString(hReq,"service_code",csServiceCode);
	}
	else if (GetField_CString(hContext,"org_service_code",&csServiceCode)) {
DEBUGLOG(("GetTxnPsp() service_code = [%s]\n",csServiceCode));
		PutField_CString(hReq,"service_code",csServiceCode);
	}
	else {
DEBUGLOG(("GetTxnPsp() service_code is missing!!!\n"));
ERRLOG("BOTxnLb::GetTxnPsp() service_code is missing!!!\n");
		iRet = PD_ERR;
	}

/* payment_method  */
	if (GetField_CString(hContext,"selected_pay_method",&csPayMethod)) {
DEBUGLOG(("GetTxnPsp() selected_pay_method  = [%s]\n",csPayMethod));
		PutField_CString(hReq,"pay_method",csPayMethod);
	}
	else {
DEBUGLOG(("GetTxnPsp() selected_pay_method  is missing!!!\n"));
ERRLOG("BOTxnLb::GetTxnPsp() selected_pay_method  is missing!!!\n");
		iRet = PD_ERR;
	}

/* txn_country  */
	if (GetField_CString(hRequest,"txn_country",&csTxnCountry)) {
DEBUGLOG(("GetTxnPsp() txn_country  = [%s]\n",csTxnCountry));
		PutField_CString(hReq,"txn_country",csTxnCountry);
	}
	else if (GetField_CString(hContext,"org_txn_country",&csTxnCountry)) {
DEBUGLOG(("GetTxnPsp() txn_country  = [%s]\n",csTxnCountry));
		PutField_CString(hReq,"txn_country",csTxnCountry);
	}
	else {
DEBUGLOG(("GetTxnPsp() txn_country  is missing!!!\n"));
ERRLOG("BOTxnLb::GetTxnPsp() txn_country  is missing!!!\n");
		iRet = PD_ERR;
	}

/* txn_ccy  */
	if (GetField_CString(hRequest,"txn_ccy",&csTxnCcy)) {
DEBUGLOG(("GetTxnPsp() txn_ccy  = [%s]\n",csTxnCcy));
		PutField_CString(hReq,"txn_ccy",csTxnCcy);
	}
	else if (GetField_CString(hContext,"org_txn_ccy",&csTxnCcy)) {
DEBUGLOG(("GetTxnPsp() txn_ccy  = [%s]\n",csTxnCcy));
		PutField_CString(hReq,"txn_ccy",csTxnCcy);
	}
	else {
DEBUGLOG(("GetTxnPsp() txn_ccy  is missing!!!\n"));
ERRLOG("BOTxnLb::GetTxnPsp() txn_ccy  is missing!!!\n");
		iRet = PD_ERR;
	}

/* merchant_id  */
	if (GetField_CString(hRequest,"merchant_id",&csPtr)) {
DEBUGLOG(("GetTxnPsp() merchant_id  = [%s]\n",csPtr));
		PutField_CString(hReq,"merchant_id",csPtr);
	}
	else if (GetField_CString(hContext,"org_merchant_id",&csPtr)) {
DEBUGLOG(("GetTxnPsp() merchant_id  = [%s]\n",csPtr));
		PutField_CString(hReq,"merchant_id",csPtr);
	}
	else {
DEBUGLOG(("GetTxnPsp() merchant_id  is missing!!!\n"));
ERRLOG("BOTxnLb::GetTxnPsp() merchant_id  is missing!!!\n");
		iRet = PD_ERR;
	}

/* merchant_clinet_id  */
	if (GetField_CString(hRequest,"client_id",&csPtr)) {
DEBUGLOG(("GetTxnPsp() client_id  = [%s]\n",csPtr));
		PutField_CString(hReq,"client_id",csPtr);
	}
	else if (GetField_CString(hContext,"org_client_id",&csPtr)) {
DEBUGLOG(("GetTxnPsp() client_id  = [%s]\n",csPtr));
		PutField_CString(hReq,"client_id",csPtr);
	}
	else {
DEBUGLOG(("GetTxnPsp() merchant_client_id  is missing!!!\n"));
ERRLOG("BOTxnLb::GetTxnPsp() merchant_client_id  is missing!!!\n");
		iRet = PD_ERR;
	}

/* business_type */
	if (GetField_Char(hContext,"org_merchant_type",&cPtr)) {
DEBUGLOG(("GetTxnPsp() merchant_type  = [%c]\n",cPtr));
		PutField_Char(hReq,"business_type",cPtr);
	}
	else {
DEBUGLOG(("GetTxnPsp() merchant_type  is missing!!!\n"));
ERRLOG("BOTxnLb::GetTxnPsp() merchant_type  is missing!!!\n");
		iRet = PD_ERR;
	}

/* txn_amt */
	if (GetField_Double(hRequest,"txn_amt",&dTxnAmt)) {
DEBUGLOG(("GetTxnPsp() txn_amt  = [%f]\n",dTxnAmt));
	}
	else if (GetField_Double(hContext,"org_txn_amt",&dTxnAmt)) {
DEBUGLOG(("GetTxnPsp() txn_amt  = [%f]\n",dTxnAmt));
	}
	else {
DEBUGLOG(("GetTxnPsp() txn_amt  is missing!!!\n"));
ERRLOG("BOTxnLb::GetTxnPsp() txn_amt  is missing!!!\n");
		iRet = PD_ERR;
	}
/* org_local_tm_datetime  */
	if (GetField_CString(hContext,"org_local_tm_datetime",&csOrgDateTime)) {
DEBUGLOG(("GetTxnPsp() org_local_tm_datetime  = [%s]\n",csOrgDateTime));
	}
	else {
DEBUGLOG(("GetTxnPsp() org_local_tm_datetime  is missing!!!\n"));
ERRLOG("BOTxnLb::GetTxnPsp() org_local_tm_datetime  is missing!!!\n");
		iRet = PD_ERR;
	}

/* bank_code  */
	if (GetField_CString(hRequest,"bank_code",&csBankCode)) {
DEBUGLOG(("GetTxnPsp() bank_code  = [%s]\n",csBankCode));
	}
	else {
DEBUGLOG(("GetTxnPsp() bank_code  is missing!!!\n"));
ERRLOG("BOTxnLB::GetTxnPsp() bank_code  is missing!!!\n");
		iRet = PD_ERR;
	}

/* check availbe psp first */
	BOObjPtr = CreateObj(BOPtr,"BOBank","GetAvailablePspByBank");
        if ((unsigned long)(*BOObjPtr)(csBankCode,csTxnCountry,csOrgDateTime,hPsp) == PD_OK) {
                int     iPtr = 0;
                if (GetField_Int(hPsp,"psp_id_cnt",&iPtr)) {
DEBUGLOG(("CheckPools psp id cnt = [%d]\n",iPtr));
                }
                if (iPtr == 0 ) {
DEBUGLOG(("Check Pools no aval psp for this bank [%s]\n",csBankCode));
                        iRet = INT_PSP_NOT_AVABILE;
                }
        }
        else {
DEBUGLOG(("Check Pools no aval psp for this bank [%s]\n",csBankCode));
                iRet = INT_PSP_NOT_AVABILE;
        }

	if (iRet == PD_OK) {
		//int	iTxnAmountTierId = 0;
		int	iCriteriaPoolId = 0;
		int	iSchedulerId = 0;
		int	iCnt = 0;
		int	iGcnt = 0;

		double	dMinTxnAmt = 0.0;
		double	dMaxTxnAmt = 0.0;

		hash_t	*hRec;
		DBObjPtr = CreateObj(DBPtr,"DBRuleLB","MatchCriteria");	
		if ((unsigned long)(*DBObjPtr)(hReq,rRecordSet) == PD_FOUND) {
			hRec = RecordSet_GetFirst(rRecordSet);
                	while (hRec) {
/*txn amount tier */
/*
				if (GetField_Int(hRec,"amount_tier_id",&iTxnAmountTierId)) {
DEBUGLOG(("GetTxnPsp() [%02d] amount_tier_id = [%d]\n",iCnt,iTxnAmountTierId));
				}
*/

				if (GetField_Double(hRec, "min_txn_amount", &dMinTxnAmt)) {
DEBUGLOG(("GetTxnPsp() [%02d] min_txn_amount = [%lf]\n",iCnt,dMinTxnAmt));
				}

				if (GetField_Double(hRec, "max_txn_amount", &dMaxTxnAmt)) {
DEBUGLOG(("GetTxnPsp() [%02d] max_txn_amount = [%lf]\n",iCnt,dMaxTxnAmt));
				}

/*criteria_pool id */
				if (GetField_Int(hRec,"criteria_pool_id",&iCriteriaPoolId)) {
DEBUGLOG(("GetTxnPsp() [%02d] criteria_pool_id = [%d]\n",iCnt,iCriteriaPoolId));
				}
/*scheduler id */
				if (GetField_Int(hRec,"scheduler_id",&iSchedulerId)) {
DEBUGLOG(("GetTxnPsp() [%02d] scheduler_id = [%d]\n",iCnt,iSchedulerId));
				}

				//if (CheckAmountTier(iTxnAmountTierId,dTxnAmt) == PD_OK)  
				if (CheckAmountTier(dMinTxnAmt, dMaxTxnAmt, dTxnAmt) == PD_OK)  
				{
DEBUGLOG(("GEtTxnPsp() [%02d] passed CheckAmount Tier\n",iCnt));
					if (CheckScheduler(iSchedulerId,csOrgDateTime) == PD_OK)  {
DEBUGLOG(("GEtTxnPsp() [%02d] this looks good\n",iCnt));
						iGcnt++;
						RecordSet_Add(rRs,hRec);
					}
					else {
DEBUGLOG(("GEtTxnPsp() [%02d] failed CheckScheduler Tier\n",iCnt));
					}
				}
				else {
DEBUGLOG(("GEtTxnPsp() [%02d] failed CheckAmount Tier\n",iCnt));
				}

				hRec = RecordSet_GetNext(rRecordSet);
				iCnt++;
			}
		}

		if (iGcnt == 0) {
DEBUGLOG(("BOTxnLb:GetTxnPsp LoadBalancer could not find any rule!!!\n"));
ERRLOG("FATAL ERROR:BOTxnLb:GetTxnPsp LoadBalancer could not find any rule!!!\n");
			iRet = INT_NO_LB_RECORD;
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("GetTxnPsp next level\n"));
		int iCnt = 0;
		int iCriteriaPoolId;
		hash_t	*hRec;

		recordset_t	*rPools;

		rPools = (recordset_t*) malloc (sizeof(recordset_t));
        	recordset_init(rPools,0);

		hRec = RecordSet_GetFirst(rRs);
                while (hRec) {
			if (GetField_Int(hRec,"criteria_pool_id",&iCriteriaPoolId)) {
DEBUGLOG(("GetTxnPsp() [%02d] criteria_pool_id = [%d]\n",iCnt,iCriteriaPoolId));
				iRet =  GetPool(iCriteriaPoolId,rPools);
			}
			hRec = RecordSet_GetNext(rRs);
		}
		iRet = CheckPools(dTxnAmt,
				csServiceCode,
                		csTxnCountry,
                		csTxnCcy,
                		csPayMethod,
				csBankCode,
				hPsp,
				rPools,
				csSelectedPspId);
		RecordSet_Destroy(rPools);
       		FREE_ME(rPools);
		if (iRet == PD_OK) {
DEBUGLOG(("GetTxnPsp PSP ID [%s] will be appiled for this txn\n",csSelectedPspId));
			PutField_CString(hContext,"psp_id",csSelectedPspId);
		}
	}

	hash_destroy(hPsp);
        FREE_ME(hPsp);

	hash_destroy(hReq);
        FREE_ME(hReq);

	RecordSet_Destroy(rRs);
       	FREE_ME(rRs);

	RecordSet_Destroy(rRecordSet);
       	FREE_ME(rRecordSet);
DEBUGLOG(("GetTxnPsp() exit iRet = [%d]\n",iRet));
	return iRet;
}

int CheckAmountTier(double dMinTxnAmt, double dMaxTxnAmt, double dTxnAmt)
{
        int             iRet = PD_ERR;

        //double  dMaxVal = 0;
        //double  dMinVal = 0;
        //char    *csDesc;

DEBUGLOG(("CheckAmountTier()\n"));
DEBUGLOG(("CheckAmountTier() min_txn_amt = [%lf] max_txn_amt = [%lf] and Txn Amt = [%f]\n",dMinTxnAmt, dMaxTxnAmt, dTxnAmt));

	if (dTxnAmt > dMinTxnAmt && (dTxnAmt <= dMaxTxnAmt || dMaxTxnAmt == 0.0)) { 
DEBUGLOG(("CheckAmountTier() min_txn_amt [%lf] max_txn_amt [%lf]  will be applied\n",dMinTxnAmt, dMaxTxnAmt ));
                        iRet = PD_OK;
        }
	else {
DEBUGLOG(("CheckAmountTier() min_txn_amt [%lf] max_txn_amt [%lf] will be filter out!!!\n",dMinTxnAmt, dMaxTxnAmt));
        }

DEBUGLOG(("CheckAmountTier exit iRet = [%d]\n",iRet));
        return  iRet;
}


int CheckScheduler(int iId,const char* csTxnDateTime)
{
	int	iRet = PD_ERR;
	recordset_t     *rRecordSet;
	hash_t	*hRec;
	char	cMode;
	char	*csStartDateTime;
	char	*csEndDateTime;
	char	*csStartTime;
	char	*csEndTime;
	char	csTime[PD_TIME_LEN +1];
	int	iDayOfWeek;
	int	iDay;
DEBUGLOG(("CheckSchedulerId()\n"));
DEBUGLOG(("CheckSchedulerId() id = [%d] txn datetime = [%s]\n",iId,csTxnDateTime));
	iDayOfWeek = day_of_week((const unsigned char*)csTxnDateTime);
	memcpy(csTime,&csTxnDateTime[PD_DATE_LEN],PD_TIME_LEN);
	csTime[PD_TIME_LEN] = '\0';
DEBUGLOG(("CheckSchedulerId() txn datetime = [%s] txn time = [%s]\n",csTxnDateTime,csTime));
	

DEBUGLOG(("CheckSchedulerId() day of week = [%d]\n",iDayOfWeek));

	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	DBObjPtr = CreateObj(DBPtr,"DBRuleSchedulerHeader","GetIdDetail");	
	if ((unsigned long)(*DBObjPtr)(iId,rRecordSet) == PD_FOUND) {
		iRet = PD_ERR;
		hRec = RecordSet_GetFirst(rRecordSet);
		while(hRec && (iRet==PD_ERR)){
			if (GetField_Char(hRec,"schedule_mode",&cMode)) {
DEBUGLOG(("CheckSchedulerId() schedule_mode = [%c]\n",cMode));
			}
			if (cMode == PD_SCHEDULER_ONCE || cMode == PD_SCHEDULER_MIX ) {
				if (GetField_CString(hRec,"start_datetime",&csStartDateTime)) {
DEBUGLOG(("CheckSchedulerId() start_datetime = [%s]\n",csStartDateTime));
					if (memcmp(csTxnDateTime,csStartDateTime,PD_DATETIME_LEN) >= 0) {
						if (GetField_CString(hRec,"end_datetime",&csEndDateTime)) {
DEBUGLOG(("CheckSchedulerId() end_datetime = [%s]\n",csEndDateTime));
							if (memcmp(csTxnDateTime,csEndDateTime,PD_DATETIME_LEN) > 0) {
DEBUGLOG(("CheckSchedulerId() id [%d] [%s] had expired\n",iId,csEndDateTime));
								iRet = PD_ERR;
							}
							else
								iRet = PD_OK;
						}
						else
							iRet = PD_OK;
					}
					else {
DEBUGLOG(("CheckSchedulerId() id [%d] [%s] not yet in range\n",iId,csStartDateTime));
						iRet = PD_ERR;
					}
				}
			}

			if (cMode == PD_SCHEDULER_RECURR && iRet == PD_ERR) {
				if (GetField_Int(hRec,"day",&iDay)) {
DEBUGLOG(("CheckSchedulerId() iDay = [%d]\n",iDay));
					if (iDay != 7 && iDay != iDayOfWeek)  {
						iRet = PD_ERR;
DEBUGLOG(("CheckSchedulerId() not today!!!\n"));
					}
					else {
						if (GetField_CString(hRec,"start_time",&csStartTime)) {
DEBUGLOG(("CheckSchedulerId() start_time = [%s]\n",csStartTime));
                                			if (memcmp(csTime,csStartTime,PD_TIME_LEN) >= 0) {
                                        			if (GetField_CString(hRec,"end_time",&csEndTime)) {
DEBUGLOG(("CheckSchedulerId() end_datetime = [%s]\n",csEndTime));
                                                			if (memcmp(csTime,csEndTime,PD_TIME_LEN) > 0) {
DEBUGLOG(("CheckSchedulerId() id [%d] [%s] had expired\n",iId,csEndTime));
                                                        			iRet = PD_ERR;
                                                			}
									else
										iRet=PD_OK;
                                        			}
								else
									iRet=PD_OK;
                                			}
                                			else {
DEBUGLOG(("CheckSchedulerId() id [%d] [%s] not yet in range\n",iId,csStartDateTime));
                                        			iRet = PD_ERR;
                                			}
						}
					}
				}
				else {
DEBUGLOG(("CheckSchedulerId() can't get day tag!!!\n"));
					iRet = PD_ERR;
				}
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}//end while
	}

	RecordSet_Destroy(rRecordSet);
       	FREE_ME(rRecordSet);
DEBUGLOG(("CheckSchedulerId exit iRet = [%d]\n",iRet));
	return	iRet;
}
int GetPool(int iId,recordset_t* rRs)
{
	int	iRet = PD_OK;
	char	*csPtr;
	double 	dPtr;
	int	iPtr;

	hash_t	*hRec;
        recordset_t     *rRecordSet;

	hash_t	*hRsp;

DEBUGLOG(("GetPool()\n"));
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	DBObjPtr = CreateObj(DBPtr,"DBRulePspLbPools","GetDetailById");	
	if ((unsigned long)(*DBObjPtr)(iId,rRecordSet) == PD_FOUND) {
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			hRsp = (hash_t*) malloc (sizeof(hash_t));
			hash_init(hRsp,0);
/* pool_id */
			if (GetField_Int(hRec,"pool_id",&iPtr)) {
//DEBUGLOG(("GetPool() pool_id = [%d]\n",iPtr));
				PutField_Int(hRsp,"pool_id",iPtr);
			}
/* desc */
			if (GetField_CString(hRec,"desc",&csPtr)) {
//DEBUGLOG(("GetPool() desc = [%s]\n",csPtr));
				PutField_CString(hRsp,"desc",csPtr);
			}

/* pool limit */
			if (GetField_Double(hRec,"pool_limit",&dPtr)) {
//DEBUGLOG(("GetPool() pool limt = [%f]\n",dPtr));
				PutField_Double(hRsp,"pool_limit",dPtr);
			}
/* ratio */
			if (GetField_Int(hRec,"ratio",&iPtr)) {
//DEBUGLOG(("GetPool() ratio = [%d]\n",iPtr));
				PutField_Int(hRsp,"ratio",iPtr);
			}
/* priority */
			if (GetField_Int(hRec,"priority",&iPtr)) {
//DEBUGLOG(("GetPool() priority = [%d]\n",iPtr));
				PutField_Int(hRsp,"priority",iPtr);
			}

			RecordSet_Add(rRs,hRsp);
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}

	RecordSet_Destroy(rRecordSet);
       	FREE_ME(rRecordSet);

DEBUGLOG(("GetPool() exit iRet = [%d]\n",iRet));
	return	iRet;
}
	
int CheckPools(double dTxnAmt,
		const char* csServiceCode,
                const char* csTxnCountry,
                const char* csTxnCcy,
                const char* csPayMethod,
		const char* csBankCode,
		hash_t*	hPsp,
		recordset_t *rRs,
		char*	csSelectedPspId)
{
	int	iRet = PD_OK;
	hash_t	*hCurrPool;
	hash_t	*hRec;
	double	dPoolLimit = 0.0;

	double	dCurr = 0.0;
	double	dTotalCurr = 0.0;
	double	dReqCurr = 0.0;
	double	dTotalReqCurr = 0.0;

	int	iPoolId;
	int	iTotalRatio = 0;
	double	dTotalVol = 0.0;
	int	iRatio;
	int	iPriority;
	
	recordset_t     *rPools;

        rPools = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rPools,0);


DEBUGLOG(("CheckPools()\n"));
	hCurrPool = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hCurrPool,0);


	hRec = RecordSet_GetFirst(rRs);

        rPools = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rPools,0);

	while (hRec) {
		dPoolLimit  = 0.0;
		dCurr  = 0.0;
		dReqCurr  = 0.0;
		iRatio = 0;
		iPriority = 0;

		if (GetField_Int(hRec,"pool_id",&iPoolId)) {
DEBUGLOG(("CheckPools pool id = [%d]\n",iPoolId));
		}
		else {
DEBUGLOG(("CheckPools pool id is missing!!!\n"));
		}
		
/* check if any ava psp in this pool */
		DBObjPtr = CreateObj(DBPtr,"DBRuleLB","FindAvalPspForPool");      
        	if ((unsigned long)(*DBObjPtr)(iPoolId,hPsp) != PD_OK) {
DEBUGLOG(("CheckPools can't find any aval psp for this pool [%d]\n",iPoolId));
			iRet = INT_PSP_NOT_AVABILE;
		}
		else {
/* check psp with schudler */
		}	
		

		if (iRet == PD_OK) {
/* check if its psp still has quota */
			if (GetField_Double(hRec,"pool_limit",&dPoolLimit)) {
DEBUGLOG(("CheckPools pool limit = [%f] for pool [%d]\n",dPoolLimit,iPoolId));
			}
			DBObjPtr = CreateObj(DBPtr,"DBRuleLB","FindAvalPsp");      
        		if ((unsigned long)(*DBObjPtr)(iPoolId,csServiceCode,csTxnCountry,dTxnAmt) != PD_OK) {
DEBUGLOG(("CheckPools none of aval psp for this pool [%d] has quota to handle txn amt [%f]\n",iPoolId,dTxnAmt));
				iRet = INT_PSP_NOT_AVABILE;
			}
		}



		if (iRet == PD_OK ) {
			if (GetField_Int(hRec,"ratio",&iRatio)) {
DEBUGLOG(("CheckPools ratio = [%d]\n",iRatio));
			}

			if (GetField_Int(hRec,"priority",&iPriority)) {
DEBUGLOG(("CheckPools priority = [%d]\n",iPriority));
			}

/*
DEBUGLOG(("CheckPools ------------------------------------------\n"));
DEBUGLOG(("CheckPools ServiceCode = [%s]\n",csServiceCode));
DEBUGLOG(("CheckPools TxnCountry = [%s]\n",csTxnCountry));
DEBUGLOG(("CheckPools TxnCcy = [%s]\n",csTxnCcy));
DEBUGLOG(("CheckPools PayMethod = [%s]\n",csPayMethod));
DEBUGLOG(("CheckPools ------------------------------------------\n"));
*/
			if (dPoolLimit != 0.0 ) {
DEBUGLOG(("CheckPools call checkpoolimit\n"));
				iRet = CheckPoolLimit(iPoolId,
       	        					csServiceCode,
       	        					csTxnCountry,
       	        					csTxnCcy,
       	        					csPayMethod,
							dTxnAmt,
       	        					dPoolLimit,
							&dCurr,
							&dTotalCurr,
							&dReqCurr,
							&dTotalReqCurr);
			}
			else {
/* Get Curr Pool Hit */
				DBObjPtr = CreateObj(DBPtr,"DBRulePspLbPools","GetPspPoolsTotal");      
       		 		iRet = (unsigned long)(*DBObjPtr)(iPoolId,csServiceCode,csTxnCountry,csTxnCcy,csPayMethod,&dCurr,&dTotalCurr,&dReqCurr,&dTotalReqCurr);
DEBUGLOG(("CheckPools iRet = [%d] from GetPspPoolsTotal\n",iRet));
			}
			if (iRet == PD_OK) {
/* check aval psp limit under this pool */
			}

			if (iRet == PD_OK) {
DEBUGLOG(("CheckPools pool id [%d] is good Pool Curr = [%f] Req Curr = [%f]\n",iPoolId,dCurr,dReqCurr));
				RecordSet_Add(rPools,hRec);	
				PutField_Double(hRec,"pool_curr",dCurr);
				PutField_Double(hRec,"pool_req_curr",dReqCurr);
			}
		}
		iTotalRatio += iRatio;
//		dTotalVol += dCurr; /* approval amount */
		dTotalVol += dReqCurr; /* request txn amount */
DEBUGLOG(("CheckPools total ratio now =  [%d] total Vol = [%lf]\n",iTotalRatio,dTotalVol));
		hRec = RecordSet_GetNext(rRs);
	}

	if (iTotalRatio > 0) {
DEBUGLOG(("CheckPools ------------let see which pool will fit\n"));
		int    	iFinalPoolId;
	        int    	iFinalPriority = 0;	
		int	iCnt=0;
		double 	dFinalVolRatio = 0;
		double 	dFinalPoolRatio = 0;
		double 	dTmpVolRatio = 0.0;
		double 	dPoolRatio = 0.0;
		hRec = RecordSet_GetFirst(rPools);
		while (hRec) {
			if (GetField_Int(hRec,"pool_id",&iPoolId)) {
DEBUGLOG(("CheckPools ------------pool id = [%d]\n",iPoolId));
			}
			if (GetField_Double(hRec,"pool_limit",&dPoolLimit)) {
DEBUGLOG(("CheckPools ------------pool limit = [%f] for pool [%d]\n",dPoolLimit,iPoolId));
			}

			if (GetField_Int(hRec,"ratio",&iRatio)) {
DEBUGLOG(("CheckPools ------------ratio = [%d]\n",iRatio));
                	}

                	if (GetField_Int(hRec,"priority",&iPriority)) {
DEBUGLOG(("CheckPools ------------priority = [%d]\n",iPriority));
                	}

                	if (GetField_Double(hRec,"pool_curr",&dCurr)) {
DEBUGLOG(("CheckPools ------------pool_curr = [%f]\n",dCurr));
                	}

                	if (GetField_Double(hRec,"pool_req_curr",&dReqCurr)) {
DEBUGLOG(("CheckPools ------------pool_req_curr = [%f]\n",dReqCurr));
                	}

			if (iRatio > 0 ) {
				dPoolRatio = (double)iRatio/(double)iTotalRatio;
DEBUGLOG(("CheckPools ------------Pool Ratio = [%f]\n",dPoolRatio));

				if (dCurr == 0.0 ) 
					dTmpVolRatio = 0.0;
				else 
					dTmpVolRatio = dReqCurr/dTotalVol; /* request amount */
			//		dTmpVolRatio = dCurr/dTotalVol; /* approval amount */

//DEBUGLOG(("CheckPools ------------tmp vol ratio = [%f] = [%f / [%f]\n",dTmpVolRatio,dCurr,dTotalVol));
DEBUGLOG(("CheckPools ------------tmp vol ratio = [%f] = [%f / [%f]\n",dTmpVolRatio,dReqCurr,dTotalVol));

				if (iCnt == 0) {
					iFinalPoolId = iPoolId;
					iFinalPriority = iPriority;
					dFinalVolRatio = dTmpVolRatio;
					dFinalPoolRatio = dPoolRatio;
				}
				iCnt++;
/* if the pool was never hit */
				//if (dCurr == 0.0 ) {
				if (dReqCurr == 0.0 ) {
DEBUGLOG(("dReqCurr == 0.0\n"));
				/* if both pools are never hit */
					if (dFinalVolRatio == 0.0) {
DEBUGLOG(("FinalVolRatio == 0.0\n"));
						if (iPriority > iFinalPriority)  {
							iFinalPoolId = iPoolId;
							iFinalPriority = iPriority;
							dFinalVolRatio = 0.0;
							dFinalPoolRatio = dPoolRatio;
						}
					}
				/* take the lowest */
					else {
						iFinalPoolId = iPoolId;
						iFinalPriority = iPriority;
						dFinalVolRatio = 0.0;
						dFinalPoolRatio = dPoolRatio;
					}
				}
/* if exceed the current ratio */
				else if ( dTmpVolRatio <= dFinalVolRatio) {
DEBUGLOG(("CheckPools TmpVolRatio [%f] <= FinalVolRatio [%f]\n",dTmpVolRatio,dFinalVolRatio));
					if (dFinalPoolRatio < dFinalVolRatio  || iPriority > iFinalPriority) {
DEBUGLOG(("CheckPools it has higher Priority or previous pool has reach its ratio\n"));
DEBUGLOG(("CheckPools  FinalPoolRatio [%f] < FinalVolRaio [%f] || Priority[%d] > FinalPriority[%d]\n",dFinalPoolRatio,dFinalVolRatio,iPriority,iFinalPriority));
						iFinalPoolId = iPoolId;
						iFinalPriority = iPriority;
						dFinalVolRatio = dTmpVolRatio;
						dFinalPoolRatio = dPoolRatio;
					}
				}
			}
DEBUGLOG(("CheckPools ++ pool id [%d] Priority [%d] Vol Ratio [%f] Pool Ratio [%f]\n",iFinalPoolId,iFinalPriority,dFinalVolRatio,dFinalPoolRatio));
			hRec = RecordSet_GetNext(rPools);
		}
DEBUGLOG(("CheckPools +++ call PickPsp\n"));
		iRet = PickPsp(iFinalPoolId,csPayMethod,csServiceCode,csTxnCountry,csTxnCcy,csSelectedPspId);
	}
	else {
DEBUGLOG(("CheckPools no pool will fit .....\n"));
ERRLOG("FATAL ERROR BOTxnLb: CheckPools no pool will fit .....\n");
		iRet = INT_EXCEED_LIMIT_PSP_AMT;
	}


	hash_destroy(hCurrPool);
        FREE_ME(hCurrPool);


	RecordSet_Destroy(rPools);
       	FREE_ME(rPools);
DEBUGLOG(("CheckPools() exit iRet = [%d]\n",iRet));
	return	iRet;
}

int CheckPoolLimit(int iId,
		const char* csServiceCode,
		const char* csTxnCountry,
		const char* csTxnCcy,
		const char* csPayMethod,
		double dTxnAmt,
		double dLimit,
		double *dPoolCurr,
		double *dTotalPoolCurr,
		double *dPoolReqCurr,
		double *dTotalPoolReqCurr)
{
	int iRet = PD_ERR;
DEBUGLOG(("CheckPoolLimit()\n"));

/*
DEBUGLOG(("CheckPoolLimit ------------------------------------------\n"));
DEBUGLOG(("CheckPoolLimits ServiceCode = [%s]\n",csServiceCode));
DEBUGLOG(("CheckPoolLimits TxnCountry = [%s]\n",csTxnCountry));
DEBUGLOG(("CheckPoolLimits TxnCcy = [%s]\n",csTxnCcy));
DEBUGLOG(("CheckPoolLimits PayMethod = [%s]\n",csPayMethod));
DEBUGLOG(("CheckPoolLimits ------------------------------------------\n"));
*/
	DBObjPtr = CreateObj(DBPtr,"DBRulePspLbPools","GetPspPoolsTotal");	
	iRet = (unsigned long)(*DBObjPtr)(iId,csServiceCode,csTxnCountry,csTxnCcy,csPayMethod,dPoolCurr,dTotalPoolCurr,&dPoolReqCurr,&dTotalPoolReqCurr);

	if (iRet == PD_OK) {
DEBUGLOG(("Rule limit = [%f] current hit = [%f]\n",dLimit,*dPoolCurr));

		if (*dTotalPoolCurr == 0.0) {
DEBUGLOG(("CheckPoolLimit() Not Yet Exceed Limit since no txn had been made for this pool [%d]+++\n",iId));
		}
		else if (*dTotalPoolCurr + dTxnAmt > dLimit) {
DEBUGLOG(("CheckPoolLimit() Exceed Limit [%f + %f] > [%f]*****\n",*dTotalPoolCurr,dTxnAmt,dLimit));
			iRet = INT_EXCEED_LIMIT_PSP_AMT;
		}
		else {
DEBUGLOG(("CheckPoolLimit() Not Yet Exceed Limit (%f + %f <= %f+++\n",*dTotalPoolCurr,dTxnAmt,dLimit));
		}
	}
DEBUGLOG(("CheckPoolLimit() exit iRet = [%d]\n",iRet));
	return iRet;
}
	
int PickPsp(int iId,
		const char* csPayMethod,
		const char* csServiceCode,
		const char* csTxnCountry,
		const char* csTxnCcy,
		char*	csSelectedPspId)
{
	int	iRet = PD_OK;
	char	*csPspId;
	double	dLimit;
	double	dPspCurr;
	double	dTotalPspCurr;
	double	dPspReqCurr;
	double	dTotalPspReqCurr;
	double	dTotalVol = 0.0;
	int	iTotalRatio = 0;
	int	iRatio;

	recordset_t     *rPsp,*rAvalPsp;
	hash_t		*hRec;


DEBUGLOG(("PickPsp()\n"));
DEBUGLOG(("PickPsp() Pool id = [%d] country = [%s] pay method = [%s] service code = [%s]\n",iId,csTxnCountry,csPayMethod,csServiceCode));
        rPsp = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rPsp,0);

        rAvalPsp = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rAvalPsp,0);

	DBObjPtr = CreateObj(DBPtr,"DBRuleLB","GetAvalPspsByPool");	
	if ((*DBObjPtr)(iId,csPayMethod,csServiceCode,csTxnCountry,rPsp) == PD_OK) {
		hRec = RecordSet_GetFirst(rPsp);
		while(hRec) {
			iRatio = 0.0;
			dLimit = 0.0;
			dPspCurr = 0.0;
			dTotalPspCurr = 0.0;
			dPspReqCurr = 0.0;
			dTotalPspReqCurr = 0.0;
			if (GetField_CString(hRec,"psp_id",&csPspId)) {
DEBUGLOG(("PickPsp psp id  = [%s]\n",csPspId));
				DBObjPtr = CreateObj(DBPtr,"DBRulePspLbPsp","GetPsp");	
				iRet = (unsigned long)(*DBObjPtr)(csPspId,hRec);
				if (iRet != PD_OK) 
					break;
				if (GetField_Double(hRec,"psp_limit",&dLimit )) {
DEBUGLOG(("PickPsp limit for [%s]  = [%f]\n",csPspId,dLimit));
				}
				if (GetField_Int(hRec,"pool_psp_ratio",&iRatio)) {
DEBUGLOG(("PickPsp ratio for [%s]  = [%d] from Pool Mapping\n",csPspId,iRatio));
				}
				else 
					iRatio = 0;

				if (iRatio == 0) { //if don't override by the pool mapping
					if (GetField_Int(hRec,"psp_ratio",&iRatio )) {
DEBUGLOG(("PickPsp ratio for [%s]  = [%d]\n",csPspId,iRatio));
					}
				}

				if (dLimit != 0.0) {
					iRet = CheckPspLimit(csPspId,
								csServiceCode,
								csTxnCountry,
								csTxnCcy,
								csPayMethod,
								dLimit,
								&dPspCurr,
								&dTotalPspCurr,
								&dPspReqCurr,
								&dTotalPspReqCurr);	
				}
				else {
/* Get Curr Pool Hit */
                        		DBObjPtr = CreateObj(DBPtr,"DBRulePspLbPsp","GetPspLimit");
                        		iRet = (unsigned long)(*DBObjPtr)(csPspId,csServiceCode,csTxnCountry,csTxnCcy,csPayMethod,&dPspCurr,&dTotalPspCurr,&dPspReqCurr,&dTotalPspReqCurr);
				}
				if (iRet == PD_OK) {
DEBUGLOG(("PickPsp psp id [%s] is good psp Curr = [%f]\n",csPspId,dPspCurr));
					PutField_Double(hRec,"psp_curr",dPspCurr);
					PutField_Double(hRec,"psp_req_curr",dPspReqCurr);
					RecordSet_Add(rAvalPsp,hRec);
                		}
			}
                       	iTotalRatio += iRatio;
                     //  	dTotalVol += dPspCurr; /* approval amount */
                       	dTotalVol += dPspReqCurr; /* request amount */
DEBUGLOG(("CheckPools total ratio now =  [%d] total Vol = [%lf]\n",iTotalRatio,dTotalVol));
			hRec = RecordSet_GetNext(rPsp);
		}
	}
	else {
DEBUGLOG(("PickPsp Not record return from!!!\n"));
	}

	if (iTotalRatio >0 ) {
DEBUGLOG(("PickPsp ------------let see which psp will fit\n"));
                int    	iFinalPriority = 0;
		int    	iPriority = 0;
                double 	dFinalVolRatio = 0;
                double 	dFinalPspRatio = 0;
                double 	dTmpVolRatio = 0.0;
                double 	dPspRatio = 0.0;
		int	iCnt = 0;
                hRec = RecordSet_GetFirst(rAvalPsp);
                while (hRec) {
                        if (GetField_CString(hRec,"psp_id",&csPspId)) {
DEBUGLOG(("PickPsp ------------psp id = [%s]\n",csPspId));
                        }
                        if (GetField_Double(hRec,"psp_limit",&dLimit)) {
DEBUGLOG(("PickPsp ------------pool limit = [%f] for psp [%s]\n",dLimit,csPspId));
                        }

			if (GetField_Int(hRec,"pool_psp_ratio",&iRatio)) {
DEBUGLOG(("PickPsp ------------ratio from pool mapping = [%d]\n",iRatio));
			}
			iRatio = 0;

			if (iRatio == 0) { // if not override by pool mapping
                        	if (GetField_Int(hRec,"psp_ratio",&iRatio)) {
DEBUGLOG(("PickPsp ------------ratio = [%d]\n",iRatio));
                        	}
			}

                        if (GetField_Int(hRec,"pool_psp_priority",&iPriority)) {
DEBUGLOG(("PickPsp ------------priority = [%d] from pool mapping\n",iPriority));
			}
			else 
				iPriority = 0;
			if (iPriority == 0) { // if not override by pool mapping
                        	if (GetField_Int(hRec,"psp_priority",&iPriority)) {
DEBUGLOG(("PickPsp ------------priority = [%d]\n",iPriority));
                        	}
			}

                        if (GetField_Double(hRec,"psp_curr",&dPspCurr)) {
DEBUGLOG(("PickPsp ------------psp_curr = [%f]\n",dPspCurr));
                        }
                        if (GetField_Double(hRec,"psp_req_curr",&dPspReqCurr)) {
DEBUGLOG(("PickPsp ------------psp_req_curr = [%f]\n",dPspReqCurr));
                        }

                        if (iRatio > 0 ) {
                                dPspRatio = (double)iRatio/(double)iTotalRatio;
DEBUGLOG(("PickPsp ------------psp Ratio = [%f]\n",dPspRatio));
				//if (dPspCurr == 0.0 )
				if (dPspReqCurr == 0.0 )
                                        dTmpVolRatio = 0.0;
                                else
                                        dTmpVolRatio = dPspReqCurr/dTotalVol; /* Request Amount*/
                                        //dTmpVolRatio = dPspCurr/dTotalVol; /* approval amount */

				if (iCnt == 0) {
					strcpy(csSelectedPspId,csPspId);
                                	iFinalPriority = iPriority;
                                	dFinalVolRatio = dTmpVolRatio;
                                	dFinalPspRatio = dPspRatio;
				}
				iCnt++;

DEBUGLOG(("PickPsp ------------tmp vol ratio = [%f]\n",dTmpVolRatio));

/* if the psp was never hit */
                                //if (dPspCurr == 0.0 ) { /* approval amount */
                                if (dPspReqCurr == 0.0 ) {
                                /* if both psp are never hit */
DEBUGLOG((" pspreqcurr == 0.0 \n"));
                                        if (dFinalVolRatio == 0.0) {
DEBUGLOG((" finalvolratio == 0.0 \n"));
                                                if (iPriority > iFinalPriority)  {
DEBUGLOG((" Priority [%d] > FinalPriorty [%d] \n",iPriority,iFinalPriority));
							strcpy(csSelectedPspId,csPspId);
                                                        iFinalPriority = iPriority;
                                                        dFinalVolRatio = 0.0;
                                			dFinalPspRatio = dPspRatio;
                                                }
                                        }
                                /* take the lowest */
                                        else {
DEBUGLOG((" else \n"));
						strcpy(csSelectedPspId,csPspId);
                                                iFinalPriority = iPriority;
                                                dFinalVolRatio = 0.0;
                                		dFinalPspRatio = dPspRatio;
                                        }
                                }
/* if exceed the current ratio */
				else if ( dTmpVolRatio <= dFinalVolRatio) {
DEBUGLOG(("PickPsp TmpVolRatio [%f] <= FinalVolRatio [%f]\n",dTmpVolRatio,dFinalVolRatio));
                                        if (dFinalPspRatio < dFinalVolRatio  || iPriority > iFinalPriority) {
DEBUGLOG(("PickPsp it has higher Priority or previous pool has reach its ratio\n"));
DEBUGLOG(("PickPsp FinalPspRatio [%f] < FinalVolRaio [%f] || Priority[%d] > FinalPriority[%d]\n",dFinalPspRatio,dFinalVolRatio,iPriority,iFinalPriority));
						strcpy(csSelectedPspId,csPspId);
                                                iFinalPriority = iPriority;
                                                dFinalVolRatio = dTmpVolRatio;
                                		dFinalPspRatio = dPspRatio;
                                        }
                                }
                        }
DEBUGLOG(("PickPsp +++ psp id [%s] Priority [%d] Ratio [%f]\n",csSelectedPspId,iFinalPriority,dFinalVolRatio));
                        hRec = RecordSet_GetNext(rAvalPsp);
                }
	}
	RecordSet_Destroy(rAvalPsp);
       	FREE_ME(rAvalPsp);

	RecordSet_Destroy(rPsp);
       	FREE_ME(rPsp);
DEBUGLOG(("PickPsp() exit iRet = [%d]\n",iRet));
	return iRet;
}


int CheckPspLimit(const char* csId,
                const char* csServiceCode,
                const char* csTxnCountry,
                const char* csTxnCcy,
                const char* csPayMethod,
                double dLimit,
                double *dPoolCurr,
                double *dTotalPoolCurr,
                double *dPoolReqCurr,
                double *dTotalPoolReqCurr)
{
        int iRet = PD_ERR;
DEBUGLOG(("CheckPspLimit()\n"));

/*
DEBUGLOG(("CheckPspLimit ------------------------------------------\n"));
DEBUGLOG(("CheckPspLimit ServiceCode = [%s]\n",csServiceCode));
DEBUGLOG(("CheckPspLimit TxnCountry = [%s]\n",csTxnCountry));
DEBUGLOG(("CheckPspLimit TxnCcy = [%s]\n",csTxnCcy));
DEBUGLOG(("CheckPspLimit PayMethod = [%s]\n",csPayMethod));
DEBUGLOG(("CheckPspLimit ------------------------------------------\n"));
*/

        DBObjPtr = CreateObj(DBPtr,"DBRulePspLbPsp","GetPspLimit");
        iRet = (unsigned long)(*DBObjPtr)(csId,csServiceCode,csTxnCountry,csTxnCcy,csPayMethod,dPoolCurr,dTotalPoolCurr,dPoolReqCurr,dTotalPoolReqCurr);

        if (iRet == PD_OK) {
DEBUGLOG(("Rule limit = [%f] current hit = [%f]\n",dLimit,*dPoolCurr));

                if (*dTotalPoolCurr == 0.0) {
DEBUGLOG(("CheckPspLimit() Not Yet Exceed Limit since no txn had been made for this psp [%s]+++\n",csId));
                }
                else if (*dTotalPoolCurr > dLimit) {
DEBUGLOG(("CheckPspLimit() Exceed Limit [%f] > [%f]*****                                    +++\n",*dTotalPoolCurr,dLimit));
                        iRet = INT_EXCEED_LIMIT_PSP_AMT;
                }
                else {
DEBUGLOG(("CheckPspLimit() Not Yet Exceed Limit (%f <= %f [%s]+++\n",*dTotalPoolCurr,dLimit,csId));
                }
        }
DEBUGLOG(("ChecPspLimit() exit iRet = [%d]\n",iRet));
        return iRet;
}
