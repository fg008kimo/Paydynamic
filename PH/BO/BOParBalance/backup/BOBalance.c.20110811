/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/04/14              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#include "common.h"
#include "BOBalance.h"

char    cDebug;
OBJPTR(DB);

void BOBalance(char    cdebug)
{
        cDebug = cdebug;
}
int UpdatetMerchantSettAmt(const char* csCountry,
                        const char* csServiceCode,
                        const char* csMerchantCCY,
                        const char* csMerchantID,
                        double dTxnAmt);

int CreditDepositAmount(const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode, 
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dMerchantAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee);

int DebitDepositAmount(const char* csPostingDate,
                       const char* csCountry,
		       const char* csServiceCode,
		       const char* csMerchantCCY,
		       const char* csMerchantID,
		       double dMerchantAmount,
		       const char* csPspCCY,
		       const char* csPspID,
		       double dPspAmount,
		       double dReserveAmount,
		       double dPspFee);

int PayoutVoided(const char* csCountry, 
		const char* csServiceCode, 
		const char* csMerchantCCY, 
		const char* csMerchantID,
		double dMerchantAmount,
		const char* csPspCCY,
		const char* csPspID,
		double dPspAmount);

int PayoutSuccess(const char* csCountry, 
			const char* csServiceCode, 
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dMerchantAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount);

int UpdateTxnAmount(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csTxnCode;
	char	*csPostingDate;
	char	*csOrgTxnSeq;
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgDstCcy;
	char	*csOrgPspId;
	char	*csOrgServiceCode;
	double	dOrgNetAmt;
	double	dOrgDstTxnAmt;
	double	dReserveAmt = 0;
	double	dPspFee = 0;
	double	dTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:UpdateTxnAmount()\n"));
/*posting date*/
	if (GetField_CString(hContext,"PHDATE",&csPostingDate)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() posting_date = [%s]\n",csPostingDate));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() posting_date is missing!!!\n"));
	}
/*txn code */
	if (GetField_CString(hContext,"txn_code",&csTxnCode)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() txn_code = [%s]\n",csTxnCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() txn_code is missing!!!\n"));
	}
/*org txn seq */
	if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_seq = [%s]\n",csOrgTxnSeq));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_seq is missing!!!\n"));
	}

/*org txn country */
	if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_country is missing!!!\n"));
	}

/*org txn ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_txn_ccy is missing!!!\n"));
	}
/*org service Code */
	if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_service_code is missing!!!\n"));
	}

/*org merchant id */
	if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_merchant_id is missing!!!\n"));
	}

/*org psp ccy */
	if (GetField_CString(hContext,"org_dst_txn_ccy",&csOrgDstCcy)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_dst_txn_ccy = [%s]\n",csOrgDstCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_dst_txn_ccy is missing!!!\n"));
	}


/*org psp id */
	if (GetField_CString(hContext,"org_psp_id",&csOrgPspId)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_psp_id = [%s]\n",csOrgPspId));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_psp_id is missing!!!\n"));
	}

/*org net amount */
	if (GetField_Double(hContext,"net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() net_amt = [%lf]\n",dOrgNetAmt));
	}
	else {
		if (GetField_Double(hContext,"org_net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_net_amt = [%lf]\n",dOrgNetAmt));
		}
		else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_net_amt is missing!!!\n"));
		}
	}

/*org psp txn amount */
	if (GetField_Double(hContext,"org_dst_net_amt",&dOrgDstTxnAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_dst_net_amt = [%lf]\n",dOrgDstTxnAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() org_dst_net_amt is missing!!!\n"));
	}

/*reserved amt */
	if (GetField_Double(hContext,"reserve_amt",&dReserveAmt)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() reserve_amt = [%lf]\n",dReserveAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() not reserve_amt\n"));
	}

/* psp_fee */
	if (GetField_Double(hContext,"precal_fee",&dPspFee)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() precal_fee = [%lf]\n",dPspFee));
	}
	else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() precal_fee not found, try to get from request\n"));
		if (GetField_Double(hRequest,"service_fee",&dPspFee)) {	
DEBUGLOG(("BOBalance:UpdateTxnAmount() service_fee = [%lf]\n",dPspFee));
		}
		else {
DEBUGLOG(("BOBalance:UpdateTxnAmount() service_fee is missing!!!\n"));
		}
	}


	if (!strcmp(csTxnCode,PD_DEPOSIT_TXN_CODE) || 
            !strcmp(csTxnCode,PD_INITIAL_TXN_CODE)) {
DEBUGLOG(("BOBalance:UpdateTxnAmount() Update Deposit Txn\n"));
		iRet =CreditDepositAmount(csPostingDate,
					csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgNetAmt,
					csOrgDstCcy,
					csOrgPspId,
					dOrgDstTxnAmt,
					dReserveAmt,
					dPspFee);
	}
	else if(!strcmp(csTxnCode,PD_VOID_TXN_CODE)){

DEBUGLOG(("BOBalance:UpdateTxnAmount() Update Deposit Txn (Void)\n"));
		iRet =DebitDepositAmount(csPostingDate,
                                        csOrgTxnCountry,
                                        csOrgServiceCode,
                                        csOrgTxnCcy,
                                        csOrgMerchantId,
                                        dOrgNetAmt,
                                        csOrgDstCcy,
                                        csOrgPspId,
                                        dOrgDstTxnAmt,
                                        dReserveAmt,
                                        dPspFee);
	}
	else {
DEBUGLOG(("BOBalance:None DSP txn\n"));
	}
	
	if(iRet==PD_OK){

		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csOrgMerchantId,csOrgTxnCcy,csOrgTxnCountry,csOrgServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"payout_bal",&dTmp)){
				PutField_Double(hContext,"payout_bal",dTmp);
DEBUGLOG(("BOBalance: payout_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"settlement_bal",&dTmp)){
				PutField_Double(hContext,"settlement_bal",dTmp);
DEBUGLOG(("BOBalance: settlement_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_tfr_hold",&dTmp)){
				PutField_Double(hContext,"total_tfr_hold",dTmp);
DEBUGLOG(("BOBalance: total_tfr_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_payout_hold",&dTmp)){
				PutField_Double(hContext,"total_payout_hold",dTmp);
DEBUGLOG(("BOBalance: total_payout_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_settlement_hold",&dTmp)){
				PutField_Double(hContext,"total_settlement_hold",dTmp);
DEBUGLOG(("BOBalance: total_settlement_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"payout_in_transit",&dTmp)){
				PutField_Double(hContext,"payout_in_transit",dTmp);
DEBUGLOG(("BOBalance: payout_in_transit= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"settlement_in_transit",&dTmp)){
				PutField_Double(hContext,"settlement_in_transit",dTmp);
DEBUGLOG(("BOBalance: settlement_in_transit= [%f]\n",dTmp));
			}
		}
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalance");
		if((unsigned long)(*DBObjPtr)(csOrgPspId,csOrgTxnCountry,csOrgDstCcy,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"balance",&dTmp)){
				PutField_Double(hContext,"psp_balance",dTmp);
DEBUGLOG(("BOBalance:psp_balance = [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"psp_total_float",dTmp);
DEBUGLOG(("BOBalance:psp_total_float = [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_hold",&dTmp)){
				PutField_Double(hContext,"psp_total_hold",dTmp);
DEBUGLOG(("BOBalance:psp_total_hold = [%f]\n",dTmp));
			}
		}

		FREE_ME(hVal);
	}
	
	return iRet;
}

int CreditDepositAmount(const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dMerchantAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee) 
{
	int iRet = PD_OK;

DEBUGLOG(("BOBalance:CreditDepositAmount()\n"));
DEBUGLOG(("BOBalance:CreditDepositAmount() merchant = [%lf], psp = [%lf], res = [%lf]\n",dMerchantAmount,dPspAmount,dReserveAmount));

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBucket","CreditMerchantAmount");
        if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			csPspID,
			PD_BUCKET_TYPE_FLOAT,
			dMerchantAmount - dReserveAmount,
			PD_UPDATE_USER) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() CreditMerchantAmount [Float]Failed\n"));
	}

	if (iRet == PD_OK && dReserveAmount > 0) {
 	       if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			csPspID,
			PD_BUCKET_TYPE_RESERVED,
			dReserveAmount,
			PD_UPDATE_USER) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() CreditMerchantAmount [Reserved]Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:CreditDepositAmount UpdateFloat\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateFloat");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dMerchantAmount - dReserveAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() UpdateFloat Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:CreditDepositAmount UpdateReserved\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateReserved");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dReserveAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() UpdateFloat Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:CreditDepositAmount CreditPSP Balance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","CreditBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				dPspAmount - dPspFee,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:CreditDepositAmount() UpdateFloat Failed\n"));
		}
	}

DEBUGLOG(("BOBalance:CreditDepositAmount() iRet = [%d]\n",iRet));
	return iRet;
}


int UpdatePayoutAmount(const hash_t *hContext)
{
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgServiceCode;
	char	cBalTrfMode;
	double	dOrgMerchantAmt;

	int iRet = PD_OK;

/*org txn country */
	if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_country is missing!!!\n"));
	}

/*org txn ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_txn_ccy is missing!!!\n"));
	}
/*org service code */
	if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_service_code is missing!!!\n"));
	}

/*org merchant id */
	if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_merchant_id is missing!!!\n"));
	}

/*pay_amt*/
	if (GetField_Double(hContext,"org_merchant_txn_amt",&dOrgMerchantAmt)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_merchant_txn_amt = [%f]\n",dOrgMerchantAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() org_merchant_txn_amt is missing!!!\n"));
	}

/*bal_trf_mode*/
	if (GetField_Char(hContext,"bal_trf_mode",&cBalTrfMode)) {	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() bal_trf_mode = [%c]\n",cBalTrfMode));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutAmount() bal_trf_mode is missing!!!\n"));
	}
	
	if(cBalTrfMode==PD_P2I){
DEBUGLOG(("BOBalance:CreditPayoutAmount Payout to In-transit\n"));
	}
	else{
DEBUGLOG(("BOBalance:DebitPayoutAmount In-transit to Payout\n"));
	}

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","Payout2InTransit");
       	if ((*DBObjPtr)(csOrgMerchantId,
			csOrgTxnCountry,
			csOrgTxnCcy,
			csOrgServiceCode,
			dOrgMerchantAmt,
			cBalTrfMode,
			PD_UPDATE_USER) != PD_OK) {

			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBMerchantBalance::Payout2InTransit() Failed\n"));
	}
	
DEBUGLOG(("BOBalance:UpdatePayoutAmount() iRet = [%d]\n",iRet));
	return iRet;
}



int UpdatePayoutResponse(const hash_t* hContext)
{
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgServiceCode;
	char	*csOrgDstCcy;
	char	*csOrgPspId;
	char	cRespMode;
	double	dOrgMerchantAmt;
	double	dOrgDstTxnAmt;
	double	dPrecalFee=0;

	int iRet = PD_OK;

/*org txn country */
	if (GetField_CString(hContext,"org_txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_txn_country is missing!!!\n"));
	}

/*org txn ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_txn_ccy is missing!!!\n"));
	}
/*org service code */
	if (GetField_CString(hContext,"org_service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_service_code is missing!!!\n"));
	}

/*org merchant id */
	if (GetField_CString(hContext,"org_merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_merchant_id is missing!!!\n"));
	}

/*org_txn_amt*/
	if (GetField_Double(hContext,"org_merchant_txn_amt",&dOrgMerchantAmt)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_merchant_txn_amt = [%f]\n",dOrgMerchantAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_merchant_txn_amt is missing!!!\n"));
	}

/*response_mode*/
	if (GetField_Char(hContext,"response_mode",&cRespMode)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() response_mode = [%s]\n",cRespMode));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() response_mode is missing!!!\n"));
	}
	
/*org psp id */
	if (GetField_CString(hContext,"org_psp_id",&csOrgPspId)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_psp_id = [%s]\n",csOrgPspId));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_psp_id is missing!!!\n"));
	}

/*org psp ccy */
	if (GetField_CString(hContext,"org_psp_txn_ccy",&csOrgDstCcy)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_psp_txn_ccy = [%s]\n",csOrgDstCcy));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_psp_txn_ccy is missing!!!\n"));
	}

/*org psp txn amount */
	if (GetField_Double(hContext,"org_psp_txn_amt",&dOrgDstTxnAmt)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_psp_txn_amt = [%lf]\n",dOrgDstTxnAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() org_psp_txn_amt is missing!!!\n"));
	}

/*org psp precal fee*/
	if (GetField_Double(hContext,"precal_fee",&dPrecalFee)) {	
DEBUGLOG(("BOBalance:UpdatePayoutResponse() psp precal_fee = [%lf]\n",dPrecalFee));
	}
	else {
DEBUGLOG(("BOBalance:UpdatePayoutResponse() psp precal_fee is missing!!!\n"));
	}

	if(cRespMode==PD_ACCEPT){
		iRet = PayoutSuccess(csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgMerchantAmt,
					csOrgDstCcy,
					csOrgPspId,
					dOrgDstTxnAmt+dPrecalFee);
	}
	else if(cRespMode==PD_REVERSED){
		iRet = PayoutVoided(csOrgTxnCountry,
					csOrgServiceCode,
					csOrgTxnCcy,
					csOrgMerchantId,
					dOrgMerchantAmt,
					csOrgDstCcy,
					csOrgPspId,
					dOrgDstTxnAmt+dPrecalFee);
	}

	return iRet;

}


int PayoutSuccess(const char* csCountry, 
			const char* csServiceCode,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dMerchantAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount)
{
	int iRet = PD_OK;

DEBUGLOG(("BOBalance:PayoutSuccess()\n"));
DEBUGLOG(("BOBalance:PayoutSuccess() merchant = [%lf], psp = [%lf]\n",dMerchantAmount,dPspAmount));


	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdatePayoutIntransit");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dMerchantAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBMerchantBalance::UpdatePayoutIntransit()  Failed\n"));
		}
	}


	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:PayoutSuccess DebitPSP Balance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				dPspAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBPspBalance::DebitBalance() Failed\n"));
		}
	}


DEBUGLOG(("BOBalance:PayoutSuccess() iRet = [%d]\n",iRet));
	return iRet;
}



int PayoutVoided(const char* csCountry, 
		const char* csServiceCode,
		const char* csMerchantCCY, 
		const char* csMerchantID,
		double dMerchantAmount,
		const char* csPspCCY,
		const char* csPspID,
		double dPspAmount)
{
	int iRet = PD_OK;

DEBUGLOG(("BOBalance:PayoutVoided()\n"));
DEBUGLOG(("BOBalance:PayoutVoided() merchant = [%lf], psp = [%lf]\n",dMerchantAmount,dPspAmount));


	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","VoidPayout");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				dMerchantAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBMerchantBalance::VoidPayout() Failed\n"));
		}
	}


	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:PayoutVoided CreditPSP Balance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","CreditBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				dPspAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DBPspBalance::CreditBalance() Failed\n"));
		}
	}

DEBUGLOG(("BOBalance:PayoutVoided() iRet = [%d]\n",iRet));
	return iRet;
}


int ProcessHold(const char *csTxnCountry,
		const char *csServiceCode,
		const char *csTxnCcy,
		const char *csMerchantId,
		char  cHoldUnholdInd,
		const char *csHoldType,
		double dHoldAmt)
{
	int iRet = PD_OK;

	char csCheckHoldType[PD_HOLD_TYPE_LEN+1];
	double dPayoutBal=0;
	double dMinPayoutBal=0;
	double dSettleBal=0;
	double dPayoutHold=0;
	double dSettleHold=0;
	double dHoldRemain;
	double dTmp;
	int i = 0;

	hash_t *hVal;
	hash_t *hTxn;

	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

DEBUGLOG(("BOBalance: ProcessHold: HoldType[%s] HoldAmt[%f]\n",csHoldType,dHoldAmt));

/////hold values from MerchantBalance/////

DEBUGLOG(("BOBalance: ProcessHold: DBMerchantBalance->GetCurrentValues\n"));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
	if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){
		if(GetField_Double(hVal,"payout_bal",&dTmp)){
			
/*TODO: Get the minimum payout balance value*/

			dPayoutBal = dTmp - dMinPayoutBal;
DEBUGLOG(("BOBalance: payout_bal= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"settlement_bal",&dSettleBal)){
DEBUGLOG(("BOBalance: settlement_bal= [%f]\n",dSettleBal));
		}
		if(GetField_Double(hVal,"total_payout_hold",&dPayoutHold)){
DEBUGLOG(("BOBalance: total_payout_hold= [%f]\n",dPayoutHold));
		}
		if(GetField_Double(hVal,"total_settlement_hold",&dSettleHold)){
DEBUGLOG(("BOBalance: total_settlement_hold= [%f]\n",dSettleHold));
		}
	}

	if(cHoldUnholdInd==PD_PROCESS_HOLD){
		dHoldRemain = dHoldAmt;
		strcpy(csCheckHoldType,csHoldType);
		csCheckHoldType[PD_HOLD_TYPE_LEN]='\0';

		do{
			i ++;
			if(!strcmp(csCheckHoldType,PD_HOLD_SETTLEMENT)){
				if(dSettleBal>=dHoldRemain){
					dSettleHold += dHoldRemain;
					dSettleBal -= dHoldRemain;
					dHoldRemain = 0;
				}
				else{
					dHoldRemain -= dSettleBal;
					dSettleHold += dSettleBal;
					dSettleBal = 0;
				}
DEBUGLOG(("BOBalance: New Settlement Balance[%f] Settlement Hold[%f] Remain Hold[%f]\n",dSettleBal,dSettleHold,dHoldRemain));

///////Update Hold Amount Table
				DBObjPtr = CreateObj(DBPtr,"DBHoldAmount","UpdateHoldAmount");
				if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCountry,
								csTxnCcy,csServiceCode,
								csCheckHoldType,dSettleHold,PD_UPDATE_USER)!=PD_OK){
					iRet = PD_ERR;
				}

				strcpy(csCheckHoldType,PD_HOLD_PAYOUT);

			}
			else if(!strcmp(csCheckHoldType,PD_HOLD_PAYOUT)){
			if(dPayoutBal>=dHoldRemain){
				dPayoutHold += dHoldRemain;
				dPayoutBal -= dHoldRemain;
				dHoldRemain = 0;
				}
				else{
					dHoldRemain -= dPayoutBal;
					dPayoutHold += dPayoutBal;
					dPayoutBal = 0;
					strcpy(csCheckHoldType,PD_HOLD_SETTLEMENT);
				}
DEBUGLOG(("BOBalance: New Payout Balance[%f] Payout Hold[%f] Remain Hold[%f]\n",dPayoutBal+dMinPayoutBal,dPayoutHold,dHoldRemain));

///////Update Hold Amount Table
				DBObjPtr = CreateObj(DBPtr,"DBHoldAmount","UpdateHoldAmount");
				if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCountry,
								csTxnCcy,csServiceCode,
								csCheckHoldType,dPayoutHold,PD_UPDATE_USER)!=PD_OK){
					iRet = PD_ERR;
				}

				strcpy(csCheckHoldType,PD_HOLD_SETTLEMENT);

			}
			else{
DEBUGLOG(("BOBalance: Invalid Hold Type\n"));
				iRet = PD_ERR;
			}

			if((i>=2)||(dHoldRemain==0)){
				break;
			}

		}while(PD_TRUE);
	}
	else if(cHoldUnholdInd==PD_PROCESS_UNHOLD){
		dSettleBal += dHoldAmt;
DEBUGLOG(("BOBalance: New Settlement Balance[%f]\n",dSettleBal));

///////Update Hold Amount Table
		DBObjPtr = CreateObj(DBPtr,"DBHoldAmount","UpdateUnHoldAmount");
		if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCountry,
						csTxnCcy,csServiceCode,
						csHoldType,dHoldAmt,PD_UPDATE_USER)!=PD_OK){
			iRet = PD_ERR;
		}

	}	


	if(iRet==PD_OK){
///////Update MerchantBalance Table
		hTxn = (hash_t*) malloc (sizeof(hash_t));
                hash_init(hTxn,0);

		PutField_CString(hTxn,"merchant_id",csMerchantId);
		PutField_CString(hTxn,"country_id",csTxnCountry);
		PutField_CString(hTxn,"ccy_id",csTxnCcy);
		PutField_CString(hTxn,"service_code",csServiceCode);
		PutField_Double(hTxn,"payout_bal",dPayoutBal+dMinPayoutBal);
		PutField_Double(hTxn,"payout_hold",dPayoutHold);
		PutField_Double(hTxn,"settlement_bal",dSettleBal);
		PutField_Double(hTxn,"settlement_hold",dSettleHold);
		PutField_CString(hTxn,"update_user",PD_UPDATE_USER);

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateBalanceAndHold");
		if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
			iRet = PD_ERR;
DEBUGLOG(("BOBalance: DBMerchantBalance::UpdateBalanceAndHold Error\n"));
		}

		FREE_ME(hTxn);
	}

	FREE_ME(hVal);	
	return iRet;
}



int DebitDepositAmount(const char* csPostingDate,
			const char* csCountry, 
			const char* csServiceCode,
			const char* csMerchantCCY, 
			const char* csMerchantID,
			double dMerchantAmount,
			const char* csPspCCY,
			const char* csPspID,
			double dPspAmount,
			double dReserveAmount,
			double dPspFee) 
{
	int iRet = PD_OK;

DEBUGLOG(("BOBalance:DebitDepositAmount()\n"));
DEBUGLOG(("BOBalance:DebitDepositAmount() merchant = [%lf], psp = [%lf], res = [%lf]\n",dMerchantAmount,dPspAmount,dReserveAmount));

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBucket","CreditMerchantAmount");
        if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			csPspID,
			PD_BUCKET_TYPE_FLOAT,
			- dMerchantAmount + dReserveAmount,
			PD_UPDATE_USER) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() CreditMerchantAmount [Float]Failed\n"));
	}

	if (iRet == PD_OK && dReserveAmount > 0) {
 	       if ((*DBObjPtr)(csPostingDate,
			csMerchantID,
			csCountry,
			csMerchantCCY,
			csServiceCode,
			csPspID,
			PD_BUCKET_TYPE_RESERVED,
			- dReserveAmount,
			PD_UPDATE_USER) != PD_OK) {
		iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() CreditMerchantAmount [Reserved]Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:DebitDepositAmount UpdateFloat\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateFloat");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				- dMerchantAmount + dReserveAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() UpdateFloat Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:DebitDepositAmount UpdateReserved\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateReserved");
        	if ((*DBObjPtr)(csMerchantID,
				csCountry,
				csMerchantCCY,
				csServiceCode,
				-dReserveAmount,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() UpdateFloat Failed\n"));
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:DebitDepositAmount DebitPSP Balance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
        	if ((*DBObjPtr)(csPspID,
				csCountry,
				csPspCCY,
				dPspAmount - dPspFee,
				PD_UPDATE_USER) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitDepositAmount() UpdateFloat Failed\n"));
		}
	}

DEBUGLOG(("BOBalance:DebitDepositAmount() iRet = [%d]\n",iRet));
	return iRet;
}





int UpdateSettlementAmount(hash_t *hContext)
{
	int	iRet = PD_OK;
	char	*csTxnCode;
	char	*csOrgTxnSeq;
	char	*csOrgTxnCountry;
	char	*csOrgTxnCcy;
	char	*csOrgMerchantId;
	char	*csOrgServiceCode;
	double	dOrgNetAmt;
	double	dTmp;
	char	cTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:UpdateSettlementAmount()\n"));

/*txn code */
	if (GetField_CString(hContext,"txn_code",&csTxnCode)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_code = [%s]\n",csTxnCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_code is missing!!!\n"));
	}
/*org txn seq */
	if (GetField_CString(hContext,"txn_seq",&csOrgTxnSeq)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_seq = [%s]\n",csOrgTxnSeq));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_seq is missing!!!\n"));
	}

/*org txn country */
	if (GetField_CString(hContext,"txn_country",&csOrgTxnCountry)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_country = [%s]\n",csOrgTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_country is missing!!!\n"));
	}

/*org txn ccy */
	if (GetField_CString(hContext,"request_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_ccy = [%s]\n",csOrgTxnCcy));
	}
	else {
		if (GetField_CString(hContext,"txn_ccy",&csOrgTxnCcy)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_ccy = [%s]\n",csOrgTxnCcy));
		}
		else{
DEBUGLOG(("BOBalance:UpdateSettlementAmount() txn_ccy is missing!!!\n"));
		}
	}
/*org service Code */
	if (GetField_CString(hContext,"service_code",&csOrgServiceCode)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() service_code = [%s]\n",csOrgServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() service_code is missing!!!\n"));
	}

/*org merchant id */
	if (GetField_CString(hContext,"merchant_id",&csOrgMerchantId)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() merchant_id = [%s]\n",csOrgMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() merchant_id is missing!!!\n"));
	}


/*org net amount */
	if (GetField_Double(hContext,"net_amt",&dOrgNetAmt)) {	
DEBUGLOG(("BOBalance:UpdateSettlementAmount() net_amt = [%lf]\n",dOrgNetAmt));
	}
	else {
DEBUGLOG(("BOBalance:UpdateSettlementAmount() net_amt is missing!!!\n"));
	}


DEBUGLOG(("BOBalance:UpdateSettlementAmount() Update Avi Settlement Balance\n"));

	if(!strcmp(csTxnCode,PD_SETTLEMENT_REQUEST)){
		iRet = PD_OK;
	}

	else if(!strcmp(csTxnCode,PD_SETTLEMENT_PROCESS)){
DEBUGLOG(("BOBalance:UpdateSettlementAmount() Call DBMerchantBalance:Settlement2InTransit[%c]\n",PD_S2I));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","Settlement2InTransit");
		iRet = (unsigned long)(*DBObjPtr)(csOrgMerchantId,
						csOrgTxnCountry,
						csOrgTxnCcy,
						csOrgServiceCode,
						dOrgNetAmt,
						PD_S2I,
						PD_UPDATE_USER); 
	}

	else if(!strcmp(csTxnCode,PD_SETTLEMENT_APPROVAL)){
		if(GetField_Char(hContext,"approval_state",&cTmp)){
DEBUGLOG(("BOBalance:UpdateSettlementAmount() Settlement approval state[%c]\n",cTmp));
		}

		if(cTmp==PD_REJECT){
DEBUGLOG(("BOBalance:UpdateSettlementAmount() Call DBMerchantBalance:Settlement2InTransit[%c]\n",PD_I2S));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","Settlement2InTransit");
			iRet = (unsigned long)(*DBObjPtr)(csOrgMerchantId,
						csOrgTxnCountry,
                                                csOrgTxnCcy,
                                                csOrgServiceCode,
                                                dOrgNetAmt,
                                                PD_I2S,
                                                PD_UPDATE_USER);
		}
		else if(cTmp==PD_ACCEPT){
DEBUGLOG(("BOBalance:UpdateSettlementAmount() Call DBMerchantBalance:UpdateSettlementIntransit\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateSettlementIntransit");
			iRet = (unsigned long)(*DBObjPtr)(csOrgMerchantId,
                                                csOrgTxnCountry,
                                                csOrgTxnCcy,
                                                csOrgServiceCode,
                                                dOrgNetAmt,
                                                PD_UPDATE_USER);
		}
	}


	else {
DEBUGLOG(("BOBalance:None Settlement txn\n"));
		return iRet;
	}

	//if(iRet==PD_OK){

		hVal = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hVal,0);

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
		if((unsigned long)(*DBObjPtr)(csOrgMerchantId,csOrgTxnCcy,csOrgTxnCountry,csOrgServiceCode,hVal)!=PD_ERR){
			if(GetField_Double(hVal,"payout_bal",&dTmp)){
				PutField_Double(hContext,"payout_bal",dTmp);
DEBUGLOG(("BOBalance: payout_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"settlement_bal",&dTmp)){
				PutField_Double(hContext,"settlement_bal",dTmp);
DEBUGLOG(("BOBalance: settlement_bal= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_float",&dTmp)){
				PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
				PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_tfr_hold",&dTmp)){
				PutField_Double(hContext,"total_tfr_hold",dTmp);
DEBUGLOG(("BOBalance: total_tfr_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_payout_hold",&dTmp)){
				PutField_Double(hContext,"total_payout_hold",dTmp);
DEBUGLOG(("BOBalance: total_payout_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"total_settlement_hold",&dTmp)){
				PutField_Double(hContext,"total_settlement_hold",dTmp);
DEBUGLOG(("BOBalance: total_settlement_hold= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"payout_in_transit",&dTmp)){
				PutField_Double(hContext,"payout_in_transit",dTmp);
DEBUGLOG(("BOBalance: payout_in_transit= [%f]\n",dTmp));
			}
			if(GetField_Double(hVal,"settlement_in_transit",&dTmp)){
				PutField_Double(hContext,"settlement_in_transit",dTmp);
DEBUGLOG(("BOBalance: settlement_in_transit= [%f]\n",dTmp));
			}
		}

		FREE_ME(hVal);
	//}
	
DEBUGLOG(("BOBalance iRet=[%d]\n",iRet));
	return iRet;
}


int GetAvalBalanceForUpdate(const char* csTxnCountry,
                        const char* csTxnCcy,
                        const char* csService,
                        const char* csMerchantId,
                        double  *dBalance)
{
	int	iRet = PD_OK;
DEBUGLOG(("BOBalance:GetBalanceForUpdate()\n"));

DEBUGLOG(("BOBalance:GetBalanceForUpdate() mid=[%s]\n",csMerchantId));
DEBUGLOG(("BOBalance:GetBalanceForUpdate() txn_ccy=[%s]\n",csTxnCcy));
DEBUGLOG(("BOBalance:GetBalanceForUpdate() txn_country=[%s]\n",csTxnCountry));
DEBUGLOG(("BOBalance:GetBalanceForUpdate() service=[%s]\n",csService));
	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetAviBalanceForSettlement");
        if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csService,dBalance)==PD_FOUND){
DEBUGLOG(("Balance = [%lf]\n",*dBalance));
        }
        else{
DEBUGLOG(("BOBalance:GetBalanceForUpdate()  balance for [%s] [%s] [%s] not found\n",csMerchantId,csTxnCcy,csService));
ERRLOG("BOBalance:GetBalanceForUpdate()  balance for [%s] [%s] [%s] not found\n",csMerchantId,csTxnCcy,csService);
		*dBalance = 0.0;
        }
	

	return iRet;
}
int GetPayoutBalanceForUpdate(const char* csTxnCountry,
                        const char* csTxnCcy,
                        const char* csService,
                        const char* csMerchantId,
                        double  *dBalance)
{
	int	iRet = PD_OK;
DEBUGLOG(("BOBalance:GetBalanceForUpdate()\n"));

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetAviBalanceForPayout");
        if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csService,dBalance)==PD_FOUND){
DEBUGLOG(("Balance = [%lf]\n",*dBalance));
	}
	else{
		iRet=PD_ERR;
DEBUGLOG(("Balance not found\n"));
	}

	return iRet;
}


int UpdatetMerchantSettAmt(const char* csCountry,
                        const char* csServiceCode,
                        const char* csMerchantCCY,
                        const char* csMerchantID,
                        double dTxnAmt)
{
	int	iRet = PD_OK;
	
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount  Amount to be updated = [%lf]\n",dTxnAmt));
        if (iRet == PD_OK) {
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount UpdateSettlementBal\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateSettlementBal");
                if ((*DBObjPtr)(csMerchantID,
                                csCountry,
                                csMerchantCCY,
                                csServiceCode,
                                dTxnAmt,
                                PD_UPDATE_USER) != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount() UpdateSettlementBal Failed\n"));
                }
        }

	return iRet;
}


int DebitMerchantSettlementAmount(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csTxnCountry;
	char	*csTxnCcy;
	char	*csMerchantId;
	char	*csServiceCode;
	double	dNetAmt;
	double	dTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount()\n"));

/*txn country */
	if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {	
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount() txn_country = [%s]\n",csTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount() txn_country is missing!!!\n"));
	}

/*txn ccy */
	if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {	
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount() txn_ccy = [%s]\n",csTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount() txn_ccy is missing!!!\n"));
	}
/*service Code */
	if (GetField_CString(hContext,"service_code",&csServiceCode)) {	
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount() service_code = [%s]\n",csServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount() service_code is missing!!!\n"));
	}

/*merchant id */
	if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {	
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount() merchant_id = [%s]\n",csMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount() merchant_id is missing!!!\n"));
	}


/* net amount */
	if (GetField_Double(hContext,"net_amt",&dNetAmt)) {	
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount() net_amt = [%lf]\n",dNetAmt));
	}
	else {
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount() net_amt is missing!!!\n"));
	}



DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount() Update settlement balance \n"));
	iRet = UpdatetMerchantSettAmt( csTxnCountry,
				csServiceCode,
				csTxnCcy,
				csMerchantId,
				dNetAmt * (-1));
		
	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
	if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){
		if(GetField_Double(hVal,"payout_bal",&dTmp)){
			PutField_Double(hContext,"payout_bal",dTmp);
DEBUGLOG(("BOBalance: payout_bal= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"settlement_bal",&dTmp)){
			PutField_Double(hContext,"settlement_bal",dTmp);
DEBUGLOG(("BOBalance: settlement_bal= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_float",&dTmp)){
			PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
			PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_tfr_hold",&dTmp)){
			PutField_Double(hContext,"total_tfr_hold",dTmp);
DEBUGLOG(("BOBalance: total_tfr_hold= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_payout_hold",&dTmp)){
			PutField_Double(hContext,"total_payout_hold",dTmp);
DEBUGLOG(("BOBalance: total_payout_hold= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_settlement_hold",&dTmp)){
			PutField_Double(hContext,"total_settlement_hold",dTmp);
DEBUGLOG(("BOBalance: total_settlement_hold= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"payout_in_transit",&dTmp)){
			PutField_Double(hContext,"payout_in_transit",dTmp);
DEBUGLOG(("BOBalance: payout_in_transit= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"settlement_in_transit",&dTmp)){
			PutField_Double(hContext,"settlement_in_transit",dTmp);
DEBUGLOG(("BOBalance: settlement_in_transit= [%f]\n",dTmp));
		}
	}
	FREE_ME(hVal);
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount()  exit = [%d]\n",iRet));
	
	return iRet;
}

int CreditMerchantSettlementAmount(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	char	*csTxnCountry;
	char	*csTxnCcy;
	char	*csMerchantId;
	char	*csServiceCode;
	double	dNetAmt;
	double	dTmp;
	hash_t* hVal;


DEBUGLOG(("BOBalance:CreditMerchantSettlementAmount()\n"));

/* txn country */
	if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {	
DEBUGLOG(("BOBalance:CreditMerchantSettlementAmount() txn_country = [%s]\n",csTxnCountry));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantSettlementAmount() txn_country is missing!!!\n"));
	}

/*txn ccy */
	if (GetField_CString(hContext,"bal_ccy",&csTxnCcy)) {	
DEBUGLOG(("BOBalance:DebitMerchantSettlementAmount() txn_ccy = [%s]\n",csTxnCcy));
	}
	else if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {	
DEBUGLOG(("BOBalance:CreditMerchantSettlementAmount() txn_ccy = [%s]\n",csTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantSettlementAmount() txn_ccy is missing!!!\n"));
	}
/*service Code */
	if (GetField_CString(hContext,"service_code",&csServiceCode)) {	
DEBUGLOG(("BOBalance:CreditMerchantSettlementAmount() service_code = [%s]\n",csServiceCode));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantSettlementAmount() service_code is missing!!!\n"));
	}

/*merchant id */
	if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {	
DEBUGLOG(("BOBalance:CreditMerchantSettlementAmount() merchant_id = [%s]\n",csMerchantId));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantSettlementAmount() merchant_id is missing!!!\n"));
	}


/*net amount */
	if (GetField_Double(hContext,"net_amt",&dNetAmt)) {	
DEBUGLOG(("BOBalance:CreditMerchantSettlementAmount() net_amt = [%lf]\n",dNetAmt));
	}
	else {
DEBUGLOG(("BOBalance:CreditMerchantSettlementAmount() net_amt is missing!!!\n"));
	}



DEBUGLOG(("BOBalance:CreditMerchantSettlementAmount() Update settlement balance \n"));
	iRet = UpdatetMerchantSettAmt( csTxnCountry,
				csServiceCode,
				csTxnCcy,
				csMerchantId,
				dNetAmt);
		
	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

	DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
	if((unsigned long)(*DBObjPtr)(csMerchantId,csTxnCcy,csTxnCountry,csServiceCode,hVal)!=PD_ERR){
		if(GetField_Double(hVal,"payout_bal",&dTmp)){
			PutField_Double(hContext,"payout_bal",dTmp);
DEBUGLOG(("BOBalance: payout_bal= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"settlement_bal",&dTmp)){
			PutField_Double(hContext,"settlement_bal",dTmp);
DEBUGLOG(("BOBalance: settlement_bal= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_float",&dTmp)){
			PutField_Double(hContext,"total_float",dTmp);
DEBUGLOG(("BOBalance: total_float= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
			PutField_Double(hContext,"total_reserved_amount",dTmp);
DEBUGLOG(("BOBalance: total_reserved_amount= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_tfr_hold",&dTmp)){
			PutField_Double(hContext,"total_tfr_hold",dTmp);
DEBUGLOG(("BOBalance: total_tfr_hold= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_payout_hold",&dTmp)){
			PutField_Double(hContext,"total_payout_hold",dTmp);
DEBUGLOG(("BOBalance: total_payout_hold= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"total_settlement_hold",&dTmp)){
			PutField_Double(hContext,"total_settlement_hold",dTmp);
DEBUGLOG(("BOBalance: total_settlement_hold= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"payout_in_transit",&dTmp)){
			PutField_Double(hContext,"payout_in_transit",dTmp);
DEBUGLOG(("BOBalance: payout_in_transit= [%f]\n",dTmp));
		}
		if(GetField_Double(hVal,"settlement_in_transit",&dTmp)){
			PutField_Double(hContext,"settlement_in_transit",dTmp);
DEBUGLOG(("BOBalance: settlement_in_transit= [%f]\n",dTmp));
		}
	}
	FREE_ME(hVal);
DEBUGLOG(("BOBalance:CreditMerchantSettlementAmount()  exit = [%d]\n",iRet));
	
	return iRet;
}

int DebitSebBalance(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	int	iCnt = 0;
	char*	csBankCcy;
	char*	csTxnId;
	char*	csTmp;
	char	csTag[PD_TAG_LEN+1];
	double	dNetAmt;
	double	dTmp;
	double	dBal;
	double	dRate;
	double	dRatio;
	double	dTotalAmt=0;
	hash_t*	hRec;	
	hash_t*	hVal;	
	hVal = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVal,0);

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("BOBalance:DebitSebBalance()\n"));

//txn_seq
	if (GetField_CString(hContext,"txn_seq",&csTxnId)) {	
		PutField_CString(hVal,"txn_id",csTxnId);
DEBUGLOG(("BOBalance:DebitSebBalance()txn_seq = [%s]\n",csTxnId));
	}
	else {
DEBUGLOG(("BOBalance:DebitSebBalance() txn_seq is missing!!!\n"));
	}

//bank_ccy
	if (GetField_CString(hContext,"bank_ccy",&csBankCcy)) {	
DEBUGLOG(("BOBalance:DebitSebBalance() bank_ccy = [%s]\n",csBankCcy));
	}
	else {
DEBUGLOG(("BOBalance:DebitSebBalance() bank_ccy is missing!!!\n"));
	}


///net amount 
	if (GetField_Double(hContext,"bank_bal",&dNetAmt)) {	
DEBUGLOG(("BOBalance:DebitSebBalance() bank_bal = [%lf]\n",dNetAmt));
	}
	else {
DEBUGLOG(("BOBalance:DebitSebBalance() bank_bal is missing!!!\n"));
	}

	DBObjPtr = CreateObj(DBPtr,"DBSebBalance","FindBankBalanceInfo");
	if ((*DBObjPtr)(csBankCcy,rRecordSet) == PD_OK) {
DEBUGLOG(("FindBankBalanceInfo::found record = [%s]\n",csBankCcy));
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if(GetField_CString(hRec,"from_ccy",&csTmp)){
				sprintf(csTag,"from_ccy_%d",iCnt);
				PutField_CString(hVal,csTag,csTmp);
DEBUGLOG(("FindBankBalanceInfo::%s= [%s]\n",csTag,csTmp));
			}
			if(GetField_Double(hRec,"bank_bal",&dTmp)){
				sprintf(csTag,"bank_bal_%d",iCnt);
				PutField_Double(hVal,csTag,dTmp);
DEBUGLOG(("FindBankBalanceInfo::%s= [%lf]\n",csTag,dTmp));

				dTotalAmt += dTmp;
			}
			if(GetField_Double(hRec,"rate",&dTmp)){
				sprintf(csTag,"rate_%d",iCnt);
				PutField_Double(hVal,csTag,dTmp);
DEBUGLOG(("FindBankBalanceInfo::%s= [%lf]\n",csTag,dTmp));
			}
			if(GetField_Double(hRec,"ratio",&dTmp)){
				sprintf(csTag,"ratio_%d",iCnt);
				PutField_Double(hVal,csTag,dTmp);
DEBUGLOG(("FindBankBalanceInfo::%s= [%lf]\n",csTag,dTmp));
			}

			iCnt++;
			hRec = RecordSet_GetNext(rRecordSet);
		}
		if(dTotalAmt<dNetAmt){
DEBUGLOG(("BOBalance:DebitSebBalance:Not enought amount[%s][%lf]\n",csBankCcy,dTotalAmt));
			iRet=INT_INSUFFICIENT_FUND;
		}
	}
	else{
		iRet=PD_ERR;
DEBUGLOG(("BOBalance:DebitSebBalance:FindBankBalanceInfo::record not found[%s]\n",csBankCcy));
	}
	

	if(iRet==PD_OK){
		int i;
		for(i=0;i<iCnt;i++){
			sprintf(csTag,"from_ccy_%d",i);
			GetField_CString(hVal,csTag,&csTmp);
			PutField_CString(hVal,"txn_ccy",csTmp);

			sprintf(csTag,"bank_bal_%d",i);
			GetField_Double(hVal,csTag,&dBal);

			sprintf(csTag,"rate_%d",i);
			GetField_Double(hVal,csTag,&dRate);
			PutField_Double(hVal,"rate",dRate);

			sprintf(csTag,"ratio_%d",i);
			GetField_Double(hVal,csTag,&dRatio);
			PutField_Double(hVal,"ratio",dRatio);

			dTmp = dBal-(dNetAmt*dRatio);
			PutField_Double(hVal,"txn_amt",(dNetAmt*dRatio));

DEBUGLOG(("BOBalance:DebitSebBalance:Call DBSebBalance:UpdateBankBalance[%s][%s][%lf]\n",csTmp,csBankCcy,dTmp));
			DBObjPtr = CreateObj(DBPtr,"DBSebBalance","UpdateBankBalance");
			if((*DBObjPtr)(csTmp,csBankCcy,dTmp)!=PD_OK){
DEBUGLOG(("BOBalance:DebitSebBalance:UpdateBankBalance[%s][%s][%lf] Failed\n",csTmp,csBankCcy,dTmp));
				iRet = PD_ERR;
				break;
			}
			else{
DEBUGLOG(("BOBalance:DebitSebBalance:Call TxnSetContributors:Add\n"));
				PutField_CString(hVal,"add_user",PD_UPDATE_USER);
				DBObjPtr = CreateObj(DBPtr,"DBTxnSetContributors","Add");
				if((*DBObjPtr)(hVal)!=PD_OK){
DEBUGLOG(("BOBalance:DebitSebBalance:TxnSetContributors:Add Failed\n"));
					iRet = PD_ERR;
					break;
				}
			}
		}
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hVal);
	return	iRet;
}


int RestoreSebBalance(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;
	int	i, iCnt = 0;
	char	*csOrgTxnSeq;
	char	*csFromCcy;
	char	*csToCcy;
	char	csTag[PD_TAG_LEN+1];
	double	dTmp,dRate,dRatio,dAmt,dCalRate,dOrgBankAmt,dOrgRate,dOrgRatio;
	double	dCalRatio_D=0;
	hash_t  *hRec, *hVal, *hTxn;

	hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
	
	recordset_t     *rSeb_RecordSet;
        rSeb_RecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rSeb_RecordSet,0);
	
	if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {	
DEBUGLOG(("BOBalance:RestoreSebBalance() org_txn_seq = [%s]\n",csOrgTxnSeq));
	}
	else{
DEBUGLOG(("BOBalance:RestoreSebBalance() org_txn_seq is missing!!!\n"));
	}
	
DEBUGLOG(("Authorize::Call DBTransaction:GetTxnDetail\n"));
	DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
	if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if (GetField_CString(hRec,"txn_ccy",&csToCcy)) {
				PutField_CString(hTxn,"bank_ccy",csToCcy);
DEBUGLOG(("GetTxnDetail::to_ccy = [%s]\n",csToCcy));
			}
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}
	RecordSet_Destroy(rRecordSet);

DEBUGLOG(("BOBalance:RestoreSebBalance:Call TxnSetContributors:GetContributors\n"));
	recordset_init(rRecordSet,0);
	DBObjPtr = CreateObj(DBPtr,"DBTxnSetContributors","GetContributors");
	if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet)==PD_OK){
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			sprintf(csTag,"txn_ccy_%d",iCnt);
			if (GetField_CString(hRec,"txn_ccy",&csFromCcy)) {
				PutField_CString(hTxn,csTag,csFromCcy);
DEBUGLOG(("GetContributors::%s = [%s]\n",csTag,csFromCcy));
			}
			sprintf(csTag,"rate_%d",iCnt);
			if (GetField_Double(hRec,"rate",&dRate)) {
DEBUGLOG(("GetContributors::%s = [%lf]\n",csTag,dRate));
			}
			sprintf(csTag,"ratio_%d",iCnt);
			if (GetField_Double(hRec,"ratio",&dRatio)) {
DEBUGLOG(("GetContributors::%s = [%lf]\n",csTag,dRatio));
			}
			sprintf(csTag,"txn_amt_%d",iCnt);
			if (GetField_Double(hRec,"txn_amt",&dAmt)) {
DEBUGLOG(("GetContributors::%s = [%lf]\n",csTag,dAmt));
			}

			dCalRatio_D += dAmt;
			
DEBUGLOG(("BOBalance:RestoreSebBalance:Call DBSebBalance:FindBalanceByCcy\n"));
			DBObjPtr = CreateObj(DBPtr,"DBSebBalance","FindBalanceByCcy");
			if ((unsigned long)(*DBObjPtr)(csFromCcy,csToCcy,rSeb_RecordSet) == PD_FOUND) {
				hVal = RecordSet_GetFirst(rSeb_RecordSet);
				while (hVal) {
					if (GetField_Double(hVal,"bank_bal",&dOrgBankAmt)) {
DEBUGLOG(("FindBalanceByCcy : org_bank_amt = [%f]\n", dOrgBankAmt));
					}
					if (GetField_Double(hVal,"rate",&dOrgRate)) {
DEBUGLOG(("FindBalanceByCcy : org_rate = [%f]\n", dOrgRate));
					}
					if (GetField_Double(hVal,"ratio",&dOrgRatio)) {
DEBUGLOG(("FindBalanceByCcy : org_ratio = [%f]\n", dOrgRatio));
					}
					hVal = RecordSet_GetNext(rRecordSet);
				}

				dCalRate = newround(((dRate*dAmt)+(dOrgRate*dOrgBankAmt))/(dAmt+dOrgBankAmt),PD_ROUND_UP_DEC);
				dCalRatio_D += dOrgBankAmt;

				sprintf(csTag,"rate_%d",iCnt);
				PutField_Double(hTxn,csTag,dCalRate);
				sprintf(csTag,"amt_%d",iCnt);
				PutField_Double(hTxn,csTag,(dAmt+dOrgBankAmt));

			}
			else{
				iRet = PD_ERR;
DEBUGLOG(("BOBalance:RestoreSebBalance:FindBalanceByCcy ERROR!!!\n"));
				break;
			}

			iCnt++;
			hRec = RecordSet_GetNext(rRecordSet);
		}

		for(i=0; i<iCnt; i++){
			sprintf(csTag,"txn_ccy_%d",i);
			if(GetField_CString(hTxn,csTag,&csFromCcy)){
				PutField_CString(hTxn,"from_ccy",csFromCcy);
DEBUGLOG(("BOBalance:RestoreSebBalance:[%s][%s]\n",csFromCcy,csToCcy));
			}
			sprintf(csTag,"rate_%d",i);
			if(GetField_Double(hTxn,csTag,&dTmp)){
				PutField_Double(hTxn,"rate",dTmp);
DEBUGLOG(("BOBalance:RestoreSebBalance:new rate=[%lf]\n",dTmp));
			}
			sprintf(csTag,"amt_%d",i);
			if(GetField_Double(hTxn,csTag,&dTmp)){
				dRatio = newround((dTmp/dCalRatio_D),PD_ROUND_UP_DEC);
				PutField_Double(hTxn,"ratio",dRatio);
DEBUGLOG(("BOBalance:RestoreSebBalance:new ratio=[%lf]\n",dRatio));

				PutField_Double(hTxn,"bank_bal",dTmp);
DEBUGLOG(("BOBalance:RestoreSebBalance:new bank_bal=[%lf]\n",dTmp));
			}

DEBUGLOG(("BOBalance:RestoreSebBalance:Update SebBalance table\n"));
			DBObjPtr = CreateObj(DBPtr,"DBSebBalance","Add");
			iRet = (unsigned long)(*DBObjPtr)(hTxn);

		}
	}
	

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	RecordSet_Destroy(rSeb_RecordSet);
	FREE_ME(rSeb_RecordSet);
	FREE_ME(hTxn);
	return iRet;
}
