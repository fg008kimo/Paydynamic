/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/07/30              Cody Chan
Log down none same date response transaction	   2010/11/16		   Cody Chan
handle bounce backup transaction		   2010/11/24		   Cody Chan
update handling FERESP msg			   2011/01/17		   LokMan Chow
add encrypt type				   2011/02/09		   LokMan Chow
add client ip & service code			   2011/02/18		   LokMan Chow
add VerifyMAC					   2011/04/12		   Cody Chan
add UpdateIntransit & DebitPayoutAmount		   2011/05/13		   LokMan Chow
Move	Gen/VerifyPSPSign to BOSecurity		   2011/05/24		   Cody Chan
handle payout resp				   2011/09/21		   LokMan Chow
51Epay Supported				   2011/11/10		   Cody Chan
Add Txn Req Counter				   2012/01/17		   Cody Chan
Change TxnFee to TxnElement			   2012/01/31		   Cody Chan
Handle manual approve date			   2012/03/28		   Virginia Yun
Shengpay Supported				   2012/04/20		   Cody Chan
Add Reply to psp reply queue			   2012/06/13		   Cody Chan
update process_payout_resp_txn			   2012/11/23		   LokMan Chow
Change the way to log approval_date		   2013/06/11		   Cody Chan
Allow refresh page to PSP (DSR with status='W')	   2013/07/19		   LokMan Chow
Add ECPSS					   2013/09/03		   Cody Chan
update context also get v.p. parameters		   2013/10/03		   LokMan Chow
remove v.p. parameters				   2013/10/16		   LokMan Chow
Add PFTTOM					   2013/12/10		   LokMan Chow
Add EPLUTUS, skip update status for resp '1'
        Add UniPay                                 2014/07/04              LokMan Chow
Add HNAPay and BAOFOO                              2014/07/24              LokMan Chow
Add TenPay					   2014/09/26              LokMan Chow
Add ReaPay                                         2015/03/10              Cody Chan
Add YeePay Mobile                                  2015/08/03              LokMan Chow
Add YsePay 					   2016/06/28              LokMan Chow
Add HeePay					   2016/08/24		   LokMan Chow
Add ECPSS Mobile				   2016/09/30		   David Wong
Add WeChatPay					   2016/11/29 		   David Wong
Add XJ-Ehk					   2016/12/14		   David Wong
Add Now2Pay					   2016/12/22		   David Wong
Add EASYPAY-AIPWechat				   2017/01/09		   David Wong
Make Response when NACK 			   2017/03/07		   Virginia Yun
Add Now2Pay-AIPWechat				   2017/04/03		   David Wong
Add XJ-CHWechat					   2017/07/06		   David Wong
Add XJ Mobile					   2017/07/14		   David Wong
Add Unipaygo Wechat				   2017/09/12		   David Wong
Add XJ-JINHAI QR				   2017/09/28		   David Wong
Add PayLink-Dinpay				   2017/10/25		   David Wong
Add Cloud123Pay					   2017/11/07		   David Wong
Add PayLink-Dinpay QR				   2017/11/16		   David Wong
Add XJ-Ehk new API				   2017/11/28		   David Wong
Add STAR-KKPay EC				   2017/12/08		   David Wong
Add PayLink-RFPay EC				   2017/12/11		   David Wong
Add TZ-CoalaPay EC				   2017/12/15		   David Wong
Add STAR-KKPay QR				   2018/01/12		   David Wong
Add STAR-KKPay VNET				   2018/01/23		   David Wong
Add EASYPAY-OpenePay				   2018/01/25		   David Wong
Add SHANFU-SFPay EC				   2018/02/06		   David Wong
*/



#include <stdio.h>
#include <stdlib.h>
#include <strings.h>
#include <string.h>
#include <ctype.h>
#include "queue_utility.h"
#include "WEBChannel.h"
#include "utilitys.h"
#include "common.h"
#include "ObjPtr.h"
#include "myrecordset.h"
#include "internal.h"
#include "mydb.h"
#include "mq_db.h"
#include "dbutility.h"
#include "langconvert.h"

#define	PD_ACK_RESEND	"resend_web_rck.sh"
char	cDebug;

void WEBChannel(char	cdebug)
{
	cDebug = cdebug;
}


OBJPTR(DB);
OBJPTR(DB2);
OBJPTR(Msg);
OBJPTR(Txn);
OBJPTR(BO);

int     UpdateContext(hash_t* hContext);
int     AddTxnLog(const hash_t *hContext,
              const hash_t* hRequest);
int     UpdateTxnLog(const hash_t *hContext,
                const hash_t* hRequest,
                const hash_t* hResponse);

int     UpdateTxnPspDetailLog(hash_t *hContext,
                const hash_t* hRequest,
                const hash_t* hResponse);
int     process_input_txn(hash_t *hContext,
                                const hash_t *Request,
                                hash_t *Response);
int     process_input_batch_txn(hash_t *hContext,
                                const hash_t *Request,
                                hash_t *Response);
int     process_resp_txn(hash_t *hContext,
			   	const hex_t* inMsg,
				hex_t *outMsg);

int     process_WEB_bounce_txn(hash_t *hContext,
			   	const hex_t* inMsg,
				hex_t *outMsg);
int     process_payout_resp_txn(hash_t *hContext,
                                const hash_t *hRequest,
                                hash_t *hResponse);
int     UpdatePayoutRespTxnLog(hash_t *hContext,
                const hash_t* hRequest,
                const hash_t* hResponse);

int     process_network_txn(hash_t *hContext,
                                const hash_t *Request,
                                hash_t *Response);

int	GetClientID(hash_t *hContext,
				const hash_t *hRequest);

int	process_txn(hash_t *hContext,
			   	const hex_t* inMsg,
				hex_t *outMsg)
{
	hex_t   *h_msg;
	struct msg_t* msg;
	hash_t	*hRequest,*hResponse;

	long	lResponseQueueMtype;
	long    lKey;


	int	iRet = INT_NO_ERR;
	int     iInternalErr = 0;
	int     iTmp = 0;

	char*	csTxnSeq;
	char*	csChannelCode;
	char*	csTxnCode;
	char*	csTxnDesc;
	char*	csProcessType;
	char*	csProcessCode;
	char*	csBuf;
	char	cTxnType;
	char*	csMerchantId;
	char*	csMerchantRef;
	char*	csPtr;
	
DEBUGLOG(("process_txn\n"));

DEBUGLOG(("msg len = [%d]\n",inMsg->len));
	hRequest = (hash_t*) malloc (sizeof(hash_t));
	hResponse = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRequest,0);
	hash_init(hResponse,0);

	csTxnCode = (char*) malloc (PD_TXN_CODE_LEN +1 );
	csTxnDesc = (char*) malloc (PD_DESC_LEN + 1);

	GetField_Char(hContext,"txn_type",&cTxnType);
DEBUGLOG(("txn type = [%c]\n",cTxnType));


	PutField_Char(hContext,"dont_convert",PD_DOPD_CONVERT);
	if (GetField_Long(hContext,"response_queue_mtype",&lResponseQueueMtype)) {
DEBUGLOG(("response queue mtype = [%ld]\n",lResponseQueueMtype));
	}
	else  {
DEBUGLOG(("unable to get response queue mtype\n"));
		iRet = PD_ERR;
	}
	if (GetField_CString(hContext,"channel_code",&csChannelCode)) {
/* set default return channel code */
		PutField_CString(hResponse,"channel_code",csChannelCode);
DEBUGLOG(("channel code = [%s]\n",csChannelCode));
	}
	else  {
DEBUGLOG(("unable to get channel code queue mtype\n"));
		iRet = PD_ERR;
	}
	if (cTxnType ==  MQ_RESP ) {
                iRet  = (UpdateContext(hContext));
DEBUGLOG(("updatecontext = [%d]\n",iRet));
		if (iRet == PD_OK) {	
DEBUGLOG(("call process_resp_txn\n"));
			return process_resp_txn(hContext,inMsg,outMsg);
		}
		else 
			return iRet;
		
	}
	else if (cTxnType == MQ_BOUNCE_BACK) {
DEBUGLOG(("Bounce Backup Txn!!!\n"));
		return process_WEB_bounce_txn(hContext,inMsg,outMsg);
	}

/* Set define return channel */
	PutField_CString(hContext,"channel_code",csChannelCode);
	if (iRet == PD_OK) {
DEBUGLOG(("Call WebMsg [%d]\n",inMsg->len));
        	MsgObjPtr = CreateObj(MsgPtr,"WebMsg","BreakDownMsg");
        	if ((*MsgObjPtr)(hRequest,inMsg->msg,inMsg->len) != PD_OK)  {
               		iRet = INT_BREAKDOWN_ERR;
                	PutField_Int(hContext,"internal_error",iRet);
ERRLOG("BreakDown WEBMsg Error\n");
DEBUGLOG(("process_txn:BreakDown WEBMsg Error\n"));
        	}
	}
        if (iRet == PD_OK) {
                iRet  = (UpdateContext(hContext));
        }


        if (iRet == PD_OK) {
/* Find Txn Code */
                if (GetField_CString(hRequest,"process_type",&csProcessType)) {
DEBUGLOG(("process_txn:process_type = [%s]\n",csProcessType));
                }
                if (!GetField_CString(hRequest,"process_code",&csProcessCode)) {
                        csProcessCode = strdup("000000");
                }
DEBUGLOG(("process_txn:process_code = [%s]\n",csProcessCode));

                DBObjPtr = CreateObj(DBPtr,"DBTxnCode","FindTxnCode");
                if (!(*DBObjPtr)(csTxnCode,
                                 csTxnDesc,
                                 csProcessType,
                                 csProcessCode)) {
                        iRet = INT_INVALID_TXN;
                        PutField_Int(hContext,"internal_error",INT_INVALID_TXN);
DEBUGLOG(("process_txn:Can't Find TxnCode\n"));
ERRLOG("WEBChannel:Unsupported transaction [%s][%s]\n",csProcessType,csProcessCode);
                }
                else {
DEBUGLOG(("try to create obj 3\n"))
                        PutField_CString(hContext,"txn_code",csTxnCode);
                        PutField_CString(hContext,"txn_desc",csTxnDesc);
                        PutField_CString(hResponse,"txn_code",csTxnCode);
DEBUGLOG(("process_txn:TxnCode = [%s]\n",csTxnCode));
DEBUGLOG(("process_txn:TxnDesc = [%s]\n",csTxnDesc));
                }
//Response Process Type
		csProcessType[PD_PROCESS_TYPE_LEN-1] = PD_PROCESS_TYPE_RESP_CODE;
		PutField_CString(hResponse,"process_type",csProcessType);
        }
	


	if ((iRet == PD_OK) && strcmp(csTxnCode,PD_INITIAL_REQ_TXN_CODE)) {
               	if (!GetField_CString(hRequest,"merchant_id",&csMerchantId)) {
DEBUGLOG(("Merchant Id Not found\n"));
               	}
DEBUGLOG(("Merchant Id = [%s]\n",csMerchantId));

               	if (!GetField_CString(hRequest,"merchant_ref",&csMerchantRef)) {
DEBUGLOG(("Merchant Ref Not Found\n"));
               	}
DEBUGLOG(("Merchant Ref = [%s]\n",csMerchantRef));
//txn seq 
        	GetField_CString(hContext,"txn_seq",&csTxnSeq);

/* VerifyMac */
		char*	csMac;
		char*	csAuthData;
                if (GetField_CString(hRequest,"mac",&csMac) &&
                   GetField_CString(hRequest,"auth_data",&csAuthData))
		{
DEBUGLOG(("Authorize() mac =[%s]\n",csMac));
DEBUGLOG(("Authorize() auth_data =[%s]\n",csAuthData));
			if (!memcmp(csProcessType,PD_PROCESS_TYPE_NETWORK,3)) {
DEBUGLOG(("Authorize() try to VerifyNetworkMac() [%s]\n",csProcessType));
                        	BOObjPtr = CreateObj(BOPtr,"BOSecurity","VerifyNetworkMac");
			}
			else {
DEBUGLOG(("Authorize() try to VerifyMac() [%s]\n",csProcessType));
                        	BOObjPtr = CreateObj(BOPtr,"BOSecurity","VerifyMac");
			}
               		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest,hResponse);
			if (iRet != PD_OK) {
DEBUGLOG(("WEBChannel:Authorize() Invalid MAC, txn id [%s] dropped\n",csTxnSeq));
ERRLOG("WEBChannel:Authorize() Invalid MAC, txn id [%s] dropped\n",csTxnSeq);
			}
                }
                else{
                        iRet = INT_MAC_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",INT_MAC_NOT_FOUND);
DEBUGLOG(("Authorize() mac not found\n"));
ERRLOG(("WEBChannel::Authorize() mac not found\n"));
                }


		if (iRet == PD_OK ) {
			MsgObjPtr = CreateObj(MsgPtr,"WebMsg","initReplyFromRequest");
               		if ((*MsgObjPtr)(hRequest,hResponse) != PD_OK)  {
                       		iRet = INT_BREAKDOWN_ERR;
                       		PutField_Int(hContext,"internal_error",iRet);
               		}
		}



	}
	if (iRet == PD_OK) {
/* network txn */
		if (!memcmp(csProcessType,PD_PROCESS_TYPE_NETWORK,3)) {
                	iRet = process_network_txn(hContext,hRequest,hResponse);
		}
		else {
			if (strcmp(csTxnCode,PD_INITIAL_REQ_TXN_CODE)) {
               			DBObjPtr = CreateObj(DBPtr,"DBTransaction","MatchMerchantRef");
               			if ((unsigned long)(DBObjPtr)(csMerchantId,csMerchantRef) == PD_FOUND) {
                       			iRet = INT_DUP_MERCHANT_REF;
                       			PutField_Int(hContext,"internal_error",INT_DUP_MERCHANT_REF);
ERRLOG("Channel:[WEB] - MerchantId[%s][%s]Duplicate Merchant Ref\n",csMerchantId,csMerchantRef);
DEBUGLOG(("Channel:[WEB] - MerchantId[%s][%s]Duplicate Merchant Ref\n",csMerchantId,csMerchantRef));

					GetClientID(hContext, hRequest);
               				AddTxnLog(hContext,hRequest);
               			}

				if (iRet == PD_OK ) {
					GetClientID(hContext, hRequest);
       	        			iRet = AddTxnLog(hContext,hRequest);
       				}
			}
			else {//if (!strcmp(csTxnCode,PD_INITIAL_REQ_TXN_CODE)) {
DEBUGLOG(("process_txn::Try to match txn\n"));
		
				char*	csPtr;
       		 		if (GetField_CString(hRequest,"org_encrypted_txn_seq",&csPtr)) {
DEBUGLOG(("process_txn::org encrypted txn seq  = [%s]\n",csPtr));
       	        		 	BOObjPtr = CreateObj(DBPtr,"BOSecurity","Decrypt3DESTxnSeq");
       	        		 	char* csTmpBuf;
					char csOrgTxnSeq[PD_TXN_SEQ_LEN +1];
       	        		 	csTmpBuf = (char*) malloc (PD_EN_TXN_SEQ_LEN +1);
       	        		 	(BOObjPtr)(csPtr,csTmpBuf);
       	        			strcpy(csOrgTxnSeq,csTmpBuf);
DEBUGLOG(("process_txn:org txn seq = [%s]\n",csOrgTxnSeq));
       	        		 	FREE_ME(csTmpBuf);


DEBUGLOG(("process_txn:: call MatchRespTxn\n"));
					DBObjPtr = CreateObj(DBPtr,"DBTransaction","MatchRespTxn");
       	        		 	if ((unsigned long)(DBObjPtr)(csOrgTxnSeq,PD_INIT) != PD_FOUND) {

					/* check status = W*/
DEBUGLOG(("process_txn:: call GetTxnHeader, check if status = 'W'\n"));
						char	cPtr;
						hash_t  *hRec;
						recordset_t     *rRecordSet;
						rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
						recordset_init(rRecordSet,0);

						char    *csPtrIPAddr;
						DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
						if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("process_txn::found record = [%s]\n",csOrgTxnSeq));
							hRec = RecordSet_GetFirst(rRecordSet);
							while (hRec) {
								if (GetField_Char(hRec,"status",&cPtr)){
DEBUGLOG(("process_txn::status = [%c]\n",cPtr));
									if(cPtr==PD_TO_PSP){
										PutField_CString(hContext,"org_txn_seq",csOrgTxnSeq);
										TxnObjPtr = CreateObj(TxnPtr,"TxnMgtByUsTSI","ResendToPsp");
										iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
										if(iRet == PD_RESEND_TO_PSP){
											iRet = PD_SKIP_OK;
											PutField_CString(hContext,"from_txn_seq",csOrgTxnSeq);
											PutField_Int(hContext,"not_update_log",PD_TRUE);
										}
										else{
											PutField_Int(hContext,"internal_error",iRet);
											PutField_Int(hContext,"not_update_log",PD_TRUE);
DEBUGLOG(("process_txn: TxnMgtByUsTSI: ResendToPsp failed = [%d]\n",iRet));
ERRLOG("WEBChannel:process_txn: TxnMgtByUsTSI: ResendToPsp failed = [%d]\n",iRet);
										}
										RemoveField_CString(hContext,"org_txn_seq");
									}
									else{
										iRet = INT_TXN_ID_NOT_FOUND;
										PutField_Int(hContext,"internal_error",iRet);
										PutField_Int(hContext,"not_update_log",PD_TRUE);
DEBUGLOG(("process_txn: org txn id record [%s] not found for status = [%c]\n",csOrgTxnSeq,PD_INIT));
ERRLOG("WEBChannel:process_txn: org txn id record [%s] not found for status = [%c]\n",csOrgTxnSeq,PD_INIT);
									}
								}

								if (GetField_CString(hRec, "ip_addr", &csPtrIPAddr)) {
DEBUGLOG(("process_txn: set ip_addr [%s]\n", csPtrIPAddr));
                                                                                PutField_CString(hContext, "org_ip_addr", csPtrIPAddr);
                                                                }

								hRec = RecordSet_GetNext(rRecordSet);
							}
       	        		                 }
						RecordSet_Destroy(rRecordSet);
						FREE_ME(rRecordSet);
				///
       	        		 	}
				}
			}
			if (iRet == PD_OK) {
/* add default psp_pd to avoid insert error */
				PutField_CString(hContext,"psp_id",PD_DEFAULT_PSP);
				if (strcmp(csTxnCode, PD_WITHDRAW_BATCH_TXN_CODE))  //none batch
               			 	iRet = process_input_txn(hContext,hRequest,hResponse);
				else  {
               	 		iRet = process_input_batch_txn(hContext,hRequest,hResponse);
				}
        		}

			if(iRet == PD_SKIP_OK){
				iRet = PD_OK;
			}
	
			if (strcmp(csTxnCode, PD_WITHDRAW_BATCH_TXN_CODE))   {//none batch
				if (iRet == PD_OK || GetField_Int(hContext,"internal_error",&iInternalErr))  {

		 			csBuf = (char*) malloc (128);
       	        			sprintf(csBuf,"%d",iInternalErr);
       	        		 	PutField_CString(hResponse,"response_code",csBuf);
DEBUGLOG(("Result_Code = %s iInternetalErr = [%d]\n",csBuf,iInternalErr));
       	        		 	FREE_ME(csBuf);
                //PutField_Char(hContext,"ar_ind",PD_ACCEPT); /* update until come back PSP */
       	        		 	PutField_Char(hContext,"status",PD_TO_PSP);
       	        		 	PutField_Int(hContext,"internal_code",iInternalErr);

       	        		 	if (iInternalErr != 0 ) {
DEBUGLOG(("*****Format Out Reject Message\n"));
       	        		         	PutField_Char(hContext,"ar_ind",PD_REJECT);
       	        		         	PutField_Char(hResponse,"ar_ind",PD_REJECT);
       	        		 		PutField_Char(hContext,"status",PD_COMPLETE);
       	        		 		PutField_Char(hResponse,"status",PD_COMPLETE);
						iRet = PD_OK;

						char* csPspChannel;
						char* csTmp;
						if (GetField_CString(hContext,"psp_channel_code",&csPspChannel)) {
DEBUGLOG(("Format out psp_channel_code = [%s]\n",csPspChannel));
							if (!strcmp(csPspChannel,PD_CHANNEL_WECHATPAY)
								|| !strcmp(csPspChannel,PD_CHANNEL_AIPWECHAT)
								|| !strcmp(csPspChannel,PD_CHANNEL_N2P_AIPWECHAT)
								|| !strcmp(csPspChannel,PD_CHANNEL_XJ_CHWECHAT)
								|| !strcmp(csPspChannel,PD_CHANNEL_UNIPAY_WECHAT)
								|| !strcmp(csPspChannel,PD_CHANNEL_XJ_JINHAI_QR)
								|| !strcmp(csPspChannel,PD_CHANNEL_DINPAY_QR)
								|| !strcmp(csPspChannel,PD_CHANNEL_STAR_KKPAY_QR)
							) {
								iInternalErr = INT_NO_ERR;
								PutField_CString(hResponse,"return_code","FAIL");
								if (GetField_CString(hResponse,"code_url",&csTmp)) {
									RemoveField_CString(hResponse,"code_url");
								}
							}
						}
       	        		 	}
       	        		 	else {
       	        		         	iInternalErr = INT_NO_ERR;

						if (!strcmp(csTxnCode, PD_INITIAL_TXN_CODE))    {// initial
							PutField_Char(hResponse,"status",PD_INIT);
							PutField_Char(hContext,"status",PD_INIT);
       	        		 			PutField_CString(hContext,"sub_status",PD_HAND_SHAKEN);
						}
						else if (!strcmp(csTxnCode, PD_MOBILE_DSP_CODE)) { //mobile payment
							if (GetField_CString(hContext,"sc",&csPtr)) {
DEBUGLOG(("Format out SC = [%s]\n",csPtr));
								PutField_CString(hResponse,"sc",csPtr);
							}
							if (GetField_CString(hContext,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("Format out MID = [%s]\n",csPtr));
								PutField_CString(hResponse,"psp_merchant_id",csPtr);
							}
							PutField_Char(hResponse,"status",PD_TO_PSP);
							PutField_Char(hContext,"status",PD_TO_PSP);
       	        		 			PutField_CString(hContext,"sub_status",PD_SENT_TO_PSP);
						}
						else {
       	        		 			PutField_Char(hResponse,"status",PD_TO_PSP);
       	        		 			PutField_CString(hContext,"sub_status",PD_SENT_TO_PSP);


/* tO ESKY Request */
							char* csPspChannel;
							if (GetField_CString(hContext,"psp_channel_code",&csPspChannel)) {
DEBUGLOG(("** PSP_ID = [%s]\n",csPspChannel));
								char* csMethod;
								char* csPspUrl;
       	        		                                char* csRequestFunction;
       	        	                                 	char  csTmpBuf[PD_TMP_BUF_LEN + 1];
       		                                         	GetField_CString(hContext,"psp_url",&csPspUrl);
       		                                    	     	GetField_CString(hContext,"request_function",&csRequestFunction);
       		                                         	sprintf(csTmpBuf,"%s/%s",csPspUrl,csRequestFunction);


/* don't override the redirect_url if twv or paygen*/
								if (strcmp(csPspChannel,PD_CHANNEL_TWV) && 
							    		strcmp(csPspChannel,PD_CHANNEL_PGEN) &&
							    		strcmp(csPspChannel,PD_CHANNEL_51EPAY) &&
									strcmp(csPspChannel,PD_CHANNEL_TENMOBPAY) &&
									strcmp(csPspChannel,PD_CHANNEL_XJP) &&
									strcmp(csPspChannel,PD_CHANNEL_COALAPAY_EC))
       		                                         		PutField_CString(hResponse,"redirect_url",csTmpBuf);

								if(GetField_CString(hResponse,"redirect_url",&csPtr)){
DEBUGLOG(("redirect_url = [%s]\n",csPtr));
								}
       	                                			if (GetField_CString(hContext,"url_method",&csMethod)) {
DEBUGLOG(("url_method = [%s]\n",csMethod));
       		                                  			PutField_CString(hResponse,"url_method",csMethod);
       	                                			}

								if(GetField_CString(hContext,"psp_passphrase",&csPtr)){
									if (!strcmp(csPspChannel,PD_CHANNEL_HNAPAY))
										PutField_CString(hResponse,"buyer_marked",csPtr);
									else if (!strcmp(csPspChannel,PD_CHANNEL_BAOFOO))
										PutField_CString(hResponse,"terminal_id",csPtr);
									else if (!strcmp(csPspChannel,PD_CHANNEL_STAR_KKPAY_EC) ||
										 !strcmp(csPspChannel,PD_CHANNEL_STAR_KKPAY_VNET)
									)
										PutField_CString(hResponse,"psp_product_name",csPtr);
								}

								if (!strcmp(csPspChannel,PD_CHANNEL_HPAY) || !strcmp(csPspChannel,PD_CHANNEL_LKPAY)
							      		|| !strcmp(csPspChannel,PD_CHANNEL_HHPAY)
							      		|| !strcmp(csPspChannel,PD_CHANNEL_GOPAY)
							      		|| !strcmp(csPspChannel,PD_CHANNEL_HAIPAY)
							      		|| !strcmp(csPspChannel,PD_CHANNEL_HPAY_CNP)) {
       	                                        	 		PutField_CString(hResponse,"recvenctype","01");
       		                         			}

								if (!strcmp(csPspChannel,PD_CHANNEL_TENPAY)) {
									PutField_CString(hResponse,"fee_type", "1");

									if (GetField_CString(hContext, "org_ip_addr", &csPtr)) {
DEBUGLOG(("client_ip = [%s]\n", csPtr));
										PutField_CString(hResponse, "spbill_create_ip", csPtr);
									}
								}
								if (!strcmp(csPspChannel,PD_CHANNEL_YEEPAYMOBILE)) {
									if (GetField_CString(hContext,"customer_tag",&csPtr)) {
										PutField_CString(hResponse,"customer_tag",csPtr);
									}
									if (GetField_CString(hContext, "org_ip_addr", &csPtr)) {
										PutField_CString(hResponse, "userip", csPtr);
									}
									else if(GetField_CString(hRequest, "ip_addr", &csPtr)){
										PutField_CString(hResponse, "userip", csPtr);
									}
								}
								if (!strcmp(csPspChannel,PD_CHANNEL_YSEPAY)) {
									if (GetField_CString(hContext, "psp_key", &csPtr)) {
										PutField_CString(hResponse, "psp_merch_name", csPtr);
									}
								}
								if (!strcmp(csPspChannel,PD_CHANNEL_HEEPAY) ||
								    !strcmp(csPspChannel,PD_CHANNEL_XJE) ||
								    !strcmp(csPspChannel,PD_CHANNEL_STAR_KKPAY_EC) ||
								    !strcmp(csPspChannel,PD_CHANNEL_RFPAY_EC) ||
								    !strcmp(csPspChannel,PD_CHANNEL_STAR_KKPAY_VNET)
								) {
									if (GetField_CString(hContext, "org_ip_addr", &csPtr)) {
										PutField_CString(hResponse, "user_ip", csPtr);
									}
								}

/*Generate PSP sign */
								BOObjPtr = CreateObj(BOPtr,"BOSecurity","GeneratePspSign");
       		         					iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest,hResponse);
DEBUGLOG(("BOSecurity->GeneratePspSign = [%d]\n",iRet));

							}
						}

					}

				}
			}
		}
			
	}
DEBUGLOG(("Build Auth Data\n"));
	if ((iRet == PD_OK) || (!memcmp(csProcessType,PD_PROCESS_TYPE_NETWORK,3) && GetField_Int(hContext,"network_txn_msg",&iTmp))) {

		if (!memcmp(csProcessType,PD_PROCESS_TYPE_NETWORK,3)) {
			MsgObjPtr = CreateObj(MsgPtr,"WebMsg","BuildNetworkRespAuthData");
		} else {
			MsgObjPtr = CreateObj(MsgPtr,"WebMsg","BuildRespAuthData");
		}

       		iRet = (unsigned long)(*MsgObjPtr)(hResponse);
/*skip gen mac if PD_INITIAL_REQ_TXN_CODE */
		if (iRet == PD_OK && strcmp(csTxnCode,PD_INITIAL_REQ_TXN_CODE)) {
/* Generate MAC */
			if (!memcmp(csProcessType,PD_PROCESS_TYPE_NETWORK,3)) {
          			BOObjPtr = CreateObj(BOPtr,"BOSecurity","GenerateNetworkMac");
			}
			else {
          			BOObjPtr = CreateObj(BOPtr,"BOSecurity","GenerateMac");
			}
               		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest,hResponse);
		}
			

               	if (iInternalErr != 0 && !(strcmp(csTxnCode,PD_INITIAL_REQ_TXN_CODE)) ) {
				MsgObjPtr = CreateObj(MsgPtr,"WebMsg","FormatFEMsg");
		}else {
			MsgObjPtr = CreateObj(MsgPtr,"WebMsg","FormatMsg");
		}
               	h_msg = (hex_t*) malloc (sizeof(hex_t));
               	if ((*MsgObjPtr)(hResponse,h_msg->msg,&h_msg->len) == PD_OK) {

			if (memcmp(csProcessType,PD_PROCESS_TYPE_NETWORK,3)) {
	               		iRet = UpdateTxnLog(hContext,hRequest,hResponse);
			}

/* update req txn counter */
			if (iRet == PD_OK) {
				char	cStatus;
				if (GetField_Char(hContext,"status",&cStatus)) {
DEBUGLOG(("before update txn counter status = [%c]\n",cStatus));
				}
				if (cStatus == PD_TO_PSP && (!strcmp(csTxnCode,PD_INITIAL_REQ_TXN_CODE) || !strcmp(csTxnCode,PD_DEPOSIT_TXN_CODE))) {
DEBUGLOG(("before update txn counter!\n"));
                  			BOObjPtr = CreateObj(BOPtr,"BOStat","UpdateDspReqStat");
                        		if ((BOObjPtr)(hContext,hRequest,hResponse) == PD_OK) {
                        			BOObjPtr = CreateObj(BOPtr,"BOStat","UpdateDspReqMerchantStat");
                        			(BOObjPtr)(hContext,hRequest,hResponse);
					}
				}
			}

/************************/
       		}
		else {
DEBUGLOG(("FormatMsg error\n"));
		}
		
		if(iRet == PD_SKIP_OK){
			iRet = PD_OK;
		}
//DEBUGLOG(("h_msg->len = [%d]\n",h_msg->len));
		if (iRet == PD_OK) {
			GetField_Long(hContext,"queue_key",&lKey);
DEBUGLOG(("h_msg->msg = [%s]\n",h_msg->msg));
DEBUGLOG(("h_msg->len = [%d] key = [%ld]\n",h_msg->len,lKey));
			msg = (struct msg_t*)malloc(sizeof(struct msg_t)+MAX_MSG_SIZE);
			msg->mtype  = lResponseQueueMtype;
			long	lRemoteKey = 0l;
			GetField_Long(hContext,"remote_reply_key",&lRemoteKey);
      			memset(msg->mtext,0,sizeof(msg->mtext));
       			MQ_build_header((unsigned char*)msg->mtext,
              			MQ_RESP,
               			csChannelCode,
				0,
				NULL,
				lRemoteKey);
              		memcpy(&msg->mtext[MQ_HEADER_LEN],h_msg->msg,h_msg->len);
               		msg->mtext[MQ_HEADER_LEN + h_msg->len] = '\0';
DEBUGLOG(("send len = [%d]\n",MQ_HEADER_LEN + h_msg->len));

               		iRet = MQSend(lKey,msg,MQ_HEADER_LEN + h_msg->len);

			FREE_ME(h_msg);
          		FREE_ME(msg);
		}
	}
	else {
ERRLOG("WEBCHANNEL internal error? [%d]\n",iRet);
	}

//NLOG("[%s]Normal RET = [%d]{%s[%s]}\n",csTxnSeq,iRet,csTxnCode,csChannelCode);
	FREE_ME(hRequest);
	FREE_ME(hResponse);
	FREE_ME(csTxnCode);
	FREE_ME(csTxnDesc);
	return iRet;
}


int     process_input_txn(hash_t *hContext,
                                const hash_t *Request,
                                hash_t *Response)
{
        int     iRet = PD_OK;
        char*   csTxnCode = NULL;
	char*	csHandler = NULL;
DEBUGLOG(("process_input\n"));
        if (GetField_CString(hContext,"txn_code",&csTxnCode)) {
DEBUGLOG(("process_input_txn:txn_code = [%s]\n",csTxnCode));
        }
        else {
                iRet = PD_ERR;
DEBUGLOG(("process_input_txn:txn_code not found\n"));
        }

        if (iRet == PD_OK && strcmp(csTxnCode,PD_INITIAL_REQ_TXN_CODE)) {
        	TxnObjPtr = CreateObj(TxnPtr,"TxnWebOnUsCOM","Authorize");
                iRet = (unsigned long)(*TxnObjPtr)(hContext,Request,Response);
        }
        if (iRet == PD_OK ) {
                csHandler = (char*) malloc (20);
                sprintf(csHandler,"TxnWebOnUs%s",csTxnCode);
DEBUGLOG(("process_input_txn Create Txn Object [%s]\n",csHandler));
                TxnObjPtr = CreateObj(TxnPtr,csHandler,"Authorize");
                FREE_ME(csHandler);

                iRet = (unsigned long)(*TxnObjPtr)(hContext,Request,Response);
DEBUGLOG(("iRet = [%d]\n",iRet));
        }

        FREE_ME(csTxnCode);
DEBUGLOG(("process_input() exit iRet = [%d]\n",iRet));
        return iRet;
}



int     UpdateContext(hash_t* hContext)
{
	int	iRet = PD_OK;
        long    lKey;
	//hash_t  *hRec;
	//char    *csCode;
        //char    *csValue;
	char*	csQueueName;
	double	dTmp = 0.0;
	//int	iGetVPParameter = PD_FALSE;
	//char	cTmp;

        //recordset_t     *rRecordSet;
        //rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        //recordset_init(rRecordSet,0);

//        lKey = GetMQKey((unsigned char*)"WEBRSPQ");
	if (GetField_CString(hContext,"reply_queue",&csQueueName)) {
DEBUGLOG(("UpdateContext:reply queue = [%s]\n",csQueueName));
		lKey = GetMQKey((unsigned char*)csQueueName);
        	PutField_Long(hContext,"queue_key",lKey);
DEBUGLOG(("UpdateContext:reply queue key = [%ld]\n",lKey));
	}


/*
        DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetAllCodes");
        if ((*DBObjPtr)(rRecordSet) == PD_OK) {
DEBUGLOG(("UpdateContext: return \n"));
                hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {
                        if (GetField_CString(hRec,"code",&csCode)) {
                                if (GetField_CString(hRec,"value",&csValue)) {
                                        if (!strcmp(csCode,"CTPHDATE")) {
DEBUGLOG(("UpdateContext:Current Processor Hub Date= [%s]\n",csValue));
                                                PutField_CString(hContext,"PHDATE",csValue);
                                        }
                                }
                        }
                        hRec = RecordSet_GetNext(rRecordSet);
                }
        }
*/
	char csTmpDate[PD_DATETIME_LEN +1];
        DBObjPtr = CreateObj(DBPtr,"DBSystemControl","FindCode");

        if ((unsigned long)(*DBObjPtr)("CTPHDATE",csTmpDate) == FOUND) {
DEBUGLOG(("UpdateContext:Current Processor Hub Date= [%s]\n",csTmpDate));
        	PutField_CString(hContext,"PHDATE",csTmpDate);
	}
        else {
DEBUGLOG(("UpdateContext:NOT RECORD\n"));
                iRet = PD_ERR;
ERRLOG("UpdateContext::Internal Error:WEB Channel:SystemControl Record Not Found\n");
        }

	if (iRet == PD_OK) {
		char*	csValueTmp;
		csValueTmp = (char*) malloc (128);
        	DBObjPtr = CreateObj(DBPtr,"DBSystemParameter","FindCode");
                if ((unsigned long)(DBObjPtr)(PD_BASED_CCY,csValueTmp) == FOUND) {
DEBUGLOG(("UpdateContext::based ccy  = [%s]\n",csValueTmp));
                        PutField_CString(hContext,"based_ccy",csValueTmp);
                }
                else {
                        iRet = INT_ERR;
ERRLOG("UpdateContext::Unable to find based ccy\n");
                }

                if ((unsigned long)(DBObjPtr)(PD_DELTA_AMT_LOW,csValueTmp) == FOUND) {
			sscanf(csValueTmp, "%lf",&dTmp);
DEBUGLOG(("UpdateContext::delta amount range (low)  = [%lf]\n",dTmp));
                        PutField_Double(hContext,"delta_amt_low",dTmp);
                }
                if ((unsigned long)(DBObjPtr)(PD_DELTA_AMT_UP,csValueTmp) == FOUND) {
			sscanf(csValueTmp, "%lf",&dTmp);
DEBUGLOG(("UpdateContext::delta amount range (up)  = [%lf]\n",dTmp));
                        PutField_Double(hContext,"delta_amt_up",dTmp);
                }

		PutField_Int(hContext,"use_mobile_simulator",PD_FALSE);
                if ((unsigned long)(DBObjPtr)(PD_USE_MOBILE_SIMULATOR,csValueTmp) == FOUND) {
DEBUGLOG(("UpdateContext:: use mobile simulator = [%s]\n",csValueTmp));
			char cTmp = csValueTmp[0];
			if(cTmp==PD_YES)
				PutField_Int(hContext,"use_mobile_simulator",PD_TRUE);
                }
		FREE_ME(csValueTmp);
        }

        //RecordSet_Destroy(rRecordSet);
        //FREE_ME(rRecordSet);
        //FREE_ME(csCode);
        //FREE_ME(csValue);
        //FREE_ME(csQueueName);
DEBUGLOG(("UpdateContext::iRet = [%d]\n",iRet));

	return iRet;
}

                                        
int     AddTxnLog(const hash_t *hContext,
                const hash_t* hRequest)
{                       
        hash_t  *hTxn;
        hash_t  *hDetail;
        char    *csTmp = strdup("");
        int iRet = PD_OK;
	int	iTmp;

	//double	dTmp;
	char	cTmp;

        hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0); 
        hDetail= (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hDetail,0); 
        if (GetField_CString(hContext,"txn_seq",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_seq = [%s]\n",csTmp));
                PutField_CString(hTxn,"txn_seq",csTmp);
                PutField_CString(hDetail,"txn_seq",csTmp);
        
                PutField_CString(hTxn,"add_user",PD_UPDATE_USER);
                PutField_CString(hDetail,"add_user",PD_UPDATE_USER);

                if (GetField_CString(hContext,"org_txn_seq",&csTmp)) {
DEBUGLOG(("AddTxnLog:: org_txn_seq = [%s]\n",csTmp));
                        PutField_CString(hTxn,"org_txn_seq",csTmp);
                }
                                
                if (GetField_CString(hContext,"channel_code",&csTmp)) {
DEBUGLOG(("AddTxnLog:: channel_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"channel_code",csTmp);
                }
                if (GetField_CString(hContext,"txn_code",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"txn_code",csTmp);
                }
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("AddTxnLog:: host_posting_date = [%s]\n",csTmp));
                        PutField_CString(hTxn,"host_posting_date",csTmp);
                }
                if (GetField_CString(hContext,"local_tm_date",&csTmp)) {
DEBUGLOG(("AddTxnLog:: local_tm_date = [%s]\n",csTmp));
                        PutField_CString(hTxn,"local_tm_date",csTmp);
                }
                if (GetField_CString(hContext,"local_tm_time",&csTmp)) {
DEBUGLOG(("AddTxnLog:: local_tm_time = [%s]\n",csTmp));
                        PutField_CString(hTxn,"local_tm_time",csTmp);
                }

/**** From Request */
                if (GetField_CString(hRequest,"remark",&csTmp)) {
DEBUGLOG(("AddTxnLog:: Remark = [%s]\n",csTmp));
                        PutField_CString(hTxn,"remark",csTmp);
                }

                if (GetField_CString(hRequest,"process_type",&csTmp)) {
DEBUGLOG(("AddTxnLog:: process_type = [%s]\n",csTmp));
                        PutField_CString(hTxn,"process_type",csTmp);
                }

                if (GetField_CString(hRequest,"process_code",&csTmp)) {
DEBUGLOG(("AddTxnLog:: process_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"process_code",csTmp);
                }


/* merchant no */
                if (GetField_CString(hRequest,"merchant_id",&csTmp)) {
DEBUGLOG(("AddTxnLog:: merchant_id = [%s]\n",csTmp));
                        PutField_CString(hTxn,"merchant_id",csTmp);
                }
/* merchant ref */
                if (GetField_CString(hRequest,"merchant_ref",&csTmp)) {
DEBUGLOG(("AddTxnLog:: merchant_ref = [%s]\n",csTmp));
                        PutField_CString(hTxn,"merchant_ref",csTmp);
                }


                if (GetField_CString(hRequest,"transmission_datetime",&csTmp)) {
DEBUGLOG(("AddTxnLog:: transmission_datetime = [%s]\n",csTmp));
                        PutField_CString(hTxn,"transmission_datetime",csTmp);
                }

                if (GetField_CString(hRequest,"tm_date",&csTmp)) {
DEBUGLOG(("AddTxnLog:: tm_date = [%s]\n",csTmp));
                        PutField_CString(hTxn,"tm_date",csTmp);
                }
                if (GetField_CString(hRequest,"tm_time",&csTmp)) {
DEBUGLOG(("AddTxnLog:: tm_time = [%s]\n",csTmp));
                        PutField_CString(hTxn,"tm_time",csTmp);
                }

/* service code */
                if (GetField_CString(hRequest,"service_code",&csTmp)) {
DEBUGLOG(("AddTxnLog:: service_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"service_code",csTmp);
                }
/* client ip */
                if (GetField_CString(hRequest,"ip_addr",&csTmp)) {
DEBUGLOG(("AddTxnLog:: client_ip = [%s]\n",csTmp));
                        PutField_CString(hTxn,"ip_addr",csTmp);
                }
/* user_agent*/
                if (GetField_CString(hRequest,"user_agent",&csTmp)) {
DEBUGLOG(("AddTxnLog:: user_agent = [%s]\n",csTmp));
                        PutField_CString(hTxn,"user_agent",csTmp);
                }

/* client id */
                if (GetField_CString(hContext,"merchant_client_id",&csTmp)) {
DEBUGLOG(("AddTxnLog:: merchant_client_id = [%s]\n",csTmp));
                        PutField_CString(hTxn,"client_id",csTmp);
                }



/* add to detail ********************************/

/* txn ccy */
                if (GetField_CString(hRequest,"txn_ccy",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_ccy = [%s]\n",csTmp));
                        PutField_CString(hDetail,"txn_ccy",csTmp);
                }

/* txn country */
                if (GetField_CString(hRequest,"txn_country",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_country = [%s]\n",csTmp));
                        PutField_CString(hDetail,"txn_country",csTmp);
                }

/* pay method */
                if (GetField_CString(hRequest,"pay_method",&csTmp)) {
DEBUGLOG(("AddTxnLog:: pay_method  = [%s]\n",csTmp));
                        PutField_CString(hDetail,"pay_method",csTmp);
                }

/* bank code */
                //if (GetField_CString(hRequest,"bank_code",&csTmp)) {
                if (GetField_CString(hRequest,"internal_bank_code",&csTmp)) {
DEBUGLOG(("AddTxnLog:: bank_code = [%s]\n",csTmp));
                        PutField_CString(hDetail,"bank_code",csTmp);
                }
/* bank name */
                if (GetField_CString(hRequest,"bank_name",&csTmp)) {
DEBUGLOG(("AddTxnLog:: bank_name = [%s]\n",csTmp));
                        PutField_CString(hDetail,"bank_name",csTmp);
                }
/* branch_name */
                if (GetField_CString(hRequest,"branch_name",&csTmp)) {

//DEBUGLOG(("AddTxnLog:: branch_name = [%s]\n",csTmp));
                        PutField_CString(hDetail,"branch_name",csTmp);
                }

/* account_id */
                if (GetField_CString(hRequest,"account_id",&csTmp)) {
DEBUGLOG(("AddTxnLog:: account_id = [%s]\n",csTmp));
                        PutField_CString(hDetail,"account_id",csTmp);
                }
/* account_name */
                if (GetField_CString(hRequest,"account_name",&csTmp)) {
                        PutField_CString(hDetail,"account_name",csTmp);
                }

/* identity_id */
                if (GetField_CString(hRequest,"identity_id",&csTmp)) {
DEBUGLOG(("AddTxnLog:: identity_id = [%s]\n",csTmp));
                        PutField_CString(hDetail,"identity_id",csTmp);
                }


/* province */
                if (GetField_CString(hRequest,"province",&csTmp)) {
DEBUGLOG(("AddTxnLog:: province = [%s]\n",csTmp));
                        PutField_CString(hDetail,"province",csTmp);
                }

/* phone_no */
                if (GetField_CString(hRequest,"phone_no",&csTmp)) {
DEBUGLOG(("AddTxnLog:: phone_no = [%s]\n",csTmp));
                        PutField_CString(hDetail,"phone_no",csTmp);
                }
/* city */
                if (GetField_CString(hRequest,"city",&csTmp)) {
DEBUGLOG(("AddTxnLog:: city = [%s]\n",csTmp));
                        PutField_CString(hDetail,"city",csTmp);
                }


/* batch_id */
                if (GetField_CString(hRequest,"batch_id",&csTmp)) {
DEBUGLOG(("AddTxnLog:: batch_id = [%s]\n",csTmp));
                        PutField_CString(hDetail,"batch_id",csTmp);
                }

/* show paypage  */
                if (GetField_Char(hRequest,"show_paypage",&cTmp)) {
DEBUGLOG(("AddTxnLog:: show_paypage = [%c]\n",cTmp));
                        PutField_Char(hDetail,"show_paypage",cTmp);
                }

/* language  */
                if (GetField_CString(hRequest,"language",&csTmp)) {
DEBUGLOG(("AddTxnLog:: language = [%s]\n",csTmp));
                        PutField_CString(hDetail,"language",csTmp);
                }

/* success url  */
                if (GetField_CString(hRequest,"success_url",&csTmp)) {
DEBUGLOG(("AddTxnLog:: success_url = [%s]\n",csTmp));
                        PutField_CString(hDetail,"success_url",csTmp);
                }

/* failure url  */
                if (GetField_CString(hRequest,"failure_url",&csTmp)) {
DEBUGLOG(("AddTxnLog:: failure_url = [%s]\n",csTmp));
                        PutField_CString(hDetail,"failure_url",csTmp);
                }


/* success call back url  */
                if (GetField_CString(hRequest,"success_callback_url",&csTmp)) {
DEBUGLOG(("AddTxnLog:: success_callback_url = [%s]\n",csTmp));
                        PutField_CString(hDetail,"success_callback_url",csTmp);
                }

/* failure  call backurl  */
                if (GetField_CString(hRequest,"failure_callback_url",&csTmp)) {
DEBUGLOG(("AddTxnLog:: failure_callback_url = [%s]\n",csTmp));
                        PutField_CString(hDetail,"failure_callback_url",csTmp);
                }

/* encrypt type */
                if (GetField_CString(hRequest,"encrypt_type",&csTmp)) {
DEBUGLOG(("AddTxnLog:: encrypt_type = [%s]\n",csTmp));
                        PutField_CString(hDetail,"encrypt_type",csTmp);
                }

/* version_no */
                if (GetField_Int(hRequest,"version_no",&iTmp)) {
DEBUGLOG(("AddTxnLog:: version_no = [%d]\n",iTmp));
                        PutField_Int(hDetail,"version_no",iTmp);
                }

/* customer_tag */
                if (GetField_CString(hRequest,"customer_tag",&csTmp)) {
DEBUGLOG(("AddTxnLog:: customer_tag = [%s]\n",csTmp));
                        PutField_CString(hDetail,"customer_tag",csTmp);
                }
/* echo_msg1 */
                if (GetField_CString(hRequest,"echo_msg1",&csTmp)) {
DEBUGLOG(("AddTxnLog:: echo_msg1 = [%s]\n",csTmp));
                        PutField_CString(hDetail,"echo_msg_1",csTmp);
                }
/* echo_msg2 */
                if (GetField_CString(hRequest,"echo_msg2",&csTmp)) {
DEBUGLOG(("AddTxnLog:: echo_msg2 = [%s]\n",csTmp));
                        PutField_CString(hDetail,"echo_msg_2",csTmp);
                }
/* echo_msg3 */
                if (GetField_CString(hRequest,"echo_msg3",&csTmp)) {
DEBUGLOG(("AddTxnLog:: echo_msg3 = [%s]\n",csTmp));
                        PutField_CString(hDetail,"echo_msg_3",csTmp);
                }
/* opt_1 */
                if (GetField_CString(hRequest,"opt_1",&csTmp)) {
DEBUGLOG(("AddTxnLog:: opt_1 = [%s]\n",csTmp));
                        PutField_CString(hDetail,"opt_1",csTmp);
                }
/* opt_2 */
                if (GetField_CString(hRequest,"opt_2",&csTmp)) {
DEBUGLOG(("AddTxnLog:: opt_2 = [%s]\n",csTmp));
                        PutField_CString(hDetail,"opt_2",csTmp);
                }
/* opt_3 */
                if (GetField_CString(hRequest,"opt_3",&csTmp)) {
DEBUGLOG(("AddTxnLog:: opt_3 = [%s]\n",csTmp));
                        PutField_CString(hDetail,"opt_3",csTmp);
                }
/* remark */
                if (GetField_CString(hRequest,"remark",&csTmp)) {
DEBUGLOG(("AddTxnLog:: remark = [%s]\n",csTmp));
                        PutField_CString(hDetail,"remark",csTmp);
                }

/* customer_name */
                if (GetField_CString(hRequest,"customer_name",&csTmp)) {
DEBUGLOG(("AddTxnLog:: customer_name = [%s]\n",csTmp));
                        PutField_CString(hDetail,"customer_name",csTmp);
                }

/* customer_family_name */
                if (GetField_CString(hRequest,"customer_family_name",&csTmp)) {
DEBUGLOG(("AddTxnLog:: customer_family_name = [%s]\n",csTmp));
                        PutField_CString(hDetail,"customer_family_name",csTmp);
                }

/* customer_tel */
                if (GetField_CString(hRequest,"customer_tel",&csTmp)) {
DEBUGLOG(("AddTxnLog:: customer_tel = [%s]\n",csTmp));
                        PutField_CString(hDetail,"customer_tel",csTmp);
                }

/* customer_email */
                if (GetField_CString(hRequest,"customer_email",&csTmp)) {
DEBUGLOG(("AddTxnLog:: customer_email = [%s]\n",csTmp));
                        PutField_CString(hDetail,"customer_email",csTmp);
                }
/* selected pid */
                if (GetField_CString(hRequest,"selected_pid",&csTmp)) {
DEBUGLOG(("AddTxnLog:: selected_pid = [%s]\n",csTmp));
                        PutField_CString(hDetail,"selected_pid",csTmp);
                }
/*
// magic num
                if (GetField_CString(hRequest,"magic_num",&csTmp)) {
DEBUGLOG(("AddTxnLog:: magic_num = [%s]\n",csTmp));
                        PutField_CString(hDetail,"magic_num",csTmp);
                }

// magic word
                if (GetField_CString(hRequest,"magic_word",&csTmp)) {
DEBUGLOG(("AddTxnLog:: magic_word = [%s]\n",csTmp));
                        PutField_CString(hDetail,"magic_word",csTmp);
                }
*/

                PutField_Char(hTxn,"status",PD_PROCESSING);

                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Add");
                iRet = (unsigned long) ((*DBObjPtr)(hTxn));

		if (iRet == PD_OK ) {
                	DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                	iRet = (unsigned long) ((*DBObjPtr)(hDetail));
		}

        }
        else
                iRet = PD_ERR;

        hash_destroy(hTxn);
        FREE_ME(hTxn);
        hash_destroy(hDetail);
        FREE_ME(hDetail);
        FREE_ME(csTmp);
DEBUGLOG(("AddTxnLog RET = [%d]\n",iRet));
        return  iRet;
}

int     UpdateTxnLog(const hash_t *hContext,
                const hash_t* hRequest,
                const hash_t* hResponse)
{                       
        hash_t  *hTxn;
        char    *csTmp = strdup("");
        char    *csTxnSeq = strdup(""); 
	char	*csTag;
	char	*csTxnCode;
        char    cTmp;
        int     iTmp;
        int     iNotUpdate=PD_FALSE;
        double  dTmp;   
        int 	iRet = PD_OK; 
                

        hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0); 


	csTag = (char*) malloc (PD_TMP_BUF_LEN +1);

	if(GetField_Int(hContext,"not_update_log",&iNotUpdate)){
DEBUGLOG(("UpdateTxnLog:: not update log = [%d]\n",iNotUpdate));
	}

        if (GetField_CString(hContext,"txn_code",&csTxnCode)) {
DEBUGLOG(("UpdateTxnLog:: txn_code = [%s]\n",csTxnCode));
	}
	if (!strcmp(csTxnCode,PD_INITIAL_REQ_TXN_CODE)) {
		strcpy(csTag,"from_txn_seq");
	}
	else {
		strcpy(csTag,"txn_seq");
	}

        if (GetField_CString(hContext,csTag,&csTxnSeq) && !iNotUpdate) {
DEBUGLOG(("UpdateTxnLog:: txn_seq = [%s]\n",csTxnSeq));
                PutField_CString(hTxn,"txn_seq",csTxnSeq);
                        
	        PutField_CString(hTxn,"update_user",PD_UPDATE_USER);
/* Context */   
                if (GetField_CString(hContext,"org_txn_seq",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: org_txn_seq = [%s]\n",csTmp));
                        PutField_CString(hTxn,"org_txn_seq",csTmp);
                }
                if (GetField_Char(hContext,"status",&cTmp)) {
DEBUGLOG(("UpdateTxnLog:: status = [%c]\n",cTmp));
                        PutField_Char(hTxn,"status",cTmp);
                }
                
                if (GetField_Char(hContext,"ar_ind",&cTmp)) {
DEBUGLOG(("UpdateTxnLog:: ar_ind = [%c]\n",cTmp));
                        PutField_Char(hTxn,"ar_ind",cTmp);
                }

                if (GetField_CString(hContext,"sub_status",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: sub_status = [%s]\n",csTmp));
                        PutField_CString(hTxn,"sub_status",csTmp);
                }

                if (GetField_Int(hContext,"internal_code",&iTmp)) {
DEBUGLOG(("UpdateTxnLog:: internal_code = [%d]\n",iTmp));
                	PutField_Int(hTxn,"internal_code",iTmp);
                }

                if (GetField_CString(hContext,"merchant_client_id",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: merchant_client_id = [%s]\n",csTmp));
                        PutField_CString(hTxn,"client_id",csTmp);
                }

                if (GetField_Double(hContext,"txn_amt",&dTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_amt = [%f]\n",dTmp));
                        PutField_Double(hTxn,"txn_amt",dTmp);
                }
/* net amount */
                if (GetField_Double(hContext,"net_amt",&dTmp)) {
DEBUGLOG(("UpdateTxnLog:: net_amt = [%f]\n",dTmp));
                        PutField_Double(hTxn,"net_amt",dTmp);
                }

/* net ccy */
		if (GetField_CString(hContext,"net_ccy",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: net_ccy = [%s]\n",csTmp));
                        PutField_CString(hTxn,"net_ccy",csTmp);
		}
/* inter ccy */
		if (GetField_CString(hContext,"inter_ccy",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: inter_ccy = [%s]\n",csTmp));
                        PutField_CString(hTxn,"inter_ccy",csTmp);
		}

/* inter rate */
		if(GetField_Double(hContext,"inter_rate",&dTmp)){
DEBUGLOG(("UpdateTxnLog:: inter_rate = [%f]\n",dTmp));
                        PutField_Double(hTxn,"inter_rate",dTmp);
		}

/* exchange rate */
		if(GetField_Double(hContext,"ex_rate",&dTmp)){
DEBUGLOG(("UpdateTxnLog:: ex_rate = [%f]\n",dTmp));
                        PutField_Double(hTxn,"ex_rate",dTmp);
		}

/* exchange rate party */
                if(GetField_Char(hContext,"ex_party",&cTmp)){
DEBUGLOG(("UpdateTxnLog:: ex_party = [%c]\n",cTmp));
                        PutField_Char(hTxn,"ex_supplier",cTmp);
		}
/*

// markup ccy 
                if(GetField_CString(hContext,"markup_ccy",&csTmp)){
DEBUGLOG(("UpdateTxnLog:: markup_ccy = [%s]\n",csTmp));
                        PutField_CString(hTxn,"markup_ccy",csTmp);
		}
/// markup rate 
		if(GetField_Double(hContext,"markup_rate",&dTmp)){
DEBUGLOG(("UpdateTxnLog:: markup_rate = [%f]\n",dTmp));
                        PutField_Double(hTxn,"markup_rate",dTmp);
		}

// markup amount
		if(GetField_Double(hContext,"markup_amt",&dTmp)){
DEBUGLOG(("UpdateTxnLog:: markup_amount = [%f]\n",dTmp));
                        PutField_Double(hTxn,"markup_amt",dTmp);
		}
*/
/* converted amount */
		if(GetField_Double(hContext,"converted_amt",&dTmp)){
DEBUGLOG(("UpdateTxnLog:: converted_amount = [%f]\n",dTmp));
                        PutField_Double(hTxn,"converted_amt",dTmp);
		}


/* request */
                if (GetField_CString(hRequest,"ip_addr",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: ip_addr = [%s]\n",csTmp));
                        PutField_CString(hTxn,"ip_addr",csTmp);
                }
/* user_agent*/
                if (GetField_CString(hRequest,"user_agent",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: user_agent = [%s]\n",csTmp));
                        PutField_CString(hTxn,"user_agent",csTmp);
                }

/* Response */
                if (GetField_CString(hResponse,"expiry_date",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: expiry_date = [%s]\n",csTmp));
                        PutField_CString(hTxn,"expiry_date",csTmp);
                }
                if (GetField_CString(hResponse,"response_code",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: response_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"response_code",csTmp);
                }
/*
                if (GetField_Double(hResponse,"net_amt",&dTmp) || GetField_Double(hContext,"net_amt",&dTmp)) {
DEBUGLOG(("UpdateTxnLog:: net_amt = [%f]\n",dTmp));
                        PutField_Double(hTxn,"net_amt",dTmp);
                }
*/

/* detail */
/************/
                if (GetField_CString(hContext,"bank_code",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: bank_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"bank_code",csTmp);
		}

                if (GetField_CString(hRequest,"pay_method",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: pay_method = [%s]\n",csTmp));
                        PutField_CString(hTxn,"pay_method",csTmp);
		}
        
                if (GetField_CString(hContext,"selected_pay_method",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: selected_pay_method = [%s]\n",csTmp));
                        PutField_CString(hTxn,"selected_pay_method",csTmp);
		}

/* customer_name */
                if (GetField_CString(hRequest,"customer_name",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: customer_name = [%s]\n",csTmp));
                        PutField_CString(hTxn,"customer_name",csTmp);
		}
/* customer_family_name */
                if (GetField_CString(hRequest,"customer_family_name",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: customer_family_name = [%s]\n",csTmp));
                        PutField_CString(hTxn,"customer_family_name",csTmp);
		}

/* customer_tel */
                if (GetField_CString(hRequest,"customer_tel",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: customer_tel = [%s]\n",csTmp));
                        PutField_CString(hTxn,"customer_tel",csTmp);
		}
/* customer_email */
                if (GetField_CString(hRequest,"customer_email",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: customer_email = [%s]\n",csTmp));
                        PutField_CString(hTxn,"customer_email",csTmp);
		}
        
/* txn psp detail */
		if (GetField_CString(hContext,"psp_id",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: psp_id = [%s]\n",csTmp));
                        PutField_CString(hTxn,"psp_id",csTmp);
		}
		if (GetField_Double(hContext,"dst_net_amt",&dTmp)) {
DEBUGLOG(("UpdateTxnLog:: psp_txn_amt = [%lf]\n",dTmp));
                        PutField_Double(hTxn,"txn_amount",dTmp);
		}
		if (GetField_CString(hContext,"dst_txn_ccy",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: psp_txn_ccy = [%s]\n",csTmp));
                        PutField_CString(hTxn,"txn_ccy",csTmp);
		}
		if (GetField_CString(hRequest,"selected_pay_method",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: selected_pay_method = [%s]\n",csTmp));
                        PutField_CString(hTxn,"selected_pay_method",csTmp);
		}
/* convenience_store */
		if (GetField_CString(hRequest,"conv_store",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: convenience_store = [%s]\n",csTmp));
                        PutField_CString(hTxn,"convenience_store",csTmp);
		}

/* magic num*/
                if (GetField_CString(hRequest,"magic_num",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: magic_num = [%s]\n",csTmp));
                        PutField_CString(hTxn,"magic_num",csTmp);
                }

/* magic word*/
                if (GetField_CString(hRequest,"magic_word",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: magic_word = [%s]\n",csTmp));
                        PutField_CString(hTxn,"magic_word",csTmp);
                }

/* customer_id*/
                if (GetField_CString(hContext,"customer_id",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: customer_id = [%s]\n",csTmp));
                        PutField_CString(hTxn,"customer_id",csTmp);
		}
/* customer_group */
                if (GetField_CString(hContext,"customer_group",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: customer_group = [%s]\n",csTmp));
                        PutField_CString(hTxn,"customer_group",csTmp);
		}

/* pid_group */
                if (GetField_CString(hContext,"pid_group",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: pid_group = [%s]\n",csTmp));
                        PutField_CString(hTxn, "pid_group",csTmp);
		}

/* vp_group */
                if (GetField_Int(hContext,"txn_gp_id",&iTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_gp_id = [%d]\n",iTmp));
                        PutField_Int(hTxn,"txn_gp_id",iTmp);
		}

/* fe_domain */
                if (GetField_CString(hContext,"fe_domain",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: fe_domain = [%s]\n",csTmp));
                        PutField_CString(hTxn,"fe_domain",csTmp);
		}

                if (iRet == PD_OK) {
                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                        iRet = (unsigned long)(*DBObjPtr)(hTxn);
                }       

                if (iRet == PD_OK) {
                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                        iRet = (unsigned long)(*DBObjPtr)(hTxn);
                }       

                if (iRet == PD_OK && strcmp(csTxnCode,PD_INITIAL_TXN_CODE)) {
                        DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
                        iRet = (unsigned long)(*DBObjPtr)(hTxn);
                }       
                if (iRet == PD_OK) {
			BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnFeeElements");
                        iRet = (unsigned long)(*BOObjPtr)(hContext);
		}
                        
        }
        else{
		if(!iNotUpdate)
                	iRet = PD_ERR;
		else
			iRet = PD_SKIP_OK;
	}

        hash_destroy(hTxn);
        FREE_ME(hTxn);          

                        
        FREE_ME(csTmp);
        FREE_ME(csTxnSeq); 
	FREE_ME(csTag);
DEBUGLOG(("UpdateTxnLog:: iRet = [%d]\n",iRet));
        return  iRet;   
}


int     process_resp_txn(hash_t *hContext,
			   	const hex_t* inMsg,
				hex_t *outMsg)
{
	int	iRet = PD_OK;
	char	*csChannelCode;
	char	cPtr;
	char	*csPtr;
	char    csTmpChannelCode[PD_CHANNEL_CODE_LEN *2  +1];
	long	lKey,lResponseQueueMtype;
	hash_t	*hRequest,*hResponse,*hRsp;
	hex_t   *h_msg;
	recordset_t     *rRecordSet;
	struct	msg_t*	msg;

	hRequest = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRequest,0);

	hResponse = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hResponse,0);

	hRsp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRsp,0);


        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);
DEBUGLOG(("process_resp_txn()\n"));

        MsgObjPtr = CreateObj(MsgPtr,"WebMsg","BreakDownRespMsg");
        if ((*MsgObjPtr)(hRequest,inMsg->msg,inMsg->len) != PD_OK)  {
     		iRet = INT_BREAKDOWN_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("process_resp_txn:BreakDown WEBMsg Error\n"));
       	}
	else {
		if (GetField_CString(hRequest,"encrypted_txn_seq",&csPtr)) {
DEBUGLOG(("process_resp_txn:encrypted txn seq = [%s]\n",csPtr));
			char* csTmpBuf;
                        csTmpBuf = (char*) malloc (PD_EN_TXN_SEQ_LEN +1);
                        BOObjPtr = CreateObj(BOPtr,"BOSecurity","Decrypt3DESTxnSeq");
                        (BOObjPtr)(csPtr,csTmpBuf);
DEBUGLOG(("process_resp_txn: txn_seq = [%s]\n",csTmpBuf));
			PutField_CString(hRequest,"txn_seq",csTmpBuf);
			PutField_CString(hResponse,"txnid",csTmpBuf);
			FREE_ME(csTmpBuf);
		}
		if (!GetField_Char(hRequest,"FERESP",&cPtr)) {

DEBUGLOG(("ERROR! Backend response handler is missing!!!!\n"));
ERRLOG("WEBChannel ERROR! Backend response handler is missing!!!!\n");
			iRet = PD_ERR;

		}
		else {
DEBUGLOG(("process_resp_txn FERESP*** DO NOTHING\n"));

      			TxnObjPtr = CreateObj(TxnPtr,"TxnWebOnUsFEK","Authorize");
               		iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
			if (iRet == PD_OK) {
				if (GetField_CString(hResponse,"channel_code",&csChannelCode)) {
DEBUGLOG(("process_resp_txn org channel code [%s]found\n",csChannelCode));
					if (strcmp(csChannelCode,PD_CHANNEL_XPAY)) {
						RemoveField_CString(hResponse,"merchant_id");
						//RemoveField_CString(hResponse,"merchant_ref");
					}	
				}

				sprintf(csTmpChannelCode,"%c%c%cMsg",csChannelCode[0],tolower(csChannelCode[1]),tolower(csChannelCode[2]));	

DEBUGLOG(("process_resp_txn try to call [%s]->FormatFEMsg\n",csTmpChannelCode));
				MsgObjPtr = CreateObj(MsgPtr,csTmpChannelCode,"FormatFEMsg");

                		h_msg = (hex_t*) malloc (sizeof(hex_t));
                		if ((*MsgObjPtr)(hResponse,h_msg->msg,&h_msg->len) == PD_OK) {
                		}

DEBUGLOG(("h_msg->len = [%d][%s]\n",h_msg->len,h_msg->msg));
				GetField_Long(hContext,"queue_key",&lKey);

				if (GetField_Long(hContext,"response_queue_mtype",&lResponseQueueMtype)) {
DEBUGLOG(("response queue mtype = [%ld]\n",lResponseQueueMtype));
				}
                		msg = (struct msg_t*)malloc(sizeof(struct msg_t)+MAX_MSG_SIZE);
                		msg->mtype  = lResponseQueueMtype;
DEBUGLOG(("key = [%ld] mtype = [%ld]\n",lKey,lResponseQueueMtype));

				long	lRemoteKey;
				GetField_Long(hContext,"remote_reply_key",&lRemoteKey);
                		memset(msg->mtext,0,sizeof(msg->mtext));
                        		MQ_build_header((unsigned char*)msg->mtext,
                        		MQ_RESP,
                        		csChannelCode,
					0,
					NULL,
					lRemoteKey);
DEBUGLOG(("build header\n"));
                		memcpy(&msg->mtext[MQ_HEADER_LEN],h_msg->msg,h_msg->len);
                		msg->mtext[MQ_HEADER_LEN + h_msg->len] = '\0';
DEBUGLOG(("send len = [%d]\n",MQ_HEADER_LEN + h_msg->len));

                		iRet = MQSend(lKey,msg,MQ_HEADER_LEN + h_msg->len);

                		FREE_ME(h_msg);
                		FREE_ME(msg);
			}
			else {
DEBUGLOG(("process_resp_txn:FEK return iRet = [%d]\n",iRet));
			}
		}
	}

       	hash_destroy(hRequest);
       	FREE_ME(hRequest);          

       	hash_destroy(hResponse);
       	FREE_ME(hResponse);          

       	hash_destroy(hRsp);
       	FREE_ME(hRsp);          

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
DEBUGLOG(("process_resp_txn::Normal RET = [%d]\n",iRet));
	return iRet;
}
	

int     process_input_batch_txn(hash_t *hContext,     
                                const hash_t *Request,
                                hash_t *Response)
{                       
        int     iRet = PD_OK;
        char*   csTxnCode = NULL;
        char*   csHandler = NULL;
	char*	csValue;
	char	csTag[25 +1];
	int	iTotal,i;
	double	dTmp;
	char*   csMerchantId;
        char*   csMerchantRef;

	hash_t	*hReq,*hRes;

	hReq = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hReq,0);

	hRes = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRes,0);

DEBUGLOG(("process_input_batch\n"));
        if (GetField_CString(hContext,"txn_code",&csTxnCode)) {
DEBUGLOG(("process_input_txn_batch:txn_code = [%s]\n",csTxnCode));
        }
        else {
                iRet = PD_ERR;
DEBUGLOG(("process_input_txn_batch:txn_code not found\n"));
        }       
	GetField_Int(Request,"total",&iTotal);
DEBUGLOG(("process_input_txn_batch:total = [%d]\n",iTotal));
                
	for (i = 0; i < iTotal; i++ ) {
/* merchant_id */
		sprintf(csTag,"merchant_id_%d",i);
		if (GetField_CString(Request,csTag,&csValue)) {
DEBUGLOG(("process_input_txn: %s = [%s]\n",csTag,csValue));
			PutField_CString(hReq,"merchant_id",csValue);
			csMerchantId  = strdup(csValue);
		}

/* merchant_ref */
		sprintf(csTag,"merchant_ref_%d",i);
		if (GetField_CString(Request,csTag,&csValue)) {
DEBUGLOG(("process_input_txn: %s = [%s]\n",csTag,csValue));
			PutField_CString(hReq,"merchant_ref",csValue);
			csMerchantRef  = strdup(csValue);
		}
/* txn_ccy */
		sprintf(csTag,"txn_ccy_%d",i);
		if (GetField_CString(Request,csTag,&csValue)) {
DEBUGLOG(("process_input_txn: %s = [%s]\n",csTag,csValue));
			PutField_CString(hReq,"txn_ccy",csValue);
		}
/* txn_country */
		sprintf(csTag,"txn_country_%d",i);
		if (GetField_CString(Request,csTag,&csValue)) {
DEBUGLOG(("process_input_txn: %s = [%s]\n",csTag,csValue));
			PutField_CString(hReq,"txn_country",csValue);
		}
/* txn_amt */
		sprintf(csTag,"txn_amt_%d",i);
		if (GetField_CString(Request,csTag,&csValue)) {
DEBUGLOG(("process_input_txn: %s = [%s]\n",csTag,csValue));
			PutField_CString(hReq,"txn_amt",csValue);
		}


/* transmission_datetime */
		sprintf(csTag,"transmission_datetime_%d",i);
		if (GetField_CString(Request,csTag,&csValue)) {
DEBUGLOG(("process_input_txn: %s = [%s]\n",csTag,csValue));
			PutField_CString(hReq,"transmission_datetime",csValue);
		}
/* bank_code */
		sprintf(csTag,"bank_code_%d",i);
		if (GetField_CString(Request,csTag,&csValue)) {
DEBUGLOG(("process_input_txn: %s = [%s]\n",csTag,csValue));
			PutField_CString(hReq,"bank_code",csValue);
		}
/* account_id */
		sprintf(csTag,"account_id_%d",i);
		if (GetField_CString(Request,csTag,&csValue)) {
DEBUGLOG(("process_input_txn: %s = [%s]\n",csTag,csValue));
			PutField_CString(hReq,"account_id",csValue);
		}
/* account_name */
		sprintf(csTag,"account_name_%d",i);
		if (GetField_CString(Request,csTag,&csValue)) {
DEBUGLOG(("process_input_txn: %s = [%s]\n",csTag,csValue));
			PutField_CString(hReq,"account_name",csValue);
		}
/* identity_id */
		sprintf(csTag,"identity_id_%d",i);
		if (GetField_CString(Request,csTag,&csValue)) {
DEBUGLOG(("process_input_txn: %s = [%s]\n",csTag,csValue));
			PutField_CString(hReq,"identity_id",csValue);
		}
/* mac */
		sprintf(csTag,"mac_%d",i);
		if (GetField_CString(Request,csTag,&csValue)) {
DEBUGLOG(("process_input_txn: %s = [%s]\n",csTag,csValue));
			PutField_CString(hReq,"mac",csValue);
		}

        	if (iRet == PD_OK) {
                	TxnObjPtr = CreateObj(TxnPtr,"TxnWebOnUsCOM","Authorize");
                	iRet = (unsigned long)(*TxnObjPtr)(hContext,hReq,hRes);
			if (GetField_Double(hContext,"txn_amt",&dTmp)) {
				sprintf(csTag,"txn_amt_%d",i);
				PutField_Double(hContext,csTag,dTmp);
			}
        	}       

		if (iRet == PD_OK) {
                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","MatchMerchantRef");
                        if ((unsigned long)(DBObjPtr)(csMerchantId,csMerchantRef) == PD_FOUND) {
                                iRet = INT_DUP_MERCHANT_REF;
ERRLOG("Channel:[WEB] batch - MerchantId[%s][%s]Duplicate Merchant Ref\n",csMerchantId,csMerchantRef);
DEBUGLOG(("Channel:[WEB] batch - MerchantId[%s][%s]Duplicate Merchant Ref\n",csMerchantId,csMerchantRef));
                        }
                }
		/* put response to request */
                sprintf(csTag,"internal_error_%d",i);
                PutField_Int((hash_t*) Request,csTag,iRet);
                FREE_ME(csMerchantId);
                FREE_ME(csMerchantRef);
                iRet = PD_OK; //reset 
	}
        if (iRet == PD_OK ) {
                csHandler = (char*) malloc (20);
                sprintf(csHandler,"TxnWebOnUs%s",csTxnCode);
DEBUGLOG(("process_input_txn_batch Create Txn Object [%s]\n",csHandler));
                TxnObjPtr = CreateObj(TxnPtr,csHandler,"Authorize");
                FREE_ME(csHandler);
        
                iRet = (unsigned long)(*TxnObjPtr)(hContext,Request,Response);
DEBUGLOG(("iRet = [%d]\n",iRet));
        }

        FREE_ME(csTxnCode);
DEBUGLOG(("process_input_batch() exit [%d]\n",iRet));
        return iRet;
}

int     process_WEB_bounce_txn(hash_t *hContext,
			   	const hex_t* inMsg,
				hex_t *outMsg)
{
	int	iRet = PD_OK;
	char	*csOrgTxnSeq;
	char	csCmd[PD_MAX_FILE_LEN +1];
	hash_t  *hRequest;

	hRequest = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRequest,0);

DEBUGLOG(("process_WEB_bounce_txn:: ()\n"));

	MsgObjPtr = CreateObj(MsgPtr,"WebMsg","DeBlockWebBounceBackData");
        if ((*MsgObjPtr)(hRequest,inMsg->msg,inMsg->len) != PD_OK)  {
                iRet = INT_BREAKDOWN_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("process_WEB_bounce_txn:BreakDown WEBMsg Error\n"));
        }
        else {
      		if (GetField_CString(hRequest,"org_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("process_WEB_bounce_txn:org txn seq = [%s]\n",csOrgTxnSeq));
			sprintf(csCmd,"%s %s",PD_ACK_RESEND,csOrgTxnSeq);
DEBUGLOG(("process_WEB_bounce_txn:cmd = [%s]\n",csCmd));
			system(csCmd);
		}
	}

	FREE_ME(hRequest);
	return iRet;
}

int     process_psp_resp_txn(hash_t *hContext,
			   	const hex_t* inMsg,
				hex_t *outMsg)
{
DEBUGLOG(("process_psp_resp_txn\n"));
	int	iRet = PD_OK;
	char	*csOrgTxnSeq;
	char	*csTxnSeq;
	char	*csChannelCode;
	char	*csTxnCode;
	char	*csPostingDate;
	char	*csOrgPostingDate;
	char	*csPtr;
	char	cPtr;
	char	cArPtr;
	char    csTmpChannelCode[PD_CHANNEL_CODE_LEN *2  +1];
	char	*csReturnPspChannel;
	int	iUpdateOnly = PD_FALSE;

	double	dTmp;
	double	dAmt = 0.0;
	double	dOrgAmt = 0.0;
	long	lKey,lResponseQueueMtype;
	hash_t	*hRequest,*hResponse,*hRsp, *hRec, *hLRsp;
	hex_t   *h_msg;
	recordset_t     *rRecordSet;
	struct	msg_t*	msg;

	int	iVoidTxn = PD_FALSE;
	int	iPayoutTxn = PD_FALSE;
	int	iSIM;

	hRequest = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRequest,0);

	hResponse = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hResponse,0);

	hRsp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRsp,0);


        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);
DEBUGLOG(("process_psp_resp_txn()\n"));

	if (GetField_CString(hContext,"return_psp_channel",&csReturnPspChannel)) {
DEBUGLOG(("process_psp_resp_txn() return psp_channel = [%s]\n",csReturnPspChannel));
	}
	else {
DEBUGLOG(("process_psp_resp_txn() return psp missing!!!!\n"));
ERRLOG("process_psp_resp_txn() return psp missing!!!!\n");
	}

/*HaiPay*/
	if (!strcmp(csReturnPspChannel,PD_CHANNEL_HPAY)) {
        	MsgObjPtr = CreateObj(MsgPtr,"HpyMsg","BreakDownMsg");
	}
/* new HaiPay */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_HAIPAY)) {
        	MsgObjPtr = CreateObj(MsgPtr,"HaiMsg","BreakDownMsg");
	}
/*HaiPay ChinaPay*/
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_HPAY_CNP)) {
        	MsgObjPtr = CreateObj(MsgPtr,"HcpMsg","BreakDownMsg");
	}
/*linkinpay */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_LKPAY)) {
        	MsgObjPtr = CreateObj(MsgPtr,"LkpMsg","BreakDownMsg");
	}
/* hohopay */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_HHPAY)) {
        	MsgObjPtr = CreateObj(MsgPtr,"HhpMsg","BreakDownMsg");
	}
/*ESKY */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_ESKY)) {
        	MsgObjPtr = CreateObj(MsgPtr,"ESkyMsg","BreakDownMsg");
	}
/*EEP */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_EEP)) {
        	MsgObjPtr = CreateObj(MsgPtr,"EepMsg","BreakDownMsg");
	}
/*TWV */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_TWV)) {
        	MsgObjPtr = CreateObj(MsgPtr,"TwvMsg","BreakDownMsg");
	}
/*51Epay */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_51EPAY)) {
        	MsgObjPtr = CreateObj(MsgPtr,"FepMsg","BreakDownMsg");
	}
/*YeePay */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_YEEPAY)) {
        	MsgObjPtr = CreateObj(MsgPtr,"YpyMsg","BreakDownMsg");
	}
/*AllinPay */
        else if (!strcmp(csReturnPspChannel,PD_CHANNEL_ALLINPAY)) {
                MsgObjPtr = CreateObj(MsgPtr,"AlpMsg","BreakDownMsg");
        }
/*ShengPay */
        else if (!strcmp(csReturnPspChannel,PD_CHANNEL_SHENGPAY)) {
                MsgObjPtr = CreateObj(MsgPtr,"SpyMsg","BreakDownMsg");
        }
/*IPay88 */
        else if (!strcmp(csReturnPspChannel,PD_CHANNEL_IPAY)) {
                MsgObjPtr = CreateObj(MsgPtr,"IpyMsg","BreakDownMsg");
        }
/*GoPay */
        else if (!strcmp(csReturnPspChannel,PD_CHANNEL_GOPAY)) {
                MsgObjPtr = CreateObj(MsgPtr,"GpyMsg","BreakDownMsg");
        }
/* ECPSS */
        else if (!strcmp(csReturnPspChannel,PD_CHANNEL_ECPSS)) {
                MsgObjPtr = CreateObj(MsgPtr,"EcpMsg","BreakDownMsg");
        }
/* PFTTOM */
        else if (!strcmp(csReturnPspChannel,PD_CHANNEL_PFTTOM)) {
                MsgObjPtr = CreateObj(MsgPtr,"PftMsg","BreakDownMsg");
        }
/* EPlutus*/
        else if (!strcmp(csReturnPspChannel,PD_CHANNEL_EPLUTUS)) {
                MsgObjPtr = CreateObj(MsgPtr,"EptMsg","BreakDownMsg");
        }
/* UniPaygo*/
        else if (!strcmp(csReturnPspChannel,PD_CHANNEL_UNIPAY)) {
                MsgObjPtr = CreateObj(MsgPtr,"UniMsg","BreakDownMsg");
        }
/* HNAPay*/
        else if (!strcmp(csReturnPspChannel,PD_CHANNEL_HNAPAY)) {
                MsgObjPtr = CreateObj(MsgPtr,"HnaMsg","BreakDownMsg");
        }
/* BaoFoo*/
        else if (!strcmp(csReturnPspChannel,PD_CHANNEL_BAOFOO)) {
                MsgObjPtr = CreateObj(MsgPtr,"BfoMsg","BreakDownMsg");
        }
/* TenPay*/
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_TENPAY)) {
		MsgObjPtr = CreateObj(MsgPtr,"TpyMsg","BreakDownMsg");
	}
/* TenPayMobile*/
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_TENMOBPAY)) {
		MsgObjPtr = CreateObj(MsgPtr,"TpmMsg","BreakDownMsg");
	}
/* ReaPay*/
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_REAPAY)) {
		MsgObjPtr = CreateObj(MsgPtr,"RpyMsg","BreakDownMsg");
	}
/* YeePay Mobile*/
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_YEEPAYMOBILE)) {
		MsgObjPtr = CreateObj(MsgPtr,"YpmMsg","BreakDownMsg");
	}
/* YsePay*/
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_YSEPAY)) {
		MsgObjPtr = CreateObj(MsgPtr,"YseMsg","BreakDownMsg");
	}
/* HeePay*/
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_HEEPAY)) {
		MsgObjPtr = CreateObj(MsgPtr,"HeeMsg","BreakDownMsg");
	}
/* ECPSS Mobile*/
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_ECPSSMOBILE)) {
		MsgObjPtr = CreateObj(MsgPtr,"EcmMsg","BreakDownMsg");
	}
/* EPLUTUS-DinPayWechat */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_WECHATPAY)) {
		MsgObjPtr = CreateObj(MsgPtr,"WcpMsg","BreakDownMsg");
	}
/* XJ-EHK*/
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_XJP)) {
		MsgObjPtr = CreateObj(MsgPtr,"XjpMsg","BreakDownMsg");
	}
/* Now2Pay*/
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_NOW2PAY)) {
		MsgObjPtr = CreateObj(MsgPtr,"NtpMsg","BreakDownMsg");
	}
/* EASYPAY-AIPWechat */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_AIPWECHAT)) {
		MsgObjPtr = CreateObj(MsgPtr,"AwcMsg","BreakDownMsg");
	}
/* N2P-AIPWechat */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_N2P_AIPWECHAT)) {
		MsgObjPtr = CreateObj(MsgPtr,"NtwMsg","BreakDownMsg");
	}
/* XJ-CHWechat */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_XJ_CHWECHAT)) {
		MsgObjPtr = CreateObj(MsgPtr,"XjwMsg","BreakDownMsg");
	}
/* XJ Mobile */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_XJ_MOBILE)) {
		MsgObjPtr = CreateObj(MsgPtr,"XjmMsg","BreakDownMsg");
	}
/* Unipaygo Wechat */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_UNIPAY_WECHAT)) {
		MsgObjPtr = CreateObj(MsgPtr,"UnwMsg","BreakDownMsg");
	}
/* XJ-JINHAI QR */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_XJ_JINHAI_QR)) {
		MsgObjPtr = CreateObj(MsgPtr,"XjqMsg","BreakDownMsg");
	}
/* PayLink-Dinpay */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_DINPAY)) {
		MsgObjPtr = CreateObj(MsgPtr,"DpyMsg","BreakDownMsg");
	}
/* Cloud123Pay */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_CLOUD123PAY)) {
		MsgObjPtr = CreateObj(MsgPtr,"CopMsg","BreakDownMsg");
	}
/* PayLink-Dinpay QR */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_DINPAY_QR)) {
		MsgObjPtr = CreateObj(MsgPtr,"DpqMsg","BreakDownMsg");
	}
/* XJ-Ehk new API */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_XJE)) {
		MsgObjPtr = CreateObj(MsgPtr,"XjeMsg","BreakDownMsg");
	}
/* STAR-KKPay EC */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_STAR_KKPAY_EC)) {
		MsgObjPtr = CreateObj(MsgPtr,"SkeMsg","BreakDownMsg");
	}
/* PayLink-RFPay EC */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_RFPAY_EC)) {
		MsgObjPtr = CreateObj(MsgPtr,"RfeMsg","BreakDownMsg");
	}
/* TZ-CoalaPay EC */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_COALAPAY_EC)) {
		MsgObjPtr = CreateObj(MsgPtr,"CpeMsg","BreakDownMsg");
	}
/* STAR-KKPay QR */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_STAR_KKPAY_QR)) {
		MsgObjPtr = CreateObj(MsgPtr,"SkqMsg","BreakDownMsg");
	}
/* STAR-KKPay VNET */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_STAR_KKPAY_VNET)) {
		MsgObjPtr = CreateObj(MsgPtr,"SkvMsg","BreakDownMsg");
	}
/* EASYPAY-OpenePay */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_OPENEPAY)) {
		MsgObjPtr = CreateObj(MsgPtr,"OppMsg","BreakDownMsg");
	}
/* SHANFU-SFPay EC */
	else if (!strcmp(csReturnPspChannel,PD_CHANNEL_SHANFU_EC)) {
		MsgObjPtr = CreateObj(MsgPtr,"SfeMsg","BreakDownMsg");
	}
	else  {
ERRLOG("WEBChannel unsupported psp channel [%s]\n",csReturnPspChannel);
	}


        if ((*MsgObjPtr)(hRequest,inMsg->msg,inMsg->len) != PD_OK)  {
     		iRet = INT_BREAKDOWN_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("process_psp_resp_txn:BreakDownMsg Error\n"));
       	}
	else{
		if (!GetField_CString(hRequest,"txn_seq",&csTxnSeq)) {
			iRet = INT_TXN_ID_NOT_FOUND;
DEBUGLOG(("process_psp_resp_txn txn id not found\n"));
ERRLOG("process_psp_resp_txn  txn id not found\n");
		}
	}
/*
	if(iRet==PD_OK && is_numeric(csTxnSeq)!=PD_TRUE){
		iRet = process_payout_resp_txn(hContext,hRequest,hResponse);
	}
	else if(iRet==PD_OK && is_numeric(csTxnSeq)==PD_TRUE){
*/
	if(iRet==PD_OK){
		if (!GetField_Char(hRequest,"FERESP",&cPtr)) {
			if (GetField_CString(hRequest,"txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("process_psp_resp_txn:org txn seq = [%s]\n",csOrgTxnSeq));
				PutField_CString(hContext,"org_txn_seq",csOrgTxnSeq);
                		DBObjPtr = CreateObj(DBPtr,"DBTransaction","MatchRespTxn");
                		if ((unsigned long)(DBObjPtr)(csOrgTxnSeq,PD_TO_PSP) != PD_FOUND) {
                     	  	 	iRet = INT_ORG_TXN_NOT_FOUND;
                       	 		PutField_Int(hContext,"internal_error",iRet);

					PutField_CString(hRsp,"txn_seq",csOrgTxnSeq);
DEBUGLOG(("process_psp_resp_txn::org_txn_seq = [%s]\n",csOrgTxnSeq));
                                	DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
					cPtr = ' ';
                                	if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("process_psp_resp_txn::found record = [%s]\n",csOrgTxnSeq));
                                        	hRec = RecordSet_GetFirst(rRecordSet);
                                        	while (hRec) {
                                                	if (GetField_Char(hRec,"status",&cPtr)){
DEBUGLOG(("process_psp_resp_txn::status = [%c]\n",cPtr));
							}
                                                	if (GetField_Char(hRec,"ar_ind",&cArPtr)){
DEBUGLOG(("process_psp_resp_txn::ar_ind = [%c]\n",cArPtr));
							}
							else{
								cArPtr=' ';
							}
							if(GetField_CString(hRec,"txn_code",&csTxnCode)){
DEBUGLOG(("process_psp_resp_txn::txn_code = [%s]\n",csTxnCode));
							}
                                        		hRec = RecordSet_GetNext(rRecordSet);
                                        	}
                               		 }
					if (cPtr == PD_COMPLETE) {
						if(cArPtr == PD_ACCEPT){
							//if(strcmp(csTxnCode,PD_WITHDRAW_BATCH_TXN_CODE)){
							if(strcmp(csTxnCode,PD_PAYOUT_GENERATE)){
DEBUGLOG(("*process_psp_resp_txn org txn id [%s][%s] Re-send update txn psp detail!!!\n",csReturnPspChannel,csOrgTxnSeq));
ERRLOG("*process_psp_resp_txn org txn id [%s][%s] Re-send update txn psp detail!!!\n",csReturnPspChannel,csOrgTxnSeq);
								iUpdateOnly = PD_TRUE;
/* update psp detaill */
							}
							else{
DEBUGLOG(("process_psp_resp_txn:: re-send POG response!!!\n"));
								iPayoutTxn = PD_TRUE;
								iRet = PD_OK;
								
							}

						}
						else{
DEBUGLOG(("*process_psp_resp_txn org txn id [%s] Re-send Message where AR_IND[%c]\n",csOrgTxnSeq,cArPtr));
ERRLOG("*process_psp_resp_txn org txn id [%s] Re-send Message where AR_IND[%c]\n",csOrgTxnSeq,cArPtr);
							iRet = PD_OK;
						}
					}
					else {
DEBUGLOG(("*process_psp_resp_txn org txn id [%s] not found!\n",csOrgTxnSeq));
ERRLOG("*process_psp_resp_txn org txn id [%s] not found!\n",csOrgTxnSeq);
					}
				}
				else{
					DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
					recordset_init(rRecordSet,0);
                                        if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("process_psp_resp_txn::found record = [%s]\n",csOrgTxnSeq));
                                                hRec = RecordSet_GetFirst(rRecordSet);
                                                while (hRec) {
                                                        if(GetField_CString(hRec,"txn_code",&csTxnCode)){
DEBUGLOG(("process_psp_resp_txn::txn_code = [%s]\n",csTxnCode));
                                                        }
                                                        hRec = RecordSet_GetNext(rRecordSet);
                                                }
                                         }
				}
                	}
			else  {
				iRet = INT_TXN_ID_NOT_FOUND;	
DEBUGLOG(("process_psp_resp_txn txn id not found\n"));
ERRLOG("process_psp_resp_txn  txn id not found\n");
			}

			////////update payout response
			if(iRet == PD_OK && !strcmp(csTxnCode,PD_PAYOUT_GENERATE) && iPayoutTxn != PD_TRUE){
				iRet = process_payout_resp_txn(hContext,hRequest,hResponse);
			}

			else{
/*VerifyPspSign*/
				if (iRet == PD_OK || iUpdateOnly == PD_TRUE) {

DEBUGLOG(("process_psp_resp_txn::VerifySign\n"));
					char*	csPspId=strdup("");
					char*	csTmp;
					recordset_init(rRecordSet,0);
		                	DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","GetTxnPspDetail");
                			if (!(*DBObjPtr)(csOrgTxnSeq,rRecordSet)) {
		                        	hRec = RecordSet_GetFirst(rRecordSet);
						while(hRec){
							if (GetField_CString(hRec,"psp_id",&csPspId)) {
DEBUGLOG(("process_psp_resp_txn::GetTxnPsp - psp_id = [%s]\n",csPspId));
								PutField_CString(hContext,"org_psp_id",csPspId);
							}

							if (GetField_CString(hRec,"txn_ccy",&csTmp)) {
DEBUGLOG(("process_psp_resp_txn::GetTxnPsp - psp_txn_ccy = [%s]\n",csTmp));
								PutField_CString(hContext,"org_dst_txn_ccy",csTmp);
							}

                                			if (GetField_Double(hRec,"txn_amt",&dOrgAmt)) {
DEBUGLOG(("process_psp_resp_txn::GetTxnPsp - txn amt = [%lf]\n",dOrgAmt));
								PutField_Double(hContext,"org_dst_net_amt",dOrgAmt);
								PutField_Double(hContext,"org_dst_txn_amt",dOrgAmt);
                                			}

							if(GetField_CString(hRequest,"txn_amt",&csPtr)){
								if (!strcmp(csReturnPspChannel,PD_CHANNEL_TWV) || 
                                                                    !strcmp(csReturnPspChannel,PD_CHANNEL_ESKY) ||
                                                                    !strcmp(csReturnPspChannel,PD_CHANNEL_YEEPAY) ||
                                                                    !strcmp(csReturnPspChannel,PD_CHANNEL_51EPAY) ||
                                                                    !strcmp(csReturnPspChannel,PD_CHANNEL_UNIPAY) ||
                                                                    !strcmp(csReturnPspChannel,PD_CHANNEL_ECPSS) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_ECPSSMOBILE) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_REAPAY) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_HEEPAY) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_NOW2PAY) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_N2P_AIPWECHAT) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_XJ_CHWECHAT) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_XJ_MOBILE) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_UNIPAY_WECHAT) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_DINPAY) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_CLOUD123PAY) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_DINPAY_QR) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_STAR_KKPAY_EC) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_RFPAY_EC) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_STAR_KKPAY_QR) ||
								    !strcmp(csReturnPspChannel,PD_CHANNEL_STAR_KKPAY_VNET)
								   ){ 
									sscanf(csPtr, "%lf", &dAmt);
								}
								else{
									dAmt = myctod((const unsigned char *)csPtr,strlen(csPtr)-PD_DECIMAL_LEN,PD_DECIMAL_LEN);
								}
DEBUGLOG(("process_psp_resp_txn::txn amt from PSP response = [%lf]\n",dAmt));
								if(dOrgAmt!=dAmt){
DEBUGLOG(("process_psp_resp_txn::txn amt not match!! [%lf]!=[%lf]\n",dOrgAmt,dAmt));
ERRLOG("process_psp_resp_txn::txn amt not match!! [%lf]!=[%lf]\n",dOrgAmt,dAmt);
									char *csCmd=(char*) malloc(PD_MAX_FILE_LEN  +1);
									sprintf(csCmd,"warn_diff_amt.sh %s %s",csOrgTxnSeq,csPspId);
									system(csCmd);
									FREE_ME(csCmd);
									iRet = INT_INVALID_PAY_AMOUNT;
								}
							}
							else{
								char *csCmd=(char*) malloc(PD_MAX_FILE_LEN  +1);
								sprintf(csCmd,"warn_diff_amt.sh %s %s",csOrgTxnSeq,csPspId);
								system(csCmd);
								FREE_ME(csCmd);
								iRet = INT_INVALID_PAY_AMOUNT;
DEBUGLOG(("process_psp_resp_txn::Cannot find the PSP response amount!!!!!\n"));
ERRLOG("WEBChannel:process_psp_resp_txn::Cannot find the PSP response amount!!!!!\n");
							}

							if (GetField_CString(hRec,"pid_group",&csTmp)) {
DEBUGLOG(("process_psp_resp_txn::GetTxnPsp - pid_group = [%s]\n",csTmp));
								PutField_CString(hContext,"org_pid_group",csTmp);
							}

                                			hRec = RecordSet_GetNext(rRecordSet);
                        			}
                			}
                			else{
ERRLOG("process_psp_resp_txn:: PSP NOT FOUND\n");
DEBUGLOG(("WEBChannel process_psp_resp_txn:: PSP NOT FOUND\n"));
                			}
					if(iRet==PD_OK){
		                		DBObjPtr = CreateObj(DBPtr,"DBPspKeys","GetPspKey");
                				if (!(*DBObjPtr)(csPspId,PD_PTK_KEY_NAME,rRecordSet)) {
		                        		hRec = RecordSet_GetFirst(rRecordSet);
               						        while(hRec){
                                					if (GetField_CString(hRec,"key_value",&csTmp)) {
DEBUGLOG(("process_psp_resp_txn::GetTxnPsp - psp_key = [%s]\n",csTmp));
                               	        	 				PutField_CString(hContext,"psp_key",csTmp);
                                					}
                                					if (GetField_CString(hRec,"publiccert",&csTmp)) {
DEBUGLOG(("process_psp_resp_txn::GetTxnPsp - psp_publiccert = [%s]\n",csTmp));
                               	        	 				PutField_CString(hContext,"psp_publiccert",csTmp);
                                					}
									if (GetField_CString(hRec,"privatepem",&csTmp)) {
DEBUGLOG(("process_psp_resp_txn::GetTxnPsp - rsa_privatepem = [%s]\n",csTmp));
										PutField_CString(hContext,"rsa_privatepem",csTmp);
									}
                                					hRec = RecordSet_GetNext(rRecordSet);
                        					}
                				}
                				else{
ERRLOG("process_psp_resp_txn::GetTxnPSP - no psp_key for [%s]\n",csPspId);
DEBUGLOG(("process_psp_resp_txn::GetTxnPSP - no psp_key for [%s]\n",csPspId));
                				}
					}

/* VerifyPspSign */
					iSIM = PD_FALSE;
					GetField_Int(hContext,"use_mobile_simulator",&iSIM);

					//if(iRet == PD_OK && (!iSIM || (iSIM && strcmp(csReturnPspChannel,PD_CHANNEL_51EPAY)))){
					if(iRet == PD_OK  && strcmp(csReturnPspChannel,PD_CHANNEL_51EPAY) 
							  && strcmp(csReturnPspChannel,PD_CHANNEL_UNIPAY)
							  && strcmp(csReturnPspChannel,PD_CHANNEL_UNIPAY_WECHAT)){
DEBUGLOG(("process_psp_resp_txn::VerifySign \n"));
						BOObjPtr = CreateObj(BOPtr,"BOSecurity","VerifyPspSign");
                                		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
						if (iRet != PD_OK) {
ERRLOG("process_psp_resp_txn::Invalid Sign!! txn id [%s] dropped\n",csOrgTxnSeq);
						}
					}
DEBUGLOG(("process_psp_resp_txn::VerifySign Completed!!!\n"));

				}
				if (iRet == PD_OK) {
					RecordSet_Destroy(rRecordSet);
					PutField_CString(hRsp,"txn_seq",csOrgTxnSeq);
DEBUGLOG(("process_psp_resp_txn::org_txn_seq = [%s]\n",csOrgTxnSeq));
                			DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
                			if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("process_psp_resp_txn::found record = [%s]\n",csOrgTxnSeq));
                        			hRec = RecordSet_GetFirst(rRecordSet);
                        			while (hRec) {
                                			if (GetField_CString(hRec,"txn_code",&csTxnCode)) {
DEBUGLOG(("process_psp_resp_txn::TXN CODE= [%s]\n",csTxnCode));
								PutField_CString(hContext,"txn_code",csTxnCode);
                                			}

                                			if (GetField_CString(hRec,"host_posting_date",&csOrgPostingDate)) {
DEBUGLOG(("process_psp_resp_txn::Org Posting Date = [%s]\n",csOrgPostingDate));
								PutField_CString(hContext,"host_posting_date",csOrgPostingDate);

                                			}
                                			if (GetField_CString(hRec,"merchant_id",&csPtr)) {
DEBUGLOG(("process_psp_resp_txn::Org merchant id = [%s]\n",csPtr));
								PutField_CString(hContext,"org_merchant_id",csPtr);
                                			}
                                			if (GetField_CString(hRec,"client_id",&csPtr)) {
DEBUGLOG(("process_psp_resp_txn::Org client_id = [%s]\n",csPtr));
								PutField_CString(hContext,"org_client_id",csPtr);
                                			}
                                			if (GetField_Double(hRec,"txn_amt",&dTmp)) {
DEBUGLOG(("process_psp_resp_txn::Org txn amt = [%lf]\n",dTmp));
								PutField_Double(hContext,"org_txn_amt",dTmp);
							}
/********* tmp *********** net amount ****/
                                			if (GetField_Double(hRec,"net_amt",&dTmp)) {
DEBUGLOG(("process_psp_resp_txn::Org net amt = [%lf]\n",dTmp));
								PutField_Double(hContext,"org_net_amt",dTmp);
								PutField_Double(hContext,"org_merchant_txn_amt",dTmp);
                                			}
/* channel code */
                                			if (GetField_CString(hRec,"channel_code",&csPtr)) {
DEBUGLOG(("process_psp_resp_txn::Org Channel Code = [%s]\n",csPtr));
								PutField_CString(hContext,"org_channel_code",csPtr);
                                			}
/* service code */
                                			if (GetField_CString(hRec,"service_code",&csPtr)) {
DEBUGLOG(("process_psp_resp_txn::Org service code = [%s]\n",csPtr));
								PutField_CString(hContext,"org_service_code",csPtr);
                                			}

                               			hRec = RecordSet_GetNext(rRecordSet);
                        			}
                			}
                			else {
DEBUGLOG(("process_psp_resp_txn:: not found record for [%s]\n",csOrgTxnSeq));
                			}
				}
/* Get Txn Detail */
				if (iRet == PD_OK) {
					RecordSet_Destroy(rRecordSet);
                			DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
                			if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("process_psp_resp_txn::found record = [%s]\n",csOrgTxnSeq));
                        			hRec = RecordSet_GetFirst(rRecordSet);
                        			while (hRec) {
/*org txn country */
                                			if (GetField_CString(hRec,"txn_country",&csPtr)) {
DEBUGLOG(("process_psp_resp_txn::Org txn country = [%s]\n",csPtr));
								PutField_CString(hContext,"org_txn_country",csPtr);
                                			}
/*org txn ccy */
                                			if (GetField_CString(hRec,"txn_ccy",&csPtr)) {
DEBUGLOG(("process_psp_resp_txn::Org txn ccy = [%s]\n",csPtr));
								PutField_CString(hContext,"org_txn_ccy",csPtr);
                                			}
/* pay_method */
                                			if (GetField_CString(hRec,"selected_pay_method",&csPtr)) {
DEBUGLOG(("process_psp_resp_txn::Org pay_method = [%s]\n",csPtr));
								PutField_CString(hContext,"org_pay_method",csPtr);
                                			}
/* customer_group */
                                			if (GetField_CString(hRec,"customer_group",&csPtr)) {
DEBUGLOG(("process_psp_resp_txn::org_customer_group = [%s]\n",csPtr));
								PutField_CString(hContext,"org_customer_group",csPtr);
                                			}
							if (GetField_CString(hRec,"customer_tag",&csPtr)) {
DEBUGLOG(("process_psp_resp_txn::org_customer_tag = [%s]\n",csPtr));
								PutField_CString(hContext,"org_customer_tag",csPtr);
							}


 	                              			hRec = RecordSet_GetNext(rRecordSet);
                        			}
					}
				}
/* check if it is none same date response */
				if (iRet == PD_OK) {
                       			if (GetField_CString(hContext,"PHDATE",&csPostingDate)) {
DEBUGLOG(("process_psp_resp_txn::Posting Date = [%s]\n",csPostingDate));
						if (strcmp(csPostingDate,csOrgPostingDate)) {
							hLRsp = (hash_t*) malloc (sizeof(hash_t));
							hash_init(hLRsp,0);
/* txn seq */
							PutField_CString(hLRsp,"txn_seq",csOrgTxnSeq);
DEBUGLOG(("process_psp_resp_txn::!!! none same date response \n"));
ERRLOG("[%s]-[%s]none same date response [%s][%s]\n",csTxnCode,csOrgTxnSeq,csPostingDate,csOrgPostingDate);


/* current posting date */
							PutField_CString(hLRsp,"host_posting_date",csPostingDate);
/* local tm date */
							if (GetField_CString(hContext,"local_tm_date",&csPtr)) {
                        					PutField_CString(hLRsp,"local_tm_date",csPtr);
                					}

					                if (GetField_CString(hContext,"local_tm_time",&csPtr)) {
                	        				PutField_CString(hLRsp,"local_tm_time",csPtr);
                					}
/* create and update user */
                        				PutField_CString(hLRsp,"create_user",PD_UPDATE_USER);
                        				PutField_CString(hLRsp,"update_user",PD_UPDATE_USER);
	
      							DBObjPtr = CreateObj(DBPtr,"DBNonPostingDateResp","Add");
                					iRet = (unsigned long)(DBObjPtr)(hLRsp);
       							hash_destroy(hLRsp);
       							FREE_ME(hLRsp);          
						
						}
						else {
DEBUGLOG(("process_psp_resp_txn::!!! same date response \n"));
						}
                        		}
				}

				if (iRet == PD_OK && iVoidTxn == PD_TRUE) {
					char*   csTxn;
	                                csTxn = (char*) malloc (sizeof(PD_TMP_BUF_LEN));
	                                sprintf(csTxn,"TxnWebOnUs%s",PD_WITHDRAW_VOID_TXN_CODE);
        	                        TxnObjPtr = CreateObj(TxnPtr,csTxn,"Authorize");
                	                iRet=(unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
DEBUGLOG(("process_psp_resp_txn:: iRet [%d] from %s\n",iRet,csTxn));
                        	        if (iRet == PD_OK)
                                		iRet = PD_SKIP_OK;
				}
				else {	


					if (iRet == PD_OK && iUpdateOnly != PD_TRUE)  {
DEBUGLOG(("process_psp_resp_txn Call UpdateRespTxnLog\n"));
						iRet = UpdateRespTxnLog(hContext,hRequest,hResponse);
/* commit txn before send out ack */
						if(iRet == PD_OK){
							TxnCommit();
						}
					}

					if (iUpdateOnly == PD_TRUE) {
						iRet = UpdateTxnPspDetailLog(hContext,hRequest,hResponse);
/* commit txn before send out ack */
						if(iRet == PD_OK){
							TxnCommit();
						}
					}
/* Send ACK */
					if ((iRet == PD_OK  && iUpdateOnly != PD_TRUE) && 
						(!(strcmp(csTxnCode,PD_DEPOSIT_TXN_CODE)) ||
						!(strcmp(csTxnCode,PD_INITIAL_TXN_CODE)) ||
						!(strcmp(csTxnCode,PD_MOBILE_DSP_CODE)))
						) {
      						TxnObjPtr = CreateObj(TxnPtr,"TxnWebOnUsACK","Authorize");
               					iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
					}
/*********/
/******** reply to remote host if success*/
					if (iRet == PD_OK) {
                                		GetField_Long(hContext,"queue_key",&lKey);

                                		if (GetField_Long(hContext,"response_queue_mtype",&lResponseQueueMtype)) {
DEBUGLOG(("response queue mtype = [%ld]\n",lResponseQueueMtype));
                                		}
                                		msg = (struct msg_t*)malloc(sizeof(struct msg_t)+MAX_MSG_SIZE);
                                		msg->mtype  = lResponseQueueMtype;
DEBUGLOG(("key = [%ld] mtype = [%ld]\n",lKey,lResponseQueueMtype));

                                		long    lRemoteKey;
                                		GetField_Long(hContext,"remote_reply_key",&lRemoteKey);
                                		memset(msg->mtext,0,sizeof(msg->mtext));
                                        	MQ_build_header((unsigned char*)msg->mtext,
                                        			MQ_RESP,
                                        			csChannelCode,
                                        			0,
                                        			NULL,
                                        			lRemoteKey);
DEBUGLOG(("build header\n"));
                                		msg->mtext[MQ_HEADER_LEN] = '\0';
DEBUGLOG(("send len = [%d]\n",MQ_HEADER_LEN));

                                		iRet = MQSend(lKey,msg,MQ_HEADER_LEN );

                				FREE_ME(msg);
					}
/**************************************************************************************/
				}
			}

		}
		else {
DEBUGLOG(("process_psp_resp_txn FERESP*** DO NOTHING\n"));

      			TxnObjPtr = CreateObj(TxnPtr,"TxnWebOnUsFEK","Authorize");
               		iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
			if (iRet == PD_OK) {
				if (GetField_CString(hResponse,"channel_code",&csChannelCode)) {
DEBUGLOG(("process_psp_resp_txn org channel code [%s]found\n",csChannelCode));
				}

				sprintf(csTmpChannelCode,"%c%c%cMsg",csChannelCode[0],tolower(csChannelCode[1]),tolower(csChannelCode[2]));	

DEBUGLOG(("process_psp_resp_txn try to call [%s]->FormatFEMsg\n",csTmpChannelCode));
				MsgObjPtr = CreateObj(MsgPtr,csTmpChannelCode,"FormatFEMsg");
                		h_msg = (hex_t*) malloc (sizeof(hex_t));
                		if ((*MsgObjPtr)(hResponse,h_msg->msg,&h_msg->len) == PD_OK) {
                		}

DEBUGLOG(("process_psp_resp_txn::h_msg->len = [%d][%s]\n",h_msg->len,h_msg->msg));
				GetField_Long(hContext,"queue_key",&lKey);

				if (GetField_Long(hContext,"response_queue_mtype",&lResponseQueueMtype)) {
DEBUGLOG(("process_psp_resp_txn::response queue mtype = [%ld]\n",lResponseQueueMtype));
				}
                		msg = (struct msg_t*)malloc(sizeof(struct msg_t)+MAX_MSG_SIZE);
                		msg->mtype  = lResponseQueueMtype;
DEBUGLOG(("process_psp_resp_txn::key = [%ld] mtype = [%ld]\n",lKey,lResponseQueueMtype));

				long lRemoteKey = 0l;

				GetField_Long(hContext,"remote_reply_key",&lRemoteKey);
                		memset(msg->mtext,0,sizeof(msg->mtext));
                        		MQ_build_header((unsigned char*)msg->mtext,
                        		MQ_RESP,
                        		csChannelCode,
					0,
					NULL,
					lRemoteKey);
DEBUGLOG(("process_psp_resp_txn::build header\n"));
                		memcpy(&msg->mtext[MQ_HEADER_LEN],h_msg->msg,h_msg->len);
                		msg->mtext[MQ_HEADER_LEN + h_msg->len] = '\0';
DEBUGLOG(("process_psp_resp_txn::send len = [%d]\n",MQ_HEADER_LEN + h_msg->len));

                		iRet = MQSend(lKey,msg,MQ_HEADER_LEN + h_msg->len);

                		FREE_ME(h_msg);
                		FREE_ME(msg);
			}
			else {
DEBUGLOG(("process_psp_resp_txn:FEK return iRet = [%d]\n",iRet));
			}
		}
	}

       	hash_destroy(hRequest);
       	FREE_ME(hRequest);          

       	hash_destroy(hResponse);
       	FREE_ME(hResponse);          

       	hash_destroy(hRsp);
       	FREE_ME(hRsp);          

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

	if (iRet == PD_SKIP_OK)
		iRet = PD_OK;

DEBUGLOG(("process_psp_resp_txn::Normal RET = [%d]\n",iRet));
	return iRet;
}
	


int     UpdateRespTxnLog(hash_t *hContext,
                const hash_t* hRequest,
                const hash_t* hResponse)
{                       
        hash_t  *hTxn,*hPspDetail;
        char    *csTmp;
        char    *csTxnSeq;
	char	*csTxnCode;
	char*	csStatus = strdup("");
	char*	csDate= strdup("");
	char*	csTime= strdup("");
	char*	csOrgPostingDate;
	double	dTmp;
	double	dServiceFee = 0.0;
        int 	iRet = PD_OK; 
	//char	*csResultCode;
	char	*csPspChannelCode;
	char	cStatus;
	



        hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0); 

        hPspDetail = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hPspDetail,0); 

	GetField_CString(hContext,"txn_code",&csTxnCode);
DEBUGLOG(("UpdateRespTxnLog:: txn_code = [%s]\n",csTxnCode));

	if(GetField_CString(hContext,"return_psp_channel",&csPspChannelCode)) {
DEBUGLOG(("UpdateRespTxnLog:: return_psp_channel = [%s]\n",csPspChannelCode));
	}
	else {
DEBUGLOG(("UpdateRespTxnLog:: return_psp_channel missing!!\n"));
ERRLOG("WEBChannel::UpdateRespTxnLog:: return_psp_channel missing!!\n");
		iRet = PD_ERR;
	}

	//ECPSS & Yeepay Mobile(YPM) & Heepay & Now2Pay & XJ-CH not return txn_date and fundin date,
	//so txn_date follow the org host posting date,
	//and fundin_date follow the currenct datetime
	if(!strcmp(csPspChannelCode,PD_CHANNEL_ECPSS)||
	   !strcmp(csPspChannelCode,PD_CHANNEL_ECPSSMOBILE)||
	   !strcmp(csPspChannelCode,PD_CHANNEL_YEEPAYMOBILE) ||
	   !strcmp(csPspChannelCode,PD_CHANNEL_HEEPAY) ||
	   !strcmp(csPspChannelCode,PD_CHANNEL_NOW2PAY) ||
	   !strcmp(csPspChannelCode,PD_CHANNEL_N2P_AIPWECHAT) ||
	   !strcmp(csPspChannelCode,PD_CHANNEL_XJ_CHWECHAT) ||
	   !strcmp(csPspChannelCode,PD_CHANNEL_XJ_MOBILE) ||
	   !strcmp(csPspChannelCode,PD_CHANNEL_COALAPAY_EC)
	){
		if(GetField_CString(hContext,"host_posting_date",&csOrgPostingDate)){
			PutField_CString(hPspDetail,"txn_date",csOrgPostingDate);
		}
		
		char csDateTime[PD_DATETIME_LEN+1];
		char csDate[PD_DATE_LEN+1];
		strcpy(csDateTime,getdatetime());
		csDateTime[PD_DATETIME_LEN]='\0';
		strcpy(csDate,csDateTime);
		csDate[PD_DATE_LEN]='\0';
		PutField_CString(hPspDetail,"fundin_date",csDateTime);
		PutField_CString(hPspDetail,"fundin_date_short",csDate);
	}


        if (GetField_CString(hRequest,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("UpdateRespTxnLog:: txn_seq = [%s]\n",csTxnSeq));
                PutField_CString(hTxn,"txn_seq",csTxnSeq);
                PutField_CString(hPspDetail,"txn_seq",csTxnSeq);
                        
        	PutField_CString(hTxn,"update_user",PD_UPDATE_USER);

DEBUGLOG(("UpdateRespTxnLog:: get status \n"));
/* response */
                if (GetField_CString(hRequest,"status",&csStatus)) {
DEBUGLOG(("UpdateRespTxnLog:: status = [%s]\n",csStatus));
                        PutField_CString(hPspDetail,"notice_status",csStatus);
                }
		else {
DEBUGLOG(("UpdateRespTxnLog:: status not found\n"));
		}

                
		long	lResult = 0L;

		/* for manual approval */
		if (!strcmp(csPspChannelCode, "internal")) {
			lResult = PD_OK;
		}
		else {
			DBObjPtr = CreateObj(DBPtr,"DBMessages","c2i");
			iRet = (unsigned long)(*DBObjPtr)(csPspChannelCode,&lResult,csStatus);
DEBUGLOG(("UpdateRespTxnLog:: response code from PSP [%s] = [%s], internal code = [%d]\n",csPspChannelCode,csStatus,lResult));
		}


		if (lResult == PD_OK) {
               		PutField_Char(hTxn,"status",PD_COMPLETE);
DEBUGLOG(("UpdateRespTxnLog:: status = [%c]\n",PD_COMPLETE));
			PutField_CString(hTxn,"sub_status",PD_PSP_CONFIRMED);

                	PutField_Char(hTxn,"ar_ind",PD_ACCEPT);
			cStatus=PD_ACCEPT;
DEBUGLOG(("UpdateRespTxnLog:: ar_ind = [%c]\n",PD_ACCEPT));


			if (!strcmp(csTxnCode,PD_DEPOSIT_TXN_CODE) ||
                         	  !strcmp(csTxnCode,PD_INITIAL_TXN_CODE) ||
                           	!strcmp(csTxnCode,PD_MOBILE_DSP_CODE)) {
DEBUGLOG(("Handle Post Txn\n"));
				char*	csTxn;
				csTxn = (char*) malloc (PD_TMP_BUF_LEN +1);
				sprintf(csTxn,"TxnWebOnUs%s",csTxnCode);
                               	TxnObjPtr = CreateObj(TxnPtr,csTxn,"PostTxn");
       		       		iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
DEBUGLOG(("UpdateRespTxnLog:: response from [%s] = [%d]\n",csTxn,iRet));
				FREE_ME(csTxn);

				if (GetField_Double(hContext,"net_amt",&dTmp)) {
DEBUGLOG(("UpdateRespTxnLog:: net_amt = [%lf]\n",dTmp));
					PutField_Double(hTxn,"net_amt",dTmp);
				}
			}

			if (iRet == PD_OK) {
				if (GetField_CString(hContext,"approval_date",&csTmp)) {
DEBUGLOG(("UpdateRespTxnLog:: approval_date = [%s]\n",csTmp));
                               		PutField_CString(hTxn,"approval_date",csTmp);
                        	}
                        	else {
ERRLOG("WEBChannel:: approval_date is missing for txn seq [%s]\n",csTxnSeq);
DEBUGLOG(("UpdateRespTxnLog:: approval_date is missing for txn seq [%s]\n",csTxnSeq));
                                	iRet = INT_ERR;
                        	}
                        	if (GetField_CString(hContext,"approval_timestamp",&csTmp)) {
DEBUGLOG(("UpdateRespTxnLog:: approval_timestamp = [%s]\n",csTmp));
                                	PutField_CString(hTxn,"approval_timestamp",csTmp);
                        	}
                        	else {
ERRLOG("WEBChannel:: approval_timestamp is missing for txn seq [%s]\n",csTxnSeq);
DEBUGLOG(("UpdateRespTxnLog:: approval_timestamp is missing for txn seq [%s]\n",csTxnSeq));
                                	iRet = INT_ERR;
                        	}
			}

/*			else if(!strcmp(csTxnCode,PD_WITHDRAW_BATCH_TXN_CODE)){
DEBUGLOG(("UpdateRespTxnLog:: Call BOPsp CalPspFee\n"));
				BOObjPtr = CreateObj(BOPtr,"BOPsp","CalPspFee");
				iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("UpdateRespTxnLog:: BOStat::CalPspFee() result = [%d]\n",iRet));

DEBUGLOG(("UpdateRespTxnLog Call BOBalance::UpdatePayoutResponse\n"));
				PutField_Char(hContext,"response_mode",PD_ACCEPT);

				BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutResponse");
				iRet = (unsigned long)(BOObjPtr)(hContext);
				if(iRet!=PD_OK){
DEBUGLOG(("BOBalance::UpdatePayoutResponse failed\n"));
				}

			}
*/


		}
		else {
			if(lResult == INT_DEPOSIT_PROCESSING){
				iRet = PD_SKIP_OK;
                	}

			else {
				int	iIgnoreNACK = PD_FALSE;	
				recordset_t     *rRset;
				rRset = (recordset_t*) malloc (sizeof(recordset_t));
				recordset_init(rRset,0);
				hash_t	*hRec;

				if (GetField_CString(hContext,"org_merchant_id",&csTmp)){
					DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GetMerchant");
					if ((*DBObjPtr)(csTmp, rRset) == PD_OK){
						hRec = RecordSet_GetFirst(rRset);
						while (hRec) {
							if (GetField_Int(hRec,"ignore_nack",&iIgnoreNACK)) {
DEBUGLOG(("UpdateRespTxnLog::GetMerchant - ignore_nack = [%d]\n",iIgnoreNACK));
								if (iIgnoreNACK == PD_FALSE) {
                							PutField_Char(hTxn,"status",PD_COMPLETE);
                							PutField_Char(hTxn,"ar_ind",PD_REJECT);
									cStatus='R';
									PutField_CString(hTxn,"sub_status",PD_PSP_REJECT);
DEBUGLOG(("UpdateRespTxnLog:: ar_ind = [%c]\n",PD_REJECT));
								}
							}
							hRec = RecordSet_GetNext(rRset);
						}
					}
				}

				RecordSet_Destroy(rRset);
				FREE_ME(rRset);
/*
				if(!strcmp(csTxnCode,PD_WITHDRAW_BATCH_TXN_CODE)){
DEBUGLOG(("UpdateRespTxnLog Call BOBalance::UpdatePayoutAmount\n"));

					BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
					iRet = (unsigned long)(BOObjPtr)(hContext);
					if(iRet!=PD_OK){
DEBUGLOG(("BOBalance::UpdatePayoutAmount failed\n"));
					}
				}
*/
			}

/*!!!!!!*/
/* Temporary solution for response when NACK */

			long    lKey,lResponseQueueMtype;
			long    lRemoteKey;
			//char	*csChannelCode = NULL;
			int	iTmpRet = INT_NO_ERR;
			struct  msg_t*  msg;


			GetField_Long(hContext,"queue_key",&lKey);


			if (GetField_Long(hContext,"response_queue_mtype",&lResponseQueueMtype)) {
DEBUGLOG(("UpdateRespTxnLog queue mtype = [%ld]\n",lResponseQueueMtype));
			}

			msg = (struct msg_t*)malloc(sizeof(struct msg_t)+MAX_MSG_SIZE);
			msg->mtype  = lResponseQueueMtype;
DEBUGLOG(("UpdateRespTxnLog key = [%ld] mtype = [%ld]\n",lKey,lResponseQueueMtype));

			GetField_Long(hContext,"remote_reply_key",&lRemoteKey);
			memset(msg->mtext,0,sizeof(msg->mtext));
			MQ_build_header((unsigned char*)msg->mtext,
					MQ_RESP,
					PD_CHANNEL_WEB,
					0,
					NULL,
					lRemoteKey);
DEBUGLOG(("UpdateRespTxnLog build header\n"));
			msg->mtext[MQ_HEADER_LEN] = '\0';
DEBUGLOG(("UpdateRespTxnLog send len = [%d]\n",MQ_HEADER_LEN));

			iTmpRet = MQSend(lKey,msg,MQ_HEADER_LEN );

			FREE_ME(msg);

/*!!!!!!*/

		}





/* psp detail */
/* error code */
        	if (GetField_CString(hRequest,"error_code",&csTmp)) {
			char *csBuf;
			char *csPspChannelCode;
			int  iDefErr=1;
			long  lIntErr=0L;

			PutField_CString(hPspDetail,"error_code",csTmp);
DEBUGLOG(("UpdateRespTxnLog:: error_code = [%s]\n",csTmp));

			if(GetField_CString(hContext,"psp_channel_code",&csPspChannelCode)){
				DBObjPtr = CreateObj(DBPtr,"DBMessages","c2i");
				if ((*DBObjPtr)(csPspChannelCode,lIntErr,csTmp) == PD_OK) {
					iDefErr=0;
					csBuf = (char*) malloc (128);
					sprintf(csBuf,"%ld",lIntErr);
					PutField_CString(hTxn,"response_code",csBuf);
DEBUGLOG(("UpdateRespTxnLog:: [%s] error_code[%s]->response_code[%s]\n",csPspChannelCode,csTmp,csBuf));
					FREE_ME(csBuf);
				}
			}
			
			if(iDefErr){
				PutField_CString(hTxn,"response_code",csTmp);
DEBUGLOG(("UpdateRespTxnLog:: response_code = %s\n",csTmp));
			}


//			PutField_CString(hTxn,"response_code",csTmp);
//DEBUGLOG(("UpdateRespTxnLog:: response_code = [%s]\n",csTmp));
/* ******************** */
		}
/* txn_date */
        	if (GetField_CString(hRequest,"txn_date",&csTmp)) {
			strcpy(csDate,csTmp);
                        csDate[PD_DATE_LEN]='\0';
                        if(strlen(csTmp)>PD_DATE_LEN){
                                strcpy(csTime,&csTmp[PD_DATE_LEN]);
                                csTime[PD_TIME_LEN]='\0';
                                PutField_CString(hPspDetail,"txn_time",csTime);
                        }
			PutField_CString(hPspDetail,"txn_date",csDate);
DEBUGLOG(("UpdateRespTxnLog:: txn_date = [%s]\n",csTmp));
		}
/* bank code */
        	//if (GetField_CString(hRequest,"bank_code",&csTmp)) {
        	if (GetField_CString(hRequest,"internal_bank_code",&csTmp)) {
			PutField_CString(hPspDetail,"bank_code",csTmp);
DEBUGLOG(("UpdateRespTxnLog:: bank_code = [%s]\n",csTmp));
		}
/* bank name */
        	if (GetField_CString(hRequest,"bank_name",&csTmp)) {
			PutField_CString(hPspDetail,"bank_name",csTmp);
DEBUGLOG(("UpdateRespTxnLog:: bank_name = [%s]\n",csTmp));
		}
/* bank_branch */
        	if (GetField_CString(hRequest,"bank_branch",&csTmp)) {
			PutField_CString(hPspDetail,"bank_branch",csTmp);
DEBUGLOG(("UpdateRespTxnLog:: bank_branch = [%s]\n",csTmp));
		}
/* account_name */
        	if (GetField_CString(hRequest,"account_name",&csTmp)) {
		//	strcpy(csAccName,code_convert(PD_BIG5_CODE,PD_HOST_CODE,csTmp));
		//	PutField_CString(hPspDetail,"account_name",csAccName);
			PutField_CString(hPspDetail,"account_name",csTmp);
DEBUGLOG(("UpdateRespTxnLog:: account_name = [%s]\n",csTmp));
		}
/* account_no */
        	if (GetField_CString(hRequest,"account_no",&csTmp)) {
			PutField_CString(hPspDetail,"account_no",csTmp);
DEBUGLOG(("UpdateRespTxnLog:: account_no = [%s]\n",csTmp));
		}
/* batch_id */
        	if (GetField_CString(hRequest,"batch_id",&csTmp)) {
			PutField_CString(hPspDetail,"batch_id",csTmp);
DEBUGLOG(("UpdateRespTxnLog:: batch_id = [%s]\n",csTmp));
		}
/* fundin_date */
        	if (GetField_CString(hRequest,"fundin_date",&csTmp)) {
			PutField_CString(hPspDetail,"fundin_date",csTmp);
DEBUGLOG(("UpdateRespTxnLog:: fundin_date = [%s]\n",csTmp));

			char csDate[PD_DATE_LEN+1];
			strcpy(csDate,csTmp);
			csDate[PD_DATE_LEN]='\0';
			PutField_CString(hPspDetail,"fundin_date_short",csDate);
		}

		else if (GetField_CString(hRequest,"tm_date",&csTmp)) {
			PutField_CString(hPspDetail,"fundin_date_short",csTmp);

                        char csDateTime[PD_DATETIME_LEN+1];
                        strcpy(csDateTime,csTmp);
                        if(GetField_CString(hRequest,"tm_time",&csTmp)){
                                strcat(csDateTime,csTmp);
                        }
                        csDateTime[strlen(csDateTime)]='\0';
                        PutField_CString(hPspDetail,"fundin_date",csDateTime);
DEBUGLOG(("UpdateRespTxnLog:: fundin_date = [%s]\n",csDateTime));
                }

/* fundout_date */
        	if (GetField_CString(hRequest,"fundout_date",&csTmp)) {
			PutField_CString(hPspDetail,"fundout_date",csTmp);
DEBUGLOG(("UpdateRespTxnLog:: fundout_date = [%s]\n",csTmp));
		}
/* service_fee */
        	if (GetField_Double(hContext,"precal_fee",&dServiceFee)) {
DEBUGLOG(("UpdateRespTxnLog:: precal service_fee = [%f]\n",dServiceFee));
			PutField_Double(hPspDetail,"service_fee",dServiceFee);
		}
		else {
        		if (GetField_Double(hRequest,"service_fee",&dServiceFee)) {
				PutField_Double(hPspDetail,"service_fee",dServiceFee);
DEBUGLOG(("UpdateRespTxnLog:: response service_fee = [%f]\n",dServiceFee));
			}
		}
/* tid */
        	if (GetField_CString(hRequest,"tid",&csTmp)) {
			PutField_CString(hPspDetail,"tid",csTmp);
DEBUGLOG(("UpdateRespTxnLog:: tid = [%s]\n",csTmp));
		}
        
/* bank_bill_no */
        	if (GetField_CString(hRequest,"bank_bill_no",&csTmp)) {
			PutField_CString(hPspDetail,"bank_bill_no",csTmp);
DEBUGLOG(("UpdateRespTxnLog:: bank_bill_no = [%s]\n",csTmp));
		}
/* ret_bank_code */
                if (GetField_CString(hRequest,"ret_bank_code",&csTmp)) {
                        PutField_CString(hPspDetail,"ret_bank_code",csTmp);
DEBUGLOG(("UpdateRespTxnLog:: ret_bank_code = [%s]\n",csTmp));
                }
        
/* open_bal */
        	if (GetField_Double(hContext,"merchant_open_bal",&dTmp)) {
			PutField_Double(hTxn,"open_bal",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: open_bal= [%f]\n",dTmp));
		}
/* open_bal_settlement */
        	if (GetField_Double(hContext,"merchant_open_bal_settlement",&dTmp)) {
			PutField_Double(hTxn,"open_bal_settlement",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: open_bal_settlement= [%f]\n",dTmp));
		}
/* current_bal */
        	if (GetField_Double(hContext,"current_bal",&dTmp)) {
			PutField_Double(hTxn,"current_bal",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: current_bal= [%f]\n",dTmp));
		}

/* current_bal_settlement */
        	if (GetField_Double(hContext,"current_bal_settlement",&dTmp)) {
			PutField_Double(hTxn,"current_bal_settlement",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: current_bal_settlement= [%f]\n",dTmp));
		}
        
/* net_bal 
        	if (GetField_Double(hContext,"net_bal",&dTmp)) {
			PutField_Double(hTxn,"net_bal",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: net_bal= [%f]\n",dTmp));
		}
*/
        
        
/* total_float*/
        	if (GetField_Double(hContext,"total_float",&dTmp)) {
			PutField_Double(hTxn,"total_float",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: total_float= [%f]\n",dTmp));
		}
/* total_float_settlement*/
        	if (GetField_Double(hContext,"total_float_settlement",&dTmp)) {
			PutField_Double(hTxn,"total_float_settlement",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: total_float_settlement= [%f]\n",dTmp));
		}
        
/* total_float_after_payout*/
        	if (GetField_Double(hContext,"total_float_after_payout",&dTmp)) {
			PutField_Double(hTxn,"total_float_after_payout",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: total_float_after_payout= [%f]\n",dTmp));
		}
/* total_reserved_amount*/
        	if (GetField_Double(hContext,"total_reserved_amount",&dTmp)) {
			PutField_Double(hTxn,"total_reserved_amount",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: total_reserved_amount= [%f]\n",dTmp));
		}
        
/* total_hold*/
        	if (GetField_Double(hContext,"total_hold",&dTmp)) {
			PutField_Double(hTxn,"total_hold",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: total_hold= [%f]\n",dTmp));
		}
/* total_hold_settlement*/
        	if (GetField_Double(hContext,"total_hold_settlement",&dTmp)) {
			PutField_Double(hTxn,"total_hold_settlement",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: total_hold_settlement= [%f]\n",dTmp));
		}

/* fundin payout */
        	if (GetField_Double(hContext,"fundin_payout",&dTmp)) {
			PutField_Double(hTxn,"fundin_payout",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: fundin_payout= [%f]\n",dTmp));
		}
/* reserved payout */
        	if (GetField_Double(hContext,"reserved_payout",&dTmp)) {
			PutField_Double(hTxn,"reserved_payout",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: reserved_payout= [%f]\n",dTmp));
		}
        
/* settlement_in_transit
        	if (GetField_Double(hContext,"settlement_in_transit",&dTmp)) {
			PutField_Double(hTxn,"settlement_in_transit",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: settlement_in_transit= [%f]\n",dTmp));
		}
*/
        

/* psp_balance*/
        	if (GetField_Double(hContext,"psp_balance",&dTmp)) {
			PutField_Double(hPspDetail,"bal",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: psp_balance = [%f]\n",dTmp));
		}
/* psp_total_float*/
        	if (GetField_Double(hContext,"psp_total_float",&dTmp)) {
			PutField_Double(hPspDetail,"total_float",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: psp_total_float = [%f]\n",dTmp));
		}
/* psp_total_hold*/
        	if (GetField_Double(hContext,"psp_total_hold",&dTmp)) {
			PutField_Double(hPspDetail,"total_hold",dTmp);
DEBUGLOG(("UpdateRespTxnLog:: psp_total_hold = [%f]\n",dTmp));
		}
        
/*reserve_amt*/
		if (GetField_Double(hContext,"reserve_amt",&dTmp)) {
DEBUGLOG(("UpdateRespTxnLog:: reserve_amt = [%f]\n",dTmp));
                	PutField_Double(hTxn,"reserve_amt",dTmp);
                }

        
                if (iRet == PD_OK) {
DEBUGLOG(("UpdateRespTxnLog:: Call Update Transaction\n"));
                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                        iRet = (unsigned long)(*DBObjPtr)(hTxn);
                }       
                if (iRet == PD_OK) {
DEBUGLOG(("UpdateRespTxnLog:: Call Update Transaction Detail\n"));
                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                        iRet = (unsigned long)(*DBObjPtr)(hTxn);
                }       
                if (iRet == PD_OK) {
DEBUGLOG(("UpdateRespTxnLog:: Call Update TxnPspDetail\n"));
                        DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
                        iRet = (unsigned long)(*DBObjPtr)(hPspDetail);
                }

		if (iRet == PD_OK && cStatus == PD_ACCEPT) {
			hash_t		*hRec;
			hash_t		*hTxnEle;
        		recordset_t     *rRecordSet;
        		rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        		recordset_init(rRecordSet,0);

        		hTxnEle = (hash_t*)  malloc (sizeof(hash_t));
        		hash_init(hTxnEle,0); 

			DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","GetTxnPspDetail");
                     	if (!(*DBObjPtr)(csTxnSeq,rRecordSet)) {
/* txn_seq */
				PutField_CString(hTxnEle,"txn_seq",csTxnSeq);
                       		hRec = RecordSet_GetFirst(rRecordSet);
                                while(hRec){
/* txn_ccy */
             				if (GetField_CString(hRec,"txn_ccy",&csTmp)) {
DEBUGLOG(("UpdateRespTxnLog::GetTxnPsp - psp_txn_ccy = [%s]\n",csTmp));
                                        	PutField_CString(hTxnEle,"txn_ccy",csTmp);
                                       	}

                                       	if (GetField_Double(hRec,"txn_amt",&dTmp)) {
DEBUGLOG(("UpdateRespTxnLog::GetTxnPsp - txn amt = [%lf]\n",dTmp));
						PutField_Double(hTxnEle,"txn_amt",dTmp);
                                        }

                                        hRec = RecordSet_GetNext(rRecordSet);
				}//while

DEBUGLOG(("UpdateRespTxnLog:: ************** try to add txn element for psp\n"));
/* add Txn Amount */
/* element type */
				PutField_CString(hTxnEle,"txn_element_type",PD_ELEMENT_TXN_AMT);

/* party type */
				PutField_Char(hTxnEle,"party_type",PD_TYPE_PSP);
/* amount type */
				PutField_CString(hTxnEle,"amount_type",PD_CR);

                        	DBObjPtr = CreateObj(DBPtr,"BOTxnElements","AddPspTxnElement");
                        	iRet = (unsigned long)(*DBObjPtr)(hTxnEle);
			
				if (iRet == PD_OK && dServiceFee > 0.0) {
/* add txn fee element for psp */
/* service fee */
					PutField_Double(hTxnEle,"txn_amt",dServiceFee);
/* element type */
					PutField_CString(hTxnEle,"txn_element_type",PD_ELEMENT_TXN_FEE);
/* amount type */
					PutField_CString(hTxnEle,"amount_type",PD_DR);
DEBUGLOG(("UpdateRespTxnLog:: ************** try to add txn element for psp service fee\n"));
                        		DBObjPtr = CreateObj(DBPtr,"BOTxnElements","AddPspTxnElement");
                        		iRet = (unsigned long)(*DBObjPtr)(hTxnEle);
				}
                        }
                        else{
ERRLOG("process_psp_resp_txn:: PSP NOT FOUND\n");
DEBUGLOG(("hannel process_psp_resp_txn:: PSP NOT FOUND\n"));
			}

        		RecordSet_Destroy(rRecordSet);
        		FREE_ME(rRecordSet);
        		hash_destroy(hTxnEle);
        		FREE_ME(hTxnEle);          
		}
                        
        }
        else                    
                iRet = PD_ERR;

        hash_destroy(hTxn);
        FREE_ME(hTxn);          

        hash_destroy(hPspDetail);
        FREE_ME(hPspDetail);          
                        
	FREE_ME(csStatus);
	FREE_ME(csDate);
	FREE_ME(csTime);
DEBUGLOG(("UpdateRespTxnLog:: Ret [%d]\n",iRet));
        return  iRet;   
}

int     UpdateTxnPspDetailLog(hash_t *hContext,
                const hash_t* hRequest,
                const hash_t* hResponse)
{                       
        hash_t  *hPspDetail;
        char    *csTmp;
        char    *csTxnSeq;
        int 	iRet = PD_OK; 
	char	*csStatus= strdup("");
	char*   csDate= strdup("");
        char*   csTime= strdup("");
	//double	dTmp=0.0;	



        hPspDetail = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hPspDetail,0); 


        if (GetField_CString(hRequest,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("UpdateTxnPspDetailLog:: txn_seq = [%s]\n",csTxnSeq));
                PutField_CString(hPspDetail,"txn_seq",csTxnSeq);
                        

DEBUGLOG(("UpdateTxnPspDetailLog:: get status \n"));
/* response */
                if (GetField_CString(hRequest,"status",&csStatus)) {
DEBUGLOG(("UpdateTxnPspDetailLog:: status = [%s]\n",csStatus));
                        PutField_CString(hPspDetail,"notice_status",csStatus);
                }
		else {
DEBUGLOG(("UpdateTxnPspDetailLog:: status not found\n"));
		}

                
/* txn_date */
        	if (GetField_CString(hRequest,"txn_date",&csTmp)) {
			strcpy(csDate,csTmp);
                        csDate[PD_DATE_LEN]='\0';
                        if(strlen(csTmp)>PD_DATE_LEN){
                                strcpy(csTime,&csTmp[PD_DATE_LEN]);
                                csTime[PD_TIME_LEN]='\0';
                                PutField_CString(hPspDetail,"txn_time",csTime);
                        }
			PutField_CString(hPspDetail,"txn_date",csDate);
DEBUGLOG(("UpdateTxnPspDetailLog:: txn_date = [%s]\n",csTmp));
		}
/* bank code */
        	if (GetField_CString(hRequest,"internal_bank_code",&csTmp)) {
			PutField_CString(hPspDetail,"bank_code",csTmp);
DEBUGLOG(("UpdateTxnPspDetailLog:: bank_code = [%s]\n",csTmp));
		}
/* bank name */
        	if (GetField_CString(hRequest,"bank_name",&csTmp)) {
			PutField_CString(hPspDetail,"bank_name",csTmp);
DEBUGLOG(("UpdateTxnPspDetailLog:: bank_name = [%s]\n",csTmp));
		}
/* bank_branch */
        	if (GetField_CString(hRequest,"bank_branch",&csTmp)) {
			PutField_CString(hPspDetail,"bank_branch",csTmp);
DEBUGLOG(("UpdateTxnPspDetailLog:: bank_branch = [%s]\n",csTmp));
		}
/* account_name */
        	if (GetField_CString(hRequest,"account_name",&csTmp)) {
			PutField_CString(hPspDetail,"account_name",csTmp);
DEBUGLOG(("UpdateTxnPspDetailLog:: account_name = [%s]\n",csTmp));
		}
/* account_no */
        	if (GetField_CString(hRequest,"account_no",&csTmp)) {
			PutField_CString(hPspDetail,"account_no",csTmp);
DEBUGLOG(("UpdateTxnPspDetailLog:: account_no = [%s]\n",csTmp));
		}
/* batch_id */
        	if (GetField_CString(hRequest,"batch_id",&csTmp)) {
			PutField_CString(hPspDetail,"batch_id",csTmp);
DEBUGLOG(("UpdateTxnPspDetailLog:: batch_id = [%s]\n",csTmp));
		}
/* fundin_date */
        	if (GetField_CString(hRequest,"fundin_date",&csTmp)) {
			PutField_CString(hPspDetail,"fundin_date",csTmp);
DEBUGLOG(("UpdateTxnPspDetailLog:: fundin_date = [%s]\n",csTmp));
		}

/* fundout_date */
        	if (GetField_CString(hRequest,"fundout_date",&csTmp)) {
			PutField_CString(hPspDetail,"fundout_date",csTmp);
DEBUGLOG(("UpdateTxnPspDetailLog:: fundout_date = [%s]\n",csTmp));
		}
/* tid */
        	if (GetField_CString(hRequest,"tid",&csTmp)) {
			PutField_CString(hPspDetail,"tid",csTmp);
DEBUGLOG(("UpdateTxnPspDetailLog:: tid = [%s]\n",csTmp));
		}
        
/* bank_bill_no */
        	if (GetField_CString(hRequest,"bank_bill_no",&csTmp)) {
			PutField_CString(hPspDetail,"bank_bill_no",csTmp);
DEBUGLOG(("UpdateTxnPspDetailLog:: bank_bill_no = [%s]\n",csTmp));
		}

/* ret_bank_code */
                if (GetField_CString(hRequest,"ret_bank_code",&csTmp)) {
                        PutField_CString(hPspDetail,"ret_bank_code",csTmp);
DEBUGLOG(("UpdateTxnPspDetailLog:: ret_bank_code = [%s]\n",csTmp));
                }
        
/* service_fee */
/////cannot update, the actual one may not equal to the precal one
/*
        	if (GetField_Double(hRequest,"service_fee",&dTmp)) {
			PutField_Double(hPspDetail,"service_fee",dTmp);
DEBUGLOG(("UpdateTxnPspDetailLog:: service_fee = [%lf]\n",dTmp));
		}
*/        
                if (iRet == PD_OK) {
DEBUGLOG(("UpdateTxnPspDetailLog:: Call Update TxnPspDetail\n"));
                        DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
                        iRet = (unsigned long)(*DBObjPtr)(hPspDetail);
                }

        }
        else                    
                iRet = PD_ERR;

        hash_destroy(hPspDetail);
        FREE_ME(hPspDetail);          
                        
	FREE_ME(csStatus);
	FREE_ME(csDate);
	FREE_ME(csTime);
DEBUGLOG(("UpdateRespTxnLog:: Ret [%d]\n",iRet));
        return  iRet;   
}


int     process_payout_resp_txn(hash_t *hContext,
                                const hash_t *hRequest,
                                hash_t *hResponse){
	int	iRet = PD_OK;
	//int	iStatus=0;
	char*	csOrgTxnSeq;
	char*	csUploadTxnSeq;
	char*	csOrgPostingDate;
	char*	csPostingDate;
	char*	csStatus;
	char*	csPtr;
	char*	csTmp;
	char	*csResultCode;
	char	*csPspChannelCode;
	char	*csCcy;
	char    *csCode;
        char    *csValue;
        char    *csPspId;
	char    *csChannelCode;

	//int	iVoidTxn = PD_FALSE;
	int	iFailTxn = PD_FALSE;
	double	dTmp = 0.0;
	double	dAmt = 0.0;
	double	dServiceFee = 0.0;
	char	cTmp;
	char	*csTmpRemark;
	csTmpRemark = (char*) malloc (128);

	hash_t	*hRec, *hLRsp, *hTxn, *hElement, *hOrgTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);
	hOrgTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hOrgTxn,0);
	hElement = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hElement,0);
        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	if(GetField_CString(hContext,"return_psp_channel",&csPspChannelCode)) {
DEBUGLOG(("process_payout_resp_txn:: return_psp_channel = [%s]\n",csPspChannelCode));
        }
        else {
DEBUGLOG(("process_payout_resp_txn:: return_psp_channel missing!!\n"));
ERRLOG("WEBChannel::process_payout_resp_txn:: return_psp_channel missing!!\n");
                iRet = INT_ERR;
        }

	if (!GetField_CString(hRequest,"txn_seq",&csOrgTxnSeq)) {
		iRet = INT_TXN_ID_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("process_payout_resp_txn txn id not found\n"));
ERRLOG("WEBChannel::process_payout_resp_txn  txn id not found\n");
	}
	else{
		PutField_CString(hTxn,"txn_seq",csOrgTxnSeq);
DEBUGLOG(("process_payout_resp_txn: txn_id = [%s] \n",csOrgTxnSeq));
	}
	
	if(GetField_CString(hRequest,"status",&csStatus)){
DEBUGLOG(("process_payout_resp_txn: status = [%s] \n",csStatus));
		if (!strcmp(csPspChannelCode,PD_CHANNEL_TWV)) {
			csResultCode = strdup(PD_TWV_WTD_NOTICE_ACCEPT);
		}
		else 
			csResultCode = strdup(PD_CN_PSP_SUCCESS);
		
		PutField_CString(hTxn,"notice_status",csStatus);
		if (strcmp(csStatus,csResultCode)){
			iFailTxn = PD_TRUE;
		}
	}
	else{
		iRet = INT_ERR;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("process_payout_resp_txn: status not found!!\n"));
ERRLOG("WEBChannel::process_payout_resp_txn: status not found!!\n");
	}

	if(GetField_CString(hRequest,"txn_date",&csTmp)){
		PutField_CString(hTxn,"txn_date",csTmp);
DEBUGLOG(("process_payout_resp_txn::txn_date = [%s]\n",csTmp));
	}
	if(GetField_CString(hRequest,"fundout_date",&csTmp)){
		PutField_CString(hTxn,"fundout_date",csTmp);
DEBUGLOG(("process_payout_resp_txn::fundout_date = [%s]\n",csTmp));
	}
	if(GetField_CString(hRequest,"error_code",&csTmp)){
		long	lIntErr = 0l;
		PutField_CString(hTxn,"error_code",csTmp);
		PutField_CString(hTxn,"response_code",csTmp);
		PutField_CString(hContext,"response_code",csTmp);
DEBUGLOG(("process_payout_resp_txn::error_code = [%s]\n",csTmp));

		DBObjPtr = CreateObj(DBPtr,"DBMessages","c2i_po");
		if ((*DBObjPtr)(csPspChannelCode,&lIntErr,csTmp) == PD_OK){
			PutField_Int(hTxn,"internal_code",(int)lIntErr);
			PutField_Int(hContext,"internal_code",(int)lIntErr);
DEBUGLOG(("process_payout_resp_txn:: [%s] error_code[%s]->internal_code[%d]\n",csPspChannelCode,csTmp,(int)lIntErr));

                	DBObjPtr = CreateObj(DBPtr,"DBMessages","GetInternalMessage");
			if ((unsigned long)(*DBObjPtr)((int)lIntErr,csTmpRemark) == PD_OK) {
DEBUGLOG(("process_payout_resp_txn:: find remark = [%s]\n",csTmpRemark));
			}
		}

	}

/*
	if(iRet == PD_OK){
		if(csOrgTxnSeq[0] != PD_WITHDRAW_BATCH_PREFIX){
			iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("process_payout_resp_txn txn id prefix[%c] not valid\n",csOrgTxnSeq[0]));
ERRLOG("WEBChannel::process_payout_resp_txn txn_id prefix[%c] not valid\n",csOrgTxnSeq[0]);
		}
	}
*/
/*
	if(iRet == PD_OK){
                DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","MatchRespTxn");
              	if ((unsigned long)(DBObjPtr)(csOrgTxnSeq,PAYOUT_MASTER_TRANSACTION_GENERATED) != PD_FOUND) {
			iRet = INT_ORG_TXN_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);

			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetailByTxnId");
              		if ((unsigned long)(DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
				hRec = RecordSet_GetFirst(rRecordSet);
				while(hRec){
					if(GetField_CString(hRec,"posting_date",&csOrgPostingDate)){
DEBUGLOG(("process_payout_resp_txn: GetDetailByTxnId posting_date = [%s] \n",csOrgPostingDate));
					}
					if(GetField_Int(hRec,"status",&iStatus)){
DEBUGLOG(("process_payout_resp_txn: GetDetailByTxnId status = [%d] \n",iStatus));
					}
					hRec = RecordSet_GetNext(rRecordSet);
				}
				if(iStatus!=0){
					iRet = PD_OK;
				}
				if((iStatus==PAYOUT_MASTER_TRANSACTION_ACCEPT ||
				    iStatus==PAYOUT_MASTER_TRANSACTION_GENERATED) && 
				   strcmp(csStatus,PD_TWV_WTD_NOTICE_REJECT)){
					iVoidTxn = PD_TRUE;
				}
				else if(iStatus==PAYOUT_MASTER_TRANSACTION_ACCEPT && 
					strcmp(csStatus,PD_TWV_WTD_NOTICE_ACCEPT)){
DEBUGLOG(("*process_payout_resp_txn org txn id [%s] Re-send Message where Status[%d]\n",csOrgTxnSeq,iStatus));
ERRLOG("*process_payout_resp_txn org txn id [%s] Re-send Message where Status[%d]\n",csOrgTxnSeq,iStatus);
					
				}
			}
		}
	}
*/
	if(iRet == PD_OK){
DEBUGLOG(("process_payout_resp_txn::Call DBTransaction:GetTxnHeader\n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
                if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("GetTxnHeader::found record = [%s]\n",csOrgTxnSeq));
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
				if (GetField_CString(hRec,"host_posting_date",&csOrgPostingDate)) {
DEBUGLOG(("GetTxnHeader::org_host_posting_date = [%s]\n",csOrgPostingDate));
				}
				if (GetField_CString(hRec,"channel_code",&csChannelCode)) {
DEBUGLOG(("GetTxnHeader::channel_code = [%s]\n",csChannelCode));
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		else{
			iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("process_payout_resp_txn record not found\n"));
ERRLOG("WEBChannel::process_payout_resp_txn record not found\n");
		}
	}

	if(iRet == PD_OK){
		if (GetField_CString(hContext,"PHDATE",&csPostingDate)) {
DEBUGLOG(("process_payout_resp_txn:Posting Date = [%s]\n",csPostingDate));
			if (strcmp(csPostingDate,csOrgPostingDate)) {
				hLRsp = (hash_t*) malloc (sizeof(hash_t));
				hash_init(hLRsp,0);
/* txn seq */
				PutField_CString(hLRsp,"txn_seq",csOrgTxnSeq);
DEBUGLOG(("process_payout_resp_txn:!!! none same date response \n"));
ERRLOG("[%s]none same date response\n",csOrgTxnSeq);

/* current posting date */
				PutField_CString(hLRsp,"host_posting_date",csPostingDate);
/* local tm date */
				if (GetField_CString(hContext,"local_tm_date",&csPtr)) {
					PutField_CString(hLRsp,"local_tm_date",csPtr);
				}

				if (GetField_CString(hContext,"local_tm_time",&csPtr)) {
					PutField_CString(hLRsp,"local_tm_time",csPtr);
				}
				PutField_CString(hLRsp,"create_user",PD_UPDATE_USER);
				PutField_CString(hLRsp,"update_user",PD_UPDATE_USER);

				DBObjPtr = CreateObj(DBPtr,"DBNonPostingDateResp","Add");
				iRet = (unsigned long)(DBObjPtr)(hLRsp);
				hash_destroy(hLRsp);
				FREE_ME(hLRsp);
			}
			else {
DEBUGLOG(("process_payout_resp_txn:!!! same date response \n"));
			}
		}
	}

	if(iRet == PD_OK){
		recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","GetTxnPspDetail");
		iRet = (unsigned long)(*DBObjPtr)(csOrgTxnSeq,rRecordSet);
		if (iRet == PD_OK) {
DEBUGLOG(("GetTxnPspDetail::found record = [%s]\n",csOrgTxnSeq));
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec,"psp_id",&csPspId)) {
DEBUGLOG(("GetTxnPspDetail::psp_id = [%s]\n",csPspId));
				}
				if (GetField_CString(hRec,"txn_ccy",&csCcy)) {
DEBUGLOG(("GetTxnPspDetail::psp_txn_ccy = [%s]\n",csCcy));
				}
				if (GetField_Double(hRec,"txn_amt",&dAmt)) {
DEBUGLOG(("GetTxnPspDetail::txn_amt = [%lf]\n",dAmt));
				}
				if (GetField_Double(hRec,"service_fee",&dServiceFee)) {
DEBUGLOG(("GetTxnPspDetail::service_fee = [%lf]\n",dServiceFee));
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}
	if(iRet == PD_OK){
		if(!iFailTxn){
			//get TxnPspDetail, TxnDetail
			//country, ccy, psp_id, amt, fee
			//get response msg: txn_date,fundout_date, fee (overwrite the fee get from txn_psp_detail)
			//Update PSP balance
			//add elements
DEBUGLOG(("process_payout_resp_txn::Call DBTransaction:GetTxnDetail\n"));
			recordset_init(rRecordSet,0);
			DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
			if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("GetTxnDetail::found record = [%s]\n",csOrgTxnSeq));
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if (GetField_CString(hRec,"txn_country",&csTmp)) {
						PutField_CString(hTxn,"org_txn_country",csTmp);
DEBUGLOG(("GetTxnDetail::txn_country = [%s]\n",csTmp));
					}
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}

			PutField_CString(hTxn,"org_psp_id",csPspId);
			PutField_CString(hTxn,"org_psp_txn_ccy",csCcy);
			PutField_CString(hElement,"txn_seq",csOrgTxnSeq);
			PutField_CString(hElement,"txn_ccy",csCcy);
			PutField_Double(hTxn,"org_dst_net_amt",dAmt);
			PutField_Char(hElement,"party_type",PD_TYPE_PSP);
			PutField_CString(hElement,"amount_type",PD_DR);
			PutField_CString(hElement,"txn_element_type",PD_ELEMENT_TXN_AMT);
			PutField_Double(hElement,"txn_amt",dAmt);
			BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddPspTxnElement");
			iRet = (unsigned long)(*BOObjPtr)(hElement);

			if(iRet==PD_OK){
				PutField_Char(hTxn,"txn_type",PD_TYPE_PAYOUT);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: Call BOPsp CalPspCosts\n"));
                                BOObjPtr = CreateObj(BOPtr,"BOPsp","CalPspCosts");
                                iRet = (unsigned long)(*BOObjPtr)(hTxn,hTxn);
                        }

			if(iRet==PD_OK){
				if(GetField_Double(hRequest,"service_fee",&dServiceFee)){
DEBUGLOG(("process_payout_resp_txn::service_fee = [%lf]\n",dServiceFee));
				}
				if(GetField_Double(hTxn,"precal_fee",&dServiceFee)){
					PutField_Double(hTxn,"service_fee",dServiceFee);
				}
				else{
					if(GetField_Double(hRequest,"service_fee",&dServiceFee)){
DEBUGLOG(("process_payout_resp_txn::service_fee = [%lf]\n",dServiceFee));
						PutField_Double(hTxn,"precal_fee",dServiceFee);
						PutField_Double(hTxn,"service_fee",dServiceFee);
					}
				}

				PutField_Char(hTxn,"response_mode",PD_ACCEPT);
				PutField_Char(hTxn,"party_type",PD_TYPE_PSP);
DEBUGLOG(("process_payout_resp_txn::Call BOBalance:UpdatePayoutAmount\n"));
				BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
				if((unsigned long)(*BOObjPtr)(hTxn)!=PD_OK){
DEBUGLOG(("process_payout_resp_txn::BOBalance:UpdatePayoutAmount Failed\n"));
					iRet = INT_ERR;
				}
				else{
					if (GetField_Double(hTxn,"psp_balance",&dTmp)) {
						PutField_Double(hTxn,"bal",dTmp);
					}
					if (GetField_Double(hTxn,"psp_total_float",&dTmp)) {
						PutField_Double(hTxn,"total_float",dTmp);
					}
					if (GetField_Double(hTxn,"psp_total_hold",&dTmp)) {
						PutField_Double(hTxn,"total_hold",dTmp);
					}
				}
			}
			if(iRet==PD_OK){
				PutField_CString(hElement,"txn_element_type",PD_ELEMENT_TXN_FEE);
				PutField_Double(hElement,"txn_amt",dServiceFee);
				BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddPspTxnElement");
				iRet = (unsigned long)(*BOObjPtr)(hElement);
			}
		}


		else{
			char *csCmd=(char*) malloc(PD_MAX_FILE_LEN  +1);
			sprintf(csCmd,"online_payout_resp_error.sh %s %s \"%s\"",csPspId,csOrgTxnSeq,csTmpRemark);
DEBUGLOG(("process_payout_resp_txn::Call %s\n",csCmd));
			system(csCmd);
			FREE_ME(csCmd);

			//Void POA
DEBUGLOG(("process_payout_resp_txn::Call TxnWebOnUsROG\n"));
			TxnObjPtr = CreateObj(TxnPtr,"TxnWebOnUsROG","Authorize");
			iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
DEBUGLOG(("process_payout_resp_txn::TxnWebOnUsROG iRet [%d]\n",iRet));

		}
/*
			//TODO: Void POA and POG

//Get upload txn id
DEBUGLOG(("process_payout_resp_txn::Call DBPayoutGeneratedFileDT:GetDetailByGenId\n"));
			DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","GetDetailByGenId");
			iRet = (unsigned long)(*DBObjPtr)(csOrgTxnSeq,rRecordSet);
			if(iRet == PD_OK) {
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if(GetField_CString(hRec,"upload_txn_id",&csTmp)){
						PutField_CString(hRequest,"org_txn_seq",csTmp);
DEBUGLOG(("process_payout_resp_txn::upload_txn_id = [%s]\n",csTmp));
					}

					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
			if(iRet == PD_OK){
DEBUGLOG(("process_payout_resp_txn::Call TxnMgtByUsVOT\n"));
				PutField_CString(hRequest,"return_pspfee","1");
				PutField_CString(hRequest,"remark","PSP rejected. Auto Refund");
				TxnObjPtr = CreateObj(TxnPtr,"TxnMgtByUsVOT","Authorize");
				iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
DEBUGLOG(("process_payout_resp_txn::TxnMgtByUsVOT iRet [%d]\n",iRet));
			}
		}
*/
		//Update TxnHeader
		//Update PayoutQueueDt
		//Update TxnPspDetail
		if(iRet==PD_OK){
			PutField_Char(hTxn,"status",PD_COMPLETE);
			if(!iFailTxn){
				PutField_Char(hTxn,"ar_ind",PD_ACCEPT);

				recordset_init(rRecordSet,0);
				DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetAllCodes");
				if ((*DBObjPtr)(rRecordSet) == PD_OK) {
					hRec = RecordSet_GetFirst(rRecordSet);
					while (hRec) {
						if (GetField_CString(hRec,"code",&csCode)) {
							if (GetField_CString(hRec,"value",&csValue)) {
								if (!strcmp(csCode,"CTPHDATE")) {
DEBUGLOG(("process_payout_resp_txn:Current Processor Hub Date= [%s]\n",csValue));
									PutField_CString(hTxn,"approval_date",csValue);
									PutField_CString(hTxn,"report_date",csValue);
								}
							}
						}
						hRec = RecordSet_GetNext(rRecordSet);
					}
				}
			}
			else{
				PutField_Char(hTxn,"ar_ind",PD_REJECT);
				PutField_CString(hTxn,"sub_status",PD_PSP_REJECT);
			}

			RemoveField_CString(hTxn,"merchant_ref");
DEBUGLOG(("process_payout_resp_txn:: Call Update DBTransaction\n"));
			DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
			iRet = (unsigned long) ((*DBObjPtr)(hTxn));
DEBUGLOG(("process_payout_resp_txn:: Update Transaction iRet[%d]\n",iRet));
		}

		if(iRet==PD_OK){
			if(GetField_Char(hTxn,"ar_ind",&cTmp)){
				PutField_Char(hTxn,"status",cTmp);
			}
DEBUGLOG(("process_payout_resp_txn:: Call DBPayoutQueueDt UpdateStatus\n"));
			DBObjPtr = CreateObj(DBPtr,"DBPayoutQueueDt","UpdateStatus");
			iRet = (unsigned long)(*DBObjPtr)(hTxn);
DEBUGLOG(("process_payout_resp_txn::DBPayoutQueueDt:UpdateStatus iRet = [%d]\n",iRet));
		}

		if(iRet==PD_OK){
DEBUGLOG(("process_payout_resp_txn:: Call Update TxnPspDetail\n"));
			DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
			iRet = (unsigned long)(*DBObjPtr)(hTxn);
DEBUGLOG(("process_payout_resp_txn:: Update TxnPspDetail iRet[%d]\n",iRet));
		}

		if(iRet==PD_OK){
			hash_init(hTxn,0);
			if(iFailTxn==PD_FALSE)
				PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_ACCEPT);
			else
				PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_REJECT);

			PutField_CString(hTxn,"txn_id",csOrgTxnSeq);
			DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","UpdateByGenId");
			iRet = (unsigned long)(*DBObjPtr)(hTxn);
DEBUGLOG(("process_payout_resp_txn::DBPayoutGeneratedFileDT:UpdateByGenId iRet = [%d]\n",iRet));
		}
	}

	//find upload txn id
	//update txn header sub_status
	if(iRet==PD_OK && iFailTxn==PD_FALSE){
		recordset_init(rRecordSet,0);
DEBUGLOG(("process_payout_resp_txn::Call DBPayoutGeneratedFileDT:GetDetailByGenId\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","GetDetailByGenId");
		iRet = (unsigned long)(*DBObjPtr)(csOrgTxnSeq,rRecordSet);
		if(iRet == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if(GetField_CString(hRec,"upload_txn_id",&csUploadTxnSeq)){
DEBUGLOG(("process_payout_resp_txn::upload_txn_id = [%s]\n",csUploadTxnSeq));
				}

				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		else{
			iRet = INT_ERR;
DEBUGLOG(("process_payout_resp_txn::no record for = [%s]\n",csOrgTxnSeq));
		}
	}
	if(iRet==PD_OK && iFailTxn==PD_FALSE){
                PutField_CString(hOrgTxn,"sub_status",PD_APPROVED_AND_SENT);
                PutField_CString(hOrgTxn,"txn_seq",csUploadTxnSeq);
DEBUGLOG(("process_payout_resp_txn::Call DBTransaction:Update (Org)\n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                if((unsigned long) ((*DBObjPtr)(hOrgTxn))!=PD_OK){
                        iRet = INT_ERR;
DEBUGLOG(("process_payout_resp_txn::DBTransaction:UpdateDetail Failed\n"));
                }
        }

/******** reply to remote host if success*/
	long	lKey,lResponseQueueMtype;
        struct  msg_t*  msg;
	if (iRet == PD_OK) {
		GetField_Long(hContext,"queue_key",&lKey);

		if (GetField_Long(hContext,"response_queue_mtype",&lResponseQueueMtype)) {
DEBUGLOG(("response queue mtype = [%ld]\n",lResponseQueueMtype));
		}
		msg = (struct msg_t*)malloc(sizeof(struct msg_t)+MAX_MSG_SIZE);
		msg->mtype  = lResponseQueueMtype;
DEBUGLOG(("key = [%ld] mtype = [%ld]\n",lKey,lResponseQueueMtype));

		long    lRemoteKey;
		GetField_Long(hContext,"remote_reply_key",&lRemoteKey);
		memset(msg->mtext,0,sizeof(msg->mtext));
		MQ_build_header((unsigned char*)msg->mtext,
				MQ_RESP,
				csChannelCode,
				0,
				NULL,
				lRemoteKey);
DEBUGLOG(("build header\n"));
		msg->mtext[MQ_HEADER_LEN] = '\0';
DEBUGLOG(("send len = [%d]\n",MQ_HEADER_LEN));

		iRet = MQSend(lKey,msg,MQ_HEADER_LEN );

		FREE_ME(msg);
	}

/*
	if (iRet == PD_OK && iVoidTxn == PD_TRUE) {
		char*   csTxn;
		csTxn = (char*) malloc (sizeof(PD_TMP_BUF_LEN));
		sprintf(csTxn,"TxnWebOnUs%s",PD_WITHDRAW_VOID_TXN_CODE);
		TxnObjPtr = CreateObj(TxnPtr,csTxn,"Authorize");
		iRet=(unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
DEBUGLOG(("process_payout_resp_txn:: iRet [%d] from %s\n",iRet,csTxn));
		FREE_ME(csTxn);
	}
	else {
		if(iRet == PD_OK){
DEBUGLOG(("process_payout_resp_txn Call UpdatePayoutRespTxnLog\n"));
			iRet = UpdatePayoutRespTxnLog(hContext,hRequest,hResponse);
		}
	}
*/
        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
        FREE_ME(hTxn);
        FREE_ME(hOrgTxn);
        FREE_ME(hElement);
	FREE_ME(csResultCode);
	FREE_ME(csTmpRemark);
	return iRet;
}

int     UpdatePayoutRespTxnLog(hash_t *hContext,
                const hash_t* hRequest,
                const hash_t* hResponse)
{                       
        int 	iRet = PD_OK; 
        hash_t  *hTxn;
        char    *csTmp;
        char    *csTxnSeq;
	char*	csStatus;
	double	dTmp;
	char	*csResultCode;
	char	*csPspChannelCode;
	

        hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0); 



	if(GetField_CString(hContext,"return_psp_channel",&csPspChannelCode)) {
DEBUGLOG(("UpdatePayoutRespTxnLog:: return_psp_channel = [%s]\n",csPspChannelCode));
	}
	else {
DEBUGLOG(("UpdatePayoutRespTxnLog:: return_psp_channel missing!!\n"));
ERRLOG("WEBChannel::UpdatePayoutRespTxnLog:: return_psp_channel missing!!\n");
		iRet = PD_ERR;
	}

        if (GetField_CString(hRequest,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("UpdatePayoutRespTxnLog:: txn_seq = [%s]\n",csTxnSeq));
                PutField_CString(hTxn,"txn_seq",csTxnSeq);
        	PutField_CString(hTxn,"update_user",PD_UPDATE_USER);

DEBUGLOG(("UpdatePayoutRespTxnLog:: get status \n"));
/* response */
                if (GetField_CString(hRequest,"status",&csStatus)) {
DEBUGLOG(("UpdatePayoutRespTxnLog:: status = [%s]\n",csStatus));
                }

		if (!strcmp(csPspChannelCode,PD_CHANNEL_TWV)) {
			csResultCode = strdup(PD_TWV_SUCCESS);
		}
		else 
			csResultCode = strdup(PD_CN_PSP_SUCCESS);
		
			
		if (!strcmp(csStatus,csResultCode))   {
                	PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_ACCEPT);
DEBUGLOG(("UpdatePayoutRespTxnLog:: status = [%d]\n",PAYOUT_MASTER_TRANSACTION_ACCEPT));
		}
		else {
                	PutField_Int(hTxn,"status",PAYOUT_MASTER_TRANSACTION_REJECT);
DEBUGLOG(("UpdatePayoutRespTxnLog:: status = [%d]\n",PAYOUT_MASTER_TRANSACTION_REJECT));
		}

/* error code */
        	if (GetField_CString(hRequest,"error_code",&csTmp)) {
			char *csBuf;
			char *csPspChannelCode;
			int  iDefErr=1;
			long lIntErr=0L;

			if(GetField_CString(hContext,"psp_channel_code",&csPspChannelCode)){
				DBObjPtr = CreateObj(DBPtr,"DBMessages","c2i");
				if ((*DBObjPtr)(csPspChannelCode,lIntErr,csTmp) == PD_OK) {
					iDefErr=0;
					csBuf = (char*) malloc (128);
					sprintf(csBuf,"%ld",lIntErr);
					PutField_CString(hTxn,"resp_code",csBuf);
DEBUGLOG(("UpdatePayoutRespTxnLog:: [%s] error_code[%s]->response_code[%s]\n",csPspChannelCode,csTmp,csBuf));
					FREE_ME(csBuf);
				}
			}
			
			if(iDefErr){
				PutField_CString(hTxn,"resp_code",csTmp);
DEBUGLOG(("UpdatePayoutRespTxnLog:: response_code = %s\n",csTmp));
			}

		}


/* fundout_date */
        	if (GetField_CString(hRequest,"fundout_date",&csTmp)) {
			PutField_CString(hTxn,"fundout_date",csTmp);
DEBUGLOG(("UpdatePayoutRespTxnLog:: fundout_date = [%s]\n",csTmp));
		}

/* service_fee */
        	if (GetField_Double(hRequest,"service_fee",&dTmp)) {
			PutField_Double(hTxn,"service_fee",dTmp);
DEBUGLOG(("UpdatePayoutRespTxnLog:: service_fee = [%f]\n",dTmp));
		}
/* tid */
        	if (GetField_CString(hRequest,"tid",&csTmp)) {
			PutField_CString(hTxn,"tid",csTmp);
DEBUGLOG(("UpdatePayoutRespTxnLog:: tid = [%s]\n",csTmp));
		}
        
                if (iRet == PD_OK) {
DEBUGLOG(("UpdatePayoutRespTxnLog:: Call DBMerchantUploadFileDetail:UpdateDetailByTxnId\n"));
                        DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","UpdateDetailByTxnId");
                        iRet = (unsigned long)(*DBObjPtr)(csTxnSeq,hTxn);
                }       
                        
        }
        else                    
                iRet = PD_ERR;

        hash_destroy(hTxn);
        FREE_ME(hTxn);          
	FREE_ME(csResultCode);

DEBUGLOG(("UpdatePayoutRespTxnLog:: Ret [%d]\n",iRet));
        return  iRet;   
}

int     process_network_txn(hash_t *hContext,
                                const hash_t *Request,
                                hash_t *Response)
{
	int	iRet = PD_OK;
	int	iInternalErr = 0;
	char	*csHandler;
	char	*csTxnCode;
DEBUGLOG(("process_network_txn\n"));
        if (GetField_CString(hContext,"txn_code",&csTxnCode)) {
DEBUGLOG(("process_input_txn:txn_code = [%s]\n",csTxnCode));
        }
        else {
                iRet = PD_ERR;
	}

	if (iRet == PD_OK) {
    		csHandler = (char*) malloc (20);
   		sprintf(csHandler,"TxnWebOnUs%s",csTxnCode);
DEBUGLOG(("process_input_txn Create Txn Object [%s]\n",csHandler));
        	TxnObjPtr = CreateObj(TxnPtr,csHandler,"Authorize");
        	FREE_ME(csHandler);

        	iRet = (unsigned long)(*TxnObjPtr)(hContext,Request,Response);
		if (iRet == PD_OK || GetField_Int(hContext,"internal_error",&iInternalErr))  {
			char*	csBuf;

                       	csBuf = (char*) malloc (128);
                        sprintf(csBuf,"%d",iInternalErr);
                        PutField_CString(Response,"response_code",csBuf);
               		PutField_Char(Response,"status",PD_COMPLETE);
			FREE_ME(csBuf);

			if (iInternalErr != 0) {
				PutField_Int(hContext, "network_txn_msg", PD_TRUE);
			}
		}
	}

DEBUGLOG(("process_network_txn iRet = [%d]\n",iRet));
	return iRet;
}

int	GetClientID(hash_t *hContext, const hash_t *hRequest)
{
	int	iRet = PD_OK;

	char*   csMerchantId;
	char*	csClientId;

	hash_t  *hRec;
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	if (GetField_CString(hRequest,"merchant_id",&csMerchantId) && 
		!GetField_CString(hContext, "merchant_client_id", &csClientId)) {
DEBUGLOG(("get_client_id::merchant id[%s]\n",csMerchantId));

		DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GetMerchant");

		if ((*DBObjPtr)(csMerchantId, rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec,"merchant_client_id",&csClientId)) {
DEBUGLOG(("get_client_id::merchant_client_id = [%s]\n",csClientId));
					PutField_CString(hContext, "merchant_client_id", csClientId);
					break;
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
        }

	return iRet;
}


