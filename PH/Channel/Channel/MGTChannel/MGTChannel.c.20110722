/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/05/17              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <strings.h>
#include <string.h>
#include <ctype.h>
#include "queue_utility.h"
#include "MGTChannel.h"
#include "utilitys.h"
#include "common.h"
#include "ObjPtr.h"
#include "myrecordset.h"
#include "internal.h"
#include "mydb.h"
#include "mq_db.h"
#include "dbutility.h"
#include "langconvert.h"

char	cDebug;

OBJPTR(DB);
OBJPTR(Msg);
OBJPTR(Txn);

void MGTChannel(char	cdebug)
{
	cDebug = cdebug;
}



int     UpdateContext(hash_t* hContext);
int     process_input_txn(hash_t *hContext,
                                const hash_t *Request,
                                hash_t *Response);
int	AddTxnLog(const hash_t *hContext,
		const hash_t* hRequest);
int	UpdateTxnLog(const hash_t *hContext,
		const hash_t* hRequest,
		const hash_t* hResponse);

int	process_txn(hash_t *hContext,
			   	const hex_t* inMsg,
				hex_t outMsg)
{
	hash_t	*hRequest,*hResponse;
	hex_t   *h_msg;
	struct msg_t* msg;
	long	lResponseQueueMtype;
	long 	lKey;
	int	iRet = INT_NO_ERR;

	char*	csChannelCode = strdup("");
	char*	csTxnCode = strdup("");
	char*	csTxnSeq = strdup("");
	int     iInternalErr = 0;
	char*	csBuf;
	
DEBUGLOG(("process_txn\n"));

	hRequest = (hash_t*) malloc (sizeof(hash_t));
	hResponse = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRequest,0);
	hash_init(hResponse,0);


	if (GetField_Long(hContext,"response_queue_mtype",&lResponseQueueMtype)) {
DEBUGLOG(("response queue mtype = [%ld]\n",lResponseQueueMtype));
	}
	else  {
DEBUGLOG(("unable to get response queue mtype\n"));
		iRet = PD_ERR;
	}
	if (GetField_CString(hContext,"channel_code",&csChannelCode)) {
DEBUGLOG(("channel code = [%s]\n",csChannelCode));
	}
	else  {
DEBUGLOG(("unable to get channel code queue mtype\n"));
		iRet = PD_ERR;
	}


DEBUGLOG(("Call MgtMsg\n"));
	MsgObjPtr = CreateObj(MsgPtr,"MgtMsg","BreakDownMsg");
	if ((*MsgObjPtr)(hRequest,inMsg->msg,inMsg->len) != PD_OK)  {
		iRet = INT_BREAKDOWN_ERR;
		PutField_Int(hContext,"internal_error",iRet);
ERRLOG("BreakDown MgtMsg Error\n");
DEBUGLOG(("process_txn:BreakDown MgtMsg Error\n"));
	}
	else {
		char*	csPtr;
		if (GetField_CString(hRequest,"add_user",&csPtr))
			PutField_CString(hContext,"add_user",csPtr);
	}

	if (iRet == PD_OK) {
		iRet  = (UpdateContext(hContext));
	}


	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBTxnSupported","FindTxnSupported");
		if (GetField_CString(hRequest,"txn_code",&csTxnCode)) {
DEBUGLOG(("process_txn:txn_code = [%s]\n",csTxnCode));
		}
		if ((*DBObjPtr)(csChannelCode,
				csTxnCode) != PD_OK) {
                        iRet = INT_INVALID_TXN;
                        PutField_Int(hContext,"internal_error",INT_INVALID_TXN);
DEBUGLOG(("process_txn:Can't Find TxnCode\n"));
ERRLOG("MGTChannel:Unsupported transaction [%s][%s]\n",csChannelCode,csTxnCode);
                }
		else {
			PutField_CString(hContext,"txn_code",csTxnCode);
		}
	}
	if (iRet == PD_OK ) {
//Skip from STP,STA and STD
		if(strcmp(csTxnCode,PD_SETTLEMENT_PROCESS)&&
		   strcmp(csTxnCode,PD_SETTLEMENT_APPROVAL)&&
		   strcmp(csTxnCode,PD_SETTLEMENT_DELIVERY)&&
		   strcmp(csTxnCode,PD_SETTLEMENT_CANCEL)&&
		   //strcmp(csTxnCode,PD_VOID_TXN_CODE)&&
		   strcmp(csTxnCode,PD_ENQUIRE_FX)){
			iRet = AddTxnLog(hContext,hRequest);
		}
	}

	if (iRet == PD_OK) {
       		MsgObjPtr = CreateObj(MsgPtr,"MgtMsg","initReplyFromRequest");
               iRet = (unsigned long)(*MsgObjPtr)(hRequest,hResponse);
DEBUGLOG(("process_txn:RET = [%d] from initReply\n",iRet));
     	}

	if (iRet == PD_OK) {
		iRet = process_input_txn(hContext,hRequest,hResponse);
	}

	if (iRet == PD_OK || GetField_Int(hContext,"internal_error",&iInternalErr))  {
		csBuf = (char*) malloc (128);
		sprintf(csBuf,"%d",iInternalErr);
		PutField_CString(hResponse,"response_code",csBuf);
DEBUGLOG(("Result_Code = %s\n",csBuf));
		FREE_ME(csBuf);
	
		if(!strcmp(csTxnCode,PD_SETTLEMENT_REQUEST)){
			PutField_Char(hContext,"status",PD_PROCESSING);
		}
		else if(!strcmp(csTxnCode,PD_SETTLEMENT_PROCESS)){
			PutField_Char(hContext,"status",PD_TO_PSP);
		}
		else{
			PutField_Char(hContext,"ar_ind",PD_ACCEPT);
                	PutField_Char(hContext,"status",PD_COMPLETE);
		}
		if (iInternalErr != 0 ) {
DEBUGLOG(("*****Format Out Reject Message\n"));
                	PutField_Char(hContext,"status",PD_COMPLETE);
                        PutField_Char(hContext,"ar_ind",PD_REJECT);
                }
                else{
                        iInternalErr = INT_NO_ERR;
/*	
			if(!strcmp(csTxnCode,PD_SETTLEMENT_REQUEST)){ //||
			   //!strcmp(csTxnCode,PD_SETTLEMENT_PROCESS)||
			   //!strcmp(csTxnCode,PD_SETTLEMENT_APPROVAL)){
DEBUGLOG(("Handle Post Txn\n"));
				char*   csTxn;
				csTxn = (char*) malloc (PD_TMP_BUF_LEN +1);
				sprintf(csTxn,"TxnMgtOnUs%s",csTxnCode);
				TxnObjPtr = CreateObj(TxnPtr,csTxn,"PostTxn");
				iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
DEBUGLOG(("process_txn: response from [%s] = [%d]\n",csTxn,iRet));
				FREE_ME(csTxn);
				if(iRet!=PD_OK){
                        		iInternalErr = iRet;
                			PutField_Char(hContext,"status",PD_COMPLETE);
                        		PutField_Char(hContext,"ar_ind",PD_REJECT);
				}
			}
*/
		}

                PutField_Int(hContext,"internal_code",iInternalErr);

DEBUGLOG(("Created Msg Object\n"));
		MsgObjPtr = CreateObj(MsgPtr,"MgtMsg","FormatMsg");
                h_msg = (hex_t*) malloc (sizeof(hex_t));
                iRet = (unsigned long)(*MsgObjPtr)(hResponse,h_msg->msg,&h_msg->len);
		if (iRet == PD_OK) {
			if(strcmp(csTxnCode,PD_ENQUIRE_FX)&&
			   strcmp(csTxnCode,PD_SETTLEMENT_CANCEL)&&
			   strcmp(csTxnCode,PD_SETTLEMENT_DELIVERY)){
                        	iRet = UpdateTxnLog(hContext,hRequest,hResponse);
			}
                }
		if (iRet == PD_OK) {
DEBUGLOG(("Preparing to [%s]send back\n",csChannelCode));

DEBUGLOG(("h_msg->len = [%d]\n",h_msg->len));           
                       GetField_Long(hContext,"queue_key",&lKey);
                       msg = (struct msg_t*)malloc(sizeof(struct msg_t)+MAX_MSG_SIZE);
                       msg->mtype  = lResponseQueueMtype;
                       long    lRemoteKey = 0l;
                       GetField_Long(hContext,"remote_reply_key",&lRemoteKey);
                       memset(msg->mtext,0,sizeof(msg->mtext));
                       MQ_build_header((unsigned char*)msg->mtext,
                       		MQ_RESP,        
                                csChannelCode,  
                                0,              
                                NULL,
                                lRemoteKey);
                       memcpy(&msg->mtext[MQ_HEADER_LEN],h_msg->msg,h_msg->len);
                        msg->mtext[MQ_HEADER_LEN + h_msg->len] = '\0';
DEBUGLOG(("send len = [%d]\n",MQ_HEADER_LEN + h_msg->len));


                        iRet = MQSend(lKey,msg,h_msg->len + MQ_HEADER_LEN);
                        FREE_ME(msg);
			if (iRet  != MQ_OK ) {
DEBUGLOG(("Can't send Message\n"));
                                PutField_Int(hContext,"internal_code",iInternalErr);
                                iRet = PD_ERR;
                        }
			else {
DEBUGLOG(("Message Sent\n"));
				iRet = PD_OK;
			}
		}
                FREE_ME(h_msg);
	}
	
DEBUGLOG(("Normal RET = [%d]\n",iRet));
	FREE_ME(hRequest);
	FREE_ME(hResponse);
	FREE_ME(csChannelCode);
	FREE_ME(csTxnCode);
	FREE_ME(csTxnSeq);
DEBUGLOG(("process_txn RET =[%d]\n",iRet));
	return iRet;
}


int     UpdateContext(hash_t* hContext)
{
        int     iRet = PD_OK;
        long    lKey;
        hash_t  *hRec;
        char    *csCode = strdup("");
        char    *csValue = strdup("");
        char*   csQueueName = strdup("");
        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

//        lKey = GetMQKey((unsigned char*)"WEBRSPQ");
        if (GetField_CString(hContext,"reply_queue",&csQueueName)) {
DEBUGLOG(("UpdateContext:reply queue = [%s]\n",csQueueName));
                lKey = GetMQKey((unsigned char*)csQueueName);
                PutField_Long(hContext,"queue_key",lKey);
DEBUGLOG(("UpdateContext:reply queue key = [%ld]\n",lKey));
        }


        DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetAllCodes");
        if ((*DBObjPtr)(rRecordSet) == PD_OK) {
DEBUGLOG(("UpdateContext: return \n"));
                hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {
                        if (GetField_CString(hRec,"code",&csCode)) {
                                if (GetField_CString(hRec,"value",&csValue)) {
                                        if (!strcmp(csCode,"CTPHDATE")) {
DEBUGLOG(("UpdateContext:Current Processor Hub Date= [%s]\n",csValue));
                                                PutField_CString(hContext,"PHDATE",csValue);
                                        }
                                }
                        }
                        hRec = RecordSet_GetNext(rRecordSet);
                }
        }
        else {
DEBUGLOG(("UpdateContext:NOT RECORD\n"));
                iRet = PD_ERR;
ERRLOG("MGTChannel::Internal Error SystemControl Record Not Found\n");
        }

        if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBSystemParameter","FindCode");
                if ((unsigned long)(DBObjPtr)(PD_BASED_CCY,csValue) == FOUND) {
DEBUGLOG(("based ccy  = [%s]\n",csValue));
                        PutField_CString(hContext,"based_ccy",csValue);
                }
                else {
                        iRet = INT_ERR;
ERRLOG("MGTChannel::Unable to find based ccy\n");
                }
        }

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
        FREE_ME(csCode);
        FREE_ME(csValue);
        FREE_ME(csQueueName);

        return iRet;
}
int     process_input_txn(hash_t *hContext,
                                const hash_t *Request,
                                hash_t *Response)
{
	int	iRet = PD_OK;
	char*	csTxnCode = strdup("");
	char*	csHandler;
DEBUGLOG(("process_input\n"));
	if (GetField_CString(hContext,"txn_code",&csTxnCode)) {
DEBUGLOG(("process_input_txn:txn_code = [%s]\n",csTxnCode));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("process_input_txn:txn_code not found\n"));
	}

	
        if (iRet == PD_OK) {
                TxnObjPtr = CreateObj(TxnPtr,"TxnMgtOnUsCOM","Authorize");
                iRet = (unsigned long)(*TxnObjPtr)(hContext,Request,Response);
        }

	if (iRet == PD_OK ) {
                csHandler = (char*) malloc (20);
                sprintf(csHandler,"TxnMgtOnUs%s",csTxnCode);
DEBUGLOG(("process_MGM_txn Create Txn Object [%s]\n",csHandler));
                TxnObjPtr = CreateObj(TxnPtr,csHandler,"Authorize");
                FREE_ME(csHandler);

                iRet = (unsigned long)(*TxnObjPtr)(hContext,Request,Response);
DEBUGLOG(("iRet = [%d]\n",iRet));
	}
	FREE_ME(csTxnCode);
	return iRet;
}

int	AddTxnLog(const hash_t *hContext,
		const hash_t* hRequest)
{
	hash_t	*hTxn;
	char	*csTmp = strdup("");
	int iRet = PD_OK;

	hTxn = (hash_t*)  malloc (sizeof(hash_t));
	hash_init(hTxn,0);
	if (GetField_CString(hContext,"txn_seq",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_seq = [%s]\n",csTmp));
                PutField_CString(hTxn,"txn_seq",csTmp);

                if (GetField_CString(hContext,"add_user",&csTmp)) {
DEBUGLOG(("AddTxnLog:: add_user = [%s]\n",csTmp));
                        PutField_CString(hTxn,"add_user",csTmp);
                }
		else{
                	PutField_CString(hTxn,"add_user",PD_UPDATE_USER);
		}

                if (GetField_CString(hContext,"org_txn_seq",&csTmp)) {
DEBUGLOG(("AddTxnLog:: org_txn_seq = [%s]\n",csTmp));
                        PutField_CString(hTxn,"org_txn_seq",csTmp);
                }

                if (GetField_CString(hContext,"channel_code",&csTmp)) {
DEBUGLOG(("AddTxnLog:: channel_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"channel_code",csTmp);
                }
                if (GetField_CString(hContext,"txn_code",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"txn_code",csTmp);
                }
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("AddTxnLog:: host_posting_date = [%s]\n",csTmp));
                        PutField_CString(hTxn,"host_posting_date",csTmp);
                }
                if (GetField_CString(hContext,"local_tm_date",&csTmp)) {
DEBUGLOG(("AddTxnLog:: local_tm_date = [%s]\n",csTmp));
                        PutField_CString(hTxn,"local_tm_date",csTmp);
                }
                if (GetField_CString(hContext,"local_tm_time",&csTmp)) {
DEBUGLOG(("AddTxnLog:: local_tm_time = [%s]\n",csTmp));
                        PutField_CString(hTxn,"local_tm_time",csTmp);
                }

/* request */
		/* client ip */
                if (GetField_CString(hRequest,"ip_addr",&csTmp)) {
DEBUGLOG(("AddTxnLog:: client_ip = [%s]\n",csTmp));
                        PutField_CString(hTxn,"ip_addr",csTmp);
                }

		PutField_Char(hTxn,"status",PD_PROCESSING);

                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Add");
                iRet = (unsigned long) ((*DBObjPtr)(hTxn));


	}
	else	 	
		iRet = PD_ERR;

	hash_destroy(hTxn);
	FREE_ME(hTxn);
	FREE_ME(csTmp);
DEBUGLOG(("AddTxnLog RET = [%d]\n",iRet));
	return  iRet;
}

int	UpdateTxnLog(const hash_t *hContext,
		const hash_t* hRequest,
		const hash_t* hResponse)
{
	hash_t	*hTxn;
	char	*csTxnSeq;
	
	int 	iRet = PD_OK;
	int	iTmp;
	char	cTmp;
	double	dTmp;
	char*	csPtr;

	hTxn = (hash_t*)  malloc (sizeof(hash_t));
	hash_init(hTxn,0);

	if (GetField_CString(hContext,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("UpdateTxnLog:: txn_seq = [%s]\n",csTxnSeq));
		PutField_CString(hTxn,"txn_seq",csTxnSeq);

                if (GetField_CString(hContext,"update_user",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: add_user = [%s]\n",csPtr));
                        PutField_CString(hTxn,"update_user",csPtr);
                }
		else{
                	PutField_CString(hTxn,"update_user",PD_UPDATE_USER);
		}

	
		if (GetField_CString(hContext,"org_txn_seq",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: org_txn_seq = [%s]\n",csPtr));
                        PutField_CString(hTxn,"org_txn_seq",csPtr);
                }
		if (GetField_CString(hContext,"process_code",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: process_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"process_code",csPtr);
                }
		if (GetField_CString(hContext,"process_type",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: process_type = [%s]\n",csPtr));
                        PutField_CString(hTxn,"process_type",csPtr);
                }
                if (GetField_Char(hContext,"status",&cTmp)) {
DEBUGLOG(("UpdateTxnLog:: status = [%c]\n",cTmp));
                        PutField_Char(hTxn,"status",cTmp);
                }

                if (GetField_Char(hContext,"ar_ind",&cTmp)) {
DEBUGLOG(("UpdateTxnLog:: ar_ind = [%c]\n",cTmp));
                        PutField_Char(hTxn,"ar_ind",cTmp);
                }

                if (GetField_Int(hContext,"internal_code",&iTmp)) {
DEBUGLOG(("UpdateTxnLog:: internal_code = [%d]\n",iTmp));
                        PutField_Int(hTxn,"internal_code",iTmp);
                }

		if (GetField_CString(hResponse,"response_code",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: response_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"response_code",csPtr);
                }

		if (GetField_CString(hContext,"merchant_client_id",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: client_id = [%s]\n",csPtr));
                        PutField_CString(hTxn,"client_id",csPtr);
                }

		if (GetField_Double(hContext,"txn_amt",&dTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_amt = [%f]\n",dTmp));
                        PutField_Double(hTxn,"txn_amt",dTmp);
                }

		if (GetField_Double(hContext,"net_amt",&dTmp)) {
DEBUGLOG(("UpdateTxnLog:: net_amt = [%f]\n",dTmp));
                        PutField_Double(hTxn,"net_amt",dTmp);
                }

		if (GetField_Double(hContext,"ex_rate",&dTmp)) {
DEBUGLOG(("UpdateTxnLog:: ex_rate = [%f]\n",dTmp));
                        PutField_Double(hTxn,"ex_rate",dTmp);
                }

		if (GetField_Char(hContext,"ex_supplier",&cTmp)) {
DEBUGLOG(("UpdateTxnLog:: ex_supplier = [%f]\n",cTmp));
                        PutField_Char(hTxn,"ex_supplier",cTmp);
                }
		if (GetField_CString(hContext,"merchant_id",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: merchant_id = [%s]\n",csPtr));
                        PutField_CString(hTxn,"merchant_id",csPtr);
                }


		if (GetField_CString(hContext,"service_code",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: service_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"service_code",csPtr);
                }

		if (GetField_CString(hContext,"approval_date",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: approval_date = [%s]\n",csPtr));
                        PutField_CString(hTxn,"approval_date",csPtr);
                }

/* update txn header */
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxn);
	}
	else	 	
		iRet = PD_ERR;

DEBUGLOG(("UpdateTxnLog iRet = [%d]\n",iRet));
	hash_destroy(hTxn);
	FREE_ME(hTxn);

	return  iRet;
}
