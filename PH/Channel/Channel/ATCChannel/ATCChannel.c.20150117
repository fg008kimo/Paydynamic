/*
Partnerdelight (c)2014. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/12/28              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <strings.h>
#include <string.h>
#include <ctype.h>
#include "queue_utility.h"
#include "ATCChannel.h"
#include "utilitys.h"
#include "common.h"
#include "ObjPtr.h"
#include "myrecordset.h"
#include "internal.h"
#include "mydb.h"
#include "mq_db.h"
#include "dbutility.h"
#include "langconvert.h"

char cDebug;

void ATCChannel(char cdebug)
{
	cDebug = cdebug;
}

OBJPTR(Msg);
OBJPTR(BO);
OBJPTR(DB);

int process_txn(hash_t *hContext,
		const hex_t *inMsg,
		hex_t *outMsg)
{
	int iRet = PD_OK;
	hash_t *hRequest, *hRec;
	char *csBaidTxnId, *csBaidTxnCode, *csNextEngineTxnCode, *csNextEngineAction;
	int iTmpRet;
	char *csTmp;

DEBUGLOG(("process_txn\n"));

	hRequest = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRequest, 0);

	hRec = (hash_t*) malloc (sizeof(hash_t));

	if (iRet == PD_OK) {
DEBUGLOG(("process_txn: Call AtcMsg [%d]\n", inMsg->len));
		MsgObjPtr = CreateObj(MsgPtr, "AtcMsg", "BreakDownMsg");
		if ((*MsgObjPtr)(hRequest, inMsg->msg, inMsg->len) != PD_OK) {
			iRet = PD_ERR;
DEBUGLOG(("process_txn: BreakDown AtcMsg Error\n"));
ERRLOG("ATCChannel: process_txn: BreakDown AtcMsg Error\n");
		}
	}

	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "baid_txn_id", &csBaidTxnId)) {
DEBUGLOG(("process_txn: baid_txn_id = [%s]\n", csBaidTxnId));
		} else {
			iRet = PD_ERR;
DEBUGLOG(("process_txn: Cannot Get Baid Txn ID\n"));
ERRLOG("ATCChannel: process_txn: Cannot Get Baid Txn ID\n");
		}
	}

	if (iRet == PD_OK) {
		BOObjPtr = CreateObj(BOPtr, "BOOLStmtEngine", "ProcessUnknownMatching");
		iRet = (unsigned long)(*BOObjPtr)(hRequest);
	}

	if (iRet == PD_FOUND) {
		hash_init(hRec, 0);

		PutField_CString(hRec, "txn_seq", csBaidTxnId);
		GetField_CString(hRequest, "baid_txn_code", &csBaidTxnCode);
		PutField_CString(hRec, "new_txn_code", csBaidTxnCode);
		PutField_Char(hRec, "classified_status", PD_CLASSIFIED);
		PutField_CString(hRec, "update_user", PD_UPDATE_USER);

DEBUGLOG(("process_txn: call DBOLBAIDTxn::Update()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Update");
		if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
			iRet = PD_ERR;
DEBUGLOG(("process_txn: call DBOLBAIDTxn::Update() failed\n"));
ERRLOG("ATCChannel: process_txn: call DBOLBAIDTxn::Update() failed\n");
		}

		hash_destroy(hRec);
	}

	if (iRet == PD_OK) {
		hash_init(hRec, 0);

		GetField_CString(hRequest, "next_engine_txn_code", &csNextEngineTxnCode);

		// get txn_grp
DEBUGLOG(("process_txn: call DBOLTxnEngineTxnCodeGrp::GetTxnGroup()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnEngineTxnCodeGrp", "GetTxnGroup");
		iTmpRet = (unsigned long)(*DBObjPtr)(csNextEngineTxnCode, hRec);
		if (iTmpRet != PD_OK) {
			iRet = PD_ERR;
DEBUGLOG(("process_txn: call DBOLTxnEngineTxnCodeGrp::GetTxnGroup() failed\n"));
ERRLOG("ATCChannel: process_txn: call DBOLTxnEngineTxnCodeGrp::GetTxnGroup() failed\n");
		} else {
			if (GetField_CString(hRec, "txn_grp", &csTmp)) {
DEBUGLOG(("process_txn: txn_grp = [%s]\n", csTmp));
				PutField_CString(hRec, "bank_stmt_type", csTmp);
				RemoveField_CString(hRec, "txn_grp");
			}
		}

		// call txn engine
		if (iRet == PD_OK) {
			// activity
			GetField_CString(hRequest, "next_engine_action", &csNextEngineAction);
			PutField_CString(hRec, "activity", csNextEngineAction);

			// trigger_type
			PutField_CString(hRec, "trigger_type", PD_TRIGGER_SYSTEM);

			// input_channel
			PutField_CString(hRec, "input_channel", PD_CHANNEL_OMT);

			// baid txn
			PutField_Int(hRec, "baid_txn_cnt", 1);
			PutField_CString(hRec, "baid_txn_id_0", csBaidTxnId);
			if (GetField_CString(hRequest, "baid_txn_id_2", &csTmp)) {
				PutField_Int(hRec, "baid_txn_cnt", 2);
				PutField_CString(hRec, "baid_txn_id_1", csTmp);
			}

			// psp txn
			if (GetField_CString(hRequest, "psp_txn_id_1", &csTmp)) {
				PutField_Int(hRec, "txn_cnt", 1);
				PutField_CString(hRec, "txn_id_0", csTmp);
			}
			if (GetField_CString(hRequest, "psp_txn_id_2", &csTmp)) {
				PutField_Int(hRec, "txn_cnt", 2);
				PutField_CString(hRec, "txn_id_1", csTmp);
			}

DEBUGLOG(("process_txn: call BOOLTxnEngine::DoAction()\n"));
			BOObjPtr = CreateObj(BOPtr, "BOOLTxnEngine", "DoAction");
			iTmpRet = (unsigned long)(*BOObjPtr)(hRec);
			if (iTmpRet != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("process_txn: call BOOLTxnEngine::DoAction() failed\n"));
ERRLOG("ATCChannel: process_txn: call BOOLTxnEngine::DoAction() failed\n");
			}
		}

		hash_destroy(hRec);
	}

	hash_destroy(hRequest);
	FREE_ME(hRequest);
	FREE_ME(hRec);

DEBUGLOG(("process_txn: Normal Exit() iRet = [%d]\n", iRet));
	return iRet;
}
