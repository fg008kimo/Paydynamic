/*
Partnerdelight (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/05              Cody Chan
*/


#include <stdio.h>
#include <stdlib.h>
#include <strings.h>
#include <string.h>
#include <ctype.h>
#include "queue_utility.h"
#include "SMSChannel.h"
#include "utilitys.h"
#include "common.h"
#include "ObjPtr.h"
#include "myrecordset.h"
#include "internal.h"
#include "mydb.h"
#include "mq_db.h"
#include "dbutility.h"
#include "langconvert.h"

#define PD_RETRY	'R'

char cDebug;

void SMSChannel(char cdebug)
{
	cDebug = cdebug;
}

OBJPTR(DB);
OBJPTR(Msg);
OBJPTR(Txn);

int	process_txn(hash_t *hContext,
			const hex_t *inMsg,
			hex_t *outMsg)
{

	int iRet = PD_OK;
	char *csQueueName;
	char *csChannelCode = strdup("SMS");
	char *csTxnCode;
	char *csTxnDesc;
	char *csProcessType;
	char *csProcessCode;
	long lKey, lResponseQueueMtype;
	struct msg_t* msg;
	hash_t *hRequest, *hResponse;
	char csTxnSeq[PD_TXN_SEQ_LEN + 1];

DEBUGLOG(("process_txn\n"));
DEBUGLOG(("msg len = [%d]\n", inMsg->len));

	hRequest = (hash_t*) malloc (sizeof(hash_t));
	hResponse = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRequest, 0);
	hash_init(hResponse, 0);

	csTxnCode = (char*) malloc (PD_TXN_CODE_LEN + 1);
	csTxnDesc = (char*) malloc (PD_DESC_LEN + 1);

	DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextOmtTxnSeq");
	strcpy(csTxnSeq,(*DBObjPtr)());
	PutField_CString(hContext,"txn_seq",csTxnSeq);

	if (GetField_CString(hContext, "reply_queue", &csQueueName)) {
DEBUGLOG(("UpdateContext:reply queue = [%s]\n", csQueueName));
		lKey = GetMQKey((unsigned char*)csQueueName);
		PutField_Long(hContext, "queue_key", lKey);
DEBUGLOG(("UpdateContext:reply queue key = [%ld]\n", lKey));
	}

	char csTmpDate[PD_DATETIME_LEN + 1];
	DBObjPtr = CreateObj(DBPtr, "DBSystemControl", "FindCode");

	if ((unsigned long)(*DBObjPtr)("CTPHDATE", csTmpDate) == FOUND) {
DEBUGLOG(("UpdateContext: Current Processor Hub Date = [%s]\n", csTmpDate));
		PutField_CString(hContext, "PHDATE", csTmpDate);
	} else {
DEBUGLOG(("UpdateContext: NOT RECORD\n"));
		iRet = PD_ERR;
ERRLOG("UpdateContext::Internal Error:SMS Channel:SystemControl Record Not Found\n");
	}

	if (iRet == PD_OK) {
DEBUGLOG(("Call SmsMsg [%d]\n", inMsg->len));
		MsgObjPtr = CreateObj(MsgPtr, "SmsMsg", "BreakDownMsg");
		if ((*MsgObjPtr)(hRequest, inMsg->msg, inMsg->len) != PD_OK) {
			iRet = INT_BREAKDOWN_ERR;
			PutField_Int(hContext, "internal_error", iRet);
ERRLOG("BreakDown SmsMsg Error\n");
DEBUGLOG(("process_txn:BreakDown SmsMsg Error\n"));
		}
	}

	if (iRet == PD_OK) {
/* Find Txn Code */
		if (GetField_CString(hRequest, "process_type", &csProcessType)) {
DEBUGLOG(("process_txn:process_type = [%s]\n", csProcessType));
		}
		if (!GetField_CString(hRequest, "process_code", &csProcessCode)) {
			csProcessCode = strdup("000000");
		}
DEBUGLOG(("process_txn:process_code = [%s]\n", csProcessCode));

		DBObjPtr = CreateObj(DBPtr, "DBTxnCode", "FindTxnCode");
			if (!(*DBObjPtr)(csTxnCode,
							csTxnDesc,
							csProcessType,
							csProcessCode)) {
				iRet = INT_INVALID_TXN;
				PutField_Int(hContext, "internal_error", INT_INVALID_TXN);
DEBUGLOG(("process_txn:Can't Find TxnCode\n"));
ERRLOG("WEBChannel:Unsupported transaction [%s][%s]\n", csProcessType, csProcessCode);
			}
			else {
DEBUGLOG(("try to create obj 3\n"))
				PutField_CString(hContext, "txn_code", csTxnCode);
				PutField_CString(hContext, "txn_desc", csTxnDesc);
				PutField_CString(hResponse, "txn_code", csTxnCode);
DEBUGLOG(("process_txn:TxnCode = [%s]\n", csTxnCode));
DEBUGLOG(("process_txn:TxnDesc = [%s]\n", csTxnDesc));
			}
//Response Process Type
			csProcessType[PD_PROCESS_TYPE_LEN - 1] = PD_PROCESS_TYPE_RESP_CODE;
			PutField_CString(hResponse, "process_type", csProcessType);
	}

	if (iRet == PD_OK) {
		TxnObjPtr = CreateObj(TxnPtr, "TxnSmsByUsSUL", "Authorize");
		iRet = (unsigned long)(*TxnObjPtr)(hContext, hRequest, hResponse);
	}


	/******** reply to remote host if success*/
	if (iRet == PD_OK) {
        	GetField_Long(hContext,"queue_key",&lKey);
DEBUGLOG(("key = [%ld]\n",lKey));

		if (GetField_Long(hContext,"response_queue_mtype",&lResponseQueueMtype)) {
DEBUGLOG(("response queue mtype = [%ld]\n",lResponseQueueMtype));
                }
                msg = (struct msg_t*)malloc(sizeof(struct msg_t)+MAX_MSG_SIZE);
                msg->mtype  = lResponseQueueMtype;
DEBUGLOG(("key = [%ld] mtype = [%ld]\n",lKey,lResponseQueueMtype));

		long    lRemoteKey;
                GetField_Long(hContext,"remote_reply_key",&lRemoteKey);
             	memset(msg->mtext,0,sizeof(msg->mtext));
                MQ_build_header((unsigned char*)msg->mtext,
                	MQ_RESP,
                        csChannelCode,
                        0,
                        NULL,
                        lRemoteKey);
DEBUGLOG(("build header\n"));
		msg->mtext[MQ_HEADER_LEN] = '\0';
DEBUGLOG(("send len = [%d]\n",MQ_HEADER_LEN));

               iRet = MQSend(lKey,msg,MQ_HEADER_LEN );

               FREE_ME(msg);
	}
/**************************************************************************************/

DEBUGLOG(("process_txn iRet = [%d]\n",iRet));
	FREE_ME(csChannelCode);
	FREE_ME(csTxnCode);
	FREE_ME(csTxnDesc);
	FREE_ME(hRequest);
        FREE_ME(hResponse);
	return iRet;
}

