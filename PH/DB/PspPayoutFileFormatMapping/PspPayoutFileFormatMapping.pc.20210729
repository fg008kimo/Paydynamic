/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2016/10/06              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "PspPayoutFileFormatMapping.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void PspPayoutFileFormatMapping(char    cdebug)
{
        cDebug = cdebug;
}

int GetPspPayoutFileFormat(const char* csPspId, char* csFormatCode)
{
        int iRet = NOT_FOUND;

        EXEC SQL WHENEVER SQLERROR GOTO getpayoutfileformat_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_psp_id[PD_PSP_ID_LEN];

                varchar         v_format_code[PD_PSP_PO_FILE_FMT_CODE_LEN];

                short           ind_format_code = -1;

        EXEC SQL END DECLARE SECTION;

        // psp_id
        hv_psp_id.len = strlen(csPspId);
        memcpy(hv_psp_id.arr,csPspId,hv_psp_id.len);
DEBUGLOG(("GetPspPayoutFileFormat psp_id = [%.*s]\n",hv_psp_id.len,hv_psp_id.arr));

        EXEC SQL DECLARE c_cursor_getpayoutfileformat CURSOR FOR
                SELECT  PPFGM_FORMAT_CODE
                FROM    PSP_PAYOUT_FILE_FORMAT_MAPPING
                WHERE   PPFGM_PSP_ID = :hv_psp_id;

        EXEC SQL OPEN c_cursor_getpayoutfileformat;
        do {
                EXEC SQL FETCH c_cursor_getpayoutfileformat
                INTO
                        :v_format_code:ind_format_code;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

/* format_code */
		if (ind_format_code >= 0) {
                        v_format_code.arr[v_format_code.len] = '\0';
			strcpy(csFormatCode,(const char*)v_format_code.arr);
DEBUGLOG(("GetPspPayoutFileFormat format_code = [%s]\n",csFormatCode));
			iRet = FOUND;
                }

                break;
        } while (PD_TRUE);
        EXEC SQL CLOSE c_cursor_getpayoutfileformat;

	if (iRet == FOUND) {
DEBUGLOG(("GetPspPayoutFileFormat format_code found [%d] \n",iRet));
        } else {
DEBUGLOG(("GetPspPayoutFileFormat format_code not found [%d] \n",iRet));
        }

        return iRet;

getpayoutfileformat_error:
DEBUGLOG(("getpayoutfileformat_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("GetPspPayoutFileFormat::getpayoutfileformat_error code %d\n", sqlca.sqlcode);
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_getpayoutfileformat;
    return PD_ERR;
}

