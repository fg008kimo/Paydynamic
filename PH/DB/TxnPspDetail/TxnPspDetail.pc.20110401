/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/09/17              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "TxnPspDetail.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;
void TxnPspDetail(char    cdebug)
{
        cDebug = cdebug;
}
int perr01(const char * msg){
    ERRLOG("Error occured when %s\n", msg);
    ERRLOG("{\n");
    ERRLOG(" sqlcaid = %s\n",sqlca.sqlcaid);
    ERRLOG(" sqlabc = %d\n",sqlca.sqlabc);
    ERRLOG(" sqlcode = %d\n",sqlca.sqlcode);
    ERRLOG(" sqlerrm.sqlerrml = %d\n",sqlca.sqlerrm.sqlerrml);
    ERRLOG(" sqlerrm.sqlerrmc = %s\n",sqlca.sqlerrm.sqlerrmc);
    ERRLOG(" sqlerrp = %s\n",sqlca.sqlerrp);
    ERRLOG(" sqlerrd = %d\n",sqlca.sqlerrd);
    ERRLOG(" sqlwarn = %s\n",sqlca.sqlwarn);
    ERRLOG(" sqlext = %s\n",sqlca.sqlext);
    ERRLOG("}\n");
    return 1;
}

int Add(const hash_t *hRls)
{
        char		*csTmp;
        double          dTmp;


        EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short 		hv_return_value;

	varchar		hv_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_psp_id[PD_PSP_ID_LEN];
	double		hv_txn_amt;
	varchar		hv_txn_ccy[PD_CCY_ID_LEN];
	varchar		hv_txn_date[PD_DATETIME_LEN];
	varchar		hv_desc[PD_DESC_LEN];
	varchar		hv_status[PD_PSP_STATUS_LEN];
	varchar		hv_notice_status[PD_PSP_STATUS_LEN];
	varchar		hv_error_code[PD_ERROR_CODE_LEN];
	varchar		hv_tid[PD_PSP_TID_LEN];
	varchar		hv_url[PD_URL_LEN];
	varchar		hv_bank_code[PD_BANK_CODE_LEN];
	varchar		hv_bank_branch[PD_BANK_BRANCH_LEN];
	varchar		hv_account_name[PD_ACCOUNT_NAME_LEN];
	varchar		hv_account_no[PD_ACCOUNT_NO_LEN];
	varchar		hv_batch_id[PD_BATCH_LEN];
	varchar		hv_fundin_date[PD_DATETIME_LEN];
	varchar		hv_fundout_date[PD_DATETIME_LEN];
	double		hv_service_fee;
	varchar		hv_add_user[PD_USER_LEN];
	varchar		hv_bill_no[PD_BANK_BILL_NO_LEN];



	short		ind_txn_id = -1;
	short		ind_psp_id = -1;
	short		ind_txn_amt = -1;
	short		ind_txn_ccy = -1;
	short		ind_txn_date = -1;
	short		ind_desc = -1;
	short		ind_status = -1;
	short		ind_notice_status = -1;
	short		ind_error_code = -1;
	short		ind_tid = -1;
	short		ind_url = -1;
	short		ind_bank_code = -1;
	short		ind_bank_branch = -1;
	short		ind_account_name = -1;
	short		ind_account_no = -1;
	short		ind_batch_id = -1;
	short		ind_fundin_date = -1;
	short		ind_fundout_date = -1;
	short		ind_service_fee = -1;
	short		ind_add_user = -1;
	short		ind_bill_no = -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));


/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("Add:txn_id = [%.*s][%d]\n",hv_txn_id.len,hv_txn_id.arr,hv_txn_id.len));
        }
/* psp_id */
        if (GetField_CString(hRls,"psp_id",&csTmp)) {
                hv_psp_id.len = strlen(csTmp);
                memcpy(hv_psp_id.arr,csTmp,hv_psp_id.len);
                ind_psp_id = 0;
DEBUGLOG(("Add:psp_id = [%.*s][%d]\n",hv_psp_id.len,hv_psp_id.arr,hv_psp_id.len));
        }



/* txn_amt   */
        if (GetField_Double(hRls,"txn_amt",&dTmp)) {
		hv_txn_amt= dTmp;
                ind_txn_amt = 0;
DEBUGLOG(("Add:txn_amt = [%f]\n",hv_txn_amt));
        }

/*	if (GetField_Double(hRls,"txn_amount",&dTmp)){
		hv_txn_amt = dTmp;
		ind_txn_amt = 0;
DEBUGLOG(("Add:txn_amt = [%f]\n",hv_txn_amt));
	}
*/
/* txn_date */
        if (GetField_CString(hRls,"txn_date",&csTmp)) {
                hv_txn_date.len = strlen(csTmp);
                memcpy(hv_txn_date.arr,csTmp,hv_txn_date.len);
                ind_txn_date = 0;
DEBUGLOG(("Add:txn_date = [%.*s][%d]\n",hv_txn_date.len,hv_txn_date.arr,hv_txn_date.len));
        }

/* txn_ccy */
        if (GetField_CString(hRls,"txn_ccy",&csTmp)) {
                hv_txn_ccy.len = strlen(csTmp);
                memcpy(hv_txn_ccy.arr,csTmp,hv_txn_ccy.len);
                ind_txn_ccy = 0;
DEBUGLOG(("Add:txn_ccy = [%.*s][%d]\n",hv_txn_ccy.len,hv_txn_ccy.arr,hv_txn_ccy.len));
        }


/* desc */
	
	if (GetField_CString(hRls,"desc", &csTmp)) {
                hv_desc.len = strlen(csTmp);
                memcpy(hv_desc.arr,csTmp,hv_desc.len);
                ind_desc = 0;
DEBUGLOG(("Add:desc = [%.*s][%d]\n",hv_desc.len,hv_desc.arr,hv_desc.len));
		
	}

/* status */
	if (GetField_CString(hRls,"status", &csTmp)) {
                hv_status.len = strlen(csTmp);
                memcpy(hv_status.arr,csTmp,hv_status.len);
                ind_status = 0;
DEBUGLOG(("Add:status = [%.*s][%d]\n",hv_status.len,hv_status.arr,hv_status.len));
	}
/* notice_status */
	if (GetField_CString(hRls,"notice_status", &csTmp)) {
                hv_status.len = strlen(csTmp);
                memcpy(hv_status.arr,csTmp,hv_notice_status.len);
                ind_notice_status = 0;
DEBUGLOG(("Add:notice_status = [%.*s]\n",hv_status.len,hv_notice_status.arr));
	}
/* error_code */
	if (GetField_CString(hRls,"error_code", &csTmp)) {
                hv_error_code.len = strlen(csTmp);
                memcpy(hv_error_code.arr,csTmp,hv_error_code.len);
                ind_error_code = 0;
DEBUGLOG(("Add:error_code = [%.*s]\n",hv_status.len,hv_error_code.arr));
	}

/* tid */
	if (GetField_CString(hRls,"tid", &csTmp)) {
                hv_tid.len = strlen(csTmp);
                memcpy(hv_tid.arr,csTmp,hv_tid.len);
                ind_tid = 0;
DEBUGLOG(("Add:tid = [%.*s][%d]\n",hv_tid.len,hv_tid.arr,hv_tid.len));
	}

/* url */
	if (GetField_CString(hRls,"deposit_url", &csTmp)) {
                hv_url.len = strlen(csTmp);
                memcpy(hv_url.arr,csTmp,hv_url.len);
                ind_url = 0;
DEBUGLOG(("Add:url = [%.*s][%d]\n",hv_url.len,hv_url.arr,hv_url.len));
	}
/* bank_code */
	if (GetField_CString(hRls,"bank_code", &csTmp)) {
                hv_bank_code.len = strlen(csTmp);
                memcpy(hv_bank_code.arr,csTmp,hv_bank_code.len);
                ind_bank_code = 0;
DEBUGLOG(("Add:bank_code = [%.*s][%d]\n",hv_bank_code.len,hv_bank_code.arr,hv_bank_code.len));
	}
/* bank_branch */
	if (GetField_CString(hRls,"bank_branch", &csTmp)) {
                hv_bank_branch.len = strlen(csTmp);
                memcpy(hv_bank_branch.arr,csTmp,hv_bank_branch.len);
                ind_bank_branch = 0;
DEBUGLOG(("Add:bank_branch = [%.*s][%d]\n",hv_bank_branch.len,hv_bank_branch.arr,hv_bank_branch.len));
	}
/* account_name */
	if (GetField_CString(hRls,"account_name", &csTmp)) {
                hv_account_name.len = strlen(csTmp);
                memcpy(hv_account_name.arr,csTmp,hv_account_name.len);
                ind_account_name = 0;
DEBUGLOG(("Add:account_name = [%.*s][%d]\n",hv_account_name.len,hv_account_name.arr,hv_account_name.len));
	}
/* account_no */
	if (GetField_CString(hRls,"account_no", &csTmp)) {
                hv_account_no.len = strlen(csTmp);
                memcpy(hv_account_no.arr,csTmp,hv_account_no.len);
                ind_account_no = 0;
DEBUGLOG(("Add:account_no = [%.*s][%d]\n",hv_account_no.len,hv_account_no.arr,hv_account_no.len));
	}
/* batch_id */
	if (GetField_CString(hRls,"batch_id", &csTmp)) {
                hv_batch_id.len = strlen(csTmp);
                memcpy(hv_batch_id.arr,csTmp,hv_batch_id.len);
                ind_batch_id = 0;
DEBUGLOG(("Add:batch_id = [%.*s][%d]\n",hv_batch_id.len,hv_batch_id.arr,hv_batch_id.len));
	}

/* fundin_date */
	if (GetField_CString(hRls,"fundin_date", &csTmp)) {
                hv_fundin_date.len = strlen(csTmp);
                memcpy(hv_fundin_date.arr,csTmp,hv_fundin_date.len);
                ind_fundin_date = 0;
DEBUGLOG(("Add:fundin_date = [%.*s]\n",hv_fundin_date.len,hv_fundin_date.arr));
	}

/* fundout_date */
	if (GetField_CString(hRls,"fundout_date", &csTmp)) {
                hv_fundout_date.len = strlen(csTmp);
                memcpy(hv_fundout_date.arr,csTmp,hv_fundout_date.len);
                ind_fundout_date = 0;
DEBUGLOG(("Add:fundout_date = [%.*s]\n",hv_fundout_date.len,hv_fundout_date.arr));
	}
/* serive_fee */
	if (GetField_Double(hRls,"service_fee", &dTmp)) {
                ind_service_fee = 0;
DEBUGLOG(("Add:service_fee = [%f]\n",hv_service_fee));
	}


/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen(csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("Add:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }

/* bank bill no */
	if (GetField_CString(hRls,"bank_bill_no", &csTmp)) {
                hv_bill_no.len = strlen(csTmp);
                memcpy(hv_bill_no.arr,csTmp,hv_bill_no.len);
                ind_bill_no = 0;
DEBUGLOG(("Add:bank_bill_no = [%.*s][%d]\n",hv_bill_no.len,hv_bill_no.arr,hv_bill_no.len));
	}

	FREE_ME(csTmp);

	EXEC SQL EXECUTE
                BEGIN
			:hv_return_value := sp_txn_psp_detail_insert(
					:hv_txn_id:ind_txn_id,
					:hv_psp_id:ind_psp_id,
					:hv_txn_amt:ind_txn_amt,
					:hv_txn_date:ind_txn_date,
					:hv_txn_ccy:ind_txn_ccy,
					:hv_desc:ind_desc,
					:hv_status:ind_status,
					:hv_notice_status:ind_notice_status,
					:hv_error_code:ind_error_code,
					:hv_tid:ind_tid,
					:hv_url:ind_url,
					:hv_bank_code:ind_bank_code,
					:hv_bank_branch:ind_bank_branch,
					:hv_account_name:ind_account_name,
					:hv_account_no:ind_account_no,
					:hv_batch_id:ind_batch_id,
					:hv_fundin_date:ind_fundin_date,
					:hv_fundout_date:ind_fundout_date,
					:hv_service_fee:ind_service_fee,
					:hv_add_user:ind_add_user,
					:hv_add_user:ind_add_user,
					:hv_bill_no:ind_bill_no);
	        END;
        END-EXEC;

DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("Add:Normal Exit\n"));
		TxnCommit();
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("TxnPspDetail_Add: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("TxnPspDetail_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		TxnAbort();
                return PD_ERR;
        }

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("TxnPspDetail_Add: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR TxnAbort\n"));
perr01("Add_txnpspdetail");
	TxnAbort();
        return PD_INTERNAL_ERR;
}

int Update(const hash_t *hRls)
{

	char*	csTmp = strdup("");
	double	dTmp;
	char*	csBuf;
	char*	csTxnId = strdup("");
        EXEC SQL WHENEVER SQLERROR GOTO update_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

	varchar 	hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr,"update txn_psp_detail set tp_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"txn_seq",&csTxnId);
DEBUGLOG(("Update:txn_id = [%s]\n",csTxnId));

/* psp_id  */
        if (GetField_CString(hRls,"psp_id",&csTmp)) {
DEBUGLOG(("Update:psp_id = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",td_psp_id = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* txn_date */
        if (GetField_CString(hRls,"txn_date",&csTmp)) {
DEBUGLOG(("Update:txn_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_txn_date = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}


/* transaction amt   */
        if (GetField_Double(hRls,"txn_amount",&dTmp)) {
DEBUGLOG(("Update:txn_amt = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",tp_amount = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* desc */
        if (GetField_CString(hRls,"descorder_no",&csTmp)) {
DEBUGLOG(("Update:desc = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_desc = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* status */
        if (GetField_CString(hRls,"status",&csTmp)) {
DEBUGLOG(("Update:status = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_status = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* notice_status */
        if (GetField_CString(hRls,"notice_status",&csTmp)) {
DEBUGLOG(("Update:notice_status = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_notice_status = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* error_code */
        if (GetField_CString(hRls,"error_code",&csTmp)) {
DEBUGLOG(("Update:error_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_error_code = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* tid */
        if (GetField_CString(hRls,"tid",&csTmp)) {
DEBUGLOG(("Update:tid = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_tid = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* url */
        if (GetField_CString(hRls,"deposit_url",&csTmp)) {
DEBUGLOG(("Update:deposit_url = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_url = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* bank_code */
        if (GetField_CString(hRls,"bank_code",&csTmp)) {
DEBUGLOG(("Update:bank_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_bank_code = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* bank_branch */
        if (GetField_CString(hRls,"bank_branch",&csTmp)) {
DEBUGLOG(("Update:bank_branch = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_bank_branch = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* account_name */
        if (GetField_CString(hRls,"account_name",&csTmp)) {
DEBUGLOG(("Update:account_name = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_account_name = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* account_no */
        if (GetField_CString(hRls,"account_no",&csTmp)) {
DEBUGLOG(("Update:account_no = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_account_no = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* batch_id */
        if (GetField_CString(hRls,"batch_id",&csTmp)) {
DEBUGLOG(("Update:batch_id = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_batch_id = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* fundin_date */
        if (GetField_CString(hRls,"fundin_date",&csTmp)) {
DEBUGLOG(("Update:fundin_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_fundin_date = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* fundout_date */
        if (GetField_CString(hRls,"fundout_date",&csTmp)) {
DEBUGLOG(("Update:fundout_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_fundout_date = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* service_fee   */
        if (GetField_Double(hRls,"service_fee",&dTmp)) {
DEBUGLOG(("Update:serive_fee = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",tp_service_fee = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* bank bill no*/
        if (GetField_CString(hRls,"bank_bill_no",&csTmp)) {
DEBUGLOG(("Update:bank_bill_no = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_bank_bill_no = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }





/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
DEBUGLOG(("Update:add_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_create_user = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* update user */
        if (GetField_CString(hRls,"update_user",&csTmp)) {
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",tp_update_user = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

	strcat((char *)hv_dynstmt.arr, " WHERE tp_txn_id = '");
        strcat((char *)hv_dynstmt.arr, csTxnId);
        strcat((char *)hv_dynstmt.arr, "'");
       	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csTmp);
	FREE_ME(csBuf);
	FREE_ME(csTxnId);


DEBUGLOG(("Update Normal Exit\n"));
	return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("TxnPspDetail_Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
	TxnAbort();
        return PD_INTERNAL_ERR;
}


int GetTxnPspDetail(const char* csTxnID,
		recordset_t* myRec)
{

        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO gettxnpspdetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_txn_id[PD_TXN_SEQ_LEN];

		varchar		v_psp_id[PD_PSP_ID_LEN + 1];
		varchar		v_tid[PD_PSP_TID_LEN + 1];
		varchar		v_txn_date[PD_DATETIME_LEN + 1];
		varchar		v_fundin_date[PD_DATETIME_LEN + 1];
		varchar		v_fundout_date[PD_DATETIME_LEN + 1];
		varchar		v_notice_status[PD_PSP_STATUS_LEN + 1];
		varchar		v_error_code[PD_ERROR_CODE_LEN + 1];
		varchar		v_batch_id[PD_BATCH_LEN + 1];
		varchar		v_bill_no[PD_BANK_BILL_NO_LEN + 1];

		double		v_txn_amt;
		double		v_service_fee;

		short		ind_psp_id = -1;
		short		ind_tid = -1;
		short		ind_txn_date = -1;
		short		ind_fundin_date = -1;
		short		ind_fundout_date = -1;
		short		ind_notice_status = -1;
		short		ind_error_code = -1;
		short		ind_batch_id = -1;
		short		ind_txn_amt = -1;
		short		ind_service_fee = -1;
		short		ind_bill_no = -1;

        EXEC SQL END DECLARE SECTION;

	hv_txn_id.len = strlen(csTxnID);
	memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetTxnPspDetail txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_gettxnpspdetail CURSOR FOR
		select 
			tp_psp_id,
			tp_tid,
			tp_txn_date,
			tp_fundin_date,
			tp_fundout_date,
			tp_notice_status,
			tp_error_code,
			tp_batch_id,
			tp_txn_amount,
			tp_service_fee,
			tp_bank_bill_no
		  from txn_psp_detail
		 where tp_txn_id = :hv_txn_id;


        EXEC SQL OPEN c_cursor_gettxnpspdetail;
        do {
                EXEC SQL FETCH c_cursor_gettxnpspdetail
                INTO
			:v_psp_id:ind_psp_id,
			:v_tid:ind_tid,
			:v_txn_date:ind_txn_date,
			:v_fundin_date:ind_fundin_date,
			:v_fundout_date:ind_fundout_date,
			:v_notice_status:ind_notice_status,
			:v_error_code:ind_error_code,
			:v_batch_id:ind_batch_id,
			:v_txn_amt:ind_txn_amt,
			:v_service_fee:ind_service_fee,
			:v_bill_no:ind_bill_no;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/* psp_id */
                if (ind_psp_id  >=  0) { 
			v_psp_id.arr[v_psp_id.len] = '\0';
                        PutField_CString(myHash,"psp_id",v_psp_id.arr);
DEBUGLOG(("GetTxnPspDetail psp_id = [%s]\n",v_psp_id.arr));
		}

/* tid */
                if (ind_tid  >=  0) { 
			v_tid.arr[v_tid.len] = '\0';
                        PutField_CString(myHash,"tid",v_tid.arr);
DEBUGLOG(("GetTxnPspDetail tid = [%s]\n",v_tid.arr));
		}

/* txn_date */
                if (ind_txn_date  >=  0) { 
			v_txn_date.arr[v_txn_date.len] = '\0';
                        PutField_CString(myHash,"txn_date",v_txn_date.arr);
DEBUGLOG(("GetTxnPspDetail txn_date = [%s]\n",v_txn_date.arr));
		}
/* fundin_date */
                if (ind_fundin_date  >=  0) { 
			v_fundin_date.arr[v_fundin_date.len] = '\0';
                        PutField_CString(myHash,"fundin_date",v_fundin_date.arr);
DEBUGLOG(("GetTxnPspDetail fundin_date = [%s]\n",v_fundin_date.arr));
		}
/* fundout_date */
                if (ind_fundout_date  >=  0) { 
			v_fundout_date.arr[v_fundout_date.len] = '\0';
                        PutField_CString(myHash,"fundout_date",v_fundout_date.arr);
DEBUGLOG(("GetTxnPspDetail fundout_date = [%s]\n",v_fundout_date.arr));
		}
/* notice_status */
                if (ind_notice_status  >=  0) { 
			v_notice_status.arr[v_notice_status.len] = '\0';
                        PutField_CString(myHash,"notice_status",v_notice_status.arr);
DEBUGLOG(("GetTxnPspDetail notice_status = [%s]\n",v_notice_status.arr));
		}
/* error_code */
                if (ind_error_code  >=  0) { 
			v_error_code.arr[v_error_code.len] = '\0';
                        PutField_CString(myHash,"error_code",v_error_code.arr);
DEBUGLOG(("GetTxnPspDetail error_code = [%s]\n",v_error_code.arr));
		}

/* batch_id */
                if (ind_batch_id  >=  0) { 
			v_batch_id.arr[v_batch_id.len] = '\0';
                        PutField_CString(myHash,"batch_id",v_batch_id.arr);
DEBUGLOG(("GetTxnPspDetail batch_id = [%s]\n",v_batch_id.arr));
		}

/*txn_amt*/
		if(ind_txn_amt>=0){
			PutField_Double(myHash,"txn_amt",v_txn_amt);
DEBUGLOG(("GetTxnPspDetail txn_amt = [%f]\n",v_txn_amt));
		}

/*service_fee*/
		if(ind_service_fee>=0){
			PutField_Double(myHash,"service_fee",v_service_fee);
DEBUGLOG(("GetTxnPspDetail service_fee = [%f]\n",v_service_fee));
		}

/* bank bill no*/
                if (ind_bill_no  >=  0) { 
			v_bill_no.arr[v_bill_no.len] = '\0';
                        PutField_CString(myHash,"bank_bill_no",v_bill_no.arr);
DEBUGLOG(("GetTxnPspDetail bank_bill_no = [%s]\n",v_bill_no.arr));
		}



		RecordSet_Add(myRec,myHash);
	}
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_gettxnpspdetail;


DEBUGLOG(("GetTxnPspDetail Normal Exit\n")); 
        return  PD_OK;

gettxnpspdetail_error:
DEBUGLOG(("gettxnpspdetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_gettxnpspdetail;
        return PD_ERR;
}


