/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/07/15              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "RulePspReleasePeriod.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;
void RulePspReleasePeriod(char    cdebug)
{
        cDebug = cdebug;
}


int Find(const char* csCountryId,
        const char* csPspId,
        int     *iPeriod)
{
        EXEC SQL WHENEVER SQLERROR GOTO find_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
    
        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_psp_id[PD_MERCHANT_ID_LEN];

		int		v_period;

		short		ind_period= -1;

    
        EXEC SQL END DECLARE SECTION;


        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("Find country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));


        hv_psp_id.len = strlen(csPspId);
        memcpy(hv_psp_id.arr,csPspId,hv_psp_id.len);
DEBUGLOG(("Find psp_id = [%.*s]\n",hv_psp_id.len,hv_psp_id.arr));

        EXEC SQL EXECUTE
                BEGIN

		select  rp_period
                into    :v_period:ind_period
                from    rule_psp_release_period
                where   rp_psp_id=:hv_psp_id
                and     rp_country_id=:hv_country_id
                and     rp_disabled = 0;

                END;
        END-EXEC;

        if (ind_period>= 0)  {
DEBUGLOG(("Find Found\n"));
		*iPeriod = v_period;
DEBUGLOG(("Find v_period = [%d]\n",*iPeriod));
                return PD_OK;
        }
        else {
DEBUGLOG(("Find Not Found\n"));
                return PD_ERR;
        }


find_error:
ERRLOG("RulePspReleasePeriod::find_error code %d\n", sqlca.sqlcode);
DEBUGLOG(("find_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}
