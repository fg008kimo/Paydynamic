/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/07/29              Simon Fung
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "CrrJnlType.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;
void CrrJnlType(char    cdebug)
{
        cDebug = cdebug;
}

int GetMnlApproval(const int iJnlTypeId, int* iMnlApproval)
{
  EXEC SQL WHENEVER SQLERROR GOTO GetMnlApproval_error;
  EXEC SQL WHENEVER NOTFOUND CONTINUE;

  EXEC SQL BEGIN DECLARE SECTION;

	int		hv_jnl_type_id;	
	int		hv_mnl_approval;	
	short		ind_mnl_approval = -1;

  EXEC SQL END DECLARE SECTION;

DEBUGLOG(("GetMnlApproval: Begin\n"));
		
	/* jnl_type_id */
	hv_jnl_type_id = iJnlTypeId;
DEBUGLOG(("GetMnlApproval:hv_jnl_type_id = [%d]\n",hv_jnl_type_id));

  EXEC SQL EXECUTE
		BEGIN
      SELECT MNL_APPROVAL INTO :hv_mnl_approval:ind_mnl_approval
			FROM CRR_JNL_TYPE 
			WHERE JNL_TYPE_ID = :hv_jnl_type_id
			AND DISABLED = 0;
    END;
  END-EXEC;
        	
	if (ind_mnl_approval == -1) {
		hv_mnl_approval = 0;
	}

	*iMnlApproval = hv_mnl_approval;

DEBUGLOG(("GetMnlApproval:hv_mnl_approval = [%d]\n",hv_mnl_approval));
	
	return PD_OK;

GetMnlApproval_error:
DEBUGLOG(("GetMnlApproval_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	ERRLOG("CrrJnlType_GetMnlApproval: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR TxnAbort\n"));
	return PD_INTERNAL_ERR;
}

