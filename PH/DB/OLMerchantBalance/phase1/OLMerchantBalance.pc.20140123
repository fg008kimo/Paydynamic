/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/11              LokMan Chow
balance field follow online structure		   2014/01/07		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLMerchantBalance.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void OLMerchantBalance(char    cdebug)
{
        cDebug = cdebug;
}

int Add(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
		const char* csServiceCode,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("Add: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("Add:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("Add:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("Add:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("Add:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_ol_merchant_balance_insert(
				:hv_merchant_id:ind_merchant_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_country_id:ind_country_id,
				:hv_service_code:ind_service_code,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("Add:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("OLOLMerchantBlance::Add: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		//TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("OLOLMerchantBlance::Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		//TxnAbort();
		return PD_ERR;
	}

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}


int GetCurrentValues(const char* csMerchantID,
                        const char* csCurrencyId,
                        const char* csCountryId,
                        const char* csServiceCode,
                        hash_t *hVal)
{
        int iRet = PD_OK;

        EXEC SQL WHENEVER SQLERROR GOTO getcurrval_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];

                double          v_current_bal;
                double          v_total_reserved_amount;
                double          v_total_hold;

                double          v_total_float_settlement;
                double          v_current_bal_settlement;
                double          v_total_hold_settlement;

                double          v_fundin_payout;
                double          v_reserved_payout;
                double          v_total_float_after_payout;

                short           ind_current_bal= -1;
                short           ind_total_reserved_amount= -1;
                short           ind_total_hold= -1;

                short           ind_total_float_settlement = -1;
                short           ind_current_bal_settlement= -1;
                short           ind_total_hold_settlement= -1;

                short           ind_total_float_after_payout = -1;
                short           ind_fundin_payout = -1;
                short           ind_reserved_payout = -1;

        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetCurrentValues merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetCurrentValues ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetCurrentValues country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetCurrentValues service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        EXEC SQL DECLARE c_cursor_getcurrval CURSOR FOR
                select  
                        om_current_bal,
                        om_total_hold,
                        om_total_reserved_amount,
                        om_total_float_settlement,
                        om_current_bal_settlement,
                        om_total_hold_settlement,
                        om_fundin_payout,
                        om_reserved_payout,
                        om_total_float_after_payout
                  from  ol_merchant_balance
                 where  om_merchant_id = :hv_merchant_id
                   and  om_currency_id = :hv_ccy_id
                   and  om_country_id = :hv_country_id
                   and  om_service_code = :hv_service_code;

        EXEC SQL OPEN c_cursor_getcurrval;
        do {
                EXEC SQL FETCH c_cursor_getcurrval
                INTO
			:v_current_bal:ind_current_bal,
                        :v_total_hold:ind_total_hold,
                        :v_total_reserved_amount:ind_total_reserved_amount,
                        :v_total_float_settlement:ind_total_float_settlement,
                        :v_current_bal_settlement:ind_current_bal_settlement,
                        :v_total_hold_settlement:ind_total_hold_settlement,
                        :v_fundin_payout:ind_fundin_payout,
                        :v_reserved_payout:ind_reserved_payout,
                        :v_total_float_after_payout:ind_total_float_after_payout;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

//current_bal
                if(ind_current_bal<0)
                        v_current_bal = 0.0;
                PutField_Double(hVal,"current_bal",v_current_bal);
DEBUGLOG(("GetCurrentValues current_bal = [%f]\n",v_current_bal));


//total_hold
                if(ind_total_hold<0)
                        v_total_hold= 0;
                PutField_Double(hVal,"total_hold",v_total_hold);
DEBUGLOG(("GetCurrentValues total_hold = [%f]\n",v_total_hold));


//total_reserved_amount
                if(ind_total_reserved_amount<0)
                        v_total_reserved_amount= 0;
                PutField_Double(hVal,"total_reserved_amount",v_total_reserved_amount);
DEBUGLOG(("GetCurrentValues total_reserved_amount = [%f]\n",v_total_reserved_amount));

//total_float_settlement
                if(ind_total_float_settlement<0)
                        v_total_float_settlement= 0;
                PutField_Double(hVal,"total_float_settlement",v_total_float_settlement);
DEBUGLOG(("GetCurrentValues total_float_settlement= [%f]\n",v_total_float_settlement));

//current_bal_settlement
                if(ind_current_bal_settlement<0)
                        v_current_bal_settlement= 0;
                PutField_Double(hVal,"current_bal_settlement",v_current_bal_settlement);
DEBUGLOG(("GetCurrentValues current_bal_settlement= [%f]\n",v_current_bal_settlement));

//total_hold_settlement
                if(ind_total_hold_settlement<0)
                        v_total_hold_settlement= 0;
                PutField_Double(hVal,"total_hold_settlement",v_total_hold_settlement);
DEBUGLOG(("GetCurrentValues total_hold_settlement= [%f]\n",v_total_hold_settlement));

//fundin_payout
                if(ind_fundin_payout<0)
                        v_fundin_payout= 0;
                PutField_Double(hVal,"fundin_payout",v_fundin_payout);
DEBUGLOG(("GetCurrentValues fundin_payout= [%f]\n",v_fundin_payout));

//reserved_payout
                if(ind_reserved_payout<0)
                        v_reserved_payout= 0;
                PutField_Double(hVal,"reserved_payout",v_reserved_payout);
DEBUGLOG(("GetCurrentValues reserved_payout= [%f]\n",v_reserved_payout));

//total_float_after_payout
                if(ind_total_float_after_payout<0)
                        v_total_float_after_payout= 0;
                PutField_Double(hVal,"total_float_after_payout",v_total_float_after_payout);
DEBUGLOG(("GetCurrentValues total_float_after_payout= [%f]\n",v_total_float_after_payout));


        }

        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getcurrval;

DEBUGLOG(("GetCurrentValues Normal Exit\n"));
        return iRet;

getcurrval_error:
DEBUGLOG(("getcurrval_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getcurrval;
        return PD_ERR;
}


int UpdateCurrBal(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
                double  dAmt,
                const char* csUser)

{
        EXEC SQL WHENEVER SQLERROR GOTO updatecurrbal_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                double          hv_amt;
                varchar         hv_create_user[PD_USER_LEN];

                short           ind_merchant_id = -1;
                short           ind_country_id = -1;
                short           ind_ccy_id = -1;
                short           ind_service_code = -1;
                short           ind_amt = -1;
                short           ind_create_user = -1;

                short           hv_return_value;
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("UpdateCurrBal: Begin\n"));

        hv_merchant_id.len = strlen(csMerchantId);
        strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
        ind_merchant_id = 0;
DEBUGLOG(("UpdateCurrBal:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

        hv_country_id.len = strlen(csCountryId);
        strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
        ind_country_id = 0;
DEBUGLOG(("UpdateCurrBal:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_ccy_id.len = strlen(csCcy);
        strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
        ind_ccy_id = 0;
DEBUGLOG(("UpdateCurrBal:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
        ind_service_code = 0;
DEBUGLOG(("UpdateCurrBal:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

       	hv_amt= dAmt;
        ind_amt= 0;
DEBUGLOG(("UpdateCurrBal:net amt = [%f]\n",hv_amt));

        hv_create_user.len = strlen(csUser);
        strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
        ind_create_user = 0;
DEBUGLOG(("UpdateCurrBal:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


        EXEC SQL EXECUTE
            BEGIN

                :hv_return_value := sp_ol_merchant_bal_upd_bal(
                                :hv_merchant_id:ind_merchant_id,
                                :hv_country_id:ind_country_id,
                                :hv_ccy_id:ind_ccy_id,
                                :hv_service_code:ind_service_code,
                                :hv_amt:ind_amt,
                                :hv_create_user:ind_create_user);

            END;
        END-EXEC;


DEBUGLOG(("UpdateCurrBal:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK){
DEBUGLOG(("UpdateCurrBal:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("OLOLMerchantBlance::UpdateCurrBal: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateCurrBal: SP_OTHER_ERR TxnAbort\n"));
                TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("OLOLMerchantBlance::UpdateCurrBal: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateCurrBal: SP_ERR TxnAbort\n"));
                TxnAbort();
                return PD_ERR;
        }

updatecurrbal_error:
DEBUGLOG(("updatecurrbal_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        TxnAbort();
        return PD_ERR;
}

int UpdateHoldBalance(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
		const char  cMHind,
                const char  cType,
                double  dAmt,
                const char* csUser)

{
        EXEC SQL WHENEVER SQLERROR GOTO updatehold_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                double          hv_hold;
                varchar         hv_create_user[PD_USER_LEN];


                short           ind_merchant_id = -1;
                short           ind_country_id = -1;
                short           ind_ccy_id = -1;
                short           ind_service_code = -1;
                short           ind_hold = -1;
                short           ind_create_user = -1;

                short           hv_return_value;
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("UpdateHoldBalance: Begin\n"));

        hv_merchant_id.len = strlen(csMerchantId);
        strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
        ind_merchant_id = 0;
DEBUGLOG(("UpdateHoldBalance:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

        hv_country_id.len = strlen(csCountryId);
        strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
        ind_country_id = 0;
DEBUGLOG(("UpdateHoldBalance:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_ccy_id.len = strlen(csCcy);
        strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
        ind_ccy_id = 0;
DEBUGLOG(("UpdateHoldBalance:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
        ind_service_code = 0;
DEBUGLOG(("UpdateHoldBalance:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        if(cType==PD_HOLD)
        	hv_hold= dAmt;
	else
        	hv_hold= (-1)*dAmt;
        ind_hold= 0;
DEBUGLOG(("UpdateHoldBalance:net hold = [%f]\n",hv_hold));
DEBUGLOG(("UpdateHoldBalance:hold_type = [%c]\n",cType));

        hv_create_user.len = strlen(csUser);
        strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
        ind_create_user = 0;
DEBUGLOG(("UpdateHoldBalance:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));

	if (cMHind == PD_TYPE_PAYOUT) {

		EXEC SQL EXECUTE
			BEGIN

			:hv_return_value := sp_ol_merchant_bal_upd_hold(
                                        :hv_merchant_id:ind_merchant_id,
                                        :hv_country_id:ind_country_id,
                                        :hv_ccy_id:ind_ccy_id,
                                        :hv_service_code:ind_service_code,
                                        :hv_hold:ind_hold,
                                        :hv_create_user:ind_create_user);

			END;
		END-EXEC;

	} else {
		
		EXEC SQL EXECUTE
			BEGIN

			:hv_return_value := sp_ol_merchant_bal_upd_shold(
                                        :hv_merchant_id:ind_merchant_id,
                                        :hv_country_id:ind_country_id,
                                        :hv_ccy_id:ind_ccy_id,
                                        :hv_service_code:ind_service_code,
                                        :hv_hold:ind_hold,
                                        :hv_create_user:ind_create_user);

			END;
		END-EXEC;
	}

DEBUGLOG(("UpdateHoldBalance:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("UpdateHoldBalance:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("OLOLMerchantBlance::UpdateHoldBalance: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateHoldBalance: SP_OTHER_ERR TxnAbort\n"));
                TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("OLOLMerchantBlance::UpdateHoldBalance: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateHoldBalance: SP_ERR TxnAbort\n"));
                TxnAbort();
                return PD_ERR;
        }

updatehold_error:
DEBUGLOG(("updatehold_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        TxnAbort();
        return PD_ERR;
}

int GetOpenBalanceForUpdate(hash_t* hContext,
                const char* csMerchantID,
                const char* csCurrencyId,
                const char* csCountryId,
                const char* csServiceCode)
{
        int iRet = PD_OK;
        double dBal = 0.0;
        double dHold = 0.0;
        double dSetBal = 0.0;
        double dSetHold = 0.0;


        EXEC SQL WHENEVER SQLERROR GOTO getopenbalforupdate_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];

                double          v_current_bal;
                double          v_total_hold;
                double          v_current_bal_settlement;
                double          v_total_hold_settlement;

                short           ind_current_bal= -1;
                short           ind_total_hold= -1;
                short           ind_current_bal_settlement = -1;
                short           ind_total_hold_settlement = -1;

        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetOpenBalanceForUpdate merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetOpenBalanceForUpdate ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetOpenBalanceForUpdate country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetOpenBalanceForUpdate service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        EXEC SQL DECLARE c_cursor_getopbal CURSOR FOR
                select  om_current_bal,
                        om_total_hold,
                        om_current_bal_settlement,
                        om_total_hold_settlement
                  from ol_merchant_balance
                 where om_merchant_id = :hv_merchant_id
                   and om_currency_id = :hv_ccy_id
                   and om_country_id = :hv_country_id
                   and om_service_code = :hv_service_code
                 for update;

        EXEC SQL OPEN c_cursor_getopbal;
        do {
                EXEC SQL FETCH c_cursor_getopbal
                INTO
                        :v_current_bal:ind_current_bal,
                        :v_total_hold:ind_total_hold,
                        :v_current_bal_settlement:ind_current_bal_settlement,
                        :v_total_hold_settlement:ind_total_hold_settlement;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                if(ind_current_bal<0) {
                        v_current_bal = 0.0;
                }
                if(ind_total_hold<0) {
                        v_total_hold= 0.0;
                }
                if(ind_current_bal_settlement <0) {
                        v_current_bal_settlement = 0.0;
                }
                if(ind_total_hold_settlement <0) {
                        v_total_hold_settlement = 0.0;
                }


                dBal = v_current_bal;
                dHold = v_total_hold;
                dSetBal = v_current_bal_settlement;
                dSetHold = v_total_hold_settlement;
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getopbal;

DEBUGLOG(("GetOpenBalanceForUpdate open_bal = [%f]\n",dBal));
                PutField_Double(hContext,"merchant_open_bal",dBal);
DEBUGLOG(("GetOpenBalanceForUpdate total_hold = [%f]\n",dHold));
                PutField_Double(hContext,"total_hold",dHold);
DEBUGLOG(("GetOpenBalanceForUpdate current_bal_settlement = [%f]\n",dSetBal));
                PutField_Double(hContext,"current_bal_settlement",dSetBal);
DEBUGLOG(("GetOpenBalanceForUpdate total_hold_settlement = [%f]\n",dSetHold));
                PutField_Double(hContext,"total_hold_settlement",dSetHold);

DEBUGLOG(("GetOpenBalanceForUpdate Normal Exit\n"));
        return iRet;

getopenbalforupdate_error:
DEBUGLOG(("getopenbalforupdate_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getopbal;
        return PD_ERR;
}


int GetCurrBalance(const char* csMerchantID,
                   const char* csCurrencyId,
		   const char* csCountryId,
		   const char* csServiceCode,
		   double  *dBal)
{
        *dBal = 0.0;
        int iRet = PD_OK;

        EXEC SQL WHENEVER SQLERROR GOTO getcurrbal_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];

                double          v_current_bal;
		double          v_current_bal_sett;
                double          v_total_hold;
                double          v_total_hold_sett;
                double          v_total_reserved_amt;

                short           ind_current_bal= -1;
		short           ind_current_bal_sett= -1;
                short           ind_total_hold= -1;
                short           ind_total_hold_sett= -1;
                short           ind_total_reserved_amt= -1;


        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetCurrBalance merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetCurrBalance ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetCurrBalance country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetCurrBalance service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        EXEC SQL DECLARE c_cursor_getcurrbal CURSOR FOR
                select  om_current_bal,
			om_current_bal_settlement,
                        om_total_hold,
                        om_total_hold_settlement,
                        om_total_reserved_amount
                  from ol_merchant_balance
                 where om_merchant_id = :hv_merchant_id
                   and om_currency_id = :hv_ccy_id
                   and om_country_id = :hv_country_id
                   and om_service_code = :hv_service_code;

        EXEC SQL OPEN c_cursor_getcurrbal;
        do {
                EXEC SQL FETCH c_cursor_getcurrbal
                INTO
			:v_current_bal:ind_current_bal,
                        :v_current_bal_sett:ind_current_bal_sett,
                        :v_total_hold:ind_total_hold,
                        :v_total_hold_sett:ind_total_hold_sett,
                        :v_total_reserved_amt:ind_total_reserved_amt;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

// balance
		if(ind_current_bal<0)
                        v_current_bal= 0.0;
                if(ind_current_bal_sett<0)
                        v_current_bal_sett = 0.0;
                if(ind_total_hold<0)
                        v_total_hold= 0.0;
                if(ind_total_hold_sett<0)
                        v_total_hold_sett= 0.0;
                if(ind_total_reserved_amt<0)
                        v_total_reserved_amt= 0.0;

                *dBal=v_current_bal+v_current_bal_sett-v_total_hold-v_total_hold_sett-v_total_reserved_amt;
DEBUGLOG(("GetCurrBalance balance = [%f]\n",*dBal));


        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getcurrbal;

DEBUGLOG(("GetCurrBalance Normal Exit\n"));
        return iRet;

getcurrbal_error:
DEBUGLOG(("getcurrbal_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getcurrbal;
        return PD_ERR;
}

int GetRemainPOBalance(hash_t* hContext,
                const char* csMerchantID,
                const char* csCurrencyId,
                const char* csCountryId,
                const char* csServiceCode,
                double  *dBal)
{
        *dBal = 0.0;
        int iRet = PD_OK;

        EXEC SQL WHENEVER SQLERROR GOTO getremainpo_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];

                double          v_current_bal;
                double          v_reserved_po;
                double          v_total_float;
                double          v_ava_po;
                double          v_total_hold;
                double          v_fundin;
                double          v_remain_po;
                double          v_remain_po_with_fee;
                double          v_fee_rate;

                short           ind_current_bal= -1;
                short           ind_reserved_po= -1;
                short           ind_total_float= -1;
                short           ind_ava_po= -1;
                short           ind_total_hold= -1;
                short           ind_fundin = -1;
                short           ind_remain_po = -1;
                short           ind_remain_po_with_fee = -1;
                short           ind_fee_rate = -1;


        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetRemainPOBalance merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetRemainPOBalance ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetRemainPOBalance country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetRemainPOBalance service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));


        EXEC SQL DECLARE c_cursor_getremainpo CURSOR FOR
                select  current_bal,
                        total_float,
                        security_bal,
                        fundin_payout,
                        reserved_payout,
                        ava_po,
                        remaining_po_amount,
                        remaining_po_amount_with_fee,
                        appro_po_fee_rate
                  from ol_merchant_balance_view
                 where merchant_id = :hv_merchant_id
                   and currency_id = :hv_ccy_id
                   and country_id = :hv_country_id
                   and service_code = :hv_service_code;


        EXEC SQL OPEN c_cursor_getremainpo;
        do {
                EXEC SQL FETCH c_cursor_getremainpo
                INTO
                        :v_current_bal:ind_current_bal,
                        :v_total_float:ind_total_float,
                        :v_total_hold:ind_total_hold,
                        :v_fundin:ind_fundin,
                        :v_reserved_po:ind_reserved_po,
                        :v_ava_po:ind_ava_po,
                        :v_remain_po:ind_remain_po,
                        :v_remain_po_with_fee:ind_remain_po_with_fee,
                        :v_fee_rate:ind_fee_rate;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

// balance
                if(ind_current_bal<0)
                        v_current_bal = 0.0;
                if(ind_total_float<0)
                        v_total_float = 0.0;
                if(ind_reserved_po<0)
                        v_reserved_po = 0.0;
                if(ind_total_hold<0)
                        v_total_hold = 0.0;
                if(ind_ava_po)
                        v_ava_po = 0.0;
                if(ind_fundin)
                        v_fundin = 0.0;
                if(ind_remain_po)
                        v_remain_po = 0.0;
                if(ind_remain_po_with_fee)
                        v_remain_po_with_fee = 0.0;
                if(ind_fee_rate)
                        v_fee_rate = 0.0;

                *dBal=v_remain_po;
DEBUGLOG(("GetRemainPOBalance remain payout balance = [%f]\n",*dBal));

                PutField_Double(hContext,"merchant_aval_po",v_ava_po);
DEBUGLOG(("GetRemainPOBalance merchant_aval_po = [%f]\n",v_ava_po));
                PutField_Double(hContext,"merchant_reserved_po",v_reserved_po);
DEBUGLOG(("GetRemainPOBalance merchant_reserved_po = [%f]\n",v_reserved_po));
                PutField_Double(hContext,"merchant_fundin_po",v_fundin);
DEBUGLOG(("GetRemainPOBalance merchant_fundin_po = [%f]\n",v_fundin));
                double dAmt = v_ava_po-v_reserved_po-v_fundin;
                if(dAmt < 0.0)
                        dAmt = 0.0;
                PutField_Double(hContext,"merchant_net_float",dAmt);
DEBUGLOG(("GetRemainPOBalance merchant_net_float = [%f]\n",dAmt));

                PutField_Double(hContext,"merchant_remain_po_with_fee",v_remain_po_with_fee);
DEBUGLOG(("GetRemainPOBalance remain_po_with_fee = [%f]\n",v_remain_po_with_fee));
                PutField_Double(hContext,"approximate_fee_rate",v_fee_rate);
DEBUGLOG(("GetRemainPOBalance = [%f]\n",v_fee_rate));
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getremainpo;

DEBUGLOG(("GetRemainPOBalance Normal Exit\n"));
        return iRet;

getremainpo_error:
DEBUGLOG(("getremainpo_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getremainpo;
        return PD_ERR;
}

int UpdatePayoutReserved(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
                double  dAmt,
                const char* csUser)

{
        EXEC SQL WHENEVER SQLERROR GOTO updpores_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                double          hv_amt;
                varchar         hv_create_user[PD_USER_LEN];


                short           ind_merchant_id = -1;
                short           ind_country_id = -1;
                short           ind_ccy_id = -1;
                short           ind_service_code = -1;
                short           ind_amt = -1;
                short           ind_create_user = -1;

                short           hv_return_value;
        EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdatePayoutReserved: Begin\n"));


        hv_merchant_id.len = strlen(csMerchantId);
        strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
        ind_merchant_id = 0;
DEBUGLOG(("UpdatePayoutReserved:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

        hv_country_id.len = strlen(csCountryId);
        strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
        ind_country_id = 0;
DEBUGLOG(("UpdatePayoutReserved:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_ccy_id.len = strlen(csCcy);
        strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
        ind_ccy_id = 0;
DEBUGLOG(("UpdatePayoutReserved:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
        ind_service_code = 0;
DEBUGLOG(("UpdatePayoutReserved:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        hv_amt= dAmt;
        ind_amt= 0;
DEBUGLOG(("UpdatePayoutReserved:amt = [%f]\n",hv_amt));

        hv_create_user.len = strlen(csUser);
        strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
        ind_create_user = 0;
DEBUGLOG(("UpdatePayoutReserved:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


        EXEC SQL EXECUTE
            BEGIN

                :hv_return_value := sp_ol_merch_balance_upd_po_res(
                                :hv_merchant_id:ind_merchant_id,
                                :hv_country_id:ind_country_id,
                                :hv_ccy_id:ind_ccy_id,
                                :hv_service_code:ind_service_code,
                                :hv_amt:ind_amt,
                                :hv_create_user:ind_create_user);

            END;
        END-EXEC;


DEBUGLOG(("UpdatePayoutReserved:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("UpdatePayoutReserved:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("OLOLMerchantBlance::UpdatePayoutReserved: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdatePayoutReserved: SP_OTHER_ERR TxnAbort\n"));
                TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("OLOLMerchantBlance::UpdatePayoutReserved: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdatePayoutReserved: SP_ERR TxnAbort\n"));
                TxnAbort();
                return PD_ERR;
        }

updpores_error:
DEBUGLOG(("updpores_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        TxnAbort();
        return PD_ERR;
}


int GetSettAvalBalanceInq(const char* csMerchantID,
                        const char* csCurrencyId,
                        const char* csCountryId,
                        const char* csServiceCode,
                        double  *dBal)
{
        *dBal = 0.0;
        int iRet = PD_OK;

        EXEC SQL WHENEVER SQLERROR GOTO getsettavalbalinq_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];

                double          v_current_bal;
                double          v_current_bal_sett;
                double          v_total_float_sett;
                double          v_total_hold_sett;
                double          v_total_reserved_sett;
                double          v_sett_in_transit;

                short           ind_current_bal= -1;
                short           ind_current_bal_sett= -1;
                short           ind_total_float_sett= -1;
                short           ind_total_hold_sett= -1;
                short           ind_total_reserved_sett= -1;
                short           ind_sett_in_transit= -1;


        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetSettAvalBalanceInq merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetSettAvalBalanceInq ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetSettAvalBalanceInq country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetSettAvalBalanceInq service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        EXEC SQL DECLARE c_cursor_getsettavalbalinq CURSOR FOR
                select  om_current_bal_settlement,
                        om_total_float_settlement,
                        om_total_hold_settlement,
                        om_total_reserved_amount,
                        om_settlement_in_transit,
                        om_current_bal
                  from ol_merchant_balance
                 where om_merchant_id = :hv_merchant_id
                   and om_currency_id = :hv_ccy_id
                   and om_country_id = :hv_country_id
                   and om_service_code = :hv_service_code;

        EXEC SQL OPEN c_cursor_getsettavalbalinq;
        do {
                EXEC SQL FETCH c_cursor_getsettavalbalinq
                INTO
                        :v_current_bal_sett:ind_current_bal_sett,
                        :v_total_float_sett:ind_total_float_sett,
                        :v_total_hold_sett:ind_total_hold_sett,
                        :v_total_reserved_sett:ind_total_reserved_sett,
                        :v_sett_in_transit:ind_sett_in_transit,
                        :v_current_bal:ind_current_bal;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

// balance
                if(ind_current_bal_sett<0)
                        v_current_bal_sett = 0.0;
                if(ind_total_float_sett<0)
                        v_total_float_sett= 0.0;
                if(ind_total_hold_sett<0)
                        v_total_hold_sett= 0.0;
                if(ind_total_reserved_sett<0)
                        v_total_reserved_sett= 0.0;
                if(ind_current_bal<0)
                        v_current_bal= 0.0;
                if(ind_sett_in_transit<0)
                        v_sett_in_transit=0.0;

                *dBal=v_current_bal_sett-v_total_float_sett-v_total_hold_sett-v_total_reserved_sett-v_sett_in_transit;
DEBUGLOG(("GetSettAvalBalanceInq balance = [%f]\n",*dBal));


        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getsettavalbalinq;

DEBUGLOG(("GetSettAvalBalanceInq Normal Exit\n"));
        return iRet;

getsettavalbalinq_error:
DEBUGLOG(("getsettavalbalinq_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getsettavalbalinq;
        return PD_ERR;
}


int GetSettTotalAvalBalance(hash_t* hContext,
                const char* csMerchantID,
                const char* csCurrencyId,
                const char* csCountryId,
                const char* csServiceCode,
                double  *dBal)
{
        *dBal = 0.0;
        int iRet = PD_OK;

        EXEC SQL WHENEVER SQLERROR GOTO getsetttotalavalbal_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];

                double          v_current_bal;
                double          v_current_bal_sett;
                double          v_total_float_sett;
                double          v_total_hold_sett;
                double          v_total_reserved_sett;

                short           ind_current_bal= -1;
                short           ind_current_bal_sett= -1;
                short           ind_total_float_sett= -1;
                short           ind_total_hold_sett= -1;
                short           ind_total_reserved_sett= -1;


        EXEC SQL END DECLARE SECTION;


        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetSettTotalAvalBalance merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetSettTotalAvalBalance ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetSettTotalAvalBalance country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetSettTotalAvalBalance service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        EXEC SQL DECLARE c_cursor_getsetttotalavalbal CURSOR FOR
                select  om_current_bal_settlement,
                        om_total_float_settlement,
                        om_total_hold_settlement,
                        om_total_reserved_amount,
                        om_current_bal
                  from ol_merchant_balance
                 where om_merchant_id = :hv_merchant_id
                   and om_currency_id = :hv_ccy_id
                   and om_country_id = :hv_country_id
                   and om_service_code = :hv_service_code;

        EXEC SQL OPEN c_cursor_getsetttotalavalbal;
        do {
                EXEC SQL FETCH c_cursor_getsetttotalavalbal
                INTO
                        :v_current_bal_sett:ind_current_bal_sett,
                        :v_total_float_sett:ind_total_float_sett,
                        :v_total_hold_sett:ind_total_hold_sett,
                        :v_total_reserved_sett:ind_total_reserved_sett,
                        :v_current_bal:ind_current_bal;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

// balance
                if(ind_current_bal_sett<0)
                        v_current_bal_sett = 0.0;
                if(ind_total_float_sett<0)
                        v_total_float_sett= 0.0;
                if(ind_total_hold_sett<0)
                        v_total_hold_sett= 0.0;
                if(ind_total_reserved_sett<0)
                        v_total_reserved_sett= 0.0;
                if(ind_current_bal<0)
                        v_current_bal= 0.0;

                *dBal=v_current_bal_sett-v_total_float_sett-v_total_hold_sett-v_total_reserved_sett;
DEBUGLOG(("GetSettTotalAvalBalance balance = [%f]\n",*dBal));

                PutField_Double(hContext,"merchant_open_bal",v_current_bal);
                PutField_Double(hContext,"merchant_open_bal_settlement",v_current_bal_sett);

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getsetttotalavalbal;

DEBUGLOG(("GetSettTotalAvalBalance Normal Exit\n"));
        return iRet;

getsetttotalavalbal_error:
DEBUGLOG(("getsetttotalavalbal_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getsetttotalavalbal;
        return PD_ERR;
}

int UpdateSettInTransit(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
                double  dAmt,
                char    cType,
                const char* csUser)
    
{

        EXEC SQL WHENEVER SQLERROR GOTO upd_sett_intransit_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                double          hv_amt;
                varchar         hv_user[PD_USER_LEN];

                short           ind_merchant_id = -1;
                short           ind_country_id = -1;
                short           ind_ccy_id = -1;
                short           ind_service_code = -1;
                short           ind_amt = -1;
                short           ind_user = -1;

                short           hv_return_value;
        EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateSettInTransit: Begin\n"));

        hv_merchant_id.len = strlen(csMerchantId);
        strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
        ind_merchant_id = 0;

        hv_country_id.len = strlen(csCountryId);
        strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
        ind_country_id = 0;

        hv_ccy_id.len = strlen(csCcy);
        strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
        ind_ccy_id = 0;

        hv_service_code.len = strlen(csServiceCode);
        strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
        ind_service_code = 0;

        if(cType==PD_IND_DEBIT){
                hv_amt = (-1)*(dAmt);
                ind_amt= 0;
        }
        else{
                hv_amt = dAmt;
                ind_amt= 0;
        }
DEBUGLOG(("UpdateSettInTransit:net_amt = [%f]\n",hv_amt));
DEBUGLOG(("UpdateSettInTransit:type => [%c]\n",cType));

        hv_user.len = strlen(csUser);
        strncpy((char *)hv_user.arr, csUser, hv_user.len);
        ind_user = 0;

                EXEC SQL EXECUTE
                   BEGIN

                        :hv_return_value := sp_ol_merch_bal_upd_sett_inst(
                                :hv_merchant_id:ind_merchant_id,
                                :hv_country_id:ind_country_id,
                                :hv_ccy_id:ind_ccy_id,
                                :hv_service_code:ind_service_code,
                                :hv_amt:ind_amt,
                                :hv_user:ind_user);

                   END;
                END-EXEC;

        if (hv_return_value == SP_OK)        {
DEBUGLOG(("UpdateSettInTransit:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("OLMerchantBlance::UpdateSettInTransit: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateSettInTransit: SP_OTHER_ERR TxnAbort\n"));
                TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("OLMerchantBlance::UpdateSettInTransit: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateSettInTransit: SP_ERR TxnAbort\n"));
                TxnAbort();
                return PD_ERR;
        }
upd_sett_intransit_error:
DEBUGLOG(("upd_sett_intransit_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        TxnAbort();
        return PD_ERR;
}

int GetSettInTransit(hash_t* hContext,
                const char* csMerchantID,
                const char* csCurrencyId,
                const char* csCountryId,
                const char* csServiceCode,
                double  *dBal)
{
        *dBal = 0.0;
        int iRet = PD_OK;

        EXEC SQL WHENEVER SQLERROR GOTO getsettintran_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];

                double          v_sett_in_transit;

                short           ind_sett_in_transit= -1;


        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetSettInTransit merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetSettInTransit ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetSettInTransit country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetSettInTransit service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        EXEC SQL DECLARE c_cursor_getsettintran CURSOR FOR
                select
                        om_settlement_in_transit
                  from ol_merchant_balance
                 where om_merchant_id = :hv_merchant_id
                   and om_currency_id = :hv_ccy_id
                   and om_country_id = :hv_country_id
                   and om_service_code = :hv_service_code
                 for update;

        EXEC SQL OPEN c_cursor_getsettintran;
        do {
                EXEC SQL FETCH c_cursor_getsettintran
                INTO
                        :v_sett_in_transit:ind_sett_in_transit;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

// balance
                if(ind_sett_in_transit<0)
                        v_sett_in_transit=0.0;

                *dBal=v_sett_in_transit;
DEBUGLOG(("GetSettInTransit balance = [%f]\n",*dBal));

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getsettintran;

DEBUGLOG(("GetSettInTransit Normal Exit\n"));
        return iRet;

getsettintran_error:
DEBUGLOG(("getsettintran_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getsettintran;
        return PD_ERR;
}

int UpdateSettBal(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
                double  dAmt,
                double  dFee,
                char    cType,
                const char* csUser)
    
{

        EXEC SQL WHENEVER SQLERROR GOTO upd_sett_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                double          hv_amt;
                varchar         hv_user[PD_USER_LEN];

                short           ind_merchant_id = -1;
                short           ind_country_id = -1;
                short           ind_ccy_id = -1;
                short           ind_service_code = -1;
                short           ind_amt = -1;
                short           ind_user = -1;

                short           hv_return_value;
        EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateSettBal: Begin\n"));

        hv_merchant_id.len = strlen(csMerchantId);
        strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
        ind_merchant_id = 0;

        hv_country_id.len = strlen(csCountryId);
        strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
        ind_country_id = 0;

        hv_ccy_id.len = strlen(csCcy);
        strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
        ind_ccy_id = 0;

        hv_service_code.len = strlen(csServiceCode);
        strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
        ind_service_code = 0;

        if(cType==PD_IND_DEBIT){
                hv_amt = (-1)*(dAmt + dFee);
                ind_amt= 0;
        }
        else{
                hv_amt = dAmt - dFee;
                ind_amt= 0;
        }
DEBUGLOG(("UpdateSettBal:amt = [%f]\n",dAmt));
DEBUGLOG(("UpdateSettBal:fee = [%f]\n",dFee));
DEBUGLOG(("UpdateSettBal:net_amt = [%f]\n",hv_amt));
DEBUGLOG(("UpdateSettBal:type => [%c]\n",cType));

        hv_user.len = strlen(csUser);
        strncpy((char *)hv_user.arr, csUser, hv_user.len);
        ind_user = 0;

                EXEC SQL EXECUTE
                   BEGIN

                        :hv_return_value := sp_ol_merch_bal_upd_sett_bal(
                                :hv_merchant_id:ind_merchant_id,
                                :hv_country_id:ind_country_id,
                                :hv_ccy_id:ind_ccy_id,
                                :hv_service_code:ind_service_code,
                                :hv_amt:ind_amt,
                                :hv_user:ind_user);

                   END;
                END-EXEC;

        if (hv_return_value == SP_OK)        {
DEBUGLOG(("UpdateSettBal:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("OLMerchantBlance::UpdateSettBal: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateSettBal: SP_OTHER_ERR TxnAbort\n"));
                TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("OLMerchantBlance::UpdateSettBal: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateSettBal: SP_ERR TxnAbort\n"));
                TxnAbort();
                return PD_ERR;
        }
upd_sett_error:
DEBUGLOG(("upd_sett_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        TxnAbort();
        return PD_ERR;
}

int GetCurrBalanceInq(hash_t* hContext,
                const char* csMerchantID,
                const char* csCurrencyId,
                const char* csCountryId,
                const char* csServiceCode,
                double  *dBal)
{
        *dBal = 0.0;
        int iRet = PD_OK;
    
        EXEC SQL WHENEVER SQLERROR GOTO getcurrbali_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
    
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
    
                double          v_current_bal;
                double          v_current_bal_sett;
                double          v_total_hold;
                double          v_total_hold_sett;
                double          v_total_reserved_amt;

                short           ind_current_bal= -1;
                short           ind_current_bal_sett= -1;
                short           ind_total_hold= -1;
                short           ind_total_hold_sett= -1;
                short           ind_total_reserved_amt= -1;


        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetCurrBalanceInq merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetCurrBalanceInq ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetCurrBalanceInq country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetCurrBalanceInq service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        EXEC SQL DECLARE c_cursor_getcurrbali CURSOR FOR
                select  om_current_bal,
                        om_current_bal_settlement,
                        om_total_hold,
                        om_total_hold_settlement,
                        om_total_reserved_amount
                  from ol_merchant_balance
                 where om_merchant_id = :hv_merchant_id
                   and om_currency_id = :hv_ccy_id
                   and om_country_id = :hv_country_id
                   and om_service_code = :hv_service_code;

        EXEC SQL OPEN c_cursor_getcurrbali;
        do {
                EXEC SQL FETCH c_cursor_getcurrbali
                INTO
                        :v_current_bal:ind_current_bal,
                        :v_current_bal_sett:ind_current_bal_sett,
                        :v_total_hold:ind_total_hold,
                        :v_total_hold_sett:ind_total_hold_sett,
                        :v_total_reserved_amt:ind_total_reserved_amt;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

// balance
                if(ind_current_bal<0)
                        v_current_bal= 0.0;
                if(ind_current_bal_sett<0)
                        v_current_bal_sett = 0.0;
                if(ind_total_hold<0)
                        v_total_hold= 0.0;
                if(ind_total_hold_sett<0)
                        v_total_hold_sett= 0.0;
                if(ind_total_reserved_amt<0)
                        v_total_reserved_amt= 0.0;

                *dBal=v_current_bal+v_current_bal_sett-v_total_hold-v_total_hold_sett-v_total_reserved_amt;
DEBUGLOG(("GetCurrBalanceInq balance = [%f]\n",*dBal));

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getcurrbali;

DEBUGLOG(("GetCurrBalanceInq Normal Exit\n"));
        return iRet;

getcurrbali_error:
DEBUGLOG(("getcurrbali_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getcurrbali;
        return PD_ERR;
}

int SetFundInPayout(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
                double  dAmt,
                const char* csUser)

{
        EXEC SQL WHENEVER SQLERROR GOTO setfundinpo_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                double          hv_amt;
                varchar         hv_create_user[PD_USER_LEN];


                short           ind_merchant_id = -1;
                short           ind_country_id = -1;
                short           ind_ccy_id = -1;
                short           ind_service_code = -1;
                short           ind_amt = -1;
                short           ind_create_user = -1;

                short           hv_return_value;
        EXEC SQL END DECLARE SECTION;


DEBUGLOG(("SetFundInPayout: Begin\n"));


        hv_merchant_id.len = strlen(csMerchantId);
        strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
        ind_merchant_id = 0;
DEBUGLOG(("SetFundInPayout:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

        hv_country_id.len = strlen(csCountryId);
        strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
        ind_country_id = 0;
DEBUGLOG(("SetFundInPayout:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_ccy_id.len = strlen(csCcy);
        strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
        ind_ccy_id = 0;
DEBUGLOG(("SetFundInPayout:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
        ind_service_code = 0;
DEBUGLOG(("SetFundInPayout:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        hv_amt= dAmt;
        ind_amt= 0;
DEBUGLOG(("SetFundInPayout:amt = [%f]\n",hv_amt));

        hv_create_user.len = strlen(csUser);
        strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
        ind_create_user = 0;
DEBUGLOG(("SetFundInPayout:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


        EXEC SQL EXECUTE
            BEGIN

                :hv_return_value := sp_ol_merch_balance_add_fin_po(
                                :hv_merchant_id:ind_merchant_id,
                                :hv_country_id:ind_country_id,
                                :hv_ccy_id:ind_ccy_id,
                                :hv_service_code:ind_service_code,
                                :hv_amt:ind_amt,
                                :hv_create_user:ind_create_user);

            END;
        END-EXEC;


DEBUGLOG(("SetFundInPayout:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("SetFundInPayout:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("OLMerchantBlance::SetFundInPayout: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("SetFundInPayout: SP_OTHER_ERR TxnAbort\n"));
                TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("OLMerchantBlance::SetFundInPayout: SP_ERR TxnAbort\n");
DEBUGLOG(("SetFundInPayout: SP_ERR TxnAbort\n"));
                TxnAbort();
                return PD_ERR;
        }

setfundinpo_error:
DEBUGLOG(("setfundinpo_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        TxnAbort();
        return PD_ERR;
}

int UpdateFundInPayout(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
                double  dAmt,
                const char* csUser)

{
        EXEC SQL WHENEVER SQLERROR GOTO updatefundinpo_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                double          hv_amt;
                varchar         hv_create_user[PD_USER_LEN];


                short           ind_merchant_id = -1;
                short           ind_country_id = -1;
                short           ind_ccy_id = -1;
                short           ind_service_code = -1;
                short           ind_amt = -1;
                short           ind_create_user = -1;
                short           hv_return_value;
        EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateFundInPayout: Begin\n"));


        hv_merchant_id.len = strlen(csMerchantId);
        strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
        ind_merchant_id = 0;
DEBUGLOG(("UpdateFundInPayout:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

        hv_country_id.len = strlen(csCountryId);
        strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
        ind_country_id = 0;
DEBUGLOG(("UpdateFundInPayout:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_ccy_id.len = strlen(csCcy);
        strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
        ind_ccy_id = 0;
DEBUGLOG(("UpdateFundInPayout:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
        ind_service_code = 0;
DEBUGLOG(("UpdateFundInPayout:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        hv_amt= dAmt;
        ind_amt= 0;
DEBUGLOG(("UpdateFundInPayout:amt = [%f]\n",hv_amt));

        hv_create_user.len = strlen(csUser);
        strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
        ind_create_user = 0;
DEBUGLOG(("UpdateFundInPayout:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));

        EXEC SQL EXECUTE
            BEGIN

                :hv_return_value := sp_ol_merch_balance_upd_fin_po(
                                :hv_merchant_id:ind_merchant_id,
                                :hv_country_id:ind_country_id,
                                :hv_ccy_id:ind_ccy_id,
                                :hv_service_code:ind_service_code,
                                :hv_amt:ind_amt,
                                :hv_create_user:ind_create_user);

            END;
        END-EXEC;


DEBUGLOG(("UpdateFundInPayout:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("UpdateFundInPayout:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("OLMerchantBlance::UpdateFundInPayout: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateFundInPayout: SP_OTHER_ERR TxnAbort\n"));
                TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("OLMerchantBlance::UpdateFundInPayout: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateFundInPayout: SP_ERR TxnAbort\n"));
                TxnAbort();
                return PD_ERR;
        }

updatefundinpo_error:
DEBUGLOG(("updatefundinpo_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        TxnAbort();
        return PD_ERR;
}

