DROP VIEW OL_MERCHANT_BALANCE_VIEW;

/* Formatted on 1/10/2014 6:26:48 PM (QP5 v5.252.13127.32867) */
CREATE OR REPLACE FORCE VIEW OL_MERCHANT_BALANCE_VIEW
(
   MERCHANT_ID,
   CURRENCY_ID,
   COUNTRY_ID,
   SERVICE_CODE,
   CURRENT_BAL,
   TOTAL_FLOAT,
   RESERVED_BAL,
   FUNDIN_PAYOUT,
   RESERVED_PAYOUT,
   SECURITY_BAL,
   AVA_PO,
   REMAINING_PO_AMOUNT,
   REMAINING_PO_AMOUNT_WITH_FEE,
   APPRO_PO_FEE_RATE,
   MERCHANT_BAL,
   AVA_SETT,
   TOTAL_AVA_SETT,
   SETT_IN_TRANSIT
)
AS
   SELECT DISTINCT
          om_merchant_id,
          om_currency_id,
          om_country_id,
          om_service_code,
          current_bal,
          total_float,
          reserved_bal,
          om_fundin_payout,
          om_reserved_payout,
          security_bal,
          CASE
             WHEN ava_po > current_bal
             THEN
                CASE WHEN current_bal <= 0 THEN 0 ELSE current_bal END
             ELSE
                ava_po
          END
             AS ava_po,
          CASE
             WHEN remaining_po_amount > current_bal
             THEN
                CASE WHEN current_bal <= 0 THEN 0 ELSE current_bal END
             ELSE
                remaining_po_amount
          END
             AS remaining_po_amount,
          CASE
             WHEN remaining_po_amount_with_fee > current_bal
             THEN
                CASE
                   WHEN current_bal <= 0 THEN 0
                   ELSE current_bal / (1 + rate)
                END
             ELSE
                remaining_po_amount_with_fee
          END
             AS remaining_po_amount_with_fee,
          appro_po_fee_rate,
          merchant_bal,
          ava_sett,
          total_ava_sett,
          sett_in_transit
     FROM (SELECT om_merchant_id,
                  om_currency_id,
                  om_country_id,
                  om_service_code,
                    om_current_bal
                  + om_current_bal_settlement
                  - om_total_hold
                  - om_total_hold_settlement
                  - om_total_reserved_amount
                     AS current_bal,
                  CASE
                     WHEN OMB_TXN_TYPE <> 'D'
                     THEN
                          om_total_float_after_payout
                        + om_total_float_settlement
                     ELSE
                          om_total_float_after_payout
                        + om_total_float_settlement
                        - om_total_hold
                  END
                     AS total_float,
                  om_total_reserved_amount AS reserved_bal,
                  om_fundin_payout,
                  om_reserved_payout,
                  om_total_hold + om_total_hold_settlement AS security_bal,
                  CASE
                     WHEN OMB_TXN_TYPE = 'D'
                     THEN
                        0
                     ELSE
                          om_current_bal
                        - om_total_hold
                        - om_total_float_after_payout
                  END
                     AS ava_po,
                  CASE
                     WHEN OMB_TXN_TYPE = 'D'
                     THEN
                        0
                     ELSE
                        CASE
                           WHEN NVL (omr_reserved_amount, 0) = 0
                           THEN
                              (  om_current_bal
                               - om_total_hold
                               - om_total_float_after_payout)
                           WHEN NVL (omr_remain_reserved_amount, 0) = 0
                           THEN
                              NVL (omr_remain_reserved_amount, 0)
                           WHEN (  om_current_bal
                                 - om_total_hold
                                 - om_total_float_after_payout) >
                                   NVL (omr_remain_reserved_amount, 0)
                           THEN
                              NVL (omr_remain_reserved_amount, 0)
                           ELSE
                              (  om_current_bal
                               - om_total_hold
                               - om_total_float_after_payout)
                        END
                  END
                     AS remaining_po_amount,
                  CASE
                     WHEN OMB_TXN_TYPE = 'D'
                     THEN
                        0
                     ELSE
                        CASE
                           WHEN NVL (omr_reserved_amount, 0) = 0
                           THEN
                                FLOOR (
                                     (  (  om_current_bal
                                         - om_total_hold
                                         - om_total_float_after_payout)
                                      / (1 + rate))
                                   * 100)
                              / 100
                           WHEN NVL (omr_remain_reserved_amount, 0) = 0
                           THEN
                                FLOOR (
                                     (  NVL (omr_remain_reserved_amount, 0)
                                      / (1 + rate))
                                   * 100)
                              / 100
                           WHEN (  om_current_bal
                                 - om_total_hold
                                 - om_total_float_after_payout) >
                                   NVL (omr_remain_reserved_amount, 0)
                           THEN
                                FLOOR (
                                     (  NVL (omr_remain_reserved_amount, 0)
                                      / (1 + rate))
                                   * 100)
                              / 100
                           ELSE
                                FLOOR (
                                     (  (  om_current_bal
                                         - om_total_hold
                                         - om_total_float_after_payout)
                                      / (1 + rate))
                                   * 100)
                              / 100
                        END
                  END
                     AS REMAINING_PO_AMOUNT_WITH_FEE,
                  rate * 100 AS appro_po_fee_rate,
                  (om_current_bal + om_current_bal_settlement)
                     AS merchant_bal,
                  (  om_current_bal_settlement
                   - om_total_float_settlement
                   - om_total_hold_settlement
                   - om_total_reserved_amount
                   - om_settlement_in_transit)
                     AS ava_sett,
                  (  om_current_bal_settlement
                   - om_total_float_settlement
                   - om_total_hold_settlement
                   - om_total_reserved_amount)
                     AS total_ava_sett,
                  om_settlement_in_transit AS sett_in_transit,
                  NVL (seb_bal, 0),
                  rate
             FROM ol_merchant_balance,
                  ol_merchant_bank_acct,
                  ol_bank_accts,
                  def_bank,
                  (  SELECT s_bank_ccy, SUM (s_bank_bal) AS seb_bal
                       FROM seb_balance
                   GROUP BY s_bank_ccy),
                  (SELECT md_merchant_id,
                          (md_approximate_fee_rate / 100) AS rate
                     FROM ol_merch_detail),
                  (SELECT omr_merchant_id,
                          omr_currency_id,
                          omr_country_id,
                          omr_service_code,
                          omr_reserved_amount,
                          omr_remain_reserved_amount
                     FROM ol_merchant_reserved_amt_view
                    WHERE     omr_type = 'D'
                          AND omr_day_of_week =
                                 (SELECT   TO_NUMBER (
                                              TO_CHAR (
                                                 TO_DATE (sys_val,
                                                          'YYYYMMDD'),
                                                 'D'))
                                         - 1
                                            AS day_of_week
                                    FROM (SELECT sys_val
                                            FROM system_control
                                           WHERE sys_code = 'CTPHDATE')))
            WHERE     om_merchant_id = omr_merchant_id(+)
                  AND om_currency_id = omr_currency_id(+)
                  AND om_country_id = omr_country_id(+)
                  AND om_service_code = omr_service_code(+)
                  AND om_merchant_id = md_merchant_id(+)
                  AND om_currency_id = s_bank_ccy(+)
                  AND om_merchant_Id = omb_merchant_id
                  AND ob_int_bank_code = db_int_bank_code
                  AND om_country_id = db_country
                  AND om_currency_id = ob_acct_ccy
                  AND omb_bank_acct_num = ob_bank_acct_num
                  AND omb_int_bank_code = ob_int_bank_code
                  AND om_service_code = omb_service_code);

