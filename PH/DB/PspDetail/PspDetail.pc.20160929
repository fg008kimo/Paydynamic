/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/09/02              Cody Chan
Add Primary Key client_id, delete key		   2011/01/07		   LokMan Chow
Add GetPspDetailByType                             2011/11/21              Virginia Yun
Add support_delta_amt & rej_small_delta_amt	   2013/03/19		   David Wong
Delete support_delta_amt			   2013/04/15		   LokMan Chow
Add rej_small_delta_amt				   2013/04/16		   Stan Poon
Add psp_remark					   2013/06/13		   Virginia Yun
Add overrided_bank_code_channel			   2013/06/14		   Cody Chan
Add processor_name                                 2013/09/02              Virginia Yun
Add pid_group					   2013/10/29		   LokMan Chow
Add MOB_CHANNEL_FE_DISPLAY                         2015/08/26              LokMan Chow
Add UpdateRemark2NULL				   2015/12/14		   Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "PspDetail.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void PspDetail(char    cdebug)
{
        cDebug = cdebug;
}

int Add(const hash_t *hPspDetail)
{
	char            *csTmp;
	char		cTmp;
	int		iTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_psp_id[PD_PSP_ID_LEN];
		varchar		hv_psp_name[PD_PSP_NAME_LEN];
		char		hv_psp_type;
		char		hv_online_mode;
		varchar 	hv_create_user[PD_USER_LEN];
		varchar 	hv_client_id[PD_CLIENT_ID_LEN];
		varchar		hv_psp_merchant_id[PD_PSP_MID_LEN];
		varchar		hv_psp_channel_code[PD_PSP_ID_LEN];
		int		hv_disabled;
		char		hv_txn_type;
		varchar		hv_status[PD_ACCOUNT_STATUS_LEN];
		varchar		hv_ccy[PD_CCY_ID_LEN];

		short		ind_psp_id = -1;
		short		ind_psp_name = -1;
		short		ind_psp_type = -1;
		short		ind_online_mode = -1;
		short		ind_create_user = -1;
		short		ind_client_id= -1;
		short		ind_psp_merchant_id = -1;
		short		ind_psp_channel_code = -1;
		short		ind_txn_type = -1;
		short		ind_status = -1;
		short		ind_ccy = -1;
		short		ind_disabled = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("Add: Begin\n"));

	if(GetField_CString(hPspDetail,"psp_id",&csTmp))
	{
		hv_psp_id.len = strlen(csTmp);
		strncpy((char*)hv_psp_id.arr, csTmp, hv_psp_id.len);
		ind_psp_id = 0;
	}
DEBUGLOG(("Add:psp_id = [%.*s]\n",hv_psp_id.len,hv_psp_id.arr));


	if(GetField_CString(hPspDetail,"psp_name",&csTmp))
	{
		hv_psp_name.len = strlen(csTmp);
		strncpy((char*)hv_psp_name.arr, csTmp, hv_psp_name.len);
		ind_psp_name = 0;
	}
DEBUGLOG(("Add:psp_name = [%.*s]\n",hv_psp_name.len,hv_psp_name.arr));

	if(GetField_CString(hPspDetail,"ccy",&csTmp))
	{
		hv_ccy.len = strlen(csTmp);
		strncpy((char*)hv_ccy.arr, csTmp, hv_ccy.len);
		ind_ccy= 0;
	}
DEBUGLOG(("Add:ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));

	if(GetField_Char(hPspDetail,"psp_type",&cTmp))
	{
		hv_psp_type = cTmp;
		ind_psp_type = 0;
DEBUGLOG(("Add:psp_type = [%c]\n",hv_psp_type));
	}

	if(GetField_Char(hPspDetail,"txn_type",&cTmp))
	{
		hv_txn_type = cTmp;
		ind_txn_type = 0;
DEBUGLOG(("Add:txn_type = [%c]\n",hv_txn_type));
	}

	if(GetField_Char(hPspDetail,"online",&cTmp))
	{
		hv_online_mode = cTmp;
		ind_online_mode = 0;
	}

DEBUGLOG(("Add:online = [%c]\n",hv_online_mode));

	if(GetField_CString(hPspDetail,"status",&csTmp))
	{
		hv_status.len = strlen(csTmp);
		strncpy((char*)hv_status.arr, csTmp, hv_status.len);
		ind_status= 0;
	}
DEBUGLOG(("Add:status= [%.*s]\n",hv_status.len,hv_status.arr));

	if(GetField_CString(hPspDetail,"create_user",&csTmp))
	{
		hv_create_user.len = strlen(csTmp);
		strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
	}
DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));

	if(GetField_CString(hPspDetail,"client_id",&csTmp))
	{
		hv_client_id.len = strlen(csTmp);
		strncpy((char*)hv_client_id.arr, csTmp, hv_client_id.len);
		ind_client_id= 0;
	}
DEBUGLOG(("Add:client_id = [%.*s]\n",hv_client_id.len,hv_client_id.arr));

	if(GetField_CString(hPspDetail,"psp_merchant_id",&csTmp))
	{
		hv_psp_merchant_id.len = strlen(csTmp);
		strncpy((char*)hv_psp_merchant_id.arr, csTmp, hv_psp_merchant_id.len);
		ind_psp_merchant_id= 0;
DEBUGLOG(("Add:psp_merchant_id = [%.*s]\n",hv_psp_merchant_id.len,hv_psp_merchant_id.arr));
	}

	if(GetField_CString(hPspDetail,"psp_channel_code",&csTmp))
	{
		hv_psp_channel_code.len = strlen(csTmp);
		strncpy((char*)hv_psp_channel_code.arr, csTmp, hv_psp_channel_code.len);
		ind_psp_channel_code= 0;
	}
DEBUGLOG(("Add:psp_channel_code = [%.*s]\n",hv_psp_channel_code.len,hv_psp_channel_code.arr));

	if(GetField_Int(hPspDetail,"disabled",&iTmp))
	{
		hv_disabled = iTmp;
		ind_disabled = 0;
	}
DEBUGLOG(("Add:disabled = [%d]\n",hv_disabled));


	FREE_ME(csTmp);


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_psp_detail_insert(
				:hv_psp_id:ind_psp_id,
				:hv_psp_name:ind_psp_name,
				:hv_disabled:ind_disabled,
				:hv_online_mode:ind_online_mode,
				:hv_psp_type:ind_psp_type,
				:hv_create_user:ind_create_user,
				:hv_client_id:ind_client_id,
				:hv_psp_merchant_id:ind_psp_merchant_id,
				:hv_psp_channel_code:ind_psp_channel_code,
				:hv_txn_type:ind_txn_type,
				:hv_ccy:ind_ccy,
				:hv_status:ind_status);


	    END;
	END-EXEC;


	DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
		DEBUGLOG(("Add:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
		ERRLOG("PspDetail_Add: SP_OTHER_ERR \n");
		DEBUGLOG(("Add: SP_OTHER_ERR \n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
		ERRLOG("PspDetail_Add: SP_ERR \n");
		DEBUGLOG(("Add: SP_ERR \n"));
		return PD_ERR;
	}

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("PspDetail_Add: SP_INTERNAL_ERR \n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;


}



int Delete(const unsigned char* psp_id, const unsigned char* client_id)
{
	EXEC SQL WHENEVER SQLERROR GOTO delete_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_psp_id[PD_PSP_ID_LEN];
		varchar hv_client_id[PD_CLIENT_ID_LEN];

		short	hv_return_value;
	EXEC SQL END DECLARE SECTION;

	hv_psp_id.len = strlen((const char*)psp_id);
	memcpy(hv_psp_id.arr,psp_id,hv_psp_id.len);
DEBUGLOG(("Delete: psp_id = [%.*s]\n",hv_psp_id.len,hv_psp_id.arr));

	hv_client_id.len = strlen((const char*)client_id);
	memcpy(hv_client_id.arr,client_id,hv_client_id.len);
DEBUGLOG(("Delete: client_id = [%.*s]\n",hv_client_id.len,hv_client_id.arr));

	EXEC SQL EXECUTE
	    BEGIN
		
		:hv_return_value := sp_psp_detail_delete(
				:hv_psp_id,
				:hv_client_id);

	    END;
	END-EXEC;


	DEBUGLOG(("Delete:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
		DEBUGLOG(("Delete:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
		ERRLOG("PspDetail_Delete: SP_OTHER_ERR TxnAbort\n");
		DEBUGLOG(("Delete: SP_OTHER_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
		ERRLOG("PspDetail_Delete: SP_ERR TxnAbort\n");
		DEBUGLOG(("Delete: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

delete_error:
DEBUGLOG(("delete_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("PspDetail_Delete: SP_INTERNAL_ERR TxnAbort\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;

}

int GetPspDetail(const char* csPspId,
                hash_t* hRec)
{

        EXEC SQL WHENEVER SQLERROR GOTO getpspdetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_psp_id[PD_PSP_ID_LEN];
                int             hv_disabled;
		//char		hv_online_mode;

		varchar		v_status[PD_ACCOUNT_STATUS_LEN+1];
                varchar         v_name[PD_NAME_LEN + 1];
                varchar         v_psp_merchant_id[PD_PSP_MID_LEN+1];
                varchar         v_psp_channel_code[PD_PSP_ID_LEN+1];
                varchar         v_client_id[PD_CLIENT_ID_LEN+1];
                varchar         v_overrided_bank_code_channel[PD_PSP_ID_LEN+1];
/*
		int             v_precal_fee;
                char            v_precal_type;
                double          v_precal_value;
                double          v_precal_additional_value;
*/
		char		v_txn_type;
		char		v_psp_type;
		varchar		v_ccy[PD_CCY_ID_LEN +1];
		double          v_payout_split_limit;
		//int		v_support_delta_amt;
		int		v_rej_small_delta_amt;
                varchar         v_pid_group[PD_CUSTOMER_GROUP_CODE_LEN+1];

		short		ind_status = -1;
                short           ind_name = -1;
		short		ind_psp_merchant_id = -1;
		short		ind_psp_channel_code = -1;
                short           ind_client_id = -1;
                short         	ind_overrided_bank_code_channel = -1;
/*
		short           ind_precal_fee = -1;
                short           ind_precal_type = -1;
                short           ind_precal_value = -1;
                short           ind_precal_additional_value = -1;
*/
		short		ind_txn_type = -1;
		short		ind_psp_type = -1;
		short		ind_ccy = -1;
		short           ind_payout_split_limit = -1;
		//short		ind_support_delta_amt = -1;
		short		ind_rej_small_delta_amt = -1;
                short           ind_pid_group = -1;

        EXEC SQL END DECLARE SECTION;

        hv_psp_id.len = strlen(csPspId);
        memcpy(hv_psp_id.arr,csPspId,hv_psp_id.len);
DEBUGLOG(("GetPspDetail psp_id = [%d][%.*s]\n",hv_psp_id.len,hv_psp_id.len,hv_psp_id.arr));

	hv_disabled = 0;
	//hv_online_mode = PD_ONLINE_MODE;

        EXEC SQL DECLARE c_cursor_getpspdetail CURSOR FOR
                select psp_name,
		       psp_merchant_id,
		       psp_channel_code,
		       client_id,
		       txn_type,
		       currency_id,
		       status,
		       payout_split_limit,
		       //support_delta_amt,
		       rej_small_delta_amt,
		       overrided_bank_code_channel,
		       pid_group,
		       psp_type
                  from psp_detail
                 where psp_id = :hv_psp_id
		 and   disabled = :hv_disabled;
		 //and   online_mode = :hv_online_mode;

        EXEC SQL OPEN c_cursor_getpspdetail;
        do {
                EXEC SQL FETCH c_cursor_getpspdetail
                INTO
                        :v_name:ind_name,
			:v_psp_merchant_id:ind_psp_merchant_id,
			:v_psp_channel_code:ind_psp_channel_code,
			:v_client_id:ind_client_id,
			:v_txn_type:ind_txn_type,
			:v_ccy:ind_ccy,
			:v_status:ind_status,
			:v_payout_split_limit:ind_payout_split_limit,
			//:v_support_delta_amt:ind_support_delta_amt,
			:v_rej_small_delta_amt:ind_rej_small_delta_amt,
			:v_overrided_bank_code_channel:ind_overrided_bank_code_channel,
			:v_pid_group:ind_pid_group,
			:v_psp_type:ind_psp_type;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }


DEBUGLOG(("GetPspDetail found record\n"));

/* psp name */
                if (ind_name >= 0) {
                        v_name.arr[v_name.len] = '\0';
                        PutField_CString(hRec,"psp_name",(const char*)v_name.arr);
DEBUGLOG(("GetPspDetail psp_name = [%s]\n",v_name.arr));
                }


/* psp merchant id */
                if (ind_psp_merchant_id >= 0) {
                        v_psp_merchant_id.arr[v_psp_merchant_id.len] = '\0';
                        PutField_CString(hRec,"psp_merchant_id",(const char*)v_psp_merchant_id.arr);
DEBUGLOG(("GetPspDetail psp_merchant_id = [%s]\n",v_psp_merchant_id.arr));
                }

/* psp channel code */
                if (ind_psp_channel_code >= 0) {
                        v_psp_channel_code.arr[v_psp_channel_code.len] = '\0';
                        PutField_CString(hRec,"psp_channel_code",(const char*)v_psp_channel_code.arr);
DEBUGLOG(("GetPspDetail psp_channel_code = [%s]\n",v_psp_channel_code.arr));
                }

/* client_id*/
                if (ind_client_id>= 0) {
                        v_client_id.arr[v_client_id.len] = '\0';
                        PutField_CString(hRec,"client_id",(const char*)v_client_id.arr);
DEBUGLOG(("GetPspDetail client_id = [%s]\n",v_client_id.arr));
                }

/* txn_type */
                if (ind_txn_type>= 0) {
                        PutField_Char(hRec,"txn_type",v_txn_type);
DEBUGLOG(("GetPspDetail txn_type = [%c]\n",v_txn_type));
                }
/* ccy*/
                if (ind_ccy>= 0) {
                        v_ccy.arr[v_ccy.len] = '\0';
                        PutField_CString(hRec,"ccy",(const char*)v_ccy.arr);
DEBUGLOG(("GetPspDetail ccy = [%s]\n",v_ccy.arr));
                }

/* status */
                if (ind_status >= 0) {
                        v_status.arr[v_status.len] = '\0';
                        PutField_CString(hRec,"status",(const char*)v_status.arr);
DEBUGLOG(("GetPspDetail status = [%s]\n",v_status.arr));
                }

/* payout_split_limit */
                if (ind_payout_split_limit < 0)
                        v_payout_split_limit = 0.0;
                PutField_Double(hRec,"payout_split_limit",v_payout_split_limit);
DEBUGLOG(("GetPspDetail payout_split_limit = [%lf]\n",v_payout_split_limit));

/* support_delta_amt */
/*
		if (ind_support_delta_amt >= 0) {
			PutField_Int(hRec,"support_delta_amt",v_support_delta_amt);
DEBUGLOG(("GetPspDetail support_delta_amt = [%d]\n",v_support_delta_amt));
		}
*/

/* rej_small_delta_amt */
		if (ind_rej_small_delta_amt >= 0) {
			PutField_Int(hRec,"rej_small_delta_amt",v_rej_small_delta_amt);
DEBUGLOG(("GetPspDetail rej_small_delta_amt = [%d]\n",v_rej_small_delta_amt));
		}

/* overrided bank code channel code */
                if (ind_overrided_bank_code_channel >= 0) {
                        v_overrided_bank_code_channel.arr[v_overrided_bank_code_channel.len] = '\0';
                        PutField_CString(hRec,"overrided_bank_code_channel",(const char*)v_overrided_bank_code_channel.arr);
DEBUGLOG(("GetPspDetail overrided_bank_code_channel = [%s]\n",v_overrided_bank_code_channel.arr));
                }

/* pid_group */
                if (ind_pid_group>= 0) {
                        v_pid_group.arr[v_pid_group.len] = '\0';
                        PutField_CString(hRec,"pid_group",(const char*)v_pid_group.arr);
DEBUGLOG(("GetPspDetail pid_group = [%s]\n",v_pid_group.arr));
                }

/* psp_type */
                if (ind_psp_type>= 0) {
                        PutField_Char(hRec,"psp_type",v_psp_type);
DEBUGLOG(("GetPspDetail psp_type = [%c]\n",v_psp_type));
                }

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getpspdetail;


DEBUGLOG(("GetPspDetail Normal Exit\n"));
        return  PD_OK;

getpspdetail_error:
DEBUGLOG(("getpspdetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("PspDetail_Get: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getpspdetail;
        return PD_ERR;
}


int Update(const hash_t *hRls)
{       
        char*   csTmp; 
        char*   csPspId;
	int	iTmp;

        EXEC SQL WHENEVER SQLERROR GOTO update_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
        
        EXEC SQL BEGIN DECLARE SECTION;

        varchar         hv_dynstmt[1024];
        
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
        strcpy((char*)hv_dynstmt.arr,"update psp_detail set update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"psp_id",&csPspId);
DEBUGLOG(("Update:psp_id = [%s]\n",csPspId));
        

/* Status */
        if (GetField_CString(hRls,"status",&csTmp)) {
DEBUGLOG(("Update:status = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",status = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* psp_name*/
        if (GetField_CString(hRls,"psp_name",&csTmp)) {
DEBUGLOG(("Update:psp_name = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",psp_name = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* txn_type */
        if (GetField_CString(hRls,"txn_type",&csTmp)) {
DEBUGLOG(("Update:txn_type = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",txn_type = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* payout_split_limit */
	if (GetField_Int(hRls, "payout_split_limit", &iTmp)) {
DEBUGLOG(("Update:payout_split_limit = [%d]\n",iTmp));
		sprintf(csTmp, "%d", iTmp);

                strcat((char*)hv_dynstmt.arr, ",payout_split_limit = ");
                strcat((char*)hv_dynstmt.arr, csTmp);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* rej_small_delta_amt */
	if (GetField_Int(hRls, "rej_small_delta_amt", &iTmp)) {
DEBUGLOG(("Update:rej_small_delta_amt = [%d]\n",iTmp));
		sprintf(csTmp, "%d", iTmp);

                strcat((char*)hv_dynstmt.arr, ",rej_small_delta_amt = ");
                strcat((char*)hv_dynstmt.arr, csTmp);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* psp_remark */
	if (GetField_CString(hRls, "psp_remark", &csTmp)) {
DEBUGLOG(("Update:psp_remark = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",psp_remark = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* processor_name */
	if (GetField_CString(hRls, "processor_name", &csTmp)) {
DEBUGLOG(("Update:processor_name = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",processor_name = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
	
/* pid_group */
	if (GetField_CString(hRls, "pid_group", &csTmp)) {
DEBUGLOG(("Update:pid_group = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",pid_group = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
	
/* mob_channel_fe_display */
	if (GetField_CString(hRls, "mob_channel_fe_display", &csTmp)) {
DEBUGLOG(("Update:mob_channel_fe_display = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mob_channel_fe_display = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
	

/*update_user*/
        if(GetField_CString(hRls,"update_user",&csTmp)){
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",update_user= '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        strcat((char *)hv_dynstmt.arr, " WHERE psp_id = '");
        strcat((char *)hv_dynstmt.arr, csPspId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;


DEBUGLOG(("Update Normal Exit\n"));
        return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("PspDetail_Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;
}


int GetPspDetailByType(const char cType,
	               recordset_t *myRec)	
{
	int	iCnt = 0;
	hash_t *myHash;

	EXEC SQL WHENEVER SQLERROR GOTO getpspdetailbytype_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                int             hv_disabled;
		char		hv_online_mode;
                char            hv_type;
		//varchar		hv_st_psp_id[PD_PSP_ID_LEN + 1];

                varchar         v_psp_id[PD_PSP_ID_LEN + 1];
                varchar         v_name[PD_NAME_LEN + 1];
                varchar         v_psp_merchant_id[PD_PSP_MID_LEN+1];
                varchar         v_psp_channel_code[PD_PSP_ID_LEN+1];
                varchar         v_client_id[PD_CLIENT_ID_LEN+1];
		char		v_txn_type;
		varchar		v_status[PD_ACCOUNT_STATUS_LEN+1];

                short           ind_psp_id = -1; 
                short           ind_name = -1;
		short		ind_psp_merchant_id = -1;
		short		ind_psp_channel_code = -1;
                short           ind_client_id = -1;
		short		ind_txn_type = -1;
		short		ind_status = -1;

        EXEC SQL END DECLARE SECTION;

        hv_type = cType;
DEBUGLOG(("GetPspDetailByType type = [%c]\n",hv_type));

	hv_disabled = 0;
	hv_online_mode = PD_ONLINE_MODE;
DEBUGLOG(("GetPspDetailByType hv_online_mode [%c]\n", hv_online_mode));

/*
        hv_st_psp_id.len = strlen(csPspId);
        memcpy(hv_st_psp_id.arr,csPspId,hv_st_psp_id.len);
DEBUGLOG(("GetPspDetailByType st_psp_id = [%d][%.*s]\n",hv_st_psp_id.len,hv_st_psp_id.len,hv_st_psp_id.arr));
*/

	EXEC SQL DECLARE c_cursor_getpspdetailbytype CURSOR FOR
		select psp_id,
			psp_name,
			psp_merchant_id,
			psp_channel_code,
			client_id,
			txn_type,
			status
		from	psp_detail
		where	disabled = :hv_disabled
		and	online_mode = :hv_online_mode
		and	psp_type = :hv_type;
			
        EXEC SQL OPEN c_cursor_getpspdetailbytype;
        do {
                EXEC SQL FETCH c_cursor_getpspdetailbytype
                INTO
			:v_psp_id:ind_psp_id,
                        :v_name:ind_name,
			:v_psp_merchant_id:ind_psp_merchant_id,
			:v_psp_channel_code:ind_psp_channel_code,
			:v_client_id:ind_client_id,
			:v_txn_type:ind_txn_type,
			:v_status:ind_status;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

		iCnt++;

		myHash = (hash_t*) malloc(sizeof(hash_t));
		hash_init(myHash, 0);


/* psp id */
                if (ind_psp_id >= 0) {
                        v_psp_id.arr[v_psp_id.len] = '\0';
                        PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetPspDetailByType psp_id = [%s]\n",v_psp_id.arr));
                }
/* psp name */
                if (ind_name >= 0) {
                        v_name.arr[v_name.len] = '\0';
                        PutField_CString(myHash,"psp_name",(const char*)v_name.arr);
DEBUGLOG(("GetPspDetailByType psp_name = [%s]\n",v_name.arr));
                }


/* psp merchant id */
                if (ind_psp_merchant_id >= 0) {
                        v_psp_merchant_id.arr[v_psp_merchant_id.len] = '\0';
                        PutField_CString(myHash,"psp_merchant_id",(const char*)v_psp_merchant_id.arr);
DEBUGLOG(("GetPspDetailByType psp_merchant_id = [%s]\n",v_psp_merchant_id.arr));
                }

/* psp channel code */
                if (ind_psp_channel_code >= 0) {
                        v_psp_channel_code.arr[v_psp_channel_code.len] = '\0';
                        PutField_CString(myHash,"psp_channel_code",(const char*)v_psp_channel_code.arr);
DEBUGLOG(("GetPspDetailbyType psp_channel_code = [%s]\n",v_psp_channel_code.arr));
                }

/* client_id*/
                if (ind_client_id>= 0) {
                        v_client_id.arr[v_client_id.len] = '\0';
                        PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
DEBUGLOG(("GetPspDetailByType client_id = [%s]\n",v_client_id.arr));
                }


/* txn_type */
                if (ind_txn_type>= 0) {
                        PutField_Char(myHash,"txn_type",v_txn_type);
DEBUGLOG(("GetPspDetailByType txn_type = [%c]\n",v_txn_type));
                }

/* status */
                if (ind_status >= 0) {
                        v_status.arr[v_status.len] = '\0';
                        PutField_CString(myHash,"status",(const char*)v_status.arr);
DEBUGLOG(("GetPspDetailByType status = [%s]\n",v_status.arr));
                }

		RecordSet_Add(myRec, myHash);

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getpspdetailbytype;


	if (iCnt > 0) {
DEBUGLOG(("GetPspDetailByType Normal Exit\n"));
	        return  PD_OK;
	}
	else {
DEBUGLOG(("GetPspDetailByType Normal Exit, Not Found\n"));
	        /*return  PD_ERR;*/
	        return  PD_OK;
	}

getpspdetailbytype_error:
DEBUGLOG(("getpspdetailbytype_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("PspDetail_Get: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getpspdetailbytype;
        return PD_ERR;
}


int GetDepositPspList(const char *csTxnCountry,
		      const char *csBank,
	               recordset_t *myRec)	
{
	int	iCnt = 0;
	hash_t *myHash;

	EXEC SQL WHENEVER SQLERROR GOTO getdsppsp_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                int             hv_disabled;
		char		hv_online_mode;
		varchar		hv_country[PD_COUNTRY_LEN];
		varchar		hv_bank[PD_BANK_CODE_LEN];

                varchar         v_psp_id[PD_PSP_ID_LEN + 1];

                short           ind_psp_id = -1; 

        EXEC SQL END DECLARE SECTION;

	hv_disabled = 0;
	hv_online_mode = PD_ONLINE_MODE;
DEBUGLOG(("GetDepositPspList: hv_online_mode = [%c]\n", hv_online_mode));

        hv_country.len = strlen(csTxnCountry);
        memcpy(hv_country.arr,csTxnCountry,hv_country.len);
DEBUGLOG(("GetDepositPspList: txn_country = [%.*s]\n",hv_country.len,hv_country.arr));

        hv_bank.len = strlen(csBank);
        memcpy(hv_bank.arr,csBank,hv_bank.len);
DEBUGLOG(("GetDepositPspList: bank_code = [%.*s]\n",hv_bank.len,hv_bank.arr));

	EXEC SQL DECLARE c_cursor_getdsppsp CURSOR FOR
		select psp_detail.psp_id
		from	psp_detail,
			psp_country,
			psp_master,
			bank_mapping
		where	psp_detail.disabled = :hv_disabled
		and	psp_detail.online_mode = :hv_online_mode
		and	psp_detail.txn_type in ('A', 'D')
		and	psp_detail.psp_id = psp_country.psp_id
		and	psp_detail.client_id = psp_master.pm_client_id
		and	psp_country.country= :hv_country
		and	psp_detail.status = 'O'
		and	psp_master.pm_status = 'O'
		and     bm_psp_channel_id  =  NVL(psp_detail.overrided_bank_code_channel, psp_detail.psp_channel_code)
		and	bm_int_bank_code = :hv_bank
		and	bm_disabled = 0
		order by psp_detail.psp_id;
			
        EXEC SQL OPEN c_cursor_getdsppsp;
        do {
                EXEC SQL FETCH c_cursor_getdsppsp
                INTO
			:v_psp_id:ind_psp_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

		iCnt++;

		myHash = (hash_t*) malloc(sizeof(hash_t));
		hash_init(myHash, 0);

/* psp id */
                if (ind_psp_id >= 0) {
                        v_psp_id.arr[v_psp_id.len] = '\0';
                        PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetDepositPspList psp_id = [%s]\n",v_psp_id.arr));
                }

		RecordSet_Add(myRec, myHash);

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getdsppsp;


	if (iCnt > 0) {
DEBUGLOG(("GetDepositPspList Normal Exit\n"));
	        return  PD_OK;
	}
	else {
DEBUGLOG(("GetDepositPspList Normal Exit, Not Found\n"));
	        /*return  PD_ERR;*/
	        return  PD_OK;
	}

getdsppsp_error:
DEBUGLOG(("getdsppsp_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("PspDetail_GetDepositPspList: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getdsppsp;
        return PD_ERR;
}

int GetPspPayoutSplitAmt(const char* csPspId,
                hash_t* hRec)
{

        EXEC SQL WHENEVER SQLERROR GOTO getsplit_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_psp_id[PD_PSP_ID_LEN];
                int             hv_disabled;

		double          v_payout_split_limit;

		short           ind_payout_split_limit = -1;

        EXEC SQL END DECLARE SECTION;

        hv_psp_id.len = strlen(csPspId);
        memcpy(hv_psp_id.arr,csPspId,hv_psp_id.len);
DEBUGLOG(("GetPspPayoutSplitAmt psp_id = [%d][%.*s]\n",hv_psp_id.len,hv_psp_id.len,hv_psp_id.arr));

	hv_disabled = 0;

        EXEC SQL DECLARE c_cursor_getsplit CURSOR FOR
                select 
		       payout_split_limit
                  from psp_detail
                 where psp_id = :hv_psp_id
		 and   disabled = :hv_disabled
		 and   txn_type in ('A','P')
		 and   status = 'O';

        EXEC SQL OPEN c_cursor_getsplit;
        do {
                EXEC SQL FETCH c_cursor_getsplit
                INTO
			:v_payout_split_limit:ind_payout_split_limit;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }


DEBUGLOG(("GetPspPayoutSplitAmt found record\n"));

/* payout_split_limit */
                if (ind_payout_split_limit < 0)
                        v_payout_split_limit = 0.0;
                PutField_Double(hRec,"payout_split_limit",v_payout_split_limit);
DEBUGLOG(("GetPspPayoutSplitAmt payout_split_limit = [%lf]\n",v_payout_split_limit));


        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getsplit;


DEBUGLOG(("GetPspPayoutSplitAmt Normal Exit\n"));
        return  PD_OK;

getsplit_error:
DEBUGLOG(("getsplit_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("PspDetail_Get: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getsplit;
        return PD_ERR;
}

int UpdateRemark2NULL(const hash_t *hRls)
{       
        char*   csPspId;
	char*	csTmp;
	
        EXEC SQL WHENEVER SQLERROR GOTO updateremark_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
        
        EXEC SQL BEGIN DECLARE SECTION;

        varchar         hv_dynstmt[1024];
        
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
        strcpy((char*)hv_dynstmt.arr,"update psp_detail set update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

// psp_id
        GetField_CString(hRls,"psp_id",&csPspId);
DEBUGLOG(("Update:psp_id = [%s]\n",csPspId));
        

/* psp_remark */
DEBUGLOG(("Update:psp_remark = [%s]\n",csTmp));
      	strcat((char*)hv_dynstmt.arr, ",psp_remark = NULL");
       	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

/*update_user*/
        if(GetField_CString(hRls,"update_user",&csTmp)){
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",update_user= '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        strcat((char *)hv_dynstmt.arr, " WHERE psp_id = '");
        strcat((char *)hv_dynstmt.arr, csPspId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;


DEBUGLOG(("Update Normal Exit\n"));
        return PD_OK;

updateremark_error:
DEBUGLOG(("updateremark_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("PspDetail_Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;
}

