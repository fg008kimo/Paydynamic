/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/12/03              Dirk Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLTxnEngineActionList.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char cDebug;


void OLTxnEngineActionList(char cdebug)
{
	cDebug = cdebug;
}

int GetTxnEngineActionList(const int iActionDetailId, hash_t* hRec)
{
	EXEC SQL WHENEVER SQLERROR GOTO gettxnengineactionlist_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		int	hv_action_detail_id;

		varchar	v_action_desc[PD_ENGINE_ACTION_LEN+1];
		int	v_action_type;
		varchar	v_action_level[PD_ENGINE_TYPE_LEN+1];
		int	v_after_status_rule;
		int	v_bal_rule;
		varchar	v_txn_amt_tag[PD_TAG_LEN+1];
		varchar	v_linkage[PD_ENGINE_TYPE_LEN+1];

		short	ind_action_desc = -1;
		short	ind_action_type = -1;
		short	ind_action_level = -1;
		short	ind_after_status_rule = -1;
		short	ind_bal_rule = -1;
		short	ind_txn_amt_tag = -1;
		short	ind_linkage = -1;

	EXEC SQL END DECLARE SECTION;

	hv_action_detail_id = iActionDetailId;
DEBUGLOG(("GetTxnEngineActionList action_detail_id = [%d]\n", hv_action_detail_id));

	EXEC SQL DECLARE c_cursor_getactionlist CURSOR FOR
		SELECT	EAL_ACTION_DESC,
			EAL_ACTION_TYPE,
			EAL_ACTION_LEVEL,
			EAL_AFTER_STATUS_RULE,
			EAL_BAL_RULE,
			EAL_TXN_AMT_TAG,
			EAL_LINKAGE
		FROM	OL_TXN_ENGINE_ACTION_LIST
		WHERE	EAL_ACTION_DETAIL_ID = :hv_action_detail_id;

	EXEC SQL OPEN c_cursor_getactionlist;
	do {
		EXEC SQL FETCH c_cursor_getactionlist
		INTO
			:v_action_desc:ind_action_desc,
			:v_action_type:ind_action_type,
			:v_action_level:ind_action_level,
			:v_after_status_rule:ind_after_status_rule,
			:v_bal_rule:ind_bal_rule,
			:v_txn_amt_tag:ind_txn_amt_tag,
			:v_linkage:ind_linkage;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

DEBUGLOG(("GetTxnEngineActionList found record\n"));

		if (ind_action_desc >= 0) {
			v_action_desc.arr[v_action_desc.len] = '\0';
			PutField_CString(hRec, "action_desc", (const char*)v_action_desc.arr);
DEBUGLOG(("GetTxnEngineActionList cac = [%s]\n", v_action_desc.arr));
		}

                if (ind_action_type >= 0) {
                        PutField_Int(hRec,"action_type", v_action_type);
DEBUGLOG(("GetTxnEngineActionList action_type = [%d]\n",v_action_type));
                }

		if (ind_action_level >= 0) {
			v_action_level.arr[v_action_level.len] = '\0';
			PutField_CString(hRec, "action_level", (const char*)v_action_level.arr);
DEBUGLOG(("GetTxnEngineActionList action_level = [%s]\n", v_action_level.arr));
		}

                if (ind_after_status_rule >= 0) {
                        PutField_Int(hRec,"after_status_rule", v_after_status_rule);
DEBUGLOG(("GetTxnEngineActionList after_status_rule = [%d]\n",v_after_status_rule));
                }

                if (ind_bal_rule >= 0) {
                        PutField_Int(hRec,"bal_rule", v_bal_rule);
DEBUGLOG(("GetTxnEngineActionList bal_rule = [%d]\n",v_bal_rule));
                }

		if (ind_txn_amt_tag >= 0) {
			v_txn_amt_tag.arr[v_txn_amt_tag.len] = '\0';
			PutField_CString(hRec, "txn_amt_tag", (const char*)v_txn_amt_tag.arr);
DEBUGLOG(("GetTxnEngineActionList txn_amt_tag = [%s]\n", v_txn_amt_tag.arr));
		}

		if (ind_linkage >= 0) {
			v_linkage.arr[v_linkage.len] = '\0';
			PutField_CString(hRec, "linkage", (const char*)v_linkage.arr);
DEBUGLOG(("GetTxnEngineActionList linkage = [%s]\n", v_linkage.arr));
		}

	} while (PD_TRUE);

	EXEC SQL CLOSE c_cursor_getactionlist;

DEBUGLOG(("GetTxnEngineActionList Normal Exit\n"));
	return PD_OK;

gettxnengineactionlist_error:
DEBUGLOG(("gettxnengineactionlist_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLPspDetail_Get: SP_INTERNAL_ERR TxnAbort\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_getactionlist;
	return PD_ERR;
}

