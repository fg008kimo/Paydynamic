/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version					   2015/11/06              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "internal.h"
#include "MiBatchDetail.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char    cDebug;

void MiBatchDetail(char    cdebug)
{
        cDebug = cdebug;
}



int Add(const hash_t *hRls)
{
	char            *csTmp;
	char          	cTmp;
	int          	iTmp;


	EXEC SQL WHENEVER SQLERROR GOTO add_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

	short           hv_return_value;

	varchar         hv_batch_id[PD_MI_BATCH_ID_LEN];
	int         	hv_seq;
	varchar         hv_entity_id[PD_MMS_ENTITY_ID_LEN];
	varchar		hv_party_type[PD_MMS_PARTY_TYPE_LEN];
	varchar		hv_party_id[PD_MMS_PARTY_ID_LEN];
	varchar		hv_txn_id[PD_TXN_SEQ_LEN];
	char		hv_txn_oper_ind;
	varchar         hv_add_user[PD_USER_LEN];

	short           ind_batch_id = -1;
	short           ind_seq = -1;
	short           ind_entity_id = -1;
	short           ind_party_type = -1;
	short           ind_party_id = -1;
	short           ind_txn_id = -1;
	short           ind_txn_oper_ind = -1;
	short           ind_add_user = -1;

	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));


/* batch_id */
        if (GetField_CString(hRls,"batch_id",&csTmp)) {
                hv_batch_id.len = strlen(csTmp);
                memcpy(hv_batch_id.arr,csTmp,hv_batch_id.len);
                ind_batch_id = 0;
DEBUGLOG(("Add:batch_id = [%.*s]\n",hv_batch_id.len,hv_batch_id.arr));
        }

/* seq */
        if (GetField_Int(hRls,"seq",&iTmp)) {
                hv_seq = iTmp;
                ind_seq = 0;
DEBUGLOG(("Add:seq = [%d]\n",hv_seq));
        }

/* entity_id */
        if (GetField_CString(hRls,"entity_id",&csTmp)) {
                hv_entity_id.len = strlen(csTmp);
                memcpy(hv_entity_id.arr,csTmp,hv_entity_id.len);
                ind_entity_id = 0;
DEBUGLOG(("Add:entity_id = [%.*s]\n",hv_entity_id.len,hv_entity_id.arr));
        }

/* party_type */
        if (GetField_CString(hRls,"party_type",&csTmp)) {
                hv_party_type.len = strlen(csTmp);
                memcpy(hv_party_type.arr,csTmp,hv_party_type.len);
                ind_party_type = 0;
DEBUGLOG(("Add:party_type = [%.*s]\n",hv_party_type.len,hv_party_type.arr));
        }

/* party_id */
        if (GetField_CString(hRls,"party_id",&csTmp)) {
                hv_party_id.len = strlen(csTmp);
                memcpy(hv_party_id.arr,csTmp,hv_party_id.len);
                ind_party_id = 0;
DEBUGLOG(("Add:party_id = [%.*s]\n",hv_party_id.len,hv_party_id.arr));
        }

/* txn_id */
        if (GetField_CString(hRls,"txn_id",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("Add:txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
        }

/* txn_oper_ind */
        if (GetField_Char(hRls,"txn_oper_ind",&cTmp)) {
                hv_txn_oper_ind= cTmp;
                ind_txn_oper_ind = 0;
DEBUGLOG(("Add:txn_oper_ind = [%c]\n",hv_txn_oper_ind));
        }

/* user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen(csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("Add:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_mi_batch_detail_insert(
					:hv_batch_id:ind_batch_id,
					:hv_seq:ind_seq,
					:hv_entity_id:ind_entity_id,
					:hv_party_type:ind_party_type,
					:hv_party_id:ind_party_id,
					:hv_txn_id:ind_txn_id,
					:hv_txn_oper_ind:ind_txn_oper_ind,
					:hv_add_user:ind_add_user);
		END;
	END-EXEC;


DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK) {
DEBUGLOG(("Add:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MiBatchDetail_Add: SP_OTHER_ERR\n");
DEBUGLOG(("Add: SP_OTHER_ERR\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MiBatchDetail_Add: SP_ERR\n");
DEBUGLOG(("Add: SP_ERR\n"));
                return PD_ERR;
        }

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("MiBatchDetail_Add: SP_INTERNAL_ERR\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR\n"));
        return PD_INTERNAL_ERR;
}


int GetDetailOfNormalBatch(hash_t* hDtl)
{
        int     iRet = PD_NOT_FOUND;
	char	cTmp;
	char*	csTmp;
DEBUGLOG(("GetDetailOfNormalBatch()\n"));

        EXEC SQL WHENEVER SQLERROR GOTO getdt_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];
		char		hv_oper_ind;
		char		hv_status;

                varchar         v_batch_id[PD_TXN_SEQ_LEN+1];
		int		v_seq;
		varchar		v_entity_id[PD_MMS_ENTITY_ID_LEN+1];
		varchar		v_party_type[PD_MMS_ENTITY_TYPE_LEN+1];
		varchar		v_party_id[PD_MMS_PARTY_ID_LEN+1];

		short		ind_batch_id = -1;
		short		ind_seq = -1;
		short		ind_entity_id = -1;
		short		ind_party_type = -1;
		short		ind_party_id = -1;

        EXEC SQL END DECLARE SECTION;

/* txn_id */
	if(GetField_CString(hDtl,"txn_id",&csTmp)){
        	hv_txn_id.len = strlen(csTmp);
        	memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
DEBUGLOG(("GetDetailOfNormalBatch txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
	}

	if(GetField_Char(hDtl,"oper_ind",&cTmp)){
        	hv_oper_ind = cTmp;
DEBUGLOG(("GetDetailOfNormalBatch oper_ind = [%c]\n",hv_oper_ind));
	}
	else{
		hv_oper_ind = 'I';
DEBUGLOG(("GetDetailOfNormalBatch oper_ind (default)= [%c]\n",hv_oper_ind));
	}

	hv_status = 'N';

        EXEC SQL DECLARE c_cursor_getdt CURSOR FOR
		SELECT	bd_batch_id,
			bd_seq,
			bd_entity_id,
			bd_party_type,
			bd_party_id
	          FROM	mi_batch_header, mi_batch_detail
		WHERE	bh_batch_id = bd_batch_id
		AND	bh_status = :hv_status
		AND	bd_txn_id = :hv_txn_id
		AND	bd_txn_oper_ind = :hv_oper_ind;

        EXEC SQL OPEN c_cursor_getdt;
        do {
                EXEC SQL FETCH c_cursor_getdt
                INTO
			:v_batch_id:ind_batch_id,
			:v_seq:ind_seq,
			:v_entity_id:ind_entity_id,
			:v_party_type:ind_party_type,
			:v_party_id:ind_party_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                iRet = PD_FOUND;

/* batch_id */
                if (ind_batch_id >= 0 ) {
                        v_batch_id.arr[v_batch_id.len] ='\0';
DEBUGLOG(("GetDetailOfNormalBatch batch_id = [%s]\n",v_batch_id.arr));
			PutField_CString(hDtl,"batch_id",(const char*) v_batch_id.arr);
                }

/* seq */
                if (ind_seq >= 0 ) {
DEBUGLOG(("GetDetailOfNormalBatch seq = [%d]\n",v_seq));
			PutField_Int(hDtl,"seq",v_seq);
                }

/* entity_id */
                if (ind_entity_id >= 0 ) {
                        v_entity_id.arr[v_entity_id.len] ='\0';
DEBUGLOG(("GetDetailOfNormalBatch entity_id = [%s]\n",v_entity_id.arr));
			PutField_CString(hDtl,"entity_id",(const char*) v_entity_id.arr);
                }

/* party_type */
                if (ind_party_type >= 0 ) {
                        v_party_type.arr[v_party_type.len] ='\0';
DEBUGLOG(("GetDetailOfNormalBatch party_type = [%s]\n",v_party_type.arr));
			PutField_CString(hDtl,"party_type",(const char*) v_party_type.arr);
                }

/* party_id */
                if (ind_party_id >= 0 ) {
                        v_party_id.arr[v_party_id.len] ='\0';
DEBUGLOG(("GetDetailOfNormalBatch party_id = [%s]\n",v_party_id.arr));
			PutField_CString(hDtl,"party_id",(const char*) v_party_id.arr);
                }

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getdt;

DEBUGLOG(("GetDetailOfNormalBatch() normal return iRet = [%d]\n",iRet));
        return iRet;

getdt_error:
DEBUGLOG(("psppartyid_error code %d\n", sqlca.sqlcode));
ERRLOG("DBMiBatchDetail::getdt_error code %d\n", sqlca.sqlcode);
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getdt;
        return PD_ERR;
}
