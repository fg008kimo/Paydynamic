/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/05/26              Cody Chan
Remove country,txn_code,channel,service		   2012/10/29		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "RuleTxnRes.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;
void RuleTxnRes(char    cdebug)
{
        cDebug = cdebug;
}

int Find(const char* csMerchantId,
         const char* csMerchantClientId,
         char	*cType,
	 double	*dValue)

{
        EXEC SQL WHENEVER SQLERROR GOTO find_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
    
        EXEC SQL BEGIN DECLARE SECTION;
                short           hv_return_value;

                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_merchant_client_id[PD_CLIENT_ID_LEN];

		char		v_type;
		double		v_value;

		short		ind_merchant_id = -1;
		short		ind_merchant_client_id = -1;

    
        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("Find merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
	ind_merchant_id = 0;
    
        hv_merchant_client_id.len = strlen(csMerchantClientId);
        memcpy(hv_merchant_client_id.arr,csMerchantClientId,hv_merchant_client_id.len);
DEBUGLOG(("Find merchant_client_id = [%.*s]\n",hv_merchant_client_id.len,hv_merchant_client_id.arr));
	ind_merchant_client_id = 0;

        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rule_txn_res_find(:hv_merchant_id:ind_merchant_id,
								:hv_merchant_client_id:ind_merchant_client_id,
								:v_type,
								:v_value);
                END;
        END-EXEC;

        if (hv_return_value > 0)  {
DEBUGLOG(("Find Found\n"));
		cType[0] = v_type;
		*dValue = v_value;
DEBUGLOG(("Find v_type = [%c]\n",cType[0]));
DEBUGLOG(("Find v_value = [%f]\n",*dValue));
                return PD_OK;
        }
        else {
DEBUGLOG(("Find Not Found\n"));
                return PD_ERR;
        }


find_error:
ERRLOG("RuleTxnRes::find_error code %d\n", sqlca.sqlcode);
DEBUGLOG(("find_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}
