/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/09/03              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "PspRequestTxnUrl.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void PspRequestTxnUrl(char    cdebug)
{
        cDebug = cdebug;
}



int GetPspRequestTxnUrl(const char* csPspId,const char* csTxnCode, hash_t* hRec)
{
        EXEC SQL WHENEVER SQLERROR GOTO getpsprequesttxnurl_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_psp_id[PD_PSP_ID_LEN];
                varchar         hv_txn_code[PD_TXN_CODE_LEN];

		varchar		v_request_function[PD_FUNCTION_URL_LEN + 1];
		varchar		v_action[PD_FUNCTION_URL_LEN + 1];
		varchar		v_method[PD_URL_METHOD_LEN + 1];

                short           ind_request_function = -1;
		short		ind_action = -1;
		short		ind_method = -1;

        EXEC SQL END DECLARE SECTION;

        hv_psp_id.len = strlen(csPspId);
        memcpy(hv_psp_id.arr,csPspId,hv_psp_id.len);
DEBUGLOG(("GetPspRequestTxnUrl psp_id = [%.*s]\n",hv_psp_id.len,hv_psp_id.arr));

        hv_txn_code.len = strlen(csTxnCode);
        memcpy(hv_txn_code.arr,csTxnCode,hv_txn_code.len);
DEBUGLOG(("GetPspRequestTxnUrl txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));

	EXEC SQL DECLARE c_cursor_getpsprequesttxnurl CURSOR FOR
                SELECT	request_function,
			action,
			url_method
		FROM	psp_request_txn_url
		WHERE	txn_code = :hv_txn_code 
                  and   psp_id = :hv_psp_id
		  and	effect_date = 
			(SELECT max(effect_date)
                           FROM psp_request_txn_url
                          WHERE txn_code = :hv_txn_code
                          and   psp_id = :hv_psp_id
                          and	effect_date <= sysdate);

        EXEC SQL OPEN c_cursor_getpsprequesttxnurl;
        do {
                EXEC SQL FETCH c_cursor_getpsprequesttxnurl
                INTO
			:v_request_function:ind_request_function,
			:v_action:ind_action,
			:v_method:ind_method;

		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
		

/*request_function*/
		if(ind_request_function >= 0)
		{
			v_request_function.arr[v_request_function.len]='\0';
			PutField_CString(hRec,"request_function",v_request_function.arr);
DEBUGLOG(("GetPspRequestTxnUrl request_function = [%s]\n",v_request_function.arr));
		}
/*action*/
		if(ind_action >= 0)
		{
			v_action.arr[v_action.len]='\0';
			PutField_CString(hRec,"action",v_action.arr);
DEBUGLOG(("GetPspRequestTxnUrl action = [%s]\n",v_action.arr));
		}

/*url_method*/
		if(ind_method >= 0)
		{
			v_method.arr[v_method.len]='\0';
			PutField_CString(hRec,"url_method",v_method.arr);
DEBUGLOG(("GetPspRequestTxnUrl url_method = [%s]\n",v_method.arr));
		}
		else{
			PutField_CString(hRec,"url_method",PD_DEFAULT_METHOD);
DEBUGLOG(("GetPspRequestTxnUrl DEFAULT url_method = [%s]\n",PD_DEFAULT_METHOD));
		}

	}while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_getpsprequesttxnurl;


DEBUGLOG(("GetPspRequestTxnUrl Normal Exit\n"));
        return  PD_OK;

getpsprequesttxnurl_error:
DEBUGLOG(("getpsprequesttxnurl_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getpsprequesttxnurl;
        return PD_ERR;

}

