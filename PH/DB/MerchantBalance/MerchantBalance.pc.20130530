/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/01/07              LokMan Chow
Add UpdateFloat					   2011/04/15		   Cody Chan
Split one bal into two				   2012/08/09		   Cody Chan
Add Add						   2012/12/07		   Stan Poon
Add GetCurrBalance for Deposit Refund		   2013/02/18		   Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "MerchantBalance.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void MerchantBalance(char    cdebug)
{
        cDebug = cdebug;
}

int Add(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
		const char* csServiceCode,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("Add: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("Add:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("Add:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("Add:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("Add:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_insert(
				:hv_merchant_id:ind_merchant_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_country_id:ind_country_id,
				:hv_service_code:ind_service_code,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("Add:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::Add: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		//TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		//TxnAbort();
		return PD_ERR;
	}

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	//TxnAbort();
	return PD_ERR;
}


int UpdateFloat(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
		const char* csServiceCode,
                double  dNetAmt,
		double  dReservedAmt,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO updatefloat_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_net_amt;
		double		hv_reserved_amt;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_net_amt = -1;
		short		ind_reserved_amt = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateFloat: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("UpdateFloat:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("UpdateFloat:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("UpdateFloat:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("UpdateFloat:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_net_amt= dNetAmt;
	ind_net_amt= 0;
DEBUGLOG(("UpdatFloat:net_amt = [%f]\n",hv_net_amt));

	hv_reserved_amt= dReservedAmt;
	ind_reserved_amt= 0;
DEBUGLOG(("UpdatFloat:resreved_amt = [%f]\n",hv_reserved_amt));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("UpdateFloat:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_insert_fl(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_net_amt:ind_net_amt,
				:hv_reserved_amt:ind_reserved_amt,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("UpdateFloat:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdateFloat:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::UpdateFloat: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateFloat: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::UpdateFloat: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateFloat: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

updatefloat_error:
DEBUGLOG(("updatefloat_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;


}

int UpdateSettFloat(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
		const char* csServiceCode,
                double  dFloat,
		const char* csUser)
{

	EXEC SQL WHENEVER SQLERROR GOTO updatesettfloat_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_float;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_float= -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateSettFloat: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("UpdateSettFloat:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("UpdateSettFloat:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("UpdateSettFloat:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("UpdateSettFloat:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_float= dFloat;
	ind_float= 0;
DEBUGLOG(("UpdatSettFloat:float = [%f]\n",hv_float));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("UpdateSettFloat:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_sett_fl_in(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_float:ind_float,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("UpdateSettFloat:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdateSettFloat:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::UpdateSettFloat: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateSettFloat: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::UpdateSettFloat: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateSettFloat: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

updatesettfloat_error:
DEBUGLOG(("updatesettfloat_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}


int ReleaseFloat(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
		const char* csServiceCode,
                double  dBal,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO releasefl_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_bal;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_bal = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("ReleaseFloat: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("ReleaseFloat:merchant id = [%.*s][%d]\n",hv_merchant_id.len,hv_merchant_id.arr,hv_merchant_id.len));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("ReleaseFloat:country_id = [%.*s][%d]\n",hv_country_id.len,hv_country_id.arr,hv_country_id.len));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("ReleaseFloat:ccy_id = [%.*s][%d]\n",hv_ccy_id.len,hv_ccy_id.arr,hv_ccy_id.len));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("ReleaseFloat:service_code = [%.*s][%d]\n",hv_service_code.len,hv_service_code.arr,hv_service_code.len));

	hv_bal= dBal;
	ind_bal= 0;
DEBUGLOG(("ReleaseFloat:aval bal = [%f]\n",hv_bal));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("ReleaseFloat:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_release(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_bal:ind_bal,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("ReleaseFloat:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("ReleaseFloat:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::ReleaseFloat: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("ReleaseFloat: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::ReleaseFloat: SP_ERR TxnAbort\n");
DEBUGLOG(("ReleaseFloat: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

releasefl_error:
DEBUGLOG(("releasefl_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}


int ReleaseSettFloat(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
		const char* csServiceCode,
                double  dBal,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO releasesettfl_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_bal;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_bal = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("ReleaseSettFloat: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("ReleaseSettFloat:merchant id = [%.*s][%d]\n",hv_merchant_id.len,hv_merchant_id.arr,hv_merchant_id.len));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("ReleaseSettFloat:country_id = [%.*s][%d]\n",hv_country_id.len,hv_country_id.arr,hv_country_id.len));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("ReleaseSettFloat:ccy_id = [%.*s][%d]\n",hv_ccy_id.len,hv_ccy_id.arr,hv_ccy_id.len));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("ReleaseSettFloat:service_code = [%.*s][%d]\n",hv_service_code.len,hv_service_code.arr,hv_service_code.len));

	hv_bal= dBal;
	ind_bal= 0;
DEBUGLOG(("ReleaseSettFloat:aval bal = [%f]\n",hv_bal));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("ReleaseSettFloat:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_rls_stfl(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_bal:ind_bal,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("ReleaseSettFloat:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("ReleaseSettFloat:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::ReleaseSettFloat: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("ReleaseSettFloat: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::ReleaseSettFloat: SP_ERR TxnAbort\n");
DEBUGLOG(("ReleaseSettFloat: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

releasesettfl_error:
DEBUGLOG(("releasesettfl_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}


int GetSettAvalBalance(hash_t* hContext,
		const char* csMerchantID,
		const char* csCurrencyId,
		const char* csCountryId,
		const char* csServiceCode,
		double	*dBal)
{
	*dBal = 0.0;
	int iRet = PD_OK;
                
        EXEC SQL WHENEVER SQLERROR GOTO getsettavalbal_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
                
		double		v_current_bal;
		double		v_current_bal_sett;
		double		v_total_float_sett;
		double		v_total_hold_sett;
		double		v_total_reserved_sett;

		short		ind_current_bal= -1;
		short		ind_current_bal_sett= -1;
		short		ind_total_float_sett= -1;
		short		ind_total_hold_sett= -1;
		short		ind_total_reserved_sett= -1;
        
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetSettAvalBalance merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetSettAvalBalance ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
        
        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetSettAvalBalance country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetSettAvalBalance service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        EXEC SQL DECLARE c_cursor_getsettavalbal CURSOR FOR
                select	m_current_bal_settlement,
			m_total_float_settlement,
			m_total_hold_settlement,
			m_total_reserved_amount,
			m_current_bal
                  from merchant_balance
		 where m_merchant_id = :hv_merchant_id
		   and m_currency_id = :hv_ccy_id
		   and m_country_id = :hv_country_id
		   and m_service_code = :hv_service_code
		 for update;

        EXEC SQL OPEN c_cursor_getsettavalbal;
        do {
                EXEC SQL FETCH c_cursor_getsettavalbal
                INTO
			:v_current_bal_sett:ind_current_bal_sett,
			:v_total_float_sett:ind_total_float_sett,
			:v_total_hold_sett:ind_total_hold_sett,
			:v_total_reserved_sett:ind_total_reserved_sett,
			:v_current_bal:ind_current_bal;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

// balance
                if(ind_current_bal_sett<0)
			v_current_bal_sett = 0.0;
                if(ind_total_float_sett<0)
			v_total_float_sett= 0.0;
                if(ind_total_hold_sett<0)
			v_total_hold_sett= 0.0;
                if(ind_total_reserved_sett<0)
			v_total_reserved_sett= 0.0;
                if(ind_current_bal<0)
			v_current_bal= 0.0;

		*dBal=v_current_bal_sett-v_total_float_sett-v_total_hold_sett-v_total_reserved_sett;
DEBUGLOG(("GetSettAvalBalance balance = [%f]\n",*dBal));

		PutField_Double(hContext,"merchant_open_bal",v_current_bal);
		PutField_Double(hContext,"merchant_open_bal_settlement",v_current_bal_sett);

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getsettavalbal;

DEBUGLOG(("GetSettAvalBalance Normal Exit\n"));
	return iRet;

getsettavalbal_error:
DEBUGLOG(("getsettavalbal_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getsettavalbal;
	TxnAbort();
        return PD_ERR;
}


int GetCurrBalance(hash_t* hContext,
		const char* csMerchantID,
		const char* csCurrencyId,
		const char* csCountryId,
		const char* csServiceCode,
		double	*dBal)
{
	*dBal = 0.0;
	int iRet = PD_OK;
                
        EXEC SQL WHENEVER SQLERROR GOTO getcurrbal_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
                
		double		v_current_bal;
		double		v_current_bal_sett;
		double		v_total_hold;
		double		v_total_hold_sett;
		double		v_total_reserved_amt;

		short		ind_current_bal= -1;
		short		ind_current_bal_sett= -1;
		short		ind_total_hold= -1;
		short		ind_total_hold_sett= -1;
		short		ind_total_reserved_amt= -1;
        
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetCurrBalance merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetCurrBalance ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
        
        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetCurrBalance country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetCurrBalance service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        EXEC SQL DECLARE c_cursor_getcurrbal CURSOR FOR
                select	m_current_bal,
                	m_current_bal_settlement,
			m_total_hold,
			m_total_hold_settlement,
			m_total_reserved_amount
                  from merchant_balance
		 where m_merchant_id = :hv_merchant_id
		   and m_currency_id = :hv_ccy_id
		   and m_country_id = :hv_country_id
		   and m_service_code = :hv_service_code
		 for update;

        EXEC SQL OPEN c_cursor_getcurrbal;
        do {
                EXEC SQL FETCH c_cursor_getcurrbal
                INTO
			:v_current_bal:ind_current_bal,
			:v_current_bal_sett:ind_current_bal_sett,
			:v_total_hold:ind_total_hold,
			:v_total_hold_sett:ind_total_hold_sett,
			:v_total_reserved_amt:ind_total_reserved_amt;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

// balance
                if(ind_current_bal<0)
			v_current_bal= 0.0;
                if(ind_current_bal_sett<0)
			v_current_bal_sett = 0.0;
                if(ind_total_hold<0)
			v_total_hold= 0.0;
                if(ind_total_hold_sett<0)
			v_total_hold_sett= 0.0;
                if(ind_total_reserved_amt<0)
			v_total_reserved_amt= 0.0;

		*dBal=v_current_bal+v_current_bal_sett-v_total_hold-v_total_hold_sett-v_total_reserved_amt;
DEBUGLOG(("GetCurrBalance balance = [%f]\n",*dBal));

		PutField_Double(hContext,"merchant_open_bal",v_current_bal);
		PutField_Double(hContext,"merchant_open_bal_settlement",v_current_bal_sett);

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getcurrbal;

DEBUGLOG(("GetCurrBalance Normal Exit\n"));
	return iRet;

getcurrbal_error:
DEBUGLOG(("getcurrbal_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getcurrbal;
	TxnAbort();
        return PD_ERR;
}


int GetPOAvalBalance(hash_t* hContext,
		const char* csMerchantID,
		const char* csCurrencyId,
		const char* csCountryId,
		const char* csServiceCode,
		double	*dBal)
{
	*dBal = 0.0;
	int iRet = PD_OK;
                
        EXEC SQL WHENEVER SQLERROR GOTO getpoavalbal_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
                
		double		v_current_bal;
		double		v_reserved_po;
		double		v_total_float;
		double		v_ava_po;
		double		v_total_hold;
		double		v_fundin;

		short		ind_current_bal= -1;
		short		ind_reserved_po= -1;
		short		ind_total_float= -1;
		short		ind_ava_po= -1;
		short		ind_total_hold= -1;
		short		ind_fundin = -1;
        
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetPOAvalBalance merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetPOAvalBalance ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
        
        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetPOAvalBalance country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetPOAvalBalance service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));


        EXEC SQL DECLARE c_cursor_getpoavalbal CURSOR FOR
                select	current_bal,
			total_float,
			security_bal,
			m_fundin_payout,
			m_reserved_payout,
			ava_po
                  from merchant_balance_view
		 where m_merchant_id = :hv_merchant_id
		   and m_currency_id = :hv_ccy_id
		   and m_country_id = :hv_country_id
		   and m_service_code = :hv_service_code;


        EXEC SQL OPEN c_cursor_getpoavalbal;
        do {
                EXEC SQL FETCH c_cursor_getpoavalbal
                INTO
			:v_current_bal:ind_current_bal,
			:v_total_float:ind_total_float,
			:v_total_hold:ind_total_hold,
			:v_fundin:ind_fundin,
			:v_reserved_po:ind_reserved_po,
			:v_ava_po:ind_ava_po;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

// balance
                if(ind_current_bal<0)
			v_current_bal = 0.0;
		if(ind_total_float<0)
			v_total_float = 0.0;
		if(ind_reserved_po<0)
			v_reserved_po = 0.0;
		if(ind_total_hold<0)
			v_total_hold = 0.0;
		if(ind_ava_po)
			v_ava_po = 0.0;
		if(ind_fundin)
			v_fundin = 0.0;

		*dBal=v_ava_po;
DEBUGLOG(("GetPOAvalBalance balance = [%f]\n",*dBal));

		PutField_Double(hContext,"fundin_po",v_fundin);
DEBUGLOG(("GetPOAvalBalance FundIn = [%f]\n",v_fundin));

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getpoavalbal;

DEBUGLOG(("GetPOAvalBalance Normal Exit\n"));
	return iRet;

getpoavalbal_error:
DEBUGLOG(("getpoavalbal_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getpoavalbal;
	TxnAbort();
        return PD_ERR;
}


int GetRemainPOBalance(hash_t* hContext,
		const char* csMerchantID,
		const char* csCurrencyId,
		const char* csCountryId,
		const char* csServiceCode,
		double	*dBal)
{
	*dBal = 0.0;
	int iRet = PD_OK;
                
        EXEC SQL WHENEVER SQLERROR GOTO getremainpo_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
                
		double		v_current_bal;
		double		v_reserved_po;
		double		v_total_float;
		double		v_ava_po;
		double		v_total_hold;
		double		v_fundin;
		double		v_remain_po;
		double		v_remain_po_with_fee;
		double		v_fee_rate;

		short		ind_current_bal= -1;
		short		ind_reserved_po= -1;
		short		ind_total_float= -1;
		short		ind_ava_po= -1;
		short		ind_total_hold= -1;
		short		ind_fundin = -1;
		short		ind_remain_po = -1;
		short		ind_remain_po_with_fee = -1;
		short		ind_fee_rate = -1;
        
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetRemainPOBalance merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetRemainPOBalance ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
        
        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetRemainPOBalance country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetRemainPOBalance service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));


        EXEC SQL DECLARE c_cursor_getremainpo CURSOR FOR
                select	current_bal,
			total_float,
			security_bal,
			m_fundin_payout,
			m_reserved_payout,
			ava_po,
			remaining_po_amount,
			round(remaining_po_amount_with_fee,2),
			appro_po_fee_rate
                  from merchant_balance_view
		 where m_merchant_id = :hv_merchant_id
		   and m_currency_id = :hv_ccy_id
		   and m_country_id = :hv_country_id
		   and m_service_code = :hv_service_code;


        EXEC SQL OPEN c_cursor_getremainpo;
        do {
                EXEC SQL FETCH c_cursor_getremainpo
                INTO
			:v_current_bal:ind_current_bal,
			:v_total_float:ind_total_float,
			:v_total_hold:ind_total_hold,
			:v_fundin:ind_fundin,
			:v_reserved_po:ind_reserved_po,
			:v_ava_po:ind_ava_po,
			:v_remain_po:ind_remain_po,
			:v_remain_po_with_fee:ind_remain_po_with_fee,
			:v_fee_rate:ind_fee_rate;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

// balance
                if(ind_current_bal<0)
			v_current_bal = 0.0;
		if(ind_total_float<0)
			v_total_float = 0.0;
		if(ind_reserved_po<0)
			v_reserved_po = 0.0;
		if(ind_total_hold<0)
			v_total_hold = 0.0;
		if(ind_ava_po)
			v_ava_po = 0.0;
		if(ind_fundin)
			v_fundin = 0.0;
		if(ind_remain_po)
			v_remain_po = 0.0;
		if(ind_remain_po_with_fee)
			v_remain_po_with_fee = 0.0;
		if(ind_fee_rate)
			v_fee_rate = 0.0;

		*dBal=v_remain_po;
DEBUGLOG(("GetRemainPOBalance remain payout balance = [%f]\n",*dBal));

		PutField_Double(hContext,"merchant_aval_po",v_ava_po);
DEBUGLOG(("GetRemainPOBalance merchant_aval_po = [%f]\n",v_ava_po));
		PutField_Double(hContext,"merchant_reserved_po",v_reserved_po);
DEBUGLOG(("GetRemainPOBalance merchant_reserved_po = [%f]\n",v_reserved_po));
		PutField_Double(hContext,"merchant_fundin_po",v_fundin);
DEBUGLOG(("GetRemainPOBalance merchant_fundin_po = [%f]\n",v_fundin));
		double dAmt = v_ava_po-v_reserved_po-v_fundin;
		if(dAmt < 0.0)
			dAmt = 0.0;
		PutField_Double(hContext,"merchant_net_float",dAmt);
DEBUGLOG(("GetRemainPOBalance merchant_net_float = [%f]\n",dAmt));

		PutField_Double(hContext,"merchant_remain_po_with_fee",v_remain_po_with_fee);
DEBUGLOG(("GetRemainPOBalance remain_po_with_fee = [%f]\n",v_remain_po_with_fee));
		PutField_Double(hContext,"approximate_fee_rate",v_fee_rate);
DEBUGLOG(("GetRemainPOBalance = [%f]\n",v_fee_rate));
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getremainpo;

DEBUGLOG(("GetRemainPOBalance Normal Exit\n"));
	return iRet;

getremainpo_error:
DEBUGLOG(("getremainpo_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getremainpo;
	TxnAbort();
        return PD_ERR;
}


int UpdateReserved(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
                double  dFloat,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO updatereserved_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_float;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_float = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


	DEBUGLOG(("UpdateReserved: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("UpdateReserved:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("UpdateReserved:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("UpdateReserved:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("UpdateReserved:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_float= dFloat;
	ind_float= 0;
DEBUGLOG(("UpdateReserved:float = [%f]\n",hv_float));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("UpdateReserved:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_insert_rs(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_float:ind_float,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("UpdateReserved:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdateReserved:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::UpdateReserved: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateReserved: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::UpdateReserved: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateReserved: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

updatereserved_error:
DEBUGLOG(("updatereserved_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;


}


int GetCurrentValues(const char* csMerchantID,
			const char* csCurrencyId, 
			const char* csCountryId,
			const char* csServiceCode,
			hash_t *hVal)
{
	int iRet = PD_OK;
                
        EXEC SQL WHENEVER SQLERROR GOTO getcurrval_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar         hv_country_id[PD_COUNTRY_LEN];
		varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                
		double		v_total_float;
		double		v_current_bal;
		double		v_total_reserved_amount;
		double		v_total_hold;

		double		v_total_float_settlement;
		double		v_current_bal_settlement;
		double		v_total_hold_settlement;

		double		v_fundin_payout;
		double		v_reserved_payout;
		double		v_total_float_after_payout;

		short		ind_total_float = -1;
		short		ind_current_bal= -1;
		short		ind_total_reserved_amount= -1;
		short		ind_total_hold= -1;

		short		ind_total_float_settlement = -1;
		short		ind_current_bal_settlement= -1;
		short		ind_total_hold_settlement= -1;

		short		ind_total_float_after_payout = -1;
		short		ind_fundin_payout = -1;
		short		ind_reserved_payout = -1;
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetCurrentValues merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetCurrentValues ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
        
        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetCurrentValues country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetCurrentValues service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
        
        EXEC SQL DECLARE c_cursor_getcurrval CURSOR FOR
                select 	m_total_float,
			m_current_bal,
			m_total_reserved_amount,
			m_total_hold,
			m_total_float_settlement,
			m_current_bal_settlement,
			m_total_hold_settlement,
			m_total_float_after_payout,
			m_fundin_payout,
                        m_reserved_payout
                  from 	merchant_balance
		 where 	m_merchant_id = :hv_merchant_id
		   and 	m_currency_id = :hv_ccy_id
		   and	m_country_id = :hv_country_id
		   and	m_service_code = :hv_service_code;

        EXEC SQL OPEN c_cursor_getcurrval;
        do {
                EXEC SQL FETCH c_cursor_getcurrval
                INTO
			:v_total_float:ind_total_float,
			:v_current_bal:ind_current_bal,
			:v_total_reserved_amount:ind_total_reserved_amount,
			:v_total_hold:ind_total_hold,
			:v_total_float_settlement:ind_total_float_settlement,
			:v_current_bal_settlement:ind_current_bal_settlement,
			:v_total_hold_settlement:ind_total_hold_settlement,
			:v_total_float_after_payout:ind_total_float_after_payout,
			:v_fundin_payout:ind_fundin_payout,
			:v_reserved_payout:ind_reserved_payout;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

//total_float 
                if(ind_total_float<0)
			v_total_float = 0.0;
		PutField_Double(hVal,"total_float",v_total_float);
DEBUGLOG(("GetCurrentValues float = [%f]\n",v_total_float));
		
//current_bal
                if(ind_current_bal<0)
			v_current_bal = 0.0;
		PutField_Double(hVal,"current_bal",v_current_bal);
DEBUGLOG(("GetCurrentValues current_bal = [%f]\n",v_current_bal));


//total_reserved_amount
                if(ind_total_reserved_amount<0)
			v_total_reserved_amount= 0.0;
		PutField_Double(hVal,"total_reserved_amount",v_total_reserved_amount);
DEBUGLOG(("GetCurrentValues total_reserved_amount = [%f]\n",v_total_reserved_amount));

//total_hold
                if(ind_total_hold<0)
			v_total_hold= 0;
		PutField_Double(hVal,"total_hold",v_total_hold);
DEBUGLOG(("GetCurrentValues total_hold = [%f]\n",v_total_hold));


//total_float_settlement 
                if(ind_total_float_settlement<0)
			v_total_float_settlement = 0.0;
		PutField_Double(hVal,"total_float_settlement",v_total_float_settlement);
DEBUGLOG(("GetCurrentValues float_settlement = [%f]\n",v_total_float_settlement));

//current_bal_settlement
                if(ind_current_bal_settlement<0)
			v_current_bal_settlement = 0.0;
		PutField_Double(hVal,"current_bal_settlement",v_current_bal_settlement);
DEBUGLOG(("GetCurrentValues current_bal_settlement = [%f]\n",v_current_bal_settlement));

//total_hold_settlement
                if(ind_total_hold_settlement<0)
			v_total_hold_settlement= 0;
		PutField_Double(hVal,"total_hold_settlement",v_total_hold_settlement);
DEBUGLOG(("GetCurrentValues total_hold_settlement = [%f]\n",v_total_hold_settlement));

//total_float_after_payout 
                if(ind_total_float_after_payout<0)
			v_total_float_after_payout = 0.0;
		PutField_Double(hVal,"total_float_after_payout",v_total_float_after_payout);
DEBUGLOG(("GetCurrentValues float_after_payout = [%f]\n",v_total_float_after_payout));
		
//fundin payout
                if(ind_fundin_payout<0)
			v_fundin_payout= 0;
		PutField_Double(hVal,"fundin_payout",v_fundin_payout);
DEBUGLOG(("GetCurrentValues fundin_payout = [%f]\n",v_fundin_payout));

//reserved payout
                if(ind_reserved_payout<0)
			v_reserved_payout= 0;
		PutField_Double(hVal,"reserved_payout",v_reserved_payout);
DEBUGLOG(("GetCurrentValues reserved_payout = [%f]\n",v_reserved_payout));

        }

        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getcurrval;

DEBUGLOG(("GetCurrentValues Normal Exit\n"));
	return iRet;

getcurrval_error:
DEBUGLOG(("getcurrval_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getcurrval;
        return PD_ERR;
}



int UpdateCurrBal(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
		const char* csServiceCode,
                double  dAmt,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO updatecurrbal_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_amt;
		varchar 	hv_create_user[PD_USER_LEN];

		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_amt = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateCurrBal: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("UpdateCurrBal:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("UpdateCurrBal:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("UpdateCurrBal:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("UpdateCurrBal:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_amt= dAmt;
	ind_amt= 0;
DEBUGLOG(("UpdateCurrBal:amt = [%f]\n",hv_amt));


	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("UpdateCurrBal:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_upd_bal(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_amt:ind_amt,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("UpdateCurrBal:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK){
DEBUGLOG(("UpdateCurrBal:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::UpdateCurrBal: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateCurrBal: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::UpdateCurrBal: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateCurrBal: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

updatecurrbal_error:
DEBUGLOG(("updatecurrbal_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}


int UpdateHoldBalance(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
		const char* csServiceCode,
		const char  cMHind,
		const char  cType,
                double  dAmt,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO updatehold_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_hold;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_hold = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateHoldBalance: Begin\n"));

	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("UpdateHoldBalance:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("UpdateHoldBalance:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("UpdateHoldBalance:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("UpdateHoldBalance:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_hold= dAmt;
	ind_hold= 0;
DEBUGLOG(("UpdateHoldBalance:hold = [%f]\n",hv_hold));
DEBUGLOG(("UpdateHoldBalance:hold_type = [%c]\n",cType));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("UpdateHoldBalance:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	if(cType==PD_HOLD){

		if (cMHind == PD_TYPE_PAYOUT) {
			EXEC SQL EXECUTE
	    			BEGIN

				:hv_return_value := sp_merchant_bal_credit_hold(
					:hv_merchant_id:ind_merchant_id,
					:hv_country_id:ind_country_id,
					:hv_ccy_id:ind_ccy_id,
					:hv_service_code:ind_service_code,
					:hv_hold:ind_hold,
					:hv_create_user:ind_create_user);

	    			END;
			END-EXEC;
		} else {
			EXEC SQL EXECUTE
	    			BEGIN

				:hv_return_value := sp_merchant_bal_cr_hold_sett(
					:hv_merchant_id:ind_merchant_id,
					:hv_country_id:ind_country_id,
					:hv_ccy_id:ind_ccy_id,
					:hv_service_code:ind_service_code,
					:hv_hold:ind_hold,
					:hv_create_user:ind_create_user);

	    			END;
			END-EXEC;
		}
	}
	else{

		if (cMHind == PD_TYPE_PAYOUT) {
			EXEC SQL EXECUTE
	    			BEGIN

				:hv_return_value := sp_merchant_bal_debit_hold(
					:hv_merchant_id:ind_merchant_id,
					:hv_country_id:ind_country_id,
					:hv_ccy_id:ind_ccy_id,
					:hv_service_code:ind_service_code,
					:hv_hold:ind_hold,
					:hv_create_user:ind_create_user);

	    			END;
			END-EXEC;
		} else {
			EXEC SQL EXECUTE
	    			BEGIN

				:hv_return_value := sp_merchant_bal_dr_hold_sett(
					:hv_merchant_id:ind_merchant_id,
					:hv_country_id:ind_country_id,
					:hv_ccy_id:ind_ccy_id,
					:hv_service_code:ind_service_code,
					:hv_hold:ind_hold,
					:hv_create_user:ind_create_user);

	    			END;
			END-EXEC;
		}
		
	}


DEBUGLOG(("UpdateHoldBalance:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdateHoldBalance:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::UpdateHoldBalance: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateHoldBalance: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::UpdateHoldBalance: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateHoldBalance: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

updatehold_error:
DEBUGLOG(("updatehold_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;


}

int GetOpenBalanceForUpdate(hash_t* hContext,
		const char* csMerchantID,
		const char* csCurrencyId,
		const char* csCountryId,
		const char* csServiceCode)
{
	int iRet = PD_OK;
	double dBal = 0.0;
	double dFloat = 0.0;
	double dHold = 0.0;
	double dBalSettlement = 0.0;
	double dFloatSettlement = 0.0;
	double dHoldSettlement = 0.0;
	double dFloatAfterPayout = 0.0;
	double dReservedAmount = 0.0;
	double dFundInPayout = 0.0;
	double dReservedPayout = 0.0;

                
        EXEC SQL WHENEVER SQLERROR GOTO getopenbalforupdate_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
                
		double		v_current_bal;
		double		v_total_float;
		double		v_total_hold;

		double		v_current_bal_settlement;
		double		v_total_float_settlement;
		double		v_total_hold_settlement;

		double		v_total_float_after_payout;
		double		v_total_reserved_amount;
		double		v_fundin_payout;
		double		v_reserved_payout;

		short		ind_current_bal= -1;
		short		ind_total_float= -1;
		short		ind_total_hold= -1;

		short		ind_current_bal_settlement= -1;
		short		ind_total_float_settlement= -1;
		short		ind_total_hold_settlement = -1;
        
		short		ind_total_float_after_payout = -1;
		short		ind_total_reserved_amount = -1;
		short 		ind_fundin_payout = -1;
		short 		ind_reserved_payout = -1;
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetOpenBalanceForUpdate merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetOpenBalanceForUpdate ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
        
        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetOpenBalanceForUpdate country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetOpenBalanceForUpdate service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));


        EXEC SQL DECLARE c_cursor_getopenbalforupdate CURSOR FOR
                select	m_current_bal,
			m_total_float,
                        m_total_hold,
                	m_current_bal_settlement,
			m_total_float_settlement,
                        m_total_hold_settlement,
			m_total_float_after_payout,
			m_total_reserved_amount,
			m_fundin_payout,
			m_reserved_payout
                  from merchant_balance
		 where m_merchant_id = :hv_merchant_id
		   and m_currency_id = :hv_ccy_id
		   and m_country_id = :hv_country_id
		   and m_service_code = :hv_service_code
		 for update;


        EXEC SQL OPEN c_cursor_getopenbalforupdate;
        do {
                EXEC SQL FETCH c_cursor_getopenbalforupdate
                INTO
			:v_current_bal:ind_current_bal,
			:v_total_float:ind_total_float,
			:v_total_hold:ind_total_hold,
			:v_current_bal_settlement:ind_current_bal_settlement,
			:v_total_float_settlement:ind_total_float_settlement,
			:v_total_hold_settlement:ind_total_hold_settlement,
			:v_total_float_after_payout:ind_total_float_after_payout,
			:v_total_reserved_amount:ind_total_reserved_amount,
			:v_fundin_payout:ind_fundin_payout,
			:v_reserved_payout:ind_reserved_payout;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                if(ind_current_bal<0) {
			v_current_bal = 0.0;
		}
                if(ind_total_float<0) {
			v_total_float= 0.0;
		}
                if(ind_total_hold<0) {
			v_total_hold= 0.0;
		}

                if(ind_current_bal_settlement<0) {
			v_current_bal_settlement = 0.0;
		}
                if(ind_total_float_settlement<0) {
			v_total_float_settlement= 0.0;
		}
                if(ind_total_hold_settlement<0) {
			v_total_hold_settlement= 0.0;
		}

		if(ind_total_float_after_payout<0) {
			v_total_float_after_payout= 0.0;
		}
		if(ind_total_reserved_amount <0) {
			v_total_reserved_amount= 0.0;
		}
		if(ind_fundin_payout <0) {
			v_fundin_payout = 0.0;
		}
		if(ind_reserved_payout <0) {
			v_reserved_payout = 0.0;
		}


		dBal = v_current_bal;
		dFloat = v_total_float;
		dHold = v_total_hold;

		dBalSettlement = v_current_bal_settlement;
		dFloatSettlement = v_total_float_settlement;
		dHoldSettlement = v_total_hold_settlement;

		dFloatAfterPayout = v_total_float_after_payout;
		dReservedAmount = v_total_reserved_amount;
		dFundInPayout = v_fundin_payout;
		dReservedPayout = v_reserved_payout;
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getopenbalforupdate;

DEBUGLOG(("GetOpenBalanceForUpdate open_bal = [%f]\n",dBal));
		PutField_Double(hContext,"merchant_open_bal",dBal);
DEBUGLOG(("GetOpenBalanceForUpdate total_float = [%f]\n",dFloat));
		PutField_Double(hContext,"total_float",dFloat);
DEBUGLOG(("GetOpenBalanceForUpdate total_hold = [%f]\n",dHold));
		PutField_Double(hContext,"total_hold",dHold);

DEBUGLOG(("GetOpenBalanceForUpdate open_bal_settlement = [%f]\n",dBalSettlement));
		PutField_Double(hContext,"merchant_open_bal_settlement",dBalSettlement);
DEBUGLOG(("GetOpenBalanceForUpdate total_float_settlement = [%f]\n",dFloatSettlement));
		PutField_Double(hContext,"total_float_settlement",dFloatSettlement);
DEBUGLOG(("GetOpenBalanceForUpdate total_hold_settlement = [%f]\n",dHoldSettlement));
		PutField_Double(hContext,"total_hold_settlement",dHoldSettlement);

DEBUGLOG(("GetOpenBalanceForUpdate total_float_after_payout = [%f]\n",dFloatAfterPayout));
		PutField_Double(hContext,"total_float_after_payout",dFloatAfterPayout);
DEBUGLOG(("GetOpenBalanceForUpdate total_reserved_amount = [%f]\n",dReservedAmount));
		PutField_Double(hContext,"reserved_amount",dReservedAmount);
DEBUGLOG(("GetOpenBalanceForUpdate fundin_payout = [%f]\n",dFundInPayout));
		PutField_Double(hContext,"fundin_payout",dFundInPayout);
DEBUGLOG(("GetOpenBalanceForUpdate reserved_payout = [%f]\n",dReservedPayout));
		PutField_Double(hContext,"reserved_payout",dReservedPayout);



DEBUGLOG(("GetOpenBalanceForUpdate Normal Exit\n"));
	return iRet;

getopenbalforupdate_error:
DEBUGLOG(("getopenbalforupdate_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getopenbalforupdate;
	TxnAbort();
        return PD_ERR;
}

int UpdateSettBal(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
                double  dAmt,
                double  dFee,
                char    cType,
                const char* csUser)
                
{

        EXEC SQL WHENEVER SQLERROR GOTO upd_sett_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                double          hv_amt;
                varchar         hv_user[PD_USER_LEN];

                short           ind_merchant_id = -1;
                short           ind_country_id = -1;
                short           ind_ccy_id = -1;
                short           ind_service_code = -1;
                short           ind_amt = -1;
                short           ind_user = -1;

                short           hv_return_value;
        EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateSettBal: Begin\n"));

	hv_merchant_id.len = strlen(csMerchantId);
        strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
        ind_merchant_id = 0;

        hv_country_id.len = strlen(csCountryId);
        strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
        ind_country_id = 0;

        hv_ccy_id.len = strlen(csCcy);
        strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
        ind_ccy_id = 0;

        hv_service_code.len = strlen(csServiceCode);
        strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
        ind_service_code = 0;

        if(cType==PD_IND_DEBIT){
        	hv_amt = (-1)*(dAmt + dFee);
        	ind_amt= 0;
	}
	else{
		hv_amt = dAmt - dFee;
        	ind_amt= 0;
	}
DEBUGLOG(("UpdateSettBal:amt = [%f]\n",dAmt));
DEBUGLOG(("UpdateSettBal:fee = [%f]\n",dFee));
DEBUGLOG(("UpdateSettBal:net_amt = [%f]\n",hv_amt));
DEBUGLOG(("UpdateSettBal:type => [%c]\n",cType));

        hv_user.len = strlen(csUser);
        strncpy((char *)hv_user.arr, csUser, hv_user.len);
        ind_user = 0;

                EXEC SQL EXECUTE
                   BEGIN

                        :hv_return_value := sp_merchant_bal_upd_sett_bal(
                                :hv_merchant_id:ind_merchant_id,
                                :hv_country_id:ind_country_id,
                                :hv_ccy_id:ind_ccy_id,
                                :hv_service_code:ind_service_code,
                                :hv_amt:ind_amt,
                                :hv_user:ind_user);

                   END;
                END-EXEC;

        if (hv_return_value == SP_OK)        {
DEBUGLOG(("UpdateSettBal:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::UpdateSettBal: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateSettBal: SP_OTHER_ERR TxnAbort\n"));
                TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::UpdateSettBal: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateSettBal: SP_ERR TxnAbort\n"));
                TxnAbort();
                return PD_ERR;
        }
upd_sett_error:
DEBUGLOG(("upd_sett_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        TxnAbort();
        return PD_ERR;
}


int UpdateAfterPayoutFloat(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
                double  dFloat,
		const char* csUser)

{
	EXEC SQL WHENEVER SQLERROR GOTO updateafterpo_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_float;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_float = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateAfterPayoutFloat: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("UpdateAfterPayoutFloat:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("UpdateAfterPayoutFloat:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("UpdateAfterPayoutFloat:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("UpdateAfterPayoutFloat:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_float= dFloat;
	ind_float= 0;
DEBUGLOG(("UpdateAfterPayoutFloat:float = [%f]\n",hv_float));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("UpdateAfterPayoutFloat:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_after_pofl(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_float:ind_float,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("UpdateAfterPayoutFloat:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdateAfterPayoutFloat:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::UpdateAfterPayoutFloat: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateAfterPayoutFloat: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::UpdateAfterPayoutFloat: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateAfterPayoutFloat: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

updateafterpo_error:
DEBUGLOG(("updateafterpo_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}

int SetFundInPayout(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
                double  dAmt,
		const char* csUser)

{
	EXEC SQL WHENEVER SQLERROR GOTO setfundinpo_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_amt;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_amt = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("SetFundInPayout: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("SetFundInPayout:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("SetFundInPayout:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("SetFundInPayout:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("SetFundInPayout:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_amt= dAmt;
	ind_amt= 0;
DEBUGLOG(("SetFundInPayout:amt = [%f]\n",hv_amt));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("SetFundInPayout:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_add_fin_po(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_amt:ind_amt,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("SetFundInPayout:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("SetFundInPayout:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::SetFundInPayout: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("SetFundInPayout: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::SetFundInPayout: SP_ERR TxnAbort\n");
DEBUGLOG(("SetFundInPayout: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

setfundinpo_error:
DEBUGLOG(("setfundinpo_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}

int UpdateFundInPayout(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
                double  dAmt,
		const char* csUser)

{
	EXEC SQL WHENEVER SQLERROR GOTO updatefundinpo_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_amt;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_amt = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateFundInPayout: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("UpdateFundInPayout:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("UpdateFundInPayout:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("UpdateFundInPayout:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("UpdateFundInPayout:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_amt= dAmt;
	ind_amt= 0;
DEBUGLOG(("UpdateFundInPayout:amt = [%f]\n",hv_amt));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("UpdateFundInPayout:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_upd_fin_po(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_amt:ind_amt,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("UpdateFundInPayout:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdateFundInPayout:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::UpdateFundInPayout: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateFundInPayout: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::UpdateFundInPayout: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateFundInPayout: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

updatefundinpo_error:
DEBUGLOG(("updatefundinpo_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}

int SetPayoutReserved(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
                double  dAmt,
		const char* csUser)

{
	EXEC SQL WHENEVER SQLERROR GOTO setpores_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_amt;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_amt = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("SetPayoutReserved: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("SetPayoutReserved:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("SetPayoutReserved:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("SetPayoutReserved:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("SetPayoutReserved:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_amt= dAmt;
	ind_amt= 0;
DEBUGLOG(("SetPayoutReserved:amt = [%f]\n",hv_amt));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("SetPayoutReserved:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_set_po_res(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_amt:ind_amt,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("SetPayoutReserved:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("SetPayoutReserved:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::SetPayoutReserved: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("SetPayoutReserved: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::SetPayoutReserved: SP_ERR TxnAbort\n");
DEBUGLOG(("SetPayoutReserved: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

setpores_error:
DEBUGLOG(("setpores_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}


int UpdatePayoutReserved(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
                double  dAmt,
		const char* csUser)

{
	EXEC SQL WHENEVER SQLERROR GOTO updpores_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_amt;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_amt = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdatePayoutReserved: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("UpdatePayoutReserved:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("UpdatePayoutReserved:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("UpdatePayoutReserved:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("UpdatePayoutReserved:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_amt= dAmt;
	ind_amt= 0;
DEBUGLOG(("UpdatePayoutReserved:amt = [%f]\n",hv_amt));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("UpdatePayoutReserved:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_upd_po_res(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_amt:ind_amt,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("UpdatePayoutReserved:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdatePayoutReserved:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::UpdatePayoutReserved: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdatePayoutReserved: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::UpdatePayoutReserved: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdatePayoutReserved: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

updpores_error:
DEBUGLOG(("updpores_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}


int ReleaseReserve(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
		const char* csServiceCode,
                double  dBal,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO releaseres_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_bal;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_bal = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("ReleaseReserve: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("ReleaseReserve:merchant id = [%.*s][%d]\n",hv_merchant_id.len,hv_merchant_id.arr,hv_merchant_id.len));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("ReleaseReserve:country_id = [%.*s][%d]\n",hv_country_id.len,hv_country_id.arr,hv_country_id.len));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("ReleaseReserve:ccy_id = [%.*s][%d]\n",hv_ccy_id.len,hv_ccy_id.arr,hv_ccy_id.len));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("ReleaseReserve:service_code = [%.*s][%d]\n",hv_service_code.len,hv_service_code.arr,hv_service_code.len));

	hv_bal= dBal;
	ind_bal= 0;
DEBUGLOG(("ReleaseReserve:aval bal = [%f]\n",hv_bal));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("ReleaseReserve:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_release_res(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_bal:ind_bal,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("ReleaseReserve:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("ReleaseReserve:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::ReleaseReserve: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("ReleaseReserve: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::ReleaseReserve: SP_ERR TxnAbort\n");
DEBUGLOG(("ReleaseFloat: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

releaseres_error:
DEBUGLOG(("releaseres_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}

int UpdateAdjBal(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
                double  dNetAmt,
                char    cType,
                const char* csUser)
                
{

        EXEC SQL WHENEVER SQLERROR GOTO upd_adj_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                double          hv_amt;
                varchar         hv_user[PD_USER_LEN];

                short           ind_merchant_id = -1;
                short           ind_country_id = -1;
                short           ind_ccy_id = -1;
                short           ind_service_code = -1;
                short           ind_amt = -1;
                short           ind_user = -1;

                short           hv_return_value;
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("UpdateAdjBal: Begin\n"));

	hv_merchant_id.len = strlen(csMerchantId);
        strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
        ind_merchant_id = 0;

        hv_country_id.len = strlen(csCountryId);
        strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
        ind_country_id = 0;

        hv_ccy_id.len = strlen(csCcy);
        strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
        ind_ccy_id = 0;

        hv_service_code.len = strlen(csServiceCode);
        strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
        ind_service_code = 0;

        if(cType==PD_IND_DEBIT){
        	hv_amt = (-1)*dNetAmt;
        	ind_amt= 0;
	}
	else{
		hv_amt = dNetAmt;
        	ind_amt= 0;
	}
DEBUGLOG(("UpdateAdjBal:Netamt = [%f]\n",dNetAmt));
DEBUGLOG(("UpdateAdjBal:net_amt = [%f]\n",hv_amt));
DEBUGLOG(("UpdateAdjBal:type => [%c]\n",cType));

        hv_user.len = strlen(csUser);
        strncpy((char *)hv_user.arr, csUser, hv_user.len);
        ind_user = 0;

//DEBUGLOG(("UpdateAdjBal:TESTIING\n"));

                EXEC SQL EXECUTE
                   BEGIN

                        :hv_return_value := sp_merchant_bal_upd_adj_bal(
                                :hv_merchant_id:ind_merchant_id,
                                :hv_country_id:ind_country_id,
                                :hv_ccy_id:ind_ccy_id,
                                :hv_service_code:ind_service_code,
                                :hv_amt:ind_amt,
                                :hv_user:ind_user);

                   END;
                END-EXEC;

        if (hv_return_value == SP_OK)        {
DEBUGLOG(("UpdateAdjBal:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::UpdateAdjBal: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateAdjBal: SP_OTHER_ERR TxnAbort\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::UpdateAdjBal: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateAdjBal: SP_ERR TxnAbort\n"));
                return PD_ERR;
        }
upd_adj_error:
DEBUGLOG(("upd_sett_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}


int UpdateAfterPOFloat(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
		const char* csServiceCode,
                double  dAmt,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO updateafterpofloat_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_amt;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_amt = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateAfterPOFloat: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("UpdateAfterPOFloat:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("UpdateAfterPOFloat:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("UpdateAfterPOFloat:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("UpdateAfterPOFloat:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_amt= dAmt;
	ind_amt= 0;
DEBUGLOG(("UpdatAfterPOFloat:amt = [%f]\n",hv_amt));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("UpdateAfterPOFloat:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_insert_af(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_amt:ind_amt,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("UpdateAfterPOFloat:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdateAfterPOFloat:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::UpdateAfterPOFloat: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateAfterPOFloat: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::UpdateAfterPOFloat: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateFloat: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

updateafterpofloat_error:
DEBUGLOG(("updateafterpofloat_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}

int GetCurrentValuesForUpdate(const char* csMerchantID,
			const char* csCurrencyId, 
			const char* csCountryId,
			const char* csServiceCode,
			hash_t *hVal)
{
	int iRet = PD_OK;
                
        EXEC SQL WHENEVER SQLERROR GOTO getcurrval_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar         hv_country_id[PD_COUNTRY_LEN];
		varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                
		double		v_total_float;
		double		v_current_bal;
		double		v_total_reserved_amount;
		double		v_total_hold;

		double		v_total_float_settlement;
		double		v_current_bal_settlement;
		double		v_total_hold_settlement;

		double		v_fundin_payout;
		double		v_reserved_payout;
		double		v_total_float_after_payout;

		short		ind_total_float = -1;
		short		ind_current_bal= -1;
		short		ind_total_reserved_amount= -1;
		short		ind_total_hold= -1;

		short		ind_total_float_settlement = -1;
		short		ind_current_bal_settlement= -1;
		short		ind_total_hold_settlement= -1;

		short		ind_total_float_after_payout = -1;
		short		ind_fundin_payout = -1;
		short		ind_reserved_payout = -1;
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetCurrentValuesForUpdate merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetCurrentValuesForUpdate ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
        
        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetCurrentValuesForUpdate country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetCurrentValuesForUpdate service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
        
        EXEC SQL DECLARE c_cursor_getcurrvalforupdate CURSOR FOR
                select 	m_total_float,
			m_current_bal,
			m_total_reserved_amount,
			m_total_hold,
			m_total_float_settlement,
			m_current_bal_settlement,
			m_total_hold_settlement,
			m_total_float_after_payout,
			m_fundin_payout,
                        m_reserved_payout
                  from 	merchant_balance
		 where 	m_merchant_id = :hv_merchant_id
		   and 	m_currency_id = :hv_ccy_id
		   and	m_country_id = :hv_country_id
		   and	m_service_code = :hv_service_code
		   for update;

        EXEC SQL OPEN c_cursor_getcurrvalforupdate;
        do {
                EXEC SQL FETCH c_cursor_getcurrvalforupdate
                INTO
			:v_total_float:ind_total_float,
			:v_current_bal:ind_current_bal,
			:v_total_reserved_amount:ind_total_reserved_amount,
			:v_total_hold:ind_total_hold,
			:v_total_float_settlement:ind_total_float_settlement,
			:v_current_bal_settlement:ind_current_bal_settlement,
			:v_total_hold_settlement:ind_total_hold_settlement,
			:v_total_float_after_payout:ind_total_float_after_payout,
			:v_fundin_payout:ind_fundin_payout,
			:v_reserved_payout:ind_reserved_payout;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

//total_float 
                if(ind_total_float<0)
			v_total_float = 0.0;
		PutField_Double(hVal,"total_float",v_total_float);
DEBUGLOG(("GetCurrentValuesForUpdate float = [%f]\n",v_total_float));
		
//current_bal
                if(ind_current_bal<0)
			v_current_bal = 0.0;
		PutField_Double(hVal,"current_bal",v_current_bal);
DEBUGLOG(("GetCurrentValuesForUpdate current_bal = [%f]\n",v_current_bal));


//total_reserved_amount
                if(ind_total_reserved_amount<0)
			v_total_reserved_amount= 0.0;
		PutField_Double(hVal,"total_reserved_amount",v_total_reserved_amount);
DEBUGLOG(("GetCurrentValuesForUpdate total_reserved_amount = [%f]\n",v_total_reserved_amount));

//total_hold
                if(ind_total_hold<0)
			v_total_hold= 0;
		PutField_Double(hVal,"total_hold",v_total_hold);
DEBUGLOG(("GetCurrentValuesForUpdate total_hold = [%f]\n",v_total_hold));


//total_float_settlement 
                if(ind_total_float_settlement<0)
			v_total_float_settlement = 0.0;
		PutField_Double(hVal,"total_float_settlement",v_total_float_settlement);
DEBUGLOG(("GetCurrentValuesForUpdate float_settlement = [%f]\n",v_total_float_settlement));

//current_bal_settlement
                if(ind_current_bal_settlement<0)
			v_current_bal_settlement = 0.0;
		PutField_Double(hVal,"current_bal_settlement",v_current_bal_settlement);
DEBUGLOG(("GetCurrentValuesForUpdate current_bal_settlement = [%f]\n",v_current_bal_settlement));

//total_hold_settlement
                if(ind_total_hold_settlement<0)
			v_total_hold_settlement= 0;
		PutField_Double(hVal,"total_hold_settlement",v_total_hold_settlement);
DEBUGLOG(("GetCurrentValuesForUpdate total_hold_settlement = [%f]\n",v_total_hold_settlement));

//total_float_after_payout 
                if(ind_total_float_after_payout<0)
			v_total_float_after_payout = 0.0;
		PutField_Double(hVal,"total_float_after_payout",v_total_float_after_payout);
DEBUGLOG(("GetCurrentValuesForUpdate float_after_payout = [%f]\n",v_total_float_after_payout));
		
//fundin payout
                if(ind_fundin_payout<0)
			v_fundin_payout= 0;
		PutField_Double(hVal,"fundin_payout",v_fundin_payout);
DEBUGLOG(("GetCurrentValuesForUpdate fundin_payout = [%f]\n",v_fundin_payout));

//reserved payout
                if(ind_reserved_payout<0)
			v_reserved_payout= 0;
		PutField_Double(hVal,"reserved_payout",v_reserved_payout);
DEBUGLOG(("GetCurrentValuesForUpdate reserved_payout = [%f]\n",v_reserved_payout));

        }

        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getcurrvalforupdate;

DEBUGLOG(("GetCurrentValuesForUpdate Normal Exit\n"));
	return iRet;

getcurrval_error:
DEBUGLOG(("getcurrvalforupdate_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getcurrvalforupdate;
        return PD_ERR;
}

int UpdateReservedPO(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
		const char* csServiceCode,
                double  dAmt,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO updatereservedpo_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_amt;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_amt = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateReservedPO: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("UpdateReservedPO:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("UpdateReservedPO:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("UpdateReservedPO:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("UpdateReservedPO:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_amt= dAmt;
	ind_amt= 0;
DEBUGLOG(("UpdateReservedPO:amt = [%f]\n",hv_amt));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("UpdateReservedPO:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_set_po_res(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_amt:ind_amt,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("UpdateReservedPO:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdateReservedPO:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::UpdateReservedPO: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateReservedPO: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::UpdateReservedPO: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateReservedPO: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

updatereservedpo_error:
DEBUGLOG(("updatereservedpo_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}

int RlsFloat2AfterPOFloat(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
		const char* csServiceCode,
                double  dAmt,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO updatebothfloat_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_amt;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_amt = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("RlsFloat2AfterPOFloat: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("RlsFloat2AfterPOFloat:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("RlsFloat2AfterPOFloat:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("RlsFloat2AfterPOFloat:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("RlsFloat2AfterPOFloat:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_amt= dAmt;
	ind_amt= 0;
DEBUGLOG(("RlsFloat2AfterPOFloat:amt = [%f]\n",hv_amt));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("RlsFloat2AfterPOFloat:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_FT_2_AF(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_amt:ind_amt,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("RlsFloat2AfterPOFloat:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("RlsFloat2AfterPOFloat:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::RlsFloat2AfterPOFloat: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("RlsFloat2AfterPOFloat: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::RlsFloat2AfterPOFloat: SP_ERR TxnAbort\n");
DEBUGLOG(("RlsFloat2AfterPOFloat: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

updatebothfloat_error:
DEBUGLOG(("updatebothfloat_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}

int RlsAfterPOFloat2SettlementFloat(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
		const char* csServiceCode,
                double  dAmt,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO updatesettlefloat_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_amt;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_amt = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("RlsAfterPOFloat2SettlementFloat: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("RlsAfterPOFloat2SettlementFloat:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("RlsAfterPOFloat2SettlementFloat:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("RlsAfterPOFloat2SettlementFloat:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("RlsAfterPOFloat2SettlementFloat:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_amt= dAmt;
	ind_amt= 0;
DEBUGLOG(("RlsAfterPOFloat2SettlementFloat:amt = [%f]\n",hv_amt));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("RlsAfterPOFloat2SettlementFloat:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_AF_2_SFL(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_amt:ind_amt,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("RlsAfterPOFloat2SettlementFloat:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("RlsAfterPOFloat2SettlementFloat:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::RlsAfterPOFloat2SettlementFloat: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("RlsAfterPOFloat2SettlementFloat: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::RlsAfterPOFloat2SettlementFloat: SP_ERR TxnAbort\n");
DEBUGLOG(("RlsAfterPOFloat2SettlementFloat: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

updatesettlefloat_error:
DEBUGLOG(("updatesettlefloat_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}

int TransferAvaPayout(const char* csMerchantId,
			const char* csCountryId,
			const char* csCcy,
			const char* csServiceCode,
			double  dFundin,
			double  dResvPO,	
			double	dNetAmt,
			const char* csUser)

{
	EXEC SQL WHENEVER SQLERROR GOTO transferavapayout_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		double		hv_fundin;
		double		hv_resvpo;
		double		hv_net_amt;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_fundin = -1;
		short		ind_resvpo = -1;
		short		ind_net_amt = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("TransferAvaPayout: Begin\n"));

	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("TransferAvaPayout:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("TransferAvaPayout:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("TransferAvaPayout:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("TransferAvaPayout:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_fundin = dFundin;
	ind_fundin = 0;
DEBUGLOG(("TransferAvaPayout:fundin = [%f]\n",hv_fundin));

	hv_resvpo = dResvPO;
	ind_resvpo = 0;
DEBUGLOG(("TransferAvaPayout:resv_po = [%f]\n",hv_resvpo));

	hv_net_amt= dNetAmt;
	ind_net_amt= 0;
DEBUGLOG(("TransferAvaPayout:net_amt = [%f]\n",hv_net_amt));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("TransferAvaPayout:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_bal_tr_ava_po(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_fundin:ind_fundin,
				:hv_resvpo:ind_resvpo,
				:hv_net_amt:ind_net_amt,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("TransferAvaPayout:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("TransferAvaPayout:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::TransferAvaPayout: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("TransferAvaPayout: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::TransferAvaPayout: SP_ERR TxnAbort\n");
DEBUGLOG(("TransferAvaPayout: SP_ERR TxnAbort\n"));
		//TxnAbort();
		return PD_ERR;
	}

transferavapayout_error:
DEBUGLOG(("transferavapayout_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}

int GetSettAvalBalanceInq(const char* csMerchantID,
			const char* csCurrencyId,
			const char* csCountryId,
			const char* csServiceCode,
			double	*dBal)
{
	*dBal = 0.0;
	int iRet = PD_OK;
                
        EXEC SQL WHENEVER SQLERROR GOTO getsettavalbalinq_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
                
		double		v_current_bal;
		double		v_current_bal_sett;
		double		v_total_float_sett;
		double		v_total_hold_sett;
		double		v_total_reserved_sett;

		short		ind_current_bal= -1;
		short		ind_current_bal_sett= -1;
		short		ind_total_float_sett= -1;
		short		ind_total_hold_sett= -1;
		short		ind_total_reserved_sett= -1;
        
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetSettAvalBalanceInq merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_ccy_id.len = strlen(csCurrencyId);
        memcpy(hv_ccy_id.arr,csCurrencyId,hv_ccy_id.len);
DEBUGLOG(("GetSettAvalBalanceInq ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
        
        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetSettAvalBalanceInq country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetSettAvalBalanceInq service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        EXEC SQL DECLARE c_cursor_getsettavalbalinq CURSOR FOR
                select	m_current_bal_settlement,
			m_total_float_settlement,
			m_total_hold_settlement,
			m_total_reserved_amount,
			m_current_bal
                  from merchant_balance
		 where m_merchant_id = :hv_merchant_id
		   and m_currency_id = :hv_ccy_id
		   and m_country_id = :hv_country_id
		   and m_service_code = :hv_service_code;

        EXEC SQL OPEN c_cursor_getsettavalbalinq;
        do {
                EXEC SQL FETCH c_cursor_getsettavalbalinq
                INTO
			:v_current_bal_sett:ind_current_bal_sett,
			:v_total_float_sett:ind_total_float_sett,
			:v_total_hold_sett:ind_total_hold_sett,
			:v_total_reserved_sett:ind_total_reserved_sett,
			:v_current_bal:ind_current_bal;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

// balance
                if(ind_current_bal_sett<0)
			v_current_bal_sett = 0.0;
                if(ind_total_float_sett<0)
			v_total_float_sett= 0.0;
                if(ind_total_hold_sett<0)
			v_total_hold_sett= 0.0;
                if(ind_total_reserved_sett<0)
			v_total_reserved_sett= 0.0;
                if(ind_current_bal<0)
			v_current_bal= 0.0;

		*dBal=v_current_bal_sett-v_total_float_sett-v_total_hold_sett-v_total_reserved_sett;
DEBUGLOG(("GetSettAvalBalanceInq balance = [%f]\n",*dBal));


        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getsettavalbalinq;

DEBUGLOG(("GetSettAvalBalanceInq Normal Exit\n"));
	return iRet;

getsettavalbalinq_error:
DEBUGLOG(("getsettavalbalinq_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getsettavalbalinq;
	TxnAbort();
        return PD_ERR;
}

int UpdateLastSettlementDate(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
		const char* csServiceCode,
		const char* csDate,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO updatesettdate_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		varchar 	hv_date[PD_DATE_LEN];
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_date = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateLastSettlementDate: Begin\n"));

	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char *)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("UpdateLastSettlementDate:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char *)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("UpdateLastSettlementDate:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char *)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("UpdateLastSettlementDate:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy((char *)hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("UpdateLastSettlementDate:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_date.len = strlen(csDate);
	strncpy((char *)hv_date.arr,csDate , hv_date.len);
	ind_date= 0;
DEBUGLOG(("UpdateLastSettlementDate:date = [%.*s]\n",hv_date.len,hv_date.arr));

	hv_create_user.len = strlen(csUser);
	strncpy((char *)hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("UpdateLastSettlementDate:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_balance_sett_date(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_date:ind_date,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("UpdateLastSettlementDate:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdateLastSettlementDate:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBlance::UpdateLastSettlementDate: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateLastSettlementDate: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBlance::UpdateLastSettlementDate: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateLastSettlementDate: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

updatesettdate_error:
DEBUGLOG(("updatesettdate_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}
