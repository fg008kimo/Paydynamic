/*
Partnerdelight (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/08/13              Cody Chan
Add Unique Amount Checking			   2013/10/10		   LokMan Chow
Add deposit ref in MatchStmt                       2014/03/20              David Wong
Add multi_match_ind                                2014/04/10              David Wong
Get deposit_Bank_code for API Method 3             2014/09/02              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLTransaction.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;
void OLTransaction(char    cdebug)
{
        cDebug = cdebug;
}

int Add(const hash_t *hRls)
{
        char		*csTmp;
        char        	cTmp;
	int		iCommit = PD_TRUE;
	int		iTmp;
	double		dTmp;


        EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short 		hv_return_value;

	varchar		hv_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_org_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_channel_code[PD_CHANNEL_CODE_LEN];
	char		hv_status;
	char		hv_ar_ind;
	varchar		hv_sub_status[PD_SUB_STATUS_LEN];
	varchar		hv_txn_code[PD_TXN_CODE_LEN];
	varchar		hv_process_type[PD_PROCESS_TYPE_LEN];
	varchar		hv_process_code[PD_PROCESS_CODE_LEN];
	varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
	varchar		hv_merchant_ref[PD_MERCHANT_REF_LEN];
	varchar		hv_client_id[PD_CLIENT_ID_LEN];
	varchar		hv_host_posting_date[PD_DATE_LEN];
	varchar		hv_transmission_datetime[PD_DATE_LEN + PD_TIME_LEN];
	int		hv_internal_code;
	varchar		hv_response_code[PD_RESPONSE_CODE_LEN];
	double		hv_transaction_amt;
	double		hv_deposit_amt;
	double		hv_display_amt;
	double		hv_net_amt;
	varchar		hv_filename[PD_UPLOAD_FILENAME_LEN];
	varchar		hv_tm_date[PD_DATE_LEN];
	varchar		hv_tm_time[PD_TIME_LEN];
	varchar		hv_local_tm_date[PD_DATE_LEN];
	varchar		hv_local_tm_time[PD_TIME_LEN];
	varchar		hv_add_user[PD_USER_LEN];
	varchar		hv_client_ip[PD_IP_LEN];
	varchar		hv_service_code[PD_SERVICE_CODE_LEN];
	varchar		hv_approval_date[PD_DATE_LEN];
	char		hv_upd_match_ts;
	int		hv_upload_channel;
	int		hv_multi_match_ind;


	short		ind_txn_id = -1;
	short		ind_org_txn_id = -1;
	short		ind_channel_code = -1;
	short		ind_status = -1;
	short		ind_ar_ind = -1;
	short		ind_sub_status = -1;
	short		ind_txn_code = -1;
	short		ind_process_type = -1;
	short		ind_process_code = -1;
	short		ind_merchant_id = -1;
	short		ind_merchant_ref = -1;
	short		ind_client_id = -1;
	short		ind_host_posting_date = -1;
	short		ind_transmission_datetime = -1;
	short		ind_internal_code = -1;
	short		ind_response_code = -1;
	short		ind_transaction_amt = -1;
	short		ind_deposit_amt = -1;
	short		ind_display_amt = -1;
	short		ind_net_amt = -1;
	short		ind_filename = -1;
	short		ind_tm_date = -1;
	short		ind_tm_time = -1;
	short		ind_local_tm_date = -1;
	short		ind_local_tm_time = -1;
	short		ind_add_user = -1;
	short		ind_client_ip= -1;
	short		ind_service_code = -1;
	short		ind_approval_date = -1;
	short		ind_upd_match_ts = -1;
	short		ind_upload_channel = -1;
	short		ind_multi_match_ind = -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));

        if (GetField_Int(hRls,"db_commit",&iCommit)) {
DEBUGLOG(("Add:db_commit = [%d]\n",iCommit));
	}

/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("Add:txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
        }
/* org txn_seq */
        if (GetField_CString(hRls,"org_txn_seq",&csTmp)) {
                hv_org_txn_id.len = strlen(csTmp);
                memcpy(hv_org_txn_id.arr,csTmp,hv_org_txn_id.len);
                ind_org_txn_id = 0;
DEBUGLOG(("Add:org_txn_id = [%.*s]\n",hv_org_txn_id.len,hv_org_txn_id.arr));
        }
/* Channel code */
        if (GetField_CString(hRls,"channel_code",&csTmp)) {
                hv_channel_code.len = strlen(csTmp);
                memcpy(hv_channel_code.arr,csTmp,hv_channel_code.len);
                ind_channel_code = 0;
DEBUGLOG(("Add:channel_code = [%.*s]\n",hv_channel_code.len,hv_channel_code.arr));
        }


/* Status */ 
        if (GetField_Char(hRls,"status",&cTmp)) {
		hv_status = cTmp;
                ind_status = 0;
DEBUGLOG(("Add:status = [%c]\n",hv_status));
        }

/* ar ind */ 
        if (GetField_Char(hRls,"ar_ind",&cTmp)) {
		hv_ar_ind = cTmp;
                ind_ar_ind = 0;
DEBUGLOG(("Add:ar_ind = [%c]\n",hv_ar_ind));
        }

/* Sub Status */ 
        if (GetField_CString(hRls,"sub_status",&csTmp)) {
                hv_sub_status.len = strlen(csTmp);
                memcpy(hv_sub_status.arr,csTmp,hv_sub_status.len);
                ind_sub_status = 0;
DEBUGLOG(("Add:sub_status = [%.*s]\n",hv_sub_status.len,hv_sub_status.arr));
        }

/* Txn Code */
        if (GetField_CString(hRls,"txn_code",&csTmp)) {
                hv_txn_code.len = strlen(csTmp);
                memcpy(hv_txn_code.arr,csTmp,hv_txn_code.len);
                ind_txn_code = 0;
DEBUGLOG(("Add:txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));
        }

/* process type */
        if (GetField_CString(hRls,"process_type",&csTmp)) {
                hv_process_type.len = strlen(csTmp);
                memcpy(hv_process_type.arr,csTmp,hv_process_type.len);
                ind_process_type = 0;
DEBUGLOG(("Add:process_type = [%.*s]\n",hv_process_type.len,hv_process_type.arr));
        }

/* process code */
        if (GetField_CString(hRls,"process_code",&csTmp)) {
                hv_process_code.len = strlen(csTmp);
                memcpy(hv_process_code.arr,csTmp,hv_process_code.len);
                ind_process_code = 0;
DEBUGLOG(("Add:process_code = [%.*s]\n",hv_process_code.len,hv_process_code.arr));
        }

/* Merchant No */
        if (GetField_CString(hRls,"merchant_id",&csTmp)) {
                hv_merchant_id.len = strlen(csTmp);
                memcpy(hv_merchant_id.arr,csTmp,hv_merchant_id.len);
                ind_merchant_id = 0;
DEBUGLOG(("Add:merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        }

/* Merchant ref */
        if (GetField_CString(hRls,"merchant_ref",&csTmp)) {
                hv_merchant_ref.len = strlen(csTmp);
                memcpy(hv_merchant_ref.arr,csTmp,hv_merchant_ref.len);
                ind_merchant_ref = 0;
DEBUGLOG(("Add:merchant_ref = [%.*s]\n",hv_merchant_ref.len,hv_merchant_ref.arr));
        }



/* Client ID */
        if (GetField_CString(hRls,"client_id",&csTmp)) {
                hv_client_id.len = strlen(csTmp);
                memcpy(hv_client_id.arr,csTmp,hv_client_id.len);
                ind_client_id = 0;
DEBUGLOG(("Add:client_id = [%.*s]\n",hv_client_id.len,hv_client_id.arr));
        }
/* host posting date */
        if (GetField_CString(hRls,"host_posting_date",&csTmp)) {
                hv_host_posting_date.len = strlen(csTmp);
                memcpy(hv_host_posting_date.arr,csTmp,hv_host_posting_date.len);
                ind_host_posting_date = 0;
DEBUGLOG(("Add:host_posting_date = [%.*s]\n",hv_host_posting_date.len,hv_host_posting_date.arr));
        }



/* internal code */
        if (GetField_Int(hRls,"internal_code",&iTmp)) {
		hv_internal_code = iTmp;
                ind_internal_code = 0;
DEBUGLOG(("Add:internal_code = [%d]\n",hv_internal_code));
        }

/* response code  */
        if (GetField_CString(hRls,"response_code",&csTmp)) {
                hv_response_code.len = strlen(csTmp);
                memcpy(hv_response_code.arr,csTmp,hv_response_code.len);
                ind_response_code = 0;
DEBUGLOG(("Add:response_code = [%.*s]\n",hv_response_code.len,hv_response_code.arr));
        }

/* transaction amt   */
        if (GetField_Double(hRls,"txn_amt",&dTmp)) {
		hv_transaction_amt = dTmp;
                ind_transaction_amt = 0;
DEBUGLOG(("Add:txn_amt = [%f]\n",hv_transaction_amt));
        }

/* deposit amt   */
        if (GetField_Double(hRls,"deposit_amt",&dTmp)) {
		hv_deposit_amt = dTmp;
                ind_deposit_amt = 0;
DEBUGLOG(("Add:deposit_amt = [%f]\n",hv_deposit_amt));
        }

/* display amt   */
        if (GetField_Double(hRls,"display_amt",&dTmp)) {
		hv_display_amt = dTmp;
                ind_display_amt = 0;
DEBUGLOG(("Add:display_amt = [%f]\n",hv_display_amt));
        }

/* net amt   */
        if (GetField_Double(hRls,"net_amt",&dTmp)) {
		hv_net_amt = dTmp;
                ind_net_amt = 0;
DEBUGLOG(("Add:net_amt = [%f]\n",hv_net_amt));
        }

/* filename */
        if (GetField_CString(hRls,"filename",&csTmp)) {
                hv_filename.len = strlen(csTmp);
                memcpy(hv_filename.arr,csTmp,hv_filename.len);
                ind_filename = 0;
DEBUGLOG(("Add:filename = [%.*s]\n",hv_filename.len,hv_filename.arr));
        }


/* transmission_datetime */
        if (GetField_CString(hRls,"transmission_datetime",&csTmp)) {
                hv_transmission_datetime.len = strlen(csTmp);
                memcpy(hv_transmission_datetime.arr,csTmp,hv_transmission_datetime.len);
                ind_transmission_datetime = 0;
DEBUGLOG(("Add:transmission_datetime = [%.*s]\n",hv_transmission_datetime.len,hv_transmission_datetime.arr));
        }

/* tm date */
        if (GetField_CString(hRls,"tm_date",&csTmp)) {
                hv_tm_date.len = strlen(csTmp);
                memcpy(hv_tm_date.arr,csTmp,hv_tm_date.len);
                ind_tm_date = 0;
DEBUGLOG(("Add:tm_date = [%.*s]\n",hv_tm_date.len,hv_tm_date.arr));
        }

/* tm time */
        if (GetField_CString(hRls,"tm_time",&csTmp)) {
                hv_tm_time.len = strlen(csTmp);
                memcpy(hv_tm_time.arr,csTmp,hv_tm_time.len);
                ind_tm_time = 0;
DEBUGLOG(("Add:tm_time = [%.*s]\n",hv_tm_time.len,hv_tm_time.arr));
        }

/* local tm date */
        if (GetField_CString(hRls,"local_tm_date",&csTmp)) {
                hv_local_tm_date.len = strlen(csTmp);
                memcpy(hv_local_tm_date.arr,csTmp,hv_local_tm_date.len);
                ind_local_tm_date = 0;
DEBUGLOG(("Add:local_tm_date = [%.*s]\n",hv_local_tm_date.len,hv_local_tm_date.arr));
        }

/* local tm time */
        if (GetField_CString(hRls,"local_tm_time",&csTmp)) {
                hv_local_tm_time.len = strlen(csTmp);
                memcpy(hv_local_tm_time.arr,csTmp,hv_local_tm_time.len);
                ind_local_tm_time = 0;
DEBUGLOG(("Add:local_tm_time = [%.*s]\n",hv_local_tm_time.len,hv_local_tm_time.arr));
        }



/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen(csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("Add:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }


/* client ip */
        if (GetField_CString(hRls,"ip_addr",&csTmp)) {
		char *p;
		char    csTmpIP[PD_IP_LEN+1];
                p = strtok (csTmp,",");
                while (p != NULL)
                {
                        strcpy(csTmpIP,p);
                        csTmpIP[strlen(p)]='\0';
			break;
                }
                hv_client_ip.len = strlen(csTmpIP);
                memcpy(hv_client_ip.arr,csTmpIP,hv_client_ip.len);
                ind_client_ip = 0;
DEBUGLOG(("Add:client_ip = [%.*s]\n",hv_client_ip.len,hv_client_ip.arr));
        }

/* service_code */
        if (GetField_CString(hRls,"service_code",&csTmp)) {
                hv_service_code.len = strlen(csTmp);
                memcpy(hv_service_code.arr,csTmp,hv_service_code.len);
                ind_service_code = 0;
DEBUGLOG(("Add:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
        }

/* approval_date */
        if (GetField_CString(hRls,"approval_date",&csTmp)) {
                hv_approval_date.len = strlen(csTmp);
                memcpy(hv_approval_date.arr,csTmp,hv_approval_date.len);
                ind_approval_date = 0;
DEBUGLOG(("Add:approval_date = [%.*s]\n",hv_approval_date.len,hv_approval_date.arr));
        }

/* upd_match_ts */ 
		if (GetField_Char(hRls, "upd_match_ts", &cTmp)) {
			hv_upd_match_ts = cTmp;
			ind_upd_match_ts = 0;
DEBUGLOG(("Add: upd_match_ts = [%c]\n", hv_upd_match_ts));
		}


/* upload_channel */
        if (GetField_Int(hRls,"upload_channel",&iTmp)) {
		hv_upload_channel = iTmp;
                ind_upload_channel = 0;
DEBUGLOG(("Add:upload_channel = [%d]\n",hv_upload_channel));
        }

/* multi_match_ind */
        if (GetField_Int(hRls,"multi_match_ind",&iTmp)) {
		hv_multi_match_ind = iTmp;
                ind_multi_match_ind = 0;
DEBUGLOG(("Add:multi_match_ind = [%d]\n",hv_multi_match_ind));
        }

	EXEC SQL EXECUTE
                BEGIN
			:hv_return_value := sp_ol_txn_header_insert(
					:hv_txn_id:ind_txn_id,
					:hv_org_txn_id:ind_org_txn_id,
					:hv_channel_code:ind_channel_code,
					:hv_status:ind_status,
					:hv_ar_ind:ind_ar_ind,
					:hv_sub_status:ind_sub_status,
					:hv_txn_code:ind_txn_code,
					:hv_process_type:ind_process_type,
					:hv_process_code:ind_process_code,
					:hv_merchant_id:ind_merchant_id,
					:hv_merchant_ref:ind_merchant_ref,
					:hv_client_id:ind_client_id,
					:hv_host_posting_date:ind_host_posting_date,
					:hv_transmission_datetime:ind_transmission_datetime,
					:hv_internal_code:ind_internal_code,
					:hv_response_code:ind_response_code,
					:hv_transaction_amt:ind_transaction_amt,
					:hv_deposit_amt:ind_deposit_amt,
					:hv_display_amt:ind_display_amt,
					:hv_net_amt:ind_net_amt,
					:hv_filename:ind_filename,
					:hv_tm_date:ind_tm_date,
					:hv_tm_time:ind_tm_time,
					:hv_local_tm_date:ind_local_tm_date,
					:hv_local_tm_time:ind_local_tm_time,
					:hv_add_user:ind_add_user,
					:hv_add_user:ind_add_user,
					:hv_client_ip:ind_client_ip,
					:hv_service_code:ind_service_code,
					:hv_approval_date:ind_approval_date,
					:hv_upd_match_ts:ind_upd_match_ts,
					:hv_upload_channel:ind_upload_channel,
					:hv_multi_match_ind:ind_multi_match_ind);
	        END;
        END-EXEC;

// update txn sub status
        AddTxnStatusLog(hRls);
// update txn browser info  
        AddTxnBrowserInfo(hRls);


DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("Add:Normal Exit\n"));
		if (iCommit == PD_TRUE)
			TxnCommit();
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("Transaction_Add: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("Transaction_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		TxnAbort();
                return PD_ERR;
        }

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("OLTransaction_Add: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR TxnAbort\n"));
	TxnAbort();
        return PD_INTERNAL_ERR;
}

int Update(const hash_t *hRls)
{

	char*	csTmp;
	char	cTmp;
	double	dTmp;
	int	iTmp;
	char*	csBuf;
	char*	csTxnId;
        EXEC SQL WHENEVER SQLERROR GOTO update_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

	varchar 	hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr,"update ol_txn_header set oth_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"txn_seq",&csTxnId);
DEBUGLOG(("Update:txn_id = [%s]\n",csTxnId));

/* org txn_seq */
        if (GetField_CString(hRls,"org_txn_seq",&csTmp)) {
DEBUGLOG(("Update:org_txn_id = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_org_txn_id = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* Channel code */
        if (GetField_CString(hRls,"channel_code",&csTmp)) {
DEBUGLOG(("Update:channel_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_input_channel = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* Status */ 
        if (GetField_Char(hRls,"status",&cTmp)) {
DEBUGLOG(("Update:status = [%c]\n",cTmp));
		sprintf(csBuf,"%c",cTmp);
		strcat((char*)hv_dynstmt.arr, ",oth_status = '");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* ar ind */ 
        if (GetField_Char(hRls,"ar_ind",&cTmp)) {
DEBUGLOG(("Update:ar_ind = [%c]\n",cTmp));
		sprintf(csBuf,"%c",cTmp);
		strcat((char*)hv_dynstmt.arr, ",oth_ar_ind = '");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* Sub Status */
        if (GetField_CString(hRls,"sub_status",&csTmp)) {
DEBUGLOG(("Update:sub_status = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",oth_sub_status = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* ACK Status */
        if (GetField_CString(hRls,"ack_status",&csTmp)) {
DEBUGLOG(("Update:ack_status = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",oth_ack_status = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* Txn Code */
        if (GetField_CString(hRls,"txn_code",&csTmp)) {
DEBUGLOG(("Update:txn_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_txn_code = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* process type */
        if (GetField_CString(hRls,"process_type",&csTmp)) {
DEBUGLOG(("Update:process_type = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_process_type = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* process code */
        if (GetField_CString(hRls,"process_code",&csTmp)) {
DEBUGLOG(("Update:process_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_process_code = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* Merchant No */
        if (GetField_CString(hRls,"merchant_id",&csTmp)) {
DEBUGLOG(("Update:merchant_id = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_merchant_id = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* Merchant Ref */
        if (GetField_CString(hRls,"merchant_ref",&csTmp)) {
DEBUGLOG(("Update:merchant_ref = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_merchant_ref = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* Client ID */
        if (GetField_CString(hRls,"client_id",&csTmp)) {
DEBUGLOG(("Update:client_id = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_client_id = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* host posting date */
        if (GetField_CString(hRls,"host_posting_date",&csTmp)) {
DEBUGLOG(("Update:host_posting_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_host_posting_date = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* transmission_datetime  */
        if (GetField_CString(hRls,"transmission_datetime",&csTmp)) {
DEBUGLOG(("Update:transmission_datetime = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_transmission_datetime = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* internal code  */
        if (GetField_Int(hRls,"internal_code",&iTmp)) {
DEBUGLOG(("Update:internal_code = [%d]\n",iTmp));
		sprintf(csBuf,"%d",iTmp);
		strcat((char*)hv_dynstmt.arr, ",oth_internal_code = '");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* response code  */
        if (GetField_CString(hRls,"response_code",&csTmp)) {
DEBUGLOG(("Update:response_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_response_code = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* transaction amt   */
        if (GetField_Double(hRls,"txn_amt",&dTmp)) {
DEBUGLOG(("Update:txn_amt = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",oth_transaction_amount = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* deposit amt   */
        if (GetField_Double(hRls,"deposit_amt",&dTmp)) {
DEBUGLOG(("Update:deposit_amt = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",oth_deposit_amount = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* display amt   */
        if (GetField_Double(hRls,"display_amt",&dTmp)) {
DEBUGLOG(("Update:display_amt = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",oth_display_amount = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* net amt   */
        if (GetField_Double(hRls,"net_amt",&dTmp)) {
DEBUGLOG(("Update:net_amt = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",oth_net_amount = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* tm date */
        if (GetField_CString(hRls,"tm_date",&csTmp)) {
DEBUGLOG(("Update:tm_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_tm_date = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* tm time */
        if (GetField_CString(hRls,"tm_time",&csTmp)) {
DEBUGLOG(("Update:tm_time = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_tm_time = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* local tm date */
        if (GetField_CString(hRls,"local_tm_date",&csTmp)) {
DEBUGLOG(("Update:local_tm_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_local_tm_date = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* local tm time */
        if (GetField_CString(hRls,"local_tm_time",&csTmp)) {
DEBUGLOG(("Update:local_tm_time = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_local_tm_time = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* ip_addr */
        if (GetField_CString(hRls,"ip_addr",&csTmp)) {
		char *p;
		char    csTmpIP[PD_IP_LEN+1];
                p = strtok (csTmp,",");
                while (p != NULL)
                {
                        strcpy(csTmpIP,p);
                        csTmpIP[strlen(p)]='\0';
			break;
                }
DEBUGLOG(("Update:ip_addr = [%s]\n",csTmpIP));
		strcat((char*)hv_dynstmt.arr, ",oth_client_ip = '");
        	strcat((char*)hv_dynstmt.arr, csTmpIP);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* approval date */
        if (GetField_CString(hRls,"approval_date",&csTmp)) {
DEBUGLOG(("Update:approval_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_approval_date = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* approval timestamp */
        if (GetField_CString(hRls,"approval_timestamp",&csTmp)) {
DEBUGLOG(("Update:approval_timestamp = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_approval_timestamp = to_timestamp('");
        	strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "','YYYYMMDDHH24MISSFF') ");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* service_code */
        if (GetField_CString(hRls,"service_code",&csTmp)) {
DEBUGLOG(("Update:service_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_service_code= '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* ex_supplier */ 
        if (GetField_Char(hRls,"ex_supplier",&cTmp)) {
DEBUGLOG(("Update:ex_supplier = [%c]\n",cTmp));
		sprintf(csBuf,"%c",cTmp);
		strcat((char*)hv_dynstmt.arr, ",oth_ex_supplier = '");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/*ex_rate*/
        if (GetField_Double(hRls,"ex_rate",&dTmp)) {
DEBUGLOG(("Update:ex_rate = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",oth_ex_rate = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* settlement txn amount */
        if (GetField_Double(hRls,"settlement_txn_amt",&dTmp)) {
DEBUGLOG(("Update:settlement_txn_amt = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",oth_settlement_txn_amount = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
DEBUGLOG(("Update:add_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_create_user = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* update user */
        if (GetField_CString(hRls,"update_user",&csTmp)) {
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_update_user = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* inter ccy */
        if (GetField_CString(hRls,"inter_ccy",&csTmp)) {
DEBUGLOG(("Update:inter_ccy = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_inter_ccy = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/// inter rate
        if (GetField_Double(hRls,"inter_rate",&dTmp)) {
DEBUGLOG(("Update:inter_rate = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",oth_inter_rate = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* net ccy */
        if (GetField_CString(hRls,"net_ccy",&csTmp)) {
DEBUGLOG(("Update:net_ccy = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",oth_net_ccy = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

// dst_txn_id
	if (GetField_CString(hRls, "dst_txn_id", &csTmp)) {
DEBUGLOG(("Update: dst_txn_id = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ",oth_dst_txn_id = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// upd_match_ts
	if (GetField_Char(hRls, "upd_match_ts", &cTmp)) {
DEBUGLOG(("Update: upd_match_ts = [%c]\n", cTmp));
		if (cTmp == PD_YES) {
			strcat((char*)hv_dynstmt.arr, ",oth_matching_timestamp = sysdate");
			hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
		}
	}

// multi_match_ind
        if (GetField_Int(hRls,"multi_match_ind",&iTmp)) {
DEBUGLOG(("Update:multi_match_ind = [%d]\n",iTmp));
		sprintf(csBuf,"%d",iTmp);
		strcat((char*)hv_dynstmt.arr, ",oth_multi_match_ind = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

	strcat((char *)hv_dynstmt.arr, " WHERE oth_txn_id = '");
        strcat((char *)hv_dynstmt.arr, csTxnId);
        strcat((char *)hv_dynstmt.arr, "'");
       	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);

// update txn sub status 
	AddTxnStatusLog(hRls);

// update txn browser info  
        AddTxnBrowserInfo(hRls);

DEBUGLOG(("Update Normal Exit\n"));
	return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("OLTransaction_Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
	TxnAbort();
        return PD_INTERNAL_ERR;
}

int AddDetail(const hash_t *hRls)
{
        char		*csTmp;
	int		iTmp;
	char		cTmp;

        EXEC SQL WHENEVER SQLERROR GOTO adddetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short 		hv_return_value;

	varchar		hv_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_txn_ccy[PD_CCY_ID_LEN];
	varchar		hv_txn_country[PD_COUNTRY_LEN];
	varchar		hv_pay_method[PD_PAY_METHOD_LIST_LEN];
	varchar		hv_cust_deposit_datetime[PD_DATETIME_LEN];
	varchar		hv_bank_deposit_datetime[PD_DATETIME_LEN];
	varchar		hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
	varchar		hv_deposit_bank_code[PD_AC_BANK_LEN];
	varchar		hv_deposit_bank[PD_BANK_DESC_LEN];
	varchar		hv_deposit_ref[PD_BANK_REF_LEN];
	varchar		hv_bank_code[PD_AC_BANK_LEN];
	varchar		hv_bank_name[PD_AC_BANK_NAME_LEN];
	varchar		hv_branch_name[PD_BANK_BRANCH_LEN];
	varchar		hv_account_id[PD_AC_NO_LEN];
	varchar		hv_account_name[PD_AC_NAME_LEN];
	varchar		hv_identity_id[PD_IDENTITY_ID_LEN];
	varchar		hv_province[PD_PROVINCE_LEN];
	varchar		hv_phone_no[PD_PHONE_NO_LEN];
	varchar		hv_city[PD_CITY_LEN];
	varchar		hv_batch_id[PD_BATCH_LEN];
	varchar		hv_language[PD_LANGUAGE_LEN];
	varchar		hv_success_url[PD_URL_LEN];
	varchar		hv_failure_url[PD_URL_LEN];
	varchar		hv_success_ck_url[PD_URL_LEN];
	varchar		hv_failure_ck_url[PD_URL_LEN];
	varchar		hv_add_user[PD_USER_LEN];
	varchar		hv_update_user[PD_USER_LEN];
	varchar		hv_encrypt_type[PD_ENCRYPT_LEN];
	int		hv_version_no;
	varchar		hv_remark[PD_REMARK_LEN];
        varchar         hv_banner_logo[PD_BANNER_LOGO_LEN];
        varchar         hv_echo_msg_1[PD_ECHO_MSG_LEN];
        varchar         hv_echo_msg_2[PD_ECHO_MSG_LEN];
        varchar         hv_echo_msg_3[PD_ECHO_MSG_LEN];
        varchar         hv_opt_1[PD_OPT_LEN];
        varchar         hv_opt_2[PD_OPT_LEN];
        varchar         hv_opt_3[PD_OPT_LEN];
	varchar		hv_cust_tag[PD_CUSTOMER_TAG_LEN];
	char		hv_deposit_flow;
	int		hv_cust_deposit_dt_prov;


	short		ind_txn_id = -1;
	short		ind_txn_ccy = -1;
	short		ind_txn_country = -1;
	short		ind_pay_method = -1;
	short		ind_cust_deposit_datetime = -1;
	short		ind_bank_deposit_datetime = -1;
	short		ind_bank_acct_num = -1;
	short		ind_deposit_bank_code = -1;
	short		ind_deposit_bank = -1;
	short		ind_deposit_ref = -1;
	short		ind_bank_code = -1;
	short		ind_bank_name = -1;
	short		ind_branch_name = -1;
	short		ind_account_id = -1;
	short		ind_account_name = -1;
	short		ind_identity_id = -1;
	short		ind_province = -1;
	short		ind_phone_no = -1;
	short		ind_city = -1;
	short		ind_batch_id = -1;
	short		ind_language = -1;
	short		ind_success_url = -1;
	short		ind_failure_url = -1;
	short		ind_success_ck_url = -1;
	short		ind_failure_ck_url = -1;
	short		ind_add_user = -1;
	short		ind_update_user = -1;
	short		ind_encrypt_type= -1;
	short		ind_version_no = -1;
	short		ind_remark = -1;
        short           ind_banner_logo= -1;
        short           ind_echo_msg_1= -1;
        short           ind_echo_msg_2= -1;
        short           ind_echo_msg_3= -1;
        short           ind_opt_1= -1;
        short           ind_opt_2= -1;
        short           ind_opt_3= -1;
	short		ind_cust_tag= -1;
	short		ind_deposit_flow= -1;
	short		ind_cust_deposit_dt_prov = -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("AddDetail: Begin\n"));


/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("AddDetail:txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
        }

/* txn_ccy */
        if (GetField_CString(hRls,"txn_ccy",&csTmp)) {
                hv_txn_ccy.len = strlen(csTmp);
                memcpy(hv_txn_ccy.arr,csTmp,hv_txn_ccy.len);
                ind_txn_ccy = 0;
DEBUGLOG(("AddDetail:txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));
        }

/* txn_country */
        if (GetField_CString(hRls,"txn_country",&csTmp)) {
                hv_txn_country.len = strlen(csTmp);
                memcpy(hv_txn_country.arr,csTmp,hv_txn_country.len);
                ind_txn_country = 0;
DEBUGLOG(("AddDetail:txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));
        }
/* pay_method */
        if (GetField_CString(hRls,"pay_method",&csTmp)) {
                hv_pay_method.len = strlen(csTmp);
                memcpy(hv_pay_method.arr,csTmp,hv_pay_method.len);
                ind_pay_method = 0;
DEBUGLOG(("AddDetail:pay_method = [%.*s]\n",hv_pay_method.len,hv_pay_method.arr));
	}

/* cust_deposit_datetime */
        if (GetField_CString(hRls,"cust_deposit_datetime",&csTmp)) {
		if (strlen(csTmp) > 14) {
			csTmp[14] = '\0';
		}
                hv_cust_deposit_datetime.len = strlen(csTmp);
                memcpy(hv_cust_deposit_datetime.arr,csTmp,hv_cust_deposit_datetime.len);
                ind_cust_deposit_datetime = 0;
DEBUGLOG(("AddDetail:cust_deposit_datetime = [%.*s]\n",hv_cust_deposit_datetime.len,hv_cust_deposit_datetime.arr));
	}

/* bank_deposit_datetime */
        if (GetField_CString(hRls,"bank_deposit_datetime",&csTmp)) {
                hv_bank_deposit_datetime.len = strlen(csTmp);
                memcpy(hv_bank_deposit_datetime.arr,csTmp,hv_bank_deposit_datetime.len);
                ind_bank_deposit_datetime = 0;
DEBUGLOG(("AddDetail:bank_deposit_datetime = [%.*s]\n",hv_bank_deposit_datetime.len,hv_bank_deposit_datetime.arr));
	}
/* bank_acct_num */
        if (GetField_CString(hRls,"bank_acct_num",&csTmp)) {
                hv_bank_acct_num.len = strlen(csTmp);
                memcpy(hv_bank_acct_num.arr,csTmp,hv_bank_acct_num.len);
                ind_bank_acct_num = 0;
DEBUGLOG(("AddDetail:bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));
	}

/* deposit_bank_code */
        if (GetField_CString(hRls,"deposit_bank_code",&csTmp)) {
                hv_deposit_bank_code.len = strlen(csTmp);
                memcpy(hv_deposit_bank_code.arr,csTmp,hv_deposit_bank_code.len);
                ind_deposit_bank_code = 0;
DEBUGLOG(("AddDetail:deposit_bank_code = [%.*s]\n",hv_deposit_bank_code.len,hv_deposit_bank_code.arr));
	}

/* deposit_bank */
        if (GetField_CString(hRls,"deposit_bank",&csTmp)) {
                hv_deposit_bank.len = strlen(csTmp);
                memcpy(hv_deposit_bank.arr,csTmp,hv_deposit_bank.len);
                ind_deposit_bank = 0;
DEBUGLOG(("AddDetail:deposit_bank = [%.*s]\n",hv_deposit_bank.len,hv_deposit_bank.arr));
	}

/* deposit_ref */
        if (GetField_CString(hRls,"deposit_ref",&csTmp)) {
                hv_deposit_ref.len = strlen(csTmp);
                memcpy(hv_deposit_ref.arr,csTmp,hv_deposit_ref.len);
                ind_deposit_ref = 0;
DEBUGLOG(("AddDetail:deposit_ref = [%.*s]\n",hv_deposit_ref.len,hv_deposit_ref.arr));
	}

/* bank_code */
        if (GetField_CString(hRls,"bank_code",&csTmp)) {
                hv_bank_code.len = strlen(csTmp);
                memcpy(hv_bank_code.arr,csTmp,hv_bank_code.len);
                ind_bank_code = 0;
DEBUGLOG(("AddDetail:bank_code = [%.*s]\n",hv_bank_code.len,hv_bank_code.arr));
	}

/* bank_name */
        if (GetField_CString(hRls,"bank_name",&csTmp)) {
                hv_bank_name.len = strlen(csTmp);
                memcpy(hv_bank_name.arr,csTmp,hv_bank_name.len);
                ind_bank_name = 0;
DEBUGLOG(("AddDetail:bank_name = [%.*s]\n",hv_bank_name.len,hv_bank_name.arr));
	}
/* branch_name */
        if (GetField_CString(hRls,"branch_name",&csTmp)) {
                hv_branch_name.len = strlen(csTmp);
                memcpy(hv_branch_name.arr,csTmp,hv_branch_name.len);
                ind_branch_name = 0;
DEBUGLOG(("AddDetail:branch_name = [%.*s]\n",hv_branch_name.len,hv_branch_name.arr));
	}

/* account_id */
        if (GetField_CString(hRls,"account_id",&csTmp)) {
                hv_account_id.len = strlen(csTmp);
                memcpy(hv_account_id.arr,csTmp,hv_account_id.len);
                ind_account_id = 0;
DEBUGLOG(("AddDetail:account_id = [%.*s]\n",hv_account_id.len,hv_account_id.arr));
	}

/* account_name */
        if (GetField_CString(hRls,"account_name",&csTmp)) {
                hv_account_name.len = strlen(csTmp);
                memcpy(hv_account_name.arr,csTmp,hv_account_name.len);
                ind_account_name = 0;
DEBUGLOG(("AddDetail:account_name = [%.*s]\n",hv_account_name.len,hv_account_name.arr));
	}


/* identity_id */
        if (GetField_CString(hRls,"identity_id",&csTmp)) {
                hv_identity_id.len = strlen(csTmp);
                memcpy(hv_identity_id.arr,csTmp,hv_identity_id.len);
                ind_identity_id = 0;
DEBUGLOG(("AddDetail:identity_id = [%.*s]\n",hv_identity_id.len,hv_identity_id.arr));
	}


/* province */
        if (GetField_CString(hRls,"province",&csTmp)) {
                hv_province.len = strlen(csTmp);
                memcpy(hv_province.arr,csTmp,hv_province.len);
                ind_province = 0;
DEBUGLOG(("AddDetail:province = [%.*s]\n",hv_province.len,hv_province.arr));
	}

/* phone_no */
        if (GetField_CString(hRls,"phone_no",&csTmp)) {
                hv_phone_no.len = strlen(csTmp);
                memcpy(hv_phone_no.arr,csTmp,hv_phone_no.len);
                ind_phone_no = 0;
DEBUGLOG(("AddDetail:phone_no = [%.*s]\n",hv_phone_no.len,hv_phone_no.arr));
	}

/* city */
        if (GetField_CString(hRls,"city",&csTmp)) {
                hv_city.len = strlen(csTmp);
                memcpy(hv_city.arr,csTmp,hv_city.len);
                ind_city = 0;
DEBUGLOG(("AddDetail:city = [%.*s]\n",hv_city.len,hv_city.arr));
	}
/* batch_id */
        if (GetField_CString(hRls,"batch_id",&csTmp)) {
                hv_batch_id.len = strlen(csTmp);
                memcpy(hv_batch_id.arr,csTmp,hv_batch_id.len);
                ind_batch_id = 0;
DEBUGLOG(("AddDetail:batch_id = [%.*s]\n",hv_batch_id.len,hv_batch_id.arr));
	}


/* language */
        if (GetField_CString(hRls,"language",&csTmp)) {
                hv_language.len = strlen(csTmp);
                memcpy(hv_language.arr,csTmp,hv_language.len);
                ind_language = 0;
DEBUGLOG(("AddDetail:language = [%.*s]\n",hv_language.len,hv_language.arr));
	}

/* success_url */
        if (GetField_CString(hRls,"success_url",&csTmp)) {
                hv_success_url.len = strlen(csTmp);
                memcpy(hv_success_url.arr,csTmp,hv_success_url.len);
                ind_success_url = 0;
DEBUGLOG(("AddDetail:success_url = [%.*s]\n",hv_success_url.len,hv_success_url.arr));
	}

/* failure_url */
        if (GetField_CString(hRls,"failure_url",&csTmp)) {
                hv_failure_url.len = strlen(csTmp);
                memcpy(hv_failure_url.arr,csTmp,hv_failure_url.len);
                ind_failure_url = 0;
DEBUGLOG(("AddDetail:failure_url = [%.*s]\n",hv_failure_url.len,hv_failure_url.arr));
	}

/* success_callback_url */
        if (GetField_CString(hRls,"success_callback_url",&csTmp)) {
                hv_success_ck_url.len = strlen(csTmp);
                memcpy(hv_success_ck_url.arr,csTmp,hv_success_ck_url.len);
                ind_success_ck_url = 0;
DEBUGLOG(("AddDetail:success_ck_url = [%.*s]\n",hv_success_ck_url.len,hv_success_ck_url.arr));
	}

/* failure_callback_url */
        if (GetField_CString(hRls,"failure_callback_url",&csTmp)) {
                hv_failure_ck_url.len = strlen(csTmp);
                memcpy(hv_failure_ck_url.arr,csTmp,hv_failure_ck_url.len);
                ind_failure_ck_url = 0;
DEBUGLOG(("AddDetail:failure_ck_url = [%.*s]\n",hv_failure_ck_url.len,hv_failure_ck_url.arr));
	}
	
	
/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen((const char*)csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("AddDetail:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }
/* update user */
        if (GetField_CString(hRls,"update_user",&csTmp)) {
                hv_update_user.len = strlen((const char*)csTmp);
                memcpy(hv_update_user.arr,csTmp,hv_update_user.len);
                ind_update_user = 0;
DEBUGLOG(("AddDetail:update_user = [%.*s]\n",hv_update_user.len,hv_update_user.arr));
        }


/* encrypt_type */
        if (GetField_CString(hRls,"encrypt_type",&csTmp)) {
                hv_encrypt_type.len = strlen(csTmp);
                memcpy(hv_encrypt_type.arr,csTmp,hv_encrypt_type.len);
                ind_encrypt_type = 0;
DEBUGLOG(("AddDetail:encrypt_type = [%.*s]\n",hv_encrypt_type.len,hv_encrypt_type.arr));
        }

/* version_no */
	if (GetField_Int(hRls,"version_no",&iTmp)) {
		hv_version_no = iTmp;
		ind_version_no = 0;
DEBUGLOG(("AddDetail:version_no = [%d]\n",hv_version_no));
	}

/* remark */
        if (GetField_CString(hRls,"remark",&csTmp)) {
                hv_remark.len = strlen(csTmp);
                memcpy(hv_remark.arr,csTmp,hv_remark.len);
                ind_remark = 0;
DEBUGLOG(("AddDetail:remark = [%.*s]\n",hv_remark.len,hv_remark.arr));
        }

/* banner_logo*/
        if (GetField_CString(hRls,"banner_logo", &csTmp)) {
                hv_banner_logo.len = strlen(csTmp);
                memcpy(hv_banner_logo.arr,csTmp,hv_banner_logo.len);
                ind_banner_logo= 0;
DEBUGLOG(("AddDetail:banner_logo = [%.*s][%d]\n",hv_banner_logo.len,hv_banner_logo.arr,hv_banner_logo.len));
        }

/* echo_msg*/
        if (GetField_CString(hRls,"echo_msg_1", &csTmp)) {
                hv_echo_msg_1.len = strlen(csTmp);
                memcpy(hv_echo_msg_1.arr,csTmp,hv_echo_msg_1.len);
                ind_echo_msg_1= 0;
DEBUGLOG(("AddDetail:echo_msg_1 = [%.*s][%d]\n",hv_echo_msg_1.len,hv_echo_msg_1.arr,hv_echo_msg_1.len));
        }

/* echo_msg*/
        if (GetField_CString(hRls,"echo_msg_2", &csTmp)) {
                hv_echo_msg_2.len = strlen(csTmp);
                memcpy(hv_echo_msg_2.arr,csTmp,hv_echo_msg_2.len);
                ind_echo_msg_2= 0;
DEBUGLOG(("AddDetail:echo_msg_2 = [%.*s][%d]\n",hv_echo_msg_2.len,hv_echo_msg_2.arr,hv_echo_msg_2.len));
        }

/* echo_msg*/
        if (GetField_CString(hRls,"echo_msg_3", &csTmp)) {
                hv_echo_msg_3.len = strlen(csTmp);
                memcpy(hv_echo_msg_3.arr,csTmp,hv_echo_msg_3.len);
                ind_echo_msg_3= 0;
DEBUGLOG(("AddDetail:echo_msg_3 = [%.*s][%d]\n",hv_echo_msg_3.len,hv_echo_msg_3.arr,hv_echo_msg_3.len));
        }

/* opt*/
        if (GetField_CString(hRls,"opt_1", &csTmp)) {
                hv_opt_1.len = strlen(csTmp);
                memcpy(hv_opt_1.arr,csTmp,hv_opt_1.len);
                ind_opt_1= 0;
DEBUGLOG(("AddDetail:opt_1 = [%.*s][%d]\n",hv_opt_1.len,hv_opt_1.arr,hv_opt_1.len));
        }

/* opt*/
        if (GetField_CString(hRls,"opt_2", &csTmp)) {
                hv_opt_2.len = strlen(csTmp);
                memcpy(hv_opt_2.arr,csTmp,hv_opt_2.len);
                ind_opt_2= 0;
DEBUGLOG(("AddDetail:opt_2 = [%.*s][%d]\n",hv_opt_2.len,hv_opt_2.arr,hv_opt_2.len));
        }

/* opt*/
        if (GetField_CString(hRls,"opt_3", &csTmp)) {
                hv_opt_3.len = strlen(csTmp);
                memcpy(hv_opt_3.arr,csTmp,hv_opt_3.len);
                ind_opt_3= 0;
DEBUGLOG(("AddDetail:opt_3 = [%.*s][%d]\n",hv_opt_3.len,hv_opt_3.arr,hv_opt_3.len));
        }

/* cust_tag*/
        if (GetField_CString(hRls,"cust_tag", &csTmp)) {
                hv_cust_tag.len = strlen(csTmp);
                memcpy(hv_cust_tag.arr,csTmp,hv_cust_tag.len);
                ind_cust_tag= 0;
DEBUGLOG(("AddDetail:cust_tag = [%.*s][%d]\n",hv_cust_tag.len,hv_cust_tag.arr,hv_cust_tag.len));
        }
/* deposit_flow*/
	if (GetField_Char(hRls,"deposit_flow", &cTmp)) {
		hv_deposit_flow = cTmp;
		ind_deposit_flow= 0;
DEBUGLOG(("AddDetail:deposit_flow = [%c]\n", hv_deposit_flow));
	}
/* cust_deposit_dt_prov */
	if (GetField_Int(hRls, "cust_deposit_dt_prov", &iTmp)) {
		hv_cust_deposit_dt_prov = iTmp;
		ind_cust_deposit_dt_prov = 0;
DEBUGLOG(("AddDetail: cust_deposit_dt_prov = [%d]\n", hv_cust_deposit_dt_prov));
	}

	EXEC SQL EXECUTE
                BEGIN
			:hv_return_value := sp_ol_txn_detail_insert(
					:hv_txn_id:ind_txn_id,
					:hv_txn_ccy:ind_txn_ccy,
					:hv_txn_country:ind_txn_country,
					:hv_pay_method:ind_pay_method,
					:hv_cust_deposit_datetime:ind_cust_deposit_datetime,
					:hv_bank_deposit_datetime:ind_bank_deposit_datetime,
					:hv_bank_acct_num:ind_bank_acct_num,
					:hv_deposit_bank_code:ind_deposit_bank_code,
					:hv_deposit_bank:ind_deposit_bank,
					:hv_deposit_ref:ind_deposit_ref,
					:hv_bank_code:ind_bank_code,
					:hv_bank_name:ind_bank_name,
					:hv_branch_name:ind_branch_name,
					:hv_account_id:ind_account_id,
					:hv_account_name:ind_account_name,
					:hv_identity_id:ind_identity_id,
					:hv_province:ind_province,
					:hv_phone_no:ind_phone_no,
					:hv_city:ind_city,
					:hv_batch_id:ind_batch_id,
					:hv_language:ind_language,
					:hv_success_url:ind_success_url,
					:hv_failure_url:ind_failure_url,
					:hv_success_ck_url:ind_success_ck_url,
					:hv_failure_ck_url:ind_failure_ck_url,
					:hv_add_user:ind_add_user,
					:hv_update_user:ind_update_user,
					:hv_encrypt_type:ind_encrypt_type,
					:hv_version_no:ind_version_no,
					:hv_remark:ind_remark,
					:hv_banner_logo:ind_banner_logo,
                                        :hv_echo_msg_1:ind_echo_msg_1,
                                        :hv_echo_msg_2:ind_echo_msg_2,
                                        :hv_echo_msg_3:ind_echo_msg_3,
                                        :hv_opt_1:ind_opt_1,
                                        :hv_opt_2:ind_opt_2,
                                        :hv_opt_3:ind_opt_3,
					:hv_cust_tag:ind_cust_tag,
					:hv_deposit_flow:ind_deposit_flow,
					:hv_cust_deposit_dt_prov:ind_cust_deposit_dt_prov);
	        END;
        END-EXEC;

DEBUGLOG(("AddDetail:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("AddDetail:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("Transaction_AddDetail: SP_OTHER_ERR\n");
DEBUGLOG(("AddDetail: SP_OTHER_ERR\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("Transaction_Add: SP_ERR\n");
DEBUGLOG(("AddDetail: SP_ERR\n"));
                return PD_ERR;
        }

adddetail_error:
DEBUGLOG(("adddetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("OLTransaction_Add: SP_INTERNAL_ERR\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR\n"));
        return PD_INTERNAL_ERR;
}

int UpdateDetail(const hash_t *hRls)
{
	double	dTmp;
	char*	csPtr;
	char*	csBuf;
	char*	csTxnId;
	int	iTmp;
	char* csQTmp[1024];
        EXEC SQL WHENEVER SQLERROR GOTO update_detail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

	varchar 	hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("UpdateDetail: Begin\n"));
	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr,"update ol_txn_detail set otd_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"txn_seq",&csTxnId);
DEBUGLOG(("UpdateDetail:txn_id = [%s]\n",csTxnId));

/* current_bal*/
        if (GetField_Double(hRls,"current_bal",&dTmp)) {
DEBUGLOG(("UpdateDetail:current_bal= [%f]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",otd_current_bal = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* current_bal_settlement */
        if (GetField_Double(hRls,"current_bal_settlement",&dTmp)) {
DEBUGLOG(("UpdateDetail:current_bal_settlement= [%f]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otd_current_bal_settlement = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* open_bal*/
        if (GetField_Double(hRls,"open_bal",&dTmp)) {
DEBUGLOG(("UpdateDetail:open_bal= [%f]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",otd_open_bal = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* open_bal_settlement*/
        if (GetField_Double(hRls,"open_bal_settlement",&dTmp)) {
DEBUGLOG(("UpdateDetail:open_bal_settlement= [%f]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otd_open_bal_settlement = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* total_float_settlement*/
        if (GetField_Double(hRls,"total_float_settlement",&dTmp)) {
DEBUGLOG(("UpdateDetail:total_float_settlement= [%f]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otd_total_float_settlement = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* total_float_after_payout*/
        if (GetField_Double(hRls,"total_float_after_payout",&dTmp)) {
DEBUGLOG(("UpdateDetail:total_float_after_payout= [%f]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otd_total_float_after_payout = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* total_reserved_amount*/
        if (GetField_Double(hRls,"total_reserved_amount",&dTmp)) {
DEBUGLOG(("UpdateDetail:total_reserved_amount= [%f]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otd_total_reserved_amount = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* total_hold*/
        if (GetField_Double(hRls,"total_hold",&dTmp)) {
DEBUGLOG(("UpdateDetail:total_hold= [%f]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",otd_total_hold = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* total_hold_settlement*/
        if (GetField_Double(hRls,"total_hold_settlement",&dTmp)) {
DEBUGLOG(("UpdateDetail:total_hold_settlement= [%f]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otd_total_hold_settlement = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/*fundin_payout*/
        if (GetField_Double(hRls,"fundin_payout",&dTmp)) {
DEBUGLOG(("UpdateDetail:fundin_payout= [%f]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otd_fundin_payout = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/*reserved_payout*/
        if (GetField_Double(hRls,"reserved_payout",&dTmp)) {
DEBUGLOG(("UpdateDetail:reserved_payout= [%f]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otd_reserved_payout = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* txn_country */
        if (GetField_CString(hRls,"txn_country",&csPtr)) {
DEBUGLOG(("UpdateDetail:txn_country = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_txn_country = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* cust_deposit_datetime */
        if (GetField_CString(hRls,"cust_deposit_datetime",&csPtr)) {
DEBUGLOG(("UpdateDetail:cust_deposit_datetime = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_cust_deposit_datetime = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* bank_deposit_datetime */
        if (GetField_CString(hRls,"bank_deposit_datetime",&csPtr)) {
DEBUGLOG(("UpdateDetail:bank_deposit_datetime = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_bank_deposit_datetime = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}
/* bank_acct_num */
        if (GetField_CString(hRls,"bank_acct_num",&csPtr)) {
DEBUGLOG(("UpdateDetail:bank_acct_num = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_bank_acct_num = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* deposit bank code */
        if (GetField_CString(hRls,"deposit_bank_code",&csPtr)) {
DEBUGLOG(("UpdateDetail:deposit_bank_code = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_deposit_bank_code = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* deposit_bank */
        if (GetField_CString(hRls,"deposit_bank",&csPtr)) {
DEBUGLOG(("UpdateDetail:bank_name = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_deposit_bank = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* deposit_ref */
        if (GetField_CString(hRls,"deposit_ref",&csPtr)) {
DEBUGLOG(("UpdateDetail:deposit_ref = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_deposit_ref = ");

		sprintf((char *)csQTmp, (char*)PD_Q_QUOTE_VALUE, csPtr);
                csQTmp[strlen(csPtr) + PD_Q_ADD_QUOTE_LEN] = '\0';
DEBUGLOG(("Update: deposit_ref(q_quote) = [%s]\n", csQTmp));

        	strcat((char*)hv_dynstmt.arr, (char*) csQTmp);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* bank code */
        if (GetField_CString(hRls,"bank_code",&csPtr)) {
DEBUGLOG(("UpdateDetail:bank_code = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_bank_code = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* bank name*/
        if (GetField_CString(hRls,"bank_name",&csPtr)) {
DEBUGLOG(("UpdateDetail:bank_name = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_bank_name = ");

		sprintf((char *)csQTmp, (char*)PD_Q_QUOTE_VALUE, csPtr);
                csQTmp[strlen(csPtr) + PD_Q_ADD_QUOTE_LEN] = '\0';
DEBUGLOG(("Update: bank_name (q_quote) = [%s]\n", csQTmp));

                strcat((char*)hv_dynstmt.arr, (char*) csQTmp);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* branch name*/
        if (GetField_CString(hRls,"branch",&csPtr)) {
DEBUGLOG(("UpdateDetail:branch = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_branch_name = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* account name*/
        if (GetField_CString(hRls,"account_name",&csPtr)) {
DEBUGLOG(("UpdateDetail:account_name = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_account_name = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* account id*/
        if (GetField_CString(hRls,"account_id",&csPtr)) {
DEBUGLOG(("UpdateDetail:account_id = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_account_id = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* pay_method */
        if (GetField_CString(hRls,"pay_method",&csPtr)) {
DEBUGLOG(("UpdateDetail:pay_method = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_pay_method = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* selected_pay_method */
        if (GetField_CString(hRls,"selected_pay_method",&csPtr)) {
DEBUGLOG(("UpdateDetail:selected_pay_method = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_selected_pay_method = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* update user */
        if (GetField_CString(hRls,"update_user",&csPtr)) {
DEBUGLOG(("UpdateDetail:update_user = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_update_user = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* batch_id */
        if (GetField_CString(hRls,"td_batch_id",&csPtr)) {
DEBUGLOG(("UpdateDetail:td_batch_id = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",otd_batch_id = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* fe_domain */
        if (GetField_CString(hRls,"fe_domain",&csPtr)) {
DEBUGLOG(("UpdateDetail:fe_domain = [%s]\n",csPtr));
                strcat((char*)hv_dynstmt.arr, ",otd_fe_domain = '");
                strcat((char*)hv_dynstmt.arr, csPtr);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* cust_deposit_id_prov*/
        if (GetField_Int(hRls,"cust_deposit_dt_prov", &iTmp)) {
DEBUGLOG(("UpdateDetail:cust_deposit_id_prov = [%d]\n",iTmp));
                sprintf(csBuf,"%d",iTmp);
                strcat((char*)hv_dynstmt.arr, ",otd_cust_deposit_dt_prov = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

	strcat((char *)hv_dynstmt.arr, " WHERE otd_txn_id = '");
        strcat((char *)hv_dynstmt.arr, csTxnId);
        strcat((char *)hv_dynstmt.arr, "'");
       	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);


DEBUGLOG(("UpdateDetail Normal Exit\n"));
	return PD_OK;

update_detail_error:
DEBUGLOG(("update_detail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("OLTransaction_UpdateDetail: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("UpdateDetail: SP_INTERNAL_ERR TxnAbort\n"));
	TxnAbort();
        return PD_INTERNAL_ERR;
}


int AddTxnStatusLog(const hash_t *hCon)
{
        char    *csTmp;
        char    cTmp;

        EXEC SQL WHENEVER SQLERROR GOTO add_txnstatuslogerror;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];
                char            hv_status;
                char            hv_ar_ind;
                varchar         hv_sub_status[PD_SUB_STATUS_LEN];
                varchar         hv_create_user[PD_USER_LEN];


                short           ind_txn_id = -1;
                short           ind_status = -1;
                short           ind_ar_ind = -1;
                short           ind_sub_status = -1;
                short           ind_create_user = -1;

                short           hv_return_value;
        EXEC SQL END DECLARE SECTION;
DEBUGLOG(("AddTxnStatusLog: Begin\n"));

        if (GetField_CString(hCon,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                strncpy((char*)hv_txn_id.arr, csTmp, hv_txn_id.len);
                ind_txn_id = 0;
        }
DEBUGLOG(("AddTxnStatusLog:txn_id = [%.*s]\n",hv_txn_id.len, hv_txn_id.arr));

        if (GetField_Char(hCon,"status",&cTmp)) {
                hv_status = cTmp;
                ind_status = 0;
DEBUGLOG(("AddTxnStatusLog: status = [%c]\n",cTmp));
        }

        if (GetField_Char(hCon,"status",&cTmp)) {
                hv_status = cTmp;
                ind_status = 0;
DEBUGLOG(("AddTxnStatusLog: status = [%c]\n",cTmp));
        }

        if (GetField_Char(hCon,"ar_ind",&cTmp)) {
                hv_ar_ind = cTmp;
                ind_ar_ind = 0;
DEBUGLOG(("AddTxnStatusLog: ar_ind = [%c]\n",cTmp));
        }

        if(GetField_CString(hCon,"sub_status",&csTmp))
        {
                hv_sub_status.len = strlen(csTmp);
                strncpy((char*)hv_sub_status.arr, csTmp, hv_sub_status.len);
                ind_sub_status = 0;
DEBUGLOG(("AddTxnStatusLog:sub_status = [%.*s]\n",hv_sub_status.len,hv_sub_status.arr));
        }

        if(GetField_CString(hCon,"add_user",&csTmp))
        {
                hv_create_user.len = strlen(csTmp);
                strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
        }
        else if(GetField_CString(hCon,"update_user",&csTmp))
        {
                hv_create_user.len = strlen(csTmp);
                strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
        }
        else{
                hv_create_user.len = strlen("SYSTEM");
                strncpy((char*)hv_create_user.arr,"SYSTEM", hv_create_user.len);
                ind_create_user = 0;
        }
DEBUGLOG(("AddTxnStatusLog:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));

        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_ol_txn_status_log_insert(
                                        :hv_txn_id:ind_txn_id,
                                        :hv_status:ind_status,
                                        :hv_ar_ind:ind_ar_ind,
                                        :hv_sub_status:ind_sub_status,
                                        :hv_create_user:ind_create_user);

                END;
        END-EXEC;


DEBUGLOG(("AddTxnStatusLog:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("AddTxnStatusLog:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("TxnCode_AddTxnStatusLog: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("TxnCode_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
                return PD_ERR;
        }


add_txnstatuslogerror:
DEBUGLOG(("add_txnstatuslogerror code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTransaction_add_txnstatuslogerror: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_INTERNAL_ERR;
}

int AddTxnBrowserInfo(const hash_t *hRls)
{
        char            *csTmp;


        EXEC SQL WHENEVER SQLERROR GOTO addtxnbrowserinfo_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short           hv_return_value;

        varchar         hv_txn_id[PD_TXN_SEQ_LEN];
        varchar         hv_user_agent[PD_REMARK_LEN*2];
        varchar         hv_add_user[PD_USER_LEN];
        varchar         hv_client_ip[PD_IP_LEN];

        short           ind_txn_id = -1;
        short           ind_user_agent = -1;
        short           ind_add_user = -1;
        short           ind_client_ip= -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("AddTxnBrowserInfo: Begin\n"));

/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("AddTxnBrowserInfo:txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
        }
/* user agent */
        if (GetField_CString(hRls,"user_agent",&csTmp)) {
                hv_user_agent.len = strlen(csTmp);
                memcpy(hv_user_agent.arr,csTmp,hv_user_agent.len);
                ind_user_agent = 0;
DEBUGLOG(("AddTxnBrowserInfo:user_agent = [%.*s]\n",hv_user_agent.len,hv_user_agent.arr));
        }

/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen(csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("AddTxnBrowserInfo:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }


/* client ip */
        if (GetField_CString(hRls,"ip_addr",&csTmp)) {
                char *p;
                char    csTmpIP[PD_IP_LEN+1];
                p = strtok (csTmp,",");
                while (p != NULL)
                {
                        strcpy(csTmpIP,p);
                        csTmpIP[strlen(p)]='\0';
                        break;
                }
                hv_client_ip.len = strlen(csTmpIP);
                memcpy(hv_client_ip.arr,csTmpIP,hv_client_ip.len);
                ind_client_ip = 0;
DEBUGLOG(("AddTxnBrowserInfo:client_ip = [%.*s]\n",hv_client_ip.len,hv_client_ip.arr));
        }

        if(ind_user_agent == 0){
            EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_ol_txn_browser_info_insert(
                                        :hv_txn_id:ind_txn_id,
                                        :hv_client_ip:ind_client_ip,
                                        :hv_user_agent:ind_user_agent,
                                        :hv_add_user:ind_add_user);
                END;
            END-EXEC;


DEBUGLOG(("AddTxnBrowserInfo:Ret = [%d]\n",hv_return_value));
                if (hv_return_value == SP_OK) {
DEBUGLOG(("AddTxnBrowserInfo:Normal Exit\n"));
                        return PD_OK;
                }

                if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("Transaction_AddTxnBrowserInfo: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("AddTxnBrowserInfo: SP_OTHER_ERR TxnAbort\n"));
                        return PD_OTHER_ERR;
                }

                if (hv_return_value == SP_ERR)  {
ERRLOG("Transaction_AddTxnBrowserInfo: SP_ERR TxnAbort\n");
DEBUGLOG(("AddTxnBrowserInfo: SP_ERR TxnAbort\n"));
                        return PD_ERR;
                }
        }
        else{
DEBUGLOG(("AddTxnBrowserInfo:user_agent not found. Skip adding\n"));
                        return PD_OK;
        }

addtxnbrowserinfo_error:
DEBUGLOG(("addtxnbrowserinfo_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("OLTransaction_AddTxnBrowserInfo: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("AddTxnBrowserInfo: SP_INTERNAL_ERR TxnAbort\n"));
        return PD_INTERNAL_ERR;
}


int TxnDepositEdit(const hash_t *hCon)
{
	char	*csTmp;
	double	dTmp;
	int	iTmp;

	EXEC SQL WHENEVER SQLERROR GOTO edit_deposit_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_txn_id[PD_TXN_SEQ_LEN];
		double	hv_amount;
		varchar	hv_cust_deposit_datetime[PD_DATETIME_LEN];
		varchar	hv_bank_code[PD_AC_BANK_LEN];
		varchar	hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		varchar	hv_deposit_bank_code[PD_AC_BANK_LEN];
		varchar	hv_deposit_bank[PD_BANK_DESC_LEN];
		varchar	hv_deposit_ref[PD_BANK_REF_LEN];
		int	hv_match;
		varchar	hv_create_user[PD_USER_LEN];

		short	ind_txn_id = -1;
		short	ind_amount = -1;
		short	ind_cust_deposit_datetime = -1;
		short	ind_bank_code = -1;
		short	ind_bank_acct_num = -1;
		short	ind_deposit_bank_code = -1;
		short	ind_deposit_bank = -1;
		short	ind_deposit_ref = -1;
		short	ind_match = -1;
		short	ind_create_user = -1;

		short	hv_return_value;
	EXEC SQL END DECLARE SECTION;
DEBUGLOG(("TxnDepositEdit: Begin\n"));

	if (GetField_CString(hCon,"txn_seq",&csTmp)) {
		hv_txn_id.len = strlen(csTmp);
		strncpy((char*)hv_txn_id.arr, csTmp, hv_txn_id.len);
		ind_txn_id = 0;
	}
DEBUGLOG(("TxnDepositEdit:txn_id = [%.*s]\n",hv_txn_id.len, hv_txn_id.arr));

	if (GetField_Double(hCon,"deposit_amount",&dTmp)) {
		hv_amount = dTmp;
		ind_amount = 0;
	}
DEBUGLOG(("TxnDepositEdit:deposit_amount = [%.2lf]\n",hv_amount));

	if (GetField_CString(hCon,"cust_deposit_datetime",&csTmp)) {
		hv_cust_deposit_datetime.len = strlen(csTmp);
		strncpy((char*)hv_cust_deposit_datetime.arr, csTmp, hv_cust_deposit_datetime.len);
		ind_cust_deposit_datetime = 0;
DEBUGLOG(("TxnDepositEdit:cust_deposit_datetime = [%.*s]\n",hv_cust_deposit_datetime.len, hv_cust_deposit_datetime.arr));
	}

	if (GetField_CString(hCon,"int_bank_code",&csTmp)) {
		hv_bank_code.len = strlen(csTmp);
		strncpy((char*)hv_bank_code.arr, csTmp, hv_bank_code.len);
		ind_bank_code = 0;
	}
DEBUGLOG(("TxnDepositEdit:bank_code = [%.*s]\n",hv_bank_code.len, hv_bank_code.arr));

	if (GetField_CString(hCon,"bank_acct_num",&csTmp)) {
		hv_bank_acct_num.len = strlen(csTmp);
		strncpy((char*)hv_bank_acct_num.arr, csTmp, hv_bank_acct_num.len);
		ind_bank_acct_num = 0;
	}
DEBUGLOG(("TxnDepositEdit:bank_acct_num = [%.*s]\n",hv_bank_acct_num.len, hv_bank_acct_num.arr));

	if (GetField_CString(hCon,"deposit_bank_code",&csTmp)) {
		hv_deposit_bank_code.len = strlen(csTmp);
		strncpy((char*)hv_deposit_bank_code.arr, csTmp, hv_deposit_bank_code.len);
		ind_deposit_bank_code = 0;
	}
DEBUGLOG(("TxnDepositEdit:deposit_bank_code = [%.*s]\n",hv_deposit_bank_code.len, hv_deposit_bank_code.arr));

	if (GetField_CString(hCon,"deposit_bank",&csTmp)) {
		hv_deposit_bank.len = strlen(csTmp);
		strncpy((char*)hv_deposit_bank.arr, csTmp, hv_deposit_bank.len);
		ind_deposit_bank = 0;
DEBUGLOG(("TxnDepositEdit:deposit_bank = [%.*s]\n",hv_deposit_bank.len, hv_deposit_bank.arr));
	}

	if (GetField_CString(hCon,"deposit_ref",&csTmp)) {
		hv_deposit_ref.len = strlen(csTmp);
		strncpy((char*)hv_deposit_ref.arr, csTmp, hv_deposit_ref.len);
		ind_deposit_ref = 0;
DEBUGLOG(("TxnDepositEdit:deposit_ref = [%.*s]\n",hv_deposit_ref.len, hv_deposit_ref.arr));
	}

	hv_match = 0;
	if (GetField_Int(hCon,"match",&iTmp)) {
		hv_match = iTmp;
	}
	ind_match = 0;
DEBUGLOG(("TxnDepositEdit:match = [%d]\n",hv_match));

	if(GetField_CString(hCon,"add_user",&csTmp))
	{
		hv_create_user.len = strlen(csTmp);
		strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
	}
	else if(GetField_CString(hCon,"update_user",&csTmp))
	{
		hv_create_user.len = strlen(csTmp);
		strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
	}
	else{
		hv_create_user.len = strlen("SYSTEM");
		strncpy((char*)hv_create_user.arr,"SYSTEM", hv_create_user.len);
		ind_create_user = 0;
	}
DEBUGLOG(("TxnDepositEdit:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_txn_deposit_edit(
					:hv_txn_id:ind_txn_id,
					:hv_amount:ind_amount,
					:hv_cust_deposit_datetime:ind_cust_deposit_datetime,
					:hv_bank_code:ind_bank_code,
					:hv_bank_acct_num:ind_bank_acct_num,
					:hv_deposit_bank_code:ind_deposit_bank_code,
					:hv_deposit_bank:ind_deposit_bank,
					:hv_deposit_ref:ind_deposit_ref,
					:hv_match:ind_match,
					:hv_create_user:ind_create_user);

		END;
	END-EXEC;


DEBUGLOG(("TxnDepositEdit:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("TxnDepositEdit:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("TxnCode_TxnDepositEdit: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("TxnCode_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}


edit_deposit_error:
DEBUGLOG(("edit_deposit_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTransaction_edit_deposit_error: SP_INTERNAL_ERR TxnAbort\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_INTERNAL_ERR;
}

int MatchMerchantRef(const char* csMerchantId,
                     const char* csMerchantRef)
{
        EXEC SQL WHENEVER SQLERROR GOTO matchmerchantref_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
    
        EXEC SQL BEGIN DECLARE SECTION;
                short           hv_return_value;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_merchant_ref[PD_MERCHANT_REF_LEN];

    
        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("MatchMerchantRef merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
    
        hv_merchant_ref.len = strlen(csMerchantRef);
        memcpy(hv_merchant_ref.arr,csMerchantRef,hv_merchant_ref.len);
DEBUGLOG(("MatchMerchantRef merchant_ref = [%.*s]\n",hv_merchant_ref.len,hv_merchant_ref.arr));

        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_ol_transaction_matchmref(:hv_merchant_id,
                                                                     :hv_merchant_ref);
                END;
        END-EXEC;

        if (hv_return_value > 0)  {

DEBUGLOG(("MatchMerchantref Found\n"));
                return FOUND;
        }
        else {
DEBUGLOG(("MatchMerchantref Not Found\n"));
                return NOT_FOUND;
        }


matchmerchantref_error:
DEBUGLOG(("matchmerchantref_error code %d\n", sqlca.sqlcode));
ERRLOG("OLTransaction::matchmerchantref_error code %d\n", sqlca.sqlcode);
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}


int GetTxnHeader(const char* csTxnID,
                recordset_t* myRec)
{

        char    csDate[PD_DATE_LEN +1];
        char    csTime[PD_TIME_LEN +1];
        char    csDateTime[PD_DATE_LEN + PD_TIME_LEN +1];
        hash_t *myHash;
        int     iCnt = 0;

        EXEC SQL WHENEVER SQLERROR GOTO gettxnheader_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];

                varchar         v_org_txn_id[PD_TXN_SEQ_LEN + 1];
                varchar         v_client_id[PD_CLIENT_ID_LEN + 1];
                char            v_status;
                char            v_ar_ind;
                varchar         v_txn_code[PD_TXN_CODE_LEN + 1];
                varchar         v_merchant_id[PD_MERCHANT_ID_LEN + 1];
                varchar         v_merchant_ref[PD_MERCHANT_REF_LEN + 1];
                double          v_txn_amt;
                double          v_net_amt;
                varchar         v_net_ccy[PD_CCY_ID_LEN +1];
                varchar         v_transmission_datetime[PD_DATE_LEN + PD_TIME_LEN + 1];
                varchar         v_local_tm_date[PD_DATE_LEN + 1];
                varchar         v_local_tm_time[PD_TIME_LEN + 1];
                varchar         v_tm_date[PD_DATE_LEN + 1];
                varchar         v_tm_time[PD_TIME_LEN + 1];
                long            v_internal_code;
                varchar         v_channel_code[PD_CHANNEL_CODE_LEN + 1];
                varchar         v_response_code[PD_RESPONSE_CODE_LEN + 1];
                varchar         v_host_posting_date[PD_DATE_LEN + 1];
                varchar         v_process_code[PD_PROCESS_CODE_LEN + 1];
                varchar         v_process_type[PD_PROCESS_TYPE_LEN + 1];
                varchar         v_service_code[PD_SERVICE_CODE_LEN + 1];
                varchar         v_client_ip[PD_IP_LEN + 1];
                char            v_ex_supplier;
                double          v_ex_rate;
                varchar         v_sub_status[PD_SUB_STATUS_LEN + 1];
                double          v_display_amt;
		double		v_deposit_amt;
		varchar		v_dst_txn_id[PD_TXN_SEQ_LEN + 1];
		int		v_upload_channel;
		int		v_multi_match_ind;



                short           ind_org_txn_id = -1;
                short           ind_client_id = -1;
                short           ind_status = -1;
                short           ind_ar_ind = -1;
                short           ind_txn_code = -1;
                short           ind_merchant_id = -1;
                short           ind_merchant_ref = -1;
                short           ind_txn_amt = -1;
                short           ind_net_amt = -1;
                short           ind_net_ccy = -1;
                short           ind_transmission_datetime = -1;
                short           ind_local_tm_date = -1;
                short           ind_local_tm_time = -1;
                short           ind_tm_date = -1;
                short           ind_tm_time = -1;
                short           ind_internal_code = -1;
                short           ind_channel_code = -1;
                short           ind_response_code = -1;
                short           ind_host_posting_date = -1;
                short           ind_process_code= -1;
                short           ind_process_type= -1;
                short           ind_service_code = -1;
                short           ind_client_ip = -1;
                short           ind_ex_supplier = -1;
                short           ind_ex_rate = -1;
                short           ind_sub_status = -1;
                short           ind_display_amt = -1;
		short		ind_deposit_amt = -1;
		short		ind_dst_txn_id = -1;
		short		ind_upload_channel = -1;
		short		ind_multi_match_ind = -1;

        EXEC SQL END DECLARE SECTION;


        hv_txn_id.len = strlen(csTxnID);
        memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetTxnHeader txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_getoltxnheader CURSOR FOR
                select oth_org_txn_id,
                       oth_client_id,
                       oth_status,
                       oth_ar_ind,
                       oth_txn_code,
                       oth_merchant_id,
                       oth_merchant_ref,
                       oth_transaction_amount,
                       oth_net_amount,
                       oth_net_ccy,
                       oth_transmission_datetime,
                       oth_local_tm_date,
                       oth_local_tm_time,
                       oth_tm_date,
                       oth_tm_time,
                       oth_internal_code,
                       oth_input_channel,
                       oth_response_code,
                       oth_host_posting_date,
                       oth_process_code,
                       oth_process_type,
                       oth_input_channel,
                       oth_service_code,
                       oth_client_ip,
                       oth_ex_supplier,
                       oth_ex_rate,
                       oth_sub_status,
		       oth_display_amount,
		       oth_deposit_amount,
		       oth_dst_txn_id,
		       oth_upload_channel,
		       oth_multi_match_ind
                  from ol_txn_header
                 where oth_txn_id = :hv_txn_id;


        EXEC SQL OPEN c_cursor_getoltxnheader;
        do {
                EXEC SQL FETCH c_cursor_getoltxnheader
                INTO
                        :v_org_txn_id:ind_org_txn_id,
                        :v_client_id:ind_client_id,
                        :v_status:ind_status,
                        :v_ar_ind:ind_ar_ind,
                        :v_txn_code:ind_txn_code,
                        :v_merchant_id:ind_merchant_id,
                        :v_merchant_ref:ind_merchant_ref,
                        :v_txn_amt:ind_txn_amt,
                        :v_net_amt:ind_net_amt,
                        :v_net_ccy:ind_net_ccy,
                        :v_transmission_datetime:ind_transmission_datetime,
                        :v_local_tm_date:ind_local_tm_date,
                        :v_local_tm_time:ind_local_tm_time,
                        :v_tm_date:ind_tm_date,
                        :v_tm_time:ind_tm_time,
                        :v_internal_code:ind_internal_code,
                        :v_channel_code:ind_channel_code,
                        :v_response_code:ind_response_code,
                        :v_host_posting_date:ind_host_posting_date,
                        :v_process_code:ind_process_code,
                        :v_process_type:ind_process_type,
                        :v_channel_code:ind_channel_code,
                        :v_service_code:ind_service_code,
                        :v_client_ip:ind_client_ip,
                        :v_ex_supplier:ind_ex_supplier,
                        :v_ex_rate:ind_ex_rate,
                        :v_sub_status:ind_sub_status,
                        :v_display_amt:ind_display_amt,
			:v_deposit_amt:ind_deposit_amt,
			:v_dst_txn_id:ind_dst_txn_id,
			:v_upload_channel:ind_upload_channel,
			:v_multi_match_ind:ind_multi_match_ind;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                iCnt++;

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

                if (ind_org_txn_id >= 0) {
                        v_org_txn_id.arr[v_org_txn_id.len] ='\0';
                        PutField_CString(myHash,"org_txn_id",(const char*)v_org_txn_id.arr);
DEBUGLOG(("GetTxnHeader org_txn_id = [%s]\n",v_org_txn_id.arr));
                }

                if (ind_client_id >= 0) {
                        v_client_id.arr[v_client_id.len] ='\0';
                        PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
DEBUGLOG(("GetTxnHeader client_id = [%s]\n",v_client_id.arr));
                }
                if (ind_status >= 0) {
DEBUGLOG(("GetTxnHeader status = [%c]\n",v_status));
                        PutField_Char(myHash,"status",v_status);
                }

                if (ind_ar_ind >= 0) {
DEBUGLOG(("GetTxnHeader ar_ind = [%c]\n",v_ar_ind));
                        PutField_Char(myHash,"ar_ind",v_ar_ind);
                }

                if (ind_txn_code >= 0) {
                        v_txn_code.arr[v_txn_code.len] ='\0';
                        PutField_CString(myHash,"txn_code",(const char*)v_txn_code.arr);
DEBUGLOG(("GetTxnHeader txn_code = [%s]\n",v_txn_code.arr));
                }

                if (ind_process_code >= 0) {
                        v_process_code.arr[v_process_code.len] ='\0';
                        PutField_CString(myHash,"process_code",(const char*)v_process_code.arr);
DEBUGLOG(("GetTxnHeader process_code = [%s]\n",v_process_code.arr));
                }

                if (ind_process_type >= 0) {
                        v_process_type.arr[v_process_type.len] ='\0';
                        PutField_CString(myHash,"process_type",(const char*)v_process_type.arr);
DEBUGLOG(("GetTxnHeader process_type = [%s]\n",v_process_type.arr));
                }


                if (ind_merchant_id >= 0) {
                        v_merchant_id.arr[v_merchant_id.len] ='\0';
                        PutField_CString(myHash,"merchant_id",(const char*)v_merchant_id.arr);
DEBUGLOG(("GetTxnHeader merchant_id = [%s]\n",v_merchant_id.arr));
                }
                if (ind_merchant_ref >= 0) {
                        v_merchant_ref.arr[v_merchant_ref.len] ='\0';
                        PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetTxnHeader merchant_ref = [%s]\n",v_merchant_ref.arr));
                }

                if (ind_txn_amt < 0)
                        v_txn_amt = 0.0;

                PutField_Double(myHash,"txn_amt",v_txn_amt);

/*DEBUGLOG(("GetTxnHeader txn_amt = [%s]\n",csTmp)); */
DEBUGLOG(("GetTxnHeader txn_amt = [%f]\n",v_txn_amt));

                if (ind_net_amt < 0)
                        v_net_amt = 0.0;


                PutField_Double(myHash,"net_amt",v_net_amt);
DEBUGLOG(("GetTxnHeader net_amt = [%f]\n",v_net_amt));

                if (ind_net_ccy >= 0) {
                        v_net_ccy.arr[v_net_ccy.len] ='\0';
                        PutField_CString(myHash,"net_ccy",(const char*)v_net_ccy.arr);
DEBUGLOG(("GetTxnHeader net_ccy = [%s]\n",v_net_ccy.arr));
                }

                if (ind_transmission_datetime >= 0) {
                        v_transmission_datetime.arr[v_transmission_datetime.len] ='\0';
                        PutField_CString(myHash,"transmission_datetime",(const char*)v_transmission_datetime.arr);
DEBUGLOG(("GetTxnHeader transmission_datetime = [%s]\n",v_transmission_datetime.arr));
                }
                if (ind_local_tm_date >= 0) {
                        v_local_tm_date.arr[v_local_tm_date.len] ='\0';
                        strcpy(csDate,(char*)v_local_tm_date.arr);
                        PutField_CString(myHash,"local_tm_date",(const char*)v_local_tm_date.arr);
DEBUGLOG(("GetTxnHeader local_tm_date = [%s]\n",v_local_tm_date.arr));
                }
                if (ind_local_tm_time >= 0) {
                        v_local_tm_time.arr[v_local_tm_time.len] ='\0';
                        strcpy(csTime,(char*)v_local_tm_time.arr);
                        PutField_CString(myHash,"local_tm_time",(const char*)v_local_tm_time.arr);
DEBUGLOG(("GetTxnHeader local_tm_time = [%s]\n",v_local_tm_time.arr));
                }
                if (ind_tm_date >= 0) {
                        v_tm_date.arr[v_tm_date.len] ='\0';
                        PutField_CString(myHash,"tm_date",(const char*)v_tm_date.arr);
DEBUGLOG(("GetTxnHeader tm_date = [%s]\n",v_tm_date.arr));
                }
                if (ind_tm_time >= 0) {
                        v_tm_time.arr[v_tm_time.len] ='\0';
                        PutField_CString(myHash,"tm_time",(const char*)v_tm_time.arr);
DEBUGLOG(("GetTxnHeader tm_time = [%s]\n",v_tm_time.arr));
                }
                if (ind_internal_code >= 0) {
                        PutField_Int(myHash,"internal_error",v_internal_code);
DEBUGLOG(("GetTxnHeader internal_code = [%d]\n",v_internal_code));
                }
                if (ind_channel_code >= 0) {
                        v_channel_code.arr[v_channel_code.len] ='\0';
                        PutField_CString(myHash,"channel_code",(const char*)v_channel_code.arr);
DEBUGLOG(("GetTxnHeader channel_code = [%s]\n",v_channel_code.arr));
                }


                if (ind_response_code >= 0) {
                        v_response_code.arr[v_response_code.len] ='\0';
                        PutField_CString(myHash,"response_code",(const char*)v_response_code.arr);
DEBUGLOG(("GetTxnHeader response_code = [%s]\n",v_response_code.arr));
                }
                if (ind_host_posting_date >= 0) {
                        v_host_posting_date.arr[v_host_posting_date.len] ='\0';
                        PutField_CString(myHash,"host_posting_date",(const char*)v_host_posting_date.arr);
DEBUGLOG(("GetTxnHeader host_posting_date = [%s]\n",v_host_posting_date.arr));
                }

DEBUGLOG(("GetTxnHeader formation local transmission_datetime\n"));
                strcpy(csDateTime,csDate);
                strcat(csDateTime,csTime);
DEBUGLOG(("GetTxnHeader local_transmission_datetime = [%s]\n",csDateTime));
                PutField_CString(myHash,"local_transmission_datetime",csDateTime);

                if (ind_service_code >= 0) {
                        v_service_code.arr[v_service_code.len] ='\0';
                        PutField_CString(myHash,"service_code",(const char*)v_service_code.arr);
DEBUGLOG(("GetTxnHeader service_code = [%s]\n",v_service_code.arr));
                }

                if (ind_client_ip>= 0) {
                        v_client_ip.arr[v_client_ip.len] ='\0';
                        PutField_CString(myHash,"ip_addr",(const char*)v_client_ip.arr);
DEBUGLOG(("GetTxnHeader client_ip = [%s]\n",v_client_ip.arr));
                }

                if (ind_ex_supplier>= 0) {
DEBUGLOG(("GetTxnHeader ex_supplier = [%c]\n",v_ex_supplier));
                        PutField_Char(myHash,"ex_supplier",v_ex_supplier);
                }

                if (ind_ex_rate < 0)
                        v_ex_rate = 0.0;
DEBUGLOG(("GetTxnHeader ex_rate = [%f]\n",v_ex_rate));
                PutField_Double(myHash,"ex_rate",v_ex_rate);


                if (ind_sub_status>= 0) {
                        v_sub_status.arr[v_sub_status.len] ='\0';
                        PutField_CString(myHash,"sub_status",(const char*)v_sub_status.arr);
DEBUGLOG(("GetTxnHeader sub_status = [%s]\n",v_sub_status.arr));
                }

                if (ind_display_amt < 0)
                        v_display_amt = 0.0;
                PutField_Double(myHash,"display_amt",v_display_amt);
DEBUGLOG(("GetTxnHeader display_amt = [%f]\n",v_display_amt));


                if (ind_deposit_amt < 0)
                        v_deposit_amt = 0.0;
                PutField_Double(myHash,"deposit_amt",v_deposit_amt);
DEBUGLOG(("GetTxnHeader deposit_amt = [%f]\n",v_deposit_amt));


                if (ind_dst_txn_id >= 0) {
                        v_dst_txn_id.arr[v_dst_txn_id.len] ='\0';
                        PutField_CString(myHash,"dst_txn_id",(const char*)v_dst_txn_id.arr);
DEBUGLOG(("GetTxnHeader dst_txn_id = [%s]\n",v_dst_txn_id.arr));
                }

		if (ind_upload_channel >= 0) {
			PutField_Int(myHash, "upload_channel", v_upload_channel);
DEBUGLOG(("GetTxnHeader upload_channel = [%d]\n", v_upload_channel));
		}

		if (ind_multi_match_ind >= 0) {
			PutField_Int(myHash, "multi_match_ind", v_multi_match_ind);
DEBUGLOG(("GetTxnHeader multi_match_ind = [%d]\n", v_multi_match_ind));
		}

                RecordSet_Add(myRec,myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getoltxnheader;


        if (iCnt > 0 ) {
DEBUGLOG(("GetTxnHeader Normal Exit\n"));
                return  PD_OK;
        }
        else {
DEBUGLOG(("GetTxnHeader Normal Exit, Not Found\n"));
                return PD_ERR;
        }

gettxnheader_error:
DEBUGLOG(("gettxnheader_error code %d\n", sqlca.sqlcode));
ERRLOG("OLTransaction::gettxnheader_error code %d\n", sqlca.sqlcode);
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getoltxnheader;
        return PD_ERR;
}


int GetTxnDetail(const char* csTxnID,
                recordset_t* myRec)
{

        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO getoltxndetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];

                varchar         v_txn_ccy[PD_CCY_ID_LEN + 1];
                varchar         v_txn_country[PD_COUNTRY_LEN + 1];
                varchar         v_pay_method[PD_PAY_METHOD_LIST_LEN+ 1];
                varchar         v_bank_code[PD_BANK_CODE_LEN + 1];
                varchar         v_language[PD_LANGUAGE_LEN + 1];
                varchar         v_success_url[PD_URL_LEN + 1];
                varchar         v_failure_url[PD_URL_LEN + 1];
                varchar         v_success_ck_url[PD_URL_LEN + 1];
                varchar         v_failure_ck_url[PD_URL_LEN + 1];
                varchar         v_encrypt_type[PD_ENCRYPT_LEN + 1];
                varchar         v_bank_name[PD_AC_BANK_NAME_LEN + 1];
                varchar         v_branch[PD_BANK_BRANCH_LEN + 1];
                varchar         v_account_id[PD_AC_NO_LEN + 1];
                varchar         v_account_name[PD_AC_NAME_LEN + 1];
                varchar         v_batch_id[PD_BATCH_LEN + 1];
                varchar         v_identity_id[PD_IDENTITY_ID_LEN + 1];
                varchar         v_remark[PD_REMARK_LEN + 1];
                varchar         v_selected_pay_method[PD_SELECTED_PAY_METHOD_LEN + 1];
                varchar         v_banner_logo[PD_BANNER_LOGO_LEN + 1];
                varchar         v_echo_msg_1[PD_ECHO_MSG_LEN + 1];
                varchar         v_echo_msg_2[PD_ECHO_MSG_LEN + 1];
                varchar         v_echo_msg_3[PD_ECHO_MSG_LEN + 1];
                varchar         v_opt_1[PD_OPT_LEN + 1];
                varchar         v_opt_2[PD_OPT_LEN + 1];
                varchar         v_opt_3[PD_OPT_LEN + 1];
                varchar		v_bank_acct_num[PD_BANK_ACCT_NUM_LEN + 1];
		varchar		v_cust_deposit_datetime[PD_DATETIME_LEN + 1];
		varchar		v_bank_deposit_datetime[PD_DATETIME_LEN + 1];
		varchar		v_deposit_bank_code[PD_AC_BANK_LEN + 1];
		varchar		v_deposit_ref[PD_DEPOSITOR_PROV_REF_LEN + 1];


                short           ind_txn_ccy = -1;
                short           ind_txn_country = -1;
                short           ind_pay_method = -1;
                short           ind_bank_code = -1;
                short           ind_language = -1;
                short           ind_success_url = -1;
                short           ind_failure_url = -1;
                short           ind_success_ck_url = -1;
                short           ind_failure_ck_url = -1;
                short           ind_encrypt_type = -1;
                short           ind_bank_name = -1;
                short           ind_branch= -1;
                short           ind_account_id= -1;
                short           ind_account_name= -1;
                short           ind_batch_id= -1;
                short           ind_identity_id= -1;
                short           ind_remark = -1;
                short           ind_selected_pay_method = -1;
                short           ind_banner_logo = -1;
                short           ind_echo_msg_1 = -1;
                short           ind_echo_msg_2 = -1;
                short           ind_echo_msg_3 = -1;
                short           ind_opt_1 = -1;
                short           ind_opt_2 = -1;
                short           ind_opt_3 = -1;
                short           ind_bank_acct_num = -1;
		short		ind_cust_deposit_datetime = -1;
		short		ind_bank_deposit_datetime = -1;
		short		ind_deposit_bank_code = -1;
		short		ind_deposit_ref = -1;
        EXEC SQL END DECLARE SECTION;

        hv_txn_id.len = strlen(csTxnID);
        memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetTxnDetail txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_getoltxndetail CURSOR FOR
                select
                        otd_txn_ccy,
                        otd_txn_country,
                        otd_pay_method,
                        otd_bank_code,
                        otd_language,
                        otd_success_url,
                        otd_failure_url,
                        otd_success_callback_url,
                        otd_failure_callback_url,
                        otd_encrypt_type,
                        otd_bank_name,
                        otd_branch_name,
                        otd_account_id,
                        otd_account_name,
                        otd_batch_id,
                        otd_identity_id,
                        otd_remark,
                        otd_selected_pay_method,
                        otd_banner_logo,
                        otd_echo_msg_1,
                        otd_echo_msg_2,
                        otd_echo_msg_3,
                        otd_opt_1,
                        otd_opt_2,
                        otd_opt_3,
			otd_bank_acct_num,
			otd_cust_deposit_datetime,
			otd_bank_deposit_datetime,
			otd_deposit_bank_code,
			otd_deposit_ref
                  from ol_txn_detail
                 where otd_txn_id = :hv_txn_id;


        EXEC SQL OPEN c_cursor_getoltxndetail;
        do {
                EXEC SQL FETCH c_cursor_getoltxndetail
                INTO
                        :v_txn_ccy:ind_txn_ccy,
                        :v_txn_country:ind_txn_country,
                        :v_pay_method:ind_pay_method,
                        :v_bank_code:ind_bank_code,
                        :v_language:ind_language,
                        :v_success_url:ind_success_url,
                        :v_failure_url:ind_failure_url,
                        :v_success_ck_url:ind_success_ck_url,
                        :v_failure_ck_url:ind_failure_ck_url,
                        :v_encrypt_type:ind_encrypt_type,
                        :v_bank_name:ind_bank_name,
                        :v_branch:ind_branch,
                        :v_account_id:ind_account_id,
                        :v_account_name:ind_account_name,
                        :v_batch_id:ind_batch_id,
                        :v_identity_id:ind_identity_id,
                        :v_remark:ind_remark,
                        :v_selected_pay_method:ind_selected_pay_method,
                        :v_banner_logo:ind_banner_logo,
                        :v_echo_msg_1:ind_echo_msg_1,
                        :v_echo_msg_2:ind_echo_msg_2,
                        :v_echo_msg_3:ind_echo_msg_3,
                        :v_opt_1:ind_opt_1,
                        :v_opt_2:ind_opt_2,
                        :v_opt_3:ind_opt_3,
                        :v_bank_acct_num:ind_bank_acct_num,
			:v_cust_deposit_datetime:ind_cust_deposit_datetime,
			:v_bank_deposit_datetime:ind_bank_deposit_datetime,
			:v_deposit_bank_code:ind_deposit_bank_code,
			:v_deposit_ref:ind_deposit_ref;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);


/* txn ccy */
                if (ind_txn_ccy  >=  0) {
                        v_txn_ccy.arr[v_txn_ccy.len] = '\0';
                        PutField_CString(myHash,"txn_ccy",(const char*)v_txn_ccy.arr);
DEBUGLOG(("GetTxnDetail txn_ccy = [%s]\n",v_txn_ccy.arr));
                }

/* txn country */
                if (ind_txn_country  >=  0) {
                        v_txn_country.arr[v_txn_ccy.len] = '\0';
                        PutField_CString(myHash,"txn_country",(const char*)v_txn_country.arr);
DEBUGLOG(("GetTxnDetail txn_country = [%s]\n",v_txn_country.arr));
                }

/* pay method */
                if (ind_pay_method  >=  0) {
                        v_pay_method.arr[v_pay_method.len] = '\0';
                        PutField_CString(myHash,"pay_method",(const char*)v_pay_method.arr);
DEBUGLOG(("GetTxnDetail pay_method = [%s]\n",v_pay_method.arr));
                }

/* bank code */
                if (ind_bank_code  >=  0) {
                        v_bank_code.arr[v_bank_code.len] = '\0';
                        PutField_CString(myHash,"bank_code",(const char*)v_bank_code.arr);
DEBUGLOG(("GetTxnDetail bank_code = [%s]\n",v_bank_code.arr));
                }

/* bank_acct_num */
                if (ind_bank_acct_num>=  0) {
                        v_bank_acct_num.arr[v_bank_acct_num.len] = '\0';
                        PutField_CString(myHash,"bank_acct_num",(const char*)v_bank_acct_num.arr);
DEBUGLOG(("GetTxnDetail bank_acct_num = [%s]\n",v_bank_acct_num.arr));
                }


/* language */
                if (ind_language  >=  0) {
                        v_language.arr[v_language.len] = '\0';
                        PutField_CString(myHash,"language",(const char*)v_language.arr);
DEBUGLOG(("GetTxnDetail language = [%s]\n",v_language.arr));
                }

/* success url */
                if (ind_success_url  >=  0) {
                        v_success_url.arr[v_success_url.len] = '\0';
                        PutField_CString(myHash,"success_url",(const char*)v_success_url.arr);
DEBUGLOG(("GetTxnDetail success_url = [%s]\n",v_success_url.arr));
                }

/* failure url */
                if (ind_failure_url  >=  0) {
                        v_failure_url.arr[v_failure_url.len] = '\0';
                        PutField_CString(myHash,"failure_url",(const char*)v_failure_url.arr);
DEBUGLOG(("GetTxnDetail failure_url = [%s]\n",v_failure_url.arr));
                }

/* success callback url */
                if (ind_success_ck_url  >=  0) {
                        v_success_ck_url.arr[v_success_ck_url.len] = '\0';
                        PutField_CString(myHash,"success_callback_url",(const char*)v_success_ck_url.arr);
DEBUGLOG(("GetTxnDetail success_callback_url = [%s]\n",v_success_ck_url.arr));
                }

/* failure callback_url */
                if (ind_failure_ck_url  >=  0) {
                        v_failure_ck_url.arr[v_failure_ck_url.len] = '\0';
                        PutField_CString(myHash,"failure_callback_url",(const char*)v_failure_ck_url.arr);
DEBUGLOG(("GetTxnDetail failure_ck_url = [%s]\n",v_failure_ck_url.arr));
                }

/* encrypt_type*/
                if (ind_encrypt_type >=  0) {
                        v_encrypt_type.arr[v_encrypt_type.len] = '\0';
                        PutField_CString(myHash,"encrypt_type",(const char*)v_encrypt_type.arr);
DEBUGLOG(("GetTxnDetail encrypt_type = [%s]\n",v_encrypt_type.arr));
                }

/* bank_name*/
                if (ind_bank_name >= 0) {
                        v_bank_name.arr[v_bank_name.len] = '\0';
                        PutField_CString(myHash,"bank_name",(const char*)v_bank_name.arr);
DEBUGLOG(("GetTxnDetail bank_name = [%s]\n",v_bank_name.arr));
                }

/* branch_name */
                if (ind_branch>=  0) {
                        v_branch.arr[v_branch.len] = '\0';
                        PutField_CString(myHash,"branch",(const char*)v_branch.arr);
DEBUGLOG(("GetTxnDetail branch= [%s]\n",v_branch.arr));
                }

/* account_id*/
                if (ind_account_id>=  0) {
                        v_account_id.arr[v_account_id.len] = '\0';
                        PutField_CString(myHash,"account_id",(const char*)v_account_id.arr);
DEBUGLOG(("GetTxnDetail account_id = [%s]\n",v_account_id.arr));
                }

/* account_name*/
                if (ind_account_name>=  0) {
                        v_account_name.arr[v_account_name.len] = '\0';
                        PutField_CString(myHash,"account_name",(const char*)v_account_name.arr);
DEBUGLOG(("GetTxnDetail account_name = [%s]\n",v_account_name.arr));
                }

/* batch_id*/
                if (ind_batch_id>=  0) {
                        v_batch_id.arr[v_batch_id.len] = '\0';
                        PutField_CString(myHash,"batch_id",(const char*)v_batch_id.arr);
DEBUGLOG(("GetTxnDetail batch_id = [%s]\n",v_batch_id.arr));
                }

/* identity_id*/
                if (ind_identity_id>=  0) {
                        v_identity_id.arr[v_identity_id.len] = '\0';
                        PutField_CString(myHash,"identity_id",(const char*)v_identity_id.arr);
DEBUGLOG(("GetTxnDetail identity_i d= [%s]\n",v_identity_id.arr));
                }


/* remark*/
                if (ind_remark>=  0) {
                        v_remark.arr[v_remark.len] = '\0';
                        PutField_CString(myHash,"remark",(const char*)v_remark.arr);
DEBUGLOG(("GetTxnDetail remark d= [%s]\n",v_remark.arr));
                }

/* selected pay method */
                if (ind_selected_pay_method  >=  0) {
                        v_selected_pay_method.arr[v_selected_pay_method.len] = '\0';
                        PutField_CString(myHash,"selected_pay_method",(const char*)v_selected_pay_method.arr);
DEBUGLOG(("GetTxnDetail selected_pay_method = [%s]\n",v_selected_pay_method.arr));
                }
/*banner_logo */
                if (ind_banner_logo>=  0) {
                        v_banner_logo.arr[v_banner_logo.len] = '\0';
                        PutField_CString(myHash,"banner_logo",(const char*)v_banner_logo.arr);
DEBUGLOG(("GetTxnDetail banner_logo = [%s]\n",v_banner_logo.arr));
                }

/* echo_msg*/
                if (ind_echo_msg_1>=  0) {
                        v_echo_msg_1.arr[v_echo_msg_1.len] = '\0';
                        PutField_CString(myHash,"echo_msg_1",(const char*)v_echo_msg_1.arr);
DEBUGLOG(("GetTxnDetail echo_msg_1 = [%s]\n",v_echo_msg_1.arr));
                }

/* echo_msg*/
                if (ind_echo_msg_2>=  0) {
                        v_echo_msg_2.arr[v_echo_msg_2.len] = '\0';
                        PutField_CString(myHash,"echo_msg_2",(const char*)v_echo_msg_2.arr);
DEBUGLOG(("GetTxnDetail echo_msg_2 = [%s]\n",v_echo_msg_2.arr));
                }


/* echo_msg*/
                if (ind_echo_msg_3>=  0) {
                        v_echo_msg_3.arr[v_echo_msg_3.len] = '\0';
                        PutField_CString(myHash,"echo_msg_3",(const char*)v_echo_msg_3.arr);
DEBUGLOG(("GetTxnDetail echo_msg_3 = [%s]\n",v_echo_msg_3.arr));
                }

/* opt*/
                if (ind_opt_1>=  0) {
                        v_opt_1.arr[v_opt_1.len] = '\0';
                        PutField_CString(myHash,"opt_1",(const char*)v_opt_1.arr);
DEBUGLOG(("GetTxnDetail opt_1 = [%s]\n",v_opt_1.arr));
                }

/* opt*/
                if (ind_opt_2>=  0) {
                        v_opt_2.arr[v_opt_2.len] = '\0';
                        PutField_CString(myHash,"opt_2",(const char*)v_opt_2.arr);
DEBUGLOG(("GetTxnDetail opt_2 = [%s]\n",v_opt_2.arr));
                }

/* opt*/
                if (ind_opt_3>=  0) {
                        v_opt_3.arr[v_opt_3.len] = '\0';
                        PutField_CString(myHash,"opt_3",(const char*)v_opt_3.arr);
DEBUGLOG(("GetTxnDetail opt_3 = [%s]\n",v_opt_3.arr));
                }

/* cust_deposit_datetime */
		if (ind_cust_deposit_datetime >= 0) {
			v_cust_deposit_datetime.arr[v_cust_deposit_datetime.len] = '\0';
			PutField_CString(myHash, "cust_deposit_datetime", (const char*)v_cust_deposit_datetime.arr);
DEBUGLOG(("GetTxnDetail cust_deposit_datetime = [%s]\n", v_cust_deposit_datetime.arr));
		}

/* bank_deposit_datetime */
		if (ind_bank_deposit_datetime >= 0) {
			v_bank_deposit_datetime.arr[v_bank_deposit_datetime.len] = '\0';
			PutField_CString(myHash, "bank_deposit_datetime", (const char*)v_bank_deposit_datetime.arr);
DEBUGLOG(("GetTxnDetail bank_deposit_datetime = [%s]\n", v_bank_deposit_datetime.arr));
		}

/* deposit_bank_code */
		if (ind_deposit_bank_code >= 0) {
			v_deposit_bank_code.arr[v_deposit_bank_code.len] = '\0';
			PutField_CString(myHash, "deposit_bank_code", (const char*)v_deposit_bank_code.arr);
DEBUGLOG(("GetTxnDetail deposit_bank_code = [%s]\n", v_deposit_bank_code.arr));
		}

/* deposit_ref */
		if (ind_deposit_ref >= 0) {
			v_deposit_ref.arr[v_deposit_ref.len] = '\0';
			PutField_CString(myHash, "deposit_ref", (const char*)v_deposit_ref.arr);
DEBUGLOG(("GetTxnDetail deposit_ref = [%s]\n", v_deposit_ref.arr));
		}

                RecordSet_Add(myRec,myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getoltxndetail;


DEBUGLOG(("GetTxnDetail Normal Exit\n"));
        return  PD_OK;

getoltxndetail_error:
DEBUGLOG(("getoltxndetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getoltxndetail;
        return PD_ERR;
}


int MatchRespTxn(const char* csTxnSeq,
                     const char cStatus)
{
        EXEC SQL WHENEVER SQLERROR GOTO MatchRespTxn_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
    
        EXEC SQL BEGIN DECLARE SECTION;
                //short           hv_return_value;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];
                char            hv_status;

                varchar         v_date[PD_DATE_LEN+1];

                short           ind_date = -1;
    
        EXEC SQL END DECLARE SECTION;

        hv_txn_id.len = strlen(csTxnSeq);
        memcpy(hv_txn_id.arr,csTxnSeq,hv_txn_id.len);
DEBUGLOG(("MatchRespTxn txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
    
        hv_status = cStatus;
DEBUGLOG(("MatchRespTxn status = [%c]\n",hv_status));

        EXEC SQL SELECT oth_host_posting_date
                INTO    :v_date:ind_date
                FROM    ol_txn_header
                WHERE   oth_txn_id = :hv_txn_id
                and     oth_status = :hv_status
                for update;


        if(ind_date>=0){
DEBUGLOG(("MatchRespTxn Found\n"));
                return PD_FOUND;
        }
        else {
DEBUGLOG(("MatchRespTxn Not Found\n"));
                return PD_NOT_FOUND;
        }


MatchRespTxn_error:
DEBUGLOG(("MatchRespTxn_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}



int MatchRespTxnReadOnly(const char* csTxnSeq,
                     const char cStatus)
{
        EXEC SQL WHENEVER SQLERROR GOTO MatchRespTxnReadOnly_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                //short           hv_return_value;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];
                char            hv_status;

                varchar         v_date[PD_DATE_LEN+1];

                short           ind_date = -1;

        EXEC SQL END DECLARE SECTION;

        hv_txn_id.len = strlen(csTxnSeq);
        memcpy(hv_txn_id.arr,csTxnSeq,hv_txn_id.len);
DEBUGLOG(("MatchRespTxnReadOnly txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        hv_status = cStatus;
DEBUGLOG(("MatchRespTxnReadOnly status = [%c]\n",hv_status));

        EXEC SQL SELECT oth_host_posting_date
                INTO    :v_date:ind_date
                FROM    ol_txn_header
                WHERE   oth_txn_id = :hv_txn_id
                and     oth_status = :hv_status;


        if(ind_date>=0){
DEBUGLOG(("MatchRespTxnReadOnly Found\n"));
                return PD_FOUND;
        }
        else {
DEBUGLOG(("MatchRespTxnReadOnly Not Found\n"));
                return PD_NOT_FOUND;
        }


MatchRespTxnReadOnly_error:
DEBUGLOG(("MatchRespTxnReadOnly_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int CheckUniqueAmt(hash_t* hRls,
		   recordset_t* myRec)
{
	char*	csTmp;
	double	dTmp;
	int	iTmp;
	int	iCnt = 0;
	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO CheckUniqueAmt_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
    
        EXEC SQL BEGIN DECLARE SECTION;
                varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar		hv_txn_code[PD_TXN_CODE_LEN];
                //varchar		hv_bank_code[PD_AC_BANK_LEN];
                //varchar		hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
                double		hv_from_amt;
                double		hv_to_amt;
                int		hv_check_interval;

                double		v_have_amt;

                short           ind_have_amt = -1;
    
        EXEC SQL END DECLARE SECTION;

	if(GetField_CString(hRls,"merchant_id",&csTmp)){
		hv_merchant_id.len = strlen(csTmp);
		memcpy(hv_merchant_id.arr,csTmp,hv_merchant_id.len);
DEBUGLOG(("CheckUniqueAmt merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
    	}
	
	if(GetField_CString(hRls,"txn_code",&csTmp)){
		hv_txn_code.len = strlen(csTmp);
		memcpy(hv_txn_code.arr,csTmp,hv_txn_code.len);
DEBUGLOG(("CheckUniqueAmt txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));
    	}
/*	
	if(GetField_CString(hRls,"bank_code",&csTmp)){
		hv_bank_code.len = strlen(csTmp);
		memcpy(hv_bank_code.arr,csTmp,hv_bank_code.len);
DEBUGLOG(("CheckUniqueAmt bank_code = [%.*s]\n",hv_bank_code.len,hv_bank_code.arr));
    	}
	
	if(GetField_CString(hRls,"bank_acct_num",&csTmp)){
		hv_bank_acct_num.len = strlen(csTmp);
		memcpy(hv_bank_acct_num.arr,csTmp,hv_bank_acct_num.len);
DEBUGLOG(("CheckUniqueAmt bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));
    	}
*/	
	if(GetField_Double(hRls,"from_amt",&dTmp)){
		hv_from_amt = dTmp;
DEBUGLOG(("CheckUniqueAmt from amount = [%lf]\n",hv_from_amt));
	}

	if(GetField_Double(hRls,"to_amt",&dTmp)){
		hv_to_amt = dTmp;
DEBUGLOG(("CheckUniqueAmt to amount = [%lf]\n",hv_to_amt));
	}

	if(GetField_Int(hRls,"check_interval",&iTmp)){
		hv_check_interval = iTmp;
DEBUGLOG(("CheckUniqueAmt check_interval = [%d]\n",iTmp));
	}

        EXEC SQL DECLARE c_cursor_checkunique CURSOR FOR
		select	oth_display_amount
                FROM	
			(select oth_display_amount,
				oth_txn_id
			from	ol_txn_header
			where	oth_display_amount between :hv_from_amt and :hv_to_amt
			and	oth_txn_code = :hv_txn_code
			and	oth_merchant_id = :hv_merchant_id
			and	oth_create_timestamp between sysdate - (:hv_check_interval/24) and sysdate)//,
			
			/*(select otd_txn_id
			from	ol_txn_detail
			where	otd_bank_code = :hv_bank_code
			and	otd_bank_acct_num = :hv_bank_acct_num
			and     otd_create_timestamp between sysdate - (:hv_check_interval/24) and sysdate)
		WHERE	oth_txn_id = otd_txn_id*/
		order by oth_display_amount;

	
        EXEC SQL OPEN c_cursor_checkunique;
        do {
                EXEC SQL FETCH c_cursor_checkunique
                INTO
                        :v_have_amt:ind_have_amt;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

                if (ind_have_amt < 0)
                        v_have_amt = 0.0;
                PutField_Double(myHash,"have_amt",v_have_amt);

		iCnt++;

		RecordSet_Add(myRec,myHash);

	}while(PD_TRUE);

	PutField_Int(hRls,"count",iCnt);

	EXEC SQL CLOSE c_cursor_checkunique;

DEBUGLOG(("CheckUniqueAmt Normal Exit\n"));
        return  PD_OK;

CheckUniqueAmt_error:
DEBUGLOG(("CheckUniqueAmt_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_checkunique;
        return PD_ERR;
}

int FindOldestUniqueAmt(hash_t* hRls)
{
	char*	csTmp;
	double	dTmp;
	int	iTmp;

        EXEC SQL WHENEVER SQLERROR GOTO FindOldestUniqueAmt_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
    
        EXEC SQL BEGIN DECLARE SECTION;
                varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar		hv_txn_code[PD_TXN_CODE_LEN];
                double		hv_from_amt;
                double		hv_to_amt;
                int		hv_check_interval;

                double		v_oldest_amt;

                short           ind_oldest_amt = -1;
    
        EXEC SQL END DECLARE SECTION;

	if(GetField_CString(hRls,"merchant_id",&csTmp)){
		hv_merchant_id.len = strlen(csTmp);
		memcpy(hv_merchant_id.arr,csTmp,hv_merchant_id.len);
DEBUGLOG(("FindOldestUniqueAmt merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
    	}
	
	if(GetField_CString(hRls,"txn_code",&csTmp)){
		hv_txn_code.len = strlen(csTmp);
		memcpy(hv_txn_code.arr,csTmp,hv_txn_code.len);
DEBUGLOG(("FindOldestUniqueAmt txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));
    	}
	
	if(GetField_Double(hRls,"from_amt",&dTmp)){
		hv_from_amt = dTmp;
DEBUGLOG(("FindOldestUniqueAmt from amount = [%lf]\n",hv_from_amt));
	}

	if(GetField_Double(hRls,"to_amt",&dTmp)){
		hv_to_amt = dTmp;
DEBUGLOG(("FindOldestUniqueAmt to amount = [%lf]\n",hv_to_amt));
	}

	if(GetField_Int(hRls,"check_interval",&iTmp)){
		hv_check_interval = iTmp;
DEBUGLOG(("FindOldestUniqueAmt check_interval = [%d]\n",iTmp));
	}

        EXEC SQL select oth_display_amount
		 into	:v_oldest_amt:ind_oldest_amt
		 from
			(select	oth_display_amount
                	FROM	ol_txn_header
			where	oth_display_amount between :hv_from_amt and :hv_to_amt
			and	oth_txn_code = :hv_txn_code
			and	oth_merchant_id = :hv_merchant_id
			and	oth_create_timestamp between sysdate - (:hv_check_interval/24) and sysdate
			order by oth_create_timestamp)
		where	rownum <= 1;

	
                if (ind_oldest_amt < 0)
                        v_oldest_amt = 0.0;
                PutField_Double(hRls,"oldest_amt",v_oldest_amt);

DEBUGLOG(("FindOldestUniqueAmt Normal Exit\n"));
        return  PD_OK;

FindOldestUniqueAmt_error:
DEBUGLOG(("FindOldestUniqueAmt_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int MatchStmt(const hash_t* hMatchValue, const hash_t* hMatchBfAf, recordset_t* rMatchResult)
{
	int iRet = PD_OK;

	hash_t *myHash;

	char *csTmp;
	char csTmp2[PD_DATETIME_LEN];
	int iTmp, iFieldCnt;
	char *csBuf = strdup("");
	int iCnt = 0;

	EXEC SQL WHENEVER SQLERROR GOTO matchstmt_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_dynstmt[PD_MAX_BUFFER];

		varchar v_txn_id[PD_TXN_SEQ_LEN + 1];
		varchar v_cust_deposit_datetime[PD_DATETIME_LEN + 1];
		varchar v_deposit_ref[PD_DEPOSITOR_PROV_REF_LEN + 1];

		short ind_txn_id = -1;
		short ind_cust_deposit_datetime = -1;
		short ind_deposit_ref = -1;
	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("MatchStmt: Begin\n"));
	strcpy((char*)hv_dynstmt.arr, "select oth_txn_id, otd_cust_deposit_datetime, otd_deposit_ref from ol_txn_header, ol_txn_detail where oth_txn_id = otd_txn_id and oth_input_channel = 'OLN' and oth_status = 'W' and oth_txn_code = 'ODI'");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

/* merchant_id (compulsory) */
	if (GetField_CString(hMatchValue, "merchant_id", &csTmp)) {
		strcat((char*)hv_dynstmt.arr, " and oth_merchant_id = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* service_code (compulsory) */
	if (GetField_CString(hMatchValue, "service_code", &csTmp)) {
		strcat((char*)hv_dynstmt.arr, " and oth_service_code = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* txn_ccy (compulsory) */
	if (GetField_CString(hMatchValue, "txn_ccy", &csTmp)) {
		strcat((char*)hv_dynstmt.arr, " and otd_txn_ccy = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* txn_country (compulsory) */
	if (GetField_CString(hMatchValue, "txn_country", &csTmp)) {
		strcat((char*)hv_dynstmt.arr, " and otd_txn_country = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}
			
/* customer_text */
	if (GetField_CString(hMatchValue, "customer_text", &csTmp)) {
		iCnt++;
		strcat((char*)hv_dynstmt.arr, " and otd_deposit_ref = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* bank_code */
	if (GetField_CString(hMatchValue, "bank_code", &csTmp)) {
		iCnt++;
		strcat((char*)hv_dynstmt.arr, " and otd_bank_code = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* bank_acct_num */
	if (GetField_CString(hMatchValue, "bank_acct_num", &csTmp)) {
		iCnt++;
		strcat((char*)hv_dynstmt.arr, " and otd_bank_acct_num = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* txn_timestamp */
	if (GetField_CString(hMatchValue, "txn_timestamp", &csTmp)) {
		iCnt++;

		strncpy(csTmp2, csTmp, 12);
		csTmp2[12] = '\0';

		// onus
		strcat((char*)hv_dynstmt.arr, " and (((otd_deposit_bank_code = otd_bank_code) and (to_date('");
		strcat((char*)hv_dynstmt.arr, csTmp2);
		strcat((char*)hv_dynstmt.arr, "', 'yyyymmddhh24mi') >= to_date(otd_cust_deposit_datetime, 'yyyymmddhh24mi') - ");
		GetField_Int(hMatchBfAf, "onus_bf_mins", &iTmp);
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, csBuf);
		strcat((char*)hv_dynstmt.arr, " / 60 / 24) and (to_date('");
		strcat((char*)hv_dynstmt.arr, csTmp2);
		strcat((char*)hv_dynstmt.arr, "', 'yyyymmddhh24mi') <= to_date(otd_cust_deposit_datetime, 'yyyymmddhh24mi') + ");
		GetField_Int(hMatchBfAf, "onus_af_mins", &iTmp);
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, csBuf);
		strcat((char*)hv_dynstmt.arr, " / 60 / 24))");

		// offus
		strcat((char*)hv_dynstmt.arr, " or ((otd_deposit_bank_code <> otd_bank_code) and (to_date('");
		strcat((char*)hv_dynstmt.arr, csTmp2);
		strcat((char*)hv_dynstmt.arr, "', 'yyyymmddhh24mi') >= to_date(otd_cust_deposit_datetime, 'yyyymmddhh24mi') - ");
		GetField_Int(hMatchBfAf, "offus_bf_mins", &iTmp);
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, csBuf);
		strcat((char*)hv_dynstmt.arr, " / 60 / 24) and (to_date('");
		strcat((char*)hv_dynstmt.arr, csTmp2);
		strcat((char*)hv_dynstmt.arr, "', 'yyyymmddhh24mi') <= to_date(otd_cust_deposit_datetime, 'yyyymmddhh24mi') + ");
		GetField_Int(hMatchBfAf, "offus_af_mins", &iTmp);
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, csBuf);
		strcat((char*)hv_dynstmt.arr, " / 60 / 24)))");
	}

/* txn_amount */
	if (GetField_CString(hMatchValue, "txn_amount", &csTmp)) {
		iCnt++;
		strcat((char*)hv_dynstmt.arr, " and oth_deposit_amount = to_number('");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "')");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

DEBUGLOG(("MatchStmt: [%.*s]\n", hv_dynstmt.len, hv_dynstmt.arr));

	GetField_Int(hMatchValue, "field_cnt", &iFieldCnt);
	if (iCnt == iFieldCnt) {
DEBUGLOG(("MatchStmt enough match field\n"));
		EXEC SQL PREPARE s1 FROM :hv_dynstmt;
		EXEC SQL DECLARE c_cursor CURSOR FOR s1;

		EXEC SQL OPEN c_cursor;
		for (;;) {
			EXEC SQL FETCH c_cursor
			INTO	:v_txn_id:ind_txn_id,
				:v_cust_deposit_datetime:ind_cust_deposit_datetime,
				:v_deposit_ref:ind_deposit_ref;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash, 0);

			// txn_id
			if (ind_txn_id >= 0) {
				v_txn_id.arr[v_txn_id.len] = '\0';
				PutField_CString(myHash, "txn_id", (const char*)v_txn_id.arr);
DEBUGLOG(("MatchStmt: txn_id = [%s]\n", (const char*)v_txn_id.arr));
			}

			// cust_deposit_datetime
			if (ind_cust_deposit_datetime >= 0) {
				v_cust_deposit_datetime.arr[v_cust_deposit_datetime.len] = '\0';
				PutField_CString(myHash, "cust_deposit_datetime", (const char*)v_cust_deposit_datetime.arr);
DEBUGLOG(("MatchStmt: cust_deposit_datetime = [%s]\n", (const char*)v_cust_deposit_datetime.arr));
			}

			// deposit_ref
			if (ind_deposit_ref >= 0) {
				v_deposit_ref.arr[v_deposit_ref.len] = '\0';
				PutField_CString(myHash, "deposit_ref", (const char*)v_deposit_ref.arr);
DEBUGLOG(("MatchStmt: deposit_ref = [%s]\n", (const char*)v_deposit_ref.arr));
			}

			RecordSet_Add(rMatchResult, myHash);
		}
		EXEC SQL CLOSE c_cursor;
	} else {
DEBUGLOG(("MatchStmt not enough match field\n"));
	}

DEBUGLOG(("MatchStmt Normal Exit! iRet = [%d]\n", iRet));
	return iRet;

matchstmt_error:
DEBUGLOG(("matchstmt_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTransaction matchstmt_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor;
	return PD_ERR;
}

int     ChkTxnCodeExist(const char *csTxnCode)
{
        int     iRet = PD_NOT_FOUND;

        EXEC SQL WHENEVER SQLERROR GOTO chktxncodeexist_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_code[PD_TXN_CODE_LEN];

                int             v_no_of_record;
                short           ind_no_of_record = -1;
        EXEC SQL END DECLARE SECTION;

        hv_txn_code.len = strlen(csTxnCode);
        memcpy(hv_txn_code.arr, csTxnCode, hv_txn_code.len);
DEBUGLOG(("ChkTxnCodeExist = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));

        EXEC SQL
                SELECT count(1)
                   INTO :v_no_of_record:ind_no_of_record
                   FROM ol_txn_header
                  WHERE oth_txn_code = :hv_txn_code
                    and rownum = 1;

        if (ind_no_of_record >= 0) {
                if (v_no_of_record > 0) {
DEBUGLOG(("ChkTxnCodeExist FOUND\n"));
                        iRet = PD_FOUND;
                }
        }

        if (iRet!= PD_FOUND) {
DEBUGLOG(("ChkTxnCodeExist NOT FOUND\n"));
        }


        return iRet;

chktxncodeexist_error:
DEBUGLOG(("ChkTxnCodeExist_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;

}

int GetTxnIdForUpdate(const char* csTxnId) {
	int iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO gettxnidforupdate_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_txn_id[PD_TXN_SEQ_LEN];
		varchar v_txn_id[PD_TXN_SEQ_LEN + 1];
		short ind_txn_id = -1;
	EXEC SQL END DECLARE SECTION;

	hv_txn_id.len = strlen(csTxnId);
	memcpy(hv_txn_id.arr, csTxnId, hv_txn_id.len);
DEBUGLOG(("GetTxnIdForUpdate txn_id = [%.*s]\n", hv_txn_id.len, hv_txn_id.arr));

	EXEC SQL select oth_txn_id
		into :v_txn_id:ind_txn_id
		from ol_txn_header
		where oth_txn_id = :hv_txn_id
		for update;

	if (ind_txn_id >= 0) {
		iRet = PD_OK;
	} else {
		iRet = PD_ERR;
	}

	return iRet;

gettxnidforupdate_error:
DEBUGLOG(("gettxnidforupdate_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}

int GetTxnIdForUpdateNoWait(const char* csTxnId) {
	int iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO gettxnidforupdatenowait_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_txn_id[PD_TXN_SEQ_LEN];
		varchar v_txn_id[PD_TXN_SEQ_LEN + 1];
		short ind_txn_id = -1;
	EXEC SQL END DECLARE SECTION;

	hv_txn_id.len = strlen(csTxnId);
	memcpy(hv_txn_id.arr, csTxnId, hv_txn_id.len);
DEBUGLOG(("GetTxnIdForUpdateNoWait txn_id = [%.*s]\n", hv_txn_id.len, hv_txn_id.arr));

	EXEC SQL select oth_txn_id
		into :v_txn_id:ind_txn_id
		from ol_txn_header
		where oth_txn_id = :hv_txn_id
		for update nowait;

	if (ind_txn_id >= 0) {
		iRet = PD_OK;
	} else {
		iRet = PD_ERR;
	}

	return iRet;

gettxnidforupdatenowait_error:
DEBUGLOG(("gettxnidforupdatenowait_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}

/* hContext: int_bank_code, bank_acct_num, stmt_date_range */
int GetUnallocatedRecords(const hash_t* hContext, recordset_t* rRecordSet)
{
	int iRet = PD_OK;

	char *csTmp;
	int iTmp;

	hash_t *myHash;

	EXEC SQL WHENEVER SQLERROR GOTO getunallocatedrecords_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_input_channel[PD_CHANNEL_CODE_LEN];
		varchar hv_txn_code[PD_TXN_CODE_LEN];
		char	hv_status;
		char	hv_ar_ind;
		varchar hv_sub_status[PD_SUB_STATUS_LEN];

		varchar hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		int	hv_stmt_date_range;
		varchar v_stmt_txn_id[PD_STMT_REF_LEN + 1];

		short ind_int_bank_code = -1;
		short ind_bank_acct_num = -1;
		short ind_stmt_date_range = -1;
		short ind_stmt_txn_id = -1;
	EXEC SQL END DECLARE SECTION;

	hv_input_channel.len = strlen(PD_CHANNEL_OMT);
	memcpy(hv_input_channel.arr, PD_CHANNEL_OMT, hv_input_channel.len);

	hv_txn_code.len = strlen(PD_BANK_DEPOSIT_TXN_CODE);
	memcpy(hv_txn_code.arr, PD_BANK_DEPOSIT_TXN_CODE, hv_txn_code.len);

	hv_status = PD_COMPLETE;

	hv_ar_ind = PD_ACCEPT;

	hv_sub_status.len = strlen(PD_UNALLOCATED);
	memcpy(hv_sub_status.arr, PD_UNALLOCATED, hv_sub_status.len);

	if (GetField_CString(hContext, "int_bank_code", &csTmp)) {
		hv_int_bank_code.len = strlen(csTmp);
		strncpy((char*)hv_int_bank_code.arr, csTmp, hv_int_bank_code.len);
		ind_int_bank_code = 0;
// DEBUGLOG(("GetUnallocatedRecords int_bank_code = [%.*s]\n", hv_int_bank_code.len, hv_int_bank_code.arr));
	}

	if (GetField_CString(hContext, "bank_acct_num", &csTmp)) {
		hv_bank_acct_num.len = strlen(csTmp);
		strncpy((char*)hv_bank_acct_num.arr, csTmp, hv_bank_acct_num.len);
		ind_bank_acct_num = 0;
// DEBUGLOG(("GetUnallocatedRecords bank_acct_num = [%.*s]\n", hv_bank_acct_num.len, hv_bank_acct_num.arr));
	}

	if (GetField_Int(hContext, "stmt_date_range", &iTmp)) {
		hv_stmt_date_range = iTmp;
		ind_stmt_date_range = 0;
// DEBUGLOG(("GetUnallocatedRecords stmt_date_range = [%d]\n", hv_stmt_date_range));
	}

	EXEC SQL DECLARE c_cursor_getunallocatedrecords CURSOR FOR
		SELECT oth_txn_id
		FROM ol_txn_header, ol_txn_psp_detail
		WHERE oth_txn_id = otp_txn_id
		AND otp_bank_code = :hv_int_bank_code:ind_int_bank_code
		AND otp_bank_acct_num = :hv_bank_acct_num:ind_bank_acct_num
		AND oth_input_channel = :hv_input_channel
		AND oth_txn_code = :hv_txn_code
		AND oth_status = :hv_status
		AND oth_ar_ind = :hv_ar_ind
		AND oth_sub_status = :hv_sub_status
		AND oth_multi_match_ind = 0
		AND otp_txn_timestamp >= sysdate - :hv_stmt_date_range:ind_stmt_date_range
		AND otp_txn_hold_ind = 0
		AND otp_sys_match_ind = 1;

	EXEC SQL OPEN c_cursor_getunallocatedrecords;

	for (;;) {
		EXEC SQL FETCH c_cursor_getunallocatedrecords
		INTO	:v_stmt_txn_id:ind_stmt_txn_id;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash, 0);

		// stmt_txn_id
		if (ind_stmt_txn_id >= 0) {
			v_stmt_txn_id.arr[v_stmt_txn_id.len] = '\0';
			PutField_CString(myHash, "stmt_txn_id", (const char*)v_stmt_txn_id.arr);
// DEBUGLOG(("GetUnallocatedRecords stmt_txn_id = [%s]\n", (const char*)v_stmt_txn_id.arr));
		}

		RecordSet_Add(rRecordSet, myHash);
	}

	EXEC SQL CLOSE c_cursor_getunallocatedrecords;

// DEBUGLOG(("GetUnallocatedRecords Normal Exit! iRet = [%d]\n", iRet));
	return iRet;

getunallocatedrecords_error:
DEBUGLOG(("getunallocatedrecords_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLStatement getunallocatedrecords_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL CLOSE c_cursor_getunallocatedrecords;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}

int CheckBasicMatchingCriteria(const char* csPspTxnId, const char* csMerchTxnId, const int iOverrideAmt, const char cMatchingType)
{
	int iRet = PD_ERR;

	EXEC SQL WHENEVER SQLERROR GOTO checkbasic_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_input_channel[PD_CHANNEL_CODE_LEN];
		varchar hv_txn_code[PD_TXN_CODE_LEN];
		char	hv_status;
		char	hv_ar_ind;
		varchar hv_sub_status[PD_SUB_STATUS_LEN];

		varchar hv_psp_txn_id[PD_TXN_SEQ_LEN];
		varchar hv_merch_txn_id[PD_TXN_SEQ_LEN];
		int hv_override_amt;
		char hv_matching_type;
		varchar hv_action[PD_ACCT_ACTION_LEN];

		int v_no_of_record;
		short ind_no_of_record = -1;
	EXEC SQL END DECLARE SECTION;

	hv_input_channel.len = strlen(PD_CHANNEL_OMT);
	memcpy(hv_input_channel.arr, PD_CHANNEL_OMT, hv_input_channel.len);

	hv_txn_code.len = strlen(PD_BANK_DEPOSIT_TXN_CODE);
	memcpy(hv_txn_code.arr, PD_BANK_DEPOSIT_TXN_CODE, hv_txn_code.len);

	hv_status = PD_COMPLETE;

	hv_ar_ind = PD_ACCEPT;

	hv_sub_status.len = strlen(PD_UNALLOCATED);
	memcpy(hv_sub_status.arr, PD_UNALLOCATED, hv_sub_status.len);

	hv_psp_txn_id.len = strlen(csPspTxnId);
	strncpy((char*)hv_psp_txn_id.arr, csPspTxnId, hv_psp_txn_id.len);
DEBUGLOG(("CheckBasicMatchingCriteria psp_txn_id = [%.*s]\n", hv_psp_txn_id.len, hv_psp_txn_id.arr));

	hv_merch_txn_id.len = strlen(csMerchTxnId);
	strncpy((char*)hv_merch_txn_id.arr, csMerchTxnId, hv_merch_txn_id.len);
DEBUGLOG(("CheckBasicMatchingCriteria merch_txn_id = [%.*s]\n", hv_merch_txn_id.len, hv_merch_txn_id.arr));

	hv_override_amt = iOverrideAmt;
DEBUGLOG(("CheckBasicMatchingCriteria override_amt = [%d]\n", hv_override_amt));

	hv_matching_type = cMatchingType;
DEBUGLOG(("CheckBasicMatchingCriteria matching_type = [%c]\n", hv_matching_type));

	switch (cMatchingType)
	{
		case 'S':
			hv_action.len = strlen(PD_AC_ACTION_AUTO_MATCH);
			memcpy(hv_action.arr, PD_AC_ACTION_AUTO_MATCH, hv_action.len);
			break;
		case 'A':
			hv_action.len = strlen(PD_AC_ACTION_ADM_MAN_MATCH);
			memcpy(hv_action.arr, PD_AC_ACTION_ADM_MAN_MATCH, hv_action.len);
			break;
		case 'M':
			hv_action.len = strlen(PD_AC_ACTION_MERCH_MAN_MATCH);
			memcpy(hv_action.arr, PD_AC_ACTION_MERCH_MAN_MATCH, hv_action.len);
			break;
		case 'R':
			hv_action.len = strlen(PD_AC_ACTION_MERCH_MAN_MATCH);
			memcpy(hv_action.arr, PD_AC_ACTION_MERCH_MAN_MATCH, hv_action.len);
			break;
		default:
			hv_action.len = strlen("UNKNOWN");
			memcpy(hv_action.arr, "UNKNOWN", hv_action.len);
			break;
	}

	EXEC SQL
		SELECT count(1)
		INTO :v_no_of_record:ind_no_of_record
		FROM ol_txn_header psp_hdr, ol_txn_psp_detail psp_dtl,
			ol_txn_header merch_hdr, ol_txn_detail merch_dtl
		WHERE psp_hdr.oth_txn_id = :hv_psp_txn_id
		AND psp_hdr.oth_input_channel = :hv_input_channel
		AND psp_hdr.oth_txn_code = :hv_txn_code
		AND psp_hdr.oth_status = :hv_status
		AND psp_hdr.oth_ar_ind = :hv_ar_ind
		AND psp_hdr.oth_sub_status = :hv_sub_status
		AND psp_dtl.otp_txn_id = psp_hdr.oth_txn_id
		AND psp_dtl.otp_txn_hold_ind = 0
		AND merch_hdr.oth_txn_id = :hv_merch_txn_id
		AND merch_hdr.oth_input_channel = decode(:hv_matching_type, 'R', 'OMT', 'E', 'OMT', 'OLN')
		AND merch_hdr.oth_txn_code = decode(:hv_matching_type, 'R', 'MRN', 'E', 'OAE', 'ODI')
		AND merch_hdr.oth_status = 'W'
		AND merch_dtl.otd_txn_id = merch_hdr.oth_txn_id
		AND psp_hdr.oth_deposit_amount = decode(:hv_override_amt, 1, psp_hdr.oth_deposit_amount, merch_hdr.oth_deposit_amount)
		AND psp_dtl.otp_txn_ccy = merch_dtl.otd_txn_ccy
		AND psp_dtl.otp_bank_code = merch_dtl.otd_bank_code
		AND psp_dtl.otp_bank_acct_num = merch_dtl.otd_bank_acct_num
--		AND abs(psp_dtl.otp_txn_timestamp - to_date(merch_dtl.otd_cust_deposit_datetime, 'yyyymmddhh24miss'))
--			<= (SELECT to_number(sp_val) FROM system_parameter WHERE sp_code = 'OFL_MANUAL_MATCH_DATE_RANGE')
		AND sp_ol_get_allow_action(psp_dtl.otp_bank_code, psp_dtl.otp_bank_acct_num, :hv_action) = decode(:hv_matching_type, 'E', 0, 1)
		;

	if (ind_no_of_record >= 0) {
		if (v_no_of_record > 0) {
			iRet = PD_OK;
		}
	}

	return iRet;

checkbasic_error:
DEBUGLOG(("checkbasic_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}

int MatchRespTxnStatus(const char* csTxnSeq,
                     const char cStatus,
                        const char cArInd)
{
        EXEC SQL WHENEVER SQLERROR GOTO MatchRespTxnStatus_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
    
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];
                char            hv_status;
                char            hv_ar_ind;

                varchar         v_host_posting_date[PD_DATE_LEN +1];

                short           ind_host_posting_date= -1;
    
        EXEC SQL END DECLARE SECTION;

        hv_txn_id.len = strlen(csTxnSeq);
        memcpy(hv_txn_id.arr,csTxnSeq,hv_txn_id.len);
DEBUGLOG(("MatchRespTxnStatus txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        hv_status = cStatus;
DEBUGLOG(("MatchRespTxnStatus status = [%c]\n",hv_status));

        hv_ar_ind = cArInd;
DEBUGLOG(("MatchRespTxnStatus ar_ind = [%c]\n",hv_ar_ind));

        EXEC SQL SELECT oth_host_posting_date
                INTO    :v_host_posting_date:ind_host_posting_date
                FROM    ol_txn_header
                WHERE   oth_txn_id = :hv_txn_id
                and     oth_status = :hv_status
                and     oth_ar_ind = :hv_ar_ind
                for update;


        if(ind_host_posting_date>=0){
DEBUGLOG(("MatchRespTxn Found\n"));
                return PD_FOUND;
        }
        else {
DEBUGLOG(("MatchRespTxnStatus Not Found\n"));
                return PD_NOT_FOUND;
        }


MatchRespTxnStatus_error:
DEBUGLOG(("MatchRespTxnStatus_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int CheckPspUniqueAmt(hash_t* hRls,
		   recordset_t* myRec)
{
	char*	csTmp;
	double	dTmp;
	int	iTmp;
	int	iCnt = 0;
	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO CheckPspUniqueAmt_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
    
        EXEC SQL BEGIN DECLARE SECTION;
                varchar		hv_baid[PD_BAID_LEN];
                varchar		hv_txn_code[PD_TXN_CODE_LEN];
                //varchar		hv_bank_code[PD_AC_BANK_LEN];
                //varchar		hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
                double		hv_from_amt;
                double		hv_to_amt;
                int		hv_check_interval;

                double		v_have_amt;

                short           ind_have_amt = -1;
    
        EXEC SQL END DECLARE SECTION;

	if(GetField_CString(hRls,"baid",&csTmp)){
		hv_baid.len = strlen(csTmp);
		memcpy(hv_baid.arr,csTmp,hv_baid.len);
DEBUGLOG(("CheckPspUniqueAmt baid = [%.*s]\n",hv_baid.len,hv_baid.arr));
    	}
	
	if(GetField_CString(hRls,"txn_code",&csTmp)){
		hv_txn_code.len = strlen(csTmp);
		memcpy(hv_txn_code.arr,csTmp,hv_txn_code.len);
DEBUGLOG(("CheckPspUniqueAmt txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));
    	}
/*	
	if(GetField_CString(hRls,"bank_code",&csTmp)){
		hv_bank_code.len = strlen(csTmp);
		memcpy(hv_bank_code.arr,csTmp,hv_bank_code.len);
DEBUGLOG(("CheckPspUniqueAmt bank_code = [%.*s]\n",hv_bank_code.len,hv_bank_code.arr));
    	}
	
	if(GetField_CString(hRls,"bank_acct_num",&csTmp)){
		hv_bank_acct_num.len = strlen(csTmp);
		memcpy(hv_bank_acct_num.arr,csTmp,hv_bank_acct_num.len);
DEBUGLOG(("CheckPspUniqueAmt bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));
    	}
*/	
	if(GetField_Double(hRls,"from_amt",&dTmp)){
		hv_from_amt = dTmp;
DEBUGLOG(("CheckPspUniqueAmt from amount = [%lf]\n",hv_from_amt));
	}

	if(GetField_Double(hRls,"to_amt",&dTmp)){
		hv_to_amt = dTmp;
DEBUGLOG(("CheckPspUniqueAmt to amount = [%lf]\n",hv_to_amt));
	}

	if(GetField_Int(hRls,"check_interval",&iTmp)){
		hv_check_interval = iTmp;
DEBUGLOG(("CheckPspUniqueAmt check_interval = [%d]\n",iTmp));
	}

        EXEC SQL DECLARE c_cursor_checkpspunique CURSOR FOR
		select	oth_display_amount
                FROM	
			(select oth_display_amount,
				oth_txn_id
			from	ol_txn_header,
				ol_txn_psp_detail
			where	oth_display_amount between :hv_from_amt and :hv_to_amt
			and	oth_txn_code = :hv_txn_code
			and	otp_baid = :hv_baid
			and	oth_txn_id = otp_txn_id
			and	oth_create_timestamp between sysdate - (:hv_check_interval/24) and sysdate)//,
			
			/*(select otd_txn_id
			from	ol_txn_detail
			where	otd_bank_code = :hv_bank_code
			and	otd_bank_acct_num = :hv_bank_acct_num
			and     otd_create_timestamp between sysdate - (:hv_check_interval/24) and sysdate)
		WHERE	oth_txn_id = otd_txn_id*/
		order by oth_display_amount;

	
        EXEC SQL OPEN c_cursor_checkpspunique;
        do {
                EXEC SQL FETCH c_cursor_checkpspunique
                INTO
                        :v_have_amt:ind_have_amt;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

                if (ind_have_amt < 0)
                        v_have_amt = 0.0;
                PutField_Double(myHash,"have_amt",v_have_amt);

		iCnt++;

		RecordSet_Add(myRec,myHash);

	}while(PD_TRUE);

	PutField_Int(hRls,"count",iCnt);

	EXEC SQL CLOSE c_cursor_checkpspunique;

DEBUGLOG(("CheckPspUniqueAmt Normal Exit\n"));
        return  PD_OK;

CheckPspUniqueAmt_error:
DEBUGLOG(("CheckPspUniqueAmt_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_checkpspunique;
        return PD_ERR;
}
