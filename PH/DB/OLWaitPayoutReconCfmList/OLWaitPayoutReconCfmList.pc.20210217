/*
PDProTech (c)2021. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2021/02/02              Michael Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "OLWaitPayoutReconCfmList.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


static char cDebug;

void OLWaitPayoutReconCfmList(char cdebug)
{
	cDebug = cdebug;
}

int Add(const hash_t *hRls)
{
	char *csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_psp_txn_id[PD_TXN_SEQ_LEN];
		varchar hv_baid_txn_id[PD_TXN_SEQ_LEN];
		varchar hv_create_user[PD_USER_LEN];

		short ind_psp_txn_id = -1;
		short ind_baid_txn_id = -1;
		short ind_create_user = -1;

		short hv_return_value;
	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));

	if (GetField_CString(hRls, "psp_txn_id", &csTmp)) {
		hv_psp_txn_id.len = strlen(csTmp);
		strncpy((char*)hv_psp_txn_id.arr, csTmp, hv_psp_txn_id.len);
		ind_psp_txn_id = 0;
	}
DEBUGLOG(("Add: psp_txn_id = [%.*s]\n", hv_psp_txn_id.len, hv_psp_txn_id.arr));

	if (GetField_CString(hRls, "baid_txn_id", &csTmp)) {
		hv_baid_txn_id.len = strlen(csTmp);
		strncpy((char*)hv_baid_txn_id.arr, csTmp, hv_baid_txn_id.len);
		ind_baid_txn_id = 0;
	}
DEBUGLOG(("Add: baid_txn_id = [%.*s]\n", hv_baid_txn_id.len, hv_baid_txn_id.arr));

	if (GetField_CString(hRls, "create_user", &csTmp)) {
		hv_create_user.len = strlen(csTmp);
		strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
	}
DEBUGLOG(("Add: create_user = [%.*s]\n", hv_create_user.len, hv_create_user.arr));

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_wa_poa_rec_cfm_list_ins(
						:hv_psp_txn_id:ind_psp_txn_id,
						:hv_baid_txn_id:ind_baid_txn_id,
						:hv_create_user:ind_create_user);
		END;
	END-EXEC;

DEBUGLOG(("Add: Ret = [%d]\n", hv_return_value));
	if (hv_return_value == SP_OK) {
DEBUGLOG(("Add: Normal Exit\n"));
	}

	if (hv_return_value == SP_OTHER_ERR) {
ERRLOG("OLWaitPayoutReconCfmList_Add: SP_OTHER_ERR\n");
DEBUGLOG(("Add: SP_OTHER_ERR\n"));
	}

	if (hv_return_value == SP_ERR) {
ERRLOG("OLWaitPayoutReconCfmList_Add: SP_ERR\n");
DEBUGLOG(("Add: SP_ERR\n"));
	}

	return PD_OK;

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLWaitPayoutReconCfmList_Add: SP_INTERNAL_ERR\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}


int DeleteSingle(const hash_t *hRls)
{
	char *csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO deletesingle_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_baid_txn_id_1[PD_TXN_SEQ_LEN];
		varchar hv_baid_txn_id_2[PD_TXN_SEQ_LEN];

		short ind_baid_txn_id_1 = -1;
		short ind_baid_txn_id_2 = -1;

		short hv_return_value;
	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("DeleteSingle: Begin\n"));

	if (GetField_CString(hRls, "baid_txn_id_1", &csTmp)) {
		hv_baid_txn_id_1.len = strlen(csTmp);
		strncpy((char*)hv_baid_txn_id_1.arr, csTmp, hv_baid_txn_id_1.len);
		ind_baid_txn_id_1 = 0;
	}
DEBUGLOG(("DeleteSingle: baid_txn_id_1 = [%.*s]\n", hv_baid_txn_id_1.len, hv_baid_txn_id_1.arr));

	if (GetField_CString(hRls, "baid_txn_id_2", &csTmp)) {
		hv_baid_txn_id_2.len = strlen(csTmp);
		strncpy((char*)hv_baid_txn_id_2.arr, csTmp, hv_baid_txn_id_2.len);
		ind_baid_txn_id_2 = 0;
	}
DEBUGLOG(("DeleteSingle: baid_txn_id_2 = [%.*s]\n", hv_baid_txn_id_2.len, hv_baid_txn_id_2.arr));


	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_wa_poa_rec_cfm_list_del(
						:hv_baid_txn_id_1:ind_baid_txn_id_1,
						:hv_baid_txn_id_2:ind_baid_txn_id_2);
		END;
	END-EXEC;

DEBUGLOG(("DeleteSingle: Ret = [%d]\n", hv_return_value));

	if (hv_return_value == SP_OK) {
DEBUGLOG(("DeleteSingle: Normal Exit\n"));
	}

	if (hv_return_value == SP_OTHER_ERR) {
ERRLOG("DeleteSingle: SP_OTHER_ERR\n");
DEBUGLOG(("DeleteSingle: SP_OTHER_ERR\n"));
	}

	if (hv_return_value == SP_ERR) {
ERRLOG("DeleteSingle: SP_ERR\n");
DEBUGLOG(("DeleteSingle: SP_ERR\n"));
	}

	return PD_OK;

deletesingle_error:
DEBUGLOG(("deletesingle_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("DeleteSingle: SP_INTERNAL_ERR\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}
