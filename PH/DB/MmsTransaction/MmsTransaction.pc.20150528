/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/04/29              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "MmsTransaction.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;
void MmsTransaction(char    cdebug)
{
        cDebug = cdebug;
}

int Add(const hash_t *hRls)
{
        char		*csTmp;
        char        	cTmp;
	int		iCommit = PD_TRUE;
	int		iTmp;
	double		dTmp;


        EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short 		hv_return_value;

	varchar		hv_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_org_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_channel_code[PD_CHANNEL_CODE_LEN];
	char		hv_status;
	char		hv_ar_ind;
	varchar		hv_sub_status[PD_SUB_STATUS_LEN];
	varchar		hv_txn_code[PD_TXN_CODE_LEN];
	varchar		hv_process_type[PD_PROCESS_TYPE_LEN];
	varchar		hv_process_code[PD_PROCESS_CODE_LEN];
	varchar		hv_host_posting_date[PD_DATE_LEN];
	varchar		hv_transmission_datetime[PD_DATE_LEN + PD_TIME_LEN];
	int		hv_internal_code;
	varchar		hv_response_code[PD_RESPONSE_CODE_LEN];
	double		hv_transaction_amt;
	double		hv_remaining_amt;
	double		hv_net_amt;
	varchar		hv_net_ccy[PD_CCY_ID_LEN +1];
	varchar		hv_local_tm_date[PD_DATE_LEN];
	varchar		hv_local_tm_time[PD_TIME_LEN];
	varchar		hv_add_user[PD_USER_LEN];
	varchar		hv_client_ip[PD_IP_LEN];



	short		ind_txn_id = -1;
	short		ind_org_txn_id = -1;
	short		ind_channel_code = -1;
	short		ind_status = -1;
	short		ind_ar_ind = -1;
	short		ind_sub_status = -1;
	short		ind_txn_code = -1;
	short		ind_process_type = -1;
	short		ind_process_code = -1;
	short		ind_host_posting_date = -1;
	short		ind_transmission_datetime = -1;
	short		ind_internal_code = -1;
	short		ind_response_code = -1;
	short		ind_transaction_amt = -1;
	short		ind_remaining_amt = -1;
	short		ind_net_amt = -1;
	short		ind_net_ccy = -1;
	short		ind_local_tm_date = -1;
	short		ind_local_tm_time = -1;
	short		ind_add_user = -1;
	short		ind_client_ip= -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));

        if (GetField_Int(hRls,"db_commit",&iCommit)) {
DEBUGLOG(("Add:db_commit = [%d]\n",iCommit));
	}

/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("Add:txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
        }
/* org txn_seq */
        if (GetField_CString(hRls,"org_txn_seq",&csTmp)) {
                hv_org_txn_id.len = strlen(csTmp);
                memcpy(hv_org_txn_id.arr,csTmp,hv_org_txn_id.len);
                ind_org_txn_id = 0;
DEBUGLOG(("Add:org_txn_id = [%.*s]\n",hv_org_txn_id.len,hv_org_txn_id.arr));
        }
/* Channel code */
        if (GetField_CString(hRls,"channel_code",&csTmp)) {
                hv_channel_code.len = strlen(csTmp);
                memcpy(hv_channel_code.arr,csTmp,hv_channel_code.len);
                ind_channel_code = 0;
DEBUGLOG(("Add:channel_code = [%.*s]\n",hv_channel_code.len,hv_channel_code.arr));
        }


/* Status */ 
        if (GetField_Char(hRls,"status",&cTmp)) {
		hv_status = cTmp;
                ind_status = 0;
DEBUGLOG(("Add:status = [%c]\n",hv_status));
        }

/* ar ind */ 
        if (GetField_Char(hRls,"ar_ind",&cTmp)) {
		hv_ar_ind = cTmp;
                ind_ar_ind = 0;
DEBUGLOG(("Add:ar_ind = [%c]\n",hv_ar_ind));
        }

/* Sub Status */ 
        if (GetField_CString(hRls,"sub_status",&csTmp)) {
                hv_sub_status.len = strlen(csTmp);
                memcpy(hv_sub_status.arr,csTmp,hv_sub_status.len);
                ind_sub_status = 0;
DEBUGLOG(("Add:sub_status = [%.*s]\n",hv_sub_status.len,hv_sub_status.arr));
        }

/* Txn Code */
        if (GetField_CString(hRls,"txn_code",&csTmp)) {
                hv_txn_code.len = strlen(csTmp);
                memcpy(hv_txn_code.arr,csTmp,hv_txn_code.len);
                ind_txn_code = 0;
DEBUGLOG(("Add:txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));
        }

/* process type */
        if (GetField_CString(hRls,"process_type",&csTmp)) {
                hv_process_type.len = strlen(csTmp);
                memcpy(hv_process_type.arr,csTmp,hv_process_type.len);
                ind_process_type = 0;
DEBUGLOG(("Add:process_type = [%.*s]\n",hv_process_type.len,hv_process_type.arr));
        }

/* process code */
        if (GetField_CString(hRls,"process_code",&csTmp)) {
                hv_process_code.len = strlen(csTmp);
                memcpy(hv_process_code.arr,csTmp,hv_process_code.len);
                ind_process_code = 0;
DEBUGLOG(("Add:process_code = [%.*s]\n",hv_process_code.len,hv_process_code.arr));
        }

/* host posting date */
        if (GetField_CString(hRls,"host_posting_date",&csTmp)) {
                hv_host_posting_date.len = strlen(csTmp);
                memcpy(hv_host_posting_date.arr,csTmp,hv_host_posting_date.len);
                ind_host_posting_date = 0;
DEBUGLOG(("Add:host_posting_date = [%.*s]\n",hv_host_posting_date.len,hv_host_posting_date.arr));
        }



/* internal code */
        if (GetField_Int(hRls,"internal_code",&iTmp)) {
		hv_internal_code = iTmp;
                ind_internal_code = 0;
DEBUGLOG(("Add:settlement_date = [%d]\n",hv_internal_code));
        }

/* response code  */
        if (GetField_CString(hRls,"response_code",&csTmp)) {
                hv_response_code.len = strlen(csTmp);
                memcpy(hv_response_code.arr,csTmp,hv_response_code.len);
                ind_response_code = 0;
DEBUGLOG(("Add:response_code = [%.*s]\n",hv_response_code.len,hv_response_code.arr));
        }

/* transaction amt   */
        if (GetField_Double(hRls,"txn_amt",&dTmp)) {
		hv_transaction_amt = dTmp;
                ind_transaction_amt = 0;
DEBUGLOG(("Add:txn_amt = [%f]\n",hv_transaction_amt));
        }
/* remaining amt   */
        if (GetField_Double(hRls,"remaining_amt",&dTmp)) {
		hv_remaining_amt = dTmp;
                ind_remaining_amt = 0;
DEBUGLOG(("Add:remaining_amt = [%f]\n",hv_remaining_amt));
        }


/* net amt   */
        if (GetField_Double(hRls,"net_amt",&dTmp)) {
		hv_net_amt = dTmp;
                ind_net_amt = 0;
DEBUGLOG(("Add:net_amt = [%f]\n",hv_net_amt));
        }

/* net ccy */
        if (GetField_CString(hRls,"net_ccy",&csTmp)) {
                hv_net_ccy.len = strlen(csTmp);
                memcpy(hv_net_ccy.arr,csTmp,hv_net_ccy.len);
                ind_net_ccy = 0;
DEBUGLOG(("Add:net_ccy = [%.*s]\n",hv_net_ccy.len,hv_net_ccy.arr));
        }

/* transmission_datetime */
        if (GetField_CString(hRls,"transmission_datetime",&csTmp)) {
                hv_transmission_datetime.len = strlen(csTmp);
                memcpy(hv_transmission_datetime.arr,csTmp,hv_transmission_datetime.len);
                ind_transmission_datetime = 0;
DEBUGLOG(("Add:transmission_datetime = [%.*s]\n",hv_transmission_datetime.len,hv_transmission_datetime.arr));
        }

/* local tm date */
        if (GetField_CString(hRls,"local_tm_date",&csTmp)) {
                hv_local_tm_date.len = strlen(csTmp);
                memcpy(hv_local_tm_date.arr,csTmp,hv_local_tm_date.len);
                ind_local_tm_date = 0;
DEBUGLOG(("Add:local_tm_date = [%.*s]\n",hv_local_tm_date.len,hv_local_tm_date.arr));
        }

/* local tm time */
        if (GetField_CString(hRls,"local_tm_time",&csTmp)) {
                hv_local_tm_time.len = strlen(csTmp);
                memcpy(hv_local_tm_time.arr,csTmp,hv_local_tm_time.len);
                ind_local_tm_time = 0;
DEBUGLOG(("Add:local_tm_time = [%.*s]\n",hv_local_tm_time.len,hv_local_tm_time.arr));
        }



/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen(csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("Add:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }


/* client ip */
        if (GetField_CString(hRls,"ip_addr",&csTmp)) {
		char *p;
		char    csTmpIP[PD_IP_LEN+1];
                p = strtok (csTmp,",");
                while (p != NULL)
                {
                        strcpy(csTmpIP,p);
                        csTmpIP[strlen(p)]='\0';
			break;
                }
                hv_client_ip.len = strlen(csTmpIP);
                memcpy(hv_client_ip.arr,csTmpIP,hv_client_ip.len);
                ind_client_ip = 0;
DEBUGLOG(("Add:client_ip = [%.*s]\n",hv_client_ip.len,hv_client_ip.arr));
        }


	EXEC SQL EXECUTE
                BEGIN
			:hv_return_value := sp_mms_txn_header_insert(
					:hv_txn_id:ind_txn_id,
					:hv_org_txn_id:ind_org_txn_id,
					:hv_channel_code:ind_channel_code,
					:hv_status:ind_status,
					:hv_ar_ind:ind_ar_ind,
					:hv_sub_status:ind_sub_status,
					:hv_txn_code:ind_txn_code,
					:hv_process_type:ind_process_type,
					:hv_process_code:ind_process_code,
					:hv_host_posting_date:ind_host_posting_date,
					:hv_transmission_datetime:ind_transmission_datetime,
					:hv_internal_code:ind_internal_code,
					:hv_response_code:ind_response_code,
					:hv_transaction_amt:ind_transaction_amt,
					:hv_remaining_amt:ind_remaining_amt,
					:hv_net_amt:ind_net_amt,
					:hv_net_ccy:ind_net_ccy,
					:hv_local_tm_date:ind_local_tm_date,
					:hv_local_tm_time:ind_local_tm_time,
					:hv_add_user:ind_add_user,
					:hv_add_user:ind_add_user,
					:hv_client_ip:ind_client_ip);
	        END;
        END-EXEC;

// update txn sub status
        //AddTxnStatusLog(hRls);


DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("Add:Normal Exit\n"));
		if (iCommit == PD_TRUE)
			TxnCommit();
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MmsTransaction_Add: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("MmsTransaction_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		TxnAbort();
                return PD_ERR;
        }

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("MmsTransaction_Add: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR TxnAbort\n"));
	TxnAbort();
        return PD_INTERNAL_ERR;
}


int Update(const hash_t *hRls)
{

        char*   csTmp;
        char    cTmp;
        double  dTmp;
        int     iTmp;
        char*   csBuf;
        char*   csTxnId;
        EXEC SQL WHENEVER SQLERROR GOTO update_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        varchar         hv_dynstmt[PD_TMP_MSG_BUF_LEN];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
        csBuf = (char*) malloc (PD_TMP_BUF_LEN);
        strcpy((char*)hv_dynstmt.arr,"update mms_txn_header set th_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"txn_seq",&csTxnId);
DEBUGLOG(("Update:txn_id = [%s]\n",csTxnId));

/* org txn_seq */
        if (GetField_CString(hRls,"org_txn_seq",&csTmp)) {
DEBUGLOG(("Update:org_txn_id = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_org_txn_id = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* Channel code */
        if (GetField_CString(hRls,"channel_code",&csTmp)) {
DEBUGLOG(("Update:channel_code = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_input_channel = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* Status */
        if (GetField_Char(hRls,"status",&cTmp)) {
DEBUGLOG(("Update:status = [%c]\n",cTmp));
                sprintf(csBuf,"%c",cTmp);
                strcat((char*)hv_dynstmt.arr, ",mth_status = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* ar ind */
        if (GetField_Char(hRls,"ar_ind",&cTmp)) {
DEBUGLOG(("Update:ar_ind = [%c]\n",cTmp));
                sprintf(csBuf,"%c",cTmp);
                strcat((char*)hv_dynstmt.arr, ",mth_ar_ind = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* Sub Status */
        if (GetField_CString(hRls,"sub_status",&csTmp)) {
DEBUGLOG(("Update:sub_status = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_sub_status = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* Txn Code */
        if (GetField_CString(hRls,"txn_code",&csTmp)) {
DEBUGLOG(("Update:txn_code = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_txn_code = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* process type */
        if (GetField_CString(hRls,"process_type",&csTmp)) {
DEBUGLOG(("Update:process_type = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_process_type = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* process code */
        if (GetField_CString(hRls,"process_code",&csTmp)) {
DEBUGLOG(("Update:process_code = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_process_code = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* host posting date */
        if (GetField_CString(hRls,"host_posting_date",&csTmp)) {
DEBUGLOG(("Update:host_posting_date = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_host_posting_date = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* transmission_datetime  */
        if (GetField_CString(hRls,"transmission_datetime",&csTmp)) {
DEBUGLOG(("Update:transmission_datetime = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_transmission_datetime = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* internal code  */
        if (GetField_Int(hRls,"internal_code",&iTmp)) {
DEBUGLOG(("Update:internal_code = [%d]\n",iTmp));
                sprintf(csBuf,"%d",iTmp);
                strcat((char*)hv_dynstmt.arr, ",mth_internal_code = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* response code  */
        if (GetField_CString(hRls,"response_code",&csTmp)) {
DEBUGLOG(("Update:response_code = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_response_code = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* transaction amt   */
        if (GetField_Double(hRls,"txn_amt",&dTmp)) {
DEBUGLOG(("Update:txn_amt = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mth_transaction_amount = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* remaining amt   */
        if (GetField_Double(hRls,"remaining_amt",&dTmp)) {
DEBUGLOG(("Update:remaining_amt = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mth_remaining_amt = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* net amt   */
        if (GetField_Double(hRls,"net_amt",&dTmp)) {
DEBUGLOG(("Update:net_amt = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mth_net_amount = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* net ccy */
        if (GetField_CString(hRls,"net_ccy",&csTmp)) {
DEBUGLOG(("Update:net_ccy = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_net_ccy = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* local tm date */
        if (GetField_CString(hRls,"local_tm_date",&csTmp)) {
DEBUGLOG(("Update:local_tm_date = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_local_tm_date = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* local tm time */
        if (GetField_CString(hRls,"local_tm_time",&csTmp)) {
DEBUGLOG(("Update:local_tm_time = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_local_tm_time = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* ip_addr */
        if (GetField_CString(hRls,"ip_addr",&csTmp)) {
                char *p;
                char    csTmpIP[PD_IP_LEN+1];
                p = strtok (csTmp,",");
                while (p != NULL)
                {
                        strcpy(csTmpIP,p);
                        csTmpIP[strlen(p)]='\0';
                        break;
                }
DEBUGLOG(("Update:ip_addr = [%s]\n",csTmpIP));
                strcat((char*)hv_dynstmt.arr, ",mth_client_ip = '");
                strcat((char*)hv_dynstmt.arr, csTmpIP);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* update user */
        if (GetField_CString(hRls,"update_user",&csTmp)) {
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_update_user = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* update timestap */
	strcat((char*)hv_dynstmt.arr, ",mth_update_timestamp = sysdate ");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " WHERE mth_txn_id = '");
        strcat((char *)hv_dynstmt.arr, csTxnId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

        FREE_ME(csBuf);

// update txn sub status
//        AddTxnStatusLog(hRls);

DEBUGLOG(("Update Normal Exit\n"));
        return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;
}


int GetTxnHeader(const char* csTxnID,
                recordset_t* myRec)
{

        char    csDate[PD_DATE_LEN +1];
        char    csTime[PD_TIME_LEN +1];
        char    csDateTime[PD_DATE_LEN + PD_TIME_LEN +1];
        hash_t *myHash;
        int     iCnt = 0;

        EXEC SQL WHENEVER SQLERROR GOTO gettxnheader_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];

                varchar         v_org_txn_id[PD_TXN_SEQ_LEN + 1];
                varchar         v_client_id[PD_CLIENT_ID_LEN + 1];
                char            v_status;
                char            v_ar_ind;
                varchar         v_txn_code[PD_TXN_CODE_LEN + 1];
                double          v_txn_amt;
                double          v_remaining_amt;
                double          v_net_amt;
                varchar         v_net_ccy[PD_CCY_ID_LEN +1];
                varchar         v_transmission_datetime[PD_DATE_LEN + PD_TIME_LEN + 1];
                varchar         v_local_tm_date[PD_DATE_LEN + 1];
                varchar         v_local_tm_time[PD_TIME_LEN + 1];
                long            v_internal_code;
                varchar         v_channel_code[PD_CHANNEL_CODE_LEN + 1];
                varchar         v_response_code[PD_RESPONSE_CODE_LEN + 1];
                varchar         v_host_posting_date[PD_DATE_LEN + 1];
                varchar         v_process_code[PD_PROCESS_CODE_LEN + 1];
                varchar         v_process_type[PD_PROCESS_TYPE_LEN + 1];
                varchar         v_client_ip[PD_IP_LEN + 1];
		varchar         v_sub_status[PD_SUB_STATUS_LEN + 1];
		

		short           ind_org_txn_id = -1;
                short           ind_client_id = -1;
                short           ind_status = -1;
                short           ind_ar_ind = -1;
                short           ind_txn_code = -1;
                short           ind_txn_amt = -1;
                short           ind_remaining_amt = -1;
                short           ind_net_amt = -1;
                short           ind_net_ccy = -1;
                short           ind_transmission_datetime = -1;
                short           ind_local_tm_date = -1;
                short           ind_local_tm_time = -1;
                short           ind_internal_code = -1;
                short           ind_channel_code = -1;
                short           ind_response_code = -1;
                short           ind_host_posting_date = -1;
                short           ind_process_code= -1;
                short           ind_process_type= -1;
                short           ind_client_ip = -1;
                short           ind_sub_status = -1;

        EXEC SQL END DECLARE SECTION;

        hv_txn_id.len = strlen(csTxnID);
        memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetTxnHeader txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_gettxnheader CURSOR FOR
                select mth_org_txn_id,
                       mth_status,
                       mth_ar_ind,
                       mth_txn_code,
                       mth_transaction_amount,
                       mth_remaining_amount,
                       mth_net_amount,
                       mth_net_ccy,
                       mth_transmission_datetime,
                       mth_local_tm_date,
                       mth_local_tm_time,
                       mth_tm_date,
                       mth_tm_time,
                       mth_internal_code,
                       mth_input_channel,
                       mth_response_code,
                       mth_host_posting_date,
                       mth_process_code,
                       mth_process_type,
                       mth_input_channel,
                       mth_client_ip,
                       mth_sub_status
                  from mms_txn_header
                 where mth_txn_id = :hv_txn_id;


        EXEC SQL OPEN c_cursor_gettxnheader;
        do {
                EXEC SQL FETCH c_cursor_gettxnheader
                INTO
                        :v_org_txn_id:ind_org_txn_id,
                        :v_status:ind_status,
                        :v_ar_ind:ind_ar_ind,
                        :v_txn_code:ind_txn_code,
                        :v_txn_amt:ind_txn_amt,
                        :v_remaining_amt:ind_remaining_amt,
                        :v_net_amt:ind_net_amt,
                        :v_net_ccy:ind_net_ccy,
                        :v_transmission_datetime:ind_transmission_datetime,
                        :v_local_tm_date:ind_local_tm_date,
                        :v_local_tm_time:ind_local_tm_time,
                        :v_internal_code:ind_internal_code,
                        :v_channel_code:ind_channel_code,
                        :v_response_code:ind_response_code,
                        :v_host_posting_date:ind_host_posting_date,
                        :v_process_code:ind_process_code,
                        :v_process_type:ind_process_type,
                        :v_channel_code:ind_channel_code,
                        :v_client_ip:ind_client_ip,
                        :v_sub_status:ind_sub_status;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                iCnt++;

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

                if (ind_org_txn_id >= 0) {
                        v_org_txn_id.arr[v_org_txn_id.len] ='\0';
                        PutField_CString(myHash,"org_txn_id",(const char*)v_org_txn_id.arr);
DEBUGLOG(("GetTxnHeader org_txn_id = [%s]\n",v_org_txn_id.arr));
                }

                if (ind_client_id >= 0) {
                        v_client_id.arr[v_client_id.len] ='\0';
                        PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
DEBUGLOG(("GetTxnHeader client_id = [%s]\n",v_client_id.arr));
                }
                if (ind_status >= 0) {
DEBUGLOG(("GetTxnHeader status = [%c]\n",v_status));
                        PutField_Char(myHash,"status",v_status);
                }

                if (ind_ar_ind >= 0) {
DEBUGLOG(("GetTxnHeader ar_ind = [%c]\n",v_ar_ind));
                        PutField_Char(myHash,"ar_ind",v_ar_ind);
                }

                if (ind_txn_code >= 0) {
                        v_txn_code.arr[v_txn_code.len] ='\0';
                        PutField_CString(myHash,"txn_code",(const char*)v_txn_code.arr);
DEBUGLOG(("GetTxnHeader txn_code = [%s]\n",v_txn_code.arr));
                }

                if (ind_process_code >= 0) {
                        v_process_code.arr[v_process_code.len] ='\0';
                        PutField_CString(myHash,"process_code",(const char*)v_process_code.arr);
DEBUGLOG(("GetTxnHeader process_code = [%s]\n",v_process_code.arr));
                }

                if (ind_process_type >= 0) {
                        v_process_type.arr[v_process_type.len] ='\0';
                        PutField_CString(myHash,"process_type",(const char*)v_process_type.arr);
DEBUGLOG(("GetTxnHeader process_type = [%s]\n",v_process_type.arr));
                }

                if (ind_txn_amt < 0)
                        v_txn_amt = 0.0;
                PutField_Double(myHash,"txn_amt",v_txn_amt);
DEBUGLOG(("GetTxnHeader txn_amt = [%f]\n",v_txn_amt));

                if (ind_remaining_amt < 0)
                        v_remaining_amt = 0.0;
                PutField_Double(myHash,"remaining_amt",v_remaining_amt);
DEBUGLOG(("GetTxnHeader remaining_amt = [%f]\n",v_remaining_amt));


                if (ind_net_amt < 0)
                        v_net_amt = 0.0;
                PutField_Double(myHash,"net_amt",v_net_amt);
DEBUGLOG(("GetTxnHeader net_amt = [%f]\n",v_net_amt));

                if (ind_net_ccy >= 0) {
                        v_net_ccy.arr[v_net_ccy.len] ='\0';
                        PutField_CString(myHash,"net_ccy",(const char*)v_net_ccy.arr);
DEBUGLOG(("GetTxnHeader net_ccy = [%s]\n",v_net_ccy.arr));
                }

                if (ind_transmission_datetime >= 0) {
                        v_transmission_datetime.arr[v_transmission_datetime.len] ='\0';
                        PutField_CString(myHash,"transmission_datetime",(const char*)v_transmission_datetime.arr);
DEBUGLOG(("GetTxnHeader transmission_datetime = [%s]\n",v_transmission_datetime.arr));
                }
                if (ind_local_tm_date >= 0) {
                        v_local_tm_date.arr[v_local_tm_date.len] ='\0';
                        strcpy(csDate,(char*)v_local_tm_date.arr);
                        PutField_CString(myHash,"local_tm_date",(const char*)v_local_tm_date.arr);
DEBUGLOG(("GetTxnHeader local_tm_date = [%s]\n",v_local_tm_date.arr));
                }
                if (ind_local_tm_time >= 0) {
                        v_local_tm_time.arr[v_local_tm_time.len] ='\0';
                        strcpy(csTime,(char*)v_local_tm_time.arr);
                        PutField_CString(myHash,"local_tm_time",(const char*)v_local_tm_time.arr);
DEBUGLOG(("GetTxnHeader local_tm_time = [%s]\n",v_local_tm_time.arr));
                }


                if (ind_internal_code >= 0) {
                        PutField_Int(myHash,"internal_error",v_internal_code);
DEBUGLOG(("GetTxnHeader internal_code = [%d]\n",v_internal_code));
                }
                if (ind_channel_code >= 0) {
                        v_channel_code.arr[v_channel_code.len] ='\0';
                        PutField_CString(myHash,"channel_code",(const char*)v_channel_code.arr);
DEBUGLOG(("GetTxnHeader channel_code = [%s]\n",v_channel_code.arr));
                }
                if (ind_response_code >= 0) {
                        v_response_code.arr[v_response_code.len] ='\0';
                        PutField_CString(myHash,"response_code",(const char*)v_response_code.arr);
DEBUGLOG(("GetTxnHeader response_code = [%s]\n",v_response_code.arr));
                }
                if (ind_host_posting_date >= 0) {
                        v_host_posting_date.arr[v_host_posting_date.len] ='\0';
                        PutField_CString(myHash,"host_posting_date",(const char*)v_host_posting_date.arr);
DEBUGLOG(("GetTxnHeader host_posting_date = [%s]\n",v_host_posting_date.arr));
                }

DEBUGLOG(("GetTxnHeader formation local transmission_datetime\n"));
                strcpy(csDateTime,csDate);
                strcat(csDateTime,csTime);
DEBUGLOG(("GetTxnHeader local_transmission_datetime = [%s]\n",csDateTime));
                PutField_CString(myHash,"local_transmission_datetime",csDateTime);


                if (ind_client_ip>= 0) {
                        v_client_ip.arr[v_client_ip.len] ='\0';
                        PutField_CString(myHash,"ip_addr",(const char*)v_client_ip.arr);
DEBUGLOG(("GetTxnHeader client_ip = [%s]\n",v_client_ip.arr));
                }



                if (ind_sub_status>= 0) {
                        v_sub_status.arr[v_sub_status.len] ='\0';
                        PutField_CString(myHash,"sub_status",(const char*)v_sub_status.arr);
DEBUGLOG(("GetTxnHeader sub_status = [%s]\n",v_sub_status.arr));
                }

                RecordSet_Add(myRec,myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_gettxnheader;


        if (iCnt > 0 ) {
DEBUGLOG(("GetTxnHeader Normal Exit\n"));
                return  PD_OK;
        }
        else {
DEBUGLOG(("GetTxnHeader Normal Exit, Not Found\n"));
                return PD_ERR;
        }

gettxnheader_error:
DEBUGLOG(("gettxnheader_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_gettxnheader;
        return PD_ERR;
}



int AddDetail(const hash_t *hRls)
{
        char            *csTmp;

        EXEC SQL WHENEVER SQLERROR GOTO adddetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short           hv_return_value;

        varchar         hv_txn_id[PD_TXN_SEQ_LEN];
        varchar         hv_src_entity_id[PD_MMS_ENTITY_ID_LEN];
        varchar         hv_dst_entity_id[PD_MMS_ENTITY_ID_LEN];
	varchar		hv_add_user[PD_USER_LEN];

	short           ind_txn_id = -1;
	short		ind_src_entity_id = -1;
	short		ind_dst_entity_id = -1;
	short		ind_add_user = -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("AddDetail: Begin\n"));


/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("AddDetail:txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
        }

/* src_entity_id */
        if (GetField_CString(hRls,"src_entity_id",&csTmp)) {
                hv_src_entity_id.len = strlen(csTmp);
                memcpy(hv_src_entity_id.arr,csTmp,hv_src_entity_id.len);
                ind_src_entity_id = 0;
DEBUGLOG(("AddDetail:src_entity_id = [%.*s]\n",hv_src_entity_id.len,hv_src_entity_id.arr));
        }

/* dst_entity_id */
        if (GetField_CString(hRls,"dst_entity_id",&csTmp)) {
                hv_dst_entity_id.len = strlen(csTmp);
                memcpy(hv_dst_entity_id.arr,csTmp,hv_dst_entity_id.len);
                ind_dst_entity_id = 0;
DEBUGLOG(("AddDetail:dst_entity_id = [%.*s]\n",hv_dst_entity_id.len,hv_dst_entity_id.arr));
        }

/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen(csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("AddDetail:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }


	EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_mms_txn_detail_insert(
                                        :hv_txn_id:ind_txn_id,
					:hv_src_entity_id:ind_src_entity_id,
					:hv_dst_entity_id:ind_dst_entity_id,
					:hv_add_user:ind_add_user
					);
                END;
        END-EXEC;

DEBUGLOG(("AddDetail:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("AddDetail:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("Transaction_AddDetail: SP_OTHER_ERR\n");
DEBUGLOG(("AddDetail: SP_OTHER_ERR\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("Transaction_Add: SP_ERR\n");
DEBUGLOG(("AddDetail: SP_ERR\n"));
                return PD_ERR;
        }

adddetail_error:
DEBUGLOG(("adddetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_Add: SP_INTERNAL_ERR\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR\n"));
        return PD_INTERNAL_ERR;
}


int UpdateDetail(const hash_t *hRls)
{
        char*   csPtr;
        char*   csBuf;
        char*   csTxnId;

        EXEC SQL WHENEVER SQLERROR GOTO update_detail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        varchar         hv_dynstmt[PD_TMP_MSG_BUF_LEN];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("UpdateDetail: Begin\n"));
        csBuf = (char*) malloc (PD_TMP_BUF_LEN);
        strcpy((char*)hv_dynstmt.arr,"update mms_txn_detail set mtd_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"txn_seq",&csTxnId);
DEBUGLOG(("UpdateDetail:txn_id = [%s]\n",csTxnId));

/* src_entity_id */
        if (GetField_CString(hRls,"src_entity_id",&csPtr)) {
DEBUGLOG(("UpdateDetail:src_entity_id = [%s]\n",csPtr));
                strcat((char*)hv_dynstmt.arr, ",mtd_src_entity_id = '");
                strcat((char*)hv_dynstmt.arr, csPtr);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* dst_entity_id */
        if (GetField_CString(hRls,"dst_entity_id",&csPtr)) {
DEBUGLOG(("UpdateDetail:dst_entity_id = [%s]\n",csPtr));
                strcat((char*)hv_dynstmt.arr, ",mtd_dst_entity_id = '");
                strcat((char*)hv_dynstmt.arr, csPtr);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* update user */
        if (GetField_CString(hRls,"update_user",&csPtr)) {
DEBUGLOG(("UpdateDetail:update_user = [%s]\n",csPtr));
                strcat((char*)hv_dynstmt.arr, ",mtd_update_user = '");
                strcat((char*)hv_dynstmt.arr, csPtr);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* update timestap */
	strcat((char*)hv_dynstmt.arr, ",mth_update_timestamp = sysdate ");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

strcat((char *)hv_dynstmt.arr, " WHERE td_txn_id = '");
        strcat((char *)hv_dynstmt.arr, csTxnId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

        FREE_ME(csBuf);


DEBUGLOG(("UpdateDetail Normal Exit\n"));
        return PD_OK;

update_detail_error:
DEBUGLOG(("update_detail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_UpdateDetail: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("UpdateDetail: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;
}


int GetTxnDetail(const char* csTxnID,
                recordset_t* myRec)
{

        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO gettxndetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];

                varchar         v_src_entity_id[PD_MMS_ENTITY_ID_LEN + 1];
                varchar         v_dst_entity_id[PD_MMS_ENTITY_ID_LEN + 1];

		short		ind_src_entity_id;
		short		ind_dst_entity_id;


	EXEC SQL END DECLARE SECTION;

        hv_txn_id.len = strlen(csTxnID);
        memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetTxnDetail txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_gettxndetail CURSOR FOR
                select
                        mtd_src_entity_id,
                        mtd_dst_entity_id
                  from mms_txn_detail
                 where mtd_txn_id = :hv_txn_id;

	EXEC SQL OPEN c_cursor_gettxndetail;
        do {
                EXEC SQL FETCH c_cursor_gettxndetail
                INTO
			:v_src_entity_id:ind_src_entity_id,
			:v_dst_entity_id:ind_dst_entity_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

	 	myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);


/* src entity id */
                if (ind_src_entity_id  >=  0) {
                        v_src_entity_id.arr[v_src_entity_id.len] = '\0';
                        PutField_CString(myHash,"src_entity_id",(const char*)v_src_entity_id.arr);
DEBUGLOG(("GetTxnDetail src_entity_id = [%s]\n",v_src_entity_id.arr));
                }

/* dst entity id */
                if (ind_dst_entity_id  >=  0) {
                        v_dst_entity_id.arr[v_dst_entity_id.len] = '\0';
                        PutField_CString(myHash,"dst_entity_id",(const char*)v_dst_entity_id.arr);
DEBUGLOG(("GetTxnDetail dst_entity_id = [%s]\n",v_dst_entity_id.arr));
                }

		RecordSet_Add(myRec,myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_gettxndetail;


DEBUGLOG(("GetTxnDetail Normal Exit\n"));
        return  PD_OK;

gettxndetail_error:
DEBUGLOG(("gettxndetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_gettxndetail;
        return PD_ERR;
}


int AddNatureDetail(const hash_t *hRls)
{
        char            *csTmp;
	double		dTmp;

        EXEC SQL WHENEVER SQLERROR GOTO addnaturedetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short           hv_return_value;

        varchar         hv_txn_id[PD_TXN_SEQ_LEN];
	varchar		hv_mms_psp_id[PD_MMS_PID_LEN];
	double		hv_txn_amount;
	varchar		hv_txn_ccy[PD_CCY_ID_LEN];
	double		hv_acct_bal;
	double		hv_intransit;
	double		hv_lien;
	double		hv_prepaid;
	varchar		hv_add_user[PD_USER_LEN];

	short           ind_txn_id = -1;
	short		ind_mms_psp_id = -1;
	short		ind_txn_amount = -1;
	short		ind_txn_ccy = -1;
	short		ind_acct_bal = -1;
	short		ind_intransit = -1;
	short		ind_lien = -1;
	short		ind_prepaid = -1;
	short		ind_add_user = -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("AddNatureDetail: Begin\n"));


/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("AddNatureDetail:txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
        }


/* mms_psp_id */
        if (GetField_CString(hRls,"mms_[id",&csTmp)) {
                hv_mms_psp_id.len = strlen(csTmp);
                memcpy(hv_mms_psp_id.arr,csTmp,hv_mms_psp_id.len);
                ind_mms_psp_id = 0;
DEBUGLOG(("AddNatureDetail:mms_psp_id = [%.*s]\n",hv_mms_psp_id.len,hv_mms_psp_id.arr));
        }

/* txn_amount */
        if (GetField_Double(hRls,"txn_amount",&dTmp)) {
		hv_txn_amount = dTmp;
                ind_txn_amount = 0;
DEBUGLOG(("AddNatureDetail:txn_amount = [%lf]\n",dTmp));
	}

/* txn_ccy */
        if (GetField_CString(hRls,"txn_ccy",&csTmp)) {
                hv_txn_ccy.len = strlen(csTmp);
                memcpy(hv_txn_ccy.arr,csTmp,hv_txn_ccy.len);
                ind_txn_ccy = 0;
DEBUGLOG(("AddNatureDetail:txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));
        }

/* acct_bal */
        if (GetField_Double(hRls,"acct_bal",&dTmp)) {
		hv_acct_bal = dTmp;
                ind_acct_bal = 0;
DEBUGLOG(("AddNatureDetail:acct_bal = [%lf]\n",dTmp));
	}

/* intransit */
        if (GetField_Double(hRls,"intransit",&dTmp)) {
		hv_intransit = dTmp;
                ind_intransit = 0;
DEBUGLOG(("AddNatureDetail:intransit = [%lf]\n",dTmp));
	}

/* lien */
        if (GetField_Double(hRls,"lien",&dTmp)) {
		hv_lien = dTmp;
                ind_lien = 0;
DEBUGLOG(("AddNatureDetail:lien = [%lf]\n",dTmp));
	}

/* prepaid */
        if (GetField_Double(hRls,"prepaid",&dTmp)) {
		hv_prepaid = dTmp;
                ind_prepaid = 0;
DEBUGLOG(("AddNatureDetail:prepaid = [%lf]\n",dTmp));
	}


/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen(csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("AddNatureDetail:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }


	EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_mms_txn_nature_dt_insert(
                                        :hv_txn_id:ind_txn_id,
                                        :hv_mms_psp_id:ind_mms_psp_id,
                                        :hv_txn_amount:ind_txn_amount,
                                        :hv_txn_ccy:ind_txn_ccy,
                                        :hv_acct_bal:ind_acct_bal,
                                        :hv_intransit:ind_intransit,
                                        :hv_lien:ind_lien,
                                        :hv_prepaid:ind_prepaid,
					:hv_add_user:ind_add_user
					);
                END;
        END-EXEC;

DEBUGLOG(("AddNatureDetail:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("AddNatureDetail:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MmsTransaction_AddNatureDetail: SP_OTHER_ERR\n");
DEBUGLOG(("AddNatureDetail: SP_OTHER_ERR\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("MmsTransaction_AddNatureDetail: SP_ERR\n");
DEBUGLOG(("AddNatureDetail: SP_ERR\n"));
                return PD_ERR;
        }

addnaturedetail_error:
DEBUGLOG(("addnaturedetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("MmsTransaction_AddNatureDetail: SP_INTERNAL_ERR\n");
DEBUGLOG(("AddnatureDetail: SP_INTERNAL_ERR\n"));
        return PD_INTERNAL_ERR;
}


int UpdateNatureDetail(const hash_t *hRls)
{
        char*   csPtr;
        char*   csBuf;
        char*   csTxnId;
	double	dTmp;

        EXEC SQL WHENEVER SQLERROR GOTO update_detail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        varchar         hv_dynstmt[PD_TMP_MSG_BUF_LEN];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("UpdateDetail: Begin\n"));
        csBuf = (char*) malloc (PD_TMP_BUF_LEN);
        strcpy((char*)hv_dynstmt.arr,"update mms_txn_nature_detail set mtn_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"txn_seq",&csTxnId);
DEBUGLOG(("UpdateDetail:txn_id = [%s]\n",csTxnId));


/* mms_psp_id */
        if (GetField_CString(hRls,"mms_psp_id",&csPtr)) {
DEBUGLOG(("UpdateNatureDetail:mms_psp_id = [%s]\n",csPtr));
                strcat((char*)hv_dynstmt.arr, ",mtn_mms_psp_id = '");
                strcat((char*)hv_dynstmt.arr, csPtr);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* txn_amount   */
        if (GetField_Double(hRls,"txn_amt",&dTmp)) {
DEBUGLOG(("Update:txn_amt = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtn_txn_amount = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* txn_ccy */
        if (GetField_CString(hRls,"txn_ccy",&csPtr)) {
DEBUGLOG(("UpdateNatureDetail:txn_ccy = [%s]\n",csPtr));
                strcat((char*)hv_dynstmt.arr, ",mtn_txn_ccy = '");
                strcat((char*)hv_dynstmt.arr, csPtr);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* acct_bal   */
        if (GetField_Double(hRls,"acct_bal",&dTmp)) {
DEBUGLOG(("Update:acct_bal = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtn_acct_bal = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* intransit   */
        if (GetField_Double(hRls,"intransit",&dTmp)) {
DEBUGLOG(("Update:intransit = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtn_intransit = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* lien   */
        if (GetField_Double(hRls,"lien",&dTmp)) {
DEBUGLOG(("Update:lien = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtn_lien = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* prepaid   */
        if (GetField_Double(hRls,"prepaid",&dTmp)) {
DEBUGLOG(("Update:prepaid = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtn_prepaid = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* update user */
        if (GetField_CString(hRls,"update_user",&csPtr)) {
DEBUGLOG(("UpdateNatureDetail:update_user = [%s]\n",csPtr));
                strcat((char*)hv_dynstmt.arr, ",mtn_update_user = '");
                strcat((char*)hv_dynstmt.arr, csPtr);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* update timestap */
	strcat((char*)hv_dynstmt.arr, ",mtn_update_timestamp = sysdate ");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

strcat((char *)hv_dynstmt.arr, " WHERE td_txn_id = '");
        strcat((char *)hv_dynstmt.arr, csTxnId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

        FREE_ME(csBuf);


DEBUGLOG(("UpdateNatureDetail Normal Exit\n"));
        return PD_OK;

update_detail_error:
DEBUGLOG(("update_detail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_UpdateDetail: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("UpdateDetail: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;
}


int GetTxnNatureDetail(const char* csTxnID,
                recordset_t* myRec)
{

        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO gettxnnaturedetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];

		varchar		v_mms_psp_id[PD_MMS_PID_LEN +1 ];
		double		v_txn_amt;
		varchar		v_txn_ccy[PD_CCY_ID_LEN +1 ];
		double		v_acct_bal;
		double		v_intransit;
		double		v_lien;
		double		v_prepaid;

		short		ind_mms_psp_id;
		short		ind_txn_amt;
		short		ind_txn_ccy;
		short		ind_acct_bal;
		short		ind_intransit;
		short		ind_lien;
		short		ind_prepaid;


	EXEC SQL END DECLARE SECTION;

        hv_txn_id.len = strlen(csTxnID);
        memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetTxnNatureDetail txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_gettxnnaturedetail CURSOR FOR
                select
		        mtn_mms_psp_id,
		        mtn_txn_amount,
		        mtn_txn_ccy,
		        mtn_acct_bal,
		        mtn_intransit,
		        mtn_lien,
			mtn_prepaid
                  from mms_txn_nature_detail
                 where mtn_txn_id = :hv_txn_id;

	EXEC SQL OPEN c_cursor_gettxnnaturedetail;
        do {
                EXEC SQL FETCH c_cursor_gettxnnaturedetail
                INTO
                        :v_mms_psp_id:ind_mms_psp_id,
                        :v_txn_amt:ind_txn_amt,
                        :v_txn_ccy:ind_txn_ccy,
                        :v_acct_bal:ind_acct_bal,
                        :v_intransit:ind_intransit,
			:v_prepaid:ind_prepaid,
			:v_lien:ind_lien;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

	 	myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/* mms_psp_id */
                if (ind_mms_psp_id  >=  0) {
                        v_mms_psp_id.arr[v_mms_psp_id.len] = '\0';
                        PutField_CString(myHash,"mms_psp_id",(const char*)v_mms_psp_id.arr);
DEBUGLOG(("GetTxnNatureDetail mms_psp_id = [%s]\n",v_mms_psp_id.arr));
                }

/* txn amt */
		if (ind_txn_amt< 0)
                        v_txn_amt= 0.0;
DEBUGLOG(("GetTxnNatureDetail txn_amt = [%f]\n",v_txn_amt));
                PutField_Double(myHash,"txn_amt",v_txn_amt);

/* txn ccy */
                if (ind_txn_ccy >= 0) {
                        v_txn_ccy.arr[v_txn_ccy.len] ='\0';
                        PutField_CString(myHash,"txn_ccy",(const char*)v_txn_ccy.arr);
DEBUGLOG(("GetTxnNatureDetail txn_ccy = [%s]\n",v_txn_ccy.arr));
                }

/* acct_bal  */
		if (ind_acct_bal< 0)
                        v_acct_bal= 0.0;
DEBUGLOG(("GetTxnNatureDetail acct_bal = [%f]\n",v_acct_bal));
                PutField_Double(myHash,"acct_bal",v_acct_bal);

/* intransit  */
		if (ind_intransit< 0)
                        v_intransit= 0.0;
DEBUGLOG(("GetTxnNatureDetail intransit = [%f]\n",v_intransit));
                PutField_Double(myHash,"acct_bal",v_intransit);

/* lien  */
		if (ind_lien< 0)
                        v_lien= 0.0;
DEBUGLOG(("GetTxnNatureDetail lien = [%f]\n",v_lien));
                PutField_Double(myHash,"lien",v_lien);

/* prepaid  */
		if (ind_prepaid< 0)
                        v_prepaid= 0.0;
DEBUGLOG(("GetTxnNatureDetail prepaid = [%f]\n",v_prepaid));
                PutField_Double(myHash,"prepaid",v_prepaid);

		RecordSet_Add(myRec,myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_gettxnnaturedetail;


DEBUGLOG(("GetTxnNatureDetail Normal Exit\n"));
        return  PD_OK;

gettxnnaturedetail_error:
DEBUGLOG(("GetTxnNatureDetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_gettxnnaturedetail;
        return PD_ERR;
}


