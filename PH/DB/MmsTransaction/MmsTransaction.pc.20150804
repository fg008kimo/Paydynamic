/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/04/29              Cody Chan
Add MatchTxnStatus				   2015/06/29		   Cody Chan
Add ChkTxnCodeExist				   2015/06/30		   Elvis Wong
Remove TxnCountry				   2015/07/22		   Cody Chan
Add Allow Prepaid				   2015/07/23		   Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "MmsTransaction.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "ObjPtr.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode
OBJPTR(DB);

char    cDebug;
void MmsTransaction(char    cdebug)
{
        cDebug = cdebug;
}

int Add(const hash_t *hRls)
{
        char		*csTmp;
        char        	cTmp;
	int		iCommit = PD_TRUE;
	int		iTmp;
	double		dTmp;


        EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short 		hv_return_value;

	varchar		hv_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_org_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_action_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_channel_code[PD_CHANNEL_CODE_LEN];
	char		hv_status;
	char		hv_ar_ind;
	varchar		hv_sub_status[PD_SUB_STATUS_LEN];
	varchar		hv_txn_code[PD_TXN_CODE_LEN];
	varchar		hv_process_type[PD_PROCESS_TYPE_LEN];
	varchar		hv_process_code[PD_PROCESS_CODE_LEN];
	varchar		hv_node_id[PD_MMS_NODE_ID_LEN];
	varchar		hv_node_ref[PD_MMS_NODE_REF_LEN];
	varchar		hv_host_posting_date[PD_DATE_LEN];
	varchar		hv_transmission_datetime[PD_DATE_LEN + PD_TIME_LEN];
	int		hv_internal_code;
	varchar		hv_response_code[PD_RESPONSE_CODE_LEN];
	double		hv_transaction_amt;
	varchar		hv_txn_ccy[PD_CCY_ID_LEN];
	double		hv_remaining_amt;
	double		hv_net_amt;
	varchar		hv_net_ccy[PD_CCY_ID_LEN +1];
	varchar		hv_local_tm_date[PD_DATE_LEN];
	varchar		hv_local_tm_time[PD_TIME_LEN];
	varchar		hv_tm_date[PD_DATE_LEN];
	varchar		hv_tm_time[PD_TIME_LEN];
	varchar		hv_client_ip[PD_IP_LEN];
	int		hv_apply_cost;
	char		hv_action;
	char		hv_allow_prepaid;
	varchar		hv_related_txn_id[PD_TXN_SEQ_LEN];
	varchar		hv_add_user[PD_USER_LEN];



	short		ind_txn_id = -1;
	short		ind_org_txn_id = -1;
	short		ind_action_txn_id = -1;
	short		ind_channel_code = -1;
	short		ind_status = -1;
	short		ind_ar_ind = -1;
	short		ind_sub_status = -1;
	short		ind_txn_code = -1;
	short		ind_process_type = -1;
	short		ind_process_code = -1;
	short		ind_node_id = -1;
	short		ind_node_ref = -1;
	short		ind_host_posting_date = -1;
	short		ind_transmission_datetime = -1;
	short		ind_internal_code = -1;
	short		ind_response_code = -1;
	short		ind_transaction_amt = -1;
	short		ind_txn_ccy = -1;
	short		ind_remaining_amt = -1;
	short		ind_net_amt = -1;
	short		ind_net_ccy = -1;
	short		ind_local_tm_date = -1;
	short		ind_local_tm_time = -1;
	short		ind_tm_date = -1;
	short		ind_tm_time = -1;
	short		ind_client_ip= -1;
	short		ind_apply_cost = -1;
	short		ind_action = -1;
	short		ind_allow_prepaid = -1;
	short		ind_related_txn_id = -1;
	short		ind_add_user = -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));

        if (GetField_Int(hRls,"db_commit",&iCommit)) {
DEBUGLOG(("Add:db_commit = [%d]\n",iCommit));
	}
	else {
DEBUGLOG(("Add:db_commit default true \n"));
	}

/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("Add:txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
        }
/* org txn_seq */
        if (GetField_CString(hRls,"org_txn_seq",&csTmp)) {
                hv_org_txn_id.len = strlen(csTmp);
                memcpy(hv_org_txn_id.arr,csTmp,hv_org_txn_id.len);
                ind_org_txn_id = 0;
DEBUGLOG(("Add:org_txn_id = [%.*s]\n",hv_org_txn_id.len,hv_org_txn_id.arr));
        }
/* action_txn_seq */
        if (GetField_CString(hRls,"action_txn_seq",&csTmp)) {
                hv_action_txn_id.len = strlen(csTmp);
                memcpy(hv_action_txn_id.arr,csTmp,hv_action_txn_id.len);
                ind_action_txn_id = 0;
DEBUGLOG(("Add:action_txn_id = [%.*s]\n",hv_action_txn_id.len,hv_action_txn_id.arr));
        }
/* Channel code */
        if (GetField_CString(hRls,"channel_code",&csTmp)) {
                hv_channel_code.len = strlen(csTmp);
                memcpy(hv_channel_code.arr,csTmp,hv_channel_code.len);
                ind_channel_code = 0;
DEBUGLOG(("Add:channel_code = [%.*s]\n",hv_channel_code.len,hv_channel_code.arr));
        }


/* Status */ 
        if (GetField_Char(hRls,"status",&cTmp)) {
		hv_status = cTmp;
                ind_status = 0;
DEBUGLOG(("Add:status = [%c]\n",hv_status));
        }

/* ar ind */ 
        if (GetField_Char(hRls,"ar_ind",&cTmp)) {
		hv_ar_ind = cTmp;
                ind_ar_ind = 0;
DEBUGLOG(("Add:ar_ind = [%c]\n",hv_ar_ind));
        }

/* Sub Status */ 
        if (GetField_CString(hRls,"sub_status",&csTmp)) {
                hv_sub_status.len = strlen(csTmp);
                memcpy(hv_sub_status.arr,csTmp,hv_sub_status.len);
                ind_sub_status = 0;
DEBUGLOG(("Add:sub_status = [%.*s]\n",hv_sub_status.len,hv_sub_status.arr));
        }

/* Txn Code */
        if (GetField_CString(hRls,"txn_code",&csTmp)) {
                hv_txn_code.len = strlen(csTmp);
                memcpy(hv_txn_code.arr,csTmp,hv_txn_code.len);
                ind_txn_code = 0;
DEBUGLOG(("Add:txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));
        }

/* process type */
        if (GetField_CString(hRls,"process_type",&csTmp)) {
                hv_process_type.len = strlen(csTmp);
                memcpy(hv_process_type.arr,csTmp,hv_process_type.len);
                ind_process_type = 0;
DEBUGLOG(("Add:process_type = [%.*s]\n",hv_process_type.len,hv_process_type.arr));
        }

/* process code */
        if (GetField_CString(hRls,"process_code",&csTmp)) {
                hv_process_code.len = strlen(csTmp);
                memcpy(hv_process_code.arr,csTmp,hv_process_code.len);
                ind_process_code = 0;
DEBUGLOG(("Add:process_code = [%.*s]\n",hv_process_code.len,hv_process_code.arr));
        }

/* node_id */
        if (GetField_CString(hRls,"node_id",&csTmp)) {
                hv_node_id.len = strlen(csTmp);
                memcpy(hv_node_id.arr,csTmp,hv_node_id.len);
                ind_node_id = 0;
DEBUGLOG(("Add:node_id = [%.*s]\n",hv_node_id.len,hv_node_id.arr));
        }

/* node_ref */
        if (GetField_CString(hRls,"node_ref",&csTmp)) {
                hv_node_ref.len = strlen(csTmp);
                memcpy(hv_node_ref.arr,csTmp,hv_node_ref.len);
                ind_node_ref = 0;
DEBUGLOG(("Add:node_ref = [%.*s]\n",hv_node_ref.len,hv_node_ref.arr));
        }



/* host posting date */
        if (GetField_CString(hRls,"host_posting_date",&csTmp)) {
                hv_host_posting_date.len = strlen(csTmp);
                memcpy(hv_host_posting_date.arr,csTmp,hv_host_posting_date.len);
                ind_host_posting_date = 0;
DEBUGLOG(("Add:host_posting_date = [%.*s]\n",hv_host_posting_date.len,hv_host_posting_date.arr));
        }



/* internal code */
        if (GetField_Int(hRls,"internal_code",&iTmp)) {
		hv_internal_code = iTmp;
                ind_internal_code = 0;
DEBUGLOG(("Add:internal code = [%d]\n",hv_internal_code));
        }

/* response code  */
        if (GetField_CString(hRls,"response_code",&csTmp)) {
                hv_response_code.len = strlen(csTmp);
                memcpy(hv_response_code.arr,csTmp,hv_response_code.len);
                ind_response_code = 0;
DEBUGLOG(("Add:response_code = [%.*s]\n",hv_response_code.len,hv_response_code.arr));
        }

/* transaction amt   */
        if (GetField_Double(hRls,"txn_amt",&dTmp)) {
		hv_transaction_amt = dTmp;
                ind_transaction_amt = 0;
DEBUGLOG(("Add:txn_amt = [%f]\n",hv_transaction_amt));
        }

/* txn_ccy */
        if (GetField_CString(hRls,"txn_ccy",&csTmp)) {
                hv_txn_ccy.len = strlen(csTmp);
                memcpy(hv_txn_ccy.arr,csTmp,hv_txn_ccy.len);
                ind_txn_ccy = 0;
DEBUGLOG(("Add:txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));
        }
/* remaining amt   */
        if (GetField_Double(hRls,"remaining_amt",&dTmp)) {
		hv_remaining_amt = dTmp;
                ind_remaining_amt = 0;
DEBUGLOG(("Add:remaining_amt = [%f]\n",hv_remaining_amt));
        }


/* net amt   */
        if (GetField_Double(hRls,"net_amt",&dTmp)) {
		hv_net_amt = dTmp;
                ind_net_amt = 0;
DEBUGLOG(("Add:net_amt = [%f]\n",hv_net_amt));
        }

/* net ccy */
        if (GetField_CString(hRls,"net_ccy",&csTmp)) {
                hv_net_ccy.len = strlen(csTmp);
                memcpy(hv_net_ccy.arr,csTmp,hv_net_ccy.len);
                ind_net_ccy = 0;
DEBUGLOG(("Add:net_ccy = [%.*s]\n",hv_net_ccy.len,hv_net_ccy.arr));
        }

/* transmission_datetime */
        if (GetField_CString(hRls,"transmission_datetime",&csTmp)) {
                hv_transmission_datetime.len = strlen(csTmp);
                memcpy(hv_transmission_datetime.arr,csTmp,hv_transmission_datetime.len);
                ind_transmission_datetime = 0;
DEBUGLOG(("Add:transmission_datetime = [%.*s]\n",hv_transmission_datetime.len,hv_transmission_datetime.arr));
        }

/* local tm date */
        if (GetField_CString(hRls,"local_tm_date",&csTmp)) {
                hv_local_tm_date.len = strlen(csTmp);
                memcpy(hv_local_tm_date.arr,csTmp,hv_local_tm_date.len);
                ind_local_tm_date = 0;
DEBUGLOG(("Add:local_tm_date = [%.*s]\n",hv_local_tm_date.len,hv_local_tm_date.arr));
        }

/* local tm time */
        if (GetField_CString(hRls,"local_tm_time",&csTmp)) {
                hv_local_tm_time.len = strlen(csTmp);
                memcpy(hv_local_tm_time.arr,csTmp,hv_local_tm_time.len);
                ind_local_tm_time = 0;
DEBUGLOG(("Add:local_tm_time = [%.*s]\n",hv_local_tm_time.len,hv_local_tm_time.arr));
        }

/* tm date */
        if (GetField_CString(hRls,"tm_date",&csTmp)) {
                hv_tm_date.len = strlen(csTmp);
                memcpy(hv_tm_date.arr,csTmp,hv_tm_date.len);
                ind_tm_date = 0;
DEBUGLOG(("Add:tm_date = [%.*s]\n",hv_tm_date.len,hv_tm_date.arr));
        }

/* tm time */
        if (GetField_CString(hRls,"tm_time",&csTmp)) {
                hv_tm_time.len = strlen(csTmp);
                memcpy(hv_tm_time.arr,csTmp,hv_tm_time.len);
                ind_tm_time = 0;
DEBUGLOG(("Add:tm_time = [%.*s]\n",hv_tm_time.len,hv_tm_time.arr));
        }

/* client ip */
        if (GetField_CString(hRls,"ip_addr",&csTmp)) {
		char *p;
		char    csTmpIP[PD_IP_LEN+1];
                p = strtok (csTmp,",");
                while (p != NULL)
                {
                        strcpy(csTmpIP,p);
                        csTmpIP[strlen(p)]='\0';
			break;
                }
                hv_client_ip.len = strlen(csTmpIP);
                memcpy(hv_client_ip.arr,csTmpIP,hv_client_ip.len);
                ind_client_ip = 0;
DEBUGLOG(("Add:client_ip = [%.*s]\n",hv_client_ip.len,hv_client_ip.arr));
        }

/* apply cost   */
        if (GetField_Int(hRls,"apply_cost",&iTmp)) {
		hv_apply_cost = iTmp;
                ind_apply_cost = 0;
DEBUGLOG(("Add:apply_cost = [%d]\n",hv_apply_cost));
        }

/* action */
        if (GetField_Char(hRls,"action",&cTmp)) {
		hv_action = cTmp;
		ind_action = 0; 
DEBUGLOG(("Add:action = [%c]\n",hv_action));
        }

/* allow_prepaid */
        if (GetField_Char(hRls,"allow_prepaid",&cTmp)) {
		hv_allow_prepaid = cTmp;
		ind_allow_prepaid = 0; 
DEBUGLOG(("Add:allow_prepaid = [%c]\n",hv_allow_prepaid));
        }

/* related_txn_id */
        if (GetField_CString(hRls,"related_txn_id",&csTmp)) {
                hv_related_txn_id.len = strlen(csTmp);
                memcpy(hv_related_txn_id.arr,csTmp,hv_related_txn_id.len);
                ind_related_txn_id = 0;
DEBUGLOG(("Add:related_txn_id = [%.*s]\n",hv_related_txn_id.len,hv_related_txn_id.arr));
        }
/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen(csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("Add:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }

	EXEC SQL EXECUTE
                BEGIN
			:hv_return_value := sp_mms_txn_header_insert(
					:hv_txn_id:ind_txn_id,
					:hv_org_txn_id:ind_org_txn_id,
					:hv_action_txn_id:ind_action_txn_id,
					:hv_channel_code:ind_channel_code,
					:hv_status:ind_status,
					:hv_ar_ind:ind_ar_ind,
					:hv_sub_status:ind_sub_status,
					:hv_txn_code:ind_txn_code,
					:hv_process_type:ind_process_type,
					:hv_process_code:ind_process_code,
					:hv_node_id:ind_node_id,
					:hv_node_ref:ind_node_ref,
					:hv_host_posting_date:ind_host_posting_date,
					:hv_transmission_datetime:ind_transmission_datetime,
					:hv_internal_code:ind_internal_code,
					:hv_response_code:ind_response_code,
					:hv_transaction_amt:ind_transaction_amt,
					:hv_txn_ccy:ind_txn_ccy,
					:hv_remaining_amt:ind_remaining_amt,
					:hv_net_amt:ind_net_amt,
					:hv_net_ccy:ind_net_ccy,
					:hv_client_ip:ind_client_ip,
					:hv_apply_cost:ind_apply_cost,
					:hv_action:ind_action,
					:hv_allow_prepaid:ind_allow_prepaid,
					:hv_related_txn_id:ind_related_txn_id,
					:hv_local_tm_date:ind_local_tm_date,
					:hv_local_tm_time:ind_local_tm_time,
					:hv_tm_date:ind_tm_date,
					:hv_tm_time:ind_tm_time,
					:hv_add_user:ind_add_user,
					:hv_add_user:ind_add_user);
	        END;
        END-EXEC;


DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("Add:Normal Exit\n"));
		if (iCommit == PD_TRUE)
			TxnCommit();
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MmsTransaction_Add: SP_OTHER_ERR\n");
DEBUGLOG(("Add: SP_OTHER_ERR\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("MmsTransaction_Add: SP_ERR\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
                return PD_ERR;
        }

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("MmsTransaction_Add: SP_INTERNAL_ERR\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR\n"));
        return PD_INTERNAL_ERR;
}


int Update(const hash_t *hRls)
{

        char*   csTmp;
	char	cTmp;
        double  dTmp;
        int     iTmp;
        char*   csBuf;
        char*   csTxnId;
	char	cStatus;
	char	cArInd;
        EXEC SQL WHENEVER SQLERROR GOTO update_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        varchar         hv_dynstmt[PD_TMP_MSG_BUF_LEN];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
        csBuf = (char*) malloc (PD_TMP_BUF_LEN);
        strcpy((char*)hv_dynstmt.arr,"update mms_txn_header set mth_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"txn_seq",&csTxnId);
DEBUGLOG(("Update:txn_id = [%s]\n",csTxnId));

/* org txn_seq */
        if (GetField_CString(hRls,"org_txn_seq",&csTmp)) {
DEBUGLOG(("Update:org_txn_id = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_org_txn_id = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* Channel code */
        if (GetField_CString(hRls,"channel_code",&csTmp)) {
DEBUGLOG(("Update:channel_code = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_input_channel = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* Status */
        if (GetField_Char(hRls,"status",&cStatus)) {
DEBUGLOG(("Update:status = [%c]\n",cStatus));
                sprintf(csBuf,"%c",cStatus);
                strcat((char*)hv_dynstmt.arr, ",mth_status = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* ar ind */
        if (GetField_Char(hRls,"ar_ind",&cArInd)) {
DEBUGLOG(("Update:ar_ind = [%c]\n",cArInd));
                sprintf(csBuf,"%c",cArInd);
                strcat((char*)hv_dynstmt.arr, ",mth_ar_ind = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* Sub Status */
        if (GetField_CString(hRls,"sub_status",&csTmp)) {
DEBUGLOG(("Update:sub_status = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_sub_status = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* Txn Code */
        if (GetField_CString(hRls,"txn_code",&csTmp)) {
DEBUGLOG(("Update:txn_code = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_txn_code = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* process type */
        if (GetField_CString(hRls,"process_type",&csTmp)) {
DEBUGLOG(("Update:process_type = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_process_type = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* process code */
        if (GetField_CString(hRls,"process_code",&csTmp)) {
DEBUGLOG(("Update:process_code = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_process_code = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* host posting date */
        if (GetField_CString(hRls,"host_posting_date",&csTmp)) {
DEBUGLOG(("Update:host_posting_date = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_host_posting_date = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* transmission_datetime  */
        if (GetField_CString(hRls,"transmission_datetime",&csTmp)) {
DEBUGLOG(("Update:transmission_datetime = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_transmission_datetime = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* internal code  */
        if (GetField_Int(hRls,"internal_code",&iTmp)) {
DEBUGLOG(("Update:internal_code = [%d]\n",iTmp));
                sprintf(csBuf,"%d",iTmp);
                strcat((char*)hv_dynstmt.arr, ",mth_internal_code = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* response code  */
        if (GetField_CString(hRls,"response_code",&csTmp)) {
DEBUGLOG(("Update:response_code = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_response_code = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* transaction amt   */
        if (GetField_Double(hRls,"txn_amt",&dTmp)) {
DEBUGLOG(("Update:txn_amt = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mth_transaction_amount = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* txn ccy */
        if (GetField_CString(hRls,"txn_ccy",&csTmp)) {
DEBUGLOG(("Update:txn_ccy = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_txn_ccy = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* remaining amt   */
        if (GetField_Double(hRls,"remaining_amt",&dTmp)) {
DEBUGLOG(("Update:remaining_amt = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mth_remaining_amount = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* net amt   */
        if (GetField_Double(hRls,"net_amt",&dTmp)) {
DEBUGLOG(("Update:net_amt = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mth_net_amount = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* net ccy */
        if (GetField_CString(hRls,"net_ccy",&csTmp)) {
DEBUGLOG(("Update:net_ccy = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_net_ccy = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* local tm date */
        if (GetField_CString(hRls,"local_tm_date",&csTmp)) {
DEBUGLOG(("Update:local_tm_date = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_local_tm_date = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* local tm time */
        if (GetField_CString(hRls,"local_tm_time",&csTmp)) {
DEBUGLOG(("Update:local_tm_time = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_local_tm_time = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* ip_addr */
        if (GetField_CString(hRls,"ip_addr",&csTmp)) {
                char *p;
                char    csTmpIP[PD_IP_LEN+1];
                p = strtok (csTmp,",");
                while (p != NULL)
                {
                        strcpy(csTmpIP,p);
                        csTmpIP[strlen(p)]='\0';
                        break;
                }
DEBUGLOG(("Update:ip_addr = [%s]\n",csTmpIP));
                strcat((char*)hv_dynstmt.arr, ",mth_client_ip = '");
                strcat((char*)hv_dynstmt.arr, csTmpIP);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* approval date */
	if (cStatus == PD_COMPLETE && cArInd == PD_ACCEPT) {
DEBUGLOG(("Update:update approval date time \n"));
		char *csApprovalDate;
                char *csApprovalTimeStamp;
		char csRptDate[PD_DATE_LEN + 1];
		char csRptTime[PD_DATE_LEN + 1];
		hash_t  *hRec;

		hRec = (hash_t*) malloc (sizeof(hash_t));
                hash_init(hRec,0);

		DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
		if ((unsigned long)(*DBObjPtr)(hRec) == PD_FOUND) {
			GetField_CString(hRec,"approval_date",&csApprovalDate);
			GetField_CString(hRec,"approval_timestamp",&csApprovalTimeStamp);
DEBUGLOG(("Update:update approval date =[%s]\n",csApprovalDate));
DEBUGLOG(("Update:update approval timestamp =[%s]\n",csApprovalTimeStamp));
		}

		memcpy(csRptDate,csApprovalTimeStamp,PD_DATE_LEN);
		csRptDate[PD_DATE_LEN] = '\0';
		memcpy(csRptTime,&csApprovalTimeStamp[PD_DATE_LEN],PD_DATE_LEN);
		csRptTime[PD_DATE_LEN] = '\0';
DEBUGLOG(("Update:update RPT approval date =[%s]\n",csRptDate));
DEBUGLOG(("Update:update RPT approval time =[%s]\n",csRptTime));
/*approval date */
		strcat((char*)hv_dynstmt.arr, ",mth_approval_date = '");
                strcat((char*)hv_dynstmt.arr, csApprovalDate);
                strcat((char*)hv_dynstmt.arr, "'");

/*approval timestmap */
		strcat((char*)hv_dynstmt.arr, ",mth_approval_timestamp = to_timestamp('");
                strcat((char*)hv_dynstmt.arr, csApprovalTimeStamp);
                strcat((char*)hv_dynstmt.arr, "','YYYYMMDDHH24MISSFF') ");

/*RPT approval date */
		strcat((char*)hv_dynstmt.arr, ",mth_rpt_approval_date = '");
                strcat((char*)hv_dynstmt.arr, csRptDate);
                strcat((char*)hv_dynstmt.arr, "'");

/*RPT approval time */
		strcat((char*)hv_dynstmt.arr, ",mth_rpt_approval_time = '");
                strcat((char*)hv_dynstmt.arr, csRptTime);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

		hash_destroy(hRec);
                FREE_ME(hRec);
	}

/* update user */
        if (GetField_CString(hRls,"update_user",&csTmp)) {
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_update_user = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* related_txn_id */
        if (GetField_CString(hRls,"related_txn_id",&csTmp)) {
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mth_related_txn_id = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* allow prepiad */
        if (GetField_Char(hRls,"allow_prepaid",&cTmp)) {
DEBUGLOG(("Update:update_user = [%c]\n",cTmp));
		sprintf(csBuf,"%c",cTmp);
                strcat((char*)hv_dynstmt.arr, ",mth_allow_prepaid = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


        strcat((char *)hv_dynstmt.arr, " WHERE mth_txn_id = '");
        strcat((char *)hv_dynstmt.arr, csTxnId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

        FREE_ME(csBuf);

// update txn sub status
//        AddTxnStatusLog(hRls);

DEBUGLOG(("Update Normal Exit\n"));
        return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("MMS Transaction_Update: SP_INTERNAL_ERR \n");
DEBUGLOG(("Update: SP_INTERNAL_ERR \n"));
        return PD_INTERNAL_ERR;
}


int GetTxnHeader(const char* csTxnID,
                recordset_t* myRec)
{

        char    csDate[PD_DATE_LEN +1];
        char    csTime[PD_TIME_LEN +1];
        char    csDateTime[PD_DATE_LEN + PD_TIME_LEN +1];
        hash_t *myHash;
        int     iCnt = 0;

        EXEC SQL WHENEVER SQLERROR GOTO gettxnheader_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];

                varchar         v_org_txn_id[PD_TXN_SEQ_LEN + 1];
                varchar         v_client_id[PD_CLIENT_ID_LEN + 1];
                char            v_status;
                char            v_ar_ind;
		varchar         v_sub_status[PD_SUB_STATUS_LEN + 1];
                varchar         v_txn_code[PD_TXN_CODE_LEN + 1];
                double          v_txn_amt;
                varchar         v_txn_ccy[PD_CCY_ID_LEN +1];
                double          v_remaining_amt;
                double          v_net_amt;
                varchar         v_net_ccy[PD_CCY_ID_LEN +1];
                varchar         v_transmission_datetime[PD_DATE_LEN + PD_TIME_LEN + 1];
                varchar         v_local_tm_date[PD_DATE_LEN + 1];
                varchar         v_local_tm_time[PD_TIME_LEN + 1];
                varchar         v_tm_date[PD_DATE_LEN + 1];
                varchar         v_tm_time[PD_TIME_LEN + 1];
                long            v_internal_code;
                varchar         v_channel_code[PD_CHANNEL_CODE_LEN + 1];
                varchar         v_response_code[PD_RESPONSE_CODE_LEN + 1];
                varchar         v_host_posting_date[PD_DATE_LEN + 1];
                varchar         v_process_code[PD_PROCESS_CODE_LEN + 1];
                varchar         v_process_type[PD_PROCESS_TYPE_LEN + 1];
                varchar         v_client_ip[PD_IP_LEN + 1];
		int		v_apply_cost;
		varchar		v_related_txn_id[PD_TXN_SEQ_LEN +1];
		

		short           ind_org_txn_id = -1;
                short           ind_client_id = -1;
                short           ind_status = -1;
                short           ind_ar_ind = -1;
                short           ind_sub_status = -1;
                short           ind_txn_code = -1;
                short           ind_txn_amt = -1;
                short           ind_txn_ccy = -1;
                short           ind_remaining_amt = -1;
                short           ind_net_amt = -1;
                short           ind_net_ccy = -1;
                short           ind_transmission_datetime = -1;
                short           ind_local_tm_date = -1;
                short           ind_local_tm_time = -1;
                short           ind_tm_date = -1;
                short           ind_tm_time = -1;
                short           ind_internal_code = -1;
                short           ind_channel_code = -1;
                short           ind_response_code = -1;
                short           ind_host_posting_date = -1;
                short           ind_process_code= -1;
                short           ind_process_type= -1;
                short           ind_client_ip = -1;
		short		ind_apply_cost = -1;
		short		ind_related_txn_id = -1;

        EXEC SQL END DECLARE SECTION;

        hv_txn_id.len = strlen(csTxnID);
        memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetTxnHeader txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_gettxnheader CURSOR FOR
                select mth_org_txn_id,
                       mth_status,
                       mth_ar_ind,
                       mth_sub_status,
                       mth_txn_code,
                       mth_transaction_amount,
                       mth_txn_ccy,
                       mth_remaining_amount,
                       mth_net_amount,
                       mth_net_ccy,
                       mth_transmission_datetime,
                       mth_local_tm_date,
                       mth_local_tm_time,
                       mth_tm_date,
                       mth_tm_time,
                       mth_internal_code,
                       mth_response_code,
                       mth_host_posting_date,
                       mth_process_code,
                       mth_process_type,
                       mth_input_channel,
                       mth_client_ip,
		       mth_apply_cost,
		       mth_related_txn_id
                  from mms_txn_header
                 where mth_txn_id = :hv_txn_id;


        EXEC SQL OPEN c_cursor_gettxnheader;
        do {
                EXEC SQL FETCH c_cursor_gettxnheader
                INTO
                        :v_org_txn_id:ind_org_txn_id,
                        :v_status:ind_status,
                        :v_ar_ind:ind_ar_ind,
                        :v_sub_status:ind_sub_status,
                        :v_txn_code:ind_txn_code,
                        :v_txn_amt:ind_txn_amt,
                        :v_txn_ccy:ind_txn_ccy,
                        :v_remaining_amt:ind_remaining_amt,
                        :v_net_amt:ind_net_amt,
                        :v_net_ccy:ind_net_ccy,
                        :v_transmission_datetime:ind_transmission_datetime,
                        :v_local_tm_date:ind_local_tm_date,
                        :v_local_tm_time:ind_local_tm_time,
                        :v_tm_date:ind_tm_date,
                        :v_tm_time:ind_tm_time,
                        :v_internal_code:ind_internal_code,
                        :v_response_code:ind_response_code,
                        :v_host_posting_date:ind_host_posting_date,
                        :v_process_code:ind_process_code,
                        :v_process_type:ind_process_type,
                        :v_channel_code:ind_channel_code,
                        :v_client_ip:ind_client_ip,
			:v_apply_cost:ind_apply_cost,
			:v_related_txn_id:ind_related_txn_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                iCnt++;

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

                if (ind_org_txn_id >= 0) {
                        v_org_txn_id.arr[v_org_txn_id.len] ='\0';
                        PutField_CString(myHash,"org_txn_id",(const char*)v_org_txn_id.arr);
DEBUGLOG(("GetTxnHeader org_txn_id = [%s]\n",v_org_txn_id.arr));
                }

                if (ind_client_id >= 0) {
                        v_client_id.arr[v_client_id.len] ='\0';
                        PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
DEBUGLOG(("GetTxnHeader client_id = [%s]\n",v_client_id.arr));
                }
                if (ind_status >= 0) {
DEBUGLOG(("GetTxnHeader status = [%c]\n",v_status));
                        PutField_Char(myHash,"status",v_status);
                }

                if (ind_ar_ind >= 0) {
DEBUGLOG(("GetTxnHeader ar_ind = [%c]\n",v_ar_ind));
                        PutField_Char(myHash,"ar_ind",v_ar_ind);
                }

                if (ind_sub_status>= 0) {
                        v_sub_status.arr[v_sub_status.len] ='\0';
                        PutField_CString(myHash,"sub_status",(const char*)v_sub_status.arr);
DEBUGLOG(("GetTxnHeader sub_status = [%s]\n",v_sub_status.arr));
                }


                if (ind_txn_code >= 0) {
                        v_txn_code.arr[v_txn_code.len] ='\0';
                        PutField_CString(myHash,"txn_code",(const char*)v_txn_code.arr);
DEBUGLOG(("GetTxnHeader txn_code = [%s]\n",v_txn_code.arr));
                }

                if (ind_process_code >= 0) {
                        v_process_code.arr[v_process_code.len] ='\0';
                        PutField_CString(myHash,"process_code",(const char*)v_process_code.arr);
DEBUGLOG(("GetTxnHeader process_code = [%s]\n",v_process_code.arr));
                }

                if (ind_process_type >= 0) {
                        v_process_type.arr[v_process_type.len] ='\0';
                        PutField_CString(myHash,"process_type",(const char*)v_process_type.arr);
DEBUGLOG(("GetTxnHeader process_type = [%s]\n",v_process_type.arr));
                }

                if (ind_txn_amt < 0)
                        v_txn_amt = 0.0;
                PutField_Double(myHash,"txn_amt",v_txn_amt);
DEBUGLOG(("GetTxnHeader txn_amt = [%f]\n",v_txn_amt));

                if (ind_txn_ccy >= 0) {
                        v_txn_ccy.arr[v_txn_ccy.len] ='\0';
                        PutField_CString(myHash,"txn_ccy",(const char*)v_txn_ccy.arr);
DEBUGLOG(("GetTxnHeader txn_ccy = [%s]\n",v_txn_ccy.arr));
                }
                if (ind_remaining_amt < 0)
                        v_remaining_amt = 0.0;
                PutField_Double(myHash,"remaining_amt",v_remaining_amt);
DEBUGLOG(("GetTxnHeader remaining_amt = [%f]\n",v_remaining_amt));


                if (ind_net_amt < 0)
                        v_net_amt = 0.0;
                PutField_Double(myHash,"net_amt",v_net_amt);
DEBUGLOG(("GetTxnHeader net_amt = [%f]\n",v_net_amt));

                if (ind_net_ccy >= 0) {
                        v_net_ccy.arr[v_net_ccy.len] ='\0';
                        PutField_CString(myHash,"net_ccy",(const char*)v_net_ccy.arr);
DEBUGLOG(("GetTxnHeader net_ccy = [%s]\n",v_net_ccy.arr));
                }

                if (ind_transmission_datetime >= 0) {
                        v_transmission_datetime.arr[v_transmission_datetime.len] ='\0';
                        PutField_CString(myHash,"transmission_datetime",(const char*)v_transmission_datetime.arr);
DEBUGLOG(("GetTxnHeader transmission_datetime = [%s]\n",v_transmission_datetime.arr));
                }
                if (ind_local_tm_date >= 0) {
                        v_local_tm_date.arr[v_local_tm_date.len] ='\0';
                        strcpy(csDate,(char*)v_local_tm_date.arr);
                        PutField_CString(myHash,"local_tm_date",(const char*)v_local_tm_date.arr);
DEBUGLOG(("GetTxnHeader local_tm_date = [%s]\n",v_local_tm_date.arr));
                }
                if (ind_local_tm_time >= 0) {
                        v_local_tm_time.arr[v_local_tm_time.len] ='\0';
                        strcpy(csTime,(char*)v_local_tm_time.arr);
                        PutField_CString(myHash,"local_tm_time",(const char*)v_local_tm_time.arr);
DEBUGLOG(("GetTxnHeader local_tm_time = [%s]\n",v_local_tm_time.arr));
                }

		if (ind_tm_date >= 0) {
                        v_tm_date.arr[v_local_tm_date.len] ='\0';
                        PutField_CString(myHash,"tm_date",(const char*)v_tm_date.arr);
DEBUGLOG(("GetTxnHeader tm_date = [%s]\n",v_tm_date.arr));
                }
                if (ind_tm_time >= 0) {
                        v_tm_time.arr[v_tm_time.len] ='\0';
                        PutField_CString(myHash,"tm_time",(const char*)v_tm_time.arr);
DEBUGLOG(("GetTxnHeader tm_time = [%s]\n",v_tm_time.arr));
                }

                if (ind_internal_code >= 0) {
                        PutField_Int(myHash,"internal_error",v_internal_code);
DEBUGLOG(("GetTxnHeader internal_code = [%d]\n",v_internal_code));
                }
                if (ind_channel_code >= 0) {
                        v_channel_code.arr[v_channel_code.len] ='\0';
                        PutField_CString(myHash,"channel_code",(const char*)v_channel_code.arr);
DEBUGLOG(("GetTxnHeader channel_code = [%s]\n",v_channel_code.arr));
                }
                if (ind_response_code >= 0) {
                        v_response_code.arr[v_response_code.len] ='\0';
                        PutField_CString(myHash,"response_code",(const char*)v_response_code.arr);
DEBUGLOG(("GetTxnHeader response_code = [%s]\n",v_response_code.arr));
                }
                if (ind_host_posting_date >= 0) {
                        v_host_posting_date.arr[v_host_posting_date.len] ='\0';
                        PutField_CString(myHash,"host_posting_date",(const char*)v_host_posting_date.arr);
DEBUGLOG(("GetTxnHeader host_posting_date = [%s]\n",v_host_posting_date.arr));
                }

DEBUGLOG(("GetTxnHeader formation local transmission_datetime\n"));
                strcpy(csDateTime,csDate);
                strcat(csDateTime,csTime);
DEBUGLOG(("GetTxnHeader local_transmission_datetime = [%s]\n",csDateTime));
                PutField_CString(myHash,"local_transmission_datetime",csDateTime);


                if (ind_client_ip>= 0) {
                        v_client_ip.arr[v_client_ip.len] ='\0';
                        PutField_CString(myHash,"ip_addr",(const char*)v_client_ip.arr);
DEBUGLOG(("GetTxnHeader client_ip = [%s]\n",v_client_ip.arr));
                }

                if (ind_apply_cost < 0)
                        v_apply_cost = 0;
                PutField_Int(myHash,"apply_cost",v_apply_cost);
DEBUGLOG(("GetTxnHeader apply_cost = [%d]\n",v_apply_cost));

                if (ind_related_txn_id >= 0) {
                        v_related_txn_id.arr[v_related_txn_id.len] ='\0';
                        PutField_CString(myHash,"related_txn_id",(const char*)v_related_txn_id.arr);
DEBUGLOG(("GetTxnHeader related_txn_id = [%s]\n",v_related_txn_id.arr));
                }

                RecordSet_Add(myRec,myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_gettxnheader;


        if (iCnt > 0 ) {
DEBUGLOG(("GetTxnHeader Normal Exit\n"));
                return  PD_OK;
        }
        else {
DEBUGLOG(("GetTxnHeader Normal Exit, Not Found\n"));
                return PD_ERR;
        }

gettxnheader_error:
DEBUGLOG(("gettxnheader_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_gettxnheader;
        return PD_ERR;
}



int AddDetail(const hash_t *hRls)
{
        char            *csTmp;
	double		dTmp;

        EXEC SQL WHENEVER SQLERROR GOTO adddetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short           hv_return_value;

        varchar         hv_txn_id[PD_TXN_SEQ_LEN];
        varchar         hv_entity_id[PD_MMS_ENTITY_ID_LEN];
        varchar         hv_related_entity_id[PD_MMS_ENTITY_ID_LEN];
	double		hv_open_acct_bal;
	double		hv_open_intransit;
	double		hv_open_lien;
	double		hv_open_prepaid;
	double		hv_curr_acct_bal;
	double		hv_curr_intransit;
	double		hv_curr_lien;
	double		hv_curr_prepaid;
	double		hv_provided_fx_rate;
	double		hv_fx_rate;
	double		hv_provided_cost_rate;
	double		hv_provided_fixed_amount;
	double		hv_provided_cost;
	double		hv_cost_rate;
	double		hv_fixed_amount;
	double		hv_cost;
	varchar		hv_remark[PD_REMARK_LEN];
	varchar		hv_add_user[PD_USER_LEN];

	short           ind_txn_id = -1;
	short		ind_entity_id = -1;
	short		ind_related_entity_id = -1;
	short		ind_open_acct_bal = -1;
	short		ind_open_intransit = -1;
	short		ind_open_lien = -1;
	short		ind_open_prepaid = -1;
	short		ind_curr_acct_bal = -1;
	short		ind_curr_intransit = -1;
	short		ind_curr_lien = -1;
	short		ind_curr_prepaid = -1;
	short		ind_provided_fx_rate = -1;
	short		ind_fx_rate = -1;
	short		ind_provided_cost_rate = -1;
	short		ind_provided_fixed_amount = -1;
	short		ind_provided_cost = -1;
	short		ind_cost_rate = -1;
	short		ind_fixed_amount = -1;
	short		ind_cost = -1;
	short		ind_remark = -1;
	short		ind_add_user = -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("AddDetail: Begin\n"));


/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("AddDetail:txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
        }

/* entity_id */
        if (GetField_CString(hRls,"entity_id",&csTmp)) {
                hv_entity_id.len = strlen(csTmp);
                memcpy(hv_entity_id.arr,csTmp,hv_entity_id.len);
                ind_entity_id = 0;
DEBUGLOG(("AddDetail:entity_id = [%.*s]\n",hv_entity_id.len,hv_entity_id.arr));
        }

/* related_entity_id */
        if (GetField_CString(hRls,"related_entity_id",&csTmp)) {
                hv_related_entity_id.len = strlen(csTmp);
                memcpy(hv_related_entity_id.arr,csTmp,hv_related_entity_id.len);
                ind_related_entity_id = 0;
DEBUGLOG(("AddDetail:related_entity_id = [%.*s]\n",hv_related_entity_id.len,hv_related_entity_id.arr));
        }

/* open_acct_bal   */
        if (GetField_Double(hRls,"open_acct_bal",&dTmp)) {
		hv_open_acct_bal = dTmp;
                ind_open_acct_bal = 0;
DEBUGLOG(("AddDetail:open_acct_bal = [%d]\n",hv_open_acct_bal));
	}

/* open_intransit   */
        if (GetField_Double(hRls,"open_intransit",&dTmp)) {
		hv_open_intransit = dTmp;
                ind_open_intransit = 0;
DEBUGLOG(("AddDetail:open_intransit = [%d]\n",hv_open_intransit));
	}

/* open_lien   */
        if (GetField_Double(hRls,"open_lien",&dTmp)) {
		hv_open_lien = dTmp;
                ind_open_lien = 0;
DEBUGLOG(("AddDetail:open_lien = [%d]\n",hv_open_lien));
	}

/* open_lien   */
        if (GetField_Double(hRls,"open_prepaid",&dTmp)) {
		hv_open_prepaid = dTmp;
                ind_open_prepaid = 0;
DEBUGLOG(("AddDetail:open_prepaid = [%d]\n",hv_open_prepaid));
	}

/* curr_acct_bal   */
        if (GetField_Double(hRls,"curr_acct_bal",&dTmp)) {
		hv_curr_acct_bal = dTmp;
                ind_curr_acct_bal = 0;
DEBUGLOG(("AddDetail:curr_acct_bal = [%d]\n",hv_curr_acct_bal));
	}

/* curr_intransit   */
        if (GetField_Double(hRls,"curr_intransit",&dTmp)) {
		hv_curr_intransit = dTmp;
                ind_curr_intransit = 0;
DEBUGLOG(("AddDetail:curr_intransit = [%d]\n",hv_curr_intransit));
	}

/* curr_lien   */
        if (GetField_Double(hRls,"curr_lien",&dTmp)) {
		hv_curr_lien = dTmp;
                ind_curr_lien = 0;
DEBUGLOG(("AddDetail:curr_lien = [%d]\n",hv_curr_lien));
	}

/* curr_lien   */
        if (GetField_Double(hRls,"curr_prepaid",&dTmp)) {
		hv_curr_prepaid = dTmp;
                ind_curr_prepaid = 0;
DEBUGLOG(("AddDetail:curr_prepaid = [%d]\n",hv_curr_prepaid));
	}

/* provided_fx_rate   */
        if (GetField_Double(hRls,"provided_fx_rate",&dTmp)) {
		hv_provided_fx_rate = dTmp;
                ind_provided_fx_rate = 0;
DEBUGLOG(("AddDetail:provided_fx_rate = [%d]\n",hv_provided_fx_rate));
	}

/* fx_rate   */
        if (GetField_Double(hRls,"fx_rate",&dTmp)) {
		hv_fx_rate = dTmp;
                ind_fx_rate = 0;
DEBUGLOG(("AddDetail:fx_rate = [%d]\n",hv_fx_rate));
	}

/* provided_cost_rate   */
        if (GetField_Double(hRls,"provided_cost_rate",&dTmp)) {
		hv_provided_cost_rate = dTmp;
                ind_provided_cost_rate = 0;
DEBUGLOG(("AddDetail:provided_cost_rate = [%d]\n",hv_provided_cost_rate));
	}

/* provided_fixed_amount   */
        if (GetField_Double(hRls,"provided_fixed_amount",&dTmp)) {
		hv_provided_fixed_amount = dTmp;
                ind_provided_fixed_amount = 0;
DEBUGLOG(("AddDetail:provided_fixed_amount = [%d]\n",hv_provided_fixed_amount));
	}

/* provided_cost   */
        if (GetField_Double(hRls,"provided_cost",&dTmp)) {
		hv_provided_cost = dTmp;
                ind_provided_cost = 0;
DEBUGLOG(("AddDetail:provided_cost = [%d]\n",hv_provided_cost));
	}

/* cost_rate   */
        if (GetField_Double(hRls,"cost_rate",&dTmp)) {
		hv_cost_rate = dTmp;
                ind_cost_rate = 0;
DEBUGLOG(("AddDetail:cost_rate = [%d]\n",hv_cost_rate));
	}

/* fixed_amount   */
        if (GetField_Double(hRls,"fixed_amount",&dTmp)) {
		hv_fixed_amount = dTmp;
                ind_fixed_amount = 0;
DEBUGLOG(("AddDetail:fixed_amount = [%d]\n",hv_fixed_amount));
	}

/* cost   */
        if (GetField_Double(hRls,"cost",&dTmp)) {
		hv_cost = dTmp;
                ind_cost = 0;
DEBUGLOG(("AddDetail:cost = [%d]\n",hv_cost));
	}

/* remark */
        if (GetField_CString(hRls,"remark",&csTmp)) {
                hv_remark.len = strlen(csTmp);
                memcpy(hv_remark.arr,csTmp,hv_remark.len);
                ind_remark = 0;
DEBUGLOG(("AddDetail:remark = [%.*s]\n",hv_remark.len,hv_remark.arr));
        }

/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen(csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("AddDetail:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }


	EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_mms_txn_detail_insert(
                                        :hv_txn_id:ind_txn_id,
					:hv_entity_id:ind_entity_id,
					:hv_related_entity_id:ind_related_entity_id,
					:hv_open_acct_bal:ind_open_acct_bal,
					:hv_open_intransit:ind_open_intransit,
					:hv_open_lien:ind_open_lien,
					:hv_open_prepaid:ind_open_prepaid,
					:hv_curr_acct_bal:ind_curr_acct_bal,
					:hv_curr_intransit:ind_curr_intransit,
					:hv_curr_lien:ind_curr_lien,
					:hv_curr_prepaid:ind_curr_prepaid,
					:hv_provided_fx_rate:ind_provided_fx_rate,
					:hv_fx_rate:ind_fx_rate,
					:hv_provided_cost_rate:ind_provided_cost_rate,
					:hv_provided_fixed_amount:ind_provided_fixed_amount,
					:hv_provided_cost:ind_provided_cost,
					:hv_cost_rate:ind_cost_rate,
					:hv_fixed_amount:ind_fixed_amount,
					:hv_cost:ind_cost,
					:hv_remark:ind_remark,
					:hv_add_user:ind_add_user
					);
                END;
        END-EXEC;

DEBUGLOG(("AddDetail:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("AddDetail:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("Transaction_AddDetail: SP_OTHER_ERR\n");
DEBUGLOG(("AddDetail: SP_OTHER_ERR\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("Transaction_Add: SP_ERR\n");
DEBUGLOG(("AddDetail: SP_ERR\n"));
                return PD_ERR;
        }

adddetail_error:
DEBUGLOG(("adddetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_Add: SP_INTERNAL_ERR\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR\n"));
        return PD_INTERNAL_ERR;
}


int UpdateDetail(const hash_t *hRls)
{
        char*   csPtr;
        char*   csBuf;
        char*   csTxnId;
	double	dTmp;

        EXEC SQL WHENEVER SQLERROR GOTO update_detail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        varchar         hv_dynstmt[PD_TMP_MSG_BUF_LEN];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("UpdateDetail: Begin\n"));
        csBuf = (char*) malloc (PD_TMP_BUF_LEN);
        strcpy((char*)hv_dynstmt.arr,"update mms_txn_detail set mtd_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"txn_seq",&csTxnId);
DEBUGLOG(("UpdateDetail:txn_id = [%s]\n",csTxnId));

/* entity_id */
        if (GetField_CString(hRls,"entity_id",&csPtr)) {
DEBUGLOG(("UpdateDetail:entity_id = [%s]\n",csPtr));
                strcat((char*)hv_dynstmt.arr, ",mtd_entity_id = '");
                strcat((char*)hv_dynstmt.arr, csPtr);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* related_entity_id */
        if (GetField_CString(hRls,"related_entity_id",&csPtr)) {
DEBUGLOG(("UpdateDetail:related_entity_id = [%s]\n",csPtr));
                strcat((char*)hv_dynstmt.arr, ",mtd_related_entity_id = '");
                strcat((char*)hv_dynstmt.arr, csPtr);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* open_acct_bal  */
        if (GetField_Double(hRls,"open_acct_bal",&dTmp)) {
DEBUGLOG(("UpdateDetail:open_acct_bal = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_open_acct_bal = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* open_intransit  */
        if (GetField_Double(hRls,"open_intransit",&dTmp)) {
DEBUGLOG(("UpdateDetail:open_intransit = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_open_intransit = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* open_lien  */
        if (GetField_Double(hRls,"open_lien",&dTmp)) {
DEBUGLOG(("UpdateDetail:open_lien = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_open_lien = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* open_prepaid  */
        if (GetField_Double(hRls,"open_prepaid",&dTmp)) {
DEBUGLOG(("UpdateDetail:open_prepaid = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_open_prepaid = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* curr_acct_bal  */
        if (GetField_Double(hRls,"curr_acct_bal",&dTmp)) {
DEBUGLOG(("UpdateDetail:curr_acct_bal = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_curr_acct_bal = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* curr_intransit  */
        if (GetField_Double(hRls,"curr_intransit",&dTmp)) {
DEBUGLOG(("UpdateDetail:curr_intransit = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_curr_intransit = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* curr_lien  */
        if (GetField_Double(hRls,"curr_lien",&dTmp)) {
DEBUGLOG(("UpdateDetail:curr_lien = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_curr_lien = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* curr_prepaid  */
        if (GetField_Double(hRls,"curr_prepaid",&dTmp)) {
DEBUGLOG(("UpdateDetail:curr_prepaid = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_curr_prepaid = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* provided_fx_rate  */
        if (GetField_Double(hRls,"provided_fx_rate",&dTmp)) {
DEBUGLOG(("UpdateDetail:provided_fx_rate = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_provided_fx_rate = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* fx_rate  */
        if (GetField_Double(hRls,"fx_rate",&dTmp)) {
DEBUGLOG(("UpdateDetail:fx_rate = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_fx_rate = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* provided_cost_rate  */
        if (GetField_Double(hRls,"provided_cost_rate",&dTmp)) {
DEBUGLOG(("UpdateDetail:provided_cost_rate = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_provided_cost_rate = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* provided_fixed_amount  */
        if (GetField_Double(hRls,"provided_fixed_amount",&dTmp)) {
DEBUGLOG(("UpdateDetail:provided_fixed_amount = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_provided_fixed_amount = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* provided_cost  */
        if (GetField_Double(hRls,"provided_cost",&dTmp)) {
DEBUGLOG(("UpdateDetail:provided_cost = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_provided_cost = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* cost_rate  */
        if (GetField_Double(hRls,"cost_rate",&dTmp)) {
DEBUGLOG(("UpdateDetail:cost_rate = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_cost_rate = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* fixed_amount  */
        if (GetField_Double(hRls,"fixed_amount",&dTmp)) {
DEBUGLOG(("UpdateDetail:fixed_amount = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_fixed_amount = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* cost  */
        if (GetField_Double(hRls,"cost",&dTmp)) {
DEBUGLOG(("UpdateDetail:cost = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",mtd_cost = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* remark  */
        if (GetField_CString(hRls,"remark",&csPtr)) {
DEBUGLOG(("UpdateDetail:remark = [%s]\n",csPtr));
                strcat((char*)hv_dynstmt.arr, ",mtd_remark = '");
                strcat((char*)hv_dynstmt.arr, csPtr);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* update user */
        if (GetField_CString(hRls,"update_user",&csPtr)) {
DEBUGLOG(("UpdateDetail:update_user = [%s]\n",csPtr));
                strcat((char*)hv_dynstmt.arr, ",mtd_update_user = '");
                strcat((char*)hv_dynstmt.arr, csPtr);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


strcat((char *)hv_dynstmt.arr, " WHERE mtd_txn_id = '");
        strcat((char *)hv_dynstmt.arr, csTxnId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

        FREE_ME(csBuf);


DEBUGLOG(("UpdateDetail Normal Exit\n"));
        return PD_OK;

update_detail_error:
DEBUGLOG(("update_detail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("MMS_Transaction_UpdateDetail: SP_INTERNAL_ERR\n");
DEBUGLOG(("UpdateDetail: SP_INTERNAL_ERR\n"));
        return PD_INTERNAL_ERR;
}


int GetTxnDetail(const char* csTxnID,
                recordset_t* myRec)
{

        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO gettxndetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];

                varchar         v_entity_id[PD_MMS_ENTITY_ID_LEN + 1];
                varchar         v_related_entity_id[PD_MMS_ENTITY_ID_LEN + 1];
		double		v_open_acct_bal;
		double		v_open_intransit;
		double		v_open_lien;
		double		v_open_prepaid;
		double		v_curr_acct_bal;
		double		v_curr_intransit;
		double		v_curr_lien;
		double		v_curr_prepaid;
		double		v_provided_fx_rate;
		double		v_fx_rate;
		double		v_provided_cost_rate;
		double		v_provided_fixed_amount;
		double		v_provided_cost;
		double		v_cost_rate;
		double		v_fixed_amount;
		double		v_cost;
		varchar		v_remark[PD_REMARK_LEN +1];

		short		ind_entity_id;
		short		ind_related_entity_id;
		short		ind_open_acct_bal;
		short		ind_open_intransit;
		short		ind_open_lien;
		short		ind_open_prepaid;
		short		ind_curr_acct_bal;
		short		ind_curr_intransit;
		short		ind_curr_lien;
		short		ind_curr_prepaid;
		short		ind_provided_fx_rate;
		short		ind_fx_rate;
		short		ind_provided_cost_rate;
		short		ind_provided_fixed_amount;
		short		ind_provided_cost;
		short		ind_cost_rate;
		short		ind_fixed_amount;
		short		ind_cost;
		short		ind_remark;


	EXEC SQL END DECLARE SECTION;

        hv_txn_id.len = strlen(csTxnID);
        memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetTxnDetail txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_gettxndetail CURSOR FOR
                select
                        mtd_entity_id,
                        mtd_related_entity_id,
			mtd_open_acct_bal,
			mtd_open_intransit,
			mtd_open_lien,
			mtd_open_prepaid,
			mtd_curr_acct_bal,
			mtd_curr_intransit,
			mtd_curr_lien,
			mtd_curr_prepaid,
			mtd_provided_fx_rate,
			mtd_fx_rate,
			mtd_provided_cost_rate,
			mtd_provided_fixed_amount,
			mtd_provided_cost,
			mtd_cost_rate,
			mtd_fixed_amount,
			mtd_cost,
			mtd_remark
                  from mms_txn_detail
                 where mtd_txn_id = :hv_txn_id;

	EXEC SQL OPEN c_cursor_gettxndetail;
        do {
                EXEC SQL FETCH c_cursor_gettxndetail
                INTO
			:v_entity_id:ind_entity_id,
			:v_related_entity_id:ind_related_entity_id,
			:v_open_acct_bal:ind_open_acct_bal,
			:v_open_intransit:ind_open_intransit,
			:v_open_lien:ind_open_lien,
			:v_open_prepaid:ind_open_prepaid,
			:v_curr_acct_bal:ind_curr_acct_bal,
			:v_curr_intransit:ind_curr_intransit,
			:v_curr_lien:ind_curr_lien,
			:v_curr_prepaid:ind_curr_prepaid,
			:v_provided_fx_rate:ind_provided_fx_rate,
			:v_fx_rate:ind_fx_rate,
			:v_provided_cost_rate:ind_provided_cost_rate,
			:v_provided_fixed_amount:ind_provided_fixed_amount,
			:v_provided_cost:ind_provided_cost,
			:v_cost_rate:ind_cost_rate,
			:v_fixed_amount:ind_fixed_amount,
			:v_cost:ind_cost,
			:v_remark:ind_remark;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

	 	myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);


/* entity id */
                if (ind_entity_id  >=  0) {
                        v_entity_id.arr[v_entity_id.len] = '\0';
                        PutField_CString(myHash,"entity_id",(const char*)v_entity_id.arr);
DEBUGLOG(("GetTxnDetail entity_id = [%s]\n",v_entity_id.arr));
                }

/* related entity id */
                if (ind_related_entity_id  >=  0) {
                        v_related_entity_id.arr[v_related_entity_id.len] = '\0';
                        PutField_CString(myHash,"related_entity_id",(const char*)v_related_entity_id.arr);
DEBUGLOG(("GetTxnDetail related_entity_id = [%s]\n",v_related_entity_id.arr));
                }

/* open_acct_bal */
                if (ind_open_acct_bal < 0)
                        v_open_acct_bal = 0.0;
                PutField_Double(myHash,"open_acct_bal",v_open_acct_bal);
DEBUGLOG(("GetTxnDetail open_acct_bal = [%f]\n",v_open_acct_bal));

/* open_intransit */
                if (ind_open_intransit < 0)
                        v_open_intransit = 0.0;
                PutField_Double(myHash,"open_intransit",v_open_intransit);
DEBUGLOG(("GetTxnDetail open_intransit = [%f]\n",v_open_intransit));

/* open_lien */
                if (ind_open_lien < 0)
                        v_open_lien = 0.0;
                PutField_Double(myHash,"open_lien",v_open_lien);
DEBUGLOG(("GetTxnDetail open_lien = [%f]\n",v_open_lien));

/* open_prepaid */
                if (ind_open_prepaid < 0)
                        v_open_prepaid = 0.0;
                PutField_Double(myHash,"open_prepaid",v_open_prepaid);
DEBUGLOG(("GetTxnDetail open_prepaid = [%f]\n",v_open_prepaid));

/* curr_acct_bal */
                if (ind_curr_acct_bal < 0)
                        v_curr_acct_bal = 0.0;
                PutField_Double(myHash,"curr_acct_bal",v_curr_acct_bal);
DEBUGLOG(("GetTxnDetail curr_acct_bal = [%f]\n",v_curr_acct_bal));

/* curr_intransit */
                if (ind_curr_intransit < 0)
                        v_curr_intransit = 0.0;
                PutField_Double(myHash,"curr_intransit",v_curr_intransit);
DEBUGLOG(("GetTxnDetail curr_intransit = [%f]\n",v_curr_intransit));

/* curr_lien */
                if (ind_curr_lien < 0)
                        v_curr_lien = 0.0;
                PutField_Double(myHash,"curr_lien",v_curr_lien);
DEBUGLOG(("GetTxnDetail curr_lien = [%f]\n",v_curr_lien));

/* curr_prepaid */
                if (ind_curr_prepaid < 0)
                        v_curr_prepaid = 0.0;
                PutField_Double(myHash,"curr_prepaid",v_curr_prepaid);
DEBUGLOG(("GetTxnDetail curr_prepaid = [%f]\n",v_curr_prepaid));

/* provided_fx_rate */
                if (ind_provided_fx_rate < 0)
                        v_provided_fx_rate = 0.0;
                PutField_Double(myHash,"provided_fx_rate",v_provided_fx_rate);
DEBUGLOG(("GetTxnDetail provided_fx_rate = [%f]\n",v_provided_fx_rate));

/* fx_rate */
                if (ind_fx_rate < 0)
                        v_fx_rate = 0.0;
                PutField_Double(myHash,"fx_rate",v_fx_rate);
DEBUGLOG(("GetTxnDetail fx_rate = [%f]\n",v_fx_rate));

/* provided_cost_rate */
                if (ind_provided_cost_rate < 0)
                        v_provided_cost_rate = 0.0;
                PutField_Double(myHash,"provided_cost_rate",v_provided_cost_rate);
DEBUGLOG(("GetTxnDetail provided_cost_rate = [%f]\n",v_provided_cost_rate));

/* provided_fixed_amount */
                if (ind_provided_fixed_amount < 0)
                        v_provided_fixed_amount = 0.0;
                PutField_Double(myHash,"provided_fixed_amount",v_provided_fixed_amount);
DEBUGLOG(("GetTxnDetail provided_fixed_amount = [%f]\n",v_provided_fixed_amount));

/* provided_cost */
                if (ind_provided_cost < 0)
                        v_provided_cost = 0.0;
                PutField_Double(myHash,"provided_cost",v_provided_cost);
DEBUGLOG(("GetTxnDetail provided_cost = [%f]\n",v_provided_cost));

/* cost_rate */
                if (ind_cost_rate < 0)
                        v_cost_rate = 0.0;
                PutField_Double(myHash,"cost_rate",v_cost_rate);
DEBUGLOG(("GetTxnDetail cost_rate = [%f]\n",v_cost_rate));

/* fixed_amount */
                if (ind_fixed_amount < 0)
                        v_fixed_amount = 0.0;
                PutField_Double(myHash,"fixed_amount",v_fixed_amount);
DEBUGLOG(("GetTxnDetail fixed_amount = [%f]\n",v_fixed_amount));

/* cost */
                if (ind_cost < 0)
                        v_cost = 0.0;
                PutField_Double(myHash,"cost",v_cost);
DEBUGLOG(("GetTxnDetail cost = [%f]\n",v_cost));

		RecordSet_Add(myRec,myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_gettxndetail;


DEBUGLOG(("GetTxnDetail Normal Exit\n"));
        return  PD_OK;

gettxndetail_error:
DEBUGLOG(("gettxndetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_gettxndetail;
        return PD_ERR;
}


int AddNatureDetail(const hash_t *hRls)
{
        char            *csTmp;
	double		dTmp;

        EXEC SQL WHENEVER SQLERROR GOTO addnaturedetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short           hv_return_value;

        varchar         hv_txn_id[PD_TXN_SEQ_LEN];
	varchar		hv_entity_id[PD_MMS_ENTITY_ID_LEN];
	varchar		hv_nature_id[PD_NATURE_ID_LEN];
	double		hv_txn_amt;
	varchar		hv_txn_ccy[PD_CCY_ID_LEN];
	double		hv_net_amt;
	varchar		hv_net_ccy[PD_CCY_ID_LEN];
	varchar		hv_add_user[PD_USER_LEN];

	short           ind_txn_id = -1;
	short		ind_entity_id = -1;
	short		ind_nature_id = -1;
	short		ind_txn_amt = -1;
	short		ind_txn_ccy = -1;
	short		ind_net_amt = -1;
	short		ind_net_ccy = -1;
	short		ind_add_user = -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("AddNatureDetail: Begin\n"));


/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("AddNatureDetail:txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
        }

/* entity_id */
        if (GetField_CString(hRls,"entity_id",&csTmp)) {
                hv_entity_id.len = strlen(csTmp);
                memcpy(hv_entity_id.arr,csTmp,hv_entity_id.len);
                ind_entity_id = 0;
DEBUGLOG(("AddNatureDetail:entity_id = [%.*s]\n",hv_entity_id.len,hv_entity_id.arr));
        }

/* nature_id */
        if (GetField_CString(hRls,"nature_id",&csTmp)) {
                hv_nature_id.len = strlen(csTmp);
                memcpy(hv_nature_id.arr,csTmp,hv_nature_id.len);
                ind_nature_id = 0;
DEBUGLOG(("AddNatureDetail:nature_id = [%.*s]\n",hv_nature_id.len,hv_nature_id.arr));
        }

/* txn_amt */
        if (GetField_Double(hRls,"txn_amt",&dTmp)) {
		hv_txn_amt = dTmp;
                ind_txn_amt = 0;
DEBUGLOG(("AddNatureDetail:txn_amt = [%lf]\n",dTmp));
	}

/* txn_ccy */
        if (GetField_CString(hRls,"txn_ccy",&csTmp)) {
                hv_txn_ccy.len = strlen(csTmp);
                memcpy(hv_txn_ccy.arr,csTmp,hv_txn_ccy.len);
                ind_txn_ccy = 0;
DEBUGLOG(("AddNatureDetail:txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));
        }

/* net_amt */
        if (GetField_Double(hRls,"net_amt",&dTmp)) {
		hv_net_amt = dTmp;
                ind_net_amt = 0;
DEBUGLOG(("AddNatureDetail:net_amt = [%lf]\n",dTmp));
	}

/* net_ccy */
        if (GetField_CString(hRls,"net_ccy",&csTmp)) {
                hv_net_ccy.len = strlen(csTmp);
                memcpy(hv_net_ccy.arr,csTmp,hv_net_ccy.len);
                ind_net_ccy = 0;
DEBUGLOG(("AddNatureDetail:net_ccy = [%.*s]\n",hv_net_ccy.len,hv_net_ccy.arr));
        }



/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen(csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("AddNatureDetail:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }


	EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_mms_txn_nature_dt_insert(
                                        :hv_txn_id:ind_txn_id,
                                        :hv_entity_id:ind_entity_id,
                                        :hv_nature_id:ind_nature_id,
                                        :hv_txn_amt:ind_txn_amt,
                                        :hv_txn_ccy:ind_txn_ccy,
                                        :hv_net_amt:ind_net_amt,
                                        :hv_net_ccy:ind_net_ccy,
					:hv_add_user:ind_add_user
					);
                END;
        END-EXEC;

DEBUGLOG(("AddNatureDetail:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("AddNatureDetail:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MmsTransaction_AddNatureDetail: SP_OTHER_ERR\n");
DEBUGLOG(("AddNatureDetail: SP_OTHER_ERR\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("MmsTransaction_AddNatureDetail: SP_ERR\n");
DEBUGLOG(("AddNatureDetail: SP_ERR\n"));
                return PD_ERR;
        }

addnaturedetail_error:
DEBUGLOG(("addnaturedetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("MmsTransaction_AddNatureDetail: SP_INTERNAL_ERR\n");
DEBUGLOG(("AddnatureDetail: SP_INTERNAL_ERR\n"));
        return PD_INTERNAL_ERR;
}



int GetTxnNatureDetail(const char* csTxnID,
                recordset_t* myRec)
{

        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO gettxnnaturedetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];

		varchar		v_entity_id[PD_MMS_ENTITY_ID_LEN +1 ];
		varchar		v_nature_id[PD_NATURE_ID_LEN +1 ];
		double		v_txn_amt;
		varchar		v_txn_ccy[PD_CCY_ID_LEN +1 ];
		double		v_net_amt;
		varchar		v_net_ccy[PD_CCY_ID_LEN +1 ];

		short		ind_entity_id;
		short		ind_nature_id;
		short		ind_txn_amt;
		short		ind_txn_ccy;
		short		ind_net_amt;
		short		ind_net_ccy;


	EXEC SQL END DECLARE SECTION;

        hv_txn_id.len = strlen(csTxnID);
        memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetTxnNatureDetail txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_gettxnnaturedetail CURSOR FOR
                select
			mtn_entity_id,
		        mtn_nature_id,
		        mtn_txn_amount,
		        mtn_txn_ccy,
		        mtn_net_amount,
		        mtn_net_ccy
                  from mms_txn_nature_detail
                 where mtn_txn_id = :hv_txn_id;

	EXEC SQL OPEN c_cursor_gettxnnaturedetail;
        do {
                EXEC SQL FETCH c_cursor_gettxnnaturedetail
                INTO
                        :v_entity_id:ind_entity_id,
                        :v_nature_id:ind_nature_id,
                        :v_txn_amt:ind_txn_amt,
                        :v_txn_ccy:ind_txn_ccy,
                        :v_net_amt:ind_net_amt,
                        :v_net_ccy:ind_net_ccy;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

	 	myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/* entity_id */
                if (ind_entity_id  >=  0) {
                        v_entity_id.arr[v_entity_id.len] = '\0';
                        PutField_CString(myHash,"entity_id",(const char*)v_entity_id.arr);
DEBUGLOG(("GetTxnNatureDetail entity_id = [%s]\n",v_entity_id.arr));
                }

/* nature_id */
                if (ind_nature_id  >=  0) {
                        v_nature_id.arr[v_nature_id.len] = '\0';
                        PutField_CString(myHash,"nature_id",(const char*)v_nature_id.arr);
DEBUGLOG(("GetTxnNatureDetail nature_id = [%s]\n",v_nature_id.arr));
                }

/* txn amt */
		if (ind_txn_amt< 0)
                        v_txn_amt= 0.0;
DEBUGLOG(("GetTxnNatureDetail txn_amt = [%f]\n",v_txn_amt));
                PutField_Double(myHash,"txn_amt",v_txn_amt);

/* txn ccy */
                if (ind_txn_ccy >= 0) {
                        v_txn_ccy.arr[v_txn_ccy.len] ='\0';
                        PutField_CString(myHash,"txn_ccy",(const char*)v_txn_ccy.arr);
DEBUGLOG(("GetTxnNatureDetail txn_ccy = [%s]\n",v_txn_ccy.arr));
                }

/* net amt */
		if (ind_net_amt< 0)
                        v_net_amt= 0.0;
DEBUGLOG(("GetTxnNatureDetail net_amt = [%f]\n",v_net_amt));
                PutField_Double(myHash,"net_amt",v_net_amt);

/* net ccy */
                if (ind_net_ccy >= 0) {
                        v_net_ccy.arr[v_net_ccy.len] ='\0';
                        PutField_CString(myHash,"net_ccy",(const char*)v_net_ccy.arr);
DEBUGLOG(("GetTxnNatureDetail net_ccy = [%s]\n",v_net_ccy.arr));
                }
		RecordSet_Add(myRec,myHash);

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_gettxnnaturedetail;


DEBUGLOG(("GetTxnNatureDetail Normal Exit\n"));
        return  PD_OK;

gettxnnaturedetail_error:
DEBUGLOG(("GetTxnNatureDetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_gettxnnaturedetail;
        return PD_ERR;
}


int MatchNodeRef(const char* csNodeID,
                     const char* csNodeRef)
{
        EXEC SQL WHENEVER SQLERROR GOTO matchnoderef_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
    
        EXEC SQL BEGIN DECLARE SECTION;
                short           hv_return_value;
                varchar         hv_node_id[PD_MMS_NODE_ID_LEN];
                varchar         hv_node_ref[PD_MMS_NODE_REF_LEN];

    
        EXEC SQL END DECLARE SECTION;

        hv_node_id.len = strlen(csNodeID);
        memcpy(hv_node_id.arr,csNodeID,hv_node_id.len);
DEBUGLOG(("MatchNodeRef node_id = [%.*s]\n",hv_node_id.len,hv_node_id.arr));
    
        hv_node_ref.len = strlen(csNodeRef);
        memcpy(hv_node_ref.arr,csNodeRef,hv_node_ref.len);
DEBUGLOG(("MatchNodeRef merchant_ref = [%.*s]\n",hv_node_ref.len,hv_node_ref.arr));

        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_mms_txn_matchnoderef(:hv_node_id,
                                                                     :hv_node_ref);
                END;
        END-EXEC;

        if (hv_return_value > 0)  {

DEBUGLOG(("MatchNodeRef Found\n"));
                return PD_FOUND;
        }
        else {
DEBUGLOG(("MatchNodeRef Not Found\n"));
                return PD_NOT_FOUND;
        }


matchnoderef_error:
DEBUGLOG(("matchnoderef_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_NOT_FOUND;
}

int MatchTxnStatusForUpdate(const hash_t* hReq)
{
	int	iRet = PD_NOT_FOUND;
	char	*csBuf;
	char	*csPtr;
	char	cPtr;
	int	iSubStatusCnt = 0,i;

        EXEC SQL WHENEVER SQLERROR GOTO matchtxnstatus_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
    
        EXEC SQL BEGIN DECLARE SECTION;
                varchar	        v_txn_seq[PD_TXN_SEQ_LEN +1];
		varchar         hv_dynstmt[PD_TMP_MSG_BUF_LEN];

		short		ind_txn_seq = -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("MatchTxnStatusForUpdate: Begin\n"));
        csBuf = (char*) malloc (PD_TMP_BUF_LEN);
        strcpy((char*)hv_dynstmt.arr,"select mth_txn_id from mms_txn_header where ");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

/* txn_seq */
        if (GetField_CString(hReq,"txn_seq",&csPtr)) {
DEBUGLOG(("MatchTxnStatusForUpdate:txn_id = [%s]\n",csPtr));
                strcat((char*)hv_dynstmt.arr, " mth_txn_id = '");
                strcat((char*)hv_dynstmt.arr, csPtr);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* txn_code */
        if (GetField_CString(hReq,"txn_code",&csPtr)) {
DEBUGLOG(("MatchTxnStatusForUpdate:txn_code = [%s]\n",csPtr));
                strcat((char*)hv_dynstmt.arr, " and  mth_txn_code = '");
                strcat((char*)hv_dynstmt.arr, csPtr);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* status */
	if (GetField_Char(hReq,"status",&cPtr)) {
DEBUGLOG(("MatchTxnStatusForUpdate:status = [%c]\n",cPtr));
		sprintf(csBuf,"%c",cPtr);
                strcat((char*)hv_dynstmt.arr, " and mth_status = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* ar_ind */
	if (GetField_Char(hReq,"ar_ind",&cPtr)) {
DEBUGLOG(("MatchTxnStatusForUpdate:status = [%c]\n",cPtr));
		sprintf(csBuf,"%c",cPtr);
                strcat((char*)hv_dynstmt.arr, " and mth_ar_ind = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	GetField_Int(hReq,"sub_status_cnt",&iSubStatusCnt);
DEBUGLOG(("MatchTxnStatusForUpdate:sub_status_cnt = [%d]\n",iSubStatusCnt));

	for (i = 0 ; i < iSubStatusCnt; i++) {
		sprintf(csBuf,"sub_status_%d",i);

		if (GetField_CString(hReq,csBuf,&csPtr)) {
DEBUGLOG(("MatchTxnStatusForUpdate: [%s] = [%s]\n",csBuf,csPtr));
			if (i  == 0) 
                		strcat((char*)hv_dynstmt.arr, "and mth_sub_status in ('");
			else 
                		strcat((char*)hv_dynstmt.arr, "','");
                	strcat((char*)hv_dynstmt.arr, csPtr);
			if (i  ==  (iSubStatusCnt -1)) 
                		strcat((char*)hv_dynstmt.arr, "')");
                	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
		}
	}
        strcat((char*)hv_dynstmt.arr, " for update");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("MatchTxnStatusForUpdate [%s]\n",hv_dynstmt.arr));
	EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL DECLARE C CURSOR FOR  PS;

        EXEC SQL OPEN C;
        do {
                EXEC SQL FETCH C
                INTO
                        :v_txn_seq:ind_txn_seq;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                if (ind_txn_seq >= 0 ) {
DEBUGLOG(("Find: recourd found\n"));
                       	iRet = FOUND;
                }
        }
        while(PD_TRUE);

	return iRet;
matchtxnstatus_error:
DEBUGLOG(("matchtxnstatus_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_NOT_FOUND;
}

int     ChkTxnCodeExist(const char *csTxnCode)
{
        int     iRet = PD_NOT_FOUND;

        EXEC SQL WHENEVER SQLERROR GOTO chktxncodeexist_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_code[PD_TXN_CODE_LEN];

                int             v_no_of_record;
                short           ind_no_of_record = -1;
        EXEC SQL END DECLARE SECTION;

/* txn_code */
        hv_txn_code.len = strlen(csTxnCode);
        memcpy(hv_txn_code.arr, csTxnCode, hv_txn_code.len);
DEBUGLOG(("ChkTxnCodeExist = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));

        EXEC SQL
                SELECT count(1)
                   INTO :v_no_of_record:ind_no_of_record
                   FROM mms_txn_header
                  WHERE mth_txn_code = :hv_txn_code
		    //AND mth_action is NULL
                    AND rownum = 1;

        if (ind_no_of_record >= 0) {
                if (v_no_of_record > 0) {
DEBUGLOG(("ChkTxnCodeExist FOUND\n"));
                        iRet = PD_FOUND;
                }
        }

        if (iRet!= PD_FOUND) {
DEBUGLOG(("ChkTxnCodeExist NOT FOUND\n"));
        }

        return iRet;

chktxncodeexist_error:
DEBUGLOG(("ChkTxnCodeExist_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MmsTransaction ChkTxnCodeExist_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}
