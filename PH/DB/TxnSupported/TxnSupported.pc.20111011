/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/05/18              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "TxnSupported.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char    cDebug;

void TxnSupported(char    cdebug)
{
        cDebug = cdebug;
}


int FindTxnSupported(const char* csChannelCode,
                        const char* csTxnCode)
{
	
        EXEC SQL WHENEVER SQLERROR GOTO find_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_channel_code[PD_CHANNEL_CODE_LEN +1];
		varchar	hv_txn_code[PD_TXN_CODE_LEN +1];


		char    v_support;

                short   ind_support = -1;
        EXEC SQL END DECLARE SECTION;

	hv_channel_code.len = strlen(csChannelCode);
        memcpy(hv_channel_code.arr,csChannelCode,hv_channel_code.len);
DEBUGLOG(("FindTxnSupported: channel code = [%.*s][%d]\n",hv_channel_code.len,hv_channel_code.arr,hv_channel_code.len)); 

	hv_txn_code.len = strlen(csTxnCode);
        memcpy(hv_txn_code.arr,csTxnCode,hv_txn_code.len);
DEBUGLOG(("FindTxnSupported: txn code = [%.*s][%d]\n",hv_txn_code.len,hv_txn_code.arr,hv_txn_code.len)); 

	EXEC SQL select ts_support
                   into :v_support:ind_support
                   from txn_supported
                  Where ts_channel_code = :hv_channel_code
                    And ts_txn_code = :hv_txn_code;

        if (ind_support >= 0) {
DEBUGLOG(("FindTxnSupported: tc_support = %c\n",v_support));
                if (v_support == PD_SUPPORTED)
                        return PD_OK;
                else
                        return PD_ERR;
        }
DEBUGLOG(("FindTxnSupported: txn[%s] not supported\n",csTxnCode));

        return PD_ERR;
find_error:
DEBUGLOG(("find_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return PD_ERR;
}


int IsDoLogging(const char* csChannelCode,
                const char* csTxnCode)
{
	
        EXEC SQL WHENEVER SQLERROR GOTO is_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_channel_code[PD_CHANNEL_CODE_LEN +1];
		varchar	hv_txn_code[PD_TXN_CODE_LEN +1];


		char    v_do_logging;

                short   ind_do_logging = -1;
        EXEC SQL END DECLARE SECTION;

	hv_channel_code.len = strlen(csChannelCode);
        memcpy(hv_channel_code.arr,csChannelCode,hv_channel_code.len);
DEBUGLOG(("FindTxnSupported: channel code = [%.*s][%d]\n",hv_channel_code.len,hv_channel_code.arr,hv_channel_code.len)); 

	hv_txn_code.len = strlen(csTxnCode);
        memcpy(hv_txn_code.arr,csTxnCode,hv_txn_code.len);
DEBUGLOG(("FindTxnSupported: txn code = [%.*s][%d]\n",hv_txn_code.len,hv_txn_code.arr,hv_txn_code.len)); 

	EXEC SQL select ts_do_logging
                   into :v_do_logging:ind_do_logging
                   from txn_supported
                  Where ts_channel_code = :hv_channel_code
                    And ts_txn_code = :hv_txn_code;

        if (ind_do_logging >= 0) {
DEBUGLOG(("FindTxnSupported: tc_do_logging = %c\n",v_do_logging));
                if (v_do_logging == 'Y')
                        return PD_ADD_LOG;
                else if(v_do_logging == 'U')
                        return PD_UPDATE_LOG_ONLY;
		else 
			return PD_NO_LOG;
        }
	else
		return PD_NO_LOG;

is_error:
DEBUGLOG(("is_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return PD_ERR;
}

