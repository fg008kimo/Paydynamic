/*
Partnerdelight (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/08/27              Virginia Yun
Add GetAvaDepositBankAccts,
    GetAvaDepositBankAcctsRandom		   2013/10/10              Virginia Yun
Add FindServiceByBankAcct			   2013/10/15		   Stan Poon
Add GetAllAvaDepositBankAccts                      2013/10/28              David Wong
Add CheckAvaDepositBankAccts by view		   2013/11/11		   Stan Poon
    FindDetailByAvaMerchBankAcct
Add GetBeneficiaryBank				   2013/11/12		   Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLMerchantBankAcct.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void OLMerchantBankAcct(char    cdebug)
{
        cDebug = cdebug;
}


int Add(const hash_t *hOLMerchantBankAcct)
{
	char *csTmp;
	char iTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar		hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		int		hv_disabled;
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		varchar		hv_status[PD_ACCOUNT_STATUS_LEN];
		varchar		hv_preferred_settle_ccy[PD_CCY_ID_LEN];
		varchar		hv_create_user[PD_USER_LEN];

		short		ind_merchant_id = -1;
		short		ind_int_bank_code = -1;
		short		ind_bank_acct_num = -1;
		short		ind_disabled = -1;
		short		ind_service_code = -1;
		short		ind_status = -1;
		short		ind_preferred_settle_ccy= -1;
		short		ind_create_user = -1;

		short		hv_return_value;

	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("Add: Begin\n"));

	if(GetField_CString(hOLMerchantBankAcct,"merchant_id",&csTmp))
	{
		hv_merchant_id.len = strlen(csTmp);
		strncpy((char *)hv_merchant_id.arr, csTmp, hv_merchant_id.len);
		ind_merchant_id = 0;
DEBUGLOG(("Add:merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
	}

	if(GetField_CString(hOLMerchantBankAcct,"int_bank_code",&csTmp))
	{
		hv_int_bank_code.len = strlen(csTmp);
		strncpy((char *)hv_int_bank_code.arr, csTmp, hv_int_bank_code.len);
		ind_int_bank_code = 0;
DEBUGLOG(("Add:int_bank_code = [%.*s]\n",hv_int_bank_code.len,hv_int_bank_code.arr));
	}

	if(GetField_CString(hOLMerchantBankAcct,"bank_acct_num",&csTmp))
	{
		hv_bank_acct_num.len = strlen(csTmp);
		strncpy((char *)hv_bank_acct_num.arr, csTmp, hv_bank_acct_num.len);
		ind_bank_acct_num = 0;
DEBUGLOG(("Add:bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));
	}

	if (GetField_Int(hOLMerchantBankAcct,"disabled", &iTmp))
	{
		hv_disabled = iTmp;
		ind_disabled = 0;
DEBUGLOG(("Add:disabled = [%d]\n",hv_disabled));
	}

	if (GetField_CString(hOLMerchantBankAcct, "service_code",&csTmp))
	{
		hv_service_code.len = strlen(csTmp);
		strncpy((char *)hv_service_code.arr, csTmp, hv_service_code.len);
		ind_service_code = 0;
DEBUGLOG(("Add:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
	}

	if (GetField_CString(hOLMerchantBankAcct, "status",&csTmp))
	{
		hv_status.len = strlen(csTmp);
		strncpy((char *)hv_status.arr, csTmp, hv_status.len);
		ind_status= 0;
DEBUGLOG(("Add:status = [%.*s]\n",hv_status.len,hv_status.arr));
	}

	if(GetField_CString(hOLMerchantBankAcct,"preferred_settle_ccy",&csTmp)) 
	{
		hv_preferred_settle_ccy.len = strlen(csTmp);
		strncpy((char *)hv_preferred_settle_ccy.arr, csTmp, hv_preferred_settle_ccy.len);
		ind_preferred_settle_ccy= 0;
DEBUGLOG(("Add:preferred_settle_ccy = [%.*s]\n",hv_preferred_settle_ccy.len,hv_preferred_settle_ccy.arr));
	}

	if(GetField_CString(hOLMerchantBankAcct,"create_user",&csTmp))
	{
		hv_create_user.len = strlen(csTmp);
		strncpy((char *)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));
	}

	EXEC SQL EXECUTE
		BEGIN

                :hv_return_value := sp_ol_merchant_bank_acct_ins(
                                :hv_merchant_id:ind_merchant_id,
                                :hv_int_bank_code:ind_int_bank_code,
                                :hv_bank_acct_num:ind_bank_acct_num,
                                :hv_disabled:ind_disabled,
                                :hv_service_code:ind_service_code,
                                :hv_status:ind_status, 
				:hv_preferred_settle_ccy:ind_preferred_settle_ccy,
                                :hv_create_user:ind_create_user);
            END;
        END-EXEC;

DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
                DEBUGLOG(("Add:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
                ERRLOG("OLMerchantBankAcct_Add: SP_OTHER_ERR TxnAbort\n");
                DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
                ERRLOG("OLMerchantBankAcct_Add: SP_ERR TxnAbort\n");
                DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
                return PD_ERR;
        }

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLMerchantBankAcct_Add: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}


int Update(const hash_t *hRls)
{
        char*     csTmp;
        char*     csBuf;

	char*     csMerchantId;
	char*     csServiceCode;
	char*     csBankCode;
	char*     csAcctNum;

	EXEC SQL WHENEVER SQLERROR GOTO update_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

                varchar        hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

        csBuf = (char *) malloc(128);

DEBUGLOG(("Update: Begin\n"));

        strcpy((char*)hv_dynstmt.arr,"update ol_merchant_bank_acct set omb_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"merchant_id",&csMerchantId);
DEBUGLOG(("Update: merchant_id = [%s]\n", csMerchantId));

        GetField_CString(hRls,"service_code",&csServiceCode);
DEBUGLOG(("Update: service_code = [%s]\n", csServiceCode));

        GetField_CString(hRls,"int_bank_code",&csBankCode);
DEBUGLOG(("Update: int_bank_code = [%s]\n", csBankCode));

        GetField_CString(hRls,"bank_acct_num",&csAcctNum);
DEBUGLOG(("Update: bank_acct_num = [%s]\n", csAcctNum));


/*status */
        if (GetField_CString(hRls,"status",&csTmp)) {
DEBUGLOG(("Update:status = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",omb_status = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/*preferred_settle_ccy*/
        if (GetField_CString(hRls,"preferred_settle_ccy",&csTmp)) {
DEBUGLOG(("Update:preferred_settle_ccy = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",omb_preferred_settle_ccy = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/*update_user*/
        if(GetField_CString(hRls,"update_user",&csTmp)){
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",omb_update_user= '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        strcat((char *)hv_dynstmt.arr, " WHERE omb_merchant_id = '");
        strcat((char *)hv_dynstmt.arr, csMerchantId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND omb_service_code = '");
        strcat((char *)hv_dynstmt.arr, csServiceCode);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND omb_int_bank_code= '");
        strcat((char *)hv_dynstmt.arr, csBankCode);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND omb_bank_acct_num= '");
        strcat((char *)hv_dynstmt.arr, csAcctNum);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

        FREE_ME(csBuf);

DEBUGLOG(("Update Normal Exit\n"));
        return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("MerantantBalAcct_Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;

}

int     FindDetailByBankAcct(const char* csBankCode,
                             const char* csAcctNum,
                             recordset_t* myRec)
{
	hash_t *myHash;
	int     iCnt = 0;

	EXEC SQL WHENEVER SQLERROR GOTO bybankacct_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar         hv_bank_code[PD_BANK_CODE_LEN];
		varchar         hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];

		varchar		v_merchant_id[PD_MERCHANT_ID_LEN+1];
		varchar		v_service_code[PD_SERVICE_CODE_LEN+1];
		varchar		v_status[PD_ACCOUNT_STATUS_LEN+1];
		varchar		v_preferred_settle_ccy[PD_CCY_ID_LEN+1];

		short		ind_merchant_id = -1;
		short		ind_service_code = -1;
		short		ind_status = -1;
		short		ind_preferred_settle_ccy= -1;

	EXEC SQL END DECLARE SECTION;

	hv_bank_code.len = strlen(csBankCode);
	memcpy(hv_bank_code.arr, csBankCode, hv_bank_code.len);
DEBUGLOG(("FindDetailByBankAcct:int_bank_code = [%.*s]\n",hv_bank_code.len,hv_bank_code.arr));

	hv_bank_acct_num.len = strlen(csAcctNum);
	memcpy(hv_bank_acct_num.arr,csAcctNum, hv_bank_acct_num.len);
DEBUGLOG(("FindDetailByBankAcct:bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));

	EXEC SQL DECLARE c_cursor_bybankacct CURSOR FOR
                select
			omb_merchant_id,
			omb_service_code,
			omb_preferred_settle_ccy,
			omb_status
		from	ol_merchant_bank_acct
		where	omb_int_bank_code = :hv_bank_code
		and	omb_bank_acct_num = :hv_bank_acct_num;

	EXEC SQL OPEN c_cursor_bybankacct;
	do {
		EXEC SQL FETCH c_cursor_bybankacct
		INTO
			:v_merchant_id:ind_merchant_id,
			:v_service_code:ind_service_code,
			:v_preferred_settle_ccy:ind_preferred_settle_ccy,
			:v_status:ind_status;


		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

		iCnt++;
                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

		if (ind_merchant_id >= 0) {
                        v_merchant_id.arr[v_merchant_id.len] ='\0';
                        PutField_CString(myHash,"merchant_id",(const char*)v_merchant_id.arr);
DEBUGLOG(("FindDetailByBankAcct merchant_id = [%s]\n",v_merchant_id.arr));
                }

		if (ind_service_code >= 0) {
                        v_service_code.arr[v_service_code.len] ='\0';
                        PutField_CString(myHash,"service_code",(const char*)v_service_code.arr);
DEBUGLOG(("FindDetailByBankAcct service_code = [%s]\n",v_service_code.arr));
                }
	
		if (ind_status >= 0) {
			v_status.arr[v_status.len] ='\0';
                        PutField_CString(myHash,"status",(const char*)v_status.arr);
DEBUGLOG(("FindDetailByBankAcct status = [%s]\n",v_status.arr));
                }

		if (ind_preferred_settle_ccy >= 0) {
                        v_preferred_settle_ccy.arr[v_preferred_settle_ccy.len] ='\0';
                        PutField_CString(myHash,"preferred_settle_ccy",(const char*)v_preferred_settle_ccy.arr);
DEBUGLOG(("FindDetailByBankAcct preferred_settle_ccy = [%s]\n",v_preferred_settle_ccy.arr));
                }

		RecordSet_Add(myRec,myHash);

	}while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_bybankacct;


        if (iCnt > 0 ) {
DEBUGLOG(("FindDetailByBankAcct Normal Exit\n"));
                return  PD_OK;
        }
        else {
DEBUGLOG(("FindDetailByBankAcct Normal Exit, Not Found\n"));
                return PD_ERR;
        }

bybankacct_error:
DEBUGLOG(("bybankacct_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_bybankacct;
        return PD_ERR;
}


int     FindDetailByAvaMerchBankAcct(const char* csMerchantID,
				const char* csBankCode,
				const char* csAcctNum,
				hash_t* myHash)
{
	int	iRet = PD_OK;
	EXEC SQL WHENEVER SQLERROR GOTO detailbyava_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar         hv_bank_code[PD_BANK_CODE_LEN];
		varchar         hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		varchar		v_acct_ccy[PD_CCY_ID_LEN + 1];
		varchar		v_service_code[PD_SERVICE_CODE_LEN + 1];
		varchar		v_country[PD_COUNTRY_LEN + 1];
		int		v_shared_acct;
		varchar		v_owner_name[PD_NAME_LEN + 1];
		varchar		v_branch_name[PD_BANK_BRANCH_LEN + 1];

		short		ind_acct_ccy = -1;
		short		ind_service_code = -1;
		short		ind_country = -1;
		short		ind_shared_acct = -1;
		short		ind_owner_name = -1;
		short		ind_branch_name = -1;

	EXEC SQL END DECLARE SECTION;

	hv_merchant_id.len = strlen(csMerchantID);
	memcpy(hv_merchant_id.arr, csMerchantID, hv_merchant_id.len);
DEBUGLOG(("FindDetailByAvaMerchBankAcct:int_merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_bank_code.len = strlen(csBankCode);
	memcpy(hv_bank_code.arr, csBankCode, hv_bank_code.len);
DEBUGLOG(("FindDetailByAvaMerchBankAcct:int_bank_code = [%.*s]\n",hv_bank_code.len,hv_bank_code.arr));

	hv_bank_acct_num.len = strlen(csAcctNum);
	memcpy(hv_bank_acct_num.arr,csAcctNum, hv_bank_acct_num.len);
DEBUGLOG(("FindDetailByAvaMerchBankAcct:bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));

	EXEC SQL SELECT	ACCT_CCY,
			SERVICE_CODE,
			COUNTRY,
			SHARED_ACCT,
			OWNER_NAME,
			BRANCH_NAME
		INTO	:v_acct_ccy:ind_acct_ccy,
			:v_service_code:ind_service_code,
			:v_country:ind_country,
			:v_shared_acct:ind_shared_acct,
			:v_owner_name:ind_owner_name,
			:v_branch_name:ind_branch_name
		FROM	OL_DEPOSIT_BANK_ACCT_VIEW
		WHERE	MERCHANT_ID = :hv_merchant_id
		AND	INT_BANK_CODE = :hv_bank_code
		AND	BANK_ACCT_NUM = :hv_bank_acct_num;

	if (ind_acct_ccy >= 0) {
		v_acct_ccy.arr[v_acct_ccy.len] ='\0';
		PutField_CString(myHash,"acct_ccy",(const char*)v_acct_ccy.arr);
DEBUGLOG(("FindDetailByAvaMerchBankAcct acct_ccy = [%s]\n",v_acct_ccy.arr));
	}

	if (ind_service_code >= 0) {
		v_service_code.arr[v_service_code.len] ='\0';
		PutField_CString(myHash,"service_code",(const char*)v_service_code.arr);
DEBUGLOG(("FindDetailByAvaMerchBankAcct service_code = [%s]\n",v_service_code.arr));
	}

	if (ind_country >= 0) {
		v_country.arr[v_country.len] ='\0';
		PutField_CString(myHash,"country",(const char*)v_country.arr);
DEBUGLOG(("FindDetailByAvaMerchBankAcct country = [%s]\n",v_country.arr));
	}

	if (ind_shared_acct >= 0) {
		PutField_Int(myHash,"shared_acct",v_shared_acct);
DEBUGLOG(("FindDetailByAvaMerchBankAcct shared_acct = [%d]\n",v_shared_acct));
	}

	if (ind_owner_name >= 0) {
		v_owner_name.arr[v_owner_name.len] ='\0';
		PutField_CString(myHash,"owner_name",(const char*)v_owner_name.arr);
DEBUGLOG(("FindDetailByAvaMerchBankAcct owner_name = [%s]\n",v_owner_name.arr));
	}

	if (ind_branch_name >= 0) {
		v_branch_name.arr[v_branch_name.len] ='\0';
		PutField_CString(myHash,"branch_name",(const char*)v_branch_name.arr);
DEBUGLOG(("FindDetailByAvaMerchBankAcct branch_name = [%s]\n",v_branch_name.arr));
	}

DEBUGLOG(("FindDetailByAvaMerchBankAcct Normal Exit\n"));
	return iRet;

detailbyava_error:
DEBUGLOG(("detailbyava_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}


/*
int     FindServiceByBankAcct(const char* csMerchantID,
				const char* csBankCode,
				const char* csAcctNum,
				hash_t* myHash)
{
	int	iRet = PD_OK;
	EXEC SQL WHENEVER SQLERROR GOTO servicebyacct_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar         hv_bank_code[PD_BANK_CODE_LEN];
		varchar         hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];

		varchar		v_service_code[PD_SERVICE_CODE_LEN+1];
		short		ind_service_code = -1;

	EXEC SQL END DECLARE SECTION;

	hv_merchant_id.len = strlen(csMerchantID);
	memcpy(hv_merchant_id.arr, csMerchantID, hv_merchant_id.len);
DEBUGLOG(("FindServiceByBankAcct:int_merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_bank_code.len = strlen(csBankCode);
	memcpy(hv_bank_code.arr, csBankCode, hv_bank_code.len);
DEBUGLOG(("FindServiceByBankAcct:int_bank_code = [%.*s]\n",hv_bank_code.len,hv_bank_code.arr));

	hv_bank_acct_num.len = strlen(csAcctNum);
	memcpy(hv_bank_acct_num.arr,csAcctNum, hv_bank_acct_num.len);
DEBUGLOG(("FindServiceByBankAcct:bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));

	EXEC SQL select	omb_service_code
		into	:v_service_code:ind_service_code
		from	ol_merchant_bank_acct
		where	omb_merchant_id = :hv_merchant_id
		and	omb_int_bank_code = :hv_bank_code
		and	omb_bank_acct_num = :hv_bank_acct_num;

	if (ind_service_code >= 0) {
		v_service_code.arr[v_service_code.len] ='\0';
		PutField_CString(myHash,"service_code",(const char*)v_service_code.arr);
DEBUGLOG(("FindServiceByBankAcct service_code = [%s]\n",v_service_code.arr));
		iRet = PD_OK;
	} else {
DEBUGLOG(("FindServiceByBankAcct Not Found!!!\n"));
		iRet = PD_ERR;
	}

DEBUGLOG(("FindServiceByBankAcct Normal Exit\n"));
	return iRet;

servicebyacct_error:
DEBUGLOG(("servicebyacct_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}


int	CheckAvaDepositBankAccts(const hash_t *hRec)
{
	int	iRet = NOT_FOUND;
	char	*csTmp;

        EXEC SQL WHENEVER SQLERROR GOTO checkbankaccts_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar	hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		int	v_cnt;

		short	ind_merchant_id = -1;
		short	ind_int_bank_code = -1;
		short	ind_bank_acct_num = -1;
	
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("CheckAvaDepositBankAccts: Begin\n"));

	if (GetField_CString(hRec,"merchant_id",&csTmp)) {
		hv_merchant_id.len = strlen(csTmp);
		memcpy(hv_merchant_id.arr, csTmp, hv_merchant_id.len);
DEBUGLOG(("CheckAvaDepositBankAccts:merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
		ind_merchant_id = 0;
	}

	if (GetField_CString(hRec,"int_bank_code",&csTmp)) {
		hv_int_bank_code.len = strlen(csTmp);
		memcpy(hv_int_bank_code.arr, csTmp, hv_int_bank_code.len);
DEBUGLOG(("CheckAvaDepositBankAccts:int_bank_code = [%.*s]\n",hv_int_bank_code.len,hv_int_bank_code.arr));
		ind_int_bank_code = 0;
	}

	if (GetField_CString(hRec,"bank_acct_num",&csTmp)) {
		hv_bank_acct_num.len = strlen(csTmp);
		memcpy(hv_bank_acct_num.arr, csTmp, hv_bank_acct_num.len);
DEBUGLOG(("CheckAvaDepositBankAccts:bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));
		ind_bank_acct_num = 0;
	}

        EXEC SQL SELECT	COUNT(*)
		 INTO	:v_cnt
		 FROM	OL_DEPOSIT_BANK_ACCT_VIEW
		 WHERE	(:hv_merchant_id:ind_merchant_id is null
			or
			merchant_id = :hv_merchant_id:ind_merchant_id)
		 AND	int_bank_code = :hv_int_bank_code:ind_int_bank_code
		 AND	bank_acct_num = :hv_bank_acct_num:ind_bank_acct_num;

	if (v_cnt > 0) {
DEBUGLOG(("CheckAvaDepositBankAccts: cnt = [%d]\n",v_cnt));
		iRet = FOUND;
	} else {
		iRet = NOT_FOUND;
	}
	
DEBUGLOG(("CheckAvaDepositBankAccts: normal Exit Ret = [%d]\n",iRet));
	return iRet;

checkbankaccts_error:
DEBUGLOG(("checkbankaccts_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;

}
*/


int     GetAvaDepositBankAccts(const char* csMerchantId,
                                const char* csBankCode,
                                const char* csCountry,
                                const char* csCcy,
				const char* csServiceCode,
                                hash_t *hRec)
{
	int	iRet = PD_ERR;

	int	iCnt = 0;

        EXEC SQL WHENEVER SQLERROR GOTO getbankaccts_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar	hv_country[PD_COUNTRY_LEN];
		varchar	hv_acct_ccy[PD_CCY_ID_LEN];
		varchar hv_service_code[PD_SERVICE_CODE_LEN];

		varchar v_out_int_bank_code[PD_BANK_CODE_LEN + 1];
                varchar v_out_bank_acct_num[PD_BANK_ACCT_NUM_LEN + 1];
		varchar v_branch_name[PD_BANK_BRANCH_LEN + 1];
		varchar	v_owner_name[PD_NAME_LEN + 1];

		short	ind_merchant_id = -1;
		short	ind_int_bank_code = -1;
		short	ind_country = -1;
		short	ind_acct_ccy = -1;
		short	ind_service_code = -1;

		short	ind_out_int_bank_code = -1;
		short	ind_out_bank_acct_num = -1;
		short   ind_branch_name = -1;
		short	ind_owner_name = -1;
	
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("GetAvaDepositBankAccts: Begin\n"));

	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
DEBUGLOG(("GetAvaDepositBankAccts:merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
	ind_merchant_id = 0;

	hv_int_bank_code.len = strlen(csBankCode);
	memcpy(hv_int_bank_code.arr, csBankCode, hv_int_bank_code.len);
DEBUGLOG(("GetAvaDepositBankAccts:int_bank_code = [%.*s]\n",hv_int_bank_code.len,hv_int_bank_code.arr));
	ind_int_bank_code = 0;

	hv_country.len = strlen(csCountry);
	memcpy(hv_country.arr, csCountry, hv_country.len);
DEBUGLOG(("GetAvaDepositBankAccts:country = [%.*s]\n",hv_country.len,hv_country.arr));
	ind_country = 0;

	hv_acct_ccy.len = strlen(csCcy);
	memcpy(hv_acct_ccy.arr, csCcy, hv_acct_ccy.len);
DEBUGLOG(("GetAvaDepositBankAccts:acct_ccy = [%.*s]\n",hv_acct_ccy.len,hv_acct_ccy.arr));
	ind_acct_ccy = 0;

	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr, csServiceCode, hv_service_code.len);
DEBUGLOG(("GetAvaDepositBankAccts:service_code = [%.*s]\n", hv_service_code.len, hv_service_code.arr));
	ind_service_code = 0;

        EXEC SQL DECLARE c_cursor_getbankaccts CURSOR FOR
		select ob_int_bank_code, ob_bank_acct_num,ob_owner_name,ob_branch_name
		from ol_bank_accts, def_bank, ol_merchant_bank_acct
		where omb_status = 'O'
		and omb_merchant_id = :hv_merchant_id:ind_merchant_id
		and omb_int_bank_code = :hv_int_bank_code:ind_int_bank_code
		and omb_service_code = :hv_service_code:ind_service_code
		and omb_disabled = 0
		and omb_int_bank_code = db_int_bank_code
		and db_country = :hv_country:ind_country
		and omb_int_bank_code = ob_int_bank_code
		and omb_bank_acct_num = ob_bank_acct_num
		and ob_acct_type = 'DSI'
		and ob_status_type = 'A'
		and ob_acct_ccy = :hv_acct_ccy:ind_acct_ccy
		order by dbms_random.value;

	EXEC SQL OPEN c_cursor_getbankaccts;
	do {
		EXEC SQL FETCH c_cursor_getbankaccts
		INTO 
			:v_out_int_bank_code:ind_out_int_bank_code,
			:v_out_bank_acct_num:ind_out_bank_acct_num,
			:v_owner_name:ind_owner_name,
			:v_branch_name:ind_branch_name;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		iCnt++;



                if (ind_out_int_bank_code >= 0) {
			v_out_int_bank_code.arr[v_out_int_bank_code.len] = '\0';
			PutField_CString(hRec, "int_bank_code", (const char*)v_out_int_bank_code.arr);
DEBUGLOG(("GetAvaDepositBankAccts: int_bank_code = [%s]\n", v_out_int_bank_code.arr));
		}

		if (ind_out_bank_acct_num >= 0) {
			v_out_bank_acct_num.arr[v_out_bank_acct_num.len] = '\0';
			PutField_CString(hRec, "bank_acct_num", (const char*)v_out_bank_acct_num.arr);
DEBUGLOG(("GetAvaDepositBankAccts: bank_acct_num = [%s]\n", v_out_bank_acct_num.arr));
		}

		if (ind_owner_name >= 0) {
			v_owner_name.arr[v_owner_name.len] = '\0';
			PutField_CString(hRec, "owner_name", (const char*)v_owner_name.arr);
DEBUGLOG(("GetAvaDepositBankAccts: owner_name = [%s]\n", v_owner_name.arr));
		}
		if (ind_branch_name >= 0) {
                        v_branch_name.arr[v_branch_name.len] = '\0';
                        PutField_CString(hRec, "branch_name", (const char*)v_branch_name.arr);
DEBUGLOG(("GetAvaDepositBankAccts: branch_name = [%s]\n", v_branch_name.arr));
                }

		break; // Only Return 1 record
        }
        while (PD_TRUE);

        EXEC SQL CLOSE c_cursor_getbankaccts;

	if (iCnt > 0 ) {
DEBUGLOG(("GetAvaDepositBankAccts Normal Exit\n"));
                iRet = PD_OK;
        } else {
DEBUGLOG(("GetAvaDepositBankAccts Normal Exit, Not Found\n"));
        }

	return iRet;

getbankaccts_error:
DEBUGLOG(("getbankaccts_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getbankaccts;
        return PD_ERR;
}

int     GetAvaDepositBankAcctsRandom(const char* csMerchantId,
                                const char* csCountry,
                                const char* csCcy,
				const char* csServiceCode,
                                hash_t *hRec)
{
	int	iRet = PD_ERR;

	hash_t *myHash;
	int	iCnt = 0;

        EXEC SQL WHENEVER SQLERROR GOTO getbankacctsrandom_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_country[PD_COUNTRY_LEN];
		varchar	hv_acct_ccy[PD_CCY_ID_LEN];
		varchar hv_service_code[PD_SERVICE_CODE_LEN];

		varchar v_out_int_bank_code[PD_BANK_CODE_LEN + 1];
                varchar v_out_bank_acct_num[PD_BANK_ACCT_NUM_LEN + 1];
		varchar	v_branch_name[PD_BANK_BRANCH_LEN + 1];
		varchar	v_owner_name[PD_NAME_LEN + 1];

		short	ind_merchant_id = -1;
		short	ind_country = -1;
		short	ind_acct_ccy = -1;
		short	ind_service_code = -1;

		short	ind_out_int_bank_code = -1;
		short	ind_out_bank_acct_num = -1;
		short	ind_branch_name = -1;
		short	ind_owner_name = -1;
	
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("GetAvaDepositBankAcctsRandom: Begin\n"));

	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
DEBUGLOG(("GetAvaDepositBankAcctsRandom:merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
	ind_merchant_id = 0;

	hv_country.len = strlen(csCountry);
	memcpy(hv_country.arr, csCountry, hv_country.len);
DEBUGLOG(("GetAvaDepositBankAcctsRandom:country = [%.*s]\n",hv_country.len,hv_country.arr));
	ind_country = 0;

	hv_acct_ccy.len = strlen(csCcy);
	memcpy(hv_acct_ccy.arr, csCcy, hv_acct_ccy.len);
DEBUGLOG(("GetAvaDepositBankAcctsRandom:acct_ccy = [%.*s]\n",hv_acct_ccy.len,hv_acct_ccy.arr));
	ind_acct_ccy = 0;

	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr, csServiceCode, hv_service_code.len);
DEBUGLOG(("GetAvaDepositBankAcctsRandom:service_code = [%.*s]\n", hv_service_code.len, hv_service_code.arr));
	ind_service_code = 0;

        EXEC SQL DECLARE c_cursor_getbankacctsrandom CURSOR FOR
		select ob_int_bank_code, ob_bank_acct_num,ob_owner_name,ob_branch_name
		from ol_bank_accts, def_bank, ol_merchant_bank_acct
		where omb_status = 'O'
		and omb_merchant_id = :hv_merchant_id:ind_merchant_id
		and omb_service_code = :hv_service_code:ind_service_code
		and omb_disabled = 0
		and omb_int_bank_code = db_int_bank_code
		and db_country = :hv_country:ind_country
		and omb_int_bank_code = ob_int_bank_code
		and omb_bank_acct_num = ob_bank_acct_num
		and ob_acct_type = 'DSI'
		and ob_status_type = 'A'
		and ob_acct_ccy = :hv_acct_ccy:ind_acct_ccy
		order by dbms_random.value;

	EXEC SQL OPEN c_cursor_getbankacctsrandom;
	do {
		EXEC SQL FETCH c_cursor_getbankacctsrandom
		INTO 
			:v_out_int_bank_code:ind_out_int_bank_code,
			:v_out_bank_acct_num:ind_out_bank_acct_num,
			:v_owner_name:ind_owner_name,
			:v_branch_name:ind_branch_name;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		iCnt++;

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash,0);


                if (ind_out_int_bank_code >= 0) {
			v_out_int_bank_code.arr[v_out_int_bank_code.len] = '\0';
			PutField_CString(hRec, "int_bank_code", (const char*)v_out_int_bank_code.arr);
DEBUGLOG(("GetAvaDepositBankAcctsRandom: int_bank_code = [%s]\n", v_out_int_bank_code.arr));
		}

		if (ind_out_bank_acct_num >= 0) {
			v_out_bank_acct_num.arr[v_out_bank_acct_num.len] = '\0';
			PutField_CString(hRec, "bank_acct_num", (const char*)v_out_bank_acct_num.arr);
DEBUGLOG(("GetAvaDepositBankAcctsRandom: bank_acct_num = [%s]\n", v_out_bank_acct_num.arr));
		}

		if (ind_owner_name >= 0) {
			v_owner_name.arr[v_owner_name.len] = '\0';
			PutField_CString(hRec, "owner_name", (const char*)v_owner_name.arr);
DEBUGLOG(("GetAvaDepositBankAcctsRandom: owner_name = [%s]\n", v_owner_name.arr));
		}
		if (ind_branch_name >= 0) {
			v_branch_name.arr[v_branch_name.len] = '\0';
			PutField_CString(hRec, "branch_name", (const char*)v_branch_name.arr);
DEBUGLOG(("GetAvaDepositBankAcctsRandom: branch_name = [%s]\n", v_branch_name.arr));
		}
		break; // Only Return 1 record
        }
        while (PD_TRUE);

        EXEC SQL CLOSE c_cursor_getbankacctsrandom;

	if (iCnt > 0 ) {
DEBUGLOG(("GetAvaDepositBankAcctsRandom Normal Exit\n"));
                iRet = PD_OK;
        } else {
DEBUGLOG(("GetAvaDepositBankAcctsRandom Normal Exit, Not Found\n"));
        }

	return iRet;

getbankacctsrandom_error:
DEBUGLOG(("getbankacctsrandom_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getbankacctsrandom;
        return PD_ERR;
}


int GetMerchBankAcctDtl(const char* csIntBankCode, const char* csBankAcctNum, hash_t* hBankAcctDtl)
{
	int iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO getmerchbankacctdtl_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		varchar v_merchant_id[PD_MERCHANT_ID_LEN + 1];
		varchar v_service_code[PD_SERVICE_CODE_LEN + 1];
		varchar v_country[PD_COUNTRY_LEN + 1];
		int	v_match_fifo;
		double	v_match_fifo_amt_limit;

		short ind_int_bank_code = -1;
		short ind_bank_acct_num = -1;
		short ind_merchant_id = -1;
		short ind_service_code = -1;
		short ind_country = -1;
		short ind_match_fifo = -1;
		short ind_match_fifo_amt_limit = -1;
	EXEC SQL END DECLARE SECTION;

	hv_int_bank_code.len = strlen(csIntBankCode);
	memcpy(hv_int_bank_code.arr, csIntBankCode, hv_int_bank_code.len);
	ind_int_bank_code = 0;
DEBUGLOG(("GetMerchBankAcctDtl int_bank_code = [%.*s]\n", hv_int_bank_code.len, hv_int_bank_code.arr));

	hv_bank_acct_num.len = strlen(csBankAcctNum);
	memcpy(hv_bank_acct_num.arr, csBankAcctNum, hv_bank_acct_num.len);
	ind_bank_acct_num = 0;
DEBUGLOG(("GetMerchBankAcctDtl bank_acct_num = [%.*s]\n", hv_bank_acct_num.len, hv_bank_acct_num.arr));

	EXEC SQL DECLARE c_cursor_getmerchbankacctdtl CURSOR FOR
		SELECT	omb_merchant_id, omb_service_code, country, omb_match_fifo, omb_match_fifo_amt_limit
		FROM	ol_merchant_bank_acct, ol_bank_accts, bank_desc
		WHERE	omb_int_bank_code = :hv_int_bank_code:ind_int_bank_code
		AND	omb_bank_acct_num = :hv_bank_acct_num:ind_bank_acct_num
		AND	omb_disabled = 0
		AND	omb_status = 'O'
		AND	omb_int_bank_code = ob_int_bank_code
		AND	omb_bank_acct_num = ob_bank_acct_num
		AND	ob_acct_type = 'DSI'
		AND	ob_shared_acct = 0
		AND	ob_status_type in ('A', 'F')
		AND	ob_int_bank_code = internal_bank_code
		AND	offline_support = 1;

	EXEC SQL OPEN c_cursor_getmerchbankacctdtl;

	for (;;) {
		EXEC SQL FETCH c_cursor_getmerchbankacctdtl
		INTO	:v_merchant_id:ind_merchant_id,
			:v_service_code:ind_service_code,
			:v_country:ind_country,
			:v_match_fifo:ind_match_fifo,
			:v_match_fifo_amt_limit:ind_match_fifo_amt_limit;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		if (ind_merchant_id >= 0) {
			v_merchant_id.arr[v_merchant_id.len] = '\0';
			PutField_CString(hBankAcctDtl, "merchant_id", (const char*)v_merchant_id.arr);
DEBUGLOG(("GetMerchBankAcctDtl merchant_id = [%s]\n", (const char*)v_merchant_id.arr));
		}

		if (ind_service_code >= 0) {
			v_service_code.arr[v_service_code.len] = '\0';
			PutField_CString(hBankAcctDtl, "service_code", (const char*)v_service_code.arr);
DEBUGLOG(("GetMerchBankAcctDtl service_code = [%s]\n", (const char*)v_service_code.arr));
		}

		if (ind_country >= 0) {
			v_country.arr[v_country.len] = '\0';
			PutField_CString(hBankAcctDtl, "country", (const char*)v_country.arr);
DEBUGLOG(("GetMerchBankAcctDtl country = [%s]\n", (const char*)v_country.arr));
		}

		if (ind_match_fifo >= 0) {
			PutField_Int(hBankAcctDtl, "match_fifo", v_match_fifo);
DEBUGLOG(("GetMerchBankAcctDtl match_fifo = [%d]\n", v_match_fifo));
			if (v_match_fifo) {
				if (ind_match_fifo_amt_limit >= 0) {
					PutField_Double(hBankAcctDtl, "match_fifo_amt_limit", v_match_fifo_amt_limit);
DEBUGLOG(("GetMerchBankAcctDtl match_fifo_amt_limit = [%lf]\n", v_match_fifo_amt_limit));
				} else {
					PutField_Double(hBankAcctDtl, "match_fifo_amt_limit", 0);
DEBUGLOG(("GetMerchBankAcctDtl (default) match_fifo_amt_limit = [%lf]\n", 0));
				}
			}
		} else {
			PutField_Int(hBankAcctDtl, "match_fifo", 0);
DEBUGLOG(("GetMerchBankAcctDtl (default) match_fifo = [%d]\n", 0));
		}
	}

	EXEC SQL CLOSE c_cursor_getmerchbankacctdtl;

DEBUGLOG(("GetMerchBankAcctDtl Normal Exit! iRet = [%d]\n", iRet));
	return iRet;

getmerchbankacctdtl_error:
DEBUGLOG(("getmerchbankacctdtl_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLMerchantBankAcct getmerchbankacctdtl_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL CLOSE c_cursor_getmerchbankacctdtl;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}


/*
int GetAllAvaDepositBankAccts(const char* csMerchantId, recordset_t* myRec)
{
	int iRet = PD_OK;
	int iCnt = 0;

	hash_t *myHash;

	EXEC SQL WHENEVER SQLERROR GOTO getallavadepositbankaccts_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_merchant_id[PD_MERCHANT_ID_LEN];

		varchar	v_int_bank_code[PD_BANK_CODE_LEN + 1];
		varchar	v_bank_acct_num[PD_BANK_ACCT_NUM_LEN + 1];
		varchar v_service_code[PD_SERVICE_CODE_LEN + 1];
		varchar	v_country[PD_COUNTRY_LEN + 1];
		int	v_match_fifo;
		double	v_match_fifo_amt_limit;

		short ind_merchant_id = -1;

		short ind_int_bank_code = -1;
		short ind_bank_acct_num = -1;
		short ind_service_code = -1;
		short ind_country = -1;
		short ind_match_fifo = -1;
		short ind_match_fifo_amt_limit = -1;
	EXEC SQL END DECLARE SECTION;

	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetAllAvaDepositBankAccts merchant_id = [%.*s]\n", hv_merchant_id.len, hv_merchant_id.arr));
DEBUGLOG(("\n"));

	EXEC SQL DECLARE c_cursor CURSOR FOR
		SELECT	ob_int_bank_code, ob_bank_acct_num, omb_service_code, country, omb_match_fifo, omb_match_fifo_amt_limit
		FROM	ol_merchant_bank_acct, ol_bank_accts, bank_desc
		WHERE	omb_merchant_id = :hv_merchant_id:ind_merchant_id
		AND	omb_disabled = 0
		AND	omb_status = 'O'
		AND	omb_int_bank_code = ob_int_bank_code
		AND	omb_bank_acct_num = ob_bank_acct_num
		AND	ob_acct_type = 'DSI'
		AND	ob_status_type <> 'I'
		AND	omb_int_bank_code = internal_bank_code
		AND	offline_support = 1
		ORDER BY ob_int_bank_code, ob_bank_acct_num;

	EXEC SQL OPEN c_cursor;
	for (;;) {
		EXEC SQL FETCH c_cursor
		INTO	:v_int_bank_code:ind_int_bank_code,
			:v_bank_acct_num:ind_bank_acct_num,
			:v_service_code:ind_service_code,
			:v_country:ind_country,
			:v_match_fifo:ind_match_fifo,
			:v_match_fifo_amt_limit:ind_match_fifo_amt_limit;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash, 0);

		iCnt++;

		if (ind_int_bank_code >= 0 && ind_bank_acct_num >= 0 && ind_service_code >= 0 && ind_country >= 0) {
			v_int_bank_code.arr[v_int_bank_code.len] = '\0';
			PutField_CString(myHash, "int_bank_code", (const char*)v_int_bank_code.arr);
DEBUGLOG(("GetAllAvaDepositBankAccts int_bank_code_%d = [%s]\n", iCnt, (const char*)v_int_bank_code.arr));

			v_bank_acct_num.arr[v_bank_acct_num.len] = '\0';
			PutField_CString(myHash, "bank_acct_num", (const char*)v_bank_acct_num.arr);
DEBUGLOG(("GetAllAvaDepositBankAccts bank_acct_num_%d = [%s]\n", iCnt, (const char*)v_bank_acct_num.arr));

			v_service_code.arr[v_service_code.len] = '\0';
			PutField_CString(myHash, "service_code", (const char*)v_service_code.arr);
DEBUGLOG(("GetAllAvaDepositBankAccts service_code_%d = [%s]\n", iCnt, (const char*)v_service_code.arr));

			v_country.arr[v_country.len] = '\0';
			PutField_CString(myHash, "country", (const char*)v_country.arr);
DEBUGLOG(("GetAllAvaDepositBankAccts country_%d = [%s]\n", iCnt, (const char*)v_country.arr));

			if (ind_match_fifo >= 0) {
				PutField_Int(myHash, "match_fifo", v_match_fifo);
DEBUGLOG(("GetAllAvaDepositBankAccts match_fifo_%d = [%d]\n", iCnt, v_match_fifo));

				if (v_match_fifo) {
					if (ind_match_fifo_amt_limit >= 0) {
						PutField_Double(myHash, "match_fifo_amt_limit", v_match_fifo_amt_limit);
DEBUGLOG(("GetAllAvaDepositBankAccts match_fifo_amt_limit_%d = [%lf]\n", iCnt, v_match_fifo_amt_limit));
					} else {
						PutField_Double(myHash, "match_fifo_amt_limit", 0);
DEBUGLOG(("GetAllAvaDepositBankAccts (default) match_fifo_amt_limit_%d = [%lf]\n", iCnt, 0));
					}
				}
			} else {
				PutField_Int(myHash, "match_fifo", 0);
DEBUGLOG(("GetAllAvaDepositBankAccts (default) match_fifo_%d = [%d]\n", iCnt, 0));

			}
DEBUGLOG(("\n"));
		}

		RecordSet_Add(myRec, myHash);
	}

	EXEC SQL CLOSE c_cursor;

DEBUGLOG(("GetAllAvaDepositBankAccts Normal Exit! iRet = [%d]\n", iRet));
	return iRet;

getallavadepositbankaccts_error:
DEBUGLOG(("getallavadepositbankaccts_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLMerchantBankAcct getallavadepositbankaccts_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL CLOSE c_cursor;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}
*/


int     GetBeneficiaryBank(const char* csMerchantId,
                        const char* csCountry,
                        const char* csCcy,
                        const char* csAcctNum,
                        hash_t *myHash)
{
        int     iRet = PD_ERR;
	int	iCnt = 0;

	EXEC SQL WHENEVER SQLERROR GOTO getbenbank_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar hv_country[PD_COUNTRY_LEN];
		varchar hv_acct_ccy[PD_CCY_ID_LEN];
		varchar hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];

		varchar v_out_int_bank_code[PD_BANK_CODE_LEN + 1];
		varchar v_out_bank_name[PD_BANK_NAME_LEN + 1];

		short   ind_merchant_id = -1;
		short   ind_country = -1;
		short   ind_acct_ccy = -1;
		short	ind_bank_acct_num = -1;

		short   ind_out_int_bank_code = -1;
		short   ind_out_bank_name = -1; 

	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("GetBeneficiaryBank: Begin\n"));

	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
DEBUGLOG(("GetBeneficiaryBank:merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        ind_merchant_id = 0;

	hv_country.len = strlen(csCountry);
        memcpy(hv_country.arr, csCountry, hv_country.len);
DEBUGLOG(("GetBeneficiaryBank:country = [%.*s]\n",hv_country.len,hv_country.arr));
	ind_country = 0;

	hv_acct_ccy.len = strlen(csCcy);
	memcpy(hv_acct_ccy.arr, csCcy, hv_acct_ccy.len);
DEBUGLOG(("GetBeneficiaryBank:acct_ccy = [%.*s]\n",hv_acct_ccy.len,hv_acct_ccy.arr));
	ind_acct_ccy = 0;

	hv_bank_acct_num.len = strlen(csAcctNum);
	memcpy(hv_bank_acct_num.arr, csAcctNum, hv_bank_acct_num.len);
DEBUGLOG(("GetBeneficiaryBank:bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));
	ind_bank_acct_num = 0;

	EXEC SQL DECLARE c_cursor_getbenbank CURSOR FOR
		select internal_bank_code, bank_name
		from bank_desc, ol_bank_accts, def_bank, ol_merchant_bank_acct
		where omb_status = 'O'
		and omb_merchant_id = :hv_merchant_id:ind_merchant_id
		and omb_disabled = 0
		and omb_bank_acct_num = :hv_bank_acct_num:ind_bank_acct_num
		and omb_int_bank_code = db_int_bank_code
		and db_country = :hv_country:ind_country
		and omb_int_bank_code = ob_int_bank_code
		and omb_bank_acct_num = ob_bank_acct_num
		and ob_acct_type = 'DSI'
		and ob_status_type = 'A'
		and ob_acct_ccy = :hv_acct_ccy:ind_acct_ccy
		and internal_bank_code = ob_int_bank_code;

	EXEc SQL OPEN c_cursor_getbenbank;
	do {
		EXEC SQL FETCH c_cursor_getbenbank
		INTO	
			:v_out_int_bank_code:ind_out_int_bank_code,
			:v_out_bank_name:ind_out_bank_name;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}
		iCnt++;

		if (ind_out_int_bank_code >= 0) {
			v_out_int_bank_code.arr[v_out_int_bank_code.len] = '\0';
			PutField_CString(myHash, "int_bank_code", (const char*)v_out_int_bank_code.arr);
DEBUGLOG(("GetBeneficiaryBank: int_bank_code = [%s]\n", v_out_int_bank_code.arr));
                }

		if (ind_out_bank_name >= 0) {
			v_out_bank_name.arr[v_out_bank_name.len] = '\0';
			PutField_CString(myHash, "bank_name", (const char*)v_out_bank_name.arr);
DEBUGLOG(("GetBeneficiaryBank: bank_name = [%s]\n", v_out_bank_name.arr));
		}

		break;
	} while (PD_TRUE);
	
	EXEC SQL CLOSE c_cursor_getbenbank;

	if (iCnt > 0) {
DEBUGLOG(("GetBeneficiaryBank Normal Exit\n")); 
		iRet = PD_OK;
	} else {
DEBUGLOG(("GetBeneficiaryBank Normal Exit, NOT FOUND\n")); 
	}

	return iRet;

getbenbank_error:
DEBUGLOG(("getbenbank_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLMerchantBankAcct::GetBeneficiaryBank:getbenbank_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getbenbank;
        return PD_ERR;
}

