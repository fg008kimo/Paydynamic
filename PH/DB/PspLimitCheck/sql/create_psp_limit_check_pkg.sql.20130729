CREATE OR REPLACE PACKAGE PSP_LIMIT_CHECK_PKG
IS
   PROCEDURE P_MERCHANT_PSP_LIMIT (
      in_party_id           IN     PSP_LIMIT_CHECK.PC_PARTY_ID%TYPE,
      out_cursor            IN OUT SYS_REFCURSOR);

   PROCEDURE P_PSP_PSP_LIMIT (
      in_party_id           IN     PSP_LIMIT_CHECK.PC_PARTY_ID%TYPE,
      out_cursor            IN OUT SYS_REFCURSOR);

   PROCEDURE P_SERVICE_PSP_LIMIT (
      out_cursor            IN OUT SYS_REFCURSOR);

   FUNCTION F_CHECK_FIND (
      in_party_type         IN     PSP_LIMIT_CHECK.PC_PARTY_TYPE%TYPE,
      in_party_id           IN     PSP_LIMIT_CHECK.PC_PARTY_ID%TYPE,
      in_business_type      IN     PSP_LIMIT_CHECK.PC_BUSINESS_TYPE%TYPE,
      out_cursor            IN OUT SYS_REFCURSOR)
      RETURN NUMBER;

END PSP_LIMIT_CHECK_PKG;
/

CREATE OR REPLACE PACKAGE BODY PSP_LIMIT_CHECK_PKG
IS
   PROCEDURE P_MERCHANT_PSP_LIMIT (
      in_party_id   IN     PSP_LIMIT_CHECK.PC_PARTY_ID%TYPE,
      out_cursor    IN OUT SYS_REFCURSOR)
   IS
   BEGIN
      OPEN out_cursor FOR
           SELECT MERCH_DETAIL.CLIENT_ID AS CLIENT_ID,
                  MERCH_DETAIL.CLIENT_NAME AS CLIENT_NAME,
                  MERCH_DETAIL.MERCHANT_ID AS MERCHANT_ID,
                  MERCH_DETAIL.SHORT_NAME AS SHORT_NAME,
                  MERCH_DETAIL.BUSINESS_TYPE,
                  /*PSP_DETAIL.PM_CLIENT_ID AS PSP_CLIENT_ID,
                  PSP_DETAIL.PM_CLIENT_NAME AS PSP_CLIENT_NAME,
                  PSP_DETAIL.RPP_PSP_ID AS PSP_ID,
                  PSP_DETAIL.PSP_NAME AS PSP_NAME,*/
                  PSP_DETAIL.CURRENCY_ID AS CURRENCY_ID,
                  SUM (PSP_DETAIL.RPP_LIMIT) AS LIMIT,
                  SUM (REMAINING_LIMIT) AS REMAINING_LIMIT
             FROM (  SELECT CLIENT_ID,
                            CLIENT_NAME,
                            MERCHANT_ID,
                            SHORT_NAME,
                            BUSINESS_TYPE,
                            RM_PSP_ID
                       FROM (SELECT RC_CHANNEL_CODE,
                                    RC_SERVICE_CODE,
                                    RC_PAYMENT_METHOD,
                                    RC_COUNTRY,
                                    RC_CCY,
                                    RC_PARTY_TYPE,
                                    RC_PARTY_ID,
                                    RC_BUSINESS_TYPE,
                                    RC_CRITERIA_POOL_ID,
                                    RC_CUSTOMER_SEGMENT,
                                    RP_CRITERIA_POOL_ID,
                                    RP_POOL_ID
                               FROM RULE_PSP_LB_CRITERIA, RULE_PSP_LB_POOLS
                              WHERE     RULE_TXN_LIMIT_PKG.FINDSCHEDULE (
                                           RC_SCHEDULER_ID) = 1
                                    AND RC_CRITERIA_POOL_ID = RP_CRITERIA_POOL_ID
                                    AND RP_DISABLED = 0
                                    AND RC_DISABLED = 0),
                            (SELECT BUSINESS_TYPE,
                                    MERCHANT_ID,
                                    SHORT_NAME,
                                    CLIENTS.CLIENT_ID,
                                    CLIENTS.CLIENT_NAME
                               FROM MERCH_DETAIL, CLIENTS
                              WHERE     DISABLED = 0
                                    AND MERCH_DETAIL.STATUS = 'O'
                                    AND MERCH_DETAIL.CLIENT_ID =
                                           CLIENTS.CLIENT_ID
                                    AND CLIENTS.STATUS = 'O'),
                            RULE_PSP_LB_MAPPING
                      WHERE        RC_BUSINESS_TYPE = BUSINESS_TYPE
                               AND RP_POOL_ID = RM_POOL_ID
                               AND RM_DISABLED = 0
                               AND ((    RC_PARTY_TYPE = 'M'
                                    AND RC_PARTY_ID = MERCHANT_ID)
                            OR (RC_PARTY_TYPE = 'C' AND RC_PARTY_ID = CLIENT_ID)
                            OR (RC_PARTY_TYPE = 'G'))
                   GROUP BY CLIENT_ID,
                            CLIENT_NAME,
                            MERCHANT_ID,
                            SHORT_NAME,
                            BUSINESS_TYPE,
                            RM_PSP_ID) MERCH_DETAIL,
                  (  SELECT PM_CLIENT_ID,
                            PM_CLIENT_NAME,
                            PSP_NAME,
                            RPP_PSP_ID,
                            CURRENCY_ID,
                            RPP_LIMIT,
                            CASE
                               WHEN RPP_LIMIT = 0 THEN RPP_LIMIT
                               ELSE RPP_LIMIT - NVL (TC_TOTAL_COUNTER, 0)
                            END
                               AS REMAINING_LIMIT
                       FROM (SELECT PM_CLIENT_ID,
                                    PM_CLIENT_NAME,
                                    RPP_PSP_ID,
                                    PSP_NAME,
                                    CURRENCY_ID,
                                    RPP_LIMIT
                               FROM (SELECT RPP_PSP_ID, RPP_LIMIT
                                       FROM RULE_PSP_LB_PSP
                                      WHERE RPP_DISABLED = 0),
                                    (SELECT PM_CLIENT_ID,
                                            PM_CLIENT_NAME,
                                            PSP_ID,
                                            PSP_NAME,
                                            CURRENCY_ID
                                       FROM PSP_DETAIL, PSP_MASTER
                                      WHERE     CLIENT_ID = PM_CLIENT_ID
                                            AND DISABLED = 0
                                            AND ONLINE_MODE = 'Y'
                                            AND STATUS = 'O'
                                            AND PM_STATUS = 'O')
                              WHERE RPP_PSP_ID = PSP_ID)
                            LEFT JOIN
                            (  SELECT SUM (TC_TOTAL_COUNTER) AS TC_TOTAL_COUNTER,
                                      TC_PARTY_ID AS PARTY_PSP_ID
                                 FROM TXN_COUNTERS
                                WHERE     TC_PARTY_TYPE = 'P'
                                      AND TC_CATEGORY = 'AMT'
                                      AND TC_TYPE = 'D'
                             GROUP BY TC_PARTY_ID)
                               ON RPP_PSP_ID = PARTY_PSP_ID
                      WHERE 1 = 1
                   ORDER BY PM_CLIENT_NAME, PSP_NAME, CURRENCY_ID) PSP_DETAIL
            WHERE RM_PSP_ID = RPP_PSP_ID
                  AND (MERCHANT_ID = in_party_id OR in_party_id IS NULL)
         GROUP BY CLIENT_ID,
                  CLIENT_NAME,
                  MERCHANT_ID,
                  SHORT_NAME,
                  BUSINESS_TYPE,
                  CURRENCY_ID
         ORDER BY SHORT_NAME;
   END P_MERCHANT_PSP_LIMIT;


   PROCEDURE P_PSP_PSP_LIMIT (
      in_party_id   IN     PSP_LIMIT_CHECK.PC_PARTY_ID%TYPE,
      out_cursor    IN OUT SYS_REFCURSOR)
   IS
   BEGIN
      OPEN out_cursor FOR
           SELECT PM_CLIENT_ID AS PSP_CLIENT_ID,
                  PM_CLIENT_NAME AS PSP_CLIENT_NAME,
                  RPP_PSP_ID AS RPP_PSP_ID,
                  PSP_NAME AS PSP_NAME,
                  PSP_TYPE AS PSP_TYPE,
                  CURRENCY_ID AS CURRENCY_ID,
                  RPP_LIMIT AS RPP_LIMIT,
                  CASE
                     WHEN RPP_LIMIT = 0 THEN RPP_LIMIT
                     ELSE RPP_LIMIT - NVL (TC_TOTAL_COUNTER, 0)
                  END
                     AS REMAINING_LIMIT
             FROM (SELECT PM_CLIENT_ID,
                          PM_CLIENT_NAME,
                          RPP_PSP_ID,
                          PSP_NAME,
                          PSP_TYPE,
                          CURRENCY_ID,
                          RPP_LIMIT
                     FROM (SELECT RPP_PSP_ID, RPP_LIMIT
                             FROM RULE_PSP_LB_PSP
                            WHERE RPP_DISABLED = 0),
                          (SELECT PM_CLIENT_ID,
                                  PM_CLIENT_NAME,
                                  PSP_ID,
                                  PSP_NAME,
                                  PSP_TYPE,
                                  CURRENCY_ID
                             FROM PSP_DETAIL, PSP_MASTER
                            WHERE     CLIENT_ID = PM_CLIENT_ID
                                  AND DISABLED = 0
                                  AND ONLINE_MODE = 'Y'
                                  AND STATUS = 'O'
                                  AND PM_STATUS = 'O')
                    WHERE RPP_PSP_ID = PSP_ID)
                  LEFT JOIN
                  (  SELECT SUM (TC_TOTAL_COUNTER) AS TC_TOTAL_COUNTER,
                            TC_PARTY_ID AS PARTY_PSP_ID
                       FROM TXN_COUNTERS
                      WHERE     TC_PARTY_TYPE = 'P'
                            AND TC_CATEGORY = 'AMT'
                            AND TC_TYPE = 'D'
                   GROUP BY TC_PARTY_ID)
                     ON RPP_PSP_ID = PARTY_PSP_ID
            WHERE 1 = 1 AND (RPP_PSP_ID = in_party_id OR in_party_id IS NULL)
         ORDER BY PSP_NAME;
   END P_PSP_PSP_LIMIT;


   PROCEDURE P_SERVICE_PSP_LIMIT (
      out_cursor    IN OUT SYS_REFCURSOR)
   IS
   BEGIN
      OPEN out_cursor FOR
           SELECT /*PM_CLIENT_ID AS PSP_CLIENT_ID,
                  PM_CLIENT_NAME AS PSP_CLIENT_NAME,
                  PSP_NAME AS PSP_NAME,
                  RPP_PSP_ID AS RPP_PSP_ID,*/
                  SP_SERVICE_CODE,
                  PSP_TYPE,
                  CURRENCY_ID AS CURRENCY_ID,
                  SUM (RPP_LIMIT) AS RPP_LIMIT,
                  SUM (
                     CASE
                        WHEN RPP_LIMIT = 0 THEN RPP_LIMIT
                        ELSE RPP_LIMIT - NVL (TC_TOTAL_COUNTER, 0)
                     END)
                     AS REMAINING_LIMIT
             FROM (SELECT PM_CLIENT_ID,
                          PM_CLIENT_NAME,
                          RPP_PSP_ID,
                          PSP_NAME,
                          CURRENCY_ID,
                          SP_SERVICE_CODE,
                          PSP_TYPE,
                          RPP_LIMIT
                     FROM (SELECT RPP_PSP_ID, RPP_LIMIT
                             FROM RULE_PSP_LB_PSP
                            WHERE RPP_DISABLED = 0),
                          (SELECT PM_CLIENT_ID,
                                  PM_CLIENT_NAME,
                                  PSP_ID,
                                  PSP_NAME,
                                  CURRENCY_ID,
                                  PSP_TYPE
                             FROM PSP_DETAIL, PSP_MASTER
                            WHERE     CLIENT_ID = PM_CLIENT_ID
                                  AND DISABLED = 0
                                  AND ONLINE_MODE = 'Y'
                                  AND STATUS = 'O'
                                  AND PM_STATUS = 'O'),
                          (SELECT COUNTRY AS CP_COUNTRY, PSP_ID AS CP_PSP_ID
                             FROM PSP_COUNTRY),
                          PSP_PAY_METHOD,
                          SERVICE_PAY_METHOD
                    WHERE     RPP_PSP_ID = PSP_ID
                          AND RPP_PSP_ID = CP_PSP_ID
                          AND RPP_PSP_ID = PP_PSP_ID
                          AND PP_COUNTRY = CP_COUNTRY
                          AND PP_PAY_METHOD = SP_PAY_METHOD
                          AND PP_DISABLED = 0
                          AND SP_DISABLED = 0)
                  LEFT JOIN
                  (  SELECT SUM (TC_TOTAL_COUNTER) AS TC_TOTAL_COUNTER,
                            TC_PARTY_ID AS PARTY_PSP_ID
                       FROM TXN_COUNTERS
                      WHERE     TC_PARTY_TYPE = 'P'
                            AND TC_CATEGORY = 'AMT'
                            AND TC_TYPE = 'D'
                   GROUP BY TC_PARTY_ID)
                     ON RPP_PSP_ID = PARTY_PSP_ID
            WHERE 1 = 1
         GROUP BY SP_SERVICE_CODE, PSP_TYPE, CURRENCY_ID
         ORDER BY SP_SERVICE_CODE;
   END P_SERVICE_PSP_LIMIT;

   FUNCTION F_CHECK_FIND (
      in_party_type IN     PSP_LIMIT_CHECK.PC_PARTY_TYPE%TYPE,
      in_party_id   IN     PSP_LIMIT_CHECK.PC_PARTY_ID%TYPE,
      in_business_type IN  PSP_LIMIT_CHECK.PC_BUSINESS_TYPE%TYPE,
      out_cursor    IN OUT SYS_REFCURSOR)
      RETURN NUMBER
   IS
      iCnt   INTEGER := 0;
   BEGIN
      SELECT COUNT (*)
        INTO iCnt
        FROM PSP_LIMIT_CHECK
       WHERE PC_PARTY_TYPE = in_party_type AND PC_PARTY_ID = in_party_id AND PC_DISABLED = 0;

      IF iCnt > 0
      THEN
         OPEN out_cursor FOR
            SELECT PC_ALERT_LEVEL,
                   TO_CHAR (PC_LAST_CHECKING_TIME, 'YYYYMMDDHH24MISS')
              FROM PSP_LIMIT_CHECK
             WHERE PC_PARTY_TYPE = in_party_type AND PC_PARTY_ID = in_party_id AND PC_DISABLED = 0;

         RETURN 1;
      ELSE
         SELECT COUNT (*)
           INTO iCnt
           FROM PSP_LIMIT_CHECK
          WHERE     PC_PARTY_TYPE = in_party_type
                AND PC_PARTY_ID = '000'
                AND PC_BUSINESS_TYPE = in_business_type
                AND PC_DISABLED = 0;

         IF iCnt > 0
         THEN
            OPEN out_cursor FOR
               SELECT PC_ALERT_LEVEL,
                      TO_CHAR (PC_LAST_CHECKING_TIME, 'YYYYMMDDHH24MISS')
                 FROM PSP_LIMIT_CHECK
                WHERE     PC_PARTY_TYPE = in_party_type
                      AND PC_PARTY_ID = '000'
                      AND PC_BUSINESS_TYPE = in_business_type
                      AND PC_DISABLED = 0;

            RETURN 1;
         ELSE
             SELECT COUNT (*)
               INTO iCnt
               FROM PSP_LIMIT_CHECK
              WHERE     PC_PARTY_TYPE = in_party_type
                    AND PC_PARTY_ID = '000'
                    AND PC_BUSINESS_TYPE IS NULL
                    AND PC_DISABLED = 0;
    
             IF iCnt > 0
             THEN
                OPEN out_cursor FOR
                   SELECT PC_ALERT_LEVEL,
                          TO_CHAR (PC_LAST_CHECKING_TIME, 'YYYYMMDDHH24MISS')
                     FROM PSP_LIMIT_CHECK
                    WHERE     PC_PARTY_TYPE = in_party_type
                          AND PC_PARTY_ID = '000'
                          AND PC_BUSINESS_TYPE IS NULL
                          AND PC_DISABLED = 0;
    
                RETURN 1;
             END IF;
         END IF;
      END IF;
      RETURN 0;
   END F_CHECK_FIND;
END PSP_LIMIT_CHECK_PKG;
/

