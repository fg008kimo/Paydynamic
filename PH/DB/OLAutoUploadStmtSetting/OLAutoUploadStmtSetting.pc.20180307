/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2017/10/12              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "internal.h"
#include "OLAutoUploadStmtSetting.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;


void OLAutoUploadStmtSetting(char    cdebug)
{
        cDebug = cdebug;
}


int GetProviderByPathName(const char* csPathName, char* csProviderName, char* csProviderId)
{
	int iRet = PD_NOT_FOUND;
	int iCnt = 0;

        EXEC SQL WHENEVER SQLERROR GOTO getprovider_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_path_name[PD_CLIENT_NAME_LEN + 1];
	
		varchar         v_provider_name[PD_CLIENT_NAME_LEN];
                varchar         v_provider_id[PD_CLIENT_ID_LEN];

                short           ind_provider_name= -1;
                short           ind_provider_id= -1;
        EXEC SQL END DECLARE SECTION;

        hv_path_name.len = strlen(csPathName);
        memcpy(hv_path_name.arr, csPathName, hv_path_name.len);
DEBUGLOG(("GetProviderByPathName path_name = [%.*s]\n", hv_path_name.len, hv_path_name.arr));

        EXEC SQL DECLARE c_cursor_getprovider CURSOR FOR
                select  pm_client_name,
			pm_client_id
                from    psp_master, ol_auto_upload_stmt_setting
                where   oaus_provider_pathname = :hv_path_name
		and 	oaus_provider_id = pm_client_id
		and	oaus_disabled = 0
		group by pm_client_name,
			 pm_client_id;

        EXEC SQL OPEN c_cursor_getprovider;
        do {
                EXEC SQL FETCH c_cursor_getprovider
                INTO
			:v_provider_name:ind_provider_name,
                        :v_provider_id:ind_provider_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

DEBUGLOG(("GetProviderByPathName found record\n"));

/* provider_name */
                if (ind_provider_name >= 0) {
                        v_provider_name.arr[v_provider_name.len] = '\0';
                        strcpy(csProviderName,(const char*)v_provider_name.arr);
DEBUGLOG(("GetProviderByPathName provider_name = [%s]\n", v_provider_name.arr));
                }

/* provider_id */
                if (ind_provider_id >= 0) {
                        v_provider_id.arr[v_provider_id.len] = '\0';
                        strcpy(csProviderId,(const char*)v_provider_id.arr);
DEBUGLOG(("GetProviderByPathName provider_id = [%s]\n", v_provider_id.arr));
	        }

		iCnt++;

        } while (PD_TRUE);

        EXEC SQL CLOSE c_cursor_getprovider;

	if (iCnt > 0) {
DEBUGLOG(("GetProviderByPathName Found\n"));
		iRet = PD_FOUND;
	} else {
DEBUGLOG(("GetProviderByPathName Not Found\n"));
		iRet = PD_NOT_FOUND;	
	}

        return iRet;

getprovider_error:
DEBUGLOG(("getprovider_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLPspDetail_GetProviderByPathName: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getprovider;
        return PD_ERR;
}

