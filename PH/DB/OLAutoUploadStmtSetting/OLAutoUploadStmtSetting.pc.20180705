/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2017/10/12              Elvis Wong
Modify GetDetailByPathName			   2018/03/07		   Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "internal.h"
#include "OLAutoUploadStmtSetting.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;


void OLAutoUploadStmtSetting(char    cdebug)
{
        cDebug = cdebug;
}


int GetDetailByPathName(const char* csProviderPath, 
			const char* csNaturePath, 
			char* csProviderName, 
			char* csProviderId, 
			char* csNature)
{
	int iRet = PD_NOT_FOUND;
	int iCnt = 0;

        EXEC SQL WHENEVER SQLERROR GOTO getdetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_provider_path[PD_CLIENT_NAME_LEN + 1];
                varchar         hv_nature_path[PD_CLIENT_NAME_LEN + 1];
	
		varchar         v_provider_name[PD_CLIENT_NAME_LEN];
                varchar         v_provider_id[PD_CLIENT_ID_LEN];
                varchar         v_nature[PD_ACCT_TYPE_LEN];

                short           ind_provider_name= -1;
                short           ind_provider_id= -1;
                short           ind_nature= -1;
        EXEC SQL END DECLARE SECTION;

        hv_provider_path.len = strlen(csProviderPath);
        memcpy(hv_provider_path.arr, csProviderPath, hv_provider_path.len);
DEBUGLOG(("GetDetailByPathName provider_path = [%.*s]\n", hv_provider_path.len, hv_provider_path.arr));

	hv_nature_path.len = strlen(csNaturePath);
        memcpy(hv_nature_path.arr, csNaturePath, hv_nature_path.len);
DEBUGLOG(("GetDetailByPathName nature_path = [%.*s]\n", hv_nature_path.len, hv_nature_path.arr));

        EXEC SQL DECLARE c_cursor_getprovider CURSOR FOR
                select  pm_client_name,
			pm_client_id,
			oaus_nature
                from    psp_master, ol_auto_upload_stmt_setting
                where   oaus_provider_pathname = :hv_provider_path
		and	oaus_nature_path = :hv_nature_path
		and 	oaus_provider_id = pm_client_id
		and	oaus_disabled = 0
		group by pm_client_name,
			 pm_client_id,
			 oaus_nature;

        EXEC SQL OPEN c_cursor_getprovider;
        do {
                EXEC SQL FETCH c_cursor_getprovider
                INTO
			:v_provider_name:ind_provider_name,
                        :v_provider_id:ind_provider_id,
                        :v_nature:ind_nature;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

DEBUGLOG(("GetDetailByPathName found record\n"));

/* provider_name */
                if (ind_provider_name >= 0) {
                        v_provider_name.arr[v_provider_name.len] = '\0';
                        strcpy(csProviderName,(const char*)v_provider_name.arr);
DEBUGLOG(("GetDetailByPathName provider_name = [%s]\n", v_provider_name.arr));
                }

/* provider_id */
                if (ind_provider_id >= 0) {
                        v_provider_id.arr[v_provider_id.len] = '\0';
                        strcpy(csProviderId,(const char*)v_provider_id.arr);
DEBUGLOG(("GetDetailByPathName provider_id = [%s]\n", v_provider_id.arr));
	        }

/* nature */
                if (ind_nature >= 0) {
                        v_nature.arr[v_nature.len] = '\0';
                        strcpy(csNature,(const char*)v_nature.arr);
DEBUGLOG(("GetDetailByPathName nature = [%s]\n", v_nature.arr));
                }

		iCnt++;

        } while (PD_TRUE);

        EXEC SQL CLOSE c_cursor_getprovider;

	if (iCnt > 0) {
DEBUGLOG(("GetDetailByPathName Found\n"));
		iRet = PD_FOUND;
	} else {
DEBUGLOG(("GetDetailByPathName Not Found\n"));
		iRet = PD_NOT_FOUND;	
	}

        return iRet;

getdetail_error:
DEBUGLOG(("getdetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLPspDetail_GetDetailByPathName: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getprovider;
        return PD_ERR;
}

