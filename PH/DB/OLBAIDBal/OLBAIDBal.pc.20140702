/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/10/11              LokMan Chow
Update to BAID Bal				   2014/01/02		   Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLBAIDBal.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void OLBAIDBal(char    cdebug)
{
        cDebug = cdebug;
}

int UpdateBalance(const char* csBAID,
		const char* csCountryId,
		const char* csCcy,
		const char  cType, 
		double dAmt,
		char* csUpdateUser)
{
	EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_baid[PD_BAID_LEN];
		varchar		hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		double		hv_balance;
		varchar 	hv_create_user[PD_USER_LEN];

		short		ind_baid = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_balance = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("UpdateBalance: Begin\n"));

	hv_baid.len = strlen(csBAID);
	strncpy((char*)hv_baid.arr, csBAID, hv_baid.len);
	ind_baid = 0;
DEBUGLOG(("UpdateBalance:baid = [%.*s]\n",hv_baid.len,hv_baid.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy((char*)hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("UpdateBalance:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy((char*)hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("UpdateBalance:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	if(cType == PD_IND_CREDIT){
		hv_balance= dAmt;
DEBUGLOG(("UpdateBalance:credit balance = [%f]\n",hv_balance));
	}
	else{
		hv_balance= (-1)*dAmt;
DEBUGLOG(("UpdateBalance:debit balance = [%f]\n",(-1)*hv_balance));
	}
	ind_balance= 0;

	hv_create_user.len = strlen(csUpdateUser);
	strncpy((char*)hv_create_user.arr, csUpdateUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("UpdateBalance:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));

		EXEC SQL EXECUTE
		    BEGIN

			:hv_return_value := sp_ol_bankacctid_bal_update(
				:hv_baid:ind_baid,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_balance:ind_balance,
				:hv_create_user:ind_create_user);

		    END;
		END-EXEC;

DEBUGLOG(("UpdateBalance:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdateBalance:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("OLBAIDBal_UpdateBalance: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateBalance: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("OLBAIDBal_UpdateBalance: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateBalance: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLBAIDBal_UpdateBalance: SP_ERR TxnAbort\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}



int GetBalance(const char* csBAID,
		hash_t *hVal)
{
	int iRet = PD_OK;
                
        EXEC SQL WHENEVER SQLERROR GOTO get_bal_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_baid[PD_BAID_LEN];
                
		double		v_balance;

		short		ind_balance= -1;
        
        
        EXEC SQL END DECLARE SECTION;
        
        hv_baid.len = strlen(csBAID);
        memcpy(hv_baid.arr,csBAID,hv_baid.len);
DEBUGLOG(("GetBalance baid = [%.*s]\n",hv_baid.len,hv_baid.arr));

        EXEC SQL select	obab_bal
		 into	:v_balance:ind_balance
                 from	ol_baid_bal
		 where	obab_baid = :hv_baid;

        if(ind_balance<0)
		v_balance = 0;
	PutField_Double(hVal,"balance",v_balance);
DEBUGLOG(("GetBalance balance = [%f]\n",v_balance));


DEBUGLOG(("GetBalance Normal Exit\n"));
	return iRet;

get_bal_error:
DEBUGLOG(("get_bal_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLBAIDBal_Get: SP_ERR\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}


int GetBalanceForUpdate(const char* csBAID,
                hash_t *hVal)
{
        int iRet = PD_OK;
    
        EXEC SQL WHENEVER SQLERROR GOTO get_bal_update_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
    
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_baid[PD_BAID_LEN];
                double          v_balance;

                short           ind_balance= -1;

        EXEC SQL END DECLARE SECTION;

        hv_baid.len = strlen(csBAID);
        memcpy(hv_baid.arr,csBAID,hv_baid.len);
DEBUGLOG(("GetBalanceForUpdate baid = [%.*s]\n",hv_baid.len,hv_baid.arr));

        EXEC SQL select obab_bal
                 into   :v_balance:ind_balance
                 from   ol_baid_bal
                 where  obab_baid = :hv_baid
		 for update ;


// balance
        if(ind_balance<0)
                v_balance = 0;
        PutField_Double(hVal,"balance",v_balance);
DEBUGLOG(("GetBalanceForUpdate balance = [%f]\n",v_balance));


DEBUGLOG(("GetBalanceForUpdate Normal Exit\n"));
        return iRet;

get_bal_update_error:
DEBUGLOG(("get_bal_update error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLBAIDBal_Get: SP_ERR\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

