/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/10/03              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "ClientSettBank.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void ClientSettBank(char    cdebug)
{
        cDebug = cdebug;
}


int GetClientSettBank(int iClientSettBankId, hash_t* hRec)
{
	int	iRet = PD_NOT_FOUND;
	
	EXEC SQL WHENEVER SQLERROR GOTO getclientsettbank_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                       
        EXEC SQL BEGIN DECLARE SECTION;

		int		hv_client_sett_bank_id;
	
		varchar		v_bank_ac_name[PD_BENEFICIARY_BANK_AC_NAME_LEN+1];
		varchar		v_bank_ac_num[PD_BENEFICIARY_BANK_AC_NUM_LEN+1];
		varchar		v_bank_name[PD_BENEFICIARY_BANK_NAME_LEN+1];
		varchar		v_address[PD_COMPANY_ADDR_LEN+1];
		varchar		v_swift_code[PD_COMPANY_SWIFT_CODE_LEN+1];
		varchar		v_iban[PD_COMPANY_IBAN_LEN+1];
		varchar		v_bank_ac_ccy[PD_CCY_ID_LEN+1];

		short		ind_bank_ac_name = -1;
		short		ind_bank_ac_num = -1;
		short		ind_bank_name = -1;
		short		ind_address = -1;
		short		ind_swift_code = -1;
		short		ind_iban = -1;
		short		ind_bank_ac_ccy = -1;

	EXEC SQL END DECLARE SECTION;

// client_sett_bank_id
	hv_client_sett_bank_id = iClientSettBankId;
DEBUGLOG(("GetClientSettBank: client_sett_bank_id = [%d]\n",hv_client_sett_bank_id));

	EXEC SQL DECLARE c_cursor_getclientsettbank CURSOR FOR
                select
			bank_ac_name,
			bank_ac_nmb,
			bank_name,
			address,
			swift_code,
			iban,
			currency_id
		from	client_sett_bank
		where	client_sett_bank_id = :hv_client_sett_bank_id;

	EXEC SQL OPEN c_cursor_getclientsettbank;
        do {
                EXEC SQL FETCH c_cursor_getclientsettbank
                INTO	:v_bank_ac_name:ind_bank_ac_name,
			:v_bank_ac_num:ind_bank_ac_num,
			:v_bank_name:ind_bank_name,
			:v_address:ind_address,
			:v_swift_code:ind_swift_code,
			:v_iban:ind_iban,
			:v_bank_ac_ccy:ind_bank_ac_ccy;

		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

DEBUGLOG(("GetClientSettBank: found record\n"));

/* bank_ac_name */
                if (ind_bank_ac_name >= 0) {
                        v_bank_ac_name.arr[v_bank_ac_name.len] = '\0';
                        PutField_CString(hRec,"bank_ac_name",(const char*)v_bank_ac_name.arr);
DEBUGLOG(("GetClientSettBank: bank_ac_name = [%s]\n",v_bank_ac_name.arr));
                }

/* bank_ac_num */
                if (ind_bank_ac_num >= 0) {
                        v_bank_ac_num.arr[v_bank_ac_num.len] = '\0';
                        PutField_CString(hRec,"bank_ac_num",(const char*)v_bank_ac_num.arr);
DEBUGLOG(("GetClientSettBank: bank_ac_num = [%s]\n",v_bank_ac_num.arr));
                }

/* bank_name */
                if (ind_bank_name >= 0) {
                        v_bank_name.arr[v_bank_name.len] = '\0';
                        PutField_CString(hRec,"bank_name",(const char*)v_bank_name.arr);
DEBUGLOG(("GetClientSettBank: bank_name = [%s]\n",v_bank_name.arr));
                }

/* address */
                if (ind_address >= 0) {
                        v_address.arr[v_address.len] = '\0';
                        PutField_CString(hRec,"address",(const char*)v_address.arr);
DEBUGLOG(("GetClientSettBank: address = [%s]\n",v_address.arr));
                }

/* swift_code */
                if (ind_swift_code >= 0) {
                        v_swift_code.arr[v_swift_code.len] = '\0';
                        PutField_CString(hRec,"swift_code",(const char*)v_swift_code.arr);
DEBUGLOG(("GetClientSettBank: swift_code = [%s]\n",v_swift_code.arr));
                }

/* iban */
                if (ind_iban >= 0) {
                        v_iban.arr[v_iban.len] = '\0';
                        PutField_CString(hRec,"iban",(const char*)v_iban.arr);
DEBUGLOG(("GetClientSettBank: iban = [%s]\n",v_iban.arr));
                }

/* bank_ac_ccy */
                if (ind_bank_ac_ccy >= 0) {
                        v_bank_ac_ccy.arr[v_bank_ac_ccy.len] = '\0';
                        PutField_CString(hRec,"bank_ac_ccy",(const char*)v_bank_ac_ccy.arr);
DEBUGLOG(("GetClientSettBank: bank_ac_ccy = [%s]\n",v_bank_ac_ccy.arr));
                }

		iRet = PD_FOUND;
	}
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getclientsettbank;

DEBUGLOG(("GetClientSettBank: Normal Exit, iRet = [%d]\n", iRet));
       	return  iRet;

getclientsettbank_error:
DEBUGLOG(("getclientsettbank_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("ClientSettBank_Get: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getclientsettbank;
        return PD_ERR;
}

