/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/01/04              LokMan Chow
Get ID Detail					   2012/01/09		   Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "RuleSchedulerHeader.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;
void RuleSchedulerHeader(char    cdebug)
{
        cDebug = cdebug;
}


int GetIdDetail(int iId, recordset_t* myRec)
{
	hash_t *myHash;
	int	iRet = PD_NOT_FOUND;
	EXEC SQL WHENEVER SQLERROR GOTO getiddetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;	

	EXEC SQL BEGIN DECLARE SECTION;
		int	hv_id;
		
		char	v_schedule_mode;
		varchar	v_start_datetime[PD_DATETIME_LEN + 1];
		varchar	v_end_datetime[PD_DATETIME_LEN + 1];
		varchar	v_start_time[PD_TIME_LEN +1];
		varchar	v_end_time[PD_TIME_LEN +1];
		int	v_day;

		short	ind_schedule_mode = -1;
		short	ind_start_datetime = -1;
		short	ind_end_datetime = -1;
		short	ind_start_time = -1;
		short	ind_end_time = -1;
		short	ind_day = -1;

		

	EXEC SQL END DECLARE SECTION;

	hv_id = iId;
DEBUGLOG(("GetIdDetail id = [%d]\n",iId));

	EXEC SQL DECLARE c_cursor_getiddetail CURSOR FOR
		 SELECT rs_schedule_mode,
                        ro_start_datetime,
                        ro_end_datetime,
                        rt_start_time,
                        rt_end_time,
                        rt_day
 		  FROM (SELECT *
           		  FROM  rule_scheduler_header 
          		 WHERE rowid = 
           			(SELECT rowid
                    		   FROM rule_scheduler_header
                          	  WHERE rs_disabled = 0
                            	    AND rs_scheduler_id = :hv_id
                          	    AND rs_effect_datetime  <= sysdate) )
                  LEFT join rule_schedule_once
                     ON rs_scheduler_id = ro_scheduler_id
                    AND ro_disabled = 0
                  LEFT join rule_schedule_recur
                     ON rs_scheduler_id = rr_scheduler_id
                    AND rr_disabled = 0
                  LEFT join rule_recur_type
                     ON rr_recurring_id = rt_id
                    AND rt_disabled = 0;

	EXEC SQL OPEN c_cursor_getiddetail;
        do {
		EXEC SQL FETCH c_cursor_getiddetail 
		INTO
			:v_schedule_mode:ind_schedule_mode,
			:v_start_datetime:ind_start_datetime,
			:v_end_datetime:ind_end_datetime,
			:v_start_time:ind_start_time,
			:v_end_time:ind_end_time,
			:v_day:ind_day;


		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}
		iRet = PD_FOUND;

		myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/* schedule_mode */
		if (ind_schedule_mode >= 0) {
DEBUGLOG(("GetIdDetail schedule_mode = [%c]\n",v_schedule_mode));
			PutField_Char(myHash,"schedule_mode",v_schedule_mode);
		}		

/* start_datetime */
		if (ind_start_datetime >= 0) {
			v_start_datetime.arr[v_start_datetime.len] = '\0';
DEBUGLOG(("GetIdDetail start_datetime = [%s]\n",v_start_datetime.arr));
			PutField_CString(myHash,"start_datetime",(char*)v_start_datetime.arr);
		}		
/* end_datetime */
		if (ind_end_datetime >= 0) {
			v_end_datetime.arr[v_end_datetime.len] = '\0';
DEBUGLOG(("GetIdDetail end_datetime = [%s]\n",v_end_datetime.arr));
			PutField_CString(myHash,"end_datetime",(char*)v_end_datetime.arr);
		}		

/* start_time */
                if (ind_start_time >= 0) {
                        v_start_time.arr[v_start_time.len] = '\0';
DEBUGLOG(("GetIdDetail start_time = [%s]\n",v_start_time.arr));
                        PutField_CString(myHash,"start_time",(char*)v_start_time.arr);
                }
/* end_time */
                if (ind_end_time >= 0) {
                        v_end_time.arr[v_end_time.len] = '\0';
DEBUGLOG(("GetIdDetail end_time = [%s]\n",v_end_time.arr));
                        PutField_CString(myHash,"end_time",(char*)v_end_time.arr);
                }
/* day */
		if (ind_day >= 0) {
DEBUGLOG(("GetIdDetail day = [%d]\n",v_day));
			PutField_Int(myHash,"day",v_day);
		}


		RecordSet_Add(myRec,myHash);

	} 
	while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_getiddetail;
	return PD_FOUND;
getiddetail_error:
DEBUGLOG(("getiddetail code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getiddetail;
        return PD_NOT_FOUND;
}
