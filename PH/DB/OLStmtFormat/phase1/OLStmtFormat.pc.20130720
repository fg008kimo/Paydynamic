/*
Partnerdelight (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/07/17              Stan Poon
Handle effect datetime                             2013/07/19              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "OLStmtFormat.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char cDebug;

void OLStmtFormat(char cdebug)
{
	cDebug = cdebug;
}


int GetFormat(const char* csIntBankCode, const char* csStmtDatetime, recordset_t* myRec)
{
	int iCnt = 0;
	hash_t *myHash;

	EXEC SQL WHENEVER SQLERROR GOTO getformat_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar hv_stmt_datetime[PD_DATETIME_LEN];
		varchar v_id[PD_FORMAT_ID_LEN + 1];
		varchar v_type[PD_FORMAT_TYPE_LEN + 1];
		varchar v_value[PD_FORMAT_VALUE_LEN + 1];
		varchar v_desc[PD_FORMAT_DESC_LEN + 1];
		varchar v_template[PD_FORMAT_TEMPLATE_LEN + 1];
		int v_next_level;

		short ind_id = -1;
		short ind_type = -1;
		short ind_value = -1;
		short ind_desc = -1;
		short ind_template = -1;
		short ind_next_level = -1;
	EXEC SQL END DECLARE SECTION;

	hv_int_bank_code.len = strlen(csIntBankCode);
	memcpy(hv_int_bank_code.arr, csIntBankCode, hv_int_bank_code.len);
DEBUGLOG(("GetFormat int_bank_code = [%.*s]\n", hv_int_bank_code.len, hv_int_bank_code.arr));

	hv_stmt_datetime.len = strlen(csStmtDatetime);
	memcpy(hv_stmt_datetime.arr, csStmtDatetime, hv_stmt_datetime.len);
DEBUGLOG(("GetFormat stmt_datetime = [%.*s]\n", hv_stmt_datetime.len, hv_stmt_datetime.arr));

	EXEC SQL DECLARE c_cursor_getformat CURSOR FOR
		SELECT	OLFT_FORMAT_ID,
			OLFT_FORMAT_TYPE,
			OLFT_FORMAT_VALUE,
			OLFT_FORMAT_DESC,
			OLFT_FORMAT_TEMPLATE,
			OLFT_NEXT_LEVEL
		FROM	OL_STMT_FORMAT_TEMPLATE
		WHERE	OLFT_FORMAT_ID = (
				SELECT	OLSF_FORMAT_ID
				FROM	OL_STMT_FORMAT
				WHERE	OLSF_INT_BANK_CODE = :hv_int_bank_code
				AND	OLSF_EFFECT_DATETIME = (
						SELECT	MAX(OLSF_EFFECT_DATETIME)
						FROM	OL_STMT_FORMAT
						WHERE	OLSF_INT_BANK_CODE = :hv_int_bank_code
						AND	OLSF_EFFECT_DATETIME <= TO_DATE(:hv_stmt_datetime,'yyyymmddhh24miss')));

	EXEC SQL OPEN c_cursor_getformat;
	for (;;) {
		EXEC SQL FETCH c_cursor_getformat
		INTO	:v_id:ind_id,
			:v_type:ind_type,
			:v_value:ind_value,
			:v_desc:ind_desc,
			:v_template:ind_template,
			:v_next_level:ind_next_level;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		iCnt++;

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash,0);

/* id */
		if (ind_id >= 0) {
			v_id.arr[v_id.len] = '\0';
			PutField_CString(myHash, "id", (const char *)v_id.arr);
DEBUGLOG(("GetFormat id = [%s]\n", v_id.arr));
		}

/* type */
		if (ind_type >= 0) {
			v_type.arr[v_type.len] = '\0';
			PutField_CString(myHash, "type", (const char *)v_type.arr);
DEBUGLOG(("GetFormat type = [%s]\n", v_type.arr));
		}

/* value */
		if (ind_value >= 0) {
			v_value.arr[v_value.len] = '\0';
			PutField_CString(myHash, "value", (const char *)v_value.arr);
DEBUGLOG(("GetFormat value = [%s]\n", v_value.arr));
		}

/* desc */
		if (ind_desc >= 0) {
			v_desc.arr[v_desc.len] = '\0';
			PutField_CString(myHash, "desc", (const char *)v_desc.arr);
DEBUGLOG(("GetFormat desc = [%s]\n", v_desc.arr));
		}

/* template */
		if (ind_template >= 0) {
			v_template.arr[v_template.len] = '\0';
			PutField_CString(myHash, "template", (const char *)v_template.arr);
DEBUGLOG(("GetFormat template = [%s]\n", v_template.arr));
		}

/* next_level */
		if (ind_next_level >= 0) {
			PutField_Int(myHash, "next_level", v_next_level);
DEBUGLOG(("GetFormat next_level = [%d]\n", v_next_level));
		}

		RecordSet_Add(myRec, myHash);
	}
	EXEC SQL CLOSE c_cursor_getformat;

	if (iCnt > 0 ) {
DEBUGLOG(("GetFormat Normal Exit!\n"));
		return PD_OK;
	} else {
DEBUGLOG(("GetFormat not found!\n"));
ERRLOG("OLStmtFormat GetFormat not found!\n");
		return PD_ERR;
	}

getformat_error:
DEBUGLOG(("getformat_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLStmtFormat getformat_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL CLOSE c_cursor_getformat;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}
