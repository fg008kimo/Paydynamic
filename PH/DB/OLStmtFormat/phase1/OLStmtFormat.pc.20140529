/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/07/17              Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "OLStmtFormat.h"
#include "internal.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

#define PD_DEFAULT_DATE_FORMAT          "%Y%m%d"
#define PD_DEFAULT_TIME_FORMAT          "%H%M%S"

char cDebug;

void OLStmtFormat(char cdebug)
{
	cDebug = cdebug;
}


int GetFormat(const char* csIntBankCode, recordset_t* myRec)
{
	int iRet = PD_OK;
	int iCnt = 0, iValue = 0;

	char csFormatId[PD_FORMAT_ID_LEN + 1];
	char csCurrFormatId[PD_FORMAT_ID_LEN + 1];

	char csFormatType[PD_FORMAT_TYPE_LEN + 1];
	char csFormatValue[PD_FORMAT_VALUE_LEN + 1];

	char *csTmp;
	char *csTag = (char*) malloc (64);

	hash_t *myHash;
	myHash = (hash_t*) malloc (sizeof(hash_t));
	hash_init(myHash, 0);

	EXEC SQL WHENEVER SQLERROR GOTO getformat_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_int_bank_code[PD_BANK_CODE_LEN + 1];
		varchar	v_format_id[PD_FORMAT_ID_LEN + 1];
		varchar	v_format_type[PD_FORMAT_TYPE_LEN + 1];
		int	v_format_value;
		varchar	v_cont_desc[PD_CONT_DESC_LEN + 1];
		varchar	v_cont_desc_2[PD_CONT_DESC_LEN + 1];
		varchar	v_cont_template[PD_CONT_TEMPLATE_LEN + 1];
		int	v_cont_next_lvl;

		short ind_int_bank_code = -1;
		short ind_format_id = -1;
		short ind_format_type = -1;
		short ind_format_value = -1;
		short ind_cont_desc = -1;
		short ind_cont_desc_2 = -1;
		short ind_cont_template = -1;
		short ind_cont_next_lvl = -1;
	EXEC SQL END DECLARE SECTION;

	hv_int_bank_code.len = strlen(csIntBankCode);
	strncpy((char*)hv_int_bank_code.arr, csIntBankCode, hv_int_bank_code.len);
	ind_int_bank_code = 0;
DEBUGLOG(("GetFormat int_bank_code = [%.*s]\n", hv_int_bank_code.len, hv_int_bank_code.arr));

	EXEC SQL DECLARE getformatcursor CURSOR FOR
		SELECT	OLFT_FORMAT_ID,
			lower(OLFT_FORMAT_TYPE) OLFT_FORMAT_TYPE,
			OLFT_FORMAT_VALUE,
			OLFT_CONT_DESC,
			OLFT_CONT_DESC_2,
			OLFT_CONT_TEMPLATE,
			OLFT_CONT_NEXT_LVL
		FROM	OL_STMT_FORMAT_TEMPLATE, OL_STMT_FORMAT
		WHERE	OLSF_INT_BANK_CODE = :hv_int_bank_code:ind_int_bank_code
		AND	(OLFT_FORMAT_ID = OLSF_FORMAT_ID or OLFT_FORMAT_ID like OLSF_FORMAT_ID||'.%')
		AND	OLSF_DISABLED = 0
		AND	OLSF_EFFECT_TIMESTAMP <= sysdate
		ORDER BY OLFT_FORMAT_ID ASC, OLFT_FORMAT_TYPE ASC, OLFT_FORMAT_VALUE ASC;

	EXEC SQL OPEN getformatcursor;
	for (;;) {
		EXEC SQL FETCH getformatcursor
		INTO	:v_format_id:ind_format_id,
			:v_format_type:ind_format_type,
			:v_format_value:ind_format_value,
			:v_cont_desc:ind_cont_desc,
			:v_cont_desc_2:ind_cont_desc_2,
			:v_cont_template:ind_cont_template,
			:v_cont_next_lvl:ind_cont_next_lvl;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		iCnt++;

/* format_id */
		if (ind_format_id >= 0) {
			v_format_id.arr[v_format_id.len] = '\0';
			strcpy(csCurrFormatId, (const char*)v_format_id.arr);
			if (iCnt == 1) {
				strcpy(csFormatId, (const char*)v_format_id.arr);
				PutField_CString(myHash, "format_id", csFormatId); //
DEBUGLOG(("GetFormat read (%s) = [%s]\n", "format_id", csFormatId));
			} else {
				csTmp = mystrtok(csCurrFormatId, ".");
				if (csTmp != NULL && strcmp(csTmp, csFormatId)) {
					RecordSet_Add(myRec, myHash);
DEBUGLOG(("GetFormat hash added - (%s) = [%s]\n", "format_id", csFormatId));
					myHash = (hash_t*) malloc (sizeof(hash_t));
					hash_init(myHash, 0);
					strcpy(csFormatId, (const char*)v_format_id.arr);
					PutField_CString(myHash, "format_id", csFormatId); //
DEBUGLOG(("GetFormat read (%s) = [%s]\n", "format_id", csFormatId));
				}
				strcpy(csCurrFormatId, (const char*)v_format_id.arr);
			}
		}

		iValue = 0;
		strcpy(csFormatValue,"");

/* format_type */
		if (ind_format_type >= 0) {
			v_format_type.arr[v_format_type.len] = '\0';
			sprintf(csFormatType, "%s", (char*)v_format_type.arr);
		}

/* format_value - DELIMITER */
		if (ind_format_value >= 0) {
			sprintf(csFormatValue,"%d",v_format_value);

			if (!strcmp(csFormatType,"delimiter")) {
				sprintf(csTag, "%s_%s", csFormatType, csCurrFormatId);
				PutField_CString(myHash, csTag, csFormatValue); //
DEBUGLOG(("GetFormat (%s) = [%s]\n", csTag, csFormatValue));
				iValue = 1;
			}
		}

/* cont_desc - CONTENT */
		if (ind_cont_desc >= 0) { 
			v_cont_desc.arr[v_cont_desc.len] = '\0';
			sprintf(csTag, "%s_desc_%s_%s", csFormatType, csCurrFormatId, csFormatValue);
			PutField_CString(myHash, csTag, (const char *)v_cont_desc.arr); //
DEBUGLOG(("GetFormat (%s) = [%s]\n", csTag, v_cont_desc.arr));
			iValue = 1;
		}

/* cont_desc_2 - CONTENT */
		if (ind_cont_desc_2 >= 0) { 
			v_cont_desc_2.arr[v_cont_desc_2.len] = '\0';
			sprintf(csTag, "%s_desc_2_%s_%s", csFormatType, csCurrFormatId, csFormatValue);
			PutField_CString(myHash, csTag, (const char *)v_cont_desc_2.arr); //
DEBUGLOG(("GetFormat (%s) = [%s]\n", csTag, v_cont_desc_2.arr));
			iValue = 1;
		}

/* cont_template - CONTENT */
		if (ind_cont_template >= 0) {
			v_cont_template.arr[v_cont_template.len] = '\0';
			sprintf(csTag, "%s_temp_%s_%s", csFormatType, csCurrFormatId, csFormatValue);
			PutField_CString(myHash, csTag, (const char *)v_cont_template.arr); //
DEBUGLOG(("GetFormat (%s) = [%s]\n", csTag, v_cont_template.arr));
			iValue = 1;
		} else {
			if (ind_cont_desc >= 0) {
				sprintf(csTag, "%s_temp_%s_%s", csFormatType, csCurrFormatId, csFormatValue);
				if (!strcmp((char*)v_cont_desc.arr,"statement_date")) {
					PutField_CString(myHash, csTag, PD_DEFAULT_DATE_FORMAT); //
DEBUGLOG(("GetFormat (%s) default = [%s]\n", csTag, PD_DEFAULT_DATE_FORMAT));
					iValue = 1;
				} else if (!strcmp((char*)v_cont_desc.arr,"statement_time")) {
					PutField_CString(myHash, csTag, PD_DEFAULT_TIME_FORMAT); //
DEBUGLOG(("GetFormat (%s) default = [%s]\n", csTag, PD_DEFAULT_TIME_FORMAT));
					iValue = 1;
				}
			}
		}

/* cont_next_lvl - CONTENT */
		if (ind_cont_next_lvl >= 0) {
			if (v_cont_next_lvl == 1) {
				sprintf(csTag, "%s_nxlv_%s_%s", csFormatType, csCurrFormatId, csFormatValue);
				PutField_Int(myHash, csTag, v_cont_next_lvl); //
DEBUGLOG(("GetFormat (%s) = [%d]\n", csTag, v_cont_next_lvl));
			}
		}

/* format_value - ELSE */
		if (ind_format_value >= 0) {
			if (iValue == 0) {
				PutField_CString(myHash, csFormatType, csFormatValue); //
DEBUGLOG(("GetFormat (%s) = [%s]\n", csFormatType, csFormatValue));
			}
		}

	}
	EXEC SQL CLOSE getformatcursor;

	if (iCnt > 0) {
		RecordSet_Add(myRec, myHash);
DEBUGLOG(("GetFormat hash added - (format_id) = [%s]\n", csFormatId));
		iRet = PD_OK;
	} else {
DEBUGLOG(("GetFormat NOT FOUND!!!\n"));
ERRLOG("OLStmtFormat::GetFormat NOT FOUND!!!\n");
		iRet = PD_ERR;
	}

	free(csTag);

DEBUGLOG(("GetFormat Normal Exit! iRet = [%d]\n", iRet));
	return iRet;

getformat_error:
DEBUGLOG(("getformat_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLStmtFormat getformat_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL CLOSE getformatcursor;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}


int GetTxnCodeKeywords(const char* csIntBankCode, const char* csFormatID, const char* csBankAcctType,
		recordset_t* myRec)
{
	int iRet = PD_FOUND;
	int iCnt = 0;

	hash_t *myHash;

	EXEC SQL WHENEVER SQLERROR GOTO gettxncode_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_format_id[PD_FORMAT_ID_LEN];
		varchar	hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar	hv_bank_acct_type[PD_ACCT_TYPE_LEN];
		varchar	v_txn_code[PD_TXN_CODE_LEN + 1];
		varchar	v_amt_type[PD_AMT_TYPE_LEN + 1];
		int	v_full_match;
		int	v_hold_credit_side;
		int	v_real_time_post;
		int	v_default;
		int	v_min_amt;
		int	v_max_amt;
		int	v_unique_amt;
		varchar	v_cont_desc[PD_CONT_DESC_LEN + 1];
		varchar	v_format_template[PD_FORMAT_TEMPLATE_LEN + 1];

		short	ind_format_id = -1;
		short	ind_int_bank_code = -1;
		short	ind_bank_acct_type = -1;
		short	ind_txn_code = -1;
		short	ind_amt_type = -1;
		short	ind_full_match = -1;
		short	ind_hold_credit_side = -1;
		short	ind_real_time_post = -1;
		short	ind_default = -1;
		short	ind_min_amt = -1;
		short	ind_max_amt = -1;
		short	ind_unique_amt = -1;
		short	ind_cont_desc = -1;
		short	ind_format_template = -1;
	EXEC SQL END DECLARE SECTION;

	hv_format_id.len = strlen(csFormatID);
	strncpy((char*)hv_format_id.arr, csFormatID, hv_format_id.len);
	ind_format_id = 0;
DEBUGLOG(("GetTxnCodeKeywords format_format_id = [%.*s]\n", hv_format_id.len, hv_format_id.arr));

	hv_int_bank_code.len = strlen(csIntBankCode);
	strncpy((char*)hv_int_bank_code.arr, csIntBankCode, hv_int_bank_code.len);
	ind_int_bank_code = 0;
DEBUGLOG(("GetTxnCodeKeywords int_bank_code = [%.*s]\n", hv_int_bank_code.len, hv_int_bank_code.arr));

	hv_bank_acct_type.len = strlen(csBankAcctType);
	strncpy((char*)hv_bank_acct_type.arr, csBankAcctType, hv_bank_acct_type.len);
	ind_bank_acct_type = 0;
DEBUGLOG(("GetTxnCodeKeywords bank_acct_type = [%.*s]\n", hv_bank_acct_type.len, hv_bank_acct_type.arr));

	EXEC SQL DECLARE gettxncodecursor CURSOR FOR
		SELECT	OBTC_CODE,
			OBTC_AMT_TYPE,
			OBTM_FULL_MATCH,
			OBTM_HOLD_CREDIT_SIDE,
			OBTM_REAL_TIME_POST,
			OBTM_DEFAULT,
			OBTM_MIN_AMT,
			OBTM_MAX_AMT,
			OBTM_UNIQUE_AMT,
			TP.OLFT_CONT_DESC,
			TK.OLFK_FORMAT_TEMPLATE
		FROM	OL_BAID_TXN_CODE,
			OL_BAID_TXN_CODE_MAPPING
			LEFT JOIN OL_STMT_FORMAT_KEYWORDS TK
			ON	OBTM_CODE = TK.OLFK_FORMAT_TXN_CODE
			AND	TK.OLFK_INT_BANK_CODE = :hv_int_bank_code:ind_int_bank_code
			AND	TK.OLFK_FORMAT_TYPE = 'TXN_CODE'
			AND	TK.OLFK_DISABLED = 0
			LEFT JOIN OL_STMT_FORMAT_TEMPLATE TP
			ON	TK.OLFK_FORMAT_COL_NAME = TP.OLFT_CONT_COL_NAME
			AND	TP.OLFT_FORMAT_ID LIKE :hv_format_id:ind_format_id || '%'
			AND	TP.OLFT_FORMAT_TYPE = 'CONTENT'
		WHERE	OBTM_CODE = OBTC_CODE
		AND	OBTM_BANK_ACCT_TYPE = :hv_bank_acct_type:ind_bank_acct_type
		AND	(OBTM_DEFAULT = 1 OR TK.OLFK_FORMAT_TEMPLATE IS NOT NULL)
		ORDER BY OBTC_AMT_TYPE ASC, OBTM_DEFAULT ASC, OBTM_PRIORITY DESC, TK.OLFK_DISPLAY_ORDER ASC;

	EXEC SQL OPEN gettxncodecursor;
	for (;;) {
		EXEC SQL FETCH gettxncodecursor
		INTO	:v_txn_code:ind_txn_code,
			:v_amt_type:ind_amt_type,
			:v_full_match:ind_full_match,
			:v_hold_credit_side:ind_hold_credit_side,
			:v_real_time_post:ind_real_time_post,
			:v_default:ind_default,
			:v_min_amt:ind_min_amt,
			:v_max_amt:ind_max_amt,
			:v_unique_amt:ind_unique_amt,
			:v_cont_desc:ind_cont_desc,
			:v_format_template:ind_format_template;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		iCnt++;

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash, 0);

/* txn_code */
		if (ind_txn_code >= 0) {
			v_txn_code.arr[v_txn_code.len] = '\0';
			PutField_CString(myHash, "txn_code", (char*)v_txn_code.arr);
DEBUGLOG(("GetTxnCodeKeywords txn_code = [%s]\n",v_txn_code.arr));
		} else {
			iRet = INT_FORMAT_KEYWORDS_ERROR;
		}
/* amt_type */
		if (ind_amt_type >= 0) {
			v_amt_type.arr[v_amt_type.len] = '\0';
			PutField_CString(myHash, "amt_type", (char*)v_amt_type.arr);
DEBUGLOG(("GetTxnCodeKeywords amt_type = [%s]\n",v_amt_type.arr));
		} else {
			iRet = INT_FORMAT_KEYWORDS_ERROR;
		}
/* full_match */
		if (ind_full_match >= 0) {
			PutField_Int(myHash, "full_match", v_full_match);
DEBUGLOG(("GetTxnCodeKeywords full_match = [%d]\n",v_full_match));
		} else {
			iRet = INT_FORMAT_KEYWORDS_ERROR;
		}
/* hold_credit_side */
		if (ind_hold_credit_side >= 0) {
			PutField_Int(myHash, "hold_credit_side", v_hold_credit_side);
DEBUGLOG(("GetTxnCodeKeywords hold_credit_side = [%d]\n",v_hold_credit_side));
		} else {
			iRet = INT_FORMAT_KEYWORDS_ERROR;
		}
/* real_time_post */
		if (ind_real_time_post >= 0) {
			PutField_Int(myHash, "real_time_post", v_real_time_post);
DEBUGLOG(("GetTxnCodeKeywords real_time_post = [%d]\n",v_real_time_post));
		} else {
			iRet = INT_FORMAT_KEYWORDS_ERROR;
		}
/* default */
		if (ind_default >= 0) {
			PutField_Int(myHash, "default", v_default);
DEBUGLOG(("GetTxnCodeKeywords default = [%d]\n",v_default));

/* cont_desc format_template */
			if (v_default == 0) {
				if (ind_cont_desc >= 0) {
					v_cont_desc.arr[v_cont_desc.len] = '\0';
					PutField_CString(myHash, "cont_desc", (char*)v_cont_desc.arr);
DEBUGLOG(("GetTxnCodeKeywords cont_desc = [%s]\n",v_cont_desc.arr));
				} else {
					iRet = INT_FORMAT_KEYWORDS_ERROR;
				}
				if (ind_format_template >= 0) {
					v_format_template.arr[v_format_template.len] = '\0';
					PutField_CString(myHash, "format_template", (char*)v_format_template.arr);
DEBUGLOG(("GetTxnCodeKeywords format_template = [%s]\n",v_format_template.arr));
				} else {
					iRet = INT_FORMAT_KEYWORDS_ERROR;
				}
			} else {

			}
		} else {
			iRet = INT_FORMAT_KEYWORDS_ERROR;
		}
/* min_amt */
		if (ind_min_amt >= 0) {
			PutField_Int(myHash, "min_amt", v_min_amt);
DEBUGLOG(("GetTxnCodeKeywords min_amt = [%d]\n",v_min_amt));
		} else {
			iRet = INT_FORMAT_KEYWORDS_ERROR;
		}
/* max_amt */
		if (ind_max_amt >= 0) {
			PutField_Int(myHash, "max_amt", v_max_amt);
DEBUGLOG(("GetTxnCodeKeywords max_amt = [%d]\n",v_max_amt));
		} else {
			iRet = INT_FORMAT_KEYWORDS_ERROR;
		}
/* unique_amt */
		if (ind_unique_amt >= 0) {
			PutField_Int(myHash, "unique_amt", v_unique_amt);
DEBUGLOG(("GetTxnCodeKeywords unique_amt = [%d]\n",v_unique_amt));
		} else {
			iRet = INT_FORMAT_KEYWORDS_ERROR;
		}

		RecordSet_Add(myRec,myHash);
	}
	EXEC SQL CLOSE gettxncodecursor;

	if (iCnt > 0) {
		iRet = PD_FOUND;
DEBUGLOG(("GetTxnCodeKeywords FOUND\n"));
	} else {
		iRet = PD_NOT_FOUND;
DEBUGLOG(("GetTxnCodeKeywords NOT FOUND!!!\n"));
	}

DEBUGLOG(("GetTxnCodeKeywords Normal Exit! iRet = [%d]\n", iRet));
	return iRet;

gettxncode_error:
DEBUGLOG(("gettxncode_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLStmtFormat gettxncode_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL CLOSE gettxncodecursor;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}


/*
int GetRestrictKeywords(const char* csIntBankCode, const char* csFormatID,
		recordset_t* myRec)
{
	int iRet = PD_FOUND;
	int iCnt = 0;

	hash_t *myHash;

	EXEC SQL WHENEVER SQLERROR GOTO getrestrict_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_format_id[PD_FORMAT_ID_LEN];
		varchar	hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar	v_cont_desc[PD_CONT_DESC_LEN + 1];
		varchar	v_format_template[PD_FORMAT_TEMPLATE_LEN + 1];

		short	ind_format_id = -1;
		short	ind_int_bank_code = -1;
		short	ind_cont_desc = -1;
		short	ind_format_template = -1;
	EXEC SQL END DECLARE SECTION;

	hv_format_id.len = strlen(csFormatID);
	strncpy((char*)hv_format_id.arr, csFormatID, hv_format_id.len);
	ind_format_id = 0;
DEBUGLOG(("GetRestrictKeywords format_format_id = [%.*s]\n", hv_format_id.len, hv_format_id.arr));

	hv_int_bank_code.len = strlen(csIntBankCode);
	strncpy((char*)hv_int_bank_code.arr, csIntBankCode, hv_int_bank_code.len);
	ind_int_bank_code = 0;
DEBUGLOG(("GetRestrictKeywords int_bank_code = [%.*s]\n", hv_int_bank_code.len, hv_int_bank_code.arr));

	EXEC SQL DECLARE getrestrictcursor CURSOR FOR
		SELECT	TP.OLFT_CONT_DESC,
			OLFK_FORMAT_TEMPLATE
		FROM	OL_STMT_FORMAT_TEMPLATE TP,
			OL_STMT_FORMAT_KEYWORDS TK
		WHERE	TP.OLFT_FORMAT_ID LIKE :hv_format_id:ind_format_id || '%'
		AND	TP.OLFT_FORMAT_TYPE = 'CONTENT'
		AND	TP.OLFT_CONT_COL_NAME = TK.OLFK_FORMAT_COL_NAME
		AND	TK.OLFK_INT_BANK_CODE = :hv_int_bank_code:ind_int_bank_code
		AND	TK.OLFK_FORMAT_TYPE = 'RESTRICT';

	EXEC SQL OPEN getrestrictcursor;
	for (;;) {
		EXEC SQL FETCH getrestrictcursor
		INTO	:v_cont_desc:ind_cont_desc,
			:v_format_template:ind_format_template;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		iCnt++;

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash, 0);

// cont_desc
		if (ind_cont_desc >= 0) {
			v_cont_desc.arr[v_cont_desc.len] = '\0';
			PutField_CString(myHash, "cont_desc", (char*)v_cont_desc.arr);
DEBUGLOG(("GetRestrictKeywords cont_desc = [%s]\n",v_cont_desc.arr));
		} else {
			iRet = INT_FORMAT_KEYWORDS_ERROR;
		}

// format_template
		if (ind_format_template >= 0) {
			v_format_template.arr[v_format_template.len] = '\0';
			PutField_CString(myHash, "format_template", (char*)v_format_template.arr);
DEBUGLOG(("GetRestrictKeywords format_template = [%s]\n",v_format_template.arr));
		} else {
			iRet = INT_FORMAT_KEYWORDS_ERROR;
		}

		RecordSet_Add(myRec,myHash);

	}
	EXEC SQL CLOSE getrestrictcursor;

	if (iCnt > 0) {
		iRet = PD_FOUND;
DEBUGLOG(("GetRestrictKeywords FOUND\n"));
	} else {
		iRet = PD_NOT_FOUND;
DEBUGLOG(("GetRestrictKeywords NOT FOUND!!!\n"));
	}

DEBUGLOG(("GetRestrictKeywords Normal Exit! iRet = [%d]\n", iRet));
	return iRet;

getrestrict_error:
DEBUGLOG(("getrestrict_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLStmtFormat getrestrict_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL CLOSE getrestrictcursor;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}
*/


int AddKeywords(const hash_t *hRls)
{
	char	*csTmp;
	int	iTmp;

        EXEC SQL WHENEVER SQLERROR GOTO addkeywords_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_int_bank_code[PD_FORMAT_ID_LEN];
		varchar		hv_format_type[PD_FORMAT_TYPE_LEN];
		int		hv_format_value;
		varchar		hv_format_txn_code[PD_TXN_CODE_LEN];
		varchar		hv_format_template[PD_FORMAT_TEMPLATE_LEN];
		varchar		hv_format_col_name[PD_COL_NAME_LEN];
		int		hv_display_order;
		int		hv_disabled;
		varchar		hv_user[PD_USER_LEN];

		short		ind_int_bank_code = -1;
		short		ind_format_type = -1;
		short		ind_format_value = -1;
		short		ind_format_txn_code = -1;
		short		ind_format_template = -1;
		short		ind_format_col_name = -1;
		short		ind_display_order = -1;
		short		ind_disabled = -1;
		short		ind_user = -1;

		short		hv_return_value;

        EXEC SQL END DECLARE SECTION;

// int_bank_code
	if (GetField_CString(hRls,"int_bank_code",&csTmp)) {
		hv_int_bank_code.len = strlen(csTmp);
		strncpy((char*)hv_int_bank_code.arr, csTmp, hv_int_bank_code.len);
		ind_int_bank_code = 0;
DEBUGLOG(("AddKeywords:int_bank_code = [%.*s]\n",hv_int_bank_code.len,hv_int_bank_code.arr));
	} else {
DEBUGLOG(("AddKeywords:int_bank_code NOT FOUND!!!\n"));
	}

// format_type
	if (GetField_CString(hRls,"format_type",&csTmp)) {
		hv_format_type.len = strlen(csTmp);
		strncpy((char*)hv_format_type.arr, csTmp, hv_format_type.len);
		ind_format_type = 0;
DEBUGLOG(("AddKeywords:format_type = [%.*s]\n",hv_format_type.len,hv_format_type.arr));
	} else {
DEBUGLOG(("AddKeywords:format_type NOT FOUND!!!\n"));
	}

// format_value
	if (GetField_Int(hRls,"format_value",&iTmp)) {
		hv_format_value = iTmp;
		ind_format_value = 0;
DEBUGLOG(("AddKeywords:format_value = [%d]\n",hv_format_value));
	}

// format_txn_code
	if (GetField_CString(hRls,"format_txn_code",&csTmp)) {
		hv_format_txn_code.len = strlen(csTmp);
		strncpy((char*)hv_format_txn_code.arr, csTmp, hv_format_txn_code.len);
		ind_format_txn_code = 0;
DEBUGLOG(("AddKeywords:format_txn_code = [%.*s]\n",hv_format_txn_code.len,hv_format_txn_code.arr));
	} else {
DEBUGLOG(("AddKeywords:format_txn_code NOT FOUND!!!\n"));
	}

// format_template
	if (GetField_CString(hRls,"format_template",&csTmp)) {
		hv_format_template.len = strlen(csTmp);
		strncpy((char*)hv_format_template.arr, csTmp, hv_format_template.len);
		ind_format_template = 0;
DEBUGLOG(("AddKeywords:format_template = [%.*s]\n",hv_format_template.len,hv_format_template.arr));
	} else {
DEBUGLOG(("AddKeywords:format_template NOT FOUND!!!\n"));
	}

// format_col_name
	if (GetField_CString(hRls,"format_col_name",&csTmp)) {
		hv_format_col_name.len = strlen(csTmp);
		strncpy((char*)hv_format_col_name.arr, csTmp, hv_format_col_name.len);
		ind_format_col_name = 0;
DEBUGLOG(("AddKeywords:format_col_name = [%.*s]\n",hv_format_col_name.len,hv_format_col_name.arr));
	} else {
DEBUGLOG(("AddKeywords:format_col_name NOT FOUND!!!\n"));
	}

// display_order
	if (GetField_Int(hRls,"display_order",&iTmp)) {
		hv_display_order = iTmp;
		ind_display_order = 0;
DEBUGLOG(("AddKeywords:display_order = [%d]\n",hv_display_order));
	}

// disabled
	hv_disabled = 0;
	if (GetField_Int(hRls,"disabled",&iTmp)) {
		hv_disabled = iTmp;
DEBUGLOG(("AddKeywords:disabled = [%d]\n",hv_disabled));
	}
	ind_disabled = 0;

// user
	if (GetField_CString(hRls,"create_user",&csTmp)) {
		hv_user.len = strlen(csTmp);
		strncpy((char*)hv_user.arr, csTmp, hv_user.len);
		ind_user = 0;
DEBUGLOG(("AddKeywords:user = [%.*s]\n",hv_user.len,hv_user.arr));
	} else if (GetField_CString(hRls,"update_user",&csTmp)) {
		hv_user.len = strlen(csTmp);
		strncpy((char*)hv_user.arr, csTmp, hv_user.len);
		ind_user = 0;
DEBUGLOG(("AddKeywords:user = [%.*s]\n",hv_user.len,hv_user.arr));
	} else {
DEBUGLOG(("AddKeywords:user NOT FOUND!!!\n"));
	}

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_stmt_format_insert(
						:hv_int_bank_code:ind_int_bank_code,
						:hv_format_type:ind_format_type,
						:hv_format_value:ind_format_value,
						:hv_format_txn_code:ind_format_txn_code,
						:hv_format_template:ind_format_template,
						:hv_format_col_name:ind_format_col_name,
						:hv_display_order:ind_display_order,
						:hv_disabled:ind_disabled,
						:hv_user:ind_user);
		END;
	END-EXEC;

DEBUGLOG(("AddKeywords:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("AddKeywords:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR) {
ERRLOG("OLStatement_AddKeywords: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("AddKeywords: SP_OTHER_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR) {
ERRLOG("OLStatement_AddKeywords: SP_ERR TxnAbort\n");
DEBUGLOG(("AddKeywords: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

addkeywords_error:
DEBUGLOG(("update_Header_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("OLStatement_AddKeywords: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("AddKeywords: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;
}


/*
int UpdateKeywords(const hash_t *hRls)
{
	char	*csTmp;
	int	iTmp;

	EXEC SQL WHENEVER SQLERROR GOTO updatekeywords_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_int_bank_code[PD_FORMAT_ID_LEN];
		varchar		hv_format_type[PD_FORMAT_TYPE_LEN];
		int		hv_format_value;
		varchar		hv_format_txn_code[PD_TXN_CODE_LEN];
		varchar		hv_format_template[PD_FORMAT_TEMPLATE_LEN];
		varchar		hv_format_col_name[PD_COL_NAME_LEN];
		varchar		hv_user[PD_USER_LEN];

		short		ind_int_bank_code = -1;
		short		ind_format_type = -1;
		short		ind_format_value = -1;
		short		ind_format_txn_code = -1;
		short		ind_format_template = -1;
		short		ind_format_col_name = -1;
		short		ind_user = -1;

		short		hv_return_value;

	EXEC SQL END DECLARE SECTION;

// int_bank_code
	if (GetField_CString(hRls,"int_bank_code",&csTmp)) {
		hv_int_bank_code.len = strlen(csTmp);
		strncpy((char*)hv_int_bank_code.arr, csTmp, hv_int_bank_code.len);
		ind_int_bank_code = 0;
DEBUGLOG(("UpdateKeywords:int_bank_code = [%.*s]\n",hv_int_bank_code.len,hv_int_bank_code.arr));
	} else {
DEBUGLOG(("UpdateKeywords:int_bank_code NOT FOUND!!!\n"));
	}

// format_type
	if (GetField_CString(hRls,"format_type",&csTmp)) {
		hv_format_type.len = strlen(csTmp);
		strncpy((char*)hv_format_type.arr, csTmp, hv_format_type.len);
		ind_format_type = 0;
DEBUGLOG(("UpdateKeywords:format_type = [%.*s]\n",hv_format_type.len,hv_format_type.arr));
	} else {
DEBUGLOG(("UpdateKeywords:format_type NOT FOUND!!!\n"));
	}

// format_value
	if (GetField_Int(hRls,"format_value",&iTmp)) {
		hv_format_value = iTmp;
		ind_format_value = 0;
DEBUGLOG(("UpdateKeywords:format_value = [%d]\n",hv_format_value));
	} else {
DEBUGLOG(("UpdateKeywords:format_value NOT FOUND!!!\n"));
	}

// format_txn_code
	if (GetField_CString(hRls,"format_txn_code",&csTmp)) {
		hv_format_txn_code.len = strlen(csTmp);
		strncpy((char*)hv_format_txn_code.arr, csTmp, hv_format_txn_code.len);
		ind_format_txn_code = 0;
DEBUGLOG(("UpdateKeywords:format_txn_code = [%.*s]\n",hv_format_txn_code.len,hv_format_txn_code.arr));
	} else {
DEBUGLOG(("UpdateKeywords:format_txn_code NOT FOUND!!!\n"));
	}

// format_template
	if (GetField_CString(hRls,"format_template",&csTmp)) {
		hv_format_template.len = strlen(csTmp);
		strncpy((char*)hv_format_template.arr, csTmp, hv_format_template.len);
		ind_format_template = 0;
DEBUGLOG(("UpdateKeywords:format_template = [%.*s]\n",hv_format_template.len,hv_format_template.arr));
	} else {
DEBUGLOG(("UpdateKeywords:format_template NOT FOUND!!!\n"));
	}

// format_col_name
	if (GetField_CString(hRls,"format_col_name",&csTmp)) {
		hv_format_col_name.len = strlen(csTmp);
		strncpy((char*)hv_format_col_name.arr, csTmp, hv_format_col_name.len);
		ind_format_col_name = 0;
DEBUGLOG(("UpdateKeywords:format_col_name = [%.*s]\n",hv_format_col_name.len,hv_format_col_name.arr));
	} else {
DEBUGLOG(("UpdateKeywords:format_col_name NOT FOUND!!!\n"));
	}

// user
	if (GetField_CString(hRls,"create_user",&csTmp)) {
		hv_user.len = strlen(csTmp);
		strncpy((char*)hv_user.arr, csTmp, hv_user.len);
		ind_user = 0;
DEBUGLOG(("UpdateKeywords:user = [%.*s]\n",hv_user.len,hv_user.arr));
	} else if (GetField_CString(hRls,"update_user",&csTmp)) {
		hv_user.len = strlen(csTmp);
		strncpy((char*)hv_user.arr, csTmp, hv_user.len);
		ind_user = 0;
DEBUGLOG(("UpdateKeywords:user = [%.*s]\n",hv_user.len,hv_user.arr));
	} else {
DEBUGLOG(("UpdateKeywords:user NOT FOUND!!!\n"));
	}

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_stmt_format_update(
						:hv_int_bank_code:ind_int_bank_code,
						:hv_format_type:ind_format_type,
						:hv_format_value:ind_format_value,
						:hv_format_txn_code:ind_format_txn_code,
						:hv_format_template:ind_format_template,
						:hv_format_col_name:ind_format_col_name,
						:hv_user:ind_user);
		END;
	END-EXEC;

DEBUGLOG(("UpdateKeywords:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdateKeywords:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR) {
ERRLOG("OLStatement_UpdateKeywords: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateKeywords: SP_OTHER_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR) {
ERRLOG("OLStatement_UpdateKeywords: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateKeywords: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

updatekeywords_error:
DEBUGLOG(("update_Header_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("OLStatement_UpdateKeywords: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("UpdateKeywords: SP_INTERNAL_ERR TxnAbort\n"));
	TxnAbort();
	return PD_INTERNAL_ERR;
}
*/

