CREATE OR REPLACE FUNCTION sp_ol_po_api_pregen_get_rec(
  in_action_id		ol_payout_api_pregen_hd.oap_action_id%type,
  out_cursor            out     sys_refcursor)

RETURN NUMBER IS
        iCnt    integer := 0;

BEGIN

   select count(*)
   into iCnt
   from    ol_payout_api_pregen_hd,
           ol_payout_api_pregen_dt,
	   ol_payout_request
   where   oap_action_id = in_action_id
   and     oap_batch_id = oag_batch_id
   and     oag_txn_id = opr_txn_id
   and     (opr_psp_payout_grp = oap_payout_group or opr_psp_payout_grp is NULL) 
   and	   oap_status = 'W'
   and     oap_pregen_ret_code is NULL
   and     oap_gen_ret_code is NULL
   and     oag_psp_id is NULL
   and     oag_bank_code is NULL;

   IF iCnt > 0 THEN
        OPEN out_cursor FOR
	select
            	oag_batch_id,
             	oap_payout_group,
              	oap_pregen_ret_code,
              	oap_gen_ret_code,
              	oag_seq,
             	oag_txn_id,
              	oag_psp_id,
             	oag_bank_code,
             	oag_file_id
      	from    ol_payout_api_pregen_hd,
     	     	ol_payout_api_pregen_dt,
		ol_payout_request
      	where   oap_action_id = in_action_id
       	and     oap_batch_id = oag_batch_id
	and     oag_txn_id = opr_txn_id
   	and     (opr_psp_payout_grp = oap_payout_group or opr_psp_payout_grp is NULL)
	and	oap_status = 'W'
	and     oap_pregen_ret_code is NULL
        and     oap_gen_ret_code is NULL
	and     oag_psp_id is NULL
      	and     oag_bank_code is NULL
       	order by oag_batch_id, oag_seq;

        RETURN 1;
   ELSE
        RETURN 0;
   END IF;

   RETURN 0;

EXCEPTION
   WHEN OTHERS 
   THEN
     RETURN 9;

END sp_ol_po_api_pregen_get_rec;
/
