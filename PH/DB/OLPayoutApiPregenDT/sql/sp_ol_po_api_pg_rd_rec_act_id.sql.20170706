CREATE OR REPLACE FUNCTION sp_ol_po_api_pg_rd_rec_act_id(
  in_action_id			ol_payout_api_pregen_hd.oap_action_id%type,
  in_merchant_id                ol_txn_header.oth_merchant_id%type,
  in_bank_name                  ol_txn_detail.otd_bank_name%type,
  in_status                     ol_payout_request.opr_status%type,
  in_payout_ccy                 ol_payout_request.opr_payout_currency%type,
  in_merch_grp                  ol_payout_request.opr_merchant_payout_grp%type,
  in_psp_grp                    ol_payout_api_pregen_hd.oap_payout_group%type,
  in_psp_id                     ol_psp_detail.opd_psp_id%type,
  out_cursor            out     sys_refcursor)

RETURN NUMBER Is
        iCnt    integer := 0;

Begin
        select count(opr_txn_id)
          into  iCnt
          from  ol_payout_api_pregen_hd,
                ol_payout_api_pregen_dt,
		ol_payout_request,
		ol_txn_header,
		ol_txn_detail
          where oap_action_id = in_action_id
	  and	oag_batch_id = oap_batch_id
	  and   oth_txn_id = otd_txn_id
          and   otd_txn_id = opr_txn_id
	  and   opr_txn_id in oag_txn_id
          and   (otd_bank_name like in_bank_name or in_bank_name is NULL)
          and   (select otd_bank_name from
                   (select '%' || re_bank_name || '%' as bname
                    from rule_payout_exclude,
                         ol_psp_detail
                    where re_psp_client_id = opd_client_id
                    and opd_psp_id = in_psp_id
                    and re_disabled = 0
                   )
                where otd_bank_name like bname) is null
          and   (oth_merchant_id = in_merchant_id or in_merchant_id is NULL)
          and   opr_status = in_status
          and   opr_payout_currency = in_payout_ccy
	  and   (opr_psp_payout_grp = oap_payout_group or oap_payout_group is NULL)
          and   (opr_merchant_payout_grp = in_merch_grp or in_merch_grp is NULL)
          and   oag_psp_id is NULL
          and   oag_bank_code is NULL;


	if iCnt > 0 THEN
                OPEN out_cursor for
                SELECT
                                oag_batch_id,
                                opr_txn_id,
                                opr_payout_amount
                         from 	ol_payout_api_pregen_hd,
				ol_payout_api_pregen_dt,
				ol_payout_request,
				ol_txn_header,
				ol_txn_detail
                         where  oap_action_id = in_action_id
			 and    oag_batch_id = oap_batch_id
			 and    oth_txn_id = otd_txn_id
			 and	otd_txn_id = opr_txn_id
			 and    opr_txn_id in oag_txn_id
			 and 	(otd_bank_name like in_bank_name or in_bank_name is NULL)
                         and    (select otd_bank_name from
                                 (select '%' || re_bank_name || '%' as bname
                                  from rule_payout_exclude,
                                  ol_psp_detail
                                  where re_psp_client_id = opd_client_id
                                  and opd_psp_id = in_psp_id
                                  and re_disabled = 0
                                 )
                                 where otd_bank_name like bname) is null
			 and   (oth_merchant_id = in_merchant_id or in_merchant_id is NULL)
                         and   opr_status = in_status
                         and   opr_payout_currency = in_payout_ccy
			 and   (opr_psp_payout_grp = oap_payout_group or oap_payout_group is NULL)
          		 and   (opr_merchant_payout_grp = in_merch_grp or in_merch_grp is NULL)
          		 and   oag_psp_id is NULL
          		 and   oag_bank_code is NULL
                ORDER BY dbms_random.value;

                return 1;
        end if;

        return 0;

exception
   WHEN OTHERS THEN
     RETURN 0;
END sp_ol_po_api_pg_rd_rec_act_id;
/

