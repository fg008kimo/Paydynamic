/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/11/03              Stan Poon
Update						   2014/11/21		   Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sqlca.h>
#include "common.h"
#include "internal.h"
#include "utilitys.h"
#include "dbutility.h"
#include "EmailSetting.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char	cDebug;

void EmailSetting(char	cdebug)
{
	cDebug = cdebug;
}


int GetNotifyList(const hash_t *hRls, recordset_t *myRec)
{
	int iRet = FOUND;
	int iCnt = 0;
	char cTmp;
	char *csTmp;

	char csTag[PD_TAG_LEN+1];

	hash_t *hRec;
	hRec = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRec, 0);

	EXEC SQL WHENEVER SQLERROR GOTO getnotifylist_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_funct[PD_EML_FUNCT_LEN];
		char		hv_party_type;
		varchar		hv_party_id[PD_EML_PARTY_ID_LEN];
		varchar		v_email[PD_EML_EMAIL_LEN + 1];

		short		ind_funct = -1;
		short		ind_party_type = -1;
		short		ind_party_id = -1;
		short		ind_email = -1;

		short		hv_return_value;
		SQL_CURSOR	c_cursor_getnotifylist;

	EXEC SQL END DECLARE SECTION;

	if (GetField_Char(hRls,"party_type",&cTmp)) {
		hv_party_type = cTmp;
		ind_party_type = 0;
DEBUGLOG(("GetNotifyList party_type = [%c]\n", hv_party_type));
	}

	if (GetField_CString(hRls,"party_id",&csTmp)) {
		hv_party_id.len = strlen(csTmp);
		ind_party_id = 0;
		strncpy((char*)hv_party_id.arr, csTmp, hv_party_id.len);
DEBUGLOG(("GetNotifyList party_id = [%.*s]\n", hv_party_id.len, hv_party_id.arr));
	}

	if (GetField_CString(hRls,"funct",&csTmp)) {
		hv_funct.len = strlen(csTmp);
		ind_funct = 0;
		strncpy((char*)hv_funct.arr, csTmp, hv_funct.len);
DEBUGLOG(("GetNotifyList funct = [%.*s]\n", hv_funct.len, hv_funct.arr));
	}

	EXEC SQL ALLOCATE :c_cursor_getnotifylist;
	EXEC SQL EXECUTE
	BEGIN
		:hv_return_value := sp_email_notify_list_find(	:hv_party_type:ind_party_type,
								:hv_party_id:ind_party_id,
								:hv_funct:ind_funct,
								:c_cursor_getnotifylist);
	END;
	END-EXEC;

	if (hv_return_value > 0) {
		for (;;) {
			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_getnotifylist
			INTO	:v_email:ind_email;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if(ind_email >= 0){
				v_email.arr[v_email.len] = '\0';
DEBUGLOG(("GetNotifyList() email = [%s]\n",v_email.arr));
				sprintf(csTag, "email_to_%d", iCnt);
				PutField_CString(hRec,csTag,(const char *)v_email.arr);
			} else {
				iRet = PD_ERR;
DEBUGLOG(("GetNotifyList() email NOT FOUND!!!\n"));
			}

			iCnt++;

			RecordSet_Add(myRec,hRec);
		}
	}

	EXEC SQL CLOSE :c_cursor_getnotifylist;
	EXEC SQL FREE :c_cursor_getnotifylist;

	if (iCnt > 0){
DEBUGLOG(("GetNotifyList() Found\n"));
	} else{
DEBUGLOG(("GetNotifyList() NOT FOUND\n"));
		iRet = NOT_FOUND;
	}

DEBUGLOG(("GetNotifyList() Normal Exit iRet = [%d]\n",iRet));
	return iRet;

getnotifylist_error:
DEBUGLOG(("getnotifylist_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL CLOSE :c_cursor_getnotifylist;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}

int CheckEmailSettingRecord(hash_t *hRls)
{
        int iRet = NOT_FOUND;

        int iCnt = 0;

	int iTmp = 0;
	char cTmp;
        char *csTmp;

        EXEC SQL WHENEVER SQLERROR GOTO checkemailsetting_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar         hv_funct[PD_EML_FUNCT_LEN];
                varchar         hv_party_id[PD_EML_PARTY_ID_LEN];
                char            hv_party_type;
                int             hv_email_id;

                short           ind_funct = -1;
                short           ind_party_id = -1;
                short           ind_party_type = -1;
                short           ind_email_id = -1;        
	
	EXEC SQL END DECLARE SECTION;

/* funct */
        if (GetField_CString(hRls,"funct",&csTmp)) {
                hv_funct.len = strlen(csTmp);
                ind_funct = 0;
                strncpy((char*)hv_funct.arr, csTmp, hv_funct.len);
DEBUGLOG(("CheckEmailSettingRecord funct = [%.*s]\n", hv_funct.len, hv_funct.arr));
        }

/* party_id */
        if (GetField_CString(hRls,"party_id",&csTmp)) {
                hv_party_id.len = strlen(csTmp);
                ind_party_id = 0;
                strncpy((char*)hv_party_id.arr, csTmp, hv_party_id.len);
DEBUGLOG(("CheckEmailSettingRecord party_id = [%.*s]\n", hv_party_id.len, hv_party_id.arr));
        }

/* party_type */
	if (GetField_Char(hRls,"party_type",&cTmp)) {
		hv_party_type = cTmp;
                ind_party_type = 0;
DEBUGLOG(("CheckEmailSettingRecord party_type = [%c]\n", hv_party_type));
        }

/* email_id */
        if (GetField_Int(hRls,"mail_id",&iTmp)) {
                hv_email_id = iTmp;
                ind_email_id = 0;
DEBUGLOG(("CheckEmailSettingRecord email_id = [%d]\n", hv_email_id));
        }

        EXEC SQL DECLARE c_cursor_checkemailsetting CURSOR FOR
                SELECT  ES_EMAIL_ID
                FROM    EMAIL_SETTING
                WHERE   ES_FUNCT = :hv_funct:ind_funct
		AND	ES_PARTY_ID = :hv_party_id:ind_party_id
		AND	ES_PARTY_TYPE = :hv_party_type:ind_party_type
		AND	ES_EMAIL_ID = :hv_email_id:ind_email_id;

	EXEC SQL OPEN c_cursor_checkemailsetting;
        do {
                EXEC SQL FETCH c_cursor_checkemailsetting
                INTO    :hv_email_id:ind_email_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                if (iCnt >= 1) {
                        break;
                }

                iCnt++;

		if (ind_email_id >= 0) {
                        PutField_Int(hRls,"mail_id",hv_email_id);
DEBUGLOG(("CheckEmailSettingRecord() email_id = [%d]\n",hv_email_id));
                }

        } while (PD_TRUE);
        EXEC SQL CLOSE c_cursor_checkemailsetting;

	if (iCnt > 0 ) {
DEBUGLOG(("CheckEmailSettingRecord() Found!!!\n"));
                iRet = FOUND;
        }

DEBUGLOG(("CheckEmailSettingRecord() Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

checkemailsetting_error:
DEBUGLOG(("checkemailsetting_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("EmailSetting checkemailsetting_error code %d\n", sqlca.sqlcode);
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_checkemailsetting;
        return PD_ERR;
}

int DisableEmailSettingRecord(const hash_t *hRls)
{
        char    *csTmp;
	char	cTmp;

        EXEC SQL WHENEVER SQLERROR GOTO disablerecord_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_funct[PD_EML_FUNCT_LEN];
                varchar         hv_party_id[PD_EML_PARTY_ID_LEN];
		char            hv_party_type;
		varchar		hv_update_user[PD_USER_LEN];

                short           ind_funct = -1;
                short           ind_party_id = -1;
                short           ind_party_type = -1;
                short           ind_update_user = -1;

                short           hv_return_value;

        EXEC SQL END DECLARE SECTION;

/* funct */
        if (GetField_CString(hRls,"funct",&csTmp)) {
                hv_funct.len = strlen(csTmp);
                strncpy((char*)hv_funct.arr,csTmp,sizeof(hv_funct.arr));
                ind_funct = 0;
DEBUGLOG(("DisableEmailSettingRecord: funct = [%.*s](%d)\n",sizeof(hv_funct.arr),hv_funct.arr,hv_funct.len));
        }

/* party_id */
        if (GetField_CString(hRls,"party_id",&csTmp)) {
                hv_party_id.len = strlen(csTmp);
                strncpy((char*)hv_party_id.arr,csTmp,sizeof(hv_party_id.arr));
                ind_party_id = 0;
DEBUGLOG(("DisableEmailSettingRecord: party_id = [%.*s](%d)\n",sizeof(hv_party_id.arr),hv_party_id.arr,hv_party_id.len));
        }

/* party_TYPE */
        if (GetField_Char(hRls, "party_type", &cTmp)) {
                hv_party_type = cTmp;
                ind_party_type = 0;
DEBUGLOG(("DisableEmailSettingRecord: party_type = [%c]\n",hv_party_type));
        }

/* update_user */
        if (GetField_CString(hRls,"update_user",&csTmp)) {
                hv_update_user.len = strlen(csTmp);
                strncpy((char*)hv_update_user.arr,csTmp,sizeof(hv_update_user.arr));
                ind_update_user = 0;
DEBUGLOG(("DisableEmailSettingRecord: update_user = [%.*s](%d)\n",sizeof(hv_update_user.arr),hv_update_user.arr,hv_update_user.len));
        }

EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_email_sett_update(
                                                :hv_funct:ind_funct,
                                                :hv_party_id:ind_party_id,
                                                :hv_party_type:ind_party_type,
                                                :hv_update_user:ind_update_user);
                END;
        END-EXEC;

        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("DisableEmailSettingRecord: Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR) {
ERRLOG("EmailSetting_DisableEmailSettingRecord: SP_OTHER_ERR\n");
DEBUGLOG(("DisableEmailSettingRecord: SP_OTHER_ERR\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR) {
ERRLOG("EmailSetting_DisableEmailSettingRecord: SP_ERR\n");
DEBUGLOG(("DisableEmailSettingRecord: SP_ERR\n"));
                return PD_ERR;
        }

disablerecord_error:
DEBUGLOG(("disablerecord_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
DEBUGLOG(("DisableEmailSettingRecord: SP_INTERNAL_ERR TxnAbort\n"));
ERRLOG("EmailSetting_DisableEmailSettingRecord: SP_INTERNAL_ERR TxnAbort\n");
        TxnAbort();
        return PD_INTERNAL_ERR;
}

int AddOriginal(const hash_t *hRls)
{
        char    *csTmp;
        char    cTmp;
        int     iTmp;

        EXEC SQL WHENEVER SQLERROR GOTO addoriginal_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
	
                int             hv_email_id;
                char            hv_party_type;
                varchar         hv_party_id[PD_EML_PARTY_ID_LEN];
		varchar         hv_funct[PD_EML_FUNCT_LEN];
                int             hv_default;
                int             hv_disabled;	
                varchar         hv_create_user[PD_USER_LEN];
		
                short           ind_email_id = -1;
                short           ind_party_type = -1;
                short           ind_party_id = -1;
		short           ind_funct = -1;
		short           ind_default = -1;
		short           ind_disabled = -1;
                short           ind_create_user = -1;

                short           hv_return_value;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("AddOriginal: Begin\n"));

	if(GetField_Int(hRls, "mail_id", &iTmp)) {
                hv_email_id = iTmp;
                ind_email_id = 0;
DEBUGLOG(("AddOriginal: email_id = [%d]\n",hv_email_id));
        }

	if(GetField_Char(hRls, "party_type", &cTmp)) {
                hv_party_type = cTmp;
                ind_party_type = 0;
DEBUGLOG(("AddOriginal: party_type = [%c]\n",hv_party_type));
        }

        if(GetField_CString(hRls,"party_id",&csTmp)) {
                hv_party_id.len = strlen(csTmp);
                strncpy((char*)hv_party_id.arr, csTmp, hv_party_id.len);
                ind_party_id = 0;
        }
DEBUGLOG(("AddOriginal: party_id = [%.*s]\n",hv_party_id.len, hv_party_id.arr));

        if(GetField_CString(hRls,"funct",&csTmp)) {
                hv_funct.len = strlen(csTmp);
                strncpy((char*)hv_funct.arr, csTmp, hv_funct.len);
                ind_funct = 0;
DEBUGLOG(("AddOriginal: funct = [%.*s]\n",hv_funct.len, hv_funct.arr));
        }

	if(GetField_Int(hRls, "default", &iTmp)) {
                hv_default = iTmp;
                ind_default = 0;
DEBUGLOG(("AddOriginal: default = [%d]\n",hv_default));
        }

        if(GetField_Int(hRls, "disabled", &iTmp)) {
                hv_disabled = iTmp;
                ind_disabled = 0;
DEBUGLOG(("AddOriginal: disabled = [%d]\n",hv_disabled));
        }

        if(GetField_CString(hRls,"create_user",&csTmp)) {
                hv_create_user.len = strlen(csTmp);
                strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
        } else if(GetField_CString(hRls,"update_user",&csTmp)) {
                hv_create_user.len = strlen(csTmp);
                strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
        }
DEBUGLOG(("AddOriginal: create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));

	EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_email_sett_insert(
                                                :hv_email_id:ind_email_id,
                                                :hv_party_type:ind_party_type,
                                                :hv_party_id:ind_party_id,
                                                :hv_funct:ind_funct,
                                                :hv_default:ind_default,
                                                :hv_disabled:ind_disabled,
                                                :hv_create_user:ind_create_user);
                END;
        END-EXEC;	

DEBUGLOG(("AddOriginal:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("AddOriginal:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("EmailSetting_AddOriginal: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("AddOriginal: SP_OTHER_ERR TxnAbort\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("EmailSetting_AddOriginal: SP_ERR TxnAbort\n");
DEBUGLOG(("AddOriginal: SP_ERR TxnAbort\n"));
                return PD_ERR;
        }

addoriginal_error:
DEBUGLOG(("addoriginal_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("EmailSetting_AddOriginal: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int Add(const hash_t *hRls)
{
        char    *csTmp;
        char    cTmp;
        int     iTmp;

        EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
	
                int             hv_email_id;
                char            hv_party_type;
                varchar         hv_party_id[PD_EML_PARTY_ID_LEN];
		varchar         hv_funct[PD_EML_FUNCT_LEN];
                int             hv_default;
                int             hv_disabled;	
		int             hv_log_seq;
                varchar         hv_create_user[PD_USER_LEN];
		
                short           ind_email_id = -1;
                short           ind_party_type = -1;
                short           ind_party_id = -1;
		short           ind_funct = -1;
		short           ind_default = -1;
		short           ind_disabled = -1;
		short           ind_log_seq = -1;
                short           ind_create_user = -1;

                short           hv_return_value;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));

	if(GetField_Int(hRls, "mail_id", &iTmp)) {
                hv_email_id = iTmp;
                ind_email_id = 0;
DEBUGLOG(("Add: email_id = [%d]\n",hv_email_id));
        }

	if(GetField_Char(hRls, "party_type", &cTmp)) {
                hv_party_type = cTmp;
                ind_party_type = 0;
DEBUGLOG(("Add: party_type = [%c]\n",hv_party_type));
        }

        if(GetField_CString(hRls,"party_id",&csTmp)) {
                hv_party_id.len = strlen(csTmp);
                strncpy((char*)hv_party_id.arr, csTmp, hv_party_id.len);
                ind_party_id = 0;
        }
DEBUGLOG(("Add: party_id = [%.*s]\n",hv_party_id.len, hv_party_id.arr));

        if(GetField_CString(hRls,"funct",&csTmp)) {
                hv_funct.len = strlen(csTmp);
                strncpy((char*)hv_funct.arr, csTmp, hv_funct.len);
                ind_funct = 0;
DEBUGLOG(("Add: funct = [%.*s]\n",hv_funct.len, hv_funct.arr));
        }

	if(GetField_Int(hRls, "default", &iTmp)) {
                hv_default = iTmp;
                ind_default = 0;
DEBUGLOG(("Add: default = [%d]\n",hv_default));
        }

        if(GetField_Int(hRls, "disabled", &iTmp)) {
                hv_disabled = iTmp;
                ind_disabled = 0;
DEBUGLOG(("Add: disabled = [%d]\n",hv_disabled));
        }

        if(GetField_CString(hRls,"create_user",&csTmp)) {
                hv_create_user.len = strlen(csTmp);
                strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
        } else if(GetField_CString(hRls,"update_user",&csTmp)) {
                hv_create_user.len = strlen(csTmp);
                strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
        }
DEBUGLOG(("Add: create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));

	EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_email_sett_insert(
                                                :hv_email_id:ind_email_id,
                                                :hv_party_type:ind_party_type,
                                                :hv_party_id:ind_party_id,
                                                :hv_funct:ind_funct,
                                                :hv_default:ind_default,
                                                :hv_disabled:ind_disabled,
                                                :hv_create_user:ind_create_user);
                END;
        END-EXEC;	

DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("Add:Normal Exit\n"));
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("EmailSetting_Add: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("EmailSetting_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
                return PD_ERR;
        }

/* add history */

/* log_seq */
        if(GetField_Int(hRls, "log_seq", &iTmp)) {
                hv_log_seq = iTmp;
                ind_log_seq = 0;
DEBUGLOG(("Add Email Setting History: log_seq = [%d]\n",hv_log_seq));
        }

        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_email_sett_hist_insert(
                                :hv_party_type:ind_party_type,
                                :hv_party_id:ind_party_id,
                                :hv_funct:ind_funct,
                                :hv_email_id:ind_email_id,
                                :hv_log_seq:ind_log_seq);
                END;
        END-EXEC;

        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("Add Email Setting History: Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)
        {
DEBUGLOG(("Add Email Setting History: SP_OTHER_ERR\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)
        {
DEBUGLOG(("Add Email Setting History: SP_ERR\n"));
                return PD_ERR;
        }

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("EmailSetting_Add: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("EmailSetting:Add: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR TxnAbort\n"));
        return PD_INTERNAL_ERR;
}

int Update(const hash_t *hRls)
{
        char    *csBuf;
        char   	*csTmp;
        char    cTmp;
        int     iTmp;

        EXEC SQL WHENEVER SQLERROR GOTO update_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                varchar		hv_dynstmt[1024];

                varchar 	hv_funct[PD_EML_FUNCT_LEN];
                varchar 	hv_party_id[PD_EML_PARTY_ID_LEN];
		char		hv_party_type;
                int 		hv_email_id;

		int		hv_log_seq;

                short 		ind_funct = -1;
                short 		ind_party_id = -1;
                short 		ind_party_type = -1;
                short 		ind_email_id = -1;

                short 		ind_log_seq = -1;

                short 		hv_return_value;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
        csBuf = (char *)malloc(128);
	
	strcpy((char*)hv_dynstmt.arr,"update email_setting set es_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

/* default */
        if (GetField_Int(hRls,"default",&iTmp)) {
DEBUGLOG(("Update: update_default = [%d]\n",iTmp));
                sprintf(csBuf,"%d",iTmp);
                strcat((char*)hv_dynstmt.arr, ",es_default = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* disabled */
        if (GetField_Int(hRls,"disabled",&iTmp)) {
DEBUGLOG(("Update: update_disabled = [%d]\n",iTmp));
                sprintf(csBuf,"%d",iTmp);
                strcat((char*)hv_dynstmt.arr, ",es_disabled = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* update_user */
        if (GetField_CString(hRls,"update_user",&csTmp)) {
DEBUGLOG(("Update: update_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",es_update_user = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* Primary Key: email_id */
        if (GetField_Int(hRls, "mail_id", &iTmp)) {
DEBUGLOG(("Update: email_id = [%d]\n", iTmp));
                sprintf(csBuf, "%d", iTmp);
                strcat((char*)hv_dynstmt.arr, " WHERE es_email_id = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

                hv_email_id = iTmp;
                ind_email_id = 0;
        }

/* Primary Key: party_type */
        if (GetField_Char(hRls, "party_type", &cTmp)) {
DEBUGLOG(("Update: party_type = [%c]\n", cTmp));
                sprintf(csBuf, "%c", cTmp);
                strcat((char*)hv_dynstmt.arr, " AND es_party_type = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

		hv_party_type = cTmp;
                ind_party_type = 0;
        }

/* Primary Key: party_id */
        if (GetField_CString(hRls,"party_id",&csTmp)) {
DEBUGLOG(("Update: party_id = [%s]\n", csTmp));
                strcat((char*)hv_dynstmt.arr, " AND es_party_id = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

                hv_party_id.len = strlen(csTmp);
                strncpy((char*)hv_party_id.arr, csTmp, hv_party_id.len);
                ind_party_id = 0;
        }

/* Primary Key: funct */
        if (GetField_CString(hRls,"funct",&csTmp)) {
DEBUGLOG(("Update: funct = [%s]\n", csTmp));
                strcat((char*)hv_dynstmt.arr, " AND es_funct = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

                hv_funct.len = strlen(csTmp);
                strncpy((char*)hv_funct.arr, csTmp, hv_funct.len);
                ind_funct = 0;
        }

DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

        FREE_ME(csBuf);

/* update history */

/* log_seq */
	if(GetField_Int(hRls, "log_seq", &iTmp)) {
                hv_log_seq = iTmp;
                ind_log_seq = 0;
DEBUGLOG(("Update Email Setting History: log_seq = [%d]\n",hv_log_seq));
        }

        EXEC SQL EXECUTE
                BEGIN
			:hv_return_value := sp_email_sett_hist_insert(
                         	:hv_party_type:ind_party_type,
                            	:hv_party_id:ind_party_id,
                             	:hv_funct:ind_funct,
				:hv_email_id:ind_email_id,
				:hv_log_seq:ind_log_seq);
                END;
        END-EXEC;

        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("Update Email Setting History: Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)
        {
DEBUGLOG(("Update Email Setting History: SP_OTHER_ERR\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)
        {
DEBUGLOG(("Update Email Setting History: SP_ERR\n"));
                return PD_ERR;
        }

DEBUGLOG(("Update Normal Exit\n"));
        return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("EmailSetting:Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
        return PD_INTERNAL_ERR;
}

