/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/07/04              Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "OLBankAccts.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char	cDebug;

void OLBankAccts(char	cdebug)
{
	cDebug = cdebug;
}


int GetAcctCcy(const char* csIntBankCode,
			const char* csBankAcctNum,
			char* csAcctCcy)
{
        int iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO getacctccy_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar	hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar	hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		varchar	v_acct_ccy[PD_CCY_ID_LEN + 1];

		short	ind_int_bank_code = -1;
		short	ind_bank_acct_num = -1;
		short	ind_acct_ccy = -1;

        EXEC SQL END DECLARE SECTION;

	hv_int_bank_code.len = strlen(csIntBankCode);
	strncpy((char*)hv_int_bank_code.arr,csIntBankCode,hv_int_bank_code.len);
	ind_int_bank_code = 0;
DEBUGLOG(("GetAcctCcy int_bank_code = [%.*s]\n",hv_int_bank_code.len,hv_int_bank_code.arr));

	hv_bank_acct_num.len = strlen(csBankAcctNum);
	strncpy((char*)hv_bank_acct_num.arr,csBankAcctNum,hv_bank_acct_num.len);
	ind_bank_acct_num = 0;
DEBUGLOG(("GetAcctCcy bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));

	EXEC SQL	SELECT	OB_ACCT_CCY
			INTO	v_acct_ccy:ind_acct_ccy
			FROM	OL_BANK_ACCTS,
				PSP_MASTER
			WHERE	OB_INT_BANK_CODE = :hv_int_bank_code:ind_int_bank_code
			AND	OB_BANK_ACCT_NUM = :hv_bank_acct_num:ind_bank_acct_num
			AND	OB_ACCT_TYPE = 'DSI'
			AND	(OB_STATUS_TYPE = 'A'
				OR (OB_STATUS_TYPE = 'F' and OB_UPDATE_TIMESTAMP >= sysdate-14))
			AND	PM_CLIENT_ID = OB_PROVIDER_ID
			AND	PM_STATUS = 'O';

	if (ind_acct_ccy>=0) {
		v_acct_ccy.arr[v_acct_ccy.len] = '\0';
		strcpy(csAcctCcy,(char*)v_acct_ccy.arr);
DEBUGLOG(("GetAcctCcy acct_ccy = [%s]\n",csAcctCcy));
	} else {
		iRet = PD_NOT_FOUND;
DEBUGLOG(("GetAcctCcy acct_ccy NOT FOUND!!!\n"));
	}

DEBUGLOG(("GetAcctCcy: Ret = [%d]\n",iRet));
	return iRet;

getacctccy_error:
DEBUGLOG(("getacctccy_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int Add(const	hash_t *hOLBankAcct) 
{
	char    *csTmp;
	int     iTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar		hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		varchar		hv_bank_acct_name[PD_NAME_LEN];
		varchar		hv_bank_acct_short_name[PD_BANK_ACCT_SHORT_NAME_LEN];
		varchar		hv_acct_ccy[PD_CCY_ID_LEN];
		varchar		hv_acct_type[PD_ACCT_TYPE_LEN];
		int		hv_shared_acct;
		varchar		hv_received_datetime[PD_DATETIME_LEN];
		varchar		hv_received_by[PD_USER_LEN];
		int		hv_support_sms_stmt;
		varchar		hv_registered_mobile[PD_CUSTOMER_TEL_LEN];
		varchar		hv_status_type[PD_ACCOUNT_STATUS_LEN];
		varchar		hv_provider_id[PD_CLIENT_ID_LEN];
		varchar		hv_owner_id[PD_OWNER_ID_LEN];
		varchar		hv_owner_name[PD_NAME_LEN];
		varchar		hv_branch_code[PD_BRANCH_CODE_LEN];
		varchar		hv_branch_name[PD_BANK_BRANCH_LEN];
		varchar		hv_swift_code[PD_SWIFT_CODE_LEN];
		varchar		hv_remark[PD_REMARK_LEN];
		varchar         hv_create_user[PD_USER_LEN];

		short		ind_int_bank_code = -1;
		short		ind_bank_acct_num = -1;
		short		ind_bank_acct_name = -1;
		short		ind_bank_acct_short_name = -1;
		short		ind_acct_ccy = -1;
		short		ind_acct_type = -1;
		short		ind_shared_acct = -1;
		short		ind_received_datetime = -1;
		short		ind_received_by = -1;
		short		ind_support_sms_stmt = -1;
		short		ind_registered_mobile = -1;
		short		ind_status_type = -1;
		short		ind_provider_id = -1;
		short		ind_owner_id = -1;
		short		ind_owner_name = -1;
		short		ind_branch_code = -1;
		short		ind_branch_name = -1;
		short		ind_swift_code = -1;
		short		ind_remark = -1;
                short           ind_create_user = -1;

                short           hv_return_value;

	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));

        if(GetField_CString(hOLBankAcct,"bank_code",&csTmp))
        {
                hv_int_bank_code.len = strlen(csTmp);
                strncpy((char *)hv_int_bank_code.arr, csTmp, hv_int_bank_code.len);
                ind_int_bank_code = 0;
DEBUGLOG(("Add:int_bank_code = [%.*s]\n",hv_int_bank_code.len,hv_int_bank_code.arr));
        }

        if(GetField_CString(hOLBankAcct,"new_acct_num",&csTmp))
        {
                hv_bank_acct_num.len = strlen(csTmp);
                strncpy((char *)hv_bank_acct_num.arr, csTmp, hv_bank_acct_num.len);
                ind_bank_acct_num = 0;
DEBUGLOG(("Add:bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));
        }

        if(GetField_CString(hOLBankAcct,"name",&csTmp))
        {
                hv_bank_acct_name.len = strlen(csTmp);
                strncpy((char *)hv_bank_acct_name.arr, csTmp, hv_bank_acct_name.len);
                ind_bank_acct_name = 0;
DEBUGLOG(("Add:bank_acct_name = [%.*s]\n",hv_bank_acct_name.len,hv_bank_acct_name.arr));
        }

        if(GetField_CString(hOLBankAcct,"short_name",&csTmp))
        {
                hv_bank_acct_short_name.len = strlen(csTmp);
                strncpy((char *)hv_bank_acct_short_name.arr, csTmp, hv_bank_acct_short_name.len);
                ind_bank_acct_short_name = 0;
DEBUGLOG(("Add:bank_acct_short_name = [%.*s]\n",hv_bank_acct_short_name.len,hv_bank_acct_short_name.arr));
        }

        if(GetField_CString(hOLBankAcct,"ccy",&csTmp))
        {
                hv_acct_ccy.len = strlen(csTmp);
                strncpy((char *)hv_acct_ccy.arr, csTmp, hv_acct_ccy.len);
                ind_acct_ccy = 0;
DEBUGLOG(("Add:acct_ccy = [%.*s]\n",hv_acct_ccy.len,hv_acct_ccy.arr));
        }

        if(GetField_CString(hOLBankAcct,"acct_type",&csTmp))
        {
                hv_acct_type.len = strlen(csTmp);
                strncpy((char *)hv_acct_type.arr, csTmp, hv_acct_type.len);
                ind_acct_type = 0;
DEBUGLOG(("Add:acct_type = [%.*s]\n",hv_acct_type.len,hv_acct_type.arr));
        }

        if (GetField_Int(hOLBankAcct,"share", &iTmp))
        {
                hv_shared_acct = iTmp;
                ind_shared_acct = 0;
DEBUGLOG(("Add:shared_acct = [%d]\n",hv_shared_acct));
        }

        if(GetField_CString(hOLBankAcct,"rec_datetime",&csTmp))
        {
                hv_received_datetime.len = strlen(csTmp);
                strncpy((char *)hv_received_datetime.arr, csTmp, hv_received_datetime.len);
                ind_received_datetime = 0;
DEBUGLOG(("Add:received_datetime = [%.*s]\n",hv_received_datetime.len,hv_received_datetime.arr));
        }

        if(GetField_CString(hOLBankAcct,"rec_by",&csTmp))
        {
                hv_received_by.len = strlen(csTmp);
                strncpy((char *)hv_received_by.arr, csTmp, hv_received_by.len);
                ind_received_by = 0;
DEBUGLOG(("Add:received_by = [%.*s]\n",hv_received_by.len,hv_received_by.arr));
        }

	if (GetField_Int(hOLBankAcct, "support_sms_stmt", &iTmp))
	{
		hv_support_sms_stmt = iTmp;
		ind_support_sms_stmt = 0;
DEBUGLOG(("Add: suppprt_sms_stmt = [%d]\n", hv_support_sms_stmt));
	}

	if(GetField_CString(hOLBankAcct,"reg_mob_num",&csTmp))
	{
		hv_registered_mobile.len = strlen(csTmp);
		strncpy((char *)hv_registered_mobile.arr, csTmp, hv_registered_mobile.len);
		ind_registered_mobile = 0;
DEBUGLOG(("Add:registered_mobile = [%.*s]\n",hv_registered_mobile.len,hv_registered_mobile.arr));
	}

        if(GetField_CString(hOLBankAcct,"status_type",&csTmp))
        {
                hv_status_type.len = strlen(csTmp);
                strncpy((char *)hv_status_type.arr, csTmp, hv_status_type.len);
                ind_status_type = 0;
DEBUGLOG(("Add:status_type = [%.*s]\n",hv_status_type.len,hv_status_type.arr));
        }

        if(GetField_CString(hOLBankAcct,"prov_id",&csTmp))
        {
                hv_provider_id.len = strlen(csTmp);
                strncpy((char *)hv_provider_id.arr, csTmp, hv_provider_id.len);
                ind_provider_id = 0;
DEBUGLOG(("Add:provider_id = [%.*s]\n",hv_provider_id.len,hv_provider_id.arr));
        }

        if(GetField_CString(hOLBankAcct,"owner_id",&csTmp))
        {
                hv_owner_id.len = strlen(csTmp);
                strncpy((char *)hv_owner_id.arr, csTmp, hv_owner_id.len);
                ind_owner_id = 0;
DEBUGLOG(("Add:owner_id = [%.*s]\n",hv_owner_id.len,hv_owner_id.arr));
        }

        if(GetField_CString(hOLBankAcct,"owner",&csTmp))
        {
                hv_owner_name.len = strlen(csTmp);
                strncpy((char *)hv_owner_name.arr, csTmp, hv_owner_name.len);
                ind_owner_name = 0;
DEBUGLOG(("Add:owner_name = [%.*s]\n",hv_owner_name.len,hv_owner_name.arr));
        }

        if(GetField_CString(hOLBankAcct,"branch_code",&csTmp))
        {
                hv_branch_code.len = strlen(csTmp);
                strncpy((char *)hv_branch_code.arr, csTmp, hv_branch_code.len);
                ind_branch_code = 0;
DEBUGLOG(("Add:branch_code = [%.*s]\n",hv_branch_code.len,hv_branch_code.arr));
        }

        if(GetField_CString(hOLBankAcct,"branch",&csTmp))
        {
                hv_branch_name.len = strlen(csTmp);
                strncpy((char *)hv_branch_name.arr, csTmp, hv_branch_name.len);
                ind_branch_name = 0;
DEBUGLOG(("Add:branch_name = [%.*s]\n",hv_branch_name.len,hv_branch_name.arr));
        }

        if(GetField_CString(hOLBankAcct,"swift_code",&csTmp))
        {
                hv_swift_code.len = strlen(csTmp);
                strncpy((char *)hv_swift_code.arr, csTmp, hv_swift_code.len);
                ind_swift_code = 0;
DEBUGLOG(("Add:swift_code = [%.*s]\n",hv_swift_code.len,hv_swift_code.arr));
        }

        if(GetField_CString(hOLBankAcct,"remark",&csTmp))
        {
                hv_remark.len = strlen(csTmp);
                strncpy((char *)hv_remark.arr, csTmp, hv_remark.len);
                ind_remark = 0;
DEBUGLOG(("Add:remark = [%.*s]\n",hv_remark.len,hv_remark.arr));
        }

        if(GetField_CString(hOLBankAcct,"create_user",&csTmp))
        {
                hv_create_user.len = strlen(csTmp);
                strncpy((char *)hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));
        }

	EXEC SQL EXECUTE
		BEGIN

		:hv_return_value := sp_ol_bank_acct_insert(
					:hv_int_bank_code:ind_int_bank_code,
					:hv_bank_acct_num:ind_bank_acct_num,
					:hv_bank_acct_name:ind_bank_acct_name,
					:hv_bank_acct_short_name:ind_bank_acct_short_name,
					:hv_acct_ccy:ind_acct_ccy,
					:hv_acct_type:ind_acct_type,
					:hv_shared_acct:ind_shared_acct,
					:hv_received_datetime:ind_received_datetime,
					:hv_received_by:ind_received_by,
					:hv_support_sms_stmt:ind_support_sms_stmt,
					:hv_registered_mobile:ind_registered_mobile,
					:hv_status_type:ind_status_type,
					:hv_provider_id:ind_provider_id,
					:hv_owner_id:ind_owner_id,
					:hv_owner_name:ind_owner_name,
					:hv_branch_code:ind_branch_code,
					:hv_branch_name:ind_branch_name,
					:hv_swift_code:ind_swift_code,
					:hv_remark:ind_remark,
					:hv_create_user:ind_create_user);


		END;
	END-EXEC;

DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
		DEBUGLOG(("Add:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
		ERRLOG("OLBankAccts_Add: SP_OTHER_ERR TxnAbort\n");
		DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
		ERRLOG("OLBankAccts_Add: SP_ERR TxnAbort\n");
		DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLBankAccts_Add: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}


int GetBankAccts(const char *csIntBankCode,
                 const char *csBankAcctNum,
                 hash_t *hRec)
{
	int	iRet = PD_ERR;

	EXEC SQL WHENEVER SQLERROR GOTO getbankaccts_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar		hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];

                varchar         v_bank_acct_name[PD_NAME_LEN + 1];
                varchar         v_bank_acct_short_name[PD_BANK_ACCT_SHORT_NAME_LEN + 1];
                varchar         v_acct_ccy[PD_CCY_ID_LEN + 1];
                varchar         v_acct_type[PD_ACCT_TYPE_LEN + 1];
                int             v_shared_acct;
                varchar         v_received_datetime[PD_DATETIME_LEN + 1];
                varchar         v_received_by[PD_USER_LEN + 1];
		int		v_support_sms_stmt;
                varchar         v_registered_mobile[PD_CUSTOMER_TEL_LEN + 1];
                varchar         v_status_type[PD_ACCOUNT_STATUS_LEN + 1];
                varchar         v_provider_id[PD_CLIENT_ID_LEN + 1];
                varchar         v_owner_id[PD_OWNER_ID_LEN + 1];
                varchar         v_owner_name[PD_NAME_LEN + 1];
                varchar         v_branch_code[PD_BRANCH_CODE_LEN + 1];
                varchar         v_branch_name[PD_BANK_BRANCH_LEN + 1];
                varchar         v_swift_code[PD_SWIFT_CODE_LEN + 1];
                varchar         v_remark[PD_REMARK_LEN + 1];

                short		ind_bank_acct_name = -1;
                short		ind_bank_acct_short_name = -1;
                short		ind_acct_ccy = -1;
                short		ind_acct_type = -1;
                short		ind_shared_acct = -1;
                short		ind_received_datetime = -1;
                short		ind_received_by = -1;
		short		ind_support_sms_stmt = -1;
                short		ind_registered_mobile = -1;
                short		ind_status_type[PD_ACCOUNT_STATUS_LEN + 1];
                short		ind_provider_id[PD_CLIENT_ID_LEN + 1];
                short		ind_owner_id[PD_OWNER_ID_LEN + 1];
                short		ind_owner_name[PD_NAME_LEN + 1];
                short		ind_branch_code[PD_BRANCH_CODE_LEN + 1];
                short		ind_branch_name[PD_BANK_BRANCH_LEN + 1];
                short		ind_swift_code[PD_SWIFT_CODE_LEN + 1];
                short		ind_remark[PD_REMARK_LEN + 1];
	EXEC SQL END DECLARE SECTION;

	hv_int_bank_code.len = strlen(csIntBankCode);
	memcpy(hv_int_bank_code.arr, csIntBankCode, hv_int_bank_code.len);
DEBUGLOG(("GetBankAccts int_bank_code = [%.*s]\n", hv_int_bank_code.len, hv_int_bank_code.arr));

	hv_bank_acct_num.len = strlen(csBankAcctNum);
	memcpy(hv_bank_acct_num.arr, csBankAcctNum, hv_bank_acct_num.len);
DEBUGLOG(("GetBankAccts bank_acct_num = [%.*s]\n", hv_bank_acct_num.len, hv_bank_acct_num.arr));

	EXEC SQL DECLARE c_cursor_getbankaccts CURSOR FOR
		select	ob_bank_acct_name,
			ob_bank_acct_short_name,
			ob_acct_ccy,
			ob_acct_type,
			ob_shared_acct,
			to_char(ob_received_datetime, 'YYYYMMDDHH24MISS'),
			ob_received_by,
			ob_support_sms_stmt,
			ob_registered_mobile,
			ob_status_type,
			ob_provider_id,
			ob_owner_id, 
			ob_owner_name,
			ob_branch_code,
			ob_branch_name,
			ob_swift_code,
			ob_remark
		from	ol_bank_accts
		where	ob_int_bank_code = :hv_int_bank_code
		and	ob_bank_acct_num = :hv_bank_acct_num;

	EXEC SQL OPEN c_cursor_getbankaccts;
        do {
		EXEC SQL FETCH c_cursor_getbankaccts
		INTO 	
			:v_bank_acct_name:ind_bank_acct_name,
                	:v_bank_acct_short_name:ind_bank_acct_short_name,
			:v_acct_ccy:ind_acct_ccy,
                	:v_acct_type:ind_acct_type,
                	:v_shared_acct:ind_shared_acct,
                	:v_received_datetime:ind_received_datetime,
                	:v_received_by:ind_received_by,
			:v_support_sms_stmt:ind_support_sms_stmt,
                	:v_registered_mobile:ind_registered_mobile,
                	:v_status_type:ind_status_type,
                	:v_provider_id:ind_provider_id,
                	:v_owner_id:ind_owner_id,
                	:v_owner_name:ind_owner_name,
	                :v_branch_code:ind_branch_code,
			:v_branch_name:ind_branch_name,
                	:v_swift_code:ind_swift_code,
                	:v_remark:ind_remark;
		

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}
DEBUGLOG(("GetBankAccts found record\n"));

		iRet = PD_OK;
/* Bank Acct Name */
		if (ind_bank_acct_name >= 0) {
			v_bank_acct_name.arr[v_bank_acct_name.len] = '\0';
			PutField_CString(hRec, "bank_acct_name", (const char*)v_bank_acct_name.arr);
DEBUGLOG(("GetBankAccts bank_acct_name = [%s]\n", v_bank_acct_name.arr));
		}

/* Bank Acct Short Name */
		if (ind_bank_acct_short_name >= 0) {
			v_bank_acct_short_name.arr[v_bank_acct_short_name.len] = '\0';
			PutField_CString(hRec, "bank_acct_short_name", (const char*)v_bank_acct_name.arr);
DEBUGLOG(("GetBankAccts bank_acct_short_name = [%s]\n", v_bank_acct_short_name.arr));
		}

/* Acct Ccy */
		if (ind_acct_ccy >= 0) {
			v_acct_ccy.arr[v_acct_ccy.len] = '\0';
			PutField_CString(hRec, "acct_ccy", (const char*)v_acct_ccy.arr);
DEBUGLOG(("GetBankAccts acct_ccy = [%s]\n", v_acct_ccy.arr));
		}

/*  Acct Type */
		if (ind_acct_type >= 0) {
			v_acct_type.arr[v_acct_type.len] = '\0';
			PutField_CString(hRec, "acct_type", (const char*)v_acct_type.arr);
DEBUGLOG(("GetBankAccts acct_type = [%s]\n", v_acct_type.arr));
		}

/* Shared Acct */
		if (ind_shared_acct >= 0) {
                        PutField_Int(hRec,"shared_acct", v_shared_acct);
DEBUGLOG(("GetBankAccts shared_acct = [%d]\n", v_shared_acct));
                }

/* Received DateTime */
		if (ind_received_datetime >= 0) {
			v_received_datetime.arr[v_received_datetime.len] = '\0';
			PutField_CString(hRec, "received_datetime", (const char*)v_received_datetime.arr);
DEBUGLOG(("GetBankAccts received_datetime = [%s]\n", v_received_datetime.arr));
		}

/* Received By */
		if (ind_received_by >= 0) {
			v_received_by.arr[v_received_by.len] = '\0';
			PutField_CString(hRec, "received_by", (const char*)v_received_by.arr);
DEBUGLOG(("GetBankAccts received_by = [%s]\n", v_received_by.arr));
		}

/* Support SMS Stmt */
		if (ind_support_sms_stmt >= 0) {
			PutField_Int(hRec, "support_sms_stmt", v_support_sms_stmt);
DEBUGLOG(("GetBankAccts support_sms_stmt = [%d]\n", v_support_sms_stmt));
		}


/* Registered_mobile */
		if (ind_registered_mobile >= 0) {
			v_registered_mobile.arr[v_registered_mobile.len] = '\0';
			PutField_CString(hRec, "registered_mobile", (const char*)v_registered_mobile.arr);
DEBUGLOG(("GetBankAccts registered_mobile = [%s]\n", v_registered_mobile.arr));
		}

/* Status Type */
		if (ind_status_type >= 0) {
			v_status_type.arr[v_status_type.len] = '\0';
			PutField_CString(hRec, "status_type", (const char*)v_status_type.arr);
DEBUGLOG(("GetBankAccts status_type = [%s]\n", v_status_type.arr));
		}

/* Provider ID */
		if (ind_provider_id >= 0) {
			v_provider_id.arr[v_provider_id.len] = '\0';
			PutField_CString(hRec, "provider_id", (const char*)v_provider_id.arr);
DEBUGLOG(("GetBankAccts provider_id = [%s]\n", v_provider_id.arr));
		}

/* owner ID */
		if (ind_owner_id >= 0) {
			v_owner_id.arr[v_owner_id.len] = '\0';
			PutField_CString(hRec, "owner_id", (const char*)v_owner_id.arr);
DEBUGLOG(("GetBankAccts owner_id = [%s]\n", v_owner_id.arr));
		}
	
/* owner Name */
		if (ind_owner_name >= 0) {
			v_owner_name.arr[v_owner_name.len] = '\0';
			PutField_CString(hRec, "owner_name", (const char*)v_owner_name.arr);
DEBUGLOG(("GetBankAccts owner_name = [%s]\n", v_owner_name.arr));
		}

/* Branch Code */
		if (ind_branch_code >= 0) {
			v_branch_code.arr[v_branch_code.len] = '\0';
			PutField_CString(hRec, "branch_code", (const char*)v_branch_code.arr);
DEBUGLOG(("GetBankAccts branch_code = [%s]\n", v_branch_code.arr));
		}

/* Branch Name */
		if (ind_branch_name >= 0) {
			v_branch_name.arr[v_branch_name.len] = '\0';
			PutField_CString(hRec, "branch_name", (const char*)v_branch_name.arr);
DEBUGLOG(("GetBankAccts branch_name = [%s]\n", v_branch_name.arr));
		}

/* Swift Code */
		if (ind_swift_code >= 0) {
			v_swift_code.arr[v_swift_code.len] = '\0';
			PutField_CString(hRec, "swift_code", (const char*)v_swift_code.arr);
DEBUGLOG(("GetBankAccts swift_code = [%s]\n", v_swift_code.arr));
		}

/* Remark */
		if (ind_remark >= 0) {
			v_remark.arr[v_remark.len] = '\0';
			PutField_CString(hRec, "acct_remark", (const char*)v_remark.arr);
DEBUGLOG(("GetBankAccts remark = [%s]\n", v_remark.arr));
		}


	} while (PD_TRUE);

	EXEC SQL CLOSE c_cursor_getbankaccts;

DEBUGLOG(("GetBankAccts Normal Exit [%d]\n", iRet));
        return  iRet;

getbankaccts_error:
DEBUGLOG(("getbankaccts_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLBankAccts_GetBankAccts: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getbankaccts;
        return PD_ERR;			
}

int Update(const hash_t *hOLBankAcct) {
	char* csTmp;
	char* csBankCode;
	char* csNewAcctNum;

	int   iTmp;

	EXEC SQL WHENEVER SQLERROR GOTO update_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_dynstmt[1024];
	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));

	strcpy((char*)hv_dynstmt.arr, "update ol_bank_accts set ob_update_timestamp = sysdate");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	GetField_CString(hOLBankAcct, "bank_code", &csBankCode);
DEBUGLOG(("Update: bank_code = [%s]\n", csBankCode));

	GetField_CString(hOLBankAcct, "new_acct_num", &csNewAcctNum);
DEBUGLOG(("Update: new_acct_num = [%s]\n", csNewAcctNum));

/* name */
	if (GetField_CString(hOLBankAcct, "name", &csTmp)) {
DEBUGLOG(("Update: name = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", ob_bank_acct_name = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* short name */
	if (GetField_CString(hOLBankAcct, "short_name", &csTmp)) {
DEBUGLOG(("Update: short_name = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", ob_bank_acct_short_name = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* rec datetime */
	if (GetField_CString(hOLBankAcct, "rec_datetime", &csTmp)) {
DEBUGLOG(("Update: rec_datetime = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", ob_received_datetime = to_date('");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "', 'YYYYMMDDHH24MISS')");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* rec by */
	if (GetField_CString(hOLBankAcct, "rec_by", &csTmp)) {
DEBUGLOG(("Update: rec_by = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", ob_received_by = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}
/* support sms stmt */
	if (GetField_Int(hOLBankAcct, "support_sms_stmt", &iTmp)) {
DEBUGLOG(("Update: support_sms_stmt = [%d]\n", iTmp));
		sprintf(csTmp, "%d", iTmp);

		strcat((char*)hv_dynstmt.arr, ", ob_support_sms_stmt = ");
		strcat((char*)hv_dynstmt.arr, csTmp);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* reg mob num */
	if (GetField_CString(hOLBankAcct, "reg_mob_num", &csTmp)) {
DEBUGLOG(("Update: reg_mob_num = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", ob_registered_mobile = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* status type */
	if (GetField_CString(hOLBankAcct, "status_type", &csTmp)) {
DEBUGLOG(("Update: status_type = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", ob_status_type = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* owner id */
	if (GetField_CString(hOLBankAcct, "owner_id", &csTmp)) {
DEBUGLOG(("Update: owner_id = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", ob_owner_id = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}
/* owner */
	if (GetField_CString(hOLBankAcct, "owner", &csTmp)) {
DEBUGLOG(("Update: owner = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", ob_owner_name = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* branch code */
	if (GetField_CString(hOLBankAcct, "branch_code", &csTmp)) {
DEBUGLOG(("Update: branch_code = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", ob_branch_code = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* branch */
	if (GetField_CString(hOLBankAcct, "branch", &csTmp)) {
DEBUGLOG(("Update: branch = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", ob_branch_name = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* swift code */
	if (GetField_CString(hOLBankAcct, "swift_code", &csTmp)) {
DEBUGLOG(("Update: swift_code = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", ob_swift_code = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* remark */
	if (GetField_CString(hOLBankAcct, "remark", &csTmp)) {
DEBUGLOG(("Update: remark = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", ob_remark = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* user */
	if (GetField_CString(hOLBankAcct, "update_user", &csTmp)) {
DEBUGLOG(("Update: user = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", ob_update_user = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	strcat((char*)hv_dynstmt.arr, " WHERE ob_int_bank_code = '");
	strcat((char*)hv_dynstmt.arr, csBankCode);
	strcat((char*)hv_dynstmt.arr, "'");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	strcat((char*)hv_dynstmt.arr, " AND ob_bank_acct_num = '");
	strcat((char*)hv_dynstmt.arr, csNewAcctNum);
	strcat((char*)hv_dynstmt.arr, "'");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n", hv_dynstmt.len, hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

DEBUGLOG(("Update Normal Exit\n"));
	return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
ERRLOG("OLBankAccts_Update: SP_INTERNAL_ERR TxnAbort\n");
	//TxnAbort();
	return PD_INTERNAL_ERR;
}

int ChkBankAcctsUnique(const char *csIntBankCode,
                        const char *csBankAcctNum)
{
	int	iRet = PD_NOT_FOUND;

	EXEC SQL WHENEVER SQLERROR GOTO chkbankacctunique_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar		hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];

		int		v_no_of_record;
		short		ind_no_of_record = -1;
	EXEC SQL END DECLARE SECTION;

	hv_int_bank_code.len = strlen(csIntBankCode);
	memcpy(hv_int_bank_code.arr, csIntBankCode, hv_int_bank_code.len);
DEBUGLOG(("ChkBankAcctsUnique int_bank_code = [%.*s]\n", hv_int_bank_code.len, hv_int_bank_code.arr));

	hv_bank_acct_num.len = strlen(csBankAcctNum);
	memcpy(hv_bank_acct_num.arr, csBankAcctNum, hv_bank_acct_num.len);
DEBUGLOG(("ChkBankAcctsUnique bank_acct_num = [%.*s]\n", hv_bank_acct_num.len, hv_bank_acct_num.arr));

	EXEC SQL
		SELECT count(1)
		INTO :v_no_of_record:ind_no_of_record
		FROM ol_bank_accts
		WHERE ob_int_bank_code = :hv_int_bank_code
		AND ob_bank_acct_num like '%' || substr(:hv_bank_acct_num, -4, 4);

	if (ind_no_of_record >= 0) {
		if (v_no_of_record > 0) {
DEBUGLOG(("ChkBankAcctsUnique FOUND\n"));
			iRet = PD_FOUND;
		}
	}

	if (iRet!= PD_FOUND) {
DEBUGLOG(("ChkBankAcctsUnique NOT FOUND\n"));
	}

        return iRet;

chkbankacctunique_error:
DEBUGLOG(("ChkBankAcctsUnique_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;

	return PD_ERR;
}


int UpdateStatus(const hash_t *hOLBankAcct) 
{
	char	*csBankCode;
	char	*csAcctNum;
	char	*csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO updatestatus_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_dynstmt[1024];
	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("UpdateStatus: Begin\n"));

	strcpy((char*)hv_dynstmt.arr, "update ol_bank_accts set ob_update_timestamp = sysdate");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	GetField_CString(hOLBankAcct, "bank_code", &csBankCode);
DEBUGLOG(("UpdateStatus: bank_code = [%s]\n", csBankCode));

	GetField_CString(hOLBankAcct, "new_acct_num", &csAcctNum);
DEBUGLOG(("UpdateStatus: new_acct_num = [%s]\n", csAcctNum));

/* status type */
	if (GetField_CString(hOLBankAcct, "status_type", &csTmp)) {
DEBUGLOG(("UpdateStatus: status_type = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", ob_status_type = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	strcat((char*)hv_dynstmt.arr, " WHERE ob_int_bank_code = '");
	strcat((char*)hv_dynstmt.arr, csBankCode);
	strcat((char*)hv_dynstmt.arr, "'");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	strcat((char*)hv_dynstmt.arr, " AND ob_bank_acct_num = '");
	strcat((char*)hv_dynstmt.arr, csAcctNum);
	strcat((char*)hv_dynstmt.arr, "'");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n", hv_dynstmt.len, hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

DEBUGLOG(("UpdateStatus Normal Exit\n"));
        return PD_OK;

updatestatus_error:
DEBUGLOG(("updatestatus_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
ERRLOG("OLBankAccts_UpdateStatus: SP_INTERNAL_ERR TxnAbort\n");
        return PD_INTERNAL_ERR;
}


int ChkMobileNumByBank(const char *csIntBankCode,
			const char* csBankAcctNum,
                        const char *csMobileNum)
{
	int     iRet = PD_NOT_FOUND;

	EXEC SQL WHENEVER SQLERROR GOTO chkmobilenumbybank_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar         hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar		hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		varchar         hv_mobile_num[PD_CUSTOMER_TEL_LEN];

                int             v_no_of_record;
                short           ind_no_of_record = -1;
        EXEC SQL END DECLARE SECTION;

	hv_int_bank_code.len = strlen(csIntBankCode);
	memcpy(hv_int_bank_code.arr, csIntBankCode, hv_int_bank_code.len);
DEBUGLOG(("ChkMobileNumByBank int_bank_code = [%.*s]\n", hv_int_bank_code.len, hv_int_bank_code.arr));

	hv_bank_acct_num.len = strlen(csBankAcctNum);
	memcpy(hv_bank_acct_num.arr, csBankAcctNum, hv_bank_acct_num.len);
DEBUGLOG(("ChkMobileNumByBank bank_acct_num = [%.*s]\n", hv_bank_acct_num.len, hv_bank_acct_num.arr));

        hv_mobile_num.len = strlen(csMobileNum);
        memcpy(hv_mobile_num.arr, csMobileNum, hv_mobile_num.len);
DEBUGLOG(("ChkMobileNumByBank mobile_num = [%.*s]\n", hv_mobile_num.len, hv_mobile_num.arr));

        EXEC SQL
                SELECT count(1)
                INTO :v_no_of_record:ind_no_of_record
                FROM ol_bank_accts
                WHERE ob_int_bank_code = :hv_int_bank_code
		AND ob_bank_acct_num !=  :hv_bank_acct_num
                AND ob_registered_mobile = :hv_mobile_num;

        if (ind_no_of_record >= 0) {
                if (v_no_of_record > 0) {
DEBUGLOG(("ChkMobileNumByBank FOUND\n"));
                        iRet = PD_FOUND;
                }
        }

        if (iRet!= PD_FOUND) {
DEBUGLOG(("ChkMobileNumByBank NOT FOUND\n"));
        }

        return iRet;

chkmobilenumbybank_error: 
DEBUGLOG(("ChkMobileNumByBank_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;

        return PD_ERR;

}
