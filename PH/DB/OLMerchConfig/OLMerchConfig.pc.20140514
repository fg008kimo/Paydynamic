/*
Partnerdelight (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/01/21              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLMerchConfig.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char cDebug;

void OLMerchConfig(char cdebug)
{
	cDebug = cdebug;
}


int Add(const hash_t *hConfig)
{
	char *csTmp;
	char iTmp;
	double dTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_currency_id[PD_CCY_ID_LEN];
		varchar		hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		int		hv_match_fifo;
		double		hv_match_fifo_amt_limit;
		double		hv_min_settle_amt;
		int		hv_min_settle_amt_apply_admin;
		varchar		hv_preferred_settle_ccy[PD_CCY_ID_LEN];
		int		hv_disabled;
		varchar		hv_create_user[PD_USER_LEN];

		short		ind_merchant_id = -1;
		short		ind_currency_id = -1;
		short		ind_country_id = -1;
		short		ind_service_code = -1;
		short		ind_match_fifo = -1;
		short		ind_match_fifo_amt_limit = -1;
		short		ind_min_settle_amt = -1;
		short		ind_min_settle_amt_apply_admin = -1;
		short		ind_preferred_settle_ccy = -1;
		short		ind_disabled = -1;
		short		ind_create_user = -1;

		short		hv_return_value;
	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));

	if (GetField_CString(hConfig, "merchant_id", &csTmp))
	{
		hv_merchant_id.len = strlen(csTmp);
		strncpy((char *)hv_merchant_id.arr, csTmp, hv_merchant_id.len);
		ind_merchant_id = 0;
DEBUGLOG(("Add: merchant_id = [%.*s]\n", hv_merchant_id.len, hv_merchant_id.arr));
	}

	if (GetField_CString(hConfig, "currency_id", &csTmp))
	{
		hv_currency_id.len = strlen(csTmp);
		strncpy((char *)hv_currency_id.arr, csTmp, hv_currency_id.len);
		ind_currency_id = 0;
DEBUGLOG(("Add: currency_id = [%.*s]\n", hv_currency_id.len, hv_currency_id.arr));
	}

	if (GetField_CString(hConfig, "country_id", &csTmp))
	{
		hv_country_id.len = strlen(csTmp);
		strncpy((char *)hv_country_id.arr, csTmp, hv_country_id.len);
		ind_country_id = 0;
DEBUGLOG(("Add: country_id = [%.*s]\n", hv_country_id.len, hv_country_id.arr));
	}

	if (GetField_CString(hConfig, "service_code", &csTmp))
	{
		hv_service_code.len = strlen(csTmp);
		strncpy((char *)hv_service_code.arr, csTmp, hv_service_code.len);
		ind_service_code = 0;
DEBUGLOG(("Add: service_code = [%.*s]\n", hv_service_code.len, hv_service_code.arr));
	}

	if (GetField_Int(hConfig, "match_fifo", &iTmp))
	{
		hv_match_fifo = iTmp;
		ind_match_fifo = 0;
DEBUGLOG(("Add: match_fifo = [%d]\n", hv_match_fifo));
	}

	if (GetField_Double(hConfig, "match_fifo_amt_limit", &dTmp))
	{
		hv_match_fifo_amt_limit = dTmp;
		ind_match_fifo_amt_limit = 0;
DEBUGLOG(("Add: match_fifo_amt_limit = [%f]\n", hv_match_fifo_amt_limit));
	}

	if (GetField_Double(hConfig, "min_settle_amt", &dTmp))
	{
		hv_min_settle_amt = dTmp;
		ind_min_settle_amt = 0;
DEBUGLOG(("Add: min_settle_amt = [%f]\n", hv_min_settle_amt));
	}

	if (GetField_Int(hConfig, "min_settle_amt_apply_admin", &iTmp))
	{
		hv_min_settle_amt_apply_admin = iTmp;
		ind_min_settle_amt_apply_admin = 0;
DEBUGLOG(("Add: min_settle_amt_apply_admin = [%d]\n", hv_min_settle_amt_apply_admin));
	}

	if (GetField_CString(hConfig, "preferred_settle_ccy", &csTmp))
	{
		hv_preferred_settle_ccy.len = strlen(csTmp);
		strncpy((char *)hv_preferred_settle_ccy.arr, csTmp, hv_preferred_settle_ccy.len);
		ind_preferred_settle_ccy = 0;
DEBUGLOG(("Add: preferred_settle_ccy = [%.*s]\n", hv_preferred_settle_ccy.len, hv_preferred_settle_ccy.arr));
	}

	if (GetField_Int(hConfig, "disabled", &iTmp))
	{
		hv_disabled = iTmp;
		ind_disabled = 0;
DEBUGLOG(("Add: disabled = [%d]\n", hv_disabled));
	} else {
		hv_disabled = PD_FALSE;
		ind_disabled = 0;
DEBUGLOG(("Add: disabled = [%d]\n", hv_disabled));
	}


	if (GetField_CString(hConfig, "create_user", &csTmp))
	{
		hv_create_user.len = strlen(csTmp);
		strncpy((char *)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
DEBUGLOG(("Add: create_user = [%.*s]\n", hv_create_user.len, hv_create_user.arr));
	}

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_merch_config_insert(
								:hv_merchant_id:ind_merchant_id,
								:hv_currency_id:ind_currency_id,
								:hv_country_id:ind_country_id,
								:hv_service_code:ind_service_code,
								:hv_match_fifo:ind_match_fifo,
								:hv_match_fifo_amt_limit:ind_match_fifo_amt_limit,
								:hv_min_settle_amt:ind_min_settle_amt,
								:hv_min_settle_amt_apply_admin:ind_min_settle_amt_apply_admin,
								:hv_preferred_settle_ccy:ind_preferred_settle_ccy,
								:hv_disabled:ind_disabled,
								:hv_create_user:ind_create_user);
		END;
	END-EXEC;

DEBUGLOG(("Add: Ret = [%d]\n", hv_return_value));

	if (hv_return_value == SP_OK)
	{
		DEBUGLOG(("Add: Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)
	{
		ERRLOG("OLMerchConfig_Add: SP_OTHER_ERR TxnAbort\n");
		DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)
	{
		ERRLOG("OLMerchConfig_Add: SP_ERR TxnAbort\n");
		DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLMerchConfig_Add: SP_INTERNAL_ERR TxnAbort\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}


int Update(const hash_t *hRls)
{
	char *csTmp;
	char *csBuf;
	int iTmp;
	double dTmp;

	char *csMerchantId;
	char *csCurrencyId;
	char *csCountryId;
	char *csServiceCode;

	EXEC SQL WHENEVER SQLERROR GOTO update_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_dynstmt[1024];
	EXEC SQL END DECLARE SECTION;

	csBuf = (char *) malloc (128);

DEBUGLOG(("Update: Begin\n"));

	strcpy((char*)hv_dynstmt.arr, "update ol_merch_config set omc_update_timestamp = sysdate");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	GetField_CString(hRls, "merchant_id", &csMerchantId);
DEBUGLOG(("Update: merchant_id = [%s]\n", csMerchantId));

	GetField_CString(hRls, "currency_id", &csCurrencyId);
DEBUGLOG(("Update: currency_id = [%s]\n", csCurrencyId));

	GetField_CString(hRls, "country_id", &csCountryId);
DEBUGLOG(("Update: country_id = [%s]\n", csCountryId));

	GetField_CString(hRls, "service_code", &csServiceCode);
DEBUGLOG(("Update: service_code = [%s]\n", csServiceCode));

// match_fifo
	if (GetField_Int(hRls, "match_fifo", &iTmp)) {
DEBUGLOG(("Update: match_fifo = [%d]\n", iTmp));
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, ", omc_match_fifo = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// match_fifo_amt_limit
	if (GetField_Double(hRls, "match_fifo_amt_limit", &dTmp)) {
DEBUGLOG(("Update: match_fifo_amt_limit = [%f]\n", dTmp));
		sprintf(csBuf, "%f", dTmp);
		strcat((char*)hv_dynstmt.arr, ", omc_match_fifo_amt_limit = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// min_settle_amt
	if (GetField_Double(hRls, "min_settle_amt", &dTmp)) {
DEBUGLOG(("Update: min_settle_amt = [%f]\n", dTmp));
		sprintf(csBuf, "%f", dTmp);
		strcat((char*)hv_dynstmt.arr, ", omc_min_settle_amt = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// min_settle_amt_apply_admin
	if (GetField_Int(hRls, "min_settle_amt_apply_admin", &iTmp)) {
DEBUGLOG(("Update: min_settle_amt_apply_admin = [%d]\n", iTmp));
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, ", omc_min_settle_amt_apply_admin = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// preferred_settle_ccy
	if (GetField_CString(hRls, "preferred_settle_ccy", &csTmp)) {
DEBUGLOG(("Update: preferred_settle_ccy = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", omc_preferred_settle_ccy = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// update_user
	if (GetField_CString(hRls, "update_user", &csTmp)) {
DEBUGLOG(("Update: update_user = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", omc_update_user = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	strcat((char *)hv_dynstmt.arr, " where omc_merchant_id = '");
	strcat((char *)hv_dynstmt.arr, csMerchantId);
	strcat((char *)hv_dynstmt.arr, "'");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	strcat((char *)hv_dynstmt.arr, " and omc_currency_id = '");
	strcat((char *)hv_dynstmt.arr, csCurrencyId);
	strcat((char *)hv_dynstmt.arr, "'");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	strcat((char *)hv_dynstmt.arr, " and omc_country_id = '");
	strcat((char *)hv_dynstmt.arr, csCountryId);
	strcat((char *)hv_dynstmt.arr, "'");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	strcat((char *)hv_dynstmt.arr, " and omc_service_code = '");
	strcat((char *)hv_dynstmt.arr, csServiceCode);
	strcat((char *)hv_dynstmt.arr, "'");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n", hv_dynstmt.len, hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);

DEBUGLOG(("Update Normal Exit\n"));
	return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("MerantantBalAcct_Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
	TxnAbort();
	return PD_INTERNAL_ERR;
}


int GetMerchConfig(const char *csMerchantId, const char *csCountryId,
					const char *csCurrencyId, const char *csServiceCode,
					hash_t *hMerchCfg)
{
	int iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO getmerchconfig_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar hv_country_id[PD_COUNTRY_LEN];
		varchar hv_currency_id[PD_CCY_ID_LEN];
		varchar hv_service_code[PD_SERVICE_CODE_LEN];
		int v_match_fifo;
		double v_match_fifo_amt_limit;
		double v_min_settle_amt;
		int v_min_settle_amt_apply_admin;
		varchar v_preferred_settle_ccy[PD_CCY_ID_LEN + 1];

		short ind_merchant_id = -1;
		short ind_country_id = -1;
		short ind_currency_id = -1;
		short ind_service_code = -1;
		short ind_match_fifo = -1;
		short ind_match_fifo_amt_limit = -1;
		short ind_min_settle_amt = -1;
		short ind_min_settle_amt_apply_admin = -1;
		short ind_preferred_settle_ccy = -1;
	EXEC SQL END DECLARE SECTION;

	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetMerchConfig merchant_id = [%.*s]\n", hv_merchant_id.len, hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	memcpy(hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("GetMerchConfig country_id = [%.*s]\n", hv_country_id.len, hv_country_id.arr));

	hv_currency_id.len = strlen(csCurrencyId);
	memcpy(hv_currency_id.arr, csCurrencyId, hv_currency_id.len);
	ind_currency_id = 0;
DEBUGLOG(("GetMerchConfig currency_id = [%.*s]\n", hv_currency_id.len, hv_currency_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetMerchConfig service_code = [%.*s]\n", hv_service_code.len, hv_service_code.arr));

	EXEC SQL DECLARE c_cursor_getmerchconfig CURSOR FOR
		SELECT	omc_match_fifo, omc_match_fifo_amt_limit, omc_min_settle_amt, omc_min_settle_amt_apply_admin, omc_preferred_settle_ccy
		FROM	ol_merch_config
		WHERE	omc_merchant_id = :hv_merchant_id:ind_merchant_id
		AND	omc_country_id = :hv_country_id:ind_country_id
		AND	omc_currency_id = :hv_currency_id:ind_currency_id
		AND	omc_service_code = :hv_service_code:ind_service_code
		AND omc_disabled = 0;

	EXEC SQL OPEN c_cursor_getmerchconfig;

	for (;;) {
		EXEC SQL FETCH c_cursor_getmerchconfig
		INTO	:v_match_fifo:ind_match_fifo,
			:v_match_fifo_amt_limit:ind_match_fifo_amt_limit,
			:v_min_settle_amt:ind_min_settle_amt,
			:v_min_settle_amt_apply_admin:ind_min_settle_amt_apply_admin,
			:v_preferred_settle_ccy:ind_preferred_settle_ccy;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		if (ind_match_fifo >= 0) {
			PutField_Int(hMerchCfg, "match_fifo", v_match_fifo);
DEBUGLOG(("GetMerchConfig match_fifo = [%d]\n", v_match_fifo));
			if (!v_match_fifo) {
				if (ind_match_fifo_amt_limit >= 0) {
					PutField_Double(hMerchCfg, "match_fifo_amt_limit", v_match_fifo_amt_limit);
DEBUGLOG(("GetMerchConfig match_fifo_amt_limit = [%lf]\n", v_match_fifo_amt_limit));
				} else {
					PutField_Double(hMerchCfg, "match_fifo_amt_limit", 0);
DEBUGLOG(("GetMerchConfig (default) match_fifo_amt_limit = [%lf]\n", 0));
				}
			}
		} else {
			PutField_Int(hMerchCfg, "match_fifo", PD_TRUE);
DEBUGLOG(("GetMerchConfig (default) match_fifo = [%d]\n", PD_TRUE));
		}

		if (ind_min_settle_amt >= 0) {
			PutField_Double(hMerchCfg, "min_settle_amt", v_min_settle_amt);
DEBUGLOG(("GetMerchConfig min_settle_amt = [%lf]\n", v_min_settle_amt));
		}

		if (ind_min_settle_amt_apply_admin >= 0) {
			PutField_Int(hMerchCfg, "min_settle_amt_apply_admin", v_min_settle_amt_apply_admin);
DEBUGLOG(("GetMerchConfig min_settle_amt_apply_admin = [%lf]\n", v_min_settle_amt_apply_admin));
		}

		if (ind_preferred_settle_ccy >= 0) {
			v_preferred_settle_ccy.arr[v_preferred_settle_ccy.len] = '\0';
			PutField_CString(hMerchCfg, "preferred_settle_ccy", (const char*)v_preferred_settle_ccy.arr);
DEBUGLOG(("GetMerchConfig preferred_settle_ccy = [%s]\n", (const char*)v_preferred_settle_ccy.arr));
		}
	}

	EXEC SQL CLOSE c_cursor_getmerchconfig;

DEBUGLOG(("GetMerchConfig Normal Exit! iRet = [%d]\n", iRet));
	return iRet;

getmerchconfig_error:
DEBUGLOG(("getmerchconfig_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLMerchConfig getmerchconfig_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL CLOSE c_cursor_getmerchconfig;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}
