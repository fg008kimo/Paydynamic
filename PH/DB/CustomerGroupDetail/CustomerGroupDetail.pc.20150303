/*
Partnerdelight. (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/11              Cody Chan
Add UpdateGroup					   2013/10/24		   LokMan Chow
*/
#include <stdio.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "CustomerGroupDetail.h"
#include "common.h"
#include "utilitys.h"
char    cDebug;

void CustomerGroupDetail(char    cdebug)
{
        cDebug = cdebug;
}


int FindGroup(const char* csMerchantId,
		const char* csCustomerTag,
		char*	csCustomerGroup)
{
        EXEC SQL WHENEVER SQLERROR GOTO find_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar hv_customer_tag[PD_CUSTOMER_TAG_LEN];

		varchar	v_customer_group[PD_CUSTOMER_GROUP_CODE_LEN +1];
                short   ind_customer_group = -1;

        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("FindGroup: merchant ID = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr)); 

        hv_customer_tag.len = strlen(csCustomerTag);
        memcpy(hv_customer_tag.arr,csCustomerTag,hv_customer_tag.len);
DEBUGLOG(("FindGroup: Customer Tag = [%.*s]\n",hv_customer_tag.len,hv_customer_tag.arr)); 

        EXEC SQL SELECT CGD_CODE
                    INTO :v_customer_group:ind_customer_group
                FROM CUSTOMER_GROUP_DETAIL
                WHERE CGD_MERCHANT_ID = :hv_merchant_id
		  AND CGD_CUST_ID = :hv_customer_tag;

        if (ind_customer_group >= 0) {
		v_customer_group.arr[v_customer_group.len] = '\0';
                strcpy(csCustomerGroup,(const char*)v_customer_group.arr);
DEBUGLOG(("FindGroup: customer group [%s] found\n",v_customer_group.arr));
              	return FOUND;
        }
DEBUGLOG(("FindGroup:Not Found\n"));
        return NOT_FOUND;
find_error:
DEBUGLOG(("find_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return NOT_FOUND;
}


int Add(const hash_t *hRec)
{
        char            *csPtr;

        EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_code[PD_CUSTOMER_GROUP_CODE_LEN];
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_customer_tag[PD_CUSTOMER_TAG_LEN];
                varchar         hv_create_user[PD_USER_LEN];

                short           ind_code = -1;
                short           ind_merchant_id = -1;
                short           ind_customer_tag = -1;
                short           ind_create_user = -1;

                short           hv_return_value;
        EXEC SQL END DECLARE SECTION;

/* code */
        if(GetField_CString(hRec,"customer_group",&csPtr))
        {
                hv_code.len = strlen(csPtr);
                strncpy((char*)hv_code.arr, csPtr, hv_code.len);
                ind_code = 0;
        }
DEBUGLOG(("Add:code = [%.*s]\n",hv_code.len,hv_code.arr));

/* merchant_id */
        if(GetField_CString(hRec,"merchant_id",&csPtr))
        {
                hv_merchant_id.len = strlen(csPtr);
                strncpy((char*)hv_merchant_id.arr, csPtr, hv_merchant_id.len);
                ind_merchant_id = 0;
        }
DEBUGLOG(("Add:merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* customer_tag */
        if(GetField_CString(hRec,"customer_tag",&csPtr))
        {
                hv_customer_tag.len = strlen(csPtr);
                strncpy((char*)hv_customer_tag.arr, csPtr, hv_customer_tag.len);
                ind_customer_tag = 0;
        }
DEBUGLOG(("Add:customer_tag = [%.*s]\n",hv_customer_tag.len,hv_customer_tag.arr));


/* create user */
        if(GetField_CString(hRec,"create_user",&csPtr))
        {
                hv_create_user.len = strlen(csPtr);
                strncpy((char*)hv_create_user.arr, csPtr, hv_create_user.len);
                ind_create_user = 0;
        }
DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));



        EXEC SQL EXECUTE
            BEGIN

                :hv_return_value := sp_customer_grp_dtl_insert(
                                :hv_code:ind_code,
                                :hv_merchant_id:ind_merchant_id,
                                :hv_customer_tag:ind_customer_tag,
                                :hv_create_user:ind_create_user);

            END;
        END-EXEC;


        DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("Add:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("CustomerGroupDetail_Add: SP_OTHER_ERR \n");
DEBUGLOG(("Add: SP_OTHER_ERR \n"));
                return PD_OTHER_ERR;
        }


        if (hv_return_value == SP_ERR)  {
ERRLOG("CustomerGroupDetail_Add: SP_ERR \n");
DEBUGLOG(("Add: SP_ERR \n"));
                return PD_ERR;
        }

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}


int UpdateGroup(const hash_t *hRec)
{
        char            *csPtr;

        EXEC SQL WHENEVER SQLERROR GOTO update_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_code[PD_CUSTOMER_GROUP_CODE_LEN];
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_customer_tag[PD_CUSTOMER_TAG_LEN];
                varchar         hv_update_user[PD_USER_LEN];

                short           ind_code = -1;
                short           ind_merchant_id = -1;
                short           ind_customer_tag = -1;
                short           ind_update_user = -1;

                short           hv_return_value;
        EXEC SQL END DECLARE SECTION;

/* code */
        if(GetField_CString(hRec,"customer_group",&csPtr))
        {
                hv_code.len = strlen(csPtr);
                strncpy((char*)hv_code.arr, csPtr, hv_code.len);
                ind_code = 0;
DEBUGLOG(("UpdateGroup:code = [%.*s]\n",hv_code.len,hv_code.arr));
        }

/* merchant_id */
        if(GetField_CString(hRec,"merchant_id",&csPtr))
        {
                hv_merchant_id.len = strlen(csPtr);
                strncpy((char*)hv_merchant_id.arr, csPtr, hv_merchant_id.len);
                ind_merchant_id = 0;
DEBUGLOG(("UpdateGroup:merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        }

/* customer_tag */
        if(GetField_CString(hRec,"customer_tag",&csPtr))
        {
                hv_customer_tag.len = strlen(csPtr);
                strncpy((char*)hv_customer_tag.arr, csPtr, hv_customer_tag.len);
                ind_customer_tag = 0;
DEBUGLOG(("UpdateGroup:customer_tag = [%.*s]\n",hv_customer_tag.len,hv_customer_tag.arr));
        }


/* update_user */
        if(GetField_CString(hRec,"update_user",&csPtr))
        {
                hv_update_user.len = strlen(csPtr);
                strncpy((char*)hv_update_user.arr, csPtr, hv_update_user.len);
                ind_update_user= 0;
DEBUGLOG(("UpdateGroup:update_user = [%.*s]\n",hv_update_user.len,hv_update_user.arr));
        }

        EXEC SQL EXECUTE
            BEGIN

                :hv_return_value := sp_customer_grp_dtl_update(
                                :hv_code:ind_code,
                                :hv_merchant_id:ind_merchant_id,
                                :hv_customer_tag:ind_customer_tag,
                                :hv_update_user:ind_update_user);

            END;
        END-EXEC;


DEBUGLOG(("UpdateGroup:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("UpdateGroup:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("CustomerGroupDetail_UpdateGroup: SP_OTHER_ERR \n");
DEBUGLOG(("UpdateGroup: SP_OTHER_ERR \n"));
                return PD_OTHER_ERR;
        }


        if (hv_return_value == SP_ERR)  {
ERRLOG("CustomerGroupDetail_UpdateGroup: SP_ERR \n");
DEBUGLOG(("UpdateGroup: SP_ERR \n"));
                return PD_ERR;
        }

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;


}

int MatchRecord(const char* csMerchantId,
		const char* csCustomerTag,
		const char* csCustomerGroup)
{
        EXEC SQL WHENEVER SQLERROR GOTO match_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar hv_customer_tag[PD_CUSTOMER_TAG_LEN];
		varchar	hv_customer_group[PD_CUSTOMER_GROUP_CODE_LEN +1];

		int	v_cnt;
                short   ind_cnt = -1;

        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("MatchRecord: merchant ID = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr)); 

        hv_customer_tag.len = strlen(csCustomerTag);
        memcpy(hv_customer_tag.arr,csCustomerTag,hv_customer_tag.len);
DEBUGLOG(("MatchRecord: Customer Tag = [%.*s]\n",hv_customer_tag.len,hv_customer_tag.arr)); 

        hv_customer_group.len = strlen(csCustomerGroup);
        memcpy(hv_customer_group.arr,csCustomerGroup,hv_customer_group.len);
DEBUGLOG(("MatchRecord: Customer Group= [%.*s]\n",hv_customer_group.len,hv_customer_group.arr)); 

        EXEC SQL
		SELECT count(1) 
		INTO  :v_cnt:ind_cnt
                FROM CUSTOMER_GROUP_DETAIL
                WHERE CGD_MERCHANT_ID = :hv_merchant_id
		  AND CGD_CUST_ID = :hv_customer_tag
                  AND CGD_CODE = :hv_customer_group;


        if (ind_cnt < 0) 
		v_cnt = 0;

	if(v_cnt >0){
DEBUGLOG(("MatchRecord: customer[%s][%s][%s] found\n",hv_merchant_id.arr,hv_customer_tag.arr,hv_customer_group.arr));
		return FOUND;
	}

DEBUGLOG(("MatchRecord:Not Found\n"));
        return NOT_FOUND;

match_error:
DEBUGLOG(("match_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return NOT_FOUND;
}
