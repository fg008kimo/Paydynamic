/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2017/10/12              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "internal.h"
#include "PidBankGroupMapping.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char    cDebug;

void PidBankGroupMapping(char    cdebug)
{
        cDebug = cdebug;
}

int GetPidGroup(const char* csServiceCode)
{
        int iRet = NOT_FOUND;

        EXEC SQL WHENEVER SQLERROR GOTO get_pid_grp_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                varchar hv_service_code[PD_SERVICE_CODE_LEN];

		int    	v_no_of_record;

                short   ind_service_code = -1;

		short   ind_no_of_record = -1;

        EXEC SQL END DECLARE SECTION;

/* service_code */
        if(csServiceCode!=NULL){
                hv_service_code.len = strlen(csServiceCode);
                memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
                ind_service_code = 0;
DEBUGLOG(("GetPidGroup: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
        }
        else{
DEBUGLOG(("GetPidGroup: service_code is missing\n"));
                return INT_ERR;
        }

	EXEC SQL
               	SELECT count(*)
             	INTO :v_no_of_record:ind_no_of_record
               	FROM pid_bank_group_mapping
                WHERE pgm_service_code = :hv_service_code
               	AND   pgm_disabled = 0;

	if (ind_no_of_record >= 0) {
                if (v_no_of_record > 0) {
DEBUGLOG(("GetPidGroup FOUND\n"));
                        iRet = FOUND;
                }
        }

	if (iRet != FOUND) {
DEBUGLOG(("GetPidGroup NOT FOUND\n"));
        }

        return iRet;

get_pid_grp_error:
DEBUGLOG(("get_pid_grp_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return PD_ERR;
}	

int CheckPidGroup(const char* csPspId, const char* csServiceCode)
{
        int iRet = PD_OK;

        EXEC SQL WHENEVER SQLERROR GOTO chk_pid_grp_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                varchar hv_psp_id[PD_PSP_ID_LEN];
                varchar hv_service_code[PD_SERVICE_CODE_LEN];

                short   hv_return_value;

                short   ind_psp_id = -1;
                short   ind_service_code = -1;

        EXEC SQL END DECLARE SECTION;

/* psp_id */
        if(csPspId!=NULL){
                hv_psp_id.len = strlen(csPspId);
                memcpy(hv_psp_id.arr,csPspId,hv_psp_id.len);
                ind_psp_id = 0;
DEBUGLOG(("CheckPidGroup: psp_id = [%.*s]\n",hv_psp_id.len,hv_psp_id.arr));
        }
        else{
DEBUGLOG(("CheckPidGroup: psp_id is missing\n"));
                return INT_ERR;
        }

/* service_code */
        if(csServiceCode!=NULL){
                hv_service_code.len = strlen(csServiceCode);
                memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
                ind_service_code = 0;
DEBUGLOG(("CheckPidGroup: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
        }
        else{
DEBUGLOG(("CheckPidGroup: service_code is missing\n"));
                return INT_ERR;
        }

        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_ng_bank_check_pid_grp(:hv_psp_id:ind_psp_id,
								      :hv_service_code:ind_service_code);
                END;
        END-EXEC;

        if (hv_return_value > 0) {
                iRet = PD_OK;
DEBUGLOG(("CheckPidGroup: Skip PID Group or PID Group is valid!!\n"));
        } else {
                iRet = PD_ERR;
DEBUGLOG(("CheckPidGroup: PID Group is invalid!!\n"));
        }

        return iRet;

chk_pid_grp_error:
DEBUGLOG(("chk_pid_grp_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return PD_ERR;
}	
