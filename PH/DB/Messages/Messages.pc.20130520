/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/10/05              Cody Chan
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "Messages.h"
#include "internal.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode
char cDebug;

void Messages(char    cdebug)
{
        cDebug = cdebug;
}

int i2c(const unsigned char* ChannelCode,long InternalCode,unsigned char* DestCode)
{

        EXEC SQL WHENEVER SQLERROR GOTO i2c_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_channel_code[PD_PSP_CHANNEL_CODE_LEN];
                long    hv_internal_code;

                varchar v_dest_code[PD_EXT_MESSAGE_CODE_LEN + 1];
        EXEC SQL END DECLARE SECTION;

        hv_channel_code.len = strlen((const char*)ChannelCode);
        memcpy(hv_channel_code.arr, ChannelCode, hv_channel_code.len);
        hv_internal_code = InternalCode;

        EXEC SQL
                SELECT  ic_error_code
                INTO    :v_dest_code
                FROM    I2C_MAPPINGS
                WHERE   ic_channel_code = :hv_channel_code
                AND     ic_internal_code = :hv_internal_code;

        if (SQLCODE == SQL_NOT_FOUND) {
                hv_internal_code = INT_SPECIAL_CODE;
                EXEC SQL
                        SELECT  ic_error_code
                        INTO    :v_dest_code
                        FROM    I2C_MAPPINGS
                        WHERE   ic_channel_code = :hv_channel_code
                        AND     ic_internal_code = :hv_internal_code;
                if (SQLCODE == SQL_NOT_FOUND) {
                        return PD_ERR;
                }
        }

        v_dest_code.arr[v_dest_code.len] = '\0';
        strcpy((char*)DestCode,(const char*)v_dest_code.arr);

        return PD_OK;

i2c_error:
    EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int c2i(const unsigned char* ChannelCode,long *InternalCode,const unsigned char* SrcCode)
{

DEBUGLOG(("c2i\n"));
DEBUGLOG(("src code = [%s]\n",SrcCode));
DEBUGLOG(("chn code = [%s]\n",ChannelCode));
        EXEC SQL WHENEVER SQLERROR GOTO c2i_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_channel_code[PD_PSP_CHANNEL_CODE_LEN];
                varchar hv_src_code[PD_EXT_MESSAGE_CODE_LEN + 1];

                long    v_internal_code;
        EXEC SQL END DECLARE SECTION;

        hv_channel_code.len = strlen((const char*)ChannelCode);
        memcpy(hv_channel_code.arr, ChannelCode, hv_channel_code.len);

        hv_src_code.len = strlen((const char*)SrcCode);
        memcpy(hv_src_code.arr, SrcCode, hv_src_code.len);
        EXEC SQL
                SELECT  ic_internal_code
                INTO    :v_internal_code
                FROM    I2C_MAPPINGS
                WHERE   ic_channel_code = :hv_channel_code
                AND     ic_error_code = :hv_src_code;

        if (SQLCODE == SQL_NOT_FOUND) {
                v_internal_code = INT_SPECIAL_CODE;
        }
DEBUGLOG(("c2i: internal code = [%d]\n",v_internal_code));

	*InternalCode = v_internal_code;

        return PD_OK;

c2i_error:
    EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int c2i_po(const unsigned char* ChannelCode,long *InternalCode,const unsigned char* SrcCode)
{

DEBUGLOG(("c2i_po\n"));
DEBUGLOG(("src code = [%s]\n",SrcCode));
DEBUGLOG(("chn code = [%s]\n",ChannelCode));
        EXEC SQL WHENEVER SQLERROR GOTO c2i_po_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_channel_code[PD_PSP_CHANNEL_CODE_LEN];
                varchar hv_src_code[PD_EXT_MESSAGE_CODE_LEN + 1];

                long    v_internal_code;
        EXEC SQL END DECLARE SECTION;

        hv_channel_code.len = strlen((const char*)ChannelCode);
        memcpy(hv_channel_code.arr, ChannelCode, hv_channel_code.len);

        hv_src_code.len = strlen((const char*)SrcCode);
        memcpy(hv_src_code.arr, SrcCode, hv_src_code.len);
        EXEC SQL
                SELECT  ic_internal_code
                INTO    :v_internal_code
                FROM    I2C_PO_MAPPINGS
                WHERE   ic_channel_code = :hv_channel_code
                AND     ic_error_code = :hv_src_code;

        if (SQLCODE == SQL_NOT_FOUND) {
                v_internal_code = INT_SPECIAL_CODE;
        }
DEBUGLOG(("c2i_po: internal code = [%d]\n",v_internal_code));

	*InternalCode = v_internal_code;

        return PD_OK;

c2i_po_error:
    EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}
