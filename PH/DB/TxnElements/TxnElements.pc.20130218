/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/01/30              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "TxnElements.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;
void TxnElements(char    cdebug)
{
        cDebug = cdebug;
}



int Add(const hash_t *hRls)
{
        char            *csTmp;
	char		cTmp;
        double          dTmp;


        EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short           hv_return_value;

        varchar         hv_txn_id[PD_TXN_SEQ_LEN];
	varchar		hv_txn_element_type[PD_TXN_ELEMENT_TYPE_LEN];
	char		hv_party_type;
	double		hv_amount;
	varchar		hv_ccy[PD_CCY_ID_LEN];
	varchar		hv_amt_type[PD_AMT_TYPE_LEN];
        varchar         hv_add_user[PD_USER_LEN];
	double		hv_rate;


        short           ind_txn_id = -1;
	short		ind_txn_element_type = -1;
	short		ind_party_type = -1;
	short		ind_amount = -1;
	short		ind_ccy = -1;
	short		ind_amt_type = -1;
        short           ind_add_user = -1;
	short		ind_rate = -1;

        EXEC SQL END DECLARE SECTION;
DEBUGLOG(("Add: Begin\n"));

/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("Add:txn_id = [%.*s][%d]\n",hv_txn_id.len,hv_txn_id.arr,hv_txn_id.len));
        }

/* txn_element_type */
        if (GetField_CString(hRls,"txn_element_type",&csTmp)) {
                hv_txn_element_type.len = strlen(csTmp);
                memcpy(hv_txn_element_type.arr,csTmp,hv_txn_element_type.len);
                ind_txn_element_type = 0;
DEBUGLOG(("Add:txn_element_type = [%.*s][%d]\n",hv_txn_element_type.len,hv_txn_element_type.arr,hv_txn_element_type.len));
        }
/* party type */
        if (GetField_Char(hRls,"party_type",&cTmp)) {
		hv_party_type = cTmp;
		ind_party_type = 0;
DEBUGLOG(("Add:party_type = [%c]\n",hv_party_type));
	}

/* amount */
        if (GetField_Double(hRls,"amount",&dTmp)) {
                hv_amount = dTmp;
                ind_amount = 0;
DEBUGLOG(("Add:amount = [%lf]\n",hv_amount));
        }

/* ccy */
        if (GetField_CString(hRls,"ccy",&csTmp)) {
                hv_ccy.len = strlen(csTmp);
                memcpy(hv_ccy.arr,csTmp,hv_ccy.len);
                ind_ccy = 0;
DEBUGLOG(("Add:ccy = [%.*s][%d]\n",hv_ccy.len,hv_ccy.arr,hv_ccy.len));
        }

/* amt_type */
        if (GetField_CString(hRls,"amount_type",&csTmp)) {
                hv_amt_type.len = strlen(csTmp);
                memcpy(hv_amt_type.arr,csTmp,hv_amt_type.len);
                ind_amt_type = 0;
DEBUGLOG(("Add:amt_type = [%.*s][%d]\n",hv_amt_type.len,hv_amt_type.arr,hv_amt_type.len));
        }

/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen(csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("Add:add_user = [%.*s][%d]\n",hv_add_user.len,hv_add_user.arr,hv_add_user.len));
        }
/* rate */
        if (GetField_Double(hRls,"rate",&dTmp)) {
                hv_rate = dTmp;
                ind_rate = 0;
DEBUGLOG(("Add:rate = [%lf]\n",hv_rate));
        }


	
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_txn_elements_insert(
                                        :hv_txn_id:ind_txn_id,
					:hv_txn_element_type:ind_txn_element_type,
					:hv_party_type:ind_party_type,
					:hv_amount:ind_amount,
					:hv_ccy:ind_ccy,
					:hv_amt_type:ind_amt_type,
					:hv_rate:ind_rate,
                                        :hv_add_user:ind_add_user);
                END;
        END-EXEC;		

DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("Add:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("TxnElements_Add: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
                TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("TxnElements_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
                TxnAbort();
                return PD_ERR;
        }



add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("TxnElement_Add: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;
}


int GetFeeChgDetailByType(const char* csTxnID,
                const char* csElementType,
                const char cPartyType,
                recordset_t* myRec)
{

        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO getfeechgdetailbytype_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];
		varchar		hv_txn_element_type[PD_TXN_ELEMENT_TYPE_LEN];
                char            hv_party_type;

                varchar         v_ccy[PD_CCY_ID_LEN +1];
                double          v_amount;

                short           ind_ccy = -1;
                short           ind_amount = -1;


        EXEC SQL END DECLARE SECTION;

/* txn_id */
        hv_txn_id.len = strlen(csTxnID);
        memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetFeeChgDetailByType txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));


/* element type */
        hv_txn_element_type.len = strlen(csElementType);
        memcpy(hv_txn_element_type.arr,csElementType,hv_txn_element_type.len);
DEBUGLOG(("GetFeeChgDetailByType txn_element_type = [%.*s]\n",hv_txn_element_type.len,hv_txn_element_type.arr));

/* party type */
        hv_party_type =  cPartyType;
DEBUGLOG(("GetFeeChgDetailByType party_type = [%c]\n",hv_party_type));

        EXEC SQL DECLARE c_cursor_getfeechgdetailbytype CURSOR FOR
                select te_ccy,
                       te_amount
                  from txn_elements
                 where te_txn_id = :hv_txn_id
		   and te_txn_element_type = :hv_txn_element_type
                   and te_party_type = :hv_party_type;


        EXEC SQL OPEN c_cursor_getfeechgdetailbytype;
        do {
                EXEC SQL FETCH c_cursor_getfeechgdetailbytype
                INTO
                        :v_ccy:ind_ccy,
                        :v_amount:ind_amount;


                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/* ccy */
                if (ind_ccy >= 0) {
                        v_ccy.arr[v_ccy.len] = '\0';
                        PutField_CString(myHash,"ccy",(const char*)v_ccy.arr);
DEBUGLOG(("GetFeeChgDetailByType ccy = [%s]\n",v_ccy.arr));
                }

/*amount*/
                if(ind_amount>=0){
                        PutField_Double(myHash,"amount",v_amount);
DEBUGLOG(("GetFeeChgDetailByType amount = [%f]\n",v_amount));
                }

                RecordSet_Add(myRec,myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getfeechgdetailbytype;


DEBUGLOG(("GetFeeChgDetailByType Normal Exit\n"));
        return  PD_OK;

getfeechgdetailbytype_error:
DEBUGLOG(("getfeechgdetailbytype_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getfeechgdetailbytype;
        return PD_ERR;
}



int GetAllFeeChgDetail(const char* csTxnID,
                recordset_t* myRec)
{

        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO getall_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];

		varchar		v_txn_element_type[PD_TXN_ELEMENT_TYPE_LEN];
                char            v_party_type;
                varchar         v_ccy[PD_CCY_ID_LEN +1];
                varchar         v_amt_type[PD_AMT_TYPE_LEN +1];
                double          v_amount;
                double          v_rate;

                short           ind_ccy = -1;
                short           ind_amount = -1;
                short           ind_txn_element_type= -1;
                short           ind_party_type= -1;
                short           ind_amt_type= -1;
                short           ind_rate= -1;


        EXEC SQL END DECLARE SECTION;

/* txn_id */
        hv_txn_id.len = strlen(csTxnID);
        memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetAllFeeChgDetail txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));


        EXEC SQL DECLARE c_cursor_getall CURSOR FOR
                select te_txn_element_type,
		       te_ccy,
                       te_amount,
		       te_amt_type,
		       te_party_type,
		       te_rate
                  from txn_elements
                 where te_txn_id = :hv_txn_id
		 order by te_exec_seq desc;

        EXEC SQL OPEN c_cursor_getall;
        do {
                EXEC SQL FETCH c_cursor_getall
                INTO
                        :v_txn_element_type:ind_txn_element_type,
                        :v_ccy:ind_ccy,
                        :v_amount:ind_amount,
			:v_amt_type:ind_amt_type,
			:v_party_type:ind_party_type,
			:v_rate:ind_rate;


                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/* element type */
		if(ind_txn_element_type >= 0){
			v_txn_element_type.arr[v_txn_element_type.len] = '\0';
			PutField_CString(myHash,"txn_element_type",(const char*)v_txn_element_type.arr);
DEBUGLOG(("GetAllFeeChgDetail txn_element_type = [%s]\n",v_txn_element_type.arr));
		}

/* party type */
		if(ind_party_type>=0){
                        PutField_Char(myHash,"party_type",v_party_type);
DEBUGLOG(("GetAllFeeChgDetail party_type = [%c]\n",v_party_type));
		}

/* amt_type */
                if (ind_amt_type >= 0) {
                        v_amt_type.arr[v_amt_type.len] = '\0';
                        PutField_CString(myHash,"amt_type",(const char*)v_amt_type.arr);
DEBUGLOG(("GetAllFeeChgDetail amt_type = [%s]\n",v_amt_type.arr));
                }

/*rate*/
                if(ind_rate>=0){
                        PutField_Double(myHash,"rate",v_rate);
DEBUGLOG(("GetAllFeeChgDetail rate = [%f]\n",v_rate));
                }

/* ccy */
                if (ind_ccy >= 0) {
                        v_ccy.arr[v_ccy.len] = '\0';
                        PutField_CString(myHash,"ccy",(const char*)v_ccy.arr);
DEBUGLOG(("GetAllFeeChgDetail ccy = [%s]\n",v_ccy.arr));
                }

/*amount*/
                if(ind_amount>=0){
                        PutField_Double(myHash,"amount",v_amount);
DEBUGLOG(("GetAllFeeChgDetail amount = [%f]\n",v_amount));
                }

                RecordSet_Add(myRec,myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getall;


DEBUGLOG(("GetAllFeeChgDetail Normal Exit\n"));
        return  PD_OK;

getall_error:
DEBUGLOG(("getall_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getall;
        return PD_ERR;
}
