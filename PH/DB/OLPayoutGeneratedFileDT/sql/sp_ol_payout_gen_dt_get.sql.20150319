CREATE OR REPLACE FUNCTION sp_ol_payout_gen_dt_get(
  in_file_id			ol_payout_generated_file_dt.ofd_file_id%type,
  in_txn_list                   VARCHAR2,
  in_upload_status		ol_merchant_upload_file_detail.oud_status%type,
  in_status			ol_payout_generated_file_dt.ofd_status%type,
  out_cursor		out	sys_refcursor)

RETURN NUMBER Is
	iCnt	integer := 0;

Begin
	select count(*)
	  into	iCnt
	  from	ol_payout_generated_file_dt,
	  	ol_payout_generated_file_hd,
		ol_merchant_upload_file_detail
	  where ofd_file_id = ofh_file_id
	  and	ofd_upload_txn_id = oud_txn_id
	  and	ofh_status = 1
	  and	(ofd_status = in_status or in_status is NULL)
	  and	(ofd_file_id = in_file_id or in_file_id is NULL)
	  and	(oud_status  = in_upload_status or in_upload_status is NULL)
	  and   (ofd_upload_txn_id in (SELECT REGEXP_SUBSTR (in_txn_list,'[^,]+',1,LEVEL) token
                FROM DUAL CONNECT BY LEVEL <= LENGTH (in_txn_list)- LENGTH (REPLACE(in_txn_list,',',''))+ 1)
                or in_txn_list is NULL)
	  and	oud_disabled=0;

	if iCnt > 0 THEN
		OPEN out_cursor for
		select	ofd_file_id,
			ofd_batch_id,
			ofd_seq_num,
                        ofd_txn_id,
                        ofd_upload_txn_id,
                        ofd_merchant_ref,
                        ofd_country,
                        ofd_identity_id,
                        ofd_account_num,
                        ofd_account_name,
                        ofd_bank_name,
                        ofd_bank_code,
                        ofd_branch,
                        ofd_phone_num,
                        ofd_province,
                        ofd_city,
                        ofd_payout_amount,
                        ofd_unique_amount,
                        ofd_request_amount,
                        ofd_payout_currency,
                        ofd_request_currency,
                        ofh_filename,
                        ofh_file_pid,
			opd_client_id,
			ofh_ccy_id,
			ofh_txn_count,
			ofh_total_txn_amt,
			otp_cost
		from	ol_payout_generated_file_dt,
			ol_payout_generated_file_hd,
			ol_merchant_upload_file_detail,
			ol_psp_detail,
                        ol_txn_psp_detail
	  	where	ofd_file_id = ofh_file_id
	  	and	ofd_upload_txn_id = oud_txn_id
		and     ofd_txn_id = otp_txn_id
	  	and	ofh_status = 1
	  	and	(ofd_status = in_status or in_status is NULL)
	  	and	(ofd_file_id = in_file_id or in_file_id is NULL)
	 	and	(oud_status  = in_upload_status or in_upload_status is NULL)
		and     (ofd_upload_txn_id in (SELECT REGEXP_SUBSTR (in_txn_list,'[^,]+',1,LEVEL) token
                        FROM DUAL CONNECT BY LEVEL <= LENGTH (in_txn_list)- LENGTH (REPLACE(in_txn_list,',',''))+ 1)
                        or in_txn_list is NULL)
                and     opd_psp_id = ofh_file_pid
	 	and	oud_disabled=0
		order by ofd_batch_id, ofd_seq_num;

		return 1;
	end if;

	return 0;

exception
   WHEN OTHERS THEN
     RETURN 0;
END sp_ol_payout_gen_dt_get;
/
