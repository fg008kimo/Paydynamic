/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/08/31              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "BankPayoutPsp.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void BankPayoutPsp(char    cdebug)
{
        cDebug = cdebug;
}

int GetBankPayoutPsp(const char* csBankCode,
		     recordset_t* myRec)
{
	hash_t *myHash;
	int	iCnt=0;

        EXEC SQL WHENEVER SQLERROR GOTO getbankpsp_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_bank_code[PD_BANK_CODE_LEN];

                varchar         v_psp_id[PD_PSP_ID_LEN+1];
                varchar         v_opr_type[PD_OPERATOR_TYPE_LEN + 1];
                double          v_total_amt;

                short           ind_opr_type = -1;
		short		ind_psp_id = -1;
                short           ind_total_amt = -1;

        EXEC SQL END DECLARE SECTION;

        hv_bank_code.len = strlen(csBankCode);
        memcpy(hv_bank_code.arr,csBankCode,hv_bank_code.len);
DEBUGLOG(("GetBankPayoutPsp bank_code = [%s]\n",hv_bank_code.arr));



        EXEC SQL DECLARE c_cursor_getbankpsp CURSOR FOR
                select bp_operator_type,
		       bp_psp_id,
                       bp_total_amt
                  from bank_payout_psp,
		       psp_detail
                 where bp_int_bank_code = :hv_bank_code
		 and   bp_psp_id = psp_id
		 and   disabled = 0
		 and   online_mode = 'Y';

        EXEC SQL OPEN c_cursor_getbankpsp;
        do {
                EXEC SQL FETCH c_cursor_getbankpsp
                INTO
                        :v_opr_type:ind_opr_type,
			:v_psp_id:ind_psp_id,
                        :v_total_amt:ind_total_amt;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

DEBUGLOG(("GetBankPayoutPsp found record\n"));
		iCnt++;

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash,0);

/* opr_type */
                if (ind_opr_type >= 0) {
                        v_opr_type.arr[v_opr_type.len] = '\0';
                        PutField_CString(myHash,"operator_type",v_opr_type.arr);
DEBUGLOG(("GetBankPayoutPsp operator_type = [%s]\n",v_opr_type.arr));
                }

/* psp id */
                if (ind_psp_id >= 0) {
                        v_psp_id.arr[v_psp_id.len] = '\0';
                        PutField_CString(myHash,"psp_id",v_psp_id.arr);
DEBUGLOG(("GetBankPayoutPsp psp_id = [%s]\n",v_psp_id.arr));
                }


/* total_amt */
                if (ind_total_amt >= 0) {
                        PutField_Double(myHash,"total_amt",v_total_amt);
DEBUGLOG(("GetBankPayoutPsp total_amt = [%f]\n",v_total_amt));
                }

		RecordSet_Add(myRec,myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getbankpsp;

	if(iCnt>0){
DEBUGLOG(("GetBankPayoutPsp Normal Exit\n"));
        	return  PD_OK;
	}
	else{
DEBUGLOG(("GetBankPayoutPsp Normal Exit, Not found\n"));
		return PD_ERR;
	}

getbankpsp_error:
DEBUGLOG(("getbankpsp_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("BankPayoutPsp_Get: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getbankpsp;
        return PD_ERR;
}
