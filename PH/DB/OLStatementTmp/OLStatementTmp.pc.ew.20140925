/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/08/01              Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sqlca.h>
#include "common.h"
#include "internal.h"
#include "utilitys.h"
#include "dbutility.h"
#include "OLStatementTmp.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char	cDebug;

void OLStatementTmp(char	cdebug)
{
	cDebug = cdebug;
}

int CheckTmpRecord(const hash_t* hRls)
{
        int iRet = NOT_FOUND;
	char *csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO checktmprecord_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_int_bank_code[PD_STMT_TMP_LEN];
		varchar	hv_bank_acct_num[PD_STMT_TMP_LEN];
		varchar	hv_raw_date[PD_STMT_TMP_LEN];
		varchar	hv_raw_time[PD_STMT_TMP_LEN];
		varchar	hv_balance[PD_TMP_BUF_LEN];
		varchar	hv_amt_type[PD_TMP_BUF_LEN];
		varchar	hv_txn_amount[PD_TMP_BUF_LEN];
		int	v_cnt;

		short	ind_int_bank_code = -1;
		short	ind_bank_acct_num = -1;
		short	ind_raw_date = -1;
		short	ind_raw_time = -1;
		short	ind_balance = -1;
		short	ind_amt_type = -1;
		short	ind_txn_amount = -1;

        EXEC SQL END DECLARE SECTION;

	if (GetField_CString(hRls,"int_bank_code",&csTmp)) {
		hv_int_bank_code.len = strlen(csTmp);
		strncpy((char*)hv_int_bank_code.arr,csTmp,sizeof(hv_int_bank_code.arr));
		ind_int_bank_code = 0;
DEBUGLOG(("CheckTmpRecord: int_bank_code = [%.*s](%d)\n",sizeof(hv_int_bank_code.arr),hv_int_bank_code.arr,hv_int_bank_code.len));
	}

	if (GetField_CString(hRls,"bank_acct_num",&csTmp)) {
		hv_bank_acct_num.len = strlen(csTmp);
		strncpy((char*)hv_bank_acct_num.arr,csTmp,sizeof(hv_bank_acct_num.arr));
		ind_bank_acct_num = 0;
DEBUGLOG(("CheckTmpRecord: bank_acct_num = [%.*s](%d)\n",sizeof(hv_bank_acct_num.arr),hv_bank_acct_num.arr,hv_bank_acct_num.len));
	}

	if (GetField_CString(hRls,"raw_date",&csTmp)) {
		hv_raw_date.len = strlen(csTmp);
		strncpy((char*)hv_raw_date.arr,csTmp,sizeof(hv_raw_date.arr));
		ind_raw_date = 0;
DEBUGLOG(("CheckTmpRecord: raw_date = [%.*s](%d)\n",sizeof(hv_raw_date.arr),hv_raw_date.arr,hv_raw_date.len));
	}

	if (GetField_CString(hRls,"raw_time",&csTmp)) {
		hv_raw_time.len = strlen(csTmp);
		strncpy((char*)hv_raw_time.arr,csTmp,sizeof(hv_raw_time.arr));
		ind_raw_time = 0;
DEBUGLOG(("CheckTmpRecord: raw_time = [%.*s](%d)\n",sizeof(hv_raw_time.arr),hv_raw_time.arr,hv_raw_time.len));
	}

	if (GetField_CString(hRls,"balance",&csTmp)) {
		hv_balance.len = strlen(csTmp);
		strncpy((char*)hv_balance.arr,csTmp,sizeof(hv_balance.arr));
		ind_balance = 0;
DEBUGLOG(("CheckTmpRecord: balance = [%.*s](%d)\n",sizeof(hv_balance.arr),hv_balance.arr,hv_balance.len));
	}

	if (GetField_CString(hRls,"amt_type",&csTmp)) {
		hv_amt_type.len = strlen(csTmp);
		strncpy((char*)hv_amt_type.arr,csTmp,sizeof(hv_amt_type.arr));
		ind_amt_type = 0;
DEBUGLOG(("CheckTmpRecord: amt_type = [%.*s](%d)\n",sizeof(hv_amt_type.arr),hv_amt_type.arr,hv_amt_type.len));
	}

	if (GetField_CString(hRls,"txn_amount",&csTmp)) {
		hv_txn_amount.len = strlen(csTmp);
		strncpy((char*)hv_txn_amount.arr,csTmp,sizeof(hv_txn_amount.arr));
		ind_txn_amount = 0;
DEBUGLOG(("CheckTmpRecord: txn_amount = [%.*s](%d)\n",sizeof(hv_txn_amount.arr),hv_txn_amount.arr,hv_txn_amount.len));
	}

	EXEC SQL	SELECT	COUNT(*)
			INTO	:v_cnt
			FROM	OL_STATEMENT_TMP
			WHERE	OLST_INT_BANK_CODE = :hv_int_bank_code:ind_int_bank_code
			AND	OLST_BANK_ACCT_NUM = :hv_bank_acct_num:ind_bank_acct_num
			AND	(OLST_RAW_DATE = :hv_raw_date:ind_raw_date or :ind_raw_date = -1)
			AND	(OLST_RAW_TIME = :hv_raw_time:ind_raw_time or :ind_raw_time = -1)
			AND	(OLST_BALANCE = :hv_balance:ind_balance or :ind_balance = -1)
			AND	(OLST_AMT_TYPE = :hv_amt_type:ind_amt_type or :ind_amt_type = -1)
			AND	(OLST_TXN_AMOUNT = :hv_txn_amount:ind_txn_amount or :ind_txn_amount = -1)
			AND	OLST_VER = 0
			AND	OLST_LATEST_VER IS NOT NULL
			AND	OLST_DISABLED = 0
			AND	OLST_SKIP = 0;

	if (v_cnt>0) {
		iRet = FOUND;
DEBUGLOG(("CheckTmpRecord() FOUND\n"));
	} else {
		iRet = NOT_FOUND;
DEBUGLOG(("CheckTmpRecord() NOT FOUND\n"));
	}

DEBUGLOG(("CheckTmpRecord() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;

checktmprecord_error:
DEBUGLOG(("checktmprecord_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int GetSystemHeader(const char* csFileId, hash_t* hRec)
{
	int iRet = PD_OK;

        EXEC SQL WHENEVER SQLERROR GOTO getsystemheader_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar         hv_file_id[PD_TXN_SEQ_LEN];		

		int		v_skip_count;
		int		v_hold_count;
		int		v_accept_count;
		int		v_total_count;
		int		v_ver;
		int		v_split_count;
		int		v_add_count;
		int		v_update_count;
		int		v_delete_count;
		int		v_file_count;

                short           ind_skip_count = -1;
                short           ind_hold_count = -1;
                short           ind_accept_count = -1;
                short           ind_total_count = -1;
                short           ind_ver = -1;
                short           ind_split_count = -1;
                short           ind_add_count = -1;
                short           ind_update_count = -1;
                short           ind_delete_count = -1;
                short           ind_file_count = -1;
        EXEC SQL END DECLARE SECTION;

// file_id
	hv_file_id.len = strlen(csFileId);
        strncpy((char*)hv_file_id.arr,csFileId,sizeof(hv_file_id.arr));
DEBUGLOG(("GetSystemHeader: file_id = [%.*s](%d)\n",sizeof(hv_file_id.arr),hv_file_id.arr,hv_file_id.len));

        EXEC SQL select olsh_skip_count,
			olsh_hold_count,
			olsh_accept_count,
			olsh_total_count,
			olsh_ver,
			olsh_split_count,
			olsh_add_count,
			olsh_update_count,
			olsh_delete_count,
			olsh_file_count
               	 into 	:v_skip_count:ind_skip_count, 
			:v_hold_count:ind_hold_count,
			:v_accept_count:ind_accept_count,
			:v_total_count:ind_total_count,
			:v_ver:ind_ver,
			:v_split_count:ind_split_count,
			:v_add_count:ind_add_count,
			:v_update_count:ind_update_count,
			:v_delete_count:ind_delete_count,
			:v_file_count:ind_file_count
                 from 	ol_statement_header 
                 where 	olsh_file_id = :hv_file_id;

// skip_count
	if (ind_skip_count >= 0) {
		PutField_Int(hRec, "skip_count", v_skip_count);
DEBUGLOG(("GetSystemHeader skip_count = [%d]\n", v_skip_count));
	}

// hold_count
	if (ind_hold_count >= 0) {
		PutField_Int(hRec, "hold_count", v_hold_count);
DEBUGLOG(("GetSystemHeader hold_count = [%d]\n", v_hold_count));
	}

// accept_count
	if (ind_accept_count >= 0) {
		PutField_Int(hRec, "accept_count", v_accept_count);
DEBUGLOG(("GetSystemHeader accept_count = [%d]\n", v_accept_count));
	}

// total_count
	if (ind_total_count >= 0) {
		PutField_Int(hRec, "total_count", v_total_count);
DEBUGLOG(("GetSystemHeader total_count = [%d]\n", v_total_count));
	}

// ver
	if (ind_ver >= 0) {
		PutField_Int(hRec, "ver", v_ver);
DEBUGLOG(("GetSystemHeader ver = [%d]\n", v_ver));
	}

// split_count
	if (ind_split_count >= 0) {
		PutField_Int(hRec, "split_count", v_split_count);
DEBUGLOG(("GetSystemHeader split_count = [%d]\n", v_split_count));
	}

// add_count
	if (ind_add_count >= 0) {
		PutField_Int(hRec, "add_count", v_add_count);
DEBUGLOG(("GetSystemHeader add_count = [%d]\n", v_add_count));
	}

// update_count
	if (ind_update_count >= 0) {
		PutField_Int(hRec, "update_count", v_update_count);
DEBUGLOG(("GetSystemHeader update_count = [%d]\n", v_update_count));
	}

// delete_count
	if (ind_delete_count >= 0) {
		PutField_Int(hRec, "delete_count", v_delete_count);
DEBUGLOG(("GetSystemHeader delete_count = [%d]\n", v_delete_count));
	}

// file_count
	if (ind_file_count >= 0) {
		PutField_Int(hRec, "file_count", v_file_count);
DEBUGLOG(("GetSystemHeader file_count = [%d]\n", v_file_count));
	}

DEBUGLOG(("GetSystemHeader Normal Exit! iRet = [%d]\n", iRet));
      	return iRet;

getsystemheader_error:
DEBUGLOG(("getsystemheader_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLStatementTmp getsystemheader_error: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int UpdateSystemHeader(const hash_t *hRls)
{
        int     iTmp;
        char    *csTmp;

        EXEC SQL WHENEVER SQLERROR GOTO update_system_header_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_file_id[PD_TXN_SEQ_LEN];
                int             hv_skip_count;
                int             hv_hold_count;
                int             hv_accept_count;
                int             hv_total_count;
                int             hv_ver;
                int             hv_split_count;
                int             hv_add_count;
                int             hv_update_count;
                int             hv_delete_count;
                int             hv_file_count;
                varchar         hv_update_user[PD_USER_LEN];

                short           ind_file_id = -1;
                short           ind_skip_count = -1;
                short           ind_hold_count = -1;
                short           ind_accept_count = -1;
                short           ind_total_count = -1;
                short           ind_ver = -1;
                short           ind_split_count = -1;
                short           ind_add_count = -1;
                short           ind_update_count = -1;
                short           ind_delete_count = -1;
                short           ind_file_count = -1;
                short           ind_update_user = -1;

                short           hv_return_value;

        EXEC SQL END DECLARE SECTION;

        if(GetField_CString(hRls,"file_id",&csTmp)) {
                hv_file_id.len = strlen(csTmp);
                strncpy((char*)hv_file_id.arr, csTmp, hv_file_id.len);
                ind_file_id = 0;
DEBUGLOG(("UpdateSystemHeader:file_id = [%.*s]\n",hv_file_id.len, hv_file_id.arr));
        } else {
DEBUGLOG(("UpdateSystemHeader:file_id NOT FOUND!!!\n"));
        }

        if(GetField_Int(hRls, "skip_count", &iTmp)) {
                hv_skip_count = iTmp;
                ind_skip_count = 0;
DEBUGLOG(("UpdateSystemHeader:skip_count = [%d]\n",hv_skip_count));
        }

        if(GetField_Int(hRls, "hold_count", &iTmp)) {
                hv_hold_count = iTmp;
                ind_hold_count = 0;
DEBUGLOG(("UpdateSystemHeader:hold_count = [%d]\n",hv_hold_count));
        }

        if(GetField_Int(hRls, "accept_count", &iTmp)) {
                hv_accept_count = iTmp;
                ind_accept_count = 0;
DEBUGLOG(("UpdateSystemHeader:accept_count = [%d]\n",hv_accept_count));
        }

        if(GetField_Int(hRls, "total_count", &iTmp)) {
                hv_total_count = iTmp;
                ind_total_count = 0;
DEBUGLOG(("UpdateSystemHeader:total_count = [%d]\n",hv_total_count));
        }

        if(GetField_Int(hRls, "ver", &iTmp)) {
                hv_ver = iTmp;
                ind_ver = 0;
DEBUGLOG(("UpdateSystemHeader:ver = [%d]\n",hv_ver));
        }

        if(GetField_Int(hRls, "split_count", &iTmp)) {
                hv_split_count = iTmp;
                ind_split_count = 0;
DEBUGLOG(("UpdateSystemHeader:split_count = [%d]\n",hv_split_count));
        }

        if(GetField_Int(hRls, "add_count", &iTmp)) {
                hv_add_count = iTmp;
                ind_add_count = 0;
DEBUGLOG(("UpdateSystemHeader:add_count = [%d]\n",hv_add_count));
        }

        if(GetField_Int(hRls, "update_count", &iTmp)) {
                hv_update_count = iTmp;
                ind_update_count = 0;
DEBUGLOG(("UpdateSystemHeader:update_count = [%d]\n",hv_update_count));
        }

        if(GetField_Int(hRls, "delete_count", &iTmp)) {
                hv_delete_count = iTmp;
                ind_delete_count = 0;
DEBUGLOG(("UpdateSystemHeader:delete_count = [%d]\n",hv_delete_count));
        }

        if(GetField_Int(hRls, "file_count", &iTmp)) {
                hv_file_count = iTmp;
                ind_file_count = 0;
DEBUGLOG(("UpdateSystemHeader:file_count = [%d]\n",hv_file_count));
        }

        if(GetField_CString(hRls,"update_user",&csTmp))
        {
                hv_update_user.len = strlen(csTmp);
                strncpy((char*)hv_update_user.arr, csTmp, hv_update_user.len);
                ind_update_user = 0;
DEBUGLOG(("UpdateSystemHeader:update_user = [%.*s]\n",hv_update_user.len,hv_update_user.arr));
        } else {
DEBUGLOG(("UpdateSystemHeader:update_user NOT FOUND!!!\n"));
        }

	EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_ol_statement_tmp_sys_hd_upd(
                                                :hv_file_id:ind_file_id,
                                                :hv_skip_count:ind_skip_count,
                                                :hv_hold_count:ind_hold_count,
                                                :hv_accept_count:ind_accept_count,
                                                :hv_total_count:ind_total_count,
                                                :hv_ver:ind_ver,
                                                :hv_split_count:ind_split_count,
                                                :hv_add_count:ind_add_count,
                                                :hv_update_count:ind_update_count,
                                                :hv_delete_count:ind_delete_count,
                                                :hv_file_count:ind_file_count,
                                                :hv_update_user:ind_update_user);
                END;
        END-EXEC;

DEBUGLOG(("UpdateSystemHeader:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("UpdateSystemHeader:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR) {
ERRLOG("OLStatementTmp_UpdateSystemHeader: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateSystemHeader: SP_OTHER_ERR TxnAbort\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR) {
ERRLOG("OLStatementTmp_UpdateSystemHeader: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateSystemHeader: SP_ERR TxnAbort\n"));
                return PD_ERR;
        }

update_system_header_error:
DEBUGLOG(("update_system_header_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("OLStatementTmp_UpdateSystemHeader: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("UpdateSystemHeader: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;
}

int AddDetail(const hash_t *hRls)
{
	int	iTmp;
	char	*csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO addetail_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_file_id[PD_TXN_SEQ_LEN];
		int		hv_seq;
		int		hv_ver;
		int		hv_latest_ver;
		int		hv_disabled;
		varchar		hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar		hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		int		hv_org_sys_seq;
		int		hv_sys_seq;
		int		hv_user_seq;
		int		hv_skip;
		int		hv_mask_skip;
		varchar		hv_raw_date[PD_TMP_BUF_LEN];
		varchar		hv_raw_time[PD_TMP_BUF_LEN];
		varchar		hv_statement_date[PD_DATE_LEN];
		varchar		hv_statement_time[PD_TIME_LEN];
		varchar		hv_tfr_bank_name[PD_STMT_TMP_LEN];
		varchar		hv_tfr_bank_acct_num[PD_STMT_TMP_LEN];
		varchar		hv_tfr_type[PD_STMT_TMP_LEN];
		varchar		hv_tfr_channel[PD_STMT_TMP_LEN];
		varchar		hv_tfr_text[PD_STMT_TMP_LEN];
		varchar		hv_tfr_customer_text[PD_STMT_TMP_LEN];
		varchar		hv_sender_name[PD_STMT_TMP_LEN];
		varchar		hv_txn_ref_num[PD_STMT_TMP_LEN];
		varchar		hv_balance[PD_TMP_BUF_LEN];
		varchar		hv_amt_type[PD_TMP_BUF_LEN];
		varchar		hv_txn_amount[PD_TMP_BUF_LEN];
		varchar		hv_bank_charge[PD_TMP_BUF_LEN];
		varchar		hv_create_user[PD_USER_LEN];

		short		ind_file_id = -1;
		short		ind_seq = -1;
		short		ind_ver = -1;
		short		ind_latest_ver = -1;
		short		ind_disabled = -1;
		short		ind_int_bank_code = -1;
		short		ind_bank_acct_num = -1;
		short		ind_org_sys_seq = -1;
		short		ind_sys_seq = -1;
		short		ind_user_seq = -1;
		short		ind_skip = -1;
		short		ind_mask_skip = -1;
		short		ind_raw_date = -1;
		short		ind_raw_time = -1;
		short		ind_statement_date = -1;
		short		ind_statement_time = -1;
		short		ind_tfr_bank_name = -1;
		short		ind_tfr_bank_acct_num = -1;
		short		ind_tfr_type = -1;
		short		ind_tfr_channel = -1;
		short		ind_tfr_text = -1;
		short		ind_tfr_customer_text = -1;
		short		ind_sender_name = -1;
		short		ind_txn_ref_num = -1;
		short		ind_balance = -1;
		short		ind_amt_type = -1;
		short		ind_txn_amount = -1;
		short		ind_bank_charge = -1;
		short		ind_create_user = -1;

		short		hv_return_value;

	EXEC SQL END DECLARE SECTION;

	if (GetField_CString(hRls,"file_id",&csTmp)) {
		hv_file_id.len = strlen(csTmp);
		strncpy((char*)hv_file_id.arr,csTmp,sizeof(hv_file_id.arr));
		ind_file_id = 0;
DEBUGLOG(("AddDetail: file_id = [%.*s](%d)\n",sizeof(hv_file_id.arr),hv_file_id.arr,hv_file_id.len));
	}

	if (GetField_Int(hRls, "seq", &iTmp)) {
		hv_seq = iTmp;
		ind_seq = 0;
DEBUGLOG(("AddDetail: seq = [%d]\n",hv_seq));
	}

	if (GetField_Int(hRls, "ver", &iTmp)) {
		hv_ver = iTmp;
		ind_ver = 0;
DEBUGLOG(("AddDetail: ver = [%d]\n",hv_ver));
	}

	if (GetField_Int(hRls, "latest_ver", &iTmp)) {
		hv_latest_ver = iTmp;
		ind_latest_ver = 0;
DEBUGLOG(("AddDetail: latest_ver = [%d]\n",hv_latest_ver));
	}

	if (GetField_Int(hRls, "disabled", &iTmp)) {
		hv_disabled = iTmp;
		ind_disabled = 0;
DEBUGLOG(("AddDetail: disabled = [%d]\n",hv_disabled));
	}

	if (GetField_CString(hRls,"int_bank_code",&csTmp)) {
		hv_int_bank_code.len = strlen(csTmp);
		strncpy((char*)hv_int_bank_code.arr,csTmp,sizeof(hv_int_bank_code.arr));
		ind_int_bank_code = 0;
DEBUGLOG(("AddDetail: int_bank_code = [%.*s](%d)\n",sizeof(hv_int_bank_code.arr),hv_int_bank_code.arr,hv_int_bank_code.len));
	}

	if (GetField_CString(hRls,"bank_acct_num",&csTmp)) {
		hv_bank_acct_num.len = strlen(csTmp);
		strncpy((char*)hv_bank_acct_num.arr,csTmp,sizeof(hv_bank_acct_num.arr));
		ind_bank_acct_num = 0;
DEBUGLOG(("AddDetail: bank_acct_num = [%.*s](%d)\n",sizeof(hv_bank_acct_num.arr),hv_bank_acct_num.arr,hv_bank_acct_num.len));
	}

	if (GetField_Int(hRls, "org_sys_seq", &iTmp)) {
		hv_org_sys_seq = iTmp;
		ind_org_sys_seq = 0;
DEBUGLOG(("AddDetail: org_sys_seq = [%d]\n",hv_org_sys_seq));
	}

	if (GetField_Int(hRls, "sys_seq", &iTmp)) {
		hv_sys_seq = iTmp;
		ind_sys_seq = 0;
DEBUGLOG(("AddDetail: sys_seq = [%d]\n",hv_sys_seq));
	}

	if (GetField_Int(hRls, "user_seq", &iTmp)) {
		hv_user_seq = iTmp;
		ind_user_seq = 0;
DEBUGLOG(("AddDetail: user_seq = [%d]\n",hv_user_seq));
	}

	if (GetField_Int(hRls, "skip", &iTmp)) {
		hv_skip = iTmp;
		ind_skip = 0;
DEBUGLOG(("AddDetail: skip = [%d]\n",hv_skip));
	}

	if (GetField_Int(hRls, "mask_skip", &iTmp)) {
		hv_mask_skip = iTmp;
		ind_mask_skip = 0;
DEBUGLOG(("AddDetail: mask_skip = [%d]\n",hv_mask_skip));
	}

	if (GetField_CString(hRls,"raw_date",&csTmp)) {
		hv_raw_date.len = strlen(csTmp);
		strncpy((char*)hv_raw_date.arr,csTmp,sizeof(hv_raw_date.arr));
		ind_raw_date = 0;
DEBUGLOG(("AddDetail: raw_date = [%.*s](%d)\n",sizeof(hv_raw_date.arr),hv_raw_date.arr,hv_raw_date.len));
	}

	if (GetField_CString(hRls,"raw_time",&csTmp)) {
		hv_raw_time.len = strlen(csTmp);
		strncpy((char*)hv_raw_time.arr,csTmp,sizeof(hv_raw_time.arr));
		ind_raw_time = 0;
DEBUGLOG(("AddDetail: raw_time = [%.*s](%d)\n",sizeof(hv_raw_time.arr),hv_raw_time.arr,hv_raw_time.len));
	}

	if (GetField_CString(hRls,"statement_date",&csTmp)) {
		hv_statement_date.len = strlen(csTmp);
		strncpy((char*)hv_statement_date.arr,csTmp,sizeof(hv_statement_date.arr));
		ind_statement_date = 0;
DEBUGLOG(("AddDetail: statement_date = [%.*s](%d)\n",sizeof(hv_statement_date.arr),hv_statement_date.arr,hv_statement_date.len));
	}

	if (GetField_CString(hRls,"statement_time",&csTmp)) {
		hv_statement_time.len = strlen(csTmp);
		strncpy((char*)hv_statement_time.arr,csTmp,sizeof(hv_statement_time.arr));
		ind_statement_time = 0;
DEBUGLOG(("AddDetail: statement_time = [%.*s](%d)\n",sizeof(hv_statement_time.arr),hv_statement_time.arr,hv_statement_time.len));
	}

	if (GetField_CString(hRls,"tfr_bank_name",&csTmp)) {
		hv_tfr_bank_name.len = strlen(csTmp);
		strncpy((char*)hv_tfr_bank_name.arr,csTmp,sizeof(hv_tfr_bank_name.arr));
		ind_tfr_bank_name = 0;
DEBUGLOG(("AddDetail: tfr_bank_name = [%.*s](%d)\n",sizeof(hv_tfr_bank_name.arr),hv_tfr_bank_name.arr,hv_tfr_bank_name.len));
	}

	if (GetField_CString(hRls,"tfr_bank_acct_num",&csTmp)) {
		hv_tfr_bank_acct_num.len = strlen(csTmp);
		strncpy((char*)hv_tfr_bank_acct_num.arr,csTmp,sizeof(hv_tfr_bank_acct_num.arr));
		ind_tfr_bank_acct_num = 0;
DEBUGLOG(("AddDetail: tfr_bank_acct_num = [%.*s](%d)\n",sizeof(hv_tfr_bank_acct_num.arr),hv_tfr_bank_acct_num.arr,hv_tfr_bank_acct_num.len));
	}

	if (GetField_CString(hRls,"tfr_type",&csTmp)) {
		hv_tfr_type.len = strlen(csTmp);
		strncpy((char*)hv_tfr_type.arr,csTmp,sizeof(hv_tfr_type.arr));
		ind_tfr_type = 0;
DEBUGLOG(("AddDetail: tfr_type = [%.*s](%d)\n",sizeof(hv_tfr_type.arr),hv_tfr_type.arr,hv_tfr_type.len));
	}

	if (GetField_CString(hRls,"tfr_channel",&csTmp)) {
		hv_tfr_channel.len = strlen(csTmp);
		strncpy((char*)hv_tfr_channel.arr,csTmp,sizeof(hv_tfr_channel.arr));
		ind_tfr_channel = 0;
DEBUGLOG(("AddDetail: tfr_channel = [%.*s](%d)\n",sizeof(hv_tfr_channel.arr),hv_tfr_channel.arr,hv_tfr_channel.len));
	}

	if (GetField_CString(hRls,"tfr_text",&csTmp)) {
		hv_tfr_text.len = strlen(csTmp);
		strncpy((char*)hv_tfr_text.arr,csTmp,sizeof(hv_tfr_text.arr));
		ind_tfr_text = 0;
DEBUGLOG(("AddDetail: tfr_text = [%.*s](%d)\n",sizeof(hv_tfr_text.arr),hv_tfr_text.arr,hv_tfr_text.len));
	}

	if (GetField_CString(hRls,"tfr_customer_text",&csTmp)) {
		hv_tfr_customer_text.len = strlen(csTmp);
		strncpy((char*)hv_tfr_customer_text.arr,csTmp,sizeof(hv_tfr_customer_text.arr));
		ind_tfr_customer_text = 0;
DEBUGLOG(("AddDetail: tfr_customer_text = [%.*s](%d)\n",sizeof(hv_tfr_customer_text.arr),hv_tfr_customer_text.arr,hv_tfr_customer_text.len));
	}

	if (GetField_CString(hRls,"sender_name",&csTmp)) {
		hv_sender_name.len = strlen(csTmp);
		strncpy((char*)hv_sender_name.arr,csTmp,sizeof(hv_sender_name.arr));
		ind_sender_name = 0;
DEBUGLOG(("AddDetail: sender_name = [%.*s](%d)\n",sizeof(hv_sender_name.arr),hv_sender_name.arr,hv_sender_name.len));
	}

	if (GetField_CString(hRls,"txn_ref_num",&csTmp)) {
		hv_txn_ref_num.len = strlen(csTmp);
		strncpy((char*)hv_txn_ref_num.arr,csTmp,sizeof(hv_txn_ref_num.arr));
		ind_txn_ref_num = 0;
DEBUGLOG(("AddDetail: txn_ref_num = [%.*s](%d)\n",sizeof(hv_txn_ref_num.arr),hv_txn_ref_num.arr,hv_txn_ref_num.len));
	}

	if (GetField_CString(hRls,"org_balance",&csTmp)) {
		hv_balance.len = strlen(csTmp);
		strncpy((char*)hv_balance.arr,csTmp,sizeof(hv_balance.arr));
		ind_balance = 0;
DEBUGLOG(("AddDetail: org_balance = [%.*s](%d)\n",sizeof(hv_balance.arr),hv_balance.arr,hv_balance.len));
	} else if (GetField_CString(hRls,"balance",&csTmp)) {
		hv_balance.len = strlen(csTmp);
		strncpy((char*)hv_balance.arr,csTmp,sizeof(hv_balance.arr));
		ind_balance = 0;
DEBUGLOG(("AddDetail: balance = [%.*s](%d)\n",sizeof(hv_balance.arr),hv_balance.arr,hv_balance.len));
	}

	if (GetField_CString(hRls,"amt_type",&csTmp)) {
		hv_amt_type.len = strlen(csTmp);
		strncpy((char*)hv_amt_type.arr,csTmp,sizeof(hv_amt_type.arr));
		ind_amt_type = 0;
DEBUGLOG(("AddDetail: amt_type = [%.*s](%d)\n",sizeof(hv_amt_type.arr),hv_amt_type.arr,hv_amt_type.len));
	}

	if (GetField_CString(hRls,"org_txn_amount",&csTmp)) {
		hv_txn_amount.len = strlen(csTmp);
		strncpy((char*)hv_txn_amount.arr,csTmp,sizeof(hv_txn_amount.arr));
		ind_txn_amount = 0;
DEBUGLOG(("AddDetail: org_txn_amount = [%.*s](%d)\n",sizeof(hv_txn_amount.arr),hv_txn_amount.arr,hv_txn_amount.len));
	} else if (GetField_CString(hRls,"txn_amount",&csTmp)) {
		hv_txn_amount.len = strlen(csTmp);
		strncpy((char*)hv_txn_amount.arr,csTmp,sizeof(hv_txn_amount.arr));
		ind_txn_amount = 0;
DEBUGLOG(("AddDetail: txn_amount = [%.*s](%d)\n",sizeof(hv_txn_amount.arr),hv_txn_amount.arr,hv_txn_amount.len));
	}

	if (GetField_CString(hRls,"bank_charge",&csTmp)) {
		hv_bank_charge.len = strlen(csTmp);
		strncpy((char*)hv_bank_charge.arr,csTmp,sizeof(hv_bank_charge.arr));
		ind_bank_charge = 0;
DEBUGLOG(("AddDetail: bank_charge = [%.*s](%d)\n",sizeof(hv_bank_charge.arr),hv_bank_charge.arr,hv_bank_charge.len));
	}

	if (GetField_CString(hRls,"create_user",&csTmp)) {
		hv_create_user.len = strlen(csTmp);
		strncpy((char*)hv_create_user.arr,csTmp,sizeof(hv_create_user.arr));
		ind_create_user = 0;
DEBUGLOG(("AddDetail: create_user = [%.*s](%d)\n",sizeof(hv_create_user.arr),hv_create_user.arr,hv_create_user.len));
	}

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_statement_tmp_insert(
						:hv_file_id:ind_file_id,
						:hv_seq:ind_seq,
						:hv_ver:ind_ver,
						:hv_latest_ver:ind_latest_ver,
						:hv_disabled:ind_disabled,
						:hv_int_bank_code:ind_int_bank_code,
						:hv_bank_acct_num:ind_bank_acct_num,
						:hv_org_sys_seq:ind_org_sys_seq,
						:hv_sys_seq:ind_sys_seq,
						:hv_user_seq:ind_user_seq,
						:hv_skip:ind_skip,
						:hv_mask_skip:ind_mask_skip,
						:hv_raw_date:ind_raw_date,
						:hv_raw_time:ind_raw_time,
						:hv_statement_date:ind_statement_date,
						:hv_statement_time:ind_statement_time,
						:hv_tfr_bank_name:ind_tfr_bank_name,
						:hv_tfr_bank_acct_num:ind_tfr_bank_acct_num,
						:hv_tfr_type:ind_tfr_type,
						:hv_tfr_channel:ind_tfr_channel,
						:hv_tfr_text:ind_tfr_text,
						:hv_tfr_customer_text:ind_tfr_customer_text,
						:hv_sender_name:ind_sender_name,
						:hv_txn_ref_num:ind_txn_ref_num,
						:hv_balance:ind_balance,
						:hv_amt_type:ind_amt_type,
						:hv_txn_amount:ind_txn_amount,
						:hv_bank_charge:ind_bank_charge,
						:hv_create_user:ind_create_user);
		END;
	END-EXEC;

	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("AddDetail: Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR) {
ERRLOG("OLStatementTmp_AddDetail: SP_OTHER_ERR\n");
DEBUGLOG(("AddDetail: SP_OTHER_ERR\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR) {
ERRLOG("OLStatementTmp_AddDetail: SP_ERR\n");
DEBUGLOG(("AddDetail: SP_ERR\n"));
		return PD_ERR;
	}

addetail_error:
DEBUGLOG(("addetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
DEBUGLOG(("AddDetail: SP_INTERNAL_ERR TxnAbort\n"));
ERRLOG("OLStatementTmp_AddDetail: SP_INTERNAL_ERR TxnAbort\n");
	TxnAbort();
	return PD_INTERNAL_ERR;
}

int UpdateDetail(const hash_t *hRls)
{
	int	iTmp;
	char	*csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO updatedetail_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_file_id[PD_TXN_SEQ_LEN];
		int		hv_seq;
		int		hv_ver;
		int		hv_latest_ver;
		int		hv_disabled;
		varchar		hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar		hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		int		hv_org_sys_seq;
		int		hv_sys_seq;
		int		hv_user_seq;
		int		hv_skip;
		int		hv_mask_skip;
		varchar		hv_raw_date[PD_TMP_BUF_LEN];
		varchar		hv_raw_time[PD_TMP_BUF_LEN];
		varchar		hv_statement_date[PD_DATE_LEN];
		varchar		hv_statement_time[PD_TIME_LEN];
		varchar		hv_tfr_bank_name[PD_STMT_TMP_LEN];
		varchar		hv_tfr_bank_acct_num[PD_STMT_TMP_LEN];
		varchar		hv_tfr_type[PD_STMT_TMP_LEN];
		varchar		hv_tfr_channel[PD_STMT_TMP_LEN];
		varchar		hv_tfr_text[PD_STMT_TMP_LEN];
		varchar		hv_tfr_customer_text[PD_STMT_TMP_LEN];
		varchar		hv_sender_name[PD_STMT_TMP_LEN];
		varchar		hv_txn_ref_num[PD_STMT_TMP_LEN];
		varchar		hv_balance[PD_TMP_BUF_LEN];
		varchar		hv_amt_type[PD_TMP_BUF_LEN];
		varchar		hv_txn_amount[PD_TMP_BUF_LEN];
		varchar		hv_bank_charge[PD_TMP_BUF_LEN];
		varchar		hv_create_user[PD_USER_LEN];
		varchar		hv_create_timestamp[PD_TIMESTAMP_LEN];
		varchar		hv_update_user[PD_USER_LEN];

		short		ind_file_id = -1;
		short		ind_seq = -1;
		short		ind_ver = -1;
		short		ind_latest_ver = -1;
		short		ind_disabled = -1;
		short		ind_int_bank_code = -1;
		short		ind_bank_acct_num = -1;
		short		ind_org_sys_seq = -1;
		short		ind_sys_seq = -1;
		short		ind_user_seq = -1;
		short		ind_skip = -1;
		short		ind_mask_skip = -1;
		short		ind_raw_date = -1;
		short		ind_raw_time = -1;
		short		ind_statement_date = -1;
		short		ind_statement_time = -1;
		short		ind_tfr_bank_name = -1;
		short		ind_tfr_bank_acct_num = -1;
		short		ind_tfr_type = -1;
		short		ind_tfr_channel = -1;
		short		ind_tfr_text = -1;
		short		ind_tfr_customer_text = -1;
		short		ind_sender_name = -1;
		short		ind_txn_ref_num = -1;
		short		ind_balance = -1;
		short		ind_amt_type = -1;
		short		ind_txn_amount = -1;
		short		ind_bank_charge = -1;
		short		ind_create_user = -1;
		short		ind_create_timestamp = -1;
		short		ind_update_user = -1;

		short		hv_return_value;

	EXEC SQL END DECLARE SECTION;

	if (GetField_CString(hRls,"file_id",&csTmp)) {
		hv_file_id.len = strlen(csTmp);
		strncpy((char*)hv_file_id.arr,csTmp,sizeof(hv_file_id.arr));
		ind_file_id = 0;
DEBUGLOG(("UpdateDetail: file_id = [%.*s](%d)\n",sizeof(hv_file_id.arr),hv_file_id.arr,hv_file_id.len));
	}

	if (GetField_Int(hRls, "seq", &iTmp)) {
		hv_seq = iTmp;
		ind_seq = 0;
DEBUGLOG(("UpdateDetail: seq = [%d]\n",hv_seq));
	}

	if (GetField_Int(hRls, "ver", &iTmp)) {
		hv_ver = iTmp;
		ind_ver = 0;
DEBUGLOG(("UpdateDetail: ver = [%d]\n",hv_ver));
	}

	if (GetField_Int(hRls, "latest_ver", &iTmp)) {
		hv_latest_ver = iTmp;
		ind_latest_ver = 0;
DEBUGLOG(("UpdateDetail: latest_ver = [%d]\n",hv_latest_ver));
	}

	if (GetField_Int(hRls, "disabled", &iTmp)) {
		hv_disabled = iTmp;
		ind_disabled = 0;
DEBUGLOG(("UpdateDetail: disabled = [%d]\n",hv_disabled));
	}

	if (GetField_CString(hRls,"int_bank_code",&csTmp)) {
		hv_int_bank_code.len = strlen(csTmp);
		strncpy((char*)hv_int_bank_code.arr,csTmp,sizeof(hv_int_bank_code.arr));
		ind_int_bank_code = 0;
DEBUGLOG(("UpdateDetail: int_bank_code = [%.*s](%d)\n",sizeof(hv_int_bank_code.arr),hv_int_bank_code.arr,hv_int_bank_code.len));
	}

	if (GetField_CString(hRls,"bank_acct_num",&csTmp)) {
		hv_bank_acct_num.len = strlen(csTmp);
		strncpy((char*)hv_bank_acct_num.arr,csTmp,sizeof(hv_bank_acct_num.arr));
		ind_bank_acct_num = 0;
DEBUGLOG(("UpdateDetail: bank_acct_num = [%.*s](%d)\n",sizeof(hv_bank_acct_num.arr),hv_bank_acct_num.arr,hv_bank_acct_num.len));
	}

	if (GetField_Int(hRls, "org_sys_seq", &iTmp)) {
		hv_org_sys_seq = iTmp;
		ind_org_sys_seq = 0;
DEBUGLOG(("UpdateDetail: org_sys_seq = [%d]\n",hv_org_sys_seq));
	}

	if (GetField_Int(hRls, "sys_seq", &iTmp)) {
		hv_sys_seq = iTmp;
		ind_sys_seq = 0;
DEBUGLOG(("UpdateDetail: sys_seq = [%d]\n",hv_sys_seq));
	}

	if (GetField_Int(hRls, "user_seq", &iTmp)) {
		hv_user_seq = iTmp;
		ind_user_seq = 0;
DEBUGLOG(("UpdateDetail: user_seq = [%d]\n",hv_user_seq));
	}

	if (GetField_Int(hRls, "skip", &iTmp)) {
		hv_skip = iTmp;
		ind_skip = 0;
DEBUGLOG(("UpdateDetail: skip = [%d]\n",hv_skip));
	}

	if (GetField_Int(hRls, "mask_skip", &iTmp)) {
		hv_mask_skip = iTmp;
		ind_mask_skip = 0;
DEBUGLOG(("UpdateDetail: mask_skip = [%d]\n",hv_mask_skip));
	}

	if (GetField_CString(hRls,"raw_date",&csTmp)) {
		hv_raw_date.len = strlen(csTmp);
		strncpy((char*)hv_raw_date.arr,csTmp,sizeof(hv_raw_date.arr));
		ind_raw_date = 0;
DEBUGLOG(("UpdateDetail: raw_date = [%.*s](%d)\n",sizeof(hv_raw_date.arr),hv_raw_date.arr,hv_raw_date.len));
	}

	if (GetField_CString(hRls,"raw_time",&csTmp)) {
		hv_raw_time.len = strlen(csTmp);
		strncpy((char*)hv_raw_time.arr,csTmp,sizeof(hv_raw_time.arr));
		ind_raw_time = 0;
DEBUGLOG(("UpdateDetail: raw_time = [%.*s](%d)\n",sizeof(hv_raw_time.arr),hv_raw_time.arr,hv_raw_time.len));
	}

	if (GetField_CString(hRls,"statement_date",&csTmp)) {
		hv_statement_date.len = strlen(csTmp);
		strncpy((char*)hv_statement_date.arr,csTmp,sizeof(hv_statement_date.arr));
		ind_statement_date = 0;
DEBUGLOG(("UpdateDetail: statement_date = [%.*s](%d)\n",sizeof(hv_statement_date.arr),hv_statement_date.arr,hv_statement_date.len));
	}

	if (GetField_CString(hRls,"statement_time",&csTmp)) {
		hv_statement_time.len = strlen(csTmp);
		strncpy((char*)hv_statement_time.arr,csTmp,sizeof(hv_statement_time.arr));
		ind_statement_time = 0;
DEBUGLOG(("UpdateDetail: statement_time = [%.*s](%d)\n",sizeof(hv_statement_time.arr),hv_statement_time.arr,hv_statement_time.len));
	}

	if (GetField_CString(hRls,"tfr_bank_name",&csTmp)) {
		hv_tfr_bank_name.len = strlen(csTmp);
		strncpy((char*)hv_tfr_bank_name.arr,csTmp,sizeof(hv_tfr_bank_name.arr));
		ind_tfr_bank_name = 0;
DEBUGLOG(("UpdateDetail: tfr_bank_name = [%.*s](%d)\n",sizeof(hv_tfr_bank_name.arr),hv_tfr_bank_name.arr,hv_tfr_bank_name.len));
	}

	if (GetField_CString(hRls,"tfr_bank_acct_num",&csTmp)) {
		hv_tfr_bank_acct_num.len = strlen(csTmp);
		strncpy((char*)hv_tfr_bank_acct_num.arr,csTmp,sizeof(hv_tfr_bank_acct_num.arr));
		ind_tfr_bank_acct_num = 0;
DEBUGLOG(("UpdateDetail: tfr_bank_acct_num = [%.*s](%d)\n",sizeof(hv_tfr_bank_acct_num.arr),hv_tfr_bank_acct_num.arr,hv_tfr_bank_acct_num.len));
	}

	if (GetField_CString(hRls,"tfr_type",&csTmp)) {
		hv_tfr_type.len = strlen(csTmp);
		strncpy((char*)hv_tfr_type.arr,csTmp,sizeof(hv_tfr_type.arr));
		ind_tfr_type = 0;
DEBUGLOG(("UpdateDetail: tfr_type = [%.*s](%d)\n",sizeof(hv_tfr_type.arr),hv_tfr_type.arr,hv_tfr_type.len));
	}

	if (GetField_CString(hRls,"tfr_channel",&csTmp)) {
		hv_tfr_channel.len = strlen(csTmp);
		strncpy((char*)hv_tfr_channel.arr,csTmp,sizeof(hv_tfr_channel.arr));
		ind_tfr_channel = 0;
DEBUGLOG(("UpdateDetail: tfr_channel = [%.*s](%d)\n",sizeof(hv_tfr_channel.arr),hv_tfr_channel.arr,hv_tfr_channel.len));
	}

	if (GetField_CString(hRls,"tfr_text",&csTmp)) {
		hv_tfr_text.len = strlen(csTmp);
		strncpy((char*)hv_tfr_text.arr,csTmp,sizeof(hv_tfr_text.arr));
		ind_tfr_text = 0;
DEBUGLOG(("UpdateDetail: tfr_text = [%.*s](%d)\n",sizeof(hv_tfr_text.arr),hv_tfr_text.arr,hv_tfr_text.len));
	}

	if (GetField_CString(hRls,"tfr_customer_text",&csTmp)) {
		hv_tfr_customer_text.len = strlen(csTmp);
		strncpy((char*)hv_tfr_customer_text.arr,csTmp,sizeof(hv_tfr_customer_text.arr));
		ind_tfr_customer_text = 0;
DEBUGLOG(("UpdateDetail: tfr_customer_text = [%.*s](%d)\n",sizeof(hv_tfr_customer_text.arr),hv_tfr_customer_text.arr,hv_tfr_customer_text.len));
	}

	if (GetField_CString(hRls,"sender_name",&csTmp)) {
		hv_sender_name.len = strlen(csTmp);
		strncpy((char*)hv_sender_name.arr,csTmp,sizeof(hv_sender_name.arr));
		ind_sender_name = 0;
DEBUGLOG(("UpdateDetail: sender_name = [%.*s](%d)\n",sizeof(hv_sender_name.arr),hv_sender_name.arr,hv_sender_name.len));
	}

	if (GetField_CString(hRls,"txn_ref_num",&csTmp)) {
		hv_txn_ref_num.len = strlen(csTmp);
		strncpy((char*)hv_txn_ref_num.arr,csTmp,sizeof(hv_txn_ref_num.arr));
		ind_txn_ref_num = 0;
DEBUGLOG(("UpdateDetail: txn_ref_num = [%.*s](%d)\n",sizeof(hv_txn_ref_num.arr),hv_txn_ref_num.arr,hv_txn_ref_num.len));
	}

	if (GetField_CString(hRls,"org_balance",&csTmp)) {
		hv_balance.len = strlen(csTmp);
		strncpy((char*)hv_balance.arr,csTmp,sizeof(hv_balance.arr));
		ind_balance = 0;
DEBUGLOG(("UpdateDetail: org_balance = [%.*s](%d)\n",sizeof(hv_balance.arr),hv_balance.arr,hv_balance.len));
	} else if (GetField_CString(hRls,"balance",&csTmp)) {
		hv_balance.len = strlen(csTmp);
		strncpy((char*)hv_balance.arr,csTmp,sizeof(hv_balance.arr));
		ind_balance = 0;
DEBUGLOG(("UpdateDetail: balance = [%.*s](%d)\n",sizeof(hv_balance.arr),hv_balance.arr,hv_balance.len));
	}

	if (GetField_CString(hRls,"amt_type",&csTmp)) {
		hv_amt_type.len = strlen(csTmp);
		strncpy((char*)hv_amt_type.arr,csTmp,sizeof(hv_amt_type.arr));
		ind_amt_type = 0;
DEBUGLOG(("UpdateDetail: amt_type = [%.*s](%d)\n",sizeof(hv_amt_type.arr),hv_amt_type.arr,hv_amt_type.len));
	}

	if (GetField_CString(hRls,"org_txn_amount",&csTmp)) {
		hv_txn_amount.len = strlen(csTmp);
		strncpy((char*)hv_txn_amount.arr,csTmp,sizeof(hv_txn_amount.arr));
		ind_txn_amount = 0;
DEBUGLOG(("UpdateDetail: org_txn_amount = [%.*s](%d)\n",sizeof(hv_txn_amount.arr),hv_txn_amount.arr,hv_txn_amount.len));
	} else if (GetField_CString(hRls,"txn_amount",&csTmp)) {
		hv_txn_amount.len = strlen(csTmp);
		strncpy((char*)hv_txn_amount.arr,csTmp,sizeof(hv_txn_amount.arr));
		ind_txn_amount = 0;
DEBUGLOG(("UpdateDetail: txn_amount = [%.*s](%d)\n",sizeof(hv_txn_amount.arr),hv_txn_amount.arr,hv_txn_amount.len));
	}

	if (GetField_CString(hRls,"bank_charge",&csTmp)) {
		hv_bank_charge.len = strlen(csTmp);
		strncpy((char*)hv_bank_charge.arr,csTmp,sizeof(hv_bank_charge.arr));
		ind_bank_charge = 0;
DEBUGLOG(("UpdateDetail: bank_charge = [%.*s](%d)\n",sizeof(hv_bank_charge.arr),hv_bank_charge.arr,hv_bank_charge.len));
	}

	if (GetField_CString(hRls,"create_user",&csTmp)) {
		hv_create_user.len = strlen(csTmp);
		strncpy((char*)hv_create_user.arr,csTmp,sizeof(hv_create_user.arr));
		ind_create_user = 0;
DEBUGLOG(("UpdateDetail: create_user = [%.*s](%d)\n",sizeof(hv_create_user.arr),hv_create_user.arr,hv_create_user.len));
	}

	if (GetField_CString(hRls,"create_timestamp",&csTmp)) {
		hv_create_timestamp.len = strlen(csTmp);
		strncpy((char*)hv_create_timestamp.arr,csTmp,sizeof(hv_create_timestamp.arr));
		ind_create_timestamp = 0;
DEBUGLOG(("UpdateDetail: create_timestamp = [%.*s](%d)\n",sizeof(hv_create_timestamp.arr),hv_create_timestamp.arr,hv_create_timestamp.len));
	}

	if (GetField_CString(hRls,"update_user",&csTmp)) {
		hv_update_user.len = strlen(csTmp);
		strncpy((char*)hv_update_user.arr,csTmp,sizeof(hv_update_user.arr));
		ind_update_user = 0;
DEBUGLOG(("UpdateDetail: update_user = [%.*s](%d)\n",sizeof(hv_update_user.arr),hv_update_user.arr,hv_update_user.len));
	}

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_statement_tmp_update(
						:hv_file_id:ind_file_id,
						:hv_seq:ind_seq,
						:hv_ver:ind_ver,
						:hv_latest_ver:ind_latest_ver,
						:hv_disabled:ind_disabled,
						:hv_int_bank_code:ind_int_bank_code,
						:hv_bank_acct_num:ind_bank_acct_num,
						:hv_org_sys_seq:ind_org_sys_seq,
						:hv_sys_seq:ind_sys_seq,
						:hv_user_seq:ind_user_seq,
						:hv_skip:ind_skip,
						:hv_mask_skip:ind_mask_skip,
						:hv_raw_date:ind_raw_date,
						:hv_raw_time:ind_raw_time,
						:hv_statement_date:ind_statement_date,
						:hv_statement_time:ind_statement_time,
						:hv_tfr_bank_name:ind_tfr_bank_name,
						:hv_tfr_bank_acct_num:ind_tfr_bank_acct_num,
						:hv_tfr_type:ind_tfr_type,
						:hv_tfr_channel:ind_tfr_channel,
						:hv_tfr_text:ind_tfr_text,
						:hv_tfr_customer_text:ind_tfr_customer_text,
						:hv_sender_name:ind_sender_name,
						:hv_txn_ref_num:ind_txn_ref_num,
						:hv_balance:ind_balance,
						:hv_amt_type:ind_amt_type,
						:hv_txn_amount:ind_txn_amount,
						:hv_bank_charge:ind_bank_charge,
						:hv_create_user:ind_create_user,
						:hv_create_timestamp:ind_create_timestamp,
						:hv_update_user:ind_update_user);
		END;
	END-EXEC;

	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdateDetail: Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR) {
ERRLOG("OLStatementTmp_UpdateDetail: SP_OTHER_ERR\n");
DEBUGLOG(("UpdateDetail: SP_OTHER_ERR\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR) {
ERRLOG("OLStatementTmp_UpdateDetail: SP_ERR\n");
DEBUGLOG(("UpdateDetail: SP_ERR\n"));
		return PD_ERR;
	}

updatedetail_error:
DEBUGLOG(("updatedetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
DEBUGLOG(("UpdateDetail: SP_INTERNAL_ERR TxnAbort\n"));
ERRLOG("OLStatementTmp_UpdateDetail: SP_INTERNAL_ERR TxnAbort\n");
	TxnAbort();
	return PD_INTERNAL_ERR;
}

int UpdateSystemDetail(const hash_t *hRls)
{
	int	iTmp;
	char	*csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO updatesysdetail_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_file_id[PD_TXN_SEQ_LEN];
		int		hv_seq;
		int		hv_ver;
		int		hv_sys_seq;
		int		hv_skip;
		varchar		hv_statement_date[PD_DATE_LEN];
		varchar		hv_statement_time[PD_TIME_LEN];

		short		ind_file_id = -1;
		short		ind_seq = -1;
		short		ind_ver = -1;
		short		ind_sys_seq = -1;
		short		ind_skip = -1;
		short		ind_statement_date = -1;
		short		ind_statement_time = -1;

		short		hv_return_value;

	EXEC SQL END DECLARE SECTION;

	if (GetField_CString(hRls,"file_id",&csTmp)) {
		hv_file_id.len = strlen(csTmp);
		strncpy((char*)hv_file_id.arr,csTmp,sizeof(hv_file_id.arr));
		ind_file_id = 0;
DEBUGLOG(("UpdateSystemDetail: file_id = [%.*s](%d)\n",sizeof(hv_file_id.arr),hv_file_id.arr,hv_file_id.len));
	}

	if (GetField_Int(hRls, "seq", &iTmp)) {
		hv_seq = iTmp;
		ind_seq = 0;
DEBUGLOG(("UpdateSystemDetail: seq = [%d]\n",hv_seq));
	}

	if (GetField_Int(hRls, "ver", &iTmp)) {
		hv_ver = iTmp;
		ind_ver = 0;
DEBUGLOG(("UpdateSystemDetail: ver = [%d]\n",hv_ver));
	}

	if (GetField_Int(hRls, "sys_seq", &iTmp)) {
		hv_sys_seq = iTmp;
		ind_sys_seq = 0;
DEBUGLOG(("UpdateSystemDetail: sys_seq = [%d]\n",hv_sys_seq));
	}

	if (GetField_Int(hRls, "skip", &iTmp)) {
		hv_skip = iTmp;
		ind_skip = 0;
DEBUGLOG(("UpdateSystemDetail: skip = [%d]\n",hv_skip));
	}

	if (GetField_CString(hRls,"statement_date",&csTmp)) {
		hv_statement_date.len = strlen(csTmp);
		strncpy((char*)hv_statement_date.arr,csTmp,sizeof(hv_statement_date.arr));
		ind_statement_date = 0;
DEBUGLOG(("UpdateSystemDetail: statement_date = [%.*s](%d)\n",sizeof(hv_statement_date.arr),hv_statement_date.arr,hv_statement_date.len));
	}

	if (GetField_CString(hRls,"statement_time",&csTmp)) {
		hv_statement_time.len = strlen(csTmp);
		strncpy((char*)hv_statement_time.arr,csTmp,sizeof(hv_statement_time.arr));
		ind_statement_time = 0;
DEBUGLOG(("UpdateSystemDetail: statement_time = [%.*s](%d)\n",sizeof(hv_statement_time.arr),hv_statement_time.arr,hv_statement_time.len));
	}

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_statement_tmp_sysupd(
						:hv_file_id:ind_file_id,
						:hv_seq:ind_seq,
						:hv_ver:ind_ver,
						:hv_sys_seq:ind_sys_seq,
						:hv_skip:ind_skip,
						:hv_statement_date:ind_statement_date,
						:hv_statement_time:ind_statement_time);
		END;
	END-EXEC;

	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdateSystemDetail: Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR) {
ERRLOG("OLStatementTmp_UpdateSystemDetail: SP_OTHER_ERR\n");
DEBUGLOG(("UpdateSystemDetail: SP_OTHER_ERR\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR) {
ERRLOG("OLStatementTmp_UpdateSystemDetail: SP_ERR\n");
DEBUGLOG(("UpdateSystemDetail: SP_ERR\n"));
		return PD_ERR;
	}

updatesysdetail_error:
DEBUGLOG(("updatesysdetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
DEBUGLOG(("UpdateSystemDetail: SP_INTERNAL_ERR TxnAbort\n"));
ERRLOG("OLStatementTmp_UpdateSystemDetail: SP_INTERNAL_ERR TxnAbort\n");
	TxnAbort();
	return PD_INTERNAL_ERR;
}

int DisableAllDetail(const hash_t* hRls)
{
        int iRet = PD_OK;
	char *csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO checktmprecord_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_file_id[PD_TXN_SEQ_LEN];

		short		ind_file_id = -1;

        EXEC SQL END DECLARE SECTION;

	if (GetField_CString(hRls,"file_id",&csTmp)) {
		hv_file_id.len = strlen(csTmp);
		strncpy((char*)hv_file_id.arr,csTmp,sizeof(hv_file_id.arr));
		ind_file_id = 0;
DEBUGLOG(("DisableAllDetail: file_id = [%.*s](%d)\n",sizeof(hv_file_id.arr),hv_file_id.arr,hv_file_id.len));
	}

	EXEC SQL UPDATE OL_STATEMENT_TMP
		SET OLST_DISABLED = 1
		WHERE	OLST_FILE_ID = :hv_file_id:ind_file_id;

DEBUGLOG(("DisableAllDetail() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;

checktmprecord_error:
DEBUGLOG(("checktmprecord_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int GetDetail(const char* csFileId, int iVer, recordset_t* myRec)
{
	int	iRet = NOT_FOUND;

	int	iCnt = 0;
	hash_t	*myHash;

	EXEC SQL WHENEVER SQLERROR GOTO getdetail_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_file_id[PD_TXN_SEQ_LEN];
		int		hv_ver;

		varchar		v_file_id[PD_TXN_SEQ_LEN + 1];
		int		v_seq;
		int		v_ver;
		int		v_latest_ver;
		varchar		v_int_bank_code[PD_BANK_CODE_LEN + 1];
		varchar		v_bank_acct_num[PD_BANK_ACCT_NUM_LEN + 1];
		int		v_org_sys_seq;
		int		v_sys_seq;
		int		v_user_seq;
		int		v_skip;
		int		v_mask_skip;
		varchar		v_raw_date[PD_TMP_BUF_LEN + 1];
		varchar		v_raw_time[PD_TMP_BUF_LEN + 1];
		varchar		v_tfr_bank_name[PD_STMT_TMP_LEN + 1];
		varchar		v_tfr_bank_acct_num[PD_STMT_TMP_LEN + 1];
		varchar		v_tfr_type[PD_STMT_TMP_LEN + 1];
		varchar		v_tfr_channel[PD_STMT_TMP_LEN + 1];
		varchar		v_tfr_text[PD_STMT_TMP_LEN + 1];
		varchar		v_tfr_customer_text[PD_STMT_TMP_LEN + 1];
		varchar		v_sender_name[PD_STMT_TMP_LEN + 1];
		varchar		v_txn_ref_num[PD_STMT_TMP_LEN + 1];
		varchar		v_balance[PD_TMP_BUF_LEN + 1];
		varchar		v_amt_type[PD_TMP_BUF_LEN + 1];
		varchar		v_txn_amount[PD_TMP_BUF_LEN + 1];
		varchar		v_bank_charge[PD_TMP_BUF_LEN + 1];
		varchar		v_create_user[PD_USER_LEN + 1];
		varchar		v_create_timestamp[PD_TIMESTAMP_LEN + 1];

		short		ind_file_id = -1;
		short		ind_seq = -1;
		short		ind_ver = -1;
		short		ind_latest_ver = -1;
		short		ind_int_bank_code = -1;
		short		ind_bank_acct_num = -1;
		short		ind_org_sys_seq = -1;
		short		ind_sys_seq = -1;
		short		ind_user_seq = -1;
		short		ind_skip = -1;
		short		ind_mask_skip = -1;
		short		ind_raw_date = -1;
		short		ind_raw_time = -1;
		short		ind_tfr_bank_name = -1;
		short		ind_tfr_bank_acct_num = -1;
		short		ind_tfr_type = -1;
		short		ind_tfr_channel = -1;
		short		ind_tfr_text = -1;
		short		ind_tfr_customer_text = -1;
		short		ind_sender_name = -1;
		short		ind_txn_ref_num = -1;
		short		ind_balance = -1;
		short		ind_amt_type = -1;
		short		ind_txn_amount = -1;
		short		ind_bank_charge = -1;
		short		ind_create_user = -1;
		short		ind_create_timestamp = -1;
	EXEC SQL END DECLARE SECTION;

	hv_file_id.len = strlen(csFileId);
	strncpy((char*)hv_file_id.arr,csFileId,sizeof(hv_file_id.arr));
DEBUGLOG(("GetDetail: file_id = [%.*s](%d)\n",sizeof(hv_file_id.arr),hv_file_id.arr,hv_file_id.len));

	hv_ver = iVer;
DEBUGLOG(("GetDetail: ver = [%d]\n", hv_ver));

	EXEC SQL DECLARE getpastrecordcursor CURSOR FOR
		SELECT	OLST_FILE_ID,
			OLST_SEQ,
			OLST_VER,
			OLST_LATEST_VER,
			OLST_INT_BANK_CODE,
			OLST_BANK_ACCT_NUM,
			OLST_ORG_SYS_SEQ,
			OLST_SYS_SEQ,
			OLST_USER_SEQ,
			OLST_SKIP,
			OLST_MASK_SKIP,
			OLST_RAW_DATE,
			OLST_RAW_TIME,
			OLST_TFR_BANK_NAME,
			OLST_TFR_BANK_ACCT_NUM,
			OLST_TFR_TYPE,
			OLST_TFR_CHANNEL,
			OLST_TFR_TEXT,
			OLST_TFR_CUSTOMER_TEXT,
			OLST_SENDER_NAME,
			OLST_TXN_REF_NUM,
			OLST_BALANCE,
			OLST_AMT_TYPE,
			OLST_TXN_AMOUNT,
			OLST_BANK_CHARGE,
			OLST_CREATE_USER,
			OLST_CREATE_TIMESTAMP
		FROM	OL_STATEMENT_TMP
		WHERE	OLST_FILE_ID = :hv_file_id
		AND	OLST_VER <= :hv_ver
		AND	(OLST_LATEST_VER >= :hv_ver or OLST_LATEST_VER IS NULL)
		AND	OLST_DISABLED = 0
		ORDER BY OLST_SYS_SEQ ASC;

	EXEC SQL OPEN getpastrecordcursor;
	for (;;) {
		EXEC SQL FETCH getpastrecordcursor
		INTO	:v_file_id:ind_file_id,
			:v_seq:ind_seq,
			:v_ver:ind_ver,
			:v_latest_ver:ind_latest_ver,
			:v_int_bank_code:ind_int_bank_code,
			:v_bank_acct_num:ind_bank_acct_num,
			:v_org_sys_seq:ind_org_sys_seq,
			:v_sys_seq:ind_sys_seq,
			:v_user_seq:ind_user_seq,
			:v_skip:ind_skip,
			:v_mask_skip:ind_mask_skip,
			:v_raw_date:ind_raw_date,
			:v_raw_time:ind_raw_time,
			:v_tfr_bank_name:ind_tfr_bank_name,
			:v_tfr_bank_acct_num:ind_tfr_bank_acct_num,
			:v_tfr_type:ind_tfr_type,
			:v_tfr_channel:ind_tfr_channel,
			:v_tfr_text:ind_tfr_text,
			:v_tfr_customer_text:ind_tfr_customer_text,
			:v_sender_name:ind_sender_name,
			:v_txn_ref_num:ind_txn_ref_num,
			:v_balance:ind_balance,
			:v_amt_type:ind_amt_type,
			:v_txn_amount:ind_txn_amount,
			:v_bank_charge:ind_bank_charge,
			:v_create_user:ind_create_user,
			:v_create_timestamp:ind_create_timestamp;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash, 0);

		iCnt++;

// file_id
		if (ind_file_id >= 0) {
			v_file_id.arr[v_file_id.len] = '\0';
			PutField_CString(myHash, "file_id", (char*)v_file_id.arr);
 DEBUGLOG(("GetDetail file_id = [%s]\n", (char*)v_file_id.arr));
		}

// seq
		if (ind_seq >= 0) {
			PutField_Int(myHash, "seq", v_seq);
 DEBUGLOG(("GetDetail seq = [%d]\n", v_seq));
		}

// ver
		if (ind_ver >= 0) {
			PutField_Int(myHash, "ver", v_ver);
 DEBUGLOG(("GetDetail ver = [%d]\n", v_ver));
		}

// latest_ver
		if (ind_latest_ver >= 0) {
			PutField_Int(myHash, "latest_ver", v_latest_ver);
 DEBUGLOG(("GetDetail latest_ver = [%d]\n", v_latest_ver));
		}

// int_bank_code
		if (ind_int_bank_code >= 0) {
			v_int_bank_code.arr[v_int_bank_code.len] = '\0';
			PutField_CString(myHash, "int_bank_code", (char*)v_int_bank_code.arr);
 DEBUGLOG(("GetDetail int_bank_code = [%s]\n", (char*)v_int_bank_code.arr));
		}

// bank_acct_num
		if (ind_bank_acct_num >= 0) {
			v_bank_acct_num.arr[v_bank_acct_num.len] = '\0';
			PutField_CString(myHash, "bank_acct_num", (char*)v_bank_acct_num.arr);
 DEBUGLOG(("GetDetail bank_acct_num = [%s]\n", (char*)v_bank_acct_num.arr));
		}

// org_sys_seq
		if (ind_org_sys_seq >= 0) {
			PutField_Int(myHash, "org_sys_seq", v_org_sys_seq);
 DEBUGLOG(("GetDetail org_sys_seq = [%d]\n", v_org_sys_seq));
		}

// sys_seq
		if (ind_sys_seq >= 0) {
			PutField_Int(myHash, "sys_seq", v_sys_seq);
 DEBUGLOG(("GetDetail sys_seq = [%d]\n", v_sys_seq));
		}

// user_seq
		if (ind_user_seq >= 0) {
			PutField_Int(myHash, "user_seq", v_user_seq);
 DEBUGLOG(("GetDetail user_seq = [%d]\n", v_user_seq));
		}

// skip
		if (ind_skip >= 0) {
			PutField_Int(myHash, "skip", v_skip);
 DEBUGLOG(("GetDetail skip = [%d]\n", v_skip));
		}

// mask_skip
		if (ind_mask_skip >= 0) {
			PutField_Int(myHash, "mask_skip", v_mask_skip);
 DEBUGLOG(("GetDetail mask_skip = [%d]\n", v_mask_skip));
		}

// raw_date
		if (ind_raw_date >= 0) {
			v_raw_date.arr[v_raw_date.len] = '\0';
			PutField_CString(myHash, "raw_date", (char*)v_raw_date.arr);
 DEBUGLOG(("GetDetail raw_date = [%s]\n", (char*)v_raw_date.arr));
		}

// raw_time
		if (ind_raw_time >= 0) {
			v_raw_time.arr[v_raw_time.len] = '\0';
			PutField_CString(myHash, "raw_time", (char*)v_raw_time.arr);
 DEBUGLOG(("GetDetail raw_time = [%s]\n", (char*)v_raw_time.arr));
		}

// tfr_bank_name
		if (ind_tfr_bank_name >= 0) {
			v_tfr_bank_name.arr[v_tfr_bank_name.len] = '\0';
			PutField_CString(myHash, "tfr_bank_name", (char*)v_tfr_bank_name.arr);
 DEBUGLOG(("GetDetail tfr_bank_name = [%s]\n", (char*)v_tfr_bank_name.arr));
		}

// tfr_bank_acct_num
		if (ind_tfr_bank_acct_num >= 0) {
			v_tfr_bank_acct_num.arr[v_tfr_bank_acct_num.len] = '\0';
			PutField_CString(myHash, "tfr_bank_acct_num", (char*)v_tfr_bank_acct_num.arr);
 DEBUGLOG(("GetDetail tfr_bank_acct_num = [%s]\n", (char*)v_tfr_bank_acct_num.arr));
		}

// tfr_type
		if (ind_tfr_type >= 0) {
			v_tfr_type.arr[v_tfr_type.len] = '\0';
			PutField_CString(myHash, "tfr_type", (char*)v_tfr_type.arr);
 DEBUGLOG(("GetDetail tfr_type = [%s]\n", (char*)v_tfr_type.arr));
		}

// tfr_channel
		if (ind_tfr_channel >= 0) {
			v_tfr_channel.arr[v_tfr_channel.len] = '\0';
			PutField_CString(myHash, "tfr_channel", (char*)v_tfr_channel.arr);
 DEBUGLOG(("GetDetail tfr_channel = [%s]\n", (char*)v_tfr_channel.arr));
		}

// tfr_text
		if (ind_tfr_text >= 0) {
			v_tfr_text.arr[v_tfr_text.len] = '\0';
			PutField_CString(myHash, "tfr_text", (char*)v_tfr_text.arr);
 DEBUGLOG(("GetDetail tfr_text = [%s]\n", (char*)v_tfr_text.arr));
		}

// tfr_customer_text
		if (ind_tfr_customer_text >= 0) {
			v_tfr_customer_text.arr[v_tfr_customer_text.len] = '\0';
			PutField_CString(myHash, "tfr_customer_text", (char*)v_tfr_customer_text.arr);
 DEBUGLOG(("GetDetail tfr_customer_text = [%s]\n", (char*)v_tfr_customer_text.arr));
		}

// sender_name
		if (ind_sender_name >= 0) {
			v_sender_name.arr[v_sender_name.len] = '\0';
			PutField_CString(myHash, "sender_name", (char*)v_sender_name.arr);
 DEBUGLOG(("GetDetail sender_name = [%s]\n", (char*)v_sender_name.arr));
		}

// txn_ref_num
		if (ind_txn_ref_num >= 0) {
			v_txn_ref_num.arr[v_txn_ref_num.len] = '\0';
			PutField_CString(myHash, "txn_ref_num", (char*)v_txn_ref_num.arr);
 DEBUGLOG(("GetDetail txn_ref_num = [%s]\n", (char*)v_txn_ref_num.arr));
		}

// balance
		if (ind_balance >= 0) {
			v_balance.arr[v_balance.len] = '\0';
			PutField_CString(myHash, "balance", (char*)v_balance.arr);
 DEBUGLOG(("GetDetail balance = [%s]\n", (char*)v_balance.arr));
		}

// amt_type
		if (ind_amt_type >= 0) {
			v_amt_type.arr[v_amt_type.len] = '\0';
			PutField_CString(myHash, "amt_type", (char*)v_amt_type.arr);
 DEBUGLOG(("GetDetail amt_type = [%s]\n", (char*)v_amt_type.arr));
		}

// txn_amount
		if (ind_txn_amount >= 0) {
			v_txn_amount.arr[v_txn_amount.len] = '\0';
			PutField_CString(myHash, "txn_amount", (char*)v_txn_amount.arr);
 DEBUGLOG(("GetDetail txn_amount = [%s]\n", (char*)v_txn_amount.arr));
		}

// bank_charge
		if (ind_bank_charge >= 0) {
			v_bank_charge.arr[v_bank_charge.len] = '\0';
			PutField_CString(myHash, "bank_charge", (char*)v_bank_charge.arr);
 DEBUGLOG(("GetDetail bank_charge = [%s]\n", (char*)v_bank_charge.arr));
		}

// create_user
		if (ind_create_user >= 0) {
			v_create_user.arr[v_create_user.len] = '\0';
			PutField_CString(myHash, "create_user", (char*)v_create_user.arr);
 DEBUGLOG(("GetDetail create_user = [%s]\n", (char*)v_create_user.arr));
		}

// create_timestamp
		if (ind_create_timestamp >= 0) {
			v_create_timestamp.arr[v_create_timestamp.len] = '\0';
			PutField_CString(myHash, "create_timestamp", (char*)v_create_timestamp.arr);
 DEBUGLOG(("GetDetail create_timestamp = [%s]\n", (char*)v_create_timestamp.arr));
		}

		RecordSet_Add(myRec, myHash);
	}
	EXEC SQL CLOSE getpastrecordcursor;

	if (iCnt > 0) {
		iRet = FOUND;
DEBUGLOG(("GetDetail() FOUND\n"));
	}

DEBUGLOG(("GetDetail Normal Exit! iRet = [%d]\n", iRet));
	return iRet;

getdetail_error:
DEBUGLOG(("getdetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLSatementTmp getdetail_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL CLOSE getpastrecordcursor;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;

}

int GetRecSystemDetail(const char* csFileId, int iSeq, int iVer, hash_t* hRec)
{
        int iRet = PD_OK;

        EXEC SQL WHENEVER SQLERROR GOTO getrecsystemdetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar         hv_file_id[PD_TXN_SEQ_LEN];
		int		hv_seq;
		int		hv_ver;

                varchar         v_file_id[PD_TXN_SEQ_LEN + 1];
                int             v_seq;
                int             v_ver;
                int             v_latest_ver;
                int             v_org_sys_seq;
                int             v_sys_seq;
                int             v_user_seq;
                //int             v_skip;
                //int             v_mask_skip;

                short           ind_file_id = -1;
                short           ind_seq = -1;
                short           ind_ver = -1;
                short           ind_latest_ver = -1;
                short           ind_org_sys_seq = -1;
                short           ind_sys_seq = -1;
                short           ind_user_seq = -1;
                //short           ind_skip = -1;
                //short           ind_mask_skip = -1;
        EXEC SQL END DECLARE SECTION;

// file_id
	hv_file_id.len = strlen(csFileId);
        strncpy((char*)hv_file_id.arr,csFileId,sizeof(hv_file_id.arr));
DEBUGLOG(("GeRecSystemDetail: file_id = [%.*s](%d)\n",sizeof(hv_file_id.arr),hv_file_id.arr,hv_file_id.len));

// seq
	hv_seq = iSeq;
DEBUGLOG(("GetRecSystemDetail: seq = [%d]\n", hv_seq));

// ver
	hv_ver = iVer;
DEBUGLOG(("GetRecSystemDetail: ver = [%d]\n", hv_ver));

	EXEC SQL SELECT OLST_FILE_ID,
                        OLST_SEQ,
                        OLST_VER,
                        OLST_LATEST_VER,
                        OLST_ORG_SYS_SEQ,
                        OLST_SYS_SEQ,
                        OLST_USER_SEQ
                        //OLST_SKIP,
                        //OLST_MASK_SKIP,
		 INTO	:v_file_id:ind_file_id,
			:v_seq:ind_seq,
			:v_ver:ind_ver,
			:v_latest_ver:ind_latest_ver,
			:v_org_sys_seq:ind_org_sys_seq,
			:v_sys_seq:ind_sys_seq,
			:v_user_seq:ind_user_seq
			//:v_skip:ind_skip,
			//:v_mask_skip:ind_mask_skip,
                 FROM   OL_STATEMENT_TMP
                 WHERE  OLST_FILE_ID = :hv_file_id
              	 AND    OLST_SEQ = :hv_seq
              	 AND    OLST_VER = :hv_ver
                 AND    OLST_DISABLED >= 0;

// file_id
      	if (ind_file_id >= 0) {
            	v_file_id.arr[v_file_id.len] = '\0';
              	PutField_CString(hRec, "file_id", (char*)v_file_id.arr);
DEBUGLOG(("GetRecSystemDetail file_id = [%s]\n", (char*)v_file_id.arr));
        }

// seq
       	if (ind_seq >= 0) {
           	PutField_Int(hRec, "seq", v_seq);
DEBUGLOG(("GetRecSystemDetail seq = [%d]\n", v_seq));
       	}

// ver
        if (ind_ver >= 0) {
            	PutField_Int(hRec, "ver", v_ver);
DEBUGLOG(("GetRecSystemDetail ver = [%d]\n", v_ver));
      	}

// latest_ver
      	if (ind_latest_ver >= 0) {
               	PutField_Int(hRec, "latest_ver", v_latest_ver);
DEBUGLOG(("GetRecSystemDetail latest_ver = [%d]\n", v_latest_ver));
	}

// org_sys_seq
      	if (ind_org_sys_seq >= 0) {
              	PutField_Int(hRec, "org_sys_seq", v_org_sys_seq);
DEBUGLOG(("GetRecSystemDetail org_sys_seq = [%d]\n", v_org_sys_seq));
      	}

// sys_seq
     	if (ind_sys_seq >= 0) {
           	PutField_Int(hRec, "sys_seq", v_sys_seq);
DEBUGLOG(("GetRecSystemDetail sys_seq = [%d]\n", v_sys_seq));
       	}

// user_seq
      	if (ind_user_seq >= 0) {
           	PutField_Int(hRec, "user_seq", v_user_seq);
DEBUGLOG(("GetRecSystemDetail user_seq = [%d]\n", v_user_seq));
       	}

/*
// skip
       	if (ind_skip >= 0) {
            	PutField_Int(hRec, "skip", v_skip);
DEBUGLOG(("GetRecSystemDetail skip = [%d]\n", v_skip));
       	}

// mask_skip
       	if (ind_mask_skip >= 0) {
             	PutField_Int(hRec, "mask_skip", v_mask_skip);
DEBUGLOG(("GetRecSystemDetail mask_skip = [%d]\n", v_mask_skip));
     	}
*/
	
DEBUGLOG(("GetRecSystemDetail Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

getrecsystemdetail_error:
DEBUGLOG(("getrecsystemdetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLStatementTmp getrecsystemdetail_error: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int GetLatestRecDetail(const char* csFileId, hash_t* hRec)
{
	int     iRet = PD_OK;

        EXEC SQL WHENEVER SQLERROR GOTO getlatestrecdetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar         hv_file_id[PD_TXN_SEQ_LEN];
       
		varchar         v_file_id[PD_TXN_SEQ_LEN + 1];
	        int             v_seq;
                int             v_ver;
                int             v_latest_ver;
                int             v_org_sys_seq;
                int             v_sys_seq;
                int             v_user_seq;
                //int             v_skip;
                //int             v_mask_skip;
		varchar         v_create_user[PD_USER_LEN + 1];
                varchar         v_create_timestamp[PD_TIMESTAMP_LEN + 1];

		short           ind_file_id = -1;
                short           ind_seq = -1;
                short           ind_ver = -1;
                short           ind_latest_ver = -1;
                short           ind_org_sys_seq = -1;
                short           ind_sys_seq = -1;
                short           ind_user_seq = -1;
                //short           ind_skip = -1;
                //short           ind_mask_skip = -1;
		short           ind_create_user = -1;
                short           ind_create_timestamp = -1;
	EXEC SQL END DECLARE SECTION;

// file_id
	hv_file_id.len = strlen(csFileId);
        strncpy((char*)hv_file_id.arr,csFileId,sizeof(hv_file_id.arr));
DEBUGLOG(("GetLatestRecSystemDetail: file_id = [%.*s](%d)\n",sizeof(hv_file_id.arr),hv_file_id.arr,hv_file_id.len));

	EXEC SQL SELECT OLST_FILE_ID,
                        OLST_SEQ,
                        OLST_VER,
                        OLST_LATEST_VER,
                        OLST_ORG_SYS_SEQ,
                        OLST_SYS_SEQ,
                        OLST_USER_SEQ,
                        //OLST_SKIP,
                        //OLST_MASK_SKIP,
                        OLST_CREATE_USER,
                        OLST_CREATE_TIMESTAMP
		INTO    :v_file_id:ind_file_id,
                        :v_seq:ind_seq,
                        :v_ver:ind_ver,
                        :v_latest_ver:ind_latest_ver,
                        :v_org_sys_seq:ind_org_sys_seq,
                        :v_sys_seq:ind_sys_seq,
                        :v_user_seq:ind_user_seq,
                        //:v_skip:ind_skip,
                        //:v_mask_skip:ind_mask_skip,
                        :v_create_user:ind_create_user,
                        :v_create_timestamp:ind_create_timestamp
                FROM    OL_STATEMENT_TMP
                WHERE   OLST_FILE_ID = :hv_file_id
                AND     OLST_LATEST_VER IS NULL
              	//AND     OLST_LATEST_VER = 0
                AND     OLST_DISABLED = 0
                ORDER BY OLST_SEQ DESC,
			 OLST_VER DESC;

// file_id
     	if (ind_file_id >= 0) {
              	v_file_id.arr[v_file_id.len] = '\0';
              	PutField_CString(myHash, "file_id", (char*)v_file_id.arr);
DEBUGLOG(("GetLatestRecDetail file_id = [%s]\n", (char*)v_file_id.arr));
       	}

// seq
       	if (ind_seq >= 0) {
              	PutField_Int(myHash, "seq", v_seq);
DEBUGLOG(("GetLatestRecDetail seq = [%d]\n", v_seq));
       	}

// ver
     	if (ind_ver >= 0) {
             	PutField_Int(myHash, "ver", v_ver);
DEBUGLOG(("GetLatestRecDetail ver = [%d]\n", v_ver));
      	}

// latest_ver
     	if (ind_latest_ver >= 0) {
          	PutField_Int(myHash, "latest_ver", v_latest_ver);
DEBUGLOG(("GetLatestRecDetail latest_ver = [%d]\n", v_latest_ver));
	}

// org_sys_seq
       	if (ind_org_sys_seq >= 0) {
            	PutField_Int(myHash, "org_sys_seq", v_org_sys_seq);
DEBUGLOG(("GetLatestRecDetail org_sys_seq = [%d]\n", v_org_sys_seq));
       	}

// sys_seq
       	if (ind_sys_seq >= 0) {
               	PutField_Int(myHash, "sys_seq", v_sys_seq);
DEBUGLOG(("GetLatestRecDetail sys_seq = [%d]\n", v_sys_seq));
      	}

// user_seq
      	if (ind_user_seq >= 0) {
               	PutField_Int(myHash, "user_seq", v_user_seq);
DEBUGLOG(("GetLatestRecDetail user_seq = [%d]\n", v_user_seq));
      	}

/*
// skip
      	if (ind_skip >= 0) {
             	PutField_Int(myHash, "skip", v_skip);
DEBUGLOG(("GetLatestRecDetail skip = [%d]\n", v_skip));
       	}

// mask_skip
       	if (ind_mask_skip >= 0) {
             	PutField_Int(myHash, "mask_skip", v_mask_skip);
DEBUGLOG(("GetLatestRecDetail mask_skip = [%d]\n", v_mask_skip));
       	}
*/

// create_user
       	if (ind_create_user >= 0) {
              	v_create_user.arr[v_create_user.len] = '\0';
              	PutField_CString(myHash, "create_user", (char*)v_create_user.arr);
DEBUGLOG(("GetLatestRecDetail create_user = [%s]\n", (char*)v_create_user.arr));
      	}

// create_timestamp
      	if (ind_create_timestamp >= 0) {
             	v_create_timestamp.arr[v_create_timestamp.len] = '\0';
              	PutField_CString(myHash, "create_timestamp", (char*)v_create_timestamp.arr);
DEBUGLOG(("GetLatestRecDetail create_timestamp = [%s]\n", (char*)v_create_timestamp.arr));
    	}

DEBUGLOG(("GetLatestRecDetail Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

getlatestrecdetail_error:
DEBUGLOG(("getlatestrecdetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLStatementTmp getlatestrecdetail_error code %d\n", sqlca.sqlcode);
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int AddError(const hash_t *hRls)
{
	char	*csTmp;
	int	iResultCnt;
	int	iTmp;

	char	*csTag = (char*) malloc (64);

	EXEC SQL WHENEVER SQLERROR GOTO adderr_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_file_id[PD_TXN_SEQ_LEN];
		int		hv_seq;
		int		hv_ver;
		varchar		hv_result[PD_TMP_BUF_LEN];
		varchar		hv_create_user[PD_USER_LEN];

		short		ind_file_id = -1;
		short		ind_seq = -1;
		short		ind_ver = -1;
		short		ind_result = -1;
		short		ind_create_user = -1;

		short		hv_return_value;

	EXEC SQL END DECLARE SECTION;

	if (GetField_CString(hRls,"file_id",&csTmp)) {
		hv_file_id.len = strlen(csTmp);
		strncpy((char*)hv_file_id.arr,csTmp,sizeof(hv_file_id.arr));
		ind_file_id = 0;
DEBUGLOG(("AddError:file_id = [%.*s](%d)\n",sizeof(hv_file_id.arr),hv_file_id.arr,hv_file_id.len));
	}

	if(GetField_Int(hRls,"ver",&iTmp)) {
		hv_ver = iTmp;
		ind_ver = 0;
DEBUGLOG(("AddError:ver = [%d]\n",hv_ver));
	}

	if (GetField_CString(hRls,"create_user",&csTmp)) {
		hv_create_user.len = strlen(csTmp);
		strncpy((char*)hv_create_user.arr,csTmp,sizeof(hv_create_user.arr));
		ind_create_user = 0;
DEBUGLOG(("AddError:create_user = [%.*s](%d)\n",sizeof(hv_create_user.arr),hv_create_user.arr,hv_create_user.len));
	}

	if (GetField_Int(hRls,"result_cnt",&iResultCnt)) {
DEBUGLOG(("AddError:result_cnt = [%d]\n",iResultCnt));
		int i;
		for (i=1;i<=iResultCnt;i++) {
			ind_seq = -1;
			ind_result = -1;

			sprintf(csTag,"seq_%d",i);
			if (GetField_Int(hRls,csTag,&iTmp)) {
				hv_seq = iTmp;
				ind_seq = 0;
			}
DEBUGLOG(("AddError: %s = [%d]\n",csTag,hv_seq));

			sprintf(csTag,"result_%d",i);
			if (GetField_CString(hRls,csTag,&csTmp)) {
				hv_result.len = strlen(csTmp);
				strncpy((char*)hv_result.arr,csTmp,sizeof(hv_result.arr));
				ind_result = 0;
			}
DEBUGLOG(("AddError: %s = %.*s\n",csTag,hv_result.len,hv_result.arr));

			EXEC SQL EXECUTE
				BEGIN
					:hv_return_value := sp_ol_statement_tmp_error_ins(
								:hv_file_id:ind_file_id,
								:hv_seq:ind_seq,
								:hv_ver:ind_ver,
								:hv_result:ind_result,
								:hv_create_user:ind_create_user);
				END;
			END-EXEC;

DEBUGLOG(("AddError: return = [%d]\n",hv_return_value));

			if (hv_return_value == SP_OTHER_ERR) {
ERRLOG("OLStatementTmp_AddError: SP_OTHER_ERR\n");
DEBUGLOG(("AddError: SP_OTHER_ERR\n"));
				return PD_OTHER_ERR;
			}

			if (hv_return_value == SP_ERR) {
ERRLOG("OLStatementTmp_AddError: SP_ERR\n");
DEBUGLOG(("AddError: SP_ERR\n"));
				return PD_ERR;
			}
		}
	}


	FREE_ME(csTag);

DEBUGLOG(("AddError:Normal Exit\n"));
	return PD_OK;

adderr_error:
DEBUGLOG(("adderr_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
DEBUGLOG(("AddError: SP_INTERNAL_ERR TxnAbort\n"));
ERRLOG("OLStatementTmp_AddError: SP_INTERNAL_ERR TxnAbort\n");
	TxnAbort();
	return PD_INTERNAL_ERR;
}

int AddSplit(const hash_t *hRls)
{
	int	iTmp;
	char	*csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO addetail_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_file_id[PD_TXN_SEQ_LEN];
		int		hv_seq;
		int		hv_ver;
		varchar		hv_statement_ref[PD_TXN_SEQ_LEN];
		varchar		hv_create_user[PD_USER_LEN];

		short		ind_file_id = -1;
		short		ind_seq = -1;
		short		ind_ver = -1;
		short		ind_statement_ref = -1;
		short		ind_create_user = -1;

		short		hv_return_value;

	EXEC SQL END DECLARE SECTION;

	if (GetField_CString(hRls,"file_id",&csTmp)) {
		hv_file_id.len = strlen(csTmp);
		strncpy((char*)hv_file_id.arr,csTmp,sizeof(hv_file_id.arr));
		ind_file_id = 0;
DEBUGLOG(("AddSplit: file_id = [%.*s](%d)\n",sizeof(hv_file_id.arr),hv_file_id.arr,hv_file_id.len));
	}

	if (GetField_Int(hRls, "seq", &iTmp)) {
		hv_seq = iTmp;
		ind_seq = 0;
DEBUGLOG(("AddSplit: seq = [%d]\n",hv_seq));
	}

	if (GetField_Int(hRls, "ver", &iTmp)) {
		hv_ver = iTmp;
		ind_ver = 0;
DEBUGLOG(("AddSplit: ver = [%d]\n",hv_ver));
	}

	if (GetField_CString(hRls,"statement_ref",&csTmp)) {
		hv_statement_ref.len = strlen(csTmp);
		strncpy((char*)hv_statement_ref.arr,csTmp,sizeof(hv_statement_ref.arr));
		ind_statement_ref = 0;
DEBUGLOG(("AddSplit: statement_ref = [%.*s](%d)\n",sizeof(hv_statement_ref.arr),hv_statement_ref.arr,hv_statement_ref.len));
	}

	if (GetField_CString(hRls,"create_user",&csTmp)) {
		hv_create_user.len = strlen(csTmp);
		strncpy((char*)hv_create_user.arr,csTmp,sizeof(hv_create_user.arr));
		ind_create_user = 0;
DEBUGLOG(("AddSplit: create_user = [%.*s](%d)\n",sizeof(hv_create_user.arr),hv_create_user.arr,hv_create_user.len));
	}

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_statement_tmp_split_ins(
						:hv_file_id:ind_file_id,
						:hv_seq:ind_seq,
						:hv_ver:ind_ver,
						:hv_statement_ref:ind_statement_ref,
						:hv_create_user:ind_create_user);
		END;
	END-EXEC;

	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("AddSplit: Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR) {
ERRLOG("OLStatementTmp_AddSplit: SP_OTHER_ERR\n");
DEBUGLOG(("AddSplit: SP_OTHER_ERR\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR) {
ERRLOG("OLStatementTmp_AddSplit: SP_ERR\n");
DEBUGLOG(("AddSplit: SP_ERR\n"));
		return PD_ERR;
	}

addetail_error:
DEBUGLOG(("addetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
DEBUGLOG(("AddSplit: SP_INTERNAL_ERR TxnAbort\n"));
ERRLOG("OLStatementTmp_AddSplit: SP_INTERNAL_ERR TxnAbort\n");
	TxnAbort();
	return PD_INTERNAL_ERR;
}

