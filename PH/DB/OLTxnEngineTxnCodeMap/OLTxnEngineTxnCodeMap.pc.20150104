/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/12/03              Dirk Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLTxnEngineTxnCodeMap.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char cDebug;


void OLTxnEngineTxnCodeMap(char cdebug)
{
	cDebug = cdebug;
}

int GetNewTxnCode(const int iActionDetailId, const char *csOrgTxnCode, hash_t* hRec)
{
	int	iRet = PD_ERR;
	EXEC SQL WHENEVER SQLERROR GOTO getnewtxncode_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		int	hv_action_detail_id;
		varchar	hv_org_txn_code[PD_TXN_CODE_LEN];

		varchar	v_new_txn_code[PD_TXN_CODE_LEN+1];
		int	v_is_offset;

		short	ind_new_txn_code = -1;
		short	ind_is_offset= -1;

	EXEC SQL END DECLARE SECTION;

	hv_action_detail_id = iActionDetailId;
DEBUGLOG(("GetNewTxnCode action_detail_id = [%d]\n", hv_action_detail_id));

	hv_org_txn_code.len = strlen(csOrgTxnCode);
	memcpy(hv_org_txn_code.arr, csOrgTxnCode, hv_org_txn_code.len);
DEBUGLOG(("GetNewTxnCode org_txn_code = [%.*s]\n", hv_org_txn_code.len, hv_org_txn_code.arr));

	EXEC SQL DECLARE c_cursor_getnewtxncode CURSOR FOR
		SELECT	ETM_NEW_TXN_CODE,
			TC_OFL_IS_OFFSET
		FROM	OL_TXN_ENGINE_TXNCODE_MAP, TXN_CODE
		WHERE	ETM_ACTION_DETAIL_ID = :hv_action_detail_id
		AND	ETM_ORG_TXN_CODE = :hv_org_txn_code
		AND 	ETM_NEW_TXN_CODE = TC_CODE;

	EXEC SQL OPEN c_cursor_getnewtxncode;
	do {
		EXEC SQL FETCH c_cursor_getnewtxncode
		INTO	:v_new_txn_code:ind_new_txn_code,
			:v_is_offset:ind_is_offset;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

DEBUGLOG(("GetNewTxnCode found record\n"));

		if (ind_new_txn_code >= 0) {
			v_new_txn_code.arr[v_new_txn_code.len] = '\0';
			PutField_CString(hRec, "new_txn_code", (const char*)v_new_txn_code.arr);
DEBUGLOG(("GetNewTxnCode new_txn_code = [%s]\n", v_new_txn_code.arr));


			if(ind_is_offset<0)
				v_is_offset = 0;

DEBUGLOG(("GetNewTxnCode is_offset = [%d]\n", v_is_offset));
			PutField_Int(hRec, "is_offset", v_is_offset);
			iRet = PD_OK;
		}

	} while (PD_TRUE);

	EXEC SQL CLOSE c_cursor_getnewtxncode;

	if(iRet!=PD_OK){
		PutField_Int(hRec, "is_offset", PD_FALSE);
		PutField_CString(hRec, "new_txn_code", csOrgTxnCode);
DEBUGLOG(("GetNewTxnCode NOT found in Map. new_txn_code = org_txn_code\n"));
		iRet = PD_OK;
	}

DEBUGLOG(("GetNewTxnCode Normal Exit [%d]\n",iRet));

	return iRet;

getnewtxncode_error:
DEBUGLOG(("getnewtxncode_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLPspDetail_Get: SP_INTERNAL_ERR TxnAbort\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_getnewtxncode;
	return PD_ERR;
}

