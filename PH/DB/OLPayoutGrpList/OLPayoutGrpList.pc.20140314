/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/01/15              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLPayoutGrpList.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "internal.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void OLPayoutGrpList(char    cdebug)
{
        cDebug = cdebug;
}


int MatchRecord(hash_t *hRls)
{
	char *csTmp;
	int iRet = PD_NOT_FOUND;
	EXEC SQL WHENEVER SQLERROR GOTO match_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_bank_acct_num[PD_AC_NO_LEN];
		varchar		hv_bank_acct_name[PD_ACC_NAME_LEN];

		char		v_group;

		short		ind_group= -1;

	EXEC SQL END DECLARE SECTION;
	
/*bank_acct_num*/
        if(GetField_CString(hRls,"bank_acct_num",&csTmp)){
                hv_bank_acct_num.len = strlen(csTmp);
                memcpy(hv_bank_acct_num.arr, csTmp, hv_bank_acct_num.len);
DEBUGLOG(("MatchRecord:bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));
        }

/*bank_acct_name*/
        if(GetField_CString(hRls,"bank_acct_name",&csTmp)){
                hv_bank_acct_name.len = strlen(csTmp);
                memcpy(hv_bank_acct_name.arr, csTmp, hv_bank_acct_name.len);
DEBUGLOG(("MatchRecord:bank_acct_name = [%.*s]\n",hv_bank_acct_name.len,hv_bank_acct_name.arr));
        }

	EXEC SQL DECLARE c_cursor_match CURSOR FOR
		select	
			ogl_group
		from	ol_payout_grp_list
		where	ogl_bank_acct_num =:hv_bank_acct_num
		AND	ogl_bank_acct_name =:hv_bank_acct_name;

	EXEC SQL OPEN  c_cursor_match;
	do{
		EXEC SQL FETCH c_cursor_match
		INTO
			:v_group:ind_group;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

/*group*/
		if(ind_group>=0){
			PutField_Char(hRls,"payout_group",v_group);
DEBUGLOG(("MatchRecord payout_group = [%c]\n",v_group));
			iRet = PD_FOUND;
		}

	}while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_match;

DEBUGLOG(("MatchRecord Normal Exit [%d]\n",iRet));
	return  iRet;

match_error:
DEBUGLOG(("match_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLPayoutGrpList_Get: SP_INTERNAL_ERR\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_match;
	return PD_ERR;

}


int     Add(const hash_t *hRls)
{
        char	*csTmp;
        char	cTmp;

        EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                char            hv_group;
                varchar         hv_bank_acct_num[PD_AC_NO_LEN];
                varchar         hv_bank_acct_name[PD_ACC_NAME_LEN];
                varchar         hv_posting_date[PD_DATE_LEN];
                varchar         hv_user[PD_USER_LEN];

		short           ind_group = -1;
		short           ind_bank_acct_num = -1;
		short		ind_bank_acct_name = -1;
		short		ind_posting_date = -1;
		short		ind_user = -1;

		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("Add: Begin\n"));

/*group*/
        if(GetField_Char(hRls,"payout_group",&cTmp)){
                hv_group = cTmp;
                ind_group= 0;
DEBUGLOG(("Add:group= [%c]\n",hv_group));
        }

/*bank_acct_num*/
        if(GetField_CString(hRls,"bank_acct_num",&csTmp)){
                hv_bank_acct_num.len = strlen(csTmp);
                memcpy(hv_bank_acct_num.arr, csTmp, hv_bank_acct_num.len);
                ind_bank_acct_num = 0;
DEBUGLOG(("Add:bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));
        }

/*bank_acct_name*/
        if(GetField_CString(hRls,"bank_acct_name",&csTmp)){
                hv_bank_acct_name.len = strlen(csTmp);
                memcpy(hv_bank_acct_name.arr, csTmp, hv_bank_acct_name.len);
                ind_bank_acct_name= 0;
DEBUGLOG(("Add:bank_acct_name = [%.*s]\n",hv_bank_acct_name.len,hv_bank_acct_name.arr));
        }

/*posting_date*/
        if(GetField_CString(hRls,"posting_date",&csTmp)){
                hv_posting_date.len = PD_DATE_LEN;
                memcpy(hv_posting_date.arr, csTmp, PD_DATE_LEN);
                ind_posting_date = 0;
DEBUGLOG(("Add:posting_date = [%.*s]\n",hv_posting_date.len,hv_posting_date.arr));
        }

/*user*/
        if(GetField_CString(hRls,"add_user",&csTmp)){
                hv_user.len = strlen(csTmp);
                memcpy(hv_user.arr, csTmp, hv_user.len);
                ind_user= 0;
DEBUGLOG(("Add:user = [%.*s]\n",hv_user.len,hv_user.arr));
        }

	EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_ol_payout_grp_list_insert(
                                        :hv_group:ind_group,
                                        :hv_bank_acct_num:ind_bank_acct_num,
                                        :hv_bank_acct_name:ind_bank_acct_name,
                                        :hv_posting_date:ind_posting_date,
                                        :hv_user:ind_user);
                END;
        END-EXEC;

DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
                DEBUGLOG(("Add:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
                ERRLOG("OLPayoutGrpList_Add: SP_OTHER_ERR \n");
                DEBUGLOG(("Add: SP_OTHER_ERR \n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
                ERRLOG("OLPayoutGrpList_Add: SP_ERR \n");
                DEBUGLOG(("Add: SP_ERR \n"));
                return PD_ERR;
        }

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLPayoutGrpList_Add: SP_INTERNAL_ERR \n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;

}


int Delete(const hash_t *hRls)
{
        char	*csTmp;
        char	cTmp;
        EXEC SQL WHENEVER SQLERROR GOTO delete_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                char            hv_group;
                varchar         hv_bank_acct_num[PD_AC_NO_LEN];
                varchar         hv_bank_acct_name[PD_ACC_NAME_LEN];

		short           ind_group = -1;
		short           ind_bank_acct_num = -1;
		short		ind_bank_acct_name = -1;

                short   hv_return_value;
        EXEC SQL END DECLARE SECTION;

/*group*/
        if(GetField_Char(hRls,"payout_group",&cTmp)){
                hv_group = cTmp;
                ind_group= 0;
DEBUGLOG(("Delete:group= [%c]\n",hv_group));
        }

/*bank_acct_num*/
        if(GetField_CString(hRls,"bank_acct_num",&csTmp)){
                hv_bank_acct_num.len = strlen(csTmp);
                memcpy(hv_bank_acct_num.arr, csTmp, hv_bank_acct_num.len);
                ind_bank_acct_num = 0;
DEBUGLOG(("Delete:bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));
        }

/*bank_acct_name*/
        if(GetField_CString(hRls,"bank_acct_name",&csTmp)){
                hv_bank_acct_name.len = strlen(csTmp);
                memcpy(hv_bank_acct_name.arr, csTmp, hv_bank_acct_name.len);
                ind_bank_acct_name= 0;
DEBUGLOG(("Delete:bank_acct_name = [%.*s]\n",hv_bank_acct_name.len,hv_bank_acct_name.arr));
        }

	EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_ol_payout_grp_list_delete(
                                        :hv_group:ind_group,
                                        :hv_bank_acct_num:ind_bank_acct_num,
                                        :hv_bank_acct_name:ind_bank_acct_name);
                END;
        END-EXEC;

DEBUGLOG(("Delete:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("Delete:Normal Exit\n"));
                return PD_OK;
        }
        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("OLPayoutGrpList_Delete: SP_OTHER_ERR\n");
DEBUGLOG(("Delete: SP_OTHER_ERR\n"));
                return PD_OTHER_ERR;
        }
        if (hv_return_value == SP_ERR)  {
ERRLOG("OLPayoutGrpList_Delete: SP_ERR\n");
DEBUGLOG(("Delete: SP_ERR\n"));
                return PD_ERR;
        }

delete_error:
DEBUGLOG(("delete_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLPayoutGrpList_Delete: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;

}
