/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/02/15              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "Service.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char    cDebug;

void Service(char    cdebug)
{
        cDebug = cdebug;
}


int FindURL(const unsigned char* ServiceCode,
                unsigned char* URL)
{

	int iRet = NOT_FOUND;

        EXEC SQL WHENEVER SQLERROR GOTO find_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
		char	hv_disabled;

                varchar v_url[PD_VALUE_LEN +1 ];

                short   ind_url = -1;
        EXEC SQL END DECLARE SECTION;

        hv_service_code.len = strlen(ServiceCode);
        memcpy(hv_service_code.arr,ServiceCode,hv_service_code.len);
DEBUGLOG(("FindURL: ServiceCode = [%.*s]\n",hv_service_code.len,hv_service_code.arr)); 

	hv_disabled='0';

	EXEC SQL DECLARE c_cursor_geturl CURSOR FOR
        	select  url
                from	service
                where code=:hv_service_code
		and   disabled=:hv_disabled
		AND   effect_date  =
                        (SELECT max(effect_date)
                           FROM service
                          WHERE code=:hv_service_code
                            AND disabled=:hv_disabled
                            AND effect_date <= sysdate);


	EXEC SQL OPEN c_cursor_geturl;
	do{	
		EXEC SQL FETCH c_cursor_geturl
                INTO
			:v_url:ind_url;

		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

        	if (ind_url >= 0) {
                	v_url.arr[v_url.len] = '\0';
                	strcpy(URL,v_url.arr);
DEBUGLOG(("URL = [%s]\n",URL)); 
                		iRet = FOUND;
		}
        }while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_geturl;

DEBUGLOG(("RET = [%d]\n",iRet));
	return iRet;

find_error:
DEBUGLOG(("find_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return NOT_FOUND;
}

