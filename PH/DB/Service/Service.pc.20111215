/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/02/15              LokMan Chow
Add Find Service				   2011/07/22		   Cody Chan
Add Psp id					   2011/11/28		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "Service.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char    cDebug;

void Service(char    cdebug)
{
        cDebug = cdebug;
}


int FindURL(const unsigned char* ServiceCode,
	    const unsigned char* PspId,
                unsigned char* URL)
{

	int i = 0;
	int iRet = NOT_FOUND;

        EXEC SQL WHENEVER SQLERROR GOTO find_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
		varchar hv_psp_id[PD_PSP_ID_LEN];
		int	hv_disabled;

                varchar v_url[PD_VALUE_LEN +1 ];

                short   ind_url = -1;
        EXEC SQL END DECLARE SECTION;

        hv_service_code.len = strlen((const char*)ServiceCode);
        memcpy(hv_service_code.arr,ServiceCode,hv_service_code.len);
DEBUGLOG(("FindURL: ServiceCode = [%.*s]\n",hv_service_code.len,hv_service_code.arr)); 

	hv_psp_id.len = strlen((const char*)PspId);
        memcpy(hv_psp_id.arr,PspId,hv_psp_id.len);
DEBUGLOG(("FindURL: psp_id = [%.*s]\n",hv_psp_id.len,hv_psp_id.arr));

	hv_disabled=0;

	EXEC SQL DECLARE c_cursor_geturl CURSOR FOR
        	select  url
                from	service
                where code=:hv_service_code
		and   disabled=:hv_disabled
		and   route_type in ('BE','FE')
		and   psp_id=:hv_psp_id
		AND   effect_date  =
                        (SELECT max(effect_date)
                           FROM service
                          WHERE code=:hv_service_code
                            AND disabled=:hv_disabled
                            AND effect_date <= sysdate);


	EXEC SQL OPEN c_cursor_geturl;
	do{	
		EXEC SQL FETCH c_cursor_geturl
                INTO
			:v_url:ind_url;

		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

        	if (ind_url >= 0) {
                	v_url.arr[v_url.len] = '\0';
                	strcpy((char*)URL,(const char*)v_url.arr);
DEBUGLOG(("URL = [%s]\n",URL));

                	i++;
		}
        }while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_geturl;

	if(i>0){
		iRet = FOUND;
	}
	
DEBUGLOG(("RET = [%d]\n",iRet));
	return iRet;

find_error:
DEBUGLOG(("find_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_geturl;
    return NOT_FOUND;
}

int FindService(const unsigned char* ServiceCode,
	       const unsigned char* TxnCountry)
{

	int iRet = NOT_FOUND;

        EXEC SQL WHENEVER SQLERROR GOTO find_service_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
		varchar hv_country[PD_COUNTRY_LEN];
		int	hv_disabled;

		short	v_cnt;

        EXEC SQL END DECLARE SECTION;

        hv_service_code.len = strlen((const char*)ServiceCode);
        memcpy(hv_service_code.arr,ServiceCode,hv_service_code.len);
DEBUGLOG(("FindService: ServiceCode = [%.*s]\n",hv_service_code.len,hv_service_code.arr)); 

	hv_country.len = strlen((const char*)TxnCountry);
        memcpy(hv_country.arr,TxnCountry,hv_country.len);
DEBUGLOG(("FindService: country = [%.*s]\n",hv_country.len,hv_country.arr));

	hv_disabled=0;

	EXEC SQL DECLARE c_cursor_get CURSOR FOR
		select count(*)
		 from def_service_code
	         where sc_code =: hv_service_code
                   and sc_txn_country =: hv_country;


	EXEC SQL OPEN c_cursor_get;
	do{	
		EXEC SQL FETCH c_cursor_get
                INTO
			:v_cnt;

		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
DEBUGLOG(("FindService: cnt = [%d]\n",v_cnt));
		if (v_cnt > 0)  
              		iRet = FOUND;
        }while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_get;

DEBUGLOG(("FindService RET = [%d]\n",iRet));
	return iRet;

find_service_error:
DEBUGLOG(("find_service_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_get;
    return NOT_FOUND;
}

int FindCountryByService(const unsigned char* ServiceCode, char* TxnCountry)
{

	int iRet = NOT_FOUND;

        EXEC SQL WHENEVER SQLERROR GOTO find_country_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
		int     hv_disabled;

		varchar v_country[PD_COUNTRY_LEN+1];

		short	ind_country=-1;

        EXEC SQL END DECLARE SECTION;

        hv_service_code.len = strlen((const char*)ServiceCode);
        memcpy(hv_service_code.arr,ServiceCode,hv_service_code.len);
DEBUGLOG(("FindCountryByService: ServiceCode = [%.*s]\n",hv_service_code.len,hv_service_code.arr)); 

	hv_disabled=0;

	EXEC SQL DECLARE c_cursor_find_country CURSOR FOR
		select sc_txn_country
                 from def_service_code
                where sc_code = :hv_service_code;

	EXEC SQL OPEN c_cursor_find_country;
	do{	
		EXEC SQL FETCH c_cursor_find_country
                INTO
			:v_country:ind_country;

		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

		if(ind_country>=0){
			v_country.arr[v_country.len]='\0';
			strcpy(TxnCountry, (const char*)v_country.arr);
DEBUGLOG(("FindCountryByService: country = [%s]\n",TxnCountry));

			iRet = FOUND;
		}

        }while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_find_country;

DEBUGLOG(("FindCountryByService iRet = [%d]\n",iRet));
	return iRet;

find_country_error:
DEBUGLOG(("find_country_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_find_country;
    return NOT_FOUND;
}

