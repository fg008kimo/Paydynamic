/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/10/22              Cody Chan
Add reverse field				   2015/05/22		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "SystemExRules.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char    cDebug;

void SystemExRules(char    cdebug)
{
        cDebug = cdebug;
}


int FindCode(const unsigned char* csTxnCode,recordset_t *myRec) 
{
        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO FindCode_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_txn_code[PD_TXN_CODE_LEN +1];

                varchar v_none_restricted[PD_EX_CODE_LEN + 1];
                varchar v_restricted_1[PD_EX_CODE_LEN + 1];
                varchar v_restricted_2[PD_EX_CODE_LEN + 1];
		varchar	v_res1_res2_opr[PD_OPER_LEN +1];
		char	v_markup_amt_opr;
		char	v_fr_to_reverse;

                short   ind_none_restricted = -1;
                short   ind_restricted_1 = -1;
                short   ind_restricted_2 = -1;
		short	ind_res1_res2_opr = -1;
		short	ind_markup_amt_opr = -1;
		short	ind_fr_to_reverse  = -1;
        EXEC SQL END DECLARE SECTION;

	hv_txn_code.len = strlen((const char*)csTxnCode);
	memcpy(hv_txn_code.arr,csTxnCode,hv_txn_code.len);
DEBUGLOG(("FindCode txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));

        EXEC SQL DECLARE c_cursor_FindCode CURSOR FOR
		SELECT  sr_none_restricted,
			sr_restricted_1,
			sr_restricted_2,
			sr_res1_res2_opr,
			sr_markup_amt_opr,
			sr_fr_to_reverse
                FROM    SYSTEM_EX_RULES
	       WHERE    sr_txn_code = :hv_txn_code;

        EXEC SQL OPEN c_cursor_FindCode;
        do {

                EXEC SQL FETCH c_cursor_FindCode
                INTO
                        :v_none_restricted:ind_none_restricted,
                        :v_restricted_1:ind_restricted_1,
                        :v_restricted_2:ind_restricted_2,
			:v_res1_res2_opr:ind_res1_res2_opr,
			:v_markup_amt_opr:ind_markup_amt_opr,
			:v_fr_to_reverse:ind_fr_to_reverse;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

                if (ind_none_restricted >= 0) {
                        v_none_restricted.arr[v_none_restricted.len] ='\0';
                        PutField_CString(myHash,"none_restricted",(const char*)v_none_restricted.arr);
DEBUGLOG(("FindCode: none_restricted = [%s]\n",v_none_restricted.arr)); 
                }

                if (ind_restricted_1 >= 0) {
                        v_restricted_1.arr[v_restricted_1.len] ='\0';
                        PutField_CString(myHash,"restricted_1",(const char*)v_restricted_1.arr);
DEBUGLOG(("FindCode: restricted_1 = [%s]\n",v_restricted_1.arr)); 
                }

                if (ind_restricted_2 >= 0) {
                        v_restricted_2.arr[v_restricted_2.len] ='\0';
                        PutField_CString(myHash,"restricted_2",(const char*)v_restricted_2.arr);
DEBUGLOG(("FindCode: restricted_2 = [%s]\n",v_restricted_2.arr)); 
                }
                if (ind_res1_res2_opr >= 0) {
                        v_res1_res2_opr.arr[v_res1_res2_opr.len] ='\0';
                        PutField_CString(myHash,"res1_res2_opr",(const char*)v_res1_res2_opr.arr);
DEBUGLOG(("FindCode: res1_res2_opr = [%s]\n",v_res1_res2_opr.arr)); 
                }

		if (ind_markup_amt_opr >= 0) {
                        PutField_Char(myHash,"markup_amt_opr",v_markup_amt_opr);
DEBUGLOG(("FindCode: markup_amt_opr = [%c]\n",v_markup_amt_opr)); 
		}

		if (ind_fr_to_reverse >= 0) {
                        PutField_Char(myHash,"fr_to_reverse",v_fr_to_reverse);
DEBUGLOG(("FindCode: fr_to_reverse = [%c]\n",v_fr_to_reverse)); 
		}

                RecordSet_Add(myRec,myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_FindCode;


        return  PD_OK;

FindCode_error:
DEBUGLOG(("FindCode_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_FindCode;
        return PD_ERR;
}

