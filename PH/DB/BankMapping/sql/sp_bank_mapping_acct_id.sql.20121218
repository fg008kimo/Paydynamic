CREATE OR REPLACE FUNCTION sp_bank_mapping_acct_id(
  in_bank_code			bank_mapping.bm_int_bank_code%type,
  out_cursor		out	sys_refcursor)

RETURN NUMBER Is
	iCnt    integer := 0;
Begin

	select count(psp_detail.psp_id)
	into iCnt
	from psp_detail,
	     clients,
	     bank_mapping
        where PSP_DETAIL.PSP_CHANNEL_CODE = BANK_MAPPING.BM_PSP_CHANNEL_ID
	and BANK_MAPPING.bm_disabled = 0
        and BANK_MAPPING.bm_int_bank_code = in_bank_code
        and     psp_detail.status = 'O'
        and     psp_detail.txn_type in ('A','D')
        and     psp_detail.disabled = 0
        and     psp_detail.online_mode = 'Y'
	and	clients.client_id = psp_detail.client_id
	and	clients.status = 'O'
	AND     bm_effect_date <= sysdate;

	if iCnt > 0 THEN
	OPEN out_cursor for
		select psp_detail.psp_id,psp_detail.client_id
                from psp_detail,
		     clients,
		     bank_mapping
                where PSP_DETAIL.PSP_CHANNEL_CODE = BANK_MAPPING.BM_PSP_CHANNEL_ID
                and BANK_MAPPING.bm_disabled = 0
                and BANK_MAPPING.bm_int_bank_code = in_bank_code
                and     psp_detail.status = 'O'
                and     psp_detail.txn_type in ('A','D')
                and     psp_detail.disabled = 0
                and     psp_detail.online_mode = 'Y'
		and     clients.client_id = psp_detail.client_id
		and     clients.status = 'O'
        	AND     bm_effect_date <= sysdate
                order by psp_detail.client_id;
		RETURN 1;
        end if;
	return 0;

 exception
   WHEN OTHERS THEN
     RETURN 9;
END sp_bank_mapping_acct_id;
/

