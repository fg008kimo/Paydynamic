/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/08/20              LokMan Chow
Add log                                            2013/08/23              Stan Poon
Add GetTotalMatchRec                               2013/09/23              Virginia Yun
Exclude update Magic Num                           2013/09/24              Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "ClientMagic.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void ClientMagic(char    cdebug)
{
        cDebug = cdebug;
}


int Add(const hash_t *hClientMagic)
{
	char    *csTmp;
	int	iTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_client[PD_CLIENT_ID_LEN];
		varchar 	hv_create_user[PD_USER_LEN];
		varchar 	hv_magic_num[PD_MAGIC_NUM_LEN];
		varchar 	hv_magic_word[PD_MAGIC_WORD_LEN];
		varchar		hv_cust_id[PD_MAGIC_CUST_ID_LEN];
		int		hv_disabled;

		short		ind_client = -1;
		short		ind_cust_id = -1;
		short		ind_magic_num= -1;
		short		ind_magic_word = -1;
		short		ind_create_user = -1;
		short		ind_disabled = -1;
		
		short	   hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("Add: Begin\n"));

	if(GetField_CString(hClientMagic,"client_id",&csTmp))
	{
		hv_client.len = strlen(csTmp);
		strncpy((char*)hv_client.arr,csTmp, hv_client.len);
		ind_client = 0;
DEBUGLOG(("Add:client_id = [%.*s]\n",hv_client.len,hv_client.arr));
	}

	if(GetField_CString(hClientMagic,"customer_id",&csTmp))
	{
		hv_cust_id.len = strlen(csTmp);
		strncpy((char*)hv_cust_id.arr, csTmp, hv_cust_id.len);
		ind_cust_id = 0;
DEBUGLOG(("Add:customer_id = [%.*s]\n",hv_cust_id.len,hv_cust_id.arr));
	}

	if(GetField_CString(hClientMagic,"magic_num",&csTmp))
	{
		hv_magic_num.len = strlen(csTmp);
		strncpy((char*)hv_magic_num.arr, csTmp, hv_magic_num.len);
		ind_magic_num = 0;
DEBUGLOG(("Add:magic_num = [%.*s]\n",hv_magic_num.len,hv_magic_num.arr));
	}

	if(GetField_CString(hClientMagic,"magic_word",&csTmp))
	{
		hv_magic_word.len = strlen(csTmp);
		strncpy((char*)hv_magic_word.arr, csTmp, hv_magic_word.len);
		ind_magic_word = 0;
DEBUGLOG(("Add:magic_word = [%.*s]\n",hv_magic_word.len,hv_magic_word.arr));
	}

	if (GetField_Int(hClientMagic,"disabled",&iTmp)) 
	{
		hv_disabled = iTmp;
		ind_disabled = 0;
DEBUGLOG(("Add:disabled = [%d]\n",hv_disabled));
	} else {
		hv_disabled = 0;
		ind_disabled = 0;
DEBUGLOG(("Add:disabled(default) = [%d]\n",hv_disabled));
	}


	if(GetField_CString(hClientMagic,"create_user",&csTmp))
	{
		hv_create_user.len = strlen(csTmp);
		strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));
	}


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_client_magic_insert(
				:hv_client:ind_client,
				:hv_cust_id:ind_cust_id,
				:hv_magic_num:ind_magic_num,
				:hv_magic_word:ind_magic_word,
				:hv_disabled:ind_disabled,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("Add:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("ClientMagic_Add: SP_OTHER_ERR \n");
DEBUGLOG(("Add: SP_OTHER_ERR \n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("ClientMagic_Add: SP_ERR \n");
DEBUGLOG(("Add: SP_ERR \n"));
		return PD_ERR;
	}

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;


}



int Delete(const hash_t *hClientMagic)
{
	char	*csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO delete_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar	hv_client[PD_CLIENT_ID_LEN];
		varchar	hv_cust_id[PD_MAGIC_CUST_ID_LEN];
		varchar	hv_update_user[PD_USER_LEN];

		short	ind_client = -1;
		short	ind_cust_id = -1;
		short	ind_update_user = -1;
		short	hv_return_value;
	EXEC SQL END DECLARE SECTION;

	if(GetField_CString(hClientMagic,"client_id",&csTmp))
	{
		hv_client.len = strlen(csTmp);
		strncpy((char*)hv_client.arr,csTmp, hv_client.len);
		ind_client = 0;
DEBUGLOG(("Delete:client_id = [%.*s]\n",hv_client.len,hv_client.arr));
	}

	if(GetField_CString(hClientMagic,"customer_id",&csTmp))
	{
		hv_cust_id.len = strlen(csTmp);
		strncpy((char*)hv_cust_id.arr, csTmp, hv_cust_id.len);
		ind_cust_id = 0;
DEBUGLOG(("Delete:customer_id = [%.*s]\n",hv_cust_id.len,hv_cust_id.arr));
	}

	if(GetField_CString(hClientMagic,"update_user",&csTmp))
	{
		hv_update_user.len = strlen(csTmp);
		strncpy((char*)hv_update_user.arr, csTmp, hv_update_user.len);
		ind_update_user = 0;
DEBUGLOG(("Add:update_user = [%.*s]\n",hv_update_user.len,hv_update_user.arr));
	}

	EXEC SQL EXECUTE
	    BEGIN
		
		:hv_return_value := sp_client_magic_delete(
				:hv_client:ind_client,
				:hv_cust_id:ind_cust_id,
				:hv_update_user:ind_update_user);

	    END;
	END-EXEC;


DEBUGLOG(("Delete:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("Delete:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("ClientMagic_Delete: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Delete: SP_OTHER_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("ClientMagic_Delete: SP_ERR TxnAbort\n");
DEBUGLOG(("Delete: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

delete_error:
	DEBUGLOG(("delete_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;

}

int GetCustomerIdByMagic(const char* csClientId, 
			 const char* csMagicNumber,
			 const char* csMagicWord,
			 unsigned char* csCustomerId)
{
	int	iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO getcust_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;
		       
	EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_client_id[PD_CLIENT_ID_LEN];
		varchar 	hv_magic_num[PD_MAGIC_NUM_LEN];
		varchar 	hv_magic_word[PD_MAGIC_WORD_LEN];
		int		hv_disabled;
	
		varchar		v_cust_id[PD_MAGIC_CUST_ID_LEN+1];

		short		ind_cust_id = -1;

	EXEC SQL END DECLARE SECTION;

	hv_disabled = 0;

	hv_client_id.len = strlen(csClientId);
	memcpy(hv_client_id.arr,csClientId,hv_client_id.len);
DEBUGLOG(("GetCustomerIdByMagic client_id = [%d][%.*s]\n",hv_client_id.len,hv_client_id.len,hv_client_id.arr));

	hv_magic_num.len = strlen(csMagicNumber);
	memcpy(hv_magic_num.arr,csMagicNumber,hv_magic_num.len);
DEBUGLOG(("GetCustomerIdByMagic magic_num = [%d][%.*s]\n",hv_magic_num.len,hv_magic_num.len,hv_magic_num.arr));

	hv_magic_word.len = strlen(csMagicWord);
	memcpy(hv_magic_word.arr,csMagicWord,hv_magic_word.len);
DEBUGLOG(("GetCustomerIdByMagic magic_word = [%d][%.*s]\n",hv_magic_word.len,hv_magic_word.len,hv_magic_word.arr));

	
	EXEC SQL 
		select  CM_CUST_ID
		INTO    :v_cust_id:ind_cust_id
		from	client_magic
		where	cm_client_id = :hv_client_id
		and	cm_num = :hv_magic_num
		and	cm_word = :hv_magic_word
		and 	cm_disabled = :hv_disabled;

/* customer id */
		if (ind_cust_id >= 0) {
			v_cust_id.arr[v_cust_id.len] = '\0';
			strcpy((char*)csCustomerId,(const char*)v_cust_id.arr);
DEBUGLOG(("GetCustomerIdByMagic customer id = [%s]\n",csCustomerId));
		}
		else{
			iRet = PD_ERR;
DEBUGLOG(("GetCustomerIdByMagic customer id Not Found\n"));
		}

DEBUGLOG(("GetCustomerIdByMagic Normal Exit\n"));
	return  iRet;

getcust_error:
DEBUGLOG(("getcust_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("ClientMagic_Get: SP_INTERNAL_ERR TxnAbort\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;

}

int GetMagicNumById(const char* csClientId, 
			 const char* csCustomerId,
			 char* csMagicNum)
{
	int	iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO getcust_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;
		       
	EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_client_id[PD_CLIENT_ID_LEN];
		varchar		hv_cust_id[PD_MAGIC_CUST_ID_LEN];
	
		varchar 	v_magic_num[PD_MAGIC_NUM_LEN + 1];

		short		ind_magic_num= -1;

	EXEC SQL END DECLARE SECTION;

	hv_client_id.len = strlen(csClientId);
	memcpy(hv_client_id.arr,csClientId,hv_client_id.len);
DEBUGLOG(("GetMagicNumById client_id = [%d][%.*s]\n",hv_client_id.len,hv_client_id.len,hv_client_id.arr));

	hv_cust_id.len = strlen(csCustomerId);
	memcpy(hv_cust_id.arr,csCustomerId,hv_cust_id.len);
DEBUGLOG(("GetMagicNumById cust_id = [%d][%.*s]\n",hv_cust_id.len,hv_cust_id.len,hv_cust_id.arr));
	
	EXEC SQL 
		select  CM_NUM
		INTO    :v_magic_num:ind_magic_num
		from	client_magic
		where	cm_client_id = :hv_client_id
		and 	cm_cust_id= :hv_cust_id;

/* magic num */
	if (ind_magic_num >= 0) {
		v_magic_num.arr[v_magic_num.len] = '\0';
		strcpy((char*)csMagicNum,(const char*)v_magic_num.arr);
DEBUGLOG(("GetMagicNumById magic num = [%s]\n",csMagicNum));
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("GetMagicNumById magic num Not Found\n"));
	}

DEBUGLOG(("GetMagicNumById Normal Exit\n"));
	return  iRet;

getcust_error:
DEBUGLOG(("getcust_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("ClientMagic_Get: SP_INTERNAL_ERR TxnAbort\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;

}


int Update(const hash_t *hRls)
{
	char*   csTmp;
	char*   csClientId;
	char*   csCustId;
	int	iTmp;
	char*   csBuf;

	EXEC SQL WHENEVER SQLERROR GOTO update_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_client[PD_CLIENT_ID_LEN];
		varchar		hv_cust_id[PD_MAGIC_CUST_ID_LEN];
		varchar 	hv_magic_num[PD_MAGIC_NUM_LEN];
		varchar 	hv_magic_word[PD_MAGIC_WORD_LEN];
		int		hv_disabled;
		varchar 	hv_update_user[PD_USER_LEN];

		short		ind_client = -1;
		short		ind_cust_id = -1;
		short		ind_magic_num= -1;
		short		ind_magic_word = -1;
		short		ind_disabled = -1;
		short		ind_update_user = -1;

		short		hv_return_value = -1;

		varchar	 hv_dynstmt[1024];

	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr,"update client_magic set cm_update_timestamp  = sysdate");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	GetField_CString(hRls,"client_id",&csClientId);
DEBUGLOG(("Update:client_id = [%s]\n",csClientId));
	hv_client.len = strlen(csClientId);
	strncpy((char*)hv_client.arr,csClientId, hv_client.len);
	ind_client = 0;

	GetField_CString(hRls,"customer_id",&csCustId);
DEBUGLOG(("Update:customer_id = [%s]\n",csCustId));
	hv_cust_id.len = strlen(csCustId);
	strncpy((char*)hv_cust_id.arr,csCustId, hv_cust_id.len);
	ind_cust_id = 0;


/*magic_num 
	if (GetField_CString(hRls,"magic_num",&csTmp)) {
DEBUGLOG(("Update:magic_num = [%s]\n",csTmp));
		hv_magic_num.len = strlen(csTmp);
		strncpy((char*)hv_magic_num.arr,csTmp, hv_magic_num.len);
		ind_magic_num = 0;

		strcat((char*)hv_dynstmt.arr, ",cm_num = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}
*/

/* magic_word*/
	if (GetField_CString(hRls,"magic_word",&csTmp)) {
DEBUGLOG(("Update:magic_word = [%s]\n",csTmp));
		hv_magic_word.len = strlen(csTmp);
		strncpy((char*)hv_magic_word.arr,csTmp, hv_magic_word.len);
		ind_magic_word = 0;

		strcat((char*)hv_dynstmt.arr, ",cm_word = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* disabled */
	if (GetField_Int(hRls,"disabled",&iTmp)) {
DEBUGLOG(("Update:disabled = [%d]\n",iTmp));
		hv_disabled = iTmp;
		ind_disabled = 0;

		sprintf(csBuf,"%d",iTmp);
		strcat((char*)hv_dynstmt.arr, ", cm_disabled = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/*update_user*/
	if(GetField_CString(hRls,"update_user",&csTmp)){
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
		hv_update_user.len = strlen(csTmp);
		strncpy((char*)hv_update_user.arr,csTmp, hv_update_user.len);
		ind_update_user = 0;

		strcat((char*)hv_dynstmt.arr, ",cm_update_user= '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	strcat((char *)hv_dynstmt.arr, " WHERE cm_client_id = '");
	strcat((char *)hv_dynstmt.arr, csClientId);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " and cm_cust_id = '");
	strcat((char *)hv_dynstmt.arr, csCustId);
	strcat((char *)hv_dynstmt.arr, "'");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_client_magic_update_on_log(
				:hv_client:ind_client,
				:hv_cust_id:ind_cust_id,
				:hv_magic_num:ind_magic_num,
				:hv_magic_word:ind_magic_word,
				:hv_disabled:ind_disabled,
				:hv_update_user:ind_update_user);

	    END;
	END-EXEC;


DEBUGLOG(("Update: add_log::Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("Update: add_log::Normal Exit\n"));
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("ClientMagic_Update: add_log:: SP_OTHER_ERR \n");
DEBUGLOG(("Update: add_log:: SP_OTHER_ERR \n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("ClientMagic_Update: add_log:: SP_ERR \n");
DEBUGLOG(("Update: add_log:: SP_ERR \n"));
		return PD_ERR;
	}

	FREE_ME(csBuf);
DEBUGLOG(("Update Normal Exit\n"));
	return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("ClientMagic_Update: SP_INTERNAL_ERR\n");
	return PD_INTERNAL_ERR;
}

int	GetTotalMatchRec(const hash_t *hClientMagic, int *iTotalCount)
{
	int	iRet = PD_OK;

	char	*csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO gettotalmatchrec_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;
	
	EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_client[PD_CLIENT_ID_LEN];
		varchar		hv_magic_num[PD_MAGIC_NUM_LEN];
		varchar		hv_cust_id[PD_MAGIC_CUST_ID_LEN];

		short		ind_client = -1;
		short		ind_magic_num = -1;
		short		ind_cust_id = -1;

		int	     v_no_of_record;
		short	   ind_no_of_record = -1;
	EXEC SQL END DECLARE SECTION;

	if(GetField_CString(hClientMagic,"client_id",&csTmp))
	{
		hv_client.len = strlen(csTmp);
		strncpy((char*)hv_client.arr,csTmp, hv_client.len);
		ind_client = 0;
DEBUGLOG(("GetTotalMatchRec:client_id = [%.*s]\n",hv_client.len,hv_client.arr));
	}

	if(GetField_CString(hClientMagic,"customer_id",&csTmp))
	{
		hv_cust_id.len = strlen(csTmp);
		strncpy((char*)hv_cust_id.arr, csTmp, hv_cust_id.len);
		ind_cust_id = 0;
DEBUGLOG(("GetTotalMatchRec:customer_id = [%.*s]\n",hv_cust_id.len,hv_cust_id.arr));
	}

	if(GetField_CString(hClientMagic,"magic_num",&csTmp))
	{
		hv_magic_num.len = strlen(csTmp);
		strncpy((char*)hv_magic_num.arr, csTmp, hv_magic_num.len);
		ind_magic_num = 0;
DEBUGLOG(("GetTotalMatchRec:magic_num = [%.*s]\n",hv_magic_num.len,hv_magic_num.arr));
	}


	EXEC SQL
		SELECT sum(rec_cnt)
		INTO :v_no_of_record:ind_no_of_record
		FROM (
			SELECT count(1) as rec_cnt
			FROM client_magic 
			WHERE cm_client_id = :hv_client:ind_client
			AND cm_num = :hv_magic_num:ind_magic_num
			UNION ALL
			SELECT count(1) as rec_cnt
			FROM client_magic 
			WHERE cm_client_id = :hv_client:ind_client
			AND cm_cust_id = :hv_cust_id:ind_cust_id
			UNION ALL
			SELECT count(1) as rec_cnt
			FROM client_magic 
			WHERE cm_client_id = :hv_client:ind_client
			AND cm_num = :hv_magic_num:ind_magic_num
			AND cm_cust_id = :hv_cust_id:ind_cust_id
		);

	if (ind_no_of_record >= 0) {
DEBUGLOG(("GetTotalMatchRec: FOUND\n"));
		*iTotalCount = v_no_of_record;
DEBUGLOG(("GetTotalMatchRec: Total Record [%d]\n", *iTotalCount));
	} else {
DEBUGLOG(("GetTotalMatchRec ERR\n"));
		iRet = PD_ERR;
	}
		
	return iRet;

gettotalmatchrec_error:
DEBUGLOG(("GetTotalMatchRec_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
	
}

int GetClientMagic(const char* csClientId, 
			const char* csMagicNumber,
			const char* csMagicWord,
			hash_t *hClientMagic)
{
	int	iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO getclientmagic_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;
		       
	EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_client_id[PD_CLIENT_ID_LEN];
		varchar 	hv_magic_num[PD_MAGIC_NUM_LEN];
		varchar 	hv_magic_word[PD_MAGIC_WORD_LEN];
	
		varchar		v_cust_id[PD_MAGIC_CUST_ID_LEN+1];
		int		v_disabled;

		short		ind_cust_id = -1;
		short		ind_disabled = -1;

	EXEC SQL END DECLARE SECTION;

	hv_client_id.len = strlen(csClientId);
	memcpy(hv_client_id.arr,csClientId,hv_client_id.len);
DEBUGLOG(("GetClientMagic client_id = [%d][%.*s]\n",hv_client_id.len,hv_client_id.len,hv_client_id.arr));

	hv_magic_num.len = strlen(csMagicNumber);
	memcpy(hv_magic_num.arr,csMagicNumber,hv_magic_num.len);
DEBUGLOG(("GetClientMagic magic_num = [%d][%.*s]\n",hv_magic_num.len,hv_magic_num.len,hv_magic_num.arr));

	hv_magic_word.len = strlen(csMagicWord);
	memcpy(hv_magic_word.arr,csMagicWord,hv_magic_word.len);
DEBUGLOG(("GetClientMagic magic_word = [%d][%.*s]\n",hv_magic_word.len,hv_magic_word.len,hv_magic_word.arr));

	
	EXEC SQL 
		select  CM_CUST_ID, CM_DISABLED
		INTO    :v_cust_id:ind_cust_id,
                        :v_disabled:ind_disabled
		from	client_magic
		where	cm_client_id = :hv_client_id
		and	cm_num = :hv_magic_num
		and	cm_word = :hv_magic_word;

/* customer id */
		if (ind_cust_id >= 0) {
			v_cust_id.arr[v_cust_id.len] = '\0';
 			PutField_CString(hClientMagic, "customer_id",(const char*)v_cust_id.arr);
DEBUGLOG(("GetClientMagic customer id = [%s]\n", v_cust_id.arr));
		}
		else{
			iRet = PD_ERR;
DEBUGLOG(("GetClientMagic customer id Not Found\n"));
		}

/* disabled */
		if (ind_disabled >= 0) {
			PutField_Int(hClientMagic, "magic_disabled", v_disabled);
DEBUGLOG(("GetClientMagic disabled = [%d]\n", v_disabled)); 
		}


DEBUGLOG(("GetClientMagic Normal Exit\n"));
	return  iRet;

getclientmagic_error:
DEBUGLOG(("getclientmagic_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("ClientMagic_Get: SP_INTERNAL_ERR TxnAbort\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;

}
