CREATE OR REPLACE FUNCTION sp_txn_fe_url_geturl(
  in_txn_code            	txn_fe_url.txn_code%type,
  in_service_code		service.code%type,
  in_psp_id			service.psp_id%type,
  in_language		        txn_fe_url.language%type,
  in_route_type		        service.route_type%type,
  in_direction            	txn_fe_url.direction%type,
  out_cursor            out     sys_refcursor)

RETURN NUMBER Is
	iCnt	integer := 0;

Begin

	select count(*)
	  into	iCnt
	  from	txn_fe_url a,
	  	service b
	  where	a.txn_code=in_txn_code
	  and	a.service_code=in_service_code
	  and	a.service_code=b.code
	  and	b.psp_id=in_psp_id
	  and	a.language=in_language
	  and	a.direction=in_direction
	  and   b.route_type=in_route_type
	  and	a.disabled=0
	  and	b.disabled=0
	  and	b.effect_date=
		(SELECT max(effect_date)
			FROM service
			WHERE code=in_service_code
			AND psp_id=in_psp_id
	  		and route_type=in_route_type
			AND disabled=0
			AND effect_date<=sysdate)
	and	a.effect_date=
		(SELECT max(effect_date)
			FROM txn_fe_url
			WHERE txn_code=in_txn_code
			AND service_code=in_service_code
	  		AND language=in_language
			AND direction=in_direction
			AND disabled=0
			AND effect_date<=sysdate);

	if iCnt > 0 THEN
		OPEN out_cursor for
		select	b.url,
			a.path,
			a.method
		from	txn_fe_url a,
			service b
		where	a.txn_code=in_txn_code
		and	a.service_code=in_service_code
		and	a.service_code=b.code
	  	and	b.psp_id=in_psp_id
		and	a.language=in_language
		and	a.direction=in_direction
	  	and     b.route_type=in_route_type
		and	a.disabled=0
		and	b.disabled=0
	  	and	b.effect_date=
			(SELECT max(effect_date)
			  FROM service
			  WHERE code=in_service_code
			  AND disabled=0
			  AND psp_id=in_psp_id
	  		  and route_type=in_route_type
			  AND effect_date<=sysdate)
		and	a.effect_date=
			(SELECT max(effect_date)
			  FROM txn_fe_url
			  WHERE txn_code=in_txn_code
			  AND service_code=in_service_code
	  		  AND language=in_language
			  AND direction=in_direction
			  AND disabled=0
			  AND effect_date<=sysdate);
		return 1;
	
	else
		select count(*)
		  into	iCnt
		  from	txn_fe_url a,
		  	service b
		  where	a.txn_code=in_txn_code
		  and	a.service_code=in_service_code
		  and	a.service_code=b.code
		  and	b.psp_id='000'
		  and	a.language=in_language
		  and	a.direction=in_direction
	  	  and   b.route_type=in_route_type
		  and	a.disabled=0
		  and	b.disabled=0
		  and	b.effect_date=
			  (SELECT max(effect_date)
			   FROM service
			   WHERE code=in_service_code
			   AND psp_id='000'
	  		   and route_type=in_route_type
			   AND disabled=0
			   AND effect_date<=sysdate)
		  and	a.effect_date=
			  (SELECT max(effect_date)
			   FROM txn_fe_url
			   WHERE txn_code=in_txn_code
			   AND service_code=in_service_code
	  		   AND language=in_language
			   AND direction=in_direction
			   AND disabled=0
			   AND effect_date<=sysdate);

		if iCnt > 0 THEN
			OPEN out_cursor for
			select	b.url,
				a.path,
				a.method
			  from	txn_fe_url a,
		  		service b
			  where	a.txn_code=in_txn_code
			  and	a.service_code=in_service_code
		  	  and	a.service_code=b.code
			  and	b.psp_id='000'
			  and	a.language=in_language
			  and	a.direction=in_direction
	  		  and   b.route_type=in_route_type
			  and	a.disabled=0
			  and	b.disabled=0
			  and	b.effect_date=
			  	  (SELECT max(effect_date)
				   FROM service
				   WHERE code=in_service_code
				   AND psp_id='000'
	  			   and route_type=in_route_type
				   AND disabled=0
				   AND effect_date<=sysdate)
			  and	a.effect_date=
				  (SELECT max(effect_date)
				   FROM txn_fe_url
				   WHERE txn_code=in_txn_code
				   AND service_code=in_service_code
	  		   	   AND language=in_language
				   AND direction=in_direction
				   AND disabled=0
				   AND effect_date<=sysdate);

			return 1;
		else
			
			select count(*)
		  	into	iCnt
		  	from	txn_fe_url a,
		  		service b
		  	where	a.txn_code=in_txn_code
		  	and	a.service_code=in_service_code
		  	and	a.service_code=b.code
		  	and	b.psp_id=in_psp_id
		  	and	a.language='EN'
		  	and	a.direction=in_direction
	  		and     b.route_type=in_route_type
		  	and	a.disabled=0
		  	and	b.disabled=0
		  	and	b.effect_date=
				  (SELECT max(effect_date)
				   FROM service
			   	WHERE code=in_service_code
			   	AND psp_id=in_psp_id
			   	AND disabled=0
	  			and route_type=in_route_type
			   	AND effect_date<=sysdate)
		  	and	a.effect_date=
			  	(SELECT max(effect_date)
			  	 FROM txn_fe_url
			   	WHERE txn_code=in_txn_code
			   	AND service_code=in_service_code
	  		   	AND language='EN'
			   	AND direction=in_direction
			   	AND disabled=0
			   	AND effect_date<=sysdate);

			if iCnt > 0 THEN
				OPEN out_cursor for
				select	b.url,
					a.path,
					a.method
			  	from	txn_fe_url a,
		  			service b
			  	where	a.txn_code=in_txn_code
			  	and	a.service_code=in_service_code
		  	  	and	a.service_code=b.code
			  	and	b.psp_id=in_psp_id
			  	and	a.language='EN'
			  	and	a.direction=in_direction
	  			and     b.route_type=in_route_type
			  	and	a.disabled=0
			  	and	b.disabled=0
			  	and	b.effect_date=
			  		  (SELECT max(effect_date)
					   FROM service
				 	  WHERE code=in_service_code
				 	  AND psp_id=in_psp_id
	  				  and route_type=in_route_type
				 	  AND disabled=0
				 	  AND effect_date<=sysdate)
			 	and	a.effect_date=
				 	 (SELECT max(effect_date)
				   	FROM txn_fe_url
				   	WHERE txn_code=in_txn_code
				   	AND service_code=in_service_code
	  		   	   	AND language='EN'
				   	AND direction=in_direction
				   	AND disabled=0
				   	AND effect_date<=sysdate);

				return 1;

			else

				select count(*)
		  		into	iCnt
		  		from	txn_fe_url a,
		  			service b
		  		where	a.txn_code=in_txn_code
		  		and	a.service_code=in_service_code
		  		and	a.service_code=b.code
		  		and	b.psp_id='000'
		  		and	a.language='EN'
		  		and	a.direction=in_direction
	  			and     b.route_type=in_route_type
		  		and	a.disabled=0
		  		and	b.disabled=0
		  		and	b.effect_date=
					  (SELECT max(effect_date)
					   FROM service
			   		WHERE code=in_service_code
			   		AND psp_id='000'
	  				and route_type=in_route_type
			   		AND disabled=0
			   		AND effect_date<=sysdate)
		  		and	a.effect_date=
				  	(SELECT max(effect_date)
				  	 FROM txn_fe_url
				   	WHERE txn_code=in_txn_code
				   	AND service_code=in_service_code
	  			   	AND language='EN'
			   		AND direction=in_direction
			   		AND disabled=0
			   		AND effect_date<=sysdate);

				if iCnt > 0 THEN
					OPEN out_cursor for
					select	b.url,
						a.path,
						a.method
			  		from	txn_fe_url a,
		  				service b
			  		where	a.txn_code=in_txn_code
			  		and	a.service_code=in_service_code
		  	  		and	a.service_code=b.code
			  		and	b.psp_id='000'
			  		and	a.language='EN'
			  		and	a.direction=in_direction
	  				and     b.route_type=in_route_type
			  		and	a.disabled=0
			  		and	b.disabled=0
			  		and	b.effect_date=
			  			  (SELECT max(effect_date)
						   FROM service
					 	  WHERE code=in_service_code
					 	  AND psp_id='000'
	  					  and route_type=in_route_type
					 	  AND disabled=0
					 	  AND effect_date<=sysdate)
			 		and	a.effect_date=
					 	 (SELECT max(effect_date)
				   		FROM txn_fe_url
				   		WHERE txn_code=in_txn_code
				   		AND service_code=in_service_code
	  		   	   		AND language='EN'
				   		AND direction=in_direction
				   		AND disabled=0
				   		AND effect_date<=sysdate);

					return 1;

				else
					return 0;
				end if;

			end if;		

		end if;
	end if;

	return 0;

exception
   WHEN OTHERS THEN
     RETURN 0;
END sp_txn_fe_url_geturl;
/
