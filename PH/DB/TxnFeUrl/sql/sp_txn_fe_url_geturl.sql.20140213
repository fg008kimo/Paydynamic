CREATE OR REPLACE FUNCTION sp_txn_fe_url_geturl(
  in_txn_code            	txn_fe_url.txn_code%type,
  in_service_code		service.code%type,
  in_merchant_id		service_consumer_url.cu_merchant_id%type,
  in_country			service_consumer_url.cu_country%type,
  in_language		        txn_fe_url.language%type,
  in_route_type		        service.route_type%type,
  in_direction            	txn_fe_url.direction%type,
  out_cursor            out     sys_refcursor)

RETURN NUMBER Is
	iCnt	 integer := 0;

Begin

	select count(*)
    	into iCnt
    	FROM ((SELECT txn_code,
                  service_code,
                  language,
                  direction,
                  PATH,
                  method,
                  cp_merchant_id,
                  cp_country,
                  cp_path,
                  cp_method
            FROM ((SELECT txn_code,
                      service_code,
                      language,
                      direction,
                      method,
                      PATH
                FROM txn_fe_url
                           WHERE     txn_code = in_txn_code
                             AND service_code = in_service_code
                             AND direction = in_direction
                             AND language = in_language
                             AND disabled = 0
                             AND effect_date =
                                    (SELECT MAX (effect_date)
                                       FROM txn_fe_url
                                      WHERE     service_code = in_service_code
                                        AND txn_code = in_txn_code
                                        AND direction = in_direction
                                        AND language = in_language
                                        AND disabled = 0
                                        AND effect_date <= SYSDATE)) org_path
                         LEFT JOIN
                         (SELECT cp_service_code,
                                 cp_merchant_id,
                                 cp_country,
                                 cp_direction,
                                 cp_language,
                                 cp_path,
                                 cp_method
                            FROM service_consumer_path
                WHERE     cp_service_code = in_service_code
                AND cp_merchant_id = in_merchant_id
                AND cp_country = in_country
                AND cp_direction = in_direction
                AND cp_language = in_language
                AND cp_disabled = 0
                AND cp_effect_date =
                                    (SELECT MAX (cp_effect_date)
                                       FROM service_consumer_path
                                      WHERE     cp_service_code = in_service_code
                                        AND cp_merchant_id = in_merchant_id
                                        AND cp_country = in_country
                                        AND cp_direction = in_direction
                                        AND cp_language = in_language
                                        AND cp_disabled = 0
                                        AND cp_effect_date <= SYSDATE)) new_path
                            ON     org_path.service_code = new_path.cp_service_code
                               AND org_path.language = new_path.cp_language
                               AND org_path.direction = new_path.cp_direction)) PATH
                LEFT JOIN
                (SELECT code,
                        cu_merchant_id,
                cu_country,
                cu_url,
                url
                   FROM ((SELECT code, url
                            FROM service
                           WHERE     code = in_service_code
                            AND route_type = in_route_type
                             AND disabled = 0
                             AND effect_date =
                                    (SELECT MAX (effect_date)
                                       FROM service
                                      WHERE     code = in_service_code
                                             AND route_type = in_route_type
                                          AND disabled = 0
                                          AND effect_date <= SYSDATE)) org_url
                            LEFT JOIN
                            (SELECT cu_service_code,
                                 cu_merchant_id,
                                 cu_country,
                                 cu_url
                            FROM service_consumer_url
                           WHERE     cu_service_code = in_service_code
                            AND cu_merchant_id = in_merchant_id
                            AND cu_country = in_country
                             AND cu_disabled = 0
                             AND cu_effect_date =
                                    (SELECT MAX (cu_effect_date)
                                       FROM service_consumer_url
                                      WHERE     cu_service_code = in_service_code
                                        AND cu_merchant_id = in_merchant_id
                                        AND cu_country = in_country
                                        AND cu_disabled = 0
                                        AND cu_effect_date <= SYSDATE)) new_url
                            ON org_url.code = new_url.cu_service_code)) url
                   ON     url.code = PATH.service_code
                      AND ((url.cu_merchant_id IS NULL OR PATH.cp_merchant_id IS NULL)
                           OR ((url.cu_merchant_id IS NOT NULL AND PATH.cp_merchant_id IS NOT NULL)
                                           AND (url.cu_merchant_id = PATH.cp_merchant_id)))
                      AND ((url.cu_country IS NULL OR PATH.cp_country IS NULL)
                           OR ((url.cu_country IS NOT NULL AND PATH.cp_country IS NOT NULL)
                                           AND (url.cu_country = PATH.cp_country))));

    	if iCnt > 0
    	then 

	OPEN out_cursor for
		SELECT CASE WHEN cu_url IS NOT NULL THEN cu_url ELSE url END ret_url,
       		       CASE WHEN cp_path IS NOT NULL THEN cp_path ELSE PATH END ret_path,
		       CASE WHEN cp_method IS NOT NULL THEN cp_method ELSE method END ret_method
	 	FROM ((SELECT txn_code,
			      service_code,
			      language,
			      direction,
			      PATH,
			      method,
			      cp_merchant_id,
			      cp_country,
			      cp_path,
			      cp_method
			FROM ((SELECT txn_code,
				      service_code,
				      language,
				      direction,
				      method,
				      PATH
				FROM txn_fe_url
                   		WHERE     txn_code = in_txn_code
                         	AND service_code = in_service_code
                         	AND direction = in_direction
                         	AND language = in_language
                         	AND disabled = 0
                         	AND effect_date =
                                	(SELECT MAX (effect_date)
                                   	FROM txn_fe_url
                                  	WHERE     service_code = in_service_code
                                        AND txn_code = in_txn_code
                                        AND direction = in_direction
                                        AND language = in_language
                                        AND disabled = 0
                                        AND effect_date <= SYSDATE)) org_path
                 		LEFT JOIN
                 		(SELECT cp_service_code,
                         		cp_merchant_id,
                         		cp_country,
                         		cp_direction,
                         		cp_language,
                         		cp_path,
                         		cp_method
                    		FROM service_consumer_path
				WHERE     cp_service_code = in_service_code
				AND cp_merchant_id = in_merchant_id
				AND cp_country = in_country
				AND cp_direction = in_direction
				AND cp_language = in_language
				AND cp_disabled = 0
				AND cp_effect_date =
                                	(SELECT MAX (cp_effect_date)
                                   	FROM service_consumer_path
                                  	WHERE     cp_service_code = in_service_code
                                        AND cp_merchant_id = in_merchant_id
                                        AND cp_country = in_country
                                        AND cp_direction = in_direction
                                        AND cp_language = in_language
                                        AND cp_disabled = 0
                                        AND cp_effect_date <= SYSDATE)) new_path
                    		ON     org_path.service_code = new_path.cp_service_code
                       		AND org_path.language = new_path.cp_language
                       		AND org_path.direction = new_path.cp_direction)) PATH
        		LEFT JOIN
        		(SELECT code,
                		cu_merchant_id,
				cu_country,
				cu_url,
				url
           		FROM ((SELECT code, url
                    		FROM service
                   		WHERE     code = in_service_code
                        	AND route_type = in_route_type
                         	AND disabled = 0
                         	AND effect_date =
                                	(SELECT MAX (effect_date)
                                	   FROM service
                                	  WHERE     code = in_service_code
                               	          AND route_type = in_route_type
                                          AND disabled = 0
                                          AND effect_date <= SYSDATE)) org_url
                 	       LEFT JOIN
                 	       (SELECT cu_service_code,
                         		cu_merchant_id,
                         		cu_country,
                         		cu_url
                    		FROM service_consumer_url
                   		WHERE     cu_service_code = in_service_code
                        	AND cu_merchant_id = in_merchant_id
                        	AND cu_country = in_country
                         	AND cu_disabled = 0
                         	AND cu_effect_date =
                                	(SELECT MAX (cu_effect_date)
                                   	FROM service_consumer_url
                                  	WHERE     cu_service_code = in_service_code
                                        AND cu_merchant_id = in_merchant_id
                                        AND cu_country = in_country
                                        AND cu_disabled = 0
                                        AND cu_effect_date <= SYSDATE)) new_url
                    		ON org_url.code = new_url.cu_service_code)) url
           		ON     url.code = PATH.service_code
              		AND ((url.cu_merchant_id IS NULL OR PATH.cp_merchant_id IS NULL)
                   		OR ((url.cu_merchant_id IS NOT NULL AND PATH.cp_merchant_id IS NOT NULL)
                       					AND (url.cu_merchant_id = PATH.cp_merchant_id)))
              		AND ((url.cu_country IS NULL OR PATH.cp_country IS NULL)
                   		OR ((url.cu_country IS NOT NULL AND PATH.cp_country IS NOT NULL)
                       					AND (url.cu_country = PATH.cp_country))));


	else
        
        OPEN out_cursor for
        SELECT CASE WHEN cu_url IS NOT NULL THEN cu_url ELSE url END ret_url,
                      CASE WHEN cp_path IS NOT NULL THEN cp_path ELSE PATH END ret_path,
               CASE WHEN cp_method IS NOT NULL THEN cp_method ELSE method END ret_method
         FROM ((SELECT txn_code,
                  service_code,
                  language,
                  direction,
                  PATH,
                  method,
                  cp_merchant_id,
                  cp_country,
                  cp_path,
                  cp_method
            FROM ((SELECT txn_code,
                      service_code,
                      language,
                      direction,
                      method,
                      PATH
                FROM txn_fe_url
                           WHERE     txn_code = in_txn_code
                             AND service_code = in_service_code
                             AND direction = in_direction
                             AND language = 'EN'
                             AND disabled = 0
                             AND effect_date =
                                    (SELECT MAX (effect_date)
                                       FROM txn_fe_url
                                      WHERE     service_code = in_service_code
                                        AND txn_code = in_txn_code
                                        AND direction = in_direction
                                        AND language = 'EN'
                                        AND disabled = 0
                                        AND effect_date <= SYSDATE)) org_path
                         LEFT JOIN
                         (SELECT cp_service_code,
                                 cp_merchant_id,
                                 cp_country,
                                 cp_direction,
                                 cp_language,
                                 cp_path,
                                 cp_method
                            FROM service_consumer_path
                WHERE     cp_service_code = in_service_code
                AND cp_merchant_id = in_merchant_id
                AND cp_country = in_country
                AND cp_direction = in_direction
                AND cp_language = in_language
                AND cp_disabled = 0
                AND cp_effect_date =
                                    (SELECT MAX (cp_effect_date)
                                       FROM service_consumer_path
                                      WHERE     cp_service_code = in_service_code
                                        AND cp_merchant_id = in_merchant_id
                                        AND cp_country = in_country
                                        AND cp_direction = in_direction
                                        AND cp_language = in_language
                                        AND cp_disabled = 0
                                        AND cp_effect_date <= SYSDATE)) new_path
                            ON     org_path.service_code = new_path.cp_service_code
                               AND org_path.language = new_path.cp_language
                               AND org_path.direction = new_path.cp_direction)) PATH
                LEFT JOIN
                (SELECT code,
                        cu_merchant_id,
                cu_country,
                cu_url,
                url
                   FROM ((SELECT code, url
                            FROM service
                           WHERE     code = in_service_code
                            AND route_type = in_route_type
                             AND disabled = 0
                             AND effect_date =
                                    (SELECT MAX (effect_date)
                                       FROM service
                                      WHERE     code = in_service_code
                                             AND route_type = in_route_type
                                          AND disabled = 0
                                          AND effect_date <= SYSDATE)) org_url
                            LEFT JOIN
                            (SELECT cu_service_code,
                                 cu_merchant_id,
                                 cu_country,
                                 cu_url
                            FROM service_consumer_url
                           WHERE     cu_service_code = in_service_code
                            AND cu_merchant_id = in_merchant_id
                            AND cu_country = in_country
                             AND cu_disabled = 0
                             AND cu_effect_date =
                                    (SELECT MAX (cu_effect_date)
                                       FROM service_consumer_url
                                      WHERE     cu_service_code = in_service_code
                                        AND cu_merchant_id = in_merchant_id
                                        AND cu_country = in_country
                                        AND cu_disabled = 0
                                        AND cu_effect_date <= SYSDATE)) new_url
                            ON org_url.code = new_url.cu_service_code)) url
                   ON     url.code = PATH.service_code
                      AND ((url.cu_merchant_id IS NULL OR PATH.cp_merchant_id IS NULL)
                           OR ((url.cu_merchant_id IS NOT NULL AND PATH.cp_merchant_id IS NOT NULL)
                                           AND (url.cu_merchant_id = PATH.cp_merchant_id)))
                      AND ((url.cu_country IS NULL OR PATH.cp_country IS NULL)
                           OR ((url.cu_country IS NOT NULL AND PATH.cp_country IS NOT NULL)
                                           AND (url.cu_country = PATH.cp_country))));

        end if;

	return 1;

exception
   WHEN OTHERS THEN
     RETURN 0;
END sp_txn_fe_url_geturl;
/
