/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/02/21              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "TxnFeUrl.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void TxnFeUrl(char    cdebug)
{
        cDebug = cdebug;
}

/*
int Add(const hash_t *hTxnFeUrl)
{
	char            *csTmp;
	int		iTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_method[PD_CLIENT_ID_LEN];
		varchar		hv_txn_code[PD_MERCHANT_ID_LEN];
		varchar		hv_path[PD_NAME_LEN];
		int		hv_disabled;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_method = -1;
		short		ind_txn_code = -1;
		short		ind_path = -1;
		short		ind_disabled = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


	DEBUGLOG(("Add: Begin\n"));

	if(GetField_CString(hTxnFeUrl,"method",&csTmp))
	{
		hv_method.len = strlen(csTmp);
		strncpy(hv_method.arr, csTmp, hv_method.len);
		ind_txn_code = 0;
	}
DEBUGLOG(("Add:method = [%.*s]\n",hv_method.len,hv_method.arr));

	if(GetField_CString(hTxnFeUrl,"txn_code",&csTmp))
	{
		hv_txn_code.len = strlen(csTmp);
		strncpy(hv_txn_code.arr, csTmp, hv_txn_code.len);
		ind_txn_code = 0;
	}
DEBUGLOG(("Add:txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));

	if(GetField_CString(hTxnFeUrl,"path",&csTmp))
	{
		hv_path.len = strlen(csTmp);
		strncpy(hv_path.arr, csTmp, hv_path.len);
		ind_path = 0;
	}
DEBUGLOG(("Add:path = [%.*s]\n",hv_path.len,hv_path.arr));


	if (GetField_Int(hTxnFeUrl,"disabled", &iTmp)) 
	{
		hv_disabled = iTmp;
		ind_disabled = 0;
	}
DEBUGLOG(("Add:disabled = [%d]\n",hv_disabled));


	if(GetField_CString(hTxnFeUrl,"create_user",&csTmp))
	{
		hv_create_user.len = strlen(csTmp);
		strncpy(hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
	}
DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	FREE_ME(csTmp);


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merch_detail_insert(
				:hv_method:ind_method,
				:hv_txn_code:ind_txn_code,
				:hv_path:ind_path,
				:hv_disabled:ind_disabled,
				:hv_create_user:ind_create_user);


	    END;
	END-EXEC;


	DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
		DEBUGLOG(("Add:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
		ERRLOG("TxnFeUrl_Add: SP_OTHER_ERR TxnAbort\n");
		DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
		ERRLOG("TxnFeUrl_Add: SP_ERR TxnAbort\n");
		DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

add_error:
	DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;


}




int Delete(const char* method, const char* txn_code, const char* path)
{
	EXEC SQL WHENEVER SQLERROR GOTO delete_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
	        varchar	hv_method[PD_COUNTRY_LEN];
		varchar hv_txn_code[PD_MERCHANT_ID_LEN];

		short	hv_return_value;
	EXEC SQL END DECLARE SECTION;


	hv_method.len = strlen((const char*)method);
	memcpy(hv_method.arr,method,hv_method.len);
DEBUGLOG(("Delete: method = [%.*s]\n",hv_method.len,hv_method.arr));

	hv_txn_code.len = strlen((const char*)txn_code);
	memcpy(hv_txn_code.arr,txn_code,hv_txn_code.len);
DEBUGLOG(("Delete: txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));

	EXEC SQL EXECUTE
	    BEGIN
		
		:hv_return_value := sp_merch_detail_delete(
				:hv_method,
				:hv_txn_code);

	    END;
	END-EXEC;


	DEBUGLOG(("Delete:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("Delete:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
		ERRLOG("TxnFeUrl_Delete: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Delete: SP_OTHER_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
		ERRLOG("TxnFeUrl_Delete: SP_ERR TxnAbort\n");
DEBUGLOG(("Delete: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

delete_error:
	DEBUGLOG(("delete_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;

}
*/


int GetFeUrl(const char* csTxnCode, const char* csServiceCode, char cDirection ,recordset_t* myRec)
{
	int iRet = PD_ERR;
	char csURL[PD_TMP_BUF_LEN + 1];
                
        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO geturl_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_code[PD_TXN_CODE_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                char        	hv_direction;
		char		hv_disabled;
                
                varchar         v_method[PD_METHOD_LEN + 1];
                varchar         v_path[PD_VALUE_LEN + 1];
                varchar         v_url[PD_VALUE_LEN + 1];

                short           ind_method = -1;
                short           ind_path = -1;
                short           ind_url = -1;
        
        
        EXEC SQL END DECLARE SECTION;
        
        hv_txn_code.len = strlen(csTxnCode);
        memcpy(hv_txn_code.arr,csTxnCode,hv_txn_code.len);
DEBUGLOG(("GetFeUrl txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));
        
        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetFeUrl service_code= [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_direction = cDirection;
DEBUGLOG(("GetFeUrl direction= [%c]\n",hv_direction));

	hv_disabled='0';

        EXEC SQL DECLARE c_cursor_geturl CURSOR FOR
                select	a.method,
			a.path,
			b.url
		from	txn_fe_url a,
			service b
		where	a.txn_code = :hv_txn_code
		and	a.service_code = :hv_service_code
		and	a.service_code = b.code
		and	a.direction = :hv_direction
		and	a.disabled = :hv_disabled
		and	b.disabled = :hv_disabled
		AND   	b.effect_date  =
                        (SELECT max(effect_date)
                           FROM service
                          WHERE code=:hv_service_code
                            AND disabled=:hv_disabled
                            AND effect_date <= sysdate)
                AND   	a.effect_date  =
                        (SELECT max(effect_date)
                           FROM txn_fe_url
                          WHERE txn_code=:hv_txn_code
                            AND service_code=:hv_service_code
			    AND direction = :hv_direction
                            AND disabled=:hv_disabled
                            AND effect_date <= sysdate);


        EXEC SQL OPEN c_cursor_geturl;
        do {
                EXEC SQL FETCH c_cursor_geturl
                INTO
                        :v_method:ind_method,
			:v_path:ind_path,
			:v_url:ind_url;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);
/* method */
                if (ind_method >= 0) {
                        v_method.arr[v_method.len] = '\0';
                        PutField_CString(myHash,"method",v_method.arr);
DEBUGLOG(("GetFeUrl method = [%s]\n",v_method.arr));
                }

		if (ind_url >= 0) {
                        v_url.arr[v_url.len] = '\0';
                        strcpy(csURL,v_url.arr);
DEBUGLOG(("URL = [%s]\n",csURL));
                        if (ind_path >= 0) {
                                v_path.arr[v_path.len] = '\0';
DEBUGLOG(("PATH = [%.*s]\n",v_path.len,v_path.arr));
                                strcat((char*)csURL,v_path.arr);
DEBUGLOG(("URL+PATH = [%s]\n",csURL));

				PutField_CString(myHash,"fe_url",csURL);
DEBUGLOG(("GetFeUrl fe_url = [%s]\n",csURL));
				iRet = PD_OK;
			}
			else
DEBUGLOG(("PATH NOT FOUND\n"));
                }
		else
DEBUGLOG(("URL NOT FOUND\n"));


                RecordSet_Add(myRec,myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_geturl;
	
	
DEBUGLOG(("GetFeUrl Normal Exit [%d]\n",iRet));

	return iRet;

geturl_error:
DEBUGLOG(("geturl_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_geturl;
        return PD_ERR;
}


