/*
Partnerdelight. (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/11              Cody Chan
Input pre-selected group list to PickGroup	   2013/09/12		   LokMan Chow
*/
#include <stdio.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "CustomerGroupRules.h"
#include "common.h"
#include "utilitys.h"
#include "myhash.h"
char    cDebug;

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode
#define MY_DELIMITER ","

void CustomerGroupRules(char    cdebug)
{
        cDebug = cdebug;
}


int FindGroupCnt(const char* csMerchantId)
{
        EXEC SQL WHENEVER SQLERROR GOTO find_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_merchant_id[PD_MERCHANT_ID_LEN];

		short	v_cnt;
                short   ind_cnt = -1;

        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("FindGroupCnt: merchant ID = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr)); 

        EXEC SQL SELECT count(*)
                    INTO :v_cnt:ind_cnt
                FROM CUSTOMER_GROUP_RULES
                WHERE CGR_MERCHANT_ID = :hv_merchant_id
		  AND CGR_FROM_GROUP_CODE is null;

        if (ind_cnt >= 0) {
		if (v_cnt > 0) { 
DEBUGLOG(("FindGroupCnt: Found [%d]\n",v_cnt));
                	return FOUND;
		}
		else {
DEBUGLOG(("FindGroupCnt:Not Found\n"));
			return NOT_FOUND;
		}
        }
DEBUGLOG(("FindGroupCnt:Not Found\n"));
        return NOT_FOUND;
find_error:
DEBUGLOG(("find_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return NOT_FOUND;
}

int PickGroup(const char* csMerchantId,	
		const char* csCountryId,
		const char* csChannelCode,
		const char* csServiceCode,
		const char* csCurrencyId,
		const char* csDate,
		const hash_t* hTxn,
		char*	csCustomerGroup)
{
	int	iRet = NOT_FOUND;
	int	i = 0;
	int	iCnt = 0;
	char	*csTmp;
	char	csTag[PD_TAG_LEN+1];

        EXEC SQL WHENEVER SQLERROR GOTO pickgroup_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		short	hv_return_value;

                varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar hv_country_id[PD_COUNTRY_LEN];
                varchar hv_channel_code[PD_CHANNEL_CODE_LEN];
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
                varchar hv_currency_id[PD_CURRENCY_ID_LEN];
                varchar hv_date[PD_DATE_LEN];
                varchar hv_group_list[PD_TMP_BUF_LEN];

		varchar	v_customer_group[PD_CUSTOMER_GROUP_CODE_LEN +1];
                short   ind_customer_group = -1;

		short	ind_merchant_id = -1;
		short	ind_country_id = -1;
		short	ind_channel_code = -1;
		short	ind_service_code = -1;
		short	ind_currency_id = -1;
		short	ind_date = -1;
		short	ind_group_list = -1;

        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("PickGroup: merchant ID = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr)); 
	ind_merchant_id = 0;

        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("PickGroup: country_id  = [%.*s]\n",hv_country_id.len,hv_country_id.arr)); 
	ind_country_id = 0;

        hv_channel_code.len = strlen(csChannelCode);
        memcpy(hv_channel_code.arr,csChannelCode,hv_channel_code.len);
DEBUGLOG(("PickGroup: channel_code  = [%.*s]\n",hv_channel_code.len,hv_channel_code.arr)); 
	ind_channel_code = 0;

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("PickGroup: service_code  = [%.*s]\n",hv_service_code.len,hv_service_code.arr)); 
	ind_service_code = 0;

        hv_currency_id.len = strlen(csCurrencyId);
        memcpy(hv_currency_id.arr,csCurrencyId,hv_currency_id.len);
DEBUGLOG(("PickGroup: currency_id  = [%.*s]\n",hv_currency_id.len,hv_currency_id.arr)); 
	ind_currency_id = 0;

        hv_date.len = strlen(csDate);
        memcpy(hv_date.arr,csDate,hv_date.len);
DEBUGLOG(("PickGroup: date = [%.*s]\n",hv_date.len,hv_date.arr)); 
	ind_date = 0;

	if(GetField_Int(hTxn,"group_cnt",&iCnt)){
DEBUGLOG(("PickGroup: group_cnt = [%d]\n",iCnt)); 
	}

	hv_group_list.arr[0]='\0';

	for (i=0; i<iCnt; i++){
		sprintf(csTag,"customer_group_%d",i);
		if(GetField_CString(hTxn,csTag,&csTmp)){
DEBUGLOG(("PickGroup: customer_group[%d] = [%s]\n",i,csTmp)); 
			if(i>0) strcat((char*)hv_group_list.arr,MY_DELIMITER);
			strcat((char*)hv_group_list.arr,csTmp);
			hv_group_list.len = strlen((char*)hv_group_list.arr);
		}
		ind_group_list = 0;
	}
DEBUGLOG(("PickGroup: group_list = [%.*s]\n",hv_group_list.len,hv_group_list.arr)); 


	EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_customer_group_pickgroup(
						:hv_merchant_id:ind_merchant_id,
						:hv_country_id:ind_country_id,
						:hv_channel_code:ind_channel_code,
						:hv_service_code:ind_service_code,
						:hv_currency_id:ind_currency_id,
						:hv_date:ind_date,
						:hv_group_list:ind_group_list,
						:v_customer_group:ind_customer_group);
		END;
        END-EXEC;

	if (hv_return_value == SP_OK) {
		if (ind_customer_group >= 0) {
			v_customer_group.arr[v_customer_group.len] = '\0';
			strcpy(csCustomerGroup,(const char*)v_customer_group.arr);
DEBUGLOG(("PickGroup: customer group [%s] found\n",v_customer_group.arr));
			iRet = FOUND;
		}

	}
	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("CustomerGroupRules_PickGroup: SP_OTHER_ERR\n");
DEBUGLOG(("PickGroup: SP_OTHER_ERR\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("CustomerGroupRules_PickGroup: SP_ERR\n");
DEBUGLOG(("PickGroup: SP_ERR\n"));
                return PD_ERR;
        }

DEBUGLOG(("PickGroup :iRet = [%d]\n",iRet));
        return iRet;

pickgroup_error:
DEBUGLOG(("pickgroup_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return NOT_FOUND;
}


int PickPromoteGroup(const char* csMerchantId,	
		const char* csCountryId,
		const char* csChannelCode,
		const char* csServiceCode,
		const char* csCurrencyId,
		const char* csDate,
		const char* csFromGroup,
		const hash_t* hTxn,
		char*	csCustomerGroup)
{
	int	iRet = NOT_FOUND;
	int	i = 0;
	int	iCnt = 0;
	char	*csTmp;
	char	csTag[PD_TAG_LEN+1];

        EXEC SQL WHENEVER SQLERROR GOTO pickpmgroup_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		short	hv_return_value;

                varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar hv_country_id[PD_COUNTRY_LEN];
                varchar hv_channel_code[PD_CHANNEL_CODE_LEN];
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
                varchar hv_currency_id[PD_CURRENCY_ID_LEN];
                varchar hv_date[PD_DATE_LEN];
		varchar	hv_from_group[PD_CUSTOMER_GROUP_CODE_LEN];
                varchar hv_group_list[PD_TMP_BUF_LEN];

		varchar	v_customer_group[PD_CUSTOMER_GROUP_CODE_LEN +1];
                short   ind_customer_group = -1;

		short	ind_merchant_id = -1;
		short	ind_country_id = -1;
		short	ind_channel_code = -1;
		short	ind_service_code = -1;
		short	ind_currency_id = -1;
		short	ind_date = -1;
		short	ind_from_group = -1;
		short	ind_group_list = -1;

        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("PickPromoteGroup: merchant ID = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr)); 
	ind_merchant_id = 0;

        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("PickPromoteGroup: country_id  = [%.*s]\n",hv_country_id.len,hv_country_id.arr)); 
	ind_country_id = 0;

        hv_channel_code.len = strlen(csChannelCode);
        memcpy(hv_channel_code.arr,csChannelCode,hv_channel_code.len);
DEBUGLOG(("PickPromoteGroup: channel_code  = [%.*s]\n",hv_channel_code.len,hv_channel_code.arr)); 
	ind_channel_code = 0;

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("PickPromoteGroup: service_code  = [%.*s]\n",hv_service_code.len,hv_service_code.arr)); 
	ind_service_code = 0;

        hv_currency_id.len = strlen(csCurrencyId);
        memcpy(hv_currency_id.arr,csCurrencyId,hv_currency_id.len);
DEBUGLOG(("PickPromoteGroup: currency_id  = [%.*s]\n",hv_currency_id.len,hv_currency_id.arr)); 
	ind_currency_id = 0;

        hv_date.len = strlen(csDate);
        memcpy(hv_date.arr,csDate,hv_date.len);
DEBUGLOG(("PickPromoteGroup: date = [%.*s]\n",hv_date.len,hv_date.arr)); 
	ind_date = 0;

        hv_from_group.len = strlen(csFromGroup);
        memcpy(hv_from_group.arr,csFromGroup,hv_from_group.len);
DEBUGLOG(("PickPromoteGroup: from_group = [%.*s]\n",hv_from_group.len,hv_from_group.arr)); 
	ind_from_group = 0;

	if(GetField_Int(hTxn,"group_cnt",&iCnt)){
DEBUGLOG(("PickPromoteGroup: group_cnt = [%d]\n",iCnt)); 
	}

	hv_group_list.arr[0]='\0';

	for (i=0; i<iCnt; i++){
		sprintf(csTag,"customer_group_%d",i);
		if(GetField_CString(hTxn,csTag,&csTmp)){
DEBUGLOG(("PickPromoteGroup: customer_group[%d] = [%s]\n",i,csTmp)); 
			if(i>0) strcat((char*)hv_group_list.arr,MY_DELIMITER);
			strcat((char*)hv_group_list.arr,csTmp);
			hv_group_list.len = strlen((char*)hv_group_list.arr);
		}
		ind_group_list = 0;
	}
DEBUGLOG(("PickPromoteGroup: group_list = [%.*s]\n",hv_group_list.len,hv_group_list.arr)); 


	EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_customer_group_pickpmgroup(
						:hv_merchant_id:ind_merchant_id,
						:hv_country_id:ind_country_id,
						:hv_channel_code:ind_channel_code,
						:hv_service_code:ind_service_code,
						:hv_currency_id:ind_currency_id,
						:hv_date:ind_date,
						:hv_from_group:ind_from_group,
						:hv_group_list:ind_group_list,
						:v_customer_group:ind_customer_group);
		END;
        END-EXEC;

	if (hv_return_value == SP_OK) {
		if (ind_customer_group >= 0) {
			v_customer_group.arr[v_customer_group.len] = '\0';
			strcpy(csCustomerGroup,(const char*)v_customer_group.arr);
DEBUGLOG(("PickPromoteGroup: customer group [%s] found\n",csCustomerGroup));
			iRet = FOUND;
		}

	}
	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("CustomerGroupRules_PickPromoteGroup: SP_OTHER_ERR\n");
DEBUGLOG(("PickPromoteGroup: SP_OTHER_ERR\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("CustomerGroupRules_PickPromoteGroup: SP_ERR\n");
DEBUGLOG(("PickPromoteGroup: SP_ERR\n"));
                return PD_ERR;
        }

DEBUGLOG(("PickPromoteGroup :iRet = [%d]\n",iRet));
        return iRet;

pickpmgroup_error:
DEBUGLOG(("pickpmgroup_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return NOT_FOUND;
}
