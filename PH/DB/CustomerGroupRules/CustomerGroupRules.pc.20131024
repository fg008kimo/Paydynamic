/*
Partnerdelight. (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/11              Cody Chan
Input pre-selected group list to PickGroup	   2013/09/12		   LokMan Chow
*/
#include <stdio.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "CustomerGroupRules.h"
#include "common.h"
#include "utilitys.h"
#include "myhash.h"
char    cDebug;

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

void CustomerGroupRules(char    cdebug)
{
        cDebug = cdebug;
}


int FindGroupCnt(const char* csMerchantId)
{
        EXEC SQL WHENEVER SQLERROR GOTO find_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_merchant_id[PD_MERCHANT_ID_LEN];

		short	v_cnt;
                short   ind_cnt = -1;

        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("FindGroupCnt: merchant ID = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr)); 

        EXEC SQL SELECT count(*)
                    INTO :v_cnt:ind_cnt
                FROM CUSTOMER_GROUP_RULES
                WHERE CGR_MERCHANT_ID = :hv_merchant_id
		  AND CGR_FROM_GROUP_CODE is null;

        if (ind_cnt >= 0) {
		if (v_cnt > 0) { 
DEBUGLOG(("FindGroupCnt: Found [%d]\n",v_cnt));
                	return FOUND;
		}
		else {
DEBUGLOG(("FindGroupCnt:Not Found\n"));
			return NOT_FOUND;
		}
        }
DEBUGLOG(("FindGroupCnt:Not Found\n"));
        return NOT_FOUND;
find_error:
DEBUGLOG(("find_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return NOT_FOUND;
}

int PickGroup(const char* csMerchantId,	
		const char* csCountryId,
		const char* csChannelCode,
		const char* csServiceCode,
		const char* csCurrencyId,
		const char* csCategory,
		const hash_t* hTxn,
		char*	csCustomerGroup)
{
	int	iRet = NOT_FOUND;
	int	i = 0;
	int	iCnt = 0;
	char	*csTmp;
	char	csTag[PD_TAG_LEN+1];

        EXEC SQL WHENEVER SQLERROR GOTO pickgroup_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar hv_country_id[PD_COUNTRY_LEN];
                varchar hv_channel_code[PD_CHANNEL_CODE_LEN];
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
                varchar hv_currency_id[PD_CURRENCY_ID_LEN];
                varchar hv_category[PD_CATEGORY_LEN];

		varchar	v_customer_group[PD_CUSTOMER_GROUP_CODE_LEN +1];
                short   ind_customer_group = -1;

		varchar         hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("PickGroup: merchant ID = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr)); 

        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("PickGroup: country_id  = [%.*s]\n",hv_country_id.len,hv_country_id.arr)); 

        hv_channel_code.len = strlen(csChannelCode);
        memcpy(hv_channel_code.arr,csChannelCode,hv_channel_code.len);
DEBUGLOG(("PickGroup: channel_code  = [%.*s]\n",hv_channel_code.len,hv_channel_code.arr)); 

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("PickGroup: service_code  = [%.*s]\n",hv_service_code.len,hv_service_code.arr)); 

        hv_currency_id.len = strlen(csCurrencyId);
        memcpy(hv_currency_id.arr,csCurrencyId,hv_currency_id.len);
DEBUGLOG(("PickGroup: currency_id  = [%.*s]\n",hv_currency_id.len,hv_currency_id.arr)); 

        hv_category.len = strlen(csCategory);
        memcpy(hv_category.arr,csCategory,hv_category.len);
DEBUGLOG(("PickGroup: category  = [%.*s]\n",hv_category.len,hv_category.arr)); 

	if(GetField_Int(hTxn,"group_cnt",&iCnt)){
DEBUGLOG(("PickGroup: group_cnt = [%d]\n",iCnt)); 
	}

	strcpy((char*)hv_dynstmt.arr,"SELECT cgr_group_code FROM (SELECT cgr_group_code");
	strcat((char*)hv_dynstmt.arr," FROM (  SELECT SUM (NVL (cgc_counter, 0)) AS cgc_counter,cgr_group_code FROM customer_group_counters,");
	strcat((char*)hv_dynstmt.arr,"(SELECT cgr_group_code FROM customer_group_rules WHERE ");
	strcat((char*)hv_dynstmt.arr," cgr_merchant_id = '");
	strcat((char*)hv_dynstmt.arr, csMerchantId);
	strcat((char*)hv_dynstmt.arr,"'");
	strcat((char*)hv_dynstmt.arr," AND cgr_from_group_code IS NULL AND cgr_disabled = 0)");
	strcat((char*)hv_dynstmt.arr," WHERE cgc_code(+) = cgr_group_code");
	strcat((char*)hv_dynstmt.arr," AND cgc_country_id(+) = '");
	strcat((char*)hv_dynstmt.arr, csCountryId);
	strcat((char*)hv_dynstmt.arr,"'");
	strcat((char*)hv_dynstmt.arr," AND cgc_channel_code(+) = '");
	strcat((char*)hv_dynstmt.arr,csChannelCode);
	strcat((char*)hv_dynstmt.arr,"'");
	strcat((char*)hv_dynstmt.arr," AND cgc_service_code(+) = '");
	strcat((char*)hv_dynstmt.arr,csServiceCode);
	strcat((char*)hv_dynstmt.arr,"'");
	strcat((char*)hv_dynstmt.arr," AND cgc_currency_id(+) = '");
	strcat((char*)hv_dynstmt.arr,csCurrencyId);
	strcat((char*)hv_dynstmt.arr,"'");
	strcat((char*)hv_dynstmt.arr," AND cgc_category(+) = '");
	strcat((char*)hv_dynstmt.arr,csCategory);
	strcat((char*)hv_dynstmt.arr,"'");
	strcat((char*)hv_dynstmt.arr," GROUP BY cgr_group_code) ");
	strcat((char*)hv_dynstmt.arr," WHERE cgc_counter = (select min(cgc_counter) ");
	strcat((char*)hv_dynstmt.arr," FROM (  SELECT SUM (NVL (cgc_counter, 0)) AS cgc_counter,cgr_group_code FROM customer_group_counters,");
	strcat((char*)hv_dynstmt.arr,"(SELECT cgr_group_code FROM customer_group_rules WHERE ");
	strcat((char*)hv_dynstmt.arr," cgr_merchant_id = '");
	strcat((char*)hv_dynstmt.arr, csMerchantId);
	strcat((char*)hv_dynstmt.arr,"'");
	strcat((char*)hv_dynstmt.arr," AND cgr_from_group_code IS NULL AND cgr_disabled = 0)");
	strcat((char*)hv_dynstmt.arr," WHERE cgc_code(+) = cgr_group_code");
	strcat((char*)hv_dynstmt.arr," AND cgc_country_id(+) = '");
	strcat((char*)hv_dynstmt.arr, csCountryId);
	strcat((char*)hv_dynstmt.arr,"'");
	strcat((char*)hv_dynstmt.arr," AND cgc_channel_code(+) = '");
	strcat((char*)hv_dynstmt.arr,csChannelCode);
	strcat((char*)hv_dynstmt.arr,"'");
	strcat((char*)hv_dynstmt.arr," AND cgc_service_code(+) = '");
	strcat((char*)hv_dynstmt.arr,csServiceCode);
	strcat((char*)hv_dynstmt.arr,"'");
	strcat((char*)hv_dynstmt.arr," AND cgc_currency_id(+) = '");
	strcat((char*)hv_dynstmt.arr,csCurrencyId);
	strcat((char*)hv_dynstmt.arr,"'");
	strcat((char*)hv_dynstmt.arr," AND cgc_category(+) = '");
	strcat((char*)hv_dynstmt.arr,csCategory);
	strcat((char*)hv_dynstmt.arr,"'");
	strcat((char*)hv_dynstmt.arr," GROUP BY cgr_group_code)) ");

	if (iCnt>0) strcat((char*)hv_dynstmt.arr," AND cgr_group_code in (");
	for (i=0; i<iCnt; i++){
		sprintf(csTag,"customer_group_%d",i);
		if(GetField_CString(hTxn,csTag,&csTmp)){
			if(i>0) strcat((char*)hv_dynstmt.arr,",'");
			else	strcat((char*)hv_dynstmt.arr,"'");
			strcat((char*)hv_dynstmt.arr,csTmp);
			strcat((char*)hv_dynstmt.arr,"'");
DEBUGLOG(("PickGroup: customer_group[%d] = [%s]\n",i,csTmp)); 
		}
	}
	if (iCnt>0) strcat((char*)hv_dynstmt.arr,")");
	strcat((char*)hv_dynstmt.arr," ORDER BY DBMS_RANDOM.VALUE)");
	strcat((char*)hv_dynstmt.arr," WHERE ROWNUM = 1");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL DECLARE c_cursor_get_grp CURSOR FOR PS;

	EXEC SQL OPEN c_cursor_get_grp;
        do {
                EXEC SQL FETCH c_cursor_get_grp
                INTO
			:v_customer_group:ind_customer_group;


		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

		if (ind_customer_group >= 0) {
			v_customer_group.arr[v_customer_group.len] = '\0';
			strcpy(csCustomerGroup,(const char*)v_customer_group.arr);
DEBUGLOG(("FindGroup: customer group [%s] found\n",v_customer_group.arr));
			iRet = FOUND;
		}
		break;///only one
	}while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_get_grp;


DEBUGLOG(("PickGroup :iRet = [%d]\n",iRet));
        return iRet;

pickgroup_error:
DEBUGLOG(("pickgroup_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL CLOSE c_cursor_get_grp;
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return NOT_FOUND;
}
