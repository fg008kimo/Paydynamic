DROP FUNCTION sp_customer_group_pickpmgroup;

CREATE OR REPLACE FUNCTION sp_customer_group_pickpmgroup (
   in_merchant_id           customer_group_rules.cgr_merchant_id%TYPE,
   in_country_id            customer_group_counters.cgc_country_id%TYPE,
   in_channel_code          customer_group_counters.cgc_channel_code%TYPE,
   in_service_code          customer_group_counters.cgc_service_code%TYPE,
   in_ccy                   customer_group_counters.cgc_currency_id%TYPE,
   in_date                  customer_group_counters.cgc_date%TYPE,
   in_from_group            customer_group_counters.cgc_code%TYPE,
   in_grp_list              VARCHAR2,
   out_customer_group   OUT customer_group_counters.cgc_code%TYPE)
   RETURN NUMBER
IS
BEGIN
   SELECT code
     INTO out_customer_group
     FROM (  SELECT code
               FROM (  SELECT code, SUM (counter) counter
                         FROM (  SELECT cgc_code code,
                                        cgc_country_id country,
                                        cgc_channel_code channel,
                                        cgc_service_code service,
                                        cgc_currency_id ccy,
                                        SUM (cgc_counter + cgc_delta_changes) counter
                                   FROM customer_group_counters
                                  WHERE     cgc_date BETWEEN TO_CHAR (
                                                                  TO_DATE (
                                                                     in_date,
                                                                     'YYYYMMDD')
                                                                - 29,
                                                                'YYYYMMDD')
                                                         AND in_date
                                        AND cgc_category = 'AMT'
                               GROUP BY cgc_code,
                                        cgc_country_id,
                                        cgc_channel_code,
                                        cgc_service_code,
                                        cgc_currency_id
                               UNION ALL
                               SELECT cgo_code code,
                                      cgo_country_id country,
                                      cgo_channel_code channel,
                                      cgo_service_code service,
                                      cgo_currency_id ccy,
                                      cgo_counter counter
                                 FROM customer_group_offset_count),
                              (SELECT cgr_group_code
                                 FROM customer_group_rules
                                WHERE     cgr_merchant_id = in_merchant_id
                                      AND cgr_from_group_code IS NULL
                                      AND cgr_disabled = 0)
                        WHERE     cgr_group_code = code
                              AND country = in_country_id
                              AND channel = in_channel_code
                              AND service = in_service_code
                              AND ccy = in_ccy
                     GROUP BY code)
              WHERE counter =
                       (SELECT MIN (counter)
                          FROM (  SELECT code, SUM (counter) counter
                                    FROM (  SELECT cgc_code code,
                                                   cgc_country_id country,
                                                   cgc_channel_code channel,
                                                   cgc_service_code service,
                                                   cgc_currency_id ccy,
                                                   SUM (cgc_counter + cgc_delta_changes) counter
                                              FROM customer_group_counters
                                             WHERE     cgc_date BETWEEN TO_CHAR (
                                                                             TO_DATE (
                                                                                in_date,
                                                                                'YYYYMMDD')
                                                                           - 29,
                                                                           'YYYYMMDD')
                                                                    AND in_date
                                                   AND cgc_category = 'AMT'
                                          GROUP BY cgc_code,
                                                   cgc_country_id,
                                                   cgc_channel_code,
                                                   cgc_service_code,
                                                   cgc_currency_id
                                          UNION ALL
                                          SELECT cgo_code code,
                                                 cgo_country_id country,
                                                 cgo_channel_code channel,
                                                 cgo_service_code service,
                                                 cgo_currency_id ccy,
                                                 cgo_counter counter
                                            FROM customer_group_offset_count),
                                         (SELECT cgr_group_code
                                            FROM customer_group_rules
                                           WHERE     cgr_merchant_id =
                                                        in_merchant_id
                                                 AND cgr_from_group_code = in_from_group 
                                                 AND cgr_disabled = 0
                                                 AND cgr_group_code IN (    SELECT REGEXP_SUBSTR (
                                                                                      in_grp_list,
                                                                                      '[^,]+',
                                                                                      1,
                                                                                      LEVEL)
                                                                                      token
                                                                              FROM DUAL
                                                                        CONNECT BY LEVEL <=
                                                                                        LENGTH (
                                                                                           in_grp_list)
                                                                                      - LENGTH (
                                                                                           REPLACE (
                                                                                              in_grp_list,
                                                                                              ',',
                                                                                              ''))
                                                                                      + 1))
                                   WHERE     cgr_group_code = code
                                         AND country = in_country_id
                                         AND channel = in_channel_code
                                         AND service = in_service_code
                                         AND ccy = in_ccy
                                GROUP BY code))
           ORDER BY DBMS_RANDOM.VALUE)
    WHERE ROWNUM = 1;

    return 0;

EXCEPTION
   WHEN OTHERS
   THEN
      RETURN 9;
END sp_customer_group_pickpmgroup;
/
