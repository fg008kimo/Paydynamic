/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/01/09              Dirk Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLTxnRelation.h"
#include "common.h"
#include "internal.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void OLTxnRelation(char    cdebug)
{
        cDebug = cdebug;
}

int Add(const hash_t *hRls)
{
	char	cTmp;
	char*	csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		char		hv_party;
		varchar		hv_p1_txn_id[PD_TXN_SEQ_LEN];
		varchar		hv_p2_txn_id[PD_TXN_SEQ_LEN];
		char		hv_txn_level;
		char		hv_relation_type;
		varchar         hv_create_user[PD_USER_LEN];

		short		ind_party = -1;
		short		ind_p1_txn_id = -1;
		short		ind_p2_txn_id = -1;
		short		ind_txn_level = -1;
		short		ind_relation_type = -1;
		short		ind_create_user = -1;

		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;
DEBUGLOG(("Add: Begin\n"));

	if (GetField_Char(hRls,"party",&cTmp)) {
		hv_party = cTmp;
		ind_party = 0;
DEBUGLOG(("Add: party = [%c]\n",hv_party));
	}

	if (GetField_CString(hRls,"p1_txn_id",&csTmp)) {
		hv_p1_txn_id.len = strlen(csTmp);
		strncpy((char*)hv_p1_txn_id.arr, csTmp, hv_p1_txn_id.len);
		ind_p1_txn_id = 0;
DEBUGLOG(("Add: p1_txn_id = [%s]\n",(char*)hv_p1_txn_id.arr));
	}

	if (GetField_CString(hRls,"p2_txn_id",&csTmp)) {
		hv_p2_txn_id.len = strlen(csTmp);
		strncpy((char*)hv_p2_txn_id.arr, csTmp, hv_p2_txn_id.len);
		ind_p2_txn_id = 0;
DEBUGLOG(("Add: p2_txn_id = [%s]\n",(char*)hv_p2_txn_id.arr));
	}

	if (GetField_Char(hRls,"txn_level",&cTmp)) {
		hv_txn_level = cTmp;
		ind_txn_level = 0;
DEBUGLOG(("Add: txn_level =  [%c]\n",hv_txn_level));
	}

	if (GetField_Char(hRls,"relation_type",&cTmp)) {
		hv_relation_type = cTmp;
		ind_relation_type = 0;
DEBUGLOG(("Add: relation_type = [%c]\n",hv_relation_type));
	}

	if(GetField_CString(hRls,"create_user",&csTmp))
	{
		hv_create_user.len = strlen(csTmp);
		strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
	}
DEBUGLOG(("Add: create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_txn_relation_insert(
						:hv_party:ind_party,
						:hv_p1_txn_id:ind_p1_txn_id,
						:hv_p2_txn_id:ind_p2_txn_id,
						:hv_txn_level:ind_txn_level,
						:hv_relation_type:ind_relation_type,
                                                :hv_create_user:ind_create_user);
		END;
	END-EXEC;

	DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("Add:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("OLTxnRelation_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	} 

	if (hv_return_value == SP_ERR)  {
ERRLOG("OLTxnRelation_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTxnRelation_Add: SP_INTERNAL_ERR TxnAbort\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}

int GetP1TxnId(const hash_t* hRls, recordset_t* rRecordSet)
{
	int iRet = PD_FOUND;
        
	int iCnt = 0;

        char *csTmp;
        char cTmp;

        hash_t *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO getp1txnid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                char            hv_party_type;
                varchar         hv_p2_txn_id[PD_TXN_SEQ_LEN];
                char            hv_txn_level;
                char            hv_relation_type;

                varchar         v_p1_txn_id[PD_TXN_SEQ_LEN];
                short           ind_p1_txn_id = -1;
        EXEC SQL END DECLARE SECTION;

/* party_type */
        if (GetField_Char(hRls, "party_type", &cTmp)) {
                hv_party_type = cTmp;
DEBUGLOG(("GetP1TxnId: party_type = [%c]\n", hv_party_type));
        }

/* p2_txn_id */
        if (GetField_CString(hRls,"p2_txn_id",&csTmp)) {
                hv_p2_txn_id.len = strlen(csTmp);
                strncpy((char*)hv_p2_txn_id.arr, csTmp, hv_p2_txn_id.len);
DEBUGLOG(("GetP1TxnId: p2_txn_id = [%s]\n",(char*)hv_p2_txn_id.arr));
        }

/* txn_level */
        if (GetField_Char(hRls, "txn_level", &cTmp)) {
                hv_txn_level = cTmp;
DEBUGLOG(("GetP1TxnId: txn_level = [%c]\n", hv_txn_level));
        }
	
/* relation_type */
        if (GetField_Char(hRls, "relation_type", &cTmp)) {
                hv_relation_type = cTmp;
DEBUGLOG(("GetP1TxnId: relation_type = [%c]\n", hv_relation_type));
        }

	EXEC SQL DECLARE c_cursor_getp1txnid CURSOR FOR
                SELECT  otr_p1_txn_id
                FROM    ol_txn_relation
                WHERE   otr_party_type = :hv_party_type
                AND     otr_p2_txn_id = :hv_p2_txn_id
                AND     otr_txn_level = :hv_txn_level
                AND     otr_relation_type = :hv_relation_type
                ORDER BY otr_relation_timestamp ASC;
        EXEC SQL OPEN c_cursor_getp1txnid;
	
	for (;;) {
                EXEC SQL FETCH c_cursor_getp1txnid
                INTO    :v_p1_txn_id:ind_p1_txn_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
	
		iCnt++;
	
                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash, 0);

                // p1_txn_id
                if (ind_p1_txn_id >= 0) {
                        v_p1_txn_id.arr[v_p1_txn_id.len] = '\0';
                        PutField_CString(myHash, "p1_txn_id", (const char*)v_p1_txn_id.arr);
DEBUGLOG(("GetP1TxnId: p1_txn_id = [%s]\n", (const char*)v_p1_txn_id.arr));
                }

                RecordSet_Add(rRecordSet, myHash);
        }

        EXEC SQL CLOSE c_cursor_getp1txnid;

	if (iCnt > 0) {
                iRet = PD_FOUND;
DEBUGLOG(("GetP1TxnId FOUND\n"));
        } else {
                iRet = PD_NOT_FOUND;
DEBUGLOG(("GetP1TxnId NOT FOUND!!!\n"));
        }


DEBUGLOG(("GetP1TxnId: Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

getp1txnid_error:
DEBUGLOG(("getp1txnid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTxnRelation getp1txnid_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL CLOSE c_cursor_getp1txnid;
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int GetP2TxnId(const hash_t* hRls, recordset_t* rRecordSet)
{
	int iRet = PD_FOUND;

        int iCnt = 0;

        char *csTmp;
        char cTmp;

        hash_t *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO getp2txnid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                char            hv_party_type;
                varchar         hv_p1_txn_id[PD_TXN_SEQ_LEN];
                char            hv_txn_level;
                char            hv_relation_type;

                varchar         v_p2_txn_id[PD_TXN_SEQ_LEN];
                short           ind_p2_txn_id = -1;
        EXEC SQL END DECLARE SECTION;

/* party_type */
        if (GetField_Char(hRls, "party_type", &cTmp)) {
                hv_party_type = cTmp;
DEBUGLOG(("GetP2TxnId: party_type = [%c]\n", hv_party_type));
        }

/* p1_txn_id */
        if (GetField_CString(hRls,"p1_txn_id",&csTmp)) {
                hv_p1_txn_id.len = strlen(csTmp);
                strncpy((char*)hv_p1_txn_id.arr, csTmp, hv_p1_txn_id.len);
DEBUGLOG(("GetP2TxnId: p1_txn_id = [%s]\n",(char*)hv_p1_txn_id.arr));
        }

/* txn_level */
        if (GetField_Char(hRls, "txn_level", &cTmp)) {
                hv_txn_level = cTmp;
DEBUGLOG(("GetP2TxnId: txn_level = [%c]\n", hv_txn_level));
        }
	
/* relation_type */
        if (GetField_Char(hRls, "relation_type", &cTmp)) {
                hv_relation_type = cTmp;
DEBUGLOG(("GetP2TxnId: relation_type = [%c]\n", hv_relation_type));
        }

	EXEC SQL DECLARE c_cursor_getp2txnid CURSOR FOR
                SELECT  otr_p2_txn_id
                FROM    ol_txn_relation
                WHERE   otr_party_type = :hv_party_type
                AND     otr_p1_txn_id = :hv_p1_txn_id
                AND     otr_txn_level = :hv_txn_level
                AND     otr_relation_type = :hv_relation_type
                ORDER BY otr_relation_timestamp ASC;
        EXEC SQL OPEN c_cursor_getp2txnid;
	
	for (;;) {
                EXEC SQL FETCH c_cursor_getp2txnid
                INTO    :v_p2_txn_id:ind_p2_txn_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

		iCnt++;

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash, 0);

                // p2_txn_id
                if (ind_p2_txn_id >= 0) {
                        v_p2_txn_id.arr[v_p2_txn_id.len] = '\0';
                        PutField_CString(myHash, "p2_txn_id", (const char*)v_p2_txn_id.arr);
DEBUGLOG(("GetP2TxnId: p2_txn_id = [%s]\n", (const char*)v_p2_txn_id.arr));
                }

                RecordSet_Add(rRecordSet, myHash);
        }

        EXEC SQL CLOSE c_cursor_getp1txnid;

	
        if (iCnt > 0) {
                iRet = PD_FOUND;
DEBUGLOG(("GetP2TxnId FOUND\n"));
        } else {
                iRet = PD_NOT_FOUND;
DEBUGLOG(("GetP2TxnId NOT FOUND!!!\n"));
        }

DEBUGLOG(("GetP2TxnId: Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

getp2txnid_error:
DEBUGLOG(("getp2txnid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTxnRelation getp2txnid_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL CLOSE c_cursor_getp2txnid;
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}
	
