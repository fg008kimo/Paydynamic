/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/01/09              Dirk Wong
Add GetRelatedTxnId				   2015/02/13		   Dirk Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLTxnRelation.h"
#include "common.h"
#include "internal.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void OLTxnRelation(char    cdebug)
{
        cDebug = cdebug;
}

int Add(const hash_t *hRls)
{
	char	cTmp;
	char*	csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		char		hv_party;
		varchar		hv_p1_txn_id[PD_TXN_SEQ_LEN];
		varchar		hv_p2_txn_id[PD_TXN_SEQ_LEN];
		char		hv_txn_level;
		char		hv_relation_type;
		varchar         hv_create_user[PD_USER_LEN];

		short		ind_party = -1;
		short		ind_p1_txn_id = -1;
		short		ind_p2_txn_id = -1;
		short		ind_txn_level = -1;
		short		ind_relation_type = -1;
		short		ind_create_user = -1;

		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;
DEBUGLOG(("Add: Begin\n"));

	if (GetField_Char(hRls,"party",&cTmp)) {
		hv_party = cTmp;
		ind_party = 0;
DEBUGLOG(("Add: party = [%c]\n",hv_party));
	}

	if (GetField_CString(hRls,"p1_txn_id",&csTmp)) {
		hv_p1_txn_id.len = strlen(csTmp);
		strncpy((char*)hv_p1_txn_id.arr, csTmp, hv_p1_txn_id.len);
		ind_p1_txn_id = 0;
DEBUGLOG(("Add: p1_txn_id = [%s]\n",(char*)hv_p1_txn_id.arr));
	}

	if (GetField_CString(hRls,"p2_txn_id",&csTmp)) {
		hv_p2_txn_id.len = strlen(csTmp);
		strncpy((char*)hv_p2_txn_id.arr, csTmp, hv_p2_txn_id.len);
		ind_p2_txn_id = 0;
DEBUGLOG(("Add: p2_txn_id = [%s]\n",(char*)hv_p2_txn_id.arr));
	}

	if (GetField_Char(hRls,"txn_level",&cTmp)) {
		hv_txn_level = cTmp;
		ind_txn_level = 0;
DEBUGLOG(("Add: txn_level =  [%c]\n",hv_txn_level));
	}

	if (GetField_Char(hRls,"relation_type",&cTmp)) {
		hv_relation_type = cTmp;
		ind_relation_type = 0;
DEBUGLOG(("Add: relation_type = [%c]\n",hv_relation_type));
	}

	if(GetField_CString(hRls,"create_user",&csTmp))
	{
		hv_create_user.len = strlen(csTmp);
		strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
	}
DEBUGLOG(("Add: create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_txn_relation_insert(
						:hv_party:ind_party,
						:hv_p1_txn_id:ind_p1_txn_id,
						:hv_p2_txn_id:ind_p2_txn_id,
						:hv_txn_level:ind_txn_level,
						:hv_relation_type:ind_relation_type,
                                                :hv_create_user:ind_create_user);
		END;
	END-EXEC;

	DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("Add:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("OLTxnRelation_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	} 

	if (hv_return_value == SP_ERR)  {
ERRLOG("OLTxnRelation_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTxnRelation_Add: SP_INTERNAL_ERR TxnAbort\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}

int GetP1TxnId(const hash_t* hRls, recordset_t* rRecordSet)
{
	int iRet = PD_FOUND;
        
	int iCnt = 0;

        char *csTmp;
        char cTmp;

        hash_t *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO getp1txnid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                char            hv_party_type;
                varchar         hv_p2_txn_id[PD_TXN_SEQ_LEN];
                char            hv_txn_level;
                char            hv_relation_type;

                varchar         v_p1_txn_id[PD_TXN_SEQ_LEN];
                short           ind_p1_txn_id = -1;
        EXEC SQL END DECLARE SECTION;

/* party_type */
        if (GetField_Char(hRls, "party_type", &cTmp)) {
                hv_party_type = cTmp;
DEBUGLOG(("GetP1TxnId: party_type = [%c]\n", hv_party_type));
        }

/* p2_txn_id */
        if (GetField_CString(hRls,"p2_txn_id",&csTmp)) {
                hv_p2_txn_id.len = strlen(csTmp);
                strncpy((char*)hv_p2_txn_id.arr, csTmp, hv_p2_txn_id.len);
DEBUGLOG(("GetP1TxnId: p2_txn_id = [%s]\n",(char*)hv_p2_txn_id.arr));
        }

/* txn_level */
        if (GetField_Char(hRls, "txn_level", &cTmp)) {
                hv_txn_level = cTmp;
DEBUGLOG(("GetP1TxnId: txn_level = [%c]\n", hv_txn_level));
        }
	
/* relation_type */
        if (GetField_Char(hRls, "relation_type", &cTmp)) {
                hv_relation_type = cTmp;
DEBUGLOG(("GetP1TxnId: relation_type = [%c]\n", hv_relation_type));
        }

	EXEC SQL DECLARE c_cursor_getp1txnid CURSOR FOR
                SELECT  otr_p1_txn_id
                FROM    ol_txn_relation
                WHERE   otr_party_type = :hv_party_type
                AND     otr_p2_txn_id = :hv_p2_txn_id
                AND     otr_txn_level = :hv_txn_level
                AND     otr_relation_type = :hv_relation_type
                ORDER BY otr_relation_timestamp ASC;
        EXEC SQL OPEN c_cursor_getp1txnid;
	
	for (;;) {
                EXEC SQL FETCH c_cursor_getp1txnid
                INTO    :v_p1_txn_id:ind_p1_txn_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
	
		iCnt++;
	
                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash, 0);

                // p1_txn_id
                if (ind_p1_txn_id >= 0) {
                        v_p1_txn_id.arr[v_p1_txn_id.len] = '\0';
                        PutField_CString(myHash, "p1_txn_id", (const char*)v_p1_txn_id.arr);
DEBUGLOG(("GetP1TxnId: p1_txn_id = [%s]\n", (const char*)v_p1_txn_id.arr));
                }

                RecordSet_Add(rRecordSet, myHash);
        }

        EXEC SQL CLOSE c_cursor_getp1txnid;

	if (iCnt > 0) {
                iRet = PD_FOUND;
DEBUGLOG(("GetP1TxnId FOUND\n"));
        } else {
                iRet = PD_NOT_FOUND;
DEBUGLOG(("GetP1TxnId NOT FOUND!!!\n"));
        }


DEBUGLOG(("GetP1TxnId: Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

getp1txnid_error:
DEBUGLOG(("getp1txnid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTxnRelation getp1txnid_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL CLOSE c_cursor_getp1txnid;
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int GetP2TxnId(const hash_t* hRls, recordset_t* rRecordSet)
{
	int iRet = PD_FOUND;

        int iCnt = 0;

        char *csTmp;
        char cTmp;

        hash_t *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO getp2txnid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                char            hv_party_type;
                varchar         hv_p1_txn_id[PD_TXN_SEQ_LEN];
                char            hv_txn_level;
                char            hv_relation_type;

                varchar         v_p2_txn_id[PD_TXN_SEQ_LEN];
                short           ind_p2_txn_id = -1;
        EXEC SQL END DECLARE SECTION;

/* party_type */
        if (GetField_Char(hRls, "party_type", &cTmp)) {
                hv_party_type = cTmp;
DEBUGLOG(("GetP2TxnId: party_type = [%c]\n", hv_party_type));
        }

/* p1_txn_id */
        if (GetField_CString(hRls,"p1_txn_id",&csTmp)) {
                hv_p1_txn_id.len = strlen(csTmp);
                strncpy((char*)hv_p1_txn_id.arr, csTmp, hv_p1_txn_id.len);
DEBUGLOG(("GetP2TxnId: p1_txn_id = [%s]\n",(char*)hv_p1_txn_id.arr));
        }

/* txn_level */
        if (GetField_Char(hRls, "txn_level", &cTmp)) {
                hv_txn_level = cTmp;
DEBUGLOG(("GetP2TxnId: txn_level = [%c]\n", hv_txn_level));
        }
	
/* relation_type */
        if (GetField_Char(hRls, "relation_type", &cTmp)) {
                hv_relation_type = cTmp;
DEBUGLOG(("GetP2TxnId: relation_type = [%c]\n", hv_relation_type));
        }

	EXEC SQL DECLARE c_cursor_getp2txnid CURSOR FOR
                SELECT  otr_p2_txn_id
                FROM    ol_txn_relation
                WHERE   otr_party_type = :hv_party_type
                AND     otr_p1_txn_id = :hv_p1_txn_id
                AND     otr_txn_level = :hv_txn_level
                AND     otr_relation_type = :hv_relation_type
                ORDER BY otr_relation_timestamp ASC;
        EXEC SQL OPEN c_cursor_getp2txnid;
	
	for (;;) {
                EXEC SQL FETCH c_cursor_getp2txnid
                INTO    :v_p2_txn_id:ind_p2_txn_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

		iCnt++;

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash, 0);

                // p2_txn_id
                if (ind_p2_txn_id >= 0) {
                        v_p2_txn_id.arr[v_p2_txn_id.len] = '\0';
                        PutField_CString(myHash, "p2_txn_id", (const char*)v_p2_txn_id.arr);
DEBUGLOG(("GetP2TxnId: p2_txn_id = [%s]\n", (const char*)v_p2_txn_id.arr));
                }

                RecordSet_Add(rRecordSet, myHash);
        }

        EXEC SQL CLOSE c_cursor_getp1txnid;

	
        if (iCnt > 0) {
                iRet = PD_FOUND;
DEBUGLOG(("GetP2TxnId FOUND\n"));
        } else {
                iRet = PD_NOT_FOUND;
DEBUGLOG(("GetP2TxnId NOT FOUND!!!\n"));
        }

DEBUGLOG(("GetP2TxnId: Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

getp2txnid_error:
DEBUGLOG(("getp2txnid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTxnRelation getp2txnid_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL CLOSE c_cursor_getp2txnid;
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int GetTxnRelationByBatchId(const hash_t* hRls, recordset_t* rRecordSet)
{
	int iRet = PD_FOUND;
        
	int iCnt = 0;

        char *csTmp;

        hash_t *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO gettxnrelationbybatchid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_batch_id[PD_TXN_SEQ_LEN];

                char            v_party_type;
		varchar		v_p1_txn_id[PD_TXN_SEQ_LEN+1];
                varchar         v_p2_txn_id[PD_TXN_SEQ_LEN+1];
                char            v_txn_level;
                char            v_relation_type;

		short		ind_party_type = -1;
                short           ind_p1_txn_id = -1;
		short		ind_p2_txn_id = -1;
		short		ind_txn_level = -1;
		short		ind_relation_type = -1;
        EXEC SQL END DECLARE SECTION;

// batch_id
	if (GetField_CString(hRls, "batch_id", &csTmp)) {
		hv_batch_id.len = strlen(csTmp);
		strncpy((char*)hv_batch_id.arr, csTmp, hv_batch_id.len);
DEBUGLOG(("GetTxnRelationByBatchId batch_id = [%s]\n",(char*)hv_batch_id.arr));
	}

	EXEC SQL DECLARE c_cursor_gettxnrelation CURSOR FOR
/*
		select	otr_party_type,
			otr_p1_txn_id,
			otr_p2_txn_id,
			otr_txn_level,
			otr_relation_type
		from	ol_txn_relation
		where	otr_relation_type != 'V'
		and	exists	(select	null 
				 from	ol_batch_txn_relation 
				 where	obtr_batch_id = :hv_batch_id
				 and	obtr_txn_level = 'T'
				 and	obtr_txn_id in (otr_p1_txn_id,otr_p2_txn_id));
*/
		select	x1.* 
		from 	(select otr_party_type,
       				otr_p1_txn_id,
       				otr_p2_txn_id,
       				otr_txn_level,
				otr_relation_type,
				oth_txn_code,
				tc_ofl_is_void
			from 	ol_txn_relation,
				ol_txn_header,txn_code
			where 	otr_relation_type != 'V'
  			and 	otr_p1_txn_id = oth_txn_id
  			and 	oth_txn_code = tc_code
  			and 	exists (select null
              			    	from   ol_batch_txn_relation
             			    	where  obtr_batch_id = :hv_batch_id
               			    	and    obtr_txn_level = 'T'
               			    	and    obtr_txn_id in (otr_p1_txn_id,otr_p2_txn_id))
			) x1
		where 	otr_relation_type!='V' 
  		//and 	TC_OFL_IS_VOID =0
		connect by prior OTR_P2_TXN_ID=OTR_P1_TXN_ID
		union
		select 	x1.* 
		from 	(select otr_party_type,
       				otr_p1_txn_id,
       				otr_p2_txn_id,
       				otr_txn_level,
				otr_relation_type,
				oth_txn_code,
				tc_ofl_is_void
			from 	ol_txn_relation,
				ol_txn_header,
				txn_code
			where 	otr_relation_type != 'V'
  			and 	otr_p1_txn_id = oth_txn_id
  			and 	oth_txn_code = tc_code
  			and 	exists (select 	null
              				from 	ol_batch_txn_relation
             				where 	obtr_batch_id = :hv_batch_id
               				and 	obtr_txn_level = 'T'
               				and 	obtr_txn_id in (otr_p1_txn_id,otr_p2_txn_id))
			) x1
		where 	otr_relation_type!='V'
  		//and 	TC_OFL_IS_VOID=0
		connect by prior OTR_P1_TXN_ID=OTR_P2_TXN_ID;
	EXEC SQL OPEN c_cursor_gettxnrelation;
	
	for (;;) {
                EXEC SQL FETCH c_cursor_gettxnrelation
                INTO	:v_party_type:ind_party_type,
			:v_p1_txn_id:ind_p1_txn_id,
			:v_p2_txn_id:ind_p2_txn_id,
			:v_txn_level:ind_txn_level,
			:v_relation_type:ind_relation_type;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
	
		iCnt++;
	
                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash, 0);

		// party_type
		if (ind_party_type >= 0) {
			PutField_Char(myHash, "party_type",v_party_type);
DEBUGLOG(("GetTxnRelationByBatchId party_type = [%c]\n", v_party_type));
		}

                // p1_txn_id
                if (ind_p1_txn_id >= 0) {
                        v_p1_txn_id.arr[v_p1_txn_id.len] = '\0';
                        PutField_CString(myHash, "p1_txn_id", (const char*)v_p1_txn_id.arr);
DEBUGLOG(("GetTxnRelationByBatchId p1_txn_id = [%s]\n", (const char*)v_p1_txn_id.arr));
                }

                // p2_txn_id
                if (ind_p2_txn_id >= 0) {
                        v_p2_txn_id.arr[v_p2_txn_id.len] = '\0';
                        PutField_CString(myHash, "p2_txn_id", (const char*)v_p2_txn_id.arr);
DEBUGLOG(("GetTxnRelationByBatchId p2_txn_id = [%s]\n", (const char*)v_p2_txn_id.arr));
                }

		// txn_leven
		if (ind_txn_level >= 0) {
			PutField_Char(myHash, "txn_level",v_txn_level);
DEBUGLOG(("GetTxnRelationByBatchId txn_level = [%c]\n", v_txn_level));
		}

		// relation_type
		if (ind_relation_type >= 0) {
			PutField_Char(myHash, "relation_type",v_relation_type);
DEBUGLOG(("GetTxnRelationByBatchId relation_type = [%c]\n", v_relation_type));
		}

                RecordSet_Add(rRecordSet, myHash);
        }

        EXEC SQL CLOSE c_cursor_gettxnrelation;

	if (iCnt > 0) {
                iRet = PD_FOUND;
DEBUGLOG(("GetTxnRelationByBatchId FOUND\n"));
        } else {
                iRet = PD_NOT_FOUND;
DEBUGLOG(("GetTxnRelationByBatchId NOT FOUND!!!\n"));
        }


DEBUGLOG(("GetTxnRelationByBatchId: Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

gettxnrelationbybatchid_error:
DEBUGLOG(("gettxnrelationbybatchid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTxnRelation getp1txnid_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL CLOSE c_cursor_gettxnrelation;
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int FindVoidTxnCount(const hash_t* hRls)
{
	int iRet = PD_NOT_FOUND;

        char *csTmp;

        EXEC SQL WHENEVER SQLERROR GOTO find_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];
                char            hv_relation_type;

                int		vCnt;
        EXEC SQL END DECLARE SECTION;

// txn_id 
        if (GetField_CString(hRls,"txn_id",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                strncpy((char*)hv_txn_id.arr, csTmp, hv_txn_id.len);
DEBUGLOG(("FindVoidTxnCount: txn_id = [%s]\n",(char*)hv_txn_id.arr));
        }

// relation_type 
        hv_relation_type = 'V';

	EXEC SQL	SELECT  count(1)
			INTO	vCnt
			FROM    ol_txn_relation
			WHERE   otr_relation_type = :hv_relation_type
			AND	(otr_p1_txn_id = :hv_txn_id OR
				 otr_p2_txn_id = :hv_txn_id);
	
        if (vCnt > 0) {
                iRet = PD_FOUND;
DEBUGLOG(("FindVoidTxnCount FOUND\n"));
        } else {
                iRet = PD_NOT_FOUND;
DEBUGLOG(("FindVoidTxnCount NOT FOUND!!!\n"));
        }

DEBUGLOG(("FindVoidTxnCount: Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

find_error:
DEBUGLOG(("find_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTxnRelation find_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}


int CheckIsBalTransBatch(const char *csBatchId)
{
	int iRet = PD_FALSE;

	EXEC SQL WHENEVER SQLERROR GOTO sql_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_batch_id[PD_TXN_SEQ_LEN];
		char	hv_txn_level;
		char	hv_relation_type;

		int	vCnt;
	EXEC SQL END DECLARE SECTION;

// batch_id
	hv_batch_id.len = strlen(csBatchId);
	strncpy((char*)hv_batch_id.arr, csBatchId, hv_batch_id.len);
DEBUGLOG(("CheckIsBalTransBatch batch_id = [%s]\n",(char*)hv_batch_id.arr));

	hv_txn_level = 'T';
	hv_relation_type = 'B';

	EXEC SQL	SELECT  count(1)
			INTO	vCnt
			FROM	OL_TXN_RELATION
			WHERE	OTR_TXN_LEVEL = :hv_txn_level
			  AND	OTR_RELATION_TYPE = :hv_relation_type
			  AND	EXISTS	(SELECT	NULL
					 FROM	OL_BATCH_TXN_RELATION
					 WHERE	OBTR_BATCH_ID = :hv_batch_id
					   AND	OBTR_TXN_ID IN (OTR_P1_TXN_ID,OTR_P2_TXN_ID));

	if (vCnt == 1) {
		iRet = PD_TRUE;
DEBUGLOG(("CheckIsBalTransBatch found one record, it's bal-transfer batch\n"));
	}

DEBUGLOG(("CheckIsBalTransBatch: Normal Exit! iRet = [%d]\n", iRet));
	return iRet;

sql_error:
DEBUGLOG(("sql_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTxnRelation sql_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}



int GetRelatedTxnId(const hash_t* hRls, recordset_t* rRecordSet)
{
	int iRet = PD_FOUND;
        
	int iCnt = 0;

        char *csTmp;

        hash_t *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO getrelatedtxnid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_txn_id[PD_TXN_SEQ_LEN];

		varchar		v_related_txn_id[PD_TXN_SEQ_LEN+1];
                short           ind_related_txn_id = -1;
        EXEC SQL END DECLARE SECTION;

// txn_id
	if (GetField_CString(hRls, "txn_seq", &csTmp)) {
		hv_txn_id.len = strlen(csTmp);
		strncpy((char*)hv_txn_id.arr, csTmp, hv_txn_id.len);
DEBUGLOG(("GetRelatedTxnId txn_id = [%s]\n",(char*)hv_txn_id.arr));
	}

	EXEC SQL DECLARE c_cursor_getrelatedtxnid CURSOR FOR
		SELECT	otr_p2_txn_id AS otr_txn_id
		FROM	ol_txn_relation
		WHERE	otr_p1_txn_id = :hv_txn_id
		AND	otr_relation_type = 'B'
		UNION
		SELECT	otr_p1_txn_id AS otr_txn_id
		FROM	ol_txn_relation
		WHERE	otr_p2_txn_id = :hv_txn_id
		AND	otr_relation_type = 'B';
	EXEC SQL OPEN c_cursor_getrelatedtxnid;
	
	for (;;) {
                EXEC SQL FETCH c_cursor_getrelatedtxnid
                INTO	:v_related_txn_id:ind_related_txn_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
	
		iCnt++;
	
                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash, 0);

                // related_txn_id
                if (ind_related_txn_id >= 0) {
                        v_related_txn_id.arr[v_related_txn_id.len] = '\0';
                        PutField_CString(myHash, "related_txn_seq", (const char*)v_related_txn_id.arr);
DEBUGLOG(("GetRelatedTxnId related_txn_id = [%s]\n", (const char*)v_related_txn_id.arr));
                }

                RecordSet_Add(rRecordSet, myHash);
        }

        EXEC SQL CLOSE c_cursor_getrelatedtxnid;

	if (iCnt > 0) {
                iRet = PD_FOUND;
DEBUGLOG(("GetRelatedTxnId FOUND\n"));
        } else {
                iRet = PD_NOT_FOUND;
DEBUGLOG(("GetRelatedTxnId NOT FOUND!!!\n"));
        }


DEBUGLOG(("GetRelatedTxnId: Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

getrelatedtxnid_error:
DEBUGLOG(("getrelatedtxnid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTxnRelation getrelatedtxnid_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL CLOSE c_cursor_getrelatedtxnid;
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int GetVoidTxnId(const hash_t* hRls, recordset_t* rRecordSet)
{
	int iRet = PD_FOUND;
        
	int iCnt = 0;

        char *csTmp;

        hash_t *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO getvoidtxnid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_txn_id[PD_TXN_SEQ_LEN];

		varchar		v_void_txn_id[PD_TXN_SEQ_LEN+1];
                short           ind_void_txn_id = -1;
        EXEC SQL END DECLARE SECTION;

// txn_id
	if (GetField_CString(hRls, "txn_seq", &csTmp)) {
		hv_txn_id.len = strlen(csTmp);
		strncpy((char*)hv_txn_id.arr, csTmp, hv_txn_id.len);
DEBUGLOG(("GetVoidTxnId txn_id = [%s]\n",(char*)hv_txn_id.arr));
	}

	EXEC SQL DECLARE c_cursor_getvoidtxnid CURSOR FOR
		SELECT	otr_p2_txn_id AS otr_txn_id
		FROM	ol_txn_relation
		WHERE	otr_p1_txn_id = :hv_txn_id
		AND	otr_relation_type = 'V'
		UNION
		SELECT	otr_p1_txn_id AS otr_txn_id
		FROM	ol_txn_relation
		WHERE	otr_p2_txn_id = :hv_txn_id
		AND	otr_relation_type = 'V';
	EXEC SQL OPEN c_cursor_getvoidtxnid;
	
	for (;;) {
                EXEC SQL FETCH c_cursor_getvoidtxnid
                INTO	:v_void_txn_id:ind_void_txn_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
	
		iCnt++;
	
                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash, 0);

                // void_txn_id
                if (ind_void_txn_id >= 0) {
                        v_void_txn_id.arr[v_void_txn_id.len] = '\0';
                        PutField_CString(myHash, "void_txn_seq", (const char*)v_void_txn_id.arr);
DEBUGLOG(("GetVoidTxnId void_txn_id = [%s]\n", (const char*)v_void_txn_id.arr));
                }

                RecordSet_Add(rRecordSet, myHash);
        }

        EXEC SQL CLOSE c_cursor_getvoidtxnid;

	if (iCnt > 0) {
                iRet = PD_FOUND;
DEBUGLOG(("GetVoidTxnId FOUND\n"));
        } else {
                iRet = PD_NOT_FOUND;
DEBUGLOG(("GetVoidTxnId NOT FOUND!!!\n"));
        }


DEBUGLOG(("GetVoidTxnId: Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

getvoidtxnid_error:
DEBUGLOG(("getvoidtxnid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTxnRelation getrelatedtxnid_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL CLOSE c_cursor_getvoidtxnid;
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int CheckIsBalTransP1TxnId(const hash_t* hRls)
{
	int iRet = PD_FALSE;

	char *csTmp;

        EXEC SQL WHENEVER SQLERROR GOTO checkp1txnid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_txn_id[PD_TXN_SEQ_LEN];
                char    hv_txn_level;
                char    hv_relation_type;

                int     vCnt;
        EXEC SQL END DECLARE SECTION;

// txn_id
        if (GetField_CString(hRls, "txn_seq", &csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                strncpy((char*)hv_txn_id.arr, csTmp, hv_txn_id.len);
DEBUGLOG(("CheckIsBalTransP1TxnId txn_id = [%s]\n",(char*)hv_txn_id.arr));
	}

        hv_txn_level = 'T';
        hv_relation_type = 'B';

        EXEC SQL        SELECT  count(1)
                        INTO    vCnt
                        FROM    OL_TXN_RELATION
                        WHERE   OTR_TXN_LEVEL = :hv_txn_level
                          AND   OTR_RELATION_TYPE = :hv_relation_type
                          AND   OTR_P1_TXN_ID = :hv_txn_id;

        if (vCnt == 1) {
                iRet = PD_TRUE;
DEBUGLOG(("CheckIsBalTransP1TxnId found one record!!!\n"));
        }

DEBUGLOG(("CheckIsBalTransP1TxnId: Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

checkp1txnid_error:
DEBUGLOG(("checkp1txnid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTxnRelation checkp1txnid_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int CheckIsBalTransP2TxnId(const hash_t* hRls)
{
	int iRet = PD_FALSE;

	char *csTmp;

        EXEC SQL WHENEVER SQLERROR GOTO checkp2txnid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_txn_id[PD_TXN_SEQ_LEN];
                char    hv_txn_level;
                char    hv_relation_type;

                int     vCnt;
        EXEC SQL END DECLARE SECTION;

// txn_id
        if (GetField_CString(hRls, "txn_seq", &csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                strncpy((char*)hv_txn_id.arr, csTmp, hv_txn_id.len);
DEBUGLOG(("CheckIsBalTransP1TxnId txn_id = [%s]\n",(char*)hv_txn_id.arr));
	}

        hv_txn_level = 'T';
        hv_relation_type = 'B';

        EXEC SQL        SELECT  count(1)
                        INTO    vCnt
                        FROM    OL_TXN_RELATION
                        WHERE   OTR_TXN_LEVEL = :hv_txn_level
                          AND   OTR_RELATION_TYPE = :hv_relation_type
                          AND   OTR_P2_TXN_ID = :hv_txn_id;

        if (vCnt == 1) {
                iRet = PD_TRUE;
DEBUGLOG(("CheckIsBalTransP2TxnId found one record!!!\n"));
        }

DEBUGLOG(("CheckIsBalTransP2TxnId: Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

checkp2txnid_error:
DEBUGLOG(("checkp2txnid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTxnRelation checkp2txnid_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

