/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/09/06              LokMan Chow
Add GetReservedAmtByWeek                           2011/10/24              Virginia Yun
Amend for support new table structure		   2012/08/15		   Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "MerchantReservedAmt.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void MerchantReservedAmt(char    cdebug)
{
        cDebug = cdebug;
}

/*
int GetReservedAmt(const char* csMerchantID,
		const char* csCountryId,
		const char* csCcy,
		const char* csServiceCode,
		const int iDayOfWeek,
		double	*dAmt)
{
	*dAmt = 0.0;
	int iRet = PD_OK;
                
        EXEC SQL WHENEVER SQLERROR GOTO getreserved_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		int		hv_day_of_week;                

		double		v_reserved;
		double		v_merchant_prefer_limit;

		short		ind_reserved= -1;
		short		ind_merchant_prefer_limit= -1;
        
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetReservedAmt merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_ccy_id.len = strlen(csCcy);
        memcpy(hv_ccy_id.arr,csCcy,hv_ccy_id.len);
DEBUGLOG(("GetReservedAmt ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
        
        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetReservedAmt country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetReservedAmt service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_day_of_week = iDayOfWeek;
DEBUGLOG(("GetReservedAmt day_of_week = [%d]\n",hv_day_of_week));
        
        EXEC SQL DECLARE c_cursor_getreserved CURSOR FOR
                select mr_reserved_amount,
		       mr_merchant_prefer_limit
                  from merchant_reserved_amt
		 where mr_merchant_id = :hv_merchant_id
		   and mr_currency_id = :hv_ccy_id
		   and mr_country_id = :hv_country_id
		   and mr_service_code = :hv_service_code
		   and mr_day_of_week = :hv_day_of_week
		 for update;


        EXEC SQL OPEN c_cursor_getreserved;
        do {
                EXEC SQL FETCH c_cursor_getreserved
                INTO
			:v_reserved:ind_reserved,
			:v_merchant_prefer_limit:ind_merchant_prefer_limit;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

// balance
                if((ind_reserved<0) &&(ind_merchant_prefer_limit<0))
			*dAmt = 0.0;

		else{
			if((v_reserved<=v_merchant_prefer_limit) && (v_reserved>0.0))
				*dAmt=v_reserved;
			else
				*dAmt=v_merchant_prefer_limit;
DEBUGLOG(("GetReservedAmt balance = [%f]\n",*dAmt));
		}

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getreserved;

DEBUGLOG(("GetReservedAmt Normal Exit\n"));
	
	return iRet;

getreserved_error:
DEBUGLOG(("getreserved_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getreserved;
	TxnAbort();
        return PD_ERR;
}
*/

/*
int GetAllReservedAmt(const char* csMerchantID,
		const char* csCountryId,
		const char* csCcy,
		const char* csServiceCode,
		const int iDayOfWeek,
		double	*dAdminAmt,
		double	*dMerchantAmt)
{
	*dMerchantAmt = 0.0;
	*dAdminAmt = 0.0;
	int iRet = PD_OK;
                
        EXEC SQL WHENEVER SQLERROR GOTO getallreserved_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		int		hv_day_of_week;                

		double		v_reserved;
		double		v_merchant_prefer_limit;

		short		ind_reserved= -1;
		short		ind_merchant_prefer_limit= -1;
        
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetAllReservedAmt merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_ccy_id.len = strlen(csCcy);
        memcpy(hv_ccy_id.arr,csCcy,hv_ccy_id.len);
DEBUGLOG(("GetAllReservedAmt ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
        
        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetAllReservedAmt country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetAllReservedAmt service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_day_of_week = iDayOfWeek;
DEBUGLOG(("GetAllReservedAmt day_of_week = [%d]\n",hv_day_of_week));
        
        EXEC SQL DECLARE c_cursor_getallreserved CURSOR FOR
                select mr_reserved_amount,
		       mr_merchant_prefer_limit
                  from merchant_reserved_amt
		 where mr_merchant_id = :hv_merchant_id
		   and mr_currency_id = :hv_ccy_id
		   and mr_country_id = :hv_country_id
		   and mr_service_code = :hv_service_code
		   and mr_day_of_week = :hv_day_of_week
		 for update;


        EXEC SQL OPEN c_cursor_getallreserved;
        do {
                EXEC SQL FETCH c_cursor_getallreserved
                INTO
			:v_reserved:ind_reserved,
			:v_merchant_prefer_limit:ind_merchant_prefer_limit;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

// balance
                if(ind_reserved<0)
			*dAdminAmt = 0.0;
		else{
			*dAdminAmt=v_reserved;
DEBUGLOG(("GetAllReservedAmt balance (Admin) = [%f]\n",*dAdminAmt));
		}

                if(ind_merchant_prefer_limit<0)
			*dMerchantAmt = 0.0;
		else{
			*dMerchantAmt=v_merchant_prefer_limit;
DEBUGLOG(("GetAllReservedAmt balance (Merchant) = [%f]\n",*dMerchantAmt));
		}

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getallreserved;

DEBUGLOG(("GetAllReservedAmt Normal Exit\n"));
	
	return iRet;

getallreserved_error:
DEBUGLOG(("getallreserved_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getallreserved;
	TxnAbort();
        return PD_ERR;
}
*/

/*
int GetReservedAmtByWeek(const char* csMerchantID,
		const char* csCountryId,
		const char* csCcy,
		const char* csServiceCode,
                recordset_t *myRec)
{
	double dAmt = 0.0;
	double dMerchantAmt = 0.0;
        int    iDayOfWeek = 0;  
	int    iRet = PD_OK;

        hash_t *myHash;
                
        EXEC SQL WHENEVER SQLERROR GOTO getreserved_week_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];

		double		v_reserved;
		double		v_merchant_prefer_limit;
                int             v_day_of_week; 

		short		ind_reserved= -1;
		short		ind_merchant_prefer_limit= -1;
                short           ind_day_of_week = -1; 
        
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetReservedAmtByWeek merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_ccy_id.len = strlen(csCcy);
        memcpy(hv_ccy_id.arr,csCcy,hv_ccy_id.len);
DEBUGLOG(("GetReservedAmtByWeek ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
        
        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetReservedAmtByWeek country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetReservedAmtByWeek service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        
        EXEC SQL DECLARE c_cursor_getreserved_week CURSOR FOR
                select mr_day_of_week, 
		       mr_reserved_amount,
		       mr_merchant_prefer_limit
                  from merchant_reserved_amt
		 where mr_merchant_id = :hv_merchant_id
		   and mr_currency_id = :hv_ccy_id
		   and mr_country_id = :hv_country_id
		   and mr_service_code = :hv_service_code;
		 //for update;

        EXEC SQL OPEN c_cursor_getreserved_week;
        do {
                EXEC SQL FETCH c_cursor_getreserved_week
                INTO 
                        :v_day_of_week:ind_day_of_week,
			:v_reserved:ind_reserved,
			:v_merchant_prefer_limit:ind_merchant_prefer_limit;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

// day of week
                if (ind_day_of_week >= 0) {
                        iDayOfWeek = v_day_of_week;
DEBUGLOG(("GetReservedAmtByWeek day_of_week = [%d]\n",iDayOfWeek));
                        PutField_Int(myHash, "day_of_week", iDayOfWeek);
                }

// balance
                if(ind_reserved >= 0) {
			dAmt=v_reserved;
DEBUGLOG(("GetReservedAmtByWeek balance (Admin) = [%f]\n",dAmt));
                        PutField_Double(myHash, "reserved_amt", dAmt);
		}

// merchant balance
                if(ind_merchant_prefer_limit >= 0) {
			dMerchantAmt=v_merchant_prefer_limit;
DEBUGLOG(("GetReservedAmtByWeek balance (Merchant) = [%f]\n",dMerchantAmt));
                        PutField_Double(myHash, "merchant_amt", dMerchantAmt);
		}
                RecordSet_Add(myRec, myHash);

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getreserved_week;

DEBUGLOG(("GetReservedAmtByWeek Normal Exit\n"));
	
	return iRet;

getreserved_week_error:
DEBUGLOG(("getreserved_week_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getreserved_week;
        return PD_ERR;
}
*/


int Add(const hash_t *hRls)
{
	char	*csTmp;
	char	cTmp;
	int	iTmp;
	double	dTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		int		hv_day_of_week;
                char		hv_amt_type;
		double		hv_amt;
		char		hv_status;
		varchar         hv_effect_date[PD_DATETIME_LEN];
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_day_of_week = -1;
		short		ind_amt_type = -1;
		short		ind_amt = -1;
		short		ind_status = -1;
		short		ind_effect_date = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;

	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));

	if (GetField_CString(hRls, "merchant_id", &csTmp)) {
                hv_merchant_id.len = strlen(csTmp);
                strncpy((char*)hv_merchant_id.arr, csTmp, hv_merchant_id.len);
		ind_merchant_id = 0;
DEBUGLOG(("Add:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
	}

	if (GetField_CString(hRls, "txn_country", &csTmp)) {
		hv_country_id.len = strlen(csTmp);
		strncpy((char *)hv_country_id.arr, csTmp, hv_country_id.len);
		ind_country_id = 0;
DEBUGLOG(("Add:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));
	}

	if (GetField_CString(hRls, "txn_ccy", &csTmp)) {
		hv_ccy_id.len = strlen(csTmp);
		strncpy((char *)hv_ccy_id.arr, csTmp, hv_ccy_id.len);
		ind_ccy_id = 0;
DEBUGLOG(("Add:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
	}

	if (GetField_CString(hRls, "service_code", &csTmp)) {
		hv_service_code.len = strlen(csTmp);
		strncpy((char *)hv_service_code.arr, csTmp, hv_service_code.len);
		ind_service_code = 0;
DEBUGLOG(("Add:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
	}

	if (GetField_Int(hRls, "dow", &iTmp)) {
		hv_day_of_week = iTmp;
		ind_day_of_week = 0;
DEBUGLOG(("Add:day_of_week = [%d]\n",hv_day_of_week));
	}

	if (GetField_Char(hRls, "amt_type", &cTmp)) {
		hv_amt_type = cTmp;
		ind_amt_type = 0;
DEBUGLOG(("Add:amt_type = [%c]\n",hv_amt_type));
	}

	if (GetField_Double(hRls, "txn_amt", &dTmp)) {
		hv_amt = dTmp;
		ind_amt = 0;
DEBUGLOG(("Add:reserved amt = [%f]\n",hv_amt));
	}

	if (GetField_Char(hRls, "status", &cTmp)) {
		hv_status = cTmp;
		ind_status = 0;
DEBUGLOG(("Add:status = [%c]\n",hv_status));
	}

	if (GetField_CString(hRls, "effect_date", &csTmp)) {
		hv_effect_date.len = strlen(csTmp);
		strncpy((char *)hv_effect_date.arr, csTmp, hv_effect_date.len);
		ind_effect_date = 0;
DEBUGLOG(("Add: effect_date = [%.*s]\n",hv_effect_date.len,hv_effect_date.arr));
	}


	if (GetField_CString(hRls, "add_user", &csTmp)) {
		hv_create_user.len = strlen(csTmp);
		strncpy((char *)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));
	}

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_merchant_res_amt_add(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_day_of_week:ind_day_of_week,
				:hv_amt_type:ind_amt_type,
				:hv_amt:ind_amt,
				:hv_status:ind_status,
				:hv_effect_date:ind_effect_date,	
				:hv_create_user:ind_create_user);

		END;
	END-EXEC;
	
DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("Add:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantReservedAmt::Add: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantReservedAmt::Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

	return PD_OK;

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;

}

int ChkRecExist(hash_t *hRls)
{
	int	iRet = PD_NOT_FOUND;
	char	*csTmp;
	int	iTmp;
	char	cTmp;
	

        EXEC SQL WHENEVER SQLERROR GOTO chkrecexist_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                int             hv_day_of_week;
                char            hv_amt_type;
                char            hv_status;

                short           ind_merchant_id = -1;
                short           ind_country_id = -1;
                short           ind_ccy_id = -1;
                short           ind_service_code = -1;
                short           ind_day_of_week = -1;
                short           ind_amt_type = -1;
                short           ind_status = -1;

		int		v_no_of_record;
		short		ind_no_of_record = -1;

	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("ChkRecExist: Begin\n"));

        if (GetField_CString(hRls, "merchant_id", &csTmp)) {
                hv_merchant_id.len = strlen(csTmp);
                strncpy((char*)hv_merchant_id.arr, csTmp, hv_merchant_id.len);
                ind_merchant_id = 0;
DEBUGLOG(("ChkRecExist:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        }

        if (GetField_CString(hRls, "txn_country", &csTmp)) {
                hv_country_id.len = strlen(csTmp);
                strncpy((char *)hv_country_id.arr, csTmp, hv_country_id.len);
                ind_country_id = 0;
DEBUGLOG(("ChkRecExist:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));
        }

        if (GetField_CString(hRls, "txn_ccy", &csTmp)) {
                hv_ccy_id.len = strlen(csTmp);
                strncpy((char *)hv_ccy_id.arr, csTmp, hv_ccy_id.len);
                ind_ccy_id = 0;
DEBUGLOG(("ChkRecExist:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
        }

        if (GetField_CString(hRls, "service_code", &csTmp)) {
                hv_service_code.len = strlen(csTmp);
                strncpy((char *)hv_service_code.arr, csTmp, hv_service_code.len);
                ind_service_code = 0;
DEBUGLOG(("ChkRecExist:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
        }		

	if (GetField_Int(hRls, "dow", &iTmp)) {
		hv_day_of_week = iTmp;
		ind_day_of_week = 0;
DEBUGLOG(("ChkRecExist:day_of_week = [%d]\n",hv_day_of_week));
	}

        if (GetField_Char(hRls, "amt_type", &cTmp)) {
                hv_amt_type = cTmp;
                ind_amt_type = 0;
DEBUGLOG(("ChkRecExist:amt_type = [%c]\n",hv_amt_type));
        }

        if (GetField_Char(hRls, "status", &cTmp)) {
                hv_status = cTmp;
                ind_status = 0;
DEBUGLOG(("ChkRecExist:status = [%c]\n",hv_status));
        }

	EXEC SQL
		SELECT count(1)
		  INTO :v_no_of_record:ind_no_of_record
		  FROM merchant_reserved_amt
		 WHERE mr_merchant_id = :hv_merchant_id:ind_merchant_id
                   AND mr_currency_id = :hv_ccy_id:ind_ccy_id
                   AND mr_country_id = :hv_country_id:ind_country_id
                   AND mr_service_code = :hv_service_code:ind_service_code
                   AND mr_day_of_week =:hv_day_of_week:ind_day_of_week
                   AND mr_type = :hv_amt_type:ind_amt_type
		   AND mr_status = :hv_status:ind_status
		   AND rownum = 1;

	if (ind_no_of_record >= 0) {
		if (v_no_of_record > 0) {
DEBUGLOG(("ChkRecExist: FOUND\n"));
			iRet = PD_FOUND;
		}
	}

	if (iRet != PD_FOUND) {
DEBUGLOG(("ChkRecExist: NOT FOUND\n"));
	}
		
	return iRet;

chkrecexist_error:
DEBUGLOG(("ChkRecExist_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
	
}

int Update(const hash_t *hRls)
{
	char	*csTmp;
	char	cTmp;
	int	iTmp;
	double	dTmp;

	EXEC SQL WHENEVER SQLERROR GOTO update_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		int		hv_day_of_week;
                char		hv_amt_type;
		double		hv_amt;
		char		hv_status;
		varchar         hv_effect_date[PD_DATETIME_LEN];
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_day_of_week = -1;
		short		ind_amt_type = -1;
		short		ind_amt = -1;
		short		ind_status = -1;
		short		ind_effect_date = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;

	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));

	if (GetField_CString(hRls, "merchant_id", &csTmp)) {
                hv_merchant_id.len = strlen(csTmp);
                strncpy((char*)hv_merchant_id.arr, csTmp, hv_merchant_id.len);
		ind_merchant_id = 0;
DEBUGLOG(("Update:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
	}

	if (GetField_CString(hRls, "txn_country", &csTmp)) {
		hv_country_id.len = strlen(csTmp);
		strncpy((char *)hv_country_id.arr, csTmp, hv_country_id.len);
		ind_country_id = 0;
DEBUGLOG(("Update:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));
	}

	if (GetField_CString(hRls, "txn_ccy", &csTmp)) {
		hv_ccy_id.len = strlen(csTmp);
		strncpy((char *)hv_ccy_id.arr, csTmp, hv_ccy_id.len);
		ind_ccy_id = 0;
DEBUGLOG(("Update:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
	}

	if (GetField_CString(hRls, "service_code", &csTmp)) {
		hv_service_code.len = strlen(csTmp);
		strncpy((char *)hv_service_code.arr, csTmp, hv_service_code.len);
		ind_service_code = 0;
DEBUGLOG(("Update:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
	}

	if (GetField_Int(hRls, "dow", &iTmp)) {
		hv_day_of_week = iTmp;
		ind_day_of_week = 0;
DEBUGLOG(("Update:day_of_week = [%d]\n",hv_day_of_week));
	}

	if (GetField_Char(hRls, "amt_type", &cTmp)) {
		hv_amt_type = cTmp;
		ind_amt_type = 0;
DEBUGLOG(("Update:amt_type = [%c]\n",hv_amt_type));
	}

	if (GetField_Double(hRls, "txn_amt", &dTmp)) {
		hv_amt = dTmp;
		ind_amt = 0;
DEBUGLOG(("Update:reserved amt = [%f]\n",hv_amt));
	}

	if (GetField_Char(hRls, "status", &cTmp)) {
		hv_status = cTmp;
		ind_status = 0;
DEBUGLOG(("Update:status = [%c]\n",hv_status));
	}

	if (GetField_CString(hRls, "effect_date", &csTmp)) {
		hv_effect_date.len = strlen(csTmp);
		strncpy((char *)hv_effect_date.arr, csTmp, hv_effect_date.len);
		ind_effect_date = 0;
DEBUGLOG(("Update: effect_date = [%.*s]\n",hv_effect_date.len,hv_effect_date.arr));
	}


	if (GetField_CString(hRls, "add_user", &csTmp)) {
		hv_create_user.len = strlen(csTmp);
		strncpy((char *)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
DEBUGLOG(("Update:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));
	}

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_merchant_res_amt_update(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_day_of_week:ind_day_of_week,
				:hv_amt_type:ind_amt_type,
				:hv_amt:ind_amt,
				:hv_status:ind_status,
				:hv_effect_date:ind_effect_date,	
				:hv_create_user:ind_create_user);

		END;
	END-EXEC;
	
DEBUGLOG(("Update:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("Update:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantReservedAmt::Update: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_OTHER_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantReservedAmt::Update: SP_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

	return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;

}

int GetReservedAmt(const hash_t *hRls,
			recordset_t *myRec)
{
	int	iRet = PD_OK;
	hash_t	*myHash;

	char	*csTmp;
	int	iTmp;
	char	cTmp;
	

        EXEC SQL WHENEVER SQLERROR GOTO getreservedamt_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		short	hv_return_value;

                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_country_id[PD_COUNTRY_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                int             hv_day_of_week;
                char            hv_status;

		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_day_of_week = -1;
		short		ind_status = -1;

		double		v_daily_cap_amount;
		double		v_reserved_amount;
		char		v_rec_status;
		varchar         v_effect_date[PD_DATETIME_LEN + 1];
		int		v_rec_count;
		
		short		ind_daily_cap_amount = -1;
		short		ind_reserved_amount = -1;
		short		ind_rec_status = -1;
		short		ind_effect_date = -1;
		short		ind_rec_count = -1;
		
                SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;


DEBUGLOG(("GetReservedAmt: Begin\n"));

        if (GetField_CString(hRls, "merchant_id", &csTmp)) {
                hv_merchant_id.len = strlen(csTmp);
                strncpy((char*)hv_merchant_id.arr, csTmp, hv_merchant_id.len);
                ind_merchant_id = 0;
DEBUGLOG(("GetReservedAmt:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        }

        if (GetField_CString(hRls, "txn_country", &csTmp)) {
                hv_country_id.len = strlen(csTmp);
                strncpy((char *)hv_country_id.arr, csTmp, hv_country_id.len);
                ind_country_id = 0;
DEBUGLOG(("GetReservedAmt:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));
        }

        if (GetField_CString(hRls, "txn_ccy", &csTmp)) {
                hv_ccy_id.len = strlen(csTmp);
                strncpy((char *)hv_ccy_id.arr, csTmp, hv_ccy_id.len);
                ind_ccy_id = 0;
DEBUGLOG(("GetReservedAmt:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
        }

        if (GetField_CString(hRls, "service_code", &csTmp)) {
                hv_service_code.len = strlen(csTmp);
                strncpy((char *)hv_service_code.arr, csTmp, hv_service_code.len);
                ind_service_code = 0;
DEBUGLOG(("GetReservedAmt:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
        }

        if (GetField_Int(hRls, "dow", &iTmp)) {
                hv_day_of_week = iTmp;
                ind_day_of_week = 0;
DEBUGLOG(("GetReservedAmt:day_of_week = [%d]\n",hv_day_of_week));
        }

	if (GetField_Char(hRls, "status", &cTmp)) {
		hv_status = cTmp;
		ind_status = 0;
DEBUGLOG(("GetReservedAmt:status = [%c]\n",hv_status));
	}

	EXEC SQL ALLOCATE	:c_cursor_id;
	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_merchant_res_amt_get(:hv_merchant_id:ind_merchant_id,
									:hv_country_id:ind_country_id,
									:hv_ccy_id:ind_ccy_id,
									:hv_service_code:ind_service_code,
									:hv_day_of_week:ind_day_of_week,
									:hv_status:ind_status,
									:c_cursor_id);
							
		END;
	END-EXEC;


	if (hv_return_value == PD_OK) {
DEBUGLOG(("GetReservedAmt: Fetching\n"));
		for (;;) {
			myHash = (hash_t *) malloc(sizeof(hash_t));
			hash_init(myHash, 0);

			ind_daily_cap_amount = -1;
			ind_reserved_amount = -1;
			ind_rec_status = -1;
			ind_effect_date = -1;
			ind_rec_count = -1;

                        EXEC SQL WHENEVER NOTFOUND DO break;
                        EXEC SQL FETCH :c_cursor_id
                        INTO    :v_daily_cap_amount:ind_daily_cap_amount,
                                :v_reserved_amount:ind_reserved_amount,
                                :v_rec_status:ind_rec_status,
                                :v_effect_date:ind_effect_date,
				:v_rec_count:ind_rec_count;

                        if (SQLCODE == SQL_NOT_FOUND) {
                                break;
                        }


			if (ind_daily_cap_amount >= 0) {
DEBUGLOG(("GetReservedAmt: daily_cap_amount = [%lf]\n", v_daily_cap_amount));
                                PutField_Double(myHash,"daily_cap_amount", v_daily_cap_amount);
			}

			if (ind_reserved_amount >= 0) {
DEBUGLOG(("GetReservedAmt: reserved_amount = [%lf]\n", v_reserved_amount));
                                PutField_Double(myHash,"reserved_amount", v_reserved_amount);
			}

			if (ind_rec_status >= 0) {
DEBUGLOG(("GetReservedAmt: rec_status = [%c]\n", v_rec_status));
                                PutField_Char(myHash,"rec_status", v_rec_status);
			}

			if (ind_effect_date >= 0) {
				v_effect_date.arr[v_effect_date.len] = '\0';
DEBUGLOG(("GetReservedAmt: effect_date = [%.*s]\n", v_effect_date.len,v_effect_date.arr));
                                PutField_CString(myHash,"effect_date",(const char *)v_effect_date.arr);
                        }

			if (ind_rec_count >= 0) {
DEBUGLOG(("GetReservedAmt: rec_count = [%d]\n", v_rec_count)); 
                                PutField_Int(myHash,"rec_count", v_rec_count);
                        }

			if (v_rec_count > 0) {
				RecordSet_Add(myRec,myHash);	
			}

		}
		EXEC SQL CLOSE :c_cursor_id;
	} 
	else if (hv_return_value == SP_OTHER_ERR) {
		EXEC SQL CLOSE :c_cursor_id;
DEBUGLOG(("GetReservedAmt: exit with error\n"));
ERRLOG("MerchantResevedAmt::GetReservedAmt: exit with error\n");
		iRet = PD_ERR;
	}

	EXEC SQL CLOSE :c_cursor_id;
	FREE_ME(myHash);

DEBUGLOG(("GetReservedAmt: return [%d]\n", iRet));

	return iRet;

getreservedamt_error:
DEBUGLOG(("getreservedamt_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    return PD_ERR;

}
