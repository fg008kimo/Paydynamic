/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/09/06              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "MerchantReservedAmt.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void MerchantReservedAmt(char    cdebug)
{
        cDebug = cdebug;
}


int GetReservedAmt(const char* csMerchantID,
		const char* csCountryId,
		const char* csCcy,
		const char* csServiceCode,
		const int iDayOfWeek,
		double	*dAmt)
{
	*dAmt = 0.0;
	int iRet = PD_OK;
                
        EXEC SQL WHENEVER SQLERROR GOTO getreserved_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		int		hv_day_of_week;                

		double		v_reserved;

		short		ind_reserved= -1;
        
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetReservedAmt merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_ccy_id.len = strlen(csCcy);
        memcpy(hv_ccy_id.arr,csCcy,hv_ccy_id.len);
DEBUGLOG(("GetReservedAmt ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
        
        hv_country_id.len = strlen(csCountryId);
        memcpy(hv_country_id.arr,csCountryId,hv_country_id.len);
DEBUGLOG(("GetReservedAmt country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetReservedAmt service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_day_of_week = iDayOfWeek;
DEBUGLOG(("GetReservedAmt day_of_week = [%d]\n",hv_day_of_week));
        
        EXEC SQL DECLARE c_cursor_getreserved CURSOR FOR
                select mr_reserved_amount
                  from merchant_reserved_amt
		 where mr_merchant_id = :hv_merchant_id
		   and mr_currency_id = :hv_ccy_id
		   and mr_country_id = :hv_country_id
		   and mr_service_code = :hv_service_code
		   and mr_day_of_week = :hv_day_of_week
		 for update;


        EXEC SQL OPEN c_cursor_getreserved;
        do {
                EXEC SQL FETCH c_cursor_getreserved
                INTO
			:v_reserved:ind_reserved;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

// balance
                if(ind_reserved<0)
			*dAmt = 0.0;

		else{
			*dAmt=v_reserved;
DEBUGLOG(("GetReservedAmt balance = [%f]\n",*dAmt));
		}

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getreserved;

DEBUGLOG(("GetReservedAmt Normal Exit\n"));
	
	return iRet;

getreserved_error:
DEBUGLOG(("getreserved_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getreserved;
	TxnAbort();
        return PD_ERR;
}


int UpdateReserved(const char* csMerchantId,
                const char* csCountryId,
                const char* csCcy,
                const char* csServiceCode,
		const int iDayOfWeek,
                double  dAmt,
		const char* csUser)

{

	EXEC SQL WHENEVER SQLERROR GOTO updatereserved_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	        hv_country_id[PD_COUNTRY_LEN];
		varchar		hv_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_service_code[PD_SERVICE_CODE_LEN];
		int		hv_day_of_week;
		double		hv_amt;
		varchar 	hv_create_user[PD_USER_LEN];


		short		ind_merchant_id = -1;
		short		ind_country_id = -1;
		short		ind_ccy_id = -1;
		short		ind_service_code = -1;
		short		ind_day_of_week = -1;
		short		ind_amt = -1;
		short		ind_create_user = -1;
		
		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateReserved: Begin\n"));


	hv_merchant_id.len = strlen(csMerchantId);
	strncpy(hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("UpdateReserved:merchant id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_country_id.len = strlen(csCountryId);
	strncpy(hv_country_id.arr, csCountryId, hv_country_id.len);
	ind_country_id = 0;
DEBUGLOG(("UpdateReserved:country_id = [%.*s]\n",hv_country_id.len,hv_country_id.arr));

	hv_ccy_id.len = strlen(csCcy);
	strncpy(hv_ccy_id.arr, csCcy, hv_ccy_id.len);
	ind_ccy_id = 0;
DEBUGLOG(("UpdateReserved:ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));

	hv_service_code.len = strlen(csServiceCode);
	strncpy(hv_service_code.arr, csServiceCode, hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("UpdateReserved:ccy_id = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

	hv_day_of_week= iDayOfWeek;
	ind_day_of_week= 0;
DEBUGLOG(("UpdatReserved:day_of_week = [%d]\n",hv_day_of_week));

	hv_amt= dAmt;
	ind_amt= 0;
DEBUGLOG(("UpdatReserved:reserved amt = [%f]\n",hv_amt));

	hv_create_user.len = strlen(csUser);
	strncpy(hv_create_user.arr, csUser, hv_create_user.len);
	ind_create_user = 0;
DEBUGLOG(("UpdateReserved:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
	    BEGIN

		:hv_return_value := sp_merchant_res_amt_add(
				:hv_merchant_id:ind_merchant_id,
				:hv_country_id:ind_country_id,
				:hv_ccy_id:ind_ccy_id,
				:hv_service_code:ind_service_code,
				:hv_day_of_week:ind_day_of_week,
				:hv_amt:ind_amt,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


DEBUGLOG(("UpdateReserved:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("UpdateReserved:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantReservedAmt::UpdateReserved: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("UpdateReserved: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantReservedAmt::UpdateReserved: SP_ERR TxnAbort\n");
DEBUGLOG(("UpdateReserved: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

updatereserved_error:
DEBUGLOG(("updateReserved_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	TxnAbort();
	return PD_ERR;
}
