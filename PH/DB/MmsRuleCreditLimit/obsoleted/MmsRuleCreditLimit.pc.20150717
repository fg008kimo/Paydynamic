/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/05/11              Dirk Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "MmsRuleCreditLimit.h"
#include "common.h"
#include "internal.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void MmsRuleCreditLimit(char    cdebug)
{
        cDebug = cdebug;
}

int GetMmsRuleCreditLimit(const hash_t* hRls, hash_t* myHash)
{
	int iRet = PD_OK;

	char	*csTmp;
	char	cTmp;

	EXEC SQL WHENEVER SQLERROR GOTO geterror;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		char	hv_credit_limit_mode;
		varchar	hv_entity_id[20];
		varchar	hv_ccy[3];
		varchar	hv_country[2];
		varchar	hv_txn_code[3];

		int	v_amount_id;
		char	v_ra_type;
		double	v_ra_value;
		double	v_ra_add_value;
		double	v_ra_min_value;
		double	v_ra_max_value;

		short	ind_amount_id = -1;
		short	ind_ra_type = -1;
		short	ind_ra_value = -1;
		short	ind_ra_add_value = -1;
		short	ind_ra_min_value = -1;
		short	ind_ra_max_value = -1;
	EXEC SQL END DECLARE SECTION;

	if (GetField_Char(hRls,"credit_limit_mode",&cTmp)) {
		hv_credit_limit_mode = cTmp;
DEBUGLOG(("GetMmsRuleCreditLimit credit_limit_mode = [%c]\n", hv_credit_limit_mode));
	} else {
		iRet = INT_ERR;
DEBUGLOG(("GetMmsRuleCreditLimit credit_limit_mode NOT FOUND!\n"));
ERRLOG("DBMmsRuleCreditLimit::GetMmsRuleCreditLimit credit_limit_mode NOT FOUND!\n");
	}

	if (GetField_CString(hRls, "entity_id", &csTmp)) {
		hv_entity_id.len = strlen(csTmp);
		memcpy(hv_entity_id.arr,csTmp,hv_entity_id.len);
DEBUGLOG(("GetMmsRuleCreditLimit entity_id = [%.*s]\n", hv_entity_id.len, hv_entity_id.arr));
	} else {
		iRet = INT_ERR;
DEBUGLOG(("GetMmsRuleCreditLimit entity_id NOT FOUND!\n"));
ERRLOG("DBMmsRuleCreditLimit::GetMmsRuleCreditLimit entity_id NOT FOUND!\n");
	}

	if (GetField_CString(hRls, "ccy", &csTmp)) {
		hv_ccy.len = strlen(csTmp);
		memcpy(hv_ccy.arr,csTmp,hv_ccy.len);
DEBUGLOG(("GetMmsRuleCreditLimit ccy = [%.*s]\n", hv_ccy.len, hv_ccy.arr));
	} else {
		iRet = INT_ERR;
DEBUGLOG(("GetMmsRuleCreditLimit ccy NOT FOUND!\n"));
ERRLOG("DBMmsRuleCreditLimit::GetMmsRuleCreditLimit ccy NOT FOUND!\n");
	}

	if (GetField_CString(hRls, "country", &csTmp)) {
		hv_country.len = strlen(csTmp);
		memcpy(hv_country.arr,csTmp,hv_country.len);
DEBUGLOG(("GetMmsRuleCreditLimit country = [%.*s]\n", hv_country.len, hv_country.arr));
	} else {
		iRet = INT_ERR;
DEBUGLOG(("GetMmsRuleCreditLimit country NOT FOUND!\n"));
ERRLOG("DBMmsRuleCreditLimit::GetMmsRuleCreditLimit country NOT FOUND!\n");
	}

	if (GetField_CString(hRls, "txn_code", &csTmp)) {
		hv_txn_code.len = strlen(csTmp);
		memcpy(hv_txn_code.arr,csTmp,hv_txn_code.len);
	} else {
		hv_txn_code.len = strlen("000");
		memcpy(hv_txn_code.arr,"000",hv_txn_code.len);
	}
DEBUGLOG(("GetMmsRuleCreditLimit txn_code = [%.*s]\n", hv_txn_code.len, hv_txn_code.arr));

	if (iRet == PD_OK) {
		EXEC SQL DECLARE c_getamountid CURSOR FOR
			SELECT	MCL_AMOUNT_ID,
				MRA_TYPE,
				MRA_VALUE,
				MRA_ADD_VALUE,
				MRA_MIN_VALUE,
				MRA_MAX_VALUE
			FROM	MMS_RULE_CREDIT_LIMIT,
				MMS_RULE_AMOUNT
			WHERE	MCL_AMOUNT_ID = MRA_ID
			  AND   MRA_DISABLED = 0
			  AND	MCL_CREDIT_LIMIT_MODE = :hv_credit_limit_mode
			  AND	MCL_ENTITY_ID = :hv_entity_id
			  AND	MCL_CCY = :hv_ccy
			  AND	MCL_COUNTRY = :hv_country
			  AND	MCL_TXN_CODE = :hv_txn_code
			  AND	MCL_DISABLED = 0
			ORDER BY
				MCL_EFFECT_DATE DESC;

		EXEC SQL FETCH	c_getamountid
			 INTO	:v_amount_id:ind_amount_id,
				:v_ra_type:ind_ra_type,
				:v_ra_value:ind_ra_value,
				:v_ra_add_value:ind_ra_add_value,
				:v_ra_min_value:ind_ra_min_value,
				:v_ra_max_value:ind_ra_max_value;

		if (SQLCODE == SQL_NOT_FOUND) {
			iRet = PD_ERR;
DEBUGLOG(("GetMmsRuleCreditLimit data NOT FOUND!\n"));
		} else {
			if (ind_amount_id >= 0) {
				PutField_Int(myHash, "amount_id", v_amount_id);
DEBUGLOG(("GetMmsRuleCreditLimit amount_id = [%d]\n",v_amount_id));
			}
			if (ind_ra_type >= 0) {
				PutField_Char(myHash, "ra_type", v_ra_type);
DEBUGLOG(("GetMmsRuleCreditLimit ra_type = [%d]\n",v_ra_type));
			}
			if (ind_ra_value >= 0) {
				PutField_Double(myHash, "ra_value", v_ra_value);
DEBUGLOG(("GetMmsRuleCreditLimit ra_value = [%.5f]\n",v_ra_value));
			}
			if (ind_ra_add_value >= 0) {
				PutField_Double(myHash, "ra_add_value", v_ra_add_value);
DEBUGLOG(("GetMmsRuleCreditLimit ra_add_value = [%.5f]\n",v_ra_add_value));
			}
			if (ind_ra_min_value >= 0) {
				PutField_Double(myHash, "ra_min_value", v_ra_min_value);
DEBUGLOG(("GetMmsRuleCreditLimit ra_min_value = [%.5f]\n",v_ra_min_value));
			}
			if (ind_ra_max_value >= 0) {
				PutField_Double(myHash, "ra_max_value", v_ra_max_value);
DEBUGLOG(("GetMmsRuleCreditLimit ra_max_value = [%.5f]\n",v_ra_max_value));
			}
		}
	}

DEBUGLOG(("GetMmsRuleCreditLimit Normal Exit! iRet = [%d]\n", iRet));
	return iRet;

geterror:
DEBUGLOG(("getrulecreditlimiterror code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MmsEntityFXBal getrulecreditlimiterror code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
    EXEC SQL CLOSE c_getamountid;
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return PD_ERR;
}

