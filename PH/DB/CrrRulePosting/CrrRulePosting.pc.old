/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/06/23              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "CrrRulePosting.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;
void CrrRulePosting(char    cdebug)
{
        cDebug = cdebug;
}

int GetRule(const char* csTxnCode,
                const char* csCountry,
                const char* csProduct,
                const char* csCcy,
                const char* csTxnType,
		const char* csPartyId,
                const char  cType,
                double  dAmt,
                hash_t *hRsp)
{
	int	iRet = PD_NOT_FOUND;

        EXEC SQL WHENEVER SQLERROR GOTO getrule_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
    
        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_country[PD_COUNTRY_LEN];
		varchar		hv_ccy[PD_CURRENCY_ID_LEN];
		varchar		hv_product[PD_PRODUCT_CODE_LEN];
		varchar		hv_txn_code[PD_TXN_CODE_LEN];
		varchar		hv_party_id[PD_MERCHANT_ID_LEN];
		char		hv_party_type;
		varchar		hv_entry_type[PD_JNL_ENTRY_TYPE_LEN];
		
		
		int		v_jnl_type_id;
		int		v_credit_gl_id;
		int		v_debit_gl_id;
		int		v_manual_approval;
		varchar		v_desc[PD_DESC_LEN +1];


		short		ind_country = -1;
		short		ind_ccy = -1;
		short		ind_product = -1;
		short		ind_txn_code = -1;
		short		ind_party_id = -1;
		short		ind_party_type = -1;
		short		ind_entry_type = -1;

		short		ind_jnl_type_id = -1;
		short		ind_credit_gl_id = -1;
		short		ind_debit_gl_id = -1;
		short		ind_manual_approval = -1;
		short		ind_desc = -1;
    
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("GetRule()\n"));

/*country id */
	hv_country.len = strlen(csCountry);
	memcpy(hv_country.arr,csCountry,hv_country.len);
	ind_country = 0;
DEBUGLOG(("GetRule:: country_id = [%.*s]\n",hv_country.len,hv_country.arr));

/* ccy */
	hv_ccy.len = strlen(csCcy);
	memcpy(hv_ccy.arr,csCcy,hv_ccy.len);
	ind_ccy = 0;
DEBUGLOG(("GetRule:: ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));

/* product */
	hv_product.len = strlen(csProduct);
	memcpy(hv_product.arr,csProduct,hv_product.len);
	ind_product = 0;
DEBUGLOG(("GetRule:: product = [%.*s]\n",hv_product.len,hv_product.arr));

/* txn_code */
	hv_txn_code.len = strlen(csTxnCode);
	memcpy(hv_txn_code.arr,csTxnCode,hv_txn_code.len);
	ind_txn_code = 0;
DEBUGLOG(("GetRule:: txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));

/* party_id */
	hv_party_id.len = strlen(csPartyId);
	memcpy(hv_party_id.arr,csPartyId,hv_party_id.len);
	ind_party_id = 0;
DEBUGLOG(("GetRule:: party_id = [%.*s]\n",hv_party_id.len,hv_party_id.arr));

/* party_type */
	hv_party_type = cType;
	ind_party_type = 0;
DEBUGLOG(("GetRule:: party_id = [%c]\n",hv_party_type));

/* entry_type */
	hv_entry_type.len = strlen(csTxnType);
	memcpy(hv_entry_type.arr,csTxnType,hv_entry_type.len);
	ind_entry_type = 0;
DEBUGLOG(("GetRule:: entry_type = [%.*s]\n",hv_entry_type.len,hv_entry_type.arr));


	EXEC SQL DECLARE c_cursor_getrule CURSOR FOR
		 SELECT	cr_jnl_type_id,
         		cr_credit_gl_id,
         		cr_debit_gl_id,
			mnl_approval,
                        b.description
  		   FROM crr_rule_posting,
                        crr_jnl_type a,
 			crr_jnl_entry_type b
		WHERE cr_country_id = :hv_country:ind_country
    		  and cr_currency = :hv_ccy:ind_ccy
    		  and cr_product_code = :hv_product:ind_product
    		  and cr_txn_code = :hv_txn_code:ind_txn_code
    		  and cr_party_type = :hv_party_type:ind_party_type
    		  and cr_party_id = :hv_party_id:ind_party_id
		  and cr_jnl_entry_type_id = :hv_entry_type:ind_entry_type
   		  and cr_disabled = 0
 		  and cr_jnl_type_id = a.jnl_type_id
		  and cr_jnl_type_id = b.jnl_type_id
                  and cr_jnl_entry_type_id = b.entry_type_id
                  and a.disabled = 0
                  and b.disabled = 0; 
		  

	
	EXEC SQL OPEN c_cursor_getrule;
        do {
                EXEC SQL FETCH c_cursor_getrule
                INTO	:v_jnl_type_id:ind_jnl_type_id,
			:v_credit_gl_id:ind_credit_gl_id,
			:v_debit_gl_id:ind_debit_gl_id,
			:v_manual_approval:ind_manual_approval,
			:v_desc:ind_desc;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}
	
		iRet = PD_FOUND;
/*jnl type id */
		if (ind_jnl_type_id >= 0 ) {
			PutField_Int(hRsp,"jnl_type_id",v_jnl_type_id);
DEBUGLOG(("GetRule:: jnl_type_id = [%d]\n",v_jnl_type_id));
		}


/* credit gl id */
		if (ind_credit_gl_id >= 0 ) {
			PutField_Int(hRsp,"credit_gl_id",v_credit_gl_id);
DEBUGLOG(("GetRule:: credit_gl_id = [%d]\n",v_credit_gl_id));
		}

/* debit gl id */
		if (ind_debit_gl_id >= 0 ) {
			PutField_Int(hRsp,"debit_gl_id",v_debit_gl_id);
DEBUGLOG(("GetRule:: debit_gl_id = [%d]\n",v_debit_gl_id));
		}

/* manual approval */
		if (ind_manual_approval >= 0 ) {
			PutField_Int(hRsp,"manual_approval",v_manual_approval);
DEBUGLOG(("GetRule:: manual_approval = [%d]\n",v_manual_approval));
		}
/* desc */
		if (ind_desc >= 0 ) {
			v_desc.arr[v_desc.len] = '\0';
			PutField_CString(hRsp,"desc",v_desc.arr);
DEBUGLOG(("GetRule:: desc = [%s]\n",v_desc.arr));
		}

		break;
	}
	while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_getrule;
	return iRet;

getrule_error:
ERRLOG("CrrRulePosting::getrule_error code %d\n", sqlca.sqlcode);
DEBUGLOG(("getrule_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_getrule;
        return PD_NOT_FOUND;
}
