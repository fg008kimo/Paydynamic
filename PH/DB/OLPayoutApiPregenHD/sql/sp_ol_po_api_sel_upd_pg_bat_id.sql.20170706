CREATE OR REPLACE FUNCTION sp_ol_po_api_sel_upd_pg_bat_id(
   in_batch_id       	OL_PAYOUT_API_PREGEN_HD.OAP_BATCH_ID%TYPE,
   in_status       	OL_PAYOUT_API_PREGEN_HD.OAP_STATUS%TYPE,
   in_check_status	INTEGER,
   out_cursor       	OUT SYS_REFCURSOR)

RETURN NUMBER IS
        iCnt    integer := 0;

BEGIN

   IF (in_check_status = 0) THEN
	SELECT count(*)
   	INTO iCnt
   	FROM ol_payout_api_pregen_hd
   	WHERE oap_batch_id = in_batch_id;

       	IF iCnt > 0 THEN
          	OPEN out_cursor FOR
            	SELECT oap_batch_id
              	FROM ol_payout_api_pregen_hd
              	WHERE oap_batch_id = in_batch_id
              	FOR UPDATE NOWAIT;

              	RETURN 1;
     	ELSE
              	RETURN 0;
    	END IF;
   ELSE	
   	SELECT count(*)
   	INTO iCnt
   	FROM ol_payout_api_pregen_hd
   	WHERE oap_batch_id = in_batch_id
   	AND oap_status != in_status;

   	IF iCnt > 0 THEN
		RETURN 0;
   	ELSE
		IF (in_status = 'W') THEN
			SELECT count(*)
   			INTO iCnt
   			FROM ol_payout_api_pregen_hd
   			WHERE oap_batch_id = in_batch_id
			AND oap_status = in_status
			AND (oap_pregen_ret_code is not NULL OR oap_gen_ret_code is not NULL);

			IF iCnt > 0 THEN
				RETURN 0;
			ELSE
				SELECT count(*)
				INTO iCnt
                        	FROM ol_payout_api_pregen_hd
                        	WHERE oap_batch_id = in_batch_id
                        	AND oap_status = in_status
                        	AND (oap_pregen_ret_code is NULL AND oap_gen_ret_code is NULL);

				IF iCnt > 0 THEN
					OPEN out_cursor FOR
        				SELECT oap_batch_id
        				FROM ol_payout_api_pregen_hd
        				WHERE oap_batch_id = in_batch_id
					AND oap_status = in_status
					AND (oap_pregen_ret_code is NULL AND oap_gen_ret_code is NULL)
        				FOR UPDATE NOWAIT;

					RETURN 1;
				ELSE
					RETURN 0;
				END IF;
			END IF;
		ELSIF (in_status = 'V') THEN
			SELECT count(*)
        	        INTO iCnt
        	        FROM ol_payout_api_pregen_hd
        	        WHERE oap_batch_id = in_batch_id
			AND oap_status = in_status
        	        AND (oap_pregen_ret_code != 0 OR oap_gen_ret_code is not NULL);

        	        IF iCnt > 0 THEN
        	                RETURN 0;
        	        ELSE
               	         	SELECT count(*)
				INTO iCnt
                        	FROM ol_payout_api_pregen_hd
                        	WHERE oap_batch_id = in_batch_id
                        	AND oap_status = in_status
                        	AND (oap_pregen_ret_code = 0 AND oap_gen_ret_code is NULL);

				IF iCnt > 0 THEN
					OPEN out_cursor FOR
                       		 	SELECT oap_batch_id
                        		FROM ol_payout_api_pregen_hd
                        		WHERE oap_batch_id = in_batch_id
                        		AND oap_status = in_status
                        		AND (oap_pregen_ret_code = 0 AND oap_gen_ret_code is NULL)
                        		FOR UPDATE NOWAIT;

					RETURN 1;
				ELSE
        	                	RETURN 0;
				END IF;
        	        END IF;
		ELSIF (in_status = 'P') THEN
        	        SELECT count(*)
        	        INTO iCnt
        	        FROM ol_payout_api_pregen_hd
        	        WHERE oap_batch_id = in_batch_id
        	        AND oap_status = in_status;
	
	                IF iCnt > 0 THEN
	                        OPEN out_cursor FOR
	                        SELECT oap_batch_id
	                        FROM ol_payout_api_pregen_hd
	                        WHERE oap_batch_id = in_batch_id
	                        AND oap_status = in_status
	                        FOR UPDATE NOWAIT;
	
	                        RETURN 1;
	                ELSE
	                        RETURN 0;
	                END IF;
		ELSE
			RETURN 0;
		END IF;
	END IF;
   END IF;

   RETURN 0;

EXCEPTION
   WHEN OTHERS
   THEN
      RETURN 9;

END sp_ol_po_api_sel_upd_pg_bat_id;
/
