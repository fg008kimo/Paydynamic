/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/01/09              Dirk Wong
Add GetTxnId, GetBatchId and CheckSingleBatchId	   2015/01/14		   Elvis Wong	
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLBatchTxnRelation.h"
#include "common.h"
#include "internal.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void OLBatchTxnRelation(char    cdebug)
{
        cDebug = cdebug;
}

int Add(const hash_t *hRls)
{
	char	cTmp;
	char*	csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		char		hv_batch_type;
		varchar		hv_batch_id[PD_TXN_SEQ_LEN];
		char		hv_txn_level;
		varchar		hv_txn_id[PD_TXN_SEQ_LEN];
		varchar         hv_create_user[PD_USER_LEN];

		short		ind_batch_type = -1;
		short		ind_batch_id = -1;
		short		ind_txn_level = -1;
		short		ind_txn_id = -1;
		short		ind_create_user = -1;

		short           hv_return_value;
	EXEC SQL END DECLARE SECTION;
DEBUGLOG(("Add: Begin\n"));

	if (GetField_Char(hRls,"batch_type",&cTmp)) {
		hv_batch_type = cTmp;
		ind_batch_type = 0;
DEBUGLOG(("Add: batch_type = [%c]\n",hv_batch_type));
	}

	if (GetField_CString(hRls,"batch_id",&csTmp)) {
		hv_batch_id.len = strlen(csTmp);
		strncpy((char*)hv_batch_id.arr, csTmp, hv_batch_id.len);
		ind_batch_id = 0;
DEBUGLOG(("Add: batch_id = [%s]\n",(char*)hv_batch_id.arr));
	}

	if (GetField_Char(hRls,"txn_level",&cTmp)) {
		hv_txn_level = cTmp;
		ind_txn_level = 0;
DEBUGLOG(("Add: txn_level =  [%c]\n",hv_txn_level));
	}

	if (GetField_CString(hRls,"txn_id",&csTmp)) {
		hv_txn_id.len = strlen(csTmp);
		strncpy((char*)hv_txn_id.arr, csTmp, hv_txn_id.len);
		ind_txn_id = 0;
DEBUGLOG(("Add: txn_id = [%s]\n",(char*)hv_txn_id.arr));
	}

	if(GetField_CString(hRls,"create_user",&csTmp))
	{
		hv_create_user.len = strlen(csTmp);
		strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
	}
DEBUGLOG(("Add: create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_batch_tx_relation_insert(
						:hv_batch_type:ind_batch_type,
						:hv_batch_id:ind_batch_id,
						:hv_txn_level:ind_txn_level,
						:hv_txn_id:ind_txn_id,
                                                :hv_create_user:ind_create_user);
		END;
	END-EXEC;

	DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
DEBUGLOG(("Add:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("OLBatchTxnRelation_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	} 

	if (hv_return_value == SP_ERR)  {
ERRLOG("OLBatchTxnRelation_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLBatchTxnRelation_Add: SP_INTERNAL_ERR TxnAbort\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}

int GetTxnId(const hash_t* hRls, recordset_t* rRecordSet)
{
        int iRet = PD_OK;

        char *csTmp;
        char cTmp;

        hash_t *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO gettxnid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		char            hv_batch_type;
                varchar         hv_batch_id[PD_TXN_SEQ_LEN];
                char            hv_txn_level;

                varchar         v_txn_id[PD_TXN_SEQ_LEN];
                short           ind_txn_id = -1;
        EXEC SQL END DECLARE SECTION;

/* batch_type */
	if (GetField_Char(hRls, "batch_type", &cTmp)) {
                hv_batch_type = cTmp;
DEBUGLOG(("GetTxnId: batch_type = [%c]\n", hv_batch_type));
        }

/* batch_id */
        if (GetField_CString(hRls,"batch_id",&csTmp)) {
                hv_batch_id.len = strlen(csTmp);
                strncpy((char*)hv_batch_id.arr, csTmp, hv_batch_id.len);
DEBUGLOG(("GetTxnId: batch_id = [%s]\n",(char*)hv_batch_id.arr));
        }

/* txn_level */
	if (GetField_Char(hRls, "txn_level", &cTmp)) {
                hv_txn_level = cTmp;
DEBUGLOG(("GetTxnId: txn_level = [%c]\n", hv_txn_level));
        }

	EXEC SQL DECLARE c_cursor_gettxnid CURSOR FOR
                SELECT  obtr_txn_id
                FROM    ol_batch_txn_relation
                WHERE   obtr_batch_type = :hv_batch_type
                AND     obtr_batch_id = :hv_batch_id
		AND	obtr_txn_level = :hv_txn_level
		ORDER BY obtr_relation_timestamp DESC;
        EXEC SQL OPEN c_cursor_gettxnid;

	for (;;) {
                EXEC SQL FETCH c_cursor_gettxnid
                INTO	:v_txn_id:ind_txn_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash, 0);

		// txn_id
                if (ind_txn_id >= 0) {
                        v_txn_id.arr[v_txn_id.len] = '\0';
                        PutField_CString(myHash, "txn_id", (const char*)v_txn_id.arr);
DEBUGLOG(("GetTxnId: txn_id = [%s]\n", (const char*)v_txn_id.arr));
                }

                RecordSet_Add(rRecordSet, myHash);
        }

	EXEC SQL CLOSE c_cursor_gettxnid;

DEBUGLOG(("GetTxnId: Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

gettxnid_error:
DEBUGLOG(("gettxnid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLBatchTxnRelation gettxnid_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL CLOSE c_cursor_gettxnid;
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}


int GetBatchId(const hash_t* hRls, recordset_t* rRecordSet)
{
        int iRet = PD_OK;

        char *csTmp;
        char cTmp;

        hash_t *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO getbatchid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                char            hv_txn_level;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];
		char            hv_batch_type;

                varchar         v_batch_id[PD_TXN_SEQ_LEN];
                short           ind_batch_id = -1;
        EXEC SQL END DECLARE SECTION;

/* txn_level */
	if (GetField_Char(hRls, "txn_level", &cTmp)) {
                hv_txn_level = cTmp;
DEBUGLOG(("GetBatchId: txn_level = [%c]\n", hv_txn_level));
        }

/* txn_id */
        if (GetField_CString(hRls,"txn_id",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                strncpy((char*)hv_txn_id.arr, csTmp, hv_txn_id.len);
DEBUGLOG(("GetBatchId: txn_id = [%s]\n",(char*)hv_txn_id.arr));
        }

/* batch_type */
        if (GetField_Char(hRls, "batch_type", &cTmp)) {
                hv_batch_type = cTmp;
DEBUGLOG(("GetBatchId: batch_type = [%c]\n", hv_batch_type));
        }

	EXEC SQL DECLARE c_cursor_getbatchid CURSOR FOR
                SELECT  obtr_batch_id
                FROM    ol_batch_txn_relation
                WHERE   obtr_txn_level = :hv_txn_level
                AND     obtr_txn_id = :hv_txn_id
		AND	obtr_batch_type = :hv_batch_type
		ORDER BY obtr_relation_timestamp DESC;
        EXEC SQL OPEN c_cursor_getbatchid;

	for (;;) {
                EXEC SQL FETCH c_cursor_getbatchid
                INTO    :v_batch_id:ind_batch_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash, 0);

		// batch_id
                if (ind_batch_id >= 0) {
                        v_batch_id.arr[v_batch_id.len] = '\0';
                        PutField_CString(myHash, "batch_id", (const char*)v_batch_id.arr);
DEBUGLOG(("GetBatchId: batch_id = [%s]\n", (const char*)v_batch_id.arr));
                }

                RecordSet_Add(rRecordSet, myHash);
        }

	EXEC SQL CLOSE c_cursor_getbatchid;

DEBUGLOG(("GetBatchId: Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

getbatchid_error:
DEBUGLOG(("getbatchid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLBatchTxnRelation getbatchid_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL CLOSE c_cursor_getbatchid;
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int CheckSingleBatchId(const hash_t* hRls)
{
	int iRet = PD_TRUE;

        char *csTmp;
        char cTmp;

        EXEC SQL WHENEVER SQLERROR GOTO checksinglebatchid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                char            hv_txn_level;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];
                char            hv_batch_type;

		int     	v_cnt;
        EXEC SQL END DECLARE SECTION;

/* txn_level */
        if (GetField_Char(hRls, "txn_level", &cTmp)) {
                hv_txn_level = cTmp;
DEBUGLOG(("CheckSingleBatchId: txn_level = [%c]\n", hv_txn_level));
        }

/* txn_id */
        if (GetField_CString(hRls,"txn_id",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                strncpy((char*)hv_txn_id.arr, csTmp, hv_txn_id.len);
DEBUGLOG(("CheckSingleBatchId: txn_id = [%s]\n",(char*)hv_txn_id.arr));
        }

/* batch_type */
        if (GetField_Char(hRls, "batch_type", &cTmp)) {
                hv_batch_type = cTmp;
DEBUGLOG(("CheckSingleBatchId: batch_type = [%c]\n", hv_batch_type));
        }

        EXEC SQL        SELECT  COUNT(*)
                        INTO    :v_cnt
                        FROM    ol_batch_txn_relation
                        WHERE   obtr_txn_level = :hv_txn_level
                	AND     obtr_txn_id = :hv_txn_id
                	AND     obtr_batch_type = :hv_batch_type;

        if (v_cnt==1) {
                iRet = PD_TRUE;
DEBUGLOG(("CheckSingleBatchId() Normal Exit! iRet = [%d]\n", iRet));
        } else {
                iRet = PD_FALSE;
DEBUGLOG(("CheckSingleBatchId() Normal Exit! iRet = [%d]\n", iRet));
        }

        return iRet;

checksinglebatchid_error:
DEBUGLOG(("checksinglebatchid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}
