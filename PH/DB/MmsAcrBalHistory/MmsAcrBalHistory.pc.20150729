/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/04/29              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "MmsAcrBalHistory.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char cDebug;

void MmsAcrBalHistory(char cdebug)
{
	cDebug = cdebug;
}


int Add(const hash_t *hRec)
{
	char *csTmp;
	double dTmp;
	int iTmp;
	char cTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		int hv_history_id;
		varchar hv_entity_id[PD_MMS_ENTITY_ID_LEN];
		varchar hv_fund_date[PD_DATE_LEN];
		char hv_fund_direction;
		varchar hv_org_ccy[PD_CCY_ID_LEN];
		varchar hv_ccy[PD_CCY_ID_LEN];
		double hv_old_bal;
		double hv_new_bal;
		double hv_old_rate;
		double hv_new_rate;
		double hv_old_ratio;
		double hv_new_ratio;
		varchar hv_txn_id[PD_TXN_SEQ_LEN];
		//int hv_txn_dt_seq;
		varchar hv_create_user[PD_CREATE_USER_LEN];

		short ind_history_id = -1;
		short ind_entity_id = -1;
		short ind_fund_date = -1;
		short ind_fund_direction = -1;
		short ind_org_ccy = -1;
		short ind_ccy = -1;
		short ind_old_bal = -1;
		short ind_new_bal = -1;
		short ind_old_rate = -1;
		short ind_new_rate = -1;
		short ind_old_ratio = -1;
		short ind_new_ratio = -1;
		short ind_txn_id = -1;
		//short ind_txn_dt_seq = -1;
		short ind_create_user = -1;

		short hv_return_value;
	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));

	if (GetField_Int(hRec, "history_id", &iTmp)) {
		hv_history_id = iTmp;
		ind_history_id = 0;
DEBUGLOG(("Add: history_id = [%d]\n", hv_history_id));
	}

	if (GetField_CString(hRec, "entity_id", &csTmp)) {
		hv_entity_id.len = strlen(csTmp);
		strncpy((char *)hv_entity_id.arr, csTmp, hv_entity_id.len);
		ind_entity_id = 0;
DEBUGLOG(("Add: entity_id = [%.*s]\n", hv_entity_id.len, hv_entity_id.arr));
	}

	if (GetField_CString(hRec, "fund_date", &csTmp)) {
		hv_fund_date.len = strlen(csTmp);
		strncpy((char *)hv_fund_date.arr, csTmp, hv_fund_date.len);
		ind_fund_date = 0;
DEBUGLOG(("Add: fund_date = [%.*s]\n", hv_fund_date.len, hv_fund_date.arr));
	}

	if (GetField_Char(hRec, "fund_direction", &cTmp)) {
		hv_fund_direction = cTmp;
		ind_fund_direction = 0;
DEBUGLOG(("Add: fund_direction = [%c]\n", hv_fund_direction));
	}

	if (GetField_CString(hRec, "org_ccy", &csTmp)) {
		hv_org_ccy.len = strlen(csTmp);
		strncpy((char *)hv_org_ccy.arr, csTmp, hv_org_ccy.len);
		ind_org_ccy = 0;
DEBUGLOG(("Add: org_ccy = [%.*s]\n", hv_org_ccy.len, hv_org_ccy.arr));
	}

	if (GetField_CString(hRec, "ccy", &csTmp)) {
		hv_ccy.len = strlen(csTmp);
		strncpy((char *)hv_ccy.arr, csTmp, hv_ccy.len);
		ind_ccy = 0;
DEBUGLOG(("Add: ccy = [%.*s]\n", hv_ccy.len, hv_ccy.arr));
	}

	if (GetField_Double(hRec, "old_bal", &dTmp)) {
		hv_old_bal = dTmp;
		ind_old_bal = 0;
DEBUGLOG(("Add: old_bal = [%f]\n", hv_old_bal));
	}

	if (GetField_Double(hRec, "new_bal", &dTmp)) {
		hv_new_bal = dTmp;
		ind_new_bal = 0;
DEBUGLOG(("Add: new_bal = [%f]\n", hv_new_bal));
	}

	if (GetField_Double(hRec, "old_rate", &dTmp)) {
		hv_old_rate = dTmp;
		ind_old_rate = 0;
DEBUGLOG(("Add: old_rate = [%f]\n", hv_old_rate));
	}

	if (GetField_Double(hRec, "new_rate", &dTmp)) {
		hv_new_rate = dTmp;
		ind_new_rate = 0;
DEBUGLOG(("Add: new_rate = [%f]\n", hv_new_rate));
	}

	if (GetField_Double(hRec, "old_ratio", &dTmp)) {
		hv_old_ratio = dTmp;
		ind_old_ratio = 0;
DEBUGLOG(("Add: old_ratio = [%f]\n", hv_old_ratio));
	}

	if (GetField_Double(hRec, "new_ratio", &dTmp)) {
		hv_new_ratio = dTmp;
		ind_new_ratio = 0;
DEBUGLOG(("Add: new_ratio = [%f]\n", hv_new_ratio));
	}

	if (GetField_CString(hRec, "txn_id", &csTmp)) {
		hv_txn_id.len = strlen(csTmp);
		strncpy((char *)hv_txn_id.arr, csTmp, hv_txn_id.len);
		ind_txn_id = 0;
DEBUGLOG(("Add: txn_id = [%.*s]\n", hv_txn_id.len, hv_txn_id.arr));
	}
/*
	if (GetField_Int(hRec, "txn_dt_seq", &iTmp)) {
		hv_txn_dt_seq = iTmp;
		ind_txn_dt_seq = 0;
DEBUGLOG(("Add: txn_dt_seq = [%d]\n", hv_txn_dt_seq));
	}
*/
	if (GetField_CString(hRec, "create_user", &csTmp)) {
		hv_create_user.len = strlen(csTmp);
		strncpy((char *)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
DEBUGLOG(("Add: create_user = [%.*s]\n", hv_create_user.len, hv_create_user.arr));
	}

	EXEC SQL EXECUTE
		BEGIN
		:hv_return_value := sp_mms_acr_bal_history_insert(
					:hv_history_id:ind_history_id,
					:hv_entity_id:ind_entity_id,
					:hv_fund_date:ind_fund_date,
					:hv_fund_direction:ind_fund_direction,
					:hv_org_ccy:ind_org_ccy,
					:hv_ccy:ind_ccy,
					:hv_old_bal:ind_old_bal,
					:hv_new_bal:ind_new_bal,
					:hv_old_rate:ind_old_rate,
					:hv_new_rate:ind_new_rate,
					:hv_old_ratio:ind_old_ratio,
					:hv_new_ratio:ind_new_ratio,
					:hv_txn_id:ind_txn_id,
					//:hv_txn_dt_seq:ind_txn_dt_seq,
					:hv_create_user:ind_create_user);
		END;
	END-EXEC;

DEBUGLOG(("Add: Ret = [%d]\n", hv_return_value));

	if (hv_return_value == SP_OK) {
DEBUGLOG(("Add: Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR) {
ERRLOG("MmsAcrBalHistory_Add: SP_OTHER_ERR\n");
DEBUGLOG(("Add: SP_OTHER_ERR\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR) {
ERRLOG("MmsAcrBalHistory_Add: SP_ERR\n");
DEBUGLOG(("Add: SP_ERR\n"));
		return PD_ERR;
	}

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MmsAcrBalHistory_Add: SP_INTERNAL_ERR\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}
