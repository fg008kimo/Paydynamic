/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/03/18              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "MerchantBucket.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;
void MerchantBucket(char    cdebug)
{
        cDebug = cdebug;
}

int CreditMerchantAmount(const char* csPostingDate,
                        const char* csMerchantID,
                        const char* csCountry,
                        const char* csCcy,
                        const char* csServiceCode,
                        const char* csPsp,
                        const char* csType,
                        double dAmount,
			const char* csUser)
{

        EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short 		hv_return_value;

	varchar		hv_posting_date[PD_DATE_LEN];	
	varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
	varchar		hv_country[PD_COUNTRY_LEN];
	varchar		hv_currency_id[PD_CCY_ID_LEN];
	varchar		hv_service_code[PD_SERVICE_CODE_LEN];
	varchar		hv_psp_id[PD_PSP_ID_LEN];
	varchar		hv_bucket_type[PD_BUCKET_TYPE_LEN];
        double		hv_bal;
	varchar		hv_create_user[PD_USER_LEN];	



	short		ind_posting_date = -1;
	short		ind_merchant_id = -1;
	short		ind_country = -1;
	short		ind_currency_id = -1;
	short		ind_service_code = -1;
	short		ind_psp_id = -1;
	short		ind_bucket_type = -1;
	short		ind_bal = -1;
	short		ind_create_user = -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("UpdateAndAdd: Begin\n"));

  	hv_posting_date.len = strlen(csPostingDate);
        memcpy(hv_posting_date.arr,csPostingDate,hv_posting_date.len);
        ind_posting_date = 0;
DEBUGLOG(("UpdateAndAdd:host_posting_date = [%.*s]\n",hv_posting_date.len,hv_posting_date.arr));

        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
        ind_merchant_id = 0;
DEBUGLOG(("UpdateAndAdd:merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

        hv_country.len = strlen(csCountry);
        memcpy(hv_country.arr,csCountry,hv_country.len);
        ind_country = 0;
DEBUGLOG(("UpdateAndAdd:country = [%.*s]\n",hv_country.len,hv_country.arr));

        hv_currency_id.len = strlen(csCcy);
        memcpy(hv_currency_id.arr,csCcy,hv_currency_id.len);
        ind_currency_id = 0;
DEBUGLOG(("UpdateAndAdd:currency_id = [%.*s]\n",hv_currency_id.len,hv_currency_id.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
        ind_service_code = 0;
DEBUGLOG(("UpdateAndAdd:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        hv_psp_id.len = strlen(csPsp);
        memcpy(hv_psp_id.arr,csPsp,hv_psp_id.len);
        ind_psp_id = 0;
DEBUGLOG(("UpdateAndAdd:psp_id = [%.*s]\n",hv_psp_id.len,hv_psp_id.arr));

        hv_bucket_type.len = strlen(csType);
        memcpy(hv_bucket_type.arr,csType,hv_bucket_type.len);
        ind_bucket_type = 0;
DEBUGLOG(("UpdateAndAdd:bucket_type = [%.*s]\n",hv_bucket_type.len,hv_bucket_type.arr));

	/* bal  */
        hv_bal = dAmount;
        ind_bal = 0;
DEBUGLOG(("UpdateAndAdd:bal = [%f]\n",hv_bal));

        hv_create_user.len = strlen(csUser);
        memcpy(hv_create_user.arr,csUser,hv_create_user.len);
        ind_create_user = 0;
DEBUGLOG(("UpdateAndAdd:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));

	EXEC SQL EXECUTE
                BEGIN
			:hv_return_value := sp_merchant_bucket_insert(
					:hv_posting_date:ind_posting_date,
					:hv_merchant_id:ind_merchant_id,
					:hv_country:ind_country,
					:hv_currency_id:ind_currency_id,
					:hv_service_code:ind_service_code,
					:hv_psp_id:ind_psp_id,
					:hv_bucket_type:ind_bucket_type,
					:hv_bal:ind_bal,
					:hv_create_user:ind_create_user);
	        END;
        END-EXEC;

DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("Add:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MerchantBucket_Add: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("MerchantBucket_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		TxnAbort();
                return PD_ERR;
        }

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("MerchantBucket_Add: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR TxnAbort\n"));
	TxnAbort();
        return PD_INTERNAL_ERR;
}




int UpdateBalanceByType(const hash_t *hMerchantBucket)
{
	char*   csBuf;
	char*   csMerchId;
	char*   csCcyId;
	char*   csServiceCode;
	char*   csPspId;
	char*   csUser;
	char*   csPostDate;
	char*   csBucketType;
	double	dTmp;

	EXEC SQL WHENEVER SQLERROR GOTO update_balance_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

	varchar         hv_dynstmt[1024];

	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr,"update merchant_bucket set mb_update_timestamp  = sysdate");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	GetField_CString(hMerchantBucket,"post_date",&csPostDate);
DEBUGLOG(("Update:post_date = [%s]\n",csPostDate));

	GetField_CString(hMerchantBucket,"merchant_id",&csMerchId);
DEBUGLOG(("Update:merchant_id = [%s]\n",csMerchId));

	GetField_CString(hMerchantBucket,"txn_ccy",&csCcyId);
DEBUGLOG(("Update:txn_ccy = [%s]\n",csCcyId));

	GetField_CString(hMerchantBucket,"service_code",&csServiceCode);
DEBUGLOG(("Update:service_code = [%s]\n",csServiceCode));

	GetField_CString(hMerchantBucket,"psp_id",&csPspId);
DEBUGLOG(("Update:psp_id = [%s]\n",csPspId));

	GetField_CString(hMerchantBucket,"bucket_type",&csBucketType);
DEBUGLOG(("Update:bucket_type = [%s]\n",csBucketType));

	GetField_CString(hMerchantBucket,"update_user",&csUser);
DEBUGLOG(("Update:update_user = [%s]\n",csUser));

/* balance */
	if (GetField_Double(hMerchantBucket,"balance",&dTmp)) {
DEBUGLOG(("Update:balance = [%f]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",mb_balance = '");
		strcat((char*)hv_dynstmt.arr, csBuf);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	strcat((char *)hv_dynstmt.arr, " WHERE mb_merchant_id = '");
	strcat((char *)hv_dynstmt.arr, csMerchId);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " and mb_currency_id = '");
	strcat((char *)hv_dynstmt.arr, csCcyId);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " and mb_service_code = '");
	strcat((char *)hv_dynstmt.arr, csServiceCode);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " and mb_posting_date= '");
	strcat((char *)hv_dynstmt.arr, csPostDate);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " and mb_psp_id = '");
	strcat((char *)hv_dynstmt.arr, csPspId);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " and mb_bucket_type = '");
	strcat((char *)hv_dynstmt.arr, csBucketType);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " and mb_update_user = '");
	strcat((char *)hv_dynstmt.arr, csUser);
	strcat((char *)hv_dynstmt.arr, "'");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);


DEBUGLOG(("Update Normal Exit\n"));
	return PD_OK;

update_balance_error:
DEBUGLOG(("update_paypout_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MerchantBucket_Update: SP_INTERNAL_ERR\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_INTERNAL_ERR;
}



double GetBalanceByType(const hash_t *hMerchantBucket)
{
	double dResult = 0;
	char	*csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO get_balance_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_ccy_id[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
                varchar         hv_psp_id[PD_PSP_ID_LEN];
                varchar         hv_post_date[PD_DATE_LEN];
                varchar         hv_bucket_type[PD_BUCKET_TYPE_LEN];

                double          v_balance;
		short           ind_balance= -1;
	EXEC SQL END DECLARE SECTION;

	if(GetField_CString(hMerchantBucket,"merchant_id",&csTmp)){
		hv_merchant_id.len = strlen(csTmp);
        	memcpy(hv_merchant_id.arr,csTmp,hv_merchant_id.len);
DEBUGLOG(("GetBalance merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
	}

	if(GetField_CString(hMerchantBucket,"txn_ccy",&csTmp)){
        	hv_ccy_id.len = strlen(csTmp);
        	memcpy(hv_ccy_id.arr,csTmp,hv_ccy_id.len);
DEBUGLOG(("GetBalance ccy_id = [%.*s]\n",hv_ccy_id.len,hv_ccy_id.arr));
	}
	if(GetField_CString(hMerchantBucket,"service_code",&csTmp)){
        	hv_service_code.len = strlen(csTmp);
        	memcpy(hv_service_code.arr,csTmp,hv_service_code.len);
DEBUGLOG(("GetBalance service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
	}

	if(GetField_CString(hMerchantBucket,"psp_id",&csTmp)){
        	hv_psp_id.len = strlen(csTmp);
        	memcpy(hv_psp_id.arr,csTmp,hv_psp_id.len);
DEBUGLOG(("GetBalance psp_id = [%.*s]\n",hv_psp_id.len,hv_psp_id.arr));
	}

	if(GetField_CString(hMerchantBucket,"post_date",&csTmp)){
        	hv_post_date.len = strlen(csTmp);
        	memcpy(hv_post_date.arr,csTmp,hv_post_date.len);
DEBUGLOG(("GetBalance post_date = [%.*s]\n",hv_post_date.len,hv_post_date.arr));
	}

	if(GetField_CString(hMerchantBucket,"bucket_type",&csTmp)){
        	hv_bucket_type.len = strlen(csTmp);
        	memcpy(hv_bucket_type.arr,csTmp,hv_bucket_type.len);
DEBUGLOG(("GetBalance bucket_type = [%.*s]\n",hv_bucket_type.len,hv_bucket_type.arr));
	}

	EXEC SQL SELECT mb_bal
		 INTO	:v_balance:ind_balance
		 FROM	merchant_bucket
		 WHERE	mb_posting_date = :hv_post_date
		 AND	mb_merchant_id = :hv_merchant_id
		 AND	mb_currency_id = :hv_ccy_id
		 AND	mb_service_code = :hv_service_code
		 AND	mb_psp_id = :hv_psp_id
		 AND	mb_bucket_type =:hv_bucket_type;

	if(ind_balance>=0){
DEBUGLOG(("GetBalance balance=[%lf]\n", v_balance));
		dResult = v_balance;
	}

	if(dResult!=0){
DEBUGLOG(("GetBalance Normal Exit\n"));
	}
	else{
DEBUGLOG(("GetBalance Error\n"));
	}

	return dResult;

get_balance_error:
DEBUGLOG(("get_balance_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MerchantBucket_Get: SP_INTERNAL_ERR\n");
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return 0;

}



int UpdateReleaseDetails(const hash_t *hMerchantBucket)
{
	char*   csBuf;
	char*   csTmp;
	char*   csMerchId;
	char*   csCcyId;
	char*   csServiceCode;
	char*   csPspId;
	char*	csCountryId;
	char*   csPostDate;
	char*   csBucketType;
	double	dTmp;

	EXEC SQL WHENEVER SQLERROR GOTO update_detail_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

	varchar         hv_dynstmt[1024];

	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr,"update merchant_bucket set mb_update_timestamp  = sysdate");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	GetField_CString(hMerchantBucket,"posting_date",&csPostDate);
DEBUGLOG(("Update:post_date = [%s]\n",csPostDate));

	GetField_CString(hMerchantBucket,"merchant_id",&csMerchId);
DEBUGLOG(("Update:merchant_id = [%s]\n",csMerchId));

	GetField_CString(hMerchantBucket,"currency_id",&csCcyId);
DEBUGLOG(("Update:txn_ccy = [%s]\n",csCcyId));

	GetField_CString(hMerchantBucket,"service_code",&csServiceCode);
DEBUGLOG(("Update:service_code = [%s]\n",csServiceCode));

	GetField_CString(hMerchantBucket,"country_id",&csCountryId);
DEBUGLOG(("Update:country = [%s]\n",csCountryId));

	GetField_CString(hMerchantBucket,"psp_id",&csPspId);
DEBUGLOG(("Update:psp_id = [%s]\n",csPspId));

	GetField_CString(hMerchantBucket,"bucket_type",&csBucketType);
DEBUGLOG(("Update:bucket_type = [%s]\n",csBucketType));


/* t1_amt*/
	if (GetField_Double(hMerchantBucket,"t1_amt",&dTmp)) {
DEBUGLOG(("Update: t1_released_amt = [%f]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ", mb_t1_released_amt = '");
		strcat((char*)hv_dynstmt.arr, csBuf);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* t2_amt*/
	if (GetField_Double(hMerchantBucket,"t2_amt",&dTmp)) {
DEBUGLOG(("Update: t2_released_amt = [%f]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ", mb_t2_released_amt = '");
		strcat((char*)hv_dynstmt.arr, csBuf);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* t1_date */
	if (GetField_CString(hMerchantBucket,"t1_date",&csTmp)) {
DEBUGLOG(("Update: t1_released_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ", mb_t1_released_date = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* t2_date */
	if (GetField_CString(hMerchantBucket,"t2_date",&csTmp)) {
DEBUGLOG(("Update: t2_released_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ", mb_t2_released_date = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	strcat((char *)hv_dynstmt.arr, " WHERE mb_merchant_id = '");
	strcat((char *)hv_dynstmt.arr, csMerchId);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " and mb_currency_id = '");
	strcat((char *)hv_dynstmt.arr, csCcyId);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " and mb_country_id = '");
	strcat((char *)hv_dynstmt.arr, csCountryId);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " and mb_service_code = '");
	strcat((char *)hv_dynstmt.arr, csServiceCode);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " and mb_posting_date= '");
	strcat((char *)hv_dynstmt.arr, csPostDate);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " and mb_psp_id = '");
	strcat((char *)hv_dynstmt.arr, csPspId);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " and mb_bucket_type = '");
	strcat((char *)hv_dynstmt.arr, csBucketType);
	strcat((char *)hv_dynstmt.arr, "'");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);


DEBUGLOG(("Update Normal Exit\n"));
	return PD_OK;

update_detail_error:
DEBUGLOG(("update_detail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MerchantBucket_Update: SP_INTERNAL_ERR\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_INTERNAL_ERR;
}

