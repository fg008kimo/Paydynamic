/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/11/03              Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sqlca.h>
#include "common.h"
#include "internal.h"
#include "utilitys.h"
#include "dbutility.h"
#include "EmailFunctTemplate.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char	cDebug;

void EmailFunctTemplate(char	cdebug)
{
	cDebug = cdebug;
}


int GetTemplate(hash_t *hRls)
{
	int iRet = FOUND;
	char *csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO gettemplate_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_funct[PD_EML_FUNCT_LEN];
		varchar	v_from[PD_EML_FROM_LEN + 1];
		varchar	v_subject[PD_EML_SUBJECT_LEN + 1];
		varchar	v_template[PD_EML_TEMPLATE_LEN*4 + 1];

		short	ind_from = -1;
		short	ind_subject = -1;
		short	ind_template = -1;

	EXEC SQL END DECLARE SECTION;

	if (GetField_CString(hRls,"funct",&csTmp)) {
		hv_funct.len = strlen(csTmp);
		strncpy((char*)hv_funct.arr, csTmp, hv_funct.len);
DEBUGLOG(("GetTemplate funct = [%.*s]\n", hv_funct.len, hv_funct.arr));
	}

	EXEC SQL
		SELECT	EFT_FROM,
			EFT_SUBJECT,
			ET1.ET_TEMPLATE ||
			ET2.ET_TEMPLATE ||
			ET3.ET_TEMPLATE ||
			ET4.ET_TEMPLATE
		INTO	:v_from:ind_from,
			:v_subject:ind_subject,
			:v_template:ind_template
		FROM	EMAIL_FUNCT_TEMPLATE
		LEFT JOIN EMAIL_TEMPLATE ET1 ON ET1.ET_ID = EFT_HEADER
		LEFT JOIN EMAIL_TEMPLATE ET2 ON ET2.ET_ID = EFT_CSS
		LEFT JOIN EMAIL_TEMPLATE ET3 ON ET3.ET_ID = EFT_BODY
		LEFT JOIN EMAIL_TEMPLATE ET4 ON ET4.ET_ID = EFT_FOOTER
		WHERE	EFT_FUNCT = :hv_funct
		AND	EFT_DISABLED = 0;

	if (ind_from >= 0) {
		v_from.arr[v_from.len]='\0';
		PutField_CString(hRls,"mail_from",(char*)v_from.arr);
DEBUGLOG(("GetTemplate() from = [%s]\n",(char*)v_from.arr));
	} else {
		iRet = NOT_FOUND;
	}
	if (ind_subject >= 0) {
		v_subject.arr[v_subject.len]='\0';
		PutField_CString(hRls,"mail_subject",(char*)v_subject.arr);
DEBUGLOG(("GetTemplate() subject = [%s]\n",(char*)v_subject.arr));
	} else {
		iRet = NOT_FOUND;
	}
	if (ind_template >= 0) {
		v_template.arr[v_template.len]='\0';
		PutField_CString(hRls,"template",(char*)v_template.arr);
DEBUGLOG(("GetTemplate() template = [%s]\n",(char*)v_template.arr));
	} else {
		iRet = NOT_FOUND;
	}

DEBUGLOG(("GetTemplate() Normal Exit iRet = [%d]\n",iRet));
	return iRet;

gettemplate_error:
DEBUGLOG(("gettemplate_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}

