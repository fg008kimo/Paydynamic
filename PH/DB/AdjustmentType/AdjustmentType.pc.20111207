/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/12/06              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "AdjustmentType.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char    cDebug;

void AdjustmentType(char    cdebug)
{
        cDebug = cdebug;
}

int GetMaxCode(const char cPartyType,
		  char *csMaxCode)
{
        int iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO getmaxcode_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		char	hv_party_type;

		varchar v_code[PD_ADJ_TYPE_CODE_LEN + 1];
		short	ind_code;

        EXEC SQL END DECLARE SECTION;

	hv_party_type = cPartyType;
DEBUGLOG(("GetMaxCode party_type = [%c]\n",hv_party_type));

	EXEC SQL DECLARE c_cursor_getmax_code CURSOR FOR
		select max(at_code)
		  from adjustment_type
 		 where at_party_type = :hv_party_type;
	
	EXEC SQL OPEN c_cursor_getmax_code;

	EXEC SQL FETCH c_cursor_getmax_code
	INTO
		:v_code:ind_code;

	if (ind_code >=0) {
                v_code.arr[v_code.len] = '\0';
                memcpy(csMaxCode, (const char*)v_code.arr, v_code.len);
DEBUGLOG(("GetMaxCode code = [%s]\n",csMaxCode));
	}
	else {
DEBUGLOG(("GetMaxCode not found\n"));

	}

	EXEC SQL CLOSE c_cursor_getmax_code;

DEBUGLOG(("GetMaxCode Normal Exit iRet =[%d]\n",iRet));
	return iRet;

getmaxcode_error:
DEBUGLOG(("getmaxcode_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getmax_code;
        return PD_ERR;

}

int Add(const hash_t *hRls)
{
	char  cTmp;
	char  *csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		char		hv_party_type;
		char	 	hv_dc_ind;	
		varchar		hv_desc[PD_ADJ_TYPE_DESC_LEN];
		varchar		hv_code[PD_ADJ_TYPE_CODE_LEN];
		varchar         hv_create_user[PD_USER_LEN];

		short		ind_party_type = -1;
		short		ind_dc_ind = -1;
		short		ind_desc = -1;
		short		ind_code = -1;
		short		ind_create_user = -1;
	
		short		hv_return_value;	
		
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));


	if (GetField_Char(hRls, "party_type", &cTmp)) {	
		hv_party_type = cTmp;
		ind_party_type = 0;
	}
DEBUGLOG(("Add:party_type = [%c]\n",hv_party_type));

	if (GetField_Char(hRls, "dc_ind", &cTmp)) {
		hv_dc_ind = cTmp;
		ind_dc_ind = 0;
	}	
DEBUGLOG(("Add:dc_ind = [%c]\n",hv_dc_ind));

        if(GetField_CString(hRls,"desc",&csTmp)) {
                hv_desc.len = strlen(csTmp);
                strncpy((char*)hv_desc.arr, csTmp, hv_desc.len);
                ind_desc = 0;
        }
DEBUGLOG(("Add:desc = [%s]\n",hv_desc.arr));

        if(GetField_CString(hRls,"code",&csTmp)) {
                hv_code.len = strlen(csTmp);
                strncpy((char*)hv_code.arr, csTmp, hv_code.len);
                ind_code = 0;
        }
DEBUGLOG(("Add:code = [%s]\n",hv_code.arr));

        if(GetField_CString(hRls,"create_user",&csTmp))
        {
                hv_create_user.len = strlen(csTmp);
                strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
        }
DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_adjustment_type_insert(
						:hv_party_type:ind_party_type,
						:hv_code:ind_code,
						:hv_dc_ind:ind_dc_ind,
						:hv_desc:ind_desc,
						:hv_create_user:ind_create_user); 
		END;
	END-EXEC;

        DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
                DEBUGLOG(("Add:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
                ERRLOG("PspDetail_Add: SP_OTHER_ERR TxnAbort\n");
                DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
                ERRLOG("PspDetail_Add: SP_ERR TxnAbort\n");
                DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
                return PD_ERR;
        }


add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("AdjustmentType_Add: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;


}
