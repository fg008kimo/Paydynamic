DROP PACKAGE PHUSER.RULE_TXN_LIMIT_PKG;

CREATE OR REPLACE PACKAGE PHUSER.rule_txn_limit_pkg is
  TYPE RULE_TXN_LIMIT_REF_CURSOR IS REF CURSOR RETURN RULE_TXN_LIMIT_VW%ROWTYPE;
  function Find(
  in_txn_code                   rule_txn_limit.rl_txn_code%type,
  in_country_id                 rule_txn_limit.rl_country_id%Type,
  in_channel_code		rule_txn_limit.rl_channel_code%type,
  in_service_code		rule_txn_limit.rl_service_code%type,
  in_pay_method			rule_txn_limit.rl_pay_method%type,
  in_currency_id                rule_txn_limit.rl_currency_id%type,
  in_party_id                   rule_txn_limit.rl_party_id%type,
  in_party_client_id            rule_txn_limit.rl_party_id%type,
  out_cursor                OUT RULE_TXN_LIMIT_REF_CURSOR

    )
    return number;

end rule_txn_limit_pkg;
/
DROP PACKAGE BODY PHUSER.RULE_TXN_LIMIT_PKG;

CREATE OR REPLACE PACKAGE BODY PHUSER.RULE_TXN_LIMIT_PKG is
 function Find(
  in_txn_code                   rule_txn_limit.rl_txn_code%type,
  in_country_id                 rule_txn_limit.rl_country_id%Type,
  in_channel_code		rule_txn_limit.rl_channel_code%type,
  in_service_code		rule_txn_limit.rl_service_code%type,
  in_pay_method			rule_txn_limit.rl_pay_method%type,
  in_currency_id                rule_txn_limit.rl_currency_id%type,
  in_party_id                   rule_txn_limit.rl_party_id%type,
  in_party_client_id            rule_txn_limit.rl_party_id%type,
  out_cursor                OUT RULE_TXN_LIMIT_REF_CURSOR
    )
    return number is
  iCnt integer := 0;
  begin
    select count(*)
          into iCnt
        from rule_txn_limit
       where rl_txn_code = in_txn_code
         and rl_country_id = in_country_id
         and rl_channel_code = in_channel_code
	 and rl_service_code = in_service_code
	 and rl_pay_method = in_pay_method
         and rl_currency_id = in_currency_id
         and rl_party_type = 'M'
         and rl_party_id = in_party_id
	 and rl_disabled = 0;

        if iCnt > 0 then
                open out_cursor FOR
                select rl_min_value,rl_max_value
                  from rule_txn_limit
                 where rl_txn_code = in_txn_code
                   and rl_country_id = in_country_id
         	   and rl_channel_code = in_channel_code
	           and rl_service_code = in_service_code
	           and rl_pay_method = in_pay_method
                   and rl_currency_id = in_currency_id
                   and rl_party_type = 'M'
                   and rl_party_id = in_party_id
	 	   and rl_disabled = 0;
		return 1;
	else
    		select count(*)
          	  into iCnt
                  from rule_txn_limit
                 where rl_txn_code = in_txn_code
                   and rl_country_id = in_country_id
         	   and rl_channel_code = in_channel_code
	           and rl_service_code = in_service_code
	           and rl_pay_method = in_pay_method
                   and rl_currency_id = in_currency_id
                   and rl_party_type = 'C'
                   and rl_party_id = in_party_client_id
                   and rl_disabled = 0;
        
                if iCnt > 0 then
                	open out_cursor FOR
                	select rl_min_value,rl_max_value
                  	  from rule_txn_limit
                 	 where rl_txn_code = in_txn_code
                   	   and rl_country_id = in_country_id
         	   	   and rl_channel_code = in_channel_code
	                   and rl_service_code = in_service_code
	                   and rl_pay_method = in_pay_method
                   	   and rl_currency_id = in_currency_id
                   	   and rl_party_type = 'C'
                   	   and rl_party_id = in_party_client_id
                   	   and rl_disabled = 0;
                	return 1;
        	else    
			select count(*)
                  	  into iCnt
                  	  from rule_txn_limit
                 	 where rl_txn_code = in_txn_code
                   	   and rl_country_id = in_country_id
         	   	   and rl_channel_code = in_channel_code
	                   and rl_service_code = in_service_code
	                   and rl_pay_method = in_pay_method
                   	   and rl_currency_id = in_currency_id
                   	   and rl_party_type = 'G'
                   	   and rl_disabled = 0;

                	if iCnt > 0 then
                        	open out_cursor FOR
                        	select rl_min_value,rl_max_value
                          	  from rule_txn_limit
                         	 where rl_txn_code = in_txn_code
                           	  and rl_country_id = in_country_id
         	   	          and rl_channel_code = in_channel_code
	                          and rl_service_code = in_service_code
	                          and rl_pay_method = in_pay_method
                           	  and rl_currency_id = in_currency_id
                           	  and rl_party_type = 'G'
                           	  and rl_disabled = 0;
                        	return 1;
                	else
                        	return 0;
                	end if;
        	end if;
        end if;

 exception
   WHEN OTHERS THEN
     RETURN 0;


  end;


end RULE_TXN_LIMIT_PKG;
/


