/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/26              Stan Poon
Add biz, non-biz                                   2013/10/24              David Wong
Add first day after non-biz                        2013/11/05              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLRuleDepositMatching.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char cDebug;


void OLRuleDepositMatching(char cdebug)
{
	cDebug = cdebug;
}

int GetRuleDepositMatchingByDate(const char* csMerchantId,
				const char* csIntBankCode,
				const char* csCountry,
				const char* csDate,
				hash_t* hRec)
{
	int iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO getruledepositmatchingbydate_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		char hv_return_value;

		varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar hv_country[PD_COUNTRY_LEN];
		varchar hv_curr_date[PD_DATE_LEN];
		varchar hv_prev_date[PD_DATE_LEN];
		int v_onus_bf_mins;
		int v_onus_af_mins;
		int v_offus_bf_mins;
		int v_offus_af_mins;

		short ind_merchant_id = -1;
		short ind_int_bank_code = -1;
		short ind_country = -1;
		short ind_curr_date = -1;
		short ind_prev_date = -1;
		short ind_onus_bf_mins = -1;
		short ind_onus_af_mins = -1;
		short ind_offus_bf_mins = -1;
		short ind_offus_af_mins = -1;
	EXEC SQL END DECLARE SECTION;

	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char*)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetRuleDepositMatchingByDate merchant_id = [%.*s]\n", hv_merchant_id.len, hv_merchant_id.arr));

	hv_int_bank_code.len = strlen(csIntBankCode);
	strncpy((char*)hv_int_bank_code.arr, csIntBankCode, hv_int_bank_code.len);
	ind_int_bank_code = 0;
DEBUGLOG(("GetRuleDepositMatchingByDate int_bank_code = [%.*s]\n", hv_int_bank_code.len, hv_int_bank_code.arr));

	hv_country.len = strlen(csCountry);
	strncpy((char*)hv_country.arr, csCountry, hv_country.len);
	ind_country = 0;
DEBUGLOG(("GetRuleDepositMatchingByDate country = [%.*s]\n", hv_country.len, hv_country.arr));

	hv_curr_date.len = strlen(csDate);
	strncpy((char*)hv_curr_date.arr, csDate, hv_curr_date.len);
	ind_curr_date = 0;
DEBUGLOG(("GetRuleDepositMatchingByDate date = [%.*s]\n", hv_curr_date.len, hv_curr_date.arr));

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := merchant_auto_settlement_pkg.is_holiday_by_country(
						:hv_curr_date:ind_curr_date,
						:hv_country:ind_country);
		END;
	END-EXEC;

	if (hv_return_value == 'Y') {
		// non_biz
		EXEC SQL
			SELECT	ORDM_NON_BIZ_ONUS_BF_MINS,
				ORDM_NON_BIZ_ONUS_AF_MINS,
				ORDM_NON_BIZ_OFFUS_BF_MINS,
				ORDM_NON_BIZ_OFFUS_AF_MINS
			INTO	:v_onus_bf_mins:ind_onus_bf_mins,
				:v_onus_af_mins:ind_onus_af_mins,
				:v_offus_bf_mins:ind_offus_bf_mins,
				:v_offus_af_mins:ind_offus_af_mins
			FROM	OL_RULE_DEPOSIT_MATCHING
			WHERE	ORDM_MERCHANT_ID = :hv_merchant_id:ind_merchant_id
			AND	ORDM_INT_BANK_CODE = :hv_int_bank_code:ind_int_bank_code;
	} else {
		EXEC SQL
			SELECT	to_char(to_date(:hv_curr_date:ind_curr_date, 'yyyymmdd') - 1, 'yyyymmdd')
			INTO	:hv_prev_date:ind_prev_date
			FROM	dual;

		EXEC SQL EXECUTE
			BEGIN
				:hv_return_value := merchant_auto_settlement_pkg.is_holiday_by_country(
							:hv_prev_date:ind_prev_date,
							:hv_country:ind_country);
			END;
		END-EXEC;

		if (hv_return_value == 'Y') {
			// af_non_biz
			EXEC SQL
				SELECT	ORDM_AF_NON_BIZ_ONUS_BF_MINS,
					ORDM_AF_NON_BIZ_ONUS_AF_MINS,
					ORDM_AF_NON_BIZ_OFFUS_BF_MINS,
					ORDM_AF_NON_BIZ_OFFUS_AF_MINS
				INTO	:v_onus_bf_mins:ind_onus_bf_mins,
					:v_onus_af_mins:ind_onus_af_mins,
					:v_offus_bf_mins:ind_offus_bf_mins,
					:v_offus_af_mins:ind_offus_af_mins
				FROM	OL_RULE_DEPOSIT_MATCHING
				WHERE	ORDM_MERCHANT_ID = :hv_merchant_id:ind_merchant_id
				AND	ORDM_INT_BANK_CODE = :hv_int_bank_code:ind_int_bank_code;
		} else {
			// biz
			EXEC SQL
				SELECT	ORDM_BIZ_ONUS_BF_MINS,
					ORDM_BIZ_ONUS_AF_MINS,
					ORDM_BIZ_OFFUS_BF_MINS,
					ORDM_BIZ_OFFUS_AF_MINS
				INTO	:v_onus_bf_mins:ind_onus_bf_mins,
					:v_onus_af_mins:ind_onus_af_mins,
					:v_offus_bf_mins:ind_offus_bf_mins,
					:v_offus_af_mins:ind_offus_af_mins
				FROM	OL_RULE_DEPOSIT_MATCHING
				WHERE	ORDM_MERCHANT_ID = :hv_merchant_id:ind_merchant_id
				AND	ORDM_INT_BANK_CODE = :hv_int_bank_code:ind_int_bank_code;
		}
	}

	if (ind_onus_bf_mins >= 0 && ind_onus_af_mins >= 0 && ind_offus_bf_mins >= 0 && ind_offus_af_mins >= 0) {
		PutField_Int(hRec, "onus_bf_mins", v_onus_bf_mins);
DEBUGLOG(("GetRuleDepositMatchingByDate onus_bf_mins = [%d]\n", v_onus_bf_mins));
		PutField_Int(hRec, "onus_af_mins", v_onus_af_mins);
DEBUGLOG(("GetRuleDepositMatchingByDate onus_af_mins = [%d]\n", v_onus_af_mins));
		PutField_Int(hRec, "offus_bf_mins", v_offus_bf_mins);
DEBUGLOG(("GetRuleDepositMatchingByDate offus_bf_mins = [%d]\n", v_offus_bf_mins));
		PutField_Int(hRec, "offus_af_mins", v_offus_af_mins);
DEBUGLOG(("GetRuleDepositMatchingByDate offus_af_mins = [%d]\n", v_offus_af_mins));
	} else {
		iRet = PD_ERR;
	}

DEBUGLOG(("GetRuleDepositMatchingByDate Exit iRet = [%d]\n", iRet));
	return iRet;

getruledepositmatchingbydate_error:
DEBUGLOG(("getruledepositmatchingbydate_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}


/*
int GetRuleDepositMatching(const char* csMerchantId,
			const char* csIntBankCode,
			hash_t* hRec)
{
	int iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO getruledepositmatching_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar hv_int_bank_code[PD_BANK_CODE_LEN];
		int v_biz_onus_bf_mins;
		int v_biz_onus_af_mins;
		int v_biz_offus_bf_mins;
		int v_biz_offus_af_mins;
		int v_non_biz_onus_bf_mins;
		int v_non_biz_onus_af_mins;
		int v_non_biz_offus_bf_mins;
		int v_non_biz_offus_af_mins;
		int v_af_non_biz_onus_bf_mins;
		int v_af_non_biz_onus_af_mins;
		int v_af_non_biz_offus_bf_mins;
		int v_af_non_biz_offus_af_mins;

		short ind_merchant_id = -1;
		short ind_int_bank_code = -1;
		short ind_biz_onus_bf_mins = -1;
		short ind_biz_onus_af_mins = -1;
		short ind_biz_offus_bf_mins = -1;
		short ind_biz_offus_af_mins = -1;
		short ind_non_biz_onus_bf_mins = -1;
		short ind_non_biz_onus_af_mins = -1;
		short ind_non_biz_offus_bf_mins = -1;
		short ind_non_biz_offus_af_mins = -1;
		short ind_af_non_biz_onus_bf_mins = -1;
		short ind_af_non_biz_onus_af_mins = -1;
		short ind_af_non_biz_offus_bf_mins = -1;
		short ind_af_non_biz_offus_af_mins = -1;
	EXEC SQL END DECLARE SECTION;

	hv_merchant_id.len = strlen(csMerchantId);
	strncpy((char*)hv_merchant_id.arr, csMerchantId, hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetRuleDepositMatching merchant_id = [%.*s]\n", hv_merchant_id.len, hv_merchant_id.arr));

	hv_int_bank_code.len = strlen(csIntBankCode);
	strncpy((char*)hv_int_bank_code.arr, csIntBankCode, hv_int_bank_code.len);
	ind_int_bank_code = 0;
DEBUGLOG(("GetRuleDepositMatching int_bank_code = [%.*s]\n", hv_int_bank_code.len, hv_int_bank_code.arr));

	EXEC SQL
		SELECT	ORDM_BIZ_ONUS_BF_MINS,
			ORDM_BIZ_ONUS_AF_MINS,
			ORDM_BIZ_OFFUS_BF_MINS,
			ORDM_BIZ_OFFUS_AF_MINS,
			ORDM_NON_BIZ_ONUS_BF_MINS,
			ORDM_NON_BIZ_ONUS_AF_MINS,
			ORDM_NON_BIZ_OFFUS_BF_MINS,
			ORDM_NON_BIZ_OFFUS_AF_MINS,
			ORDM_AF_NON_BIZ_ONUS_BF_MINS,
			ORDM_AF_NON_BIZ_ONUS_AF_MINS,
			ORDM_AF_NON_BIZ_OFFUS_BF_MINS,
			ORDM_AF_NON_BIZ_OFFUS_AF_MINS
		INTO	:v_biz_onus_bf_mins:ind_biz_onus_bf_mins,
			:v_biz_onus_af_mins:ind_biz_onus_af_mins,
			:v_biz_offus_bf_mins:ind_biz_offus_bf_mins,
			:v_biz_offus_af_mins:ind_biz_offus_af_mins,
			:v_non_biz_onus_bf_mins:ind_non_biz_onus_bf_mins,
			:v_non_biz_onus_af_mins:ind_non_biz_onus_af_mins,
			:v_non_biz_offus_bf_mins:ind_non_biz_offus_bf_mins,
			:v_non_biz_offus_af_mins:ind_non_biz_offus_af_mins,
			:v_af_non_biz_onus_bf_mins:ind_af_non_biz_onus_bf_mins,
			:v_af_non_biz_onus_af_mins:ind_af_non_biz_onus_af_mins,
			:v_af_non_biz_offus_bf_mins:ind_af_non_biz_offus_bf_mins,
			:v_af_non_biz_offus_af_mins:ind_af_non_biz_offus_af_mins
		FROM	OL_RULE_DEPOSIT_MATCHING
		WHERE	ORDM_MERCHANT_ID = :hv_merchant_id:ind_merchant_id
		AND	ORDM_INT_BANK_CODE = :hv_int_bank_code:ind_int_bank_code;

	if (ind_biz_onus_bf_mins >= 0) {
		PutField_Int(hRec, "biz_onus_bf_mins", v_biz_onus_bf_mins);
DEBUGLOG(("GetRuleDepositMatching biz_onus_bf_mins = [%d]\n", v_biz_onus_bf_mins));
	} else {
		iRet = PD_ERR;
	}

	if (ind_biz_onus_af_mins >= 0) {
		PutField_Int(hRec, "biz_onus_af_mins", v_biz_onus_af_mins);
DEBUGLOG(("GetRuleDepositMatching biz_onus_af_mins = [%d]\n", v_biz_onus_af_mins));
	} else {
		iRet = PD_ERR;
	}

	if (ind_biz_offus_bf_mins >= 0) {
		PutField_Int(hRec, "biz_offus_bf_mins", v_biz_offus_bf_mins);
DEBUGLOG(("GetRuleDepositMatching biz_offus_bf_mins = [%d]\n", v_biz_offus_bf_mins));
	} else {
		iRet = PD_ERR;
	}

	if (ind_biz_offus_af_mins >= 0) {
		PutField_Int(hRec, "biz_offus_af_mins", v_biz_offus_af_mins);
DEBUGLOG(("GetRuleDepositMatching biz_offus_af_mins = [%d]\n", v_biz_offus_af_mins));
	} else {
		iRet = PD_ERR;
	}

	if (ind_non_biz_onus_bf_mins >= 0) {
		PutField_Int(hRec, "non_biz_onus_bf_mins", v_non_biz_onus_bf_mins);
DEBUGLOG(("GetRuleDepositMatching non_biz_onus_bf_mins = [%d]\n", v_non_biz_onus_bf_mins));
	} else {
		iRet = PD_ERR;
	}

	if (ind_non_biz_onus_af_mins >= 0) {
		PutField_Int(hRec, "non_biz_onus_af_mins", v_non_biz_onus_af_mins);
DEBUGLOG(("GetRuleDepositMatching non_biz_onus_af_mins = [%d]\n", v_non_biz_onus_af_mins));
	} else {
		iRet = PD_ERR;
	}

	if (ind_non_biz_offus_bf_mins >= 0) {
		PutField_Int(hRec, "non_biz_offus_bf_mins", v_non_biz_offus_bf_mins);
DEBUGLOG(("GetRuleDepositMatching non_biz_offus_bf_mins = [%d]\n", v_non_biz_offus_bf_mins));
	} else {
		iRet = PD_ERR;
	}

	if (ind_non_biz_offus_af_mins >= 0) {
		PutField_Int(hRec, "non_biz_offus_af_mins", v_non_biz_offus_af_mins);
DEBUGLOG(("GetRuleDepositMatching non_biz_offus_af_mins = [%d]\n", v_non_biz_offus_af_mins));
	} else {
		iRet = PD_ERR;
	}

	if (ind_af_non_biz_onus_bf_mins >= 0) {
		PutField_Int(hRec, "af_non_biz_onus_bf_mins", v_af_non_biz_onus_bf_mins);
DEBUGLOG(("GetRuleDepositMatching af_non_biz_onus_bf_mins = [%d]\n", v_af_non_biz_onus_bf_mins));
	} else {
		iRet = PD_ERR;
	}

	if (ind_af_non_biz_onus_af_mins >= 0) {
		PutField_Int(hRec, "af_non_biz_onus_af_mins", v_af_non_biz_onus_af_mins);
DEBUGLOG(("GetRuleDepositMatching af_non_biz_onus_af_mins = [%d]\n", v_af_non_biz_onus_af_mins));
	} else {
		iRet = PD_ERR;
	}

	if (ind_af_non_biz_offus_bf_mins >= 0) {
		PutField_Int(hRec, "af_non_biz_offus_bf_mins", v_af_non_biz_offus_bf_mins);
DEBUGLOG(("GetRuleDepositMatching af_non_biz_offus_bf_mins = [%d]\n", v_af_non_biz_offus_bf_mins));
	} else {
		iRet = PD_ERR;
	}

	if (ind_af_non_biz_offus_af_mins >= 0) {
		PutField_Int(hRec, "af_non_biz_offus_af_mins", v_af_non_biz_offus_af_mins);
DEBUGLOG(("GetRuleDepositMatching af_non_biz_offus_af_mins = [%d]\n", v_af_non_biz_offus_af_mins));
	} else {
		iRet = PD_ERR;
	}

DEBUGLOG(("GetRuleDepositMatching Exit iRet = [%d]\n", iRet));
	return iRet;

getruledepositmatching_error:
DEBUGLOG(("getruledepositmatching_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}
*/

