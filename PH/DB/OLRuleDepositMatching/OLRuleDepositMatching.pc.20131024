/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/26              Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLRuleDepositMatching.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char	cDebug;

void OLRuleDepositMatching(char	cdebug)
{
	cDebug = cdebug;
}


int GetRuleDepositMatching(const char* csIntBankCode,
			int* iBFMins,
			int* iAFMins,
			int* iOFFBFMins,
			int* iOFFAFMins)
{
        int iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO getacctccy_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar	hv_int_bank_code[PD_BANK_CODE_LEN];
		int	v_bf_mins;
		int	v_af_mins;
		int	v_off_bf_mins;
		int	v_off_af_mins;

		short	ind_int_bank_code = -1;
		short	ind_bf_mins = -1;
		short	ind_af_mins = -1;
		short	ind_off_bf_mins = -1;
		short	ind_off_af_mins = -1;

        EXEC SQL END DECLARE SECTION;

	hv_int_bank_code.len = strlen(csIntBankCode);
	strncpy((char*)hv_int_bank_code.arr,csIntBankCode,hv_int_bank_code.len);
	ind_int_bank_code = 0;
DEBUGLOG(("GetRuleDepositMatching int_bank_code = [%.*s]\n",hv_int_bank_code.len,hv_int_bank_code.arr));

	EXEC SQL	SELECT	ORDM_BF_MINS,
				ORDM_AF_MINS,
				ORDM_OFFUS_BF_MINS,
				ORDM_OFFUS_AF_MINS
			INTO	:v_bf_mins:ind_bf_mins,
				:v_af_mins:ind_af_mins,
				:v_off_bf_mins:ind_off_bf_mins,
				:v_off_af_mins:ind_off_af_mins
			FROM	OL_RULE_DEPOSIT_MATCHING
			WHERE	ORDM_INT_BANK_CODE = :hv_int_bank_code:ind_int_bank_code;

	if (ind_bf_mins>=0) {
		*iBFMins = v_bf_mins;
DEBUGLOG(("GetRuleDepositMatching bf_mins = [%d]\n",iBFMins));
	} else {
		iRet = PD_ERR;
	}

	if (ind_af_mins>=0) {
		*iAFMins = v_af_mins;
DEBUGLOG(("GetRuleDepositMatching af_mins = [%d]\n",iAFMins));
	} else {
		iRet = PD_ERR;
	}

	if (ind_off_bf_mins>=0) {
		*iOFFBFMins = v_off_bf_mins;
DEBUGLOG(("GetRuleDepositMatching off_bf_mins = [%d]\n",iBFMins));
	} else {
		iRet = PD_ERR;
	}

	if (ind_off_af_mins>=0) {
		*iOFFAFMins = v_off_af_mins;
DEBUGLOG(("GetRuleDepositMatching off_af_mins = [%d]\n",iAFMins));
	} else {
		iRet = PD_ERR;
	}

DEBUGLOG(("GetRuleDepositMatching Exit iRet = [%d]\n",iRet));
	return iRet;

getacctccy_error:
DEBUGLOG(("getacctccy_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

