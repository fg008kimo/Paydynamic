/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/08/22              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "MerchantUploadFileDetail.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void MerchantUploadFileDetail(char    cdebug)
{
        cDebug = cdebug;
}


int UpdateDetailByBatchId(const char* csBatchId, const int iSeqNum, const hash_t *hRls)
{
	char*   csBuf;
	char*	csRespCode;
	char*	csSeqNum;
	double	dTmp;
	char	cTmp;
	int	iTmp;

	EXEC SQL WHENEVER SQLERROR GOTO updatedetailbybatch_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_dynstmt[1024];

	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateDetailByBatchId: Begin\n"));
        csBuf = (char*) malloc (128);
        strcpy((char*)hv_dynstmt.arr,"update merchant_upload_file_detail set ud_update_timestamp = sysdate ");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        
DEBUGLOG(("UpdateDetailByBatchId:batch_id = [%s]\n",csBatchId));

        csSeqNum = (char*) malloc (128);
	sprintf(csSeqNum,"%d",iSeqNum);
DEBUGLOG(("UpdateDetailByBatchId:seq_num = [%s]\n",csSeqNum));

        if(GetField_Double(hRls,"payout_amt",&dTmp)){
DEBUGLOG(("UpdateDetailByBatchId: payout_amt = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",ud_payout_amount =");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_Double(hRls,"member_fee",&dTmp)){
DEBUGLOG(("UpdateDetailByBatchId: member_fee = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",ud_member_fee =");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"txn_country",&csBuf)){
DEBUGLOG(("UpdateDetailByBatchId: txn_country = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_country = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"bank_code",&csBuf)){
DEBUGLOG(("UpdateDetailByBatchId: bank_code = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_bank_code = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"psp_id",&csBuf)){
DEBUGLOG(("UpdateDetailByBatchId: psp_id = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_psp_id = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


        if(GetField_CString(hRls,"member_fee_ccy",&csBuf)){
DEBUGLOG(("UpdateDetailByBatchId: member_fee_ccy = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_member_fee_ccy= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_Double(hRls,"merchant_fee",&dTmp)){
DEBUGLOG(("UpdateDetailByBatchId: merchant_fee = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",ud_merchant_fee =");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"merchant_fee_ccy",&csBuf)){
DEBUGLOG(("UpdateDetailByBatchId: merchant_fee_ccy = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_merchant_fee_ccy= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_Double(hRls,"markup_amt",&dTmp)){
DEBUGLOG(("UpdateDetailByBatchId: markup_amt = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",ud_markup_amt =");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"markup_ccy",&csBuf)){
DEBUGLOG(("UpdateDetailByBatchId: markup_ccy = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_markup_ccy= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_Double(hRls,"ex_rate",&dTmp)){
DEBUGLOG(("UpdateDetailByBatchId: ex_rate = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",ud_exchange_rate =");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_Char(hRls,"batch_mode",&cTmp)){
DEBUGLOG(("UpdateDetailByBatchId: batch_mode = [%c]\n",cTmp));
                sprintf(csBuf,"%c",cTmp);
                strcat((char*)hv_dynstmt.arr, ",ud_batch_mode = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        
        if(GetField_Int(hRls,"status",&iTmp)){
DEBUGLOG(("UpdateDetailByBatchId: status = [%d]\n",iTmp));
                sprintf(csBuf,"%d",iTmp);
                strcat((char*)hv_dynstmt.arr, ",ud_status = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        
        if(GetField_CString(hRls,"resp_code",&csRespCode)){
DEBUGLOG(("UpdateDetailByBatchId: resp_code = [%s]\n",csRespCode));
                strcat((char*)hv_dynstmt.arr, ",ud_response_code = '");
                strcat((char*)hv_dynstmt.arr, csRespCode);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"remark",&csBuf)){
DEBUGLOG(("UpdateDetailByBatchId: remark = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_remark= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"txn_seq",&csBuf)){
DEBUGLOG(("UpdateDetailByBatchId: txn_id = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_txn_id= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"psp_batch_id",&csBuf)){
DEBUGLOG(("UpdateDetailByBatchId: psp_batch_id = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_psp_batch_id= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"fundout_date",&csBuf)){
DEBUGLOG(("UpdateDetailByBatchId: fundout_date = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_fundout_date= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_Double(hRls,"service_fee",&dTmp)){
DEBUGLOG(("UpdateDetailByBatchId: service_fee = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",ud_service_fee=");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


        if(GetField_CString(hRls,"generated_file_name",&csBuf)){
DEBUGLOG(("UpdateDetailByBatchId: generated_file_name = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_generated_file_name= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


        if(GetField_CString(hRls,"update_user",&csBuf)){
DEBUGLOG(("UpdateDetailByBatchId: update_user = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_update_user= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        strcat((char*)hv_dynstmt.arr, " WHERE ud_batch_id = ");
        strcat((char*)hv_dynstmt.arr, csBatchId);
        strcat((char*)hv_dynstmt.arr, " AND ud_seq_num = ");
        strcat((char*)hv_dynstmt.arr, csSeqNum);
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);
	FREE_ME(csSeqNum);

DEBUGLOG(("UpdateDetailByBatchId Normal Exit\n"));
        return PD_OK;

updatedetailbybatch_error:
DEBUGLOG(("updatedetailbybatch_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MerchantUploadFileDetail_UpdateDetailByBatchId: SP_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_INTERNAL_ERR;
}

int UpdateDetailByTxnId(const char* csTxnId, const hash_t *hRls)
{
	char*   csBuf;
	char*	csRespCode;
	double	dTmp;
	int	iTmp;

	EXEC SQL WHENEVER SQLERROR GOTO updatedetailbytxn_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_dynstmt[1024];

	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateDetailByTxnId: Begin\n"));
        csBuf = (char*) malloc (128);
        strcpy((char*)hv_dynstmt.arr,"update merchant_upload_file_detail set ud_update_timestamp = sysdate ");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        
DEBUGLOG(("UpdateDetailByTxnId:txn_id = [%s]\n",csTxnId));
        
        if(GetField_CString(hRls,"psp_id",&csBuf)){
DEBUGLOG(("UpdateDetailByTxnId: psp_id = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_psp_id = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"aux_txn_seq",&csBuf)){
DEBUGLOG(("UpdateDetailByTxnId: aux_txn_seq = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_aux_txn_id= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"member_fee_ccy",&csBuf)){
DEBUGLOG(("UpdateDetailByTxnId: member_fee_ccy = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_member_fee_ccy= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
	
	if (GetField_Double(hRls,"member_fee",&dTmp)) {
DEBUGLOG(("UpdateDetailByTxnId:member_fee = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",ud_member_fee = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"merchant_fee_ccy",&csBuf)){
DEBUGLOG(("UpdateDetailByTxnId: merchant_fee_ccy = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_merchant_fee_ccy= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

	if (GetField_Double(hRls,"merchant_fee",&dTmp)) {
DEBUGLOG(("UpdateDetailByTxnId:merchant_fee = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",ud_merchant_fee = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"markup_ccy",&csBuf)){
DEBUGLOG(("UpdateDetailByTxnId: markup_ccy = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_markup_ccy= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

	if (GetField_Double(hRls,"markup_amt",&dTmp)) {
DEBUGLOG(("UpdateDetailByTxnId:markup_amt = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",ud_markup_amt = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

	if (GetField_Double(hRls,"ex_rate",&dTmp)) {
DEBUGLOG(("UpdateDetailByTxnId:ex_rate = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",ud_exchange_rate = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


        if(GetField_CString(hRls,"payout_txn_num",&csBuf)){
DEBUGLOG(("UpdateDetailByTxnId: payout_txn_num = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_payout_txn_num= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_Int(hRls,"status",&iTmp)){
DEBUGLOG(("UpdateDetailByTxnId: status = [%d]\n",iTmp));
                sprintf(csBuf,"%d",iTmp);
                strcat((char*)hv_dynstmt.arr, ",ud_status = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        
        if(GetField_CString(hRls,"resp_code",&csRespCode)){
DEBUGLOG(("UpdateDetailByTxnId: resp_code = [%s]\n",csRespCode));
                strcat((char*)hv_dynstmt.arr, ",ud_response_code = '");
                strcat((char*)hv_dynstmt.arr, csRespCode);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"remark",&csBuf)){
DEBUGLOG(("UpdateDetailByTxnId: remark = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_remark= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"psp_batch_id",&csBuf)){
DEBUGLOG(("UpdateDetailByTxnId: psp_batch_id = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_psp_batch_id= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"tid",&csBuf)){
DEBUGLOG(("UpdateDetailByTxnId: tid = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_tid= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"fundout_date",&csBuf)){
DEBUGLOG(("UpdateDetailByTxnId: fundout_date = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_fundout_date= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_Double(hRls,"service_fee",&dTmp)){
DEBUGLOG(("UpdateDetailByTxnId: service_fee = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",ud_service_fee=");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        if(GetField_CString(hRls,"update_user",&csBuf)){
DEBUGLOG(("UpdateDetailByTxnId: update_user = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_update_user= '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        strcat((char*)hv_dynstmt.arr, " WHERE ud_txn_id = '");
        strcat((char*)hv_dynstmt.arr, csTxnId);
        strcat((char*)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);

DEBUGLOG(("UpdateDetailByTxnId Normal Exit\n"));
        return PD_OK;

updatedetailbytxn_error:
DEBUGLOG(("updatedetailbytxn_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MerchantUploadFileDetail_UpdateDetailByTxnId: SP_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_INTERNAL_ERR;
}


int GetDetail(const unsigned long lBatchId, recordset_t* myRec)
{
	hash_t *myHash;
	EXEC SQL WHENEVER SQLERROR GOTO getpayout_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		unsigned long	hv_batch_id;
		int		hv_disabled;
		//varchar		hv_batch_id[PD_TXN_SEQ_LEN];

		int	        v_seq_num;
		varchar		v_txn_id[PD_TXN_SEQ_LEN+1];
		varchar		v_aux_txn_seq[PD_TXN_SEQ_LEN+1];
		varchar         v_merchant_ref[PD_MERCHANT_REF_LEN+1];
		varchar		v_country[PD_COUNTRY_LEN+1];
		varchar         v_identity_id[PD_IDENTITY_ID_LEN+1];
		varchar         v_account_num[PD_AC_NO_LEN+1];
		varchar         v_account_name[PD_ACC_NAME_LEN+1];
		varchar         v_bank_name[PD_BANK_NAME_LEN+1];
		varchar         v_bank_code[PD_BANK_CODE_LEN+1];
		varchar         v_branch[PD_BANK_BRANCH_LEN+1];
		varchar		v_phone_num[PD_MOBILE_NO_LEN+1];
		varchar         v_province[PD_PROVINCE_LEN+1];
		varchar		v_city[PD_CITY_LEN+1];
		varchar		v_payout_ccy[PD_CCY_ID_LEN+1];
		varchar		v_request_ccy[PD_CCY_ID_LEN+1];
		varchar		v_member_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_merchant_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_markup_ccy[PD_CCY_ID_LEN+1];
		double		v_payout_amount;
		double		v_request_amount;
		double		v_member_fee;
		double		v_merchant_fee;
		double		v_markup_amt;
		double		v_ex_rate;
		varchar		v_resp_code[PD_RESPONSE_CODE_LEN+1];
		int		v_status;
		varchar		v_remark[PD_REMARK_LEN+1];
		char		v_batch_mode;
		varchar		v_file_name[PD_FILENAME_LEN+1];
		varchar		v_psp_batch_id[PD_BATCH_LEN+1];
		varchar		v_fundout_date[PD_DATETIME_LEN+1];
		varchar		v_psp_id[PD_PSP_ID_LEN+1];
		double		v_service_fee;


		short           ind_seq_num = -1;
		short           ind_txn_id = -1;
		short           ind_aux_txn_seq = -1;
		short           ind_merchant_ref = -1;
		short		ind_country = -1;
		short		ind_identity_id = -1;
		short           ind_account_num = -1;
		short           ind_account_name = -1;
		short           ind_bank_name = -1;
		short           ind_bank_code = -1;
		short		ind_branch = -1;
		short           ind_phone_num = -1;
		short		ind_province = -1;
		short		ind_city = -1;
		short		ind_payout_ccy = -1;
		short		ind_request_ccy = -1;
		short		ind_status = -1;
		short           ind_member_fee_ccy = -1;
		short           ind_merchant_fee_ccy = -1;
		short           ind_markup_ccy = -1;
		short           ind_payout_amount = -1;
		short           ind_request_amount = -1;
		short           ind_member_fee = -1;
		short		ind_merchant_fee = -1;
		short           ind_markup_amt = -1;
		short		ind_ex_rate = -1;
		short		ind_resp_code = -1;
		short           ind_remark = -1;
		short		ind_batch_mode = -1;
		short           ind_file_name = -1;
		short           ind_psp_batch_id = -1;
		short           ind_psp_id = -1;
		short           ind_fundout_date = -1;
		short           ind_service_fee = -1;

	EXEC SQL END DECLARE SECTION;

	hv_batch_id = lBatchId;
DEBUGLOG(("GetDetail batch_id = [%ld]\n",hv_batch_id));

	hv_disabled = 0;

/*	hv_batch_id.len = strlen(iBatchId);
	memcpy(hv_batch_id.arr,iBatchId,hv_batch_id.len);
DEBUGLOG(("GetDetail batch_id = [%s]\n",hv_batch_id.arr));
*/

	EXEC SQL DECLARE c_cursor_getpayout CURSOR FOR
		select	ud_seq_num,
			ud_txn_id,
			ud_aux_txn_id,
			ud_merchant_ref,
			ud_country,
			ud_identity_id,
			ud_account_num,
			ud_account_name,
			ud_bank_name,
			ud_bank_code,
			ud_branch,
			ud_phone_num,
			ud_province,
			ud_city,
			ud_payout_amount,
			ud_request_amount,
			ud_payout_currency,
			ud_request_currency,
			ud_member_fee_ccy,
			ud_member_fee,
			ud_merchant_fee_ccy,
			ud_merchant_fee,
			ud_markup_ccy,
			ud_markup_amt,
			ud_exchange_rate,
			ud_status,
			ud_response_code,
			ud_remark,
			ud_batch_mode,
			ud_generated_file_name,
			ud_psp_batch_id,
			ud_fundout_date,
			ud_service_fee,
			ud_psp_id
		from	merchant_upload_file_detail
		where	ud_batch_id =:hv_batch_id
		and	ud_disabled = :hv_disabled
		order by ud_seq_num;

	EXEC SQL OPEN  c_cursor_getpayout;
	do{
		EXEC SQL FETCH c_cursor_getpayout
		INTO
			:v_seq_num:ind_seq_num,
			:v_txn_id:ind_txn_id,
			:v_aux_txn_seq:ind_aux_txn_seq,
			:v_merchant_ref:ind_merchant_ref,
			:v_country:ind_country,
			:v_identity_id:ind_identity_id,
			:v_account_num:ind_account_num,
			:v_account_name:ind_account_name,
			:v_bank_name:ind_bank_name,
			:v_bank_code:ind_bank_code,
			:v_branch:ind_branch,
			:v_phone_num:ind_phone_num,
			:v_province:ind_province,
			:v_city:ind_city,
			:v_payout_amount:ind_payout_amount,
			:v_request_amount:ind_request_amount,
			:v_payout_ccy:ind_payout_ccy,
			:v_request_ccy:ind_request_ccy,
			:v_member_fee_ccy:ind_member_fee_ccy,
			:v_member_fee:ind_member_fee,
			:v_merchant_fee_ccy:ind_merchant_fee_ccy,
			:v_merchant_fee:ind_merchant_fee,
			:v_markup_ccy:ind_markup_ccy,
			:v_markup_amt:ind_markup_amt,
			:v_ex_rate:ind_ex_rate,
			:v_status:ind_status,
			:v_resp_code:ind_resp_code,
			:v_remark:ind_remark,
			:v_batch_mode:ind_batch_mode,
			:v_file_name:ind_file_name,
			:v_psp_batch_id:ind_psp_batch_id,
			:v_fundout_date:ind_fundout_date,
			:v_service_fee:ind_service_fee,
			:v_psp_id:ind_psp_id;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash,0);

/*seq_num*/
		if(ind_seq_num>=0){
			PutField_Int(myHash,"seq_num",v_seq_num);
DEBUGLOG(("GetDetail seq_num=[%d]\n",v_seq_num));
		}

/*txn_id*/
		if(ind_txn_id>=0){
			v_txn_id.arr[v_txn_id.len]='\0';
			PutField_CString(myHash,"txn_seq",(const char*)v_txn_id.arr);
DEBUGLOG(("GetDetail txn_id=[%s]\n",v_txn_id.arr));
		}

/*aux_txn_seq*/
		if(ind_aux_txn_seq>=0){
			v_aux_txn_seq.arr[v_aux_txn_seq.len]='\0';
			PutField_CString(myHash,"aux_txn_seq",(const char*)v_aux_txn_seq.arr);
DEBUGLOG(("GetDetail aux_txn_seq=[%s]\n",v_aux_txn_seq.arr));
		}


/*merchant_ref*/
		if(ind_merchant_ref>=0){
			v_merchant_ref.arr[v_merchant_ref.len]='\0';
			PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetDetail merchant_ref= [%s]\n",v_merchant_ref.arr));
		}

/*country*/
		if(ind_country>=0){
			v_country.arr[v_country.len]='\0';
			PutField_CString(myHash,"txn_country",(const char*)v_country.arr);
DEBUGLOG(("GetDetail country= [%s]\n",v_country.arr));
		}

/*identity_id*/
		if(ind_identity_id>=0){
			v_identity_id.arr[v_identity_id.len]='\0';
			PutField_CString(myHash,"identity_id",(const char*)v_identity_id.arr);
DEBUGLOG(("GetDetail identity_id= [%s]\n",v_identity_id.arr));
		}

/*account_num*/
		if(ind_account_num>=0){
			v_account_num.arr[v_account_num.len]='\0';
			PutField_CString(myHash,"account_num",(const char*)v_account_num.arr);
DEBUGLOG(("GetDetail account_num= [%s]\n",v_account_num.arr));
		}

/*account_name*/
		if(ind_account_name>=0){
			v_account_name.arr[v_account_name.len]='\0';
			PutField_CString(myHash,"account_name",(const char*)v_account_name.arr);
DEBUGLOG(("GetDetail account_name= [%s]\n",v_account_name.arr));
		}

/*bank_name*/
		if(ind_bank_name>=0){
			v_bank_name.arr[v_bank_name.len]='\0';
			PutField_CString(myHash,"bank_name",(const char*)v_bank_name.arr);
DEBUGLOG(("GetDetail bank_name= [%s]\n",v_bank_name.arr));
	}

/*bank_code*/
		if(ind_bank_code>=0){
			v_bank_code.arr[v_bank_code.len]='\0';
			PutField_CString(myHash,"bank_code",(const char*)v_bank_code.arr);
DEBUGLOG(("GetDetail bank_code= [%s]\n",v_bank_code.arr));
		}

/*branch*/
		if(ind_branch>=0){
			v_branch.arr[v_branch.len]='\0';
			PutField_CString(myHash,"branch",(const char*)v_branch.arr);
DEBUGLOG(("GetDetail branch= [%s]\n",v_branch.arr));
		}

/*phone_num*/
		if(ind_phone_num>=0){
			v_phone_num.arr[v_phone_num.len]='\0';
			PutField_CString(myHash,"phone_num",(const char*)v_phone_num.arr);
DEBUGLOG(("GetDetail phone_num= [%s]\n",v_phone_num.arr));
		}

/*province*/
		if(ind_province>=0){
		v_province.arr[v_province.len]='\0';
		PutField_CString(myHash,"province",(const char*)v_province.arr);
DEBUGLOG(("GetDetail province= [%s]\n",v_province.arr));
	}

/*city*/
		if(ind_city>=0){
			v_city.arr[v_city.len]='\0';
			PutField_CString(myHash,"city",(const char*)v_city.arr);
DEBUGLOG(("GetDetail city= [%s]\n",v_city.arr));
		}

/*payout_currency*/
		if(ind_payout_ccy>=0){
			v_payout_ccy.arr[v_payout_ccy.len]='\0';
			PutField_CString(myHash,"payout_ccy",(const char*)v_payout_ccy.arr);
DEBUGLOG(("GetDetail payout_ccy= [%s]\n",v_payout_ccy.arr));
		}

/*request_currency*/
		if(ind_request_ccy>=0){
			v_request_ccy.arr[v_request_ccy.len]='\0';
			PutField_CString(myHash,"request_ccy",(const char*)v_request_ccy.arr);
DEBUGLOG(("GetDetail request_ccy= [%s]\n",v_request_ccy.arr));
		}

/*payout_amount*/
		if(ind_payout_amount>=0){
			PutField_Double(myHash,"payout_amount",v_payout_amount);
DEBUGLOG(("GetDetail payout_amount = [%lf]\n",v_payout_amount));
	}

/*request_amount*/
		if(ind_request_amount>=0){
			PutField_Double(myHash,"request_amount",v_request_amount);
DEBUGLOG(("GetDetail request_amount = [%lf]\n",v_request_amount));
	}

/*member_fee_ccy*/
		if(ind_member_fee_ccy>=0){
			v_member_fee_ccy.arr[v_member_fee_ccy.len]='\0';
			PutField_CString(myHash,"member_fee_ccy",(const char*)v_member_fee_ccy.arr);
DEBUGLOG(("GetDetail member_fee_ccy= [%s]\n",v_member_fee_ccy.arr));
		}

/*member_fee*/
		if(ind_member_fee>=0){
			PutField_Double(myHash,"member_fee",v_member_fee);
DEBUGLOG(("GetDetail member_fee = [%lf]\n",v_member_fee));
		}

/*merchant_fee_ccy*/
		if(ind_merchant_fee_ccy>=0){
			v_merchant_fee_ccy.arr[v_merchant_fee_ccy.len]='\0';
			PutField_CString(myHash,"merchant_fee_ccy",(const char*)v_merchant_fee_ccy.arr);
DEBUGLOG(("GetDetail merchant_fee_ccy= [%s]\n",v_merchant_fee_ccy.arr));
		}

/*merchant_fee*/
		if(ind_merchant_fee>=0){
			PutField_Double(myHash,"merchant_fee",v_merchant_fee);
DEBUGLOG(("GetDetail merchant_fee = [%lf]\n",v_merchant_fee));
		}

/*markup_ccy*/
		if(ind_markup_ccy>=0){
			v_markup_ccy.arr[v_markup_ccy.len]='\0';
			PutField_CString(myHash,"markup_ccy",(const char*)v_markup_ccy.arr);
DEBUGLOG(("GetDetail markup_ccy= [%s]\n",v_markup_ccy.arr));
		}

/*markup_amt*/
		if(ind_markup_amt>=0){
			PutField_Double(myHash,"markup_amt",v_markup_amt);
DEBUGLOG(("GetDetail markup_amt = [%lf]\n",v_markup_amt));
		}

/*ex_rate*/
		if(ind_ex_rate>=0){
			PutField_Double(myHash,"ex_rate",v_ex_rate);
DEBUGLOG(("GetDetail ex_rate = [%lf]\n",v_ex_rate));
		}

/*resp_code*/
		if(ind_resp_code>=0){
			v_resp_code.arr[v_resp_code.len]='\0';
			PutField_CString(myHash,"resp_code",(const char*)v_resp_code.arr);
DEBUGLOG(("GetDetail resp_code= [%s]\n",v_resp_code.arr));
		}

/*status*/
		if(ind_status>=0){
			PutField_Int(myHash,"status",v_status);
DEBUGLOG(("GetDetail status= [%d]\n",v_status));
		}

/*remark*/
		if(ind_remark>=0){
			v_remark.arr[v_remark.len]='\0';
			PutField_CString(myHash,"remark",(const char*)v_remark.arr);
DEBUGLOG(("GetDetail remark= [%s]\n",v_remark.arr));
		}

/*batch_mode*/
		if(ind_batch_mode>=0){
			PutField_Char(myHash,"batch_mode",v_batch_mode);
DEBUGLOG(("GetDetail batch_mode= [%c]\n",v_batch_mode));
		}

/*file_name*/
		if(ind_file_name>=0){
			v_file_name.arr[v_file_name.len]='\0';
			PutField_CString(myHash,"file_name",(const char*)v_file_name.arr);
DEBUGLOG(("GetDetail file_name= [%s]\n",v_file_name.arr));
		}

/*psp_batch_id*/	
		if(ind_psp_batch_id>=0){
			v_psp_batch_id.arr[v_psp_batch_id.len]='\0';
			PutField_CString(myHash,"psp_batch_id",(const char*)v_psp_batch_id.arr);
DEBUGLOG(("GetDetail psp_batch_id= [%s]\n",v_psp_batch_id.arr));
		}

/*fundout_date*/
		if(ind_fundout_date>=0){
			v_fundout_date.arr[v_fundout_date.len]='\0';
			PutField_CString(myHash,"fundout_date",(const char*)v_fundout_date.arr);
DEBUGLOG(("GetDetail fundout_date= [%s]\n",v_fundout_date.arr));
		}

/*service_fee*/
		if(ind_service_fee>=0){
			PutField_Double(myHash,"service_fee",v_service_fee);
DEBUGLOG(("GetDetail service_fee= [%lf]\n",v_service_fee));
		}

/*psp_id*/	
		if(ind_psp_id>=0){
			v_psp_id.arr[v_psp_id.len]='\0';
			PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetDetail psp_id= [%s]\n",v_psp_id.arr));
		}

		RecordSet_Add(myRec,myHash);

	}while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_getpayout;

DEBUGLOG(("GetDetail Normal Exit\n"));
	return  PD_OK;

getpayout_error:
DEBUGLOG(("getpayout_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MerchantUploadFileDetail_Get: SP_ERR\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_getpayout;
	return PD_ERR;

}


int GetDetailByTxnId(const char* csTxnId, recordset_t* myRec)
{
	hash_t *myHash;
	char	csBatchId[PD_TXN_SEQ_LEN+1];

	EXEC SQL WHENEVER SQLERROR GOTO getdetail_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		int		hv_disabled;
		varchar		hv_txn_id[PD_TXN_SEQ_LEN];

		unsigned long   v_batch_id;
		int	        v_seq_num;
		varchar		v_aux_txn_seq[PD_TXN_SEQ_LEN+1];
		varchar         v_merchant_ref[PD_MERCHANT_REF_LEN+1];
		varchar		v_country[PD_COUNTRY_LEN+1];
		varchar         v_identity_id[PD_IDENTITY_ID_LEN+1];
		varchar         v_account_num[PD_AC_NO_LEN+1];
		varchar         v_account_name[PD_ACC_NAME_LEN+1];
		varchar         v_bank_name[PD_BANK_NAME_LEN+1];
		varchar         v_bank_code[PD_BANK_CODE_LEN+1];
		varchar         v_branch[PD_BANK_BRANCH_LEN+1];
		varchar		v_phone_num[PD_MOBILE_NO_LEN+1];
		varchar         v_province[PD_PROVINCE_LEN+1];
		varchar		v_city[PD_CITY_LEN+1];
		varchar		v_payout_ccy[PD_CCY_ID_LEN+1];
		varchar		v_request_ccy[PD_CCY_ID_LEN+1];
		varchar		v_member_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_merchant_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_markup_ccy[PD_CCY_ID_LEN+1];
		double		v_payout_amount;
		double		v_request_amount;
		double		v_member_fee;
		double		v_merchant_fee;
		double		v_markup_amt;
		double		v_ex_rate;
		varchar		v_resp_code[PD_RESPONSE_CODE_LEN+1];
		int		v_status;
		varchar		v_remark[PD_REMARK_LEN+1];
		char		v_batch_mode;
		varchar		v_file_name[PD_FILENAME_LEN+1];
		varchar		v_psp_batch_id[PD_BATCH_LEN+1];
		varchar		v_fundout_date[PD_DATETIME_LEN+1];
		double		v_service_fee;
		varchar		v_psp_id[PD_PSP_ID_LEN+1];


		short           ind_seq_num = -1;
		short           ind_batch_id = -1;
		short           ind_aux_txn_seq = -1;
		short           ind_merchant_ref = -1;
		short		ind_country = -1;
		short		ind_identity_id = -1;
		short           ind_account_num = -1;
		short           ind_account_name = -1;
		short           ind_bank_name = -1;
		short           ind_bank_code = -1;
		short		ind_branch = -1;
		short           ind_phone_num = -1;
		short		ind_province = -1;
		short		ind_city = -1;
		short		ind_payout_ccy = -1;
		short		ind_request_ccy = -1;
		short		ind_status = -1;
		short           ind_member_fee_ccy = -1;
		short           ind_merchant_fee_ccy = -1;
		short           ind_markup_ccy = -1;
		short           ind_payout_amount = -1;
		short           ind_request_amount = -1;
		short           ind_member_fee = -1;
		short		ind_merchant_fee = -1;
		short           ind_markup_amt = -1;
		short		ind_ex_rate = -1;
		short		ind_resp_code = -1;
		short           ind_remark = -1;
		short		ind_batch_mode = -1;
		short           ind_file_name = -1;
		short           ind_psp_batch_id = -1;
		short           ind_fundout_date = -1;
		short           ind_service_fee = -1;
		short           ind_psp_id = -1;

	EXEC SQL END DECLARE SECTION;

	hv_disabled = 0;

	hv_txn_id.len = strlen(csTxnId);
	memcpy(hv_txn_id.arr,csTxnId,hv_txn_id.len);
DEBUGLOG(("GetDetailByTxnId txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));


	EXEC SQL DECLARE c_cursor_getdetail CURSOR FOR
		select	ud_batch_id,
			ud_seq_num,
			ud_aux_txn_id,
			ud_merchant_ref,
			ud_country,
			ud_identity_id,
			ud_account_num,
			ud_account_name,
			ud_bank_name,
			ud_bank_code,
			ud_branch,
			ud_phone_num,
			ud_province,
			ud_city,
			ud_payout_amount,
			ud_request_amount,
			ud_payout_currency,
			ud_request_currency,
			ud_member_fee_ccy,
			ud_member_fee,
			ud_merchant_fee_ccy,
			ud_merchant_fee,
			ud_markup_ccy,
			ud_markup_amt,
			ud_exchange_rate,
			ud_status,
			ud_response_code,
			ud_remark,
			ud_batch_mode,
			ud_generated_file_name,
			ud_psp_batch_id,
			ud_fundout_date,
			ud_service_fee,
			ud_psp_id
		from	merchant_upload_file_detail
		where	ud_txn_id =:hv_txn_id
		and	ud_disabled = :hv_disabled
		order by ud_seq_num;

	EXEC SQL OPEN  c_cursor_getdetail;
	do{
		EXEC SQL FETCH c_cursor_getdetail
		INTO
			:v_batch_id:ind_batch_id,
			:v_seq_num:ind_seq_num,
			:v_aux_txn_seq:ind_aux_txn_seq,
			:v_merchant_ref:ind_merchant_ref,
			:v_country:ind_country,
			:v_identity_id:ind_identity_id,
			:v_account_num:ind_account_num,
			:v_account_name:ind_account_name,
			:v_bank_name:ind_bank_name,
			:v_bank_code:ind_bank_code,
			:v_branch:ind_branch,
			:v_phone_num:ind_phone_num,
			:v_province:ind_province,
			:v_city:ind_city,
			:v_payout_amount:ind_payout_amount,
			:v_request_amount:ind_request_amount,
			:v_payout_ccy:ind_payout_ccy,
			:v_request_ccy:ind_request_ccy,
			:v_member_fee_ccy:ind_member_fee_ccy,
			:v_member_fee:ind_member_fee,
			:v_merchant_fee_ccy:ind_merchant_fee_ccy,
			:v_merchant_fee:ind_merchant_fee,
			:v_markup_ccy:ind_markup_ccy,
			:v_markup_amt:ind_markup_amt,
			:v_ex_rate:ind_ex_rate,
			:v_status:ind_status,
			:v_resp_code:ind_resp_code,
			:v_remark:ind_remark,
			:v_batch_mode:ind_batch_mode,
			:v_file_name:ind_file_name,
			:v_psp_batch_id:ind_psp_batch_id,
			:v_fundout_date:ind_fundout_date,
			:v_service_fee:ind_service_fee,
			:v_psp_id:ind_psp_id;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash,0);

/*batch_id*/
		if(ind_batch_id>=0){
			//PutField_ULong(myHash,"batch_id",v_batch_id);
			sprintf(csBatchId,"%ld",v_batch_id);
DEBUGLOG(("GetDetailByTxnId batch_id=[%ld]\n",v_batch_id));
			PutField_CString(myHash,"batch_id",csBatchId);
		}

/*seq_num*/
		if(ind_seq_num>=0){
			PutField_Int(myHash,"seq_num",v_seq_num);
DEBUGLOG(("GetDetailByTxnId seq_num=[%d]\n",v_seq_num));
		}

/*aux_txn_seq*/
		if(ind_aux_txn_seq>=0){
			v_aux_txn_seq.arr[v_aux_txn_seq.len]='\0';
			PutField_CString(myHash,"aux_txn_seq",(const char*)v_aux_txn_seq.arr);
DEBUGLOG(("GetDetailByTxnId aux_txn_seq=[%s]\n",v_aux_txn_seq.arr));
		}


/*merchant_ref*/
		if(ind_merchant_ref>=0){
			v_merchant_ref.arr[v_merchant_ref.len]='\0';
			PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetDetailByTxnId merchant_ref= [%s]\n",v_merchant_ref.arr));
		}

/*country*/
		if(ind_country>=0){
			v_country.arr[v_country.len]='\0';
			PutField_CString(myHash,"txn_country",(const char*)v_country.arr);
DEBUGLOG(("GetDetailByTxnId country= [%s]\n",v_country.arr));
		}

/*identity_id*/
		if(ind_identity_id>=0){
			v_identity_id.arr[v_identity_id.len]='\0';
			PutField_CString(myHash,"identity_id",(const char*)v_identity_id.arr);
DEBUGLOG(("GetDetailByTxnId identity_id= [%s]\n",v_identity_id.arr));
		}

/*account_num*/
		if(ind_account_num>=0){
			v_account_num.arr[v_account_num.len]='\0';
			PutField_CString(myHash,"account_num",(const char*)v_account_num.arr);
DEBUGLOG(("GetDetailByTxnId account_num= [%s]\n",v_account_num.arr));
		}

/*account_name*/
		if(ind_account_name>=0){
			v_account_name.arr[v_account_name.len]='\0';
			PutField_CString(myHash,"account_name",(const char*)v_account_name.arr);
DEBUGLOG(("GetDetailByTxnId account_name= [%s]\n",v_account_name.arr));
		}

/*bank_name*/
		if(ind_bank_name>=0){
			v_bank_name.arr[v_bank_name.len]='\0';
			PutField_CString(myHash,"bank_name",(const char*)v_bank_name.arr);
DEBUGLOG(("GetDetailByTxnId bank_name= [%s]\n",v_bank_name.arr));
	}

/*bank_code*/
		if(ind_bank_code>=0){
			v_bank_code.arr[v_bank_code.len]='\0';
			PutField_CString(myHash,"bank_code",(const char*)v_bank_code.arr);
DEBUGLOG(("GetDetailByTxnId bank_code= [%s]\n",v_bank_code.arr));
		}

/*branch*/
		if(ind_branch>=0){
			v_branch.arr[v_branch.len]='\0';
			PutField_CString(myHash,"branch",(const char*)v_branch.arr);
DEBUGLOG(("GetDetailByTxnId branch= [%s]\n",v_branch.arr));
		}

/*phone_num*/
		if(ind_phone_num>=0){
			v_phone_num.arr[v_phone_num.len]='\0';
			PutField_CString(myHash,"phone_num",(const char*)v_phone_num.arr);
DEBUGLOG(("GetDetailByTxnId phone_num= [%s]\n",v_phone_num.arr));
		}

/*province*/
		if(ind_province>=0){
		v_province.arr[v_province.len]='\0';
		PutField_CString(myHash,"province",(const char*)v_province.arr);
DEBUGLOG(("GetDetailByTxnId province= [%s]\n",v_province.arr));
	}

/*city*/
		if(ind_city>=0){
			v_city.arr[v_city.len]='\0';
			PutField_CString(myHash,"city",(const char*)v_city.arr);
DEBUGLOG(("GetDetailByTxnId city= [%s]\n",v_city.arr));
		}

/*payout_currency*/
		if(ind_payout_ccy>=0){
			v_payout_ccy.arr[v_payout_ccy.len]='\0';
			PutField_CString(myHash,"payout_ccy",(const char*)v_payout_ccy.arr);
DEBUGLOG(("GetDetailByTxnId payout_ccy= [%s]\n",v_payout_ccy.arr));
		}

/*request_currency*/
		if(ind_request_ccy>=0){
			v_request_ccy.arr[v_request_ccy.len]='\0';
			PutField_CString(myHash,"request_ccy",(const char*)v_request_ccy.arr);
DEBUGLOG(("GetDetailByTxnId request_ccy= [%s]\n",v_request_ccy.arr));
		}

/*payout_amount*/
		if(ind_payout_amount>=0){
			PutField_Double(myHash,"payout_amount",v_payout_amount);
DEBUGLOG(("GetDetailByTxnId payout_amount = [%lf]\n",v_payout_amount));
	}

/*request_amount*/
		if(ind_request_amount>=0){
			PutField_Double(myHash,"request_amount",v_request_amount);
DEBUGLOG(("GetDetailByTxnId request_amount = [%lf]\n",v_request_amount));
	}

/*member_fee_ccy*/
		if(ind_member_fee_ccy>=0){
			v_member_fee_ccy.arr[v_member_fee_ccy.len]='\0';
			PutField_CString(myHash,"member_fee_ccy",(const char*)v_member_fee_ccy.arr);
DEBUGLOG(("GetDetailByTxnId member_fee_ccy= [%s]\n",v_member_fee_ccy.arr));
		}

/*member_fee*/
		if(ind_member_fee>=0){
			PutField_Double(myHash,"member_fee",v_member_fee);
DEBUGLOG(("GetDetailByTxnId member_fee = [%lf]\n",v_member_fee));
		}

/*merchant_fee_ccy*/
		if(ind_merchant_fee_ccy>=0){
			v_merchant_fee_ccy.arr[v_merchant_fee_ccy.len]='\0';
			PutField_CString(myHash,"merchant_fee_ccy",(const char*)v_merchant_fee_ccy.arr);
DEBUGLOG(("GetDetailByTxnId merchant_fee_ccy= [%s]\n",v_merchant_fee_ccy.arr));
		}

/*merchant_fee*/
		if(ind_merchant_fee>=0){
			PutField_Double(myHash,"merchant_fee",v_merchant_fee);
DEBUGLOG(("GetDetailByTxnId merchant_fee = [%lf]\n",v_merchant_fee));
		}

/*markup_ccy*/
		if(ind_markup_ccy>=0){
			v_markup_ccy.arr[v_markup_ccy.len]='\0';
			PutField_CString(myHash,"markup_ccy",(const char*)v_markup_ccy.arr);
DEBUGLOG(("GetDetailByTxnId markup_ccy= [%s]\n",v_markup_ccy.arr));
		}

/*markup_amt*/
		if(ind_markup_amt>=0){
			PutField_Double(myHash,"markup_amt",v_markup_amt);
DEBUGLOG(("GetDetailByTxnId markup_amt = [%lf]\n",v_markup_amt));
		}

/*ex_rate*/
		if(ind_ex_rate>=0){
			PutField_Double(myHash,"ex_rate",v_ex_rate);
DEBUGLOG(("GetDetailByTxnId ex_rate = [%lf]\n",v_ex_rate));
		}

/*resp_code*/
		if(ind_resp_code>=0){
			v_resp_code.arr[v_resp_code.len]='\0';
			PutField_CString(myHash,"resp_code",(const char*)v_resp_code.arr);
DEBUGLOG(("GetDetailByTxnId resp_code= [%s]\n",v_resp_code.arr));
		}

/*status*/
		if(ind_status>=0){
			PutField_Int(myHash,"status",v_status);
DEBUGLOG(("GetDetailByTxnId status= [%d]\n",v_status));
		}

/*remark*/
		if(ind_remark>=0){
			v_remark.arr[v_remark.len]='\0';
			PutField_CString(myHash,"remark",(const char*)v_remark.arr);
DEBUGLOG(("GetDetailByTxnId remark= [%s]\n",v_remark.arr));
		}

/*batch_mode*/
		if(ind_batch_mode>=0){
			PutField_Char(myHash,"batch_mode",v_batch_mode);
DEBUGLOG(("GetDetailByTxnId batch_mode= [%c]\n",v_batch_mode));
		}

/*file_name*/
		if(ind_file_name>=0){
			v_file_name.arr[v_file_name.len]='\0';
			PutField_CString(myHash,"file_name",(const char*)v_file_name.arr);
DEBUGLOG(("GetDetailByTxnId file_name= [%s]\n",v_file_name.arr));
		}

/*psp_batch_id*/	
		if(ind_psp_batch_id>=0){
			v_psp_batch_id.arr[v_psp_batch_id.len]='\0';
			PutField_CString(myHash,"psp_batch_id",(const char*)v_psp_batch_id.arr);
DEBUGLOG(("GetDetailByTxnId psp_batch_id= [%s]\n",v_psp_batch_id.arr));
		}

/*fundout_date*/
		if(ind_fundout_date>=0){
			v_fundout_date.arr[v_fundout_date.len]='\0';
			PutField_CString(myHash,"fundout_date",(const char*)v_fundout_date.arr);
DEBUGLOG(("GetDetailByTxnId fundout_date= [%s]\n",v_fundout_date.arr));
		}

/*service_fee*/
		if(ind_service_fee>=0){
			PutField_Double(myHash,"service_fee",v_service_fee);
DEBUGLOG(("GetDetailByTxnId service_fee= [%lf]\n",v_service_fee));
		}


/*psp_id*/	
		if(ind_psp_id>=0){
			v_psp_id.arr[v_psp_id.len]='\0';
			PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetDetail psp_id= [%s]\n",v_psp_id.arr));
		}

		RecordSet_Add(myRec,myHash);

	}while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_getdetail;

DEBUGLOG(("GetDetailByTxnId Normal Exit\n"));
	return  PD_OK;

getdetail_error:
DEBUGLOG(("getdetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MerchantUploadFileDetail_GetByTxnId: SP_ERR\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_getdetail;
	return PD_ERR;

}


int MatchRespTxn(const char* csTxnSeq,
                 const int iStatus)
{
        EXEC SQL WHENEVER SQLERROR GOTO MatchRespTxn_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];
                int             hv_status;

		short		v_cnt;

        EXEC SQL END DECLARE SECTION;

        hv_txn_id.len = strlen(csTxnSeq);
        memcpy(hv_txn_id.arr,csTxnSeq,hv_txn_id.len);
DEBUGLOG(("MatchRespTxn txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        hv_status = iStatus;
DEBUGLOG(("MatchRespTxn status = [%d]\n",hv_status));

        EXEC SQL SELECT nvl(COUNT(*),0)
                INTO    :v_cnt
                FROM    merchant_upload_file_detail
                WHERE   ud_txn_id = :hv_txn_id
                and     ud_status = :hv_status;


	if(v_cnt>0){
DEBUGLOG(("MatchRespTxn Found\n"));
		return PD_FOUND;
        }
	else {
DEBUGLOG(("MatchRespTxn Not Found\n"));
		return PD_NOT_FOUND;
	}


MatchRespTxn_error:
DEBUGLOG(("MatchRespTxn_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

/*
int GetExistingPid(hash_t *hTxn, recordset_t* myRec)
{
	hash_t *myHash;
	int	iCnt = 0;
	char* csMerchantId;
        EXEC SQL WHENEVER SQLERROR GOTO epp_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                int		hv_status;
                int             hv_disabled;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];

                varchar         v_pid[PD_PSP_ID_LEN+1];
                short           ind_pid = -1;

        EXEC SQL END DECLARE SECTION;

        hv_status = PAYOUT_MASTER_TRANSACTION_APPROVED;
DEBUGLOG(("GetExistingPid status = [%d]\n",hv_status));

        hv_disabled = 0;

	if(GetField_CString(hTxn,"merchant_id",&csMerchantId)){
		
        	hv_merchant_id.len = strlen(csMerchantId);
        	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("GetExistingPid merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));


        	EXEC SQL DECLARE c_cursor_eppm CURSOR FOR
                	SELECT UNIQUE ud_pid
                	FROM    merchant_upload_file_detail,
				merchant_upload_file_header
                	WHERE   ud_status= :hv_status
                	and     ud_disabled = :hv_disabled
			and	ud_batch_id=uh_batch_id
			and	uh_merchant_id=:hv_merchant_id
			and     ud_pid IS NOT NULL;

		EXEC SQL OPEN  c_cursor_eppm;
		do{
			EXEC SQL FETCH c_cursor_eppm
				INTO
				:v_pid:ind_pid;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			if(ind_pid>=0){
				v_pid.arr[v_pid.len]='\0';
				PutField_CString(myHash,"pid",(const char*)v_pid.arr);
DEBUGLOG(("GetExistingPid pid= [%s]\n",v_pid.arr));

				iCnt++;
			}

			RecordSet_Add(myRec,myHash);

		}while(PD_TRUE);

		EXEC SQL CLOSE c_cursor_eppm;
	}
	else{
        	EXEC SQL DECLARE c_cursor_epp CURSOR FOR
                	SELECT UNIQUE ud_pid
                	FROM    merchant_upload_file_detail
                	WHERE   ud_status= :hv_status
                	and     ud_disabled = :hv_disabled
			and     ud_pid IS NOT NULL;

		EXEC SQL OPEN  c_cursor_epp;
		do{
			EXEC SQL FETCH c_cursor_epp
				INTO
				:v_pid:ind_pid;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			if(ind_pid>=0){
				v_pid.arr[v_pid.len]='\0';
				PutField_CString(myHash,"pid",(const char*)v_pid.arr);
DEBUGLOG(("GetExistingPid pid= [%s]\n",v_pid.arr));

				iCnt++;
			}

			RecordSet_Add(myRec,myHash);

		}while(PD_TRUE);

		EXEC SQL CLOSE c_cursor_epp;
	}

	if(iCnt>0){
DEBUGLOG(("GetExistingPid Normal Exit\n"));
		return  PD_OK;
	}
	else{
DEBUGLOG(("GetExistingPid Normal Exit, No Record\n"));
		return  PD_ERR;
	}

epp_error:
DEBUGLOG(("GetExistingPid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_epp;
        return PD_ERR;
}
*/

int GetExistingPsp(hash_t *hTxn, recordset_t* myRec)
{
	hash_t *myHash;
	int	iCnt = 0;
	char*	csMerchantId;
        EXEC SQL WHENEVER SQLERROR GOTO epsp_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                int		hv_status;
                int             hv_disabled;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		char		hv_batch_mode;

                varchar         v_psp_id[PD_PSP_ID_LEN+1];
                short           ind_psp_id = -1;

        EXEC SQL END DECLARE SECTION;

        hv_status = PAYOUT_MASTER_TRANSACTION_APPROVED;
DEBUGLOG(("GetExistingPsp status = [%d]\n",hv_status));

        hv_disabled = 0;
	hv_batch_mode = PD_OFFLINE;


	if(GetField_CString(hTxn,"merchant_id",&csMerchantId)){
		
        	hv_merchant_id.len = strlen(csMerchantId);
        	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("GetExistingPsp merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));


        	EXEC SQL DECLARE c_cursor_epspm CURSOR FOR
                	SELECT UNIQUE ud_psp_id
                	FROM    merchant_upload_file_detail,
				merchant_upload_file_header
                	WHERE   ud_status= :hv_status
                	and     ud_disabled = :hv_disabled
			and	ud_batch_id=uh_batch_id
			and	uh_merchant_id=:hv_merchant_id
			and	ud_batch_mode=:hv_batch_mode
			and     ud_psp_id IS NOT NULL;

		EXEC SQL OPEN  c_cursor_epspm;
		do{
			EXEC SQL FETCH c_cursor_epspm
				INTO
				:v_psp_id:ind_psp_id;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

/*psp_id*/
			if(ind_psp_id>=0){
				v_psp_id.arr[v_psp_id.len]='\0';
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetExistingPsp psp_id= [%s]\n",v_psp_id.arr));

				iCnt++;
			}

			RecordSet_Add(myRec,myHash);

		}while(PD_TRUE);

		EXEC SQL CLOSE c_cursor_epspm;

	}
	else{
        	EXEC SQL DECLARE c_cursor_epsp CURSOR FOR
                	SELECT UNIQUE ud_psp_id
                	FROM    merchant_upload_file_detail
                	WHERE   ud_status= :hv_status
                	and     ud_disabled = :hv_disabled
			and	ud_batch_mode=:hv_batch_mode
			and     ud_psp_id IS NOT NULL;

		EXEC SQL OPEN  c_cursor_epsp;
		do{
			EXEC SQL FETCH c_cursor_epsp
				INTO
				:v_psp_id:ind_psp_id;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

/*psp_id*/
			if(ind_psp_id>=0){
				v_psp_id.arr[v_psp_id.len]='\0';
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetExistingPsp psp_id= [%s]\n",v_psp_id.arr));

				iCnt++;
			}

			RecordSet_Add(myRec,myHash);

		}while(PD_TRUE);

		EXEC SQL CLOSE c_cursor_epsp;
	}

	if(iCnt>0){
DEBUGLOG(("GetExistingPsp Normal Exit\n"));
		return  PD_OK;
	}
	else{
DEBUGLOG(("GetExistingPsp Normal Exit, No Record\n"));
		return  PD_ERR;
	}

epsp_error:
DEBUGLOG(("GetExistingPsp_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_epsp;
        return PD_ERR;
}


int GetPspAssignedTxn(hash_t* hTxn, recordset_t* myRec)
{
	hash_t	*myHash;
	int	iCnt = 0;
	char	csBatchId[PD_TXN_SEQ_LEN+1];
	char*	csMerchantId;

        EXEC SQL WHENEVER SQLERROR GOTO psp_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		int		hv_disabled;
		int		hv_status;
		varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		char		hv_batch_mode;

		unsigned long	v_batch_id;
		int		v_seq_num;
		varchar         v_txn_id[PD_TXN_SEQ_LEN+1];
		varchar         v_psp_id[PD_PSP_ID_LEN+1];
		varchar         v_merchant_ref[PD_MERCHANT_REF_LEN+1];
		varchar         v_identity_id[PD_IDENTITY_ID_LEN+1];
		varchar         v_account_num[PD_AC_NO_LEN+1];
		varchar         v_account_name[PD_ACC_NAME_LEN+1];
		varchar         v_bank_name[PD_BANK_NAME_LEN+1];
		varchar         v_branch[PD_BANK_BRANCH_LEN+1];
		varchar		v_phone_num[PD_MOBILE_NO_LEN+1];
		varchar         v_province[PD_PROVINCE_LEN+1];
		varchar		v_city[PD_CITY_LEN+1];
		double		v_payout_amount;
		double		v_request_amount;
		varchar		v_remark[PD_REMARK_LEN+1];
		varchar		v_txn_country[PD_COUNTRY_CODE_LEN+1];
		varchar		v_payout_ccy[PD_CURRENCY_ID_LEN+1];
		varchar		v_request_ccy[PD_CURRENCY_ID_LEN+1];
		varchar		v_member_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_merchant_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_markup_ccy[PD_CCY_ID_LEN+1];
		double		v_markup_amt;
		double		v_member_fee;
		double		v_merchant_fee;

		short		ind_txn_id = -1;
		short		ind_psp_id = -1;
		short		ind_seq_num = -1;
		short		ind_batch_id = -1;
		short           ind_merchant_ref = -1;
		short		ind_identity_id = -1;
		short           ind_account_num = -1;
		short           ind_account_name = -1;
		short           ind_bank_name = -1;
		short		ind_branch = -1;
		short           ind_phone_num = -1;
		short		ind_province = -1;
		short		ind_city = -1;
		short		ind_payout_amount = -1;
		short		ind_remark = -1;
		short		ind_txn_country = -1;
		short		ind_payout_ccy = -1;
		short		ind_request_ccy = -1;
		short           ind_member_fee_ccy = -1;
		short           ind_merchant_fee_ccy = -1;
		short           ind_request_amount = -1;
		short           ind_member_fee = -1;
		short		ind_merchant_fee = -1;
		short		ind_markup_amt= -1;
		short		ind_markup_ccy= -1;

        EXEC SQL END DECLARE SECTION;

	hv_status = PAYOUT_MASTER_TRANSACTION_APPROVED;
DEBUGLOG(("GetPspAssignedTxn status = [%d]\n",hv_status));

	hv_disabled = 0;
	hv_batch_mode=PD_OFFLINE;

	if(GetField_CString(hTxn,"merchant_id",&csMerchantId)){
        	hv_merchant_id.len = strlen(csMerchantId);
        	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("GetPspAssignedTxn merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

		EXEC SQL DECLARE c_cursor_pspm CURSOR FOR
        		SELECT	ud_batch_id,
				ud_seq_num,
				ud_txn_id,
				ud_merchant_ref,
				ud_identity_id,
				ud_account_name,
				ud_account_num,
				ud_bank_name,
				ud_branch,
				ud_phone_num,
				ud_province,
				ud_city,
				ud_payout_amount,
				ud_request_amount,
				ud_remark,
				ud_psp_id,
				ud_country,
				ud_payout_currency,
				ud_request_currency,
				ud_merchant_fee_ccy,
				ud_merchant_fee,
				ud_member_fee_ccy,
				ud_member_fee,
				ud_markup_amt,
				ud_markup_ccy
			FROM    merchant_upload_file_detail,
				merchant_upload_file_header
                	WHERE   ud_status = :hv_status
                	and     ud_disabled = :hv_disabled
			and	ud_batch_id=uh_batch_id
			and	uh_merchant_id = :hv_merchant_id
			and	ud_batch_mode=:hv_batch_mode
			and     ud_psp_id IS NOT NULL;

		EXEC SQL OPEN  c_cursor_pspm;
		do{
			EXEC SQL FETCH c_cursor_pspm
				INTO
				:v_batch_id:ind_batch_id,
				:v_seq_num:ind_seq_num,
				:v_txn_id:ind_txn_id,
				:v_merchant_ref:ind_merchant_ref,
				:v_identity_id:ind_identity_id,
				:v_account_name:ind_account_name,
				:v_account_num:ind_account_num,
				:v_bank_name:ind_bank_name,
				:v_branch:ind_branch,
				:v_phone_num:ind_phone_num,
				:v_province:ind_province,
				:v_city:ind_city,
				:v_payout_amount:ind_payout_amount,
				:v_request_amount:ind_request_amount,
				:v_remark:ind_remark,
				:v_psp_id:ind_psp_id,
				:v_txn_country:ind_txn_country,
				:v_payout_ccy:ind_payout_ccy,
				:v_request_ccy:ind_request_ccy,
				:v_merchant_fee_ccy:ind_merchant_fee_ccy,
				:v_merchant_fee:ind_merchant_fee,
				:v_member_fee_ccy:ind_member_fee_ccy,
				:v_member_fee:ind_member_fee,
				:v_markup_amt:ind_markup_amt,
				:v_markup_ccy:ind_markup_ccy;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

/*txn_id*/	
			if(ind_txn_id>=0){
				v_txn_id.arr[v_txn_id.len]='\0';
				PutField_CString(myHash,"txn_id",(const char*)v_txn_id.arr);
DEBUGLOG(("GetPspAssignedTxn txn_id= [%s]\n",v_txn_id.arr));

			}

/*psp_id*/	
			if(ind_psp_id>=0){
				v_psp_id.arr[v_psp_id.len]='\0';
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetPspAssignedTxn psp_id= [%s]\n",v_psp_id.arr));

			}

/*txn_country*/	
			if(ind_txn_country>=0){
				v_txn_country.arr[v_txn_country.len]='\0';
				PutField_CString(myHash,"txn_country",(const char*)v_txn_country.arr);
DEBUGLOG(("GetPspAssignedTxn txn_country= [%s]\n",v_txn_country.arr));

			}

/*batch_id*/
			if(ind_batch_id>=0){
				sprintf(csBatchId,"%ld",v_batch_id);
DEBUGLOG(("GetPspAssignedTxn batch_id=[%ld]\n",v_batch_id));
				PutField_CString(myHash,"batch_id",csBatchId);
			}


/*seq_num*/
			if(ind_seq_num>=0){
				PutField_Int(myHash,"seq_num",v_seq_num);
DEBUGLOG(("GetPspAssignedTxn seq_num=[%d]\n",v_seq_num));
			}


/*merchant_ref*/
			if(ind_merchant_ref>=0){
				v_merchant_ref.arr[v_merchant_ref.len]='\0';
				PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetPspAssignedTxn merchant_ref= [%s]\n",v_merchant_ref.arr));
			}

/*identity_id*/
			if(ind_identity_id>=0){
				v_identity_id.arr[v_identity_id.len]='\0';
				PutField_CString(myHash,"identity_id",(const char*)v_identity_id.arr);
DEBUGLOG(("GetPspAssignedTxn identity_id= [%s]\n",v_identity_id.arr));
			}

/*account_num*/
			if(ind_account_num>=0){
				v_account_num.arr[v_account_num.len]='\0';
				PutField_CString(myHash,"account_num",(const char*)v_account_num.arr);
DEBUGLOG(("GetPspAssignedTxn account_num= [%s]\n",v_account_num.arr));
			}

/*account_name*/
			if(ind_account_name>=0){
				v_account_name.arr[v_account_name.len]='\0';
				PutField_CString(myHash,"account_name",(const char*)v_account_name.arr);
DEBUGLOG(("GetPspAssignedTxn account_name= [%s]\n",v_account_name.arr));
			}

/*bank_name*/
			if(ind_bank_name>=0){
				v_bank_name.arr[v_bank_name.len]='\0';
				PutField_CString(myHash,"bank_name",(const char*)v_bank_name.arr);
DEBUGLOG(("GetPspAssignedTxn bank_name= [%s]\n",v_bank_name.arr));
			}


/*branch*/
			if(ind_branch>=0){
				v_branch.arr[v_branch.len]='\0';
				PutField_CString(myHash,"branch",(const char*)v_branch.arr);
DEBUGLOG(("GetPspAssignedTxn branch= [%s]\n",v_branch.arr));
			}

/*phone_num*/
			if(ind_phone_num>=0){
				v_phone_num.arr[v_phone_num.len]='\0';
				PutField_CString(myHash,"phone_num",(const char*)v_phone_num.arr);
DEBUGLOG(("GetPspAssignedTxn phone_num= [%s]\n",v_phone_num.arr));
			}

/*province*/
			if(ind_province>=0){
				v_province.arr[v_province.len]='\0';
				PutField_CString(myHash,"province",(const char*)v_province.arr);
DEBUGLOG(("GetPspAssignedTxn province= [%s]\n",v_province.arr));
			}

/*city*/
			if(ind_city>=0){
				v_city.arr[v_city.len]='\0';
				PutField_CString(myHash,"city",(const char*)v_city.arr);
DEBUGLOG(("GetPspAssignedTxn city= [%s]\n",v_city.arr));
			}

/*request_ccy*/	
			if(ind_request_ccy>=0){
				v_request_ccy.arr[v_request_ccy.len]='\0';
				PutField_CString(myHash,"request_ccy",(const char*)v_request_ccy.arr);
DEBUGLOG(("GetPspAssignedTxn request_ccy= [%s]\n",v_request_ccy.arr));

			}

/*request_amount*/
			if(ind_request_amount>=0){
				PutField_Double(myHash,"request_amount",v_request_amount);
DEBUGLOG(("GetPspAssignedTxn request_amount = [%lf]\n",v_request_amount));
			}

/*payout_ccy*/	
			if(ind_payout_ccy>=0){
				v_payout_ccy.arr[v_payout_ccy.len]='\0';
				PutField_CString(myHash,"payout_ccy",(const char*)v_payout_ccy.arr);
DEBUGLOG(("GetPspAssignedTxn payout_ccy= [%s]\n",v_payout_ccy.arr));

			}

/*payout_amount*/
			if(ind_payout_amount>=0){
				PutField_Double(myHash,"payout_amount",v_payout_amount);
DEBUGLOG(("GetPspAssignedTxn payout_amount = [%lf]\n",v_payout_amount));
			}

/*merchant_fee_ccy*/	
			if(ind_merchant_fee_ccy>=0){
				v_merchant_fee_ccy.arr[v_merchant_fee_ccy.len]='\0';
				PutField_CString(myHash,"merchant_fee_ccy",(const char*)v_merchant_fee_ccy.arr);
DEBUGLOG(("GetPspAssignedTxn merchant_fee_ccy= [%s]\n",v_merchant_fee_ccy.arr));

			}

/*merchant_fee*/
			if(ind_merchant_fee>=0){
				PutField_Double(myHash,"merchant_fee",v_merchant_fee);
DEBUGLOG(("GetPspAssignedTxn merchant_fee = [%lf]\n",v_merchant_fee));
			}

/*member_fee_ccy*/	
			if(ind_member_fee_ccy>=0){
				v_member_fee_ccy.arr[v_member_fee_ccy.len]='\0';
				PutField_CString(myHash,"member_fee_ccy",(const char*)v_member_fee_ccy.arr);
DEBUGLOG(("GetPspAssignedTxn member_fee_ccy= [%s]\n",v_member_fee_ccy.arr));

			}

/*member_fee*/
			if(ind_member_fee>=0){
				PutField_Double(myHash,"member_fee",v_member_fee);
DEBUGLOG(("GetPspAssignedTxn member_fee = [%lf]\n",v_member_fee));
			}

/*markup_ccy*/	
			if(ind_markup_ccy>=0){
				v_markup_ccy.arr[v_markup_ccy.len]='\0';
				PutField_CString(myHash,"markup_ccy",(const char*)v_markup_ccy.arr);
DEBUGLOG(("GetPspAssignedTxn markup_ccy= [%s]\n",v_markup_ccy.arr));

			}

/*markup_amt*/
			if(ind_markup_amt>=0){
				PutField_Double(myHash,"markup_amt",v_markup_amt);
DEBUGLOG(("GetPspAssignedTxn markup_amt = [%lf]\n",v_markup_amt));
			}

/*remark*/
			if(ind_remark>=0){
				v_remark.arr[v_remark.len]='\0';
				PutField_CString(myHash,"remark",(const char*)v_remark.arr);
DEBUGLOG(("GetPspAssignedTxn remark= [%s]\n",v_remark.arr));
			}

			iCnt ++;
			RecordSet_Add(myRec,myHash);

		}while(PD_TRUE);

		EXEC SQL CLOSE c_cursor_pspm;

	}
	else{
		EXEC SQL DECLARE c_cursor_psp CURSOR FOR
        		SELECT	ud_batch_id,
				ud_seq_num,
				ud_txn_id,
				ud_merchant_ref,
				ud_identity_id,
				ud_account_name,
				ud_account_num,
				ud_bank_name,
				ud_branch,
				ud_phone_num,
				ud_province,
				ud_city,
				ud_payout_amount,
				ud_remark,
				ud_psp_id,
				ud_country,
				ud_payout_currency
         	       FROM    merchant_upload_file_detail
                	WHERE   ud_status = :hv_status
                	and     ud_disabled = :hv_disabled
			and	ud_batch_mode=:hv_batch_mode
			and     ud_psp_id IS NOT NULL;

		EXEC SQL OPEN  c_cursor_psp;
		do{
			EXEC SQL FETCH c_cursor_psp
				INTO
				:v_batch_id:ind_batch_id,
				:v_seq_num:ind_seq_num,
				:v_txn_id:ind_txn_id,
				:v_merchant_ref:ind_merchant_ref,
				:v_identity_id:ind_identity_id,
				:v_account_name:ind_account_name,
				:v_account_num:ind_account_num,
				:v_bank_name:ind_bank_name,
				:v_branch:ind_branch,
				:v_phone_num:ind_phone_num,
				:v_province:ind_province,
				:v_city:ind_city,
				:v_payout_amount:ind_payout_amount,
				:v_remark:ind_remark,
				:v_psp_id:ind_psp_id,
				:v_txn_country:ind_txn_country,
				:v_payout_ccy:ind_payout_ccy;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

/*txn_id*/	
			if(ind_txn_id>=0){
				v_txn_id.arr[v_txn_id.len]='\0';
				PutField_CString(myHash,"txn_id",(const char*)v_txn_id.arr);
DEBUGLOG(("GetPspAssignedTxn txn_id= [%s]\n",v_txn_id.arr));

			}

/*psp_id*/	
			if(ind_psp_id>=0){
				v_psp_id.arr[v_psp_id.len]='\0';
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetPspAssignedTxn psp_id= [%s]\n",v_psp_id.arr));

			}

/*txn_country*/	
			if(ind_txn_country>=0){
				v_txn_country.arr[v_txn_country.len]='\0';
				PutField_CString(myHash,"txn_country",(const char*)v_txn_country.arr);
DEBUGLOG(("GetPspAssignedTxn txn_country= [%s]\n",v_txn_country.arr));

			}

/*batch_id*/
			if(ind_batch_id>=0){
				sprintf(csBatchId,"%ld",v_batch_id);
				DEBUGLOG(("GetDetailByTxnId batch_id=[%ld]\n",v_batch_id));
PutField_CString(myHash,"batch_id",csBatchId);
			}


/*seq_num*/
			if(ind_seq_num>=0){
				PutField_Int(myHash,"seq_num",v_seq_num);
DEBUGLOG(("GetPspAssignedTxn seq_num=[%d]\n",v_seq_num));
			}


/*merchant_ref*/
			if(ind_merchant_ref>=0){
				v_merchant_ref.arr[v_merchant_ref.len]='\0';
				PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetPspAssignedTxn merchant_ref= [%s]\n",v_merchant_ref.arr));
			}

/*identity_id*/
			if(ind_identity_id>=0){
				v_identity_id.arr[v_identity_id.len]='\0';
				PutField_CString(myHash,"identity_id",(const char*)v_identity_id.arr);
DEBUGLOG(("GetPspAssignedTxn identity_id= [%s]\n",v_identity_id.arr));
			}

/*account_num*/
			if(ind_account_num>=0){
				v_account_num.arr[v_account_num.len]='\0';
				PutField_CString(myHash,"account_num",(const char*)v_account_num.arr);
DEBUGLOG(("GetPspAssignedTxn account_num= [%s]\n",v_account_num.arr));
			}

/*account_name*/
			if(ind_account_name>=0){
				v_account_name.arr[v_account_name.len]='\0';
				PutField_CString(myHash,"account_name",(const char*)v_account_name.arr);
DEBUGLOG(("GetPspAssignedTxn account_name= [%s]\n",v_account_name.arr));
			}

/*bank_name*/
			if(ind_bank_name>=0){
				v_bank_name.arr[v_bank_name.len]='\0';
				PutField_CString(myHash,"bank_name",(const char*)v_bank_name.arr);
DEBUGLOG(("GetPspAssignedTxn bank_name= [%s]\n",v_bank_name.arr));
			}


/*branch*/
			if(ind_branch>=0){
				v_branch.arr[v_branch.len]='\0';
				PutField_CString(myHash,"branch",(const char*)v_branch.arr);
DEBUGLOG(("GetPspAssignedTxn branch= [%s]\n",v_branch.arr));
			}

/*phone_num*/
			if(ind_phone_num>=0){
				v_phone_num.arr[v_phone_num.len]='\0';
				PutField_CString(myHash,"phone_num",(const char*)v_phone_num.arr);
DEBUGLOG(("GetPspAssignedTxn phone_num= [%s]\n",v_phone_num.arr));
			}

/*province*/
			if(ind_province>=0){
				v_province.arr[v_province.len]='\0';
				PutField_CString(myHash,"province",(const char*)v_province.arr);
DEBUGLOG(("GetPspAssignedTxn province= [%s]\n",v_province.arr));
			}

/*city*/
			if(ind_city>=0){
				v_city.arr[v_city.len]='\0';
				PutField_CString(myHash,"city",(const char*)v_city.arr);
DEBUGLOG(("GetPspAssignedTxn city= [%s]\n",v_city.arr));
			}

/*payout_ccy*/	
			if(ind_payout_ccy>=0){
				v_payout_ccy.arr[v_payout_ccy.len]='\0';
				PutField_CString(myHash,"payout_ccy",(const char*)v_payout_ccy.arr);
DEBUGLOG(("GetPspAssignedTxn payout_ccy= [%s]\n",v_payout_ccy.arr));

			}

/*payout_amount*/
			if(ind_payout_amount>=0){
				PutField_Double(myHash,"payout_amount",v_payout_amount);
DEBUGLOG(("GetPspAssignedTxn payout_amount = [%lf]\n",v_payout_amount));
			}

/*remark*/
			if(ind_remark>=0){
				v_remark.arr[v_remark.len]='\0';
				PutField_CString(myHash,"remark",(const char*)v_remark.arr);
DEBUGLOG(("GetPspAssignedTxn remark= [%s]\n",v_remark.arr));
			}

			iCnt ++;
			RecordSet_Add(myRec,myHash);

		}while(PD_TRUE);

		EXEC SQL CLOSE c_cursor_psp;
	}
	
	if(iCnt>0){
DEBUGLOG(("GetPspAssignedTxn Normal Exit\n"));
		return  PD_OK;
	}
	else{
DEBUGLOG(("GetPspAssignedTxn Normal Exit, No Record\n"));
		return  PD_ERR;
	}

psp_error:
DEBUGLOG(("GetPspAssignedTxn_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_psp;
        return PD_ERR;
}


int GetDetailByRandomWithBankMerchant(const char* csBankName, const char* csMerchantId, recordset_t* myRec)
{
	hash_t *myHash;
	char	csBatchId[PD_TXN_SEQ_LEN+1];

	EXEC SQL WHENEVER SQLERROR GOTO getdetailrbm_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		int		hv_disabled;
		varchar         hv_bank_name[PD_BANK_NAME_LEN];
		varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		int		hv_status;
		char		hv_batch_mode;

		varchar		v_txn_id[PD_TXN_SEQ_LEN+1];
		unsigned long   v_batch_id;
		int	        v_seq_num;
		varchar		v_aux_txn_seq[PD_TXN_SEQ_LEN+1];
		varchar         v_merchant_ref[PD_MERCHANT_REF_LEN+1];
		varchar		v_country[PD_COUNTRY_LEN+1];
		varchar         v_identity_id[PD_IDENTITY_ID_LEN+1];
		varchar         v_account_num[PD_AC_NO_LEN+1];
		varchar         v_account_name[PD_ACC_NAME_LEN+1];
		varchar         v_branch[PD_BANK_BRANCH_LEN+1];
		varchar		v_phone_num[PD_MOBILE_NO_LEN+1];
		varchar         v_province[PD_PROVINCE_LEN+1];
		varchar		v_city[PD_CITY_LEN+1];
		varchar		v_payout_ccy[PD_CCY_ID_LEN+1];
		varchar		v_request_ccy[PD_CCY_ID_LEN+1];
		varchar		v_member_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_merchant_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_markup_ccy[PD_CCY_ID_LEN+1];
		double		v_payout_amount;
		double		v_request_amount;
		double		v_member_fee;
		double		v_merchant_fee;
		double		v_markup_amt;
		double		v_ex_rate;
		varchar		v_resp_code[PD_RESPONSE_CODE_LEN+1];
		varchar		v_remark[PD_REMARK_LEN+1];
		char		v_batch_mode;
		varchar		v_file_name[PD_FILENAME_LEN+1];
		varchar		v_psp_batch_id[PD_BATCH_LEN+1];
		varchar		v_fundout_date[PD_DATETIME_LEN+1];
		double		v_service_fee;
		varchar		v_psp_id[PD_PSP_ID_LEN+1];


		short           ind_txn_id = -1;
		short           ind_seq_num = -1;
		short           ind_batch_id = -1;
		short           ind_aux_txn_seq = -1;
		short           ind_merchant_ref = -1;
		short		ind_country = -1;
		short		ind_identity_id = -1;
		short           ind_account_num = -1;
		short           ind_account_name = -1;
		short		ind_branch = -1;
		short           ind_phone_num = -1;
		short		ind_province = -1;
		short		ind_city = -1;
		short		ind_payout_ccy = -1;
		short		ind_request_ccy = -1;
		short           ind_member_fee_ccy = -1;
		short           ind_merchant_fee_ccy = -1;
		short           ind_markup_ccy = -1;
		short           ind_payout_amount = -1;
		short           ind_request_amount = -1;
		short           ind_member_fee = -1;
		short		ind_merchant_fee = -1;
		short           ind_markup_amt = -1;
		short		ind_ex_rate = -1;
		short		ind_resp_code = -1;
		short           ind_remark = -1;
		short		ind_batch_mode = -1;
		short           ind_file_name = -1;
		short           ind_psp_batch_id = -1;
		short           ind_fundout_date = -1;
		short           ind_service_fee = -1;
		short           ind_psp_id = -1;

	EXEC SQL END DECLARE SECTION;

	hv_disabled = 0;
	hv_batch_mode=PD_OFFLINE;

	hv_bank_name.len = strlen(csBankName);
	memcpy(hv_bank_name.arr,csBankName,hv_bank_name.len);
DEBUGLOG(("GetDetailByRandomWithBankMerchant bank_name = [%.*s]\n",hv_bank_name.len,hv_bank_name.arr));

	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("GetDetailByRandomWithBankMerchant merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_status = PAYOUT_MASTER_TRANSACTION_APPROVED;
DEBUGLOG(("GetDetailByRandomWithBankMerchant status = [%d]\n",hv_status));

	EXEC SQL DECLARE c_cursor_getdetailrbm CURSOR FOR
		select	ud_txn_id,
			ud_batch_id,
			ud_seq_num,
			ud_aux_txn_id,
			ud_merchant_ref,
			ud_country,
			ud_identity_id,
			ud_account_num,
			ud_account_name,
			ud_branch,
			ud_phone_num,
			ud_province,
			ud_city,
			ud_payout_amount,
			ud_request_amount,
			ud_payout_currency,
			ud_request_currency,
			ud_member_fee_ccy,
			ud_member_fee,
			ud_merchant_fee_ccy,
			ud_merchant_fee,
			ud_markup_ccy,
			ud_markup_amt,
			ud_exchange_rate,
			ud_response_code,
			ud_remark,
			ud_batch_mode,
			ud_generated_file_name,
			ud_psp_batch_id,
			ud_fundout_date,
			ud_service_fee
		from	(SELECT * FROM merchant_upload_file_detail ORDER BY dbms_random.value),
			merchant_upload_file_header
		where	ud_bank_name = :hv_bank_name
		and	ud_status = :hv_status
		and	ud_disabled = :hv_disabled
		and	uh_merchant_id = :hv_merchant_id
		and	uh_batch_id = ud_batch_id
		and	ud_batch_mode=:hv_batch_mode
		and	ud_psp_id IS NULL;

	EXEC SQL OPEN  c_cursor_getdetailrbm;
	do{
		EXEC SQL FETCH c_cursor_getdetailrbm
		INTO	:v_txn_id:ind_txn_id,
			:v_batch_id:ind_batch_id,
			:v_seq_num:ind_seq_num,
			:v_aux_txn_seq:ind_aux_txn_seq,
			:v_merchant_ref:ind_merchant_ref,
			:v_country:ind_country,
			:v_identity_id:ind_identity_id,
			:v_account_num:ind_account_num,
			:v_account_name:ind_account_name,
			:v_branch:ind_branch,
			:v_phone_num:ind_phone_num,
			:v_province:ind_province,
			:v_city:ind_city,
			:v_payout_amount:ind_payout_amount,
			:v_request_amount:ind_request_amount,
			:v_payout_ccy:ind_payout_ccy,
			:v_request_ccy:ind_request_ccy,
			:v_member_fee_ccy:ind_member_fee_ccy,
			:v_member_fee:ind_member_fee,
			:v_merchant_fee_ccy:ind_merchant_fee_ccy,
			:v_merchant_fee:ind_merchant_fee,
			:v_markup_ccy:ind_markup_ccy,
			:v_markup_amt:ind_markup_amt,
			:v_ex_rate:ind_ex_rate,
			:v_resp_code:ind_resp_code,
			:v_remark:ind_remark,
			:v_batch_mode:ind_batch_mode,
			:v_file_name:ind_file_name,
			:v_psp_batch_id:ind_psp_batch_id,
			:v_fundout_date:ind_fundout_date,
			:v_service_fee:ind_service_fee;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash,0);

/*batch_id*/
		if(ind_batch_id>=0){
			//PutField_ULong(myHash,"batch_id",v_batch_id);
			sprintf(csBatchId,"%ld",v_batch_id);
DEBUGLOG(("GetDetailByRandomWithBankMerchant batch_id=[%ld]\n",v_batch_id));
			PutField_CString(myHash,"batch_id",csBatchId);
		}

/*seq_num*/
		if(ind_seq_num>=0){
			PutField_Int(myHash,"seq_num",v_seq_num);
DEBUGLOG(("GetDetailByRandomWithBankMerchant seq_num=[%d]\n",v_seq_num));
		}

/*txn_id*/
		if(ind_txn_id>=0){
			v_txn_id.arr[v_txn_id.len]='\0';
			PutField_CString(myHash,"txn_seq",(const char*)v_txn_id.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant txn_id=[%s]\n",v_txn_id.arr));
		}

/*aux_txn_seq*/
		if(ind_aux_txn_seq>=0){
			v_aux_txn_seq.arr[v_aux_txn_seq.len]='\0';
			PutField_CString(myHash,"aux_txn_seq",(const char*)v_aux_txn_seq.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant aux_txn_seq=[%s]\n",v_aux_txn_seq.arr));
		}


/*merchant_ref*/
		if(ind_merchant_ref>=0){
			v_merchant_ref.arr[v_merchant_ref.len]='\0';
			PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant merchant_ref= [%s]\n",v_merchant_ref.arr));
		}

/*country*/
		if(ind_country>=0){
			v_country.arr[v_country.len]='\0';
			PutField_CString(myHash,"txn_country",(const char*)v_country.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant country= [%s]\n",v_country.arr));
		}

/*identity_id*/
		if(ind_identity_id>=0){
			v_identity_id.arr[v_identity_id.len]='\0';
			PutField_CString(myHash,"identity_id",(const char*)v_identity_id.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant identity_id= [%s]\n",v_identity_id.arr));
		}

/*account_num*/
		if(ind_account_num>=0){
			v_account_num.arr[v_account_num.len]='\0';
			PutField_CString(myHash,"account_num",(const char*)v_account_num.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant account_num= [%s]\n",v_account_num.arr));
		}

/*account_name*/
		if(ind_account_name>=0){
			v_account_name.arr[v_account_name.len]='\0';
			PutField_CString(myHash,"account_name",(const char*)v_account_name.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant account_name= [%s]\n",v_account_name.arr));
		}

/*branch*/
		if(ind_branch>=0){
			v_branch.arr[v_branch.len]='\0';
			PutField_CString(myHash,"branch",(const char*)v_branch.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant branch= [%s]\n",v_branch.arr));
		}

/*phone_num*/
		if(ind_phone_num>=0){
			v_phone_num.arr[v_phone_num.len]='\0';
			PutField_CString(myHash,"phone_num",(const char*)v_phone_num.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant phone_num= [%s]\n",v_phone_num.arr));
		}

/*province*/
		if(ind_province>=0){
		v_province.arr[v_province.len]='\0';
		PutField_CString(myHash,"province",(const char*)v_province.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant province= [%s]\n",v_province.arr));
	}

/*city*/
		if(ind_city>=0){
			v_city.arr[v_city.len]='\0';
			PutField_CString(myHash,"city",(const char*)v_city.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant city= [%s]\n",v_city.arr));
		}

/*payout_currency*/
		if(ind_payout_ccy>=0){
			v_payout_ccy.arr[v_payout_ccy.len]='\0';
			PutField_CString(myHash,"payout_ccy",(const char*)v_payout_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant payout_ccy= [%s]\n",v_payout_ccy.arr));
		}

/*request_currency*/
		if(ind_request_ccy>=0){
			v_request_ccy.arr[v_request_ccy.len]='\0';
			PutField_CString(myHash,"request_ccy",(const char*)v_request_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant request_ccy= [%s]\n",v_request_ccy.arr));
		}

/*payout_amount*/
		if(ind_payout_amount>=0){
			PutField_Double(myHash,"payout_amount",v_payout_amount);
DEBUGLOG(("GetDetailByRandomWithBankMerchant payout_amount = [%lf]\n",v_payout_amount));
	}

/*request_amount*/
		if(ind_request_amount>=0){
			PutField_Double(myHash,"request_amount",v_request_amount);
DEBUGLOG(("GetDetailByRandomWithBankMerchant request_amount = [%lf]\n",v_request_amount));
	}

/*member_fee_ccy*/
		if(ind_member_fee_ccy>=0){
			v_member_fee_ccy.arr[v_member_fee_ccy.len]='\0';
			PutField_CString(myHash,"member_fee_ccy",(const char*)v_member_fee_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant member_fee_ccy= [%s]\n",v_member_fee_ccy.arr));
		}

/*member_fee*/
		if(ind_member_fee>=0){
			PutField_Double(myHash,"member_fee",v_member_fee);
DEBUGLOG(("GetDetailByRandomWithBankMerchant member_fee = [%lf]\n",v_member_fee));
		}

/*merchant_fee_ccy*/
		if(ind_merchant_fee_ccy>=0){
			v_merchant_fee_ccy.arr[v_merchant_fee_ccy.len]='\0';
			PutField_CString(myHash,"merchant_fee_ccy",(const char*)v_merchant_fee_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant merchant_fee_ccy= [%s]\n",v_merchant_fee_ccy.arr));
		}

/*merchant_fee*/
		if(ind_merchant_fee>=0){
			PutField_Double(myHash,"merchant_fee",v_merchant_fee);
DEBUGLOG(("GetDetailByRandomWithBankMerchant merchant_fee = [%lf]\n",v_merchant_fee));
		}

/*markup_ccy*/
		if(ind_markup_ccy>=0){
			v_markup_ccy.arr[v_markup_ccy.len]='\0';
			PutField_CString(myHash,"markup_ccy",(const char*)v_markup_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant markup_ccy= [%s]\n",v_markup_ccy.arr));
		}

/*markup_amt*/
		if(ind_markup_amt>=0){
			PutField_Double(myHash,"markup_amt",v_markup_amt);
DEBUGLOG(("GetDetailByRandomWithBankMerchant markup_amt = [%lf]\n",v_markup_amt));
		}

/*ex_rate*/
		if(ind_ex_rate>=0){
			PutField_Double(myHash,"ex_rate",v_ex_rate);
DEBUGLOG(("GetDetailByRandomWithBankMerchant ex_rate = [%lf]\n",v_ex_rate));
		}

/*resp_code*/
		if(ind_resp_code>=0){
			v_resp_code.arr[v_resp_code.len]='\0';
			PutField_CString(myHash,"resp_code",(const char*)v_resp_code.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant resp_code= [%s]\n",v_resp_code.arr));
		}

/*remark*/
		if(ind_remark>=0){
			v_remark.arr[v_remark.len]='\0';
			PutField_CString(myHash,"remark",(const char*)v_remark.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant remark= [%s]\n",v_remark.arr));
		}

/*batch_mode*/
		if(ind_batch_mode>=0){
			PutField_Char(myHash,"batch_mode",v_batch_mode);
DEBUGLOG(("GetDetailByRandomWithBankMerchant batch_mode= [%c]\n",v_batch_mode));
		}

/*file_name*/
		if(ind_file_name>=0){
			v_file_name.arr[v_file_name.len]='\0';
			PutField_CString(myHash,"file_name",(const char*)v_file_name.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant file_name= [%s]\n",v_file_name.arr));
		}

/*psp_batch_id*/	
		if(ind_psp_batch_id>=0){
			v_psp_batch_id.arr[v_psp_batch_id.len]='\0';
			PutField_CString(myHash,"psp_batch_id",(const char*)v_psp_batch_id.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant psp_batch_id= [%s]\n",v_psp_batch_id.arr));
		}

/*fundout_date*/
		if(ind_fundout_date>=0){
			v_fundout_date.arr[v_fundout_date.len]='\0';
			PutField_CString(myHash,"fundout_date",(const char*)v_fundout_date.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant fundout_date= [%s]\n",v_fundout_date.arr));
		}

/*service_fee*/
		if(ind_service_fee>=0){
			PutField_Double(myHash,"service_fee",v_service_fee);
DEBUGLOG(("GetDetailByRandomWithBankMerchant service_fee= [%lf]\n",v_service_fee));
		}

/*psp_id*/	
		if(ind_psp_id>=0){
			v_psp_id.arr[v_psp_id.len]='\0';
			PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetDetailByRandomWithBankMerchant psp_id= [%s]\n",v_psp_id.arr));
		}

		RecordSet_Add(myRec,myHash);

	}while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_getdetailrbm;

DEBUGLOG(("GetDetailByRandomWithBankMerchant Normal Exit\n"));
	return  PD_OK;

getdetailrbm_error:
DEBUGLOG(("getdetailrbm_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MerchantUploadFileDetail_GetWithBankMerchantByRandom: SP_ERR\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_getdetailrbm;
	return PD_ERR;

}


int GetDetailByRandomWithBank(const char* csBankName, recordset_t* myRec)
{
	hash_t *myHash;
	char	csBatchId[PD_TXN_SEQ_LEN+1];

	EXEC SQL WHENEVER SQLERROR GOTO getdetailrb_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		int		hv_disabled;
		varchar         hv_bank_name[PD_BANK_NAME_LEN];
		int		hv_status;
		char		hv_batch_mode;

		varchar		v_txn_id[PD_TXN_SEQ_LEN+1];
		unsigned long   v_batch_id;
		int	        v_seq_num;
		varchar		v_aux_txn_seq[PD_TXN_SEQ_LEN+1];
		varchar         v_merchant_ref[PD_MERCHANT_REF_LEN+1];
		varchar		v_country[PD_COUNTRY_LEN+1];
		varchar         v_identity_id[PD_IDENTITY_ID_LEN+1];
		varchar         v_account_num[PD_AC_NO_LEN+1];
		varchar         v_account_name[PD_ACC_NAME_LEN+1];
		varchar         v_branch[PD_BANK_BRANCH_LEN+1];
		varchar		v_phone_num[PD_MOBILE_NO_LEN+1];
		varchar         v_province[PD_PROVINCE_LEN+1];
		varchar		v_city[PD_CITY_LEN+1];
		varchar		v_payout_ccy[PD_CCY_ID_LEN+1];
		varchar		v_request_ccy[PD_CCY_ID_LEN+1];
		varchar		v_member_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_merchant_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_markup_ccy[PD_CCY_ID_LEN+1];
		double		v_payout_amount;
		double		v_request_amount;
		double		v_member_fee;
		double		v_merchant_fee;
		double		v_markup_amt;
		double		v_ex_rate;
		varchar		v_resp_code[PD_RESPONSE_CODE_LEN+1];
		varchar		v_remark[PD_REMARK_LEN+1];
		char		v_batch_mode;
		varchar		v_file_name[PD_FILENAME_LEN+1];
		varchar		v_psp_batch_id[PD_BATCH_LEN+1];
		varchar		v_fundout_date[PD_DATETIME_LEN+1];
		double		v_service_fee;
		varchar		v_psp_id[PD_PSP_ID_LEN+1];


		short           ind_txn_id = -1;
		short           ind_seq_num = -1;
		short           ind_batch_id = -1;
		short           ind_aux_txn_seq = -1;
		short           ind_merchant_ref = -1;
		short		ind_country = -1;
		short		ind_identity_id = -1;
		short           ind_account_num = -1;
		short           ind_account_name = -1;
		short		ind_branch = -1;
		short           ind_phone_num = -1;
		short		ind_province = -1;
		short		ind_city = -1;
		short		ind_payout_ccy = -1;
		short		ind_request_ccy = -1;
		short           ind_member_fee_ccy = -1;
		short           ind_merchant_fee_ccy = -1;
		short           ind_markup_ccy = -1;
		short           ind_payout_amount = -1;
		short           ind_request_amount = -1;
		short           ind_member_fee = -1;
		short		ind_merchant_fee = -1;
		short           ind_markup_amt = -1;
		short		ind_ex_rate = -1;
		short		ind_resp_code = -1;
		short           ind_remark = -1;
		short		ind_batch_mode = -1;
		short           ind_file_name = -1;
		short           ind_psp_batch_id = -1;
		short           ind_fundout_date = -1;
		short           ind_service_fee = -1;
		short           ind_psp_id = -1;

	EXEC SQL END DECLARE SECTION;

	hv_disabled = 0;
	hv_batch_mode = PD_OFFLINE;

	hv_bank_name.len = strlen(csBankName);
	memcpy(hv_bank_name.arr,csBankName,hv_bank_name.len);
DEBUGLOG(("GetDetailByRandomWithBank bank_name = [%.*s]\n",hv_bank_name.len,hv_bank_name.arr));

	hv_status = PAYOUT_MASTER_TRANSACTION_APPROVED;
DEBUGLOG(("GetDetailByRandomWithBank status = [%d]\n",hv_status));

	EXEC SQL DECLARE c_cursor_getdetailrb CURSOR FOR
		select	ud_txn_id,
			ud_batch_id,
			ud_seq_num,
			ud_aux_txn_id,
			ud_merchant_ref,
			ud_country,
			ud_identity_id,
			ud_account_num,
			ud_account_name,
			ud_branch,
			ud_phone_num,
			ud_province,
			ud_city,
			ud_payout_amount,
			ud_request_amount,
			ud_payout_currency,
			ud_request_currency,
			ud_member_fee_ccy,
			ud_member_fee,
			ud_merchant_fee_ccy,
			ud_merchant_fee,
			ud_markup_ccy,
			ud_markup_amt,
			ud_exchange_rate,
			ud_response_code,
			ud_remark,
			ud_batch_mode,
			ud_generated_file_name,
			ud_psp_batch_id,
			ud_fundout_date,
			ud_service_fee
		from	(SELECT * FROM merchant_upload_file_detail ORDER BY dbms_random.value)
		where	ud_bank_name = :hv_bank_name
		and	ud_status = :hv_status
		and	ud_disabled = :hv_disabled
		and	ud_batch_mode=:hv_batch_mode
		and	ud_psp_id IS NULL;

	EXEC SQL OPEN  c_cursor_getdetailrb;
	do{
		EXEC SQL FETCH c_cursor_getdetailrb
		INTO	:v_txn_id:ind_txn_id,
			:v_batch_id:ind_batch_id,
			:v_seq_num:ind_seq_num,
			:v_aux_txn_seq:ind_aux_txn_seq,
			:v_merchant_ref:ind_merchant_ref,
			:v_country:ind_country,
			:v_identity_id:ind_identity_id,
			:v_account_num:ind_account_num,
			:v_account_name:ind_account_name,
			:v_branch:ind_branch,
			:v_phone_num:ind_phone_num,
			:v_province:ind_province,
			:v_city:ind_city,
			:v_payout_amount:ind_payout_amount,
			:v_request_amount:ind_request_amount,
			:v_payout_ccy:ind_payout_ccy,
			:v_request_ccy:ind_request_ccy,
			:v_member_fee_ccy:ind_member_fee_ccy,
			:v_member_fee:ind_member_fee,
			:v_merchant_fee_ccy:ind_merchant_fee_ccy,
			:v_merchant_fee:ind_merchant_fee,
			:v_markup_ccy:ind_markup_ccy,
			:v_markup_amt:ind_markup_amt,
			:v_ex_rate:ind_ex_rate,
			:v_resp_code:ind_resp_code,
			:v_remark:ind_remark,
			:v_batch_mode:ind_batch_mode,
			:v_file_name:ind_file_name,
			:v_psp_batch_id:ind_psp_batch_id,
			:v_fundout_date:ind_fundout_date,
			:v_service_fee:ind_service_fee;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash,0);

/*batch_id*/
		if(ind_batch_id>=0){
			//PutField_ULong(myHash,"batch_id",v_batch_id);
			sprintf(csBatchId,"%ld",v_batch_id);
DEBUGLOG(("GetDetailByRandomWithBank batch_id=[%ld]\n",v_batch_id));
			PutField_CString(myHash,"batch_id",csBatchId);
		}

/*seq_num*/
		if(ind_seq_num>=0){
			PutField_Int(myHash,"seq_num",v_seq_num);
DEBUGLOG(("GetDetailByRandomWithBank seq_num=[%d]\n",v_seq_num));
		}

/*txn_id*/
		if(ind_txn_id>=0){
			v_txn_id.arr[v_txn_id.len]='\0';
			PutField_CString(myHash,"txn_seq",(const char*)v_txn_id.arr);
DEBUGLOG(("GetDetailByRandomWithBank txn_id=[%s]\n",v_txn_id.arr));
		}

/*aux_txn_seq*/
		if(ind_aux_txn_seq>=0){
			v_aux_txn_seq.arr[v_aux_txn_seq.len]='\0';
			PutField_CString(myHash,"aux_txn_seq",(const char*)v_aux_txn_seq.arr);
DEBUGLOG(("GetDetailByRandomWithBank aux_txn_seq=[%s]\n",v_aux_txn_seq.arr));
		}


/*merchant_ref*/
		if(ind_merchant_ref>=0){
			v_merchant_ref.arr[v_merchant_ref.len]='\0';
			PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetDetailByRandomWithBank merchant_ref= [%s]\n",v_merchant_ref.arr));
		}

/*country*/
		if(ind_country>=0){
			v_country.arr[v_country.len]='\0';
			PutField_CString(myHash,"txn_country",(const char*)v_country.arr);
DEBUGLOG(("GetDetailByRandomWithBank country= [%s]\n",v_country.arr));
		}

/*identity_id*/
		if(ind_identity_id>=0){
			v_identity_id.arr[v_identity_id.len]='\0';
			PutField_CString(myHash,"identity_id",(const char*)v_identity_id.arr);
DEBUGLOG(("GetDetailByRandomWithBank identity_id= [%s]\n",v_identity_id.arr));
		}

/*account_num*/
		if(ind_account_num>=0){
			v_account_num.arr[v_account_num.len]='\0';
			PutField_CString(myHash,"account_num",(const char*)v_account_num.arr);
DEBUGLOG(("GetDetailByRandomWithBank account_num= [%s]\n",v_account_num.arr));
		}

/*account_name*/
		if(ind_account_name>=0){
			v_account_name.arr[v_account_name.len]='\0';
			PutField_CString(myHash,"account_name",(const char*)v_account_name.arr);
DEBUGLOG(("GetDetailByRandomWithBank account_name= [%s]\n",v_account_name.arr));
		}

/*branch*/
		if(ind_branch>=0){
			v_branch.arr[v_branch.len]='\0';
			PutField_CString(myHash,"branch",(const char*)v_branch.arr);
DEBUGLOG(("GetDetailByRandomWithBank branch= [%s]\n",v_branch.arr));
		}

/*phone_num*/
		if(ind_phone_num>=0){
			v_phone_num.arr[v_phone_num.len]='\0';
			PutField_CString(myHash,"phone_num",(const char*)v_phone_num.arr);
DEBUGLOG(("GetDetailByRandomWithBank phone_num= [%s]\n",v_phone_num.arr));
		}

/*province*/
		if(ind_province>=0){
		v_province.arr[v_province.len]='\0';
		PutField_CString(myHash,"province",(const char*)v_province.arr);
DEBUGLOG(("GetDetailByRandomWithBank province= [%s]\n",v_province.arr));
	}

/*city*/
		if(ind_city>=0){
			v_city.arr[v_city.len]='\0';
			PutField_CString(myHash,"city",(const char*)v_city.arr);
DEBUGLOG(("GetDetailByRandomWithBank city= [%s]\n",v_city.arr));
		}

/*payout_currency*/
		if(ind_payout_ccy>=0){
			v_payout_ccy.arr[v_payout_ccy.len]='\0';
			PutField_CString(myHash,"payout_ccy",(const char*)v_payout_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithBank payout_ccy= [%s]\n",v_payout_ccy.arr));
		}

/*request_currency*/
		if(ind_request_ccy>=0){
			v_request_ccy.arr[v_request_ccy.len]='\0';
			PutField_CString(myHash,"request_ccy",(const char*)v_request_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithBank request_ccy= [%s]\n",v_request_ccy.arr));
		}

/*payout_amount*/
		if(ind_payout_amount>=0){
			PutField_Double(myHash,"payout_amount",v_payout_amount);
DEBUGLOG(("GetDetailByRandomWithBank payout_amount = [%lf]\n",v_payout_amount));
	}

/*request_amount*/
		if(ind_request_amount>=0){
			PutField_Double(myHash,"request_amount",v_request_amount);
DEBUGLOG(("GetDetailByRandomWithBank request_amount = [%lf]\n",v_request_amount));
	}

/*member_fee_ccy*/
		if(ind_member_fee_ccy>=0){
			v_member_fee_ccy.arr[v_member_fee_ccy.len]='\0';
			PutField_CString(myHash,"member_fee_ccy",(const char*)v_member_fee_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithBank member_fee_ccy= [%s]\n",v_member_fee_ccy.arr));
		}

/*member_fee*/
		if(ind_member_fee>=0){
			PutField_Double(myHash,"member_fee",v_member_fee);
DEBUGLOG(("GetDetailByRandomWithBank member_fee = [%lf]\n",v_member_fee));
		}

/*merchant_fee_ccy*/
		if(ind_merchant_fee_ccy>=0){
			v_merchant_fee_ccy.arr[v_merchant_fee_ccy.len]='\0';
			PutField_CString(myHash,"merchant_fee_ccy",(const char*)v_merchant_fee_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithBank merchant_fee_ccy= [%s]\n",v_merchant_fee_ccy.arr));
		}

/*merchant_fee*/
		if(ind_merchant_fee>=0){
			PutField_Double(myHash,"merchant_fee",v_merchant_fee);
DEBUGLOG(("GetDetailByRandomWithBank merchant_fee = [%lf]\n",v_merchant_fee));
		}

/*markup_ccy*/
		if(ind_markup_ccy>=0){
			v_markup_ccy.arr[v_markup_ccy.len]='\0';
			PutField_CString(myHash,"markup_ccy",(const char*)v_markup_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithBank markup_ccy= [%s]\n",v_markup_ccy.arr));
		}

/*markup_amt*/
		if(ind_markup_amt>=0){
			PutField_Double(myHash,"markup_amt",v_markup_amt);
DEBUGLOG(("GetDetailByRandomWithBank markup_amt = [%lf]\n",v_markup_amt));
		}

/*ex_rate*/
		if(ind_ex_rate>=0){
			PutField_Double(myHash,"ex_rate",v_ex_rate);
DEBUGLOG(("GetDetailByRandomWithBank ex_rate = [%lf]\n",v_ex_rate));
		}

/*resp_code*/
		if(ind_resp_code>=0){
			v_resp_code.arr[v_resp_code.len]='\0';
			PutField_CString(myHash,"resp_code",(const char*)v_resp_code.arr);
DEBUGLOG(("GetDetailByRandomWithBank resp_code= [%s]\n",v_resp_code.arr));
		}

/*remark*/
		if(ind_remark>=0){
			v_remark.arr[v_remark.len]='\0';
			PutField_CString(myHash,"remark",(const char*)v_remark.arr);
DEBUGLOG(("GetDetailByRandomWithBank remark= [%s]\n",v_remark.arr));
		}

/*batch_mode*/
		if(ind_batch_mode>=0){
			PutField_Char(myHash,"batch_mode",v_batch_mode);
DEBUGLOG(("GetDetailByRandomWithBank batch_mode= [%c]\n",v_batch_mode));
		}

/*file_name*/
		if(ind_file_name>=0){
			v_file_name.arr[v_file_name.len]='\0';
			PutField_CString(myHash,"file_name",(const char*)v_file_name.arr);
DEBUGLOG(("GetDetailByRandomWithBank file_name= [%s]\n",v_file_name.arr));
		}

/*psp_batch_id*/	
		if(ind_psp_batch_id>=0){
			v_psp_batch_id.arr[v_psp_batch_id.len]='\0';
			PutField_CString(myHash,"psp_batch_id",(const char*)v_psp_batch_id.arr);
DEBUGLOG(("GetDetailByRandomWithBank psp_batch_id= [%s]\n",v_psp_batch_id.arr));
		}

/*fundout_date*/
		if(ind_fundout_date>=0){
			v_fundout_date.arr[v_fundout_date.len]='\0';
			PutField_CString(myHash,"fundout_date",(const char*)v_fundout_date.arr);
DEBUGLOG(("GetDetailByRandomWithBank fundout_date= [%s]\n",v_fundout_date.arr));
		}

/*service_fee*/
		if(ind_service_fee>=0){
			PutField_Double(myHash,"service_fee",v_service_fee);
DEBUGLOG(("GetDetailByRandomWithBank service_fee= [%lf]\n",v_service_fee));
		}

/*psp_id*/	
		if(ind_psp_id>=0){
			v_psp_id.arr[v_psp_id.len]='\0';
			PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetDetailByRandomWithBank psp_id= [%s]\n",v_psp_id.arr));
		}

		RecordSet_Add(myRec,myHash);

	}while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_getdetailrb;

DEBUGLOG(("GetDetailByRandomWithBank Normal Exit\n"));
	return  PD_OK;

getdetailrb_error:
DEBUGLOG(("getdetailrb_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MerchantUploadFileDetail_GetWithBankByRandom: SP_ERR\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_getdetailrb;
	return PD_ERR;

}


int GetDetailByRandomWithMerchant(const char* csMerchantId, recordset_t* myRec)
{
	hash_t *myHash;
	char	csBatchId[PD_TXN_SEQ_LEN+1];

	EXEC SQL WHENEVER SQLERROR GOTO getdetailrm_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		int		hv_disabled;
		varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		int		hv_status;
		char		hv_batch_mode;

		varchar		v_txn_id[PD_TXN_SEQ_LEN+1];
		unsigned long   v_batch_id;
		int	        v_seq_num;
		varchar		v_aux_txn_seq[PD_TXN_SEQ_LEN+1];
		varchar         v_merchant_ref[PD_MERCHANT_REF_LEN+1];
		varchar		v_country[PD_COUNTRY_LEN+1];
		varchar         v_identity_id[PD_IDENTITY_ID_LEN+1];
		varchar         v_account_num[PD_AC_NO_LEN+1];
		varchar         v_account_name[PD_ACC_NAME_LEN+1];
		varchar         v_bank_name[PD_BANK_NAME_LEN+1];
		varchar         v_branch[PD_BANK_BRANCH_LEN+1];
		varchar		v_phone_num[PD_MOBILE_NO_LEN+1];
		varchar         v_province[PD_PROVINCE_LEN+1];
		varchar		v_city[PD_CITY_LEN+1];
		varchar		v_payout_ccy[PD_CCY_ID_LEN+1];
		varchar		v_request_ccy[PD_CCY_ID_LEN+1];
		varchar		v_member_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_merchant_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_markup_ccy[PD_CCY_ID_LEN+1];
		double		v_payout_amount;
		double		v_request_amount;
		double		v_member_fee;
		double		v_merchant_fee;
		double		v_markup_amt;
		double		v_ex_rate;
		varchar		v_resp_code[PD_RESPONSE_CODE_LEN+1];
		varchar		v_remark[PD_REMARK_LEN+1];
		char		v_batch_mode;
		varchar		v_file_name[PD_FILENAME_LEN+1];
		varchar		v_psp_batch_id[PD_BATCH_LEN+1];
		varchar		v_fundout_date[PD_DATETIME_LEN+1];
		double		v_service_fee;
		varchar		v_psp_id[PD_PSP_ID_LEN+1];


		short           ind_txn_id = -1;
		short           ind_seq_num = -1;
		short           ind_batch_id = -1;
		short           ind_aux_txn_seq = -1;
		short           ind_merchant_ref = -1;
		short		ind_country = -1;
		short		ind_identity_id = -1;
		short           ind_account_num = -1;
		short           ind_account_name = -1;
		short           ind_bank_name = -1;
		short		ind_branch = -1;
		short           ind_phone_num = -1;
		short		ind_province = -1;
		short		ind_city = -1;
		short		ind_payout_ccy = -1;
		short		ind_request_ccy = -1;
		short           ind_member_fee_ccy = -1;
		short           ind_merchant_fee_ccy = -1;
		short           ind_markup_ccy = -1;
		short           ind_payout_amount = -1;
		short           ind_request_amount = -1;
		short           ind_member_fee = -1;
		short		ind_merchant_fee = -1;
		short           ind_markup_amt = -1;
		short		ind_ex_rate = -1;
		short		ind_resp_code = -1;
		short           ind_remark = -1;
		short		ind_batch_mode = -1;
		short           ind_file_name = -1;
		short           ind_psp_batch_id = -1;
		short           ind_fundout_date = -1;
		short           ind_service_fee = -1;
		short           ind_psp_id = -1;

	EXEC SQL END DECLARE SECTION;

	hv_disabled = 0;
	hv_batch_mode = PD_OFFLINE;

	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("GetDetailByRandomWithMerchant merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_status = PAYOUT_MASTER_TRANSACTION_APPROVED;
DEBUGLOG(("GetDetailByRandomWithMerchant status = [%d]\n",hv_status));

	EXEC SQL DECLARE c_cursor_getdetailrm CURSOR FOR
		select	ud_txn_id,
			ud_batch_id,
			ud_seq_num,
			ud_aux_txn_id,
			ud_merchant_ref,
			ud_country,
			ud_identity_id,
			ud_account_num,
			ud_account_name,
			ud_bank_name,
			ud_branch,
			ud_phone_num,
			ud_province,
			ud_city,
			ud_payout_amount,
			ud_request_amount,
			ud_payout_currency,
			ud_request_currency,
			ud_member_fee_ccy,
			ud_member_fee,
			ud_merchant_fee_ccy,
			ud_merchant_fee,
			ud_markup_ccy,
			ud_markup_amt,
			ud_exchange_rate,
			ud_response_code,
			ud_remark,
			ud_batch_mode,
			ud_generated_file_name,
			ud_psp_batch_id,
			ud_fundout_date,
			ud_service_fee
		from	(SELECT * FROM merchant_upload_file_detail ORDER BY dbms_random.value),
			merchant_upload_file_header
		where	ud_status = :hv_status
		and	ud_disabled = :hv_disabled
		and	uh_merchant_id = :hv_merchant_id
		and	uh_batch_id = ud_batch_id
		and	ud_batch_mode=:hv_batch_mode
		and	ud_psp_id IS NULL;

	EXEC SQL OPEN  c_cursor_getdetailrm;
	do{
		EXEC SQL FETCH c_cursor_getdetailrm
		INTO	:v_txn_id:ind_txn_id,
			:v_batch_id:ind_batch_id,
			:v_seq_num:ind_seq_num,
			:v_aux_txn_seq:ind_aux_txn_seq,
			:v_merchant_ref:ind_merchant_ref,
			:v_country:ind_country,
			:v_identity_id:ind_identity_id,
			:v_account_num:ind_account_num,
			:v_account_name:ind_account_name,
			:v_bank_name:ind_bank_name,
			:v_branch:ind_branch,
			:v_phone_num:ind_phone_num,
			:v_province:ind_province,
			:v_city:ind_city,
			:v_payout_amount:ind_payout_amount,
			:v_request_amount:ind_request_amount,
			:v_payout_ccy:ind_payout_ccy,
			:v_request_ccy:ind_request_ccy,
			:v_member_fee_ccy:ind_member_fee_ccy,
			:v_member_fee:ind_member_fee,
			:v_merchant_fee_ccy:ind_merchant_fee_ccy,
			:v_merchant_fee:ind_merchant_fee,
			:v_markup_ccy:ind_markup_ccy,
			:v_markup_amt:ind_markup_amt,
			:v_ex_rate:ind_ex_rate,
			:v_resp_code:ind_resp_code,
			:v_remark:ind_remark,
			:v_batch_mode:ind_batch_mode,
			:v_file_name:ind_file_name,
			:v_psp_batch_id:ind_psp_batch_id,
			:v_fundout_date:ind_fundout_date,
			:v_service_fee:ind_service_fee;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash,0);

/*batch_id*/
		if(ind_batch_id>=0){
			//PutField_ULong(myHash,"batch_id",v_batch_id);
			sprintf(csBatchId,"%ld",v_batch_id);
DEBUGLOG(("GetDetailByRandomWithMerchant batch_id=[%ld]\n",v_batch_id));
			PutField_CString(myHash,"batch_id",csBatchId);
		}

/*seq_num*/
		if(ind_seq_num>=0){
			PutField_Int(myHash,"seq_num",v_seq_num);
DEBUGLOG(("GetDetailByRandomWithMerchant seq_num=[%d]\n",v_seq_num));
		}

/*txn_id*/
		if(ind_txn_id>=0){
			v_txn_id.arr[v_txn_id.len]='\0';
			PutField_CString(myHash,"txn_seq",(const char*)v_txn_id.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant txn_id=[%s]\n",v_txn_id.arr));
		}

/*aux_txn_seq*/
		if(ind_aux_txn_seq>=0){
			v_aux_txn_seq.arr[v_aux_txn_seq.len]='\0';
			PutField_CString(myHash,"aux_txn_seq",(const char*)v_aux_txn_seq.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant aux_txn_seq=[%s]\n",v_aux_txn_seq.arr));
		}


/*merchant_ref*/
		if(ind_merchant_ref>=0){
			v_merchant_ref.arr[v_merchant_ref.len]='\0';
			PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant merchant_ref= [%s]\n",v_merchant_ref.arr));
		}

/*country*/
		if(ind_country>=0){
			v_country.arr[v_country.len]='\0';
			PutField_CString(myHash,"txn_country",(const char*)v_country.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant country= [%s]\n",v_country.arr));
		}

/*identity_id*/
		if(ind_identity_id>=0){
			v_identity_id.arr[v_identity_id.len]='\0';
			PutField_CString(myHash,"identity_id",(const char*)v_identity_id.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant identity_id= [%s]\n",v_identity_id.arr));
		}

/*account_num*/
		if(ind_account_num>=0){
			v_account_num.arr[v_account_num.len]='\0';
			PutField_CString(myHash,"account_num",(const char*)v_account_num.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant account_num= [%s]\n",v_account_num.arr));
		}

/*account_name*/
		if(ind_account_name>=0){
			v_account_name.arr[v_account_name.len]='\0';
			PutField_CString(myHash,"account_name",(const char*)v_account_name.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant account_name= [%s]\n",v_account_name.arr));
		}

/*bank_name*/
		if(ind_bank_name>=0){
			v_bank_name.arr[v_bank_name.len]='\0';
			PutField_CString(myHash,"bank_name",(const char*)v_bank_name.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant bank_name= [%s]\n",v_bank_name.arr));
	}

/*branch*/
		if(ind_branch>=0){
			v_branch.arr[v_branch.len]='\0';
			PutField_CString(myHash,"branch",(const char*)v_branch.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant branch= [%s]\n",v_branch.arr));
		}

/*phone_num*/
		if(ind_phone_num>=0){
			v_phone_num.arr[v_phone_num.len]='\0';
			PutField_CString(myHash,"phone_num",(const char*)v_phone_num.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant phone_num= [%s]\n",v_phone_num.arr));
		}

/*province*/
		if(ind_province>=0){
		v_province.arr[v_province.len]='\0';
		PutField_CString(myHash,"province",(const char*)v_province.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant province= [%s]\n",v_province.arr));
	}

/*city*/
		if(ind_city>=0){
			v_city.arr[v_city.len]='\0';
			PutField_CString(myHash,"city",(const char*)v_city.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant city= [%s]\n",v_city.arr));
		}

/*payout_currency*/
		if(ind_payout_ccy>=0){
			v_payout_ccy.arr[v_payout_ccy.len]='\0';
			PutField_CString(myHash,"payout_ccy",(const char*)v_payout_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant payout_ccy= [%s]\n",v_payout_ccy.arr));
		}

/*request_currency*/
		if(ind_request_ccy>=0){
			v_request_ccy.arr[v_request_ccy.len]='\0';
			PutField_CString(myHash,"request_ccy",(const char*)v_request_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant request_ccy= [%s]\n",v_request_ccy.arr));
		}

/*payout_amount*/
		if(ind_payout_amount>=0){
			PutField_Double(myHash,"payout_amount",v_payout_amount);
DEBUGLOG(("GetDetailByRandomWithMerchant payout_amount = [%lf]\n",v_payout_amount));
	}

/*request_amount*/
		if(ind_request_amount>=0){
			PutField_Double(myHash,"request_amount",v_request_amount);
DEBUGLOG(("GetDetailByRandomWithMerchant request_amount = [%lf]\n",v_request_amount));
	}

/*member_fee_ccy*/
		if(ind_member_fee_ccy>=0){
			v_member_fee_ccy.arr[v_member_fee_ccy.len]='\0';
			PutField_CString(myHash,"member_fee_ccy",(const char*)v_member_fee_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant member_fee_ccy= [%s]\n",v_member_fee_ccy.arr));
		}

/*member_fee*/
		if(ind_member_fee>=0){
			PutField_Double(myHash,"member_fee",v_member_fee);
DEBUGLOG(("GetDetailByRandomWithMerchant member_fee = [%lf]\n",v_member_fee));
		}

/*merchant_fee_ccy*/
		if(ind_merchant_fee_ccy>=0){
			v_merchant_fee_ccy.arr[v_merchant_fee_ccy.len]='\0';
			PutField_CString(myHash,"merchant_fee_ccy",(const char*)v_merchant_fee_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant merchant_fee_ccy= [%s]\n",v_merchant_fee_ccy.arr));
		}

/*merchant_fee*/
		if(ind_merchant_fee>=0){
			PutField_Double(myHash,"merchant_fee",v_merchant_fee);
DEBUGLOG(("GetDetailByRandomWithMerchant merchant_fee = [%lf]\n",v_merchant_fee));
		}

/*markup_ccy*/
		if(ind_markup_ccy>=0){
			v_markup_ccy.arr[v_markup_ccy.len]='\0';
			PutField_CString(myHash,"markup_ccy",(const char*)v_markup_ccy.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant markup_ccy= [%s]\n",v_markup_ccy.arr));
		}

/*markup_amt*/
		if(ind_markup_amt>=0){
			PutField_Double(myHash,"markup_amt",v_markup_amt);
DEBUGLOG(("GetDetailByRandomWithMerchant markup_amt = [%lf]\n",v_markup_amt));
		}

/*ex_rate*/
		if(ind_ex_rate>=0){
			PutField_Double(myHash,"ex_rate",v_ex_rate);
DEBUGLOG(("GetDetailByRandomWithMerchant ex_rate = [%lf]\n",v_ex_rate));
		}

/*resp_code*/
		if(ind_resp_code>=0){
			v_resp_code.arr[v_resp_code.len]='\0';
			PutField_CString(myHash,"resp_code",(const char*)v_resp_code.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant resp_code= [%s]\n",v_resp_code.arr));
		}

/*remark*/
		if(ind_remark>=0){
			v_remark.arr[v_remark.len]='\0';
			PutField_CString(myHash,"remark",(const char*)v_remark.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant remark= [%s]\n",v_remark.arr));
		}

/*batch_mode*/
		if(ind_batch_mode>=0){
			PutField_Char(myHash,"batch_mode",v_batch_mode);
DEBUGLOG(("GetDetailByRandomWithMerchant batch_mode= [%c]\n",v_batch_mode));
		}

/*file_name*/
		if(ind_file_name>=0){
			v_file_name.arr[v_file_name.len]='\0';
			PutField_CString(myHash,"file_name",(const char*)v_file_name.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant file_name= [%s]\n",v_file_name.arr));
		}

/*psp_batch_id*/	
		if(ind_psp_batch_id>=0){
			v_psp_batch_id.arr[v_psp_batch_id.len]='\0';
			PutField_CString(myHash,"psp_batch_id",(const char*)v_psp_batch_id.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant psp_batch_id= [%s]\n",v_psp_batch_id.arr));
		}

/*fundout_date*/
		if(ind_fundout_date>=0){
			v_fundout_date.arr[v_fundout_date.len]='\0';
			PutField_CString(myHash,"fundout_date",(const char*)v_fundout_date.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant fundout_date= [%s]\n",v_fundout_date.arr));
		}

/*service_fee*/
		if(ind_service_fee>=0){
			PutField_Double(myHash,"service_fee",v_service_fee);
DEBUGLOG(("GetDetailByRandomWithMerchant service_fee= [%lf]\n",v_service_fee));
		}

/*psp_id*/	
		if(ind_psp_id>=0){
			v_psp_id.arr[v_psp_id.len]='\0';
			PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetDetailByRandomWithMerchant psp_id= [%s]\n",v_psp_id.arr));
		}

		RecordSet_Add(myRec,myHash);

	}while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_getdetailrm;

DEBUGLOG(("GetDetailByRandomWithMerchant Normal Exit\n"));
	return  PD_OK;

getdetailrm_error:
DEBUGLOG(("getdetailrm_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MerchantUploadFileDetail_GetWithMerchantByRandom: SP_ERR\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_getdetailrm;
	return PD_ERR;

}

int GetDetailByRandom(recordset_t* myRec)
{
	hash_t *myHash;
	char	csBatchId[PD_TXN_SEQ_LEN+1];

	EXEC SQL WHENEVER SQLERROR GOTO getdetailr_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		int		hv_disabled;
		int		hv_status;
		char		hv_batch_mode;

		varchar		v_txn_id[PD_TXN_SEQ_LEN+1];
		unsigned long   v_batch_id;
		int	        v_seq_num;
		varchar		v_aux_txn_seq[PD_TXN_SEQ_LEN+1];
		varchar         v_merchant_ref[PD_MERCHANT_REF_LEN+1];
		varchar		v_country[PD_COUNTRY_LEN+1];
		varchar         v_identity_id[PD_IDENTITY_ID_LEN+1];
		varchar         v_account_num[PD_AC_NO_LEN+1];
		varchar         v_account_name[PD_ACC_NAME_LEN+1];
		varchar         v_bank_name[PD_BANK_NAME_LEN+1];
		varchar         v_branch[PD_BANK_BRANCH_LEN+1];
		varchar		v_phone_num[PD_MOBILE_NO_LEN+1];
		varchar         v_province[PD_PROVINCE_LEN+1];
		varchar		v_city[PD_CITY_LEN+1];
		varchar		v_payout_ccy[PD_CCY_ID_LEN+1];
		varchar		v_request_ccy[PD_CCY_ID_LEN+1];
		varchar		v_member_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_merchant_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_markup_ccy[PD_CCY_ID_LEN+1];
		double		v_payout_amount;
		double		v_request_amount;
		double		v_member_fee;
		double		v_merchant_fee;
		double		v_markup_amt;
		double		v_ex_rate;
		varchar		v_resp_code[PD_RESPONSE_CODE_LEN+1];
		varchar		v_remark[PD_REMARK_LEN+1];
		char		v_batch_mode;
		varchar		v_file_name[PD_FILENAME_LEN+1];
		varchar		v_psp_batch_id[PD_BATCH_LEN+1];
		varchar		v_fundout_date[PD_DATETIME_LEN+1];
		double		v_service_fee;
		varchar		v_psp_id[PD_PSP_ID_LEN+1];


		short           ind_txn_id = -1;
		short           ind_seq_num = -1;
		short           ind_batch_id = -1;
		short           ind_aux_txn_seq = -1;
		short           ind_merchant_ref = -1;
		short		ind_country = -1;
		short		ind_identity_id = -1;
		short           ind_account_num = -1;
		short           ind_account_name = -1;
		short		ind_bank_name = -1;
		short		ind_branch = -1;
		short           ind_phone_num = -1;
		short		ind_province = -1;
		short		ind_city = -1;
		short		ind_payout_ccy = -1;
		short		ind_request_ccy = -1;
		short           ind_member_fee_ccy = -1;
		short           ind_merchant_fee_ccy = -1;
		short           ind_markup_ccy = -1;
		short           ind_payout_amount = -1;
		short           ind_request_amount = -1;
		short           ind_member_fee = -1;
		short		ind_merchant_fee = -1;
		short           ind_markup_amt = -1;
		short		ind_ex_rate = -1;
		short		ind_resp_code = -1;
		short           ind_remark = -1;
		short		ind_batch_mode = -1;
		short           ind_file_name = -1;
		short           ind_psp_batch_id = -1;
		short           ind_fundout_date = -1;
		short           ind_service_fee = -1;
		short           ind_psp_id = -1;

	EXEC SQL END DECLARE SECTION;

	hv_disabled = 0;
	hv_batch_mode = PD_OFFLINE;

	hv_status = PAYOUT_MASTER_TRANSACTION_APPROVED;
DEBUGLOG(("GetDetailByRandom status = [%d]\n",hv_status));

	EXEC SQL DECLARE c_cursor_getdetailr CURSOR FOR
		select	ud_txn_id,
			ud_batch_id,
			ud_seq_num,
			ud_aux_txn_id,
			ud_merchant_ref,
			ud_country,
			ud_identity_id,
			ud_account_num,
			ud_account_name,
			ud_bank_name,
			ud_branch,
			ud_phone_num,
			ud_province,
			ud_city,
			ud_payout_amount,
			ud_request_amount,
			ud_payout_currency,
			ud_request_currency,
			ud_member_fee_ccy,
			ud_member_fee,
			ud_merchant_fee_ccy,
			ud_merchant_fee,
			ud_markup_ccy,
			ud_markup_amt,
			ud_exchange_rate,
			ud_response_code,
			ud_remark,
			ud_batch_mode,
			ud_generated_file_name,
			ud_psp_batch_id,
			ud_fundout_date,
			ud_service_fee
		from	(SELECT * FROM merchant_upload_file_detail ORDER BY dbms_random.value)
		where	ud_status = :hv_status
		and	ud_disabled = :hv_disabled
		and	ud_batch_mode=:hv_batch_mode
		and	ud_psp_id IS NULL;

	EXEC SQL OPEN  c_cursor_getdetailr;
	do{
		EXEC SQL FETCH c_cursor_getdetailr
		INTO	:v_txn_id:ind_txn_id,
			:v_batch_id:ind_batch_id,
			:v_seq_num:ind_seq_num,
			:v_aux_txn_seq:ind_aux_txn_seq,
			:v_merchant_ref:ind_merchant_ref,
			:v_country:ind_country,
			:v_identity_id:ind_identity_id,
			:v_account_num:ind_account_num,
			:v_account_name:ind_account_name,
			:v_bank_name:ind_bank_name,
			:v_branch:ind_branch,
			:v_phone_num:ind_phone_num,
			:v_province:ind_province,
			:v_city:ind_city,
			:v_payout_amount:ind_payout_amount,
			:v_request_amount:ind_request_amount,
			:v_payout_ccy:ind_payout_ccy,
			:v_request_ccy:ind_request_ccy,
			:v_member_fee_ccy:ind_member_fee_ccy,
			:v_member_fee:ind_member_fee,
			:v_merchant_fee_ccy:ind_merchant_fee_ccy,
			:v_merchant_fee:ind_merchant_fee,
			:v_markup_ccy:ind_markup_ccy,
			:v_markup_amt:ind_markup_amt,
			:v_ex_rate:ind_ex_rate,
			:v_resp_code:ind_resp_code,
			:v_remark:ind_remark,
			:v_batch_mode:ind_batch_mode,
			:v_file_name:ind_file_name,
			:v_psp_batch_id:ind_psp_batch_id,
			:v_fundout_date:ind_fundout_date,
			:v_service_fee:ind_service_fee;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash,0);

/*batch_id*/
		if(ind_batch_id>=0){
			//PutField_ULong(myHash,"batch_id",v_batch_id);
			sprintf(csBatchId,"%ld",v_batch_id);
DEBUGLOG(("GetDetailByRandom batch_id=[%ld]\n",v_batch_id));
			PutField_CString(myHash,"batch_id",csBatchId);
		}

/*seq_num*/
		if(ind_seq_num>=0){
			PutField_Int(myHash,"seq_num",v_seq_num);
DEBUGLOG(("GetDetailByRandom seq_num=[%d]\n",v_seq_num));
		}

/*txn_id*/
		if(ind_txn_id>=0){
			v_txn_id.arr[v_txn_id.len]='\0';
			PutField_CString(myHash,"txn_seq",(const char*)v_txn_id.arr);
DEBUGLOG(("GetDetailByRandom txn_id=[%s]\n",v_txn_id.arr));
		}

/*aux_txn_seq*/
		if(ind_aux_txn_seq>=0){
			v_aux_txn_seq.arr[v_aux_txn_seq.len]='\0';
			PutField_CString(myHash,"aux_txn_seq",(const char*)v_aux_txn_seq.arr);
DEBUGLOG(("GetDetailByRandom aux_txn_seq=[%s]\n",v_aux_txn_seq.arr));
		}


/*merchant_ref*/
		if(ind_merchant_ref>=0){
			v_merchant_ref.arr[v_merchant_ref.len]='\0';
			PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetDetailByRandom merchant_ref= [%s]\n",v_merchant_ref.arr));
		}

/*country*/
		if(ind_country>=0){
			v_country.arr[v_country.len]='\0';
			PutField_CString(myHash,"txn_country",(const char*)v_country.arr);
DEBUGLOG(("GetDetailByRandom country= [%s]\n",v_country.arr));
		}

/*identity_id*/
		if(ind_identity_id>=0){
			v_identity_id.arr[v_identity_id.len]='\0';
			PutField_CString(myHash,"identity_id",(const char*)v_identity_id.arr);
DEBUGLOG(("GetDetailByRandom identity_id= [%s]\n",v_identity_id.arr));
		}

/*account_num*/
		if(ind_account_num>=0){
			v_account_num.arr[v_account_num.len]='\0';
			PutField_CString(myHash,"account_num",(const char*)v_account_num.arr);
DEBUGLOG(("GetDetailByRandom account_num= [%s]\n",v_account_num.arr));
		}

/*account_name*/
		if(ind_account_name>=0){
			v_account_name.arr[v_account_name.len]='\0';
			PutField_CString(myHash,"account_name",(const char*)v_account_name.arr);
DEBUGLOG(("GetDetailByRandom account_name= [%s]\n",v_account_name.arr));
		}

/*bank_name*/
		if(ind_bank_name>=0){
			v_bank_name.arr[v_bank_name.len]='\0';
			PutField_CString(myHash,"bank_name",(const char*)v_bank_name.arr);
DEBUGLOG(("GetDetailByRandom bank_name= [%s]\n",v_bank_name.arr));
	}


/*branch*/
		if(ind_branch>=0){
			v_branch.arr[v_branch.len]='\0';
			PutField_CString(myHash,"branch",(const char*)v_branch.arr);
DEBUGLOG(("GetDetailByRandom branch= [%s]\n",v_branch.arr));
		}

/*phone_num*/
		if(ind_phone_num>=0){
			v_phone_num.arr[v_phone_num.len]='\0';
			PutField_CString(myHash,"phone_num",(const char*)v_phone_num.arr);
DEBUGLOG(("GetDetailByRandom phone_num= [%s]\n",v_phone_num.arr));
		}

/*province*/
		if(ind_province>=0){
		v_province.arr[v_province.len]='\0';
		PutField_CString(myHash,"province",(const char*)v_province.arr);
DEBUGLOG(("GetDetailByRandom province= [%s]\n",v_province.arr));
	}

/*city*/
		if(ind_city>=0){
			v_city.arr[v_city.len]='\0';
			PutField_CString(myHash,"city",(const char*)v_city.arr);
DEBUGLOG(("GetDetailByRandom city= [%s]\n",v_city.arr));
		}

/*payout_currency*/
		if(ind_payout_ccy>=0){
			v_payout_ccy.arr[v_payout_ccy.len]='\0';
			PutField_CString(myHash,"payout_ccy",(const char*)v_payout_ccy.arr);
DEBUGLOG(("GetDetailByRandom payout_ccy= [%s]\n",v_payout_ccy.arr));
		}

/*request_currency*/
		if(ind_request_ccy>=0){
			v_request_ccy.arr[v_request_ccy.len]='\0';
			PutField_CString(myHash,"request_ccy",(const char*)v_request_ccy.arr);
DEBUGLOG(("GetDetailByRandom request_ccy= [%s]\n",v_request_ccy.arr));
		}

/*payout_amount*/
		if(ind_payout_amount>=0){
			PutField_Double(myHash,"payout_amount",v_payout_amount);
DEBUGLOG(("GetDetailByRandom payout_amount = [%lf]\n",v_payout_amount));
	}

/*request_amount*/
		if(ind_request_amount>=0){
			PutField_Double(myHash,"request_amount",v_request_amount);
DEBUGLOG(("GetDetailByRandom request_amount = [%lf]\n",v_request_amount));
	}

/*member_fee_ccy*/
		if(ind_member_fee_ccy>=0){
			v_member_fee_ccy.arr[v_member_fee_ccy.len]='\0';
			PutField_CString(myHash,"member_fee_ccy",(const char*)v_member_fee_ccy.arr);
DEBUGLOG(("GetDetailByRandom member_fee_ccy= [%s]\n",v_member_fee_ccy.arr));
		}

/*member_fee*/
		if(ind_member_fee>=0){
			PutField_Double(myHash,"member_fee",v_member_fee);
DEBUGLOG(("GetDetailByRandom member_fee = [%lf]\n",v_member_fee));
		}

/*merchant_fee_ccy*/
		if(ind_merchant_fee_ccy>=0){
			v_merchant_fee_ccy.arr[v_merchant_fee_ccy.len]='\0';
			PutField_CString(myHash,"merchant_fee_ccy",(const char*)v_merchant_fee_ccy.arr);
DEBUGLOG(("GetDetailByRandom merchant_fee_ccy= [%s]\n",v_merchant_fee_ccy.arr));
		}

/*merchant_fee*/
		if(ind_merchant_fee>=0){
			PutField_Double(myHash,"merchant_fee",v_merchant_fee);
DEBUGLOG(("GetDetailByRandom merchant_fee = [%lf]\n",v_merchant_fee));
		}

/*markup_ccy*/
		if(ind_markup_ccy>=0){
			v_markup_ccy.arr[v_markup_ccy.len]='\0';
			PutField_CString(myHash,"markup_ccy",(const char*)v_markup_ccy.arr);
DEBUGLOG(("GetDetailByRandom markup_ccy= [%s]\n",v_markup_ccy.arr));
		}

/*markup_amt*/
		if(ind_markup_amt>=0){
			PutField_Double(myHash,"markup_amt",v_markup_amt);
DEBUGLOG(("GetDetailByRandom markup_amt = [%lf]\n",v_markup_amt));
		}

/*ex_rate*/
		if(ind_ex_rate>=0){
			PutField_Double(myHash,"ex_rate",v_ex_rate);
DEBUGLOG(("GetDetailByRandom ex_rate = [%lf]\n",v_ex_rate));
		}

/*resp_code*/
		if(ind_resp_code>=0){
			v_resp_code.arr[v_resp_code.len]='\0';
			PutField_CString(myHash,"resp_code",(const char*)v_resp_code.arr);
DEBUGLOG(("GetDetailByRandom resp_code= [%s]\n",v_resp_code.arr));
		}

/*remark*/
		if(ind_remark>=0){
			v_remark.arr[v_remark.len]='\0';
			PutField_CString(myHash,"remark",(const char*)v_remark.arr);
DEBUGLOG(("GetDetailByRandom remark= [%s]\n",v_remark.arr));
		}

/*batch_mode*/
		if(ind_batch_mode>=0){
			PutField_Char(myHash,"batch_mode",v_batch_mode);
DEBUGLOG(("GetDetailByRandom batch_mode= [%c]\n",v_batch_mode));
		}

/*file_name*/
		if(ind_file_name>=0){
			v_file_name.arr[v_file_name.len]='\0';
			PutField_CString(myHash,"file_name",(const char*)v_file_name.arr);
DEBUGLOG(("GetDetailByRandom file_name= [%s]\n",v_file_name.arr));
		}

/*psp_batch_id*/	
		if(ind_psp_batch_id>=0){
			v_psp_batch_id.arr[v_psp_batch_id.len]='\0';
			PutField_CString(myHash,"psp_batch_id",(const char*)v_psp_batch_id.arr);
DEBUGLOG(("GetDetailByRandom psp_batch_id= [%s]\n",v_psp_batch_id.arr));
		}

/*fundout_date*/
		if(ind_fundout_date>=0){
			v_fundout_date.arr[v_fundout_date.len]='\0';
			PutField_CString(myHash,"fundout_date",(const char*)v_fundout_date.arr);
DEBUGLOG(("GetDetailByRandom fundout_date= [%s]\n",v_fundout_date.arr));
		}

/*service_fee*/
		if(ind_service_fee>=0){
			PutField_Double(myHash,"service_fee",v_service_fee);
DEBUGLOG(("GetDetailByRandom service_fee= [%lf]\n",v_service_fee));
		}

/*psp_id*/	
		if(ind_psp_id>=0){
			v_psp_id.arr[v_psp_id.len]='\0';
			PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetDetailByRandom psp_id= [%s]\n",v_psp_id.arr));
		}

		RecordSet_Add(myRec,myHash);

	}while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_getdetailr;

DEBUGLOG(("GetDetailByRandom Normal Exit\n"));
	return  PD_OK;

getdetailr_error:
DEBUGLOG(("getdetailr_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MerchantUploadFileDetail_GetWithBankByRandom: SP_ERR\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_getdetailr;
	return PD_ERR;

}



int MatchCount(const unsigned long lBatchId,const int iStatus)
{
	int iRet = PD_FALSE;
        EXEC SQL WHENEVER SQLERROR GOTO check_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                unsigned long   hv_batch_id;
		int		hv_status;
		int		hv_void_status;

		short		v_cnt;
		short		v_void_cnt;
		short		v_org_cnt;

		short		ind_org_cnt = -1;

        EXEC SQL END DECLARE SECTION;

        hv_batch_id = lBatchId;
DEBUGLOG(("MatchCount batch_id= [%ld]\n",hv_batch_id));

	hv_void_status = PAYOUT_MASTER_TRANSACTION_REVERSED;

	hv_status = iStatus;
DEBUGLOG(("MatchCount status= [%d]\n",hv_status));

        EXEC SQL SELECT nvl(COUNT(*),0)
                INTO    :v_cnt
                FROM    merchant_upload_file_detail
                WHERE   ud_batch_id = :hv_batch_id
                and     ud_status = :hv_status;

        EXEC SQL SELECT nvl(COUNT(*),0)
                INTO    :v_void_cnt
                FROM    merchant_upload_file_detail
                WHERE   ud_batch_id = :hv_batch_id
                and     ud_status = :hv_void_status;

        EXEC SQL SELECT	uh_txn_count
                INTO    :v_org_cnt:ind_org_cnt
                FROM    merchant_upload_file_header
                WHERE   uh_batch_id = :hv_batch_id;

	if(ind_org_cnt>=0){
		if((v_cnt+v_void_cnt)==v_org_cnt){
DEBUGLOG(("MatchCount Matched[%d][%d][%d]\n",v_cnt,v_void_cnt,v_org_cnt));
			iRet = PD_TRUE;
		}
		else{
DEBUGLOG(("MatchCount Not Matched[%d][%d][%d]\n",v_cnt,v_void_cnt,v_org_cnt));
		}
        }
	else{
		iRet = PD_NOT_FOUND;
DEBUGLOG(("MatchCount Not Found in header\n"));
	}


	return iRet;

check_error:
DEBUGLOG(("check_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}



int ResumeAssignedPsp()
{
	char*   csBuf;

	EXEC SQL WHENEVER SQLERROR GOTO resume_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_dynstmt[1024];

	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("ResumeAssignedPsp: Begin\n"));
        csBuf = (char*) malloc (128);
        strcpy((char*)hv_dynstmt.arr,"update merchant_upload_file_detail set ud_psp_id ='' ");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        

        strcat((char*)hv_dynstmt.arr, " WHERE ud_status = 65 and ud_batch_mode = 'F' and ud_psp_id IS NOT NULL");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);

DEBUGLOG(("ResumeAssignedPsp Normal Exit\n"));
        return PD_OK;

resume_error:
DEBUGLOG(("resume_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MerchantUploadFileDetail_ResumeAssignedPsp: SP_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_INTERNAL_ERR;
}



int ResumePreGenFile(const char*csFileId)
{
	char*   csBuf;

	EXEC SQL WHENEVER SQLERROR GOTO resumefile_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_dynstmt[1024];

	EXEC SQL END DECLARE SECTION;


DEBUGLOG(("ResumePreGenFile: Begin\n"));
        csBuf = (char*) malloc (128);
        strcpy((char*)hv_dynstmt.arr,"update merchant_upload_file_detail set ud_psp_id ='',ud_generated_file_name='', ud_generated_file_id='' ");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);        

        strcat((char*)hv_dynstmt.arr, " WHERE ud_generated_file_id = ");
        strcat((char*)hv_dynstmt.arr, csFileId);
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);

DEBUGLOG(("ResumePreGenFile Normal Exit\n"));
        return PD_OK;

resumefile_error:
DEBUGLOG(("resumefile_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MerchantUploadFileDetail_ResumePreGenFile: SP_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_INTERNAL_ERR;
}


int GetOnlineBatchRecord(recordset_t* myRec)
{
	hash_t *myHash;
	EXEC SQL WHENEVER SQLERROR GOTO getonpayout_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		int		hv_status;
		char		hv_batch_mode;
		int		hv_disabled;

		varchar		v_batch_id[PD_TXN_SEQ_LEN+1];
		int	        v_seq_num;
		varchar		v_merchant_id[PD_MERCHANT_ID_LEN+1];
		varchar		v_txn_id[PD_TXN_SEQ_LEN+1];
		varchar		v_aux_txn_seq[PD_TXN_SEQ_LEN+1];
		varchar         v_merchant_ref[PD_MERCHANT_REF_LEN+1];
		varchar		v_country[PD_COUNTRY_LEN+1];
		varchar         v_identity_id[PD_IDENTITY_ID_LEN+1];
		varchar         v_account_num[PD_AC_NO_LEN+1];
		varchar         v_account_name[PD_ACC_NAME_LEN+1];
		varchar         v_bank_name[PD_BANK_NAME_LEN+1];
		varchar         v_bank_code[PD_BANK_CODE_LEN+1];
		varchar         v_branch[PD_BANK_BRANCH_LEN+1];
		varchar		v_phone_num[PD_MOBILE_NO_LEN+1];
		varchar         v_province[PD_PROVINCE_LEN+1];
		varchar		v_city[PD_CITY_LEN+1];
		varchar		v_payout_ccy[PD_CCY_ID_LEN+1];
		varchar		v_request_ccy[PD_CCY_ID_LEN+1];
		varchar		v_member_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_merchant_fee_ccy[PD_CCY_ID_LEN+1];
		varchar		v_markup_ccy[PD_CCY_ID_LEN+1];
		double		v_payout_amount;
		double		v_request_amount;
		double		v_member_fee;
		double		v_merchant_fee;
		double		v_markup_amt;
		double		v_ex_rate;
		varchar		v_resp_code[PD_RESPONSE_CODE_LEN+1];
		varchar		v_remark[PD_REMARK_LEN+1];
		varchar		v_file_name[PD_FILENAME_LEN+1];
		varchar		v_psp_batch_id[PD_BATCH_LEN+1];
		varchar		v_fundout_date[PD_DATETIME_LEN+1];
		varchar		v_psp_id[PD_PSP_ID_LEN+1];
		double		v_service_fee;


		short           ind_batch_id = -1;
		short           ind_seq_num = -1;
		short           ind_merchant_id = -1;
		short           ind_txn_id = -1;
		short           ind_aux_txn_seq = -1;
		short           ind_merchant_ref = -1;
		short		ind_country = -1;
		short		ind_identity_id = -1;
		short           ind_account_num = -1;
		short           ind_account_name = -1;
		short           ind_bank_name = -1;
		short           ind_bank_code = -1;
		short		ind_branch = -1;
		short           ind_phone_num = -1;
		short		ind_province = -1;
		short		ind_city = -1;
		short		ind_payout_ccy = -1;
		short		ind_request_ccy = -1;
		short           ind_member_fee_ccy = -1;
		short           ind_merchant_fee_ccy = -1;
		short           ind_markup_ccy = -1;
		short           ind_payout_amount = -1;
		short           ind_request_amount = -1;
		short           ind_member_fee = -1;
		short		ind_merchant_fee = -1;
		short           ind_markup_amt = -1;
		short		ind_ex_rate = -1;
		short		ind_resp_code = -1;
		short           ind_remark = -1;
		short           ind_file_name = -1;
		short           ind_psp_batch_id = -1;
		short           ind_psp_id = -1;
		short           ind_fundout_date = -1;
		short           ind_service_fee = -1;

	EXEC SQL END DECLARE SECTION;

	hv_disabled = 0;
	hv_status = PAYOUT_MASTER_TRANSACTION_APPROVED;
	hv_batch_mode = PD_ONLINE;

	EXEC SQL DECLARE c_cursor_getonpayout CURSOR FOR
		select	ud_batch_id,
			ud_seq_num,
			uh_merchant_id,
			ud_txn_id,
			ud_aux_txn_id,
			ud_merchant_ref,
			ud_country,
			ud_identity_id,
			ud_account_num,
			ud_account_name,
			ud_bank_name,
			ud_bank_code,
			ud_branch,
			ud_phone_num,
			ud_province,
			ud_city,
			ud_payout_amount,
			ud_request_amount,
			ud_payout_currency,
			ud_request_currency,
			ud_member_fee_ccy,
			ud_member_fee,
			ud_merchant_fee_ccy,
			ud_merchant_fee,
			ud_markup_ccy,
			ud_markup_amt,
			ud_exchange_rate,
			ud_response_code,
			ud_remark,
			ud_generated_file_name,
			ud_psp_batch_id,
			ud_fundout_date,
			ud_service_fee,
			ud_psp_id
		from	merchant_upload_file_detail,
			merchant_upload_file_header
		where	ud_batch_id = uh_batch_id
		and	ud_disabled = :hv_disabled
		and	uh_disabled = :hv_disabled
		and	ud_batch_mode = :hv_batch_mode
		and	ud_status = :hv_status
		order by ud_batch_id, ud_seq_num;

	EXEC SQL OPEN  c_cursor_getonpayout;
	do{
		EXEC SQL FETCH c_cursor_getonpayout
		INTO	:v_batch_id:ind_batch_id,
			:v_seq_num:ind_seq_num,
			:v_merchant_id:ind_merchant_id,
			:v_txn_id:ind_txn_id,
			:v_aux_txn_seq:ind_aux_txn_seq,
			:v_merchant_ref:ind_merchant_ref,
			:v_country:ind_country,
			:v_identity_id:ind_identity_id,
			:v_account_num:ind_account_num,
			:v_account_name:ind_account_name,
			:v_bank_name:ind_bank_name,
			:v_bank_code:ind_bank_code,
			:v_branch:ind_branch,
			:v_phone_num:ind_phone_num,
			:v_province:ind_province,
			:v_city:ind_city,
			:v_payout_amount:ind_payout_amount,
			:v_request_amount:ind_request_amount,
			:v_payout_ccy:ind_payout_ccy,
			:v_request_ccy:ind_request_ccy,
			:v_member_fee_ccy:ind_member_fee_ccy,
			:v_member_fee:ind_member_fee,
			:v_merchant_fee_ccy:ind_merchant_fee_ccy,
			:v_merchant_fee:ind_merchant_fee,
			:v_markup_ccy:ind_markup_ccy,
			:v_markup_amt:ind_markup_amt,
			:v_ex_rate:ind_ex_rate,
			:v_resp_code:ind_resp_code,
			:v_remark:ind_remark,
			:v_file_name:ind_file_name,
			:v_psp_batch_id:ind_psp_batch_id,
			:v_fundout_date:ind_fundout_date,
			:v_service_fee:ind_service_fee,
			:v_psp_id:ind_psp_id;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash,0);

/*seq_num*/
		if(ind_seq_num>=0){
			PutField_Int(myHash,"seq_num",v_seq_num);
DEBUGLOG(("GetOnlineBatchRecord seq_num=[%d]\n",v_seq_num));
		}

/*batch_id*/
		if(ind_batch_id>=0){
			v_batch_id.arr[v_batch_id.len]='\0';
			PutField_CString(myHash,"batch_id",(const char*)v_batch_id.arr);
DEBUGLOG(("GetOnlineBatchRecord batch_id=[%s]\n",v_batch_id.arr));
		}

/*merchant_id*/
		if(ind_merchant_id>=0){
			v_merchant_id.arr[v_merchant_id.len]='\0';
			PutField_CString(myHash,"merchant_id",(const char*)v_merchant_id.arr);
DEBUGLOG(("GetOnlineBatchRecord merchant_id=[%s]\n",v_merchant_id.arr));
		}

/*txn_id*/
		if(ind_txn_id>=0){
			v_txn_id.arr[v_txn_id.len]='\0';
			PutField_CString(myHash,"txn_seq",(const char*)v_txn_id.arr);
DEBUGLOG(("GetOnlineBatchRecord txn_id=[%s]\n",v_txn_id.arr));
		}

/*aux_txn_seq*/
		if(ind_aux_txn_seq>=0){
			v_aux_txn_seq.arr[v_aux_txn_seq.len]='\0';
			PutField_CString(myHash,"aux_txn_seq",(const char*)v_aux_txn_seq.arr);
DEBUGLOG(("GetOnlineBatchRecord aux_txn_seq=[%s]\n",v_aux_txn_seq.arr));
		}


/*merchant_ref*/
		if(ind_merchant_ref>=0){
			v_merchant_ref.arr[v_merchant_ref.len]='\0';
			PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetOnlineBatchRecord merchant_ref= [%s]\n",v_merchant_ref.arr));
		}

/*country*/
		if(ind_country>=0){
			v_country.arr[v_country.len]='\0';
			PutField_CString(myHash,"txn_country",(const char*)v_country.arr);
DEBUGLOG(("GetOnlineBatchRecord country= [%s]\n",v_country.arr));
		}

/*identity_id*/
		if(ind_identity_id>=0){
			v_identity_id.arr[v_identity_id.len]='\0';
			PutField_CString(myHash,"identity_id",(const char*)v_identity_id.arr);
DEBUGLOG(("GetOnlineBatchRecord identity_id= [%s]\n",v_identity_id.arr));
		}

/*account_num*/
		if(ind_account_num>=0){
			v_account_num.arr[v_account_num.len]='\0';
			PutField_CString(myHash,"account_num",(const char*)v_account_num.arr);
DEBUGLOG(("GetOnlineBatchRecord account_num= [%s]\n",v_account_num.arr));
		}

/*account_name*/
		if(ind_account_name>=0){
			v_account_name.arr[v_account_name.len]='\0';
			PutField_CString(myHash,"account_name",(const char*)v_account_name.arr);
DEBUGLOG(("GetOnlineBatchRecord account_name= [%s]\n",v_account_name.arr));
		}

/*bank_name*/
		if(ind_bank_name>=0){
			v_bank_name.arr[v_bank_name.len]='\0';
			PutField_CString(myHash,"bank_name",(const char*)v_bank_name.arr);
DEBUGLOG(("GetOnlineBatchRecord bank_name= [%s]\n",v_bank_name.arr));
	}

/*bank_code*/
		if(ind_bank_code>=0){
			v_bank_code.arr[v_bank_code.len]='\0';
			PutField_CString(myHash,"bank_code",(const char*)v_bank_code.arr);
DEBUGLOG(("GetOnlineBatchRecord bank_code= [%s]\n",v_bank_code.arr));
		}

/*branch*/
		if(ind_branch>=0){
			v_branch.arr[v_branch.len]='\0';
			PutField_CString(myHash,"branch",(const char*)v_branch.arr);
DEBUGLOG(("GetOnlineBatchRecord branch= [%s]\n",v_branch.arr));
		}

/*phone_num*/
		if(ind_phone_num>=0){
			v_phone_num.arr[v_phone_num.len]='\0';
			PutField_CString(myHash,"phone_num",(const char*)v_phone_num.arr);
DEBUGLOG(("GetOnlineBatchRecord phone_num= [%s]\n",v_phone_num.arr));
		}

/*province*/
		if(ind_province>=0){
		v_province.arr[v_province.len]='\0';
		PutField_CString(myHash,"province",(const char*)v_province.arr);
DEBUGLOG(("GetOnlineBatchRecord province= [%s]\n",v_province.arr));
	}

/*city*/
		if(ind_city>=0){
			v_city.arr[v_city.len]='\0';
			PutField_CString(myHash,"city",(const char*)v_city.arr);
DEBUGLOG(("GetOnlineBatchRecord city= [%s]\n",v_city.arr));
		}

/*payout_currency*/
		if(ind_payout_ccy>=0){
			v_payout_ccy.arr[v_payout_ccy.len]='\0';
			PutField_CString(myHash,"payout_ccy",(const char*)v_payout_ccy.arr);
DEBUGLOG(("GetOnlineBatchRecord payout_ccy= [%s]\n",v_payout_ccy.arr));
		}

/*request_currency*/
		if(ind_request_ccy>=0){
			v_request_ccy.arr[v_request_ccy.len]='\0';
			PutField_CString(myHash,"request_ccy",(const char*)v_request_ccy.arr);
DEBUGLOG(("GetOnlineBatchRecord request_ccy= [%s]\n",v_request_ccy.arr));
		}

/*payout_amount*/
		if(ind_payout_amount>=0){
			PutField_Double(myHash,"payout_amount",v_payout_amount);
DEBUGLOG(("GetOnlineBatchRecord payout_amount = [%lf]\n",v_payout_amount));
	}

/*request_amount*/
		if(ind_request_amount>=0){
			PutField_Double(myHash,"request_amount",v_request_amount);
DEBUGLOG(("GetOnlineBatchRecord request_amount = [%lf]\n",v_request_amount));
	}

/*member_fee_ccy*/
		if(ind_member_fee_ccy>=0){
			v_member_fee_ccy.arr[v_member_fee_ccy.len]='\0';
			PutField_CString(myHash,"member_fee_ccy",(const char*)v_member_fee_ccy.arr);
DEBUGLOG(("GetOnlineBatchRecord member_fee_ccy= [%s]\n",v_member_fee_ccy.arr));
		}

/*member_fee*/
		if(ind_member_fee>=0){
			PutField_Double(myHash,"member_fee",v_member_fee);
DEBUGLOG(("GetOnlineBatchRecord member_fee = [%lf]\n",v_member_fee));
		}

/*merchant_fee_ccy*/
		if(ind_merchant_fee_ccy>=0){
			v_merchant_fee_ccy.arr[v_merchant_fee_ccy.len]='\0';
			PutField_CString(myHash,"merchant_fee_ccy",(const char*)v_merchant_fee_ccy.arr);
DEBUGLOG(("GetOnlineBatchRecord merchant_fee_ccy= [%s]\n",v_merchant_fee_ccy.arr));
		}

/*merchant_fee*/
		if(ind_merchant_fee>=0){
			PutField_Double(myHash,"merchant_fee",v_merchant_fee);
DEBUGLOG(("GetOnlineBatchRecord merchant_fee = [%lf]\n",v_merchant_fee));
		}

/*markup_ccy*/
		if(ind_markup_ccy>=0){
			v_markup_ccy.arr[v_markup_ccy.len]='\0';
			PutField_CString(myHash,"markup_ccy",(const char*)v_markup_ccy.arr);
DEBUGLOG(("GetOnlineBatchRecord markup_ccy= [%s]\n",v_markup_ccy.arr));
		}

/*markup_amt*/
		if(ind_markup_amt>=0){
			PutField_Double(myHash,"markup_amt",v_markup_amt);
DEBUGLOG(("GetOnlineBatchRecord markup_amt = [%lf]\n",v_markup_amt));
		}

/*ex_rate*/
		if(ind_ex_rate>=0){
			PutField_Double(myHash,"ex_rate",v_ex_rate);
DEBUGLOG(("GetOnlineBatchRecord ex_rate = [%lf]\n",v_ex_rate));
		}

/*resp_code*/
		if(ind_resp_code>=0){
			v_resp_code.arr[v_resp_code.len]='\0';
			PutField_CString(myHash,"resp_code",(const char*)v_resp_code.arr);
DEBUGLOG(("GetOnlineBatchRecord resp_code= [%s]\n",v_resp_code.arr));
		}

/*remark*/
		if(ind_remark>=0){
			v_remark.arr[v_remark.len]='\0';
			PutField_CString(myHash,"remark",(const char*)v_remark.arr);
DEBUGLOG(("GetOnlineBatchRecord remark= [%s]\n",v_remark.arr));
		}

/*file_name*/
		if(ind_file_name>=0){
			v_file_name.arr[v_file_name.len]='\0';
			PutField_CString(myHash,"file_name",(const char*)v_file_name.arr);
DEBUGLOG(("GetOnlineBatchRecord file_name= [%s]\n",v_file_name.arr));
		}

/*psp_batch_id*/	
		if(ind_psp_batch_id>=0){
			v_psp_batch_id.arr[v_psp_batch_id.len]='\0';
			PutField_CString(myHash,"psp_batch_id",(const char*)v_psp_batch_id.arr);
DEBUGLOG(("GetOnlineBatchRecord psp_batch_id= [%s]\n",v_psp_batch_id.arr));
		}

/*fundout_date*/
		if(ind_fundout_date>=0){
			v_fundout_date.arr[v_fundout_date.len]='\0';
			PutField_CString(myHash,"fundout_date",(const char*)v_fundout_date.arr);
DEBUGLOG(("GetOnlineBatchRecord fundout_date= [%s]\n",v_fundout_date.arr));
		}

/*service_fee*/
		if(ind_service_fee>=0){
			PutField_Double(myHash,"service_fee",v_service_fee);
DEBUGLOG(("GetOnlineBatchRecord service_fee= [%lf]\n",v_service_fee));
		}

/*psp_id*/	
		if(ind_psp_id>=0){
			v_psp_id.arr[v_psp_id.len]='\0';
			PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetOnlineBatchRecord psp_id= [%s]\n",v_psp_id.arr));
		}

		RecordSet_Add(myRec,myHash);

	}while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_getonpayout;

DEBUGLOG(("GetOnlineBatchRecord Normal Exit\n"));
	return  PD_OK;

getonpayout_error:
DEBUGLOG(("getonpayout_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("DBMerchantUploadFileDetail GetOnlineBatchRecord: SP_ERR\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_getonpayout;
	return PD_ERR;

}

