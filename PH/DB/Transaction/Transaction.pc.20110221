/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/07/30              Cody Chan
Add GetTxnHeader ph_posting-date		   2010/11/16		   Cody Chan
Add balance and encrpyt type			   2011/01/25		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "Transaction.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;
void Transaction(char    cdebug)
{
        cDebug = cdebug;
}

int Add(const hash_t *hRls)
{
        char		*csTmp;
        char        	cTmp;
        double          dTmp;
	int		iTmp;


        EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short 		hv_return_value;

	varchar		hv_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_org_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_channel_code[PD_CHANNEL_CODE_LEN];
	char		hv_status;
	char		hv_ar_ind;
	varchar		hv_txn_code[PD_TXN_CODE_LEN];
	varchar		hv_process_type[PD_PROCESS_TYPE_LEN];
	varchar		hv_process_code[PD_PROCESS_CODE_LEN];
	varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
	varchar		hv_merchant_ref[PD_MERCHANT_REF_LEN];
	varchar		hv_client_id[PD_CLIENT_ID_LEN];
	varchar		hv_host_posting_date[PD_DATE_LEN];
	varchar		hv_transmission_datetime[PD_DATE_LEN + PD_TIME_LEN];
	int		hv_internal_code;
	varchar		hv_response_code[PD_RESPONSE_CODE_LEN];
	double		hv_transaction_amt;
	double		hv_net_amt;
	varchar		hv_tm_date[PD_DATE_LEN];
	varchar		hv_tm_time[PD_TIME_LEN];
	varchar		hv_local_tm_date[PD_DATE_LEN];
	varchar		hv_local_tm_time[PD_TIME_LEN];
	varchar		hv_add_user[PD_USER_LEN];



	short		ind_txn_id = -1;
	short		ind_org_txn_id = -1;
	short		ind_channel_code = -1;
	short		ind_status = -1;
	short		ind_ar_ind = -1;
	short		ind_txn_code = -1;
	short		ind_process_type = -1;
	short		ind_process_code = -1;
	short		ind_merchant_id = -1;
	short		ind_merchant_ref = -1;
	short		ind_client_id = -1;
	short		ind_host_posting_date = -1;
	short		ind_transmission_datetime = -1;
	short		ind_internal_code = -1;
	short		ind_response_code = -1;
	short		ind_transaction_amt = -1;
	short		ind_net_amt = -1;
	short		ind_tm_date = -1;
	short		ind_tm_time = -1;
	short		ind_local_tm_date = -1;
	short		ind_local_tm_time = -1;
	short		ind_add_user = -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));


/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("Add:txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
        }
/* org txn_seq */
        if (GetField_CString(hRls,"org_txn_seq",&csTmp)) {
                hv_org_txn_id.len = strlen(csTmp);
                memcpy(hv_org_txn_id.arr,csTmp,hv_org_txn_id.len);
                ind_org_txn_id = 0;
DEBUGLOG(("Add:org_txn_id = [%.*s]\n",hv_org_txn_id.len,hv_org_txn_id.arr));
        }
/* Channel code */
        if (GetField_CString(hRls,"channel_code",&csTmp)) {
                hv_channel_code.len = strlen(csTmp);
                memcpy(hv_channel_code.arr,csTmp,hv_channel_code.len);
                ind_channel_code = 0;
DEBUGLOG(("Add:channel_code = [%.*s]\n",hv_channel_code.len,hv_channel_code.arr));
        }


/* Status */ 
        if (GetField_Char(hRls,"status",&cTmp)) {
		hv_status = cTmp;
                ind_status = 0;
DEBUGLOG(("Add:status = [%c]\n",hv_status));
        }

/* ar ind */ 
        if (GetField_Char(hRls,"ar_ind",&cTmp)) {
		hv_ar_ind = cTmp;
                ind_ar_ind = 0;
DEBUGLOG(("Add:ar_ind = [%c]\n",hv_ar_ind));
        }

/* Txn Code */
        if (GetField_CString(hRls,"txn_code",&csTmp)) {
                hv_txn_code.len = strlen(csTmp);
                memcpy(hv_txn_code.arr,csTmp,hv_txn_code.len);
                ind_txn_code = 0;
DEBUGLOG(("Add:txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));
        }

/* process type */
        if (GetField_CString(hRls,"process_type",&csTmp)) {
                hv_process_type.len = strlen(csTmp);
                memcpy(hv_process_type.arr,csTmp,hv_process_type.len);
                ind_process_type = 0;
DEBUGLOG(("Add:process_type = [%.*s]\n",hv_process_type.len,hv_process_type.arr));
        }

/* process code */
        if (GetField_CString(hRls,"process_code",&csTmp)) {
                hv_process_code.len = strlen(csTmp);
                memcpy(hv_process_code.arr,csTmp,hv_process_code.len);
                ind_process_code = 0;
DEBUGLOG(("Add:process_code = [%.*s]\n",hv_process_code.len,hv_process_code.arr));
        }

/* Merchant No */
        if (GetField_CString(hRls,"merchant_id",&csTmp)) {
                hv_merchant_id.len = strlen(csTmp);
                memcpy(hv_merchant_id.arr,csTmp,hv_merchant_id.len);
                ind_merchant_id = 0;
DEBUGLOG(("Add:merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        }

/* Merchant ref */
        if (GetField_CString(hRls,"merchant_ref",&csTmp)) {
                hv_merchant_ref.len = strlen(csTmp);
                memcpy(hv_merchant_ref.arr,csTmp,hv_merchant_ref.len);
                ind_merchant_ref = 0;
DEBUGLOG(("Add:merchant_ref = [%.*s]\n",hv_merchant_ref.len,hv_merchant_ref.arr));
        }



/* Client ID */
        if (GetField_CString(hRls,"client_id",&csTmp)) {
                hv_client_id.len = strlen(csTmp);
                memcpy(hv_client_id.arr,csTmp,hv_client_id.len);
                ind_client_id = 0;
DEBUGLOG(("Add:client_id = [%.*s]\n",hv_client_id.len,hv_client_id.arr));
        }
/* host posting date */
        if (GetField_CString(hRls,"host_posting_date",&csTmp)) {
                hv_host_posting_date.len = strlen(csTmp);
                memcpy(hv_host_posting_date.arr,csTmp,hv_host_posting_date.len);
                ind_host_posting_date = 0;
DEBUGLOG(("Add:host_posting_date = [%.*s]\n",hv_host_posting_date.len,hv_host_posting_date.arr));
        }



/* internal code */
        if (GetField_Int(hRls,"internal_code",&iTmp)) {
		hv_internal_code = iTmp;
                ind_internal_code = 0;
DEBUGLOG(("Add:settlement_date = [%d]\n",hv_internal_code));
        }

/* response code  */
        if (GetField_CString(hRls,"response_code",&csTmp)) {
                hv_response_code.len = strlen(csTmp);
                memcpy(hv_response_code.arr,csTmp,hv_response_code.len);
                ind_response_code = 0;
DEBUGLOG(("Add:response_code = [%.*s]\n",hv_response_code.len,hv_response_code.arr));
        }

/* transaction amt   */
        if (GetField_Double(hRls,"txn_amt",&dTmp)) {
		hv_transaction_amt = dTmp;
                ind_transaction_amt = 0;
DEBUGLOG(("Add:txn_amt = [%f]\n",hv_transaction_amt));
        }

/* net amt   */
        if (GetField_Double(hRls,"net_amt",&dTmp)) {
		hv_net_amt = dTmp;
                ind_net_amt = 0;
DEBUGLOG(("Add:net_amt = [%f]\n",hv_net_amt));
        }
/* transmission_datetime */
        if (GetField_CString(hRls,"transmission_datetime",&csTmp)) {
                hv_transmission_datetime.len = strlen(csTmp);
                memcpy(hv_transmission_datetime.arr,csTmp,hv_transmission_datetime.len);
                ind_transmission_datetime = 0;
DEBUGLOG(("Add:transmission_datetime = [%.*s]\n",hv_transmission_datetime.len,hv_transmission_datetime.arr));
        }

/* tm date */
        if (GetField_CString(hRls,"tm_date",&csTmp)) {
                hv_tm_date.len = strlen(csTmp);
                memcpy(hv_tm_date.arr,csTmp,hv_tm_date.len);
                ind_tm_date = 0;
DEBUGLOG(("Add:tm_date = [%.*s]\n",hv_tm_date.len,hv_tm_date.arr));
        }

/* tm time */
        if (GetField_CString(hRls,"tm_time",&csTmp)) {
                hv_tm_time.len = strlen(csTmp);
                memcpy(hv_tm_time.arr,csTmp,hv_tm_time.len);
                ind_tm_time = 0;
DEBUGLOG(("Add:tm_time = [%.*s]\n",hv_tm_time.len,hv_tm_time.arr));
        }

/* local tm date */
        if (GetField_CString(hRls,"local_tm_date",&csTmp)) {
                hv_local_tm_date.len = strlen(csTmp);
                memcpy(hv_local_tm_date.arr,csTmp,hv_local_tm_date.len);
                ind_local_tm_date = 0;
DEBUGLOG(("Add:local_tm_date = [%.*s]\n",hv_local_tm_date.len,hv_local_tm_date.arr));
        }

/* local tm time */
        if (GetField_CString(hRls,"local_tm_time",&csTmp)) {
                hv_local_tm_time.len = strlen(csTmp);
                memcpy(hv_local_tm_time.arr,csTmp,hv_local_tm_time.len);
                ind_local_tm_time = 0;
DEBUGLOG(("Add:local_tm_time = [%.*s]\n",hv_local_tm_time.len,hv_local_tm_time.arr));
        }



/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen(csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("Add:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }


	FREE_ME(csTmp);

	EXEC SQL EXECUTE
                BEGIN
			:hv_return_value := sp_txn_header_insert(
					:hv_txn_id:ind_txn_id,
					:hv_org_txn_id:ind_org_txn_id,
					:hv_channel_code:ind_channel_code,
					:hv_status:ind_status,
					:hv_ar_ind:ind_ar_ind,
					:hv_txn_code:ind_txn_code,
					:hv_process_type:ind_process_type,
					:hv_process_code:ind_process_code,
					:hv_merchant_id:ind_merchant_id,
					:hv_merchant_ref:ind_merchant_ref,
					:hv_client_id:ind_client_id,
					:hv_host_posting_date:ind_host_posting_date,
					:hv_transmission_datetime:ind_transmission_datetime,
					:hv_internal_code:ind_internal_code,
					:hv_response_code:ind_response_code,
					:hv_transaction_amt:ind_transaction_amt,
					:hv_net_amt:ind_net_amt,
					:hv_tm_date:ind_tm_date,
					:hv_tm_time:ind_tm_time,
					:hv_local_tm_date:ind_local_tm_date,
					:hv_local_tm_time:ind_local_tm_time,
					:hv_add_user:ind_add_user,
					:hv_add_user:ind_add_user);
	        END;
        END-EXEC;

DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("Add:Normal Exit\n"));
		TxnCommit();
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("Transaction_Add: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("Transaction_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		TxnAbort();
                return PD_ERR;
        }

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_Add: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR TxnAbort\n"));
	TxnAbort();
        return PD_INTERNAL_ERR;
}

int Update(const hash_t *hRls)
{

	char*	csTmp = strdup("");
	char	cTmp;
	double	dTmp;
	int	iTmp;
	char*	csBuf;
	char*	csTxnId = strdup("");
        EXEC SQL WHENEVER SQLERROR GOTO update_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

	varchar 	hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr,"update txn_header set th_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"txn_seq",&csTxnId);
DEBUGLOG(("Update:txn_id = [%s]\n",csTxnId));

/* org txn_seq */
        if (GetField_CString(hRls,"org_txn_seq",&csTmp)) {
DEBUGLOG(("Update:org_txn_id = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_org_txn_id = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* Channel code */
        if (GetField_CString(hRls,"channel_code",&csTmp)) {
DEBUGLOG(("Update:channel_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_channel_code = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* Status */ 
        if (GetField_Char(hRls,"status",&cTmp)) {
DEBUGLOG(("Update:status = [%c]\n",cTmp));
		sprintf(csBuf,"%c",cTmp);
		strcat((char*)hv_dynstmt.arr, ",th_status = '");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* ar ind */ 
        if (GetField_Char(hRls,"ar_ind",&cTmp)) {
DEBUGLOG(("Update:ar_ind = [%c]\n",cTmp));
		sprintf(csBuf,"%c",cTmp);
		strcat((char*)hv_dynstmt.arr, ",th_ar_ind = '");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* Txn Code */
        if (GetField_CString(hRls,"txn_code",&csTmp)) {
DEBUGLOG(("Update:txn_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_txn_code = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* process type */
        if (GetField_CString(hRls,"process_type",&csTmp)) {
DEBUGLOG(("Update:txn_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_process_type = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* process code */
        if (GetField_CString(hRls,"process_code",&csTmp)) {
DEBUGLOG(("Update:txn_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_process_code = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* Merchant No */
        if (GetField_CString(hRls,"merchant_id",&csTmp)) {
DEBUGLOG(("Update:merchant_id = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_merchant_id = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* Client ID */
        if (GetField_CString(hRls,"client_id",&csTmp)) {
DEBUGLOG(("Update:client_id = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_client_id = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* host posting date */
        if (GetField_CString(hRls,"host_posting_date",&csTmp)) {
DEBUGLOG(("Update:host_posting_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_host_posting_date = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* transmission_datetime  */
        if (GetField_CString(hRls,"transmission_datetime",&csTmp)) {
DEBUGLOG(("Update:transmission_datetime = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_transmission_datetime = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* internal code  */
        if (GetField_Int(hRls,"internal_code",&iTmp)) {
DEBUGLOG(("Update:internal_code = [%d]\n",iTmp));
		sprintf(csBuf,"%d",iTmp);
		strcat((char*)hv_dynstmt.arr, ",th_internal_code = '");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* response code  */
        if (GetField_CString(hRls,"response_code",&csTmp)) {
DEBUGLOG(("Update:response_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_response_code = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* transaction amt   */
        if (GetField_Double(hRls,"txn_amt",&dTmp)) {
DEBUGLOG(("Update:txn_amt = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",th_transaction_amount = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* net amt   */
        if (GetField_Double(hRls,"net_amt",&dTmp)) {
DEBUGLOG(("Update:net_amt = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",th_net_amount = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* tm date */
        if (GetField_CString(hRls,"tm_date",&csTmp)) {
DEBUGLOG(("Update:tm_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_tm_date = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* tm time */
        if (GetField_CString(hRls,"tm_time",&csTmp)) {
DEBUGLOG(("Update:tm_time = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_tm_time = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* local tm date */
        if (GetField_CString(hRls,"local_tm_date",&csTmp)) {
DEBUGLOG(("Update:local_tm_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_local_tm_date = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* local tm time */
        if (GetField_CString(hRls,"local_tm_time",&csTmp)) {
DEBUGLOG(("Update:local_tm_time = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_local_tm_time = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
DEBUGLOG(("Update:add_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_create_user = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* update user */
        if (GetField_CString(hRls,"update_user",&csTmp)) {
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_update_user = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

	strcat((char *)hv_dynstmt.arr, " WHERE th_txn_id = '");
        strcat((char *)hv_dynstmt.arr, csTxnId);
        strcat((char *)hv_dynstmt.arr, "'");
       	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csTmp);
	FREE_ME(csBuf);
	FREE_ME(csTxnId);


DEBUGLOG(("Update Normal Exit\n"));
	return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
	TxnAbort();
        return PD_INTERNAL_ERR;
}

int AddDetail(const hash_t *hRls)
{
        char		*csTmp;
	char		cTmp;
	double		dTmp;

        EXEC SQL WHENEVER SQLERROR GOTO adddetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short 		hv_return_value;

	varchar		hv_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_txn_ccy[PD_CCY_ID_LEN];
	varchar		hv_txn_country[PD_COUNTRY_LEN];
	varchar		hv_pay_method[PD_PAY_METHOD_LEN];
	varchar		hv_bank_code[PD_AC_BANK_LEN];
	varchar		hv_bank_name[PD_AC_BANK_NAME_LEN];
	varchar		hv_branch_name[PD_AC_BRANCH_LEN];
	varchar		hv_account_id[PD_AC_NO_LEN];
	varchar		hv_account_name[PD_AC_NAME_LEN];
	varchar		hv_identity_id[PD_IDENTITY_ID_LEN];
	varchar		hv_province[PD_PROVINCE_LEN];
	varchar		hv_phone_no[PD_PHONE_NO_LEN];
	varchar		hv_city[PD_CITY_LEN];
	varchar		hv_batch_id[PD_BATCH_LEN];
	char		hv_show_paypage;
	varchar		hv_language[PD_LANGUAGE_LEN];
	varchar		hv_success_url[PD_URL_LEN];
	varchar		hv_failure_url[PD_URL_LEN];
	varchar		hv_success_ck_url[PD_URL_LEN];
	varchar		hv_failure_ck_url[PD_URL_LEN];
	varchar		hv_add_user[PD_USER_LEN];
	varchar		hv_update_user[PD_USER_LEN];
	double		hv_balance;
	varchar		hv_encrypt_type[PD_ENCRYPT_LEN];



	short		ind_txn_id = -1;
	short		ind_txn_ccy = -1;
	short		ind_txn_country = -1;
	short		ind_pay_method = -1;
	short		ind_bank_code = -1;
	short		ind_bank_name = -1;
	short		ind_branch_name = -1;
	short		ind_account_id = -1;
	short		ind_account_name = -1;
	short		ind_identity_id = -1;
	short		ind_province = -1;
	short		ind_phone_no = -1;
	short		ind_city = -1;
	short		ind_batch_id = -1;
	short		ind_show_paypage = -1;
	short		ind_language = -1;
	short		ind_success_url = -1;
	short		ind_failure_url = -1;
	short		ind_success_ck_url = -1;
	short		ind_failure_ck_url = -1;
	short		ind_add_user = -1;
	short		ind_update_user = -1;
	short		ind_balance = -1;
	short		ind_encrypt_type= -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("AddDetail: Begin\n"));


/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("AddDetail:txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
        }

/* txn_ccy */
        if (GetField_CString(hRls,"txn_ccy",&csTmp)) {
                hv_txn_ccy.len = strlen(csTmp);
                memcpy(hv_txn_ccy.arr,csTmp,hv_txn_ccy.len);
                ind_txn_ccy = 0;
DEBUGLOG(("AddDetail:txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));
        }

/* txn_country */
        if (GetField_CString(hRls,"txn_country",&csTmp)) {
                hv_txn_country.len = strlen(csTmp);
                memcpy(hv_txn_country.arr,csTmp,hv_txn_country.len);
                ind_txn_country = 0;
DEBUGLOG(("AddDetail:txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));
        }
/* pay_method */
        if (GetField_CString(hRls,"pay_method",&csTmp)) {
                hv_pay_method.len = strlen(csTmp);
                memcpy(hv_pay_method.arr,csTmp,hv_pay_method.len);
                ind_pay_method = 0;
DEBUGLOG(("AddDetail:pay_method = [%.*s]\n",hv_pay_method.len,hv_pay_method.arr));
	}

/* bank_code */
        if (GetField_CString(hRls,"bank_code",&csTmp)) {
                hv_bank_code.len = strlen(csTmp);
                memcpy(hv_bank_code.arr,csTmp,hv_bank_code.len);
                ind_bank_code = 0;
DEBUGLOG(("AddDetail:bank_code = [%.*s]\n",hv_bank_code.len,hv_bank_code.arr));
	}

/* bank_name */
        if (GetField_CString(hRls,"bank_name",&csTmp)) {
                hv_bank_name.len = strlen(csTmp);
                memcpy(hv_bank_name.arr,csTmp,hv_bank_name.len);
                ind_bank_name = 0;
DEBUGLOG(("AddDetail:bank_name = [%.*s]\n",hv_bank_name.len,hv_bank_name.arr));
	}
/* branch_name */
        if (GetField_CString(hRls,"branch_name",&csTmp)) {
                hv_branch_name.len = strlen(csTmp);
                memcpy(hv_branch_name.arr,csTmp,hv_branch_name.len);
                ind_branch_name = 0;
DEBUGLOG(("AddDetail:branch_name = [%.*s]\n",hv_branch_name.len,hv_branch_name.arr));
	}

/* account_id */
        if (GetField_CString(hRls,"account_id",&csTmp)) {
                hv_account_id.len = strlen(csTmp);
                memcpy(hv_account_id.arr,csTmp,hv_account_id.len);
                ind_account_id = 0;
DEBUGLOG(("AddDetail:account_id = [%.*s]\n",hv_account_id.len,hv_account_id.arr));
	}

/* account_name */
        if (GetField_CString(hRls,"account_name",&csTmp)) {
                hv_account_name.len = strlen(csTmp);
                memcpy(hv_account_name.arr,csTmp,hv_account_name.len);
                ind_account_name = 0;
DEBUGLOG(("AddDetail:account_name = [%.*s]\n",hv_account_name.len,hv_account_name.arr));
	}


/* identity_id */
        if (GetField_CString(hRls,"identity_id",&csTmp)) {
                hv_identity_id.len = strlen(csTmp);
                memcpy(hv_identity_id.arr,csTmp,hv_identity_id.len);
                ind_identity_id = 0;
DEBUGLOG(("AddDetail:identity_id = [%.*s]\n",hv_identity_id.len,hv_identity_id.arr));
	}


/* province */
        if (GetField_CString(hRls,"province",&csTmp)) {
                hv_province.len = strlen(csTmp);
                memcpy(hv_province.arr,csTmp,hv_province.len);
                ind_province = 0;
DEBUGLOG(("AddDetail:province = [%.*s]\n",hv_province.len,hv_province.arr));
	}

/* phone_no */
        if (GetField_CString(hRls,"phone_no",&csTmp)) {
                hv_phone_no.len = strlen(csTmp);
                memcpy(hv_phone_no.arr,csTmp,hv_phone_no.len);
                ind_phone_no = 0;
DEBUGLOG(("AddDetail:phone_no = [%.*s]\n",hv_phone_no.len,hv_phone_no.arr));
	}

/* city */
        if (GetField_CString(hRls,"city",&csTmp)) {
                hv_city.len = strlen(csTmp);
                memcpy(hv_city.arr,csTmp,hv_city.len);
                ind_city = 0;
DEBUGLOG(("AddDetail:city = [%.*s]\n",hv_city.len,hv_city.arr));
	}
/* batch_id */
        if (GetField_CString(hRls,"batch_id",&csTmp)) {
                hv_batch_id.len = strlen(csTmp);
                memcpy(hv_batch_id.arr,csTmp,hv_batch_id.len);
                ind_batch_id = 0;
DEBUGLOG(("AddDetail:batch_id = [%.*s]\n",hv_batch_id.len,hv_batch_id.arr));
	}


/* show paypage */
        if (GetField_Char(hRls,"show_paypage",&cTmp)) {
		hv_show_paypage = cTmp;
		ind_show_paypage = 0;
DEBUGLOG(("AddDetail:show_paypage = [%c]\n",hv_show_paypage));
	}

/* language */
        if (GetField_CString(hRls,"language",&csTmp)) {
                hv_language.len = strlen(csTmp);
                memcpy(hv_language.arr,csTmp,hv_language.len);
                ind_language = 0;
DEBUGLOG(("AddDetail:language = [%.*s]\n",hv_language.len,hv_language.arr));
	}

/* success_url */
        if (GetField_CString(hRls,"success_url",&csTmp)) {
                hv_success_url.len = strlen(csTmp);
                memcpy(hv_success_url.arr,csTmp,hv_success_url.len);
                ind_success_url = 0;
DEBUGLOG(("AddDetail:success_url = [%.*s]\n",hv_success_url.len,hv_success_url.arr));
	}

/* failure_url */
        if (GetField_CString(hRls,"failure_url",&csTmp)) {
                hv_failure_url.len = strlen(csTmp);
                memcpy(hv_failure_url.arr,csTmp,hv_failure_url.len);
                ind_failure_url = 0;
DEBUGLOG(("AddDetail:failure_url = [%.*s]\n",hv_failure_url.len,hv_failure_url.arr));
	}

/* success_callback_url */
        if (GetField_CString(hRls,"success_callback_url",&csTmp)) {
                hv_success_ck_url.len = strlen(csTmp);
                memcpy(hv_success_ck_url.arr,csTmp,hv_success_ck_url.len);
                ind_success_ck_url = 0;
DEBUGLOG(("AddDetail:success_ck_url = [%.*s]\n",hv_success_ck_url.len,hv_success_ck_url.arr));
	}

/* failure_callback_url */
        if (GetField_CString(hRls,"failure_callback_url",&csTmp)) {
                hv_failure_ck_url.len = strlen(csTmp);
                memcpy(hv_failure_ck_url.arr,csTmp,hv_failure_ck_url.len);
                ind_failure_ck_url = 0;
DEBUGLOG(("AddDetail:failure_ck_url = [%.*s]\n",hv_failure_ck_url.len,hv_failure_ck_url.arr));
	}
	
	
/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen((const char*)csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("AddDetail:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }
/* update user */
        if (GetField_CString(hRls,"update_user",&csTmp)) {
                hv_update_user.len = strlen((const char*)csTmp);
                memcpy(hv_update_user.arr,csTmp,hv_update_user.len);
                ind_update_user = 0;
DEBUGLOG(("AddDetail:update_user = [%.*s]\n",hv_update_user.len,hv_update_user.arr));
        }

/* balance   */
        if (GetField_Double(hRls,"balance",&dTmp)) {
		hv_balance = dTmp;
                ind_balance = 0;
DEBUGLOG(("Add:balance = [%f]\n",hv_balance));
        }

/* encrypt_type */
        if (GetField_CString(hRls,"encrypt_type",&csTmp)) {
                hv_encrypt_type.len = strlen(csTmp);
                memcpy(hv_encrypt_type.arr,csTmp,hv_encrypt_type.len);
                ind_encrypt_type = 0;
DEBUGLOG(("Add:encrypt_type = [%.*s]\n",hv_encrypt_type.len,hv_encrypt_type.arr));
        }

	FREE_ME(csTmp);

	EXEC SQL EXECUTE
                BEGIN
			:hv_return_value := sp_txn_detail_insert(
					:hv_txn_id:ind_txn_id,
					:hv_txn_ccy:ind_txn_ccy,
					:hv_txn_country:ind_txn_country,
					:hv_pay_method:ind_pay_method,
					:hv_bank_code:ind_bank_code,
					:hv_bank_name:ind_bank_name,
					:hv_branch_name:ind_branch_name,
					:hv_account_id:ind_account_id,
					:hv_account_name:ind_account_name,
					:hv_identity_id:ind_identity_id,
					:hv_province:ind_province,
					:hv_phone_no:ind_phone_no,
					:hv_city:ind_city,
					:hv_batch_id:ind_batch_id,
					:hv_show_paypage:ind_show_paypage,
					:hv_language:ind_language,
					:hv_success_url:ind_success_url,
					:hv_failure_url:ind_failure_url,
					:hv_success_ck_url:ind_success_ck_url,
					:hv_failure_ck_url:ind_failure_ck_url,
					:hv_add_user:ind_add_user,
					:hv_update_user:ind_update_user,
					:hv_encrypt_type:ind_encrypt_type,
					:hv_balance:ind_balance);
	        END;
        END-EXEC;

DEBUGLOG(("AddDetail:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("AddDetail:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("Transaction_AddDetail: SP_OTHER_ERR\n");
DEBUGLOG(("AddDetail: SP_OTHER_ERR\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("Transaction_Add: SP_ERR\n");
DEBUGLOG(("AddDetail: SP_ERR\n"));
                return PD_ERR;
        }

adddetail_error:
DEBUGLOG(("adddetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_Add: SP_INTERNAL_ERR\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR\n"));
        return PD_INTERNAL_ERR;
}


int GetTxnHeader(const char* csTxnID,
		recordset_t* myRec)
{

	char	csTmp[PD_DIGIT_LEN + PD_DECIMAL_LEN + 2];
	char	csDate[PD_DATE_LEN +1];
	char	csTime[PD_TIME_LEN +1];
	char	csDateTime[PD_DATE_LEN + PD_TIME_LEN +1];
        hash_t *myHash;
	int	iCnt = 0;

        EXEC SQL WHENEVER SQLERROR GOTO gettxnheader_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_txn_id[PD_TXN_SEQ_LEN];

		varchar		v_org_txn_id[PD_TXN_SEQ_LEN + 1];
		varchar		v_client_id[PD_CLIENT_ID_LEN + 1];
		char		v_status;
		char		v_ar_ind;
		varchar		v_txn_code[PD_TXN_CODE_LEN + 1];
		varchar		v_merchant_id[PD_MERCHANT_ID_LEN + 1];
		varchar		v_merchant_ref[PD_MERCHANT_REF_LEN + 1];
		double		v_txn_amt;
		double		v_net_amt;
		varchar		v_transmission_datetime[PD_DATE_LEN + PD_TIME_LEN + 1];
		varchar		v_local_tm_date[PD_DATE_LEN + 1];
		varchar		v_local_tm_time[PD_TIME_LEN + 1];
		long		v_internal_code;
		varchar		v_channel_code[PD_CHANNEL_CODE_LEN + 1];
		varchar		v_response_code[PD_RESPONSE_CODE_LEN + 1];
		varchar		v_host_posting_date[PD_DATE_LEN + 1];

		short		ind_org_txn_id = -1;
		short		ind_client_id = -1;
		short		ind_status = -1;
		short		ind_ar_ind = -1;
		short		ind_txn_code = -1;
		short		ind_merchant_id = -1;
		short		ind_merchant_ref = -1;
		short		ind_txn_amt = -1;
		short		ind_net_amt = -1;
		short		ind_transmission_datetime = -1;
		short		ind_local_tm_date = -1;
		short		ind_local_tm_time = -1;
		short		ind_internal_code = -1;
		short		ind_channel_code = -1;
		short		ind_response_code = -1;
		short		ind_host_posting_date = -1;

        EXEC SQL END DECLARE SECTION;

	hv_txn_id.len = strlen(csTxnID);
	memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetTxnHeader txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_gettxnheader CURSOR FOR
		select th_org_txn_id, 
		       th_client_id,
		       th_status,
		       th_ar_ind,
		       th_txn_code,
       		       th_merchant_id,
       		       th_merchant_ref,
		       th_transaction_amount,
		       th_net_amount,
		       th_transmission_datetime,
		       th_local_tm_date,
		       th_local_tm_time,
		       th_internal_code,
		       th_input_channel,
		       th_response_code,
		       th_host_posting_date
                  from txn_header 
                 where th_txn_id = :hv_txn_id;


        EXEC SQL OPEN c_cursor_gettxnheader;
        do {
                EXEC SQL FETCH c_cursor_gettxnheader
                INTO
			:v_org_txn_id:ind_org_txn_id,
			:v_client_id:ind_client_id,
			:v_status:ind_status,
			:v_ar_ind:ind_ar_ind,
			:v_txn_code:ind_txn_code,
			:v_merchant_id:ind_merchant_id,
			:v_merchant_ref:ind_merchant_ref,
			:v_txn_amt:ind_txn_amt,
			:v_net_amt:ind_net_amt,
			:v_transmission_datetime:ind_transmission_datetime,
			:v_local_tm_date:ind_local_tm_date,
			:v_local_tm_time:ind_local_tm_time,
			:v_internal_code:ind_internal_code,
			:v_channel_code:ind_channel_code,
			:v_response_code:ind_response_code,
			:v_host_posting_date:ind_host_posting_date;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

		iCnt++;

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

                if (ind_org_txn_id >= 0) {
                        v_org_txn_id.arr[v_org_txn_id.len] ='\0';
                        PutField_CString(myHash,"org_txn_id",(const char*)v_org_txn_id.arr);
DEBUGLOG(("GetTxnHeader org_txn_id = [%s]\n",v_org_txn_id.arr)); 
                }

                if (ind_client_id >= 0) {
                        v_client_id.arr[v_client_id.len] ='\0';
                        PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
DEBUGLOG(("GetTxnHeader client_id = [%s]\n",v_client_id.arr)); 
                }
                if (ind_status >= 0) {
DEBUGLOG(("GetTxnHeader status = [%c]\n",v_status)); 
                        PutField_Char(myHash,"status",v_status);
		}

                if (ind_ar_ind >= 0) {
DEBUGLOG(("GetTxnHeader ar_ind = [%c]\n",v_ar_ind)); 
                        PutField_Char(myHash,"ar_ind",v_ar_ind);
		}

                if (ind_txn_code >= 0) {
                        v_txn_code.arr[v_txn_code.len] ='\0';
                        PutField_CString(myHash,"txn_code",(const char*)v_txn_code.arr);
DEBUGLOG(("GetTxnHeader txn_code = [%s]\n",v_txn_code.arr)); 
                }

                if (ind_merchant_id >= 0) {
                        v_merchant_id.arr[v_merchant_id.len] ='\0';
                        PutField_CString(myHash,"merchant_id",(const char*)v_merchant_id.arr);
DEBUGLOG(("GetTxnHeader merchant_id = [%s]\n",v_merchant_id.arr)); 
                }
                if (ind_merchant_ref >= 0) {
                        v_merchant_ref.arr[v_merchant_ref.len] ='\0';
                        PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetTxnHeader merchant_ref = [%s]\n",v_merchant_ref.arr)); 
                }

                if (ind_txn_amt < 0) 
			v_txn_amt = 0.0;
		mydtoc(v_txn_amt,PD_DIGIT_LEN,PD_DECIMAL_LEN,csTmp);
		trim_leading_zero(csTmp,csTmp);
		//PutField_CString(myHash,"txn_amount",csTmp);
                PutField_Double(myHash,"txn_amt",v_txn_amt);
DEBUGLOG(("GetTxnHeader txn_amt = [%s]\n",csTmp)); 

                if (ind_net_amt < 0) 
			v_net_amt = 0.0;	
		mydtoc(v_net_amt,PD_DIGIT_LEN,PD_DECIMAL_LEN,csTmp);
		trim_leading_zero(csTmp,csTmp);
		//PutField_CString(myHash,"net_amt",csTmp);
                PutField_Double(myHash,"net_amt",v_net_amt);
DEBUGLOG(("GetTxnHeader net_amt = [%f]\n",v_net_amt)); 

                if (ind_transmission_datetime >= 0) {
                        v_transmission_datetime.arr[v_transmission_datetime.len] ='\0';
                        PutField_CString(myHash,"transmission_datetime",(const char*)v_transmission_datetime.arr);
DEBUGLOG(("GetTxnHeader transmission_datetime = [%s]\n",v_transmission_datetime.arr)); 
                }
                if (ind_local_tm_date >= 0) {
                        v_local_tm_date.arr[v_local_tm_date.len] ='\0';
			strcpy(csDate,v_local_tm_date.arr);
                        PutField_CString(myHash,"local_tm_date",(const char*)v_local_tm_date.arr);
DEBUGLOG(("GetTxnHeader local_tm_date = [%s]\n",v_local_tm_date.arr)); 
                }
                if (ind_local_tm_time >= 0) {
                        v_local_tm_time.arr[v_local_tm_time.len] ='\0';
			strcpy(csTime,v_local_tm_time.arr);
                        PutField_CString(myHash,"local_tm_time",(const char*)v_local_tm_time.arr);
DEBUGLOG(("GetTxnHeader local_tm_time = [%s]\n",v_local_tm_time.arr)); 
                }
                if (ind_internal_code >= 0) {
                        PutField_Int(myHash,"internal_error",v_internal_code);
DEBUGLOG(("GetTxnHeader internal_code = [%d]\n",v_internal_code)); 
		}
                if (ind_channel_code >= 0) {
                        v_channel_code.arr[v_channel_code.len] ='\0';
                        PutField_CString(myHash,"channel_code",(const char*)v_channel_code.arr);
DEBUGLOG(("GetTxnHeader channel_code = [%s]\n",v_channel_code.arr)); 
                }
                if (ind_response_code >= 0) {
                        v_response_code.arr[v_response_code.len] ='\0';
                        PutField_CString(myHash,"response_code",(const char*)v_response_code.arr);
DEBUGLOG(("GetTxnHeader response_code = [%s]\n",v_response_code.arr)); 
                }
                if (ind_host_posting_date >= 0) {
                        v_host_posting_date.arr[v_host_posting_date.len] ='\0';
                        PutField_CString(myHash,"host_posting_date",(const char*)v_host_posting_date.arr);
DEBUGLOG(("GetTxnHeader host_posting_date = [%s]\n",v_host_posting_date.arr)); 
                }

DEBUGLOG(("GetTxnHeader formation local transmission_datetime\n"));
		strcpy(csDateTime,csDate);
		strcat(csDateTime,csTime);
DEBUGLOG(("GetTxnHeader local_transmission_datetime = [%s]\n",csDateTime));
		PutField_CString(myHash,"local_transmission_datetime",csDateTime);

		RecordSet_Add(myRec,myHash);
	}
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_gettxnheader;


	if (iCnt > 0 ) {
DEBUGLOG(("GetTxnHeader Normal Exit\n")); 
        	return  PD_OK;
	}
	else {
DEBUGLOG(("GetTxnHeader Normal Exit, Not Found\n")); 
		return PD_ERR;
	}

gettxnheader_error:
DEBUGLOG(("gettxnheader_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_gettxnheader;
        return PD_ERR;
}



int GetTxnDetail(const char* csTxnID,
		recordset_t* myRec)
{

        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO gettxndetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_txn_id[PD_TXN_SEQ_LEN];

		varchar		v_txn_ccy[PD_CCY_ID_LEN + 1];
		varchar		v_txn_country[PD_COUNTRY_LEN + 1];
		varchar		v_pay_method[PD_PAY_METHOD_LEN + 1];
		varchar		v_bank_code[PD_BANK_CODE_LEN + 1];
		char		v_show_paypage;
		varchar		v_language[PD_LANGUAGE_LEN + 1];
		varchar		v_success_url[PD_URL_LEN + 1];
		varchar		v_failure_url[PD_URL_LEN + 1];
		varchar		v_success_ck_url[PD_URL_LEN + 1];
		varchar		v_failure_ck_url[PD_URL_LEN + 1];
		varchar		v_encrypt_type[PD_ENCRYPT_LEN + 1];

		short		ind_txn_ccy = -1;
		short		ind_txn_country = -1;
		short		ind_pay_method = -1;
		short		ind_bank_code = -1;
		short		ind_show_paypage = -1;
		short		ind_language = -1;
		short		ind_success_url = -1;
		short		ind_failure_url = -1;
		short		ind_success_ck_url = -1;
		short		ind_failure_ck_url = -1;
		short		ind_encrypt_type = -1;


        EXEC SQL END DECLARE SECTION;

	hv_txn_id.len = strlen(csTxnID);
	memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetTxnDetail txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_gettxndetail CURSOR FOR
		select 
			td_txn_ccy,
			td_txn_country,
			td_pay_method,
			td_bank_code,
			td_show_paypage,
			td_language,
			td_success_url,
			td_failure_url,
			td_success_callback_url,
			td_failure_callback_url,
			td_encrypt_type
		  from txn_detail
		 where td_txn_id = :hv_txn_id;


        EXEC SQL OPEN c_cursor_gettxndetail;
        do {
                EXEC SQL FETCH c_cursor_gettxndetail
                INTO
			:v_txn_ccy:ind_txn_ccy,
			:v_txn_country:ind_txn_country,
			:v_pay_method:ind_pay_method,
			:v_bank_code:ind_bank_code,
			:v_show_paypage:ind_show_paypage,
			:v_language:ind_language,
			:v_success_url:ind_success_url,
			:v_failure_url:ind_failure_url,
			:v_success_ck_url:ind_success_ck_url,
			:v_failure_ck_url:ind_failure_ck_url,
			:v_encrypt_type:ind_encrypt_type;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/* txn ccy */
                if (ind_txn_ccy  >=  0) { 
			v_txn_ccy.arr[v_txn_ccy.len] = '\0';
                        PutField_CString(myHash,"txn_ccy",v_txn_ccy.arr);
DEBUGLOG(("GetTxnDetail txn_ccy = [%s]\n",v_txn_ccy.arr));
		}

/* txn country */
                if (ind_txn_country  >=  0) { 
			v_txn_country.arr[v_txn_ccy.len] = '\0';
                        PutField_CString(myHash,"txn_country",v_txn_country.arr);
DEBUGLOG(("GetTxnDetail txn_country = [%s]\n",v_txn_country.arr));
		}

/* pay method */
                if (ind_pay_method  >=  0) { 
			v_pay_method.arr[v_pay_method.len] = '\0';
                        PutField_CString(myHash,"pay_method",v_pay_method.arr);
DEBUGLOG(("GetTxnDetail pay_method = [%s]\n",v_pay_method.arr));
		}

/* bank code */
                if (ind_bank_code  >=  0) { 
			v_bank_code.arr[v_bank_code.len] = '\0';
                        PutField_CString(myHash,"bank_code",v_bank_code.arr);
DEBUGLOG(("GetTxnDetail bank_code = [%s]\n",v_bank_code.arr));
		}

/* show paypage */
                if (ind_show_paypage  >=  0) { 
                        PutField_Char(myHash,"show_paypage",v_show_paypage);
DEBUGLOG(("GetTxnDetail show_paypage = [%c]\n",v_show_paypage));
		}


/* language */
                if (ind_language  >=  0) { 
			v_language.arr[v_language.len] = '\0';
                        PutField_CString(myHash,"language",v_language.arr);
DEBUGLOG(("GetTxnDetail language = [%s]\n",v_language.arr));
		}

/* success url */
                if (ind_success_url  >=  0) { 
			v_success_url.arr[v_success_url.len] = '\0';
                        PutField_CString(myHash,"success_url",v_success_url.arr);
DEBUGLOG(("GetTxnDetail success_url = [%s]\n",v_success_url.arr));
		}

/* failure url */
                if (ind_failure_url  >=  0) { 
			v_failure_url.arr[v_failure_url.len] = '\0';
                        PutField_CString(myHash,"failure_url",v_failure_url.arr);
DEBUGLOG(("GetTxnDetail failure_url = [%s]\n",v_failure_url.arr));
		}

/* success callback url */
                if (ind_success_ck_url  >=  0) { 
			v_success_ck_url.arr[v_success_ck_url.len] = '\0';
                        PutField_CString(myHash,"success_callback_url",v_success_ck_url.arr);
DEBUGLOG(("GetTxnDetail success_callback_url = [%s]\n",v_success_ck_url.arr));
		}

/* failure callback_url */
                if (ind_failure_ck_url  >=  0) { 
			v_failure_ck_url.arr[v_failure_ck_url.len] = '\0';
                        PutField_CString(myHash,"failure_callback_url",v_failure_ck_url.arr);
DEBUGLOG(("GetTxnDetail failure_ck_url = [%s]\n",v_failure_ck_url.arr));
		}

/* encrypt_type*/
                if (ind_encrypt_type >=  0) { 
			v_encrypt_type.arr[v_encrypt_type.len] = '\0';
                        PutField_CString(myHash,"encrypt_type",v_encrypt_type.arr);
DEBUGLOG(("GetTxnDetail encrypt_type = [%s]\n",v_encrypt_type.arr));
		}


		RecordSet_Add(myRec,myHash);
	}
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_gettxndetail;


DEBUGLOG(("GetTxnDetail Normal Exit\n")); 
        return  PD_OK;

gettxndetail_error:
DEBUGLOG(("gettxndetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_gettxndetail;
        return PD_ERR;
}


int MatchMerchantRef(const char* csMerchantId,
                     const char* csMerchantRef)
{
        EXEC SQL WHENEVER SQLERROR GOTO matchmerchantref_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                
        EXEC SQL BEGIN DECLARE SECTION;
	 	short           hv_return_value;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_merchant_ref[PD_MERCHANT_REF_LEN];

                        
        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("MatchMerchantRef merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
                
        hv_merchant_ref.len = strlen(csMerchantRef);
        memcpy(hv_merchant_ref.arr,csMerchantRef,hv_merchant_ref.len);
DEBUGLOG(("MatchMerchantRef merchant_ref = [%.*s]\n",hv_merchant_ref.len,hv_merchant_ref.arr));

        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_transaction_matchmref(:hv_merchant_id,
                                                		     :hv_merchant_ref);
                END;
        END-EXEC;

        if (hv_return_value > 0)  {

DEBUGLOG(("MatchMerchantref Found\n"));
                return PD_FOUND;
	}
	else {
DEBUGLOG(("MatchMerchantref Not Found\n"));
		return PD_NOT_FOUND;
	}
        

matchmerchantref_error:
DEBUGLOG(("matchmerchantref_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int MatchRespTxn(const char* csTxnSeq,
                     const char cStatus)
{
        EXEC SQL WHENEVER SQLERROR GOTO MatchRespTxn_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                
        EXEC SQL BEGIN DECLARE SECTION;
	 	short           hv_return_value;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];
		char		hv_status;

                        
        EXEC SQL END DECLARE SECTION;

        hv_txn_id.len = strlen(csTxnSeq);
        memcpy(hv_txn_id.arr,csTxnSeq,hv_txn_id.len);
DEBUGLOG(("MatchRespTxn txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
                
	hv_status = cStatus;
DEBUGLOG(("MatchRespTxn status = [%c]\n",hv_status));

        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_txn_matchresptxn(:hv_txn_id,
                                                		     :hv_status);
                END;
        END-EXEC;

        if (hv_return_value > 0)  {

DEBUGLOG(("MatchRespTxn Found\n"));
                return PD_FOUND;
	}
	else {
DEBUGLOG(("MatchRespTxn Not Found\n"));
		return PD_NOT_FOUND;
	}
        

MatchRespTxn_error:
DEBUGLOG(("MatchRespTxn_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}



int GetTxnIdByTxnDateAndArInd(const char* csTxnDate, const char cArInd, recordset_t* myRec)
{
        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO gettxnid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_txn_date[PD_DATE_LEN];
		char		hv_ar_ind;

		varchar		v_txn_id[PD_TXN_SEQ_LEN];

		short		ind_txn_id;

	EXEC SQL END DECLARE SECTION;

	hv_txn_date.len = strlen(csTxnDate);
	memcpy(hv_txn_date.arr,csTxnDate,hv_txn_date.len);
DEBUGLOG(("GetTxnIdByTxnDateAndArInd txn_date = [%.*s]\n",hv_txn_date.len,hv_txn_date.arr));

	hv_ar_ind = cArInd;
DEBUGLOG(("GetTxnIdByTxnDateAndArInd ar_ind=[%c]\n",hv_ar_ind));
	
	
        EXEC SQL DECLARE c_cursor_gettxnid CURSOR FOR
		select 
			th_txn_id
		from	txn_header
		where	th_transmission_datetime = :hv_txn_date
		and	th_ar_ind = :hv_ar_ind
		order by  th_txn_id;


        EXEC SQL OPEN c_cursor_gettxnid;
	do {
		EXEC SQL FETCH c_cursor_gettxnid
		INTO
			:v_txn_id:ind_txn_id;
	
                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/// txn id
                if (ind_txn_id  >=  0) { 
			v_txn_id.arr[v_txn_id.len] = '\0';
                        PutField_CString(myHash,"txn_id",v_txn_id.arr);
DEBUGLOG(("GetTxnIdByTxnDateAndArInd txn_id = [%s]\n",v_txn_id.arr));
		}

		RecordSet_Add(myRec,myHash);

	}while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_gettxnid;


DEBUGLOG(("GetTxnIdByTxnDateAndArInd Normal Exit\n")); 
        return  PD_OK;

gettxnid_error:
DEBUGLOG(("gettxnid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_gettxnid;
        return PD_ERR;
}


int GetDetailByTxnDate(const char* csTxnDate, recordset_t* myRec)
{
        hash_t	*myHash;
	char	csTmp[PD_DIGIT_LEN + PD_DECIMAL_LEN + 2];
	char	csDate[PD_DATE_LEN +1];
        char	csTime[PD_TIME_LEN +1];

        EXEC SQL WHENEVER SQLERROR GOTO getdetailbydate_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_txn_date[PD_DATE_LEN];

		///from header///
		varchar		v_txn_id[PD_TXN_SEQ_LEN + 1];
		varchar		v_channel_code[PD_CHANNEL_CODE_LEN + 1];
		char		v_status;
		char		v_ar_ind;
		varchar		v_txn_code[PD_TXN_CODE_LEN + 1];
		varchar		v_client_id[PD_CLIENT_ID_LEN + 1];
		varchar		v_merchant_id[PD_MERCHANT_ID_LEN + 1];
		varchar		v_merchant_ref[PD_MERCHANT_REF_LEN + 1];
		double		v_txn_amt;
		double		v_net_amt;
		varchar		v_local_tm_date[PD_DATE_LEN + 1];
		varchar		v_local_tm_time[PD_TIME_LEN + 1];
		/////////////////

		///from detail///
		varchar		v_txn_ccy[PD_CCY_ID_LEN + 1];
		varchar		v_txn_country[PD_COUNTRY_LEN + 1];
		varchar		v_pay_method[PD_PAY_METHOD_LEN + 1];
		varchar		v_bank_code[PD_BANK_CODE_LEN + 1];
		/////////////////

		///from psp_detail///
		varchar		v_tid[PD_MERCHANT_REF_LEN + 1];
		varchar		v_error_code[PD_ERROR_CODE_LEN + 1];
		/////////////////////

		short		ind_txn_id = -1;
		short		ind_channel_code = -1;
		short		ind_status = -1;
		short		ind_ar_ind = -1;
		short		ind_txn_code = -1;
		short		ind_client_id = -1;
		short		ind_merchant_id = -1;
		short		ind_merchant_ref = -1;
		short		ind_txn_amt = -1;
		short		ind_net_amt = -1;
		short		ind_local_tm_date = -1;
		short		ind_local_tm_time = -1;

		short		ind_txn_ccy = -1;
		short		ind_txn_country = -1;
		short		ind_pay_method = -1;
		short		ind_bank_code = -1;

		short		ind_tid = -1;
		short		ind_error_code = -1;

	EXEC SQL END DECLARE SECTION;

	hv_txn_date.len = strlen(csTxnDate);
	memcpy(hv_txn_date.arr,csTxnDate,hv_txn_date.len);
DEBUGLOG(("GetDetailByTxnDate txn_date = [%.*s]\n",hv_txn_date.len,hv_txn_date.arr));
	
        EXEC SQL DECLARE c_cursor_getdetailbydate CURSOR FOR
		select	a.th_txn_id,
			a.th_input_channel,
			a.th_status,
			a.th_ar_ind,
			a.th_txn_code,
			a.th_client_id,
			a.th_merchant_id,
			a.th_merchant_ref,
			a.th_transaction_amount,
			a.th_net_amount,
			a.th_local_tm_date,
			a.th_local_tm_time,
			b.td_txn_ccy,
			b.td_txn_country,
			b.td_pay_method,
			b.td_bank_code,
			c.tp_tid,
			c.tp_error_code

		from	txn_header a,
			txn_detail b,
			txn_psp_detail c
		where	a.th_transmission_datetime = :hv_txn_date
		and	a.th_txn_id=b.td_txn_id
		and	a.th_txn_id=c.tp_txn_id
		order by  th_txn_id;


        EXEC SQL OPEN c_cursor_getdetailbydate;
	do {
		EXEC SQL FETCH c_cursor_getdetailbydate
		INTO
			:v_txn_id:ind_txn_id,
			:v_channel_code:ind_channel_code,
			:v_status:ind_status,
			:v_ar_ind:ind_ar_ind,
			:v_txn_code:ind_txn_code,
			:v_client_id:ind_client_id,
			:v_merchant_id:ind_merchant_id,
			:v_merchant_ref:ind_merchant_ref,
			:v_txn_amt:ind_txn_amt,
			:v_net_amt:ind_net_amt,
			:v_local_tm_date:ind_local_tm_date,
			:v_local_tm_time:ind_local_tm_time,
			:v_txn_ccy:ind_txn_ccy,
			:v_txn_country:ind_txn_country,
			:v_pay_method:ind_pay_method,
			:v_bank_code:ind_bank_code,
			:v_tid:ind_tid,
			:v_error_code:ind_error_code;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/// txn_id
		if (ind_txn_id  >=  0) { 
			v_txn_id.arr[v_txn_id.len] = '\0';
                        PutField_CString(myHash,"txn_id",v_txn_id.arr);
DEBUGLOG(("GetDetailByTxnDate txn_id = [%s]\n",v_txn_id.arr));
		}


/// channel_code
                if (ind_channel_code  >=  0) { 
			v_channel_code.arr[v_channel_code.len] = '\0';
                        PutField_CString(myHash,"channel_code",v_channel_code.arr);
DEBUGLOG(("GetDetailByTxnDate channel_code = [%s]\n",v_channel_code.arr));
		}

///txn_code
                if (ind_txn_code >= 0) {
                        v_txn_code.arr[v_txn_code.len] ='\0';
                        PutField_CString(myHash,"txn_code",(const char*)v_txn_code.arr);
DEBUGLOG(("GetDetailByTxnDate txn_code = [%s]\n",v_txn_code.arr)); 
                }

///client_id
                if (ind_client_id >= 0) {
                        v_client_id.arr[v_client_id.len] ='\0';
                        PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
DEBUGLOG(("GetDetailByTxnDate client_id = [%s]\n",v_client_id.arr)); 
                }
///status
                if (ind_status >= 0) {
DEBUGLOG(("GetDetailByTxnDate status = [%c]\n",v_status)); 
                        PutField_Char(myHash,"status",v_status);
		}
///ar_ind
                if (ind_ar_ind >= 0) {
DEBUGLOG(("GetDetailByTxnDate ar_ind = [%c]\n",v_ar_ind)); 
                        PutField_Char(myHash,"ar_ind",v_ar_ind);
		}

///merchant_id
                if (ind_merchant_id >= 0) {
                        v_merchant_id.arr[v_merchant_id.len] ='\0';
                        PutField_CString(myHash,"merchant_id",(const char*)v_merchant_id.arr);
DEBUGLOG(("GetDetailByTxnDate merchant_id = [%s]\n",v_merchant_id.arr)); 
                }

///merchant_ref
                if (ind_merchant_ref >= 0) {
                        v_merchant_ref.arr[v_merchant_ref.len] ='\0';
                        PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetDetailByTxnDate merchant_ref = [%s]\n",v_merchant_ref.arr)); 
                }

///txn_amt
                if (ind_txn_amt < 0) 
			v_txn_amt = 0.0;
		dtoc(v_txn_amt,12,0,csTmp);
		trim_leading_zero(csTmp,csTmp);
		PutField_CString(myHash,"txn_amount",csTmp);
                PutField_Double(myHash,"txn_amt",v_txn_amt);
DEBUGLOG(("GetDetailByTxnDate txn_amt = [%s]\n",csTmp)); 


///net_amt
                if (ind_net_amt < 0) 
			v_net_amt = 0.0;	
		dtoc(v_net_amt,12,0,csTmp);
		trim_leading_zero(csTmp,csTmp);
		PutField_CString(myHash,"net_amount",csTmp);
                PutField_Double(myHash,"net_amt",v_net_amt);
DEBUGLOG(("GetDetailByTxnDate net_amt = [%s]\n",csTmp)); 

///local_tm_date
                if (ind_local_tm_date >= 0) {
                        v_local_tm_date.arr[v_local_tm_date.len] ='\0';
			strcpy(csDate,v_local_tm_date.arr);
                        PutField_CString(myHash,"local_tm_date",(const char*)v_local_tm_date.arr);
DEBUGLOG(("GetDetailByTxnDate local_tm_date = [%s]\n",v_local_tm_date.arr)); 
                }

///local_tm_time
                if (ind_local_tm_time >= 0) {
                        v_local_tm_time.arr[v_local_tm_time.len] ='\0';
			strcpy(csTime,v_local_tm_time.arr);
                        PutField_CString(myHash,"local_tm_time",(const char*)v_local_tm_time.arr);
DEBUGLOG(("GetDetailByTxnDate local_tm_time = [%s]\n",v_local_tm_time.arr)); 
                }

/* txn ccy */
                if (ind_txn_ccy  >=  0) { 
			v_txn_ccy.arr[v_txn_ccy.len] = '\0';
                        PutField_CString(myHash,"txn_ccy",v_txn_ccy.arr);
DEBUGLOG(("GetDetailByTxnDate txn_ccy = [%s]\n",v_txn_ccy.arr));
		}

/* txn country */
                if (ind_txn_country  >=  0) { 
			v_txn_country.arr[v_txn_ccy.len] = '\0';
                        PutField_CString(myHash,"txn_country",v_txn_country.arr);
DEBUGLOG(("GetDetailByTxnDate txn_country = [%s]\n",v_txn_country.arr));
		}

/* pay method */
                if (ind_pay_method  >=  0) { 
			v_pay_method.arr[v_pay_method.len] = '\0';
                        PutField_CString(myHash,"pay_method",v_pay_method.arr);
DEBUGLOG(("GetDetailByTxnDate pay_method = [%s]\n",v_pay_method.arr));
		}

/* bank code */
                if (ind_bank_code  >=  0) { 
			v_bank_code.arr[v_bank_code.len] = '\0';
                        PutField_CString(myHash,"bank_code",v_bank_code.arr);
DEBUGLOG(("GetDetailByTxnDate bank_code = [%s]\n",v_bank_code.arr));
		}

/* error_code */
                if (ind_error_code  >=  0) {
                        v_error_code.arr[v_error_code.len] = '\0';
                        PutField_CString(myHash,"error_code",v_error_code.arr);
DEBUGLOG(("GetDetailByTxnDate error_code = [%s]\n",v_error_code.arr));
                }

/* tid */
                if (ind_tid  >=  0) {
                        v_tid.arr[v_tid.len] = '\0';
                        PutField_CString(myHash,"tid",v_tid.arr);
DEBUGLOG(("GetDetailByTxnDate tid = [%s]\n",v_tid.arr));
                }

		RecordSet_Add(myRec,myHash);

	}while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getdetailbydate;


DEBUGLOG(("GetDetailByTxnDate Normal Exit\n")); 
        return  PD_OK;

getdetailbydate_error:
DEBUGLOG(("getdetailbydate_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getdetailbydate;
        return PD_ERR;

}


int GetStatusArIndByMerchIdRef(const char* csMerchId, const char* csMerchRef, hash_t *hStatus)
{
	EXEC SQL WHENEVER SQLERROR GOTO getstatus_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merch_id[PD_MERCHANT_ID_LEN];
		varchar		hv_merch_ref[PD_MERCHANT_REF_LEN];
		char		v_status;
		char		v_ar_ind;
	
		short		ind_status = -1;
		short		ind_ar_ind = -1;
	EXEC SQL END DECLARE SECTION;

	hv_merch_id.len = strlen(csMerchId);
	memcpy(hv_merch_id.arr,csMerchId,hv_merch_id.len);
DEBUGLOG(("GetStatusArIndByMerchIdRef MerchId = [%.*s]\n",hv_merch_id.len,hv_merch_id.arr));


	hv_merch_ref.len = strlen(csMerchRef);
	memcpy(hv_merch_ref.arr,csMerchRef,hv_merch_ref.len);
DEBUGLOG(("GetStatusArIndByMerchIdRef MerchRef= [%.*s]\n",hv_merch_ref.len,hv_merch_ref.arr));

	EXEC SQL DECLARE c_cursor_getstatus CURSOR FOR
		select	th_status,
			th_ar_ind
		from	txn_header
		where	th_merchant_id = :hv_merch_id
		and	th_merchant_ref =:hv_merch_ref;

	EXEC SQL OPEN c_cursor_getstatus;
	do{
		EXEC SQL FETCH c_cursor_getstatus
		INTO
			:v_status:ind_status,
			:v_ar_ind:ind_ar_ind;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

/*status*/
		if(ind_status>=0){
			PutField_Char(hStatus,"status",v_status);
DEBUGLOG(("GetStatusArIndByMerchIdRef status = [%c]\n",v_status));
		}
/*ar_ind*/
		if(ind_ar_ind>=0){
			PutField_Char(hStatus,"ar_ind",v_ar_ind);
DEBUGLOG(("GetStatusArIndByMerchIdRef ar_ind= [%c]\n",v_ar_ind));
		}

	}while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_getstatus;

DEBUGLOG(("GetStatusArIndByMerchIdRef Normal Exit\n"));
        return  PD_OK;

getstatus_error:
DEBUGLOG(("getstatus_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getstatus;
        return PD_ERR;

}


