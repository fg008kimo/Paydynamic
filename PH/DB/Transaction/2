
int GetTxnHeader(const char* csTxnID,
		recordset_t* myRec)
{

	char	csTmp[PD_DIGIT_LEN + PD_DECIMAL_LEN + 2];
	char	csDate[PD_DATE_LEN +1];
	char	csTime[PD_TIME_LEN +1];
	char	csDateTime[PD_DATE_LEN + PD_TIME_LEN +1];
        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO gettxnheader_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_txn_id[PD_TXN_SEQ_LEN];

		varchar		v_org_txn_id[PD_TXN_SEQ_LEN + 1];
		varchar		v_client_id[PD_CLIENT_ID_LEN + 1];
		varchar		v_merchant_id[PD_MERCHANT_ID_LEN + 1];
		varchar		v_merchant_ref[PD_MERCHANT_REF_LEN + 1];
		double		v_txn_amt;
		double		v_net_amt;
		varchar		v_transmission_datetime[PD_DATE_LEN + PD_TIME_LEN + 1];
		varchar		v_local_tm_date[PD_DATE_LEN + 1];
		varchar		v_local_tm_time[PD_TIME_LEN + 1];
		long		v_internal_code;
		varchar		v_channel_code[PD_CHANNEL_CODE_LEN + 1];

		short		ind_org_txn_id = -1;
		short		ind_client_id = -1;
		short		ind_merchant_id = -1;
		short		ind_merchant_ref = -1;
		short		ind_txn_amt = -1;
		short		ind_net_amt = -1;
		short		ind_transmission_datetime = -1;
		short		ind_local_tm_date = -1;
		short		ind_local_tm_time = -1;
		short		ind_internal_code = -1;
		short		ind_channel_code = -1;

        EXEC SQL END DECLARE SECTION;

	hv_txn_id.len = strlen(csTxnID);
	memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetTxnHeader txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_gettxnheader CURSOR FOR
		select th_org_txn_id, 
		       th_client_id,
       		       th_merchant_id,
       		       th_merchant_ref,
		       th_transaction_amount,
		       th_net_amount,
		       th_transmission_datetime,
		       th_local_tm_date,
		       th_local_tm_time,
		       th_internal_code,
		       th_input_channel
                  from txn_header 
                 where th_txn_id = :hv_txn_id;


        EXEC SQL OPEN c_cursor_gettxnheader;
        do {
                EXEC SQL FETCH c_cursor_gettxnheader
                INTO
			:v_org_txn_id:ind_org_txn_id,
			:v_client_id:ind_client_id,
			:v_merchant_id:ind_merchant_id,
			:v_merchant_ref:ind_merchant_ref,
			:v_txn_amt:ind_txn_amt,
			:v_net_amt:ind_net_amt,
			:v_transmission_datetime:ind_transmission_datetime,
			:v_local_tm_date:ind_local_tm_date,
			:v_local_tm_time:ind_local_tm_time,
			:v_internal_code:ind_internal_code,
			:v_channel_code:ind_channel_code;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

                if (ind_org_txn_id >= 0) {
                        v_org_txn_id.arr[v_org_txn_id.len] ='\0';
                        PutField_CString(myHash,"org_txn_id",(const char*)v_org_txn_id.arr);
DEBUGLOG(("GetTxnHeader org_txn_id = [%s]\n",v_org_txn_id.arr)); 
                }

                if (ind_client_id >= 0) {
                        v_client_id.arr[v_client_id.len] ='\0';
                        PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
DEBUGLOG(("GetTxnHeader client_id = [%s]\n",v_client_id.arr)); 
                }

                if (ind_merchant_id >= 0) {
                        v_merchant_id.arr[v_merchant_id.len] ='\0';
                        PutField_CString(myHash,"merchant_id",(const char*)v_merchant_id.arr);
DEBUGLOG(("GetTxnHeader merchant_id = [%s]\n",v_merchant_id.arr)); 
                }
                if (ind_merchant_ref >= 0) {
                        v_merchant_ref.arr[v_merchant_ref.len] ='\0';
                        PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetTxnHeader merchant_ref = [%s]\n",v_merchant_ref.arr)); 
                }

                if (ind_txn_amt < 0) 
			v_txn_amt = 0.0;
		dtoc(v_txn_amt,12,0,csTmp);
		trim_leading_zero(csTmp,csTmp);
		PutField_CString(myHash,"txn_amt",csTmp);
                PutField_Double(myHash,"txn_amount",v_txn_amt);
DEBUGLOG(("GetTxnHeader txn_amt = [%s]\n",csTmp)); 

                if (ind_net_amt < 0) 
			v_net_amt = 0.0;	
		dtoc(v_net_amt,12,0,csTmp);
		trim_leading_zero(csTmp,csTmp);
		PutField_CString(myHash,"net_amt",csTmp);
                PutField_Double(myHash,"net_amt",v_net_amt);
DEBUGLOG(("GetTxnHeader net_amt = [%f]\n",v_net_amt)); 

                if (ind_transmission_datetime >= 0) {
                        v_transmission_datetime.arr[v_transmission_datetime.len] ='\0';
                        PutField_CString(myHash,"transmission_datetime",(const char*)v_transmission_datetime.arr);
DEBUGLOG(("GetTxnHeader transmission_datetime = [%s]\n",v_transmission_datetime.arr)); 
                }
                if (ind_local_tm_date >= 0) {
                        v_local_tm_date.arr[v_local_tm_date.len] ='\0';
			strcpy(csDate,v_local_tm_date.arr);
                        PutField_CString(myHash,"local_tm_date",(const char*)v_local_tm_date.arr);
DEBUGLOG(("GetTxnHeader local_tm_date = [%s]\n",v_local_tm_date.arr)); 
                }
                if (ind_local_tm_time >= 0) {
                        v_local_tm_time.arr[v_local_tm_time.len] ='\0';
			strcpy(csTime,v_local_tm_time.arr);
                        PutField_CString(myHash,"local_tm_time",(const char*)v_local_tm_time.arr);
DEBUGLOG(("GetTxnHeader local_tm_time = [%s]\n",v_local_tm_time.arr)); 
                }
                if (ind_local_tm_time >= 0) {
                        PutField_Int(myHash,"internal_error",v_internal_code);
DEBUGLOG(("GetTxnHeader internal_code = [%d]\n",v_internal_code)); 
		}
                if (ind_channel_code >= 0) {
                        v_channel_code.arr[v_channel_code.len] ='\0';
                        PutField_CString(myHash,"channel_code",(const char*)v_channel_code.arr);
DEBUGLOG(("GetTxnHeader channel_code = [%s]\n",v_channel_code.arr)); 
                }
		strcpy(csDateTime,csDate);
		strcat(csDateTime,csTime);
DEBUGLOG(("GetTxnHeader local_transmission_datetime = [%s]\n",csDateTime));
		PutField_CString(myHash,"local_transmission_datetime",csDateTime);

		RecordSet_Add(myRec,myHash);
	}
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_gettxnheader;


DEBUGLOG(("GetTxnHeader Normal Exit\n")); 
        return  PD_OK;

gettxnheader_error:
DEBUGLOG(("gettxnheader_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_gettxnheader;
        return PD_ERR;
}

