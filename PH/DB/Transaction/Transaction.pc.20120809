/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/07/30              Cody Chan
Add GetTxnHeader ph_posting-date		   2010/11/16		   Cody Chan
Add encrpyt type				   2011/01/25		   LokMan Chow
Add ChkTxnCodeExist				   2011/12/06		   Virginia Yun
markup amt/rate/ccy deleted			   2012/02/01		   LokMan Chow
check duplicate MMS host ref			   2012/02/22		   LokMan Chow
Add substatus			   	           2012/04/13		   Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "Transaction.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;
void Transaction(char    cdebug)
{
        cDebug = cdebug;
}

int Add(const hash_t *hRls)
{
        char		*csTmp;
        char        	cTmp;
	int		iCommit = PD_TRUE;
	int		iTmp;
	double		dTmp;


        EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short 		hv_return_value;

	varchar		hv_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_org_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_channel_code[PD_CHANNEL_CODE_LEN];
	char		hv_status;
	char		hv_ar_ind;
	varchar		hv_sub_status[PD_SUB_STATUS_LEN];
	varchar		hv_txn_code[PD_TXN_CODE_LEN];
	varchar		hv_process_type[PD_PROCESS_TYPE_LEN];
	varchar		hv_process_code[PD_PROCESS_CODE_LEN];
	varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
	varchar		hv_merchant_ref[PD_MERCHANT_REF_LEN];
	varchar		hv_client_id[PD_CLIENT_ID_LEN];
	varchar		hv_host_posting_date[PD_DATE_LEN];
	varchar		hv_transmission_datetime[PD_DATE_LEN + PD_TIME_LEN];
	int		hv_internal_code;
	varchar		hv_response_code[PD_RESPONSE_CODE_LEN];
	double		hv_transaction_amt;
	double		hv_net_amt;
	varchar		hv_net_ccy[PD_CCY_ID_LEN +1];
	varchar		hv_tm_date[PD_DATE_LEN];
	varchar		hv_tm_time[PD_TIME_LEN];
	varchar		hv_local_tm_date[PD_DATE_LEN];
	varchar		hv_local_tm_time[PD_TIME_LEN];
	varchar		hv_add_user[PD_USER_LEN];
	varchar		hv_client_ip[PD_IP_LEN];
	varchar		hv_service_code[PD_SERVICE_CODE_LEN];
	varchar		hv_approval_date[PD_DATE_LEN];



	short		ind_txn_id = -1;
	short		ind_org_txn_id = -1;
	short		ind_channel_code = -1;
	short		ind_status = -1;
	short		ind_ar_ind = -1;
	short		ind_sub_status = -1;
	short		ind_txn_code = -1;
	short		ind_process_type = -1;
	short		ind_process_code = -1;
	short		ind_merchant_id = -1;
	short		ind_merchant_ref = -1;
	short		ind_client_id = -1;
	short		ind_host_posting_date = -1;
	short		ind_transmission_datetime = -1;
	short		ind_internal_code = -1;
	short		ind_response_code = -1;
	short		ind_transaction_amt = -1;
	short		ind_net_amt = -1;
	short		ind_net_ccy = -1;
	short		ind_tm_date = -1;
	short		ind_tm_time = -1;
	short		ind_local_tm_date = -1;
	short		ind_local_tm_time = -1;
	short		ind_add_user = -1;
	short		ind_client_ip= -1;
	short		ind_service_code = -1;
	short		ind_approval_date = -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));

        if (GetField_Int(hRls,"db_commit",&iCommit)) {
DEBUGLOG(("Add:db_commit = [%d]\n",iCommit));
	}

/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("Add:txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
        }
/* org txn_seq */
        if (GetField_CString(hRls,"org_txn_seq",&csTmp)) {
                hv_org_txn_id.len = strlen(csTmp);
                memcpy(hv_org_txn_id.arr,csTmp,hv_org_txn_id.len);
                ind_org_txn_id = 0;
DEBUGLOG(("Add:org_txn_id = [%.*s]\n",hv_org_txn_id.len,hv_org_txn_id.arr));
        }
/* Channel code */
        if (GetField_CString(hRls,"channel_code",&csTmp)) {
                hv_channel_code.len = strlen(csTmp);
                memcpy(hv_channel_code.arr,csTmp,hv_channel_code.len);
                ind_channel_code = 0;
DEBUGLOG(("Add:channel_code = [%.*s]\n",hv_channel_code.len,hv_channel_code.arr));
        }


/* Status */ 
        if (GetField_Char(hRls,"status",&cTmp)) {
		hv_status = cTmp;
                ind_status = 0;
DEBUGLOG(("Add:status = [%c]\n",hv_status));
        }

/* ar ind */ 
        if (GetField_Char(hRls,"ar_ind",&cTmp)) {
		hv_ar_ind = cTmp;
                ind_ar_ind = 0;
DEBUGLOG(("Add:ar_ind = [%c]\n",hv_ar_ind));
        }

/* Sub Status */ 
        if (GetField_CString(hRls,"sub_status",&csTmp)) {
                hv_sub_status.len = strlen(csTmp);
                memcpy(hv_sub_status.arr,csTmp,hv_sub_status.len);
                ind_sub_status = 0;
DEBUGLOG(("Add:sub_status = [%.*s]\n",hv_sub_status.len,hv_sub_status.arr));
        }

/* Txn Code */
        if (GetField_CString(hRls,"txn_code",&csTmp)) {
                hv_txn_code.len = strlen(csTmp);
                memcpy(hv_txn_code.arr,csTmp,hv_txn_code.len);
                ind_txn_code = 0;
DEBUGLOG(("Add:txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));
        }

/* process type */
        if (GetField_CString(hRls,"process_type",&csTmp)) {
                hv_process_type.len = strlen(csTmp);
                memcpy(hv_process_type.arr,csTmp,hv_process_type.len);
                ind_process_type = 0;
DEBUGLOG(("Add:process_type = [%.*s]\n",hv_process_type.len,hv_process_type.arr));
        }

/* process code */
        if (GetField_CString(hRls,"process_code",&csTmp)) {
                hv_process_code.len = strlen(csTmp);
                memcpy(hv_process_code.arr,csTmp,hv_process_code.len);
                ind_process_code = 0;
DEBUGLOG(("Add:process_code = [%.*s]\n",hv_process_code.len,hv_process_code.arr));
        }

/* Merchant No */
        if (GetField_CString(hRls,"merchant_id",&csTmp)) {
                hv_merchant_id.len = strlen(csTmp);
                memcpy(hv_merchant_id.arr,csTmp,hv_merchant_id.len);
                ind_merchant_id = 0;
DEBUGLOG(("Add:merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        }

/* Merchant ref */
        if (GetField_CString(hRls,"merchant_ref",&csTmp)) {
                hv_merchant_ref.len = strlen(csTmp);
                memcpy(hv_merchant_ref.arr,csTmp,hv_merchant_ref.len);
                ind_merchant_ref = 0;
DEBUGLOG(("Add:merchant_ref = [%.*s]\n",hv_merchant_ref.len,hv_merchant_ref.arr));
        }



/* Client ID */
        if (GetField_CString(hRls,"client_id",&csTmp)) {
                hv_client_id.len = strlen(csTmp);
                memcpy(hv_client_id.arr,csTmp,hv_client_id.len);
                ind_client_id = 0;
DEBUGLOG(("Add:client_id = [%.*s]\n",hv_client_id.len,hv_client_id.arr));
        }
/* host posting date */
        if (GetField_CString(hRls,"host_posting_date",&csTmp)) {
                hv_host_posting_date.len = strlen(csTmp);
                memcpy(hv_host_posting_date.arr,csTmp,hv_host_posting_date.len);
                ind_host_posting_date = 0;
DEBUGLOG(("Add:host_posting_date = [%.*s]\n",hv_host_posting_date.len,hv_host_posting_date.arr));
        }



/* internal code */
        if (GetField_Int(hRls,"internal_code",&iTmp)) {
		hv_internal_code = iTmp;
                ind_internal_code = 0;
DEBUGLOG(("Add:settlement_date = [%d]\n",hv_internal_code));
        }

/* response code  */
        if (GetField_CString(hRls,"response_code",&csTmp)) {
                hv_response_code.len = strlen(csTmp);
                memcpy(hv_response_code.arr,csTmp,hv_response_code.len);
                ind_response_code = 0;
DEBUGLOG(("Add:response_code = [%.*s]\n",hv_response_code.len,hv_response_code.arr));
        }

/* transaction amt   */
        if (GetField_Double(hRls,"txn_amt",&dTmp)) {
		hv_transaction_amt = dTmp;
                ind_transaction_amt = 0;
DEBUGLOG(("Add:txn_amt = [%f]\n",hv_transaction_amt));
        }

/* net amt   */
        if (GetField_Double(hRls,"net_amt",&dTmp)) {
		hv_net_amt = dTmp;
                ind_net_amt = 0;
DEBUGLOG(("Add:net_amt = [%f]\n",hv_net_amt));
        }

/* net ccy */
        if (GetField_CString(hRls,"net_ccy",&csTmp)) {
                hv_net_ccy.len = strlen(csTmp);
                memcpy(hv_net_ccy.arr,csTmp,hv_net_ccy.len);
                ind_net_ccy = 0;
DEBUGLOG(("Add:net_ccy = [%.*s]\n",hv_net_ccy.len,hv_net_ccy.arr));
        }

/* transmission_datetime */
        if (GetField_CString(hRls,"transmission_datetime",&csTmp)) {
                hv_transmission_datetime.len = strlen(csTmp);
                memcpy(hv_transmission_datetime.arr,csTmp,hv_transmission_datetime.len);
                ind_transmission_datetime = 0;
DEBUGLOG(("Add:transmission_datetime = [%.*s]\n",hv_transmission_datetime.len,hv_transmission_datetime.arr));
        }

/* tm date */
        if (GetField_CString(hRls,"tm_date",&csTmp)) {
                hv_tm_date.len = strlen(csTmp);
                memcpy(hv_tm_date.arr,csTmp,hv_tm_date.len);
                ind_tm_date = 0;
DEBUGLOG(("Add:tm_date = [%.*s]\n",hv_tm_date.len,hv_tm_date.arr));
        }

/* tm time */
        if (GetField_CString(hRls,"tm_time",&csTmp)) {
                hv_tm_time.len = strlen(csTmp);
                memcpy(hv_tm_time.arr,csTmp,hv_tm_time.len);
                ind_tm_time = 0;
DEBUGLOG(("Add:tm_time = [%.*s]\n",hv_tm_time.len,hv_tm_time.arr));
        }

/* local tm date */
        if (GetField_CString(hRls,"local_tm_date",&csTmp)) {
                hv_local_tm_date.len = strlen(csTmp);
                memcpy(hv_local_tm_date.arr,csTmp,hv_local_tm_date.len);
                ind_local_tm_date = 0;
DEBUGLOG(("Add:local_tm_date = [%.*s]\n",hv_local_tm_date.len,hv_local_tm_date.arr));
        }

/* local tm time */
        if (GetField_CString(hRls,"local_tm_time",&csTmp)) {
                hv_local_tm_time.len = strlen(csTmp);
                memcpy(hv_local_tm_time.arr,csTmp,hv_local_tm_time.len);
                ind_local_tm_time = 0;
DEBUGLOG(("Add:local_tm_time = [%.*s]\n",hv_local_tm_time.len,hv_local_tm_time.arr));
        }



/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen(csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("Add:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }


/* client ip */
        if (GetField_CString(hRls,"ip_addr",&csTmp)) {
                hv_client_ip.len = strlen(csTmp);
                memcpy(hv_client_ip.arr,csTmp,hv_client_ip.len);
                ind_client_ip = 0;
DEBUGLOG(("Add:client_ip = [%.*s]\n",hv_client_ip.len,hv_client_ip.arr));
        }

/* service_code */
        if (GetField_CString(hRls,"service_code",&csTmp)) {
                hv_service_code.len = strlen(csTmp);
                memcpy(hv_service_code.arr,csTmp,hv_service_code.len);
                ind_service_code = 0;
DEBUGLOG(("Add:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
        }

/* approval_date */
        if (GetField_CString(hRls,"approval_date",&csTmp)) {
                hv_approval_date.len = strlen(csTmp);
                memcpy(hv_approval_date.arr,csTmp,hv_approval_date.len);
                ind_approval_date = 0;
DEBUGLOG(("Add:approval_date = [%.*s]\n",hv_approval_date.len,hv_approval_date.arr));
        }

	EXEC SQL EXECUTE
                BEGIN
			:hv_return_value := sp_txn_header_insert(
					:hv_txn_id:ind_txn_id,
					:hv_org_txn_id:ind_org_txn_id,
					:hv_channel_code:ind_channel_code,
					:hv_status:ind_status,
					:hv_ar_ind:ind_ar_ind,
					:hv_sub_status:ind_sub_status,
					:hv_txn_code:ind_txn_code,
					:hv_process_type:ind_process_type,
					:hv_process_code:ind_process_code,
					:hv_merchant_id:ind_merchant_id,
					:hv_merchant_ref:ind_merchant_ref,
					:hv_client_id:ind_client_id,
					:hv_host_posting_date:ind_host_posting_date,
					:hv_transmission_datetime:ind_transmission_datetime,
					:hv_internal_code:ind_internal_code,
					:hv_response_code:ind_response_code,
					:hv_transaction_amt:ind_transaction_amt,
					:hv_net_amt:ind_net_amt,
					:hv_net_ccy:ind_net_ccy,
					:hv_tm_date:ind_tm_date,
					:hv_tm_time:ind_tm_time,
					:hv_local_tm_date:ind_local_tm_date,
					:hv_local_tm_time:ind_local_tm_time,
					:hv_add_user:ind_add_user,
					:hv_add_user:ind_add_user,
					:hv_client_ip:ind_client_ip,
					:hv_service_code:ind_service_code,
					:hv_approval_date:ind_approval_date);
	        END;
        END-EXEC;

// update txn sub status
        AddTxnStatusLog(hRls);

DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("Add:Normal Exit\n"));
		if (iCommit == PD_TRUE)
			TxnCommit();
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("Transaction_Add: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("Transaction_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		TxnAbort();
                return PD_ERR;
        }

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_Add: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR TxnAbort\n"));
	TxnAbort();
        return PD_INTERNAL_ERR;
}

int Update(const hash_t *hRls)
{

	char*	csTmp;
	char	cTmp;
	double	dTmp;
	int	iTmp;
	char*	csBuf;
	char*	csTxnId;
        EXEC SQL WHENEVER SQLERROR GOTO update_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

	varchar 	hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr,"update txn_header set th_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"txn_seq",&csTxnId);
DEBUGLOG(("Update:txn_id = [%s]\n",csTxnId));

/* org txn_seq */
        if (GetField_CString(hRls,"org_txn_seq",&csTmp)) {
DEBUGLOG(("Update:org_txn_id = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_org_txn_id = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* Channel code */
        if (GetField_CString(hRls,"channel_code",&csTmp)) {
DEBUGLOG(("Update:channel_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_input_channel = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* Status */ 
        if (GetField_Char(hRls,"status",&cTmp)) {
DEBUGLOG(("Update:status = [%c]\n",cTmp));
		sprintf(csBuf,"%c",cTmp);
		strcat((char*)hv_dynstmt.arr, ",th_status = '");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* ar ind */ 
        if (GetField_Char(hRls,"ar_ind",&cTmp)) {
DEBUGLOG(("Update:ar_ind = [%c]\n",cTmp));
		sprintf(csBuf,"%c",cTmp);
		strcat((char*)hv_dynstmt.arr, ",th_ar_ind = '");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* Sub Status */
        if (GetField_CString(hRls,"sub_status",&csTmp)) {
DEBUGLOG(("Update:sub_status = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",th_sub_status = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* Txn Code */
        if (GetField_CString(hRls,"txn_code",&csTmp)) {
DEBUGLOG(("Update:txn_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_txn_code = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* process type */
        if (GetField_CString(hRls,"process_type",&csTmp)) {
DEBUGLOG(("Update:process_type = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_process_type = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* process code */
        if (GetField_CString(hRls,"process_code",&csTmp)) {
DEBUGLOG(("Update:process_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_process_code = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* Merchant No */
        if (GetField_CString(hRls,"merchant_id",&csTmp)) {
DEBUGLOG(("Update:merchant_id = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_merchant_id = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* Merchant Ref */
        if (GetField_CString(hRls,"merchant_ref",&csTmp)) {
DEBUGLOG(("Update:merchant_ref = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_merchant_ref = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* Client ID */
        if (GetField_CString(hRls,"client_id",&csTmp)) {
DEBUGLOG(("Update:client_id = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_client_id = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* host posting date */
        if (GetField_CString(hRls,"host_posting_date",&csTmp)) {
DEBUGLOG(("Update:host_posting_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_host_posting_date = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* transmission_datetime  */
        if (GetField_CString(hRls,"transmission_datetime",&csTmp)) {
DEBUGLOG(("Update:transmission_datetime = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_transmission_datetime = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* internal code  */
        if (GetField_Int(hRls,"internal_code",&iTmp)) {
DEBUGLOG(("Update:internal_code = [%d]\n",iTmp));
		sprintf(csBuf,"%d",iTmp);
		strcat((char*)hv_dynstmt.arr, ",th_internal_code = '");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* response code  */
        if (GetField_CString(hRls,"response_code",&csTmp)) {
DEBUGLOG(("Update:response_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_response_code = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* transaction amt   */
        if (GetField_Double(hRls,"txn_amt",&dTmp)) {
DEBUGLOG(("Update:txn_amt = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",th_transaction_amount = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* net amt   */
        if (GetField_Double(hRls,"net_amt",&dTmp)) {
DEBUGLOG(("Update:net_amt = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",th_net_amount = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* net ccy */
        if (GetField_CString(hRls,"net_ccy",&csTmp)) {
DEBUGLOG(("Update:net_ccy = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_net_ccy = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* reserve amt   */
        if (GetField_Double(hRls,"reserve_amt",&dTmp)) {
DEBUGLOG(("Update:reserve_amt = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",th_reserve_amount = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* tm date */
        if (GetField_CString(hRls,"tm_date",&csTmp)) {
DEBUGLOG(("Update:tm_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_tm_date = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* tm time */
        if (GetField_CString(hRls,"tm_time",&csTmp)) {
DEBUGLOG(("Update:tm_time = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_tm_time = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* local tm date */
        if (GetField_CString(hRls,"local_tm_date",&csTmp)) {
DEBUGLOG(("Update:local_tm_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_local_tm_date = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* local tm time */
        if (GetField_CString(hRls,"local_tm_time",&csTmp)) {
DEBUGLOG(("Update:local_tm_time = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_local_tm_time = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* ip_addr */
        if (GetField_CString(hRls,"ip_addr",&csTmp)) {
DEBUGLOG(("Update:ip_addr = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_client_ip = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* approval date */
        if (GetField_CString(hRls,"approval_date",&csTmp)) {
DEBUGLOG(("Update:approval_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_approval_date = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
/* approval timestamp */
		strcat((char*)hv_dynstmt.arr, ",th_approval_timestamp = systimestamp");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* service_code */
        if (GetField_CString(hRls,"service_code",&csTmp)) {
DEBUGLOG(("Update:service_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_service_code= '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* ex_supplier */ 
        if (GetField_Char(hRls,"ex_supplier",&cTmp)) {
DEBUGLOG(("Update:ex_supplier = [%c]\n",cTmp));
		sprintf(csBuf,"%c",cTmp);
		strcat((char*)hv_dynstmt.arr, ",th_ex_supplier = '");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/*ex_rate*/
        if (GetField_Double(hRls,"ex_rate",&dTmp)) {
DEBUGLOG(("Update:ex_rate = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",th_ex_rate = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* markup ccy 
        if (GetField_CString(hRls,"markup_ccy",&csTmp)) {
DEBUGLOG(("Update:markup_ccy = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_markup_ccy = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/// markup rate
        if (GetField_Double(hRls,"markup_rate",&dTmp)) {
DEBUGLOG(("Update:markup_rate = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",th_markup_rate = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/// markup amount
        if (GetField_Double(hRls,"markup_amt",&dTmp)) {
DEBUGLOG(("Update:markup_amt = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",th_markup_amount = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
*/

/* settlement txn amount */
        if (GetField_Double(hRls,"settlement_txn_amt",&dTmp)) {
DEBUGLOG(("Update:settlement_txn_amt = [%lf]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",th_settlement_txn_amount = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
DEBUGLOG(("Update:add_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_create_user = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* update user */
        if (GetField_CString(hRls,"update_user",&csTmp)) {
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_update_user = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* customer_name */
        if (GetField_CString(hRls,"customer_name",&csTmp)) {
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_customer_name = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* customer_family_name */
        if (GetField_CString(hRls,"customer_family_name",&csTmp)) {
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_customer_family_name = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
/* customer_tel */
        if (GetField_CString(hRls,"customer_tel",&csTmp)) {
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",th_customer_tel = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

	strcat((char *)hv_dynstmt.arr, " WHERE th_txn_id = '");
        strcat((char *)hv_dynstmt.arr, csTxnId);
        strcat((char *)hv_dynstmt.arr, "'");
       	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);

// update txn sub status 
	AddTxnStatusLog(hRls);

DEBUGLOG(("Update Normal Exit\n"));
	return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
	TxnAbort();
        return PD_INTERNAL_ERR;
}

int AddDetail(const hash_t *hRls)
{
        char		*csTmp;
	char		cTmp;
	int		iTmp;

        EXEC SQL WHENEVER SQLERROR GOTO adddetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short 		hv_return_value;

	varchar		hv_txn_id[PD_TXN_SEQ_LEN];	
	varchar		hv_txn_ccy[PD_CCY_ID_LEN];
	varchar		hv_txn_country[PD_COUNTRY_LEN];
	varchar		hv_pay_method[PD_PAY_METHOD_LIST_LEN];
	varchar		hv_bank_code[PD_AC_BANK_LEN];
	varchar		hv_bank_name[PD_AC_BANK_NAME_LEN];
	varchar		hv_branch_name[PD_AC_BRANCH_LEN];
	varchar		hv_account_id[PD_AC_NO_LEN];
	varchar		hv_account_name[PD_AC_NAME_LEN];
	varchar		hv_identity_id[PD_IDENTITY_ID_LEN];
	varchar		hv_province[PD_PROVINCE_LEN];
	varchar		hv_phone_no[PD_PHONE_NO_LEN];
	varchar		hv_city[PD_CITY_LEN];
	varchar		hv_batch_id[PD_BATCH_LEN];
	char		hv_show_paypage;
	varchar		hv_language[PD_LANGUAGE_LEN];
	varchar		hv_success_url[PD_URL_LEN];
	varchar		hv_failure_url[PD_URL_LEN];
	varchar		hv_success_ck_url[PD_URL_LEN];
	varchar		hv_failure_ck_url[PD_URL_LEN];
	varchar		hv_add_user[PD_USER_LEN];
	varchar		hv_update_user[PD_USER_LEN];
	varchar		hv_encrypt_type[PD_ENCRYPT_LEN];
	int		hv_version_no;
	varchar		hv_remark[PD_REMARK_LEN];
	varchar		hv_selected_pay_method[PD_SELECTED_PAY_METHOD_LEN];
	varchar         hv_customer_tag[PD_CUSTOMER_TAG_LEN];
        varchar         hv_banner_logo[PD_BANNER_LOGO_LEN];
        varchar         hv_echo_msg_1[PD_ECHO_MSG_LEN];
        varchar         hv_echo_msg_2[PD_ECHO_MSG_LEN];
        varchar         hv_echo_msg_3[PD_ECHO_MSG_LEN];
        varchar         hv_opt_1[PD_OPT_LEN];
        varchar         hv_opt_2[PD_OPT_LEN];
        varchar         hv_opt_3[PD_OPT_LEN];



	short		ind_txn_id = -1;
	short		ind_txn_ccy = -1;
	short		ind_txn_country = -1;
	short		ind_pay_method = -1;
	short		ind_bank_code = -1;
	short		ind_bank_name = -1;
	short		ind_branch_name = -1;
	short		ind_account_id = -1;
	short		ind_account_name = -1;
	short		ind_identity_id = -1;
	short		ind_province = -1;
	short		ind_phone_no = -1;
	short		ind_city = -1;
	short		ind_batch_id = -1;
	short		ind_show_paypage = -1;
	short		ind_language = -1;
	short		ind_success_url = -1;
	short		ind_failure_url = -1;
	short		ind_success_ck_url = -1;
	short		ind_failure_ck_url = -1;
	short		ind_add_user = -1;
	short		ind_update_user = -1;
	short		ind_encrypt_type= -1;
	short		ind_version_no = -1;
	short		ind_remark = -1;
	short		ind_selected_pay_method = -1;
	short           ind_customer_tag= -1;
        short           ind_banner_logo= -1;
        short           ind_echo_msg_1= -1;
        short           ind_echo_msg_2= -1;
        short           ind_echo_msg_3= -1;
        short           ind_opt_1= -1;
        short           ind_opt_2= -1;
        short           ind_opt_3= -1;

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("AddDetail: Begin\n"));


/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("AddDetail:txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
        }

/* txn_ccy */
        if (GetField_CString(hRls,"txn_ccy",&csTmp)) {
                hv_txn_ccy.len = strlen(csTmp);
                memcpy(hv_txn_ccy.arr,csTmp,hv_txn_ccy.len);
                ind_txn_ccy = 0;
DEBUGLOG(("AddDetail:txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));
        }

/* txn_country */
        if (GetField_CString(hRls,"txn_country",&csTmp)) {
                hv_txn_country.len = strlen(csTmp);
                memcpy(hv_txn_country.arr,csTmp,hv_txn_country.len);
                ind_txn_country = 0;
DEBUGLOG(("AddDetail:txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));
        }
/* pay_method */
        if (GetField_CString(hRls,"pay_method",&csTmp)) {
                hv_pay_method.len = strlen(csTmp);
                memcpy(hv_pay_method.arr,csTmp,hv_pay_method.len);
                ind_pay_method = 0;
DEBUGLOG(("AddDetail:pay_method = [%.*s]\n",hv_pay_method.len,hv_pay_method.arr));
	}

/* bank_code */
        if (GetField_CString(hRls,"bank_code",&csTmp)) {
                hv_bank_code.len = strlen(csTmp);
                memcpy(hv_bank_code.arr,csTmp,hv_bank_code.len);
                ind_bank_code = 0;
DEBUGLOG(("AddDetail:bank_code = [%.*s]\n",hv_bank_code.len,hv_bank_code.arr));
	}

/* bank_name */
        if (GetField_CString(hRls,"bank_name",&csTmp)) {
                hv_bank_name.len = strlen(csTmp);
                memcpy(hv_bank_name.arr,csTmp,hv_bank_name.len);
                ind_bank_name = 0;
DEBUGLOG(("AddDetail:bank_name = [%.*s]\n",hv_bank_name.len,hv_bank_name.arr));
	}
/* branch_name */
        if (GetField_CString(hRls,"branch_name",&csTmp)) {
                hv_branch_name.len = strlen(csTmp);
                memcpy(hv_branch_name.arr,csTmp,hv_branch_name.len);
                ind_branch_name = 0;
DEBUGLOG(("AddDetail:branch_name = [%.*s]\n",hv_branch_name.len,hv_branch_name.arr));
	}

/* account_id */
        if (GetField_CString(hRls,"account_id",&csTmp)) {
                hv_account_id.len = strlen(csTmp);
                memcpy(hv_account_id.arr,csTmp,hv_account_id.len);
                ind_account_id = 0;
DEBUGLOG(("AddDetail:account_id = [%.*s]\n",hv_account_id.len,hv_account_id.arr));
	}

/* account_name */
        if (GetField_CString(hRls,"account_name",&csTmp)) {
                hv_account_name.len = strlen(csTmp);
                memcpy(hv_account_name.arr,csTmp,hv_account_name.len);
                ind_account_name = 0;
DEBUGLOG(("AddDetail:account_name = [%.*s]\n",hv_account_name.len,hv_account_name.arr));
	}


/* identity_id */
        if (GetField_CString(hRls,"identity_id",&csTmp)) {
                hv_identity_id.len = strlen(csTmp);
                memcpy(hv_identity_id.arr,csTmp,hv_identity_id.len);
                ind_identity_id = 0;
DEBUGLOG(("AddDetail:identity_id = [%.*s]\n",hv_identity_id.len,hv_identity_id.arr));
	}


/* province */
        if (GetField_CString(hRls,"province",&csTmp)) {
                hv_province.len = strlen(csTmp);
                memcpy(hv_province.arr,csTmp,hv_province.len);
                ind_province = 0;
DEBUGLOG(("AddDetail:province = [%.*s]\n",hv_province.len,hv_province.arr));
	}

/* phone_no */
        if (GetField_CString(hRls,"phone_no",&csTmp)) {
                hv_phone_no.len = strlen(csTmp);
                memcpy(hv_phone_no.arr,csTmp,hv_phone_no.len);
                ind_phone_no = 0;
DEBUGLOG(("AddDetail:phone_no = [%.*s]\n",hv_phone_no.len,hv_phone_no.arr));
	}

/* city */
        if (GetField_CString(hRls,"city",&csTmp)) {
                hv_city.len = strlen(csTmp);
                memcpy(hv_city.arr,csTmp,hv_city.len);
                ind_city = 0;
DEBUGLOG(("AddDetail:city = [%.*s]\n",hv_city.len,hv_city.arr));
	}
/* batch_id */
        if (GetField_CString(hRls,"batch_id",&csTmp)) {
                hv_batch_id.len = strlen(csTmp);
                memcpy(hv_batch_id.arr,csTmp,hv_batch_id.len);
                ind_batch_id = 0;
DEBUGLOG(("AddDetail:batch_id = [%.*s]\n",hv_batch_id.len,hv_batch_id.arr));
	}


/* show paypage */
        if (GetField_Char(hRls,"show_paypage",&cTmp)) {
		hv_show_paypage = cTmp;
		ind_show_paypage = 0;
DEBUGLOG(("AddDetail:show_paypage = [%c]\n",hv_show_paypage));
	}

/* language */
        if (GetField_CString(hRls,"language",&csTmp)) {
                hv_language.len = strlen(csTmp);
                memcpy(hv_language.arr,csTmp,hv_language.len);
                ind_language = 0;
DEBUGLOG(("AddDetail:language = [%.*s]\n",hv_language.len,hv_language.arr));
	}

/* success_url */
        if (GetField_CString(hRls,"success_url",&csTmp)) {
                hv_success_url.len = strlen(csTmp);
                memcpy(hv_success_url.arr,csTmp,hv_success_url.len);
                ind_success_url = 0;
DEBUGLOG(("AddDetail:success_url = [%.*s]\n",hv_success_url.len,hv_success_url.arr));
	}

/* failure_url */
        if (GetField_CString(hRls,"failure_url",&csTmp)) {
                hv_failure_url.len = strlen(csTmp);
                memcpy(hv_failure_url.arr,csTmp,hv_failure_url.len);
                ind_failure_url = 0;
DEBUGLOG(("AddDetail:failure_url = [%.*s]\n",hv_failure_url.len,hv_failure_url.arr));
	}

/* success_callback_url */
        if (GetField_CString(hRls,"success_callback_url",&csTmp)) {
                hv_success_ck_url.len = strlen(csTmp);
                memcpy(hv_success_ck_url.arr,csTmp,hv_success_ck_url.len);
                ind_success_ck_url = 0;
DEBUGLOG(("AddDetail:success_ck_url = [%.*s]\n",hv_success_ck_url.len,hv_success_ck_url.arr));
	}

/* failure_callback_url */
        if (GetField_CString(hRls,"failure_callback_url",&csTmp)) {
                hv_failure_ck_url.len = strlen(csTmp);
                memcpy(hv_failure_ck_url.arr,csTmp,hv_failure_ck_url.len);
                ind_failure_ck_url = 0;
DEBUGLOG(("AddDetail:failure_ck_url = [%.*s]\n",hv_failure_ck_url.len,hv_failure_ck_url.arr));
	}
	
	
/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen((const char*)csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("AddDetail:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }
/* update user */
        if (GetField_CString(hRls,"update_user",&csTmp)) {
                hv_update_user.len = strlen((const char*)csTmp);
                memcpy(hv_update_user.arr,csTmp,hv_update_user.len);
                ind_update_user = 0;
DEBUGLOG(("AddDetail:update_user = [%.*s]\n",hv_update_user.len,hv_update_user.arr));
        }


/* encrypt_type */
        if (GetField_CString(hRls,"encrypt_type",&csTmp)) {
                hv_encrypt_type.len = strlen(csTmp);
                memcpy(hv_encrypt_type.arr,csTmp,hv_encrypt_type.len);
                ind_encrypt_type = 0;
DEBUGLOG(("AddDetail:encrypt_type = [%.*s]\n",hv_encrypt_type.len,hv_encrypt_type.arr));
        }

/* version_no */
	if (GetField_Int(hRls,"version_no",&iTmp)) {
		hv_version_no = iTmp;
		ind_version_no = 0;
DEBUGLOG(("AddDetail:version_no = [%d]\n",hv_version_no));
	}

/* remark */
        if (GetField_CString(hRls,"remark",&csTmp)) {
                hv_remark.len = strlen(csTmp);
                memcpy(hv_remark.arr,csTmp,hv_remark.len);
                ind_remark = 0;
DEBUGLOG(("AddDetail:remark = [%.*s]\n",hv_remark.len,hv_remark.arr));
        }

/* selected_pay_method */
        if (GetField_CString(hRls,"selected_pay_method",&csTmp)) {
                hv_selected_pay_method.len = strlen(csTmp);
                memcpy(hv_selected_pay_method.arr,csTmp,hv_selected_pay_method.len);
                ind_selected_pay_method = 0;
DEBUGLOG(("AddDetail:selected_pay_method = [%.*s]\n",hv_selected_pay_method.len,hv_selected_pay_method.arr));
	}


/* customer tag*/
        if (GetField_CString(hRls,"customer_tag", &csTmp)) {
                hv_customer_tag.len = strlen(csTmp);
                memcpy(hv_customer_tag.arr,csTmp,hv_customer_tag.len);
                ind_customer_tag = 0;
DEBUGLOG(("AddDetail:customer_tag = [%.*s][%d]\n",hv_customer_tag.len,hv_customer_tag.arr,hv_customer_tag.len));
        }

/* banner_logo*/
        if (GetField_CString(hRls,"banner_logo", &csTmp)) {
                hv_banner_logo.len = strlen(csTmp);
                memcpy(hv_banner_logo.arr,csTmp,hv_banner_logo.len);
                ind_banner_logo= 0;
DEBUGLOG(("AddDetail:banner_logo = [%.*s][%d]\n",hv_banner_logo.len,hv_banner_logo.arr,hv_banner_logo.len));
        }

/* echo_msg*/
        if (GetField_CString(hRls,"echo_msg_1", &csTmp)) {
                hv_echo_msg_1.len = strlen(csTmp);
                memcpy(hv_echo_msg_1.arr,csTmp,hv_echo_msg_1.len);
                ind_echo_msg_1= 0;
DEBUGLOG(("AddDetail:echo_msg_1 = [%.*s][%d]\n",hv_echo_msg_1.len,hv_echo_msg_1.arr,hv_echo_msg_1.len));
        }

/* echo_msg*/
        if (GetField_CString(hRls,"echo_msg_2", &csTmp)) {
                hv_echo_msg_2.len = strlen(csTmp);
                memcpy(hv_echo_msg_2.arr,csTmp,hv_echo_msg_2.len);
                ind_echo_msg_2= 0;
DEBUGLOG(("AddDetail:echo_msg_2 = [%.*s][%d]\n",hv_echo_msg_2.len,hv_echo_msg_2.arr,hv_echo_msg_2.len));
        }

/* echo_msg*/
        if (GetField_CString(hRls,"echo_msg_3", &csTmp)) {
                hv_echo_msg_3.len = strlen(csTmp);
                memcpy(hv_echo_msg_3.arr,csTmp,hv_echo_msg_3.len);
                ind_echo_msg_3= 0;
DEBUGLOG(("AddDetail:echo_msg_3 = [%.*s][%d]\n",hv_echo_msg_3.len,hv_echo_msg_3.arr,hv_echo_msg_3.len));
        }

/* opt*/
        if (GetField_CString(hRls,"opt_1", &csTmp)) {
                hv_opt_1.len = strlen(csTmp);
                memcpy(hv_opt_1.arr,csTmp,hv_opt_1.len);
                ind_opt_1= 0;
DEBUGLOG(("AddDetail:opt_1 = [%.*s][%d]\n",hv_opt_1.len,hv_opt_1.arr,hv_opt_1.len));
        }

/* opt*/
        if (GetField_CString(hRls,"opt_2", &csTmp)) {
                hv_opt_2.len = strlen(csTmp);
                memcpy(hv_opt_2.arr,csTmp,hv_opt_2.len);
                ind_opt_2= 0;
DEBUGLOG(("AddDetail:opt_2 = [%.*s][%d]\n",hv_opt_2.len,hv_opt_2.arr,hv_opt_2.len));
        }

/* opt*/
        if (GetField_CString(hRls,"opt_3", &csTmp)) {
                hv_opt_3.len = strlen(csTmp);
                memcpy(hv_opt_3.arr,csTmp,hv_opt_3.len);
                ind_opt_3= 0;
DEBUGLOG(("AddDetail:opt_3 = [%.*s][%d]\n",hv_opt_3.len,hv_opt_3.arr,hv_opt_3.len));
        }

	EXEC SQL EXECUTE
                BEGIN
			:hv_return_value := sp_txn_detail_insert(
					:hv_txn_id:ind_txn_id,
					:hv_txn_ccy:ind_txn_ccy,
					:hv_txn_country:ind_txn_country,
					:hv_pay_method:ind_pay_method,
					:hv_bank_code:ind_bank_code,
					:hv_bank_name:ind_bank_name,
					:hv_branch_name:ind_branch_name,
					:hv_account_id:ind_account_id,
					:hv_account_name:ind_account_name,
					:hv_identity_id:ind_identity_id,
					:hv_province:ind_province,
					:hv_phone_no:ind_phone_no,
					:hv_city:ind_city,
					:hv_batch_id:ind_batch_id,
					:hv_show_paypage:ind_show_paypage,
					:hv_language:ind_language,
					:hv_success_url:ind_success_url,
					:hv_failure_url:ind_failure_url,
					:hv_success_ck_url:ind_success_ck_url,
					:hv_failure_ck_url:ind_failure_ck_url,
					:hv_add_user:ind_add_user,
					:hv_update_user:ind_update_user,
					:hv_encrypt_type:ind_encrypt_type,
					:hv_version_no:ind_version_no,
					:hv_remark:ind_remark,
					:hv_selected_pay_method:ind_selected_pay_method,
					:hv_banner_logo:ind_banner_logo,
                                        :hv_customer_tag:ind_customer_tag,
                                        :hv_echo_msg_1:ind_echo_msg_1,
                                        :hv_echo_msg_2:ind_echo_msg_2,
                                        :hv_echo_msg_3:ind_echo_msg_3,
                                        :hv_opt_1:ind_opt_1,
                                        :hv_opt_2:ind_opt_2,
                                        :hv_opt_3:ind_opt_3);
	        END;
        END-EXEC;

DEBUGLOG(("AddDetail:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("AddDetail:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("Transaction_AddDetail: SP_OTHER_ERR\n");
DEBUGLOG(("AddDetail: SP_OTHER_ERR\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("Transaction_Add: SP_ERR\n");
DEBUGLOG(("AddDetail: SP_ERR\n"));
                return PD_ERR;
        }

adddetail_error:
DEBUGLOG(("adddetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_Add: SP_INTERNAL_ERR\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR\n"));
        return PD_INTERNAL_ERR;
}

int UpdateDetail(const hash_t *hRls)
{
	double	dTmp;
	char*	csPtr;
	char*	csBuf;
	char*	csTxnId;
        EXEC SQL WHENEVER SQLERROR GOTO update_detail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

	varchar 	hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("UpdateDetail: Begin\n"));
	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr,"update txn_detail set td_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"txn_seq",&csTxnId);
DEBUGLOG(("UpdateDetail:txn_id = [%s]\n",csTxnId));

/* current_bal*/
        if (GetField_Double(hRls,"current_bal",&dTmp)) {
DEBUGLOG(("UpdateDetail:current_bal= [%f]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",td_current_bal = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* net_bal*/
        if (GetField_Double(hRls,"net_bal",&dTmp)) {
DEBUGLOG(("UpdateDetail:net_bal= [%f]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",td_net_bal = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* open_bal*/
        if (GetField_Double(hRls,"open_bal",&dTmp)) {
DEBUGLOG(("UpdateDetail:open_bal= [%f]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",td_open_bal = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* total_float*/
        if (GetField_Double(hRls,"total_float",&dTmp)) {
DEBUGLOG(("UpdateDetail:total_float= [%f]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",td_total_float = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* total_reserved_amount*/
        if (GetField_Double(hRls,"total_reserved_amount",&dTmp)) {
DEBUGLOG(("UpdateDetail:total_reserved_amount= [%f]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",td_total_reserved_amount = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* total_hold*/
        if (GetField_Double(hRls,"total_hold",&dTmp)) {
DEBUGLOG(("UpdateDetail:total_hold= [%f]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",td_total_hold = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* settlement_in_transit*/
        if (GetField_Double(hRls,"settlement_in_transit",&dTmp)) {
DEBUGLOG(("UpdateDetail:settlement_in_transit= [%f]\n",dTmp));
		sprintf(csBuf,"%f",dTmp);
		strcat((char*)hv_dynstmt.arr, ",td_settlement_in_transit = ");
        	strcat((char*)hv_dynstmt.arr, csBuf);
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* txn_country */
        if (GetField_CString(hRls,"txn_country",&csPtr)) {
DEBUGLOG(("UpdateDetail:txn_country = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",td_txn_country = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* bank code */
        if (GetField_CString(hRls,"bank_code",&csPtr)) {
DEBUGLOG(("UpdateDetail:bank_code = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",td_bank_code = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* pay_method */
        if (GetField_CString(hRls,"pay_method",&csPtr)) {
DEBUGLOG(("UpdateDetail:pay_method = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",td_pay_method = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* selected_pay_method */
        if (GetField_CString(hRls,"selected_pay_method",&csPtr)) {
DEBUGLOG(("UpdateDetail:selected_pay_method = [%s]\n",csPtr));
		strcat((char*)hv_dynstmt.arr, ",td_selected_pay_method = '");
        	strcat((char*)hv_dynstmt.arr, csPtr);
        	strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}


	strcat((char *)hv_dynstmt.arr, " WHERE td_txn_id = '");
        strcat((char *)hv_dynstmt.arr, csTxnId);
        strcat((char *)hv_dynstmt.arr, "'");
       	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);


DEBUGLOG(("UpdateDetail Normal Exit\n"));
	return PD_OK;

update_detail_error:
DEBUGLOG(("update_detail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_UpdateDetail: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("UpdateDetail: SP_INTERNAL_ERR TxnAbort\n"));
	TxnAbort();
        return PD_INTERNAL_ERR;
}


int GetTxnHeader(const char* csTxnID,
		recordset_t* myRec)
{

//	char	csTmp[PD_DIGIT_LEN + PD_DECIMAL_LEN + 2];
	char	csDate[PD_DATE_LEN +1];
	char	csTime[PD_TIME_LEN +1];
	char	csDateTime[PD_DATE_LEN + PD_TIME_LEN +1];
        hash_t *myHash;
	int	iCnt = 0;

        EXEC SQL WHENEVER SQLERROR GOTO gettxnheader_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_txn_id[PD_TXN_SEQ_LEN];

		varchar		v_org_txn_id[PD_TXN_SEQ_LEN + 1];
		varchar		v_client_id[PD_CLIENT_ID_LEN + 1];
		char		v_status;
		char		v_ar_ind;
		varchar		v_txn_code[PD_TXN_CODE_LEN + 1];
		varchar		v_merchant_id[PD_MERCHANT_ID_LEN + 1];
		varchar		v_merchant_ref[PD_MERCHANT_REF_LEN + 1];
		double		v_txn_amt;
		double		v_net_amt;
		varchar		v_transmission_datetime[PD_DATE_LEN + PD_TIME_LEN + 1];
		varchar		v_local_tm_date[PD_DATE_LEN + 1];
		varchar		v_local_tm_time[PD_TIME_LEN + 1];
		varchar		v_tm_date[PD_DATE_LEN + 1];
		varchar		v_tm_time[PD_TIME_LEN + 1];
		long		v_internal_code;
		varchar		v_channel_code[PD_CHANNEL_CODE_LEN + 1];
		varchar		v_response_code[PD_RESPONSE_CODE_LEN + 1];
		varchar		v_host_posting_date[PD_DATE_LEN + 1];
		varchar		v_process_code[PD_PROCESS_CODE_LEN + 1];
		varchar		v_process_type[PD_PROCESS_TYPE_LEN + 1];
		varchar		v_service_code[PD_SERVICE_CODE_LEN + 1];
		varchar		v_client_ip[PD_IP_LEN + 1];
		char		v_ex_supplier;
		double		v_ex_rate;
		double		v_reserve_amt;
		//double		v_markup_amt;
		

		short		ind_org_txn_id = -1;
		short		ind_client_id = -1;
		short		ind_status = -1;
		short		ind_ar_ind = -1;
		short		ind_txn_code = -1;
		short		ind_merchant_id = -1;
		short		ind_merchant_ref = -1;
		short		ind_txn_amt = -1;
		short		ind_net_amt = -1;
		short		ind_transmission_datetime = -1;
		short		ind_local_tm_date = -1;
		short		ind_local_tm_time = -1;
		short		ind_tm_date = -1;
		short		ind_tm_time = -1;
		short		ind_internal_code = -1;
		short		ind_channel_code = -1;
		short		ind_response_code = -1;
		short		ind_host_posting_date = -1;
		short		ind_process_code= -1;
		short		ind_process_type= -1;
		short		ind_service_code = -1;
		short		ind_client_ip = -1;
		short		ind_ex_supplier = -1;
		short		ind_ex_rate = -1;
		short		ind_reserve_amt = -1;
		//short		ind_markup_amt = -1;

        EXEC SQL END DECLARE SECTION;

	hv_txn_id.len = strlen(csTxnID);
	memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetTxnHeader txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_gettxnheader CURSOR FOR
		select th_org_txn_id, 
		       th_client_id,
		       th_status,
		       th_ar_ind,
		       th_txn_code,
       		       th_merchant_id,
       		       th_merchant_ref,
		       th_transaction_amount,
		       th_net_amount,
		       th_transmission_datetime,
		       th_local_tm_date,
		       th_local_tm_time,
		       th_tm_date,
		       th_tm_time,
		       th_internal_code,
		       th_input_channel,
		       th_response_code,
		       th_host_posting_date,
		       th_process_code,
		       th_process_type,
		       th_input_channel,
		       th_service_code,
		       th_client_ip,
		       th_ex_supplier,
		       th_ex_rate,
		       th_reserve_amount
                  from txn_header 
                 where th_txn_id = :hv_txn_id;


        EXEC SQL OPEN c_cursor_gettxnheader;
        do {
                EXEC SQL FETCH c_cursor_gettxnheader
                INTO
			:v_org_txn_id:ind_org_txn_id,
			:v_client_id:ind_client_id,
			:v_status:ind_status,
			:v_ar_ind:ind_ar_ind,
			:v_txn_code:ind_txn_code,
			:v_merchant_id:ind_merchant_id,
			:v_merchant_ref:ind_merchant_ref,
			:v_txn_amt:ind_txn_amt,
			:v_net_amt:ind_net_amt,
			:v_transmission_datetime:ind_transmission_datetime,
			:v_local_tm_date:ind_local_tm_date,
			:v_local_tm_time:ind_local_tm_time,
			:v_tm_date:ind_tm_date,
			:v_tm_time:ind_tm_time,
			:v_internal_code:ind_internal_code,
			:v_channel_code:ind_channel_code,
			:v_response_code:ind_response_code,
			:v_host_posting_date:ind_host_posting_date,
			:v_process_code:ind_process_code,
			:v_process_type:ind_process_type,
			:v_channel_code:ind_channel_code,
			:v_service_code:ind_service_code,
			:v_client_ip:ind_client_ip,
			:v_ex_supplier:ind_ex_supplier,
			:v_ex_rate:ind_ex_rate,
			:v_reserve_amt:ind_reserve_amt;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

		iCnt++;

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

                if (ind_org_txn_id >= 0) {
                        v_org_txn_id.arr[v_org_txn_id.len] ='\0';
                        PutField_CString(myHash,"org_txn_id",(const char*)v_org_txn_id.arr);
DEBUGLOG(("GetTxnHeader org_txn_id = [%s]\n",v_org_txn_id.arr)); 
                }

                if (ind_client_id >= 0) {
                        v_client_id.arr[v_client_id.len] ='\0';
                        PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
DEBUGLOG(("GetTxnHeader client_id = [%s]\n",v_client_id.arr)); 
                }
                if (ind_status >= 0) {
DEBUGLOG(("GetTxnHeader status = [%c]\n",v_status)); 
                        PutField_Char(myHash,"status",v_status);
		}

                if (ind_ar_ind >= 0) {
DEBUGLOG(("GetTxnHeader ar_ind = [%c]\n",v_ar_ind)); 
                        PutField_Char(myHash,"ar_ind",v_ar_ind);
		}

                if (ind_txn_code >= 0) {
                        v_txn_code.arr[v_txn_code.len] ='\0';
                        PutField_CString(myHash,"txn_code",(const char*)v_txn_code.arr);
DEBUGLOG(("GetTxnHeader txn_code = [%s]\n",v_txn_code.arr)); 
                }

                if (ind_process_code >= 0) {
                        v_process_code.arr[v_process_code.len] ='\0';
                        PutField_CString(myHash,"process_code",(const char*)v_process_code.arr);
DEBUGLOG(("GetTxnHeader process_code = [%s]\n",v_process_code.arr)); 
                }

                if (ind_process_type >= 0) {
                        v_process_type.arr[v_process_type.len] ='\0';
                        PutField_CString(myHash,"process_type",(const char*)v_process_type.arr);
DEBUGLOG(("GetTxnHeader process_type = [%s]\n",v_process_type.arr)); 
                }

                if (ind_merchant_id >= 0) {
                        v_merchant_id.arr[v_merchant_id.len] ='\0';
                        PutField_CString(myHash,"merchant_id",(const char*)v_merchant_id.arr);
DEBUGLOG(("GetTxnHeader merchant_id = [%s]\n",v_merchant_id.arr)); 
                }
                if (ind_merchant_ref >= 0) {
                        v_merchant_ref.arr[v_merchant_ref.len] ='\0';
                        PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetTxnHeader merchant_ref = [%s]\n",v_merchant_ref.arr)); 
                }

                if (ind_txn_amt < 0) 
			v_txn_amt = 0.0;
/*
		mydtoc(v_txn_amt,PD_DIGIT_LEN,PD_DECIMAL_LEN,csTmp);
		trim_leading_zero(csTmp,csTmp);
*/
                PutField_Double(myHash,"txn_amt",v_txn_amt);

/*DEBUGLOG(("GetTxnHeader txn_amt = [%s]\n",csTmp)); */
DEBUGLOG(("GetTxnHeader txn_amt = [%f]\n",v_txn_amt)); 

                if (ind_net_amt < 0) 
			v_net_amt = 0.0;	
/*
		mydtoc(v_net_amt,PD_DIGIT_LEN,PD_DECIMAL_LEN,csTmp);
		trim_leading_zero(csTmp,csTmp);
*/
		//PutField_CString(myHash,"net_amt",csTmp);
                PutField_Double(myHash,"net_amt",v_net_amt);
DEBUGLOG(("GetTxnHeader net_amt = [%f]\n",v_net_amt)); 

                if (ind_transmission_datetime >= 0) {
                        v_transmission_datetime.arr[v_transmission_datetime.len] ='\0';
                        PutField_CString(myHash,"transmission_datetime",(const char*)v_transmission_datetime.arr);
DEBUGLOG(("GetTxnHeader transmission_datetime = [%s]\n",v_transmission_datetime.arr)); 
                }
                if (ind_local_tm_date >= 0) {
                        v_local_tm_date.arr[v_local_tm_date.len] ='\0';
			strcpy(csDate,(char*)v_local_tm_date.arr);
                        PutField_CString(myHash,"local_tm_date",(const char*)v_local_tm_date.arr);
DEBUGLOG(("GetTxnHeader local_tm_date = [%s]\n",v_local_tm_date.arr)); 
                }
                if (ind_local_tm_time >= 0) {
                        v_local_tm_time.arr[v_local_tm_time.len] ='\0';
			strcpy(csTime,(char*)v_local_tm_time.arr);
                        PutField_CString(myHash,"local_tm_time",(const char*)v_local_tm_time.arr);
DEBUGLOG(("GetTxnHeader local_tm_time = [%s]\n",v_local_tm_time.arr)); 
                }
                if (ind_tm_date >= 0) {
                        v_tm_date.arr[v_tm_date.len] ='\0';
                        PutField_CString(myHash,"tm_date",(const char*)v_tm_date.arr);
DEBUGLOG(("GetTxnHeader tm_date = [%s]\n",v_tm_date.arr)); 
                }
                if (ind_tm_time >= 0) {
                        v_tm_time.arr[v_tm_time.len] ='\0';
                        PutField_CString(myHash,"tm_time",(const char*)v_tm_time.arr);
DEBUGLOG(("GetTxnHeader tm_time = [%s]\n",v_tm_time.arr)); 
                }
                if (ind_internal_code >= 0) {
                        PutField_Int(myHash,"internal_error",v_internal_code);
DEBUGLOG(("GetTxnHeader internal_code = [%d]\n",v_internal_code)); 
		}
                if (ind_channel_code >= 0) {
                        v_channel_code.arr[v_channel_code.len] ='\0';
                        PutField_CString(myHash,"channel_code",(const char*)v_channel_code.arr);
DEBUGLOG(("GetTxnHeader channel_code = [%s]\n",v_channel_code.arr)); 
                }
                if (ind_response_code >= 0) {
                        v_response_code.arr[v_response_code.len] ='\0';
                        PutField_CString(myHash,"response_code",(const char*)v_response_code.arr);
DEBUGLOG(("GetTxnHeader response_code = [%s]\n",v_response_code.arr)); 
                }
                if (ind_host_posting_date >= 0) {
                        v_host_posting_date.arr[v_host_posting_date.len] ='\0';
                        PutField_CString(myHash,"host_posting_date",(const char*)v_host_posting_date.arr);
DEBUGLOG(("GetTxnHeader host_posting_date = [%s]\n",v_host_posting_date.arr)); 
                }

DEBUGLOG(("GetTxnHeader formation local transmission_datetime\n"));
		strcpy(csDateTime,csDate);
		strcat(csDateTime,csTime);
DEBUGLOG(("GetTxnHeader local_transmission_datetime = [%s]\n",csDateTime));
		PutField_CString(myHash,"local_transmission_datetime",csDateTime);

                if (ind_service_code >= 0) {
                        v_service_code.arr[v_service_code.len] ='\0';
                        PutField_CString(myHash,"service_code",(const char*)v_service_code.arr);
DEBUGLOG(("GetTxnHeader service_code = [%s]\n",v_service_code.arr)); 
                }

                if (ind_client_ip>= 0) {
                        v_client_ip.arr[v_client_ip.len] ='\0';
                        PutField_CString(myHash,"ip_addr",(const char*)v_client_ip.arr);
DEBUGLOG(("GetTxnHeader client_ip = [%s]\n",v_client_ip.arr)); 
                }

                if (ind_ex_supplier>= 0) {
DEBUGLOG(("GetTxnHeader ex_supplier = [%c]\n",v_ex_supplier)); 
                        PutField_Char(myHash,"ex_supplier",v_ex_supplier);
		}

                if (ind_ex_rate < 0) 
			v_ex_rate = 0.0;
DEBUGLOG(("GetTxnHeader ex_rate = [%f]\n",v_ex_rate)); 
		PutField_Double(myHash,"ex_rate",v_ex_rate);
		
                if (ind_reserve_amt< 0) 
			v_reserve_amt= 0.0;
DEBUGLOG(("GetTxnHeader reserve_amt = [%f]\n",v_reserve_amt)); 
		PutField_Double(myHash,"reserve_amt",v_reserve_amt);
		

		RecordSet_Add(myRec,myHash);
	}
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_gettxnheader;


	if (iCnt > 0 ) {
DEBUGLOG(("GetTxnHeader Normal Exit\n")); 
        	return  PD_OK;
	}
	else {
DEBUGLOG(("GetTxnHeader Normal Exit, Not Found\n")); 
		return PD_ERR;
	}

gettxnheader_error:
DEBUGLOG(("gettxnheader_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_gettxnheader;
        return PD_ERR;
}



int GetTxnDetail(const char* csTxnID,
		recordset_t* myRec)
{

        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO gettxndetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_txn_id[PD_TXN_SEQ_LEN];

		varchar		v_txn_ccy[PD_CCY_ID_LEN + 1];
		varchar		v_txn_country[PD_COUNTRY_LEN + 1];
		varchar		v_pay_method[PD_PAY_METHOD_LIST_LEN+ 1];
		varchar		v_bank_code[PD_BANK_CODE_LEN + 1];
		char		v_show_paypage;
		varchar		v_language[PD_LANGUAGE_LEN + 1];
		varchar		v_success_url[PD_URL_LEN + 1];
		varchar		v_failure_url[PD_URL_LEN + 1];
		varchar		v_success_ck_url[PD_URL_LEN + 1];
		varchar		v_failure_ck_url[PD_URL_LEN + 1];
		varchar		v_encrypt_type[PD_ENCRYPT_LEN + 1];
		varchar		v_bank_name[PD_AC_BANK_NAME_LEN + 1];
		varchar		v_branch[PD_AC_BRANCH_LEN + 1];
		varchar		v_account_id[PD_AC_NO_LEN + 1];
		varchar		v_account_name[PD_AC_NAME_LEN + 1];
		varchar		v_batch_id[PD_BATCH_LEN + 1];
		varchar		v_identity_id[PD_IDENTITY_ID_LEN + 1];
		varchar		v_remark[PD_REMARK_LEN + 1];
		varchar		v_selected_pay_method[PD_SELECTED_PAY_METHOD_LEN + 1];
		varchar         v_banner_logo[PD_BANNER_LOGO_LEN + 1];
                varchar         v_customer_tag[PD_CUSTOMER_TAG_LEN + 1];
                varchar         v_echo_msg_1[PD_ECHO_MSG_LEN + 1];
                varchar         v_echo_msg_2[PD_ECHO_MSG_LEN + 1];
                varchar         v_echo_msg_3[PD_ECHO_MSG_LEN + 1];
                varchar         v_opt_1[PD_OPT_LEN + 1];
                varchar         v_opt_2[PD_OPT_LEN + 1];
                varchar         v_opt_3[PD_OPT_LEN + 1];

		short		ind_txn_ccy = -1;
		short		ind_txn_country = -1;
		short		ind_pay_method = -1;
		short		ind_bank_code = -1;
		short		ind_show_paypage = -1;
		short		ind_language = -1;
		short		ind_success_url = -1;
		short		ind_failure_url = -1;
		short		ind_success_ck_url = -1;
		short		ind_failure_ck_url = -1;
		short		ind_encrypt_type = -1;
		short		ind_bank_name = -1;
		short		ind_branch= -1;
		short		ind_account_id= -1;
		short		ind_account_name= -1;
		short		ind_batch_id= -1;
		short		ind_identity_id= -1;
		short		ind_remark = -1;
		short		ind_selected_pay_method = -1;
		short           ind_banner_logo = -1;
                short           ind_customer_tag = -1;
                short           ind_echo_msg_1 = -1;
                short           ind_echo_msg_2 = -1;
                short           ind_echo_msg_3 = -1;
                short           ind_opt_1 = -1;
                short           ind_opt_2 = -1;
                short           ind_opt_3 = -1;


        EXEC SQL END DECLARE SECTION;

	hv_txn_id.len = strlen(csTxnID);
	memcpy(hv_txn_id.arr,csTxnID,hv_txn_id.len);
DEBUGLOG(("GetTxnDetail txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_gettxndetail CURSOR FOR
		select 
			td_txn_ccy,
			td_txn_country,
			td_pay_method,
			td_bank_code,
			td_show_paypage,
			td_language,
			td_success_url,
			td_failure_url,
			td_success_callback_url,
			td_failure_callback_url,
			td_encrypt_type,
			td_bank_name,
			td_branch_name,
			td_account_id,
			td_account_name,
			td_batch_id,
			td_identity_id,
			td_remark,
			td_selected_pay_method,
			td_banner_logo,
                        td_customer_tag,
                        td_echo_msg_1,
                        td_echo_msg_2,
                        td_echo_msg_3,
                        td_opt_1,
                        td_opt_2,
                        td_opt_3
		  from txn_detail
		 where td_txn_id = :hv_txn_id;


        EXEC SQL OPEN c_cursor_gettxndetail;
        do {
                EXEC SQL FETCH c_cursor_gettxndetail
                INTO
			:v_txn_ccy:ind_txn_ccy,
			:v_txn_country:ind_txn_country,
			:v_pay_method:ind_pay_method,
			:v_bank_code:ind_bank_code,
			:v_show_paypage:ind_show_paypage,
			:v_language:ind_language,
			:v_success_url:ind_success_url,
			:v_failure_url:ind_failure_url,
			:v_success_ck_url:ind_success_ck_url,
			:v_failure_ck_url:ind_failure_ck_url,
			:v_encrypt_type:ind_encrypt_type,
			:v_bank_name:ind_bank_name,
			:v_branch:ind_branch,
			:v_account_id:ind_account_id,
			:v_account_name:ind_account_name,
			:v_batch_id:ind_batch_id,
			:v_identity_id:ind_identity_id,
			:v_remark:ind_remark,
			:v_selected_pay_method:ind_selected_pay_method,
			:v_banner_logo:ind_banner_logo,
                        :v_customer_tag:ind_customer_tag,
                        :v_echo_msg_1:ind_echo_msg_1,
                        :v_echo_msg_2:ind_echo_msg_2,
                        :v_echo_msg_3:ind_echo_msg_3,
                        :v_opt_1:ind_opt_1,
                        :v_opt_2:ind_opt_2,
                        :v_opt_3:ind_opt_3;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/* txn ccy */
                if (ind_txn_ccy  >=  0) { 
			v_txn_ccy.arr[v_txn_ccy.len] = '\0';
                        PutField_CString(myHash,"txn_ccy",(const char*)v_txn_ccy.arr);
DEBUGLOG(("GetTxnDetail txn_ccy = [%s]\n",v_txn_ccy.arr));
		}

/* txn country */
                if (ind_txn_country  >=  0) { 
			v_txn_country.arr[v_txn_ccy.len] = '\0';
                        PutField_CString(myHash,"txn_country",(const char*)v_txn_country.arr);
DEBUGLOG(("GetTxnDetail txn_country = [%s]\n",v_txn_country.arr));
		}

/* pay method */
                if (ind_pay_method  >=  0) { 
			v_pay_method.arr[v_pay_method.len] = '\0';
                        PutField_CString(myHash,"pay_method",(const char*)v_pay_method.arr);
DEBUGLOG(("GetTxnDetail pay_method = [%s]\n",v_pay_method.arr));
		}

/* bank code */
                if (ind_bank_code  >=  0) { 
			v_bank_code.arr[v_bank_code.len] = '\0';
                        PutField_CString(myHash,"bank_code",(const char*)v_bank_code.arr);
DEBUGLOG(("GetTxnDetail bank_code = [%s]\n",v_bank_code.arr));
		}

/* show paypage */
                if (ind_show_paypage  >=  0) { 
                        PutField_Char(myHash,"show_paypage",v_show_paypage);
DEBUGLOG(("GetTxnDetail show_paypage = [%c]\n",v_show_paypage));
		}


/* language */
                if (ind_language  >=  0) { 
			v_language.arr[v_language.len] = '\0';
                        PutField_CString(myHash,"language",(const char*)v_language.arr);
DEBUGLOG(("GetTxnDetail language = [%s]\n",v_language.arr));
		}

/* success url */
                if (ind_success_url  >=  0) { 
			v_success_url.arr[v_success_url.len] = '\0';
                        PutField_CString(myHash,"success_url",(const char*)v_success_url.arr);
DEBUGLOG(("GetTxnDetail success_url = [%s]\n",v_success_url.arr));
		}

/* failure url */
                if (ind_failure_url  >=  0) { 
			v_failure_url.arr[v_failure_url.len] = '\0';
                        PutField_CString(myHash,"failure_url",(const char*)v_failure_url.arr);
DEBUGLOG(("GetTxnDetail failure_url = [%s]\n",v_failure_url.arr));
		}

/* success callback url */
                if (ind_success_ck_url  >=  0) { 
			v_success_ck_url.arr[v_success_ck_url.len] = '\0';
                        PutField_CString(myHash,"success_callback_url",(const char*)v_success_ck_url.arr);
DEBUGLOG(("GetTxnDetail success_callback_url = [%s]\n",v_success_ck_url.arr));
		}

/* failure callback_url */
                if (ind_failure_ck_url  >=  0) { 
			v_failure_ck_url.arr[v_failure_ck_url.len] = '\0';
                        PutField_CString(myHash,"failure_callback_url",(const char*)v_failure_ck_url.arr);
DEBUGLOG(("GetTxnDetail failure_ck_url = [%s]\n",v_failure_ck_url.arr));
		}

/* encrypt_type*/
                if (ind_encrypt_type >=  0) { 
			v_encrypt_type.arr[v_encrypt_type.len] = '\0';
                        PutField_CString(myHash,"encrypt_type",(const char*)v_encrypt_type.arr);
DEBUGLOG(("GetTxnDetail encrypt_type = [%s]\n",v_encrypt_type.arr));
		}

/* bank_name*/
                if (ind_bank_name >= 0) { 
			v_bank_name.arr[v_bank_name.len] = '\0';
                        PutField_CString(myHash,"bank_name",(const char*)v_bank_name.arr);
DEBUGLOG(("GetTxnDetail bank_name = [%s]\n",v_bank_name.arr));
		}

/* branch_name */
                if (ind_branch>=  0) { 
			v_branch.arr[v_branch.len] = '\0';
                        PutField_CString(myHash,"branch",(const char*)v_branch.arr);
DEBUGLOG(("GetTxnDetail branch= [%s]\n",v_branch.arr));
		}

/* account_id*/
                if (ind_account_id>=  0) { 
			v_account_id.arr[v_account_id.len] = '\0';
                        PutField_CString(myHash,"account_id",(const char*)v_account_id.arr);
DEBUGLOG(("GetTxnDetail account_id = [%s]\n",v_account_id.arr));
		}

/* account_name*/
                if (ind_account_name>=  0) { 
			v_account_name.arr[v_account_name.len] = '\0';
                        PutField_CString(myHash,"account_name",(const char*)v_account_name.arr);
DEBUGLOG(("GetTxnDetail account_name = [%s]\n",v_account_name.arr));
		}

/* batch_id*/
                if (ind_batch_id>=  0) { 
			v_batch_id.arr[v_batch_id.len] = '\0';
                        PutField_CString(myHash,"batch_id",(const char*)v_batch_id.arr);
DEBUGLOG(("GetTxnDetail batch_id = [%s]\n",v_batch_id.arr));
		}

/* identity_id*/
                if (ind_identity_id>=  0) { 
			v_identity_id.arr[v_identity_id.len] = '\0';
                        PutField_CString(myHash,"identity_id",(const char*)v_identity_id.arr);
DEBUGLOG(("GetTxnDetail identity_i d= [%s]\n",v_identity_id.arr));
		}
/* remark*/
                if (ind_remark>=  0) { 
			v_remark.arr[v_remark.len] = '\0';
                        PutField_CString(myHash,"remark",(const char*)v_remark.arr);
DEBUGLOG(("GetTxnDetail remark d= [%s]\n",v_remark.arr));
		}

/* selected pay method */
                if (ind_selected_pay_method  >=  0) { 
			v_selected_pay_method.arr[v_selected_pay_method.len] = '\0';
                        PutField_CString(myHash,"selected_pay_method",(const char*)v_selected_pay_method.arr);
DEBUGLOG(("GetTxnDetail selected_pay_method = [%s]\n",v_selected_pay_method.arr));
		}
/*banner_logo */
                if (ind_banner_logo>=  0) {
                        v_banner_logo.arr[v_banner_logo.len] = '\0';
                        PutField_CString(myHash,"banner_logo",(const char*)v_banner_logo.arr);
DEBUGLOG(("GetTxnDetail banner_logo = [%s]\n",v_banner_logo.arr));
                }

/* customer_tag*/
                if (ind_customer_tag>=  0) {
                        v_customer_tag.arr[v_customer_tag.len] = '\0';
                        PutField_CString(myHash,"customer_tag",(const char*)v_customer_tag.arr);
DEBUGLOG(("GetTxnDetail customer_tag = [%s]\n",v_customer_tag.arr));
                }

/* echo_msg*/   
                if (ind_echo_msg_1>=  0) { 
                        v_echo_msg_1.arr[v_echo_msg_1.len] = '\0';
                        PutField_CString(myHash,"echo_msg_1",(const char*)v_echo_msg_1.arr);
DEBUGLOG(("GetTxnDetail echo_msg_1 = [%s]\n",v_echo_msg_1.arr));
                }
                
/* echo_msg*/           
                if (ind_echo_msg_2>=  0) { 
                        v_echo_msg_2.arr[v_echo_msg_2.len] = '\0';
                        PutField_CString(myHash,"echo_msg_2",(const char*)v_echo_msg_2.arr);
DEBUGLOG(("GetTxnDetail echo_msg_2 = [%s]\n",v_echo_msg_2.arr));
                }

/* echo_msg*/
                if (ind_echo_msg_3>=  0) {
                        v_echo_msg_3.arr[v_echo_msg_3.len] = '\0';
                        PutField_CString(myHash,"echo_msg_3",(const char*)v_echo_msg_3.arr);
DEBUGLOG(("GetTxnDetail echo_msg_3 = [%s]\n",v_echo_msg_3.arr));
                }

/* opt*/
                if (ind_opt_1>=  0) {
                        v_opt_1.arr[v_opt_1.len] = '\0';
                        PutField_CString(myHash,"opt_1",(const char*)v_opt_1.arr);
DEBUGLOG(("GetTxnDetail opt_1 = [%s]\n",v_opt_1.arr));
                }

/* opt*/
                if (ind_opt_2>=  0) {
                        v_opt_2.arr[v_opt_2.len] = '\0';
                        PutField_CString(myHash,"opt_2",(const char*)v_opt_2.arr);
DEBUGLOG(("GetTxnDetail opt_2 = [%s]\n",v_opt_2.arr));
                }

/* opt*/
                if (ind_opt_3>=  0) {
                        v_opt_3.arr[v_opt_3.len] = '\0';
                        PutField_CString(myHash,"opt_3",(const char*)v_opt_3.arr);
DEBUGLOG(("GetTxnDetail opt_3 = [%s]\n",v_opt_3.arr));
                }




		RecordSet_Add(myRec,myHash);
	}
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_gettxndetail;


DEBUGLOG(("GetTxnDetail Normal Exit\n")); 
        return  PD_OK;

gettxndetail_error:
DEBUGLOG(("gettxndetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_gettxndetail;
        return PD_ERR;
}


int MatchMerchantRef(const char* csMerchantId,
                     const char* csMerchantRef)
{
        EXEC SQL WHENEVER SQLERROR GOTO matchmerchantref_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                
        EXEC SQL BEGIN DECLARE SECTION;
	 	short           hv_return_value;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_merchant_ref[PD_MERCHANT_REF_LEN];

                        
        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("MatchMerchantRef merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
                
        hv_merchant_ref.len = strlen(csMerchantRef);
        memcpy(hv_merchant_ref.arr,csMerchantRef,hv_merchant_ref.len);
DEBUGLOG(("MatchMerchantRef merchant_ref = [%.*s]\n",hv_merchant_ref.len,hv_merchant_ref.arr));

        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_transaction_matchmref(:hv_merchant_id,
                                                		     :hv_merchant_ref);
                END;
        END-EXEC;

        if (hv_return_value > 0)  {

DEBUGLOG(("MatchMerchantref Found\n"));
                return PD_FOUND;
	}
	else {
DEBUGLOG(("MatchMerchantref Not Found\n"));
		return PD_NOT_FOUND;
	}
        

matchmerchantref_error:
DEBUGLOG(("matchmerchantref_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int MatchRespTxn(const char* csTxnSeq,
                     const char cStatus)
{
        EXEC SQL WHENEVER SQLERROR GOTO MatchRespTxn_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                
        EXEC SQL BEGIN DECLARE SECTION;
	 	//short           hv_return_value;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];
		char		hv_status;
		
		varchar         v_merchant_id[PD_MERCHANT_ID_LEN+1];

                short           ind_merchant_id = -1;
                        
        EXEC SQL END DECLARE SECTION;

        hv_txn_id.len = strlen(csTxnSeq);
        memcpy(hv_txn_id.arr,csTxnSeq,hv_txn_id.len);
DEBUGLOG(("MatchRespTxn txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
                
	hv_status = cStatus;
DEBUGLOG(("MatchRespTxn status = [%c]\n",hv_status));

	EXEC SQL SELECT th_merchant_id
                INTO    :v_merchant_id:ind_merchant_id
                FROM    txn_header
                WHERE   th_txn_id = :hv_txn_id
                and     th_status = :hv_status
                for update;


        if(ind_merchant_id>=0){
DEBUGLOG(("MatchRespTxn Found\n"));
                return PD_FOUND;
	}
	else {
DEBUGLOG(("MatchRespTxn Not Found\n"));
		return PD_NOT_FOUND;
	}
        

MatchRespTxn_error:
DEBUGLOG(("MatchRespTxn_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int MatchRespTxnStatus(const char* csTxnSeq,
                     const char cStatus,
			const char cArInd)
{
        EXEC SQL WHENEVER SQLERROR GOTO MatchRespTxnStatus_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_txn_id[PD_TXN_SEQ_LEN];
		char		hv_status;
		char		hv_ar_ind;
		
		varchar         v_merchant_id[PD_MERCHANT_ID_LEN+1];

                short           ind_merchant_id = -1;
                        
        EXEC SQL END DECLARE SECTION;

        hv_txn_id.len = strlen(csTxnSeq);
        memcpy(hv_txn_id.arr,csTxnSeq,hv_txn_id.len);
DEBUGLOG(("MatchRespTxnStatus txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
                
	hv_status = cStatus;
DEBUGLOG(("MatchRespTxnStatus status = [%c]\n",hv_status));

	hv_ar_ind = cArInd;
DEBUGLOG(("MatchRespTxnStatus ar_ind = [%c]\n",hv_ar_ind));

	EXEC SQL SELECT th_merchant_id
                INTO    :v_merchant_id:ind_merchant_id
                FROM    txn_header
                WHERE   th_txn_id = :hv_txn_id
                and     th_status = :hv_status
                and     th_ar_ind = :hv_ar_ind
                for update;


        if(ind_merchant_id>=0){
DEBUGLOG(("MatchRespTxn Found\n"));
                return PD_FOUND;
	}
	else {
DEBUGLOG(("MatchRespTxnStatus Not Found\n"));
		return PD_NOT_FOUND;
	}
        

MatchRespTxnStatus_error:
DEBUGLOG(("MatchRespTxnStatus_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int MatchRespTxnByRemark(const char* csRemark,
                     const char cStatus,
			char*	csOrgTxnId)
{
        EXEC SQL WHENEVER SQLERROR GOTO MatchRespTxnByRemark_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_remark[PD_REMARK_LEN];
                char            hv_status;
                 
                varchar         v_merchant_id[PD_MERCHANT_ID_LEN+1];
                varchar         v_txn_id[PD_TXN_SEQ_LEN + 1];
        
                short           ind_merchant_id = -1;
                short           ind_txn_id = -1;
                        
        EXEC SQL END DECLARE SECTION;
        
        hv_remark.len = strlen(csRemark);
        memcpy(hv_remark.arr,csRemark,hv_remark.len);
DEBUGLOG(("MatchRespTxnByRemark remark = [%.*s]\n",hv_remark.len,hv_remark.arr));
                        
        hv_status = cStatus;
DEBUGLOG(("MatchRespTxnByRemark status = [%c]\n",hv_status));
        
        EXEC SQL SELECT th_merchant_id,
			th_txn_id
                INTO    :v_merchant_id:ind_merchant_id,
			:v_txn_id:ind_txn_id
                  FROM txn_detail,
                       txn_header
                 WHERE td_remark = :hv_remark
                   AND td_txn_id = th_txn_id
                   AND th_status = :hv_status
       		   for update; 
        
        if(ind_merchant_id>=0){
        	if(ind_txn_id>=0){
                        v_txn_id.arr[v_txn_id.len] = '\0';
			strcpy(csOrgTxnId,(char*)v_txn_id.arr);
DEBUGLOG(("MatchRespTxnByRemark org_txn_id = [%s]\n",csOrgTxnId));
		}
DEBUGLOG(("MatchRespTxnByRemark Found\n"));
                return PD_FOUND;
        }
        else {
DEBUGLOG(("MatchRespTxnByRemark Not Found\n"));
                return PD_NOT_FOUND;
        }


MatchRespTxnByRemark_error:
DEBUGLOG(("MatchRespTxnByRemark_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}


int 	ChkTxnCodeExist(const char *csTxnCode)
{
	int 	iRet = PD_NOT_FOUND;

        EXEC SQL WHENEVER SQLERROR GOTO chktxncodeexist_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_txn_code[PD_TXN_CODE_LEN];

		int		v_no_of_record;
		short		ind_no_of_record = -1;
	EXEC SQL END DECLARE SECTION;	

	hv_txn_code.len = strlen(csTxnCode);
	memcpy(hv_txn_code.arr, csTxnCode, hv_txn_code.len);
DEBUGLOG(("ChkTxnCodeExist = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));

	EXEC SQL 
		SELECT count(1)
		   INTO :v_no_of_record:ind_no_of_record
		   FROM txn_header
		  WHERE th_txn_code = :hv_txn_code
		    and rownum = 1;

	if (ind_no_of_record >= 0) {
		if (v_no_of_record > 0) {
DEBUGLOG(("ChkTxnCodeExist FOUND\n"));
			iRet = PD_FOUND;
		}
	}

	if (iRet!= PD_FOUND) {
DEBUGLOG(("ChkTxnCodeExist NOT FOUND\n"));
	}


	return iRet;

chktxncodeexist_error:
DEBUGLOG(("ChkTxnCodeExist_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;

}


int MatchHostRef(const char* csChannelCode,
                 const char* csMmsHostRef)
{
        EXEC SQL WHENEVER SQLERROR GOTO matchhostref_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                
        EXEC SQL BEGIN DECLARE SECTION;
	 	short           hv_return_value;
                varchar         hv_channel_code[PD_CHANNEL_CODE_LEN];
		varchar		hv_host_ref[PD_MERCHANT_REF_LEN];

                        
        EXEC SQL END DECLARE SECTION;

        hv_channel_code.len = strlen(csChannelCode);
        memcpy(hv_channel_code.arr,csChannelCode,hv_channel_code.len);
DEBUGLOG(("MatchHostRef channel_code = [%.*s]\n",hv_channel_code.len,hv_channel_code.arr));
                
        hv_host_ref.len = strlen(csMmsHostRef);
        memcpy(hv_host_ref.arr,csMmsHostRef,hv_host_ref.len);
DEBUGLOG(("MatchHostRef host_ref = [%.*s]\n",hv_host_ref.len,hv_host_ref.arr));

        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_txn_matchhostref(:hv_channel_code,
                                                		:hv_host_ref);
                END;
        END-EXEC;

        if (hv_return_value > 0)  {

DEBUGLOG(("MatchHostRef Found\n"));
                return PD_FOUND;
	}
	else {
DEBUGLOG(("MatchHostRef Not Found\n"));
		return PD_NOT_FOUND;
	}
        

matchhostref_error:
DEBUGLOG(("matchhostref_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}


int GetMmsDetail(const char* csMmsHostRef,
		  recordset_t* myRec)
{

        hash_t *myHash;
	int	iCnt = 0;

        EXEC SQL WHENEVER SQLERROR GOTO getmmsdt_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_host_ref[PD_REMARK_LEN];

		varchar		v_txn_id[PD_TXN_SEQ_LEN + 1];
		varchar		v_txn_code[PD_TXN_CODE_LEN + 1];
		varchar		v_merchant_id[PD_MERCHANT_ID_LEN + 1];
		varchar		v_client_id[PD_CLIENT_ID_LEN + 1];
		varchar		v_service_code[PD_SERVICE_CODE_LEN + 1];
		varchar		v_psp_id[PD_PSP_ID_LEN + 1];
		varchar		v_txn_ccy[PD_CCY_ID_LEN + 1];
		char		v_status;
		char		v_ar_ind;
		double		v_txn_amt;
		

		short		ind_txn_id= -1;
		short		ind_txn_code= -1;
		short		ind_merchant_id= -1;
		short		ind_client_id= -1;
		short		ind_service_code= -1;
		short		ind_psp_id= -1;
		short		ind_txn_ccy= -1;
		short		ind_status= -1;
		short		ind_ar_ind= -1;
		short		ind_txn_amt= -1;


        EXEC SQL END DECLARE SECTION;

	hv_host_ref.len = strlen(csMmsHostRef);
	memcpy(hv_host_ref.arr,csMmsHostRef,hv_host_ref.len);
DEBUGLOG(("GetMmsDetail host_ref = [%.*s]\n",hv_host_ref.len,hv_host_ref.arr));

        EXEC SQL DECLARE c_cursor_getmmsdt CURSOR FOR
		select 
			th_txn_id,
			th_txn_code,
			th_merchant_id,
			th_client_id,
			th_service_code,
			tp_psp_id,
			td_txn_ccy,
			th_status,
			th_ar_ind,
			th_transaction_amount
		from	txn_detail,
			(txn_header
			left join txn_psp_detail
			on th_txn_id = tp_txn_id)
		where	th_txn_id=td_txn_id
		and	td_remark = :hv_host_ref
		and	th_org_txn_id is null
		and	th_status = 'C'
		and 	th_ar_ind = 'A';  
 
        EXEC SQL OPEN c_cursor_getmmsdt;
        do {
                EXEC SQL FETCH c_cursor_getmmsdt
                INTO
			:v_txn_id:ind_txn_id,
			:v_txn_code:ind_txn_code,
			:v_merchant_id:ind_merchant_id,
			:v_client_id:ind_client_id,
			:v_service_code:ind_service_code,
			:v_psp_id:ind_psp_id,
			:v_txn_ccy:ind_txn_ccy,
			:v_status:ind_status,
			:v_ar_ind:ind_ar_ind,
			:v_txn_amt:ind_txn_amt;


                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/* txn id*/
                if (ind_txn_id>=  0) { 
			v_txn_id.arr[v_txn_id.len] = '\0';
                        PutField_CString(myHash,"txn_seq",(const char*)v_txn_id.arr);
DEBUGLOG(("GetMmsDetail txn_id = [%s]\n",v_txn_id.arr));
		}

/* txn code */
                if (ind_txn_code>=  0) { 
			v_txn_code.arr[v_txn_code.len] = '\0';
                        PutField_CString(myHash,"txn_code",(const char*)v_txn_code.arr);
DEBUGLOG(("GetMmsDetail txn_code = [%s]\n",v_txn_code.arr));
		}

/* merchant id*/
                if (ind_merchant_id>=  0) { 
			v_merchant_id.arr[v_merchant_id.len] = '\0';
                        PutField_CString(myHash,"merchant_id",(const char*)v_merchant_id.arr);
DEBUGLOG(("GetMmsDetail merchant_id = [%s]\n",v_merchant_id.arr));
		}

/* client id*/
                if (ind_client_id>=  0) { 
			v_client_id.arr[v_client_id.len] = '\0';
                        PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
DEBUGLOG(("GetMmsDetail client_id = [%s]\n",v_client_id.arr));
		}

/* service_code */
                if (ind_service_code>=  0) { 
			v_service_code.arr[v_service_code.len] = '\0';
                        PutField_CString(myHash,"service_code",(const char*)v_service_code.arr);
DEBUGLOG(("GetMmsDetail service_code = [%s]\n",v_service_code.arr));
		}

/* psp id */
                if (ind_psp_id>=  0) { 
			v_psp_id.arr[v_psp_id.len] = '\0';
                        PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetMmsDetail psp_id = [%s]\n",v_psp_id.arr));
		}

/* txn ccy */
                if (ind_txn_ccy  >=  0) { 
			v_txn_ccy.arr[v_txn_ccy.len] = '\0';
                        PutField_CString(myHash,"txn_ccy",(const char*)v_txn_ccy.arr);
DEBUGLOG(("GetMmsDetail txn_ccy = [%s]\n",v_txn_ccy.arr));
		}

/* txn_amt */
                if (ind_txn_amt <  0)
			v_txn_amt = 0.0;
                        PutField_Double(myHash,"txn_amt",v_txn_amt);
DEBUGLOG(("GetMmsDetail txn_amt = [%lf]\n",v_txn_amt));


/* status */
                if (ind_status>=  0) { 
                        PutField_Char(myHash,"status",v_status);
DEBUGLOG(("GetMmsDetail status = [%c]\n",v_status));
		}

/* ar_ind */
                if (ind_ar_ind>=  0) { 
                        PutField_Char(myHash,"ar_ind",v_ar_ind);
DEBUGLOG(("GetMmsDetail ar_ind = [%c]\n",v_ar_ind));
		}

		iCnt ++;
		RecordSet_Add(myRec,myHash);
	}
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getmmsdt;

	if(iCnt>0){
DEBUGLOG(("GetMmsDetail Normal Exit\n")); 
        	return  PD_FOUND;
	}
	else{
DEBUGLOG(("GetMmsDetail Normal Exit, Not Found\n")); 
        	return  PD_NOT_FOUND;
	}

getmmsdt_error:
DEBUGLOG(("getmmsdt_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getmmsdt;
        return PD_ERR;


	
}

int AddTxnStatusLog(const hash_t *hCon)
{
	char	*csTmp;
	char	cTmp;
	
	EXEC SQL WHENEVER SQLERROR GOTO add_txnstatuslogerror;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_txn_id[PD_TXN_SEQ_LEN];
		char		hv_status;
		char		hv_ar_ind;
		varchar		hv_sub_status[PD_SUB_STATUS_LEN];
		varchar		hv_create_user[PD_USER_LEN];


		short		ind_txn_id = -1;
		short		ind_status = -1;
		short		ind_ar_ind = -1;
		short		ind_sub_status = -1;
		short		ind_create_user = -1;

		short           hv_return_value;
        EXEC SQL END DECLARE SECTION;
DEBUGLOG(("AddTxnStatusLog: Begin\n"));

	if (GetField_CString(hCon,"txn_seq",&csTmp)) {
		hv_txn_id.len = strlen(csTmp);
                strncpy((char*)hv_txn_id.arr, csTmp, hv_txn_id.len);
                ind_txn_id = 0;
	}
DEBUGLOG(("AddTxnStatusLog:txn_id = [%.*s]\n",hv_txn_id.len, hv_txn_id.arr));
	
	if (GetField_Char(hCon,"status",&cTmp)) {
		hv_status = cTmp;
		ind_status = 0;
DEBUGLOG(("AddTxnStatusLog: status = [%c]\n",cTmp));
	}

	if (GetField_Char(hCon,"ar_ind",&cTmp)) {
		hv_ar_ind = cTmp;
		ind_ar_ind = 0;
DEBUGLOG(("AddTxnStatusLog: ar_ind = [%c]\n",cTmp));
	}

        if(GetField_CString(hCon,"sub_status",&csTmp))
        {
                hv_sub_status.len = strlen(csTmp);
                strncpy((char*)hv_sub_status.arr, csTmp, hv_sub_status.len);
                ind_sub_status = 0;
DEBUGLOG(("AddTxnStatusLog:sub_status = [%.*s]\n",hv_sub_status.len,hv_sub_status.arr));
        }

        if(GetField_CString(hCon,"add_user",&csTmp))
        {
                hv_create_user.len = strlen(csTmp);
                strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
        }
        else if(GetField_CString(hCon,"update_user",&csTmp))
        {
                hv_create_user.len = strlen(csTmp);
                strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
        }
	else{
		hv_create_user.len = strlen("SYSTEM");
		strncpy((char*)hv_create_user.arr,"SYSTEM", hv_create_user.len);
		ind_create_user = 0;
	}
DEBUGLOG(("AddTxnStatusLog:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));


	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_txn_status_log_insert(
					:hv_txn_id:ind_txn_id,
					:hv_status:ind_status,
					:hv_ar_ind:ind_ar_ind,
					:hv_sub_status:ind_sub_status,
					:hv_create_user:ind_create_user);

		END;
	END-EXEC;


DEBUGLOG(("AddTxnStatusLog:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("AddTxnStatusLog:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("TxnCode_AddTxnStatusLog: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("TxnCode_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
                return PD_ERR;
        }


add_txnstatuslogerror:
DEBUGLOG(("add_txnstatuslogerror code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("TxnCode_add_txnstatuslogerror: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_INTERNAL_ERR;
}
