/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/07/17              Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "OLStmtConvertScript.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char cDebug;

void OLStmtConvertScript(char cdebug)
{
	cDebug = cdebug;
}

int GetEncoding(const char* csIntBankCode, char* csScriptName, char* csInFileEncoding)
				
{
	int	iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO getscript_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_int_bank_code[PD_BANK_CODE_LEN + 1];
		varchar	v_script_name[PD_SCRIPT_NAME_LEN + 1];
		varchar	v_in_file_encoding[PD_IN_FILE_ENCODING_LEN + 1];

		short	ind_int_bank_code = -1;
		short	ind_script_name= -1;
		short	ind_in_file_encoding = -1;

	EXEC SQL END DECLARE SECTION;

	hv_int_bank_code.len = strlen(csIntBankCode);
	strncpy((char*)hv_int_bank_code.arr,csIntBankCode,hv_int_bank_code.len);
	ind_int_bank_code = 0;
DEBUGLOG(("GetEncoding int_bank_code = [%.*s]\n",hv_int_bank_code.len,hv_int_bank_code.arr));

	EXEC SQL	SELECT	OLCS_SCRIPT_NAME,
				OLCS_IN_FILE_ENCODING
			INTO	:v_script_name:ind_script_name,
				:v_in_file_encoding:ind_in_file_encoding
			FROM	(SELECT	OLCS_SCRIPT_NAME,
					OLCS_IN_FILE_ENCODING,
					OLCS_OUT_FILE_PREFIX,
					OLCS_OUT_FILE_POSTFIX
				FROM	OL_STMT_CONVERT_SCRIPT
				WHERE	OLCS_INT_BANK_CODE = :hv_int_bank_code:ind_int_bank_code
				ORDER BY OLCS_EFFECT_DATETIME DESC)
			WHERE ROWNUM = 1;


/* script_name */	
	if (ind_script_name >= 0) {
		v_script_name.arr[v_script_name.len] = '\0';
		strcpy(csScriptName,(char*)v_script_name.arr);
DEBUGLOG(("GetEncoding script_name = [%s]\n",v_script_name.arr));
	}

/* in_file_encoding */	
	if (ind_in_file_encoding >= 0) {
		v_in_file_encoding.arr[v_in_file_encoding.len] = '\0';
		strcpy(csInFileEncoding,(char*)v_in_file_encoding.arr);
DEBUGLOG(("GetEncoding in_file_encoding = [%s]\n",v_in_file_encoding.arr));
	}

        if (ind_in_file_encoding >= 0 ) {
DEBUGLOG(("GetEncoding FOUND\n"));
                iRet = PD_OK;
        } else {
DEBUGLOG(("GetEncoding NOT FOUND!!!\n"));
ERRLOG("OLStmtConvertScript_GetEncoding NOT FOUND!!!\n");
                iRet = PD_ERR;
        }

DEBUGLOG(("GetEncoding Normal Exit iRet = [%d]\n",iRet));
	return iRet;

getscript_error:
DEBUGLOG(("getscript_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLStmtConvertScript_GetEncoding code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}

