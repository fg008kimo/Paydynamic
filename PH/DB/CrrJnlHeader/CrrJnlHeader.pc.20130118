/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/05/19              Simon Fung
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "CrrJnlHeader.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#include <unistd.h>
#include <ctype.h>
#include <sys/types.h>
#include <time.h>
#include "myhash.h"
#include "numutility.h"
#include "myrecordset.h"
#include "ObjPtr.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

OBJPTR(BO);
OBJPTR(DB);

char    cDebug;
void CrrJnlHeader(char    cdebug)
{
        cDebug = cdebug;
}

int Add(const hash_t *hRls)
{
	char	*csTmp;
	char  cTmp;
	int		iTmp;

  EXEC SQL WHENEVER SQLERROR GOTO add_error;
  EXEC SQL WHENEVER NOTFOUND CONTINUE;

  EXEC SQL BEGIN DECLARE SECTION;

  short 		hv_return_value;
  varchar		hv_jnl_id[PD_JNL_ID_LEN];	
	int		hv_jnl_type_id;	
	varchar		hv_description[PD_DESCRIPTION_LEN];	
	varchar		hv_txn_date[PD_TXN_DATE_LEN];	
	varchar		hv_bank_update_date[PD_BANK_UPDATE_DATE_LEN];	
	varchar		hv_acc_year[PD_ACC_YEAR_LEN];
	varchar		hv_acc_month[PD_ACC_MONTH_LEN];
	varchar		hv_country_code[PD_COUNTRY_CODE_LEN];
	varchar		hv_product_code[PD_PRODUCT_CODE_LEN];
	varchar		hv_ref_no[PD_REF_NO_LEN];	
	varchar		hv_remarks[PD_REMARKS_LEN];	
	char		hv_status;	
	int		hv_disabled;	
	varchar		hv_create_user[PD_CREATE_USER_LEN];	

	short		ind_jnl_id = -1;
	short		ind_jnl_type_id = -1;
	short		ind_description = -1;
	short		ind_txn_date = -1;
	short		ind_bank_update_date = -1;
	short		ind_acc_year = -1;
	short		ind_acc_month = -1;
	short		ind_country_code = -1;
	short		ind_product_code = -1;
	short		ind_ref_no = -1;
	short		ind_remarks = -1;
	short		ind_status = -1;
	short		ind_disabled = -1;
	short		ind_create_user = -1;


  EXEC SQL END DECLARE SECTION;

	DEBUGLOG(("Add: Begin\n"));

	/* jnl_id */
	if (GetField_CString(hRls,"jnl_id",&csTmp)) {
		hv_jnl_id.len = strlen(csTmp);
		memcpy(hv_jnl_id.arr,csTmp,hv_jnl_id.len);
		ind_jnl_id = 0;
		DEBUGLOG(("Add:jnl_id = [%.*s]\n",hv_jnl_id.len,hv_jnl_id.arr));
	} else {
		DEBUGLOG(("Add:jnl_id not found\n"));
		return PD_ERR;
	}

	
	/* jnl_type_id */
	if (GetField_Int(hRls,"jnl_type_id",&iTmp)) {
		hv_jnl_type_id = iTmp;
		ind_jnl_type_id = 0;
		DEBUGLOG(("Add:jnl_type_id = [%d]\n",hv_jnl_type_id));
	} else {
		DEBUGLOG(("Add:jnl_type_id not found\n"));
		return PD_ERR;
	}

	
	/* description */
	if (GetField_CString(hRls,"description",&csTmp)) {
		hv_description.len = strlen(csTmp);
		memcpy(hv_description.arr,csTmp,hv_description.len);
		ind_description = 0;
		DEBUGLOG(("Add:description = [%.*s]\n",hv_description.len,hv_description.arr));
	}

	
	/* txn_date */
	if (GetField_CString(hRls,"txn_date",&csTmp)) {
		hv_txn_date.len = strlen(csTmp);
		memcpy(hv_txn_date.arr,csTmp,hv_txn_date.len);
		ind_txn_date = 0;
		DEBUGLOG(("Add:txn_date = [%.*s]\n",hv_txn_date.len,hv_txn_date.arr));
	} else {
		DEBUGLOG(("Add:txn_date not found\n"));
		return PD_ERR;
	}


	
	/* bank_update_date */
	if (GetField_CString(hRls,"bank_update_date",&csTmp)) {
		hv_bank_update_date.len = strlen(csTmp);
		memcpy(hv_bank_update_date.arr,csTmp,hv_bank_update_date.len);
		ind_bank_update_date = 0;
		DEBUGLOG(("Add:bank_update_date = [%.*s]\n",hv_bank_update_date.len,hv_bank_update_date.arr));
	}

	
	/* acc_year */
	if (GetField_CString(hRls,"acc_year",&csTmp)) {
		hv_acc_year.len = strlen(csTmp);
		memcpy(hv_acc_year.arr,csTmp,hv_acc_year.len);
		ind_acc_year = 0;
		DEBUGLOG(("Add:acc_year = [%.*s]\n",hv_acc_year.len,hv_acc_year.arr));
	} else {
		DEBUGLOG(("Add:acc_year not found\n"));
		return PD_ERR;
	}

	
	/* acc_month */
	if (GetField_CString(hRls,"acc_month",&csTmp)) {
		hv_acc_month.len = strlen(csTmp);
		memcpy(hv_acc_month.arr,csTmp,hv_acc_month.len);
		ind_acc_month = 0;
		DEBUGLOG(("Add:acc_month = [%.*s]\n",hv_acc_month.len,hv_acc_month.arr));
	} else {
		DEBUGLOG(("Add:acc_month not found\n"));
		return PD_ERR;
	}
	
	/* country_code */
	if (GetField_CString(hRls,"country_code",&csTmp)) {
		hv_country_code.len = strlen(csTmp);
		memcpy(hv_country_code.arr,csTmp,hv_country_code.len);
		ind_country_code = 0;
		DEBUGLOG(("Add:country_code = [%.*s]\n",hv_country_code.len,hv_country_code.arr));
	} else {
		DEBUGLOG(("Add:country_code not found\n"));
		return PD_ERR;
	}

	/* product_code */
	if (GetField_CString(hRls,"product_code",&csTmp)) {
		hv_product_code.len = strlen(csTmp);
		memcpy(hv_product_code.arr,csTmp,hv_product_code.len);
		ind_product_code = 0;
		DEBUGLOG(("Add:product_code = [%.*s]\n",hv_product_code.len,hv_product_code.arr));
	} else {
		DEBUGLOG(("Add:product_code not found\n"));
		return PD_ERR;
	}
	
	/* ref_no */
	if (GetField_CString(hRls,"ref_no",&csTmp)) {
		hv_ref_no.len = strlen(csTmp);
		memcpy(hv_ref_no.arr,csTmp,hv_ref_no.len);
		ind_ref_no = 0;
		DEBUGLOG(("Add:ref_no = [%.*s]\n",hv_ref_no.len,hv_ref_no.arr));
	}

	
	/* remarks */
	if (GetField_CString(hRls,"remarks",&csTmp)) {
		hv_remarks.len = strlen(csTmp);
		memcpy(hv_remarks.arr,csTmp,hv_remarks.len);
		ind_remarks = 0;
		DEBUGLOG(("Add:remarks = [%.*s]\n",hv_remarks.len,hv_remarks.arr));
	}

	/* status */ 
	if (GetField_Char(hRls,"status",&cTmp)) {
		hv_status = cTmp;
		ind_status = 0;
		DEBUGLOG(("Add:status = [%c]\n",hv_status));
	} else {
		DEBUGLOG(("Add:status not found\n"));
		return PD_ERR;
	}

	
	/* disabled */
	if (GetField_Int(hRls,"disabled",&iTmp)) {
		hv_disabled = iTmp;
		ind_disabled = 0;
		DEBUGLOG(("Add:disabled = [%d]\n",hv_disabled));
	} else {
		hv_disabled = 0;
		ind_disabled = 0;
		DEBUGLOG(("Add:disabled (default) = [%d]\n",hv_disabled));
	}
	
	/* create_user */
	if (GetField_CString(hRls,"create_user",&csTmp)) {
		hv_create_user.len = strlen(csTmp);
		memcpy(hv_create_user.arr,csTmp,hv_create_user.len);
		ind_create_user = 0;
		DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));
	} else {
		DEBUGLOG(("Add:create_user not found\n"));
		return PD_ERR;
	}
		
	EXEC SQL EXECUTE BEGIN
			:hv_return_value := sp_crr_jnl_header_insert(
			:hv_jnl_id:ind_jnl_id,
			:hv_jnl_type_id:ind_jnl_type_id,
			:hv_description:ind_description,
			:hv_txn_date:ind_txn_date,
			:hv_bank_update_date:ind_bank_update_date,
			:hv_acc_year:ind_acc_year,
			:hv_acc_month:ind_acc_month,
			:hv_country_code:ind_country_code,
			:hv_product_code:ind_product_code,			
			:hv_ref_no:ind_ref_no,
			:hv_remarks:ind_remarks,
			:hv_status:ind_status,
			:hv_disabled:ind_disabled,
			:hv_create_user:ind_create_user
					);
	        END;
        END-EXEC;

	DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
    
  if (hv_return_value == SP_OK) {
		DEBUGLOG(("Add:Normal Exit\n"));
    return PD_OK;
  }

  if (hv_return_value == SP_OTHER_ERR)  {
		ERRLOG("CrrJnlHeader_Add: SP_OTHER_ERR TxnAbort\n");
		DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
    return PD_OTHER_ERR;
  }

  if (hv_return_value == SP_ERR)  {
		ERRLOG("CrrJnlHeader_Add: SP_ERR TxnAbort\n");
		DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
    return PD_ERR;
  }

add_error:
	DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	ERRLOG("CrrJnlHeader_Add: SP_INTERNAL_ERR TxnAbort\n");
	DEBUGLOG(("Add: SP_INTERNAL_ERR TxnAbort\n"));

  return PD_INTERNAL_ERR;
}

int Update(const hash_t *hRls)
{

	char*	csTmp;
	char	cTmp;
	int	iTmp;
	char*	csBuf;
	char*	csJnlId;
  EXEC SQL WHENEVER SQLERROR GOTO update_error;
  EXEC SQL WHENEVER NOTFOUND CONTINUE;

  EXEC SQL BEGIN DECLARE SECTION;

	varchar 	hv_dynstmt[1024];

  EXEC SQL END DECLARE SECTION;

	DEBUGLOG(("Update: Begin\n"));
	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr,"update crr_jnl_header set update_timestamp  = sysdate");

  if (GetField_CString(hRls,"jnl_id",&csJnlId)) {
		DEBUGLOG(("Update:jnl_id = [%s]\n",csJnlId));
	} else {
		DEBUGLOG(("Update:jnl_id not found\n"));
		return PD_ERR;
	}
				
	/* jnl_type_id  */
	if (GetField_Int(hRls,"jnl_type_id",&iTmp)) {
		DEBUGLOG(("Update:jnl_type_id = [%d]\n",iTmp));
		sprintf(csBuf,"%d",iTmp);
		strcat((char*)hv_dynstmt.arr, ",jnl_type_id = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		//strcat((char*)hv_dynstmt.arr, "'");
		//hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	
	/* description */
	if (GetField_CString(hRls,"description",&csTmp)) {
		DEBUGLOG(("Update:description = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",description = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		//hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	
	/* txn_date */
	if (GetField_CString(hRls,"txn_date",&csTmp)) {
		DEBUGLOG(("Update:txn_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",txn_date = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	
	/* bank_update_date */
	if (GetField_CString(hRls,"bank_update_date",&csTmp)) {
		DEBUGLOG(("Update:bank_update_date = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",bank_update_date = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		//hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	
	/* acc_year  */
	if (GetField_CString(hRls,"acc_year",&csTmp)) {
		DEBUGLOG(("Update:acc_year = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",acc_year = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		//hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	
	/* acc_month  */
	if (GetField_CString(hRls,"acc_month",&csTmp)) {
		DEBUGLOG(("Update:acc_month = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",acc_month = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		//hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	/* country_code  */
	if (GetField_CString(hRls,"country_code",&csTmp)) {
		DEBUGLOG(("Update:country_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",country_code = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		//hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	/* product_code  */
	if (GetField_CString(hRls,"product_code",&csTmp)) {
		DEBUGLOG(("Update:product_code = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",product_code = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}	
	
	/* ref_no */
	if (GetField_CString(hRls,"ref_no",&csTmp)) {
		DEBUGLOG(("Update:ref_no = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",ref_no = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		//hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	
	/* remarks */
	if (GetField_CString(hRls,"remarks",&csTmp)) {
		DEBUGLOG(("Update:remarks = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",remarks = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		//hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	
	/* status */ 
	if (GetField_Char(hRls,"status",&cTmp)) {
		DEBUGLOG(("Update:status = [%c]\n",cTmp));
		sprintf(csBuf,"%c",cTmp);
		strcat((char*)hv_dynstmt.arr, ",status = '");
		strcat((char*)hv_dynstmt.arr, csBuf);
		strcat((char*)hv_dynstmt.arr, "'");
		//hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	
	/* disabled  */
	if (GetField_Int(hRls,"disabled",&iTmp)) {
		DEBUGLOG(("Update:disabled = [%d]\n",iTmp));
		sprintf(csBuf,"%d",iTmp);
		strcat((char*)hv_dynstmt.arr, ",disabled = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		//strcat((char*)hv_dynstmt.arr, "'");
		//hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}
	
	/* update_user */
	if (GetField_CString(hRls,"update_user",&csTmp)) {
		DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",update_user = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		//hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}
	
	// Reset the approval/booked whenever updated
	strcat((char*)hv_dynstmt.arr, ",approve_user = NULL");
	strcat((char*)hv_dynstmt.arr, ",approve_timestamp = NULL");
	strcat((char*)hv_dynstmt.arr, ",book_user = NULL");
	strcat((char*)hv_dynstmt.arr, ",book_timestamp = NULL");
		
	strcat((char *)hv_dynstmt.arr, " WHERE jnl_id = '");
  strcat((char *)hv_dynstmt.arr, csJnlId);
  strcat((char *)hv_dynstmt.arr, "'");
 	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	
	DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);
	
	DEBUGLOG(("Update Normal Exit\n"));
	return PD_OK;

update_error:
	DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	ERRLOG("CrrJnlHeader_Update: SP_INTERNAL_ERR TxnAbort\n");
	DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
	return PD_INTERNAL_ERR;
}

int Delete(const hash_t *hRls)
{

	char*	csTmp;
	char*	csBuf;
	char*	csJnlId;
  EXEC SQL WHENEVER SQLERROR GOTO disable_error;
  EXEC SQL WHENEVER NOTFOUND CONTINUE;

  EXEC SQL BEGIN DECLARE SECTION;

	varchar 	hv_dynstmt[1024];

  EXEC SQL END DECLARE SECTION;

	DEBUGLOG(("Delete: Begin\n"));
	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr,"update crr_jnl_header set update_timestamp  = sysdate, disabled = 1 ");

  if (GetField_CString(hRls,"jnl_id",&csJnlId)) {
		DEBUGLOG(("Delete:jnl_id = [%s]\n",csJnlId));
	} else {
		DEBUGLOG(("Delete:jnl_id not found\n"));
		return PD_ERR;
	}
			
	/* update_user */
	if (GetField_CString(hRls,"update_user",&csTmp)) {
		DEBUGLOG(("Delete:update_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",update_user = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
	} else {
		DEBUGLOG(("Delete:update_user not found\n"));
		return PD_ERR;
	}
	
	strcat((char *)hv_dynstmt.arr, " WHERE jnl_id = '");
  strcat((char *)hv_dynstmt.arr, csJnlId);
  strcat((char *)hv_dynstmt.arr, "'");
 	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	
	DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);

	DEBUGLOG(("Delete Normal Exit\n"));
	return PD_OK;

disable_error:
	DEBUGLOG(("delete_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	ERRLOG("CrrJnlHeader_Delete: SP_INTERNAL_ERR TxnAbort\n");
	DEBUGLOG(("Delete: SP_INTERNAL_ERR TxnAbort\n"));
	return PD_INTERNAL_ERR;
}

int Approve(const hash_t *hRls)
{

	char*	csTmp;
	char*	csBuf;
	char*	csJnlId;
  EXEC SQL WHENEVER SQLERROR GOTO approve_error;
  EXEC SQL WHENEVER NOTFOUND CONTINUE;

  EXEC SQL BEGIN DECLARE SECTION;

	varchar 	hv_dynstmt[1024];

  EXEC SQL END DECLARE SECTION;

	DEBUGLOG(("Approve: Begin\n"));
	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr,"update crr_jnl_header set approve_timestamp  = sysdate");

  if (GetField_CString(hRls,"jnl_id",&csJnlId)) {
		DEBUGLOG(("Approve:jnl_id = [%s]\n",csJnlId));
	} else {
		DEBUGLOG(("Approve:jnl_id not found\n"));
		return PD_ERR;
	}
			
	/* status to A */ 
	DEBUGLOG(("Approve:status = [%c]\n",PD_JNL_APPROVED));
	sprintf(csBuf,"%c",PD_JNL_APPROVED);
	strcat((char*)hv_dynstmt.arr, ",status = '");
	strcat((char*)hv_dynstmt.arr, csBuf);
	strcat((char*)hv_dynstmt.arr, "'");

	/* approve_user */
	if (GetField_CString(hRls,"approve_user",&csTmp)) {
		DEBUGLOG(("Approve:approve_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",approve_user = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");	
	} else {
		DEBUGLOG(("Approve:approve_user not found\n"));
		return PD_ERR;
	}
	
	strcat((char *)hv_dynstmt.arr, " WHERE jnl_id = '");
	strcat((char *)hv_dynstmt.arr, csJnlId);
	strcat((char *)hv_dynstmt.arr, "'");
	// Approve only pending journal
	/*
	sprintf(csBuf,"%c",PD_JNL_PENDING);
	strcat((char*)hv_dynstmt.arr, " AND STATUS = '");
	strcat((char*)hv_dynstmt.arr, csBuf);
	strcat((char*)hv_dynstmt.arr, "'");	
	*/

	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	
	DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);

	DEBUGLOG(("Approve Normal Exit\n"));
	return PD_OK;

approve_error:
	DEBUGLOG(("approve_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	ERRLOG("CrrJnlHeader_Approve: SP_INTERNAL_ERR TxnAbort\n");
	DEBUGLOG(("Approve: SP_INTERNAL_ERR TxnAbort\n"));
	return PD_INTERNAL_ERR;
}

int Release(const hash_t *hRls)
{

	char*	csTmp;
	char*	csBuf;
	char*	csJnlId;
  EXEC SQL WHENEVER SQLERROR GOTO release_error;
  EXEC SQL WHENEVER NOTFOUND CONTINUE;

  EXEC SQL BEGIN DECLARE SECTION;

	varchar 	hv_dynstmt[1024];

  EXEC SQL END DECLARE SECTION;

	DEBUGLOG(("Release: Begin\n"));
	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr,"update crr_jnl_header set update_timestamp  = sysdate");

   if (GetField_CString(hRls,"jnl_id",&csJnlId)) {
		DEBUGLOG(("Release:jnl_id = [%s]\n",csJnlId));
	} else {
		DEBUGLOG(("Release:jnl_id not found\n"));
		return PD_ERR;
	}
			
	/* status to P */ 
	DEBUGLOG(("Release:status = [%c]\n",PD_JNL_PENDING));
	sprintf(csBuf,"%c",PD_JNL_PENDING);
	strcat((char*)hv_dynstmt.arr, ",status = '");
	strcat((char*)hv_dynstmt.arr, csBuf);
	strcat((char*)hv_dynstmt.arr, "'");

	/* update_user */
	if (GetField_CString(hRls,"update_user",&csTmp)) {
		DEBUGLOG(("Release:update_user = [%s]\n",csTmp));
		strcat((char*)hv_dynstmt.arr, ",update_user = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");	
	} else {
		DEBUGLOG(("Release:update_user not found\n"));
		return PD_ERR;
	}

	// Reset the approval/booked when release
	strcat((char*)hv_dynstmt.arr, ",approve_user = NULL");
	strcat((char*)hv_dynstmt.arr, ",approve_timestamp = NULL");
	strcat((char*)hv_dynstmt.arr, ",book_user = NULL");
	strcat((char*)hv_dynstmt.arr, ",book_timestamp = NULL");
	
	strcat((char *)hv_dynstmt.arr, " WHERE jnl_id = '");
  strcat((char *)hv_dynstmt.arr, csJnlId);
  strcat((char *)hv_dynstmt.arr, "'");
 	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	
	DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);

	DEBUGLOG(("Release Normal Exit\n"));
	return PD_OK;

release_error:
	DEBUGLOG(("release_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	ERRLOG("CrrJnlHeader_Release: SP_INTERNAL_ERR TxnAbort\n");
	DEBUGLOG(("Approve: SP_INTERNAL_ERR TxnAbort\n"));
	return PD_INTERNAL_ERR;
}

int MonthEndBook(const char* csTbYear, const char* csTbMonth, const char* csBookUser)
{
	char*	csBuf;

	EXEC SQL WHENEVER SQLERROR GOTO monthendbook_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

	varchar 	hv_dynstmt[1024];

	EXEC SQL END DECLARE SECTION;

	DEBUGLOG(("MonthEndBook: Begin\n"));
	csBuf = (char*) malloc (128);
	
	strcpy((char*)hv_dynstmt.arr,"update crr_jnl_header set book_timestamp  = sysdate");
	//hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	DEBUGLOG(("MonthEndBook:csTbYear = [%s]\n",csTbYear));
	DEBUGLOG(("MonthEndBook:csTbMonth = [%s]\n",csTbMonth));
	DEBUGLOG(("MonthEndBook:csBookUser = [%s]\n",csBookUser));	
			
	/* status to PD_JNL_POSTED (B) */
	DEBUGLOG(("MonthEndBook:status = [%c]\n",PD_JNL_POSTED));
	sprintf(csBuf,"%c",PD_JNL_POSTED);
	strcat((char*)hv_dynstmt.arr, ",status = '");
	strcat((char*)hv_dynstmt.arr, csBuf);
	strcat((char*)hv_dynstmt.arr, "'");
	//hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	/* book_user */
	DEBUGLOG(("MonthEndBook:book_user = [%s]\n",csBookUser));
	strcat((char*)hv_dynstmt.arr, ",book_user = '");
	strcat((char*)hv_dynstmt.arr, csBookUser);
	strcat((char*)hv_dynstmt.arr, "'");
	//hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	strcat((char *)hv_dynstmt.arr, " WHERE acc_year = '");
	strcat((char *)hv_dynstmt.arr, csTbYear);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " AND acc_month = '");
	strcat((char *)hv_dynstmt.arr, csTbMonth);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " AND status = '");
	sprintf(csBuf,"%c",PD_JNL_APPROVED);
	strcat((char *)hv_dynstmt.arr, csBuf);
	strcat((char *)hv_dynstmt.arr, "'");  
	strcat((char *)hv_dynstmt.arr, " AND disabled = 0");

 	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	
	DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	DEBUGLOG(("MonthEndBook: Start to add change log\n"));
	strcpy((char *)hv_dynstmt.arr,"insert into crr_jnl_change_log");
	strcat((char *)hv_dynstmt.arr, " select (select max(jnl_change_log_id)  from crr_jnl_change_log)+rownum jnl_change_log_id,");
	strcat((char *)hv_dynstmt.arr, " jnl_id, null,null, 'Post', status, book_user, sysdate, book_user ");
	strcat((char *)hv_dynstmt.arr, " from crr_jnl_header ");
	strcat((char *)hv_dynstmt.arr, " WHERE acc_year = '");
	strcat((char *)hv_dynstmt.arr, csTbYear);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " AND acc_month = '");
	strcat((char *)hv_dynstmt.arr, csTbMonth);
	strcat((char *)hv_dynstmt.arr, "'");
	strcat((char *)hv_dynstmt.arr, " AND status = '");
	sprintf(csBuf,"%c",PD_JNL_POSTED);
	strcat((char *)hv_dynstmt.arr, csBuf);
	strcat((char *)hv_dynstmt.arr, "'");  
	strcat((char *)hv_dynstmt.arr, " AND disabled = 0");
	
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	
	DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;
	
	FREE_ME(csBuf);
	
	DEBUGLOG(("MonthEndBook Normal Exit\n"));
	return PD_OK;

monthendbook_error:
	DEBUGLOG(("MonthEndBook_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	ERRLOG("CrrJnlHeader_MonthEndBook: SP_INTERNAL_ERR TxnAbort\n");
	DEBUGLOG(("MonthEndBook: SP_INTERNAL_ERR TxnAbort\n"));
	return PD_INTERNAL_ERR;
}

int GetJnlStatus(const char* csJnlId, char* cJnlStatus)
{
	EXEC SQL WHENEVER SQLERROR GOTO GetJnlStatus_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

	varchar		hv_jnl_id[PD_JNL_ID_LEN];	
	char		hv_status;	
	short		ind_status = -1;

	EXEC SQL END DECLARE SECTION;

	DEBUGLOG(("GetJnlStatus: Begin\n"));
		
	/* jnl_id */
	hv_jnl_id.len = strlen(csJnlId);
	memcpy(hv_jnl_id.arr,csJnlId,hv_jnl_id.len);
	DEBUGLOG(("GetJnlStatus:jnl_id = [%.*s]\n",hv_jnl_id.len,hv_jnl_id.arr));

	EXEC SQL EXECUTE
		BEGIN
		SELECT STATUS INTO :hv_status:ind_status
			FROM CRR_JNL_HEADER 
			WHERE JNL_ID = :hv_jnl_id;
    END;
	END-EXEC;
        	
	if (ind_status == -1) {
		hv_status = ' ';
	}
	
	*cJnlStatus = (char) hv_status;

	DEBUGLOG(("GetJnlStatus:status = [%c]\n",hv_status));
	
	return PD_OK;

GetJnlStatus_error:
	DEBUGLOG(("GetJnlStatus_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	ERRLOG("CrrJnlHeader_GetJnlStatus: SP_INTERNAL_ERR TxnAbort\n");
	DEBUGLOG(("Add: SP_INTERNAL_ERR TxnAbort\n"));
	return PD_INTERNAL_ERR;
}

int GetJnlAccYearMonth(const char* csJnlId, char* csAccYear, char* csAccMonth)
{
	EXEC SQL WHENEVER SQLERROR GOTO GetJnlAccYearMonth_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_jnl_id[PD_JNL_ID_LEN];
		short		ind_jnl_id = -1;
		
		varchar		v_acc_year[PD_ACC_YEAR_LEN+1];
		short		ind_acc_year = -1;	
		
		varchar		v_acc_month[PD_ACC_MONTH_LEN+1];	
		short		ind_acc_month = -1;	

	EXEC SQL END DECLARE SECTION;

	DEBUGLOG(("GetJnlAccYearMonth: Begin\n"));
		
	hv_jnl_id.len = strlen(csJnlId);
	memcpy(hv_jnl_id.arr,csJnlId,hv_jnl_id.len);
	DEBUGLOG(("GetJnlAccYearMonth:jnl_id = [%.*s]\n",hv_jnl_id.len,hv_jnl_id.arr));
	ind_jnl_id = 0;

	EXEC SQL DECLARE c_cursor_get CURSOR FOR
		SELECT	
			ACC_YEAR,
			ACC_MONTH
		FROM	
			CRR_JNL_HEADER
		WHERE	
			JNL_ID = :hv_jnl_id:ind_jnl_id;

	EXEC SQL OPEN c_cursor_get;
	
	do {
		EXEC SQL FETCH c_cursor_get
			INTO
		:v_acc_year:ind_acc_year,
		:v_acc_month:ind_acc_month;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		if(ind_acc_year>=0) {
			v_acc_year.arr[v_acc_year.len] = '\0';
			strcpy(csAccYear,(const char *)v_acc_year.arr);
			DEBUGLOG(("GetJnlAccYearMonth:csAccYear = [%s]\n",csAccYear));
		} else {
			DEBUGLOG(("GetJnlAccYearMonth:v_acc_year not found\n"));			
		}

		if(ind_acc_month>=0) {
			v_acc_month.arr[v_acc_month.len] = '\0';
			strcpy(csAccMonth,(const char *)v_acc_month.arr);
			DEBUGLOG(("GetJnlAccYearMonth:csAccMonth = [%s]\n",csAccMonth));			
			
		} else {
			DEBUGLOG(("GetJnlAccYearMonth:v_acc_month not found\n"));			
		}
		

	} while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_get;
	DEBUGLOG(("GetJnlAccYearMonth Normal Exit\n")); 
	return PD_OK;

GetJnlAccYearMonth_error:
	DEBUGLOG(("GetJnlAccYearMonth_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	//ERRLOG("CrrJnlHeader_GetJnlAccYearMonth: SP_INTERNAL_ERR TxnAbort\n");
	DEBUGLOG(("GetJnlAccYearMonth: SP_INTERNAL_ERR TxnAbort\n"));
	return PD_INTERNAL_ERR;
}

int Build(const char* csTxnDate, const char* csCountry, const char* csProduct, const char* csJnlType, const char* csPostUser)
{
	int	iRet = PD_OK;
	recordset_t  *rRec;
	rRec = (recordset_t*) malloc (sizeof(recordset_t));
	
	/* Get Clear Journals */
	DEBUGLOG(("Cleanup Journal Begin \n"));
	recordset_init(rRec,0);
	if (!strcmp(csJnlType,PD_JLT_PX_ALL)) {
		iRet = GetAllPostJnl(rRec, csTxnDate, csCountry, csProduct, PD_JLT_POST_ONLINE);
	} else {
		iRet = GetPostJnl(rRec, csTxnDate, csCountry, csProduct, csJnlType, PD_JLT_POST_ONLINE);
	}
	if (iRet == PD_OK) {
		iRet = clearJournal("Cleanup Journal", rRec, csPostUser); 
	} else {
		iRet = FAILURE;
	}
DEBUGLOG(("Cleanup Journal End. Return:[%d]\n",iRet));	
	
	if ((!strcmp(csJnlType,PD_JLT_PX_ALL)) || (!strcmp(csJnlType,PD_JLT_PX_ONDF))) {
		// GetApprovedDeposit
		DEBUGLOG(("GetApprovedDeposit Begin\n"));
		recordset_init(rRec,0);
		if (GetApprovedDeposit(rRec, csTxnDate, csCountry, csProduct) == PD_OK) {
			iRet = postSingleJournal("Approved Deposit", rRec, csPostUser); 
		} else {
			iRet = FAILURE;
		}
		DEBUGLOG(("GetApprovedDeposit End. Return:[%d]\n",iRet));
	}
	
	if ((!strcmp(csJnlType,PD_JLT_PX_ALL)) || (!strcmp(csJnlType,PD_JLT_PX_ONDV))) {
		// GetVoidDeposit
		DEBUGLOG(("GetVoidDeposit Begin\n"));
		recordset_init(rRec,0);
		if (GetVoidDeposit(rRec, csTxnDate, csCountry, csProduct) == PD_OK) {
			iRet = postSingleJournal("Void Deposit", rRec, csPostUser); 
		} else {
			iRet = FAILURE;
		}
		DEBUGLOG(("GetVoidDeposit End. Return:[%d]\n",iRet));
	}
	
	if ((!strcmp(csJnlType,PD_JLT_PX_ALL)) || (!strcmp(csJnlType,PD_JLT_PX_ONDA))) {
		// GetReconDeposit
		DEBUGLOG(("GetReconDeposit Begin\n"));
		recordset_init(rRec,0);
		if (GetReconDeposit(rRec, csTxnDate, csCountry, csProduct) == PD_OK) {
			iRet = postSingleJournal("Reconciled Deposit", rRec, csPostUser); 
		} else {
			iRet = FAILURE;
		}
		DEBUGLOG(("GetReconDeposit End. Return:[%d]\n",iRet));
	}
	
	if ((!strcmp(csJnlType,PD_JLT_PX_ALL)) || (!strcmp(csJnlType,PD_JLT_PX_ONP))) {
		// GetApprovedPayout
		DEBUGLOG(("GetApprovedPayout Begin\n"));
		recordset_init(rRec,0);
		if (GetApprovedPayout(rRec, csTxnDate, csCountry, csProduct) == PD_OK) {
			iRet = postSingleJournal("Approved Payout", rRec, csPostUser); 
		} else {
			iRet = FAILURE;
		}
		DEBUGLOG(("GetApprovedPayout End. Return:[%d]\n",iRet));
	}
	
	if ((!strcmp(csJnlType,PD_JLT_PX_ALL)) || (!strcmp(csJnlType,PD_JLT_PX_ONPA))) {
		// GetGeneratedPayout
		DEBUGLOG(("GetGeneratedPayout Begin\n"));
		recordset_init(rRec,0);
		if (GetGeneratedPayout(rRec, csTxnDate, csCountry, csProduct) == PD_OK) {
			iRet = postSingleJournal("Generated Payout", rRec, csPostUser); 
		} else {
			iRet = FAILURE;
		}
		DEBUGLOG(("GetGeneratedPayout End. Return:[%d]\n",iRet));
	}
	
	if ((!strcmp(csJnlType,PD_JLT_PX_ALL)) || (!strcmp(csJnlType,PD_JLT_PX_ONPV))) {
		// GetVoidApprovedPayout
		DEBUGLOG(("GetVoidApprovedPayout Begin\n"));
		recordset_init(rRec,0);
		if (GetVoidApprovedPayout(rRec, csTxnDate, csCountry, csProduct) == PD_OK) {
			iRet = postSingleJournal("Void Approved Payout", rRec, csPostUser); 
		} else {
			iRet = FAILURE;
		}
		DEBUGLOG(("GetVoidApprovedPayout End. Return:[%d]\n",iRet));
	}
	
	if ((!strcmp(csJnlType,PD_JLT_PX_ALL)) || (!strcmp(csJnlType,PD_JLT_PX_ONPAV))) {
		// GetVoidGenPayout
		DEBUGLOG(("GetVoidGenPayout Begin\n"));
		recordset_init(rRec,0);
		if (GetVoidGenPayout(rRec, csTxnDate, csCountry, csProduct) == PD_OK) {
			iRet = postSingleJournal("Void Generated Payout", rRec, csPostUser); 
		} else {
			iRet = FAILURE;
		}
		DEBUGLOG(("GetVoidGenPayout End. Return:[%d]\n",iRet));
	}
	
	if ((!strcmp(csJnlType,PD_JLT_PX_ALL)) || (!strcmp(csJnlType,PD_JLT_PX_ONMS))) {
		// GetDeliveredMst
		DEBUGLOG(("GetDeliveredMst Begin\n"));
		recordset_init(rRec,0);
		if (GetDeliveredMst(rRec, csTxnDate, csCountry, csProduct) == PD_OK) {
			iRet = postMultipleJournal("Delivered Merchant Settlement", rRec, csPostUser); 
		} else {
			iRet = FAILURE;
		}	
		DEBUGLOG(("GetDeliveredMst End. Return:[%d]\n",iRet));
	}
	
	if ((!strcmp(csJnlType,PD_JLT_PX_ALL)) || (!strcmp(csJnlType,PD_JLT_PX_ONMSV))) {
		// GetVoidMst
		DEBUGLOG(("GetVoidMst Begin\n"));
		recordset_init(rRec,0);
		if (GetVoidMst(rRec, csTxnDate, csCountry, csProduct) == PD_OK) {
			iRet = postMultipleJournal("Void Merchant Settlement", rRec, csPostUser); 
		} else {
			iRet = FAILURE;
		}	
		DEBUGLOG(("GetVoidMst End. Return:[%d]\n",iRet));
	}
	
	if ((!strcmp(csJnlType,PD_JLT_PX_ALL)) || (!strcmp(csJnlType,PD_JLT_PX_ONMTF))) {
		// GetApprovedMbt
		DEBUGLOG(("GetApprovedMbt Begin\n"));
		recordset_init(rRec,0);
		if (GetApprovedMbt(rRec, csTxnDate, csCountry, csProduct) == PD_OK) {
			iRet = postMultipleJournal("Approved Merchant Balance Transfer", rRec, csPostUser); 
		} else {
			iRet = FAILURE;
		}	
		DEBUGLOG(("GetApprovedMbt End. Return:[%d]\n",iRet));
	}
	
	RecordSet_Destroy(rRec);
	
	DEBUGLOG(("End getPostTxn and return:[%d]\n",iRet));
	return iRet;
}

int clearJournal(char* csType, recordset_t* rsJnl, const char* csPostUser) 
{
	int		iRet = PD_OK;
	hash_t	*hJnl;
	char*	csTmp = NULL;
	
	hash_t  *hJnlHdr;
	
	hJnlHdr = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hJnlHdr,0);

	hJnl = RecordSet_GetFirst(rsJnl);
	while (hJnl) {

		// jnl_id //
		if (GetField_CString(hJnl,"v_jnl_id",&csTmp)) {
			DEBUGLOG(("clearJournal: v_jnl_id = [%s]\n",csTmp));
			PutField_CString(hJnlHdr,"jnl_id",csTmp);
		}
		
		// update_user //
		DEBUGLOG(("clearJournal: update_user = [%s]\n",csPostUser));
		PutField_CString(hJnlHdr,"update_user",csPostUser);

		// Delete Journal
		BOObjPtr = CreateObj(BOPtr,"BOCrrJnl","Delete");
		iRet = (unsigned long) ((*BOObjPtr)(hJnlHdr));				
		
		if(iRet==PD_OK) {
			DEBUGLOG(("clearJournal::CrrJnlHeader->Delete Success\n"));

		} else {
			DEBUGLOG(("clearJournal::CrrJnlHeader->Delete Failed\n"));	
		}

		hJnl = RecordSet_GetNext(rsJnl);
	}
		
	DEBUGLOG(("End clearJournal and return:[%d]\n",iRet));
	return iRet;
}

int GetFXConvertAmt(char *csTxnDate, char *csFromCcy, char *csToCcy, double dReqAmt, double* dConvertAmt)
{
	char csFxDate[PD_DATE_LEN] = "";
	char csReqCcy[PD_CCY_ID_LEN];
	double dFxRate = 0.0;
	int	iRet = PD_OK;
	
	*dConvertAmt = 0.0;
	strcpy(csFxDate, csTxnDate);
	
	// Skip conversion when same currency
	if (!strcmp(csFromCcy,csToCcy)) {		
		*dConvertAmt = dReqAmt;
		return iRet;
	}

	/* ccy, convert RMB to CNY if needed */
	if (!strcmp(csFromCcy,PD_CCY_ISO_RMB)) {
		strcpy(csReqCcy, PD_CCY_ISO_CNY);
	} else {
		strcpy(csReqCcy, csFromCcy);
	}
	
	// Convert to HKD and Get FX rate to HKD
	BOObjPtr = CreateObj(DBPtr,"BOExchange","GetExternalExchangeRateByDate");

	if ((*BOObjPtr)(csFxDate,csReqCcy,csToCcy,dReqAmt,&dFxRate,dConvertAmt) == PD_OK) {
		//DEBUGLOG(("Converted request amount: ex rate = [%lf], ori amt = [%lf], ex amt = [%lf]\n",dFxRate,dReqAmt, *dConvertAmt));
		
	} else {
		DEBUGLOG(("Fail to get FX rate at converted request amount\n"));
		DEBUGLOG(("csFxDate [%s]\n",csFxDate));
		DEBUGLOG(("csReqCcy [%s]\n",csReqCcy));
		DEBUGLOG(("dReqAmt [%lf]\n",dReqAmt));
		DEBUGLOG(("dFxRate [%lf]\n",dFxRate));
		DEBUGLOG(("dConvertAmt [%lf]\n",dConvertAmt));
		DEBUGLOG(("csToCcy [%s]\n",csToCcy));
		
		return FAILURE;
	}
	
	return iRet;
}

int postSingleJournal(char* csType, recordset_t* rsJnl, const char* csPostUser) 
{
	int		iRet = PD_OK;
	//char	*csPtr;
	hash_t	*hJnl;
	int 	i = 1;
	int 	iFound = 0;
	char*	csTmp = NULL;
	char* 	csTxnID = NULL;
	char* 	csTxnDate = NULL;
	char* 	csProduct = NULL;
	char* 	csTxnCcy = NULL;
	char*	csCrInd = NULL;
	int		iTmp;
	char	csFXGL_GL[PD_GL_CODE_LEN] = "";
	char	csFXGL_SL[PD_SL_CODE_LEN] = "";
	char	cTmp;	
	double	dTmpAmt;
	int		iJnlTypeID;
	double	dConvertAmt = 0.0;
	double	dFxGainLoss = 0.0;
	char csFxGainLossCcy[PD_CCY_ID_LEN] = "";
	
	strcpy(csFxGainLossCcy, PD_CCY_ISO_HKD);
	
	hash_t  *hJnlHdr;
	hash_t	*hJnlDtl;

	hJnlHdr = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hJnlHdr,0);

	// RS for holding jnl details
	recordset_t *rsJnlDtl;
	rsJnlDtl = (recordset_t*) malloc (sizeof(recordset_t));	
	recordset_init(rsJnlDtl,0);

	hJnl = RecordSet_GetFirst(rsJnl);
	while (hJnl) {
		if (i == 1) {
			// Journal Header
			iFound = 1;

			// Generate jnl_id
			DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextMgtTxnSeq");
			csTmp  = strdup((*DBObjPtr)());
			DEBUGLOG(("postSingleJournal: jnl_id = [%s]\n",csTmp));
			PutField_CString(hJnlHdr,"jnl_id",csTmp);				

			// ref_no //
			if (GetField_CString(hJnl,"v_th_txn_id",&csTxnID)) {
				DEBUGLOG(("postSingleJournal: ref_no = [%s]\n",csTxnID));
				PutField_CString(hJnlHdr,"ref_no",csTxnID);
				
			}

			// jnl_type_id //
			if (GetField_Int(hJnl,"v_jnl_type_id",&iJnlTypeID)) {
				DEBUGLOG(("postSingleJournal: jnl_type_id = [%d]\n",iJnlTypeID));
				PutField_Int(hJnlHdr,"jnl_type_id",iJnlTypeID);
			}

			// txn_date //
			if (GetField_CString(hJnl,"v_cr_txn_date",&csTxnDate)) {
				DEBUGLOG(("postSingleJournal: txn_date = [%s]\n",csTxnDate));
				PutField_CString(hJnlHdr,"txn_date",csTxnDate);			
			}

			// country_code //
			if (GetField_CString(hJnl,"v_country",&csTmp)) {
				DEBUGLOG(("postSingleJournal: country_code = [%s]\n",csTmp));
				PutField_CString(hJnlHdr,"country_code",csTmp);
			}
			
			// product_code //
			if (GetField_CString(hJnl,"v_product",&csProduct)) {
				DEBUGLOG(("postSingleJournal: product_code = [%s]\n",csProduct));
				PutField_CString(hJnlHdr,"product_code",csProduct);
			}
			
			// description //
			DEBUGLOG(("postSingleJournal: description = [%s]\n",csType));
			PutField_CString(hJnlHdr,"description",csType);

			// status
			//DEBUGLOG(("postSingleJournal: status = [%c]\n",cStatus));
			//PutField_Char(hJnlHdr,"status",cStatus);
			
			// create_user //
			DEBUGLOG(("postSingleJournal: create_user = [%s]\n",csPostUser));
			PutField_CString(hJnlHdr,"create_user",csPostUser);			
			

		}
		
		i++;
		
		// Journal Detail
		hJnlDtl = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hJnlDtl,0);

		// GL ID
		if (GetField_Int(hJnl,"v_gl_id",&iTmp)) {
			DEBUGLOG(("postSingleJournal: v_gl_id = [%d]\n", iTmp));
			PutField_Int(hJnlDtl,"gl_id",iTmp);
		}
		
		// Currency
		if (GetField_CString(hJnl,"v_currency",&csTxnCcy)) {
			DEBUGLOG(("postSingleJournal: v_currency = [%s]\n", csTxnCcy));
			PutField_CString(hJnlDtl,"currency_id",csTxnCcy);
		}		

		// Txn amt
		if (GetField_Double(hJnl,"v_txn_amt",&dTmpAmt)) {
			DEBUGLOG(("postSingleJournal: v_txn_amt = [%f]\n", dTmpAmt));
			PutField_Double(hJnlDtl,"txn_amt",dTmpAmt);
		}

		// CR ind
		if (GetField_CString(hJnl,"v_cr_ind",&csCrInd)) {
			cTmp = csCrInd[0];
			DEBUGLOG(("postSingleJournal: v_cr_ind = [%c]\n", cTmp));
			PutField_Char(hJnlDtl,"cr_ind",cTmp);
		}

		// Txn Count
		if (GetField_Int(hJnl,"v_txn_cnt",&iTmp)) {
			DEBUGLOG(("postSingleJournal: v_txn_cnt = [%d]\n", iTmp));
			PutField_Int(hJnlDtl,"txn_count",iTmp);
		} else {
			DEBUGLOG(("postSingleJournal: v_txn_cnt not found\n"));
		}

		RecordSet_Add(rsJnlDtl,hJnlDtl);

		// Determine the FX gain/loss
		if (GetFXConvertAmt(csTxnDate, csTxnCcy, csFxGainLossCcy, dTmpAmt, &dConvertAmt)!=PD_OK) {
			DEBUGLOG(("postSingleJournal: Fail to get FX rate at converted request amount\n"));
			return FAILURE;			
		}
		
		// Credit (+), Debit (-)
		if (!strcmp(csCrInd,"D"))
			dFxGainLoss = (double) dFxGainLoss + dConvertAmt;
		else
			dFxGainLoss = (double) dFxGainLoss + (dConvertAmt*-1);

		hJnl = RecordSet_GetNext(rsJnl);
	}
	
	if (iFound) {
		if ((dFxGainLoss != 0.000000) && (dFxGainLoss != -0.000000)) {	
			if (dFxGainLoss > 0.0f) {
				// Credit
				strcpy(csCrInd, "C");
				DEBUGLOG(("postSingleJournal: Credit FxGainLoss for Type [%s] = [%f]\n",csType, dFxGainLoss));
				
			} else if ((dFxGainLoss < 0.0f) && ((dFxGainLoss*-1) > 0.0f)) {
				// Debit
				strcpy(csCrInd, "D");
				dFxGainLoss = dFxGainLoss * -1;
				DEBUGLOG(("postSingleJournal: Debit FxGainLoss for Type [%s] = [%f]\n",csType, dFxGainLoss));
				
			}
			
			// Journal Detail for FX Gain/Loss
			DEBUGLOG(("postSingleJournal:FX Gain/Loss GL [%s] and SL [%s]\n",csFXGL_GL,csFXGL_SL));
			// Get FX Gain/Loss GL ID
			strcpy(csFXGL_GL, PD_FXGL_GL);
			
			if (!strcmp(csProduct,PD_PRODUCT_GATEWAY))
				strcpy(csFXGL_SL,PD_GATEWAY_FXGL_SL);
			else if (!strcmp(csProduct,PD_PRODUCT_HYBRID))
				strcpy(csFXGL_SL,PD_HYBRID_FXGL_SL);
			else if (!strcmp(csProduct,PD_PRODUCT_OFFLINE))
				strcpy(csFXGL_SL,PD_OFFLINE_FXGL_SL);

			DEBUGLOG(("postSingleJournal:FX Gain/Loss GL [%s] and SL [%s]\n",csFXGL_GL,csFXGL_SL));

			DBObjPtr = CreateObj(DBPtr,"DBCrrGlCode","GetIDbyGLSL");
			iRet = (unsigned long) ((*DBObjPtr)(csFXGL_GL, csFXGL_SL, &iTmp));

			if (iRet != FOUND) {
				DEBUGLOG(("postSingleJournal: Fail to get FX Gain/Loss GL ID by GL [%s] and SL [%s]\n",csFXGL_GL,csFXGL_SL));
				return FAILURE;					
			}

			// Journal Detail
			hJnlDtl = (hash_t*) malloc (sizeof(hash_t));
			hash_init(hJnlDtl,0);

			// GL ID
			DEBUGLOG(("postSingleJournal: v_gl_id = [%d]\n", iTmp));
			PutField_Int(hJnlDtl,"gl_id",iTmp);

			// Currency
			DEBUGLOG(("postSingleJournal: csFxGainLossCcy = [%s]\n", csFxGainLossCcy));
			PutField_CString(hJnlDtl,"currency_id",csFxGainLossCcy);

			// Txn amt
			DEBUGLOG(("postSingleJournal: dFxGainLoss = [%f]\n", dFxGainLoss));
			PutField_Double(hJnlDtl,"txn_amt",dFxGainLoss);

			// CR ind
			cTmp = csCrInd[0];
			DEBUGLOG(("postSingleJournal: v_cr_ind = [%c]\n", cTmp));
			PutField_Char(hJnlDtl,"cr_ind",cTmp);

			RecordSet_Add(rsJnlDtl,hJnlDtl);			
		}	
	
		// Add Journal
		BOObjPtr = CreateObj(BOPtr,"BOCrrJnl","Add");
		iRet = (unsigned long) ((*BOObjPtr)(hJnlHdr, rsJnlDtl));				
		
		if(iRet==PD_OK) {
			DEBUGLOG(("postSingleJournal::CrrJnlHeader->Add Success\n"));

		} else {
			DEBUGLOG(("postSingleJournal::CrrJnlHeader->Add Failed\n"));	
		}
	}
	
	DEBUGLOG(("End postSingleJournal and return:[%d]\n",iRet));
	return iRet;
}

int postMultipleJournal(char* csType, recordset_t* rsJnl, const char* csPostUser) 
{
	int		iRet = PD_OK;
	//char	*csPtr;
	hash_t	*hJnl;
	//int 	i = 1;
	int 	iFound = 0;
	
	char*	csTxnID = "";
	char*	csCurrTxnID = "";
	/*
	char*	csTmp = NULL;* 
	int		iTmp;
	char	cTmp;	
	double	dTmp;
	int		iJnlTypeID;
	*/
	//int		iMnlApproval;
	//char	cStatus = PD_JNL_APPROVED;
	
	hash_t  *hJnlHdr;
	hash_t	*hJnlDtl;

	hJnlHdr = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hJnlHdr,0);

	hJnlDtl = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hJnlHdr,0);

	// RS for holding single journal
	recordset_t *rsSingleJnl;
	rsSingleJnl = (recordset_t*) malloc (sizeof(recordset_t));	
	recordset_init(rsSingleJnl,0);

	// RS for holding jnl details
	recordset_t *rsJnlDtl;
	rsJnlDtl = (recordset_t*) malloc (sizeof(recordset_t));	
	recordset_init(rsJnlDtl,0);

	hJnl = RecordSet_GetFirst(rsJnl);
	if (hJnl) {
		// Journal Header
		iFound = 1;

		// ref_no //
		if (GetField_CString(hJnl,"v_th_txn_id",&csTxnID)) {	
			//
		}

		// Set current txn ID
		csCurrTxnID = strdup(csTxnID);
		DEBUGLOG(("postMultipleJournal: csCurrTxnID = [%s]\n",csCurrTxnID));			


		RecordSet_Add(rsSingleJnl,hJnl);		
	}
	
	hJnl = RecordSet_GetNext(rsJnl);
	while (hJnl) {

		if (GetField_CString(hJnl,"v_th_txn_id",&csTxnID)) {
			//DEBUGLOG(("postMultipleJournal: ref_no = [%s]\n",csTxnID));			
		}

		if (strcmp(csCurrTxnID, csTxnID)) {
			// Add Journal
			iRet = postSingleJournal(csType, rsSingleJnl, csPostUser); 

			if(iRet==PD_OK) {
				DEBUGLOG(("postMultipleJournal::postSingleJournal [%s]->Add Success\n",csCurrTxnID));
			} else {
				DEBUGLOG(("postMultipleJournal::postSingleJournal [%s]->Add Failed\n",csCurrTxnID));
				
				DEBUGLOG(("End postMultipleJournal and return:[%d]\n",iRet));
				return iRet;
			}		
			 
			// Reset single RS
			recordset_init(rsSingleJnl,0);
			
			// Set current txn ID
			csCurrTxnID = strdup(csTxnID);
			DEBUGLOG(("postMultipleJournal: csCurrTxnID = [%s]\n",csCurrTxnID));
			
		}

		RecordSet_Add(rsSingleJnl,hJnl);
		
		hJnl = RecordSet_GetNext(rsJnl);
	}
	
	if (iFound) {
		// Add Journal
		iRet = postSingleJournal(csType, rsSingleJnl, csPostUser); 

		if(iRet==PD_OK) {
			DEBUGLOG(("postMultipleJournal::postSingleJournal [%s]->Add Success\n",csCurrTxnID));
		} else {
			DEBUGLOG(("postMultipleJournal::postSingleJournal [%s]->Add Failed\n",csCurrTxnID));	
		}	
	}
	
	DEBUGLOG(("End postMultipleJournal and return:[%d]\n",iRet));
	return iRet;
}

int GetApprovedDeposit(recordset_t* myRec, const char* csTxnDate, const char* csCountry, const char* csProduct)
{
	hash_t *myHash;
	EXEC SQL WHENEVER SQLERROR GOTO GetApprovedDeposit_error;
    EXEC SQL WHENEVER NOTFOUND CONTINUE;		
	
	EXEC SQL BEGIN DECLARE SECTION;		
		varchar	v_cr_txn_date[PD_DATE_LEN + 1];
		short	ind_cr_txn_date = -1;
		
		varchar	v_country[PD_COUNTRY_CODE_LEN + 1];
		short	ind_country = -1;
		
		varchar	v_product[PD_PRODUCT_CODE_LEN + 1];
		short	ind_product = -1;
		
		varchar	v_party_type[PD_PARTY_TYPE_LEN + 1];
		short	ind_party_type = -1;
		
		varchar	v_party_id[PD_PARTY_ID_LEN + 1];
		short	ind_party_id = -1;	
		
		varchar	v_currency[PD_CURRENCY_ID_LEN + 1];
		short	ind_currency = -1;	
		
		int		v_jnl_type_id;
		short	ind_jnl_type_id = -1;	
		
		varchar	v_jnl_entry_type_id[PD_JNL_ENTRY_TYPE_LEN + 1];
		short	ind_jnl_entry_type_id = -1;	
		
		varchar	v_cr_ind[PD_CR_IND_LEN + 1];
		short	ind_cr_ind = -1;	
		
		int		v_gl_id;
		short	ind_gl_id = -1;
		
		int		v_txn_cnt;
		short	ind_txn_cnt = -1;	
		
		double	v_txn_amt;
		short	ind_txn_amt = -1;			
	EXEC SQL END DECLARE SECTION;

	v_cr_txn_date.len = strlen(csTxnDate);
	memcpy(v_cr_txn_date.arr,csTxnDate,v_cr_txn_date.len);
	ind_cr_txn_date = 0;

	v_country.len = strlen(csCountry);
	memcpy(v_country.arr,csCountry,v_country.len);
	ind_country = 0;
	
	v_product.len = strlen(csProduct);
	memcpy(v_product.arr,csProduct,v_product.len);
	ind_product = 0;	

	DEBUGLOG(("GetApprovedDeposit csTxnDate = [%s]\n",csTxnDate));
	DEBUGLOG(("GetApprovedDeposit csCountry = [%s]\n",csCountry));
	DEBUGLOG(("GetApprovedDeposit csProduct = [%s]\n",csProduct));
	
	EXEC SQL DECLARE c_cursor_GetApprovedDeposit CURSOR FOR
		select cr_txn_date, cr_country, cr_product, te_party_type, party_id, cr_currency, cr_jnl_type_id,
		cr_jnl_entry_type_id, cr_ind, cr_gl_id, txn_count, cr_amount
		from crr_apl_deposit_view
		where cr_txn_date = :v_cr_txn_date:ind_cr_txn_date and cr_country = :v_country:ind_country and cr_product = :v_product:ind_product;

	EXEC SQL OPEN c_cursor_GetApprovedDeposit;
        do {    
        	EXEC SQL FETCH c_cursor_GetApprovedDeposit
              	INTO
			:v_cr_txn_date:ind_cr_txn_date,
			:v_country:ind_country,
			:v_product:ind_product,
			:v_party_type:ind_party_type,
			:v_party_id:ind_party_id,
			:v_currency:ind_currency,
			:v_jnl_type_id:ind_jnl_type_id,
			:v_jnl_entry_type_id:ind_jnl_entry_type_id,
			:v_cr_ind:ind_cr_ind,
			:v_gl_id:ind_gl_id,
			:v_txn_cnt:ind_txn_cnt,
			:v_txn_amt:ind_txn_amt;

			if (SQLCODE == SQL_NOT_FOUND) { 
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			if (ind_cr_txn_date >= 0) {
				v_cr_txn_date.arr[v_cr_txn_date.len] ='\0';
				PutField_CString(myHash,"v_cr_txn_date",(const char*)v_cr_txn_date.arr);
				DEBUGLOG(("GetApprovedDeposit v_cr_txn_date = [%s]\n",v_cr_txn_date.arr)); 
			}
			if (ind_country >= 0) {
				v_country.arr[v_country.len] ='\0';
				PutField_CString(myHash,"v_country",(const char*)v_country.arr);
				DEBUGLOG(("GetApprovedDeposit v_country = [%s]\n",v_country.arr)); 
			}
			if (ind_product >= 0) {
				v_product.arr[v_product.len] ='\0';
				PutField_CString(myHash,"v_product",(const char*)v_product.arr);
				DEBUGLOG(("GetApprovedDeposit v_product = [%s]\n",v_product.arr)); 
			}
			if (ind_party_type >= 0) {
				v_party_type.arr[v_party_type.len] ='\0';
				PutField_CString(myHash,"v_party_type",(const char*)v_party_type.arr);
				DEBUGLOG(("GetApprovedDeposit v_party_type = [%s]\n",v_party_type.arr)); 
			}
			if (ind_party_id >= 0) {
				v_party_id.arr[v_party_id.len] ='\0';
				PutField_CString(myHash,"v_party_id",(const char*)v_party_id.arr);
				DEBUGLOG(("GetApprovedDeposit v_party_id = [%s]\n",v_party_id.arr)); 
			}		
			if (ind_currency >= 0) {
				v_currency.arr[v_currency.len] ='\0';
				PutField_CString(myHash,"v_currency",(const char*)v_currency.arr);
				DEBUGLOG(("GetApprovedDeposit v_currency = [%s]\n",v_currency.arr)); 
			}
			if (ind_jnl_type_id >= 0) {
				PutField_Int(myHash,"v_jnl_type_id",(int)v_jnl_type_id);
				DEBUGLOG(("GetApprovedDeposit v_jnl_type_id = [%d]\n",v_jnl_type_id)); 
			}
			if (ind_jnl_entry_type_id >= 0) {
				v_jnl_entry_type_id.arr[v_jnl_entry_type_id.len] ='\0';
				PutField_CString(myHash,"v_jnl_entry_type_id",(const char*)v_jnl_entry_type_id.arr);
				DEBUGLOG(("GetApprovedDeposit v_jnl_entry_type_id = [%s]\n",v_jnl_entry_type_id.arr)); 
			}	
			if (ind_cr_ind >= 0) {
				v_cr_ind.arr[v_cr_ind.len] ='\0';
				PutField_CString(myHash,"v_cr_ind",(const char*)v_cr_ind.arr);
				DEBUGLOG(("GetApprovedDeposit v_cr_ind = [%s]\n",v_cr_ind.arr)); 
			}
			if (ind_gl_id >= 0) {
				PutField_Int(myHash,"v_gl_id",(int)v_gl_id);
				DEBUGLOG(("GetApprovedDeposit v_gl_id = [%d]\n",v_gl_id)); 
			}
			if (ind_txn_cnt >= 0) {
				PutField_Int(myHash,"v_txn_cnt",(int)v_txn_cnt);
				DEBUGLOG(("GetApprovedDeposit v_txn_cnt = [%d]\n",v_txn_cnt)); 
			}
			if (ind_txn_amt >= 0) {
				PutField_Double(myHash,"v_txn_amt",(double)v_txn_amt);
				DEBUGLOG(("GetApprovedDeposit v_txn_amt = [%f]\n",v_txn_amt)); 
			}			
			RecordSet_Add(myRec,myHash);
		}
		while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_GetApprovedDeposit;

	DEBUGLOG(("GetApprovedDeposit Normal Exit\n")); 
	return  PD_OK;

GetApprovedDeposit_error:
	DEBUGLOG(("GetApprovedDeposit_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_GetApprovedDeposit;
	return PD_ERR;
}

int GetVoidDeposit(recordset_t* myRec, const char* csTxnDate, const char* csCountry, const char* csProduct)
{
	hash_t *myHash;
	EXEC SQL WHENEVER SQLERROR GOTO GetVoidDeposit_error;
    EXEC SQL WHENEVER NOTFOUND CONTINUE;		
	
	EXEC SQL BEGIN DECLARE SECTION;		
		varchar	v_cr_txn_date[PD_DATE_LEN + 1];
		short	ind_cr_txn_date = -1;
		
		varchar	v_country[PD_COUNTRY_CODE_LEN + 1];
		short	ind_country = -1;
		
		varchar	v_product[PD_PRODUCT_CODE_LEN + 1];
		short	ind_product = -1;
		
		varchar	v_party_type[PD_PARTY_TYPE_LEN + 1];
		short	ind_party_type = -1;
		
		varchar	v_party_id[PD_PARTY_ID_LEN + 1];
		short	ind_party_id = -1;	
		
		varchar	v_currency[PD_CURRENCY_ID_LEN + 1];
		short	ind_currency = -1;	
		
		int		v_jnl_type_id;
		short	ind_jnl_type_id = -1;	
		
		varchar	v_jnl_entry_type_id[PD_JNL_ENTRY_TYPE_LEN + 1];
		short	ind_jnl_entry_type_id = -1;	
		
		varchar	v_cr_ind[PD_CR_IND_LEN + 1];
		short	ind_cr_ind = -1;	
		
		int		v_gl_id;
		short	ind_gl_id = -1;
		
		int		v_txn_cnt;
		short	ind_txn_cnt = -1;	
		
		double	v_txn_amt;
		short	ind_txn_amt = -1;			
	EXEC SQL END DECLARE SECTION;

	v_cr_txn_date.len = strlen(csTxnDate);
	memcpy(v_cr_txn_date.arr,csTxnDate,v_cr_txn_date.len);
	ind_cr_txn_date = 0;

	v_country.len = strlen(csCountry);
	memcpy(v_country.arr,csCountry,v_country.len);
	ind_country = 0;
	
	v_product.len = strlen(csProduct);
	memcpy(v_product.arr,csProduct,v_product.len);
	ind_product = 0;	

	DEBUGLOG(("GetVoidDeposit csTxnDate = [%s]\n",csTxnDate));
	DEBUGLOG(("GetVoidDeposit csCountry = [%s]\n",csCountry));
	DEBUGLOG(("GetVoidDeposit csProduct = [%s]\n",csProduct));
	
	EXEC SQL DECLARE c_cursor_GetVoidDeposit CURSOR FOR
		select cr_txn_date, cr_country, cr_product, te_party_type, party_id, cr_currency, cr_jnl_type_id,
		cr_jnl_entry_type_id, cr_ind, cr_gl_id, txn_count, cr_amount
		from CRR_VOD_DEPOSIT_VIEW
		where cr_txn_date = :v_cr_txn_date:ind_cr_txn_date and cr_country = :v_country:ind_country and cr_product = :v_product:ind_product;

	EXEC SQL OPEN c_cursor_GetVoidDeposit;
        do {    
        	EXEC SQL FETCH c_cursor_GetVoidDeposit
              	INTO
			:v_cr_txn_date:ind_cr_txn_date,
			:v_country:ind_country,
			:v_product:ind_product,
			:v_party_type:ind_party_type,
			:v_party_id:ind_party_id,
			:v_currency:ind_currency,
			:v_jnl_type_id:ind_jnl_type_id,
			:v_jnl_entry_type_id:ind_jnl_entry_type_id,
			:v_cr_ind:ind_cr_ind,
			:v_gl_id:ind_gl_id,
			:v_txn_cnt:ind_txn_cnt,
			:v_txn_amt:ind_txn_amt;

			if (SQLCODE == SQL_NOT_FOUND) { 
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			if (ind_cr_txn_date >= 0) {
				v_cr_txn_date.arr[v_cr_txn_date.len] ='\0';
				PutField_CString(myHash,"v_cr_txn_date",(const char*)v_cr_txn_date.arr);
				DEBUGLOG(("GetVoidDeposit v_cr_txn_date = [%s]\n",v_cr_txn_date.arr)); 
			}
			if (ind_country >= 0) {
				v_country.arr[v_country.len] ='\0';
				PutField_CString(myHash,"v_country",(const char*)v_country.arr);
				DEBUGLOG(("GetVoidDeposit v_country = [%s]\n",v_country.arr)); 
			}
			if (ind_product >= 0) {
				v_product.arr[v_product.len] ='\0';
				PutField_CString(myHash,"v_product",(const char*)v_product.arr);
				DEBUGLOG(("GetVoidDeposit v_product = [%s]\n",v_product.arr)); 
			}
			if (ind_party_type >= 0) {
				v_party_type.arr[v_party_type.len] ='\0';
				PutField_CString(myHash,"v_party_type",(const char*)v_party_type.arr);
				DEBUGLOG(("GetVoidDeposit v_party_type = [%s]\n",v_party_type.arr)); 
			}
			if (ind_party_id >= 0) {
				v_party_id.arr[v_party_id.len] ='\0';
				PutField_CString(myHash,"v_party_id",(const char*)v_party_id.arr);
				DEBUGLOG(("GetVoidDeposit v_party_id = [%s]\n",v_party_id.arr)); 
			}		
			if (ind_currency >= 0) {
				v_currency.arr[v_currency.len] ='\0';
				PutField_CString(myHash,"v_currency",(const char*)v_currency.arr);
				DEBUGLOG(("GetVoidDeposit v_currency = [%s]\n",v_currency.arr)); 
			}
			if (ind_jnl_type_id >= 0) {
				PutField_Int(myHash,"v_jnl_type_id",(int)v_jnl_type_id);
				DEBUGLOG(("GetVoidDeposit v_jnl_type_id = [%d]\n",v_jnl_type_id)); 
			}
			if (ind_jnl_entry_type_id >= 0) {
				v_jnl_entry_type_id.arr[v_jnl_entry_type_id.len] ='\0';
				PutField_CString(myHash,"v_jnl_entry_type_id",(const char*)v_jnl_entry_type_id.arr);
				DEBUGLOG(("GetVoidDeposit v_jnl_entry_type_id = [%s]\n",v_jnl_entry_type_id.arr)); 
			}	
			if (ind_cr_ind >= 0) {
				v_cr_ind.arr[v_cr_ind.len] ='\0';
				PutField_CString(myHash,"v_cr_ind",(const char*)v_cr_ind.arr);
				DEBUGLOG(("GetVoidDeposit v_cr_ind = [%s]\n",v_cr_ind.arr)); 
			}
			if (ind_gl_id >= 0) {
				PutField_Int(myHash,"v_gl_id",(int)v_gl_id);
				DEBUGLOG(("GetVoidDeposit v_gl_id = [%d]\n",v_gl_id)); 
			}
			if (ind_txn_cnt >= 0) {
				PutField_Int(myHash,"v_txn_cnt",(int)v_txn_cnt);
				DEBUGLOG(("GetVoidDeposit v_txn_cnt = [%d]\n",v_txn_cnt)); 
			}
			if (ind_txn_amt >= 0) {
				PutField_Double(myHash,"v_txn_amt",(double)v_txn_amt);
				DEBUGLOG(("GetVoidDeposit v_txn_amt = [%f]\n",v_txn_amt)); 
			}			
			RecordSet_Add(myRec,myHash);
		}
		while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_GetVoidDeposit;

	DEBUGLOG(("GetVoidDeposit Normal Exit\n")); 
	return  PD_OK;

GetVoidDeposit_error:
	DEBUGLOG(("GetVoidDeposit_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_GetVoidDeposit;
	return PD_ERR;
}

int GetReconDeposit(recordset_t* myRec, const char* csTxnDate, const char* csCountry, const char* csProduct)
{
	hash_t *myHash;
	EXEC SQL WHENEVER SQLERROR GOTO GetReconDeposit_error;
    EXEC SQL WHENEVER NOTFOUND CONTINUE;		
	
	EXEC SQL BEGIN DECLARE SECTION;		
		varchar	v_cr_txn_date[PD_DATE_LEN + 1];
		short	ind_cr_txn_date = -1;
		
		varchar	v_country[PD_COUNTRY_CODE_LEN + 1];
		short	ind_country = -1;
		
		varchar	v_product[PD_PRODUCT_CODE_LEN + 1];
		short	ind_product = -1;
		
		varchar	v_party_type[PD_PARTY_TYPE_LEN + 1];
		short	ind_party_type = -1;
		
		varchar	v_party_id[PD_PARTY_ID_LEN + 1];
		short	ind_party_id = -1;	
		
		varchar	v_currency[PD_CURRENCY_ID_LEN + 1];
		short	ind_currency = -1;	
		
		int		v_jnl_type_id;
		short	ind_jnl_type_id = -1;	
		
		varchar	v_jnl_entry_type_id[PD_JNL_ENTRY_TYPE_LEN + 1];
		short	ind_jnl_entry_type_id = -1;	
		
		varchar	v_cr_ind[PD_CR_IND_LEN + 1];
		short	ind_cr_ind = -1;	
		
		int		v_gl_id;
		short	ind_gl_id = -1;
		
		int		v_txn_cnt;
		short	ind_txn_cnt = -1;	
		
		double	v_txn_amt;
		short	ind_txn_amt = -1;			
	EXEC SQL END DECLARE SECTION;

	v_cr_txn_date.len = strlen(csTxnDate);
	memcpy(v_cr_txn_date.arr,csTxnDate,v_cr_txn_date.len);
	ind_cr_txn_date = 0;

	v_country.len = strlen(csCountry);
	memcpy(v_country.arr,csCountry,v_country.len);
	ind_country = 0;
	
	v_product.len = strlen(csProduct);
	memcpy(v_product.arr,csProduct,v_product.len);
	ind_product = 0;	

	DEBUGLOG(("GetReconDeposit csTxnDate = [%s]\n",csTxnDate));
	DEBUGLOG(("GetReconDeposit csCountry = [%s]\n",csCountry));
	DEBUGLOG(("GetReconDeposit csProduct = [%s]\n",csProduct));
	
	EXEC SQL DECLARE c_cursor_GetReconDeposit CURSOR FOR
		select cr_txn_date, cr_country, cr_product, te_party_type, party_id, cr_currency, cr_jnl_type_id,
		cr_jnl_entry_type_id, cr_ind, cr_gl_id, txn_count, cr_amount
		from CRR_REC_DEPOSIT_VIEW
		where cr_txn_date = :v_cr_txn_date:ind_cr_txn_date and cr_country = :v_country:ind_country and cr_product = :v_product:ind_product;

	EXEC SQL OPEN c_cursor_GetReconDeposit;
        do {    
        	EXEC SQL FETCH c_cursor_GetReconDeposit
              	INTO
			:v_cr_txn_date:ind_cr_txn_date,
			:v_country:ind_country,
			:v_product:ind_product,
			:v_party_type:ind_party_type,
			:v_party_id:ind_party_id,
			:v_currency:ind_currency,
			:v_jnl_type_id:ind_jnl_type_id,
			:v_jnl_entry_type_id:ind_jnl_entry_type_id,
			:v_cr_ind:ind_cr_ind,
			:v_gl_id:ind_gl_id,
			:v_txn_cnt:ind_txn_cnt,
			:v_txn_amt:ind_txn_amt;

			if (SQLCODE == SQL_NOT_FOUND) { 
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			if (ind_cr_txn_date >= 0) {
				v_cr_txn_date.arr[v_cr_txn_date.len] ='\0';
				PutField_CString(myHash,"v_cr_txn_date",(const char*)v_cr_txn_date.arr);
				DEBUGLOG(("GetReconDeposit v_cr_txn_date = [%s]\n",v_cr_txn_date.arr)); 
			}
			if (ind_country >= 0) {
				v_country.arr[v_country.len] ='\0';
				PutField_CString(myHash,"v_country",(const char*)v_country.arr);
				DEBUGLOG(("GetReconDeposit v_country = [%s]\n",v_country.arr)); 
			}
			if (ind_product >= 0) {
				v_product.arr[v_product.len] ='\0';
				PutField_CString(myHash,"v_product",(const char*)v_product.arr);
				DEBUGLOG(("GetReconDeposit v_product = [%s]\n",v_product.arr)); 
			}
			if (ind_party_type >= 0) {
				v_party_type.arr[v_party_type.len] ='\0';
				PutField_CString(myHash,"v_party_type",(const char*)v_party_type.arr);
				DEBUGLOG(("GetReconDeposit v_party_type = [%s]\n",v_party_type.arr)); 
			}
			if (ind_party_id >= 0) {
				v_party_id.arr[v_party_id.len] ='\0';
				PutField_CString(myHash,"v_party_id",(const char*)v_party_id.arr);
				DEBUGLOG(("GetReconDeposit v_party_id = [%s]\n",v_party_id.arr)); 
			}		
			if (ind_currency >= 0) {
				v_currency.arr[v_currency.len] ='\0';
				PutField_CString(myHash,"v_currency",(const char*)v_currency.arr);
				DEBUGLOG(("GetReconDeposit v_currency = [%s]\n",v_currency.arr)); 
			}
			if (ind_jnl_type_id >= 0) {
				PutField_Int(myHash,"v_jnl_type_id",(int)v_jnl_type_id);
				DEBUGLOG(("GetReconDeposit v_jnl_type_id = [%d]\n",v_jnl_type_id)); 
			}
			if (ind_jnl_entry_type_id >= 0) {
				v_jnl_entry_type_id.arr[v_jnl_entry_type_id.len] ='\0';
				PutField_CString(myHash,"v_jnl_entry_type_id",(const char*)v_jnl_entry_type_id.arr);
				DEBUGLOG(("GetReconDeposit v_jnl_entry_type_id = [%s]\n",v_jnl_entry_type_id.arr)); 
			}	
			if (ind_cr_ind >= 0) {
				v_cr_ind.arr[v_cr_ind.len] ='\0';
				PutField_CString(myHash,"v_cr_ind",(const char*)v_cr_ind.arr);
				DEBUGLOG(("GetReconDeposit v_cr_ind = [%s]\n",v_cr_ind.arr)); 
			}
			if (ind_gl_id >= 0) {
				PutField_Int(myHash,"v_gl_id",(int)v_gl_id);
				DEBUGLOG(("GetReconDeposit v_gl_id = [%d]\n",v_gl_id)); 
			}
			if (ind_txn_cnt >= 0) {
				PutField_Int(myHash,"v_txn_cnt",(int)v_txn_cnt);
				DEBUGLOG(("GetReconDeposit v_txn_cnt = [%d]\n",v_txn_cnt)); 
			}
			if (ind_txn_amt >= 0) {
				PutField_Double(myHash,"v_txn_amt",(double)v_txn_amt);
				DEBUGLOG(("GetReconDeposit v_txn_amt = [%f]\n",v_txn_amt)); 
			}			
			RecordSet_Add(myRec,myHash);
		}
		while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_GetReconDeposit;

	DEBUGLOG(("GetReconDeposit Normal Exit\n")); 
	return  PD_OK;

GetReconDeposit_error:
	DEBUGLOG(("GetReconDeposit_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_GetReconDeposit;
	return PD_ERR;
}

int GetApprovedPayout(recordset_t* myRec, const char* csTxnDate, const char* csCountry, const char* csProduct)
{
	hash_t *myHash;
	EXEC SQL WHENEVER SQLERROR GOTO GetApprovedPayout_error;
    EXEC SQL WHENEVER NOTFOUND CONTINUE;		
	
	EXEC SQL BEGIN DECLARE SECTION;		
		varchar	v_cr_txn_date[PD_DATE_LEN + 1];
		short	ind_cr_txn_date = -1;
		
		varchar	v_country[PD_COUNTRY_CODE_LEN + 1];
		short	ind_country = -1;
		
		varchar	v_product[PD_PRODUCT_CODE_LEN + 1];
		short	ind_product = -1;
		
		varchar	v_party_type[PD_PARTY_TYPE_LEN + 1];
		short	ind_party_type = -1;
		
		varchar	v_party_id[PD_PARTY_ID_LEN + 1];
		short	ind_party_id = -1;	
		
		varchar	v_currency[PD_CURRENCY_ID_LEN + 1];
		short	ind_currency = -1;	
		
		int		v_jnl_type_id;
		short	ind_jnl_type_id = -1;	
		
		varchar	v_jnl_entry_type_id[PD_JNL_ENTRY_TYPE_LEN + 1];
		short	ind_jnl_entry_type_id = -1;	
		
		varchar	v_cr_ind[PD_CR_IND_LEN + 1];
		short	ind_cr_ind = -1;	
		
		int		v_gl_id;
		short	ind_gl_id = -1;
		
		int		v_txn_cnt;
		short	ind_txn_cnt = -1;	
		
		double	v_txn_amt;
		short	ind_txn_amt = -1;			
	EXEC SQL END DECLARE SECTION;

	v_cr_txn_date.len = strlen(csTxnDate);
	memcpy(v_cr_txn_date.arr,csTxnDate,v_cr_txn_date.len);
	ind_cr_txn_date = 0;

	v_country.len = strlen(csCountry);
	memcpy(v_country.arr,csCountry,v_country.len);
	ind_country = 0;
	
	v_product.len = strlen(csProduct);
	memcpy(v_product.arr,csProduct,v_product.len);
	ind_product = 0;	

	DEBUGLOG(("GetApprovedPayout csTxnDate = [%s]\n",csTxnDate));
	DEBUGLOG(("GetApprovedPayout csCountry = [%s]\n",csCountry));
	DEBUGLOG(("GetApprovedPayout csProduct = [%s]\n",csProduct));
	
	EXEC SQL DECLARE c_cursor_GetApprovedPayout CURSOR FOR
		select cr_txn_date, cr_country, cr_product, te_party_type, party_id, cr_currency, cr_jnl_type_id,
		cr_jnl_entry_type_id, cr_ind, cr_gl_id, txn_count, cr_amount
		from CRR_APL_PAYOUT_VIEW
		where cr_txn_date = :v_cr_txn_date:ind_cr_txn_date and cr_country = :v_country:ind_country and cr_product = :v_product:ind_product;

	EXEC SQL OPEN c_cursor_GetApprovedPayout;
        do {    
        	EXEC SQL FETCH c_cursor_GetApprovedPayout
              	INTO
			:v_cr_txn_date:ind_cr_txn_date,
			:v_country:ind_country,
			:v_product:ind_product,
			:v_party_type:ind_party_type,
			:v_party_id:ind_party_id,
			:v_currency:ind_currency,
			:v_jnl_type_id:ind_jnl_type_id,
			:v_jnl_entry_type_id:ind_jnl_entry_type_id,
			:v_cr_ind:ind_cr_ind,
			:v_gl_id:ind_gl_id,
			:v_txn_cnt:ind_txn_cnt,
			:v_txn_amt:ind_txn_amt;

			if (SQLCODE == SQL_NOT_FOUND) { 
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			if (ind_cr_txn_date >= 0) {
				v_cr_txn_date.arr[v_cr_txn_date.len] ='\0';
				PutField_CString(myHash,"v_cr_txn_date",(const char*)v_cr_txn_date.arr);
				DEBUGLOG(("GetApprovedPayout v_cr_txn_date = [%s]\n",v_cr_txn_date.arr)); 
			}
			if (ind_country >= 0) {
				v_country.arr[v_country.len] ='\0';
				PutField_CString(myHash,"v_country",(const char*)v_country.arr);
				DEBUGLOG(("GetApprovedPayout v_country = [%s]\n",v_country.arr)); 
			}
			if (ind_product >= 0) {
				v_product.arr[v_product.len] ='\0';
				PutField_CString(myHash,"v_product",(const char*)v_product.arr);
				DEBUGLOG(("GetApprovedPayout v_product = [%s]\n",v_product.arr)); 
			}
			if (ind_party_type >= 0) {
				v_party_type.arr[v_party_type.len] ='\0';
				PutField_CString(myHash,"v_party_type",(const char*)v_party_type.arr);
				DEBUGLOG(("GetApprovedPayout v_party_type = [%s]\n",v_party_type.arr)); 
			}
			if (ind_party_id >= 0) {
				v_party_id.arr[v_party_id.len] ='\0';
				PutField_CString(myHash,"v_party_id",(const char*)v_party_id.arr);
				DEBUGLOG(("GetApprovedPayout v_party_id = [%s]\n",v_party_id.arr)); 
			}		
			if (ind_currency >= 0) {
				v_currency.arr[v_currency.len] ='\0';
				PutField_CString(myHash,"v_currency",(const char*)v_currency.arr);
				DEBUGLOG(("GetApprovedPayout v_currency = [%s]\n",v_currency.arr)); 
			}
			if (ind_jnl_type_id >= 0) {
				PutField_Int(myHash,"v_jnl_type_id",(int)v_jnl_type_id);
				DEBUGLOG(("GetApprovedPayout v_jnl_type_id = [%d]\n",v_jnl_type_id)); 
			}
			if (ind_jnl_entry_type_id >= 0) {
				v_jnl_entry_type_id.arr[v_jnl_entry_type_id.len] ='\0';
				PutField_CString(myHash,"v_jnl_entry_type_id",(const char*)v_jnl_entry_type_id.arr);
				DEBUGLOG(("GetApprovedPayout v_jnl_entry_type_id = [%s]\n",v_jnl_entry_type_id.arr)); 
			}	
			if (ind_cr_ind >= 0) {
				v_cr_ind.arr[v_cr_ind.len] ='\0';
				PutField_CString(myHash,"v_cr_ind",(const char*)v_cr_ind.arr);
				DEBUGLOG(("GetApprovedPayout v_cr_ind = [%s]\n",v_cr_ind.arr)); 
			}
			if (ind_gl_id >= 0) {
				PutField_Int(myHash,"v_gl_id",(int)v_gl_id);
				DEBUGLOG(("GetApprovedPayout v_gl_id = [%d]\n",v_gl_id)); 
			}
			if (ind_txn_cnt >= 0) {
				PutField_Int(myHash,"v_txn_cnt",(int)v_txn_cnt);
				DEBUGLOG(("GetApprovedPayout v_txn_cnt = [%d]\n",v_txn_cnt)); 
			}
			if (ind_txn_amt >= 0) {
				PutField_Double(myHash,"v_txn_amt",(double)v_txn_amt);
				DEBUGLOG(("GetApprovedPayout v_txn_amt = [%f]\n",v_txn_amt)); 
			}			
			RecordSet_Add(myRec,myHash);
		}
		while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_GetApprovedPayout;

	DEBUGLOG(("GetApprovedPayout Normal Exit\n")); 
	return  PD_OK;

GetApprovedPayout_error:
	DEBUGLOG(("GetApprovedPayout_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_GetApprovedPayout;
	return PD_ERR;
}

int GetGeneratedPayout(recordset_t* myRec, const char* csTxnDate, const char* csCountry, const char* csProduct)
{
	hash_t *myHash;
	EXEC SQL WHENEVER SQLERROR GOTO GetGeneratedPayout_error;
    EXEC SQL WHENEVER NOTFOUND CONTINUE;		
	
	EXEC SQL BEGIN DECLARE SECTION;		
		varchar	v_cr_txn_date[PD_DATE_LEN + 1];
		short	ind_cr_txn_date = -1;
		
		varchar	v_country[PD_COUNTRY_CODE_LEN + 1];
		short	ind_country = -1;
		
		varchar	v_product[PD_PRODUCT_CODE_LEN + 1];
		short	ind_product = -1;
		
		varchar	v_party_type[PD_PARTY_TYPE_LEN + 1];
		short	ind_party_type = -1;
		
		varchar	v_party_id[PD_PARTY_ID_LEN + 1];
		short	ind_party_id = -1;	
		
		varchar	v_currency[PD_CURRENCY_ID_LEN + 1];
		short	ind_currency = -1;	
		
		int		v_jnl_type_id;
		short	ind_jnl_type_id = -1;	
		
		varchar	v_jnl_entry_type_id[PD_JNL_ENTRY_TYPE_LEN + 1];
		short	ind_jnl_entry_type_id = -1;	
		
		varchar	v_cr_ind[PD_CR_IND_LEN + 1];
		short	ind_cr_ind = -1;	
		
		int		v_gl_id;
		short	ind_gl_id = -1;
		
		int		v_txn_cnt;
		short	ind_txn_cnt = -1;	
		
		double	v_txn_amt;
		short	ind_txn_amt = -1;			
	EXEC SQL END DECLARE SECTION;

	v_cr_txn_date.len = strlen(csTxnDate);
	memcpy(v_cr_txn_date.arr,csTxnDate,v_cr_txn_date.len);
	ind_cr_txn_date = 0;

	v_country.len = strlen(csCountry);
	memcpy(v_country.arr,csCountry,v_country.len);
	ind_country = 0;
	
	v_product.len = strlen(csProduct);
	memcpy(v_product.arr,csProduct,v_product.len);
	ind_product = 0;	

	DEBUGLOG(("GetGeneratedPayout csTxnDate = [%s]\n",csTxnDate));
	DEBUGLOG(("GetGeneratedPayout csCountry = [%s]\n",csCountry));
	DEBUGLOG(("GetGeneratedPayout csProduct = [%s]\n",csProduct));
	
	EXEC SQL DECLARE c_cursor_GetGeneratedPayout CURSOR FOR
		select cr_txn_date, cr_country, cr_product, te_party_type, party_id, cr_currency, cr_jnl_type_id,
		cr_jnl_entry_type_id, cr_ind, cr_gl_id, txn_count, cr_amount
		from CRR_GEN_PAYOUT_VIEW
		where cr_txn_date = :v_cr_txn_date:ind_cr_txn_date and cr_country = :v_country:ind_country and cr_product = :v_product:ind_product;

	EXEC SQL OPEN c_cursor_GetGeneratedPayout;
        do {    
        	EXEC SQL FETCH c_cursor_GetGeneratedPayout
              	INTO
			:v_cr_txn_date:ind_cr_txn_date,
			:v_country:ind_country,
			:v_product:ind_product,
			:v_party_type:ind_party_type,
			:v_party_id:ind_party_id,
			:v_currency:ind_currency,
			:v_jnl_type_id:ind_jnl_type_id,
			:v_jnl_entry_type_id:ind_jnl_entry_type_id,
			:v_cr_ind:ind_cr_ind,
			:v_gl_id:ind_gl_id,
			:v_txn_cnt:ind_txn_cnt,
			:v_txn_amt:ind_txn_amt;

			if (SQLCODE == SQL_NOT_FOUND) { 
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			if (ind_cr_txn_date >= 0) {
				v_cr_txn_date.arr[v_cr_txn_date.len] ='\0';
				PutField_CString(myHash,"v_cr_txn_date",(const char*)v_cr_txn_date.arr);
				DEBUGLOG(("GetGeneratedPayout v_cr_txn_date = [%s]\n",v_cr_txn_date.arr)); 
			}
			if (ind_country >= 0) {
				v_country.arr[v_country.len] ='\0';
				PutField_CString(myHash,"v_country",(const char*)v_country.arr);
				DEBUGLOG(("GetGeneratedPayout v_country = [%s]\n",v_country.arr)); 
			}
			if (ind_product >= 0) {
				v_product.arr[v_product.len] ='\0';
				PutField_CString(myHash,"v_product",(const char*)v_product.arr);
				DEBUGLOG(("GetGeneratedPayout v_product = [%s]\n",v_product.arr)); 
			}
			if (ind_party_type >= 0) {
				v_party_type.arr[v_party_type.len] ='\0';
				PutField_CString(myHash,"v_party_type",(const char*)v_party_type.arr);
				DEBUGLOG(("GetGeneratedPayout v_party_type = [%s]\n",v_party_type.arr)); 
			}
			if (ind_party_id >= 0) {
				v_party_id.arr[v_party_id.len] ='\0';
				PutField_CString(myHash,"v_party_id",(const char*)v_party_id.arr);
				DEBUGLOG(("GetGeneratedPayout v_party_id = [%s]\n",v_party_id.arr)); 
			}		
			if (ind_currency >= 0) {
				v_currency.arr[v_currency.len] ='\0';
				PutField_CString(myHash,"v_currency",(const char*)v_currency.arr);
				DEBUGLOG(("GetGeneratedPayout v_currency = [%s]\n",v_currency.arr)); 
			}
			if (ind_jnl_type_id >= 0) {
				PutField_Int(myHash,"v_jnl_type_id",(int)v_jnl_type_id);
				DEBUGLOG(("GetGeneratedPayout v_jnl_type_id = [%d]\n",v_jnl_type_id)); 
			}
			if (ind_jnl_entry_type_id >= 0) {
				v_jnl_entry_type_id.arr[v_jnl_entry_type_id.len] ='\0';
				PutField_CString(myHash,"v_jnl_entry_type_id",(const char*)v_jnl_entry_type_id.arr);
				DEBUGLOG(("GetGeneratedPayout v_jnl_entry_type_id = [%s]\n",v_jnl_entry_type_id.arr)); 
			}	
			if (ind_cr_ind >= 0) {
				v_cr_ind.arr[v_cr_ind.len] ='\0';
				PutField_CString(myHash,"v_cr_ind",(const char*)v_cr_ind.arr);
				DEBUGLOG(("GetGeneratedPayout v_cr_ind = [%s]\n",v_cr_ind.arr)); 
			}
			if (ind_gl_id >= 0) {
				PutField_Int(myHash,"v_gl_id",(int)v_gl_id);
				DEBUGLOG(("GetGeneratedPayout v_gl_id = [%d]\n",v_gl_id)); 
			}
			if (ind_txn_cnt >= 0) {
				PutField_Int(myHash,"v_txn_cnt",(int)v_txn_cnt);
				DEBUGLOG(("GetGeneratedPayout v_txn_cnt = [%d]\n",v_txn_cnt)); 
			}
			if (ind_txn_amt >= 0) {
				PutField_Double(myHash,"v_txn_amt",(double)v_txn_amt);
				DEBUGLOG(("GetGeneratedPayout v_txn_amt = [%f]\n",v_txn_amt)); 
			}			
			RecordSet_Add(myRec,myHash);
		}
		while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_GetGeneratedPayout;

	DEBUGLOG(("GetGeneratedPayout Normal Exit\n")); 
	return  PD_OK;

GetGeneratedPayout_error:
	DEBUGLOG(("GetGeneratedPayout_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_GetGeneratedPayout;
	return PD_ERR;
}

int GetVoidApprovedPayout(recordset_t* myRec, const char* csTxnDate, const char* csCountry, const char* csProduct)
{
	hash_t *myHash;
	EXEC SQL WHENEVER SQLERROR GOTO GetVoidApprovedPayout_error;
    EXEC SQL WHENEVER NOTFOUND CONTINUE;		
	
	EXEC SQL BEGIN DECLARE SECTION;		
		varchar	v_cr_txn_date[PD_DATE_LEN + 1];
		short	ind_cr_txn_date = -1;
		
		varchar	v_country[PD_COUNTRY_CODE_LEN + 1];
		short	ind_country = -1;
		
		varchar	v_product[PD_PRODUCT_CODE_LEN + 1];
		short	ind_product = -1;
		
		varchar	v_party_type[PD_PARTY_TYPE_LEN + 1];
		short	ind_party_type = -1;
		
		varchar	v_party_id[PD_PARTY_ID_LEN + 1];
		short	ind_party_id = -1;	
		
		varchar	v_currency[PD_CURRENCY_ID_LEN + 1];
		short	ind_currency = -1;	
		
		int		v_jnl_type_id;
		short	ind_jnl_type_id = -1;	
		
		varchar	v_jnl_entry_type_id[PD_JNL_ENTRY_TYPE_LEN + 1];
		short	ind_jnl_entry_type_id = -1;	
		
		varchar	v_cr_ind[PD_CR_IND_LEN + 1];
		short	ind_cr_ind = -1;	
		
		int		v_gl_id;
		short	ind_gl_id = -1;
		
		int		v_txn_cnt;
		short	ind_txn_cnt = -1;	
		
		double	v_txn_amt;
		short	ind_txn_amt = -1;			
	EXEC SQL END DECLARE SECTION;

	v_cr_txn_date.len = strlen(csTxnDate);
	memcpy(v_cr_txn_date.arr,csTxnDate,v_cr_txn_date.len);
	ind_cr_txn_date = 0;

	v_country.len = strlen(csCountry);
	memcpy(v_country.arr,csCountry,v_country.len);
	ind_country = 0;
	
	v_product.len = strlen(csProduct);
	memcpy(v_product.arr,csProduct,v_product.len);
	ind_product = 0;	

	DEBUGLOG(("GetVoidApprovedPayout csTxnDate = [%s]\n",csTxnDate));
	DEBUGLOG(("GetVoidApprovedPayout csCountry = [%s]\n",csCountry));
	DEBUGLOG(("GetVoidApprovedPayout csProduct = [%s]\n",csProduct));
	
	EXEC SQL DECLARE c_cursor_GetVoidApprovedPayout CURSOR FOR
		select cr_txn_date, cr_country, cr_product, te_party_type, party_id, cr_currency, cr_jnl_type_id,
		cr_jnl_entry_type_id, cr_ind, cr_gl_id, txn_count, cr_amount
		from CRR_VOD_APL_PAYOUT_VIEW
		where cr_txn_date = :v_cr_txn_date:ind_cr_txn_date and cr_country = :v_country:ind_country and cr_product = :v_product:ind_product;

	EXEC SQL OPEN c_cursor_GetVoidApprovedPayout;
        do {    
        	EXEC SQL FETCH c_cursor_GetVoidApprovedPayout
              	INTO
			:v_cr_txn_date:ind_cr_txn_date,
			:v_country:ind_country,
			:v_product:ind_product,
			:v_party_type:ind_party_type,
			:v_party_id:ind_party_id,
			:v_currency:ind_currency,
			:v_jnl_type_id:ind_jnl_type_id,
			:v_jnl_entry_type_id:ind_jnl_entry_type_id,
			:v_cr_ind:ind_cr_ind,
			:v_gl_id:ind_gl_id,
			:v_txn_cnt:ind_txn_cnt,
			:v_txn_amt:ind_txn_amt;

			if (SQLCODE == SQL_NOT_FOUND) { 
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			if (ind_cr_txn_date >= 0) {
				v_cr_txn_date.arr[v_cr_txn_date.len] ='\0';
				PutField_CString(myHash,"v_cr_txn_date",(const char*)v_cr_txn_date.arr);
				DEBUGLOG(("GetVoidApprovedPayout v_cr_txn_date = [%s]\n",v_cr_txn_date.arr)); 
			}
			if (ind_country >= 0) {
				v_country.arr[v_country.len] ='\0';
				PutField_CString(myHash,"v_country",(const char*)v_country.arr);
				DEBUGLOG(("GetVoidApprovedPayout v_country = [%s]\n",v_country.arr)); 
			}
			if (ind_product >= 0) {
				v_product.arr[v_product.len] ='\0';
				PutField_CString(myHash,"v_product",(const char*)v_product.arr);
				DEBUGLOG(("GetVoidApprovedPayout v_product = [%s]\n",v_product.arr)); 
			}
			if (ind_party_type >= 0) {
				v_party_type.arr[v_party_type.len] ='\0';
				PutField_CString(myHash,"v_party_type",(const char*)v_party_type.arr);
				DEBUGLOG(("GetVoidApprovedPayout v_party_type = [%s]\n",v_party_type.arr)); 
			}
			if (ind_party_id >= 0) {
				v_party_id.arr[v_party_id.len] ='\0';
				PutField_CString(myHash,"v_party_id",(const char*)v_party_id.arr);
				DEBUGLOG(("GetVoidApprovedPayout v_party_id = [%s]\n",v_party_id.arr)); 
			}		
			if (ind_currency >= 0) {
				v_currency.arr[v_currency.len] ='\0';
				PutField_CString(myHash,"v_currency",(const char*)v_currency.arr);
				DEBUGLOG(("GetVoidApprovedPayout v_currency = [%s]\n",v_currency.arr)); 
			}
			if (ind_jnl_type_id >= 0) {
				PutField_Int(myHash,"v_jnl_type_id",(int)v_jnl_type_id);
				DEBUGLOG(("GetVoidApprovedPayout v_jnl_type_id = [%d]\n",v_jnl_type_id)); 
			}
			if (ind_jnl_entry_type_id >= 0) {
				v_jnl_entry_type_id.arr[v_jnl_entry_type_id.len] ='\0';
				PutField_CString(myHash,"v_jnl_entry_type_id",(const char*)v_jnl_entry_type_id.arr);
				DEBUGLOG(("GetVoidApprovedPayout v_jnl_entry_type_id = [%s]\n",v_jnl_entry_type_id.arr)); 
			}	
			if (ind_cr_ind >= 0) {
				v_cr_ind.arr[v_cr_ind.len] ='\0';
				PutField_CString(myHash,"v_cr_ind",(const char*)v_cr_ind.arr);
				DEBUGLOG(("GetVoidApprovedPayout v_cr_ind = [%s]\n",v_cr_ind.arr)); 
			}
			if (ind_gl_id >= 0) {
				PutField_Int(myHash,"v_gl_id",(int)v_gl_id);
				DEBUGLOG(("GetVoidApprovedPayout v_gl_id = [%d]\n",v_gl_id)); 
			}
			if (ind_txn_cnt >= 0) {
				PutField_Int(myHash,"v_txn_cnt",(int)v_txn_cnt);
				DEBUGLOG(("GetVoidApprovedPayout v_txn_cnt = [%d]\n",v_txn_cnt)); 
			}
			if (ind_txn_amt >= 0) {
				PutField_Double(myHash,"v_txn_amt",(double)v_txn_amt);
				DEBUGLOG(("GetVoidApprovedPayout v_txn_amt = [%f]\n",v_txn_amt)); 
			}			
			RecordSet_Add(myRec,myHash);
		}
		while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_GetVoidApprovedPayout;

	DEBUGLOG(("GetVoidApprovedPayout Normal Exit\n")); 
	return  PD_OK;

GetVoidApprovedPayout_error:
	DEBUGLOG(("GetVoidApprovedPayout_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_GetVoidApprovedPayout;
	return PD_ERR;
}

int GetVoidGenPayout(recordset_t* myRec, const char* csTxnDate, const char* csCountry, const char* csProduct)
{
	hash_t *myHash;
	EXEC SQL WHENEVER SQLERROR GOTO GetVoidGenPayout_error;
    EXEC SQL WHENEVER NOTFOUND CONTINUE;		
	
	EXEC SQL BEGIN DECLARE SECTION;		
		varchar	v_cr_txn_date[PD_DATE_LEN + 1];
		short	ind_cr_txn_date = -1;
		
		varchar	v_country[PD_COUNTRY_CODE_LEN + 1];
		short	ind_country = -1;
		
		varchar	v_product[PD_PRODUCT_CODE_LEN + 1];
		short	ind_product = -1;
		
		varchar	v_party_type[PD_PARTY_TYPE_LEN + 1];
		short	ind_party_type = -1;
		
		varchar	v_party_id[PD_PARTY_ID_LEN + 1];
		short	ind_party_id = -1;	
		
		varchar	v_currency[PD_CURRENCY_ID_LEN + 1];
		short	ind_currency = -1;	
		
		int		v_jnl_type_id;
		short	ind_jnl_type_id = -1;	
		
		varchar	v_jnl_entry_type_id[PD_JNL_ENTRY_TYPE_LEN + 1];
		short	ind_jnl_entry_type_id = -1;	
		
		varchar	v_cr_ind[PD_CR_IND_LEN + 1];
		short	ind_cr_ind = -1;	
		
		int		v_gl_id;
		short	ind_gl_id = -1;
		
		int		v_txn_cnt;
		short	ind_txn_cnt = -1;	
		
		double	v_txn_amt;
		short	ind_txn_amt = -1;			
	EXEC SQL END DECLARE SECTION;

	v_cr_txn_date.len = strlen(csTxnDate);
	memcpy(v_cr_txn_date.arr,csTxnDate,v_cr_txn_date.len);
	ind_cr_txn_date = 0;

	v_country.len = strlen(csCountry);
	memcpy(v_country.arr,csCountry,v_country.len);
	ind_country = 0;
	
	v_product.len = strlen(csProduct);
	memcpy(v_product.arr,csProduct,v_product.len);
	ind_product = 0;	

	DEBUGLOG(("GetVoidGenPayout csTxnDate = [%s]\n",csTxnDate));
	DEBUGLOG(("GetVoidGenPayout csCountry = [%s]\n",csCountry));
	DEBUGLOG(("GetVoidGenPayout csProduct = [%s]\n",csProduct));
	
	EXEC SQL DECLARE c_cursor_GetVoidGenPayout CURSOR FOR
		select cr_txn_date, cr_country, cr_product, te_party_type, party_id, cr_currency, cr_jnl_type_id,
		cr_jnl_entry_type_id, cr_ind, cr_gl_id, txn_count, cr_amount
		from CRR_VOD_GEN_PAYOUT_VIEW
		where cr_txn_date = :v_cr_txn_date:ind_cr_txn_date and cr_country = :v_country:ind_country and cr_product = :v_product:ind_product;

	EXEC SQL OPEN c_cursor_GetVoidGenPayout;
        do {    
        	EXEC SQL FETCH c_cursor_GetVoidGenPayout
              	INTO
			:v_cr_txn_date:ind_cr_txn_date,
			:v_country:ind_country,
			:v_product:ind_product,
			:v_party_type:ind_party_type,
			:v_party_id:ind_party_id,
			:v_currency:ind_currency,
			:v_jnl_type_id:ind_jnl_type_id,
			:v_jnl_entry_type_id:ind_jnl_entry_type_id,
			:v_cr_ind:ind_cr_ind,
			:v_gl_id:ind_gl_id,
			:v_txn_cnt:ind_txn_cnt,
			:v_txn_amt:ind_txn_amt;

			if (SQLCODE == SQL_NOT_FOUND) { 
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			if (ind_cr_txn_date >= 0) {
				v_cr_txn_date.arr[v_cr_txn_date.len] ='\0';
				PutField_CString(myHash,"v_cr_txn_date",(const char*)v_cr_txn_date.arr);
				DEBUGLOG(("GetVoidGenPayout v_cr_txn_date = [%s]\n",v_cr_txn_date.arr)); 
			}
			if (ind_country >= 0) {
				v_country.arr[v_country.len] ='\0';
				PutField_CString(myHash,"v_country",(const char*)v_country.arr);
				DEBUGLOG(("GetVoidGenPayout v_country = [%s]\n",v_country.arr)); 
			}
			if (ind_product >= 0) {
				v_product.arr[v_product.len] ='\0';
				PutField_CString(myHash,"v_product",(const char*)v_product.arr);
				DEBUGLOG(("GetVoidGenPayout v_product = [%s]\n",v_product.arr)); 
			}
			if (ind_party_type >= 0) {
				v_party_type.arr[v_party_type.len] ='\0';
				PutField_CString(myHash,"v_party_type",(const char*)v_party_type.arr);
				DEBUGLOG(("GetVoidGenPayout v_party_type = [%s]\n",v_party_type.arr)); 
			}
			if (ind_party_id >= 0) {
				v_party_id.arr[v_party_id.len] ='\0';
				PutField_CString(myHash,"v_party_id",(const char*)v_party_id.arr);
				DEBUGLOG(("GetVoidGenPayout v_party_id = [%s]\n",v_party_id.arr)); 
			}		
			if (ind_currency >= 0) {
				v_currency.arr[v_currency.len] ='\0';
				PutField_CString(myHash,"v_currency",(const char*)v_currency.arr);
				DEBUGLOG(("GetVoidGenPayout v_currency = [%s]\n",v_currency.arr)); 
			}
			if (ind_jnl_type_id >= 0) {
				PutField_Int(myHash,"v_jnl_type_id",(int)v_jnl_type_id);
				DEBUGLOG(("GetVoidGenPayout v_jnl_type_id = [%d]\n",v_jnl_type_id)); 
			}
			if (ind_jnl_entry_type_id >= 0) {
				v_jnl_entry_type_id.arr[v_jnl_entry_type_id.len] ='\0';
				PutField_CString(myHash,"v_jnl_entry_type_id",(const char*)v_jnl_entry_type_id.arr);
				DEBUGLOG(("GetVoidGenPayout v_jnl_entry_type_id = [%s]\n",v_jnl_entry_type_id.arr)); 
			}	
			if (ind_cr_ind >= 0) {
				v_cr_ind.arr[v_cr_ind.len] ='\0';
				PutField_CString(myHash,"v_cr_ind",(const char*)v_cr_ind.arr);
				DEBUGLOG(("GetVoidGenPayout v_cr_ind = [%s]\n",v_cr_ind.arr)); 
			}
			if (ind_gl_id >= 0) {
				PutField_Int(myHash,"v_gl_id",(int)v_gl_id);
				DEBUGLOG(("GetVoidGenPayout v_gl_id = [%d]\n",v_gl_id)); 
			}
			if (ind_txn_cnt >= 0) {
				PutField_Int(myHash,"v_txn_cnt",(int)v_txn_cnt);
				DEBUGLOG(("GetVoidGenPayout v_txn_cnt = [%d]\n",v_txn_cnt)); 
			}
			if (ind_txn_amt >= 0) {
				PutField_Double(myHash,"v_txn_amt",(double)v_txn_amt);
				DEBUGLOG(("GetVoidGenPayout v_txn_amt = [%f]\n",v_txn_amt)); 
			}			
			RecordSet_Add(myRec,myHash);
		}
		while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_GetVoidGenPayout;

	DEBUGLOG(("GetVoidGenPayout Normal Exit\n")); 
	return  PD_OK;

GetVoidGenPayout_error:
	DEBUGLOG(("GetVoidGenPayout_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_GetVoidGenPayout;
	return PD_ERR;
}

int GetDeliveredMst(recordset_t* myRec, const char* csTxnDate, const char* csCountry, const char* csProduct)
{
	hash_t *myHash;
	EXEC SQL WHENEVER SQLERROR GOTO GetDeliveredMst_error;
    EXEC SQL WHENEVER NOTFOUND CONTINUE;		
	
	EXEC SQL BEGIN DECLARE SECTION;	
		varchar	v_th_txn_id[PD_TXN_SEQ_LEN + 1];
		short	ind_th_txn_id = -1;

		varchar	v_cr_txn_date[PD_DATE_LEN + 1];
		short	ind_cr_txn_date = -1;
		
		varchar	v_country[PD_COUNTRY_CODE_LEN + 1];
		short	ind_country = -1;
		
		varchar	v_product[PD_PRODUCT_CODE_LEN + 1];
		short	ind_product = -1;
		
		varchar	v_party_type[PD_PARTY_TYPE_LEN + 1];
		short	ind_party_type = -1;
		
		varchar	v_party_id[PD_PARTY_ID_LEN + 1];
		short	ind_party_id = -1;	
		
		varchar	v_currency[PD_CURRENCY_ID_LEN + 1];
		short	ind_currency = -1;	
		
		int		v_jnl_type_id;
		short	ind_jnl_type_id = -1;	
		
		varchar	v_jnl_entry_type_id[PD_JNL_ENTRY_TYPE_LEN + 1];
		short	ind_jnl_entry_type_id = -1;	
		
		varchar	v_cr_ind[PD_CR_IND_LEN + 1];
		short	ind_cr_ind = -1;	
		
		int		v_gl_id;
		short	ind_gl_id = -1;
		
		int		v_txn_cnt;
		short	ind_txn_cnt = -1;	
		
		double	v_txn_amt;
		short	ind_txn_amt = -1;			
	EXEC SQL END DECLARE SECTION;

	v_cr_txn_date.len = strlen(csTxnDate);
	memcpy(v_cr_txn_date.arr,csTxnDate,v_cr_txn_date.len);
	ind_cr_txn_date = 0;

	v_country.len = strlen(csCountry);
	memcpy(v_country.arr,csCountry,v_country.len);
	ind_country = 0;
	
	v_product.len = strlen(csProduct);
	memcpy(v_product.arr,csProduct,v_product.len);
	ind_product = 0;	

	DEBUGLOG(("GetDeliveredMst csTxnDate = [%s]\n",csTxnDate));
	DEBUGLOG(("GetDeliveredMst csCountry = [%s]\n",csCountry));
	DEBUGLOG(("GetDeliveredMst csProduct = [%s]\n",csProduct));
	
	EXEC SQL DECLARE c_cursor_GetDeliveredMst CURSOR FOR
		select th_txn_id, cr_txn_date, cr_country, cr_product, te_party_type, party_id, cr_currency, cr_jnl_type_id,
		cr_jnl_entry_type_id, cr_ind, cr_gl_id, txn_count, cr_amount
		from CRR_DEL_SETTLE_VIEW
		where cr_txn_date = :v_cr_txn_date:ind_cr_txn_date and cr_country = :v_country:ind_country and cr_product = :v_product:ind_product
		order by th_txn_id;

	EXEC SQL OPEN c_cursor_GetDeliveredMst;
        do {    
        	EXEC SQL FETCH c_cursor_GetDeliveredMst
              	INTO			
			:v_th_txn_id:ind_th_txn_id,
			:v_cr_txn_date:ind_cr_txn_date,
			:v_country:ind_country,
			:v_product:ind_product,
			:v_party_type:ind_party_type,
			:v_party_id:ind_party_id,
			:v_currency:ind_currency,
			:v_jnl_type_id:ind_jnl_type_id,
			:v_jnl_entry_type_id:ind_jnl_entry_type_id,
			:v_cr_ind:ind_cr_ind,
			:v_gl_id:ind_gl_id,
			:v_txn_cnt:ind_txn_cnt,
			:v_txn_amt:ind_txn_amt;

			if (SQLCODE == SQL_NOT_FOUND) { 
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			if (ind_th_txn_id >= 0) {
				v_th_txn_id.arr[v_th_txn_id.len] ='\0';
				PutField_CString(myHash,"v_th_txn_id",(const char*)v_th_txn_id.arr);
				DEBUGLOG(("GetDeliveredMst v_th_txn_id = [%s]\n",v_th_txn_id.arr)); 
			}
			if (ind_cr_txn_date >= 0) {
				v_cr_txn_date.arr[v_cr_txn_date.len] ='\0';
				PutField_CString(myHash,"v_cr_txn_date",(const char*)v_cr_txn_date.arr);
				DEBUGLOG(("GetDeliveredMst v_cr_txn_date = [%s]\n",v_cr_txn_date.arr)); 
			}
			if (ind_country >= 0) {
				v_country.arr[v_country.len] ='\0';
				PutField_CString(myHash,"v_country",(const char*)v_country.arr);
				DEBUGLOG(("GetDeliveredMst v_country = [%s]\n",v_country.arr)); 
			}
			if (ind_product >= 0) {
				v_product.arr[v_product.len] ='\0';
				PutField_CString(myHash,"v_product",(const char*)v_product.arr);
				DEBUGLOG(("GetDeliveredMst v_product = [%s]\n",v_product.arr)); 
			}
			if (ind_party_type >= 0) {
				v_party_type.arr[v_party_type.len] ='\0';
				PutField_CString(myHash,"v_party_type",(const char*)v_party_type.arr);
				DEBUGLOG(("GetDeliveredMst v_party_type = [%s]\n",v_party_type.arr)); 
			}
			if (ind_party_id >= 0) {
				v_party_id.arr[v_party_id.len] ='\0';
				PutField_CString(myHash,"v_party_id",(const char*)v_party_id.arr);
				DEBUGLOG(("GetDeliveredMst v_party_id = [%s]\n",v_party_id.arr)); 
			}		
			if (ind_currency >= 0) {
				v_currency.arr[v_currency.len] ='\0';
				PutField_CString(myHash,"v_currency",(const char*)v_currency.arr);
				DEBUGLOG(("GetDeliveredMst v_currency = [%s]\n",v_currency.arr)); 
			}
			if (ind_jnl_type_id >= 0) {
				PutField_Int(myHash,"v_jnl_type_id",(int)v_jnl_type_id);
				DEBUGLOG(("GetDeliveredMst v_jnl_type_id = [%d]\n",v_jnl_type_id)); 
			}
			if (ind_jnl_entry_type_id >= 0) {
				v_jnl_entry_type_id.arr[v_jnl_entry_type_id.len] ='\0';
				PutField_CString(myHash,"v_jnl_entry_type_id",(const char*)v_jnl_entry_type_id.arr);
				DEBUGLOG(("GetDeliveredMst v_jnl_entry_type_id = [%s]\n",v_jnl_entry_type_id.arr)); 
			}	
			if (ind_cr_ind >= 0) {
				v_cr_ind.arr[v_cr_ind.len] ='\0';
				PutField_CString(myHash,"v_cr_ind",(const char*)v_cr_ind.arr);
				DEBUGLOG(("GetDeliveredMst v_cr_ind = [%s]\n",v_cr_ind.arr)); 
			}
			if (ind_gl_id >= 0) {
				PutField_Int(myHash,"v_gl_id",(int)v_gl_id);
				DEBUGLOG(("GetDeliveredMst v_gl_id = [%d]\n",v_gl_id)); 
			}
			if (ind_txn_cnt >= 0) {
				PutField_Int(myHash,"v_txn_cnt",(int)v_txn_cnt);
				DEBUGLOG(("GetDeliveredMst v_txn_cnt = [%d]\n",v_txn_cnt)); 
			}
			if (ind_txn_amt >= 0) {
				PutField_Double(myHash,"v_txn_amt",(double)v_txn_amt);
				DEBUGLOG(("GetDeliveredMst v_txn_amt = [%f]\n",v_txn_amt)); 
			}			
			RecordSet_Add(myRec,myHash);
		}
		while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_GetDeliveredMst;

	DEBUGLOG(("GetDeliveredMst Normal Exit\n")); 
	return  PD_OK;

GetDeliveredMst_error:
	DEBUGLOG(("GetDeliveredMst_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_GetDeliveredMst;
	return PD_ERR;
}

int GetVoidMst(recordset_t* myRec, const char* csTxnDate, const char* csCountry, const char* csProduct)
{
	hash_t *myHash;
	EXEC SQL WHENEVER SQLERROR GOTO GetVoidMst_error;
    EXEC SQL WHENEVER NOTFOUND CONTINUE;		
	
	EXEC SQL BEGIN DECLARE SECTION;	
		varchar	v_th_txn_id[PD_TXN_SEQ_LEN + 1];
		short	ind_th_txn_id = -1;

		varchar	v_cr_txn_date[PD_DATE_LEN + 1];
		short	ind_cr_txn_date = -1;
		
		varchar	v_country[PD_COUNTRY_CODE_LEN + 1];
		short	ind_country = -1;
		
		varchar	v_product[PD_PRODUCT_CODE_LEN + 1];
		short	ind_product = -1;
		
		varchar	v_party_type[PD_PARTY_TYPE_LEN + 1];
		short	ind_party_type = -1;
		
		varchar	v_party_id[PD_PARTY_ID_LEN + 1];
		short	ind_party_id = -1;	
		
		varchar	v_currency[PD_CURRENCY_ID_LEN + 1];
		short	ind_currency = -1;	
		
		int		v_jnl_type_id;
		short	ind_jnl_type_id = -1;	
		
		varchar	v_jnl_entry_type_id[PD_JNL_ENTRY_TYPE_LEN + 1];
		short	ind_jnl_entry_type_id = -1;	
		
		varchar	v_cr_ind[PD_CR_IND_LEN + 1];
		short	ind_cr_ind = -1;	
		
		int		v_gl_id;
		short	ind_gl_id = -1;
		
		int		v_txn_cnt;
		short	ind_txn_cnt = -1;	
		
		double	v_txn_amt;
		short	ind_txn_amt = -1;			
	EXEC SQL END DECLARE SECTION;

	v_cr_txn_date.len = strlen(csTxnDate);
	memcpy(v_cr_txn_date.arr,csTxnDate,v_cr_txn_date.len);
	ind_cr_txn_date = 0;

	v_country.len = strlen(csCountry);
	memcpy(v_country.arr,csCountry,v_country.len);
	ind_country = 0;
	
	v_product.len = strlen(csProduct);
	memcpy(v_product.arr,csProduct,v_product.len);
	ind_product = 0;	

	DEBUGLOG(("GetVoidMst csTxnDate = [%s]\n",csTxnDate));
	DEBUGLOG(("GetVoidMst csCountry = [%s]\n",csCountry));
	DEBUGLOG(("GetVoidMst csProduct = [%s]\n",csProduct));
	
	EXEC SQL DECLARE c_cursor_GetVoidMst CURSOR FOR
		select th_txn_id, cr_txn_date, cr_country, cr_product, te_party_type, party_id, cr_currency, cr_jnl_type_id,
		cr_jnl_entry_type_id, cr_ind, cr_gl_id, txn_count, cr_amount
		from CRR_VOD_SETTLE_VIEW
		where cr_txn_date = :v_cr_txn_date:ind_cr_txn_date and cr_country = :v_country:ind_country and cr_product = :v_product:ind_product
		order by th_txn_id;

	EXEC SQL OPEN c_cursor_GetVoidMst;
        do {    
        	EXEC SQL FETCH c_cursor_GetVoidMst
              	INTO			
			:v_th_txn_id:ind_th_txn_id,
			:v_cr_txn_date:ind_cr_txn_date,
			:v_country:ind_country,
			:v_product:ind_product,
			:v_party_type:ind_party_type,
			:v_party_id:ind_party_id,
			:v_currency:ind_currency,
			:v_jnl_type_id:ind_jnl_type_id,
			:v_jnl_entry_type_id:ind_jnl_entry_type_id,
			:v_cr_ind:ind_cr_ind,
			:v_gl_id:ind_gl_id,
			:v_txn_cnt:ind_txn_cnt,
			:v_txn_amt:ind_txn_amt;

			if (SQLCODE == SQL_NOT_FOUND) { 
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			if (ind_th_txn_id >= 0) {
				v_th_txn_id.arr[v_th_txn_id.len] ='\0';
				PutField_CString(myHash,"v_th_txn_id",(const char*)v_th_txn_id.arr);
				DEBUGLOG(("GetVoidMst v_th_txn_id = [%s]\n",v_th_txn_id.arr)); 
			}
			if (ind_cr_txn_date >= 0) {
				v_cr_txn_date.arr[v_cr_txn_date.len] ='\0';
				PutField_CString(myHash,"v_cr_txn_date",(const char*)v_cr_txn_date.arr);
				DEBUGLOG(("GetVoidMst v_cr_txn_date = [%s]\n",v_cr_txn_date.arr)); 
			}
			if (ind_country >= 0) {
				v_country.arr[v_country.len] ='\0';
				PutField_CString(myHash,"v_country",(const char*)v_country.arr);
				DEBUGLOG(("GetVoidMst v_country = [%s]\n",v_country.arr)); 
			}
			if (ind_product >= 0) {
				v_product.arr[v_product.len] ='\0';
				PutField_CString(myHash,"v_product",(const char*)v_product.arr);
				DEBUGLOG(("GetVoidMst v_product = [%s]\n",v_product.arr)); 
			}
			if (ind_party_type >= 0) {
				v_party_type.arr[v_party_type.len] ='\0';
				PutField_CString(myHash,"v_party_type",(const char*)v_party_type.arr);
				DEBUGLOG(("GetVoidMst v_party_type = [%s]\n",v_party_type.arr)); 
			}
			if (ind_party_id >= 0) {
				v_party_id.arr[v_party_id.len] ='\0';
				PutField_CString(myHash,"v_party_id",(const char*)v_party_id.arr);
				DEBUGLOG(("GetVoidMst v_party_id = [%s]\n",v_party_id.arr)); 
			}		
			if (ind_currency >= 0) {
				v_currency.arr[v_currency.len] ='\0';
				PutField_CString(myHash,"v_currency",(const char*)v_currency.arr);
				DEBUGLOG(("GetVoidMst v_currency = [%s]\n",v_currency.arr)); 
			}
			if (ind_jnl_type_id >= 0) {
				PutField_Int(myHash,"v_jnl_type_id",(int)v_jnl_type_id);
				DEBUGLOG(("GetVoidMst v_jnl_type_id = [%d]\n",v_jnl_type_id)); 
			}
			if (ind_jnl_entry_type_id >= 0) {
				v_jnl_entry_type_id.arr[v_jnl_entry_type_id.len] ='\0';
				PutField_CString(myHash,"v_jnl_entry_type_id",(const char*)v_jnl_entry_type_id.arr);
				DEBUGLOG(("GetVoidMst v_jnl_entry_type_id = [%s]\n",v_jnl_entry_type_id.arr)); 
			}	
			if (ind_cr_ind >= 0) {
				v_cr_ind.arr[v_cr_ind.len] ='\0';
				PutField_CString(myHash,"v_cr_ind",(const char*)v_cr_ind.arr);
				DEBUGLOG(("GetVoidMst v_cr_ind = [%s]\n",v_cr_ind.arr)); 
			}
			if (ind_gl_id >= 0) {
				PutField_Int(myHash,"v_gl_id",(int)v_gl_id);
				DEBUGLOG(("GetVoidMst v_gl_id = [%d]\n",v_gl_id)); 
			}
			if (ind_txn_cnt >= 0) {
				PutField_Int(myHash,"v_txn_cnt",(int)v_txn_cnt);
				DEBUGLOG(("GetVoidMst v_txn_cnt = [%d]\n",v_txn_cnt)); 
			}
			if (ind_txn_amt >= 0) {
				PutField_Double(myHash,"v_txn_amt",(double)v_txn_amt);
				DEBUGLOG(("GetVoidMst v_txn_amt = [%f]\n",v_txn_amt)); 
			}			
			RecordSet_Add(myRec,myHash);
		}
		while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_GetVoidMst;

	DEBUGLOG(("GetVoidMst Normal Exit\n")); 
	return  PD_OK;

GetVoidMst_error:
	DEBUGLOG(("GetVoidMst_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_GetVoidMst;
	return PD_ERR;
}

int GetApprovedMbt(recordset_t* myRec, const char* csTxnDate, const char* csCountry, const char* csProduct)
{
	hash_t *myHash;
	EXEC SQL WHENEVER SQLERROR GOTO GetApprovedMbt_error;
    EXEC SQL WHENEVER NOTFOUND CONTINUE;		
	
	EXEC SQL BEGIN DECLARE SECTION;	
		varchar	v_th_txn_id[PD_TXN_SEQ_LEN + 1];
		short	ind_th_txn_id = -1;

		varchar	v_cr_txn_date[PD_DATE_LEN + 1];
		short	ind_cr_txn_date = -1;
		
		varchar	v_country[PD_COUNTRY_CODE_LEN + 1];
		short	ind_country = -1;
		
		varchar	v_product[PD_PRODUCT_CODE_LEN + 1];
		short	ind_product = -1;
		
		varchar	v_party_type[PD_PARTY_TYPE_LEN + 1];
		short	ind_party_type = -1;
		
		varchar	v_party_id[PD_PARTY_ID_LEN + 1];
		short	ind_party_id = -1;	
		
		varchar	v_currency[PD_CURRENCY_ID_LEN + 1];
		short	ind_currency = -1;	
		
		int		v_jnl_type_id;
		short	ind_jnl_type_id = -1;	
		
		varchar	v_jnl_entry_type_id[PD_JNL_ENTRY_TYPE_LEN + 1];
		short	ind_jnl_entry_type_id = -1;	
		
		varchar	v_cr_ind[PD_CR_IND_LEN + 1];
		short	ind_cr_ind = -1;	
		
		int		v_gl_id;
		short	ind_gl_id = -1;
		
		int		v_txn_cnt;
		short	ind_txn_cnt = -1;	
		
		double	v_txn_amt;
		short	ind_txn_amt = -1;			
	EXEC SQL END DECLARE SECTION;

	v_cr_txn_date.len = strlen(csTxnDate);
	memcpy(v_cr_txn_date.arr,csTxnDate,v_cr_txn_date.len);
	ind_cr_txn_date = 0;

	v_country.len = strlen(csCountry);
	memcpy(v_country.arr,csCountry,v_country.len);
	ind_country = 0;
	
	v_product.len = strlen(csProduct);
	memcpy(v_product.arr,csProduct,v_product.len);
	ind_product = 0;	

	DEBUGLOG(("GetApprovedMbt csTxnDate = [%s]\n",csTxnDate));
	DEBUGLOG(("GetApprovedMbt csCountry = [%s]\n",csCountry));
	DEBUGLOG(("GetApprovedMbt csProduct = [%s]\n",csProduct));
	
	EXEC SQL DECLARE c_cursor_GetApprovedMbt CURSOR FOR
		select th_txn_id, cr_txn_date, cr_country, cr_product, te_party_type, party_id, cr_currency, cr_jnl_type_id,
		cr_jnl_entry_type_id, cr_ind, cr_gl_id, txn_count, cr_amount
		from CRR_APL_MBT_VIEW
		where cr_txn_date = :v_cr_txn_date:ind_cr_txn_date and cr_country = :v_country:ind_country and cr_product = :v_product:ind_product
		order by th_txn_id;
		
	EXEC SQL OPEN c_cursor_GetApprovedMbt;
        do {    
        	EXEC SQL FETCH c_cursor_GetApprovedMbt
              	INTO			
			:v_th_txn_id:ind_th_txn_id,
			:v_cr_txn_date:ind_cr_txn_date,
			:v_country:ind_country,
			:v_product:ind_product,
			:v_party_type:ind_party_type,
			:v_party_id:ind_party_id,
			:v_currency:ind_currency,
			:v_jnl_type_id:ind_jnl_type_id,
			:v_jnl_entry_type_id:ind_jnl_entry_type_id,
			:v_cr_ind:ind_cr_ind,
			:v_gl_id:ind_gl_id,
			:v_txn_cnt:ind_txn_cnt,
			:v_txn_amt:ind_txn_amt;

			if (SQLCODE == SQL_NOT_FOUND) { 
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			if (ind_th_txn_id >= 0) {
				v_th_txn_id.arr[v_th_txn_id.len] ='\0';
				PutField_CString(myHash,"v_th_txn_id",(const char*)v_th_txn_id.arr);
				DEBUGLOG(("GetApprovedMbt v_th_txn_id = [%s]\n",v_th_txn_id.arr)); 
			}
			if (ind_cr_txn_date >= 0) {
				v_cr_txn_date.arr[v_cr_txn_date.len] ='\0';
				PutField_CString(myHash,"v_cr_txn_date",(const char*)v_cr_txn_date.arr);
				DEBUGLOG(("GetApprovedMbt v_cr_txn_date = [%s]\n",v_cr_txn_date.arr)); 
			}
			if (ind_country >= 0) {
				v_country.arr[v_country.len] ='\0';
				PutField_CString(myHash,"v_country",(const char*)v_country.arr);
				DEBUGLOG(("GetApprovedMbt v_country = [%s]\n",v_country.arr)); 
			}
			if (ind_product >= 0) {
				v_product.arr[v_product.len] ='\0';
				PutField_CString(myHash,"v_product",(const char*)v_product.arr);
				DEBUGLOG(("GetApprovedMbt v_product = [%s]\n",v_product.arr)); 
			}
			if (ind_party_type >= 0) {
				v_party_type.arr[v_party_type.len] ='\0';
				PutField_CString(myHash,"v_party_type",(const char*)v_party_type.arr);
				DEBUGLOG(("GetApprovedMbt v_party_type = [%s]\n",v_party_type.arr)); 
			}
			if (ind_party_id >= 0) {
				v_party_id.arr[v_party_id.len] ='\0';
				PutField_CString(myHash,"v_party_id",(const char*)v_party_id.arr);
				DEBUGLOG(("GetApprovedMbt v_party_id = [%s]\n",v_party_id.arr)); 
			}		
			if (ind_currency >= 0) {
				v_currency.arr[v_currency.len] ='\0';
				PutField_CString(myHash,"v_currency",(const char*)v_currency.arr);
				DEBUGLOG(("GetApprovedMbt v_currency = [%s]\n",v_currency.arr)); 
			}
			if (ind_jnl_type_id >= 0) {
				PutField_Int(myHash,"v_jnl_type_id",(int)v_jnl_type_id);
				DEBUGLOG(("GetApprovedMbt v_jnl_type_id = [%d]\n",v_jnl_type_id)); 
			}
			if (ind_jnl_entry_type_id >= 0) {
				v_jnl_entry_type_id.arr[v_jnl_entry_type_id.len] ='\0';
				PutField_CString(myHash,"v_jnl_entry_type_id",(const char*)v_jnl_entry_type_id.arr);
				DEBUGLOG(("GetApprovedMbt v_jnl_entry_type_id = [%s]\n",v_jnl_entry_type_id.arr)); 
			}	
			if (ind_cr_ind >= 0) {
				v_cr_ind.arr[v_cr_ind.len] ='\0';
				PutField_CString(myHash,"v_cr_ind",(const char*)v_cr_ind.arr);
				DEBUGLOG(("GetApprovedMbt v_cr_ind = [%s]\n",v_cr_ind.arr)); 
			}
			if (ind_gl_id >= 0) {
				PutField_Int(myHash,"v_gl_id",(int)v_gl_id);
				DEBUGLOG(("GetApprovedMbt v_gl_id = [%d]\n",v_gl_id)); 
			}
			if (ind_txn_cnt >= 0) {
				PutField_Int(myHash,"v_txn_cnt",(int)v_txn_cnt);
				DEBUGLOG(("GetApprovedMbt v_txn_cnt = [%d]\n",v_txn_cnt)); 
			}
			if (ind_txn_amt >= 0) {
				PutField_Double(myHash,"v_txn_amt",(double)v_txn_amt);
				DEBUGLOG(("GetApprovedMbt v_txn_amt = [%f]\n",v_txn_amt)); 
			}			
			RecordSet_Add(myRec,myHash);
		}
		while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_GetApprovedMbt;

	DEBUGLOG(("GetApprovedMbt Normal Exit\n")); 
	return  PD_OK;

GetApprovedMbt_error:
	DEBUGLOG(("GetApprovedMbt_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_GetApprovedMbt;
	return PD_ERR;
}

int GetPostJnl(recordset_t* myRec, const char* csTxnDate, const char* csCountry, const char* csProduct, const char* csJnlType, const char cPostType)
{
	hash_t *myHash;
	
	char csPostType[PD_JNL_TYPE_POST_TYPE_LEN + 1];
	sprintf(csPostType,"%c",cPostType);
	
	EXEC SQL WHENEVER SQLERROR GOTO GetPostJnl_error;
    EXEC SQL WHENEVER NOTFOUND CONTINUE;		
	
	EXEC SQL BEGIN DECLARE SECTION;	
	varchar	v_jnl_id[PD_TXN_SEQ_LEN + 1];
	short	ind_jnl_id = -1;

	varchar	v_cr_txn_date[PD_DATE_LEN + 1];
	short	ind_cr_txn_date = -1;
	
	varchar	v_country[PD_COUNTRY_CODE_LEN + 1];
	short	ind_country = -1;
	
	varchar	v_product[PD_PRODUCT_CODE_LEN + 1];
	short	ind_product = -1;

	varchar	v_jnl_type[PD_JNL_TYPE_PREFIX_LEN + 1];
	short	ind_jnl_type = -1;

	varchar	v_post_type[PD_JNL_TYPE_POST_TYPE_LEN + 1];
	short	ind_post_type = -1;

	EXEC SQL END DECLARE SECTION;

	v_cr_txn_date.len = strlen(csTxnDate);
	memcpy(v_cr_txn_date.arr,csTxnDate,v_cr_txn_date.len);
	ind_cr_txn_date = 0;

	v_country.len = strlen(csCountry);
	memcpy(v_country.arr,csCountry,v_country.len);
	ind_country = 0;
	
	v_product.len = strlen(csProduct);
	memcpy(v_product.arr,csProduct,v_product.len);
	ind_product = 0;	
	
	v_jnl_type.len = strlen(csJnlType);
	memcpy(v_jnl_type.arr,csJnlType,v_jnl_type.len);
	ind_jnl_type = 0;	

	v_post_type.len = PD_JNL_TYPE_POST_TYPE_LEN;
	memcpy(v_post_type.arr,csPostType,v_post_type.len);
	ind_post_type = 0;	

	DEBUGLOG(("GetPostJnl csTxnDate = [%s], csCountry = [%s], csProduct = [%s], csJnlType = [%s], csPostType = [%]\n ",csTxnDate,csCountry,csProduct,csJnlType, csPostType));
	
	EXEC SQL DECLARE c_cursor_GetPostJnl CURSOR FOR
		select cjh.jnl_id
		from crr_jnl_header cjh, crr_jnl_type cjt
		where cjh.disabled = 0
		and cjt.disabled = 0
		and cjt.post_type = :v_post_type:ind_post_type
		and cjh.txn_date = :v_cr_txn_date:ind_cr_txn_date 
		and cjh.country_code = :v_country:ind_country 
		and cjh.product_code = :v_product:ind_product
		and cjt.prefix = :v_jnl_type:ind_jnl_type
		and cjh.jnl_type_id = cjt.jnl_type_id;	
	
	
	EXEC SQL OPEN c_cursor_GetPostJnl;
        do {    
        	EXEC SQL FETCH c_cursor_GetPostJnl
              	INTO			
			:v_jnl_id:ind_jnl_id;

			if (SQLCODE == SQL_NOT_FOUND) { 
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			if (ind_jnl_id >= 0) {
				v_jnl_id.arr[v_jnl_id.len] ='\0';
				PutField_CString(myHash,"v_jnl_id",(const char*)v_jnl_id.arr);
				DEBUGLOG(("GetPostJnl v_jnl_id = [%s]\n",v_jnl_id.arr)); 
			}
		
			RecordSet_Add(myRec,myHash);
		}
		while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_GetPostJnl;

	DEBUGLOG(("GetPostJnl Normal Exit\n")); 
	return  PD_OK;

GetPostJnl_error:
	DEBUGLOG(("GetPostJnl_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_GetPostJnl;
	return PD_ERR;
}

int GetAllPostJnl(recordset_t* myRec, const char* csTxnDate, const char* csCountry, const char* csProduct, const char cPostType)
{
	hash_t *myHash;
	char csPostType[PD_JNL_TYPE_POST_TYPE_LEN + 1];
	sprintf(csPostType,"%c",cPostType);

	EXEC SQL WHENEVER SQLERROR GOTO GetAllPostJnl_error;
    EXEC SQL WHENEVER NOTFOUND CONTINUE;		
	
	EXEC SQL BEGIN DECLARE SECTION;	
		varchar	v_jnl_id[PD_TXN_SEQ_LEN + 1];
		short	ind_jnl_id = -1;

		varchar	v_cr_txn_date[PD_DATE_LEN + 1];
		short	ind_cr_txn_date = -1;
		
		varchar	v_country[PD_COUNTRY_CODE_LEN + 1];
		short	ind_country = -1;
		
		varchar	v_product[PD_PRODUCT_CODE_LEN + 1];
		short	ind_product = -1;

		varchar	v_post_type[PD_JNL_TYPE_POST_TYPE_LEN + 1];
		short	ind_post_type = -1;

	EXEC SQL END DECLARE SECTION;

	v_cr_txn_date.len = strlen(csTxnDate);
	memcpy(v_cr_txn_date.arr,csTxnDate,v_cr_txn_date.len);
	ind_cr_txn_date = 0;

	v_country.len = strlen(csCountry);
	memcpy(v_country.arr,csCountry,v_country.len);
	ind_country = 0;
	
	v_product.len = strlen(csProduct);
	memcpy(v_product.arr,csProduct,v_product.len);
	ind_product = 0;	

	v_post_type.len = PD_JNL_TYPE_POST_TYPE_LEN;
	memcpy(v_post_type.arr,csPostType,v_post_type.len);
	ind_post_type = 0;	

	DEBUGLOG(("GetAllPostJnl csTxnDate = [%s], csCountry = [%s], csProduct = [%s], csPostType = [%s]\n ",csTxnDate,csCountry,csProduct,csPostType));
	
	EXEC SQL DECLARE c_cursor_GetAllPostJnl CURSOR FOR
		select cjh.jnl_id
		from crr_jnl_header cjh, crr_jnl_type cjt
		where cjh.disabled = 0
		and cjt.disabled = 0
		and cjt.post_type = :v_post_type:ind_post_type
		and cjh.txn_date = :v_cr_txn_date:ind_cr_txn_date 
		and cjh.country_code = :v_country:ind_country 
		and cjh.product_code = :v_product:ind_product
		and cjh.jnl_type_id = cjt.jnl_type_id;	
	
	
	EXEC SQL OPEN c_cursor_GetAllPostJnl;
        do {    
        	EXEC SQL FETCH c_cursor_GetAllPostJnl
              	INTO			
			:v_jnl_id:ind_jnl_id;

			if (SQLCODE == SQL_NOT_FOUND) { 
				break;
			}

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			if (ind_jnl_id >= 0) {
				v_jnl_id.arr[v_jnl_id.len] ='\0';
				PutField_CString(myHash,"v_jnl_id",(const char*)v_jnl_id.arr);
				DEBUGLOG(("GetAllPostJnl v_jnl_id = [%s]\n",v_jnl_id.arr)); 
			}
		
			RecordSet_Add(myRec,myHash);
		}
		while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_GetAllPostJnl;

	DEBUGLOG(("GetAllPostJnl Normal Exit\n")); 
	return  PD_OK;

GetAllPostJnl_error:
	DEBUGLOG(("GetAllPostJnl_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_GetAllPostJnl;
	return PD_ERR;
}

