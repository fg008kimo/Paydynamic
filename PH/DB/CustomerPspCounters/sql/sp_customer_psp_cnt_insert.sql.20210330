


CREATE OR REPLACE FUNCTION sp_customer_psp_cnt_insert (
    in_cust_id        customer_psp_counters.cpc_cust_id%TYPE,
    in_psp_id         customer_psp_counters.cpc_psp_id%TYPE,
    in_date           customer_psp_counters.cpc_date%TYPE,
    in_category       customer_psp_counters.cpc_category%TYPE,
    in_counter        customer_psp_counters.cpc_counter%TYPE,
    in_create_user    customer_psp_counters.cpc_create_user%TYPE)
    RETURN NUMBER
IS
BEGIN
    UPDATE customer_psp_counters
       SET cpc_counter = cpc_counter + in_counter,
           cpc_update_user = in_create_user,
           cpc_update_timestamp = SYSDATE
     WHERE     cpc_cust_id = in_cust_id
           AND cpc_psp_id = in_psp_id
           AND cpc_date = in_date
           AND cpc_category = in_category;

    IF SQL%ROWCOUNT = 0
    THEN
        INSERT INTO customer_psp_counters (cpc_cust_id,
                                           cpc_psp_id,
                                           cpc_date,
                                           cpc_category,
                                           cpc_counter,
                                           cpc_create_user,
                                           cpc_create_timestamp,
                                           cpc_update_user,
                                           cpc_update_timestamp)
             VALUES (in_cust_id,
                     in_psp_id,
                     in_date,
                     in_category,
                     in_counter,
                     in_create_user,
                     SYSDATE,
                     in_create_user,
                     SYSDATE);

        IF SQL%ROWCOUNT = 0
        THEN
            UPDATE customer_psp_counters
               SET cpc_counter = cpc_counter + in_counter,
                   cpc_update_user = in_create_user,
                   cpc_update_timestamp = SYSDATE
             WHERE     cpc_cust_id = in_cust_id
                   AND cpc_psp_id = in_psp_id
                   AND cpc_date = in_date
                   AND cpc_category = in_category;

            IF SQL%ROWCOUNT = 0
            THEN
                RETURN 1;
            END IF;
        END IF;
    END IF;

    RETURN 0;
EXCEPTION
    WHEN OTHERS
    THEN
        RETURN 9;
END sp_customer_psp_cnt_insert;
/

