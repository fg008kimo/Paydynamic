/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/09/15              Cody Chan
add psp_channel_code,psp_merchant_id		   2011/01/10		   Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "Psp.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;
void Psp(char    cdebug)
{
        cDebug = cdebug;
}



int GetCountryPsp(const char* csCountryCode,
		recordset_t* myRec)
{

        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO getcountrypsp_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_country_code[PD_COUNTRY_LEN];
		char		hv_type;

		varchar		v_client_id[PD_CLIENT_ID_LEN + 1];
		varchar		v_psp_id[PD_PSP_ID_LEN + 1];
		int		v_disabled;
		char		v_online_mode;
		varchar		v_psp_merchant_id[PD_MERCHANT_ID_LEN + 1];
		varchar		v_psp_channel_code[PD_CHANNEL_CODE_LEN + 1];

		short		ind_client_id = -1;
		short		ind_psp_id = -1;
		short		ind_disabled = -1;
		short		ind_online_mode = -1;
		short		ind_psp_merchant_id = -1;
		short		ind_psp_channel_code = -1;


        EXEC SQL END DECLARE SECTION;

	hv_country_code.len = strlen(csCountryCode);
	memcpy(hv_country_code.arr,csCountryCode,hv_country_code.len);
DEBUGLOG(("GetCountryPsp country_code = [%.*s]\n",hv_country_code.len,hv_country_code.arr));

	hv_type = PD_TYPE_PSP;

        EXEC SQL DECLARE c_cursor_getcountrypsp CURSOR FOR
		select a.client_id,
		       a.customer_id,
		       c.disabled,
		       c.online_mode,
                       c.psp_merchant_id,
                       c.psp_channel_code
  		  from clients a,
         	       psp_country b,
         	       psp_detail c   
    		 where a.type = :hv_type
		   and a.customer_id = b.psp_id
        	   and b.country = :hv_country_code
        	   and a.customer_id = c.psp_id;


        EXEC SQL OPEN c_cursor_getcountrypsp;
        do {
                EXEC SQL FETCH c_cursor_getcountrypsp
                INTO
			:v_client_id:ind_client_id,
			:v_psp_id:ind_psp_id,
			:v_disabled:ind_disabled,
			:v_online_mode:ind_online_mode,
			:v_psp_merchant_id:ind_psp_merchant_id,
			:v_psp_channel_code:ind_psp_channel_code;

//DEBUGLOG(("SQLCODe = [%d]\n",SQLCODE));
                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/* client_id */
                if (ind_client_id >= 0) { 
			v_client_id.arr[v_client_id.len] = '\0';
                        PutField_CString(myHash,"psp_client_id",v_client_id.arr);
DEBUGLOG(("GetCountryPsp psp_client_id = [%s]\n",v_client_id.arr));
		}

/* psp_id */
                if (ind_psp_id >= 0) { 
			v_psp_id.arr[v_psp_id.len] = '\0';
                        PutField_CString(myHash,"psp_id",v_psp_id.arr);
DEBUGLOG(("GetCountryPsp txn_psp_id = [%s]\n",v_psp_id.arr));
		}


/* disabled */
                if (ind_disabled >= 0) { 
                        PutField_Int(myHash,"disabled",v_disabled);
DEBUGLOG(("GetCountryPsp disabled = [%d]\n",v_disabled));
		}

/* online_mode */
                if (ind_online_mode >= 0) { 
                        PutField_Char(myHash,"online",v_online_mode);
DEBUGLOG(("GetCountryPsp online_mode = [%c]\n",v_online_mode));
		}
/* psp_merchant_id */
                if (ind_psp_merchant_id >= 0) { 
			v_psp_id.arr[v_psp_merchant_id.len] = '\0';
                        PutField_CString(myHash,"psp_merchant_id",v_psp_merchant_id.arr);
DEBUGLOG(("GetCountryPsp psp_merchant_id = [%s]\n",v_psp_merchant_id.arr));
		}

/* psp_channel_code */
                if (ind_psp_channel_code >= 0) { 
			v_psp_channel_code.arr[v_psp_channel_code.len] = '\0';
                        PutField_CString(myHash,"psp_channel_code",v_psp_channel_code.arr);
DEBUGLOG(("GetCountryPsp psp_channel_code = [%s]\n",v_psp_channel_code.arr));
		}



		RecordSet_Add(myRec,myHash);
		break; //*****************only one now
	}
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getcountrypsp;


DEBUGLOG(("GetCountryPsp Normal Exit\n")); 
        return  PD_OK;

getcountrypsp_error:
DEBUGLOG(("getcountrypsp_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getcountrypsp;
        return PD_ERR;
}


