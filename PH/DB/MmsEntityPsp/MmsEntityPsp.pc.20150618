/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/06/03              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "internal.h"
#include "MmsEntityPsp.h"
#include "ObjPtr.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char    cDebug;
OBJPTR(DB);

void MmsEntityPsp(char    cdebug)
{
        cDebug = cdebug;
}


int Sync(const hash_t *hRls)
{
	int	iRet = PD_OK;
	char	*csTmp;
	char	csEntityID[PD_MMS_ENTITY_ID_LEN +1];
	hash_t	*hData;

	hData= (hash_t*) malloc (sizeof(hash_t));
        hash_init(hData,0);

	EXEC SQL WHENEVER SQLERROR GOTO sync_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_node_id[PD_MMS_NODE_ID_LEN];
		varchar		hv_client_id[PD_CLIENT_ID_LEN];
		varchar		hv_client_name[PD_CLIENT_NAME_LEN];
		varchar		hv_psp_id[PD_PSP_ID_LEN];
		varchar		hv_baid[PD_BAID_LEN];
		varchar		hv_psp_name[PD_PSP_NAME_LEN];
		varchar		hv_baid_name[PD_BAID_NAME_LEN];
		varchar		hv_entity_id[PD_MMS_ENTITY_ID_LEN];
		varchar		hv_create_user[PD_USER_LEN];

		short		ind_node_id = -1;
		short		ind_client_id = -1;
		short		ind_client_name = -1;
		short		ind_psp_id = -1;
		short		ind_baid = -1;
		short		ind_psp_name = -1;
		short		ind_baid_name = -1;
		short		ind_create_user = -1;
		short		ind_entity_id = -1;
	
		short		hv_return_value;	
		
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Sync: Begin\n"));

        if(GetField_CString(hRls,"node_id",&csTmp)) {
                hv_node_id.len = strlen(csTmp);
                strncpy((char*)hv_node_id.arr, csTmp, hv_node_id.len);
                ind_node_id = 0;
DEBUGLOG(("Sync:node_id = [%.*s]\n",hv_node_id.len, hv_node_id.arr));
        }

        if(GetField_CString(hRls,"client_id",&csTmp)) {
                hv_client_id.len = strlen(csTmp);
                strncpy((char*)hv_client_id.arr, csTmp, hv_client_id.len);
                ind_client_id = 0;
DEBUGLOG(("Sync:client_id = [%.*s]\n",hv_client_id.len, hv_client_id.arr));
		PutField_CString(hData,"client_id",csTmp);
        }

        if(GetField_CString(hRls,"client_name",&csTmp)) {
                hv_client_name.len = strlen(csTmp);
                strncpy((char*)hv_client_name.arr, csTmp, hv_client_name.len);
                ind_client_name = 0;
DEBUGLOG(("Sync:client_name = [%.*s]\n",hv_client_name.len, hv_client_name.arr));
		PutField_CString(hData,"client_name",csTmp);
        }

        if(GetField_CString(hRls,"psp_id",&csTmp)) {
                hv_psp_id.len = strlen(csTmp);
                strncpy((char*)hv_psp_id.arr, csTmp, hv_psp_id.len);
                ind_psp_id = 0;
DEBUGLOG(("Sync:psp_id = [%.*s]\n",hv_psp_id.len, hv_psp_id.arr));
        }

        if(GetField_CString(hRls,"baid",&csTmp)) {
                hv_baid.len = strlen(csTmp);
                strncpy((char*)hv_baid.arr, csTmp, hv_baid.len);
                ind_baid = 0;
DEBUGLOG(("Sync:baid = [%.*s]\n",hv_baid.len, hv_baid.arr));
        }


        if(GetField_CString(hRls,"psp_name",&csTmp)) {
                hv_psp_name.len = strlen(csTmp);
                strncpy((char*)hv_psp_name.arr, csTmp, hv_psp_name.len);
                ind_psp_name = 0;
DEBUGLOG(("Sync:psp_name = [%.*s]\n",hv_psp_name.len, hv_psp_name.arr));
        }

        if(GetField_CString(hRls,"baid_name",&csTmp)) {
                hv_baid_name.len = strlen(csTmp);
                strncpy((char*)hv_baid_name.arr, csTmp, hv_baid_name.len);
                ind_baid_name = 0;
DEBUGLOG(("Sync:baid_name = [%.*s]\n",hv_baid_name.len, hv_baid_name.arr));
		PutField_CString(hData,"desc",csTmp);
        }

        if(GetField_CString(hRls,"create_user",&csTmp)) {
                hv_create_user.len = strlen(csTmp);
                strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
		PutField_CString(hData,"create_user",csTmp);
        }
DEBUGLOG(("Sync:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_mms_entity_psp_update(
								:hv_node_id:ind_node_id,
								:hv_client_id:ind_client_id,
								:hv_psp_id:ind_psp_id,
								:hv_baid:ind_baid,
								:hv_psp_name:ind_psp_name,
								:hv_baid_name:ind_baid_name,
								:hv_create_user:ind_create_user); 
		END;
	END-EXEC;

DEBUGLOG(("Sync:Updte Ret = [%d]\n",hv_return_value));

        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("Sync:Update Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MmsEntityPsp_Sync: Update SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Sync: Update SP_OTHER_ERR TxnAbort\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
DEBUGLOG(("Sync: Update Switched to Create\n"));
        }

/* create entity master */

	DBObjPtr = CreateObj(DBPtr,"DBMmsEntityMaster", "Add");
	iRet = (unsigned long) (*DBObjPtr)(hData);

DEBUGLOG(("Sync: iRet = [%d] return from MmsEntityMaster Create\n",iRet));
/* create entity  */
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBMmsEntityID", "GetNextEntityID");
		strcpy(csEntityID,(*DBObjPtr)());
DEBUGLOG(("Sync: new Entity ID [%s]\n",csEntityID));
                hv_entity_id.len = strlen(csEntityID);
                strncpy((char*)hv_entity_id.arr, csEntityID, hv_entity_id.len);
                ind_entity_id = 0;
DEBUGLOG(("Sync:entity_id = [%.*s]\n",hv_entity_id.len,hv_entity_id.arr));

		PutField_CString(hData,"entity_id",csEntityID);
		PutField_CString(hData,"entity_type",PD_MMS_ENTITY_PSP);

		DBObjPtr = CreateObj(DBPtr,"DBMmsEntity", "Add");
		iRet = (unsigned long) (*DBObjPtr)(hData);
DEBUGLOG(("Sync: iRet = [%d] return from MMS Entity Add\n",iRet));
	}

/* free */
	FREE_ME(hData);

	if (iRet == PD_OK) {
		EXEC SQL EXECUTE
			BEGIN
				:hv_return_value := sp_mms_entity_psp_insert(
								:hv_node_id:ind_node_id,
								:hv_client_id:ind_client_id,
								:hv_psp_id:ind_psp_id,
								:hv_baid:ind_baid,
								:hv_psp_name:ind_psp_name,
								:hv_baid_name:ind_baid_name,
								:hv_entity_id:ind_entity_id,
								:hv_create_user:ind_create_user); 
			END;
		END-EXEC;

DEBUGLOG(("Sync:Ret = [%d]\n",hv_return_value));
        	if (hv_return_value == SP_OK)
        	{
DEBUGLOG(("Sync:Normal Exit\n"));
                	return PD_OK;
        	}

        	if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MmsEntityPsp_Sync: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Sync: SP_OTHER_ERR TxnAbort\n"));
               	 	return PD_OTHER_ERR;
        	}

        	if (hv_return_value == SP_ERR)  {
ERRLOG("MmsEntityPsp_Sync: SP_ERR TxnAbort\n");
DEBUGLOG(("Sync: SP_ERR TxnAbort\n"));
                	return PD_ERR;
        	}

	}

	return PD_ERR;
sync_error:
DEBUGLOG(("sync_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MmsEntityPsp_Sync: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}


int GetPspEntityId(const char* csNodeId,
		const char* csClientId,
		const char* csPspId,
		const char* csBAID,
		char* csEntityId,
		char* csNatureId)
{
	int	iRet = PD_NOT_FOUND;
DEBUGLOG(("GetPspEntityId()\n"));

	EXEC SQL WHENEVER SQLERROR GOTO getpspentityid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar         hv_node_id[PD_MMS_NODE_ID_LEN];
		varchar         hv_client_id[PD_CLIENT_ID_LEN];
		varchar         hv_psp_id[PD_PSP_ID_LEN];
		varchar         hv_baid[PD_BAID_LEN];

		varchar		v_entity_id[PD_MMS_ENTITY_ID_LEN +1];
		varchar		v_nature_id[PD_NATURE_ID_LEN +1];
	
		short		ind_entity_id = -1;
		short		ind_nature_id = -1;
	
	EXEC SQL END DECLARE SECTION;

/* node_id */
	hv_node_id.len = strlen(csNodeId);
        memcpy(hv_node_id.arr,csNodeId,hv_node_id.len);
DEBUGLOG(("GetPspEntityId node_id = [%.*s]\n",hv_node_id.len,hv_node_id.arr));

/* client_id */
	hv_client_id.len = strlen(csClientId);
        memcpy(hv_client_id.arr,csClientId,hv_client_id.len);
DEBUGLOG(("GetPspEntityId client_id = [%.*s]\n",hv_client_id.len,hv_client_id.arr));
	
/* psp_id */
	hv_psp_id.len = strlen(csPspId);
        memcpy(hv_psp_id.arr,csPspId,hv_psp_id.len);
DEBUGLOG(("GetPspEntityId psp_id = [%.*s]\n",hv_psp_id.len,hv_psp_id.arr));
	
/* baid */
	hv_baid.len = strlen(csBAID);
        memcpy(hv_baid.arr,csBAID,hv_baid.len);
DEBUGLOG(("GetPspEntityId baid = [%.*s]\n",hv_baid.len,hv_baid.arr));
	

	EXEC SQL DECLARE c_cursor_getpspentityid CURSOR FOR
                select MEP_ENTITY_ID,
		       MEP_DEFAULT_NATURE_ID
                  from MMS_ENTITY_PSP
                 where MEP_NODE_ID = :hv_node_id
		   and MEP_CLIENT_ID = :hv_client_id
      	 	   and MEP_PSP_ID = :hv_psp_id
		   and MEP_BAID = :hv_baid;

	EXEC SQL OPEN c_cursor_getpspentityid;
        do {
                EXEC SQL FETCH c_cursor_getpspentityid
                INTO
			:v_entity_id:ind_entity_id,
			:v_nature_id:ind_nature_id;

		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

		if (ind_entity_id >= 0 ) {
			iRet = PD_FOUND;
			v_entity_id.arr[v_entity_id.len] ='\0';
			strcpy(csEntityId,(const char*)v_entity_id.arr);
DEBUGLOG(("GetPspEntityId Entity Id = [%s]\n",csEntityId));
		}

		if (ind_nature_id >= 0 ) {
			iRet = PD_FOUND;
			v_nature_id.arr[v_nature_id.len] ='\0';
			strcpy(csNatureId,(const char*)v_nature_id.arr);
DEBUGLOG(("GetPspEntityId default nature id = [%s]\n",csNatureId));
		}
		else {
DEBUGLOG(("GetPspEntityId default nature id not found, set to null\n"));
			csNatureId[0]='\0';
		}
	}
	while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getpspentityid;
	
DEBUGLOG(("GetPspEntityId() normal return iRet = [%d]\n",iRet));
	return iRet;

getpspentityid_error:
DEBUGLOG(("pspentityid_error code %d\n", sqlca.sqlcode));
ERRLOG("DBMmsEntityPsp::pspentityid_error code %d\n", sqlca.sqlcode);
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getpspentityid;
        return PD_NOT_FOUND;
}

