/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/07/04              Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "OLStatement.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char	cDebug;

void OLStatement(char	cdebug)
{
	cDebug = cdebug;
}

/*
int GetLastBalance(const char* csBankAcctNum, double* dBalance)
{
	int iRet = PD_FOUND;

	EXEC SQL WHENEVER SQLERROR GOTO getlastbalance_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN + 1];
		double	v_balance;

		short	ind_bank_acct_num = -1;
		short	ind_balance = -1;

	EXEC SQL END DECLARE SECTION;

	hv_bank_acct_num.len = strlen(csBankAcctNum);
	strncpy((char*)hv_bank_acct_num.arr,csBankAcctNum,hv_bank_acct_num.len);
	ind_bank_acct_num = 0;
DEBUGLOG(("GetLastBalance bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));

	EXEC SQL	SELECT	OLSD_BALANCE
			INTO	v_balance:ind_balance
			FROM	(SELECT	OLSD_BALANCE
				FROM	OL_STATEMENT_DETAIL
				WHERE	OLSD_BANK_ACCT_NUM = :hv_bank_acct_num:ind_bank_acct_num
				ORDER BY OLSD_CREATE_TIMESTAMP DESC, OLSD_STATEMENT_SEQ DESC)
			WHERE	rownum = 1;

	if (ind_balance>=0) {
		*dBalance = v_balance;
DEBUGLOG(("GetLastBalance balance = [%.2f]\n",v_balance));
		iRet = PD_FOUND;
	} else {
		iRet = PD_NOT_FOUND;
	}

DEBUGLOG(("GetLastBalance Normal Exit iRet = [%d]\n",iRet));
	return iRet;

getlastbalance_error:
DEBUGLOG(("getlastbalance_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}
*/

/*
int GetDupRecord(double dTxnAmount, int iBFHour, int iAFHour)
{
	int iRet = PD_FOUND;

	EXEC SQL WHENEVER SQLERROR GOTO getduprecord_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		double	hv_txn_amount;
		int	hv_bf_hour;
		int	hv_af_hour;
		int	v_cnt;

		short	ind_txn_amount = -1;
		short	ind_bf_hour = -1;
		short	ind_af_hour = -1;

	EXEC SQL END DECLARE SECTION;

	hv_txn_amount = dTxnAmount;
DEBUGLOG(("GetDupRecord txn_amount = [%.2f]\n",hv_txn_amount));

	hv_bf_hour = iBFHour;
DEBUGLOG(("GetDupRecord bf_hour = [%d]\n",hv_bf_hour));

	hv_af_hour = iAFHour;
DEBUGLOG(("GetDupRecord af_hour = [%d]\n",hv_af_hour));

	EXEC SQL	SELECT	COUNT(*)
			INTO	v_cnt
			FROM	OL_STATEMENT_DETAIL
			WHERE	OLSD_BANK_ACCT_NUM = :hv_bank_acct_num:ind_bank_acct_num
			AND	OLSD_TXN_AMOUNT = :hv_txn_amount:ind_txn_amount
			AND	OLSD_STATEMENT_TIME <= :hv_date:ind_date - :hv_bf_hour:ind_bf_hour
			AND	OLSD_STATEMENT_DATE >= :hv_date:ind_date + :hv_af_hour:ind_af_hour

	if (v_cnt>0) {
DEBUGLOG(("GetDupRecord FOUND));
		iRet = PD_FOUND;
	} else {
DEBUGLOG(("GetDupRecord NOT FOUND));
		iRet = PD_NOT_FOUND;
	}

DEBUGLOG(("GetDupRecord Normal Exit iRet = [%d]\n",iRet));
	return iRet;

getduprecord_error:
DEBUGLOG(("getduprecord_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}
*/


int GetNextHeaderFileIndex(const char* csStartName, const char* csEndName,
				const char* csFilename, int* iFileIndex)
{
        int iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO checkheader_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_filename[PD_FILENAME_LEN + 1];
		varchar	hv_start_name[PD_FILENAME_LEN + 1];
		varchar	hv_end_name[PD_FILENAME_LEN + 1];
		int	v_cnt;

		short	ind_filename = -1;
		short	ind_start_name = -1;
		short	ind_end_name = -1;

        EXEC SQL END DECLARE SECTION;

	hv_filename.len = strlen(csFilename);
	strncpy((char*)hv_filename.arr,csFilename,hv_filename.len);
	ind_filename = 0;
DEBUGLOG(("GetNextHeaderFileIndex filename = [%s]\n",csFilename)); 

	hv_start_name.len = strlen(csStartName);
	strncpy((char*)hv_start_name.arr,csStartName,hv_start_name.len);
	ind_start_name = 0;
DEBUGLOG(("GetNextHeaderFileIndex start name = [%s]\n",csStartName)); 

	hv_end_name.len = strlen(csEndName);
	strncpy((char*)hv_end_name.arr,csEndName,hv_end_name.len);
	ind_end_name = 0;
DEBUGLOG(("GetNextHeaderFileIndex End Name = [%s]\n",csEndName)); 

	EXEC SQL	SELECT	NVL(MAX(TO_NUMBER(FILE_INDEX))+1,0)
			INTO	:v_cnt
			FROM	(SELECT	NVL(REGEXP_REPLACE
					(OLSH_FILENAME, '^'||start_name||'\(?|\)?\.'||end_name||'$')
					,'0') AS FILE_INDEX
				FROM	OL_STATEMENT_HEADER,
					(SELECT	regexp_replace (:hv_start_name:ind_start_name,'[\[\\\^\$\|\?\*\+\(\)]','.') as start_name,
						regexp_replace (:hv_end_name:ind_end_name,'[\[\\\^\$\|\?\*\+\(\)]','.') as end_name
					FROM DUAL)
				WHERE	REGEXP_LIKE
					(OLSH_FILENAME, '^'||start_name||'(\([0-9]+\))?\.'||end_name||'$')
				);

	*iFileIndex = v_cnt;
	if (v_cnt>0) {
		iRet = PD_FOUND;
DEBUGLOG(("GetNextHeaderFileIndex filename [%s] FOUND (next:[%d])\n",csFilename,v_cnt)); 
	} else {
		iRet = PD_NOT_FOUND;
DEBUGLOG(("GetNextHeaderFileIndex filename [%s] NOT FOUND\n",csFilename));
	}

	return iRet;

checkheader_error:
DEBUGLOG(("checkheader_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}


int CheckHeaderExist(const char* csFilename)
{
        int iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO checkheader_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_filename[PD_FILENAME_LEN + 1];
		int	v_cnt;

		short	ind_filename = -1;

        EXEC SQL END DECLARE SECTION;

	hv_filename.len = strlen(csFilename);
	strncpy((char*)hv_filename.arr,csFilename,hv_filename.len);
	ind_filename = 0;

	EXEC SQL	SELECT	COUNT(*)
			INTO	v_cnt
			FROM	OL_STATEMENT_HEADER
			WHERE	OLSH_FILENAME = :hv_filename:ind_filename;

	if (v_cnt>0) {
		iRet = PD_FOUND;
DEBUGLOG(("CheckHeaderExist filename [%s] FOUND\n",csFilename)); 
	} else {
		iRet = PD_NOT_FOUND;
DEBUGLOG(("CheckHeaderExist filename [%s] NOT FOUND\n",csFilename));
	}

	return iRet;

checkheader_error:
DEBUGLOG(("checkheader_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int AddHeader(const hash_t *hRls)
{
	char	*csTmp;
	int	iTmp;

	EXEC SQL WHENEVER SQLERROR GOTO addheader_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_filename[PD_FILENAME_LEN];
		varchar		hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar		hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		int		hv_sms_count;
		int		hv_total_count;
		int		hv_accept_count;
		int		hv_skip_count;
		varchar		hv_create_user[PD_USER_LEN];

		short		ind_filename = -1;
		short		ind_int_bank_code = -1;
		short		ind_bank_acct_num = -1;
		short		ind_sms_count = -1;
		short		ind_total_count = -1;
		short		ind_accept_count = -1;
		short		ind_skip_count = -1;
		short		ind_create_user = -1;
	
		short		hv_return_value;	
		
	EXEC SQL END DECLARE SECTION;

	if(GetField_CString(hRls,"filename",&csTmp)) {
		hv_filename.len = strlen(csTmp);
		strncpy((char*)hv_filename.arr, csTmp, hv_filename.len);
		ind_filename = 0;
DEBUGLOG(("AddHeader:filename = [%.*s]\n",hv_filename.len, hv_filename.arr));
	} else {
DEBUGLOG(("AddHeader:filename NOT FOUND!!!\n"));
	}

	if(GetField_CString(hRls,"int_bank_code",&csTmp)) {
		hv_int_bank_code.len = strlen(csTmp);
		strncpy((char*)hv_int_bank_code.arr, csTmp, hv_int_bank_code.len);
		ind_int_bank_code = 0;
DEBUGLOG(("AddHeader:int_bank_code = [%.*s]\n",hv_int_bank_code.len, hv_int_bank_code.arr));
	}

	if(GetField_CString(hRls,"bank_acct_num",&csTmp)) {
		hv_bank_acct_num.len = strlen(csTmp);
		strncpy((char*)hv_bank_acct_num.arr, csTmp, hv_bank_acct_num.len);
		ind_bank_acct_num = 0;
DEBUGLOG(("AddHeader:bank_acct_num = [%.*s]\n",hv_bank_acct_num.len, hv_bank_acct_num.arr));
	}

	hv_sms_count = 0;
	if(GetField_Int(hRls, "sms_count", &iTmp)) {
		hv_sms_count = iTmp;
DEBUGLOG(("AddHeader:sms_count = [%d]\n",hv_sms_count));
	}
	ind_sms_count = 0;

	hv_total_count = 0;
	if(GetField_Int(hRls, "total_count", &iTmp)) {
		hv_total_count = iTmp;
DEBUGLOG(("AddHeader:total_count = [%d]\n",hv_total_count));
	}
	ind_total_count = 0;

	hv_accept_count = 0;
	if(GetField_Int(hRls, "accept_count", &iTmp)) {
		hv_accept_count = iTmp;
DEBUGLOG(("AddHeader:accept_count = [%d]\n",hv_accept_count));
	}
	ind_accept_count = 0;

	hv_skip_count = 0;
	if(GetField_Int(hRls, "skip_count", &iTmp)) {
		hv_skip_count = iTmp;
DEBUGLOG(("AddHeader:skip_count = [%d]\n",hv_skip_count));
	}
	ind_skip_count = 0;

	if(GetField_CString(hRls,"create_user",&csTmp))
	{
		hv_create_user.len = strlen(csTmp);
		strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
DEBUGLOG(("AddHeader:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));
	} else {
DEBUGLOG(("AddHeader:create_user NOT FOUND!!!\n"));
	}

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_statement_header_insert(
						:hv_filename:ind_filename,
						:hv_int_bank_code:ind_int_bank_code,
						:hv_bank_acct_num:ind_bank_acct_num,
						:hv_sms_count:ind_sms_count,
						:hv_total_count:ind_total_count,
						:hv_accept_count:ind_accept_count,
						:hv_skip_count:ind_skip_count,
						:hv_create_user:ind_create_user); 
		END;
	END-EXEC;

	DEBUGLOG(("AddHeader:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
		DEBUGLOG(("AddHeader:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR) {
		ERRLOG("OLStatement_AddHeader: SP_OTHER_ERR TxnAbort\n");
		DEBUGLOG(("AddHeader: SP_OTHER_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR) {
		ERRLOG("OLStatement_AddHeader: SP_ERR TxnAbort\n");
		DEBUGLOG(("AddHeader: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

addheader_error:
DEBUGLOG(("addheader_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLStatement_AddHeader: SP_INTERNAL_ERR TxnAbort\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}

int UpdateHeader(const hash_t *hRls)
{
	int	iTmp;
	char	*csTmp;
	char	*csFilename;

	char*	csBuf;
	csBuf = (char *) malloc(128);

        EXEC SQL WHENEVER SQLERROR GOTO update_header_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar	hv_dynstmt[1024];
		
        EXEC SQL END DECLARE SECTION;

        strcpy((char*)hv_dynstmt.arr,"update ol_statement_header set olsh_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	if (!GetField_CString(hRls,"filename",&csFilename)) {
DEBUGLOG(("UpdateHeader: filename NOT FOUND!!!\n"));
	}

/* update_user */
        if(GetField_CString(hRls,"update_user",&csTmp)){
DEBUGLOG(("UpdateHeader:update_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",olsh_update_user= '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* int_bank_code */
        if(GetField_CString(hRls,"int_bank_code",&csTmp)){
DEBUGLOG(("UpdateHeader:int_bank_code = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",olsh_int_bank_code= '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* bank_acct_num */
        if(GetField_CString(hRls,"bank_acct_num",&csTmp)){
DEBUGLOG(("UpdateHeader:bank_acct_num = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",olsh_bank_acct_num= '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* sms_count */
	if (GetField_Int(hRls,"sms_count",&iTmp)) {
DEBUGLOG(("UpdateHeader:sms_count += [%d]\n",iTmp));
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, ",olsh_sms_count = NVL(olsh_sms_count,0)+");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* total_count */
	if (GetField_Int(hRls,"total_count",&iTmp)) {
DEBUGLOG(("UpdateHeader:total_count += [%d]\n",iTmp));
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, ",olsh_total_count = NVL(olsh_total_count,0)+");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* accept_count */
	if (GetField_Int(hRls,"accept_count",&iTmp)) {
DEBUGLOG(("UpdateHeader:accept_count += [%d]\n",iTmp));
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, ",olsh_accept_count = NVL(olsh_accept_count,0)+");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* skip_count */
	if (GetField_Int(hRls,"skip_count",&iTmp)) {
DEBUGLOG(("UpdateHeader:skip_count += [%d]\n",iTmp));
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, ",olsh_skip_count = NVL(olsh_skip_count,0)+");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

        strcat((char *)hv_dynstmt.arr, " WHERE olsh_filename = '");
        strcat((char *)hv_dynstmt.arr, csFilename);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);

DEBUGLOG(("UpdateHeader Normal Exit\n"));
        return PD_OK;

update_header_error:
DEBUGLOG(("update_Header_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("OLStatement_UpdateHeader: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("UpdateHeader: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;
}

#define	PD_OUT_OF_DATE	7
#define	PD_OUT_OF_TIME	8

int CheckDetail(int iCurrLine, const hash_t *hRls)
{
	int	iRet = PD_OK;
	int	iTmp;
	double	dTmp;
	char	cTmp;
	char	*csTmp;

/* filename */
	if(GetField_CString(hRls,"filename",&csTmp)) {
		if (strlen(csTmp) > PD_FILENAME_LEN) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: filename [%s] len > [%d]\n",csTmp,PD_FILENAME_LEN));
		}
	} else {
		iRet = PD_ERR;
DEBUGLOG(("CheckDetail: filename NOT FOUND\n"));
	}

/* int_bank_code */
	if(GetField_CString(hRls,"int_bank_code",&csTmp)) {
		if (strlen(csTmp) > PD_BANK_CODE_LEN) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: int_bank_code [%s] len > [%d]\n",csTmp,PD_BANK_CODE_LEN));
		}
	} else {
		iRet = PD_ERR;
DEBUGLOG(("CheckDetail: int_bank_code NOT FOUND\n"));
	}

/* bank_acct_num */
	if(GetField_CString(hRls,"bank_acct_num",&csTmp)) {
		if (strlen(csTmp) > PD_BANK_ACCT_NUM_LEN) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: bank_acct_num [%s] len > [%d]\n",csTmp,PD_BANK_ACCT_NUM_LEN));
		}
	} else {
		iRet = PD_ERR;
DEBUGLOG(("CheckDetail: bank_acct_num NOT FOUND\n"));
	}

/* statement_seq */
	if(!GetField_Int(hRls, "statement_seq", &iTmp)) {
		iRet = PD_ERR;
DEBUGLOG(("CheckDetail: statement_seq NOT FOUND\n"));
	}

/* status */
	if (!GetField_Char(hRls,"status",&cTmp)) {	
		iRet = PD_ERR;
DEBUGLOG(("CheckDetail: status NOT FOUND\n"));
	}

/* statement_date */
	if(GetField_CString(hRls,"statement_date",&csTmp)) {
		if (strlen(csTmp) > PD_FORMAT_TEMPLATE_LEN) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: statement_date [%s] len > [%d]\n",csTmp,PD_FORMAT_TEMPLATE_LEN));
		}

		if(GetField_CString(hRls,"statement_date_t",&csTmp)) {
			if (strlen(csTmp) > PD_FORMAT_TEMPLATE_LEN) {
				iRet = PD_ERR;
DEBUGLOG(("CheckDetail: statement_date_t [%s] len > [%d]\n",csTmp,PD_FORMAT_TEMPLATE_LEN));
			}
		}
	} else {
		iRet = PD_ERR;
DEBUGLOG(("CheckDetail: statement_date NOT FOUND\n"));
	}

/* statement_time */
	if(GetField_CString(hRls,"statement_time",&csTmp)) {
		if (strlen(csTmp) > PD_FORMAT_TEMPLATE_LEN) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: statement_time [%s] len > [%d]\n",csTmp,PD_FORMAT_TEMPLATE_LEN));
		}

		if(GetField_CString(hRls,"statement_time_t",&csTmp)) {
			if (strlen(csTmp) > PD_FORMAT_TEMPLATE_LEN) {
				iRet = PD_ERR;
DEBUGLOG(("CheckDetail: statement_time_t [%s] len > [%d]\n",csTmp,PD_FORMAT_TEMPLATE_LEN));
			}
		}
	}

/* tfr_bank_name */
	if(GetField_CString(hRls,"tfr_bank_name",&csTmp)) {
		if (strlen(csTmp) > PD_TFR_BANK_NAME_LEN) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: tfr_bank_name [%s] len > [%d]\n",csTmp,PD_TFR_BANK_NAME_LEN));
		}
	}
/* tfr_bank_acct_num */
	if(GetField_CString(hRls,"tfr_bank_acct_num",&csTmp)) {
		if (strlen(csTmp) > PD_TFR_BANK_ACCT_NUM_LEN) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: tfr_bank_acct_num [%s] len > [%d]\n",csTmp,PD_TFR_BANK_ACCT_NUM_LEN));
		}
	}
/* tfr_type */
	if(GetField_CString(hRls,"tfr_type",&csTmp)) {
		if (strlen(csTmp) > PD_TFR_TYPE_LEN) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: tfr_type [%s] len > [%d]\n",csTmp,PD_TFR_TYPE_LEN));
		}
	}
/* tfr_channel */
	if(GetField_CString(hRls,"tfr_channel",&csTmp)) {
		if (strlen(csTmp) > PD_TFR_CHANNEL_LEN) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: tfr_channel [%s] len > [%d]\n",csTmp,PD_TFR_CHANNEL_LEN));
		}
	}
/* tfr_text */
	if(GetField_CString(hRls,"tfr_text",&csTmp)) {
		if (strlen(csTmp) > PD_TFR_TEXT_LEN) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: tfr_text [%s] len > [%d]\n",csTmp,PD_TFR_TEXT_LEN));
		}
	}
/* tfr_customer_text */
	if(GetField_CString(hRls,"tfr_customer_text",&csTmp)) {
		if (strlen(csTmp) > PD_TFR_TEXT_LEN) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: tfr_customer_text [%s] len > [%d]\n",csTmp,PD_TFR_TEXT_LEN));
		}
	}

/* balance */
	if (GetField_CString(hRls,"balance",&csTmp)) {	
		dTmp = atof(csTmp);
		if (dTmp < 0.0) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: balance = [%.2f] < 0.0\n",dTmp));
		}
	} else {
		iRet = PD_ERR;
DEBUGLOG(("CheckDetail: balance NOT FOUND\n"));
	}

/* amt_type */
	if (GetField_CString(hRls,"amt_type",&csTmp)) {	
		if (strlen(csTmp) > PD_AMT_TYPE_LEN) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: amt_type [%s] len > [%d]\n",csTmp,PD_AMT_TYPE_LEN));
		}
	} else {
		iRet = PD_ERR;
DEBUGLOG(("CheckDetail: amt_type NOT FOUND\n"));
	}

/* txn_amount */
	if (GetField_CString(hRls,"txn_amount",&csTmp)) {	
		dTmp = atof(csTmp);
		if (dTmp <= 0.0) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: txn_amount = [%.2f] <= 0.0\n",dTmp));
		}
	} else {
		iRet = PD_ERR;
DEBUGLOG(("CheckDetail: txn_amount NOT FOUND\n"));
	}

/* txn_ccy */
	if(GetField_CString(hRls,"txn_ccy",&csTmp)) {
		if (strlen(csTmp) > PD_CCY_ID_LEN) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: txn_ccy [%s] len > [%d]\n",csTmp,PD_CCY_ID_LEN));
		}
	} else {
		iRet = PD_ERR;
DEBUGLOG(("CheckDetail: txn_ccy NOT FOUND\n"));
	}

/* create_user */
	if(GetField_CString(hRls,"create_user",&csTmp)) {
		if (strlen(csTmp) > PD_USER_LEN) {
			iRet = PD_ERR;
DEBUGLOG(("CheckDetail: create_user [%s] len > [%d]\n",csTmp,PD_USER_LEN));
		}
	} else {
		iRet = PD_ERR;
DEBUGLOG(("CheckDetail: create_user NOT FOUND\n"));
	}


	if (iRet != PD_OK)
DEBUGLOG(("CheckDetail: Line [%d] FAILURE!!!\n",iCurrLine));

	return iRet;

}

int AddDetail(int iCurrLine, const hash_t *hRls)
{
	int	iTmp;
	char	cTmp;
	char	*csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO addetail_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_filename[PD_FILENAME_LEN];
		varchar		hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar		hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		int		hv_statement_seq;
		varchar		hv_txn_id[PD_TXN_SEQ_LEN];
		varchar		hv_sms_txn_id[PD_TXN_SEQ_LEN];
		char		hv_status;
		varchar		hv_statement_date[PD_FORMAT_TEMPLATE_LEN];
		varchar		hv_statement_date_t[PD_FORMAT_TEMPLATE_LEN];
		varchar		hv_statement_time[PD_FORMAT_TEMPLATE_LEN];
		varchar		hv_statement_time_t[PD_FORMAT_TEMPLATE_LEN];
		varchar		hv_tfr_bank_name[PD_TFR_BANK_NAME_LEN];
		varchar		hv_tfr_bank_acct_num[PD_TFR_BANK_ACCT_NUM_LEN];
		varchar		hv_tfr_type[PD_TFR_TYPE_LEN];
		varchar		hv_tfr_channel[PD_TFR_CHANNEL_LEN];
		varchar		hv_tfr_text[PD_TFR_TEXT_LEN];
		varchar		hv_tfr_customer_text[PD_TFR_TEXT_LEN];
		double		hv_balance;
		varchar		hv_amt_type[PD_AMT_TYPE_LEN];
		double		hv_txn_amount;
		varchar		hv_txn_ccy[PD_CCY_ID_LEN];
		varchar		hv_create_user[PD_USER_LEN];

		short		ind_filename = -1;
		short		ind_int_bank_code = -1;
		short		ind_bank_acct_num = -1;
		short		ind_statement_seq = -1;
		short		ind_txn_id = -1;
		short		ind_sms_txn_id = -1;
		short		ind_status = -1;
		short		ind_statement_date = -1;
		short		ind_statement_date_t = -1;
		short		ind_statement_time = -1;
		short		ind_statement_time_t = -1;
		short		ind_tfr_bank_name = -1;
		short		ind_tfr_bank_acct_num = -1;
		short		ind_tfr_type = -1;
		short		ind_tfr_channel = -1;
		short		ind_tfr_text = -1;
		short		ind_tfr_customer_text = -1;
		short		ind_balance = -1;
		short		ind_amt_type = -1;
		short		ind_txn_amount = -1;
		short		ind_txn_ccy = -1;
		short		ind_create_user = -1;
	
		short		hv_return_value;	
		
	EXEC SQL END DECLARE SECTION;

	if(GetField_CString(hRls,"filename",&csTmp)) {
		hv_filename.len = strlen(csTmp);
		strncpy((char*)hv_filename.arr, csTmp, hv_filename.len);
		ind_filename = 0;
//DEBUGLOG(("AddDetail: filename = [%.*s]\n",hv_filename.len, hv_filename.arr));
	}

	if(GetField_CString(hRls,"int_bank_code",&csTmp)) {
		hv_int_bank_code.len = strlen(csTmp);
		strncpy((char*)hv_int_bank_code.arr, csTmp, hv_int_bank_code.len);
		ind_int_bank_code = 0;
//DEBUGLOG(("AddDetail: int_bank_code = [%.*s]\n",hv_int_bank_code.len, hv_int_bank_code.arr));
	}

	if(GetField_CString(hRls,"bank_acct_num",&csTmp)) {
		hv_bank_acct_num.len = strlen(csTmp);
		strncpy((char*)hv_bank_acct_num.arr, csTmp, hv_bank_acct_num.len);
		ind_bank_acct_num = 0;
//DEBUGLOG(("AddDetail: bank_acct_num = [%.*s]\n",hv_bank_acct_num.len, hv_bank_acct_num.arr));
	}

	if(GetField_Int(hRls, "statement_seq", &iTmp)) {
		hv_statement_seq = iTmp;
		ind_statement_seq = 0;
//DEBUGLOG(("AddDetail: statement_seq = [%d]\n",hv_statement_seq));
	}

/*
	if(GetField_CString(hRls,"txn_id",&csTmp)) {
		hv_txn_id.len = strlen(csTmp);
		strncpy((char*)hv_txn_id.arr, csTmp, hv_txn_id.len);
		ind_txn_id = 0;
DEBUGLOG(("AddDetail: txn_id = [%.*s]\n",hv_txn_id.len, hv_txn_id.arr));
	}

	if(GetField_CString(hRls,"sms_txn_id",&csTmp)) {
		hv_sms_txn_id.len = strlen(csTmp);
		strncpy((char*)hv_sms_txn_id.arr, csTmp, hv_sms_txn_id.len);
		ind_sms_txn_id = 0;
DEBUGLOG(("AddDetail: sms_txn_id = [%.*s]\n",hv_sms_txn_id.len, hv_sms_txn_id.arr));
	}
*/

	if (GetField_Char(hRls,"status",&cTmp)) {	
		hv_status = cTmp;
		ind_status = 0;
//DEBUGLOG(("AddDetail: status = [%c]\n",hv_status));
	}

	if(GetField_CString(hRls,"statement_date",&csTmp)) {
		hv_statement_date.len = strlen(csTmp);
		strncpy((char*)hv_statement_date.arr, csTmp, hv_statement_date.len);
		ind_statement_date = 0;
//DEBUGLOG(("AddDetail: statement_date = [%.*s]\n",hv_statement_date.len, hv_statement_date.arr));

		if(GetField_CString(hRls,"statement_date_t",&csTmp)) {
			hv_statement_date_t.len = strlen(csTmp);
			strncpy((char*)hv_statement_date_t.arr, csTmp, hv_statement_date_t.len);
			ind_statement_date_t = 0;
//DEBUGLOG(("AddDetail: statement_date template = [%.*s]\n",hv_statement_date_t.len, hv_statement_date_t.arr));
		}
	}


	if(GetField_CString(hRls,"statement_time",&csTmp)) {
		hv_statement_time.len = strlen(csTmp);
		strncpy((char*)hv_statement_time.arr, csTmp, hv_statement_time.len);
		ind_statement_time = 0;
//DEBUGLOG(("AddDetail: statement_time = [%.*s]\n",hv_statement_time.len, hv_statement_time.arr));

		if(GetField_CString(hRls,"statement_time_t",&csTmp)) {
			hv_statement_time_t.len = strlen(csTmp);
			strncpy((char*)hv_statement_time_t.arr, csTmp, hv_statement_time_t.len);
			ind_statement_time_t = 0;
//DEBUGLOG(("AddDetail: statement_time template = [%.*s]\n",hv_statement_time_t.len, hv_statement_time_t.arr));
		}
	}

	if(GetField_CString(hRls,"tfr_bank_name",&csTmp)) {
		hv_tfr_bank_name.len = strlen(csTmp);
		strncpy((char*)hv_tfr_bank_name.arr, csTmp, hv_tfr_bank_name.len);
		ind_tfr_bank_name = 0;
//DEBUGLOG(("AddDetail: tfr_bank_name = [%.*s]\n",hv_tfr_bank_name.len, hv_tfr_bank_name.arr));
	}

	if(GetField_CString(hRls,"tfr_bank_acct_num",&csTmp)) {
		hv_tfr_bank_acct_num.len = strlen(csTmp);
		strncpy((char*)hv_tfr_bank_acct_num.arr, csTmp, hv_tfr_bank_acct_num.len);
		ind_tfr_bank_acct_num = 0;
//DEBUGLOG(("AddDetail: tfr_bank_acct_num = [%.*s]\n",hv_tfr_bank_acct_num.len, hv_tfr_bank_acct_num.arr));
	}

	if(GetField_CString(hRls,"tfr_type",&csTmp)) {
		hv_tfr_type.len = strlen(csTmp);
		strncpy((char*)hv_tfr_type.arr, csTmp, hv_tfr_type.len);
		ind_tfr_type = 0;
//DEBUGLOG(("AddDetail: tfr_type = [%.*s]\n",hv_tfr_type.len, hv_tfr_type.arr));
	}

	if(GetField_CString(hRls,"tfr_channel",&csTmp)) {
		hv_tfr_channel.len = strlen(csTmp);
		strncpy((char*)hv_tfr_channel.arr, csTmp, hv_tfr_channel.len);
		ind_tfr_channel = 0;
//DEBUGLOG(("AddDetail: tfr_channel = [%.*s]\n",hv_tfr_channel.len, hv_tfr_channel.arr));
	}

	if(GetField_CString(hRls,"tfr_text",&csTmp)) {
		hv_tfr_text.len = strlen(csTmp);
		strncpy((char*)hv_tfr_text.arr, csTmp, hv_tfr_text.len);
		ind_tfr_text = 0;
//DEBUGLOG(("AddDetail: tfr_text = [%.*s]\n",hv_tfr_text.len, hv_tfr_text.arr));
	}

	if(GetField_CString(hRls,"tfr_customer_text",&csTmp)) {
		hv_tfr_customer_text.len = strlen(csTmp);
		strncpy((char*)hv_tfr_customer_text.arr, csTmp, hv_tfr_customer_text.len);
		ind_tfr_customer_text = 0;
//DEBUGLOG(("AddDetail: tfr_customer_text = [%.*s]\n",hv_tfr_customer_text.len, hv_tfr_customer_text.arr));
	}

	if (GetField_CString(hRls,"balance",&csTmp)) {	
		hv_balance = atof(csTmp);
		ind_balance = 0;
//DEBUGLOG(("AddDetail: balance = [%.2f]\n",hv_balance));
	}

	if (GetField_CString(hRls,"amt_type",&csTmp)) {	
		hv_amt_type.len = strlen(csTmp);
		strncpy((char*)hv_amt_type.arr, csTmp, hv_amt_type.len);
		ind_amt_type = 0;
//DEBUGLOG(("AddDetail: amt_type = [%.*s]\n",hv_amt_type.len,hv_amt_type.arr));
	}

	if (GetField_CString(hRls,"txn_amount",&csTmp)) {	
		hv_txn_amount = atof(csTmp);
		ind_txn_amount = 0;
//DEBUGLOG(("AddDetail: txn_amount = [%.2f]\n",hv_txn_amount));
	}

	if(GetField_CString(hRls,"txn_ccy",&csTmp)) {
		hv_txn_ccy.len = strlen(csTmp);
		strncpy((char*)hv_txn_ccy.arr, csTmp, hv_txn_ccy.len);
		ind_txn_ccy = 0;
//DEBUGLOG(("AddDetail: txn_ccy = [%.*s]\n",hv_txn_ccy.len, hv_txn_ccy.arr));
	}

	if(GetField_CString(hRls,"create_user",&csTmp)) {
		hv_create_user.len = strlen(csTmp);
		strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
//DEBUGLOG(("AddDetail: create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));
	}

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_statement_detail_insert(
						:hv_filename:ind_filename,
						:hv_int_bank_code:ind_int_bank_code,
						:hv_bank_acct_num:ind_bank_acct_num,
						:hv_statement_seq:ind_statement_seq,
						:hv_txn_id:ind_txn_id,
						:hv_sms_txn_id:ind_sms_txn_id,
						:hv_status:ind_status,
						:hv_statement_date:ind_statement_date,
						:hv_statement_date_t:ind_statement_date_t,
						:hv_statement_time:ind_statement_time,
						:hv_statement_time_t:ind_statement_time_t,
						:hv_tfr_bank_name:ind_tfr_bank_name,
						:hv_tfr_bank_acct_num:ind_tfr_bank_acct_num,
						:hv_tfr_type:ind_tfr_type,
						:hv_tfr_channel:ind_tfr_channel,
						:hv_tfr_text:ind_tfr_text,
						:hv_tfr_customer_text:ind_tfr_customer_text,
						:hv_balance:ind_balance,
						:hv_amt_type:ind_amt_type,
						:hv_txn_amount:ind_txn_amount,
						:hv_txn_ccy:ind_txn_ccy,
						:hv_create_user:ind_create_user); 
		END;
	END-EXEC;

	if (hv_return_value == SP_OK)
	{
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR) {
DEBUGLOG(("AddDetail: Line [%d] SP_OTHER_ERR TxnAbort\n",iCurrLine));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == PD_OUT_OF_DATE) {
DEBUGLOG(("AddDetail: Line [%d] DATE_ERR TxnAbort\n",iCurrLine));
		return PD_ERR;
	}

	if (hv_return_value == PD_OUT_OF_TIME) {
DEBUGLOG(("AddDetail: Line [%d] TIME_ERR TxnAbort\n",iCurrLine));
		return PD_ERR;
	}

	if (hv_return_value == SP_ERR) {
DEBUGLOG(("AddDetail: Line [%d] SP_ERR TxnAbort\n",iCurrLine));
		return PD_ERR;
	}

addetail_error:
DEBUGLOG(("addetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLStatement_AddDetail: SP_INTERNAL_ERR TxnAbort\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}


int GetNextStatementSeq(const char* csFilename,
			const char* csBankAcctNum,
			int* iStatementSeq)
{
	int iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO getnextseq_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_filename[PD_FILENAME_LEN + 1];
		varchar	hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN + 1];
		int	v_statement_seq;

		short	ind_filename = -1;
		short	ind_bank_acct_num = -1;
		short	ind_statement_seq = -1;

	EXEC SQL END DECLARE SECTION;

	hv_filename.len = strlen(csFilename);
	strncpy((char*)hv_filename.arr,csFilename,hv_filename.len);
	ind_filename = 0;
DEBUGLOG(("GetStatementSeq filename = [%.*s]\n",hv_filename.len,hv_filename.arr));

	hv_bank_acct_num.len = strlen(csBankAcctNum);
	strncpy((char*)hv_bank_acct_num.arr,csBankAcctNum,hv_bank_acct_num.len);
	ind_bank_acct_num = 0;
DEBUGLOG(("GetStatementSeq bank_acct_num = [%.*s]\n",hv_bank_acct_num.len,hv_bank_acct_num.arr));

	EXEC SQL	SELECT	NVL(MAX(OLSD_STATEMENT_SEQ),0)+1
			INTO	v_statement_seq:ind_statement_seq
			FROM	OL_STATEMENT_DETAIL
			WHERE	OLSD_FILENAME = :hv_filename:ind_filename
			AND	OLSD_BANK_ACCT_NUM = :hv_bank_acct_num:ind_bank_acct_num;

	if (ind_statement_seq>=0) {
		*iStatementSeq= v_statement_seq;
DEBUGLOG(("GetStatementSeq statement_seq = [%d]\n",*iStatementSeq));
	}

DEBUGLOG(("GetStatementSeq Normal Exit iRet = [%d]\n",iRet));
	return iRet;

getnextseq_error:
DEBUGLOG(("getnextseq_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}

