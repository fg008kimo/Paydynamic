CREATE OR REPLACE FUNCTION sp_ol_statement_status_update (
   in_statement_ref      ol_statement_detail.olsd_statement_ref%TYPE,
   in_txn_id             ol_statement_detail.olsd_txn_id%TYPE,
   in_status             ol_statement_detail.olsd_status%TYPE,
   in_sub_status         ol_statement_detail.olsd_sub_status%TYPE,
   in_type               ol_statement_detail.olsd_type%TYPE,
   in_upload_filename    ol_statement_status_log.sl_upload_filename%TYPE,
   in_remark             ol_statement_status_log.sl_remark%TYPE,
   in_update_user        ol_statement_detail.olsd_update_user%TYPE)
   RETURN NUMBER
IS
   org_filename          ol_statement_detail.olsd_filename%TYPE;
   org_status            ol_statement_detail.olsd_status%TYPE;
   org_sub_status        ol_statement_detail.olsd_sub_status%TYPE;
   org_type              ol_statement_detail.olsd_type%TYPE;
   org_create_user       ol_statement_detail.olsd_create_user%TYPE;
   org_create_datetime   VARCHAR (14);
   iCnt                  INTEGER;
BEGIN
   SELECT olsd_filename,
          olsd_status,
          olsd_sub_status,
          olsd_type,
          olsd_create_user,
          TO_CHAR (olsd_create_timestamp, 'YYYYMMDDHH24MISS')
     INTO org_filename,
          org_status,
          org_sub_status,
          org_type,
          org_create_user,
          org_create_datetime
     FROM ol_statement_detail
    WHERE olsd_statement_ref = in_statement_ref
      AND olsd_status in ('U','S','W','H');

   SELECT COUNT (*)
     INTO iCnt
     FROM ol_statement_status_log
    WHERE sl_statement_ref = in_statement_ref;

   IF iCnt = 0
   THEN
      /* First time log before update */
      INSERT INTO ol_statement_status_log (sl_statement_ref,
                                           sl_status,
                                           sl_sub_status,
                                           sl_type,
                                           sl_upload_filename,
                                           sl_remark,
                                           sl_create_user,
                                           sl_create_timestamp)
           VALUES (in_statement_ref,
                   org_status,
                   org_sub_status,
                   org_type,
                   org_filename,
                   '',
                   org_create_user,
                   TO_DATE (org_create_datetime, 'YYYYMMDDHH24MISS'));

      IF SQL%ROWCOUNT = 0
      THEN
         RETURN 1;
      END IF;
   END IF;

   /* Log and Update */
   INSERT INTO ol_statement_status_log (sl_statement_ref,
                                        sl_status,
                                        sl_sub_status,
                                        sl_type,
                                        sl_upload_filename,
                                        sl_remark,
                                        sl_create_user,
                                        sl_create_timestamp)
        VALUES (in_statement_ref,
                NVL (in_status, org_status),
                NVL (in_sub_status, org_sub_status),
                NVL (in_type, org_type),
                in_upload_filename,
                in_remark,
                in_update_user,
                SYSDATE + 1/86400);

   IF SQL%ROWCOUNT = 0
   THEN
      RETURN 1;
   END IF;

   UPDATE ol_statement_detail
      SET olsd_update_timestamp = SYSDATE + 1/86400,
          olsd_update_user = in_update_user,
          olsd_status = NVL (in_status, olsd_status),
          olsd_sub_status = NVL (in_sub_status, olsd_sub_status),
          olsd_type = NVL (in_type, olsd_type),
          olsd_txn_id = NVL(in_txn_id, olsd_txn_id)
    WHERE olsd_statement_ref = in_statement_ref;

   IF SQL%ROWCOUNT = 0
   THEN
      RETURN 1;
   END IF;

   RETURN 0;
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN 9;
END sp_ol_statement_status_update;
/

