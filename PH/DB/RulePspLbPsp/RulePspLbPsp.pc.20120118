/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/01/12              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "RulePspLbPsp.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char    cDebug;

void RulePspLbPsp(char    cdebug)
{
        cDebug = cdebug;
}


int GetPsp(const char* csPspId,
	hash_t	*myHash)
{

        int     iRet = PD_OK;

        EXEC SQL WHENEVER SQLERROR GOTO getpsp_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_psp_id[PD_PSP_ID_LEN];

		double	v_limit;
		int	v_ratio;
		int	v_priority;
		double	v_guarantee_volume;

		short	ind_limit = -1;	
		short	ind_ratio = -1;
		short	ind_priority = -1;
		short	ind_guarantee_volume = -1;
		
        EXEC SQL END DECLARE SECTION;

/* psp id */
        hv_psp_id.len = strlen(csPspId);
        memcpy(hv_psp_id.arr,csPspId,hv_psp_id.len);
DEBUGLOG(("GetPsp: psp_id = [%.*s]\n",hv_psp_id.len,hv_psp_id.arr));

	EXEC SQL DECLARE c_cursor_getpsp CURSOR FOR
		SELECT  rpp_limit,
          		rpp_ratio,
          		rpp_priority,
          		rpp_guarantee_volume
  		  FROM  rule_psp_lb_psp
 		 WHERE rpp_psp_id = :hv_psp_id
    		   AND rpp_disabled = 0	;

	
        EXEC SQL OPEN c_cursor_getpsp;
        do {
		EXEC SQL FETCH c_cursor_getpsp
                INTO
			:v_limit:ind_limit,
			:v_ratio:ind_ratio,
			:v_priority:ind_priority,
			:v_guarantee_volume:ind_guarantee_volume;

		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

/* limit */
		if (ind_limit >=0 ) {
DEBUGLOG(("GetPsp: limit = [%f]\n",v_limit));
			PutField_Double(myHash,"psp_limit",v_limit);
		}

/* ratio */
		if (ind_ratio >= 0 ) {
DEBUGLOG(("GetPsp: ratio = [%d]\n",v_ratio));
			PutField_Int(myHash,"psp_ratio",v_ratio);
		}
/* priority */
		if (ind_priority >= 0 ) {
DEBUGLOG(("GetPsp: priority = [%d]\n",v_priority));
			PutField_Int(myHash,"psp_priority",v_priority);
		}

/* guarantee_volume */
		if (ind_guarantee_volume >=0 ) {
DEBUGLOG(("GetPsp: guarantee_volume = [%f]\n",v_guarantee_volume));
			PutField_Double(myHash,"guarantee_volume",v_guarantee_volume);
		}

	}
	while (PD_TRUE);

    	EXEC SQL CLOSE c_cursor_getpsp;
	return iRet;

getpsp_error:

DEBUGLOG(("getpsp_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_getpsp;
    return PD_ERR;
}


int GetPspLimit(const char* csId,
                  const char* csServiceCode,
                  const char* csTxnCountry,
                  const char* csTxnCcy,
                  const char* csPayMethod,
                  double *dCurr,
                  double *dTotalCurr)
{

        int     iRet = PD_OK;


        EXEC SQL WHENEVER SQLERROR GOTO getpsppsplimit_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	hv_psp_id[PD_PSP_ID_LEN];
                char    hv_party_type;
                char    hv_counter_type;
                varchar hv_category_type[PD_CATEGORY_LEN];
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
                varchar hv_txn_country[PD_COUNTRY_LEN];
                varchar hv_txn_ccy[PD_CCY_ID_LEN];
                varchar hv_pay_method[PD_PAY_METHOD_LEN];

                double  v_curr;
                double  v_total_curr;

                short   ind_curr = -1;
                short   ind_total_curr = -1;

        EXEC SQL END DECLARE SECTION;

        *dCurr = 0.0;
        *dTotalCurr = 0.0;

/* psp id */
        hv_psp_id.len = strlen(csId);
        strcpy((char*)hv_psp_id.arr,csId);
DEBUGLOG(("GetPspLimit: psp_id = [%.*s]\n",hv_psp_id.len,hv_psp_id.arr));

/* party type */
        hv_party_type = PD_TYPE_PSP;
DEBUGLOG(("GetPspLimit: party_type = [%c]\n",hv_party_type));

/* counter type */
        hv_counter_type = PD_DAILY;
DEBUGLOG(("GetPspLimit: counter_type = [%c]\n",hv_counter_type));

/* category type */
        hv_category_type.len = strlen(PD_VALUE_TYPE_AMT);
        strcpy((char*)hv_category_type.arr,PD_VALUE_TYPE_AMT);
DEBUGLOG(("GetPspLimit: category_type = [%.*s]\n",hv_category_type.len,hv_category_type.arr));

/* service_code */
        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetPspLimit: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/* txn_country */
        hv_txn_country.len = strlen(csTxnCountry);
        memcpy(hv_txn_country.arr,csTxnCountry,hv_txn_country.len);
DEBUGLOG(("GetPspLimit: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));

/* txn_ccy */
        hv_txn_ccy.len = strlen(csTxnCcy);
        memcpy(hv_txn_ccy.arr,csTxnCcy,hv_txn_ccy.len);
DEBUGLOG(("GetPspLimit: txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));

/* pay_method */
        hv_pay_method.len = strlen(csPayMethod);
        memcpy(hv_pay_method.arr,csPayMethod,hv_pay_method.len);
DEBUGLOG(("GetPspLimit: pay_method = [%.*s]\n",hv_pay_method.len,hv_pay_method.arr));


        EXEC SQL DECLARE c_cursor_getpspsplimit CURSOR FOR
                SELECT sum(tc_total_counter),
                       sum(tc_counter)
                  FROM txn_counters
                 WHERE tc_txn_code in ('DSI','DSP')
                   AND tc_country_id = :hv_txn_country
                   AND tc_channel_code in ('WEB','XPY')
                   AND tc_service_code = :hv_service_code
                   AND (tc_pay_method = :hv_pay_method or tc_pay_method = '000')
                   AND tc_type = :hv_counter_type
                   AND tc_category = :hv_category_type
                   AND tc_party_type = :hv_party_type
                   AND TC_PARTY_ID  = :hv_psp_id
                   AND tc_currency_id = :hv_txn_ccy;


        EXEC SQL OPEN c_cursor_getpspsplimit;
        do {
                EXEC SQL FETCH c_cursor_getpspsplimit
                INTO
                        :v_total_curr:ind_total_curr,
                        :v_curr:ind_curr;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
                if (ind_curr >= 0)
                        *dCurr = v_curr;
                if (ind_total_curr >= 0)
                        *dTotalCurr = v_total_curr;
        }
        while(PD_TRUE);

DEBUGLOG(("GetPspLimit limit = [%f]\n",*dCurr));
        EXEC SQL CLOSE c_cursor_getpspsplimit;

        return iRet;


getpsppsplimit_error:
DEBUGLOG(("getpsppoolslimit_erro code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_getpspsplimit;
    return PD_ERR;
}
