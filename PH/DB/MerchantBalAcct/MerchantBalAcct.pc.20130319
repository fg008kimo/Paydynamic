/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/06/07              LokMan Chow
Add UpdateMerchantBalAcctStatus                    2011/09/23              Virginia Yun
Add function Add()			           2012/01/11		   Virginia Yun	
Amend UpdateMerchantBalAcctStatus to support 
	update mb_allow_payout			   2012/06/13	           Virginia Yun
replace mb_allow_payout by mb_txn_type		   2012/10/26		   LokMan Chow
Add auto_sett_min_amt				   2013/03/01		   David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "MerchantBalAcct.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void MerchantBalAcct(char    cdebug)
{
        cDebug = cdebug;
}

int CheckMerchantBalAcct(const char* csMerchantID,
                const char* csCountry,
		const char* csCcy,
		const char* csServiceCode,
		hash_t *hRec)
{
	int iRet = PD_NOT_FOUND;
                
        EXEC SQL WHENEVER SQLERROR GOTO check_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_country[PD_COUNTRY_LEN];
                varchar         hv_ccy[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
		varchar         hv_status[PD_ACCOUNT_STATUS_LEN];
                
		short		v_cnt;
		char		v_txn_type;
		//int		v_allow_payout;

		short		ind_txn_type = -1 ;
        
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("CheckMerchantBalAcct merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_country.len = strlen(csCountry);
        memcpy(hv_country.arr,csCountry,hv_country.len);
DEBUGLOG(("CheckMerchantBalAcct country = [%.*s]\n",hv_country.len,hv_country.arr));

        hv_ccy.len = strlen(csCcy);
        memcpy(hv_ccy.arr,csCcy,hv_ccy.len);
DEBUGLOG(("CheckMerchantBalAcct ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("CheckMerchantBalAcct service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
        
	hv_status.len = strlen(PD_ACC_OPEN);
        memcpy(hv_status.arr,PD_ACC_OPEN,hv_status.len);

        EXEC SQL SELECT	nvl(COUNT(*),0)
		   INTO :v_cnt
                   FROM merchant_bal_acct
                  WHERE mb_merchant_id = :hv_merchant_id
                    AND mb_country = :hv_country
                    AND mb_ccy_id = :hv_ccy
		    AND mb_service_code = :hv_service_code
                    AND mb_disabled = 0
		    AND mb_status = :hv_status;


	if (v_cnt > 0){
		iRet = PD_FOUND;
DEBUGLOG(("CheckMerchantBalAcct  found! [%d]\n",v_cnt));

		EXEC SQL SELECT mb_txn_type
			INTO :v_txn_type:ind_txn_type
			FROM merchant_bal_acct
		       WHERE mb_merchant_id = :hv_merchant_id
			 AND mb_country = :hv_country
			 AND mb_ccy_id = :hv_ccy
			 AND mb_service_code = :hv_service_code
			 AND mb_disabled = 0
			 AND mb_status = :hv_status;

		if(ind_txn_type>=0){
DEBUGLOG(("CheckMerchantBalAcct txn_type=[%c]\n",v_txn_type));
			if((v_txn_type == PD_TYPE_ALL) || (v_txn_type == PD_TYPE_PAYOUT)){
				PutField_Int(hRec,"allow_payout",PD_TRUE);
DEBUGLOG(("CheckMerchantBalAcct allow_payout=[%d]\n",PD_TRUE));
			}
			else{
				PutField_Int(hRec,"allow_payout",PD_FALSE);
DEBUGLOG(("CheckMerchantBalAcct allow_payout=[%d]\n",PD_FALSE));
			}
		}
		else{
			PutField_Int(hRec,"allow_payout",PD_FALSE);
		}
	}
	else {
DEBUGLOG(("CheckMerchantBalAcct Not found! [%d]\n",v_cnt));
	}
	

DEBUGLOG(("CheckMerchantBalAcct Normal Exit [%d]\n",iRet));
	return iRet;

check_error:
DEBUGLOG(("check_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}



int UpdateMerchantBalAcctStatus(const hash_t *hRls)
{
        char*     csTmp;

	//int	  iTmp;
	char*	  csBuf;

        char*     csMerchantId;
        char*     csCountry;
        char*     csCcyId;
        char*     csServiceCode;
	char	  cTmp;
	double	  dTmp;

        EXEC SQL WHENEVER SQLERROR GOTO updatestatus_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                varchar        hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

	csBuf = (char *) malloc(128);

DEBUGLOG(("UpdateMerchantBalAcctStatus: Begin\n"));

        strcpy((char*)hv_dynstmt.arr,"update merchant_bal_acct set mb_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"merchant_id",&csMerchantId);
DEBUGLOG(("UpdateMerchantBalAcctStatus: merchant_id = [%s]\n", csMerchantId));

        GetField_CString(hRls,"country",&csCountry);
DEBUGLOG(("UpdateMerchantBalAcctStatus: country = [%s]\n", csCountry));

        GetField_CString(hRls,"ccy",&csCcyId);
DEBUGLOG(("UpdateMerchantBalAcctStatus: ccy = [%s]\n", csCcyId));

        GetField_CString(hRls,"service",&csServiceCode);
DEBUGLOG(("UpdateMerchantBalAcctStatus: service = [%s]\n", csServiceCode));

/*status */
        if (GetField_CString(hRls,"status",&csTmp)) {
DEBUGLOG(("UpdateMerchantBalAcctStatus:status = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mb_status = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* txn_type */
        if (GetField_Char(hRls,"txn_type",&cTmp)) {
DEBUGLOG(("UpdateMerchantBalAcctStatus:txn_type = [%c]\n",cTmp));
		sprintf(csBuf, "%c", cTmp);
		strcat((char*)hv_dynstmt.arr, ",mb_txn_type= '");
		strcat((char*)hv_dynstmt.arr, csBuf);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* auto_sett_min_amt */
	if (GetField_Double(hRls,"auto_sett_min_amt",&dTmp)) {
DEBUGLOG(("UpdateMerchantBalAcctStatus:auto_sett_min_amt = [%f]\n",dTmp));
		sprintf(csBuf, "%f", dTmp);
		strcat((char*)hv_dynstmt.arr, ",mb_auto_sett_min_amt= ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/*update_user*/
        if(GetField_CString(hRls,"update_user",&csTmp)){
DEBUGLOG(("UpdateMerchantBalAcctStatus:update_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mb_update_user= '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        strcat((char *)hv_dynstmt.arr, " WHERE mb_merchant_id = '");
        strcat((char *)hv_dynstmt.arr, csMerchantId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND mb_country = '");
        strcat((char *)hv_dynstmt.arr, csCountry);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND mb_ccy_id = '");
        strcat((char *)hv_dynstmt.arr, csCcyId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND mb_service_code = '");
        strcat((char *)hv_dynstmt.arr, csServiceCode);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);

DEBUGLOG(("Update Normal Exit\n"));
        return PD_OK;

updatestatus_error:
DEBUGLOG(("updatestatus_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("MerantantBalAcct_UpdateMerchantBalAcctStatus: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("UpdateMerchantBalAcctStatus: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;

}

int Add(const hash_t *hMerchantBalAcct)
{
	char *csTmp;
	char iTmp;
	char	cTmp;
	double dTmp;

        EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar		hv_country[PD_COUNTRY_LEN];
                varchar         hv_ccy[PD_CCY_ID_LEN];
		int		hv_disabled;
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
		varchar         hv_status[PD_ACCOUNT_STATUS_LEN];
		//int		hv_allow_payout;
		varchar		hv_create_user[PD_USER_LEN];
		char		hv_txn_type;
		double		hv_auto_sett_min_amt;

		short		ind_merchant_id = -1;
		short		ind_country = -1;
		short		ind_ccy = -1;
		short		ind_disabled = -1;
		short		ind_service_code = -1;
		short		ind_status = -1;
		//short		ind_allow_payout = -1;
		short		ind_create_user = -1;
		short		ind_txn_type = -1;
		short		ind_auto_sett_min_amt = -1;

		short		hv_return_value;
        EXEC SQL END DECLARE SECTION;


        DEBUGLOG(("Add: Begin\n"));

        if(GetField_CString(hMerchantBalAcct,"merchant_id",&csTmp))
        {
                hv_merchant_id.len = strlen(csTmp);
                strncpy((char *)hv_merchant_id.arr, csTmp, hv_merchant_id.len);
                ind_merchant_id = 0;
        }
DEBUGLOG(("Add:merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	if (GetField_CString(hMerchantBalAcct, "country",&csTmp))
	{
		hv_country.len = strlen(csTmp);
		strncpy((char *)hv_country.arr, csTmp, hv_country.len);
		ind_country = 0;
	}
DEBUGLOG(("Add:country = [%.*s]\n",hv_country.len,hv_country.arr));

        if (GetField_CString(hMerchantBalAcct, "ccy",&csTmp))
        {
                hv_ccy.len = strlen(csTmp);
                strncpy((char *)hv_ccy.arr, csTmp, hv_ccy.len);
                ind_ccy = 0;
        }
DEBUGLOG(("Add:ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));

        if (GetField_Int(hMerchantBalAcct,"disabled", &iTmp))
        {
                hv_disabled = iTmp;
                ind_disabled = 0;
        }
DEBUGLOG(("Add:disabled = [%d]\n",hv_disabled));

        if (GetField_CString(hMerchantBalAcct, "service_code",&csTmp))
        {
                hv_service_code.len = strlen(csTmp);
                strncpy((char *)hv_service_code.arr, csTmp, hv_service_code.len);
                ind_service_code = 0;
        }
DEBUGLOG(("Add:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        if (GetField_CString(hMerchantBalAcct, "status",&csTmp))
        {
                hv_status.len = strlen(csTmp);
                strncpy((char *)hv_status.arr, csTmp, hv_status.len);
                ind_status= 0;
        }
DEBUGLOG(("Add:status = [%.*s]\n",hv_status.len,hv_status.arr));
	
        if (GetField_Char(hMerchantBalAcct,"txn_type", &cTmp))
        {
                hv_txn_type= cTmp;
                ind_txn_type= 0;
        }
DEBUGLOG(("Add:txn_type = [%c]\n",hv_txn_type));	

	if (GetField_Double(hMerchantBalAcct,"auto_sett_min_amt",&dTmp))
	{
		hv_auto_sett_min_amt = dTmp;
		ind_auto_sett_min_amt = 0;
	}
DEBUGLOG(("Add:auto_sett_min_amt = [%lf]\n",hv_auto_sett_min_amt));

        if(GetField_CString(hMerchantBalAcct,"create_user",&csTmp))
        {
                hv_create_user.len = strlen(csTmp);
                strncpy((char *)hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
        }
DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));

        EXEC SQL EXECUTE
            BEGIN

                :hv_return_value := sp_merchant_bal_acct_insert(
                                :hv_merchant_id:ind_merchant_id,
				:hv_country:ind_country,
                                :hv_ccy:ind_ccy,
                                :hv_disabled:ind_disabled,
                                :hv_service_code:ind_service_code,
                                :hv_status:ind_status, 
				:hv_txn_type:ind_txn_type,
				:hv_auto_sett_min_amt:ind_auto_sett_min_amt,
                                :hv_create_user:ind_create_user);
            END;
        END-EXEC;

        DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
                DEBUGLOG(("Add:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
                ERRLOG("MerchDetail_Add: SP_OTHER_ERR TxnAbort\n");
                DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
                ERRLOG("MerchDetail_Add: SP_ERR TxnAbort\n");
                DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
                return PD_ERR;
        }

add_error:
        DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
        DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}
