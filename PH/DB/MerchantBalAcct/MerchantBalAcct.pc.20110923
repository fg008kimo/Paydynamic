/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/06/07              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "MerchantBalAcct.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void MerchantBalAcct(char    cdebug)
{
        cDebug = cdebug;
}

int CheckMerchantBalAcct(const char* csMerchantID,
                const char* csCountry,
		const char* csCcy,
		const char* csServiceCode,
		hash_t *hRec)
{
	int iRet = PD_NOT_FOUND;
                
        EXEC SQL WHENEVER SQLERROR GOTO check_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_country[PD_COUNTRY_LEN];
                varchar         hv_ccy[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
		varchar         hv_status[PD_ACCOUNT_STATUS_LEN];
                
		short		v_cnt;
		char		v_allow_payout;

		short		ind_allow_payout = -1 ;
        
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("CheckMerchantBalAcct merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_country.len = strlen(csCountry);
        memcpy(hv_country.arr,csCountry,hv_country.len);
DEBUGLOG(("CheckMerchantBalAcct country = [%.*s]\n",hv_country.len,hv_country.arr));

        hv_ccy.len = strlen(csCcy);
        memcpy(hv_ccy.arr,csCcy,hv_ccy.len);
DEBUGLOG(("CheckMerchantBalAcct ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("CheckMerchantBalAcct service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
        
	hv_status.len = strlen(PD_ACC_OPEN);
        memcpy(hv_status.arr,PD_ACC_OPEN,hv_status.len);

        EXEC SQL SELECT	nvl(COUNT(*),0)
		   INTO :v_cnt
                   FROM merchant_bal_acct
                  WHERE mb_merchant_id = :hv_merchant_id
                    AND mb_country = :hv_country
                    AND mb_ccy_id = :hv_ccy
		    AND mb_service_code = :hv_service_code
                    AND mb_disabled = 0
		    AND mb_status = :hv_status;


	if (v_cnt > 0){
		iRet = PD_FOUND;
DEBUGLOG(("CheckMerchantBalAcct  found! [%d]\n",v_cnt));

		EXEC SQL SELECT mb_allow_payout
			INTO :v_allow_payout:ind_allow_payout
			FROM merchant_bal_acct
		       WHERE mb_merchant_id = :hv_merchant_id
			 AND mb_country = :hv_country
			 AND mb_ccy_id = :hv_ccy
			 AND mb_service_code = :hv_service_code
			 AND mb_disabled = 0
			 AND mb_status = :hv_status;

		if(ind_allow_payout>=0){
			PutField_Char(hRec,"allow_payout",v_allow_payout);
DEBUGLOG(("CheckMerchantBalAcct allow_payout=[%c]\n",v_allow_payout));
		}
		else{
			PutField_Char(hRec,"allow_payout",'N');
		}
	}
	else {
DEBUGLOG(("CheckMerchantBalAcct Not found! [%d]\n",v_cnt));
	}
	

DEBUGLOG(("CheckMerchantBalAcct Normal Exit [%d]\n",iRet));
	return iRet;

check_error:
DEBUGLOG(("check_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

