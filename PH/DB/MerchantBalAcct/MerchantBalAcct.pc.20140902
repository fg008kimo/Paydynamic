
/* Result Sets Interface */
#ifndef SQL_CRSR
#  define SQL_CRSR
  struct sql_cursor
  {
    unsigned int curocn;
    void *ptr1;
    void *ptr2;
    unsigned int magic;
  };
  typedef struct sql_cursor sql_cursor;
  typedef struct sql_cursor SQL_CURSOR;
#endif /* SQL_CRSR */

/* Thread Safety */
typedef void * sql_context;
typedef void * SQL_CONTEXT;

/* Object support */
struct sqltvn
{
  unsigned char *tvnvsn; 
  unsigned short tvnvsnl; 
  unsigned char *tvnnm;
  unsigned short tvnnml; 
  unsigned char *tvnsnm;
  unsigned short tvnsnml;
};
typedef struct sqltvn sqltvn;

struct sqladts
{
  unsigned int adtvsn; 
  unsigned short adtmode; 
  unsigned short adtnum;  
  sqltvn adttvn[1];       
};
typedef struct sqladts sqladts;

static struct sqladts sqladt = {
  1,1,0,
};

/* Binding to PL/SQL Records */
struct sqltdss
{
  unsigned int tdsvsn; 
  unsigned short tdsnum; 
  unsigned char *tdsval[1]; 
};
typedef struct sqltdss sqltdss;
static struct sqltdss sqltds =
{
  1,
  0,
};

/* File name & Package Name */
struct sqlcxp
{
  unsigned short fillen;
           char  filnam[19];
};
static struct sqlcxp sqlfpn =
{
    18,
    "MerchantBalAcct.pc"
};


static unsigned int sqlctx = 19569675;


static struct sqlexd {
   unsigned long  sqlvsn;
   unsigned int   arrsiz;
   unsigned int   iters;
   unsigned int   offset;
   unsigned short selerr;
   unsigned short sqlety;
   unsigned int   occurs;
            short *cud;
   unsigned char  *sqlest;
            char  *stmt;
   sqladts *sqladtp;
   sqltdss *sqltdsp;
   unsigned char  **sqphsv;
   unsigned long  *sqphsl;
            int   *sqphss;
            short **sqpind;
            int   *sqpins;
   unsigned long  *sqparm;
   unsigned long  **sqparc;
   unsigned short  *sqpadto;
   unsigned short  *sqptdso;
   unsigned int   sqlcmax;
   unsigned int   sqlcmin;
   unsigned int   sqlcincr;
   unsigned int   sqlctimeout;
   unsigned int   sqlcnowait;
            int   sqfoff;
   unsigned int   sqcmod;
   unsigned int   sqfmod;
   unsigned char  *sqhstv[15];
   unsigned long  sqhstl[15];
            int   sqhsts[15];
            short *sqindv[15];
            int   sqinds[15];
   unsigned long  sqharm[15];
   unsigned long  *sqharc[15];
   unsigned short  sqadto[15];
   unsigned short  sqtdso[15];
} sqlstm = {12,15};

/* SQLLIB Prototypes */
extern sqlcxt ( void **, unsigned int *,
                   struct sqlexd *, struct sqlcxp * );
extern sqlcx2t( void **, unsigned int *,
                   struct sqlexd *, struct sqlcxp * );
extern sqlbuft( void **, char * );
extern sqlgs2t( void **, char * );
extern sqlorat( void **, unsigned int *, void * );

/* Forms Interface */
static int IAPSUCC = 0;
static int IAPFAIL = 1403;
static int IAPFTL  = 535;
extern void sqliem( unsigned char *, signed int * );

typedef struct { unsigned short len; unsigned char arr[1]; } VARCHAR;
typedef struct { unsigned short len; unsigned char arr[1]; } varchar;

/* CUD (Compilation Unit Data) Array */
static short sqlcud0[] =
{12,4130,871,0,0,
5,0,0,1,197,0,4,99,0,0,6,5,0,1,0,2,3,0,0,1,9,0,0,1,9,0,0,1,9,0,0,1,9,0,0,1,9,0,
0,
44,0,0,2,401,0,4,114,0,0,12,5,0,1,0,2,1,0,0,2,3,0,0,2,9,0,0,2,9,0,0,2,4,0,0,2,
3,0,0,2,3,0,0,1,9,0,0,1,9,0,0,1,9,0,0,1,9,0,0,1,9,0,0,
107,0,0,3,0,0,17,363,0,0,1,1,0,1,0,1,9,0,0,
126,0,0,3,0,0,21,364,0,0,0,0,0,1,0,
141,0,0,3,0,0,17,471,0,0,1,1,0,1,0,1,9,0,0,
160,0,0,3,0,0,21,472,0,0,0,0,0,1,0,
175,0,0,4,586,0,6,642,0,0,15,15,0,1,0,2,3,0,0,1,9,0,0,1,9,0,0,1,9,0,0,1,3,0,0,
1,9,0,0,1,9,0,0,1,1,0,0,1,3,0,0,1,9,0,0,1,9,0,0,1,4,0,0,1,3,0,0,1,3,0,0,1,9,0,
0,
250,0,0,5,198,0,4,757,0,0,6,4,0,1,0,2,3,0,0,2,3,0,0,1,9,0,0,1,9,0,0,1,9,0,0,1,
9,0,0,
289,0,0,6,82,0,4,778,0,0,1,0,0,1,0,2,3,0,0,
308,0,0,7,198,0,4,841,0,0,6,5,0,1,0,2,9,0,0,1,9,0,0,1,9,0,0,1,9,0,0,1,9,0,0,1,
9,0,0,
};


/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/06/07              LokMan Chow
Add UpdateMerchantBalAcctStatus                    2011/09/23              Virginia Yun
Add function Add()			           2012/01/11		   Virginia Yun	
Amend UpdateMerchantBalAcctStatus to support 
	update mb_allow_payout			   2012/06/13	           Virginia Yun
replace mb_allow_payout by mb_txn_type		   2012/10/26		   LokMan Chow
Add support_delta_amt				   2013/03/19		   David Wong
Add support_delta_amt				   2013/04/16		   Stan Poon
Add preferred_settle_ccy & avai_po %		   2013/05/27		   LokMan Chow
Add support_auto_sett and mb_auto_sett_id          2013/05/30              Stan Poon
Add min_settle_amt				   2013/08/06		   Stan Poon
Add preferred_acr_pool				   2014/03/26		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "MerchantBalAcct.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void MerchantBalAcct(char    cdebug)
{
        cDebug = cdebug;
}

int CheckMerchantBalAcct(const char* csMerchantID,
                const char* csCountry,
		const char* csCcy,
		const char* csServiceCode,
		hash_t *hRec)
{
	int iRet = PD_NOT_FOUND;
                
        /* EXEC SQL WHENEVER SQLERROR GOTO check_error; */ 

        /* EXEC SQL WHENEVER NOTFOUND CONTINUE; */ 

                        
        /* EXEC SQL BEGIN DECLARE SECTION; */ 

                /* varchar         hv_merchant_id[PD_MERCHANT_ID_LEN]; */ 
struct { unsigned short len; unsigned char arr[15]; } hv_merchant_id;

                /* varchar         hv_country[PD_COUNTRY_LEN]; */ 
struct { unsigned short len; unsigned char arr[2]; } hv_country;

                /* varchar         hv_ccy[PD_CCY_ID_LEN]; */ 
struct { unsigned short len; unsigned char arr[3]; } hv_ccy;

                /* varchar         hv_service_code[PD_SERVICE_CODE_LEN]; */ 
struct { unsigned short len; unsigned char arr[3]; } hv_service_code;

		/* varchar         hv_status[PD_ACCOUNT_STATUS_LEN]; */ 
struct { unsigned short len; unsigned char arr[2]; } hv_status;

                
		short		v_cnt;
		char		v_txn_type;
		//int		v_allow_payout;
		int		v_support_delta_amt;
                /* varchar         v_preferred_settle_ccy[PD_CCY_ID_LEN+1]; */ 
struct { unsigned short len; unsigned char arr[4]; } v_preferred_settle_ccy;

                /* varchar         v_preferred_acr_pool[PD_CCY_ID_LEN+1]; */ 
struct { unsigned short len; unsigned char arr[4]; } v_preferred_acr_pool;

		double		v_min_settle_amt;
		int		v_min_settle_amt_applytoadmin;
		int		v_avai_po_percentage;

		short		ind_txn_type = -1 ;
		short		ind_support_delta_amt = -1;
		short		ind_preferred_settle_ccy = -1;
		short		ind_preferred_acr_pool= -1;
		short		ind_min_settle_amt = -1;
		short		ind_minsetamt_applytoadmin = -1;
		short		ind_avai_po_percentage = -1;
        
        
        /* EXEC SQL END DECLARE SECTION; */ 

        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("CheckMerchantBalAcct merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_country.len = strlen(csCountry);
        memcpy(hv_country.arr,csCountry,hv_country.len);
DEBUGLOG(("CheckMerchantBalAcct country = [%.*s]\n",hv_country.len,hv_country.arr));

        hv_ccy.len = strlen(csCcy);
        memcpy(hv_ccy.arr,csCcy,hv_ccy.len);
DEBUGLOG(("CheckMerchantBalAcct ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("CheckMerchantBalAcct service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
        
	hv_status.len = strlen(PD_ACC_OPEN);
        memcpy(hv_status.arr,PD_ACC_OPEN,hv_status.len);

        /* EXEC SQL SELECT	nvl(COUNT(*),0)
		   INTO :v_cnt
                   FROM merchant_bal_acct
                  WHERE mb_merchant_id = :hv_merchant_id
                    AND mb_country = :hv_country
                    AND mb_ccy_id = :hv_ccy
		    AND mb_service_code = :hv_service_code
                    AND mb_disabled = 0
		    AND mb_status = :hv_status; */ 

{
        struct sqlexd sqlstm;
        sqlstm.sqlvsn = 12;
        sqlstm.arrsiz = 6;
        sqlstm.sqladtp = &sqladt;
        sqlstm.sqltdsp = &sqltds;
        sqlstm.stmt = "select nvl ( COUNT ( * ) , 0 ) INTO :b0 FROM merchan\
t_bal_acct WHERE mb_merchant_id = :b1 AND mb_country = :b2 AND mb_ccy_id = :b\
3 AND mb_service_code = :b4 AND mb_disabled = 0 AND mb_status = :b5 ";
        sqlstm.iters = (unsigned int  )1;
        sqlstm.offset = (unsigned int  )5;
        sqlstm.selerr = (unsigned short)1;
        sqlstm.cud = sqlcud0;
        sqlstm.sqlest = (unsigned char  *)&sqlca;
        sqlstm.sqlety = (unsigned short)4352;
        sqlstm.occurs = (unsigned int  )0;
        sqlstm.sqhstv[0] = (unsigned char  *)&v_cnt;
        sqlstm.sqhstl[0] = (unsigned long )sizeof(short);
        sqlstm.sqhsts[0] = (         int  )0;
        sqlstm.sqindv[0] = (         short *)0;
        sqlstm.sqinds[0] = (         int  )0;
        sqlstm.sqharm[0] = (unsigned long )0;
        sqlstm.sqadto[0] = (unsigned short )0;
        sqlstm.sqtdso[0] = (unsigned short )0;
        sqlstm.sqhstv[1] = (unsigned char  *)&hv_merchant_id;
        sqlstm.sqhstl[1] = (unsigned long )17;
        sqlstm.sqhsts[1] = (         int  )0;
        sqlstm.sqindv[1] = (         short *)0;
        sqlstm.sqinds[1] = (         int  )0;
        sqlstm.sqharm[1] = (unsigned long )0;
        sqlstm.sqadto[1] = (unsigned short )0;
        sqlstm.sqtdso[1] = (unsigned short )0;
        sqlstm.sqhstv[2] = (unsigned char  *)&hv_country;
        sqlstm.sqhstl[2] = (unsigned long )4;
        sqlstm.sqhsts[2] = (         int  )0;
        sqlstm.sqindv[2] = (         short *)0;
        sqlstm.sqinds[2] = (         int  )0;
        sqlstm.sqharm[2] = (unsigned long )0;
        sqlstm.sqadto[2] = (unsigned short )0;
        sqlstm.sqtdso[2] = (unsigned short )0;
        sqlstm.sqhstv[3] = (unsigned char  *)&hv_ccy;
        sqlstm.sqhstl[3] = (unsigned long )5;
        sqlstm.sqhsts[3] = (         int  )0;
        sqlstm.sqindv[3] = (         short *)0;
        sqlstm.sqinds[3] = (         int  )0;
        sqlstm.sqharm[3] = (unsigned long )0;
        sqlstm.sqadto[3] = (unsigned short )0;
        sqlstm.sqtdso[3] = (unsigned short )0;
        sqlstm.sqhstv[4] = (unsigned char  *)&hv_service_code;
        sqlstm.sqhstl[4] = (unsigned long )5;
        sqlstm.sqhsts[4] = (         int  )0;
        sqlstm.sqindv[4] = (         short *)0;
        sqlstm.sqinds[4] = (         int  )0;
        sqlstm.sqharm[4] = (unsigned long )0;
        sqlstm.sqadto[4] = (unsigned short )0;
        sqlstm.sqtdso[4] = (unsigned short )0;
        sqlstm.sqhstv[5] = (unsigned char  *)&hv_status;
        sqlstm.sqhstl[5] = (unsigned long )4;
        sqlstm.sqhsts[5] = (         int  )0;
        sqlstm.sqindv[5] = (         short *)0;
        sqlstm.sqinds[5] = (         int  )0;
        sqlstm.sqharm[5] = (unsigned long )0;
        sqlstm.sqadto[5] = (unsigned short )0;
        sqlstm.sqtdso[5] = (unsigned short )0;
        sqlstm.sqphsv = sqlstm.sqhstv;
        sqlstm.sqphsl = sqlstm.sqhstl;
        sqlstm.sqphss = sqlstm.sqhsts;
        sqlstm.sqpind = sqlstm.sqindv;
        sqlstm.sqpins = sqlstm.sqinds;
        sqlstm.sqparm = sqlstm.sqharm;
        sqlstm.sqparc = sqlstm.sqharc;
        sqlstm.sqpadto = sqlstm.sqadto;
        sqlstm.sqptdso = sqlstm.sqtdso;
        sqlcxt((void **)0, &sqlctx, &sqlstm, &sqlfpn);
        if (sqlca.sqlcode < 0) goto check_error;
}




	if (v_cnt > 0){
		iRet = PD_FOUND;
DEBUGLOG(("CheckMerchantBalAcct  found! [%d]\n",v_cnt));

		/* EXEC SQL SELECT mb_txn_type,
				mb_support_delta_amt,
				mb_preferred_settle_ccy,
				mb_preferred_acr_pool,
				mb_min_settle_amt,
				mb_min_settle_amt_applytoadmin,
				mb_avai_po_percentage
			INTO :v_txn_type:ind_txn_type,
			     :v_support_delta_amt:ind_support_delta_amt,
			     :v_preferred_settle_ccy:ind_preferred_settle_ccy,
			     :v_preferred_acr_pool:ind_preferred_acr_pool,
			     :v_min_settle_amt:ind_min_settle_amt,
			     :v_min_settle_amt_applytoadmin:ind_minsetamt_applytoadmin,
			     :v_avai_po_percentage:ind_avai_po_percentage
			FROM merchant_bal_acct
		       WHERE mb_merchant_id = :hv_merchant_id
			 AND mb_country = :hv_country
			 AND mb_ccy_id = :hv_ccy
			 AND mb_service_code = :hv_service_code
			 AND mb_disabled = 0
			 AND mb_status = :hv_status; */ 

{
  struct sqlexd sqlstm;
  sqlstm.sqlvsn = 12;
  sqlstm.arrsiz = 12;
  sqlstm.sqladtp = &sqladt;
  sqlstm.sqltdsp = &sqltds;
  sqlstm.stmt = "select mb_txn_type , mb_support_delta_amt , mb_preferred_s\
ettle_ccy , mb_preferred_acr_pool , mb_min_settle_amt , mb_min_settle_amt_app\
lytoadmin , mb_avai_po_percentage INTO :b0:b1 , :b2:b3 , :b4:b5 , :b6:b7 , :b\
8:b9 , :b10:b11 , :b12:b13 FROM merchant_bal_acct WHERE mb_merchant_id = :b14\
 AND mb_country = :b15 AND mb_ccy_id = :b16 AND mb_service_code = :b17 AND mb\
_disabled = 0 AND mb_status = :b18 ";
  sqlstm.iters = (unsigned int  )1;
  sqlstm.offset = (unsigned int  )44;
  sqlstm.selerr = (unsigned short)1;
  sqlstm.cud = sqlcud0;
  sqlstm.sqlest = (unsigned char  *)&sqlca;
  sqlstm.sqlety = (unsigned short)4352;
  sqlstm.occurs = (unsigned int  )0;
  sqlstm.sqhstv[0] = (unsigned char  *)&v_txn_type;
  sqlstm.sqhstl[0] = (unsigned long )1;
  sqlstm.sqhsts[0] = (         int  )0;
  sqlstm.sqindv[0] = (         short *)&ind_txn_type;
  sqlstm.sqinds[0] = (         int  )0;
  sqlstm.sqharm[0] = (unsigned long )0;
  sqlstm.sqadto[0] = (unsigned short )0;
  sqlstm.sqtdso[0] = (unsigned short )0;
  sqlstm.sqhstv[1] = (unsigned char  *)&v_support_delta_amt;
  sqlstm.sqhstl[1] = (unsigned long )sizeof(int);
  sqlstm.sqhsts[1] = (         int  )0;
  sqlstm.sqindv[1] = (         short *)&ind_support_delta_amt;
  sqlstm.sqinds[1] = (         int  )0;
  sqlstm.sqharm[1] = (unsigned long )0;
  sqlstm.sqadto[1] = (unsigned short )0;
  sqlstm.sqtdso[1] = (unsigned short )0;
  sqlstm.sqhstv[2] = (unsigned char  *)&v_preferred_settle_ccy;
  sqlstm.sqhstl[2] = (unsigned long )6;
  sqlstm.sqhsts[2] = (         int  )0;
  sqlstm.sqindv[2] = (         short *)&ind_preferred_settle_ccy;
  sqlstm.sqinds[2] = (         int  )0;
  sqlstm.sqharm[2] = (unsigned long )0;
  sqlstm.sqadto[2] = (unsigned short )0;
  sqlstm.sqtdso[2] = (unsigned short )0;
  sqlstm.sqhstv[3] = (unsigned char  *)&v_preferred_acr_pool;
  sqlstm.sqhstl[3] = (unsigned long )6;
  sqlstm.sqhsts[3] = (         int  )0;
  sqlstm.sqindv[3] = (         short *)&ind_preferred_acr_pool;
  sqlstm.sqinds[3] = (         int  )0;
  sqlstm.sqharm[3] = (unsigned long )0;
  sqlstm.sqadto[3] = (unsigned short )0;
  sqlstm.sqtdso[3] = (unsigned short )0;
  sqlstm.sqhstv[4] = (unsigned char  *)&v_min_settle_amt;
  sqlstm.sqhstl[4] = (unsigned long )sizeof(double);
  sqlstm.sqhsts[4] = (         int  )0;
  sqlstm.sqindv[4] = (         short *)&ind_min_settle_amt;
  sqlstm.sqinds[4] = (         int  )0;
  sqlstm.sqharm[4] = (unsigned long )0;
  sqlstm.sqadto[4] = (unsigned short )0;
  sqlstm.sqtdso[4] = (unsigned short )0;
  sqlstm.sqhstv[5] = (unsigned char  *)&v_min_settle_amt_applytoadmin;
  sqlstm.sqhstl[5] = (unsigned long )sizeof(int);
  sqlstm.sqhsts[5] = (         int  )0;
  sqlstm.sqindv[5] = (         short *)&ind_minsetamt_applytoadmin;
  sqlstm.sqinds[5] = (         int  )0;
  sqlstm.sqharm[5] = (unsigned long )0;
  sqlstm.sqadto[5] = (unsigned short )0;
  sqlstm.sqtdso[5] = (unsigned short )0;
  sqlstm.sqhstv[6] = (unsigned char  *)&v_avai_po_percentage;
  sqlstm.sqhstl[6] = (unsigned long )sizeof(int);
  sqlstm.sqhsts[6] = (         int  )0;
  sqlstm.sqindv[6] = (         short *)&ind_avai_po_percentage;
  sqlstm.sqinds[6] = (         int  )0;
  sqlstm.sqharm[6] = (unsigned long )0;
  sqlstm.sqadto[6] = (unsigned short )0;
  sqlstm.sqtdso[6] = (unsigned short )0;
  sqlstm.sqhstv[7] = (unsigned char  *)&hv_merchant_id;
  sqlstm.sqhstl[7] = (unsigned long )17;
  sqlstm.sqhsts[7] = (         int  )0;
  sqlstm.sqindv[7] = (         short *)0;
  sqlstm.sqinds[7] = (         int  )0;
  sqlstm.sqharm[7] = (unsigned long )0;
  sqlstm.sqadto[7] = (unsigned short )0;
  sqlstm.sqtdso[7] = (unsigned short )0;
  sqlstm.sqhstv[8] = (unsigned char  *)&hv_country;
  sqlstm.sqhstl[8] = (unsigned long )4;
  sqlstm.sqhsts[8] = (         int  )0;
  sqlstm.sqindv[8] = (         short *)0;
  sqlstm.sqinds[8] = (         int  )0;
  sqlstm.sqharm[8] = (unsigned long )0;
  sqlstm.sqadto[8] = (unsigned short )0;
  sqlstm.sqtdso[8] = (unsigned short )0;
  sqlstm.sqhstv[9] = (unsigned char  *)&hv_ccy;
  sqlstm.sqhstl[9] = (unsigned long )5;
  sqlstm.sqhsts[9] = (         int  )0;
  sqlstm.sqindv[9] = (         short *)0;
  sqlstm.sqinds[9] = (         int  )0;
  sqlstm.sqharm[9] = (unsigned long )0;
  sqlstm.sqadto[9] = (unsigned short )0;
  sqlstm.sqtdso[9] = (unsigned short )0;
  sqlstm.sqhstv[10] = (unsigned char  *)&hv_service_code;
  sqlstm.sqhstl[10] = (unsigned long )5;
  sqlstm.sqhsts[10] = (         int  )0;
  sqlstm.sqindv[10] = (         short *)0;
  sqlstm.sqinds[10] = (         int  )0;
  sqlstm.sqharm[10] = (unsigned long )0;
  sqlstm.sqadto[10] = (unsigned short )0;
  sqlstm.sqtdso[10] = (unsigned short )0;
  sqlstm.sqhstv[11] = (unsigned char  *)&hv_status;
  sqlstm.sqhstl[11] = (unsigned long )4;
  sqlstm.sqhsts[11] = (         int  )0;
  sqlstm.sqindv[11] = (         short *)0;
  sqlstm.sqinds[11] = (         int  )0;
  sqlstm.sqharm[11] = (unsigned long )0;
  sqlstm.sqadto[11] = (unsigned short )0;
  sqlstm.sqtdso[11] = (unsigned short )0;
  sqlstm.sqphsv = sqlstm.sqhstv;
  sqlstm.sqphsl = sqlstm.sqhstl;
  sqlstm.sqphss = sqlstm.sqhsts;
  sqlstm.sqpind = sqlstm.sqindv;
  sqlstm.sqpins = sqlstm.sqinds;
  sqlstm.sqparm = sqlstm.sqharm;
  sqlstm.sqparc = sqlstm.sqharc;
  sqlstm.sqpadto = sqlstm.sqadto;
  sqlstm.sqptdso = sqlstm.sqtdso;
  sqlcxt((void **)0, &sqlctx, &sqlstm, &sqlfpn);
  if (sqlca.sqlcode < 0) goto check_error;
}



		if(ind_txn_type>=0){
DEBUGLOG(("CheckMerchantBalAcct txn_type=[%c]\n",v_txn_type));
			if((v_txn_type == PD_TYPE_ALL) || (v_txn_type == PD_TYPE_PAYOUT)){
				PutField_Int(hRec,"allow_payout",PD_TRUE);
DEBUGLOG(("CheckMerchantBalAcct allow_payout=[%d]\n",PD_TRUE));
			}
			else{
				PutField_Int(hRec,"allow_payout",PD_FALSE);
DEBUGLOG(("CheckMerchantBalAcct allow_payout=[%d]\n",PD_FALSE));
			}
		}
		else{
			PutField_Int(hRec,"allow_payout",PD_FALSE);
		}

		if (ind_support_delta_amt >= 0) {
DEBUGLOG(("CheckMerchantBalAcct support_delta_amt=[%d]\n",v_support_delta_amt));
			PutField_Int(hRec,"support_delta_amt",v_support_delta_amt);
		}
		else {
DEBUGLOG(("CheckMerchantBalAcct support_delta_amt[default]=[%d]\n",PD_FALSE));
			PutField_Int(hRec,"support_delta_amt",PD_FALSE);
		}

		if(ind_preferred_settle_ccy >= 0){
			v_preferred_settle_ccy.arr[v_preferred_settle_ccy.len]='\0';
			PutField_CString(hRec,"preferred_settle_ccy",(const char*)v_preferred_settle_ccy.arr);
DEBUGLOG(("CheckMerchantBalAcct preferred settlement ccy =[%s]\n",v_preferred_settle_ccy.arr));
		}

		if (ind_min_settle_amt >= 0) {
DEBUGLOG(("CheckMerchantBalAcct min_settle_amt=[%lf]\n",v_min_settle_amt));
			PutField_Double(hRec,"min_settle_amt",v_min_settle_amt);
		}
		else {
DEBUGLOG(("CheckMerchantBalAcct min_settle_amt[default]=[%lf]\n",0.0));
			PutField_Double(hRec,"min_settle_amt",0.0);
		}
		if (ind_minsetamt_applytoadmin>= 0) {
DEBUGLOG(("CheckMerchantBalAcct min_settle_amt_applytoadmin=[%d]\n",v_min_settle_amt_applytoadmin));
			PutField_Int(hRec,"min_settle_amt_applytoadmin",v_min_settle_amt_applytoadmin);
		}
		else {
DEBUGLOG(("CheckMerchantBalAcct min_settle_amt_applytoadmin[default]=[%d]\n",PD_FALSE));
			PutField_Int(hRec,"min_settle_amt_applytoadmin",PD_FALSE);
		}


		if (ind_avai_po_percentage >= 0) {
			PutField_Int(hRec,"avai_po_percentage",v_avai_po_percentage);
DEBUGLOG(("CheckMerchantBalAcct available payout percentage =[%d]\n",v_avai_po_percentage));
		}

		if(ind_preferred_acr_pool>= 0){
			v_preferred_acr_pool.arr[v_preferred_acr_pool.len]='\0';
			PutField_CString(hRec,"preferred_acr_pool",(const char*)v_preferred_acr_pool.arr);
DEBUGLOG(("CheckMerchantBalAcct preferred acr pool =[%s]\n",v_preferred_acr_pool.arr));
		}
		else{
			PutField_CString(hRec,"preferred_acr_pool",PD_CCY_UNKNOWN);
DEBUGLOG(("GetACRPool preferred acr pool (not found) =[%s]\n",PD_CCY_UNKNOWN));
		}

	}
	else {
DEBUGLOG(("CheckMerchantBalAcct Not found! [%d]\n",v_cnt));
	}
	

DEBUGLOG(("CheckMerchantBalAcct Normal Exit [%d]\n",iRet));
	return iRet;

check_error:
DEBUGLOG(("check_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        /* EXEC SQL WHENEVER SQLERROR CONTINUE; */ 

        return PD_ERR;
}



int UpdateMerchantBalAcctStatus(const hash_t *hRls)
{
        char*     csTmp;

	char*	  csBuf;

        char*     csMerchantId;
        char*     csCountry;
        char*     csCcyId;
        char*     csServiceCode;
	char	  cTmp;
	int	  iTmp;
	double	  dTmp;

        /* EXEC SQL WHENEVER SQLERROR GOTO updatestatus_error; */ 

        /* EXEC SQL WHENEVER NOTFOUND CONTINUE; */ 


        /* EXEC SQL BEGIN DECLARE SECTION; */ 


                /* varchar        hv_dynstmt[1024]; */ 
struct { unsigned short len; unsigned char arr[1024]; } hv_dynstmt;


        /* EXEC SQL END DECLARE SECTION; */ 


	csBuf = (char *) malloc(128);

DEBUGLOG(("UpdateMerchantBalAcctStatus: Begin\n"));

        strcpy((char*)hv_dynstmt.arr,"update merchant_bal_acct set mb_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"merchant_id",&csMerchantId);
DEBUGLOG(("UpdateMerchantBalAcctStatus: merchant_id = [%s]\n", csMerchantId));

        GetField_CString(hRls,"country",&csCountry);
DEBUGLOG(("UpdateMerchantBalAcctStatus: country = [%s]\n", csCountry));

        GetField_CString(hRls,"ccy",&csCcyId);
DEBUGLOG(("UpdateMerchantBalAcctStatus: ccy = [%s]\n", csCcyId));

        GetField_CString(hRls,"service",&csServiceCode);
DEBUGLOG(("UpdateMerchantBalAcctStatus: service = [%s]\n", csServiceCode));

/*status */
        if (GetField_CString(hRls,"status",&csTmp)) {
DEBUGLOG(("UpdateMerchantBalAcctStatus:status = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mb_status = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* txn_type */
        if (GetField_Char(hRls,"txn_type",&cTmp)) {
DEBUGLOG(("UpdateMerchantBalAcctStatus:txn_type = [%c]\n",cTmp));
		sprintf(csBuf, "%c", cTmp);
		strcat((char*)hv_dynstmt.arr, ",mb_txn_type= '");
		strcat((char*)hv_dynstmt.arr, csBuf);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* support_delta_amt */
	if (GetField_Int(hRls,"support_delta_amt",&iTmp)) {
DEBUGLOG(("UpdateMerchantBalAcctStatus:support_delta_amt= [%f]\n",iTmp));
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, ",mb_support_delta_amt= ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/*preferred_settle_ccy*/
        if (GetField_CString(hRls,"preferred_settle_ccy",&csTmp)) {
DEBUGLOG(("UpdateMerchantBalAcctStatus:preferred_settle_ccy = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mb_preferred_settle_ccy = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/*min_settle_amt*/
        if (GetField_Double(hRls,"min_settle_amt",&dTmp)) {
DEBUGLOG(("UpdateMerchantBalAcctStatus:min_settle_amt = [%lf]\n",dTmp));
		sprintf(csBuf, "%lf", dTmp);
                strcat((char*)hv_dynstmt.arr, ",mb_min_settle_amt = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* min_settle_amt_applytoadmin */
	if (GetField_Int(hRls,"min_settle_amt_applytoadmin",&iTmp)) {
DEBUGLOG(("UpdateMerchantBalAcctStatus:min_settle_amt_applytoadmin = [%f]\n",iTmp));
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, ",mb_min_settle_amt_applytoadmin = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* avai_po_percentage */
	if (GetField_Int(hRls,"avai_po_percentage",&iTmp)) {
DEBUGLOG(("UpdateMerchantBalAcctStatus:avai_po_percentage = [%f]\n",iTmp));
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, ",mb_avai_po_percentage = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/*preferred_acr_pool*/
        if (GetField_CString(hRls,"preferred_acr_pool",&csTmp)) {
DEBUGLOG(("UpdateMerchantBalAcctStatus:preferred_acr_pool = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mb_preferred_acr_pool = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/*update_user*/
        if(GetField_CString(hRls,"update_user",&csTmp)){
DEBUGLOG(("UpdateMerchantBalAcctStatus:update_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mb_update_user= '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        strcat((char *)hv_dynstmt.arr, " WHERE mb_merchant_id = '");
        strcat((char *)hv_dynstmt.arr, csMerchantId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND mb_country = '");
        strcat((char *)hv_dynstmt.arr, csCountry);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND mb_ccy_id = '");
        strcat((char *)hv_dynstmt.arr, csCcyId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND mb_service_code = '");
        strcat((char *)hv_dynstmt.arr, csServiceCode);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        /* EXEC SQL PREPARE PS FROM :hv_dynstmt; */ 

{
        struct sqlexd sqlstm;
        sqlstm.sqlvsn = 12;
        sqlstm.arrsiz = 12;
        sqlstm.sqladtp = &sqladt;
        sqlstm.sqltdsp = &sqltds;
        sqlstm.stmt = "";
        sqlstm.iters = (unsigned int  )1;
        sqlstm.offset = (unsigned int  )107;
        sqlstm.cud = sqlcud0;
        sqlstm.sqlest = (unsigned char  *)&sqlca;
        sqlstm.sqlety = (unsigned short)4352;
        sqlstm.occurs = (unsigned int  )0;
        sqlstm.sqhstv[0] = (unsigned char  *)&hv_dynstmt;
        sqlstm.sqhstl[0] = (unsigned long )1026;
        sqlstm.sqhsts[0] = (         int  )0;
        sqlstm.sqindv[0] = (         short *)0;
        sqlstm.sqinds[0] = (         int  )0;
        sqlstm.sqharm[0] = (unsigned long )0;
        sqlstm.sqadto[0] = (unsigned short )0;
        sqlstm.sqtdso[0] = (unsigned short )0;
        sqlstm.sqphsv = sqlstm.sqhstv;
        sqlstm.sqphsl = sqlstm.sqhstl;
        sqlstm.sqphss = sqlstm.sqhsts;
        sqlstm.sqpind = sqlstm.sqindv;
        sqlstm.sqpins = sqlstm.sqinds;
        sqlstm.sqparm = sqlstm.sqharm;
        sqlstm.sqparc = sqlstm.sqharc;
        sqlstm.sqpadto = sqlstm.sqadto;
        sqlstm.sqptdso = sqlstm.sqtdso;
        sqlcxt((void **)0, &sqlctx, &sqlstm, &sqlfpn);
        if (sqlca.sqlcode < 0) goto updatestatus_error;
}


        /* EXEC SQL EXECUTE PS; */ 

{
        struct sqlexd sqlstm;
        sqlstm.sqlvsn = 12;
        sqlstm.arrsiz = 12;
        sqlstm.sqladtp = &sqladt;
        sqlstm.sqltdsp = &sqltds;
        sqlstm.stmt = "";
        sqlstm.iters = (unsigned int  )1;
        sqlstm.offset = (unsigned int  )126;
        sqlstm.cud = sqlcud0;
        sqlstm.sqlest = (unsigned char  *)&sqlca;
        sqlstm.sqlety = (unsigned short)4352;
        sqlstm.occurs = (unsigned int  )0;
        sqlcxt((void **)0, &sqlctx, &sqlstm, &sqlfpn);
        if (sqlca.sqlcode < 0) goto updatestatus_error;
}



	FREE_ME(csBuf);

DEBUGLOG(("Update Normal Exit\n"));
        return PD_OK;

updatestatus_error:
DEBUGLOG(("updatestatus_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        /* EXEC SQL WHENEVER SQLERROR CONTINUE; */ 

ERRLOG("MerantantBalAcct_UpdateMerchantBalAcctStatus: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("UpdateMerchantBalAcctStatus: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;

}

int UpdateMerchantAutoSettlement(const hash_t *hRls)
{
        char*     csTmp;

	char*	  csBuf;

        char*     csMerchantId;
        char*     csCountry;
        char*     csCcyId;
        char*     csServiceCode;
	int	  iTmp;

        /* EXEC SQL WHENEVER SQLERROR GOTO updateSett_error; */ 

        /* EXEC SQL WHENEVER NOTFOUND CONTINUE; */ 


        /* EXEC SQL BEGIN DECLARE SECTION; */ 


                /* varchar        hv_dynstmt[1024]; */ 
struct { unsigned short len; unsigned char arr[1024]; } hv_dynstmt;


        /* EXEC SQL END DECLARE SECTION; */ 


	csBuf = (char *) malloc(128);

DEBUGLOG(("UpdateMerchantAutoSettlement: Begin\n"));

        strcpy((char*)hv_dynstmt.arr,"update merchant_bal_acct set mb_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"merchant_id",&csMerchantId);
DEBUGLOG(("UpdateMerchantAutoSettlement: merchant_id = [%s]\n", csMerchantId));

        GetField_CString(hRls,"country",&csCountry);
DEBUGLOG(("UpdateMerchantAutoSettlement: country = [%s]\n", csCountry));

        GetField_CString(hRls,"ccy",&csCcyId);
DEBUGLOG(("UpdateMerchantAutoSettlement: ccy = [%s]\n", csCcyId));

        GetField_CString(hRls,"service",&csServiceCode);
DEBUGLOG(("UpdateMerchantAutoSettlement: service = [%s]\n", csServiceCode));

/* support_auto_sett */
	if (GetField_Int(hRls,"support_auto_sett",&iTmp)) {
DEBUGLOG(("UpdateMerchantAutoSettlement:support_auto_sett = [%d]\n",iTmp));
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, ",mb_support_auto_sett = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/* auto_sett_id */
	if (GetField_Int(hRls,"auto_sett_id",&iTmp)) {
DEBUGLOG(("UpdateMerchantAutoSettlement:auto_sett_id = [%d]\n",iTmp));
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, ",mb_auto_sett_id = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

/*update_user*/
        if(GetField_CString(hRls,"update_user",&csTmp)){
DEBUGLOG(("UpdateMerchantAutoSettlement:update_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mb_update_user= '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        strcat((char *)hv_dynstmt.arr, " WHERE mb_merchant_id = '");
        strcat((char *)hv_dynstmt.arr, csMerchantId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND mb_country = '");
        strcat((char *)hv_dynstmt.arr, csCountry);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND mb_ccy_id = '");
        strcat((char *)hv_dynstmt.arr, csCcyId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND mb_service_code = '");
        strcat((char *)hv_dynstmt.arr, csServiceCode);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        /* EXEC SQL PREPARE PS FROM :hv_dynstmt; */ 

{
        struct sqlexd sqlstm;
        sqlstm.sqlvsn = 12;
        sqlstm.arrsiz = 12;
        sqlstm.sqladtp = &sqladt;
        sqlstm.sqltdsp = &sqltds;
        sqlstm.stmt = "";
        sqlstm.iters = (unsigned int  )1;
        sqlstm.offset = (unsigned int  )141;
        sqlstm.cud = sqlcud0;
        sqlstm.sqlest = (unsigned char  *)&sqlca;
        sqlstm.sqlety = (unsigned short)4352;
        sqlstm.occurs = (unsigned int  )0;
        sqlstm.sqhstv[0] = (unsigned char  *)&hv_dynstmt;
        sqlstm.sqhstl[0] = (unsigned long )1026;
        sqlstm.sqhsts[0] = (         int  )0;
        sqlstm.sqindv[0] = (         short *)0;
        sqlstm.sqinds[0] = (         int  )0;
        sqlstm.sqharm[0] = (unsigned long )0;
        sqlstm.sqadto[0] = (unsigned short )0;
        sqlstm.sqtdso[0] = (unsigned short )0;
        sqlstm.sqphsv = sqlstm.sqhstv;
        sqlstm.sqphsl = sqlstm.sqhstl;
        sqlstm.sqphss = sqlstm.sqhsts;
        sqlstm.sqpind = sqlstm.sqindv;
        sqlstm.sqpins = sqlstm.sqinds;
        sqlstm.sqparm = sqlstm.sqharm;
        sqlstm.sqparc = sqlstm.sqharc;
        sqlstm.sqpadto = sqlstm.sqadto;
        sqlstm.sqptdso = sqlstm.sqtdso;
        sqlcxt((void **)0, &sqlctx, &sqlstm, &sqlfpn);
        if (sqlca.sqlcode < 0) goto updateSett_error;
}


        /* EXEC SQL EXECUTE PS; */ 

{
        struct sqlexd sqlstm;
        sqlstm.sqlvsn = 12;
        sqlstm.arrsiz = 12;
        sqlstm.sqladtp = &sqladt;
        sqlstm.sqltdsp = &sqltds;
        sqlstm.stmt = "";
        sqlstm.iters = (unsigned int  )1;
        sqlstm.offset = (unsigned int  )160;
        sqlstm.cud = sqlcud0;
        sqlstm.sqlest = (unsigned char  *)&sqlca;
        sqlstm.sqlety = (unsigned short)4352;
        sqlstm.occurs = (unsigned int  )0;
        sqlcxt((void **)0, &sqlctx, &sqlstm, &sqlfpn);
        if (sqlca.sqlcode < 0) goto updateSett_error;
}



	FREE_ME(csBuf);

DEBUGLOG(("Update Normal Exit\n"));
        return PD_OK;

updateSett_error:
DEBUGLOG(("updateSett_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        /* EXEC SQL WHENEVER SQLERROR CONTINUE; */ 

ERRLOG("MerantantBalAcct_UpdateMerchantAutoSettlement: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("UpdateMerchantAutoSettlement: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;

}

int Add(const hash_t *hMerchantBalAcct)
{
	char *csTmp;
	char iTmp;
	char	cTmp;
	double dTmp;

        /* EXEC SQL WHENEVER SQLERROR GOTO add_error; */ 

        /* EXEC SQL WHENEVER NOTFOUND CONTINUE; */ 


        /* EXEC SQL BEGIN DECLARE SECTION; */ 

		/* varchar		hv_merchant_id[PD_MERCHANT_ID_LEN]; */ 
struct { unsigned short len; unsigned char arr[15]; } hv_merchant_id;

		/* varchar		hv_country[PD_COUNTRY_LEN]; */ 
struct { unsigned short len; unsigned char arr[2]; } hv_country;

                /* varchar         hv_ccy[PD_CCY_ID_LEN]; */ 
struct { unsigned short len; unsigned char arr[3]; } hv_ccy;

		int		hv_disabled;
                /* varchar         hv_service_code[PD_SERVICE_CODE_LEN]; */ 
struct { unsigned short len; unsigned char arr[3]; } hv_service_code;

		/* varchar         hv_status[PD_ACCOUNT_STATUS_LEN]; */ 
struct { unsigned short len; unsigned char arr[2]; } hv_status;

		//int		hv_allow_payout;
		/* varchar		hv_create_user[PD_USER_LEN]; */ 
struct { unsigned short len; unsigned char arr[20]; } hv_create_user;

		char		hv_txn_type;
		int		hv_support_delta_amt;
		double		hv_min_settle_amt;
		int		hv_min_settle_amt_applytoadmin;
                /* varchar         hv_preferred_settle_ccy[PD_CCY_ID_LEN]; */ 
struct { unsigned short len; unsigned char arr[3]; } hv_preferred_settle_ccy;

		int		hv_avai_po_percentage;
                /* varchar         hv_preferred_acr_pool[PD_CCY_ID_LEN]; */ 
struct { unsigned short len; unsigned char arr[3]; } hv_preferred_acr_pool;


		short		ind_merchant_id = -1;
		short		ind_country = -1;
		short		ind_ccy = -1;
		short		ind_disabled = -1;
		short		ind_service_code = -1;
		short		ind_status = -1;
		//short		ind_allow_payout = -1;
		short		ind_create_user = -1;
		short		ind_txn_type = -1;
		short		ind_support_delta_amt = -1;
		short		ind_min_settle_amt = -1;
		short		ind_minsetamt_applytoadmin= -1;
		short		ind_preferred_settle_ccy= -1;
		short		ind_avai_po_percentage= -1;
		short		ind_preferred_acr_pool = -1;

		short		hv_return_value;
        /* EXEC SQL END DECLARE SECTION; */ 



        DEBUGLOG(("Add: Begin\n"));

        if(GetField_CString(hMerchantBalAcct,"merchant_id",&csTmp))
        {
                hv_merchant_id.len = strlen(csTmp);
                strncpy((char *)hv_merchant_id.arr, csTmp, hv_merchant_id.len);
                ind_merchant_id = 0;
DEBUGLOG(("Add:merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        }

	if (GetField_CString(hMerchantBalAcct, "country",&csTmp))
	{
		hv_country.len = strlen(csTmp);
		strncpy((char *)hv_country.arr, csTmp, hv_country.len);
		ind_country = 0;
DEBUGLOG(("Add:country = [%.*s]\n",hv_country.len,hv_country.arr));
	}

        if (GetField_CString(hMerchantBalAcct, "ccy",&csTmp))
        {
                hv_ccy.len = strlen(csTmp);
                strncpy((char *)hv_ccy.arr, csTmp, hv_ccy.len);
                ind_ccy = 0;
DEBUGLOG(("Add:ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));
        }

        if (GetField_Int(hMerchantBalAcct,"disabled", &iTmp))
        {
                hv_disabled = iTmp;
                ind_disabled = 0;
DEBUGLOG(("Add:disabled = [%d]\n",hv_disabled));
        }

        if (GetField_CString(hMerchantBalAcct, "service_code",&csTmp))
        {
                hv_service_code.len = strlen(csTmp);
                strncpy((char *)hv_service_code.arr, csTmp, hv_service_code.len);
                ind_service_code = 0;
DEBUGLOG(("Add:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
        }

        if (GetField_CString(hMerchantBalAcct, "status",&csTmp))
        {
                hv_status.len = strlen(csTmp);
                strncpy((char *)hv_status.arr, csTmp, hv_status.len);
                ind_status= 0;
DEBUGLOG(("Add:status = [%.*s]\n",hv_status.len,hv_status.arr));
        }
	
        if (GetField_Char(hMerchantBalAcct,"txn_type", &cTmp))
        {
                hv_txn_type= cTmp;
                ind_txn_type= 0;
DEBUGLOG(("Add:txn_type = [%c]\n",hv_txn_type));	
        }

	if (GetField_Int(hMerchantBalAcct,"support_delta_amt",&iTmp))
	{
		hv_support_delta_amt = iTmp;
		ind_support_delta_amt = 0;
DEBUGLOG(("Add:support_delta_amt= [%d]\n",hv_support_delta_amt));
	}

        if(GetField_CString(hMerchantBalAcct,"preferred_settle_ccy",&csTmp)) {
                hv_preferred_settle_ccy.len = strlen(csTmp);
                strncpy((char *)hv_preferred_settle_ccy.arr, csTmp, hv_preferred_settle_ccy.len);
                ind_preferred_settle_ccy= 0;
DEBUGLOG(("Add:preferred_settle_ccy = [%.*s]\n",hv_preferred_settle_ccy.len,hv_preferred_settle_ccy.arr));
	}

        if(GetField_Double(hMerchantBalAcct,"min_settle_amt",&dTmp)) {
		hv_min_settle_amt = dTmp;
                ind_min_settle_amt= 0;
DEBUGLOG(("Add:min_settle_amt = [%lf]\n",hv_min_settle_amt));
	}

	if (GetField_Int(hMerchantBalAcct,"min_settle_amt_applytoadmin",&iTmp))
	{
		hv_min_settle_amt_applytoadmin= iTmp;
		ind_minsetamt_applytoadmin= 0;
DEBUGLOG(("Add:min_settle_amt_applytoadmin = [%d]\n",hv_min_settle_amt_applytoadmin));
	}

	if (GetField_Int(hMerchantBalAcct,"avai_po_percentage",&iTmp))
	{
		hv_avai_po_percentage= iTmp;
		ind_avai_po_percentage= 0;
DEBUGLOG(("Add:avai_po_percentage = [%d]\n",hv_avai_po_percentage));
	}

        if(GetField_CString(hMerchantBalAcct,"preferred_acr_pool",&csTmp)) {
                hv_preferred_acr_pool.len = strlen(csTmp);
                strncpy((char *)hv_preferred_acr_pool.arr, csTmp, hv_preferred_acr_pool.len);
                ind_preferred_acr_pool= 0;
DEBUGLOG(("Add:preferred_acr_pool = [%.*s]\n",hv_preferred_acr_pool.len,hv_preferred_acr_pool.arr));
	}

        if(GetField_CString(hMerchantBalAcct,"create_user",&csTmp))
        {
                hv_create_user.len = strlen(csTmp);
                strncpy((char *)hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));
        }

        /* EXEC SQL EXECUTE
            BEGIN

                :hv_return_value := sp_merchant_bal_acct_insert(
                                :hv_merchant_id:ind_merchant_id,
				:hv_country:ind_country,
                                :hv_ccy:ind_ccy,
                                :hv_disabled:ind_disabled,
                                :hv_service_code:ind_service_code,
                                :hv_status:ind_status, 
				:hv_txn_type:ind_txn_type,
				:hv_support_delta_amt:ind_support_delta_amt,
				:hv_preferred_settle_ccy:ind_preferred_settle_ccy,
				:hv_preferred_acr_pool:ind_preferred_acr_pool,
				:hv_min_settle_amt:ind_min_settle_amt,
				:hv_min_settle_amt_applytoadmin:ind_minsetamt_applytoadmin,
				:hv_avai_po_percentage:ind_avai_po_percentage,
                                :hv_create_user:ind_create_user);
            END;
        END-EXEC; */ 

{
        struct sqlexd sqlstm;
        sqlstm.sqlvsn = 12;
        sqlstm.arrsiz = 15;
        sqlstm.sqladtp = &sqladt;
        sqlstm.sqltdsp = &sqltds;
        sqlstm.stmt = "begin :hv_return_value := sp_merchant_bal_acct_inser\
t ( :hv_merchant_id:ind_merchant_id , :hv_country:ind_country , :hv_ccy:ind_c\
cy , :hv_disabled:ind_disabled , :hv_service_code:ind_service_code , :hv_stat\
us:ind_status , :hv_txn_type:ind_txn_type , :hv_support_delta_amt:ind_support\
_delta_amt , :hv_preferred_settle_ccy:ind_preferred_settle_ccy , :hv_preferre\
d_acr_pool:ind_preferred_acr_pool , :hv_min_settle_amt:ind_min_settle_amt , :\
hv_min_settle_amt_applytoadmin:ind_minsetamt_applytoadmin , :hv_avai_po_perce\
ntage:ind_avai_po_percentage , :hv_create_user:ind_create_user ) ; END ;";
        sqlstm.iters = (unsigned int  )1;
        sqlstm.offset = (unsigned int  )175;
        sqlstm.cud = sqlcud0;
        sqlstm.sqlest = (unsigned char  *)&sqlca;
        sqlstm.sqlety = (unsigned short)4352;
        sqlstm.occurs = (unsigned int  )0;
        sqlstm.sqhstv[0] = (unsigned char  *)&hv_return_value;
        sqlstm.sqhstl[0] = (unsigned long )sizeof(short);
        sqlstm.sqhsts[0] = (         int  )0;
        sqlstm.sqindv[0] = (         short *)0;
        sqlstm.sqinds[0] = (         int  )0;
        sqlstm.sqharm[0] = (unsigned long )0;
        sqlstm.sqadto[0] = (unsigned short )0;
        sqlstm.sqtdso[0] = (unsigned short )0;
        sqlstm.sqhstv[1] = (unsigned char  *)&hv_merchant_id;
        sqlstm.sqhstl[1] = (unsigned long )17;
        sqlstm.sqhsts[1] = (         int  )0;
        sqlstm.sqindv[1] = (         short *)&ind_merchant_id;
        sqlstm.sqinds[1] = (         int  )0;
        sqlstm.sqharm[1] = (unsigned long )0;
        sqlstm.sqadto[1] = (unsigned short )0;
        sqlstm.sqtdso[1] = (unsigned short )0;
        sqlstm.sqhstv[2] = (unsigned char  *)&hv_country;
        sqlstm.sqhstl[2] = (unsigned long )4;
        sqlstm.sqhsts[2] = (         int  )0;
        sqlstm.sqindv[2] = (         short *)&ind_country;
        sqlstm.sqinds[2] = (         int  )0;
        sqlstm.sqharm[2] = (unsigned long )0;
        sqlstm.sqadto[2] = (unsigned short )0;
        sqlstm.sqtdso[2] = (unsigned short )0;
        sqlstm.sqhstv[3] = (unsigned char  *)&hv_ccy;
        sqlstm.sqhstl[3] = (unsigned long )5;
        sqlstm.sqhsts[3] = (         int  )0;
        sqlstm.sqindv[3] = (         short *)&ind_ccy;
        sqlstm.sqinds[3] = (         int  )0;
        sqlstm.sqharm[3] = (unsigned long )0;
        sqlstm.sqadto[3] = (unsigned short )0;
        sqlstm.sqtdso[3] = (unsigned short )0;
        sqlstm.sqhstv[4] = (unsigned char  *)&hv_disabled;
        sqlstm.sqhstl[4] = (unsigned long )sizeof(int);
        sqlstm.sqhsts[4] = (         int  )0;
        sqlstm.sqindv[4] = (         short *)&ind_disabled;
        sqlstm.sqinds[4] = (         int  )0;
        sqlstm.sqharm[4] = (unsigned long )0;
        sqlstm.sqadto[4] = (unsigned short )0;
        sqlstm.sqtdso[4] = (unsigned short )0;
        sqlstm.sqhstv[5] = (unsigned char  *)&hv_service_code;
        sqlstm.sqhstl[5] = (unsigned long )5;
        sqlstm.sqhsts[5] = (         int  )0;
        sqlstm.sqindv[5] = (         short *)&ind_service_code;
        sqlstm.sqinds[5] = (         int  )0;
        sqlstm.sqharm[5] = (unsigned long )0;
        sqlstm.sqadto[5] = (unsigned short )0;
        sqlstm.sqtdso[5] = (unsigned short )0;
        sqlstm.sqhstv[6] = (unsigned char  *)&hv_status;
        sqlstm.sqhstl[6] = (unsigned long )4;
        sqlstm.sqhsts[6] = (         int  )0;
        sqlstm.sqindv[6] = (         short *)&ind_status;
        sqlstm.sqinds[6] = (         int  )0;
        sqlstm.sqharm[6] = (unsigned long )0;
        sqlstm.sqadto[6] = (unsigned short )0;
        sqlstm.sqtdso[6] = (unsigned short )0;
        sqlstm.sqhstv[7] = (unsigned char  *)&hv_txn_type;
        sqlstm.sqhstl[7] = (unsigned long )1;
        sqlstm.sqhsts[7] = (         int  )0;
        sqlstm.sqindv[7] = (         short *)&ind_txn_type;
        sqlstm.sqinds[7] = (         int  )0;
        sqlstm.sqharm[7] = (unsigned long )0;
        sqlstm.sqadto[7] = (unsigned short )0;
        sqlstm.sqtdso[7] = (unsigned short )0;
        sqlstm.sqhstv[8] = (unsigned char  *)&hv_support_delta_amt;
        sqlstm.sqhstl[8] = (unsigned long )sizeof(int);
        sqlstm.sqhsts[8] = (         int  )0;
        sqlstm.sqindv[8] = (         short *)&ind_support_delta_amt;
        sqlstm.sqinds[8] = (         int  )0;
        sqlstm.sqharm[8] = (unsigned long )0;
        sqlstm.sqadto[8] = (unsigned short )0;
        sqlstm.sqtdso[8] = (unsigned short )0;
        sqlstm.sqhstv[9] = (unsigned char  *)&hv_preferred_settle_ccy;
        sqlstm.sqhstl[9] = (unsigned long )5;
        sqlstm.sqhsts[9] = (         int  )0;
        sqlstm.sqindv[9] = (         short *)&ind_preferred_settle_ccy;
        sqlstm.sqinds[9] = (         int  )0;
        sqlstm.sqharm[9] = (unsigned long )0;
        sqlstm.sqadto[9] = (unsigned short )0;
        sqlstm.sqtdso[9] = (unsigned short )0;
        sqlstm.sqhstv[10] = (unsigned char  *)&hv_preferred_acr_pool;
        sqlstm.sqhstl[10] = (unsigned long )5;
        sqlstm.sqhsts[10] = (         int  )0;
        sqlstm.sqindv[10] = (         short *)&ind_preferred_acr_pool;
        sqlstm.sqinds[10] = (         int  )0;
        sqlstm.sqharm[10] = (unsigned long )0;
        sqlstm.sqadto[10] = (unsigned short )0;
        sqlstm.sqtdso[10] = (unsigned short )0;
        sqlstm.sqhstv[11] = (unsigned char  *)&hv_min_settle_amt;
        sqlstm.sqhstl[11] = (unsigned long )sizeof(double);
        sqlstm.sqhsts[11] = (         int  )0;
        sqlstm.sqindv[11] = (         short *)&ind_min_settle_amt;
        sqlstm.sqinds[11] = (         int  )0;
        sqlstm.sqharm[11] = (unsigned long )0;
        sqlstm.sqadto[11] = (unsigned short )0;
        sqlstm.sqtdso[11] = (unsigned short )0;
        sqlstm.sqhstv[12] = (unsigned char  *)&hv_min_settle_amt_applytoadmin;
        sqlstm.sqhstl[12] = (unsigned long )sizeof(int);
        sqlstm.sqhsts[12] = (         int  )0;
        sqlstm.sqindv[12] = (         short *)&ind_minsetamt_applytoadmin;
        sqlstm.sqinds[12] = (         int  )0;
        sqlstm.sqharm[12] = (unsigned long )0;
        sqlstm.sqadto[12] = (unsigned short )0;
        sqlstm.sqtdso[12] = (unsigned short )0;
        sqlstm.sqhstv[13] = (unsigned char  *)&hv_avai_po_percentage;
        sqlstm.sqhstl[13] = (unsigned long )sizeof(int);
        sqlstm.sqhsts[13] = (         int  )0;
        sqlstm.sqindv[13] = (         short *)&ind_avai_po_percentage;
        sqlstm.sqinds[13] = (         int  )0;
        sqlstm.sqharm[13] = (unsigned long )0;
        sqlstm.sqadto[13] = (unsigned short )0;
        sqlstm.sqtdso[13] = (unsigned short )0;
        sqlstm.sqhstv[14] = (unsigned char  *)&hv_create_user;
        sqlstm.sqhstl[14] = (unsigned long )22;
        sqlstm.sqhsts[14] = (         int  )0;
        sqlstm.sqindv[14] = (         short *)&ind_create_user;
        sqlstm.sqinds[14] = (         int  )0;
        sqlstm.sqharm[14] = (unsigned long )0;
        sqlstm.sqadto[14] = (unsigned short )0;
        sqlstm.sqtdso[14] = (unsigned short )0;
        sqlstm.sqphsv = sqlstm.sqhstv;
        sqlstm.sqphsl = sqlstm.sqhstl;
        sqlstm.sqphss = sqlstm.sqhsts;
        sqlstm.sqpind = sqlstm.sqindv;
        sqlstm.sqpins = sqlstm.sqinds;
        sqlstm.sqparm = sqlstm.sqharm;
        sqlstm.sqparc = sqlstm.sqharc;
        sqlstm.sqpadto = sqlstm.sqadto;
        sqlstm.sqptdso = sqlstm.sqtdso;
        sqlcxt((void **)0, &sqlctx, &sqlstm, &sqlfpn);
        if (sqlca.sqlcode < 0) goto add_error;
}



DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
                DEBUGLOG(("Add:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
                ERRLOG("MerchantBalAcct_Add: SP_OTHER_ERR TxnAbort\n");
                DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
                ERRLOG("MerchantBalAcct_Add: SP_ERR TxnAbort\n");
                DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
                return PD_ERR;
        }

add_error:
        DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
        DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        /* EXEC SQL WHENEVER SQLERROR CONTINUE; */ 

        return PD_ERR;
}

int GetAutoSettId(const hash_t *hMerchantBalAcct, int *iSupportAutoSett, int *iAutoSettId)
{
	char	*csTmp;

	/* EXEC SQL WHENEVER SQLERROR GOTO get_error; */ 

	/* EXEC SQL WHENEVER NOTFOUND CONTINUE; */ 


	/* EXEC SQL BEGIN DECLARE SECTION; */ 

		/* varchar		hv_merchant_id[PD_MERCHANT_ID_LEN]; */ 
struct { unsigned short len; unsigned char arr[15]; } hv_merchant_id;

		/* varchar		hv_country[PD_COUNTRY_LEN]; */ 
struct { unsigned short len; unsigned char arr[2]; } hv_country;

		/* varchar		hv_ccy[PD_CCY_ID_LEN]; */ 
struct { unsigned short len; unsigned char arr[3]; } hv_ccy;

		/* varchar		hv_service_code[PD_SERVICE_CODE_LEN]; */ 
struct { unsigned short len; unsigned char arr[3]; } hv_service_code;

		int		v_support_auto_sett;
		int		v_auto_sett_id;

		short		ind_merchant_id = -1;
		short		ind_country = -1;
		short		ind_ccy = -1;
		short		ind_service_code = -1;
		short		ind_support_auto_sett = -1;
		short		ind_auto_sett_id = -1;

	/* EXEC SQL END DECLARE SECTION; */ 


	if(GetField_CString(hMerchantBalAcct,"merchant_id",&csTmp))
	{
		hv_merchant_id.len = strlen(csTmp);
		strncpy((char *)hv_merchant_id.arr, csTmp, hv_merchant_id.len);
		ind_merchant_id = 0;
DEBUGLOG(("GetAutoSettId:merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
	} else {
DEBUGLOG(("GetAutoSettId:merchant_id NOT FOUND!!!\n"));
		return PD_ERR;
	}

	if(GetField_CString(hMerchantBalAcct,"country",&csTmp))
	{
		hv_country.len = strlen(csTmp);
		strncpy((char *)hv_country.arr, csTmp, hv_country.len);
		ind_country = 0;
DEBUGLOG(("GetAutoSettId:country = [%.*s]\n",hv_country.len,hv_country.arr));
	} else {
DEBUGLOG(("GetAutoSettId:country NOT FOUND!!!\n"));
		return PD_ERR;
	}

	if(GetField_CString(hMerchantBalAcct,"ccy",&csTmp))
	{
		hv_ccy.len = strlen(csTmp);
		strncpy((char *)hv_ccy.arr, csTmp, hv_ccy.len);
		ind_ccy = 0;
DEBUGLOG(("GetAutoSettId:ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));
	} else {
DEBUGLOG(("GetAutoSettId:ccy NOT FOUND!!!\n"));
		return PD_ERR;
	}

	if(GetField_CString(hMerchantBalAcct,"service",&csTmp))
	{
		hv_service_code.len = strlen(csTmp);
		strncpy((char *)hv_service_code.arr, csTmp, hv_service_code.len);
		ind_service_code = 0;
DEBUGLOG(("GetAutoSettId:service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
	} else {
DEBUGLOG(("GetAutoSettId:service_code NOT FOUND!!!\n"));
		return PD_ERR;
	}

	/* EXEC SQL SELECT 
		mb_support_auto_sett, mb_auto_sett_id
		 into :v_support_auto_sett:ind_support_auto_sett,:v_auto_sett_id:ind_auto_sett_id
		from merchant_bal_acct
		where mb_merchant_id = :hv_merchant_id:ind_merchant_id
		 and mb_country = :hv_country:ind_country
		 and mb_ccy_id = :hv_ccy:ind_ccy
		 and mb_service_code = :hv_service_code:ind_service_code; */ 

{
 struct sqlexd sqlstm;
 sqlstm.sqlvsn = 12;
 sqlstm.arrsiz = 15;
 sqlstm.sqladtp = &sqladt;
 sqlstm.sqltdsp = &sqltds;
 sqlstm.stmt = "select mb_support_auto_sett , mb_auto_sett_id into :b0:b1 ,\
 :b2:b3 from merchant_bal_acct where mb_merchant_id = :b4:b5 and mb_country =\
 :b6:b7 and mb_ccy_id = :b8:b9 and mb_service_code = :b10:b11 ";
 sqlstm.iters = (unsigned int  )1;
 sqlstm.offset = (unsigned int  )250;
 sqlstm.selerr = (unsigned short)1;
 sqlstm.cud = sqlcud0;
 sqlstm.sqlest = (unsigned char  *)&sqlca;
 sqlstm.sqlety = (unsigned short)4352;
 sqlstm.occurs = (unsigned int  )0;
 sqlstm.sqhstv[0] = (unsigned char  *)&v_support_auto_sett;
 sqlstm.sqhstl[0] = (unsigned long )sizeof(int);
 sqlstm.sqhsts[0] = (         int  )0;
 sqlstm.sqindv[0] = (         short *)&ind_support_auto_sett;
 sqlstm.sqinds[0] = (         int  )0;
 sqlstm.sqharm[0] = (unsigned long )0;
 sqlstm.sqadto[0] = (unsigned short )0;
 sqlstm.sqtdso[0] = (unsigned short )0;
 sqlstm.sqhstv[1] = (unsigned char  *)&v_auto_sett_id;
 sqlstm.sqhstl[1] = (unsigned long )sizeof(int);
 sqlstm.sqhsts[1] = (         int  )0;
 sqlstm.sqindv[1] = (         short *)&ind_auto_sett_id;
 sqlstm.sqinds[1] = (         int  )0;
 sqlstm.sqharm[1] = (unsigned long )0;
 sqlstm.sqadto[1] = (unsigned short )0;
 sqlstm.sqtdso[1] = (unsigned short )0;
 sqlstm.sqhstv[2] = (unsigned char  *)&hv_merchant_id;
 sqlstm.sqhstl[2] = (unsigned long )17;
 sqlstm.sqhsts[2] = (         int  )0;
 sqlstm.sqindv[2] = (         short *)&ind_merchant_id;
 sqlstm.sqinds[2] = (         int  )0;
 sqlstm.sqharm[2] = (unsigned long )0;
 sqlstm.sqadto[2] = (unsigned short )0;
 sqlstm.sqtdso[2] = (unsigned short )0;
 sqlstm.sqhstv[3] = (unsigned char  *)&hv_country;
 sqlstm.sqhstl[3] = (unsigned long )4;
 sqlstm.sqhsts[3] = (         int  )0;
 sqlstm.sqindv[3] = (         short *)&ind_country;
 sqlstm.sqinds[3] = (         int  )0;
 sqlstm.sqharm[3] = (unsigned long )0;
 sqlstm.sqadto[3] = (unsigned short )0;
 sqlstm.sqtdso[3] = (unsigned short )0;
 sqlstm.sqhstv[4] = (unsigned char  *)&hv_ccy;
 sqlstm.sqhstl[4] = (unsigned long )5;
 sqlstm.sqhsts[4] = (         int  )0;
 sqlstm.sqindv[4] = (         short *)&ind_ccy;
 sqlstm.sqinds[4] = (         int  )0;
 sqlstm.sqharm[4] = (unsigned long )0;
 sqlstm.sqadto[4] = (unsigned short )0;
 sqlstm.sqtdso[4] = (unsigned short )0;
 sqlstm.sqhstv[5] = (unsigned char  *)&hv_service_code;
 sqlstm.sqhstl[5] = (unsigned long )5;
 sqlstm.sqhsts[5] = (         int  )0;
 sqlstm.sqindv[5] = (         short *)&ind_service_code;
 sqlstm.sqinds[5] = (         int  )0;
 sqlstm.sqharm[5] = (unsigned long )0;
 sqlstm.sqadto[5] = (unsigned short )0;
 sqlstm.sqtdso[5] = (unsigned short )0;
 sqlstm.sqphsv = sqlstm.sqhstv;
 sqlstm.sqphsl = sqlstm.sqhstl;
 sqlstm.sqphss = sqlstm.sqhsts;
 sqlstm.sqpind = sqlstm.sqindv;
 sqlstm.sqpins = sqlstm.sqinds;
 sqlstm.sqparm = sqlstm.sqharm;
 sqlstm.sqparc = sqlstm.sqharc;
 sqlstm.sqpadto = sqlstm.sqadto;
 sqlstm.sqptdso = sqlstm.sqtdso;
 sqlcxt((void **)0, &sqlctx, &sqlstm, &sqlfpn);
 if (sqlca.sqlcode < 0) goto get_error;
}



	if(ind_support_auto_sett >= 0) {
DEBUGLOG(("GetAutoSettId:support_auto_sett = [%d]\n",v_support_auto_sett));
		*iSupportAutoSett = v_support_auto_sett;
	} else {
		*iSupportAutoSett = 0;
DEBUGLOG(("GetAutoSettId:DEFAULT support_auto_sett= [0]\n"));
	}

	if (ind_auto_sett_id >= 0) {
DEBUGLOG(("GetAutoSettId:auto_sett_id = [%d]\n",v_auto_sett_id));
		*iAutoSettId = v_auto_sett_id;
	} else {
		/* EXEC SQL SELECT 
			nvl(max(mb_auto_sett_id),0)+1 into v_auto_sett_id:ind_auto_sett_id
			from merchant_bal_acct; */ 

{
  struct sqlexd sqlstm;
  sqlstm.sqlvsn = 12;
  sqlstm.arrsiz = 15;
  sqlstm.sqladtp = &sqladt;
  sqlstm.sqltdsp = &sqltds;
  sqlstm.stmt = "select nvl ( max ( mb_auto_sett_id ) , 0 ) + 1 into :b0:b1\
 from merchant_bal_acct ";
  sqlstm.iters = (unsigned int  )1;
  sqlstm.offset = (unsigned int  )289;
  sqlstm.selerr = (unsigned short)1;
  sqlstm.cud = sqlcud0;
  sqlstm.sqlest = (unsigned char  *)&sqlca;
  sqlstm.sqlety = (unsigned short)4352;
  sqlstm.occurs = (unsigned int  )0;
  sqlstm.sqhstv[0] = (unsigned char  *)&v_auto_sett_id;
  sqlstm.sqhstl[0] = (unsigned long )sizeof(int);
  sqlstm.sqhsts[0] = (         int  )0;
  sqlstm.sqindv[0] = (         short *)&ind_auto_sett_id;
  sqlstm.sqinds[0] = (         int  )0;
  sqlstm.sqharm[0] = (unsigned long )0;
  sqlstm.sqadto[0] = (unsigned short )0;
  sqlstm.sqtdso[0] = (unsigned short )0;
  sqlstm.sqphsv = sqlstm.sqhstv;
  sqlstm.sqphsl = sqlstm.sqhstl;
  sqlstm.sqphss = sqlstm.sqhsts;
  sqlstm.sqpind = sqlstm.sqindv;
  sqlstm.sqpins = sqlstm.sqinds;
  sqlstm.sqparm = sqlstm.sqharm;
  sqlstm.sqparc = sqlstm.sqharc;
  sqlstm.sqpadto = sqlstm.sqadto;
  sqlstm.sqptdso = sqlstm.sqtdso;
  sqlcxt((void **)0, &sqlctx, &sqlstm, &sqlfpn);
  if (sqlca.sqlcode < 0) goto get_error;
}



		if (ind_auto_sett_id >= 0) {
DEBUGLOG(("GetAutoSettId:NEW auto_sett_id = [%d]\n",v_auto_sett_id));
			*iAutoSettId = v_auto_sett_id;
		}
	}

	return PD_OK;

get_error:
	DEBUGLOG(("get_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	/* EXEC SQL WHENEVER SQLERROR CONTINUE; */ 

	return PD_ERR;
}


int GetACRPool(const char* csMerchantID,
                const char* csCountry,
		const char* csCcy,
		const char* csServiceCode,
		char*	csACRPool)
{
	int iRet = PD_OK;
                
        /* EXEC SQL WHENEVER SQLERROR GOTO acr_error; */ 

        /* EXEC SQL WHENEVER NOTFOUND CONTINUE; */ 

                        
        /* EXEC SQL BEGIN DECLARE SECTION; */ 

                /* varchar         hv_merchant_id[PD_MERCHANT_ID_LEN]; */ 
struct { unsigned short len; unsigned char arr[15]; } hv_merchant_id;

                /* varchar         hv_country[PD_COUNTRY_LEN]; */ 
struct { unsigned short len; unsigned char arr[2]; } hv_country;

                /* varchar         hv_ccy[PD_CCY_ID_LEN]; */ 
struct { unsigned short len; unsigned char arr[3]; } hv_ccy;

                /* varchar         hv_service_code[PD_SERVICE_CODE_LEN]; */ 
struct { unsigned short len; unsigned char arr[3]; } hv_service_code;

		/* varchar         hv_status[PD_ACCOUNT_STATUS_LEN]; */ 
struct { unsigned short len; unsigned char arr[2]; } hv_status;

                
                /* varchar         v_preferred_acr_pool[PD_CCY_ID_LEN+1]; */ 
struct { unsigned short len; unsigned char arr[4]; } v_preferred_acr_pool;


		short		ind_preferred_acr_pool = -1;
        
        /* EXEC SQL END DECLARE SECTION; */ 

        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("GetACRPool merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_country.len = strlen(csCountry);
        memcpy(hv_country.arr,csCountry,hv_country.len);
DEBUGLOG(("GetACRPool country = [%.*s]\n",hv_country.len,hv_country.arr));

        hv_ccy.len = strlen(csCcy);
        memcpy(hv_ccy.arr,csCcy,hv_ccy.len);
DEBUGLOG(("GetACRPool ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("GetACRPool service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
        
	hv_status.len = strlen(PD_ACC_OPEN);
        memcpy(hv_status.arr,PD_ACC_OPEN,hv_status.len);

	/* EXEC SQL SELECT 
			mb_preferred_acr_pool
		INTO 
		     :v_preferred_acr_pool:ind_preferred_acr_pool
		FROM merchant_bal_acct
	       WHERE mb_merchant_id = :hv_merchant_id
		 AND mb_country = :hv_country
		 AND mb_ccy_id = :hv_ccy
		 AND mb_service_code = :hv_service_code
		 AND mb_disabled = 0
		 AND mb_status = :hv_status; */ 

{
 struct sqlexd sqlstm;
 sqlstm.sqlvsn = 12;
 sqlstm.arrsiz = 15;
 sqlstm.sqladtp = &sqladt;
 sqlstm.sqltdsp = &sqltds;
 sqlstm.stmt = "select mb_preferred_acr_pool INTO :b0:b1 FROM merchant_bal_\
acct WHERE mb_merchant_id = :b2 AND mb_country = :b3 AND mb_ccy_id = :b4 AND \
mb_service_code = :b5 AND mb_disabled = 0 AND mb_status = :b6 ";
 sqlstm.iters = (unsigned int  )1;
 sqlstm.offset = (unsigned int  )308;
 sqlstm.selerr = (unsigned short)1;
 sqlstm.cud = sqlcud0;
 sqlstm.sqlest = (unsigned char  *)&sqlca;
 sqlstm.sqlety = (unsigned short)4352;
 sqlstm.occurs = (unsigned int  )0;
 sqlstm.sqhstv[0] = (unsigned char  *)&v_preferred_acr_pool;
 sqlstm.sqhstl[0] = (unsigned long )6;
 sqlstm.sqhsts[0] = (         int  )0;
 sqlstm.sqindv[0] = (         short *)&ind_preferred_acr_pool;
 sqlstm.sqinds[0] = (         int  )0;
 sqlstm.sqharm[0] = (unsigned long )0;
 sqlstm.sqadto[0] = (unsigned short )0;
 sqlstm.sqtdso[0] = (unsigned short )0;
 sqlstm.sqhstv[1] = (unsigned char  *)&hv_merchant_id;
 sqlstm.sqhstl[1] = (unsigned long )17;
 sqlstm.sqhsts[1] = (         int  )0;
 sqlstm.sqindv[1] = (         short *)0;
 sqlstm.sqinds[1] = (         int  )0;
 sqlstm.sqharm[1] = (unsigned long )0;
 sqlstm.sqadto[1] = (unsigned short )0;
 sqlstm.sqtdso[1] = (unsigned short )0;
 sqlstm.sqhstv[2] = (unsigned char  *)&hv_country;
 sqlstm.sqhstl[2] = (unsigned long )4;
 sqlstm.sqhsts[2] = (         int  )0;
 sqlstm.sqindv[2] = (         short *)0;
 sqlstm.sqinds[2] = (         int  )0;
 sqlstm.sqharm[2] = (unsigned long )0;
 sqlstm.sqadto[2] = (unsigned short )0;
 sqlstm.sqtdso[2] = (unsigned short )0;
 sqlstm.sqhstv[3] = (unsigned char  *)&hv_ccy;
 sqlstm.sqhstl[3] = (unsigned long )5;
 sqlstm.sqhsts[3] = (         int  )0;
 sqlstm.sqindv[3] = (         short *)0;
 sqlstm.sqinds[3] = (         int  )0;
 sqlstm.sqharm[3] = (unsigned long )0;
 sqlstm.sqadto[3] = (unsigned short )0;
 sqlstm.sqtdso[3] = (unsigned short )0;
 sqlstm.sqhstv[4] = (unsigned char  *)&hv_service_code;
 sqlstm.sqhstl[4] = (unsigned long )5;
 sqlstm.sqhsts[4] = (         int  )0;
 sqlstm.sqindv[4] = (         short *)0;
 sqlstm.sqinds[4] = (         int  )0;
 sqlstm.sqharm[4] = (unsigned long )0;
 sqlstm.sqadto[4] = (unsigned short )0;
 sqlstm.sqtdso[4] = (unsigned short )0;
 sqlstm.sqhstv[5] = (unsigned char  *)&hv_status;
 sqlstm.sqhstl[5] = (unsigned long )4;
 sqlstm.sqhsts[5] = (         int  )0;
 sqlstm.sqindv[5] = (         short *)0;
 sqlstm.sqinds[5] = (         int  )0;
 sqlstm.sqharm[5] = (unsigned long )0;
 sqlstm.sqadto[5] = (unsigned short )0;
 sqlstm.sqtdso[5] = (unsigned short )0;
 sqlstm.sqphsv = sqlstm.sqhstv;
 sqlstm.sqphsl = sqlstm.sqhstl;
 sqlstm.sqphss = sqlstm.sqhsts;
 sqlstm.sqpind = sqlstm.sqindv;
 sqlstm.sqpins = sqlstm.sqinds;
 sqlstm.sqparm = sqlstm.sqharm;
 sqlstm.sqparc = sqlstm.sqharc;
 sqlstm.sqpadto = sqlstm.sqadto;
 sqlstm.sqptdso = sqlstm.sqtdso;
 sqlcxt((void **)0, &sqlctx, &sqlstm, &sqlfpn);
 if (sqlca.sqlcode < 0) goto acr_error;
}




	if(ind_preferred_acr_pool>= 0){
		v_preferred_acr_pool.arr[v_preferred_acr_pool.len]='\0';
		strcpy((char*)csACRPool,(const char*)v_preferred_acr_pool.arr);
		csACRPool[PD_CCY_ID_LEN] = '\0';
DEBUGLOG(("GetACRPool preferred acr pool =[%s]\n",csACRPool));
	}
	else{
		strcpy((char*)csACRPool,PD_CCY_UNKNOWN);
		csACRPool[PD_CCY_ID_LEN] = '\0';
DEBUGLOG(("GetACRPool preferred acr pool (not found) =[%s]\n",csACRPool));
	}


DEBUGLOG(("GetACRPool Normal Exit [%d]\n",iRet));
	return iRet;

acr_error:
DEBUGLOG(("acr_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        /* EXEC SQL WHENEVER SQLERROR CONTINUE; */ 

        return PD_ERR;
}
