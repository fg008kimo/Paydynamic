/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/06/07              LokMan Chow
Add UpdateMerchantBalAcctStatus                    2011/09/23              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "MerchantBalAcct.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void MerchantBalAcct(char    cdebug)
{
        cDebug = cdebug;
}

int CheckMerchantBalAcct(const char* csMerchantID,
                const char* csCountry,
		const char* csCcy,
		const char* csServiceCode,
		hash_t *hRec)
{
	int iRet = PD_NOT_FOUND;
                
        EXEC SQL WHENEVER SQLERROR GOTO check_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar         hv_country[PD_COUNTRY_LEN];
                varchar         hv_ccy[PD_CCY_ID_LEN];
                varchar         hv_service_code[PD_SERVICE_CODE_LEN];
		varchar         hv_status[PD_ACCOUNT_STATUS_LEN];
                
		short		v_cnt;
		//char		v_allow_payout;
		int		v_allow_payout;

		short		ind_allow_payout = -1 ;
        
        
        EXEC SQL END DECLARE SECTION;
        
        hv_merchant_id.len = strlen(csMerchantID);
        memcpy(hv_merchant_id.arr,csMerchantID,hv_merchant_id.len);
DEBUGLOG(("CheckMerchantBalAcct merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
        
        hv_country.len = strlen(csCountry);
        memcpy(hv_country.arr,csCountry,hv_country.len);
DEBUGLOG(("CheckMerchantBalAcct country = [%.*s]\n",hv_country.len,hv_country.arr));

        hv_ccy.len = strlen(csCcy);
        memcpy(hv_ccy.arr,csCcy,hv_ccy.len);
DEBUGLOG(("CheckMerchantBalAcct ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("CheckMerchantBalAcct service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
        
	hv_status.len = strlen(PD_ACC_OPEN);
        memcpy(hv_status.arr,PD_ACC_OPEN,hv_status.len);

        EXEC SQL SELECT	nvl(COUNT(*),0)
		   INTO :v_cnt
                   FROM merchant_bal_acct
                  WHERE mb_merchant_id = :hv_merchant_id
                    AND mb_country = :hv_country
                    AND mb_ccy_id = :hv_ccy
		    AND mb_service_code = :hv_service_code
                    AND mb_disabled = 0
		    AND mb_status = :hv_status;


	if (v_cnt > 0){
		iRet = PD_FOUND;
DEBUGLOG(("CheckMerchantBalAcct  found! [%d]\n",v_cnt));

		EXEC SQL SELECT mb_allow_payout
			INTO :v_allow_payout:ind_allow_payout
			FROM merchant_bal_acct
		       WHERE mb_merchant_id = :hv_merchant_id
			 AND mb_country = :hv_country
			 AND mb_ccy_id = :hv_ccy
			 AND mb_service_code = :hv_service_code
			 AND mb_disabled = 0
			 AND mb_status = :hv_status;

		if(ind_allow_payout>=0){
			PutField_Int(hRec,"allow_payout",v_allow_payout);
DEBUGLOG(("CheckMerchantBalAcct allow_payout=[%d]\n",v_allow_payout));
		}
		else{
			PutField_Int(hRec,"allow_payout",PD_FALSE);
		}
	}
	else {
DEBUGLOG(("CheckMerchantBalAcct Not found! [%d]\n",v_cnt));
	}
	

DEBUGLOG(("CheckMerchantBalAcct Normal Exit [%d]\n",iRet));
	return iRet;

check_error:
DEBUGLOG(("check_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}



int UpdateMerchantBalAcctStatus(const hash_t *hRls)
{
        char*     csTmp;
        char*     csMerchantId;
        char*     csCountry;
        char*     csCcyId;
        char*     csServiceCode;

        EXEC SQL WHENEVER SQLERROR GOTO updatestatus_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                varchar        hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("UpdateMerchantBalAcctStatus: Begin\n"));

        strcpy((char*)hv_dynstmt.arr,"update merchant_bal_acct set mb_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"merchant_id",&csMerchantId);
DEBUGLOG(("UpdateMerchantBalAcctStatus: merchant_id = [%s]\n", csMerchantId));

        GetField_CString(hRls,"country",&csCountry);
DEBUGLOG(("UpdateMerchantBalAcctStatus: country = [%s]\n", csCountry));

        GetField_CString(hRls,"ccy",&csCcyId);
DEBUGLOG(("UpdateMerchantBalAcctStatus: ccy = [%s]\n", csCcyId));

        GetField_CString(hRls,"service",&csServiceCode);
DEBUGLOG(("UpdateMerchantBalAcctStatus: service = [%s]\n", csServiceCode));

/*status */
        if (GetField_CString(hRls,"status",&csTmp)) {
DEBUGLOG(("UpdateMerchantBalAcctStatus:status = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mb_status = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/*update_user*/
        if(GetField_CString(hRls,"update_user",&csTmp)){
DEBUGLOG(("UpdateMerchantBalAcctStatus:update_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mb_update_user= '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        strcat((char *)hv_dynstmt.arr, " WHERE mb_merchant_id = '");
        strcat((char *)hv_dynstmt.arr, csMerchantId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND mb_country = '");
        strcat((char *)hv_dynstmt.arr, csCountry);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND mb_ccy_id = '");
        strcat((char *)hv_dynstmt.arr, csCcyId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        strcat((char *)hv_dynstmt.arr, " AND mb_service_code = '");
        strcat((char *)hv_dynstmt.arr, csServiceCode);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;


DEBUGLOG(("Update Normal Exit\n"));
        return PD_OK;

updatestatus_error:
DEBUGLOG(("updatestatus_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("MerantantBalAcct_UpdateMerchantBalAcctStatus: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("UpdateMerchantBalAcctStatus: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;

}
