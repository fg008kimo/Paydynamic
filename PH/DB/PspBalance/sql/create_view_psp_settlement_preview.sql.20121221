DROP VIEW PSP_SETTLEMENT_PREVIEW_VIEW;

/* Formatted on 9/21/2012 12:53:59 PM (QP5 v5.226.12202.30050) */
CREATE OR REPLACE FORCE VIEW PSP_SETTLEMENT_PREVIEW_VIEW
(
   MB_POSTING_DATE,
   MB_MERCHANT_ID,
   MB_COUNTRY_ID,
   MB_CURRENCY_ID,
   MB_SERVICE_CODE,
   MB_PSP_ID,
   MBP_BAL
)
AS
     SELECT mb_posting_date,
            mb_merchant_id,
            mb_country_id,
            mb_currency_id,
            mb_service_code,
            mb_psp_id,
            SUM (mb_bal) AS mbp_bal
       FROM merchant_bucket
      WHERE     mb_bucket_type = 'AF'
            AND mb_released_date IS NULL
            AND mb_posting_date <= release_pkg.find_release_date (
                                      (SELECT sys_val
                                         FROM system_control
                                        WHERE sys_code = 'CTPHDATE'),
                                      (  SELECT mb_country_id
                                           FROM merchant_bucket
                                          WHERE     mb_bucket_type = 'AF'
                                                AND mb_released_date IS NULL
                                       GROUP BY mb_country_id),
                                      (SELECT rs_release_period
                                         FROM rule_service_release_period,
                                              (  SELECT mb_country_id,
                                                        mb_service_code
                                                   FROM merchant_bucket
                                                  WHERE     mb_bucket_type = 'AF'
                                                        AND mb_released_date
                                                               IS NULL
                                               GROUP BY mb_country_id,
                                                        mb_service_code) left
                                        WHERE     rs_release_type = 'SETTFT'
                                              AND rs_service_code =
                                                     mb_service_code
                                              AND rs_disabled = 0))
   GROUP BY mb_posting_date,
            mb_merchant_id,
            mb_country_id,
            mb_currency_id,
            mb_service_code,
            mb_psp_id
   UNION ALL
     SELECT mbp_posting_date,
            mbp_merchant_id,
            mbp_country_id,
            mbp_currency_id,
            mbp_service_code,
            mbp_psp_id,
            SUM (mbp_bal) AS mbp_bal
       FROM merchant_bucket_preview
      WHERE     mbp_bucket_type = 'AF'
            AND mbp_posting_date <= release_pkg.find_release_date (
                                       (SELECT sys_val
                                          FROM system_control
                                         WHERE sys_code = 'CTPHDATE'),
                                       (  SELECT mb_country_id
                                            FROM merchant_bucket
                                           WHERE     mb_bucket_type = 'AF'
                                                 AND mb_released_date IS NULL
                                        GROUP BY mb_country_id),
                                       (SELECT rs_release_period
                                          FROM rule_service_release_period,
                                               (  SELECT mb_country_id,
                                                         mb_service_code
                                                    FROM merchant_bucket
                                                   WHERE     mb_bucket_type =
                                                                'AF'
                                                         AND mb_released_date
                                                                IS NULL
                                                GROUP BY mb_country_id,
                                                         mb_service_code) left
                                         WHERE     rs_release_type = 'SETTFT'
                                               AND rs_service_code =
                                                      mb_service_code
                                               AND rs_disabled = 0))
   GROUP BY mbp_posting_date,
            mbp_merchant_id,
            mbp_country_id,
            mbp_currency_id,
            mbp_service_code,
            mbp_psp_id;

