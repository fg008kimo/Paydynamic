/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version 			                   2015/11/05              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLTxnMiDetail.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void OLTxnMiDetail(char    cdebug)
{
        cDebug = cdebug;
}


int Add(const hash_t* hRls)
{
	char            *csTmp;
        double          dTmp;
	int		iTmp;

        EXEC SQL WHENEVER SQLERROR GOTO add_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        short           hv_return_value;
	
	varchar         hv_txn_id[PD_TXN_SEQ_LEN];
       	varchar         hv_entity_id[PD_MMS_ENTITY_ID_LEN + 1];
     	varchar         hv_party_type[PD_MMS_PARTY_TYPE_LEN + 1];
   	varchar         hv_party_id[PD_MMS_PARTY_ID_LEN + 1];
     	varchar         hv_txn_ccy[PD_CCY_ID_LEN + 1];
   	varchar         hv_txn_country[PD_COUNTRY_LEN + 1];
      	varchar         hv_txn_product[PD_PRODUCT_CODE_LEN + 1];
      	double          hv_open_acct_bal;
      	double          hv_acct_bal;
      	double          hv_open_intransit;
     	double          hv_intransit;
     	double          hv_open_ar_bal;
     	double          hv_ar_bal;
      	varchar         hv_txn_date[PD_DATE_LEN + 1];
      	varchar         hv_report_date[PD_DATE_LEN + 1];
      	double          hv_cost_rate;
      	double          hv_actual_cost;
     	varchar         hv_remittance_slip_date[PD_DATE_LEN + 1];
       	varchar         hv_converted_ccy[PD_CCY_ID_LEN + 1];
     	double          hv_converted_amount;
     	varchar         hv_remark[PD_REMARK_LEN + 1];
        varchar         hv_prev_grp_txn_id[PD_TXN_SEQ_LEN + 1];
     	varchar         hv_next_grp_txn_id[PD_TXN_SEQ_LEN + 1];
    	int             hv_acr_prorata;	
       	varchar         hv_entity_ccy[PD_CCY_ID_LEN + 1];
     	double          hv_entity_txn_amount;
	varchar         hv_add_user[PD_USER_LEN];

     	short           ind_txn_id = -1;
       	short           ind_entity_id = -1;
    	short           ind_party_type = -1;
      	short           ind_party_id = -1;
   	short           ind_txn_ccy = -1;
    	short           ind_txn_country = -1;
      	short           ind_txn_product = -1;
    	short           ind_open_acct_bal = -1;
     	short           ind_acct_bal = -1;
      	short           ind_open_intransit = -1;
     	short           ind_intransit = -1;
      	short           ind_open_ar_bal = -1;
     	short           ind_ar_bal = -1;
     	short           ind_txn_date = -1;
      	short           ind_report_date = -1;
      	short           ind_cost_rate = -1;
     	short           ind_actual_cost = -1;
     	short           ind_remittance_slip_date = -1;
     	short           ind_converted_ccy = -1;
     	short           ind_converted_amount = -1;
      	short           ind_remark = -1;
      	short           ind_prev_grp_txn_id = -1;
       	short           ind_next_grp_txn_id = -1;
     	short           ind_acr_prorata = -1;
     	short           ind_entity_ccy = -1;
     	short           ind_entity_txn_amount = -1;
     	short           ind_add_user = -1;
	
	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));

/* txn_seq */
        if (GetField_CString(hRls,"txn_seq",&csTmp)) {
                hv_txn_id.len = strlen(csTmp);
                memcpy(hv_txn_id.arr,csTmp,hv_txn_id.len);
                ind_txn_id = 0;
DEBUGLOG(("Add:txn_id = [%.*s][%d]\n",hv_txn_id.len,hv_txn_id.arr,hv_txn_id.len));
        }	

/* entity_id */
        if (GetField_CString(hRls,"entity_id",&csTmp)) {
                hv_entity_id.len = strlen(csTmp);
                memcpy(hv_entity_id.arr,csTmp,hv_entity_id.len);
                ind_entity_id = 0;
DEBUGLOG(("Add:entity_id = [%.*s][%d]\n",hv_entity_id.len,hv_entity_id.arr,hv_entity_id.len));
        }

/* party_type */
        if (GetField_CString(hRls,"party_type",&csTmp)) {
                hv_party_type.len = strlen(csTmp);
                memcpy(hv_party_type.arr,csTmp,hv_party_type.len);
                ind_party_type = 0;
DEBUGLOG(("Add:party_type = [%.*s][%d]\n",hv_party_type.len,hv_party_type.arr,hv_party_type.len));
        }

/* party_id */
        if (GetField_CString(hRls,"party_id",&csTmp)) {
                hv_party_id.len = strlen(csTmp);
                memcpy(hv_party_id.arr,csTmp,hv_party_id.len);
                ind_party_id = 0;
DEBUGLOG(("Add:party_id = [%.*s][%d]\n",hv_party_id.len,hv_party_id.arr,hv_party_id.len));
        }

/* txn_ccy */
        if (GetField_CString(hRls,"txn_ccy",&csTmp)) {
                hv_txn_ccy.len = strlen(csTmp);
                memcpy(hv_txn_ccy.arr,csTmp,hv_txn_ccy.len);
                ind_txn_ccy = 0;
DEBUGLOG(("Add:txn_ccy = [%.*s][%d]\n",hv_txn_ccy.len,hv_txn_ccy.arr,hv_txn_ccy.len));
        }

/* txn_country */
        if (GetField_CString(hRls,"txn_country",&csTmp)) {
                hv_txn_country.len = strlen(csTmp);
                memcpy(hv_txn_country.arr,csTmp,hv_txn_country.len);
                ind_txn_country = 0;
DEBUGLOG(("Add:txn_country = [%.*s][%d]\n",hv_txn_country.len,hv_txn_country.arr,hv_txn_country.len));
        }

/* txn_product */
        if (GetField_CString(hRls,"txn_product",&csTmp)) {
                hv_txn_product.len = strlen(csTmp);
                memcpy(hv_txn_product.arr,csTmp,hv_txn_product.len);
                ind_txn_product = 0;
DEBUGLOG(("Add:txn_product = [%.*s][%d]\n",hv_txn_product.len,hv_txn_product.arr,hv_txn_product.len));
        }

/* open_acct_bal */
        if (GetField_Double(hRls,"open_acct_bal",&dTmp)) {
                hv_open_acct_bal= dTmp;
                ind_open_acct_bal = 0;
DEBUGLOG(("Add:open_acct_bal = [%f]\n",hv_open_acct_bal));
        }

/* acct_bal */
        if (GetField_Double(hRls,"acct_bal",&dTmp)) {
                hv_acct_bal= dTmp;
                ind_acct_bal = 0;
DEBUGLOG(("Add:acct_bal = [%f]\n",hv_acct_bal));
        }

/* open_intransit */
        if (GetField_Double(hRls,"open_intransit",&dTmp)) {
                hv_open_intransit= dTmp;
                ind_open_intransit = 0;
DEBUGLOG(("Add:open_intransit = [%f]\n",hv_open_intransit));
        }

/* intransit */
        if (GetField_Double(hRls,"intransit",&dTmp)) {
                hv_intransit= dTmp;
                ind_intransit = 0;
DEBUGLOG(("Add:intransit = [%f]\n",hv_intransit));
        }

/* open_ar_bal */
        if (GetField_Double(hRls,"open_ar_bal",&dTmp)) {
                hv_open_ar_bal= dTmp;
                ind_open_ar_bal = 0;
DEBUGLOG(("Add:open_ar_bal = [%f]\n",hv_open_ar_bal));
        }

/* ar_bal */
        if (GetField_Double(hRls,"ar_bal",&dTmp)) {
                hv_ar_bal= dTmp;
                ind_ar_bal = 0;
DEBUGLOG(("Add:ar_bal = [%f]\n",hv_ar_bal));
        }

/* txn_date */
        if (GetField_CString(hRls,"txn_date",&csTmp)) {
                hv_txn_date.len = strlen(csTmp);
                memcpy(hv_txn_date.arr,csTmp,hv_txn_date.len);
                ind_txn_date = 0;
DEBUGLOG(("Add:txn_date = [%.*s][%d]\n",hv_txn_date.len,hv_txn_date.arr,hv_txn_date.len));
        }

/* report_date */
        if (GetField_CString(hRls,"report_date",&csTmp)) {
                hv_report_date.len = strlen(csTmp);
                memcpy(hv_report_date.arr,csTmp,hv_report_date.len);
                ind_report_date = 0;
DEBUGLOG(("Add:report_date = [%.*s][%d]\n",hv_report_date.len,hv_report_date.arr,hv_report_date.len));
        }

/* cost_rate */
        if (GetField_Double(hRls,"cost_rate",&dTmp)) {
                hv_cost_rate= dTmp;
                ind_cost_rate = 0;
DEBUGLOG(("Add:cost_rate = [%f]\n",hv_cost_rate));
        }

/* actual_cost */
        if (GetField_Double(hRls,"actual_cost",&dTmp)) {
                hv_actual_cost= dTmp;
                ind_actual_cost = 0;
DEBUGLOG(("Add:actual_cost = [%f]\n",hv_actual_cost));
        }

/* remittance_slip_date */
        if (GetField_CString(hRls,"remittance_slip_date",&csTmp)) {
                hv_remittance_slip_date.len = strlen(csTmp);
                memcpy(hv_remittance_slip_date.arr,csTmp,hv_remittance_slip_date.len);
                ind_remittance_slip_date = 0;
DEBUGLOG(("Add:remittance_slip_date = [%.*s][%d]\n",hv_remittance_slip_date.len,hv_remittance_slip_date.arr,hv_remittance_slip_date.len));
        }

/* converted_ccy */
        if (GetField_CString(hRls,"converted_ccy",&csTmp)) {
                hv_converted_ccy.len = strlen(csTmp);
                memcpy(hv_converted_ccy.arr,csTmp,hv_converted_ccy.len);
                ind_converted_ccy = 0;
DEBUGLOG(("Add:converted_ccy = [%.*s][%d]\n",hv_converted_ccy.len,hv_converted_ccy.arr,hv_converted_ccy.len));
        }

/* converted_amount */
        if (GetField_Double(hRls,"converted_amount",&dTmp)) {
                hv_converted_amount= dTmp;
                ind_converted_amount = 0;
DEBUGLOG(("Add:converted_amount = [%f]\n",hv_converted_amount));
        }

/* remark */
        if (GetField_CString(hRls,"remark",&csTmp)) {
                hv_remark.len = strlen(csTmp);
                memcpy(hv_remark.arr,csTmp,hv_remark.len);
                ind_remark = 0;
DEBUGLOG(("Add:remark = [%.*s][%d]\n",hv_remark.len,hv_remark.arr,hv_remark.len));
        }

/* prev_grp_txn_id */
        if (GetField_CString(hRls,"prev_grp_txn_id",&csTmp)) {
                hv_prev_grp_txn_id.len = strlen(csTmp);
                memcpy(hv_prev_grp_txn_id.arr,csTmp,hv_prev_grp_txn_id.len);
                ind_prev_grp_txn_id = 0;
DEBUGLOG(("Add:prev_grp_txn_id = [%.*s][%d]\n",hv_prev_grp_txn_id.len,hv_prev_grp_txn_id.arr,hv_prev_grp_txn_id.len));
        }

/* next_grp_txn_id */
        if (GetField_CString(hRls,"next_grp_txn_id",&csTmp)) {
                hv_next_grp_txn_id.len = strlen(csTmp);
                memcpy(hv_next_grp_txn_id.arr,csTmp,hv_next_grp_txn_id.len);
                ind_next_grp_txn_id = 0;
DEBUGLOG(("Add:next_grp_txn_id = [%.*s][%d]\n",hv_next_grp_txn_id.len,hv_next_grp_txn_id.arr,hv_next_grp_txn_id.len));
        }

/* acr_prorata */
        if (GetField_Int(hRls,"acr_prorata",&iTmp)) {
                hv_acr_prorata= iTmp;
                ind_acr_prorata = 0;
DEBUGLOG(("Add:acr_prorata = [%d]\n",hv_acr_prorata));
        }

/* entity_ccy */
        if (GetField_CString(hRls,"entity_ccy",&csTmp)) {
                hv_entity_ccy.len = strlen(csTmp);
                memcpy(hv_entity_ccy.arr,csTmp,hv_entity_ccy.len);
                ind_entity_ccy = 0;
DEBUGLOG(("Add:entity_ccy = [%.*s][%d]\n",hv_entity_ccy.len,hv_entity_ccy.arr,hv_entity_ccy.len));
        }

/* entity_txn_amount */
        if (GetField_Double(hRls,"entity_txn_amount",&dTmp)) {
                hv_entity_txn_amount= dTmp;
                ind_entity_txn_amount = 0;
DEBUGLOG(("Add:entity_txn_amount = [%f]\n",hv_entity_txn_amount));
        }

/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
                hv_add_user.len = strlen(csTmp);
                memcpy(hv_add_user.arr,csTmp,hv_add_user.len);
                ind_add_user = 0;
DEBUGLOG(("Add:add_user = [%.*s]\n",hv_add_user.len,hv_add_user.arr));
        }

	EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_ol_txn_mi_detail_insert(
                                        :hv_txn_id:ind_txn_id,
                                        :hv_entity_id:ind_entity_id,
                                        :hv_party_type:ind_party_type,
                                        :hv_party_id:ind_party_id,
                                        :hv_txn_ccy:ind_txn_ccy,
                                        :hv_txn_country:ind_txn_country,
                                        :hv_txn_product:ind_txn_product,
                                        :hv_open_acct_bal:ind_open_acct_bal,
                                        :hv_acct_bal:ind_acct_bal,
                                        :hv_open_intransit:ind_open_intransit,
                                        :hv_intransit:ind_intransit,
                                        :hv_open_ar_bal:ind_open_ar_bal,
                                        :hv_ar_bal:ind_ar_bal,
                                        :hv_txn_date:ind_txn_date,
                                        :hv_report_date:ind_report_date,
                                        :hv_cost_rate:ind_cost_rate,
                                        :hv_actual_cost:ind_actual_cost,
                                        :hv_remittance_slip_date:ind_remittance_slip_date,
                                        :hv_converted_ccy:ind_converted_ccy,
                                        :hv_converted_amount:ind_converted_amount,
                                        :hv_remark:ind_remark,
                                        :hv_prev_grp_txn_id:ind_prev_grp_txn_id,
                                        :hv_next_grp_txn_id:ind_next_grp_txn_id,
                                        :hv_acr_prorata:ind_acr_prorata,
                                        :hv_entity_ccy:ind_entity_ccy,
                                        :hv_entity_txn_amount:ind_entity_txn_amount,
                                        :hv_add_user:ind_add_user);
                END;
        END-EXEC;

DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK) {
DEBUGLOG(("Add:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("OLTxnMiDetail_Add: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
                TxnAbort();
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("OLTxnMiDetail_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
                TxnAbort();
                return PD_ERR;
        }

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("OLTxnMiDetail_Add: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;
}	

int Update(const hash_t* hRls)
{
	char*   csTxnId;
	char*   csBuf;
	char*   csTmp;
        double  dTmp;
        int     iTmp;

        EXEC SQL WHENEVER SQLERROR GOTO update_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        varchar         hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
        csBuf = (char*) malloc (128);
        strcpy((char*)hv_dynstmt.arr,"update ol_txn_mi_detail set otm_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"txn_seq",&csTxnId);
DEBUGLOG(("Update:txn_id = [%s]\n",csTxnId));	
	
/* entity_id  */
        if (GetField_CString(hRls,"entity_id",&csTmp)) {
DEBUGLOG(("Update:entity_id = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_entity_id = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* party_type */
        if (GetField_CString(hRls,"party_type",&csTmp)) {
DEBUGLOG(("Update:party_type = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_party_type = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* party_id */
        if (GetField_CString(hRls,"party_id",&csTmp)) {
DEBUGLOG(("Update:party_id = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_party_id = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* txn_ccy */
        if (GetField_CString(hRls,"txn_ccy",&csTmp)) {
DEBUGLOG(("Update:txn_ccy = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_txn_ccy = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* txn_country */
        if (GetField_CString(hRls,"txn_country",&csTmp)) {
DEBUGLOG(("Update:txn_country = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_txn_country = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* txn_product */
        if (GetField_CString(hRls,"txn_product",&csTmp)) {
DEBUGLOG(("Update:txn_product = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_txn_product = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* open_acct_bal */
        if (GetField_Double(hRls,"open_acct_bal",&dTmp)) {
DEBUGLOG(("Update:open_acct_bal = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otm_open_acct_bal = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* acct_bal */
        if (GetField_Double(hRls,"acct_bal",&dTmp)) {
DEBUGLOG(("Update:acct_bal = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otm_acct_bal = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* open_intransit */
        if (GetField_Double(hRls,"open_intransit",&dTmp)) {
DEBUGLOG(("Update:open_intransit = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otm_open_intransit = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* intransit */
        if (GetField_Double(hRls,"intransit",&dTmp)) {
DEBUGLOG(("Update:intransit = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otm_intransit = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* open_ar_bal */
        if (GetField_Double(hRls,"open_ar_bal",&dTmp)) {
DEBUGLOG(("Update:open_ar_bal = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otm_open_ar_bal = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* ar_bal */
        if (GetField_Double(hRls,"ar_bal",&dTmp)) {
DEBUGLOG(("Update:ar_bal = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otm_ar_bal = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* txn_date */
        if (GetField_CString(hRls,"txn_date",&csTmp)) {
DEBUGLOG(("Update:txn_date = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_txn_date = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* report_date*/
        if (GetField_CString(hRls,"report_date",&csTmp)) {
DEBUGLOG(("Update:report_date = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_report_date = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* cost_rate */
        if (GetField_Double(hRls,"cost_rate",&dTmp)) {
DEBUGLOG(("Update:cost_rate = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otm_cost_rate = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* actual_cost */
        if (GetField_Double(hRls,"actual_cost",&dTmp)) {
DEBUGLOG(("Update:actual_cost = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otm_actual_cost = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* remittance_slip_date */
        if (GetField_CString(hRls,"remittance_slip_date",&csTmp)) {
DEBUGLOG(("Update:remittance_slip_date = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_remittance_slip_date = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* converted_ccy */
        if (GetField_CString(hRls,"converted_ccy",&csTmp)) {
DEBUGLOG(("Update:converted_ccy = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_converted_ccy = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* converted_amount */
        if (GetField_Double(hRls,"converted_amount",&dTmp)) {
DEBUGLOG(("Update:converted_amount = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otm_converted_amount = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* remark */
        if (GetField_CString(hRls,"remark",&csTmp)) {
DEBUGLOG(("Update:remark = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_remark = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* prev_grp_txn_id */
        if (GetField_CString(hRls,"prev_grp_txn_id",&csTmp)) {
DEBUGLOG(("Update:prev_grp_txn_id = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_prev_grp_txn_id = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* next_grp_txn_id */
        if (GetField_CString(hRls,"next_grp_txn_id",&csTmp)) {
DEBUGLOG(("Update:next_grp_txn_id = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_next_grp_txn_id = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* acr_prorata */
        if (GetField_Int(hRls,"acr_prorata",&iTmp)) {
DEBUGLOG(("Update:acr_prorata = [%d]\n",iTmp));
                sprintf(csBuf,"%d",iTmp);
                strcat((char*)hv_dynstmt.arr, ",otm_acr_prorata = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* entity_ccy */
        if (GetField_CString(hRls,"entity_ccy",&csTmp)) {
DEBUGLOG(("Update:entity_ccy = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_entity_ccy = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* entity_txn_amount */
        if (GetField_Double(hRls,"entity_txn_amount",&dTmp)) {
DEBUGLOG(("Update:entity_txn_amount = [%lf]\n",dTmp));
                sprintf(csBuf,"%f",dTmp);
                strcat((char*)hv_dynstmt.arr, ",otm_entity_txn_amount = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* add user */
        if (GetField_CString(hRls,"add_user",&csTmp)) {
DEBUGLOG(("Update:add_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_create_user = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* update user */
        if (GetField_CString(hRls,"update_user",&csTmp)) {
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",otm_update_user = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        strcat((char *)hv_dynstmt.arr, " WHERE otm_txn_id = '");
        strcat((char *)hv_dynstmt.arr, csTxnId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

        FREE_ME(csBuf);

DEBUGLOG(("Update Normal Exit\n"));
        return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("OLTxnMiDetail_Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
        TxnAbort();
        return PD_INTERNAL_ERR;	
}

int GetOLTxnMiDetail(const char* csTxnId, 
		recordset_t* myRec)
{
	hash_t *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO getoltxnmidetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar         hv_txn_id[PD_TXN_SEQ_LEN];

		varchar         v_entity_id[PD_MMS_ENTITY_ID_LEN + 1];		
		varchar         v_party_type[PD_MMS_PARTY_TYPE_LEN + 1];		
		varchar         v_party_id[PD_MMS_PARTY_ID_LEN + 1];		
		varchar         v_txn_ccy[PD_CCY_ID_LEN + 1];		
		varchar         v_txn_country[PD_COUNTRY_LEN + 1];		
		varchar         v_txn_product[PD_PRODUCT_CODE_LEN + 1];		
		double          v_open_acct_bal;
		double          v_acct_bal;
		double          v_open_intransit;
		double          v_intransit;
		double          v_open_ar_bal;
		double          v_ar_bal;
		varchar         v_txn_date[PD_DATE_LEN + 1];
		varchar         v_report_date[PD_DATE_LEN + 1];		
		double          v_cost_rate;
		double          v_actual_cost;
		varchar         v_remittance_slip_date[PD_DATE_LEN + 1];
		varchar         v_converted_ccy[PD_CCY_ID_LEN + 1];
		double          v_converted_amount;
		varchar         v_remark[PD_REMARK_LEN + 1];
		varchar         v_prev_grp_txn_id[PD_TXN_SEQ_LEN + 1];
		varchar         v_next_grp_txn_id[PD_TXN_SEQ_LEN + 1];
		int		v_acr_prorata;
		varchar         v_entity_ccy[PD_CCY_ID_LEN + 1];
		double          v_entity_txn_amount;
		
		short		ind_entity_id = -1;
		short		ind_party_type = -1;
		short		ind_party_id = -1;
		short		ind_txn_ccy = -1;
		short		ind_txn_country = -1;
		short		ind_txn_product = -1;
		short		ind_open_acct_bal = -1;
		short		ind_acct_bal = -1;
		short		ind_open_intransit = -1;
		short		ind_intransit = -1;
		short		ind_open_ar_bal = -1;
		short		ind_ar_bal = -1;
		short		ind_txn_date = -1;
		short		ind_report_date = -1;
		short		ind_cost_rate = -1;
		short		ind_actual_cost = -1;
		short		ind_remittance_slip_date = -1;
		short		ind_converted_ccy = -1;
		short		ind_converted_amount = -1;
		short		ind_remark = -1;
		short		ind_prev_grp_txn_id = -1;
		short		ind_next_grp_txn_id = -1;
		short		ind_acr_prorata = -1;
		short		ind_entity_ccy = -1;
		short		ind_entity_txn_amount = -1;

        EXEC SQL END DECLARE SECTION;

// txn_id
        hv_txn_id.len = strlen(csTxnId);
        memcpy(hv_txn_id.arr,csTxnId,hv_txn_id.len);
DEBUGLOG(("GetOLTxnMiDetail txn_id = [%d][%.*s]\n",hv_txn_id.len,hv_txn_id.len,hv_txn_id.arr));

        EXEC SQL DECLARE c_cursor_getoltxnmidetail CURSOR FOR
                select otm_entity_id,
		       otm_party_type,
		       otm_party_id,
		       otm_txn_ccy,
		       otm_txn_country,
		       otm_txn_product,
		       otm_open_acct_bal,
		       otm_acct_bal,
		       otm_open_intransit,
		       otm_intransit,
		       otm_open_ar_bal,
		       otm_ar_bal,
		       otm_txn_date,
		       otm_report_date,
		       otm_cost_rate,
		       otm_actual_cost,
		       otm_remittance_slip_date,
		       otm_converted_ccy,
		       otm_converted_amount,
		       otm_remark,
		       otm_prev_grp_txn_id,
		       otm_next_grp_txn_id,
		       otm_acr_prorata,
		       otm_entity_ccy,
		       otm_entity_txn_amount
                  from ol_txn_mi_detail
                 where otm_txn_id = :hv_txn_id;

        EXEC SQL OPEN c_cursor_getoltxnmidetail;
        do {
                EXEC SQL FETCH c_cursor_getoltxnmidetail
                INTO
                        :v_entity_id:ind_entity_id,
			:v_party_type:ind_party_type,
			:v_party_id:ind_party_id,
			:v_txn_ccy:ind_txn_ccy,
			:v_txn_country:ind_txn_country,
			:v_txn_product:ind_txn_product,
			:v_open_acct_bal:ind_open_acct_bal,
			:v_acct_bal:ind_acct_bal,
			:v_open_intransit:ind_open_intransit,
			:v_intransit:ind_intransit,
			:v_open_ar_bal:ind_open_ar_bal,
			:v_ar_bal:ind_ar_bal,
			:v_txn_date:ind_txn_date,
			:v_report_date:ind_report_date,
			:v_cost_rate:ind_cost_rate,
			:v_actual_cost:ind_actual_cost,
			:v_remittance_slip_date:ind_remittance_slip_date,	
			:v_converted_ccy:ind_converted_ccy,
			:v_converted_amount:ind_converted_amount,
			:v_remark:ind_remark,
			:v_prev_grp_txn_id:ind_prev_grp_txn_id,
			:v_next_grp_txn_id:ind_next_grp_txn_id,
			:v_acr_prorata:ind_acr_prorata,
			:v_entity_ccy:ind_entity_ccy,
			:v_entity_txn_amount:ind_entity_txn_amount;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

DEBUGLOG(("GetOLTxnMiDetail found record\n"));

		myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash, 0);

/* entity_id */
                if (ind_entity_id >= 0) {
                        v_entity_id.arr[v_entity_id.len] = '\0';
                        PutField_CString(myHash,"entity_id",(const char*)v_entity_id.arr);
DEBUGLOG(("GetOLTxnMiDetail entity_id = [%s]\n",v_entity_id.arr));
                }

/* party_type */
                if (ind_party_type >= 0) {
                        v_party_type.arr[v_party_type.len] = '\0';
                        PutField_CString(myHash,"party_type",(const char*)v_party_type.arr);
DEBUGLOG(("GetOLTxnMiDetail party_type = [%s]\n",v_party_type.arr));
                }

/* party_id */
                if (ind_party_id >= 0) {
                        v_party_id.arr[v_party_id.len] = '\0';
                        PutField_CString(myHash,"party_id",(const char*)v_party_id.arr);
DEBUGLOG(("GetOLTxnMiDetail party_id = [%s]\n",v_party_id.arr));
                }

/* txn_ccy */
                if (ind_txn_ccy >= 0) {
                        v_txn_ccy.arr[v_txn_ccy.len] = '\0';
                        PutField_CString(myHash,"txn_ccy",(const char*)v_txn_ccy.arr);
DEBUGLOG(("GetOLTxnMiDetail txn_ccy = [%s]\n",v_txn_ccy.arr));
                }

/* txn_country */
                if (ind_txn_country >= 0) {
                        v_txn_country.arr[v_txn_country.len] = '\0';
                        PutField_CString(myHash,"txn_country",(const char*)v_txn_country.arr);
DEBUGLOG(("GetOLTxnMiDetail txn_country = [%s]\n",v_txn_country.arr));
                }

/* txn_product */
                if (ind_txn_product >= 0) {
                        v_txn_product.arr[v_txn_product.len] = '\0';
                        PutField_CString(myHash,"txn_product",(const char*)v_txn_product.arr);
DEBUGLOG(("GetOLTxnMiDetail txn_product = [%s]\n",v_txn_product.arr));
                }

/* open_acct_bal */
                if(ind_open_acct_bal>=0){
                        PutField_Double(myHash,"open_acct_bal",v_open_acct_bal);
DEBUGLOG(("GetOLTxnMiDetail open_acct_bal = [%f]\n",v_open_acct_bal));
                }

/* acct_bal */
                if(ind_acct_bal>=0){
                        PutField_Double(myHash,"acct_bal",v_acct_bal);
DEBUGLOG(("GetOLTxnMiDetail acct_bal = [%f]\n",v_acct_bal));
                }

/* open_intransit */
                if(ind_open_intransit>=0){
                        PutField_Double(myHash,"open_intransit",v_open_intransit);
DEBUGLOG(("GetOLTxnMiDetail open_intransit = [%f]\n",v_open_intransit));
                }

/* intransit */
                if(ind_intransit>=0){
                        PutField_Double(myHash,"intransit",v_intransit);
DEBUGLOG(("GetOLTxnMiDetail intransit = [%f]\n",v_intransit));
                }

/* open_ar_bal */
                if(ind_open_ar_bal>=0){
                        PutField_Double(myHash,"open_ar_bal",v_open_ar_bal);
DEBUGLOG(("GetOLTxnMiDetail open_ar_bal = [%f]\n",v_open_ar_bal));
                }

/* ar_bal */
                if(ind_ar_bal>=0){
                        PutField_Double(myHash,"ar_bal",v_ar_bal);
DEBUGLOG(("GetOLTxnMiDetail ar_bal = [%f]\n",v_ar_bal));
                }

/* txn_date */
                if (ind_txn_date >= 0) {
                        v_txn_date.arr[v_txn_date.len] = '\0';
                        PutField_CString(myHash,"txn_date",(const char*)v_txn_date.arr);
DEBUGLOG(("GetOLTxnMiDetail txn_date = [%s]\n",v_txn_date.arr));
                }

/* report_date */
                if (ind_report_date >= 0) {
                        v_report_date.arr[v_report_date.len] = '\0';
                        PutField_CString(myHash,"report_date",(const char*)v_report_date.arr);
DEBUGLOG(("GetOLTxnMiDetail report_date = [%s]\n",v_report_date.arr));
                }

/* cost_rate */
                if(ind_cost_rate>=0){
                        PutField_Double(myHash,"cost_rate",v_cost_rate);
DEBUGLOG(("GetOLTxnMiDetail cost_rate = [%f]\n",v_cost_rate));
                }

/* actual_cost */
                if(ind_actual_cost>=0){
                        PutField_Double(myHash,"actual_cost",v_actual_cost);
DEBUGLOG(("GetOLTxnMiDetail actual_cost = [%f]\n",v_actual_cost));
                }

/* remittance_slip_date */
                if (ind_remittance_slip_date >= 0) {
                        v_remittance_slip_date.arr[v_remittance_slip_date.len] = '\0';
                        PutField_CString(myHash,"remittance_slip_date",(const char*)v_remittance_slip_date.arr);
DEBUGLOG(("GetOLTxnMiDetail remittance_slip_date = [%s]\n",v_remittance_slip_date.arr));
                }

/* converted_ccy */
                if (ind_converted_ccy >= 0) {
                        v_converted_ccy.arr[v_converted_ccy.len] = '\0';
                        PutField_CString(myHash,"converted_ccy",(const char*)v_converted_ccy.arr);
DEBUGLOG(("GetOLTxnMiDetail converted_ccy = [%s]\n",v_converted_ccy.arr));
                }

/* converted_amount */
                if(ind_converted_amount>=0){
                        PutField_Double(myHash,"converted_amount",v_converted_amount);
DEBUGLOG(("GetOLTxnMiDetail converted_amount = [%f]\n",v_converted_amount));
                }

/* remark */
                if (ind_remark >= 0) {
                        v_remark.arr[v_remark.len] = '\0';
                        PutField_CString(myHash,"remark",(const char*)v_remark.arr);
DEBUGLOG(("GetOLTxnMiDetail remark = [%s]\n",v_remark.arr));
                }

/* prev_grp_txn_id */
                if (ind_prev_grp_txn_id >= 0) {
                        v_prev_grp_txn_id.arr[v_prev_grp_txn_id.len] = '\0';
                        PutField_CString(myHash,"prev_grp_txn_id",(const char*)v_prev_grp_txn_id.arr);
DEBUGLOG(("GetOLTxnMiDetail prev_grp_txn_id = [%s]\n",v_prev_grp_txn_id.arr));
                }

/* next_grp_txn_id */
                if (ind_next_grp_txn_id >= 0) {
                        v_next_grp_txn_id.arr[v_next_grp_txn_id.len] = '\0';
                        PutField_CString(myHash,"next_grp_txn_id",(const char*)v_next_grp_txn_id.arr);
DEBUGLOG(("GetOLTxnMiDetail next_grp_txn_id = [%s]\n",v_next_grp_txn_id.arr));
                }

/* acr_prorata */
                if(ind_acr_prorata>=0){
                        PutField_Int(myHash,"acr_prorata",v_acr_prorata);
DEBUGLOG(("GetOLTxnMiDetail acr_prorata = [%d]\n",v_acr_prorata));
                }

/* entity_ccy */
                if (ind_entity_ccy >= 0) {
                        v_entity_ccy.arr[v_entity_ccy.len] = '\0';
                        PutField_CString(myHash,"entity_ccy",(const char*)v_entity_ccy.arr);
DEBUGLOG(("GetOLTxnMiDetail entity_ccy = [%s]\n",v_entity_ccy.arr));
                }

/* entity_txn_amount */
                if(ind_entity_txn_amount>=0){
                        PutField_Double(myHash,"entity_txn_amount",v_entity_txn_amount);
DEBUGLOG(("GetOLTxnMiDetail entity_txn_amount = [%f]\n",v_entity_txn_amount));
                }
		RecordSet_Add(myRec, myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getoltxnmidetail;


DEBUGLOG(("GetOLTxnMiDetail Normal Exit\n"));
        return  PD_OK;

getoltxnmidetail_error:
DEBUGLOG(("getoltxnmidetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLTxnMiDetail_Get: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getoltxnmidetail;
        return PD_ERR;
}
