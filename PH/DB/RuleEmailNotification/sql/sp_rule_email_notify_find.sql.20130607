CREATE OR REPLACE FUNCTION sp_rule_email_notify_find (
        in_merchant_id                merch_detail.merchant_id%type,
        out_cursor            OUT     sys_refcursor)
RETURN NUMBER Is
        iCnt        integer := 0;
Begin
        select count(*)
          into iCnt
          from email_notify_list, rule_email_notification
         where re_party_type = 'M' 
           and re_party_id = in_merchant_id
           and re_disabled = 0
           and re_email_id = el_id;

        if iCnt > 0 then
                OPEN out_cursor for
                    select el_email
                      from email_notify_list, rule_email_notification
                     where re_party_type = 'M' 
                       and re_party_id = in_merchant_id
                       and re_disabled = 0
                       and re_email_id = el_id;
                return 1;
        else
                select count(*)
                  into iCnt
                  from email_notify_list, merch_detail, rule_email_notification
                 where re_party_type = 'C' 
                   and merchant_id = in_merchant_id
                   and re_party_id = client_id
                   and re_disabled = 0
                   and re_email_id = el_id;

                if iCnt > 0 then
                        OPEN out_cursor for
                            select el_email
                              from email_notify_list, merch_detail, rule_email_notification
                             where re_party_type = 'C' 
                               and merchant_id = in_merchant_id
                               and re_party_id = client_id
                               and re_disabled = 0
                               and re_email_id = el_id;
                        return 1;
                else
                        select count(*)
                          into iCnt 
                          from email_notify_list, rule_email_notification
                         where re_party_type = 'G' 
                           and re_disabled = 0
                           and re_email_id = el_id;
 
                        if iCnt > 0 then
                                OPEN out_cursor for
                                    select el_email
                                      from email_notify_list, rule_email_notification
                                     where re_party_type = 'G' 
                                       and re_disabled = 0
                                       and re_email_id = el_id;

                                return 1;
                        else 
                                return 0;

                        end if;  -- end of global
                end if; -- end of client
        end if; -- end of MID

	RETURN 0;

exception
    WHEN OTHERS THEN
        RETURN 9;
END sp_rule_email_notify_find;
/

