/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/11/17              LokMan Chow
Add Find Code by Type				   2011/11/22		   Cody Chan
Add GetNumRtnRecordByCode                          2011/12/05              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "MmsTxnCode.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char    cDebug;

void MmsTxnCode(char    cdebug)
{
        cDebug = cdebug;
}


int FindProcessCode(const unsigned char* TxnCode,
		unsigned char* TxnCodeDesc,
                unsigned char* ProcessType,
                unsigned char* ProcessCode)
{
        EXEC SQL WHENEVER SQLERROR GOTO find_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar v_process_type[PD_PROCESS_TYPE_LEN+1];
                varchar v_process_code[PD_PROCESS_CODE_LEN+1];

                varchar hv_txn_code[PD_TXN_CODE_LEN];
		varchar	v_txn_desc[PD_DESC_LEN + 1];

                short   ind_process_type= -1;
                short   ind_process_code= -1;
		short	ind_txn_desc = -1;
        EXEC SQL END DECLARE SECTION;

        hv_txn_code.len = strlen((const char*)TxnCode);
        memcpy(hv_txn_code.arr,TxnCode,hv_txn_code.len);
DEBUGLOG(("FindProcessCode: txn_code = [%.*s][%d]\n",hv_txn_code.len,hv_txn_code.arr,hv_txn_code.len)); 


        EXEC SQL SELECT mtc_process_code,
			mtc_process_type,
			mtc_desc
                   INTO :v_process_code:ind_process_code,
			:v_process_type:ind_process_type,
			:v_txn_desc:ind_txn_desc
                   FROM mms_txn_code
                  WHERE mtc_code=:hv_txn_code
                 and ROWNUM <= 1;

	if (ind_txn_desc >= 0) {
		v_txn_desc.arr[v_txn_desc.len] = '\0';
		strcpy((char*)TxnCodeDesc,(const char*)v_txn_desc.arr);
DEBUGLOG(("Txn Code Desc= [%s]\n",TxnCodeDesc)); 
	}

	if (ind_process_code >= 0) {
		v_process_code.arr[v_process_code.len] = '\0';
		strcpy((char*)ProcessCode,(const char*)v_process_code.arr);
DEBUGLOG(("Process Code = [%s]\n",ProcessCode));
		
		if(ind_process_type >= 0){
			v_process_type.arr[v_process_type.len] = '\0';
			strcpy((char*)ProcessType,(const char*)v_process_type.arr);
DEBUGLOG(("Process Type = [%s]\n",ProcessType));
			
DEBUGLOG(("iRet =  FOUND\n"));
			return FOUND;
		}
	}


DEBUGLOG(("iRet =  NOT FOUND\n"));
        return NOT_FOUND;

find_error:
DEBUGLOG(("find_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return NOT_FOUND;
}


int FindTxnCode(unsigned char* TxnCode,
                unsigned char* TxnCodeDesc,
                const unsigned char* ProcessType,
                const unsigned char* ProcessCode)
{
        EXEC SQL WHENEVER SQLERROR GOTO find_txncode_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_process_type[PD_PROCESS_TYPE_LEN];
                varchar hv_process_code[PD_PROCESS_CODE_LEN];

                varchar v_txn_code[PD_TXN_CODE_LEN +1 ];
                varchar v_txn_desc[PD_DESC_LEN + 1];

                short   ind_txn_code = -1;
                short   ind_txn_desc = -1;
        EXEC SQL END DECLARE SECTION;

        hv_process_type.len = strlen((const char*)ProcessType);
        memcpy(hv_process_type.arr,ProcessType,hv_process_type.len);
DEBUGLOG(("FindTxnCode: Process Type = [%.*s][%d]\n",hv_process_type.len,hv_process_type.arr,PD_PROCESS_TYPE_LEN));

        hv_process_code.len = strlen((const char*)ProcessCode);
        memcpy(hv_process_code.arr,ProcessCode,hv_process_code.len);
DEBUGLOG(("FindTxnCode: ProcessCode = [%.*s]\n",hv_process_code.len,hv_process_code.arr));


        EXEC SQL SELECT MTC_CODE,MTC_DESC
                   INTO :v_txn_code:ind_txn_code,
                        :v_txn_desc:ind_txn_desc
                FROM MMS_TXN_CODE
                WHERE MTC_PROCESS_TYPE =:hv_process_type and MTC_PROCESS_CODe = :hv_process_code
                 and ROWNUM <= 1;

        if (ind_txn_code >= 0) {
                v_txn_code.arr[v_txn_code.len] = '\0';
                strcpy((char*)TxnCode,(const char*)v_txn_code.arr);
DEBUGLOG(("Txn Code = [%s]\n",TxnCode));
                if (ind_txn_desc >= 0) {
                        v_txn_desc.arr[v_txn_desc.len] = '\0';
                        strcpy((char*)TxnCodeDesc,(const char*)v_txn_desc.arr);
DEBUGLOG(("Txn Code Desc= [%s]\n",TxnCodeDesc));
                        }
                return FOUND;
        }

DEBUGLOG(("Txn Code  NOT FOUND\n"));
        return NOT_FOUND;
find_txncode_error:
DEBUGLOG(("find_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return NOT_FOUND;
}



int FindTxnCodeByType(unsigned char* TxnCode,
                unsigned char* TxnCodeDesc,
                const char* FromType,
                const char* ToType)
{
        EXEC SQL WHENEVER SQLERROR GOTO find_txncodebytype_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_from_type[PD_MMS_TYPE_LEN];
                varchar hv_to_type[PD_MMS_TYPE_LEN];

                varchar v_txn_code[PD_TXN_CODE_LEN +1 ];
                varchar v_txn_desc[PD_DESC_LEN + 1];

                short   ind_txn_code = -1;
                short   ind_txn_desc = -1;
        EXEC SQL END DECLARE SECTION;

        hv_from_type.len = strlen((const char*)FromType);
        memcpy(hv_from_type.arr,FromType,hv_from_type.len);
DEBUGLOG(("FindTxnCodeByType:From Type = [%.*s]\n",hv_from_type.len,hv_from_type.arr));

        hv_to_type.len = strlen((const char*)ToType);
        memcpy(hv_to_type.arr,ToType,hv_to_type.len);
DEBUGLOG(("FindTxnCodeByType: ToType = [%.*s]\n",hv_to_type.len,hv_to_type.arr));


        EXEC SQL SELECT MTC_CODE,MTC_DESC
                   INTO :v_txn_code:ind_txn_code,
                        :v_txn_desc:ind_txn_desc
                FROM MMS_TXN_CODE
                WHERE MTC_FROM_TYPE =:hv_from_type and MTC_TO_TYPE = :hv_to_type
                 and ROWNUM <= 1;

        if (ind_txn_code >= 0) {
                v_txn_code.arr[v_txn_code.len] = '\0';
                strcpy((char*)TxnCode,(const char*)v_txn_code.arr);
DEBUGLOG(("FindTxnCodeByType:Txn Code = [%s]\n",TxnCode));
                if (ind_txn_desc >= 0) {
                        v_txn_desc.arr[v_txn_desc.len] = '\0';
                        strcpy((char*)TxnCodeDesc,(const char*)v_txn_desc.arr);
DEBUGLOG(("FindTxnCodeByType:Txn Code Desc= [%s]\n",TxnCodeDesc));
                        }
                return FOUND;
        }

DEBUGLOG(("FindTxnCodeByType:Txn Code  NOT FOUND\n"));
        return NOT_FOUND;
find_txncodebytype_error:
DEBUGLOG(("find_txncodebytype_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return NOT_FOUND;
}

int	GetNumRtnRecordByCode(const unsigned char *TxnCode,
					int *iNumRtn)
{
        EXEC SQL WHENEVER SQLERROR GOTO get_numrtnrecordbycode_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_txn_code[PD_TXN_CODE_LEN];

                int     v_num_rtn_record;
                short   ind_num_rtn_record = -1;

        EXEC SQL END DECLARE SECTION;

        hv_txn_code.len = strlen((const char*)TxnCode);
        memcpy(hv_txn_code.arr,TxnCode,hv_txn_code.len);
DEBUGLOG(("GetNumRtnRecordByCode:txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));

        EXEC SQL SELECT MTC_NUM_RTN_RECORD
                   INTO :v_num_rtn_record:ind_num_rtn_record
                FROM MMS_TXN_CODE
                WHERE MTC_CODE = :hv_txn_code
                 and ROWNUM <= 1;

        if (ind_num_rtn_record >= 0) {
		*iNumRtn = v_num_rtn_record;
DEBUGLOG(("GetNumRtnRecordByCode: NumberReturn = [%d]\n",*iNumRtn));
                return FOUND;
        }

DEBUGLOG(("GetNumRtnRecordByCode: NumberReturn NOT FOUND\n"));
        return NOT_FOUND;

get_numrtnrecordbycode_error:
DEBUGLOG(("get_numrtnrecordbycode_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return NOT_FOUND;

}
