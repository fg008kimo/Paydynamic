/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/11/22              LokMan Chow 
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "MmsMBDetail.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void MmsMBDetail(char    cdebug)
{
        cDebug = cdebug;
}


int GetMBDetail(const char* csMBId,
                hash_t* hRec)
{

        EXEC SQL WHENEVER SQLERROR GOTO getmbdetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_mb_id[PD_MB_ID_LEN];
                int             hv_disabled;

                varchar         v_name[PD_NAME_LEN + 1];

                short           ind_name = -1;

        EXEC SQL END DECLARE SECTION;

        hv_mb_id.len = strlen(csMBId);
        memcpy(hv_mb_id.arr,csMBId,hv_mb_id.len);
DEBUGLOG(("GetMBDetail mb_id = [%d][%.*s]\n",hv_mb_id.len,hv_mb_id.len,hv_mb_id.arr));

	hv_disabled = 0;

        EXEC SQL DECLARE c_cursor_getmbdetail CURSOR FOR
                select md_mb_name
                  from mms_mb_detail
                 where md_mb_id = :hv_mb_id
		 and   md_disabled = :hv_disabled;

        EXEC SQL OPEN c_cursor_getmbdetail;
        do {
                EXEC SQL FETCH c_cursor_getmbdetail
                INTO
                        :v_name:ind_name;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }


DEBUGLOG(("GetMBDetail found record\n"));

/* bank name */
                if (ind_name >= 0) {
                        v_name.arr[v_name.len] = '\0';
                        PutField_CString(hRec,"mb_name",(const char*)v_name.arr);
DEBUGLOG(("GetMBDetail mb_name = [%s]\n",v_name.arr));
                }
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getmbdetail;


DEBUGLOG(("GetMBDetail Normal Exit\n"));
        return  PD_OK;

getmbdetail_error:
DEBUGLOG(("getmbdetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MBDetail_Get: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getmbdetail;
        return PD_ERR;
}
