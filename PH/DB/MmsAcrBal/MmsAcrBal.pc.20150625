/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/04/29              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "MmsAcrBal.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char cDebug;

void MmsAcrBal(char cdebug)
{
	cDebug = cdebug;
}


int Update(const hash_t *hRec)
{
	char *csTmp;
	double dTmp;
	int	iRet = PD_OK;

	EXEC SQL WHENEVER SQLERROR GOTO update_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_entity_id[PD_MMS_ENTITY_ID_LEN];
		varchar hv_org_ccy[PD_CCY_ID_LEN];
		varchar hv_ccy[PD_CCY_ID_LEN];
		double hv_bal;
		double hv_rate;
		double hv_ratio;
		varchar hv_update_user[PD_UPDATE_USER_LEN];

		short ind_entity_id = -1;
		short ind_org_ccy = -1;
		short ind_ccy = -1;
		short ind_bal = -1;
		short ind_rate = -1;
		short ind_ratio = -1;
		short ind_update_user = -1;

		short hv_return_value;
	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));

	if (GetField_CString(hRec, "entity_id", &csTmp)) {
		hv_entity_id.len = strlen(csTmp);
		strncpy((char *)hv_entity_id.arr, csTmp, hv_entity_id.len);
		ind_entity_id = 0;
DEBUGLOG(("Update: entity_id = [%.*s]\n", hv_entity_id.len, hv_entity_id.arr));
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("Update: entity_id is missing!!!!\n"));
ERRLOG("MmsAcrBal: Update: entity_id is missing!!!!\n");
	}

	if (GetField_CString(hRec, "org_ccy", &csTmp)) {
		hv_org_ccy.len = strlen(csTmp);
		strncpy((char *)hv_org_ccy.arr, csTmp, hv_org_ccy.len);
		ind_org_ccy = 0;
DEBUGLOG(("Update: org_ccy = [%.*s]\n", hv_org_ccy.len, hv_org_ccy.arr));
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("Update: org_ccy is missing!!!!\n"));
ERRLOG("MmsAcrBal: Update: org_ccy is missing!!!!\n");
	}

	if (GetField_CString(hRec, "ccy", &csTmp)) {
		hv_ccy.len = strlen(csTmp);
		strncpy((char *)hv_ccy.arr, csTmp, hv_ccy.len);
		ind_ccy = 0;
DEBUGLOG(("Update: ccy = [%.*s]\n", hv_ccy.len, hv_ccy.arr));
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("Update: ccy is missing!!!!\n"));
ERRLOG("MmsAcrBal: Update: ccy is missing!!!!\n");
	}

	if (GetField_Double(hRec, "bal", &dTmp)) {
		hv_bal = dTmp;
DEBUGLOG(("Update: bal = [%f]\n", hv_bal));
	} else {
		hv_bal = 0.0;
	}
	ind_bal = 0;

	if (GetField_Double(hRec, "rate", &dTmp)) {
		hv_rate = dTmp;
DEBUGLOG(("Update: rate = [%f]\n", hv_rate));
	} else {
		hv_rate = 1.0;
	}
	ind_rate = 0;

	if (GetField_Double(hRec, "ratio", &dTmp)) {
		hv_ratio = dTmp;
DEBUGLOG(("Update: ratio = [%f]\n", hv_ratio));
	} else {
		hv_ratio = 0.0;
	}
	ind_ratio = 0;

	if (GetField_CString(hRec, "update_user", &csTmp)) {
		hv_update_user.len = strlen(csTmp);
		strncpy((char *)hv_update_user.arr, csTmp, hv_update_user.len);
	}
	else{
		hv_update_user.len = strlen(PD_UPDATE_USER);
		strncpy((char *)hv_update_user.arr, PD_UPDATE_USER, hv_update_user.len);
	}
	ind_update_user = 0;
DEBUGLOG(("Update: update_user = [%.*s]\n", hv_update_user.len, hv_update_user.arr));

	if(iRet!=PD_OK){
DEBUGLOG(("Update: Ret = [%d]\n", iRet));
		return iRet;
	}

	EXEC SQL EXECUTE
		BEGIN
		:hv_return_value := sp_mms_acr_bal_update(
					:hv_entity_id:ind_entity_id,
					:hv_org_ccy:ind_org_ccy,
					:hv_ccy:ind_ccy,
					:hv_bal:ind_bal,
					:hv_rate:ind_rate,
					:hv_ratio:ind_ratio,
					:hv_update_user:ind_update_user);
		END;
	END-EXEC;

DEBUGLOG(("Update: Ret = [%d]\n", hv_return_value));

	if (hv_return_value == SP_OK) {
DEBUGLOG(("Update: Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR) {
ERRLOG("MmsAcrBal_Update: SP_OTHER_ERR\n");
DEBUGLOG(("Update: SP_OTHER_ERR\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR) {
ERRLOG("MmsAcrBal_Update: SP_ERR\n");
DEBUGLOG(("Update: SP_ERR\n"));
		return PD_ERR;
	}

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MmsAcrBal_Update: SP_INTERNAL_ERR\n");
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}


int GetAcrBal(const hash_t *hRec, hash_t *hBal)
{
	int iRet = PD_NOT_FOUND;

	char *csTmp;
	int iCnt = 0;

	EXEC SQL WHENEVER SQLERROR GOTO getacrbal_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_entity_id[PD_MMS_ENTITY_ID_LEN];
		varchar hv_org_ccy[PD_CCY_ID_LEN];
		varchar hv_ccy[PD_CCY_ID_LEN];

		double v_bal;
		double v_rate;
		double v_ratio;
		short ind_bal = -1;
		short ind_rate = -1;
		short ind_ratio = -1;
	EXEC SQL END DECLARE SECTION;

	if (GetField_CString(hRec, "entity_id", &csTmp)) {
		hv_entity_id.len = strlen(csTmp);
		strncpy((char *)hv_entity_id.arr, csTmp, hv_entity_id.len);
DEBUGLOG(("GetAcrBal: entity_id = [%.*s]\n", hv_entity_id.len, hv_entity_id.arr));
	}

	if (GetField_CString(hRec, "org_ccy", &csTmp)) {
		hv_org_ccy.len = strlen(csTmp);
		strncpy((char *)hv_org_ccy.arr, csTmp, hv_org_ccy.len);
DEBUGLOG(("GetAcrBal: org_ccy = [%.*s]\n", hv_org_ccy.len, hv_org_ccy.arr));
	}

	if (GetField_CString(hRec, "ccy", &csTmp)) {
		hv_ccy.len = strlen(csTmp);
		strncpy((char *)hv_ccy.arr, csTmp, hv_ccy.len);
DEBUGLOG(("GetAcrBal: ccy = [%.*s]\n", hv_ccy.len, hv_ccy.arr));
	}

	EXEC SQL DECLARE c_getacrbal CURSOR FOR
		SELECT	mab_bal,
			mab_rate,
			mab_ratio
		FROM	mms_acr_bal
		WHERE	mab_entity_id = :hv_entity_id
		AND	mab_org_ccy = :hv_org_ccy
		AND	mab_ccy = :hv_ccy;


	EXEC SQL OPEN c_getacrbal;
        do {
		EXEC SQL FETCH c_getacrbal
		INTO	:v_bal:ind_bal,
			:v_rate:ind_rate,
			:v_ratio:ind_ratio;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		if (ind_bal >= 0) {
			PutField_Double(hBal, "bal", v_bal);
DEBUGLOG(("GetAcrBal bal = [%f]\n", v_bal));
		}

		if (ind_rate >= 0) {
			PutField_Double(hBal, "rate", v_rate);
DEBUGLOG(("GetAcrBal rate = [%f]\n", v_rate));
		}

		if (ind_ratio >= 0) {
			PutField_Double(hBal, "ratio", v_ratio);
DEBUGLOG(("GetAcrBal ratio = [%f]\n", v_ratio));
		}

		iCnt ++;
		iRet = PD_FOUND;

	}while(PD_TRUE);

	EXEC SQL CLOSE c_getacrbal;

	if (iRet == PD_FOUND) {
DEBUGLOG(("GetAcrBal: record found\n"));
	} else {
DEBUGLOG(("GetAcrBal no record found\n"));
	}

DEBUGLOG(("GetAcrBal Normal Exit! iRet = [%d]\n", iRet));
	return iRet;

getacrbal_error:
DEBUGLOG(("getacrbal_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MmsEntityPsp getacrbal_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL CLOSE c_getacrbal;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}
