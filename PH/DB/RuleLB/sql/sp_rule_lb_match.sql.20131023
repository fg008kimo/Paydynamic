DROP FUNCTION SP_RULE_LB_MATCH;

CREATE OR REPLACE FUNCTION sp_rule_lb_match (
   in_channel_code         rule_psp_lb_criteria.rc_channel_code%TYPE,
   in_service_code         rule_psp_lb_criteria.rc_service_code%TYPE,
   in_payment_method       rule_psp_lb_criteria.rc_payment_method%TYPE,
   in_country              rule_psp_lb_criteria.rc_country%TYPE,
   in_ccy                  rule_psp_lb_criteria.rc_ccy%TYPE,
   in_merchant_id          rule_psp_lb_criteria.rc_party_id%TYPE,
   in_client_id            rule_psp_lb_criteria.rc_party_id%TYPE,
   in_business_type        rule_psp_lb_criteria.rc_business_type%TYPE,
   in_customer_tag         rule_psp_lb_criteria.rc_customer_segment%TYPE,
   in_restrictde_ip        rule_psp_lb_criteria.rc_allow_special_region%TYPE,
   out_cursor          OUT SYS_REFCURSOR)
   RETURN NUMBER
IS
   iCnt   INTEGER := 0;
BEGIN
   SELECT COUNT (*)
     INTO iCnt
     FROM rule_psp_lb_criteria
    WHERE     rc_channel_code = in_channel_code
          AND rc_service_code = in_service_code
          AND (   rc_payment_method = in_payment_method
               OR rc_payment_method = '000')
          AND rc_country = in_country
          AND rc_ccy = in_ccy
          AND rc_party_type = 'M'
          AND rc_party_id = in_merchant_id
          AND rc_business_type = in_business_type
          AND rc_disabled = 0
          AND rc_allow_special_region = in_restrictde_ip
          AND (   rc_customer_segment = in_customer_tag
               OR rc_customer_segment IS NULL);

   IF iCnt > 0
   THEN
      OPEN out_cursor FOR
           SELECT rc_min_transaction_amount,
                  rc_max_transaction_amount,
                  rc_criteria_pool_id,
                  rc_scheduler_id,
                  rc_priority
             FROM rule_psp_lb_criteria
            WHERE     rc_channel_code = in_channel_code
                  AND rc_service_code = in_service_code
                  AND (   rc_payment_method = in_payment_method
                       OR rc_payment_method = '000')
                  AND rc_country = in_country
                  AND rc_ccy = in_ccy
                  AND rc_party_type = 'M'
                  AND rc_party_id = in_merchant_id
                  AND rc_business_type = in_business_type
                  AND rc_disabled = 0
                  AND rc_allow_special_region = in_restrictde_ip
                  AND (   rc_customer_segment = in_customer_tag
                       OR rc_customer_segment IS NULL)
         ORDER BY rc_priority DESC;

      RETURN 1;
   ELSE
      SELECT COUNT (*)
        INTO iCnt
        FROM rule_psp_lb_criteria
       WHERE     rc_channel_code = in_channel_code
             AND rc_service_code = in_service_code
             AND (   rc_payment_method = in_payment_method
                  OR rc_payment_method = '000')
             AND rc_country = in_country
             AND rc_ccy = in_ccy
             AND rc_party_type = 'C'
             AND rc_party_id = in_client_id
             AND rc_business_type = in_business_type
             AND rc_disabled = 0
             AND rc_allow_special_region = in_restrictde_ip
             AND (   rc_customer_segment = in_customer_tag
                  OR rc_customer_segment IS NULL);

      IF iCnt > 0
      THEN
         OPEN out_cursor FOR
              SELECT rc_min_transaction_amount,
                     rc_max_transaction_amount,
                     rc_criteria_pool_id,
                     rc_scheduler_id,
                     rc_priority
                FROM rule_psp_lb_criteria
               WHERE     rc_channel_code = in_channel_code
                     AND rc_service_code = in_service_code
                     AND (   rc_payment_method = in_payment_method
                          OR rc_payment_method = '000')
                     AND rc_country = in_country
                     AND rc_ccy = in_ccy
                     AND rc_party_type = 'C'
                     AND rc_party_id = in_client_id
                     AND rc_business_type = in_business_type
                     AND rc_disabled = 0
                     AND rc_allow_special_region = in_restrictde_ip
                     AND (   rc_customer_segment = in_customer_tag
                          OR rc_customer_segment IS NULL)
            ORDER BY rc_priority DESC;

         RETURN 1;
      ELSE
         SELECT COUNT (*)
           INTO iCnt
           FROM rule_psp_lb_criteria
          WHERE     rc_channel_code = in_channel_code
                AND rc_service_code = in_service_code
                AND (   rc_payment_method = in_payment_method
                     OR rc_payment_method = '000')
                AND rc_country = in_country
                AND rc_ccy = in_ccy
                AND rc_party_type = 'G'
                AND rc_business_type = in_business_type
                AND rc_disabled = 0
                AND rc_allow_special_region = in_restrictde_ip
                AND (   rc_customer_segment = in_customer_tag
                     OR rc_customer_segment IS NULL);

         IF iCnt > 0
         THEN
            OPEN out_cursor FOR
                 SELECT rc_min_transaction_amount,
                        rc_max_transaction_amount,
                        rc_criteria_pool_id,
                        rc_scheduler_id,
                        rc_priority
                   FROM rule_psp_lb_criteria
                  WHERE     rc_channel_code = in_channel_code
                        AND rc_service_code = in_service_code
                        AND (   rc_payment_method = in_payment_method
                             OR rc_payment_method = '000')
                        AND rc_country = in_country
                        AND rc_ccy = in_ccy
                        AND rc_party_type = 'G'
                        AND rc_business_type = in_business_type
                        AND rc_disabled = 0
                        AND rc_allow_special_region = in_restrictde_ip
                        AND (   rc_customer_segment = in_customer_tag
                             OR rc_customer_segment IS NULL)
               ORDER BY rc_priority DESC;

            RETURN 1;
         END IF;
      END IF;
   END IF;

   RETURN 0;
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN 0;
END sp_rule_lb_match;
/

