CREATE OR REPLACE FUNCTION sp_rule_lb_sarip_get_pspbank(
   in_merchant_id       MERCH_DETAIL.MERCHANT_ID%TYPE,
   in_ccy		RULE_PSP_LB_CRITERIA.RC_CCY%TYPE,
   in_amt		RULE_PSP_LB_CRITERIA.RC_MAX_TRANSACTION_AMOUNT%TYPE,
   out_cursor       OUT SYS_REFCURSOR)
   RETURN NUMBER
IS
BEGIN
   OPEN out_cursor FOR
      SELECT bm_int_bank_code,
                   client_id,
                   rpp_psp_id,
                   currency_id,
                   remaining_limit,
                   rb_scheduler_id,
                   rb_note_id
              FROM (  SELECT bm_int_bank_code,
                             client_id,
                             rpp_psp_id,
                             currency_id,
                             remaining_limit,
                             fe_display_order
                        FROM (SELECT psp_name,
                                     client_id,
                                     rpp_psp_id,
                                     currency_id,
                                     rpp_limit,
                                     remaining_limit,
                                     psp_channel_code,
                                     overrided_bank_code_channel,
                                     rc_service_code
                                FROM (  SELECT rm_psp_id, rc_service_code
                                          FROM (SELECT rc_channel_code,
                                                       rc_service_code,
                                                       rc_payment_method,
                                                       rc_country,
                                                       rc_ccy,
                                                       rc_party_type,
                                                       rc_party_id,
                                                       rc_business_type,
                                                       rc_criteria_pool_id,
                                                       rc_customer_segment,
                                                       rp_criteria_pool_id,
                                                       rp_pool_id
                                                  FROM rule_psp_lb_criteria,
                                                       rule_psp_lb_pools
                                                 WHERE     RULE_TXN_LIMIT_PKG.FINDSCHEDULE (
                                                              rc_scheduler_id) = 1
                                                       AND rc_criteria_pool_id = rp_criteria_pool_id
                                                       AND rc_disabled = 0
                                                       AND rp_disabled = 0
						       AND rc_ccy = in_ccy
						       AND (rc_allow_special_region = 1
							     OR (rc_max_transaction_amount > 0 and rc_max_transaction_amount >= in_amt))
						),
                                               (SELECT business_type,
                                                       merchant_id,
                                                       clients.client_id
                                                  FROM merch_detail, clients
                                                 WHERE     merchant_id = in_merchant_id
                                                       AND disabled = 0
                                                       AND merch_detail.status = 'O'
                                                       AND merch_detail.client_id = clients.client_id
                                                       AND clients.status = 'O'),
                                               (rule_psp_lb_mapping)
                                         WHERE     rc_business_type = business_type
                                               AND rp_pool_id = rm_pool_id
                                               AND rm_disabled = 0
                                               AND (   (    rc_party_type = 'M'
                                                        AND rc_party_id = merchant_id)
                                                    OR (    rc_party_type = 'C'
                                                        AND rc_party_id = client_id)
                                                    OR (rc_party_type = 'G'))
                                      GROUP BY rm_psp_id, rc_service_code),
                                     (SELECT psp_name,
                                             client_id,
                                             psp_channel_code,
                                             overrided_bank_code_channel,
                                             rpp_psp_id,
                                             currency_id,
                                             rpp_limit,
                                             CASE
                                                WHEN rpp_limit = 0
                                                THEN
                                                   rpp_limit
                                                ELSE
                                                     rpp_limit - NVL (tc_total_counter, 0)
                                             END
                                                AS remaining_limit
                                        FROM (SELECT rpp_psp_id,
                                                     currency_id,
                                                     rpp_limit,
                                                     client_id,
                                                     psp_name,
                                                     psp_channel_code,
                                                     overrided_bank_code_channel
                                                FROM (SELECT rpp_psp_id, rpp_limit
                                                        FROM rule_psp_lb_psp
                                                       WHERE rpp_disabled = 0),
                                                     (SELECT PSP_ID AS r_psp_id,
                                                             currency_id,
                                                             client_id,
                                                             psp_name,
                                                             psp_channel_code,
                                                             overrided_bank_code_channel
                                                        FROM psp_detail, psp_master
                                                       WHERE     client_id = pm_client_id
                                                             AND disabled = 0
                                                             AND online_mode = 'Y'
                                                             AND status = 'O'
                                                             AND pm_status = 'O')
                                               WHERE rpp_psp_id = r_psp_id)
                                             LEFT JOIN
                                             (  SELECT SUM (tc_total_counter) AS tc_total_counter,
                                                       tc_party_id AS party_psp_id
                                                  FROM txn_counters
                                                 WHERE     tc_party_type = 'P'
                                                       AND tc_category = 'AMT'
                                                       AND tc_type = 'D'
                                              GROUP BY tc_party_id)
                                                ON rpp_psp_id = party_psp_id)
                               WHERE rm_psp_id = rpp_psp_id) a
                             LEFT JOIN
                             (SELECT bm_int_bank_code,
                                     bm_psp_channel_id,
                                     fe_display_order,
                                     bs_service_code
                                FROM bank_mapping, bank_desc, bank_service_mapping
                               WHERE     bm_disabled = 0
                                     AND internal_bank_code = bm_int_bank_code
                                     AND bs_disabled = 0
                                     AND internal_bank_code = bs_int_bank_code) b
                                ON     (   (    a.overrided_bank_code_channel
                                                   IS NOT NULL
                                            AND b.bm_psp_channel_id =
                                                   a.overrided_bank_code_channel)
                                        OR (    a.overrided_bank_code_channel
                                                   IS NULL
                                            AND b.bm_psp_channel_id =
                                                   a.psp_channel_code))
                                   AND b.bs_service_code = a.rc_service_code
                    ORDER BY fe_display_order, client_id, rpp_psp_id)
                   LEFT JOIN
                   (SELECT rb_bank_code,
                           rb_type,
                           rb_party_id,
                           rb_scheduler_id,
                           rb_note_id
                      FROM rule_disabled_bank
                     WHERE     rb_disabled = 0
                           AND rb_channel_code = 'WEB'
                           AND rb_type IN ('C', 'P'))
                      ON     rb_bank_code = bm_int_bank_code
                         AND (   (rb_type = 'C' AND rb_party_id = client_id)
                              OR (rb_type = 'P' AND rb_party_id = rpp_psp_id))
             WHERE remaining_limit >= in_amt
          ORDER BY fe_display_order, rb_scheduler_id desc, remaining_limit DESC;

   RETURN 0;

EXCEPTION
   WHEN OTHERS
   THEN
      RETURN 9;
END sp_rule_lb_sarip_get_pspbank;
/
