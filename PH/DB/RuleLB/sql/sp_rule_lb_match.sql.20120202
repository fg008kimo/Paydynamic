CREATE OR REPLACE FUNCTION sp_rule_lb_match (
  in_channel_code		rule_psp_lb_criteria.rc_channel_code%type,
  in_service_code            	rule_psp_lb_criteria.rc_service_code%Type,
  in_payment_method		rule_psp_lb_criteria.rc_payment_method%type,
  in_country			rule_psp_lb_criteria.rc_country%type,
  in_ccy 	           	rule_psp_lb_criteria.rc_ccy%Type,
  in_merchant_id 	       	rule_psp_lb_criteria.rc_party_id%Type,
  in_client_id 	       		rule_psp_lb_criteria.rc_party_id%Type,
  in_business_type 	     	rule_psp_lb_criteria.rc_business_type%Type,
  out_cursor		out	sys_refcursor)

RETURN NUMBER Is
	iCnt	integer := 0;
Begin
	select count(*)
          into iCnt    
  	  from rule_psp_lb_criteria
	 where rc_channel_code = in_channel_code
    	   and rc_service_code = in_service_code
    	   and (rc_payment_method = in_payment_method or rc_payment_method = '000')
    	   and rc_country = in_country
    	   and rc_ccy = in_ccy
    	   and rc_party_type = 'M'
    	   and rc_party_id = in_merchant_id
    	   and rc_business_type = in_business_type;

        if iCnt > 0 THEN
              OPEN out_cursor for
	       select rc_transaction_amount_tier,
                      rc_criteria_pool_id,
		      rc_scheduler_id
  	  	 from rule_psp_lb_criteria
	 	where rc_channel_code = in_channel_code
    	   	  and rc_service_code = in_service_code
    	   	  and (rc_payment_method = in_payment_method or rc_payment_method = '000')
    	   	  and rc_country = in_country
    	   	  and rc_ccy = in_ccy
    	   	  and rc_party_type = 'M'
    	   	  and rc_party_id = in_merchant_id
    	   	  and rc_business_type = in_business_type;
                  RETURN 1;
	else
		select count(*)
          	  into iCnt    
  	  	  from rule_psp_lb_criteria
	 	 where rc_channel_code = in_channel_code
    	   	   and rc_service_code = in_service_code
    	   	   and (rc_payment_method = in_payment_method or rc_payment_method = '000')
    	   	   and rc_country = in_country
    	   	   and rc_ccy = in_ccy
    	   	   and rc_party_type = 'C'
    	   	   and rc_party_id = in_client_id
    	   	   and rc_business_type = in_business_type;

        	if iCnt > 0 THEN
              		OPEN out_cursor for
	       		 select rc_transaction_amount_tier,
                      		rc_criteria_pool_id,
		      		rc_scheduler_id
  	  	 	   from rule_psp_lb_criteria
	 		  where rc_channel_code = in_channel_code
    	   	  	    and rc_service_code = in_service_code
    	   	   	    and (rc_payment_method = in_payment_method or rc_payment_method = '000')
    	   	  	    and rc_country = in_country
    	   	  	    and rc_ccy = in_ccy
    	   	  	    and rc_party_type = 'C'
    	   	   	    and rc_party_id = in_client_id
    	   	  	    and rc_business_type = in_business_type;
                  	RETURN 1;
		else 
			select count(*)
                  		into iCnt
                  	 from rule_psp_lb_criteria
                 	where rc_channel_code = in_channel_code
                   	  and rc_service_code = in_service_code
    	   	   	  and (rc_payment_method = in_payment_method or rc_payment_method = '000')
                   	  and rc_country = in_country
                   	  and rc_ccy = in_ccy
                   	  and rc_party_type = 'G'
                   	  and rc_business_type = in_business_type;
        		if iCnt > 0 THEN
				OPEN out_cursor for
                         	select rc_transaction_amount_tier,
                                	rc_criteria_pool_id,
                                	rc_scheduler_id
                           	  from rule_psp_lb_criteria
                          	 where rc_channel_code = in_channel_code
                            	   and rc_service_code = in_service_code
    	   	   	           and (rc_payment_method = in_payment_method or rc_payment_method = '000')
                            	   and rc_country = in_country
                            	   and rc_ccy = in_ccy
                            	   and rc_party_type = 'G'
                            	   and rc_business_type = in_business_type;
                  		RETURN 1;
			end if;
		end if;
	end if;

	RETURN 0;


 exception
   WHEN OTHERS THEN
     RETURN 0;
END sp_rule_lb_match;
/

