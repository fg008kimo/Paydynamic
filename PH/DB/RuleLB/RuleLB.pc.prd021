/*
PDProTech (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/01/03              [GOD]
Add customer_tag				   2013/01/29		   [GOD]
GetAvalPspsByPool Check againest with hPsps        2013/03/04		   [GOD]
Check psp limit before bank selection		   2013/03/20		   [STP]
get bank+psp by merchant and txnamt		   2013/07/04		   [MSN]
Add functions for mobile segment		   2015/02/25		   [MSN]
Update functions for card type option
	1. GetBankPspForSARIP
	2. GetBankPspByMerchNCcyNGrp
	3. GetBankPspForPromoCustomer
	4. HaveDefineSmallAmtRule
Add function for card type option
	1. GetBankPspByOtherMerch		   2016/10/05              [MSN]
	2. MatchCriteria_Mode
	3. HaveDefineRestrictedIPRule
	4. FindPotentialPool
	5. FindPoolDetail
	6. FindPoolPspDetail
	7. GetCustomerGroup_CardType
	8. GetPromoteCustomerGroup_CardType
	9. FindRuleWithoutVirtualPID
Update functions for QR Payment
	1. GetMobileBankByMerchNCcyNGrp		   2016/11/30		   [MSN]
	2. GetMobileBankDefault			   2016/12/12
Add function for NBXA Mobile
	1. GetBankPspByOtherMerchDefault	   2017/07/13		   [WMC]
Fix for serch scheme with merhcant txn amount
	1. FallBack change for NBXA Mobile
	2. Update MatchCriteria_Mode		   2017/09/07		   [MSN]
Add function for NBXA
	1. GetNGBankDefault	   		   2017/10/12		   [WMC]
	2. GetBankPspByOtherMerchDefault
Add function for Vmobile New Phase		   2017/11/24		   [WMC]
	1. GetMobileBankByMerchNCcyNGrpNew	
	2. GetBankPspByMerchNCcyNGrpNew
Update function for Vmobile New Phase
	1. MatchCriteria_Mode
Add ip_region_code in the functions		   2020/10/15              [WMC]
	1. GetMobileBankByMerchNCcyNGrpNew
	2. GetBankPspByMerchNCcyNGrpNew
	3. GetNGBankDefault
	4. GetBankPspByOtherMerchDefault
	5. GetBankPspForSARIP
	6. GetBankPspByMerchNCcyNGrp                    
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "RuleLB.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


static char    cDebug;

void RuleLB(char    cdebug)
{
        cDebug = cdebug;
}


int MatchCriteria(const hash_t *hRec,
			recordset_t* myRec)
{

	int iRet = PD_NOT_FOUND;
	int	iCnt = 0;
	char	*csPtr;
	char	cPtr;
	int	iPtr;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO match_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		short	hv_return_value;
		varchar	hv_channel_code[PD_CHANNEL_CODE_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];
		varchar	hv_payment_method[PD_PAY_METHOD_LEN];
		varchar	hv_txn_country[PD_COUNTRY_LEN];
		varchar	hv_txn_ccy[PD_CCY_ID_LEN];
		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_client_id[PD_CLIENT_ID_LEN];
		char	hv_business_type;
		varchar	hv_customer_tag[PD_CUSTOMER_TAG_LEN];
		int	hv_restricted_ip;

		//int	v_txn_amount_tier;
		double  v_min_txn_amount;
		double  v_max_txn_amount;
		int	v_criteria_pool_id;
		int	v_scheduler_id;
		int	v_priority;
		varchar	v_out_customer_tag[PD_CUSTOMER_TAG_LEN+1];
		
		short	ind_channel_code = -1;
		short	ind_service_code = -1;
		short	ind_payment_method = -1;
		short	ind_txn_country = -1;
		short	ind_txn_ccy = -1;
		short	ind_merchant_id = -1;
		short	ind_client_id = -1;
		short	ind_business_type = -1;
		short	ind_customer_tag = -1;
		short	ind_restricted_ip = -1;

		//short	ind_txn_amount_tier = -1;
		short	ind_min_txn_amount = -1;
		short	ind_max_txn_amount = -1;
		short	ind_pool_id = -1;
		short	ind_scheduler_id = -1;
		short	ind_priority = -1;
		short	ind_out_customer_tag = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* channel code */
	if (GetField_CString(hRec,"channel_code",&csPtr)) {
		hv_channel_code.len = strlen(csPtr);
		memcpy(hv_channel_code.arr,csPtr,hv_channel_code.len);
		ind_channel_code = 0;
DEBUGLOG(("MatchCriteria: channel_code = [%.*s]\n",hv_channel_code.len,hv_channel_code.arr));
	}
	else {
DEBUGLOG(("MatchCriteria: channel_code is missing!!!\n"));
	}

/* service code */
	if (GetField_CString(hRec,"service_code",&csPtr)) {
		hv_service_code.len = strlen(csPtr);
		memcpy(hv_service_code.arr,csPtr,hv_service_code.len);
		ind_service_code = 0;
DEBUGLOG(("MatchCriteria: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
	}
	else {
DEBUGLOG(("MatchCriteria: service_code is missing!!!\n"));
	}

/*payment method */
	if (GetField_CString(hRec,"pay_method",&csPtr)) {
		hv_payment_method.len = strlen(csPtr);
		memcpy(hv_payment_method.arr,csPtr,hv_payment_method.len);
		ind_payment_method = 0;
DEBUGLOG(("MatchCriteria: payment_method = [%.*s]\n",hv_payment_method.len,hv_payment_method.arr));
	}
	else {
DEBUGLOG(("MatchCriteria: pay_method is missing!!!\n"));
	}

/*txn_country */
	if (GetField_CString(hRec,"txn_country",&csPtr)) {
		hv_txn_country.len = strlen(csPtr);
		memcpy(hv_txn_country.arr,csPtr,hv_txn_country.len);
		ind_txn_country = 0;
DEBUGLOG(("MatchCriteria: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));
	}
	else {
DEBUGLOG(("MatchCriteria: txn_country is missing!!!\n"));
	}

/*txn_ccy */
	if (GetField_CString(hRec,"txn_ccy",&csPtr)) {
		hv_txn_ccy.len = strlen(csPtr);
		memcpy(hv_txn_ccy.arr,csPtr,hv_txn_ccy.len);
		ind_txn_ccy = 0;
DEBUGLOG(("MatchCriteria: txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));
	}
	else {
DEBUGLOG(("MatchCriteria: txn_ccy is missing!!!\n"));
	}


/*merchant_id */
	if (GetField_CString(hRec,"merchant_id",&csPtr)) {
		hv_merchant_id.len = strlen(csPtr);
		memcpy(hv_merchant_id.arr,csPtr,hv_merchant_id.len);
		ind_merchant_id = 0;
DEBUGLOG(("MatchCriteria: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
	}
	else {
DEBUGLOG(("MatchCriteria: merchant_id is missing!!!\n"));
	}

/*client_id */
	if (GetField_CString(hRec,"client_id",&csPtr)) {
		hv_client_id.len = strlen(csPtr);
		memcpy(hv_client_id.arr,csPtr,hv_client_id.len);
		ind_client_id = 0;
DEBUGLOG(("MatchCriteria: client_id = [%.*s]\n",hv_client_id.len,hv_client_id.arr));
	}
	else {
DEBUGLOG(("MatchCriteria: client_id is missing!!!\n"));
	}


/*business_type */
	if (GetField_Char(hRec,"business_type",&cPtr)) {
		hv_business_type = cPtr;
		ind_business_type = 0;
DEBUGLOG(("MatchCriteria: business_type = [%c]\n",hv_business_type));
	}
	else {
DEBUGLOG(("MatchCriteria: business_type is missing!!!\n"));
	}

/*customer_tag */
	if (GetField_CString(hRec,"customer_tag",&csPtr)) {
		hv_customer_tag.len = strlen(csPtr);
		memcpy(hv_customer_tag.arr,csPtr,hv_customer_tag.len);
		ind_customer_tag = 0;
DEBUGLOG(("MatchCriteria: customer_tag = [%.*s]\n",hv_customer_tag.len,hv_customer_tag.arr));
	}

/*restricted_ip*/
	if (GetField_Int(hRec,"restricted_ip",&iPtr)) {
		hv_restricted_ip = iPtr;
		ind_restricted_ip = 0;
DEBUGLOG(("MatchCriteria: restricted_ip = [%d]\n",hv_restricted_ip));
	}
	else {
DEBUGLOG(("MatchCriteria: restricted_ip is missing!!!\n"));
	}

	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rule_lb_match(:hv_channel_code:ind_channel_code,
								:hv_service_code:ind_service_code,
								:hv_payment_method:ind_payment_method,
								:hv_txn_country:ind_txn_country,
								:hv_txn_ccy:ind_txn_ccy,
								:hv_merchant_id:ind_merchant_id,
								:hv_client_id:ind_client_id,
								:hv_business_type:ind_business_type,
								:hv_customer_tag:ind_customer_tag,
								:hv_restricted_ip:ind_restricted_ip,
								:c_cursor_id);
                END;
        END-EXEC;

	if (hv_return_value > 0 ) {
DEBUGLOG(("MatchCriteria: Found!\n"));
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			//ind_txn_amount_tier = -1;
			ind_min_txn_amount = -1;
			ind_max_txn_amount = -1;
			ind_pool_id = -1;
			ind_scheduler_id = -1;
			ind_priority = -1;
			ind_out_customer_tag = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_min_txn_amount:ind_min_txn_amount,
				:v_max_txn_amount:ind_max_txn_amount,
				:v_criteria_pool_id:ind_pool_id,
				:v_scheduler_id:ind_scheduler_id,
				:v_priority:ind_priority,
				:v_out_customer_tag:ind_out_customer_tag;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			/*
			if (ind_txn_amount_tier >= 0) {
DEBUGLOG(("MatchCriteria: [%03d]txn_amount_tier = [%d]\n",iCnt,v_txn_amount_tier));
				PutField_Int(myHash,"amount_tier_id",v_txn_amount_tier);
			}
			*/

			if (ind_min_txn_amount >= 0) {
DEBUGLOG(("MatchCriteria: [%03d]min_txn_amount = [%lf]\n",iCnt,v_min_txn_amount));
				PutField_Double(myHash,"min_txn_amount",v_min_txn_amount);
			}
			if (ind_max_txn_amount >= 0) {
DEBUGLOG(("MatchCriteria: [%03d]max_txn_amount = [%lf]\n",iCnt,v_max_txn_amount));
				PutField_Double(myHash,"max_txn_amount",v_max_txn_amount);
			}
	
			if (ind_pool_id >= 0) {
DEBUGLOG(("MatchCriteria: [%03d]criteria_pool_id = [%d]\n",iCnt,v_criteria_pool_id));
				PutField_Int(myHash,"criteria_pool_id",v_criteria_pool_id);
			}
			if (ind_scheduler_id >= 0) {
DEBUGLOG(("MatchCriteria: [%03d]scheduler_id = [%d]\n",iCnt,v_scheduler_id));
				PutField_Int(myHash,"scheduler_id",v_scheduler_id);
			}

			if (ind_priority >= 0) {
DEBUGLOG(("MatchCriteria: [%03d]priority = [%d]\n",iCnt,v_priority));
				PutField_Int(myHash,"priority",v_priority);
			}

			if (ind_out_customer_tag>= 0) {
				v_out_customer_tag.arr[v_out_customer_tag.len] = '\0';
DEBUGLOG(("MatchCriteria: [%03d]out_customer_tag = [%s]\n",iCnt,v_out_customer_tag.arr));
				PutField_CString(myHash,"out_customer_tag",(const char*)v_out_customer_tag.arr);
			}

			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
		EXEC SQL CLOSE :c_cursor_id;
		EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("MatchCriteria: exit with ok\n"));
		return PD_FOUND;
	}
	else {
		EXEC SQL CLOSE :c_cursor_id;
		EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("MatchCriteria: exit with error\n"));
		return PD_NOT_FOUND;
	}


	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("RET = [%d]\n",iRet));
	return iRet;

match_error:
DEBUGLOG(("match_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_NOT_FOUND;
}

int GetAvalPspsByPool(hash_t* hPsp,
			int iPoolId,
			recordset_t* myRec)
{

	int iRet = PD_OK;
	char*	csBuf;
	char	csTag[PD_TAG_LEN +1];
	char*	csPtr;
	int	iPtr;
	int 	i;

	hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO getavalpspsbypool_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
	varchar         hv_dynstmt[1024*4];

	int	hv_pool_id;

	varchar	v_psp_id[PD_PSP_ID_LEN +1];
	int	v_ratio;
	int	v_priority;
	

	short	ind_psp_id = -1;
	short	ind_ratio = -1;
	short	ind_priority = -1;

        EXEC SQL END DECLARE SECTION;

	hv_pool_id = iPoolId;
DEBUGLOG(("GetAvalPspsByPool pool id = [%d]\n",hv_pool_id));

	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr,"SELECT rm_psp_id,");
	strcat((char*)hv_dynstmt.arr,"rm_ratio,");
	strcat((char*)hv_dynstmt.arr,"rm_priority");
	strcat((char*)hv_dynstmt.arr," FROM rule_psp_lb_mapping");
	strcat((char*)hv_dynstmt.arr," WHERE rm_pool_id  = ");
/* insert pool */
	sprintf(csBuf,"%d",iPoolId);
	strcat((char*)hv_dynstmt.arr, csBuf);
	strcat((char*)hv_dynstmt.arr," AND rm_psp_id in (");
/* insert psps */
	if (GetField_Int(hPsp,"psp_id_cnt",&iPtr)) {
DEBUGLOG(("GetAvalPspsByPool = [%d]\n",iPtr));
        }
	else 
		iPtr = 0;
	for (i= 0 ; i < iPtr; i++) {
		sprintf(csTag,"psp_id_%d",i);
		if (GetField_CString(hPsp,csTag,&csPtr)) {
DEBUGLOG(("GetAvalPspsByPool [%s] =  [%s]\n",csTag,csPtr));
			if (i != 0 ) 
				strcat((char*)hv_dynstmt.arr, ",");
			strcat((char*)hv_dynstmt.arr, "'");
			strcat((char*)hv_dynstmt.arr, csPtr);
			strcat((char*)hv_dynstmt.arr, "'");
		}
	}

	strcat((char*)hv_dynstmt.arr,")");
	strcat((char*)hv_dynstmt.arr," AND rm_disabled = 0");
	strcat((char*)hv_dynstmt.arr," order by rm_priority desc, rm_ratio desc");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	FREE_ME(csBuf);

DEBUGLOG(("GetAvalPspsByPool:[%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));
	EXEC SQL PREPARE s1 FROM :hv_dynstmt;  
	EXEC SQL DECLARE c_cursor_getavalpspsbypool CURSOR FOR s1;
  	

	EXEC SQL OPEN c_cursor_getavalpspsbypool;
        do {
		EXEC SQL FETCH c_cursor_getavalpspsbypool
                INTO
			:v_psp_id:ind_psp_id,
			:v_ratio:ind_ratio,
			:v_priority:ind_priority;

		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }	

		myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);	

		if  (ind_psp_id >= 0) {
			v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetAvalPspsByPool PSP ID = [%s]\n",v_psp_id.arr));
			PutField_CString(myHash,"psp_id",(char*)v_psp_id.arr);
		}

		if  (ind_ratio < 0) {
			v_ratio = 0;
		}
DEBUGLOG(("GetAvalPspsByPool ratio = [%d]\n",v_ratio));
		PutField_Int(myHash,"pool_psp_ratio",v_ratio);

		if  (ind_priority < 0) {
			v_priority = 0;
		}
DEBUGLOG(("GetAvalPspsByPool priority = [%d]\n",v_priority));
		PutField_Int(myHash,"pool_psp_priority",v_priority);


		RecordSet_Add(myRec,myHash);
	}while (PD_TRUE);	

	EXEC SQL CLOSE c_cursor_getavalpspsbypool;
	return iRet;

getavalpspsbypool_error:
DEBUGLOG(("getavalpspsbypool_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_getavalpspsbypool;
    return PD_ERR;
}



int FindAvalPsp(int     iPoolId,
                const char* csServiceCode,
                const char* csTxnCountry,
                double dTxnAmt)
{
        int iRet = PD_ERR;

DEBUGLOG(("FindAvalPsp()\n"));
        EXEC SQL WHENEVER SQLERROR GOTO findavalpsp_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                int     hv_pool_id;
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
                varchar hv_txn_country[PD_COUNTRY_LEN];
                varchar hv_category[PD_CATEGORY_LEN];
                char    hv_type;
                char    hv_party_type;
                double  hv_txn_amt;

                int     v_counter;

                short   ind_counter = -1;

        EXEC SQL END DECLARE SECTION;

        hv_pool_id = iPoolId;
DEBUGLOG(("FindAvalPsp: pool id  = [%d]\n",iPoolId));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("FindAvalPsp: service_code = [%.*s][%d]\n",hv_service_code.len,hv_service_code.arr,hv_service_code.len));

        hv_txn_country.len = strlen(csTxnCountry);
        memcpy(hv_txn_country.arr,csTxnCountry,hv_txn_country.len);
DEBUGLOG(("FindAvalPsp: txn_country = [%.*s][%d]\n",hv_txn_country.len,hv_txn_country.arr,hv_txn_country.len));

        hv_type = PD_DAILY;
DEBUGLOG(("FindAvalPsp: type = [%c]\n",hv_type));


        hv_category.len = strlen(PD_VALUE_TYPE_AMT);
        memcpy(hv_category.arr,PD_VALUE_TYPE_AMT,hv_category.len);
DEBUGLOG(("FindAvalPsp: category = [%.*s][%d]\n",hv_category.len,hv_category.arr,hv_category.len));

        hv_party_type = PD_TYPE_PSP;
DEBUGLOG(("FindAvalPsp: party_type = [%c]\n",hv_party_type));

        hv_txn_amt = dTxnAmt;
DEBUGLOG(("FindAvalPsp: txn amt = [%f]\n",hv_txn_amt));


        EXEC SQL DECLARE c_cursor_findavalpsp CURSOR FOR
		SELECT count(*) as cnt
		  FROM (SELECT rm_psp_id,
         		       rpp_limit,
         		       nvl(tc_counter,0) as counter,
         		       nvl(tc_total_counter,0) as total_counter
   			  FROM (SELECT rm_psp_id,
                                       rpp_limit
                                  FROM rule_psp_lb_mapping,
                               	       psp_detail a,
                               	       psp_master b,
                               	       rule_psp_lb_psp
                         	 WHERE rm_pool_id = :hv_pool_id
                           	   AND rm_disabled = 0
                           	   AND rm_psp_id = a.psp_id
                           	   AND a.disabled = 0
                           	   AND a.online_mode = 'Y'
                           	   AND a.status = 'O'
                           	   AND a.client_id = b.pm_client_id
                           	   AND b.pm_status = 'O'
                           	   AND rm_psp_id = rpp_psp_id
                           	   AND rpp_disabled = 0) a
    		         LEFT JOIN txn_counters
    			   ON rm_psp_id = tc_party_id
    			  AND tc_txn_code in ('DSI','DSP')
                          AND tc_country_id = :hv_txn_country
                          AND tc_channel_code in ('WEB','XPY')
                          AND tc_service_code = :hv_service_code
                          AND TC_type = :hv_type
                          AND tc_category = :hv_category
                          AND Tc_party_type = :hv_party_type) 
    		  WHERE (rpp_limit >= (total_counter + :hv_txn_amt) or rpp_limit = 0);
              	



        EXEC SQL OPEN c_cursor_findavalpsp;
        do {
                EXEC SQL FETCH c_cursor_findavalpsp
                  INTO
                        :v_counter:ind_counter;


                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

DEBUGLOG(("FindAvalPsp  found\n"));
                if (ind_counter >= 0 ) {
DEBUGLOG(("FindAvalPsp  counter = [%d]\n",v_counter));
                        if (v_counter >0 )  {
                                iRet = PD_OK;
                        }
                }

        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_findavalpsp;

DEBUGLOG(("FindAvalPsp Counter iRet = [%d]\n",iRet));
        return iRet;
findavalpsp_error:
DEBUGLOG(("findavalpsp_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_findavalpsp;
    return PD_ERR;
}
int FindAvalPspForPool(int iPoolId,
			hash_t* hRec)
{
        int 	iRet = PD_ERR;
	int	iPspCnt;
	char*	csBuf;
	char*	csPtr;

DEBUGLOG(("FindAvalPspForPool()\n"));
        EXEC SQL WHENEVER SQLERROR GOTO findavalpspforpool_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
	int	v_cnt;
	varchar hv_dynstmt[1024*4];

	short	ind_cnt = -1;
        EXEC SQL END DECLARE SECTION;

	csBuf = (char*) malloc (128);

	strcpy((char*)hv_dynstmt.arr,"select count(*) as cnt ");
	strcat((char*)hv_dynstmt.arr,"from rule_psp_lb_mapping,rule_psp_lb_psp ");
	strcat((char*)hv_dynstmt.arr,"where rm_disabled = 0 ");

/* pool id */
	strcat((char*)hv_dynstmt.arr,"and rm_pool_id = ");
	sprintf(csBuf,"%d",iPoolId);
	strcat((char*)hv_dynstmt.arr,csBuf);
	strcat((char*)hv_dynstmt.arr," ");

	strcat((char*)hv_dynstmt.arr,"and rm_psp_id = rpp_psp_id ");
	strcat((char*)hv_dynstmt.arr,"and rpp_disabled = 0 ");
	strcat((char*)hv_dynstmt.arr,"and rpp_psp_id in (");
	
	if (GetField_Int(hRec,"psp_id_cnt",&iPspCnt)) {
DEBUGLOG(("FindAvalPspForPool: psp_id_cnt = [%d]\n",iPspCnt));
		int i = 0;
		char	csTag[PD_TAG_LEN +1];
		for (i = 0; i < iPspCnt; i++) {
			sprintf(csTag,"psp_id_%d",i);
			if (GetField_CString(hRec,csTag,&csPtr)) {
DEBUGLOG(("FindAvalPspForPool: [%s] = [%s]\n",csTag,csPtr));
				if (i == 0)
					sprintf(csBuf,"'%s'",csPtr);
				else 
					sprintf(csBuf,",'%s'",csPtr);
				strcat((char*)hv_dynstmt.arr,csBuf);
			}
		}
        }
	strcat((char*)hv_dynstmt.arr,")");

        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL DECLARE c_cursor_getavalpsp CURSOR FOR PS;
	FREE_ME(csBuf);

	EXEC SQL OPEN c_cursor_getavalpsp;
        do {	
		EXEC SQL FETCH c_cursor_getavalpsp
                INTO
			:v_cnt:ind_cnt;

		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
		
		if (ind_cnt >= 0 ) {
			if (v_cnt > 0) {
DEBUGLOG(("FindAvalPspForPool: cnt = [%d]\n",v_cnt));
				iRet = PD_OK;
			}
		}
	}
	while (PD_TRUE);

	EXEC SQL CLOSE c_cursor_getavalpsp;
DEBUGLOG(("FindAvalPspForPool iRet = [%d]\n",iRet));
        return iRet;
findavalpspforpool_error:
DEBUGLOG(("findavalpspforpool_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_getavalpsp;
    return PD_ERR;
}

int FindAvalPspSchudler(int iPoolId,
			hash_t* hRec)
{
        int 	iRet = PD_ERR;
	int	iPspCnt;
	char*	csBuf;
	char*	csPtr;

DEBUGLOG(("FindAvalPspSchudler()\n"));
        EXEC SQL WHENEVER SQLERROR GOTO findavalpspschudler_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
	int	v_cnt;
	varchar hv_dynstmt[1024*4];

	short	ind_cnt = -1;
        EXEC SQL END DECLARE SECTION;

	csBuf = (char*) malloc (128);

	strcpy((char*)hv_dynstmt.arr,"select count(*) as cnt ");
	strcat((char*)hv_dynstmt.arr,"from rule_psp_lb_mapping,rule_psp_lb_psp ");
	strcat((char*)hv_dynstmt.arr,"where rm_disabled = 0 ");

/* pool id */
	strcat((char*)hv_dynstmt.arr,"and rm_pool_id = ");
	sprintf(csBuf,"%d",iPoolId);
	strcat((char*)hv_dynstmt.arr,csBuf);
	strcat((char*)hv_dynstmt.arr," ");

	strcat((char*)hv_dynstmt.arr,"and rm_psp_id = rpp_psp_id ");
	strcat((char*)hv_dynstmt.arr,"and rpp_disabled = 0 ");
	strcat((char*)hv_dynstmt.arr,"and rpp_psp_id in (");
	
	if (GetField_Int(hRec,"psp_id_cnt",&iPspCnt)) {
DEBUGLOG(("FindAvalPspSchudler: psp_id_cnt = [%d]\n",iPspCnt));
		int i = 0;
		char	csTag[PD_TAG_LEN +1];
		for (i = 0; i < iPspCnt; i++) {
			sprintf(csTag,"psp_id_%d",i);
			if (GetField_CString(hRec,csTag,&csPtr)) {
DEBUGLOG(("FindAvalPspForPool: [%s] = [%s]\n",csTag,csPtr));
				if (i == 0)
					sprintf(csBuf,"'%s'",csPtr);
				else 
					sprintf(csBuf,",'%s'",csPtr);
				strcat((char*)hv_dynstmt.arr,csBuf);
			}
		}
        }
	strcat((char*)hv_dynstmt.arr,")");

        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL DECLARE c_cursor_getavalpspschudler CURSOR FOR PS;
	FREE_ME(csBuf);

	EXEC SQL OPEN c_cursor_getavalpspschudler;
        do {	
		EXEC SQL FETCH c_cursor_getavalpspschudler
                INTO
			:v_cnt:ind_cnt;

		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
		
		if (ind_cnt >= 0 ) {
			if (v_cnt > 0) {
DEBUGLOG(("FindAvalPspSchudler: cnt = [%d]\n",v_cnt));
				iRet = PD_OK;
			}
		}
	}
	while (PD_TRUE);

	EXEC SQL CLOSE c_cursor_getavalpspschudler;
DEBUGLOG(("FindAvalPspSchudler iRet = [%d]\n",iRet));
        return iRet;
findavalpspschudler_error:
DEBUGLOG(("findavalpspschduler code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_getavalpspschudler;
    return PD_ERR;
}

int GetAllPspByMerch(const char* csMerchantId,
			recordset_t* myRec)
{

	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO get_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	v_psp_name[PD_PSP_NAME_LEN];
		varchar	v_psp_id[PD_PSP_ID_LEN];
		varchar v_ccy[PD_CCY_ID_LEN];
		double v_limit;
		double v_remaining_limit;

		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];

		short	hv_return_value;

		short	ind_psp_name = -1;
		short	ind_psp_id = -1;
		short	ind_ccy = -1;
		short	ind_limit = -1;
		short	ind_remaining_limit = -1;

		short	ind_merchant_id = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetAllPspByMerch: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rule_lb_all_psp_get(:hv_merchant_id:ind_merchant_id,
								:c_cursor_id);
                END;
        END-EXEC;

	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_psp_name = -1;
			ind_psp_id = -1;
			ind_ccy = -1;
			ind_limit = -1;
			ind_remaining_limit = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_psp_name:ind_psp_name,
				:v_psp_id:ind_psp_id,
				:v_ccy:ind_ccy,
				:v_limit:ind_limit,
				:v_remaining_limit:ind_remaining_limit;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_psp_name >= 0) {
				v_psp_name.arr[v_psp_name.len] = '\0';
DEBUGLOG(("GetAllPspByMerch: [%03d]psp_name = [%s]\n",iCnt,v_psp_name.arr));
				PutField_CString(myHash,"psp_name",(const char*)v_psp_name.arr);
			}

			if (ind_psp_id >= 0) {
				v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetAllPspByMerch: [%03d]psp_id = [%s]\n",iCnt,v_psp_id.arr));
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetAllPspByMerch: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}

			if (ind_limit >= 0) {
DEBUGLOG(("GetAllPspByMerch: [%03d]limit = [%lf]\n",iCnt,v_limit));
				PutField_Double(myHash,"psp_limit",v_limit);
			}

			if (ind_remaining_limit >= 0) {
DEBUGLOG(("GetAllPspByMerch: [%03d]remaining_limit = [%lf]\n",iCnt,v_remaining_limit));
				PutField_Double(myHash,"psp_remaining_limit",v_remaining_limit);
			}
	
			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("GetAllPspByMerch: Finished\n"));

	return iRet;

get_error:
DEBUGLOG(("get_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}


int GetAllPspByMerchBank(const char* csMerchantId,
			const char* csBank,
			recordset_t* myRec)
{
	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO mbget_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	v_psp_name[PD_PSP_NAME_LEN];
		varchar	v_psp_id[PD_PSP_ID_LEN];
		varchar	v_client_id[PD_CLIENT_ID_LEN];
		varchar v_ccy[PD_CCY_ID_LEN];
		double v_limit;
		double v_remaining_limit;

		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_bank[PD_BANK_CODE_LEN];

		short	hv_return_value;

		short	ind_psp_name = -1;
		short	ind_psp_id = -1;
		short	ind_client_id = -1;
		short	ind_ccy = -1;
		short	ind_limit = -1;
		short	ind_remaining_limit = -1;

		short	ind_merchant_id = -1;
		short	ind_bank= -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetAllPspByMerchBank: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* bank_code */
	hv_bank.len = strlen(csBank);
	memcpy(hv_bank.arr,csBank,hv_bank.len);
	ind_bank= 0;
DEBUGLOG(("GetAllPspByMerchBank: bank_code = [%.*s]\n",hv_bank.len,hv_bank.arr));

	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rule_lb_mbgetpsp(:hv_merchant_id:ind_merchant_id,
								:hv_bank:ind_bank,
								:c_cursor_id);
                END;
        END-EXEC;

	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_psp_name = -1;
			ind_psp_id = -1;
			ind_client_id = -1;
			ind_ccy = -1;
			ind_limit = -1;
			ind_remaining_limit = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_psp_name:ind_psp_name,
				:v_psp_id:ind_psp_id,
				:v_client_id:ind_client_id,
				:v_ccy:ind_ccy,
				:v_limit:ind_limit,
				:v_remaining_limit:ind_remaining_limit;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_psp_name >= 0) {
				v_psp_name.arr[v_psp_name.len] = '\0';
DEBUGLOG(("GetAllPspByMerchBank: [%03d]psp_name = [%s]\n",iCnt,v_psp_name.arr));
				PutField_CString(myHash,"psp_name",(const char*)v_psp_name.arr);
			}

			if (ind_psp_id >= 0) {
				v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetAllPspByMerchBank: [%03d]psp_id = [%s]\n",iCnt,v_psp_id.arr));
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
			}

			if (ind_client_id >= 0) {
				v_client_id.arr[v_client_id.len] = '\0';
DEBUGLOG(("GetAllPspByMerchBank: [%03d]client_id = [%s]\n",iCnt,v_client_id.arr));
				PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetAllPspByMerchBank: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}

			if (ind_limit >= 0) {
DEBUGLOG(("GetAllPspByMerchBank: [%03d]limit = [%lf]\n",iCnt,v_limit));
				PutField_Double(myHash,"psp_limit",v_limit);
			}

			if (ind_remaining_limit >= 0) {
DEBUGLOG(("GetAllPspByMerchBank: [%03d]remaining_limit = [%lf]\n",iCnt,v_remaining_limit));
				PutField_Double(myHash,"psp_remaining_limit",v_remaining_limit);
			}
	
			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("GetAllPspByMerchBank: Finished\n"));

	return iRet;

mbget_error:
DEBUGLOG(("mbget_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}

int HaveDefineRuleByService(const char* csServiceCode)
{
        int iRet = PD_NOT_FOUND;

DEBUGLOG(("HaveDefineRuleByService()\n"));
        EXEC SQL WHENEVER SQLERROR GOTO byservice_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_service_code[PD_SERVICE_CODE_LEN];

                int     v_count;

                short   ind_count= -1;

        EXEC SQL END DECLARE SECTION;

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("HaveDefineRuleByService: service_code = [%.*s][%d]\n",hv_service_code.len,hv_service_code.arr,hv_service_code.len));

        EXEC SQL DECLARE c_cursor_byservice CURSOR FOR
		SELECT	count(*) 
              	FROM	rule_psp_lb_criteria
		where	rc_service_code = :hv_service_code
		and	rc_allow_special_region = 1
		and	rc_disabled = 0;

        EXEC SQL OPEN c_cursor_byservice;
        do {
                EXEC SQL FETCH c_cursor_byservice
                  INTO
                        :v_count:ind_count;


                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

DEBUGLOG(("HaveDefineRuleByService  found\n"));
                if (ind_count>= 0 ) {
DEBUGLOG(("HaveDefineRuleByService  count = [%d]\n",v_count));
                        if (v_count>0 )  {
                                iRet = PD_FOUND;
                        }
                }
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_byservice;

DEBUGLOG(("HaveDefineRuleByService iRet = [%d]\n",iRet));
        return iRet;
byservice_error:
DEBUGLOG(("byservice_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_byservice;
    return PD_ERR;
}


int GetBankPspByMerch(const char* csMerchantId,
			recordset_t* myRec)
{
	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO maget_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	v_psp_id[PD_PSP_ID_LEN];
		varchar	v_client_id[PD_CLIENT_ID_LEN];
		varchar v_ccy[PD_CCY_ID_LEN];
		varchar	v_bank[PD_BANK_CODE_LEN];
		double	v_remaining_limit;
		int	v_scheduler_id;
		int	v_note_id;

		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];

		short	hv_return_value;

		short	ind_psp_id = -1;
		short	ind_client_id = -1;
		short	ind_ccy = -1;
		short	ind_bank= -1;
		short	ind_remaining_limit = -1;
		short	ind_scheduler_id = -1;
		short	ind_note_id = -1;

		short	ind_merchant_id = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetBankPspByMerch: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));


	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rule_lb_merch_get_pspbank( :hv_merchant_id:ind_merchant_id,
									  :c_cursor_id);
                END;
        END-EXEC;

	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_psp_id = -1;
			ind_client_id = -1;
			ind_ccy = -1;
			ind_bank = -1;
			ind_remaining_limit = -1;
			ind_scheduler_id = -1;
			ind_note_id = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_bank:ind_bank,
				:v_client_id:ind_client_id,
				:v_psp_id:ind_psp_id,
				:v_ccy:ind_ccy,
				:v_remaining_limit:ind_remaining_limit,
				:v_scheduler_id:ind_scheduler_id,
				:v_note_id:ind_note_id;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_bank >= 0) {
				v_bank.arr[v_bank.len] = '\0';
DEBUGLOG(("GetBankPspByMerch: [%03d]bank = [%s]\n",iCnt,v_bank.arr));
				PutField_CString(myHash,"bank_code",(const char*)v_bank.arr);
			}

			if (ind_psp_id >= 0) {
				v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetBankPspByMerch: [%03d]psp_id = [%s]\n",iCnt,v_psp_id.arr));
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
			}

			if (ind_client_id >= 0) {
				v_client_id.arr[v_client_id.len] = '\0';
DEBUGLOG(("GetBankPspByMerch: [%03d]client_id = [%s]\n",iCnt,v_client_id.arr));
				PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetBankPspByMerch: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}
	
			if (ind_remaining_limit>= 0) {
DEBUGLOG(("GetBankPspByMerch: [%03d]remaining_limit = [%lf]\n",iCnt,v_remaining_limit));
				PutField_Double(myHash,"remaining_limit",v_remaining_limit);
			}

			if (ind_scheduler_id>= 0) {
DEBUGLOG(("GetBankPspByMerch: [%03d]scheduler_id = [%d]\n",iCnt,v_scheduler_id));
				PutField_Int(myHash,"scheduler_id",v_scheduler_id);
			}

			if (ind_note_id>= 0) {
DEBUGLOG(("GetBankPspByMerch: [%03d]note_id = [%d]\n",iCnt,v_note_id));
				PutField_Int(myHash,"note_id",v_note_id);
			}

			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("GetBankPspByMerch: Finished\n"));

	return iRet;

maget_error:
DEBUGLOG(("maget_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}

/*
int GetDstCcyWithLBRule(const char* csMerchantId,
			const char* csServiceCode,
			recordset_t* myRec)
{
	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO getccy_lb_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar v_ccy[PD_CCY_ID_LEN];

		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];

		short	hv_return_value;

		short	ind_ccy = -1;

		short	ind_merchant_id = -1;
		short	ind_service_code = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

// merchant_id 
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetDstCcyWithLBRule: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

// service_code 
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetDstCcyWithLBRule: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));


	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rule_lb_get_dstccy(:hv_merchant_id:ind_merchant_id,
								  :hv_service_code:ind_service_code,
								  :c_cursor_id);
                END;
        END-EXEC;

	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_ccy = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	
				:v_ccy:ind_ccy;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetDstCcyWithLBRule: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}
	
			RecordSet_Add(myRec,myHash);
			iCnt++;
			break; ////only one record
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;

	if(iCnt==0)
		iRet = PD_ERR;

DEBUGLOG(("GetDstCcyWithLBRule: Finished iRet = [%d]\n",iRet));

	return iRet;

getccy_lb_error:
DEBUGLOG(("getccy_lb_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}

int GetDstCcyWithoutLBRule(const char* csMerchantId,
			const char* csServiceCode,
			recordset_t* myRec)
{
	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO getccy_wolb_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar v_ccy[PD_CCY_ID_LEN];

		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];

		short	hv_return_value;

		short	ind_ccy = -1;

		short	ind_merchant_id = -1;
		short	ind_service_code = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

// merchant_id
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetDstCcyWithoutLBRule: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

// service_code 
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetDstCcyWithoutLBRule: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));


	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_no_lbrule_get_dstccy(:hv_merchant_id:ind_merchant_id,
								  :hv_service_code:ind_service_code,
								  :c_cursor_id);
                END;
        END-EXEC;

	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_ccy = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	
				:v_ccy:ind_ccy;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetDstCcyWithoutLBRule: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}
	
			RecordSet_Add(myRec,myHash);
			iCnt++;
			break; ////only one record
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;

	if(iCnt==0)
		iRet = PD_ERR;

DEBUGLOG(("GetDstCcyWithoutLBRule: Finished iRet = [%d]\n",iRet));

	return iRet;

getccy_wolb_error:
DEBUGLOG(("getccy_wolb_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}
*/

int GetDstCcyWithoutRule(const char* csMerchantId,
			const char* csServiceCode,
			hash_t * hTxn)
{
	int iRet = PD_OK;

        EXEC SQL WHENEVER SQLERROR GOTO getccy_wor_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar v_ccy[PD_CCY_ID_LEN];

		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];

		short	hv_return_value;

		short	ind_ccy = -1;

		short	ind_merchant_id = -1;
		short	ind_service_code = -1;


        EXEC SQL END DECLARE SECTION;

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetDstCcyWithoutRule: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetDstCcyWithoutRule: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));


        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_no_rule_get_dstccy(:hv_merchant_id:ind_merchant_id,
								  :hv_service_code:ind_service_code,
								  :v_ccy:ind_ccy);
                END;
        END-EXEC;

	if (hv_return_value == 0 ) {
		if (ind_ccy>= 0) {
			v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetDstCcyWithoutRule: ccy = [%s]\n",v_ccy.arr));
			PutField_CString(hTxn,"psp_ccy",(const char*)v_ccy.arr);
		}
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("GetDstCcyWithoutRule  Failed\n"));
	}


DEBUGLOG(("GetDstCcyWithoutRule: Finished iRet = [%d]\n",iRet));

	return iRet;

getccy_wor_error:
DEBUGLOG(("getccy_wor_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return PD_ERR;
}

int GetCustomerGroup(const char* csMerchantId,
                     const char* csServiceCode,
                     const char* csCcy,
                     const char* csBankCode,
                     hash_t * hTxn)
{
	int iRet = PD_OK;
	int iCnt = 0;
	char csTag[PD_TAG_LEN+1];

        EXEC SQL WHENEVER SQLERROR GOTO getgrp_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];
		varchar hv_ccy[PD_CCY_ID_LEN];
		varchar hv_bank_code[PD_BANK_CODE_LEN];

		varchar	v_group[PD_CUSTOMER_GROUP_CODE_LEN+1];

		short	hv_return_value;

		short	ind_merchant_id = -1;
		short	ind_service_code = -1;
		short	ind_ccy = -1;
		short	ind_bank_code  = -1;

		short	ind_group = -1;

		SQL_CURSOR      c_cursor_id;
        EXEC SQL END DECLARE SECTION;

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetCustomerGroup: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetCustomerGroup: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/*ccy*/
	hv_ccy.len = strlen(csCcy);
	memcpy(hv_ccy.arr,csCcy,hv_ccy.len);
	ind_ccy = 0;
DEBUGLOG(("GetCustomerGroup: ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));

/* bank_code */
	hv_bank_code.len = strlen(csBankCode);
	memcpy(hv_bank_code.arr,csBankCode,hv_bank_code.len);
	ind_bank_code = 0;
DEBUGLOG(("GetCustomerGroup: bank_code = [%.*s]\n",hv_bank_code.len,hv_bank_code.arr));


	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rule_lb_get_custgrp(:hv_merchant_id:ind_merchant_id,
								  :hv_service_code:ind_service_code,
								  :hv_ccy:ind_ccy,
								  :hv_bank_code:ind_bank_code,
								  :c_cursor_id);
                END;
        END-EXEC;

	PutField_Int(hTxn,"group_cnt",iCnt);
	if (hv_return_value == 0 ) {
		for (;;) {
			ind_group = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	
				:v_group:ind_group;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_group>= 0) {
				v_group.arr[v_group.len] = '\0';
DEBUGLOG(("GetCustomerGroup: [%03d]group = [%s]\n",iCnt,v_group.arr));
				sprintf(csTag,"customer_group_%d",iCnt);
				PutField_CString(hTxn,csTag,(const char*)v_group.arr);
			}
	
			iCnt++;
			PutField_Int(hTxn,"group_cnt",iCnt);
		}
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("GetCustomerGroup  Failed!!!\n"));
	}

DEBUGLOG(("GetCustomerGroup: Finished iRet = [%d]\n",iRet));
	return iRet;

getgrp_error:
DEBUGLOG(("getgrp_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return PD_ERR;
}


int GetBankPspByMerchNCcy(const char* csMerchantId,
			const char* csCcy,
			recordset_t* myRec)
{
	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO maccyget_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	v_psp_id[PD_PSP_ID_LEN];
		varchar	v_client_id[PD_CLIENT_ID_LEN];
		varchar v_ccy[PD_CCY_ID_LEN];
		varchar	v_bank[PD_BANK_CODE_LEN];
		double	v_remaining_limit;
		int	v_scheduler_id;
		int	v_note_id;

		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_txn_ccy[PD_CCY_ID_LEN];

		short	hv_return_value;

		short	ind_psp_id = -1;
		short	ind_client_id = -1;
		short	ind_ccy = -1;
		short	ind_bank= -1;
		short	ind_remaining_limit = -1;
		short	ind_scheduler_id = -1;
		short	ind_note_id = -1;

		short	ind_merchant_id = -1;
		short	ind_txn_ccy = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetBankPspByMerchNCcy: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* txn_ccy*/
	hv_txn_ccy.len = strlen(csCcy);
	memcpy(hv_txn_ccy.arr,csCcy,hv_txn_ccy.len);
	ind_txn_ccy = 0;
DEBUGLOG(("GetBankPspByMerchNCcy: txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));


	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rule_lb_mccy_get_pspbank( :hv_merchant_id:ind_merchant_id,
									     :hv_txn_ccy:ind_txn_ccy,
									     :c_cursor_id);
                END;
        END-EXEC;

	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_psp_id = -1;
			ind_client_id = -1;
			ind_ccy = -1;
			ind_bank = -1;
			ind_remaining_limit = -1;
			ind_scheduler_id = -1;
			ind_note_id = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_bank:ind_bank,
				:v_client_id:ind_client_id,
				:v_psp_id:ind_psp_id,
				:v_ccy:ind_ccy,
				:v_remaining_limit:ind_remaining_limit,
				:v_scheduler_id:ind_scheduler_id,
				:v_note_id:ind_note_id;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_bank >= 0) {
				v_bank.arr[v_bank.len] = '\0';
DEBUGLOG(("GetBankPspByMerchNCcy: [%03d]bank = [%s]\n",iCnt,v_bank.arr));
				PutField_CString(myHash,"bank_code",(const char*)v_bank.arr);
			}

			if (ind_psp_id >= 0) {
				v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetBankPspByMerchNCcy: [%03d]psp_id = [%s]\n",iCnt,v_psp_id.arr));
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
			}

			if (ind_client_id >= 0) {
				v_client_id.arr[v_client_id.len] = '\0';
DEBUGLOG(("GetBankPspByMerchNCcy: [%03d]client_id = [%s]\n",iCnt,v_client_id.arr));
				PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetBankPspByMerchNCcy: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}
	
			if (ind_remaining_limit>= 0) {
DEBUGLOG(("GetBankPspByMerchNCcy: [%03d]remaining_limit = [%lf]\n",iCnt,v_remaining_limit));
				PutField_Double(myHash,"remaining_limit",v_remaining_limit);
			}

			if (ind_scheduler_id>= 0) {
DEBUGLOG(("GetBankPspByMerchNCcy: [%03d]scheduler_id = [%d]\n",iCnt,v_scheduler_id));
				PutField_Int(myHash,"scheduler_id",v_scheduler_id);
			}

			if (ind_note_id>= 0) {
DEBUGLOG(("GetBankPspByMerchNCcy: [%03d]note_id = [%d]\n",iCnt,v_note_id));
				PutField_Int(myHash,"note_id",v_note_id);
			}

			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("GetBankPspByMerchNCcy: Finished\n"));

	return iRet;

maccyget_error:
DEBUGLOG(("maccyget_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}

int GetBankPspByMerchNCcyNGrp( const char* csChannel,
                        const char* csMerchantId,
                        const char* csServiceCode,
                        const char* csCountry,
			const char* csCcy,
			const char* csCustomerGroup,
			const char* csIpRegionCode,
			const int   iRestrictedIP,
			const double dAmt,
			recordset_t* myRec)
{
	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO maccygrpget_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	v_psp_id[PD_PSP_ID_LEN];
		varchar	v_client_id[PD_CLIENT_ID_LEN];
		varchar v_ccy[PD_CCY_ID_LEN];
		varchar	v_bank[PD_BANK_CODE_LEN];
		double	v_remaining_limit;
		int	v_credit_option;
		int	v_debit_option;

		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];
		varchar	hv_channel[PD_CHANNEL_CODE_LEN];
		varchar	hv_txn_country[PD_COUNTRY_LEN];
		varchar	hv_txn_ccy[PD_CCY_ID_LEN];
		varchar	hv_customer_group[PD_CUSTOMER_GROUP_CODE_LEN];
		varchar hv_ip_region_code[PD_COUNTRY_LEN];
		double	hv_amount;
		int	hv_restricted_ip;

		short	hv_return_value;

		short	ind_psp_id = -1;
		short	ind_client_id = -1;
		short	ind_ccy = -1;
		short	ind_bank= -1;
		short	ind_remaining_limit = -1;
		short	ind_credit_option = -1;
		short	ind_debit_option = -1;

		short	ind_merchant_id = -1;
		short	ind_service_code = -1;
		short	ind_channel = -1;
		short	ind_txn_country = -1;
		short	ind_txn_ccy = -1;
		short	ind_customer_group = -1;
		short	ind_ip_region_code = -1;
		short	ind_amount = -1;
		short	ind_restricted_ip = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* channel */
	hv_channel.len = strlen(csChannel);
	memcpy(hv_channel.arr,csChannel,hv_channel.len);
	ind_channel = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: channel = [%.*s]\n",hv_channel.len,hv_channel.arr));

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/* txn_country */
	hv_txn_country.len = strlen(csCountry);
	memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
	ind_txn_country = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));

/* txn_ccy */
	hv_txn_ccy.len = strlen(csCcy);
	memcpy(hv_txn_ccy.arr,csCcy,hv_txn_ccy.len);
	ind_txn_ccy = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));

/* ip_region_code */
        hv_ip_region_code.len = strlen(csIpRegionCode);
        memcpy(hv_ip_region_code.arr,csIpRegionCode,hv_ip_region_code.len);
        ind_ip_region_code = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: ip_region_code = [%.*s]\n",hv_ip_region_code.len,hv_ip_region_code.arr));

/* amount*/
	hv_amount = dAmt;
	ind_amount = 0;

/* restricted_ip */
	hv_restricted_ip = iRestrictedIP;
	ind_restricted_ip  = 0;

/* customer_group */
	if(csCustomerGroup!=NULL){
		hv_customer_group.len = strlen(csCustomerGroup);
		memcpy(hv_customer_group.arr,csCustomerGroup,hv_customer_group.len);
		ind_customer_group = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: customer_group = [%.*s]\n",hv_customer_group.len,hv_customer_group.arr));
	}


/*
	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rule_lb_mcgrp_get_pspbank( :hv_merchant_id:ind_merchant_id,
									     :hv_txn_ccy:ind_txn_ccy,
									     :hv_customer_group:ind_customer_group,
									     :hv_amount:ind_amount,
									     :c_cursor_id);
                END;
        END-EXEC;

*/

	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_mcgrp_cardtype_get( :hv_merchant_id:ind_merchant_id,
									     :hv_channel:ind_channel,
									     :hv_service_code:ind_service_code,
									     :hv_txn_country:ind_txn_country,
									     :hv_txn_ccy:ind_txn_ccy,
									     :hv_customer_group:ind_customer_group,
									     :hv_ip_region_code:ind_ip_region_code,
									     :hv_restricted_ip:ind_restricted_ip,
									     :hv_amount:ind_amount,
									     :c_cursor_id);
                END;
        END-EXEC;


	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_psp_id = -1;
			ind_client_id = -1;
			ind_ccy = -1;
			ind_bank = -1;
			ind_remaining_limit = -1;
			ind_credit_option = -1;
			ind_debit_option = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_bank:ind_bank,
				:v_client_id:ind_client_id,
				:v_psp_id:ind_psp_id,
				:v_ccy:ind_ccy,
				:v_remaining_limit:ind_remaining_limit,
				:v_credit_option:ind_credit_option,
				:v_debit_option:ind_debit_option;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_bank >= 0) {
				v_bank.arr[v_bank.len] = '\0';
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: [%03d]bank = [%s]\n",iCnt,v_bank.arr));
				PutField_CString(myHash,"bank_code",(const char*)v_bank.arr);
			}

			if (ind_psp_id >= 0) {
				v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: [%03d]psp_id = [%s]\n",iCnt,v_psp_id.arr));
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
			}

			if (ind_client_id >= 0) {
				v_client_id.arr[v_client_id.len] = '\0';
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: [%03d]client_id = [%s]\n",iCnt,v_client_id.arr));
				PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}
	
			if (ind_remaining_limit>= 0) {
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: [%03d]remaining_limit = [%lf]\n",iCnt,v_remaining_limit));
				PutField_Double(myHash,"remaining_limit",v_remaining_limit);
			}

			if (ind_credit_option>= 0) {
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: [%03d]credit_option = [%d]\n",iCnt,v_credit_option));
				PutField_Int(myHash,"credit_option",v_credit_option);
			}

			if (ind_debit_option>= 0) {
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: [%03d]debit_option = [%d]\n",iCnt,v_debit_option));
				PutField_Int(myHash,"debit_option",v_debit_option);
			}

/*
			if (ind_scheduler_id>= 0) {
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: [%03d]scheduler_id = [%d]\n",iCnt,v_scheduler_id));
				PutField_Int(myHash,"scheduler_id",v_scheduler_id);
			}

			if (ind_note_id>= 0) {
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: [%03d]note_id = [%d]\n",iCnt,v_note_id));
				PutField_Int(myHash,"note_id",v_note_id);
			}
*/
			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("GetBankPspByMerchNCcyNGrp: Finished\n"));

	return iRet;

maccygrpget_error:
DEBUGLOG(("maccygrpget_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}

int GetPromoteCustomerGroup(const char* csMerchantId,
                     const char* csServiceCode,
                     const char* csCcy,
                     const char* csBankCode,
                     const char* csFromGroup,
                     hash_t * hTxn)
{
	int iRet = PD_OK;
	int iCnt = 0;
	char csTag[PD_TAG_LEN+1];

        EXEC SQL WHENEVER SQLERROR GOTO getpmgrp_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];
		varchar hv_ccy[PD_CCY_ID_LEN];
		varchar hv_bank_code[PD_BANK_CODE_LEN];
		varchar	hv_from_group[PD_CUSTOMER_GROUP_CODE_LEN];

		varchar	v_group[PD_CUSTOMER_GROUP_CODE_LEN+1];

		short	hv_return_value;

		short	ind_merchant_id = -1;
		short	ind_service_code = -1;
		short	ind_ccy = -1;
		short	ind_bank_code  = -1;
		short	ind_from_group = -1;

		short	ind_group = -1;

		SQL_CURSOR      c_cursor_id;
        EXEC SQL END DECLARE SECTION;

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetPromoteCustomerGroup: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetPromoteCustomerGroup: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/*ccy*/
	hv_ccy.len = strlen(csCcy);
	memcpy(hv_ccy.arr,csCcy,hv_ccy.len);
	ind_ccy = 0;
DEBUGLOG(("GetPromoteCustomerGroup: ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));

/* bank_code */
	hv_bank_code.len = strlen(csBankCode);
	memcpy(hv_bank_code.arr,csBankCode,hv_bank_code.len);
	ind_bank_code = 0;
DEBUGLOG(("GetPromoteCustomerGroup: bank_code = [%.*s]\n",hv_bank_code.len,hv_bank_code.arr));

/* from_group */
	hv_from_group.len = strlen(csFromGroup);
	memcpy(hv_from_group.arr,csFromGroup,hv_from_group.len);
	ind_from_group = 0;
DEBUGLOG(("GetPromoteCustomerGroup: from_group = [%.*s]\n",hv_from_group.len,hv_from_group.arr));


	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rule_lb_get_pm_custgrp(:hv_merchant_id:ind_merchant_id,
								  :hv_service_code:ind_service_code,
								  :hv_ccy:ind_ccy,
								  :hv_bank_code:ind_bank_code,
								  :hv_from_group:ind_from_group,
								  :c_cursor_id);
                END;
        END-EXEC;

	PutField_Int(hTxn,"group_cnt",iCnt);
	if (hv_return_value == 0 ) {
		for (;;) {
			ind_group = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	
				:v_group:ind_group;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_group>= 0) {
				v_group.arr[v_group.len] = '\0';
DEBUGLOG(("GetPromoteCustomerGroup: [%03d]group = [%s]\n",iCnt,v_group.arr));
				sprintf(csTag,"customer_group_%d",iCnt);
				PutField_CString(hTxn,csTag,(const char*)v_group.arr);
			}
	
			iCnt++;
			PutField_Int(hTxn,"group_cnt",iCnt);
		}
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("GetPromoteCustomerGroup  Failed!!!\n"));
	}

DEBUGLOG(("GetPromoteCustomerGroup: Finished iRet = [%d]\n",iRet));
	return iRet;

getpmgrp_error:
DEBUGLOG(("getpmgrp_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return PD_ERR;
}


int HaveDefineSmallAmtRule(const char* csChannel,
			   const char* csMerchantId,
			   const char* csServiceCode,
			   const char* csCountry,
			   const char* csCcy, 
			   char	cCardType,
			   const double dAmt)
{
        int iRet = PD_NOT_FOUND;

DEBUGLOG(("HaveDefineSmallAmtRule()\n"));
        EXEC SQL WHENEVER SQLERROR GOTO sarip_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];
		varchar	hv_channel[PD_CHANNEL_CODE_LEN];
		varchar	hv_txn_country[PD_COUNTRY_LEN];
                varchar hv_ccy[PD_CCY_ID_LEN];
		char	hv_card_type;
		double	hv_amt;

                int     v_count;

                short   ind_count= -1;

        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("HaveDefineSmallAmtRule: merchant_id = [%.*s][%d]\n",hv_merchant_id.len,hv_merchant_id.arr,hv_merchant_id.len));

        hv_channel.len = strlen(csChannel);
        memcpy(hv_channel.arr,csChannel,hv_channel.len);
DEBUGLOG(("HaveDefineSmallAmtRule: channel = [%.*s][%d]\n",hv_channel.len,hv_channel.arr,hv_channel.len));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("HaveDefineSmallAmtRule: service_code = [%.*s][%d]\n",hv_service_code.len,hv_service_code.arr,hv_service_code.len));

        hv_txn_country.len = strlen(csCountry);
        memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
DEBUGLOG(("HaveDefineSmallAmtRule: txn_country = [%.*s][%d]\n",hv_txn_country.len,hv_txn_country.arr,hv_txn_country.len));

        hv_ccy.len = strlen(csCcy);
        memcpy(hv_ccy.arr,csCcy,hv_ccy.len);
DEBUGLOG(("HaveDefineSmallAmtRule: ccy = [%.*s][%d]\n",hv_ccy.len,hv_ccy.arr,hv_ccy.len));

	hv_card_type = cCardType;
DEBUGLOG(("HaveDefineSmallAmtRule: card type = [%c]\n", hv_card_type));

	hv_amt = dAmt;
DEBUGLOG(("HaveDefineSmallAmtRule: amount = [%lf]\n",hv_amt));

        EXEC SQL DECLARE c_cursor_sarip CURSOR FOR
		SELECT	count(*) 
              	FROM	rule_psp_lb_criteria,
			system_parameter
		where	rc_party_id = :hv_merchant_id
		and	rc_ccy = :hv_ccy
		and	rc_channel_code = :hv_channel
		and	rc_service_code = :hv_service_code
		and	rc_country = :hv_txn_country
		and	rc_allow_special_region = 0 
		and	rc_max_transaction_amount >= :hv_amt
		and	rc_max_transaction_amount >0
		and	rc_max_transaction_amount <= sp_val
		and	rc_disabled = 0
		and	('A' = :hv_card_type  or rc_card_type_opt = :hv_card_type)
		and	sp_code = 'LB_SMALL_AMT';

        EXEC SQL OPEN c_cursor_sarip;
        do {
                EXEC SQL FETCH c_cursor_sarip
                  INTO
                        :v_count:ind_count;


                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

DEBUGLOG(("HaveDefineSmallAmtRule  found\n"));
                if (ind_count>= 0 ) {
DEBUGLOG(("HaveDefineSmallAmtRule  count = [%d]\n",v_count));
                        if (v_count>0 )  {
                                iRet = PD_FOUND;
                        }
                }
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_sarip;

DEBUGLOG(("HaveDefineSmallAmtRule iRet = [%d]\n",iRet));
        return iRet;

sarip_error:
DEBUGLOG(("sarip_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_sarip;
    return PD_ERR;
}

int GetBankPspForSARIP( const char* csChannel,
			const char* csMerchantId,
			const char* csServiceCode,
			const char* csCountry,
			const char* csCcy,
			const char* csIpRegionCode,
			const int   iRestrictedIP,
			const double dAmt,
			recordset_t* myRec)
{
	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO getsarip_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	v_psp_id[PD_PSP_ID_LEN];
		varchar	v_client_id[PD_CLIENT_ID_LEN];
		varchar v_ccy[PD_CCY_ID_LEN];
		varchar	v_bank[PD_BANK_CODE_LEN];
		double	v_remaining_limit;
		int	v_credit_option;
		int	v_debit_option;

		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];
		varchar	hv_channel[PD_CHANNEL_CODE_LEN];
		varchar	hv_txn_country[PD_COUNTRY_LEN];
		varchar	hv_txn_ccy[PD_CCY_ID_LEN];
		varchar hv_ip_region_code[PD_COUNTRY_LEN];
		double	hv_amt;
		int	hv_restricted_ip;

		short	hv_return_value;

		short	ind_psp_id = -1;
		short	ind_client_id = -1;
		short	ind_ccy = -1;
		short	ind_bank= -1;
		short	ind_remaining_limit = -1;
		short	ind_credit_option= -1;
		short	ind_debit_option= -1;

		short	ind_merchant_id = -1;
		short	ind_service_code = -1;
		short	ind_channel = -1;
		short	ind_txn_country = -1;
		short	ind_txn_ccy = -1;
		short	ind_ip_region_code = -1;
		short	ind_amt = -1;
		short	ind_restricted_ip = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;


/* channel */
	hv_channel.len = strlen(csChannel);
	memcpy(hv_channel.arr,csChannel,hv_channel.len);
	ind_channel = 0;
DEBUGLOG(("GetBankPspForSARIP: channel = [%.*s]\n",hv_channel.len,hv_channel.arr));

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetBankPspForSARIP: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetBankPspForSARIP: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/* txn_country */
	hv_txn_country.len = strlen(csCountry);
	memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
	ind_txn_country = 0;
DEBUGLOG(("GetBankPspForSARIP: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));

/* txn_ccy */
	hv_txn_ccy.len = strlen(csCcy);
	memcpy(hv_txn_ccy.arr,csCcy,hv_txn_ccy.len);
	ind_txn_ccy = 0;
DEBUGLOG(("GetBankPspForSARIP: txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));

/* ip_region_code */
        hv_ip_region_code.len = strlen(csIpRegionCode);
        memcpy(hv_ip_region_code.arr,csIpRegionCode,hv_ip_region_code.len);
        ind_ip_region_code = 0;
DEBUGLOG(("GetBankPspForSARIP: ip_region_code = [%.*s]\n",hv_ip_region_code.len,hv_ip_region_code.arr));

/*amt*/
	hv_amt = dAmt;
	ind_amt = 0;
DEBUGLOG(("GetBankPspForSARIP: amt = [%lf]\n",hv_amt));

/* restricted_ip */
	hv_restricted_ip = iRestrictedIP;
	ind_restricted_ip  = 0;

/*
	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rule_lb_sarip_get_pspbank( :hv_merchant_id:ind_merchant_id,
									     :hv_txn_ccy:ind_txn_ccy,
									     :hv_amt:ind_amt,
									     :c_cursor_id);
                END;
        END-EXEC;
*/


	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_sarip_cardtype_get( :hv_merchant_id:ind_merchant_id,
									     :hv_channel:ind_channel,
									     :hv_service_code:ind_service_code,
									     :hv_txn_country:ind_txn_country,
									     :hv_txn_ccy:ind_txn_ccy,
									     :hv_ip_region_code:ind_ip_region_code,
									     :hv_restricted_ip:ind_restricted_ip,
									     :hv_amt:ind_amt,
									     :c_cursor_id);
                END;
        END-EXEC;



	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_psp_id = -1;
			ind_client_id = -1;
			ind_ccy = -1;
			ind_bank = -1;
			ind_remaining_limit = -1;
			ind_credit_option = -1;
			ind_debit_option = -1;
			//ind_scheduler_id = -1;
			//ind_note_id = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_bank:ind_bank,
				:v_client_id:ind_client_id,
				:v_psp_id:ind_psp_id,
				:v_ccy:ind_ccy,
				:v_remaining_limit:ind_remaining_limit,
				:v_credit_option:ind_credit_option,
				:v_debit_option:ind_debit_option;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_bank >= 0) {
				v_bank.arr[v_bank.len] = '\0';
DEBUGLOG(("GetBankPspForSARIP: [%03d]bank = [%s]\n",iCnt,v_bank.arr));
				PutField_CString(myHash,"bank_code",(const char*)v_bank.arr);
			}

			if (ind_psp_id >= 0) {
				v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetBankPspForSARIP: [%03d]psp_id = [%s]\n",iCnt,v_psp_id.arr));
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
			}

			if (ind_client_id >= 0) {
				v_client_id.arr[v_client_id.len] = '\0';
DEBUGLOG(("GetBankPspForSARIP: [%03d]client_id = [%s]\n",iCnt,v_client_id.arr));
				PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetBankPspForSARIP: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}
	
			if (ind_remaining_limit>= 0) {
DEBUGLOG(("GetBankPspForSARIP: [%03d]remaining_limit = [%lf]\n",iCnt,v_remaining_limit));
				PutField_Double(myHash,"remaining_limit",v_remaining_limit);
			}

			if (ind_credit_option>= 0) {
DEBUGLOG(("GetBankPspForSARIP: [%03d]credit_option = [%d]\n",iCnt,v_credit_option));
				PutField_Int(myHash,"credit_option",v_credit_option);
			}

			if (ind_debit_option>= 0) {
DEBUGLOG(("GetBankPspForSARIP: [%03d]debit_option = [%d]\n",iCnt,v_debit_option));
				PutField_Int(myHash,"debit_option",v_debit_option);
			}

/*
			if (ind_scheduler_id>= 0) {
DEBUGLOG(("GetBankPspForSARIP: [%03d]scheduler_id = [%d]\n",iCnt,v_scheduler_id));
				PutField_Int(myHash,"scheduler_id",v_scheduler_id);
			}

			if (ind_note_id>= 0) {
DEBUGLOG(("GetBankPspForSARIP: [%03d]note_id = [%d]\n",iCnt,v_note_id));
				PutField_Int(myHash,"note_id",v_note_id);
			}
*/
			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("GetBankPspForSARIP: Finished\n"));

	return iRet;

getsarip_error:
DEBUGLOG(("getsarip_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}

int GetBankPspForPromoCustomer( const char* csChannel,
                        const char* csMerchantId,
                        const char* csServiceCode,
                        const char* csCountry,
                        const char* csCcy,
                        const char* csCustomerGroup,
			const int   iRestrictedIP,
                        const double dAmt,
                        recordset_t* myRec)
				
{
	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO newphaseget_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	v_psp_id[PD_PSP_ID_LEN];
		varchar	v_client_id[PD_CLIENT_ID_LEN];
		varchar v_ccy[PD_CCY_ID_LEN];
		varchar	v_bank[PD_BANK_CODE_LEN];
		double	v_remaining_limit;
		int	v_credit_option;
		int	v_debit_option;

		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];
		varchar	hv_channel[PD_CHANNEL_CODE_LEN];
		varchar	hv_txn_country[PD_COUNTRY_LEN];
		varchar	hv_txn_ccy[PD_CCY_ID_LEN];
		varchar	hv_customer_group[PD_CUSTOMER_GROUP_CODE_LEN];
		double	hv_amount;
		int	hv_restricted_ip;

		short	hv_return_value;

		short	ind_psp_id = -1;
		short	ind_client_id = -1;
		short	ind_ccy = -1;
		short	ind_bank= -1;
		short	ind_remaining_limit = -1;
		short	ind_credit_option= -1;
		short	ind_debit_option= -1;

		short	ind_merchant_id = -1;
		short	ind_service_code = -1;
		short	ind_channel = -1;
		short	ind_txn_country = -1;
		short	ind_txn_ccy = -1;
		short	ind_customer_group = -1;
		short	ind_amount = -1;
		short	ind_restricted_ip = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* channel */
	hv_channel.len = strlen(csChannel);
	memcpy(hv_channel.arr,csChannel,hv_channel.len);
	ind_channel = 0;
DEBUGLOG(("GetBankPspForPromoCustomer: channel = [%.*s]\n",hv_channel.len,hv_channel.arr));

// merchant_id
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetBankPspForPromoCustomer: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetBankPspForPromoCustomer: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/* txn_country */
	hv_txn_country.len = strlen(csCountry);
	memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
	ind_txn_country = 0;
DEBUGLOG(("GetBankPspForPromoCustomer: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));

// txn_ccy
	hv_txn_ccy.len = strlen(csCcy);
	memcpy(hv_txn_ccy.arr,csCcy,hv_txn_ccy.len);
	ind_txn_ccy = 0;
DEBUGLOG(("GetBankPspForPromoCustomer: txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));

/* amount*/
	hv_amount = dAmt;
	ind_amount = 0;

/* restricted_ip */
	hv_restricted_ip = iRestrictedIP;
	ind_restricted_ip  = 0;

/* customer_group */
	if(csCustomerGroup!=NULL){
		hv_customer_group.len = strlen(csCustomerGroup);
		memcpy(hv_customer_group.arr,csCustomerGroup,hv_customer_group.len);
		ind_customer_group = 0;
DEBUGLOG(("GetBankPspForPromoCustomer: customer_group = [%.*s]\n",hv_customer_group.len,hv_customer_group.arr));
	}

/*
	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rule_lb_pmcust_get_pspbank(:hv_merchant_id:ind_merchant_id,
									     :hv_txn_ccy:ind_txn_ccy,
									     :hv_customer_group:ind_customer_group,
									     :hv_amount:ind_amount,
									     :c_cursor_id);
                END;
        END-EXEC;
*/

	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_pmcust_cardtype_get(:hv_merchant_id:ind_merchant_id,
									     :hv_channel:ind_channel,
									     :hv_service_code:ind_service_code,
									     :hv_txn_country:ind_txn_country,
									     :hv_txn_ccy:ind_txn_ccy,
									     :hv_customer_group:ind_customer_group,
									     :hv_restricted_ip:ind_restricted_ip,
									     :hv_amount:ind_amount,
									     :c_cursor_id);
                END;
        END-EXEC;



	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_psp_id = -1;
			ind_client_id = -1;
			ind_ccy = -1;
			ind_bank = -1;
			ind_remaining_limit = -1;
			ind_credit_option= -1;
			ind_debit_option= -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_bank:ind_bank,
				:v_client_id:ind_client_id,
				:v_psp_id:ind_psp_id,
				:v_ccy:ind_ccy,
				:v_remaining_limit:ind_remaining_limit,
				:v_credit_option:ind_credit_option,
				:v_debit_option:ind_debit_option;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_bank >= 0) {
				v_bank.arr[v_bank.len] = '\0';
DEBUGLOG(("GetBankPspForPromoCustomer: [%03d]bank = [%s]\n",iCnt,v_bank.arr));
				PutField_CString(myHash,"bank_code",(const char*)v_bank.arr);
			}

			if (ind_psp_id >= 0) {
				v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetBankPspForPromoCustomer: [%03d]psp_id = [%s]\n",iCnt,v_psp_id.arr));
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
			}

			if (ind_client_id >= 0) {
				v_client_id.arr[v_client_id.len] = '\0';
DEBUGLOG(("GetBankPspForPromoCustomer: [%03d]client_id = [%s]\n",iCnt,v_client_id.arr));
				PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetBankPspForPromoCustomer: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}
	
			if (ind_remaining_limit>= 0) {
DEBUGLOG(("GetBankPspForPromoCustomer: [%03d]remaining_limit = [%lf]\n",iCnt,v_remaining_limit));
				PutField_Double(myHash,"remaining_limit",v_remaining_limit);
			}

			if (ind_credit_option>= 0) {
DEBUGLOG(("GetBankPspForPromoCustomer: [%03d]credit_option = [%d]\n",iCnt,v_credit_option));
				PutField_Int(myHash,"credit_option",v_credit_option);
			}

			if (ind_debit_option>= 0) {
DEBUGLOG(("GetBankPspForPromoCustomer: [%03d]debit_option = [%d]\n",iCnt,v_debit_option));
				PutField_Int(myHash,"debit_option",v_debit_option);
			}

			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("GetBankPspForPromoCustomer: Finished\n"));

	return iRet;

newphaseget_error:
DEBUGLOG(("newphaseget_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}

int GetMobileBankByMerchNCcyNGrp(const char* csChannel,
                        const char* csMerchantId,
                        const char* csServiceCode,
                        const char* csCountry,
                        const char* csCcy,
			const char* csCustomerGroup,
			const char* csUnionGroup,
			const double dAmt,
			int iIsNewCust,
			recordset_t* myRec)
{
	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO mobccygrpget_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	v_customer_grp[PD_CUSTOMER_GROUP_CODE_LEN+1];
		varchar	v_psp_id[PD_PSP_ID_LEN];
		varchar v_ccy[PD_CCY_ID_LEN];
		varchar	v_bank[PD_BANK_CODE_LEN];
		double	v_remaining_limit;
		int	v_credit_option;
		int	v_debit_option;
		int	v_is_all_child_outage;
		int	v_is_child_outage;

		varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
                varchar hv_channel[PD_CHANNEL_CODE_LEN];
                varchar hv_txn_country[PD_COUNTRY_LEN];
                varchar hv_txn_ccy[PD_CCY_ID_LEN];
		varchar	hv_customer_group[PD_CUSTOMER_GROUP_CODE_LEN];
		varchar	hv_union_group[PD_CUSTOMER_GROUP_CODE_LEN];
		double	hv_amount;
		int	hv_new_cust;

		short	hv_return_value;

		short	ind_customer_grp = -1;
		short	ind_psp_id = -1;
		short	ind_ccy = -1;
		short	ind_bank= -1;
		short	ind_remaining_limit = -1;
		short	ind_credit_option = -1;
		short	ind_debit_option = -1;
		short	ind_is_all_child_outage = -1;
		short	ind_is_child_outage = -1;

		short	ind_merchant_id = -1;
		short	ind_service_code = -1;
		short	ind_channel = -1;
		short	ind_txn_country = -1;
		short	ind_txn_ccy = -1;
		short	ind_customer_group = -1;
		short	ind_union_group = -1;
		short	ind_amount = -1;
		short	ind_new_cust = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* channel */
	hv_channel.len = strlen(csChannel);
	memcpy(hv_channel.arr,csChannel,hv_channel.len);
	ind_channel = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: channel = [%.*s]\n",hv_channel.len,hv_channel.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/* txn_country */
	hv_txn_country.len = strlen(csCountry);
	memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
	ind_txn_country = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* txn_ccy*/
	hv_txn_ccy.len = strlen(csCcy);
	memcpy(hv_txn_ccy.arr,csCcy,hv_txn_ccy.len);
	ind_txn_ccy = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));

/* amount*/
	hv_amount = dAmt;
	ind_amount = 0;

/* is new customer */
	hv_new_cust = iIsNewCust;
	ind_new_cust = 0;

/* customer_group */
	if(csCustomerGroup!=NULL){
		hv_customer_group.len = strlen(csCustomerGroup);
		memcpy(hv_customer_group.arr,csCustomerGroup,hv_customer_group.len);
		ind_customer_group = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: customer_group = [%.*s]\n",hv_customer_group.len,hv_customer_group.arr));
	}

/* union_group */
	if(csUnionGroup!=NULL){
		hv_union_group.len = strlen(csUnionGroup);
		memcpy(hv_union_group.arr,csUnionGroup,hv_union_group.len);
		ind_union_group = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: union_group = [%.*s]\n",hv_union_group.len,hv_union_group.arr));
	}

/*
	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rule_lb_mcgrp_get_mobbank( :hv_merchant_id:ind_merchant_id,
									     :hv_txn_ccy:ind_txn_ccy,
									     :hv_customer_group:ind_customer_group,
									     :hv_amount:ind_amount,
									     :c_cursor_id);
                END;
        END-EXEC;
*/

	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_mcgrp_get_mobbank( :hv_merchant_id:ind_merchant_id,
									     :hv_channel:ind_channel,
									     :hv_service_code:ind_service_code,
									     :hv_txn_country:ind_txn_country,
									     :hv_txn_ccy:ind_txn_ccy,
									     :hv_customer_group:ind_customer_group,
									     :hv_union_group:ind_union_group,
									     :hv_amount:ind_amount,
									     :hv_new_cust:ind_new_cust,
									     :c_cursor_id);
                END;
        END-EXEC;

	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_customer_grp = -1;
			ind_ccy = -1;
			ind_bank = -1;
			ind_remaining_limit = -1;
			ind_credit_option = -1;
			ind_debit_option = -1;
			ind_psp_id = -1;
			ind_is_all_child_outage = -1;
			ind_is_child_outage = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_bank:ind_bank,
				:v_is_all_child_outage:ind_is_all_child_outage,
				:v_is_child_outage:ind_is_child_outage,
				:v_customer_grp:ind_customer_grp,
				:v_ccy:ind_ccy,
				:v_psp_id:ind_psp_id,
				:v_remaining_limit:ind_remaining_limit,
				:v_credit_option:ind_credit_option,
				:v_debit_option:ind_debit_option;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_bank >= 0) {
				v_bank.arr[v_bank.len] = '\0';
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: [%03d]bank = [%s]\n",iCnt,v_bank.arr));
				PutField_CString(myHash,"bank_code",(const char*)v_bank.arr);
			}

			if (ind_is_all_child_outage >= 0) {
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: [%03d]is_all_child_outage = [%d]\n",iCnt,v_is_all_child_outage));
				PutField_Int(myHash,"is_all_child_outage",v_is_all_child_outage);
			}

			if (ind_is_child_outage >= 0) {
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: [%03d]is_child_outage = [%d]\n",iCnt,v_is_child_outage));
				PutField_Int(myHash,"is_child_outage",v_is_child_outage);
			}

			if (ind_customer_grp>= 0) {
				v_customer_grp.arr[v_customer_grp.len] = '\0';
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: [%03d]customer_grp = [%s]\n",iCnt,v_customer_grp.arr));
				PutField_CString(myHash,"customer_grp",(const char*)v_customer_grp.arr);
			}

			if (ind_psp_id >= 0) {
				v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: [%03d]psp_id = [%s]\n",iCnt,v_psp_id.arr));
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}
	
			if (ind_remaining_limit>= 0) {
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: [%03d]remaining_limit = [%lf]\n",iCnt,v_remaining_limit));
				PutField_Double(myHash,"remaining_limit",v_remaining_limit);
			}

			if (ind_credit_option>= 0) {
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: [%03d]credit_option = [%d]\n",iCnt,v_credit_option));
				PutField_Int(myHash,"credit_option",v_credit_option);
			}

			if (ind_debit_option>= 0) {
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: [%03d]debit_option = [%d]\n",iCnt,v_debit_option));
				PutField_Int(myHash,"debit_option",v_debit_option);
			}

			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrp: Finished\n"));

	return iRet;

mobccygrpget_error:
DEBUGLOG(("mobccygrpget_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}


int GetMobileBankDefault(const char* csChannel,
                        const char* csMerchantId,
                        const char* csServiceCode,
                        const char* csCountry,
                        const char* csCcy,
			const double dAmt,
			recordset_t* myRec)
{
	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO mobdefaultget_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;


		varchar	v_customer_grp[PD_CUSTOMER_GROUP_CODE_LEN+1];
		varchar	v_psp_id[PD_PSP_ID_LEN];
		varchar v_ccy[PD_CCY_ID_LEN];
		varchar	v_bank[PD_BANK_CODE_LEN];
		double	v_remaining_limit;
		int	v_credit_option;
		int	v_debit_option;
		int	v_is_all_child_outage;
		int	v_is_child_outage;

		varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
                varchar hv_channel[PD_CHANNEL_CODE_LEN];
                varchar hv_txn_country[PD_COUNTRY_LEN];
                varchar hv_txn_ccy[PD_CCY_ID_LEN];
		double	hv_amount;

		short	hv_return_value;


		short	ind_customer_grp = -1;
		short	ind_psp_id = -1;
		short	ind_ccy = -1;
		short	ind_bank= -1;
		short	ind_remaining_limit = -1;
		short	ind_credit_option = -1;
		short	ind_debit_option = -1;
		short	ind_is_all_child_outage = -1;
		short	ind_is_child_outage = -1;

		short	ind_merchant_id = -1;
		short	ind_service_code = -1;
		short	ind_channel = -1;
		short	ind_txn_country = -1;
		short	ind_txn_ccy = -1;
		short	ind_amount = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* channel */
	hv_channel.len = strlen(csChannel);
	memcpy(hv_channel.arr,csChannel,hv_channel.len);
	ind_channel = 0;
DEBUGLOG(("GetMobileBankDefault: channel = [%.*s]\n",hv_channel.len,hv_channel.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetMobileBankDefault: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/* txn_country */
	hv_txn_country.len = strlen(csCountry);
	memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
	ind_txn_country = 0;
DEBUGLOG(("GetMobileBankDefault: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetMobileBankDefault: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* txn_ccy*/
	hv_txn_ccy.len = strlen(csCcy);
	memcpy(hv_txn_ccy.arr,csCcy,hv_txn_ccy.len);
	ind_txn_ccy = 0;
DEBUGLOG(("GetMobileBankDefault: txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));

/* amount*/
	hv_amount = dAmt;
	ind_amount = 0;

	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_def_get_mobbank( :hv_merchant_id:ind_merchant_id,
								       :hv_channel:ind_channel,
								       :hv_service_code:ind_service_code,
								       :hv_txn_country:ind_txn_country,
								       :hv_txn_ccy:ind_txn_ccy,
								       :hv_amount:ind_amount,
								       :c_cursor_id);
                END;
        END-EXEC;

	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_customer_grp = -1;
			ind_ccy = -1;
			ind_bank = -1;
			ind_remaining_limit = -1;
			ind_credit_option = -1;
			ind_debit_option = -1;
			ind_psp_id = -1;
			ind_is_all_child_outage = -1;
			ind_is_child_outage = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_bank:ind_bank,
				:v_is_all_child_outage:ind_is_all_child_outage,
				:v_is_child_outage:ind_is_child_outage,
				:v_customer_grp:ind_customer_grp,
				:v_ccy:ind_ccy,
				:v_psp_id:ind_psp_id,
				:v_remaining_limit:ind_remaining_limit,
				:v_credit_option:ind_credit_option,
				:v_debit_option:ind_debit_option;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_bank >= 0) {
				v_bank.arr[v_bank.len] = '\0';
DEBUGLOG(("GetMobileBankDefault: [%03d]bank = [%s]\n",iCnt,v_bank.arr));
				PutField_CString(myHash,"bank_code",(const char*)v_bank.arr);
			}

			if (ind_is_all_child_outage >= 0) {
DEBUGLOG(("GetMobileBankDefault: [%03d]is_all_child_outage = [%d]\n",iCnt,v_is_all_child_outage));
				PutField_Int(myHash,"is_all_child_outage",v_is_all_child_outage);
			}

			if (ind_is_child_outage >= 0) {
DEBUGLOG(("GetMobileBankDefault: [%03d]is_child_outage = [%d]\n",iCnt,v_is_child_outage));
				PutField_Int(myHash,"is_child_outage",v_is_child_outage);
			}

			if (ind_customer_grp>= 0) {
				v_customer_grp.arr[v_customer_grp.len] = '\0';
DEBUGLOG(("GetMobileBankDefault: [%03d]customer_grp = [%s]\n",iCnt,v_customer_grp.arr));
				PutField_CString(myHash,"customer_grp",(const char*)v_customer_grp.arr);
			}

			if (ind_psp_id >= 0) {
				v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetMobileBankDefault: [%03d]psp_id = [%s]\n",iCnt,v_psp_id.arr));
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetMobileBankDefault: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}
	
			if (ind_remaining_limit>= 0) {
DEBUGLOG(("GetMobileBankDefault: [%03d]remaining_limit = [%lf]\n",iCnt,v_remaining_limit));
				PutField_Double(myHash,"remaining_limit",v_remaining_limit);
			}

			if (ind_credit_option>= 0) {
DEBUGLOG(("GetMobileBankDefault: [%03d]credit_option = [%d]\n",iCnt,v_credit_option));
				PutField_Int(myHash,"credit_option",v_credit_option);
			}

			if (ind_debit_option>= 0) {
DEBUGLOG(("GetMobileBankDefault: [%03d]debit_option = [%d]\n",iCnt,v_debit_option));
				PutField_Int(myHash,"debit_option",v_debit_option);
			}

			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("GetMobileBankDefault: Finished\n"));

	return iRet;

mobdefaultget_error:
DEBUGLOG(("mobdefaultget_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}

int GetRemainCapForMobSegment(const char* csMerchantId,const char* csGroup, const double dAmt, double *dRemain)
{
        int iRet = PD_OK;
	*dRemain = 0.0;

DEBUGLOG(("GetRemainCapForMobSegment()\n"));
        EXEC SQL WHENEVER SQLERROR GOTO remain_mob_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar hv_group[PD_CUSTOMER_GROUP_CODE_LEN];
		double	hv_amt;

                double	v_remain;

                short   ind_remain = -1;

        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("GetRemainCapForMobSegment: merchant_id = [%.*s][%d]\n",hv_merchant_id.len,hv_merchant_id.arr,hv_merchant_id.len));

        hv_group.len = strlen(csGroup);
        memcpy(hv_group.arr,csGroup,hv_group.len);
DEBUGLOG(("GetRemainCapForMobSegment: group = [%.*s][%d]\n",hv_group.len,hv_group.arr,hv_group.len));

	hv_amt = dAmt;
DEBUGLOG(("GetRemainCapForMobSegment: amount = [%lf]\n",hv_amt));

        EXEC SQL 
		select	sum(remaining_limit)
		into	:v_remain:ind_remain
		from	PSP_LIMIT_MERCHANT_VIEW
		where	merchant_id = :hv_merchant_id
		and	customer_segment = :hv_group
		AND	min_transaction_amount <= :hv_amt
		and	((max_transaction_amount >= :hv_amt 
				and max_transaction_amount> 0) 
			or max_transaction_amount = 0)
		and	remaining_limit >= :hv_amt;


	if (ind_remain>= 0 ) {
		*dRemain = v_remain;
DEBUGLOG(("GetRemainCapForMobSegment remain capacity = [%lf]\n",v_remain));
	}

DEBUGLOG(("GetRemainCapForMobSegment iRet = [%d]\n",iRet));
        return iRet;

remain_mob_error:
DEBUGLOG(("remain_mob_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return PD_ERR;
}



int GetBankPspByOtherMerch( const char* csChannel,
                        const char* csMerchantId,
                        const char* csServiceCode,
                        const char* csCountry,
			const char* csCcy,
			const int   iRestrictedIP,
			const double dAmt,
			recordset_t* myRec)
{
	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO othermerchget_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	v_psp_id[PD_PSP_ID_LEN];
		varchar	v_client_id[PD_CLIENT_ID_LEN];
		varchar v_ccy[PD_CCY_ID_LEN];
		varchar	v_bank[PD_BANK_CODE_LEN];
		double	v_remaining_limit;
		int	v_credit_option;
		int	v_debit_option;

		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];
		varchar	hv_channel[PD_CHANNEL_CODE_LEN];
		varchar	hv_txn_country[PD_COUNTRY_LEN];
		varchar	hv_txn_ccy[PD_CCY_ID_LEN];
		double	hv_amount;
		int	hv_restricted_ip;

		short	hv_return_value;

		short	ind_psp_id = -1;
		short	ind_client_id = -1;
		short	ind_ccy = -1;
		short	ind_bank= -1;
		short	ind_remaining_limit = -1;
		short	ind_credit_option = -1;
		short	ind_debit_option = -1;

		short	ind_merchant_id = -1;
		short	ind_service_code = -1;
		short	ind_channel = -1;
		short	ind_txn_country = -1;
		short	ind_txn_ccy = -1;
		short	ind_amount = -1;
		short	ind_restricted_ip = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* channel */
	hv_channel.len = strlen(csChannel);
	memcpy(hv_channel.arr,csChannel,hv_channel.len);
	ind_channel = 0;
DEBUGLOG(("GetBankPspByOtherMerch: channel = [%.*s]\n",hv_channel.len,hv_channel.arr));

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetBankPspByOtherMerch: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetBankPspByOtherMerch: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/* txn_country */
	hv_txn_country.len = strlen(csCountry);
	memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
	ind_txn_country = 0;
DEBUGLOG(("GetBankPspByOtherMerch: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));


/* txn_ccy*/
	hv_txn_ccy.len = strlen(csCcy);
	memcpy(hv_txn_ccy.arr,csCcy,hv_txn_ccy.len);
	ind_txn_ccy = 0;
DEBUGLOG(("GetBankPspByOtherMerch: txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));

/* amount*/
	hv_amount = dAmt;
	ind_amount = 0;

/* restricted_ip */
	hv_restricted_ip = iRestrictedIP;
	ind_restricted_ip  = 0;


	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_mccy_cardtype_get( :hv_merchant_id:ind_merchant_id,
									     :hv_channel:ind_channel,
									     :hv_service_code:ind_service_code,
									     :hv_txn_country:ind_txn_country,
									     :hv_txn_ccy:ind_txn_ccy,
									     :hv_restricted_ip:ind_restricted_ip,
									     :hv_amount:ind_amount,
									     :c_cursor_id);
                END;
        END-EXEC;


	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_psp_id = -1;
			ind_client_id = -1;
			ind_ccy = -1;
			ind_bank = -1;
			ind_remaining_limit = -1;
			ind_credit_option = -1;
			ind_debit_option = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_bank:ind_bank,
				:v_client_id:ind_client_id,
				:v_psp_id:ind_psp_id,
				:v_ccy:ind_ccy,
				:v_remaining_limit:ind_remaining_limit,
				:v_credit_option:ind_credit_option,
				:v_debit_option:ind_debit_option;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_bank >= 0) {
				v_bank.arr[v_bank.len] = '\0';
DEBUGLOG(("GetBankPspByOtherMerch: [%03d]bank = [%s]\n",iCnt,v_bank.arr));
				PutField_CString(myHash,"bank_code",(const char*)v_bank.arr);
			}

			if (ind_psp_id >= 0) {
				v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetBankPspByOtherMerch: [%03d]psp_id = [%s]\n",iCnt,v_psp_id.arr));
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
			}

			if (ind_client_id >= 0) {
				v_client_id.arr[v_client_id.len] = '\0';
DEBUGLOG(("GetBankPspByOtherMerch: [%03d]client_id = [%s]\n",iCnt,v_client_id.arr));
				PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetBankPspByOtherMerch: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}
	
			if (ind_remaining_limit>= 0) {
DEBUGLOG(("GetBankPspByOtherMerch: [%03d]remaining_limit = [%lf]\n",iCnt,v_remaining_limit));
				PutField_Double(myHash,"remaining_limit",v_remaining_limit);
			}

			if (ind_credit_option>= 0) {
DEBUGLOG(("GetBankPspByOtherMerch: [%03d]credit_option = [%d]\n",iCnt,v_credit_option));
				PutField_Int(myHash,"credit_option",v_credit_option);
			}

			if (ind_debit_option>= 0) {
DEBUGLOG(("GetBankPspByOtherMerch: [%03d]debit_option = [%d]\n",iCnt,v_debit_option));
				PutField_Int(myHash,"debit_option",v_debit_option);
			}

			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("GetBankPspByOtherMerch: Finished\n"));

	return iRet;

othermerchget_error:
DEBUGLOG(("othermerchget_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}




int HaveDefineRestrictedIPRule(const char* csChannel,
			   const char* csMerchantId,
			   const char* csServiceCode,
			   const char* csCountry,
			   const char* csCcy, 
			   char	cCardType)
{
        int iRet = PD_NOT_FOUND;

DEBUGLOG(("HaveDefineRestrictedIPRule()\n"));
        EXEC SQL WHENEVER SQLERROR GOTO riprule_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];
		varchar	hv_channel[PD_CHANNEL_CODE_LEN];
		varchar	hv_txn_country[PD_COUNTRY_LEN];
                varchar hv_ccy[PD_CCY_ID_LEN];
		char	hv_card_type;

                int     v_count;

                short   ind_count= -1;

        EXEC SQL END DECLARE SECTION;

        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
DEBUGLOG(("HaveDefineRestrictedIPRule: merchant_id = [%.*s][%d]\n",hv_merchant_id.len,hv_merchant_id.arr,hv_merchant_id.len));

        hv_channel.len = strlen(csChannel);
        memcpy(hv_channel.arr,csChannel,hv_channel.len);
DEBUGLOG(("HaveDefineRestrictedIPRule: channel = [%.*s][%d]\n",hv_channel.len,hv_channel.arr,hv_channel.len));

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("HaveDefineRestrictedIPRule: service_code = [%.*s][%d]\n",hv_service_code.len,hv_service_code.arr,hv_service_code.len));

        hv_txn_country.len = strlen(csCountry);
        memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
DEBUGLOG(("HaveDefineRestrictedIPRule: txn_country = [%.*s][%d]\n",hv_txn_country.len,hv_txn_country.arr,hv_txn_country.len));

        hv_ccy.len = strlen(csCcy);
        memcpy(hv_ccy.arr,csCcy,hv_ccy.len);
DEBUGLOG(("HaveDefineRestrictedIPRule: ccy = [%.*s][%d]\n",hv_ccy.len,hv_ccy.arr,hv_ccy.len));

	hv_card_type = cCardType;
DEBUGLOG(("HaveDefineRestrictedIPRule: card type = [%c]\n", hv_card_type));

        EXEC SQL DECLARE c_cursor_riprule CURSOR FOR
		SELECT	count(*) 
              	FROM	rule_psp_lb_criteria
		where	rc_party_id = :hv_merchant_id
		and	rc_ccy = :hv_ccy
		and	rc_channel_code = :hv_channel
		and	rc_service_code = :hv_service_code
		and	rc_country = :hv_txn_country
		and	rc_allow_special_region = 1 
		and	rc_disabled = 0
		and	('A' = :hv_card_type  or rc_card_type_opt = :hv_card_type);

        EXEC SQL OPEN c_cursor_riprule;
        do {
                EXEC SQL FETCH c_cursor_riprule
                  INTO
                        :v_count:ind_count;


                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

DEBUGLOG(("HaveDefineRestrictedIPRule  found\n"));
                if (ind_count>= 0 ) {
DEBUGLOG(("HaveDefineRestrictedIPRule  count = [%d]\n",v_count));
                        if (v_count>0 )  {
                                iRet = PD_FOUND;
                        }
                }
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_riprule;

DEBUGLOG(("HaveDefineRestrictedIPRule iRet = [%d]\n",iRet));
        return iRet;

riprule_error:
DEBUGLOG(("riprule_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_riprule;
    return PD_ERR;
}


int FindPotentialPool(hash_t *hIn,
		      recordset_t* myRec)
{

        int     iCnt = 0;
	int	iTmp = 0;
	double	dTmp = 0.0;
	char	*csTmp = NULL;
        hash_t  *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO potentialpool_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                int     hv_id;
                varchar	hv_bank_code[PD_BANK_CODE_LEN];
		double	hv_amt;

                int     v_pool_id;
                varchar v_desc[PD_DESC_LEN +1];
                double  v_pool_limit;
                int     v_ratio;
                int     v_priority;

                short   ind_pool_id = -1;
                short   ind_desc = -1;
                short   ind_pool_limit = -1;
                short   ind_ratio = -1;
                short   ind_priority = -1;

        EXEC SQL END DECLARE SECTION;

	if(GetField_Int(hIn, "criteria_pool_id", &iTmp)){
        	hv_id = iTmp;
DEBUGLOG(("FindPotentialPool: Scheme ID = [%d]\n",hv_id));
	}

	if(GetField_CString(hIn, "bank_code", &csTmp)){
        	hv_bank_code.len = strlen(csTmp);
		memcpy(hv_bank_code.arr,csTmp,hv_bank_code.len);
DEBUGLOG(("FindPotentialPool: Bank Code = [%.*s]\n",hv_bank_code.len,hv_bank_code.arr));
	}

	if(GetField_Double(hIn, "psp_amt", &dTmp)){
        	hv_amt = dTmp;
DEBUGLOG(("FindPotentialPool: PSP Amount = [%lf]\n",hv_amt));
	}

        EXEC SQL DECLARE c_cursor_potentialpool CURSOR FOR
	   SELECT
		    pool_id,
		    pool_desc,
		    pool_limit,
		    pool_ratio,
		    pool_priority
	   FROM
                (SELECT pool_id,
			pool_desc,
			pool_limit,
			pool_ratio,
			pool_priority,
			pool_pid,pid_limit,approved_amt pid_approved_amt
                  FROM ( select pool_id,
				pool_desc,
				pool_limit,
				pool_ratio,
				pool_priority,
				pool_pid,pid_limit,approved_amt,
				sum(request_amt) OVER (PARTITION BY pool_id) pool_request_amt,
				sum(approved_amt) OVER (PARTITION BY pool_id) pool_approved_amt
			 from rule_lb_scheme_detail_view
			 where scheme_id = :hv_id
			 and int_bank_code = :hv_bank_code
		       )
		  where (pool_approved_amt + :hv_amt <= pool_limit
			  or pool_limit = 0))
	   WHERE pid_approved_amt + :hv_amt <= pid_limit
	   group by pool_id,
		    pool_desc,
		    pool_limit,
		    pool_ratio,
		    pool_priority
	   order by pool_priority desc, pool_ratio desc; 

        EXEC SQL OPEN c_cursor_potentialpool;
        do {
                EXEC SQL FETCH c_cursor_potentialpool
                INTO
                        :v_pool_id:ind_pool_id,
                        :v_desc:ind_desc,
                        :v_pool_limit:ind_pool_limit,
                        :v_ratio:ind_ratio,
                        :v_priority:ind_priority;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
                iCnt++;
                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/* pool_id */
                if (ind_pool_id >= 0) {
DEBUGLOG(("FindPotentialPool: pool_id = [%d]\n",v_pool_id));
                        PutField_Int(myHash,"pool_id",v_pool_id);
                }
/* desc */
                if (ind_desc >= 0 ) {
                        v_desc.arr[v_desc.len] = '\0';
DEBUGLOG(("FindPotentialPool: desc = [%s]\n",(char*)v_desc.arr));
                        PutField_CString(myHash,"desc",(char*)v_desc.arr);
                }


/* pool limit */
                if (ind_pool_limit >= 0) {
DEBUGLOG(("FindPotentialPool: pool_limit = [%lf]\n",v_pool_limit));
                        PutField_Double(myHash,"pool_limit",v_pool_limit);
                }

/* ratio */
                if (ind_ratio >= 0) {
DEBUGLOG(("FindPotentialPool: ratio = [%d]\n",v_ratio));
                        PutField_Int(myHash,"ratio",v_ratio);
                }
/* priority */
                if (ind_priority >= 0) {
DEBUGLOG(("FindPotentialPool: priority = [%d]\n",v_priority));
                        PutField_Int(myHash,"priority",v_priority);
                }
                RecordSet_Add(myRec,myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_potentialpool;

        if (iCnt > 0 ) {
DEBUGLOG(("FindPotentialPool Normal Exit\n"));
                return  PD_FOUND;
        }
        else {
DEBUGLOG(("FindPotentialPool Normal Exit, Not Found\n"));
                return PD_NOT_FOUND;
        }

potentialpool_error:
DEBUGLOG(("potentialpool_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_potentialpool;
    return PD_NOT_FOUND;
}


int FindPoolDetail(hash_t *hIn,
		      hash_t *hOut)
{

        int     iCnt = 0;
	int	iTmp = 0;

        EXEC SQL WHENEVER SQLERROR GOTO pooldt_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                int     hv_id;
                int     hv_pool_id;

                int     v_pool_id;
                int     v_ratio;
                int     v_priority;
                double  v_req_amt;
                double  v_total_req_amt;
                double  v_app_amt;
                double  v_total_app_amt;

                short   ind_pool_id = -1;
                short   ind_ratio = -1;
                short   ind_priority = -1;
                short   ind_req_amt = -1;
                short   ind_total_req_amt = -1;
                short   ind_app_amt = -1;
                short   ind_total_app_amt = -1;

        EXEC SQL END DECLARE SECTION;

	if(GetField_Int(hIn, "criteria_pool_id", &iTmp)){
        	hv_id = iTmp;
DEBUGLOG(("FindPoolDetail: Scheme ID = [%d]\n",hv_id));
	}

	if(GetField_Int(hIn, "pool_id", &iTmp)){
        	hv_pool_id = iTmp;
DEBUGLOG(("FindPoolDetail: Pool ID = [%d]\n",hv_pool_id));
	}


        EXEC SQL DECLARE c_cursor_pooldt CURSOR FOR
                SELECT  pool_id,
			pool_ratio,
			pool_priority,
			pool_request_amt,
			pool_total_request_amt,
			pool_approved_amt,
			pool_total_approved_amt
                  FROM ( select pool_id,
				pool_ratio,
				pool_priority,
				sum(request_amt) OVER (PARTITION BY pool_id) pool_request_amt,
				sum(total_request_amt) OVER (PARTITION BY pool_id) pool_total_request_amt,
				sum(approved_amt) OVER (PARTITION BY pool_id) pool_approved_amt,
				sum(total_approved_amt) OVER (PARTITION BY pool_id) pool_total_approved_amt
			 from rule_lb_scheme_detail_view
			 where scheme_id = :hv_id
			 and pool_id= :hv_pool_id
			 group by pool_id,
				  pool_ratio,
				  pool_priority,
				  pool_pid,
				  approved_amt,
				  total_approved_amt,
				  request_amt,
				  total_request_amt
		  	  ) 
		  group by pool_id,
			   pool_ratio,
			   pool_priority,
			   pool_approved_amt,
			   pool_total_approved_amt,
			   pool_request_amt,
			   pool_total_request_amt;
		   

        EXEC SQL OPEN c_cursor_pooldt;
        do {
                EXEC SQL FETCH c_cursor_pooldt
                INTO
                        :v_pool_id:ind_pool_id,
                        :v_ratio:ind_ratio,
                        :v_priority:ind_priority,
			:v_req_amt:ind_req_amt,
			:v_total_req_amt:ind_total_req_amt,
			:v_app_amt:ind_app_amt,
			:v_total_app_amt:ind_total_app_amt;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
                iCnt++;
/* pool_id */
                if (ind_pool_id >= 0) {
DEBUGLOG(("FindPoolDetail: pool_id = [%d]\n",v_pool_id));
                        PutField_Int(hOut,"pool_id",v_pool_id);
                }
/* ratio */
                if (ind_ratio >= 0) {
DEBUGLOG(("FindPoolDetail: ratio = [%d]\n",v_ratio));
                        PutField_Int(hOut,"ratio",v_ratio);
                }
/* priority */
                if (ind_priority >= 0) {
DEBUGLOG(("FindPoolDetail: priority = [%d]\n",v_priority));
                        PutField_Int(hOut,"priority",v_priority);
                }

		if(ind_req_amt >= 0){
DEBUGLOG(("FindPoolDetail: req_amt = [%lf]\n",v_req_amt));
                        PutField_Double(hOut,"req_amt",v_req_amt);
		}

		if(ind_total_req_amt >= 0){
DEBUGLOG(("FindPoolDetail: total_req_amt = [%lf]\n",v_total_req_amt));
                        PutField_Double(hOut,"total_req_amt",v_total_req_amt);
		}

		if(ind_app_amt >= 0){
DEBUGLOG(("FindPoolDetail: app_amt = [%lf]\n",v_app_amt));
                        PutField_Double(hOut,"app_amt",v_app_amt);
		}

		if(ind_total_app_amt >= 0){
DEBUGLOG(("FindPoolDetail: total_app_amt = [%lf]\n",v_total_app_amt));
                        PutField_Double(hOut,"total_app_amt",v_total_app_amt);
		}
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_pooldt;

        if (iCnt > 0 ) {
DEBUGLOG(("FindPoolDetail Normal Exit\n"));
                return  PD_FOUND;
        }
        else {
DEBUGLOG(("FindPoolDetail Normal Exit, Not Found\n"));
                return PD_NOT_FOUND;
        }

pooldt_error:
DEBUGLOG(("pooldt_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_pooldt;
    return PD_NOT_FOUND;
}




int FindPoolPspDetail(hash_t *hIn,
		      recordset_t* myRec)
{

        int     iCnt = 0;
	int	iTmp = 0;
	double	dTmp = 0.0;
	char	*csTmp = NULL;
        hash_t  *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO poolpspdt_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                int     hv_id;
                int     hv_pool_id;
                varchar	hv_bank_code[PD_BANK_CODE_LEN];
		double	hv_amt;

                int     v_pool_id;
                varchar v_psp_id[PD_PSP_ID_LEN +1];
                int     v_ratio;
                int     v_priority;
                double  v_req_amt;
                double  v_pool_req_amt;
                varchar v_client[PD_CLIENT_ID_LEN +1];
                int     v_rej_delta_amt;

		short   ind_pool_id = -1;
                short   ind_psp_id = -1;
                short   ind_ratio = -1;
                short   ind_priority = -1;
                short   ind_req_amt = -1;
                short   ind_pool_req_amt = -1;
                short   ind_client = -1;
                short   ind_rej_delta_amt = -1;

        EXEC SQL END DECLARE SECTION;

	if(GetField_Int(hIn, "criteria_pool_id", &iTmp)){
        	hv_id = iTmp;
DEBUGLOG(("FindPoolPspDetail: Scheme ID = [%d]\n",hv_id));
	}

	if(GetField_Int(hIn, "pool_id", &iTmp)){
        	hv_pool_id = iTmp;
DEBUGLOG(("FindPoolPspDetail: Pool ID = [%d]\n",hv_pool_id));
	}

	if(GetField_CString(hIn, "bank_code", &csTmp)){
        	hv_bank_code.len = strlen(csTmp);
		memcpy(hv_bank_code.arr,csTmp,hv_bank_code.len);
DEBUGLOG(("FindPoolPspDetail: Bank Code = [%s]\n",hv_bank_code.arr));
	}

	if(GetField_Double(hIn, "psp_amt", &dTmp)){
        	hv_amt = dTmp;
DEBUGLOG(("FindPoolPspDetail: PSP Amount = [%lf]\n",hv_amt));
	}
	
	EXEC SQL DECLARE c_cursor_poolpspdt CURSOR FOR
                SELECT  pool_id,
                        pool_pid,
                        pool_pid_ratio,
                        pool_pid_priority,
                        request_amt,
                        sum(request_amt) OVER (PARTITION BY pool_id) pool_request_amt,
                        CLIENT_ID,
                        REJ_SMALL_DELTA_AMT
                from rule_lb_scheme_detail_view,psp_detail
                where scheme_id = :hv_id
                and   pool_id = :hv_pool_id
                and   int_bank_code = :hv_bank_code
                and   approved_amt + :hv_amt <= pid_limit
                and   pool_pid = psp_id
                and   ((deposit_card_type = card_type_opt) or deposit_card_type = 'A')
                order by pool_pid_priority desc, pool_pid_ratio desc;

        EXEC SQL OPEN c_cursor_poolpspdt;
	do {
                EXEC SQL FETCH c_cursor_poolpspdt
                INTO
                        :v_pool_id:ind_pool_id,
                        :v_psp_id:ind_psp_id,
                        :v_ratio:ind_ratio,
                        :v_priority:ind_priority,
                        :v_req_amt:ind_req_amt,
                        :v_pool_req_amt:ind_pool_req_amt,
                        :v_client:ind_client,
                        :v_rej_delta_amt:ind_rej_delta_amt;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
                iCnt++;
                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/* pool_id */
                if (ind_pool_id >= 0) {
DEBUGLOG(("FindPoolPspDetail: pool_id = [%d]\n",v_pool_id));
                        PutField_Int(myHash,"pool_id",v_pool_id);
                }

/* psp_id */
                if (ind_psp_id >= 0 ) {
                        v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("FindPoolPspDetail: psp_id = [%s]\n",(char*)v_psp_id.arr));
                        PutField_CString(myHash,"psp_id",(char*)v_psp_id.arr);
                }

/* client */
                if (ind_client >= 0 ) {
                        v_client.arr[v_client.len] = '\0';
DEBUGLOG(("FindPoolPspDetail: client = [%s]\n",(char*)v_client.arr));
                        PutField_CString(myHash,"client",(char*)v_client.arr);
                }

/* rej_delta_amt */
                if (ind_rej_delta_amt >= 0) {
DEBUGLOG(("FindPoolPspDetail: rej_delta_amt = [%d]\n",v_rej_delta_amt));
                        PutField_Int(myHash,"rej_delta_amt",v_rej_delta_amt);
                }

/* ratio */
                if (ind_ratio >= 0) {
DEBUGLOG(("FindPoolPspDetail: ratio = [%d]\n",v_ratio));
                        PutField_Int(myHash,"psp_ratio",v_ratio);
                }

/* priority */
                if (ind_priority >= 0) {
DEBUGLOG(("FindPoolPspDetail: priority = [%d]\n",v_priority));
                        PutField_Int(myHash,"psp_priority",v_priority);
                }

/* req_amt */
                if (ind_req_amt >= 0) {
DEBUGLOG(("FindPoolPspDetail: req_amt = [%lf]\n",v_req_amt));
                        PutField_Double(myHash,"req_amt",v_req_amt);
                }

/* pool_req_amt */
                if (ind_pool_req_amt >= 0) {
DEBUGLOG(("FindPoolPspDetail: pool_req_amt = [%lf]\n",v_pool_req_amt));
                        PutField_Double(myHash,"pool_req_amt",v_pool_req_amt);
                }

                RecordSet_Add(myRec,myHash);
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_poolpspdt;

        if (iCnt > 0 ) {
DEBUGLOG(("FindPoolPspDetail Normal Exit\n"));
                return  PD_FOUND;
        }
        else {
DEBUGLOG(("FindPoolPspDetail Normal Exit, Not Found\n"));
                return PD_NOT_FOUND;
        }

poolpspdt_error:
DEBUGLOG(("poolpspdt_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_poolpspdt;
    return PD_NOT_FOUND;
}



int MatchCriteria_Mode(const hash_t *hRec,
			recordset_t* myRec)
{

	int iRet = PD_NOT_FOUND;
	int	iCnt = 0;
	char	*csPtr;
	char	cPtr;
	int	iPtr = 0;
	double	dPtr = 0.0;
	char	*csMode = NULL;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO match_mode_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		short	hv_return_value = -1;
		varchar	hv_channel_code[PD_CHANNEL_CODE_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];
		varchar	hv_txn_country[PD_COUNTRY_LEN];
		varchar	hv_txn_ccy[PD_CCY_ID_LEN];
		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_customer_tag[PD_CUSTOMER_TAG_LEN];
		int	hv_sarip;
		int	hv_restricted_ip;
		char	hv_card_type;
		double	hv_amount;

		double  v_min_txn_amount;
		double  v_max_txn_amount;
		int	v_criteria_pool_id;
		int	v_scheduler_id;
		int	v_priority;
		
		short	ind_channel_code = -1;
		short	ind_service_code = -1;
		short	ind_txn_country = -1;
		short	ind_txn_ccy = -1;
		short	ind_merchant_id = -1;
		short	ind_customer_tag = -1;
		short	ind_sarip = -1;
		short	ind_restricted_ip = -1;
		short	ind_card_type = -1;
		short	ind_amount = -1;

		short	ind_min_txn_amount = -1;
		short	ind_max_txn_amount = -1;
		short	ind_pool_id = -1;
		short	ind_scheduler_id = -1;
		short	ind_priority = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* match_mode */
	if (GetField_CString(hRec,"match_mode",&csMode)) {
DEBUGLOG(("MatchCriteria_Mode: mode = [%s]\n",csMode));
        }

/* channel code */
	if (GetField_CString(hRec,"channel_code",&csPtr)) {
		hv_channel_code.len = strlen(csPtr);
		memcpy(hv_channel_code.arr,csPtr,hv_channel_code.len);
		ind_channel_code = 0;
DEBUGLOG(("MatchCriteria_Mode: channel_code = [%.*s]\n",hv_channel_code.len,hv_channel_code.arr));
	}
	else {
DEBUGLOG(("MatchCriteria_Mode: channel_code is missing!!!\n"));
	}

/* service code */
	if (GetField_CString(hRec,"service_code",&csPtr)) {
		hv_service_code.len = strlen(csPtr);
		memcpy(hv_service_code.arr,csPtr,hv_service_code.len);
		ind_service_code = 0;
DEBUGLOG(("MatchCriteria_Mode: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));
	}
	else {
DEBUGLOG(("MatchCriteria_Mode: service_code is missing!!!\n"));
	}

/*txn_country */
	if (GetField_CString(hRec,"txn_country",&csPtr)) {
		hv_txn_country.len = strlen(csPtr);
		memcpy(hv_txn_country.arr,csPtr,hv_txn_country.len);
		ind_txn_country = 0;
DEBUGLOG(("MatchCriteria_Mode: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));
	}
	else {
DEBUGLOG(("MatchCriteria_Mode: txn_country is missing!!!\n"));
	}

/*txn_ccy */
	if (GetField_CString(hRec,"txn_ccy",&csPtr)) {
		hv_txn_ccy.len = strlen(csPtr);
		memcpy(hv_txn_ccy.arr,csPtr,hv_txn_ccy.len);
		ind_txn_ccy = 0;
DEBUGLOG(("MatchCriteria_Mode: txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));
	}
	else {
DEBUGLOG(("MatchCriteria_Mode: txn_ccy is missing!!!\n"));
	}


/*merchant_id */
	if (GetField_CString(hRec,"merchant_id",&csPtr)) {
		hv_merchant_id.len = strlen(csPtr);
		memcpy(hv_merchant_id.arr,csPtr,hv_merchant_id.len);
		ind_merchant_id = 0;
DEBUGLOG(("MatchCriteria_Mode: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));
	}
	else {
DEBUGLOG(("MatchCriteria_Mode: merchant_id is missing!!!\n"));
	}

/*customer_tag */
	if (GetField_CString(hRec,"customer_segment",&csPtr)) {
		hv_customer_tag.len = strlen(csPtr);
		memcpy(hv_customer_tag.arr,csPtr,hv_customer_tag.len);
		ind_customer_tag = 0;
DEBUGLOG(("MatchCriteria_Mode: customer_tag = [%.*s]\n",hv_customer_tag.len,hv_customer_tag.arr));
	}

/*sarip*/
	if(!strcmp(csMode,PD_MODE_MOBILE_SEGMENT_NEW)){
        	if (GetField_Int(hRec,"sarip",&iPtr)) {
                	hv_sarip = iPtr;
                	ind_sarip = 0;
DEBUGLOG(("MatchCriteria_Mode: sarip = [%d]\n",hv_sarip));
        	}
		else {
DEBUGLOG(("MatchCriteria_Mode: sarip is missing!!!\n"));
		}
	}

/*restricted_ip*/
	if (GetField_Int(hRec,"restricted_ip",&iPtr)) {
		hv_restricted_ip = iPtr;
		ind_restricted_ip = 0;
DEBUGLOG(("MatchCriteria_Mode: restricted_ip = [%d]\n",hv_restricted_ip));
	}
	else {
DEBUGLOG(("MatchCriteria_Mode: restricted_ip is missing!!!\n"));
	}

/*card_type*/
	if (GetField_Char(hRec,"card_type",&cPtr)) {
		hv_card_type = cPtr;
		ind_card_type = 0;
DEBUGLOG(("MatchCriteria_Mode: card_type = [%c]\n",hv_card_type));
	}
	else {
DEBUGLOG(("MatchCriteria_Mode:  is missing!!!\n"));
	}

/* amount */
	if (GetField_Double(hRec,"txn_amt",&dPtr)) {
		hv_amount = dPtr;
		ind_amount = 0;
DEBUGLOG(("MatchCriteria_Mode: amount = [%lf]\n",hv_amount));
	}
	else {
DEBUGLOG(("MatchCriteria_Mode: amount is missing!!!\n"));
	}

	EXEC SQL ALLOCATE       :c_cursor_id;


	if(!strcmp(csMode,PD_MODE_SARIP)){
            EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_match_sarip(:hv_channel_code:ind_channel_code,
								:hv_service_code:ind_service_code,
								:hv_txn_country:ind_txn_country,
								:hv_txn_ccy:ind_txn_ccy,
								:hv_merchant_id:ind_merchant_id,
								:hv_card_type:ind_card_type,
								:hv_restricted_ip:ind_restricted_ip,
								:hv_amount:ind_amount,
								:c_cursor_id);
                END;
            END-EXEC;
	}
	else if(!strcmp(csMode,PD_MODE_SEGMENT_MERCH)){
            EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_match_mcgrp(:hv_channel_code:ind_channel_code,
								:hv_service_code:ind_service_code,
								:hv_txn_country:ind_txn_country,
								:hv_txn_ccy:ind_txn_ccy,
								:hv_merchant_id:ind_merchant_id,
								:hv_customer_tag:ind_customer_tag,
								:hv_card_type:ind_card_type,
								:hv_restricted_ip:ind_restricted_ip,
								:hv_amount:ind_amount,
								:c_cursor_id);
                END;
            END-EXEC;

	}
	else if(!strcmp(csMode,PD_MODE_OTHER_MERCH)){
            EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_match_mccy(:hv_channel_code:ind_channel_code,
								:hv_service_code:ind_service_code,
								:hv_txn_country:ind_txn_country,
								:hv_txn_ccy:ind_txn_ccy,
								:hv_merchant_id:ind_merchant_id,
								:hv_card_type:ind_card_type,
								:hv_restricted_ip:ind_restricted_ip,
								:hv_amount:ind_amount,
								:c_cursor_id);
                END;
            END-EXEC;

	}
	else if(!strcmp(csMode,PD_MODE_MOBILE_SEGMENT_NEW)){
            EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_match_mobgrpnew(:hv_channel_code:ind_channel_code,
                                                                :hv_service_code:ind_service_code,
                                                                :hv_txn_country:ind_txn_country,
                                                                :hv_txn_ccy:ind_txn_ccy,
                                                                :hv_merchant_id:ind_merchant_id,
                                                                :hv_customer_tag:ind_customer_tag,
                                                                :hv_card_type:ind_card_type,
                                                                :hv_sarip:ind_sarip,
                                                                :hv_restricted_ip:ind_restricted_ip,
                                                                :hv_amount:ind_amount,
                                                                :c_cursor_id);
                END;
            END-EXEC;

        }


	if (hv_return_value > 0 ) {
DEBUGLOG(("MatchCriteria_Mode: Found!\n"));
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_min_txn_amount = -1;
			ind_max_txn_amount = -1;
			ind_pool_id = -1;
			ind_scheduler_id = -1;
			ind_priority = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_min_txn_amount:ind_min_txn_amount,
				:v_max_txn_amount:ind_max_txn_amount,
				:v_criteria_pool_id:ind_pool_id,
				:v_scheduler_id:ind_scheduler_id,
				:v_priority:ind_priority;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_min_txn_amount >= 0) {
DEBUGLOG(("MatchCriteria_Mode: [%03d]min_txn_amount = [%lf]\n",iCnt,v_min_txn_amount));
				PutField_Double(myHash,"min_txn_amount",v_min_txn_amount);
			}
			if (ind_max_txn_amount >= 0) {
DEBUGLOG(("MatchCriteria_Mode: [%03d]max_txn_amount = [%lf]\n",iCnt,v_max_txn_amount));
				PutField_Double(myHash,"max_txn_amount",v_max_txn_amount);
			}
	
			if (ind_pool_id >= 0) {
DEBUGLOG(("MatchCriteria_Mode: [%03d]criteria_pool_id = [%d]\n",iCnt,v_criteria_pool_id));
				PutField_Int(myHash,"criteria_pool_id",v_criteria_pool_id);
			}
			if (ind_scheduler_id >= 0) {
DEBUGLOG(("MatchCriteria_Mode: [%03d]scheduler_id = [%d]\n",iCnt,v_scheduler_id));
				PutField_Int(myHash,"scheduler_id",v_scheduler_id);
			}

			if (ind_priority >= 0) {
DEBUGLOG(("MatchCriteria_Mode: [%03d]priority = [%d]\n",iCnt,v_priority));
				PutField_Int(myHash,"priority",v_priority);
			}

			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
		EXEC SQL CLOSE :c_cursor_id;
		EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("MatchCriteria_Mode: exit with ok\n"));
		return PD_FOUND;
	}
	else {
		EXEC SQL CLOSE :c_cursor_id;
		EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("MatchCriteria_Mode: exit with error\n"));
		return PD_NOT_FOUND;
	}


	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("RET = [%d]\n",iRet));
	return iRet;

match_mode_error:
DEBUGLOG(("match_mode_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_NOT_FOUND;
}


int GetCustomerGroup_CardType(const char* csChannel,
		     const char* csMerchantId,
                     const char* csServiceCode,
		     const char* csCountry,
                     const char* csCcy,
		     char cCardType,
		     const double dAmt,
                     const char* csBankCode,
                     hash_t * hTxn)
{
	int iRet = PD_OK;
	int iCnt = 0;
	char csTag[PD_TAG_LEN+1];

        EXEC SQL WHENEVER SQLERROR GOTO getgrp_card_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	hv_channel[PD_CHANNEL_CODE_LEN];
		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];
		varchar	hv_txn_country[PD_COUNTRY_LEN];
		varchar hv_ccy[PD_CCY_ID_LEN];
		varchar hv_bank_code[PD_BANK_CODE_LEN];
		char	hv_card_type;
		double	hv_amount;

		varchar	v_group[PD_CUSTOMER_GROUP_CODE_LEN+1];

		short	hv_return_value;

		short	ind_channel = -1;
		short	ind_txn_country = -1;
		short	ind_merchant_id = -1;
		short	ind_service_code = -1;
		short	ind_ccy = -1;
		short	ind_bank_code  = -1;
		short	ind_card_type = -1;
		short	ind_amount = -1;

		short	ind_group = -1;

		SQL_CURSOR      c_cursor_id;
        EXEC SQL END DECLARE SECTION;

/* channel */
	hv_channel.len = strlen(csChannel);
	memcpy(hv_channel.arr,csChannel,hv_channel.len);
	ind_channel = 0;
DEBUGLOG(("GetCustomerGroup_CardType: channel = [%.*s]\n",hv_channel.len,hv_channel.arr));

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetCustomerGroup_CardType: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetCustomerGroup_CardType: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/* txn_country */
	hv_txn_country.len = strlen(csCountry);
	memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
	ind_txn_country = 0;
DEBUGLOG(("GetCustomerGroup_CardType: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));

/*ccy*/
	hv_ccy.len = strlen(csCcy);
	memcpy(hv_ccy.arr,csCcy,hv_ccy.len);
	ind_ccy = 0;
DEBUGLOG(("GetCustomerGroup_CardType: ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));

/* bank_code */
	hv_bank_code.len = strlen(csBankCode);
	memcpy(hv_bank_code.arr,csBankCode,hv_bank_code.len);
	ind_bank_code = 0;
DEBUGLOG(("GetCustomerGroup_CardType: bank_code = [%.*s]\n",hv_bank_code.len,hv_bank_code.arr));

	hv_card_type = cCardType;
	ind_card_type = 0;
DEBUGLOG(("GetCustomerGroup_CardType: card_type = [%c]\n",hv_card_type));

	hv_amount = dAmt;
	ind_amount = 0;
DEBUGLOG(("GetCustomerGroup_CardType: amount = [%lf]\n",hv_amount));

	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_custgrp_cardtype(:hv_merchant_id:ind_merchant_id,
								  :hv_channel:ind_channel,
								  :hv_service_code:ind_service_code,
								  :hv_txn_country:ind_txn_country,
								  :hv_ccy:ind_ccy,
								  :hv_card_type:ind_card_type,
								  :hv_amount:ind_amount,
								  :hv_bank_code:ind_bank_code,
								  :c_cursor_id);
                END;
        END-EXEC;

	PutField_Int(hTxn,"group_cnt",iCnt);
	if (hv_return_value == 0 ) {
		for (;;) {
			ind_group = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	
				:v_group:ind_group;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_group>= 0) {
				v_group.arr[v_group.len] = '\0';
DEBUGLOG(("GetCustomerGroup_CardType: [%03d]group = [%s]\n",iCnt,v_group.arr));
				sprintf(csTag,"customer_group_%d",iCnt);
				PutField_CString(hTxn,csTag,(const char*)v_group.arr);
			}
	
			iCnt++;
			PutField_Int(hTxn,"group_cnt",iCnt);
		}
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("GetCustomerGroup_CardType  Failed!!!\n"));
	}

DEBUGLOG(("GetCustomerGroup_CardType: Finished iRet = [%d]\n",iRet));
	return iRet;

getgrp_card_error:
DEBUGLOG(("getgrp_card_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return PD_ERR;
}


int GetPromoteCustomerGroup_CardType(const char* csChannel,
		     const char* csMerchantId,
                     const char* csServiceCode,
		     const char* csCountry,
                     const char* csCcy,
		     const char* csCustomerGroup,
		     char cCardType,
		     const double dAmt,
                     const char* csBankCode,
                     hash_t * hTxn)
{
	int iRet = PD_OK;
	int iCnt = 0;
	char csTag[PD_TAG_LEN+1];

        EXEC SQL WHENEVER SQLERROR GOTO getpmgrp_card_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	hv_channel[PD_CHANNEL_CODE_LEN];
		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];
		varchar	hv_txn_country[PD_COUNTRY_LEN];
		varchar hv_ccy[PD_CCY_ID_LEN];
		varchar	hv_customer_group[PD_CUSTOMER_GROUP_CODE_LEN];
		varchar hv_bank_code[PD_BANK_CODE_LEN];
		char	hv_card_type;
		double	hv_amount;

		varchar	v_group[PD_CUSTOMER_GROUP_CODE_LEN+1];

		short	hv_return_value;

		short	ind_channel = -1;
		short	ind_txn_country = -1;
		short	ind_merchant_id = -1;
		short	ind_service_code = -1;
		short	ind_ccy = -1;
		short	ind_bank_code  = -1;
		short	ind_card_type = -1;
		short	ind_customer_group = -1;
		short	ind_amount = -1;

		short	ind_group = -1;

		SQL_CURSOR      c_cursor_id;
        EXEC SQL END DECLARE SECTION;

/* channel */
	hv_channel.len = strlen(csChannel);
	memcpy(hv_channel.arr,csChannel,hv_channel.len);
	ind_channel = 0;
DEBUGLOG(("GetPromoteCustomerGroup_CardType: channel = [%.*s]\n",hv_channel.len,hv_channel.arr));

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetPromoteCustomerGroup_CardType: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetPromoteCustomerGroup_CardType: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/* txn_country */
	hv_txn_country.len = strlen(csCountry);
	memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
	ind_txn_country = 0;
DEBUGLOG(("GetPromoteCustomerGroup_CardType: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));

/*ccy*/
	hv_ccy.len = strlen(csCcy);
	memcpy(hv_ccy.arr,csCcy,hv_ccy.len);
	ind_ccy = 0;
DEBUGLOG(("GetPromoteCustomerGroup_CardType: ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));

/* customer_group */
	hv_customer_group.len = strlen(csCustomerGroup);
	memcpy(hv_customer_group.arr,csCustomerGroup,hv_customer_group.len);
	ind_customer_group = 0;
DEBUGLOG(("GetPromoteCustomerGroup_CardType: customer_group = [%.*s]\n",hv_customer_group.len,hv_customer_group.arr));

/* bank_code */
	hv_bank_code.len = strlen(csBankCode);
	memcpy(hv_bank_code.arr,csBankCode,hv_bank_code.len);
	ind_bank_code = 0;
DEBUGLOG(("GetPromoteCustomerGroup_CardType: bank_code = [%.*s]\n",hv_bank_code.len,hv_bank_code.arr));

	hv_card_type = cCardType;
	ind_card_type = 0;
DEBUGLOG(("GetPromoteCustomerGroup_CardType: card_type = [%c]\n",hv_card_type));

	hv_amount = dAmt;
	ind_amount = 0;
DEBUGLOG(("GetPromoteCustomerGroup_CardType: amount = [%lf]\n",hv_amount));

	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_pm_custgrp_cardtype(:hv_merchant_id:ind_merchant_id,
								  :hv_channel:ind_channel,
								  :hv_service_code:ind_service_code,
								  :hv_txn_country:ind_txn_country,
								  :hv_ccy:ind_ccy,
								  :hv_customer_group:ind_customer_group,
								  :hv_card_type:ind_card_type,
								  :hv_amount:ind_amount,
								  :hv_bank_code:ind_bank_code,
								  :c_cursor_id);
                END;
        END-EXEC;

	PutField_Int(hTxn,"group_cnt",iCnt);
	if (hv_return_value == 0 ) {
		for (;;) {
			ind_group = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	
				:v_group:ind_group;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_group>= 0) {
				v_group.arr[v_group.len] = '\0';
DEBUGLOG(("GetPromoteCustomerGroup_CardType: [%03d]group = [%s]\n",iCnt,v_group.arr));
				sprintf(csTag,"customer_group_%d",iCnt);
				PutField_CString(hTxn,csTag,(const char*)v_group.arr);
			}
	
			iCnt++;
			PutField_Int(hTxn,"group_cnt",iCnt);
		}
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("GetPromoteCustomerGroup_CardType  Failed!!!\n"));
	}

DEBUGLOG(("GetPromoteCustomerGroup_CardType: Finished iRet = [%d]\n",iRet));
	return iRet;

getpmgrp_card_error:
DEBUGLOG(("getpmgrp_card_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return PD_ERR;
}




int FindRuleWithoutVirtualPID(const char* csChannel,
		     const char* csMerchantId,
                     const char* csServiceCode,
		     const char* csCountry,
                     const char* csCcy,
		     const char* csCustomerGroup,
		     char cCardType,
		     const double dAmt,
                     hash_t * hTxn)
{
	int iRet = PD_OK;
	int iCnt = 0;
	char csTag[PD_TAG_LEN+1];

        EXEC SQL WHENEVER SQLERROR GOTO rule_wo_vrtpid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	hv_channel[PD_CHANNEL_CODE_LEN];
		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];
		varchar	hv_txn_country[PD_COUNTRY_LEN];
		varchar hv_ccy[PD_CCY_ID_LEN];
		varchar	hv_customer_group[PD_CUSTOMER_GROUP_CODE_LEN];
		char	hv_card_type;
		double	hv_amount;

		varchar	v_group[PD_CUSTOMER_GROUP_CODE_LEN+1];

		short	hv_return_value;

		short	ind_channel = -1;
		short	ind_txn_country = -1;
		short	ind_merchant_id = -1;
		short	ind_service_code = -1;
		short	ind_ccy = -1;
		short	ind_card_type = -1;
		short	ind_customer_group = -1;
		short	ind_amount = -1;

		short	ind_group = -1;

		SQL_CURSOR      c_cursor_id;
        EXEC SQL END DECLARE SECTION;

/* channel */
	hv_channel.len = strlen(csChannel);
	memcpy(hv_channel.arr,csChannel,hv_channel.len);
	ind_channel = 0;
DEBUGLOG(("FindRuleWithoutVirtualPID: channel = [%.*s]\n",hv_channel.len,hv_channel.arr));

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("FindRuleWithoutVirtualPID: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("FindRuleWithoutVirtualPID: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/* txn_country */
	hv_txn_country.len = strlen(csCountry);
	memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
	ind_txn_country = 0;
DEBUGLOG(("FindRuleWithoutVirtualPID: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));

/*ccy*/
	hv_ccy.len = strlen(csCcy);
	memcpy(hv_ccy.arr,csCcy,hv_ccy.len);
	ind_ccy = 0;
DEBUGLOG(("FindRuleWithoutVirtualPID: ccy = [%.*s]\n",hv_ccy.len,hv_ccy.arr));

/* customer_group */
	hv_customer_group.len = strlen(csCustomerGroup);
	memcpy(hv_customer_group.arr,csCustomerGroup,hv_customer_group.len);
	ind_customer_group = 0;
DEBUGLOG(("FindRuleWithoutVirtualPID: customer_group = [%.*s]\n",hv_customer_group.len,hv_customer_group.arr));

	hv_card_type = cCardType;
	ind_card_type = 0;
DEBUGLOG(("FindRuleWithoutVirtualPID: card_type = [%c]\n",hv_card_type));

	hv_amount = dAmt;
	ind_amount = 0;
DEBUGLOG(("FindRuleWithoutVirtualPID: amount = [%lf]\n",hv_amount));


	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_without_virtualpid(:hv_merchant_id:ind_merchant_id,
								  :hv_channel:ind_channel,
								  :hv_service_code:ind_service_code,
								  :hv_txn_country:ind_txn_country,
								  :hv_ccy:ind_ccy,
								  :hv_customer_group:ind_customer_group,
								  :hv_card_type:ind_card_type,
								  :hv_amount:ind_amount,
								  :c_cursor_id);
                END;
        END-EXEC;

	PutField_Int(hTxn,"group_cnt",iCnt);
	if (hv_return_value == 0 ) {
		for (;;) {
			ind_group = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	
				:v_group:ind_group;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_group>= 0) {
				v_group.arr[v_group.len] = '\0';
DEBUGLOG(("FindRuleWithoutVirtualPID: [%03d]group = [%s]\n",iCnt,v_group.arr));
				sprintf(csTag,"customer_group_%d",iCnt);
				PutField_CString(hTxn,csTag,(const char*)v_group.arr);
			}
	
			iCnt++;
			PutField_Int(hTxn,"group_cnt",iCnt);
		}
	}
	else{
		iRet = PD_ERR;
DEBUGLOG(("FindRuleWithoutVirtualPID  Failed!!!\n"));
	}

DEBUGLOG(("FindRuleWithoutVirtualPID: Finished iRet = [%d]\n",iRet));
	return iRet;

rule_wo_vrtpid_error:
DEBUGLOG(("rule_wo_vrtpid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return PD_ERR;
}


int GetNGBankDefault(const char* csChannel,
                        const char* csMerchantId,
                        const char* csServiceCode,
                        const char* csCountry,
                        const char* csCcy,
			const char* csIpRegionCode,
			char cDeviceType,
			const double dAmt,
			recordset_t* myRec)
{
	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO ngdefaultget_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;


		varchar	v_customer_grp[PD_CUSTOMER_GROUP_CODE_LEN+1];
		varchar	v_psp_id[PD_PSP_ID_LEN];
		varchar v_ccy[PD_CCY_ID_LEN];
		varchar	v_bank_group[PD_BANK_CODE_LEN];
		varchar	v_bank[PD_BANK_CODE_LEN];
		varchar	v_select_bank[PD_BANK_CODE_LEN];
		double	v_remaining_limit;
		int	v_credit_option;
		int	v_debit_option;
		int	v_is_all_child_outage;
		int	v_is_child_outage;

		varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
                varchar hv_channel[PD_CHANNEL_CODE_LEN];
                varchar hv_txn_country[PD_COUNTRY_LEN];
                varchar hv_txn_ccy[PD_CCY_ID_LEN];
                varchar hv_ip_region_code[PD_COUNTRY_LEN];
		char	hv_device_type;	
		double	hv_amount;

		short	hv_return_value;


		short	ind_customer_grp = -1;
		short	ind_psp_id = -1;
		short	ind_ccy = -1;
		short	ind_bank_group= -1;
		short	ind_bank= -1;
		short	ind_select_bank = -1;
		short	ind_remaining_limit = -1;
		short	ind_credit_option = -1;
		short	ind_debit_option = -1;
		short	ind_is_all_child_outage = -1;
		short	ind_is_child_outage = -1;

		short	ind_merchant_id = -1;
		short	ind_service_code = -1;
		short	ind_channel = -1;
		short	ind_txn_country = -1;
		short	ind_txn_ccy = -1;
		short	ind_ip_region_code = -1;
		short	ind_device_type = -1;
		short	ind_amount = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* channel */
	hv_channel.len = strlen(csChannel);
	memcpy(hv_channel.arr,csChannel,hv_channel.len);
	ind_channel = 0;
DEBUGLOG(("GetNGBankDefault: channel = [%.*s]\n",hv_channel.len,hv_channel.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetNGBankDefault: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/* txn_country */
	hv_txn_country.len = strlen(csCountry);
	memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
	ind_txn_country = 0;
DEBUGLOG(("GetNGBankDefault: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetNGBankDefault: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* txn_ccy*/
	hv_txn_ccy.len = strlen(csCcy);
	memcpy(hv_txn_ccy.arr,csCcy,hv_txn_ccy.len);
	ind_txn_ccy = 0;
DEBUGLOG(("GetNGBankDefault: txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));

/* ip_region_code*/
        hv_ip_region_code.len = strlen(csIpRegionCode);
        memcpy(hv_ip_region_code.arr,csIpRegionCode,hv_ip_region_code.len);
        ind_ip_region_code = 0;
DEBUGLOG(("GetNGBankDefault: ip_region_code = [%.*s]\n",hv_ip_region_code.len,hv_ip_region_code.arr));

/* device_type */
	hv_device_type = cDeviceType;
        ind_device_type = 0;
DEBUGLOG(("GetNGBankDefault: device_type = [%c]\n",hv_device_type));

/* amount*/
	hv_amount = dAmt;
	ind_amount = 0;

	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_def_get_ngbank( :hv_merchant_id:ind_merchant_id,
								       :hv_channel:ind_channel,
								       :hv_service_code:ind_service_code,
								       :hv_txn_country:ind_txn_country,
								       :hv_txn_ccy:ind_txn_ccy,
								       :hv_ip_region_code:ind_ip_region_code,
								       :hv_device_type:ind_device_type,
								       :hv_amount:ind_amount,
								       :c_cursor_id);
                END;
        END-EXEC;

	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_customer_grp = -1;
			ind_ccy = -1;
			ind_bank_group = -1;
			ind_bank = -1;
			ind_select_bank = -1;
			ind_remaining_limit = -1;
			ind_credit_option = -1;
			ind_debit_option = -1;
			ind_psp_id = -1;
			ind_is_all_child_outage = -1;
			ind_is_child_outage = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_bank_group:ind_bank_group,
				:v_bank:ind_bank,
				:v_select_bank:ind_select_bank,
				:v_is_all_child_outage:ind_is_all_child_outage,
				:v_is_child_outage:ind_is_child_outage,
				:v_customer_grp:ind_customer_grp,
				:v_ccy:ind_ccy,
				:v_psp_id:ind_psp_id,
				:v_remaining_limit:ind_remaining_limit,
				:v_credit_option:ind_credit_option,
				:v_debit_option:ind_debit_option;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}
			
			if (ind_bank_group >= 0) {
                                v_bank_group.arr[v_bank_group.len] = '\0';
DEBUGLOG(("GetNGBankDefault: [%03d]bank_group = [%s]\n",iCnt,v_bank_group.arr));
                                PutField_CString(myHash,"bank_group",(const char*)v_bank_group.arr);
                        }

			if (ind_bank >= 0) {
				v_bank.arr[v_bank.len] = '\0';
DEBUGLOG(("GetNGBankDefault: [%03d]bank = [%s]\n",iCnt,v_bank.arr));
				//PutField_CString(myHash,"bank_code",(const char*)v_bank.arr);
			}

			if (ind_select_bank >= 0) {
                                v_select_bank.arr[v_select_bank.len] = '\0';
DEBUGLOG(("GetNGBankDefault: [%03d]select_bank = [%s]\n",iCnt,v_select_bank.arr));
                                PutField_CString(myHash,"bank_code",(const char*)v_select_bank.arr);
                        }

			if (ind_is_all_child_outage >= 0) {
DEBUGLOG(("GetNGBankDefault: [%03d]is_all_child_outage = [%d]\n",iCnt,v_is_all_child_outage));
				PutField_Int(myHash,"is_all_child_outage",v_is_all_child_outage);
			}

			if (ind_is_child_outage >= 0) {
DEBUGLOG(("GetNGBankDefault: [%03d]is_child_outage = [%d]\n",iCnt,v_is_child_outage));
				PutField_Int(myHash,"is_child_outage",v_is_child_outage);
			}

			if (ind_customer_grp>= 0) {
				v_customer_grp.arr[v_customer_grp.len] = '\0';
DEBUGLOG(("GetNGBankDefault: [%03d]customer_grp = [%s]\n",iCnt,v_customer_grp.arr));
				PutField_CString(myHash,"customer_grp",(const char*)v_customer_grp.arr);
			}

			if (ind_psp_id >= 0) {
				v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetNGBankDefault: [%03d]psp_id = [%s]\n",iCnt,v_psp_id.arr));
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetNGBankDefault: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}
	
			if (ind_remaining_limit>= 0) {
DEBUGLOG(("GetNGBankDefault: [%03d]remaining_limit = [%lf]\n",iCnt,v_remaining_limit));
				PutField_Double(myHash,"remaining_limit",v_remaining_limit);
			}

			if (ind_credit_option>= 0) {
DEBUGLOG(("GetNGBankDefault: [%03d]credit_option = [%d]\n",iCnt,v_credit_option));
				PutField_Int(myHash,"credit_option",v_credit_option);
			}

			if (ind_debit_option>= 0) {
DEBUGLOG(("GetNGBankDefault: [%03d]debit_option = [%d]\n",iCnt,v_debit_option));
				PutField_Int(myHash,"debit_option",v_debit_option);
			}

			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("GetNGBankDefault: Finished\n"));

	return iRet;

ngdefaultget_error:
DEBUGLOG(("ngdefaultget_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}


int GetBankPspByOtherMerchDefault(const char* csOptionBank,
                        const char* csChannel,
                        const char* csMerchantId,
                        const char* csServiceCode,
                        const char* csCountry,
                        const char* csCcy,
			const char* csIpRegionCode,
                        char  cDeviceType,
                        const int   iRestrictedIP,
                        const double dAmt,
                        recordset_t* myRec)
{
        int iRet = PD_OK;
        int     iCnt = 0;

        hash_t  *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO othermerchdefget_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                varchar v_psp_id[PD_PSP_ID_LEN];
                varchar v_client_id[PD_CLIENT_ID_LEN];
                varchar v_ccy[PD_CCY_ID_LEN];
                varchar v_bank_group[PD_BANK_CODE_LEN];
                varchar v_bank[PD_BANK_CODE_LEN];
                double  v_remaining_limit;
                int     v_credit_option;
                int     v_debit_option;

                varchar hv_option_bank[PD_BANK_CODE_LEN];
                varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
                varchar hv_channel[PD_CHANNEL_CODE_LEN];
                varchar hv_txn_country[PD_COUNTRY_LEN];
                varchar hv_txn_ccy[PD_CCY_ID_LEN];
		varchar hv_ip_region_code[PD_COUNTRY_LEN];
                char    hv_device_type;
		double  hv_amount;
                int     hv_restricted_ip;

                short   hv_return_value;

                short   ind_psp_id = -1;
                short   ind_client_id = -1;
                short   ind_ccy = -1;
                short   ind_bank_group= -1;
                short   ind_bank= -1;
                short   ind_remaining_limit = -1;
                short   ind_credit_option = -1;
                short   ind_debit_option = -1;

                short   ind_option_bank = -1;
                short   ind_merchant_id = -1;
		short   ind_service_code = -1;
                short   ind_channel = -1;
                short   ind_txn_country = -1;
                short   ind_txn_ccy = -1;
                short   ind_ip_region_code = -1;
		short   ind_device_type = -1;
                short   ind_amount = -1;
                short   ind_restricted_ip = -1;

                SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* option_bank */
        hv_option_bank.len = strlen(csOptionBank);
        memcpy(hv_option_bank.arr,csOptionBank,hv_option_bank.len);
        ind_option_bank = 0;
DEBUGLOG(("GetBankPspByOtherMerchDefault: option_bank = [%.*s]\n",hv_option_bank.len,hv_option_bank.arr));

/* channel */
        hv_channel.len = strlen(csChannel);
        memcpy(hv_channel.arr,csChannel,hv_channel.len);
        ind_channel = 0;
DEBUGLOG(("GetBankPspByOtherMerchDefault: channel = [%.*s]\n",hv_channel.len,hv_channel.arr));

/* merchant_id */
        hv_merchant_id.len = strlen(csMerchantId);
        memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
        ind_merchant_id = 0;
DEBUGLOG(("GetBankPspByOtherMerchDefault: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* service_code */
        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
        ind_service_code = 0;
DEBUGLOG(("GetBankPspByOtherMerchDefault: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/* txn_country */
        hv_txn_country.len = strlen(csCountry);
        memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
        ind_txn_country = 0;
DEBUGLOG(("GetBankPspByOtherMerchDefault: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));

/* txn_ccy */
        hv_txn_ccy.len = strlen(csCcy);
        memcpy(hv_txn_ccy.arr,csCcy,hv_txn_ccy.len);
	ind_txn_ccy = 0;
DEBUGLOG(("GetBankPspByOtherMerchDefault: txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));

/* ip_region_code */
        hv_ip_region_code.len = strlen(csIpRegionCode);
        memcpy(hv_ip_region_code.arr,csIpRegionCode,hv_ip_region_code.len);
        ind_ip_region_code = 0;
DEBUGLOG(("GetBankPspByOtherMerchDefault: ip_region_code = [%.*s]\n",hv_ip_region_code.len,hv_ip_region_code.arr));

/* device_type */
        hv_device_type = cDeviceType;
        ind_device_type = 0;
DEBUGLOG(("GetBankPspByOtherMerchDefault: device_type = [%c]\n",hv_device_type));

/* amount*/
        hv_amount = dAmt;
        ind_amount = 0;
DEBUGLOG(("GetBankPspByOtherMerchDefault: amount = [%.2f]\n",dAmt));

/* restricted_ip */
        hv_restricted_ip = iRestrictedIP;
        ind_restricted_ip  = 0;
DEBUGLOG(("GetBankPspByOtherMerchDefault: restricted_ip = [%d]\n",iRestrictedIP));


        EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_def_cardtype_get( :hv_option_bank:ind_option_bank,
                                                                             :hv_merchant_id:ind_merchant_id,
                                                                             :hv_channel:ind_channel,
                                                                             :hv_service_code:ind_service_code,
                                                                             :hv_txn_country:ind_txn_country,
                                                                             :hv_txn_ccy:ind_txn_ccy,
                                                                             :hv_ip_region_code:ind_ip_region_code,
									     :hv_device_type:ind_device_type,
                                                                             :hv_restricted_ip:ind_restricted_ip,
                                                                             :hv_amount:ind_amount,
                                                                             :c_cursor_id);
                END;
        END-EXEC;


        if (hv_return_value == 0 ) {
                for (;;) {
                        myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);

                        ind_psp_id = -1;
                        ind_client_id = -1;
                        ind_ccy = -1;
                        ind_bank_group = -1;
                        ind_bank = -1;
                        ind_remaining_limit = -1;
                        ind_credit_option = -1;
                        ind_debit_option = -1;
		
			EXEC SQL WHENEVER NOTFOUND DO break;
                        EXEC SQL FETCH :c_cursor_id
                        INTO    :v_bank_group:ind_bank_group,
				:v_bank:ind_bank,
                                :v_client_id:ind_client_id,
                                :v_psp_id:ind_psp_id,
                                :v_ccy:ind_ccy,
                                :v_remaining_limit:ind_remaining_limit,
                                :v_credit_option:ind_credit_option,
                                :v_debit_option:ind_debit_option;

                        if (SQLCODE == SQL_NOT_FOUND) {
                                break;
                        }

			if (ind_bank_group >= 0) {
                                v_bank_group.arr[v_bank_group.len] = '\0';
DEBUGLOG(("GetBankPspByOtherMerchDefault: [%03d]bank_group = [%s]\n",iCnt,v_bank_group.arr));
                                PutField_CString(myHash,"bank_group",(const char*)v_bank_group.arr);
                        }

                        if (ind_bank >= 0) {
                                v_bank.arr[v_bank.len] = '\0';
DEBUGLOG(("GetBankPspByOtherMerchDefault: [%03d]bank = [%s]\n",iCnt,v_bank.arr));
                                PutField_CString(myHash,"bank_code",(const char*)v_bank.arr);
                        }

                        if (ind_psp_id >= 0) {
                                v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetBankPspByOtherMerchDefault: [%03d]psp_id = [%s]\n",iCnt,v_psp_id.arr));
                                PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
                        }

                        if (ind_client_id >= 0) {
                                v_client_id.arr[v_client_id.len] = '\0';
DEBUGLOG(("GetBankPspByOtherMerchDefault: [%03d]client_id = [%s]\n",iCnt,v_client_id.arr));
                                PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
                        }

                        if (ind_ccy>= 0) {
                                v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetBankPspByOtherMerchDefault: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
                                PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
                        }

                        if (ind_remaining_limit>= 0) {
DEBUGLOG(("GetBankPspByOtherMerchDefault: [%03d]remaining_limit = [%lf]\n",iCnt,v_remaining_limit));
                                PutField_Double(myHash,"remaining_limit",v_remaining_limit);
                        }

                        if (ind_credit_option>= 0) {
DEBUGLOG(("GetBankPspByOtherMerchDefault: [%03d]credit_option = [%d]\n",iCnt,v_credit_option));
                                PutField_Int(myHash,"credit_option",v_credit_option);
                        }

			if (ind_debit_option>= 0) {
DEBUGLOG(("GetBankPspByOtherMerchDefault: [%03d]debit_option = [%d]\n",iCnt,v_debit_option));
                                PutField_Int(myHash,"debit_option",v_debit_option);
                        }

                        RecordSet_Add(myRec,myHash);
                        iCnt++;
                }
        }

        EXEC SQL CLOSE :c_cursor_id;
        EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("GetBankPspByOtherMerchDefault: Finished\n"));

        return iRet;

othermerchdefget_error:
DEBUGLOG(("othermerchdefget_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}


int GetMobileBankByMerchNCcyNGrpNew(const char* csChannel,
                        const char* csMerchantId,
                        const char* csServiceCode,
                        const char* csCountry,
                        const char* csCcy,
			const char* csCustomerGroup,
			const char* csIpRegionCode,
			char cDeviceType,
			const int iSARIP,
			const int iRestrictedIP,
			const double dAmt,
			recordset_t* myRec)
{
	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO mobnewccygrpget_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;


		varchar	v_customer_grp[PD_CUSTOMER_GROUP_CODE_LEN+1];
		varchar	v_psp_id[PD_PSP_ID_LEN];
		varchar v_ccy[PD_CCY_ID_LEN];
		varchar	v_bank_group[PD_BANK_CODE_LEN];
		varchar	v_bank[PD_BANK_CODE_LEN];
		varchar	v_select_bank[PD_BANK_CODE_LEN];
		double	v_remaining_limit;
		int	v_credit_option;
		int	v_debit_option;
		int	v_is_all_child_outage;
		int	v_is_child_outage;

		varchar hv_merchant_id[PD_MERCHANT_ID_LEN];
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
                varchar hv_channel[PD_CHANNEL_CODE_LEN];
                varchar hv_txn_country[PD_COUNTRY_LEN];
                varchar hv_txn_ccy[PD_CCY_ID_LEN];
		varchar hv_customer_group[PD_CUSTOMER_GROUP_CODE_LEN];
		varchar hv_ip_region_code[PD_COUNTRY_LEN];
		char	hv_device_type;	
		int     hv_sarip;
		int     hv_restricted_ip;
		double	hv_amount;

		short	hv_return_value;


		short	ind_customer_grp = -1;
		short	ind_psp_id = -1;
		short	ind_ccy = -1;
		short	ind_bank_group= -1;
		short	ind_bank= -1;
		short	ind_select_bank = -1;
		short	ind_remaining_limit = -1;
		short	ind_credit_option = -1;
		short	ind_debit_option = -1;
		short	ind_is_all_child_outage = -1;
		short	ind_is_child_outage = -1;

		short	ind_merchant_id = -1;
		short	ind_service_code = -1;
		short	ind_channel = -1;
		short	ind_txn_country = -1;
		short	ind_txn_ccy = -1;
		short	ind_customer_group = -1;
		short	ind_ip_region_code = -1;
		short	ind_device_type = -1;
		short	ind_sarip = -1;
		short	ind_restricted_ip = -1;
		short	ind_amount = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* channel */
	hv_channel.len = strlen(csChannel);
	memcpy(hv_channel.arr,csChannel,hv_channel.len);
	ind_channel = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: channel = [%.*s]\n",hv_channel.len,hv_channel.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/* txn_country */
	hv_txn_country.len = strlen(csCountry);
	memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
	ind_txn_country = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* txn_ccy*/
	hv_txn_ccy.len = strlen(csCcy);
	memcpy(hv_txn_ccy.arr,csCcy,hv_txn_ccy.len);
	ind_txn_ccy = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));

/* customer_group */
        if(csCustomerGroup!=NULL){
                hv_customer_group.len = strlen(csCustomerGroup);
                memcpy(hv_customer_group.arr,csCustomerGroup,hv_customer_group.len);
                ind_customer_group = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: customer_group = [%.*s]\n",hv_customer_group.len,hv_customer_group.arr));
        }

/* ip_region_code*/
        hv_ip_region_code.len = strlen(csIpRegionCode);
        memcpy(hv_ip_region_code.arr,csIpRegionCode,hv_ip_region_code.len);
        ind_ip_region_code = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: ip_region_code = [%.*s]\n",hv_ip_region_code.len,hv_ip_region_code.arr));

/* device_type */
	hv_device_type = cDeviceType;
        ind_device_type = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: device_type = [%c]\n",hv_device_type));

/* sarip */
        hv_sarip = iSARIP;
        ind_sarip  = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: sarip = [%d]\n",hv_sarip));

/* restricted_ip */
        hv_restricted_ip = iRestrictedIP;
        ind_restricted_ip  = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: restricted_ip = [%d]\n",hv_restricted_ip));

/* amount*/
	hv_amount = dAmt;
	ind_amount = 0;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: amount = [%lf]\n",hv_amount));

	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_mcgrp_get_mob_new( :hv_merchant_id:ind_merchant_id,
								       :hv_channel:ind_channel,
								       :hv_service_code:ind_service_code,
								       :hv_txn_country:ind_txn_country,
								       :hv_txn_ccy:ind_txn_ccy,
								       :hv_customer_group:ind_customer_group,
								       :hv_ip_region_code:ind_ip_region_code,
								       //:hv_device_type:ind_device_type,
								       :hv_sarip:ind_sarip,
								       :hv_restricted_ip:ind_restricted_ip,
								       :hv_amount:ind_amount,
								       :c_cursor_id);
                END;
        END-EXEC;

	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_customer_grp = -1;
			ind_ccy = -1;
			ind_bank_group = -1;
			ind_bank = -1;
			ind_select_bank = -1;
			ind_remaining_limit = -1;
			ind_credit_option = -1;
			ind_debit_option = -1;
			ind_psp_id = -1;
			ind_is_all_child_outage = -1;
			ind_is_child_outage = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_bank_group:ind_bank_group,
				:v_bank:ind_bank,
				:v_select_bank:ind_select_bank,
				:v_is_all_child_outage:ind_is_all_child_outage,
				:v_is_child_outage:ind_is_child_outage,
				:v_customer_grp:ind_customer_grp,
				:v_ccy:ind_ccy,
				:v_psp_id:ind_psp_id,
				:v_remaining_limit:ind_remaining_limit,
				:v_credit_option:ind_credit_option,
				:v_debit_option:ind_debit_option;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}
			
			if (ind_bank_group >= 0) {
                                v_bank_group.arr[v_bank_group.len] = '\0';
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: [%03d]bank_group = [%s]\n",iCnt,v_bank_group.arr));
                                PutField_CString(myHash,"bank_code",(const char*)v_bank_group.arr);
                        }

			if (ind_bank >= 0) {
				v_bank.arr[v_bank.len] = '\0';
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: [%03d]bank = [%s]\n",iCnt,v_bank.arr));
				//PutField_CString(myHash,"bank_code",(const char*)v_bank.arr);
			}

			if (ind_select_bank >= 0) {
                                v_select_bank.arr[v_select_bank.len] = '\0';
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: [%03d]select_bank = [%s]\n",iCnt,v_select_bank.arr));
                                //PutField_CString(myHash,"bank_code",(const char*)v_select_bank.arr);
                        }

			if (ind_is_all_child_outage >= 0) {
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: [%03d]is_all_child_outage = [%d]\n",iCnt,v_is_all_child_outage));
				PutField_Int(myHash,"is_all_child_outage",v_is_all_child_outage);
			}

			if (ind_is_child_outage >= 0) {
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: [%03d]is_child_outage = [%d]\n",iCnt,v_is_child_outage));
				PutField_Int(myHash,"is_child_outage",v_is_child_outage);
			}

			if (ind_customer_grp>= 0) {
				v_customer_grp.arr[v_customer_grp.len] = '\0';
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: [%03d]customer_grp = [%s]\n",iCnt,v_customer_grp.arr));
				PutField_CString(myHash,"customer_grp",(const char*)v_customer_grp.arr);
			}

			if (ind_psp_id >= 0) {
				v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: [%03d]psp_id = [%s]\n",iCnt,v_psp_id.arr));
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}
	
			if (ind_remaining_limit>= 0) {
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: [%03d]remaining_limit = [%lf]\n",iCnt,v_remaining_limit));
				PutField_Double(myHash,"remaining_limit",v_remaining_limit);
			}

			if (ind_credit_option>= 0) {
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: [%03d]credit_option = [%d]\n",iCnt,v_credit_option));
				PutField_Int(myHash,"credit_option",v_credit_option);
			}

			if (ind_debit_option>= 0) {
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: [%03d]debit_option = [%d]\n",iCnt,v_debit_option));
				PutField_Int(myHash,"debit_option",v_debit_option);
			}

			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("GetMobileBankByMerchNCcyNGrpNew: Finished\n"));

	return iRet;

mobnewccygrpget_error:
DEBUGLOG(("mobnewccygrpget_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}


int GetBankPspByMerchNCcyNGrpNew( const char* csOptionBank,
			const char* csChannel,
                        const char* csMerchantId,
                        const char* csServiceCode,
                        const char* csCountry,
			const char* csCcy,
			const char* csCustomerGroup,
			const char* csIpRegionCode,
			const int   iRestrictedIP,
			const double dAmt,
			recordset_t* myRec)
{
	int iRet = PD_OK;
	int	iCnt = 0;

	hash_t	*myHash;

        EXEC SQL WHENEVER SQLERROR GOTO maccygrpgetnew_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar	v_psp_id[PD_PSP_ID_LEN];
		varchar	v_client_id[PD_CLIENT_ID_LEN];
		varchar v_ccy[PD_CCY_ID_LEN];
		varchar	v_bank[PD_BANK_CODE_LEN];
		double	v_remaining_limit;
		int	v_credit_option;
		int	v_debit_option;

		varchar hv_option_bank[PD_BANK_CODE_LEN];
		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_service_code[PD_SERVICE_CODE_LEN];
		varchar	hv_channel[PD_CHANNEL_CODE_LEN];
		varchar	hv_txn_country[PD_COUNTRY_LEN];
		varchar	hv_txn_ccy[PD_CCY_ID_LEN];
		varchar	hv_customer_group[PD_CUSTOMER_GROUP_CODE_LEN];
		varchar hv_ip_region_code[PD_COUNTRY_LEN];
		double	hv_amount;
		int	hv_restricted_ip;

		short	hv_return_value;

		short	ind_psp_id = -1;
		short	ind_client_id = -1;
		short	ind_ccy = -1;
		short	ind_bank= -1;
		short	ind_remaining_limit = -1;
		short	ind_credit_option = -1;
		short	ind_debit_option = -1;

		short   ind_option_bank = -1;
		short	ind_merchant_id = -1;
		short	ind_service_code = -1;
		short	ind_channel = -1;
		short	ind_txn_country = -1;
		short	ind_txn_ccy = -1;
		short	ind_customer_group = -1;
		short	ind_ip_region_code = -1;
		short	ind_amount = -1;
		short	ind_restricted_ip = -1;

		SQL_CURSOR      c_cursor_id;

        EXEC SQL END DECLARE SECTION;

/* option_bank */
        hv_option_bank.len = strlen(csOptionBank);
        memcpy(hv_option_bank.arr,csOptionBank,hv_option_bank.len);
        ind_option_bank = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: option_bank = [%.*s]\n",hv_option_bank.len,hv_option_bank.arr));

/* channel */
	hv_channel.len = strlen(csChannel);
	memcpy(hv_channel.arr,csChannel,hv_channel.len);
	ind_channel = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: channel = [%.*s]\n",hv_channel.len,hv_channel.arr));

/* merchant_id */
	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

/* service_code */
	hv_service_code.len = strlen(csServiceCode);
	memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
	ind_service_code = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: service_code = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

/* txn_country */
	hv_txn_country.len = strlen(csCountry);
	memcpy(hv_txn_country.arr,csCountry,hv_txn_country.len);
	ind_txn_country = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: txn_country = [%.*s]\n",hv_txn_country.len,hv_txn_country.arr));

/* txn_ccy */
	hv_txn_ccy.len = strlen(csCcy);
	memcpy(hv_txn_ccy.arr,csCcy,hv_txn_ccy.len);
	ind_txn_ccy = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: txn_ccy = [%.*s]\n",hv_txn_ccy.len,hv_txn_ccy.arr));

/* ip_region_code */
        hv_ip_region_code.len = strlen(csIpRegionCode);
        memcpy(hv_ip_region_code.arr,csIpRegionCode,hv_ip_region_code.len);
        ind_ip_region_code = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: ip_region_code = [%.*s]\n",hv_ip_region_code.len,hv_ip_region_code.arr));

/* amount*/
	hv_amount = dAmt;
	ind_amount = 0;

/* restricted_ip */
	hv_restricted_ip = iRestrictedIP;
	ind_restricted_ip  = 0;

/* customer_group */
	if(csCustomerGroup!=NULL){
		hv_customer_group.len = strlen(csCustomerGroup);
		memcpy(hv_customer_group.arr,csCustomerGroup,hv_customer_group.len);
		ind_customer_group = 0;
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: customer_group = [%.*s]\n",hv_customer_group.len,hv_customer_group.arr));
	}


	EXEC SQL ALLOCATE       :c_cursor_id;
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_rulelb_mcgrp_card_get_new( :hv_option_bank:ind_option_bank,
									     :hv_merchant_id:ind_merchant_id,
									     :hv_channel:ind_channel,
									     :hv_service_code:ind_service_code,
									     :hv_txn_country:ind_txn_country,
									     :hv_txn_ccy:ind_txn_ccy,
									     :hv_customer_group:ind_customer_group,
									     :hv_ip_region_code:ind_ip_region_code,
									     :hv_restricted_ip:ind_restricted_ip,
									     :hv_amount:ind_amount,
									     :c_cursor_id);
                END;
        END-EXEC;


	if (hv_return_value == 0 ) {
		for (;;) {
			myHash = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(myHash,0);	

			ind_psp_id = -1;
			ind_client_id = -1;
			ind_ccy = -1;
			ind_bank = -1;
			ind_remaining_limit = -1;
			ind_credit_option = -1;
			ind_debit_option = -1;

			EXEC SQL WHENEVER NOTFOUND DO break;
			EXEC SQL FETCH :c_cursor_id
			INTO	:v_bank:ind_bank,
				:v_client_id:ind_client_id,
				:v_psp_id:ind_psp_id,
				:v_ccy:ind_ccy,
				:v_remaining_limit:ind_remaining_limit,
				:v_credit_option:ind_credit_option,
				:v_debit_option:ind_debit_option;

			if (SQLCODE == SQL_NOT_FOUND) {
				break;
			}

			if (ind_bank >= 0) {
				v_bank.arr[v_bank.len] = '\0';
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: [%03d]bank = [%s]\n",iCnt,v_bank.arr));
				PutField_CString(myHash,"bank_code",(const char*)v_bank.arr);
			}

			if (ind_psp_id >= 0) {
				v_psp_id.arr[v_psp_id.len] = '\0';
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: [%03d]psp_id = [%s]\n",iCnt,v_psp_id.arr));
				PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
			}

			if (ind_client_id >= 0) {
				v_client_id.arr[v_client_id.len] = '\0';
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: [%03d]client_id = [%s]\n",iCnt,v_client_id.arr));
				PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
			}

			if (ind_ccy>= 0) {
				v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: [%03d]ccy = [%s]\n",iCnt,v_ccy.arr));
				PutField_CString(myHash,"psp_ccy",(const char*)v_ccy.arr);
			}
	
			if (ind_remaining_limit>= 0) {
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: [%03d]remaining_limit = [%lf]\n",iCnt,v_remaining_limit));
				PutField_Double(myHash,"remaining_limit",v_remaining_limit);
			}

			if (ind_credit_option>= 0) {
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: [%03d]credit_option = [%d]\n",iCnt,v_credit_option));
				PutField_Int(myHash,"credit_option",v_credit_option);
			}

			if (ind_debit_option>= 0) {
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: [%03d]debit_option = [%d]\n",iCnt,v_debit_option));
				PutField_Int(myHash,"debit_option",v_debit_option);
			}

/*
			if (ind_scheduler_id>= 0) {
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: [%03d]scheduler_id = [%d]\n",iCnt,v_scheduler_id));
				PutField_Int(myHash,"scheduler_id",v_scheduler_id);
			}

			if (ind_note_id>= 0) {
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: [%03d]note_id = [%d]\n",iCnt,v_note_id));
				PutField_Int(myHash,"note_id",v_note_id);
			}
*/
			RecordSet_Add(myRec,myHash);
			iCnt++;
		}
	}

	EXEC SQL CLOSE :c_cursor_id;
	EXEC SQL FREE :c_cursor_id;
DEBUGLOG(("GetBankPspByMerchNCcyNGrpNew: Finished\n"));

	return iRet;

maccygrpgetnew_error:
DEBUGLOG(("maccygrpgetnew_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE :c_cursor_id;
    EXEC SQL FREE :c_cursor_id;
    return PD_ERR;
}

