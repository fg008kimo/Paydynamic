/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/08/27              Cody Chan
Added "GetExchangeRateByDate"			   2011/07/15		   Simon Fung
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "ExchangeRate.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cDebug;

void ExchangeRate(char    cdebug)
{
        cDebug = cdebug;
}


int Add(const hash_t *hExr)
{
	char            *csTmp;
	double          dTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_from_ccy_id[PD_CCY_ID_LEN];
		varchar 	hv_to_ccy_id[PD_CCY_ID_LEN];
		varchar 	hv_create_user[PD_USER_LEN];

		double		hv_rate;
		double 		hv_bid;
		double 		hv_max_bid;
		double 		hv_med_bid;
		double 		hv_min_bid;
		double 		hv_max_ask;
		double 		hv_med_ask;
		double 		hv_min_ask;
		double 		hv_min_max;
		double 		hv_mean_min_max;


		short 		ind_from_ccy_id = -1;
		short 		ind_to_ccy_id = -1;
		short 		ind_create_user = -1;
		short 		ind_hv_rate = -1;
		short 		ind_hv_bid = -1;
		short 		ind_hv_max_bid = -1;
		short 		ind_hv_med_bid = -1;
		short 		ind_hv_min_bid = -1;
		short 		ind_hv_max_ask = -1;
		short 		ind_hv_med_ask = -1;
		short 		ind_hv_min_ask = -1;
		short 		ind_hv_min_max = -1;
		short 		ind_hv_mean_min_max = -1;

		short 		hv_return_value;

	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));

	if(GetField_CString(hExr,"from_ccy_id", &csTmp))
	{
		hv_from_ccy_id.len = strlen(csTmp);
		strncpy((char *)hv_from_ccy_id.arr, csTmp, hv_from_ccy_id.len);
		ind_from_ccy_id = 0;
	}
DEBUGLOG(("Add:from_ccy_id = [%.*s]\n",hv_from_ccy_id.len,hv_from_ccy_id.arr));

	if(GetField_CString(hExr,"to_ccy_id", &csTmp))
	{
		hv_to_ccy_id.len = strlen(csTmp);
		strncpy((char *)hv_to_ccy_id.arr, csTmp, hv_to_ccy_id.len);
		ind_to_ccy_id = 0;
	}
DEBUGLOG(("Add:to_ccy_id = [%.*s]\n",hv_to_ccy_id.len,hv_to_ccy_id.arr));
	

	if(GetField_CString(hExr,"create_user", &csTmp))
	{
		hv_create_user.len = strlen(csTmp);
		strncpy((char *)hv_create_user.arr, csTmp, hv_create_user.len);
		ind_create_user = 0;
	}
DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));

	if(GetField_Double(hExr,"rate", &dTmp))
	{
		hv_rate = dTmp;
		ind_hv_rate = 0;
	}
DEBUGLOG(("Add:rate = [%f]\n",hv_rate));

	if(GetField_Double(hExr,"bid", &dTmp))
	{
		hv_bid = dTmp;
		ind_hv_bid = 0;
	}
DEBUGLOG(("Add:bid = [%f]\n",hv_bid));

	if(GetField_Double(hExr,"max_bid", &dTmp))
	{
		hv_max_bid = dTmp;
		ind_hv_max_bid = 0;
	}
DEBUGLOG(("Add:max_bid = [%f]\n",hv_max_bid));

	if(GetField_Double(hExr,"med_bid", &dTmp))
	{
		hv_med_bid = dTmp;
		ind_hv_med_bid = 0;
	}
DEBUGLOG(("Add:med_bid = [%f]\n",hv_med_bid));

	if(GetField_Double(hExr,"min_bid", &dTmp))
	{
		hv_min_bid = dTmp;
		ind_hv_min_bid = 0;
	}
DEBUGLOG(("Add:min_bid = [%f]\n",hv_min_bid));

	if(GetField_Double(hExr,"max_ask", &dTmp))
	{
		hv_max_ask = dTmp;
		ind_hv_max_ask = 0;
	}
DEBUGLOG(("Add:max_ask = [%f]\n",hv_max_ask));

	if(GetField_Double(hExr,"med_ask", &dTmp))
	{
		hv_med_ask = dTmp;
		ind_hv_med_ask = 0;
	}
DEBUGLOG(("Add:med_ask = [%f]\n",hv_med_ask));

	if(GetField_Double(hExr,"min_ask", &dTmp))
	{
		hv_min_ask = dTmp;
		ind_hv_min_ask = 0;
	}
DEBUGLOG(("Add:min_ask = [%f]\n",hv_min_ask));

	if(GetField_Double(hExr,"min_max", &dTmp))
	{
		hv_min_max = dTmp;
		ind_hv_min_max = 0;
	}
DEBUGLOG(("Add:min_max = [%f]\n",hv_min_max));

	if(GetField_Double(hExr,"mean_min_max", &dTmp))
	{
		hv_mean_min_max = dTmp;
		ind_hv_mean_min_max = 0;
	}
DEBUGLOG(("Add:mean_min_max = [%f]\n",hv_mean_min_max));

	FREE_ME(csTmp);


	EXEC SQL EXECUTE
	    BEGIN
		:hv_return_value := sp_exchange_rate_insert(
				:hv_from_ccy_id:ind_from_ccy_id,
				:hv_to_ccy_id:ind_to_ccy_id,
				:hv_rate:ind_hv_rate,
				:hv_bid:ind_hv_bid,
				:hv_max_ask:ind_hv_max_ask,
				:hv_med_ask:ind_hv_med_ask,
				:hv_min_ask:ind_hv_min_ask,
				:hv_max_bid:ind_hv_max_bid,
				:hv_med_bid:ind_hv_med_bid,
				:hv_min_bid:ind_hv_min_bid,
				:hv_mean_min_max:ind_hv_mean_min_max,
				:hv_min_max:ind_hv_min_max,
				:hv_create_user:ind_create_user);

	    END;
	END-EXEC;


	DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
	if (hv_return_value == SP_OK)
	{
		DEBUGLOG(("Add:Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR)  {
		ERRLOG("ExchangeRate_Add: SP_OTHER_ERR TxnAbort\n");
		DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR)  {
		ERRLOG("ExchangeRate_Add: SP_ERR TxnAbort\n");
		DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		return PD_ERR;
	}

add_error:
	DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
	DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;

}


int GetExchangeRate(const char* csFromCcyId, const char* csToCcyId, hash_t* hRec)
{

	EXEC SQL WHENEVER SQLERROR GOTO getexchangerate_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_from_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_to_ccy_id[PD_CCY_ID_LEN];


		double		v_rate;
		double		v_bid;
		double		v_max_bid;
                double          v_med_bid;
                double          v_min_bid;
                double          v_max_ask;
                double          v_med_ask;
                double          v_min_ask;
                double          v_min_max;
                double          v_mean_min_max;
	
		short           ind_v_rate = -1;
                short           ind_v_bid = -1;
                short           ind_v_max_bid = -1;
                short           ind_v_med_bid = -1;
                short           ind_v_min_bid = -1;
                short           ind_v_max_ask = -1;
                short           ind_v_med_ask = -1;
                short           ind_v_min_ask = -1;
                short           ind_v_min_max = -1;
                short           ind_v_mean_min_max = -1;

	EXEC SQL END DECLARE SECTION;


	hv_from_ccy_id.len = strlen(csFromCcyId);
	memcpy(hv_from_ccy_id.arr, csFromCcyId, hv_from_ccy_id.len);
DEBUGLOG(("GetExchangeRate from_ccy_id = [%.*s]\n",hv_from_ccy_id.len,hv_from_ccy_id.arr));

	hv_to_ccy_id.len = strlen(csToCcyId);
	memcpy(hv_to_ccy_id.arr, csToCcyId, hv_to_ccy_id.len);
DEBUGLOG(("GetExchangeRate to_ccy_id = [%.*s]\n",hv_to_ccy_id.len,hv_to_ccy_id.arr));

	EXEC SQL DECLARE c_cursor_getexchangerate CURSOR FOR
		SELECT	ex_rate,
			ex_bid,
			ex_max_ask,
			ex_med_ask,
			ex_min_ask,
			ex_max_bid,
			ex_med_bid,
			ex_min_bid,
			ex_minmax_src2dst,
			ex_meanminmax_src2dst
		FROM	exchange_rate
		WHERE	ex_from_ccy_id = :hv_from_ccy_id
		AND	ex_to_ccy_id = :hv_to_ccy_id
		AND	ex_effect_date  = 
			(SELECT max(ex_effect_date)
                           FROM exchange_rate
                          WHERE ex_from_ccy_id = :hv_from_ccy_id
                            AND ex_to_ccy_id = :hv_to_ccy_id
                            AND ex_effect_date <= sysdate);

	EXEC SQL OPEN c_cursor_getexchangerate;
	do {
		EXEC SQL FETCH c_cursor_getexchangerate

                INTO
			:v_rate:ind_v_rate,
			:v_bid:ind_v_bid,
			:v_max_ask:ind_v_max_ask,
			:v_med_ask:ind_v_med_ask,
			:v_min_ask:ind_v_min_ask,
			:v_max_bid:ind_v_max_bid,
			:v_med_bid:ind_v_med_bid,
			:v_min_bid:ind_v_min_bid,
			:v_min_max:ind_v_min_max,
			:v_mean_min_max:ind_v_mean_min_max;

		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

/*rate*/
		if(ind_v_rate>=0)
		{
			PutField_Double(hRec,"rate",v_rate);
DEBUGLOG(("GetExchangeRate rate = [%f]\n",v_rate));
		}

/*bid*/
		if(ind_v_bid>=0)
		{
			PutField_Double(hRec,"bid",v_bid);
DEBUGLOG(("GetExchangeRate bid = [%f]\n",v_bid));
		}

/*max_bid*/
		if(ind_v_max_bid>=0)
		{
			PutField_Double(hRec,"MAXBID",v_max_bid);
DEBUGLOG(("GetExchangeRate MAXBID = [%f]\n",v_max_bid));
		}

/*med_bid*/
		if(ind_v_med_bid>=0)
		{
			PutField_Double(hRec,"MEDBID",v_med_bid);
DEBUGLOG(("GetExchangeRate MEDBID = [%f]\n",v_med_bid));
		}

/*min_bid*/
		if(ind_v_min_bid>=0)
		{
			PutField_Double(hRec,"MINBID",v_min_bid);
DEBUGLOG(("GetExchangeRate MINBID = [%f]\n",v_min_bid));
		}

/*max_ask*/
		if(ind_v_max_ask>=0)
		{
			PutField_Double(hRec,"MAXASK",v_max_ask);
DEBUGLOG(("GetExchangeRate MAXASK = [%f]\n",v_max_ask));
		}

/*med_ask*/
		if(ind_v_med_ask>=0)
		{
			PutField_Double(hRec,"MEDASK",v_med_ask);
DEBUGLOG(("GetExchangeRate MEDASK = [%f]\n",v_med_ask));
		}

/*min_ask*/
		if(ind_v_min_ask>=0)
		{
			PutField_Double(hRec,"MINASK",v_min_ask);
DEBUGLOG(("GetExchangeRate MINASK = [%f]\n",v_min_ask));
		}

/*min_max*/
		if(ind_v_min_max>=0)
		{
			PutField_Double(hRec,"MINMAX",v_min_max);
DEBUGLOG(("GetExchangeRate MINMAX = [%f]\n",v_min_max));
		}

/*mean_min_max*/
		if(ind_v_mean_min_max>=0)
		{
			PutField_Double(hRec,"MEANMINMAX",v_mean_min_max);
DEBUGLOG(("GetExchangeRate MEANMINMAX = [%f]\n",v_mean_min_max));
		}


	}while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_getexchangerate;

DEBUGLOG(("GetExchangeRate Normal Exit\n"));
        return  PD_OK;

getexchangerate_error:
DEBUGLOG(("getexchangerate_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getexchangerate;
        return PD_ERR;


}

int GetExchangeRateByDate(const char* csEffectDate, const char* csFromCcyId, const char* csToCcyId, hash_t* hRec)
{

	EXEC SQL WHENEVER SQLERROR GOTO getexchangeratebydate_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_from_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_to_ccy_id[PD_CCY_ID_LEN];
		varchar		hv_effect_date[PD_DATE_LEN];

		double		v_rate;
		double		v_bid;
		double		v_max_bid;
                double          v_med_bid;
                double          v_min_bid;
                double          v_max_ask;
                double          v_med_ask;
                double          v_min_ask;
                double          v_min_max;
                double          v_mean_min_max;
	
		short           ind_v_rate = -1;
                short           ind_v_bid = -1;
                short           ind_v_max_bid = -1;
                short           ind_v_med_bid = -1;
                short           ind_v_min_bid = -1;
                short           ind_v_max_ask = -1;
                short           ind_v_med_ask = -1;
                short           ind_v_min_ask = -1;
                short           ind_v_min_max = -1;
                short           ind_v_mean_min_max = -1;

	EXEC SQL END DECLARE SECTION;


	hv_from_ccy_id.len = strlen(csFromCcyId);
	memcpy(hv_from_ccy_id.arr, csFromCcyId, hv_from_ccy_id.len);
DEBUGLOG(("GetExchangeRateByDate from_ccy_id = [%.*s]\n",hv_from_ccy_id.len,hv_from_ccy_id.arr));

	hv_to_ccy_id.len = strlen(csToCcyId);
	memcpy(hv_to_ccy_id.arr, csToCcyId, hv_to_ccy_id.len);
DEBUGLOG(("GetExchangeRateByDate to_ccy_id = [%.*s]\n",hv_to_ccy_id.len,hv_to_ccy_id.arr));

	hv_effect_date.len = strlen(csEffectDate);
	memcpy(hv_effect_date.arr, csEffectDate, hv_effect_date.len);
DEBUGLOG(("GetExchangeRateByDate effect_date = [%.*s]\n",hv_effect_date.len,hv_effect_date.arr));

	EXEC SQL DECLARE c_cursor_getexchangeratebydate CURSOR FOR
		SELECT	ex_rate,
			ex_bid,
			ex_max_ask,
			ex_med_ask,
			ex_min_ask,
			ex_max_bid,
			ex_med_bid,
			ex_min_bid,
			ex_minmax_src2dst,
			ex_meanminmax_src2dst
		FROM	exchange_rate
		WHERE	ex_from_ccy_id = :hv_from_ccy_id
		AND	ex_to_ccy_id = :hv_to_ccy_id
		AND	ex_effect_date  = 
			(SELECT max(ex_effect_date)
                           FROM exchange_rate
                          WHERE ex_from_ccy_id = :hv_from_ccy_id
                            AND ex_to_ccy_id = :hv_to_ccy_id
                            AND ex_effect_date < to_date(:hv_effect_date,'YYYYMMDD') + 1);

	EXEC SQL OPEN c_cursor_getexchangeratebydate;
	do {
		EXEC SQL FETCH c_cursor_getexchangeratebydate

                INTO
			:v_rate:ind_v_rate,
			:v_bid:ind_v_bid,
			:v_max_ask:ind_v_max_ask,
			:v_med_ask:ind_v_med_ask,
			:v_min_ask:ind_v_min_ask,
			:v_max_bid:ind_v_max_bid,
			:v_med_bid:ind_v_med_bid,
			:v_min_bid:ind_v_min_bid,
			:v_min_max:ind_v_min_max,
			:v_mean_min_max:ind_v_mean_min_max;

		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

/*rate*/
		if(ind_v_rate>=0)
		{
			PutField_Double(hRec,"rate",v_rate);
DEBUGLOG(("GetExchangeRateByDate rate = [%f]\n",v_rate));
		}

/*bid*/
		if(ind_v_bid>=0)
		{
			PutField_Double(hRec,"bid",v_bid);
DEBUGLOG(("GetExchangeRateByDate bid = [%f]\n",v_bid));
		}

/*max_bid*/
		if(ind_v_max_bid>=0)
		{
			PutField_Double(hRec,"max_bid",v_max_bid);
DEBUGLOG(("GetExchangeRateByDate max_bid = [%f]\n",v_max_bid));
		}

/*med_bid*/
		if(ind_v_med_bid>=0)
		{
			PutField_Double(hRec,"med_bid",v_med_bid);
DEBUGLOG(("GetExchangeRateByDate med_bid = [%f]\n",v_med_bid));
		}

/*min_bid*/
		if(ind_v_min_bid>=0)
		{
			PutField_Double(hRec,"min_bid",v_min_bid);
DEBUGLOG(("GetExchangeRateByDate min_bid = [%f]\n",v_min_bid));
		}

/*max_ask*/
		if(ind_v_max_ask>=0)
		{
			PutField_Double(hRec,"max_ask",v_max_ask);
DEBUGLOG(("GetExchangeRateByDate max_ask = [%f]\n",v_max_ask));
		}

/*med_ask*/
		if(ind_v_med_ask>=0)
		{
			PutField_Double(hRec,"med_ask",v_med_ask);
DEBUGLOG(("GetExchangeRateByDate med_ask = [%f]\n",v_med_ask));
		}

/*min_ask*/
		if(ind_v_min_ask>=0)
		{
			PutField_Double(hRec,"min_ask",v_min_ask);
DEBUGLOG(("GetExchangeRateByDate min_ask = [%f]\n",v_min_ask));
		}

/*min_max*/
		if(ind_v_min_max>=0)
		{
			PutField_Double(hRec,"min_max",v_min_max);
DEBUGLOG(("GetExchangeRateByDate min_max = [%f]\n",v_min_max));
		}

/*mean_min_max*/
		if(ind_v_mean_min_max>=0)
		{
			PutField_Double(hRec,"mean_min_max",v_mean_min_max);
DEBUGLOG(("GetExchangeRateByDate mean_min_max = [%f]\n",v_mean_min_max));
		}


	}while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_getexchangeratebydate;

DEBUGLOG(("GetExchangeRateByDate Normal Exit\n"));
        return  PD_OK;

getexchangeratebydate_error:
DEBUGLOG(("getexchangeratebydate_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getexchangeratebydate;
        return PD_ERR;


}



