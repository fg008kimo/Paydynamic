CREATE OR REPLACE FUNCTION sp_ol_auto_upl_get_bank_acct(
	in_acct_type			OL_BANK_ACCTS.OB_ACCT_TYPE%type,
	in_client_id			PSP_MASTER.PM_CLIENT_ID%type,
	in_int_bank_code_list		VARCHAR2,
	in_int_bank_code_exist		INTEGER,
	in_int_bank_code_exclude	INTEGER,
	out_cursor       		OUT SYS_REFCURSOR)
RETURN NUMBER IS
	iCnt    integer := 0;
BEGIN

	select 	count(*)
	into 	iCnt
	from    bank_desc,
             	ol_bank_accts,
                ol_bank_acct_id,
             	ol_psp_detail,
               	psp_master
     	where   ob_int_bank_code = obai_int_bank_code
        and     internal_bank_code = ob_int_bank_code
       	and     ((in_int_bank_code_exist <> 1) 
		 or (in_int_bank_code_exist = 1 and in_int_bank_code_exclude <> 1 
		     and internal_bank_code in (SELECT REGEXP_SUBSTR (in_int_bank_code_list,'[^,]+',1,LEVEL) token
						 FROM DUAL CONNECT BY LEVEL <= LENGTH (in_int_bank_code_list)- LENGTH (REPLACE(in_int_bank_code_list,',',''))+ 1))
		 or (in_int_bank_code_exist = 1 and in_int_bank_code_exclude = 1
		     and internal_bank_code not in (SELECT REGEXP_SUBSTR (in_int_bank_code_list,'[^,]+',1,LEVEL) token
                                               	     FROM DUAL CONNECT BY LEVEL <= LENGTH (in_int_bank_code_list)- LENGTH (REPLACE(in_int_bank_code_list,',',''))+ 1))
		)
      	and     ob_bank_acct_num = obai_bank_acct_num
     	and     obai_psp_id = opd_psp_id
      	and     pm_client_id = in_client_id
      	and     opd_client_id = pm_client_id
       	and     offline_support = 1
       	and   	((ob_acct_type = 'DSI' and offline_deposit = 1)
		 or (ob_acct_type != 'DSI'))
      	/*and   ob_status_type in ('A', 'B', 'F', 'S', 'SS', 'NF', 'ND')*/
      	and     ob_status_type in ('A')
      	and     ob_acct_type = in_acct_type
       	and     ob_sys_switch_enabled = 1
      	and     obai_status = 'O'
     	and     opd_bank_acct_type = ob_acct_type
      	and     opd_status = 'O'
     	and     opd_disabled = 0
    	and     pm_status = 'O'
    	and     pm_mode_type = 'OFL';

	IF iCnt > 0 THEN

		OPEN out_cursor FOR
		select	pm_client_name,
       		       	opd_psp_id,
       		       	opd_psp_name,
       		       	obai_baid,
       		       	obai_baid_name,
       		       	internal_bank_code,
       		       	bank_abbrev_name,
       		       	bank_name,
       		       	country,
       		       	ob_bank_acct_num,
       		       	ob_acct_ccy,
       		       	ob_bank_acct_name,
       		       	ob_bank_acct_short_name,
       		       	bank_disabled,
       		       	bank_acct_disabled
		from (
			select 	pm_client_name,
       			       	opd_psp_id,
       			       	opd_psp_name,
       			       	obai_baid,
       			       	obai_baid_name,
       			       	internal_bank_code,
       				bank_abbrev_name,
       				bank_name,
       				country,
       				ob_bank_acct_num,
       				ob_acct_ccy,
       				ob_bank_acct_name,
       				ob_bank_acct_short_name,
       				a.oaubd_disabled bank_disabled,
       				b.oaubd_disabled bank_acct_disabled
			from (
				select 	pm_client_name,
       					opd_psp_id,
       					opd_psp_name,
       					obai_baid,
       					obai_baid_name,
       					internal_bank_code,
       					bank_abbrev_name,
       					bank_name,
       					country,
       					ob_bank_acct_num,
       					ob_acct_ccy,
       					ob_bank_acct_name,
       					ob_bank_acct_short_name
				from    bank_desc,
        				ol_bank_accts,
        				ol_bank_acct_id,
        				ol_psp_detail,
        				psp_master
				where   ob_int_bank_code = obai_int_bank_code
				and     internal_bank_code = ob_int_bank_code
				and     ((in_int_bank_code_exist <> 1)
                 			or (in_int_bank_code_exist = 1 and in_int_bank_code_exclude <> 1
                     			   and internal_bank_code in (SELECT REGEXP_SUBSTR (in_int_bank_code_list,'[^,]+',1,LEVEL) token
                                                 		     FROM DUAL CONNECT BY LEVEL <= LENGTH (in_int_bank_code_list)- LENGTH (REPLACE(in_int_bank_code_list,',',''))+ 1))
                 			or (in_int_bank_code_exist = 1 and in_int_bank_code_exclude = 1
                     			   and internal_bank_code not in (SELECT REGEXP_SUBSTR (in_int_bank_code_list,'[^,]+',1,LEVEL) token
                                                     			 FROM DUAL CONNECT BY LEVEL <= LENGTH (in_int_bank_code_list)- LENGTH (REPLACE(in_int_bank_code_list,',',''))+ 1))
                			)
				and     ob_bank_acct_num = obai_bank_acct_num
				and     obai_psp_id = opd_psp_id
				and     pm_client_id = in_client_id
				and     opd_client_id = pm_client_id
				and     offline_support = 1
				and     ((ob_acct_type = 'DSI' and offline_deposit = 1)
                 			 or (ob_acct_type != 'DSI'))
				/*and   ob_status_type in ('A', 'B', 'F', 'S', 'SS', 'NF', 'ND')*/
				and     ob_status_type in ('A')
				and     ob_acct_type = in_acct_type
				and     ob_sys_switch_enabled = 1
				and     obai_status = 'O'
				and     opd_bank_acct_type = ob_acct_type
				and     opd_status = 'O'
				and     opd_disabled = 0
				and     pm_status = 'O'
				and     pm_mode_type = 'OFL'
			)
--
			LEFT JOIN	(SELECT	oaubd_acct_type,
						oaubd_int_bank_code,
                    				oaubd_bank_acct_num,
                    				oaubd_disabled                      
             				 FROM ol_auto_upload_bank_detail) a
			ON a.oaubd_acct_type = in_acct_type
			AND a.oaubd_int_bank_code = internal_bank_code
			AND a.oaubd_bank_acct_num = '000'
--
			LEFT JOIN   	(SELECT oaubd_acct_type,
						oaubd_int_bank_code,
                    				oaubd_bank_acct_num,
                    				oaubd_disabled                      
             				FROM ol_auto_upload_bank_detail) b
					ON b.oaubd_acct_type = in_acct_type
					AND b.oaubd_int_bank_code = internal_bank_code
					AND b.oaubd_bank_acct_num = ob_bank_acct_num
--
		)
		group by	pm_client_name,
       				opd_psp_id,
       				opd_psp_name,
       				obai_baid,
       				obai_baid_name,
       				internal_bank_code,
       				bank_abbrev_name,
       				bank_name,
       				country,
       				ob_bank_acct_num,
       				ob_acct_ccy,
       				ob_bank_acct_name,
       				ob_bank_acct_short_name,
       				bank_disabled,
       				bank_acct_disabled
		order by 	pm_client_name,
       				opd_psp_id,
       				opd_psp_name,
       				obai_baid,
       				obai_baid_name,
       				internal_bank_code,
       				bank_abbrev_name,
       				bank_name,
       				country,
       				ob_bank_acct_num,
       				ob_acct_ccy,
       				ob_bank_acct_name,
       				ob_bank_acct_short_name,
       				bank_disabled,
       				bank_acct_disabled;		

		return 0;
	ELSE
		return 2;
  	END IF;

EXCEPTION
	WHEN OTHERS THEN
		RETURN 9;

END sp_ol_auto_upl_get_bank_acct;
/
