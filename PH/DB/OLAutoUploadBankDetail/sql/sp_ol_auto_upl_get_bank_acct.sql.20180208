CREATE OR REPLACE FUNCTION sp_ol_auto_upl_get_bank_acct(
	in_acct_type			OL_BANK_ACCTS.OB_ACCT_TYPE%type,
	in_client_id			PSP_MASTER.PM_CLIENT_ID%type,
	in_int_bank_code		OL_AUTO_UPLOAD_BANK_DETAIL.OAUBD_INT_BANK_CODE%type,
	in_int_bank_code_exist		INTEGER,
	in_int_bank_code_disabled	INTEGER,
	out_cursor       		OUT SYS_REFCURSOR)
RETURN NUMBER IS
	iCnt    integer := 0;
BEGIN

	select count(*)
	into iCnt
	from    ol_auto_upload_bank_detail,
               	bank_desc,
             	ol_bank_accts,
                ol_bank_acct_id,
             	ol_psp_detail,
               	psp_master
     	where   obai_int_bank_code = oaubd_int_bank_code
      	and     ob_int_bank_code = obai_int_bank_code
        and     internal_bank_code = ob_int_bank_code
       	and     ((in_int_bank_code_exist <> 1) 
		 or (in_int_bank_code_exist = 1 and in_int_bank_code_disabled <> 1 and oaubd_int_bank_code = in_int_bank_code)
		 or (in_int_bank_code_exist = 1 and in_int_bank_code_disabled = 1 and oaubd_int_bank_code != in_int_bank_code)
		)
      	and     oaubd_bank_acct_num = '000'
      	and     ob_bank_acct_num = obai_bank_acct_num
     	and     obai_psp_id = opd_psp_id
      	and     pm_client_id = in_client_id
      	and     opd_client_id = pm_client_id
	and   	oaubd_disabled = 0
       	and     offline_support = 1
       	/*and   offline_deposit = 1*/
      	/*and   ob_status_type in ('A', 'B', 'F', 'S', 'SS', 'NF', 'ND')*/
      	and     ob_status_type in ('A')
      	and     ob_acct_type = in_acct_type
       	and     ob_sys_switch_enabled = 1
      	and     obai_status = 'O'
     	and     opd_bank_acct_type = ob_acct_type
      	and     opd_status = 'O'
     	and     opd_disabled = 0
    	and     pm_status = 'O'
    	and     pm_mode_type = 'OFL';

	IF iCnt > 0 THEN

		select count(*)
        	into iCnt
        	from    ol_auto_upload_bank_detail,
                	bank_desc,
                	ol_bank_accts,
                	ol_bank_acct_id,
                	ol_psp_detail,
                	psp_master
       	 	where   obai_int_bank_code = oaubd_int_bank_code
        	and     ob_int_bank_code = obai_int_bank_code
        	and     internal_bank_code = ob_int_bank_code
		and     ((in_int_bank_code_exist <> 1) 
                 	 or (in_int_bank_code_exist = 1 and in_int_bank_code_disabled <> 1 and oaubd_int_bank_code = in_int_bank_code)
                 	 or (in_int_bank_code_exist = 1 and in_int_bank_code_disabled = 1 and oaubd_int_bank_code != in_int_bank_code)
                	)
        	and     obai_bank_acct_num = oaubd_bank_acct_num
        	and     ob_bank_acct_num = obai_bank_acct_num
        	and     obai_psp_id = opd_psp_id
        	and     pm_client_id = in_client_id
        	and     opd_client_id = pm_client_id
        	/*and   oaubd_disabled = 0*/
        	and     offline_support = 1
        	/*and   offline_deposit = 1*/
        	/*and   ob_status_type in ('A', 'B', 'F', 'S', 'SS', 'NF', 'ND')*/
        	and     ob_status_type in ('A')
        	and     ob_acct_type = in_acct_type
        	and     ob_sys_switch_enabled = 1
        	and     obai_status = 'O'
        	and     opd_bank_acct_type = ob_acct_type
        	and     opd_status = 'O'
        	and     opd_disabled = 0
        	and     pm_status = 'O'
        	and     pm_mode_type = 'OFL';

		IF iCnt > 0 THEN
		
			OPEN out_cursor FOR
	     		select  pm_client_name,
	                        opd_psp_id,
	                        opd_psp_name,
	                        obai_baid,
	                        obai_baid_name,
	                        ob_int_bank_code,
	                        bank_abbrev_name,
	                        bank_name,
	                        country,
	                        ob_bank_acct_num,
	                        ob_acct_ccy,
	                        ob_bank_acct_name,
	                        ob_bank_acct_short_name,
	                        oaubd_disabled
	                from    ol_auto_upload_bank_detail,
	                        bank_desc,
	                        ol_bank_accts,
	                        ol_bank_acct_id,
	                        ol_psp_detail,
	                        psp_master
	                where   obai_int_bank_code = oaubd_int_bank_code
	                and     ob_int_bank_code = obai_int_bank_code
	                and     internal_bank_code = ob_int_bank_code
			and     ((in_int_bank_code_exist <> 1) 
                 		 or (in_int_bank_code_exist = 1 and in_int_bank_code_disabled <> 1 and oaubd_int_bank_code = in_int_bank_code)
                 		 or (in_int_bank_code_exist = 1 and in_int_bank_code_disabled = 1 and oaubd_int_bank_code != in_int_bank_code)
               	 		)
	                and     obai_bank_acct_num = oaubd_bank_acct_num
	                and     ob_bank_acct_num = obai_bank_acct_num
	                and     obai_psp_id = opd_psp_id
	                and     pm_client_id = in_client_id
	                and     opd_client_id = pm_client_id
			/*and   oaubd_disabled = 0*/
	                and     offline_support = 1
        	        /*and   offline_deposit = 1*/
        	        /*and   ob_status_type in ('A', 'B', 'F', 'S', 'SS', 'NF', 'ND')*/
        	        and     ob_status_type in ('A')
        	        and     ob_acct_type = in_acct_type
        	        and     ob_sys_switch_enabled = 1
        	        and     obai_status = 'O'
        	        and     opd_bank_acct_type = ob_acct_type
        	        and     opd_status = 'O'
        	        and     opd_disabled = 0
        	        and     pm_status = 'O'
        	        and     pm_mode_type = 'OFL'
        	        order by pm_client_id, ob_int_bank_code, ob_bank_acct_num;

			return 0;
		ELSE
			return 2;
		END IF;
	ELSE
		return 2;
  	END IF;

EXCEPTION
	WHEN OTHERS THEN
		RETURN 9;

END sp_ol_auto_upl_get_bank_acct;
/
