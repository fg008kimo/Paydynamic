/*
Partnerdelight. (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/01/10              Stan Poon
Add GetNextErrAdjBatchSeq			   2016/09/06		   Elvis Wong
*/
#include <stdio.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLTxnSeq.h"
#include "common.h"
#include "utilitys.h"
char    cDebug;

void OLTxnSeq(char    cdebug)
{
        cDebug = cdebug;
}


char* GetNextOlnTxnSeq()
{
        EXEC SQL WHENEVER SQLERROR GOTO get_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_txn_seq_no[PD_TXN_SEQ_LEN + 1];
                short   ind_txn_seq_no;
        EXEC SQL END DECLARE SECTION;

        EXEC SQL SELECT osp_prefix || TO_CHAR(oln_txn_seq.NEXTVAL, 'FM099999999999999')
        	   INTO :hv_txn_seq_no:ind_txn_seq_no
                 FROM ol_seq_prefix
		 WHERE osp_val = 'OLN_PREFIX';

        if (ind_txn_seq_no >= 0)  {
                hv_txn_seq_no.arr[hv_txn_seq_no.len] = '\0';
                return strdup((const char *) hv_txn_seq_no.arr);
        }
        else
                return strdup("");

get_error:
DEBUGLOG(("get_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return strdup("");
}

char* GetNextOmtTxnSeq()
{
        EXEC SQL WHENEVER SQLERROR GOTO get_omttxnseq_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_txn_seq_no[PD_TXN_SEQ_LEN + 1];
                short   ind_txn_seq_no;
        EXEC SQL END DECLARE SECTION;

        EXEC SQL SELECT osp_prefix || TO_CHAR(omt_txn_seq.NEXTVAL, 'FM099999999999999')
                   INTO :hv_txn_seq_no:ind_txn_seq_no
                 FROM ol_seq_prefix
		 WHERE osp_val = 'OMT_PREFIX';

        if (ind_txn_seq_no >= 0)  {
                hv_txn_seq_no.arr[hv_txn_seq_no.len] = '\0';
                return strdup((const char *) hv_txn_seq_no.arr);
        }
        else
                return strdup("");

get_omttxnseq_error:
DEBUGLOG(("get_omttxnseq_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return strdup("");
}

char* GetNextStmtTxnSeq()
{
        EXEC SQL WHENEVER SQLERROR GOTO get_stmttxnseq_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_txn_seq_no[PD_TXN_SEQ_LEN + 1];
                short   ind_txn_seq_no;
        EXEC SQL END DECLARE SECTION;

        EXEC SQL SELECT osp_prefix || TO_CHAR(stmt_txn_seq.NEXTVAL, 'FM099999999999999')
                   INTO :hv_txn_seq_no:ind_txn_seq_no
                 FROM ol_seq_prefix
                 WHERE osp_val = 'STMT_PREFIX';

        if (ind_txn_seq_no >= 0)  {
                hv_txn_seq_no.arr[hv_txn_seq_no.len] = '\0';
                return strdup((const char *) hv_txn_seq_no.arr);
        }
        else
                return strdup("");

get_stmttxnseq_error:
DEBUGLOG(("get_stmttxnseq_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return strdup("");
}

char* GetNextStmtRef()
{
        EXEC SQL WHENEVER SQLERROR GOTO get_stmtref_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_txn_seq_no[PD_TXN_SEQ_LEN + 1];
                short   ind_txn_seq_no;
        EXEC SQL END DECLARE SECTION;

        EXEC SQL SELECT osp_prefix || TO_CHAR(stmt_seq.NEXTVAL, 'FM099999999999999')
                   INTO :hv_txn_seq_no:ind_txn_seq_no
                 FROM ol_seq_prefix
                 WHERE osp_val = 'STMT_REF_PREFIX';

        if (ind_txn_seq_no >= 0)  {
                hv_txn_seq_no.arr[hv_txn_seq_no.len] = '\0';
                return strdup((const char *) hv_txn_seq_no.arr);
        }
        else
                return strdup("");

get_stmtref_error:
DEBUGLOG(("get_stmtref_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return strdup("");
}

char* GetNextBaidTxnSeq()
{
        EXEC SQL WHENEVER SQLERROR GOTO get_baidtxnseq_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_txn_seq_no[PD_TXN_SEQ_LEN + 1];
                short   ind_txn_seq_no;
        EXEC SQL END DECLARE SECTION;

        EXEC SQL SELECT osp_prefix || TO_CHAR(baid_txn_seq.NEXTVAL, 'FM099999999999999')
                   INTO :hv_txn_seq_no:ind_txn_seq_no
                 FROM ol_seq_prefix
                 WHERE osp_val = 'BAID_PREFIX';

        if (ind_txn_seq_no >= 0)  {
                hv_txn_seq_no.arr[hv_txn_seq_no.len] = '\0';
                return strdup((const char *) hv_txn_seq_no.arr);
        }
        else
                return strdup("");

get_baidtxnseq_error:
DEBUGLOG(("get_baidtxnseq_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return strdup("");
}

char* GetNextOdiFileSeq()
{
        EXEC SQL WHENEVER SQLERROR GOTO get_odifileseq_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_txn_seq_no[PD_TXN_SEQ_LEN + 1];
                short   ind_txn_seq_no;
        EXEC SQL END DECLARE SECTION;

        EXEC SQL SELECT TO_CHAR(odi_file_seq.NEXTVAL, 'FM09999999999999')
                   INTO :hv_txn_seq_no:ind_txn_seq_no
                 FROM dual;

        if (ind_txn_seq_no >= 0)  {
                hv_txn_seq_no.arr[hv_txn_seq_no.len] = '\0';
                return strdup((const char *) hv_txn_seq_no.arr);
        }
        else
                return strdup("");

get_odifileseq_error:
DEBUGLOG(("get_odifileseq_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return strdup("");
}


char* GetNextBatchTxnSeq()
{

        EXEC SQL WHENEVER SQLERROR GOTO get_batchid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_txn_seq_no[PD_TXN_SEQ_LEN + 1];
                short   ind_txn_seq_no;
        EXEC SQL END DECLARE SECTION;

//DEBUGLOG(("GetNextBatchTxnSeq()\n"));
        EXEC SQL SELECT osp_prefix || TO_CHAR(txn_batch_seq.NEXTVAL, 'FM099999999999999')
                   INTO :hv_txn_seq_no:ind_txn_seq_no
                 FROM ol_seq_prefix
                 WHERE osp_val = 'MERCH_PO_PREFIX';

        if (ind_txn_seq_no >= 0)  {
                hv_txn_seq_no.arr[hv_txn_seq_no.len] = '\0';
                return strdup((const char *) hv_txn_seq_no.arr);
        }
        else
                return strdup("");

get_batchid_error:
DEBUGLOG(("get_batchid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return strdup("");
}

char* GetNextPayoutTxnSeq()
{

        EXEC SQL WHENEVER SQLERROR GOTO get_payoutid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_txn_seq_no[PD_TXN_SEQ_LEN + 1];
                short   ind_txn_seq_no;
        EXEC SQL END DECLARE SECTION;

//DEBUGLOG(("GetNextPayoutTxnSeq()\n"));
        EXEC SQL SELECT osp_prefix || TO_CHAR(txn_payout_gen_seq.NEXTVAL, 'FM099999999999999')
                   INTO :hv_txn_seq_no:ind_txn_seq_no
                 FROM ol_seq_prefix
                 WHERE osp_val = 'PSP_PO_PREFIX';

        if (ind_txn_seq_no >= 0)  {
                hv_txn_seq_no.arr[hv_txn_seq_no.len] = '\0';
                return strdup((const char *) hv_txn_seq_no.arr);
        }
        else
                return strdup("");

get_payoutid_error:
DEBUGLOG(("get_payoutid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return strdup("");
}


char* GetNextActionBatchSeq()
{

        EXEC SQL WHENEVER SQLERROR GOTO get_actbatch_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_txn_seq_no[PD_TXN_SEQ_LEN + 1];
                short   ind_txn_seq_no;
        EXEC SQL END DECLARE SECTION;

//DEBUGLOG(("GetNextActionBatchSeq()\n"));
        EXEC SQL SELECT osp_prefix || TO_CHAR(ACT_BATCH_SEQ.NEXTVAL, 'FM099999999999999')
                   INTO :hv_txn_seq_no:ind_txn_seq_no
                 FROM ol_seq_prefix
                 WHERE osp_val = 'ACT_BATCH_PREFIX';

        if (ind_txn_seq_no >= 0)  {
                hv_txn_seq_no.arr[hv_txn_seq_no.len] = '\0';
                return strdup((const char *) hv_txn_seq_no.arr);
        }
        else
                return strdup("");

get_actbatch_error:
DEBUGLOG(("get_actbatch_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return strdup("");
}

char* GetNextPfiFileSeq()
{
        EXEC SQL WHENEVER SQLERROR GOTO get_pfifileseq_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_txn_seq_no[PD_TXN_SEQ_LEN + 1];
                short   ind_txn_seq_no;
        EXEC SQL END DECLARE SECTION;

        EXEC SQL SELECT TO_CHAR(pfi_file_seq.NEXTVAL, 'FM0999999999999999')
                   INTO :hv_txn_seq_no:ind_txn_seq_no
                 FROM dual;

        if (ind_txn_seq_no >= 0)  {
                hv_txn_seq_no.arr[hv_txn_seq_no.len] = '\0';
                return strdup((const char *) hv_txn_seq_no.arr);
        }
        else
                return strdup("");

get_pfifileseq_error:
DEBUGLOG(("get_pfifileseq_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return strdup("");
}

char* GetNextMerchPspBatchSeq()
{

        EXEC SQL WHENEVER SQLERROR GOTO get_merchpspbatch_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_txn_seq_no[PD_TXN_SEQ_LEN + 1];
                short   ind_txn_seq_no;
        EXEC SQL END DECLARE SECTION;

//DEBUGLOG(("GetNextMerchPspBatchSeq()\n"));
        EXEC SQL SELECT osp_prefix || TO_CHAR(MERCH_PSP_BATCH_SEQ.NEXTVAL, 'FM099999999999999')
                   INTO :hv_txn_seq_no:ind_txn_seq_no
                 FROM ol_seq_prefix
                 WHERE osp_val = 'MERCH_PSP_BATCH_PREFIX';

        if (ind_txn_seq_no >= 0)  {
                hv_txn_seq_no.arr[hv_txn_seq_no.len] = '\0';
                return strdup((const char *) hv_txn_seq_no.arr);
        }
        else
                return strdup("");

get_merchpspbatch_error:
DEBUGLOG(("get_merchpspbatch_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return strdup("");
}

