/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/01/09              David Wong
Add GetDepositTxnToHold                            2014/03/03              Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <oraca.h>
#include <sqlca.h>
#include "OLTxnPspDetail.h"
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char cDebug;


void OLTxnPspDetail(char cdebug)
{
	cDebug = cdebug;
}


int perr01(const char *msg) {
	ERRLOG("Error occured when %s\n", msg);
	ERRLOG("{\n");
	ERRLOG(" sqlcaid = %s\n", sqlca.sqlcaid);
	ERRLOG(" sqlabc = %d\n", sqlca.sqlabc);
	ERRLOG(" sqlcode = %d\n", sqlca.sqlcode);
	ERRLOG(" sqlerrm.sqlerrml = %d\n", sqlca.sqlerrm.sqlerrml);
	ERRLOG(" sqlerrm.sqlerrmc = %s\n", sqlca.sqlerrm.sqlerrmc);
	ERRLOG(" sqlerrp = %s\n", sqlca.sqlerrp);
	ERRLOG(" sqlerrd = %d\n", sqlca.sqlerrd);
	ERRLOG(" sqlwarn = %s\n", sqlca.sqlwarn);
	ERRLOG(" sqlext = %s\n", sqlca.sqlext);
	ERRLOG("}\n");
	return 1;
}


int Add(const hash_t *hRls)
{
	char *csTmp;
	double dTmp;
	int iTmp;

	EXEC SQL WHENEVER SQLERROR GOTO add_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		short hv_return_value;

		varchar		hv_txn_id[PD_TXN_SEQ_LEN];
		varchar		hv_psp_id[PD_PSP_ID_LEN];
		varchar		hv_baid[PD_BAID_LEN];
		varchar		hv_txn_ccy[PD_CCY_ID_LEN];
		double		hv_txn_amount;
		varchar		hv_txn_date[PD_DATE_LEN];
		varchar		hv_txn_time[PD_TIME_LEN];
		varchar		hv_bank_code[PD_BANK_CODE_LEN];
		varchar		hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		double		hv_cost;
		double		hv_open_bal;
		double		hv_total_hold;
		double		hv_bal;
		double		hv_prepaid;
		double		hv_open_in_transit;
		double		hv_in_transit;
		double		hv_pending_fund;
		int		hv_txn_hold_ind;
		int		hv_sys_match_ind;
		varchar		hv_customer_text[PD_TFR_CUSTOMER_TEXT_LEN];
		varchar		hv_sender_name[PD_SENDER_NAME_LEN];
		varchar		hv_txn_ref_num[PD_TXN_REF_NUM_LEN];
		varchar		hv_add_user[PD_USER_LEN];

		short		ind_txn_id = -1;
		short		ind_psp_id = -1;
		short		ind_baid = -1;
		short		ind_txn_ccy = -1;
		short		ind_txn_amount = -1;
		short		ind_txn_date = -1;
		short		ind_txn_time = -1;
		short		ind_bank_code = -1;
		short		ind_bank_acct_num = -1;
		short		ind_cost = -1;
		short		ind_open_bal = -1;
		short		ind_total_hold = -1;
		short		ind_bal = -1;
		short		ind_prepaid = -1;
		short		ind_open_in_transit = -1;
		short		ind_in_transit = -1;
		short		ind_pending_fund = -1;
		short		ind_txn_hold_ind = -1;
		short		ind_sys_match_ind = -1;
		short		ind_customer_text = -1;
		short		ind_sender_name = -1;
		short		ind_txn_ref_num = -1;
		short		ind_add_user = -1;
	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));

// txn_seq
	if (GetField_CString(hRls, "txn_seq", &csTmp)) {
		hv_txn_id.len = strlen(csTmp);
		memcpy(hv_txn_id.arr, csTmp, hv_txn_id.len);
		ind_txn_id = 0;
DEBUGLOG(("Add: txn_id = [%.*s][%d]\n", hv_txn_id.len, hv_txn_id.arr, hv_txn_id.len));
	}

// psp_id
	if (GetField_CString(hRls, "psp_id", &csTmp)) {
		hv_psp_id.len = strlen(csTmp);
		memcpy(hv_psp_id.arr, csTmp, hv_psp_id.len);
		ind_psp_id = 0;
DEBUGLOG(("Add: psp_id = [%.*s][%d]\n", hv_psp_id.len, hv_psp_id.arr, hv_psp_id.len));
	}

// baid
	if (GetField_CString(hRls, "baid", &csTmp)) {
		hv_baid.len = strlen(csTmp);
		memcpy(hv_baid.arr, csTmp, hv_baid.len);
		ind_baid = 0;
DEBUGLOG(("Add: baid = [%.*s][%d]\n", hv_baid.len, hv_baid.arr, hv_baid.len));
	}

// txn_ccy
	if (GetField_CString(hRls, "txn_ccy", &csTmp)) {
		hv_txn_ccy.len = strlen(csTmp);
		memcpy(hv_txn_ccy.arr, csTmp, hv_txn_ccy.len);
		ind_txn_ccy = 0;
DEBUGLOG(("Add: txn_ccy = [%.*s][%d]\n", hv_txn_ccy.len, hv_txn_ccy.arr, hv_txn_ccy.len));
	}

// txn_amount
	if (GetField_Double(hRls, "txn_amount", &dTmp)) {
		hv_txn_amount = dTmp;
		ind_txn_amount = 0;
DEBUGLOG(("Add: txn_amount = [%f]\n", hv_txn_amount));
	}

// txn_date
	if (GetField_CString(hRls, "txn_date", &csTmp)) {
		hv_txn_date.len = strlen(csTmp);
		memcpy(hv_txn_date.arr, csTmp, hv_txn_date.len);
		ind_txn_date = 0;
DEBUGLOG(("Add: txn_date = [%.*s][%d]\n", hv_txn_date.len, hv_txn_date.arr, hv_txn_date.len));
	}

// txn_time
	if (GetField_CString(hRls, "txn_time", &csTmp)) {
		hv_txn_time.len = strlen(csTmp);
		memcpy(hv_txn_time.arr, csTmp, hv_txn_time.len);
		ind_txn_time = 0;
DEBUGLOG(("Add: txn_time = [%.*s][%d]\n", hv_txn_time.len, hv_txn_time.arr, hv_txn_time.len));
	}

// bank_code
	if (GetField_CString(hRls, "bank_code", &csTmp)) {
		hv_bank_code.len = strlen(csTmp);
		memcpy(hv_bank_code.arr, csTmp, hv_bank_code.len);
		ind_bank_code = 0;
DEBUGLOG(("Add: bank_code = [%.*s][%d]\n", hv_bank_code.len, hv_bank_code.arr, hv_bank_code.len));
	}

// bank_acct_num
	if (GetField_CString(hRls, "bank_acct_num", &csTmp)) {
		hv_bank_acct_num.len = strlen(csTmp);
		memcpy(hv_bank_acct_num.arr, csTmp, hv_bank_acct_num.len);
		ind_bank_acct_num = 0;
DEBUGLOG(("Add: bank_acct_num = [%.*s][%d]\n", hv_bank_acct_num.len, hv_bank_acct_num.arr, hv_bank_acct_num.len));
	}

// cost
	hv_cost = 0;
	ind_cost = 0;
	if (GetField_Double(hRls, "cost", &dTmp)) {
		hv_cost = dTmp;
DEBUGLOG(("Add: cost = [%f]\n", hv_cost));
	}

// open_bal
	hv_open_bal = 0;
	ind_open_bal = 0;
	if (GetField_Double(hRls, "open_bal", &dTmp)) {
		hv_open_bal = dTmp;
		ind_open_bal = 0;
DEBUGLOG(("Add: open_bal = [%f]\n", hv_open_bal));
	}

// total_hold
	hv_total_hold = 0;
	ind_total_hold = 0;
	if (GetField_Double(hRls, "total_hold", &dTmp)) {
		hv_total_hold = dTmp;
		ind_total_hold = 0;
DEBUGLOG(("Add: total_hold = [%f]\n", hv_total_hold));
	}

// bal
	hv_bal = 0;
	ind_bal = 0;
	if (GetField_Double(hRls, "bal", &dTmp)) {
		hv_bal = dTmp;
		ind_bal = 0;
DEBUGLOG(("Add: bal = [%f]\n", hv_bal));
	}

// prepaid
	hv_prepaid = 0;
	ind_prepaid = 0;
	if (GetField_Double(hRls, "prepaid", &dTmp)) {
		hv_prepaid = dTmp;
		ind_prepaid = 0;
DEBUGLOG(("Add: prepaid = [%f]\n", hv_prepaid));
	}

// open_in_transit
	hv_open_in_transit = 0;
	ind_open_in_transit = 0;
	if (GetField_Double(hRls, "open_in_transit", &dTmp)) {
		hv_open_in_transit = dTmp;
		ind_open_in_transit = 0;
DEBUGLOG(("Add: open_in_transit = [%f]\n", hv_open_in_transit));
	}

// in_transit
	hv_in_transit = 0;
	ind_in_transit = 0;
	if (GetField_Double(hRls, "in_transit", &dTmp)) {
		hv_in_transit = dTmp;
		ind_in_transit = 0;
DEBUGLOG(("Add: in_transit = [%f]\n", hv_in_transit));
	}

// pending_fund
	hv_pending_fund = 0;
	ind_pending_fund = 0;
	if (GetField_Double(hRls, "pending_fund", &dTmp)) {
		hv_pending_fund = dTmp;
		ind_pending_fund = 0;
DEBUGLOG(("Add: pending_fund = [%f]\n", hv_pending_fund));
	}

// txn_hold_ind
	hv_txn_hold_ind = 0;
	ind_txn_hold_ind = 0;
	if (GetField_Int(hRls, "txn_hold_ind", &iTmp)) {
		hv_txn_hold_ind = iTmp;
		ind_txn_hold_ind = 0;
DEBUGLOG(("Add: txn_hold_ind = [%d]\n", hv_txn_hold_ind));
	}


// sys_match_ind
	hv_sys_match_ind = 0;
	ind_sys_match_ind = 0;
	if (GetField_Int(hRls, "sys_match_ind", &iTmp)) {
		hv_sys_match_ind = iTmp;
		ind_sys_match_ind = 0;
DEBUGLOG(("Add: sys_match_ind = [%d]\n", hv_sys_match_ind));
	}

// customer_text
	if (GetField_CString(hRls, "customer_text", &csTmp)) {
		hv_customer_text.len = strlen(csTmp);
		memcpy(hv_customer_text.arr, csTmp, hv_customer_text.len);
		ind_customer_text = 0;
DEBUGLOG(("Add: customer_text = [%.*s][%d]\n", hv_customer_text.len, hv_customer_text.arr, hv_customer_text.len));
	}

// sender_name
	if (GetField_CString(hRls, "sender_name", &csTmp)) {
		hv_sender_name.len = strlen(csTmp);
		memcpy(hv_sender_name.arr, csTmp, hv_sender_name.len);
		ind_sender_name = 0;
DEBUGLOG(("Add: sender_name = [%.*s][%d]\n", hv_sender_name.len, hv_sender_name.arr, hv_sender_name.len));
	}

// txn_ref_num
	if (GetField_CString(hRls, "txn_ref_num", &csTmp)) {
		hv_txn_ref_num.len = strlen(csTmp);
		memcpy(hv_txn_ref_num.arr, csTmp, hv_txn_ref_num.len);
		ind_txn_ref_num = 0;
DEBUGLOG(("Add: txn_ref_num = [%.*s][%d]\n", hv_txn_ref_num.len, hv_txn_ref_num.arr, hv_txn_ref_num.len));
	}

// add_user
	if (GetField_CString(hRls, "add_user", &csTmp)) {
		hv_add_user.len = strlen(csTmp);
		memcpy(hv_add_user.arr, csTmp, hv_add_user.len);
		ind_add_user = 0;
DEBUGLOG(("Add: add_user = [%.*s]\n", hv_add_user.len, hv_add_user.arr));
	}

	FREE_ME(csTmp);

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_ol_txn_psp_detail_insert(
									:hv_txn_id:ind_txn_id,
									:hv_psp_id:ind_psp_id,
									:hv_baid:ind_baid,
									:hv_txn_ccy:ind_txn_ccy,
									:hv_txn_amount:ind_txn_amount,
									:hv_txn_date:ind_txn_date,
									:hv_txn_time:ind_txn_time,
									:hv_bank_code:ind_bank_code,
									:hv_bank_acct_num:ind_bank_acct_num,
									:hv_cost:ind_cost,
									:hv_open_bal:ind_open_bal,
									:hv_total_hold:ind_total_hold,
									:hv_bal:ind_bal,
									:hv_prepaid:ind_prepaid,
									:hv_open_in_transit:ind_open_in_transit,
									:hv_in_transit:ind_in_transit,
									:hv_pending_fund:ind_pending_fund,
									:hv_txn_hold_ind:ind_txn_hold_ind,
									:hv_sys_match_ind:ind_sys_match_ind,
									:hv_customer_text:ind_customer_text,
									:hv_sender_name:ind_sender_name,
									:hv_txn_ref_num:ind_txn_ref_num,
									:hv_add_user:ind_add_user,
									:hv_add_user:ind_add_user);
		END;
	END-EXEC;

DEBUGLOG(("Add: Ret = [%d]\n", hv_return_value));
	if (hv_return_value == SP_OK) {
DEBUGLOG(("Add: Normal Exit\n"));
		return PD_OK;
	}

	if (hv_return_value == SP_OTHER_ERR) {
ERRLOG("OLTxnPspDetail_Add: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
		TxnAbort();
		return PD_OTHER_ERR;
	}

	if (hv_return_value == SP_ERR) {
ERRLOG("OLTxnPspDetail_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
		TxnAbort();
		return PD_ERR;
	}

add_error:
DEBUGLOG(("add_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("OLTxnPspDetail_Add: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_INTERNAL_ERR TxnAbort\n"));
perr01("Add_oltxnpspdetail");
	TxnAbort();
	return PD_INTERNAL_ERR;
}


int Update(const hash_t *hRls)
{
	char *csTmp;
	char *csTmp2;
	double dTmp;
	int iTmp;
	char *csBuf;
	char *csTxnId;

	EXEC SQL WHENEVER SQLERROR GOTO update_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar hv_dynstmt[1024];
	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
	csBuf = (char*) malloc (128);
	strcpy((char*)hv_dynstmt.arr, "update ol_txn_psp_detail set otp_update_timestamp = sysdate");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

	GetField_CString(hRls, "txn_seq", &csTxnId);
DEBUGLOG(("Update: txn_id = [%s]\n", csTxnId));

// psp_id
	if (GetField_CString(hRls, "psp_id", &csTmp)) {
DEBUGLOG(("Update: psp_id = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", otp_psp_id = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// baid
	if (GetField_CString(hRls, "baid", &csTmp)) {
DEBUGLOG(("Update: baid = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", otp_baid = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// txn_ccy
	if (GetField_CString(hRls, "txn_ccy", &csTmp)) {
DEBUGLOG(("Update: txn_ccy = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", otp_txn_ccy = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// txn_amount
	if (GetField_Double(hRls, "txn_amount", &dTmp)) {
DEBUGLOG(("Update: txn_amt = [%lf]\n", dTmp));
		sprintf(csBuf, "%f", dTmp);
		strcat((char*)hv_dynstmt.arr, ", otp_txn_amount = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// txn_date
	if (GetField_CString(hRls, "txn_date", &csTmp)) {
DEBUGLOG(("Update: txn_date = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", otp_txn_date = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// txn_time
	if (GetField_CString(hRls, "txn_time", &csTmp)) {
DEBUGLOG(("Update: txn_time = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", otp_txn_time = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// txn_timestamp
	// if (GetField_CString(hRls, "txn_date", &csTmp) && GetField_CString(hRls, "txn_time", &csTmp2)) {
	if (GetField_CString(hRls, "txn_date", &csTmp)) {
DEBUGLOG(("Update: txn_timestamp = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", otp_txn_timestamp = to_date('");
		strcat((char*)hv_dynstmt.arr, csTmp);
		if (GetField_CString(hRls, "txn_time", &csTmp2)) {
DEBUGLOG(("Update: txn_timestamp = [%s%s]\n", csTmp, csTmp2));
			strcat((char*)hv_dynstmt.arr, csTmp2);
		}
		strcat((char*)hv_dynstmt.arr, "', 'yyyymmddhh24miss')");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// bank_code
	if (GetField_CString(hRls, "bank_code", &csTmp)) {
DEBUGLOG(("Update: bank_code = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", otp_bank_code = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// bank_acct_num
	if (GetField_CString(hRls, "bank_acct_num", &csTmp)) {
DEBUGLOG(("Update: bank_acct_num = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", otp_bank_acct_num = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// cost
	if (GetField_Double(hRls, "cost", &dTmp)) {
DEBUGLOG(("Update: cost = [%lf]\n", dTmp));
		sprintf(csBuf, "%f", dTmp);
		strcat((char*)hv_dynstmt.arr, ", otp_cost = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// open_bal
	if (GetField_Double(hRls, "open_bal", &dTmp)) {
DEBUGLOG(("Update: open_bal = [%lf]\n", dTmp));
		sprintf(csBuf, "%f", dTmp);
		strcat((char*)hv_dynstmt.arr, ", otp_open_bal = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// total_hold
	if (GetField_Double(hRls, "total_hold", &dTmp)) {
DEBUGLOG(("Update: total_hold = [%lf]\n", dTmp));
		sprintf(csBuf, "%f", dTmp);
		strcat((char*)hv_dynstmt.arr, ", otp_total_hold = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// bal
	if (GetField_Double(hRls, "bal", &dTmp)) {
DEBUGLOG(("Update: bal = [%lf]\n", dTmp));
		sprintf(csBuf, "%f", dTmp);
		strcat((char*)hv_dynstmt.arr, ", otp_bal = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// prepaid
	if (GetField_Double(hRls, "prepaid", &dTmp)) {
DEBUGLOG(("Update: prepaid = [%lf]\n", dTmp));
		sprintf(csBuf, "%f", dTmp);
		strcat((char*)hv_dynstmt.arr, ", otp_prepaid = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// open_in_transit
	if (GetField_Double(hRls, "open_in_transit", &dTmp)) {
DEBUGLOG(("Update: open_in_transit = [%lf]\n", dTmp));
		sprintf(csBuf, "%f", dTmp);
		strcat((char*)hv_dynstmt.arr, ", otp_open_in_transit = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// in_transit
	if (GetField_Double(hRls, "in_transit", &dTmp)) {
DEBUGLOG(("Update: in_transit = [%lf]\n", dTmp));
		sprintf(csBuf, "%f", dTmp);
		strcat((char*)hv_dynstmt.arr, ", otp_in_transit = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// pending_fund
	if (GetField_Double(hRls, "pending_fund", &dTmp)) {
DEBUGLOG(("Update: pending_fund = [%lf]\n", dTmp));
		sprintf(csBuf, "%f", dTmp);
		strcat((char*)hv_dynstmt.arr, ", otp_pending_fund = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// txn_hold_ind
	if (GetField_Int(hRls, "txn_hold_ind", &iTmp)) {
DEBUGLOG(("Update: txn_hold_ind = [%d]\n", iTmp));
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, ", otp_txn_hold_ind = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// sys_match_ind
	if (GetField_Int(hRls, "sys_match_ind", &iTmp)) {
DEBUGLOG(("Update: sys_match_ind = [%d]\n", iTmp));
		sprintf(csBuf, "%d", iTmp);
		strcat((char*)hv_dynstmt.arr, ", otp_sys_match_ind = ");
		strcat((char*)hv_dynstmt.arr, csBuf);
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// customer_text
	if (GetField_CString(hRls, "customer_text", &csTmp)) {
DEBUGLOG(("Update: customer_text = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", otp_customer_text = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// sender_name
	if (GetField_CString(hRls, "sender_name", &csTmp)) {
DEBUGLOG(("Update: sender_name = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", otp_sender_name = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// txn_ref_num
	if (GetField_CString(hRls, "txn_ref_num", &csTmp)) {
DEBUGLOG(("Update: txn_ref_num = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", otp_txn_ref_num = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

// update user
	if (GetField_CString(hRls, "update_user", &csTmp)) {
DEBUGLOG(("Update: update_user = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, ", otp_update_user = '");
		strcat((char*)hv_dynstmt.arr, csTmp);
		strcat((char*)hv_dynstmt.arr, "'");
		hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
	}

	strcat((char*)hv_dynstmt.arr, " where otp_txn_id = '");
	strcat((char*)hv_dynstmt.arr, csTxnId);
	strcat((char*)hv_dynstmt.arr, "'");
	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n", hv_dynstmt.len, hv_dynstmt.arr));

	EXEC SQL PREPARE PS FROM :hv_dynstmt;
	EXEC SQL EXECUTE PS;

	FREE_ME(csBuf);

DEBUGLOG(("Update Normal Exit\n"));
	return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("OLTxnPspDetail_Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
	TxnAbort();
	return PD_INTERNAL_ERR;
}


int GetTxnPspDetail(const char *csTxnID, hash_t *myHash)
{
	int iCnt=0;

	EXEC SQL WHENEVER SQLERROR GOTO gettxnpspdetail_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_txn_id[PD_TXN_SEQ_LEN];

		varchar		v_psp_id[PD_PSP_ID_LEN + 1];
		varchar		v_baid[PD_BAID_LEN + 1];
		varchar		v_txn_ccy[PD_CCY_ID_LEN + 1];
		double		v_txn_amount;
		varchar		v_txn_date[PD_DATE_LEN + 1];
		varchar		v_txn_time[PD_TIME_LEN + 1];
		varchar		v_txn_timestamp[PD_DATETIME_LEN + 1];
		varchar		v_bank_code[PD_BANK_CODE_LEN + 1];
		varchar		v_bank_acct_num[PD_BANK_ACCT_NUM_LEN + 1];
		double		v_cost;
		double		v_open_bal;
		double		v_total_hold;
		double		v_bal;
		double		v_prepaid;
		double		v_open_in_transit;
		double		v_in_transit;
		double		v_pending_fund;
		int		v_txn_hold_ind;
		int		v_sys_match_ind;
		varchar		v_customer_text[PD_TFR_CUSTOMER_TEXT_LEN + 1];
		varchar		v_sender_name[PD_SENDER_NAME_LEN + 1];
		varchar		v_txn_ref_num[PD_TXN_REF_NUM_LEN + 1];

		short		ind_psp_id = -1;
		short		ind_baid = -1;
		short		ind_txn_ccy = -1;
		short		ind_txn_amount = -1;
		short		ind_txn_date = -1;
		short		ind_txn_time = -1;
		short		ind_txn_timestamp = -1;
		short		ind_bank_code = -1;
		short		ind_bank_acct_num = -1;
		short		ind_cost = -1;
		short		ind_open_bal = -1;
		short		ind_total_hold = -1;
		short		ind_bal = -1;
		short		ind_prepaid = -1;
		short		ind_open_in_transit = -1;
		short		ind_in_transit = -1;
		short		ind_pending_fund = -1;
		short		ind_txn_hold_ind = -1;
		short		ind_sys_match_ind = -1;
		short		ind_customer_text = -1;
		short		ind_sender_name = -1;
		short		ind_txn_ref_num = -1;

	EXEC SQL END DECLARE SECTION;

	hv_txn_id.len = strlen(csTxnID);
	memcpy(hv_txn_id.arr, csTxnID, hv_txn_id.len);
DEBUGLOG(("GetTxnPspDetail txn_id = [%.*s]\n", hv_txn_id.len, hv_txn_id.arr));

	EXEC SQL DECLARE c_cursor_gettxnpspdetail CURSOR FOR
		select otp_psp_id,
				otp_baid,
				otp_txn_ccy,
				otp_txn_amount,
				otp_txn_date,
				otp_txn_time,
				to_char(otp_txn_timestamp, 'yyyymmddhh24miss'),
				otp_bank_code,
				otp_bank_acct_num,
				otp_cost,
				otp_open_bal,
				otp_total_hold,
				otp_bal,
				otp_prepaid,
				otp_open_in_transit,
				otp_in_transit,
				otp_pending_fund,
				otp_txn_hold_ind,
				otp_sys_match_ind,
				otp_customer_text,
				otp_sender_name,
				otp_txn_ref_num
		from ol_txn_psp_detail
		where otp_txn_id = :hv_txn_id;

	EXEC SQL OPEN c_cursor_gettxnpspdetail;
	do {
		EXEC SQL FETCH c_cursor_gettxnpspdetail
		INTO
			:v_psp_id:ind_psp_id,
			:v_baid:ind_baid,
			:v_txn_ccy:ind_txn_ccy,
			:v_txn_amount:ind_txn_amount,
			:v_txn_date:ind_txn_date,
			:v_txn_time:ind_txn_time,
			:v_txn_timestamp:ind_txn_timestamp,
			:v_bank_code:ind_bank_code,
			:v_bank_acct_num:ind_bank_acct_num,
			:v_cost:ind_cost,
			:v_open_bal:ind_open_bal,
			:v_total_hold:ind_total_hold,
			:v_bal:ind_bal,
			:v_prepaid:ind_prepaid,
			:v_open_in_transit:ind_open_in_transit,
			:v_in_transit:ind_in_transit,
			:v_pending_fund:ind_pending_fund,
			:v_txn_hold_ind:ind_txn_hold_ind,
			:v_sys_match_ind:ind_sys_match_ind,
			:v_customer_text:ind_customer_text,
			:v_sender_name:ind_sender_name,
			:v_txn_ref_num:ind_txn_ref_num;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		iCnt++;

// psp_id
		if (ind_psp_id >= 0) {
			v_psp_id.arr[v_psp_id.len] = '\0';
			PutField_CString(myHash, "psp_id", (const char*)v_psp_id.arr);
DEBUGLOG(("GetTxnPspDetail psp_id = [%s]\n", v_psp_id.arr));
		}

// baid
		if (ind_baid >= 0) {
			v_baid.arr[v_baid.len] = '\0';
			PutField_CString(myHash, "baid", (const char*)v_baid.arr);
DEBUGLOG(("GetTxnPspDetail baid = [%s]\n", v_baid.arr));
		}

// txn_ccy
		if (ind_txn_ccy >= 0) {
			v_txn_ccy.arr[v_txn_ccy.len] = '\0';
			PutField_CString(myHash, "txn_ccy", (const char*)v_txn_ccy.arr);
DEBUGLOG(("GetTxnPspDetail txn_ccy = [%s]\n", v_txn_ccy.arr));
		}

// txn_amount
		if (ind_txn_amount >= 0) {
			PutField_Double(myHash, "txn_amount", v_txn_amount);
DEBUGLOG(("GetTxnPspDetail txn_amount = [%f]\n", v_txn_amount));
		}

// txn_date
		if (ind_txn_date >= 0) {
			v_txn_date.arr[v_txn_date.len] = '\0';
			PutField_CString(myHash, "txn_date", (const char*)v_txn_date.arr);
DEBUGLOG(("GetTxnPspDetail txn_date = [%s]\n", v_txn_date.arr));
		}

// txn_time
		if (ind_txn_time >= 0) {
			v_txn_time.arr[v_txn_time.len] = '\0';
			PutField_CString(myHash, "txn_time", (const char*)v_txn_time.arr);
DEBUGLOG(("GetTxnPspDetail txn_time = [%s]\n", v_txn_time.arr));
		}

// txn_timestamp
		if (ind_txn_timestamp >= 0) {
			v_txn_timestamp.arr[v_txn_timestamp.len] = '\0';
			PutField_CString(myHash, "txn_timestamp", (const char*)v_txn_timestamp.arr);
DEBUGLOG(("GetTxnPspDetail txn_timestamp = [%s]\n", v_txn_timestamp.arr));
		}

// bank_code
		if (ind_bank_code >= 0) {
			v_bank_code.arr[v_bank_code.len] = '\0';
			PutField_CString(myHash, "bank_code", (const char*)v_bank_code.arr);
DEBUGLOG(("GetTxnPspDetail bank_code = [%s]\n", v_bank_code.arr));
		}

// bank_acct_num
		if (ind_bank_acct_num >= 0) {
			v_bank_acct_num.arr[v_bank_acct_num.len] = '\0';
			PutField_CString(myHash, "bank_acct_num", (const char*)v_bank_acct_num.arr);
DEBUGLOG(("GetTxnPspDetail bank_acct_num = [%s]\n", v_bank_acct_num.arr));
		}

// cost
		if (ind_cost >= 0) {
			PutField_Double(myHash, "cost", v_cost);
DEBUGLOG(("GetTxnPspDetail cost = [%f]\n", v_cost));
		}

// open_bal
		if (ind_open_bal >= 0) {
			PutField_Double(myHash, "open_bal", v_open_bal);
DEBUGLOG(("GetTxnPspDetail open_bal = [%f]\n", v_open_bal));
		}

// total_hold
		if (ind_total_hold >= 0) {
			PutField_Double(myHash, "total_hold", v_total_hold);
DEBUGLOG(("GetTxnPspDetail total_hold = [%f]\n", v_total_hold));
		}

// bal
		if (ind_bal >= 0) {
			PutField_Double(myHash, "bal", v_bal);
DEBUGLOG(("GetTxnPspDetail bal = [%f]\n", v_bal));
		}

// prepaid
		if (ind_prepaid >= 0) {
			PutField_Double(myHash, "prepaid", v_prepaid);
DEBUGLOG(("GetTxnPspDetail prepaid = [%f]\n", v_prepaid));
		}

// open_in_transit
		if (ind_open_in_transit >= 0) {
			PutField_Double(myHash, "open_in_transit", v_open_in_transit);
DEBUGLOG(("GetTxnPspDetail open_in_transit = [%f]\n", v_open_in_transit));
		}

// in_transit
		if (ind_in_transit >= 0) {
			PutField_Double(myHash, "in_transit", v_in_transit);
DEBUGLOG(("GetTxnPspDetail in_transit = [%f]\n", v_in_transit));
		}

// pending_fund
		if (ind_pending_fund >= 0) {
			PutField_Double(myHash, "pending_fund", v_pending_fund);
DEBUGLOG(("GetTxnPspDetail pending_fund = [%f]\n", v_pending_fund));
		}

// txn_hold_ind
		if (ind_txn_hold_ind >= 0) {
			PutField_Int(myHash, "txn_hold_ind", v_txn_hold_ind);
DEBUGLOG(("GetTxnPspDetail txn_hold_ind = [%d]\n", v_txn_hold_ind));
		}

// sys_match_ind
		if (ind_sys_match_ind >= 0) {
			PutField_Int(myHash, "sys_match_ind", v_sys_match_ind);
DEBUGLOG(("GetTxnPspDetail sys_match_ind = [%d]\n", v_sys_match_ind));
		}

// customer_text
		if (ind_customer_text >= 0) {
			v_customer_text.arr[v_customer_text.len] = '\0';
			PutField_CString(myHash, "customer_text", (const char*)v_customer_text.arr);
DEBUGLOG(("GetTxnPspDetail customer_text = [%s]\n", v_customer_text.arr));
		}

// sender_name
		if (ind_sender_name >= 0) {
			v_sender_name.arr[v_sender_name.len] = '\0';
			PutField_CString(myHash, "sender_name", (const char*)v_sender_name.arr);
DEBUGLOG(("GetTxnPspDetail sender_name = [%s]\n", v_sender_name.arr));
		}

// txn_ref_num
		if (ind_txn_ref_num >= 0) {
			v_txn_ref_num.arr[v_txn_ref_num.len] = '\0';
			PutField_CString(myHash, "txn_ref_num", (const char*)v_txn_ref_num.arr);
DEBUGLOG(("GetTxnPspDetail txn_ref_num = [%s]\n", v_txn_ref_num.arr));
		}
	}
	while (PD_TRUE);

	EXEC SQL CLOSE c_cursor_gettxnpspdetail;

	if (iCnt>0) {
DEBUGLOG(("GetTxnPspDetail Normal Exit\n"));
		return PD_OK;
	} else {
DEBUGLOG(("GetTxnPspDetail NOT FOUND!!!\n"));
		return PD_ERR;
	}

gettxnpspdetail_error:
DEBUGLOG(("gettxnpspdetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_gettxnpspdetail;
	return PD_ERR;
}


int GetDepositTxnToHold(hash_t *myHash)
{
	int iRet = PD_OK;
	char *csTmp;
	double dTmp;

	EXEC SQL WHENEVER SQLERROR GOTO gettxntohold_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_stat_txn_id[PD_TXN_SEQ_LEN + 1];
		varchar		hv_txn_ccy[PD_CCY_ID_LEN];
		double		hv_txn_amount;
		varchar		hv_txn_date[PD_DATE_LEN];
		varchar		hv_txn_time[PD_TIME_LEN];
		varchar		hv_bank_code[PD_BANK_CODE_LEN];
		varchar		hv_bank_acct_num[PD_BANK_ACCT_NUM_LEN];
		varchar		v_txn_id[PD_TXN_SEQ_LEN + 1];

		short		ind_stat_txn_id = -1;
		short		ind_txn_ccy = -1;
		short		ind_txn_amount = -1;
		short		ind_txn_date = -1;
		short		ind_txn_time = -1;
		short		ind_bank_code = -1;
		short		ind_bank_acct_num = -1;
		short		ind_txn_id = -1;

		short		hv_return_value;

	EXEC SQL END DECLARE SECTION;

	if (GetField_CString(myHash,"stat_txn_id",&csTmp)) {
		hv_stat_txn_id.len = strlen(csTmp);
		memcpy(hv_stat_txn_id.arr, csTmp, hv_stat_txn_id.len);
		ind_stat_txn_id = 0;
DEBUGLOG(("GetTransactionToHold stat_txn_id = [%.*s]\n", hv_stat_txn_id.len, hv_stat_txn_id.arr));
	} else {
		iRet = PD_ERR;
DEBUGLOG(("GetTransactionToHold stat_txn_id NOT FOUND!!!\n"));
	}

	if (GetField_CString(myHash,"txn_ccy",&csTmp)) {
		hv_txn_ccy.len = strlen(csTmp);
		memcpy(hv_txn_ccy.arr, csTmp, hv_txn_ccy.len);
		ind_txn_ccy = 0;
DEBUGLOG(("GetTransactionToHold txn_ccy = [%.*s]\n", hv_txn_ccy.len, hv_txn_ccy.arr));
	} else {
		iRet = PD_ERR;
DEBUGLOG(("GetTransactionToHold txn_ccy NOT FOUND!!!\n"));
	}

	if (GetField_Double(myHash,"txn_amount",&dTmp)) {
		hv_txn_amount = dTmp;
		ind_txn_amount = 0;
DEBUGLOG(("GetTransactionToHold txn_amount = [%.2lf]\n", hv_txn_amount));
	} else {
		iRet = PD_ERR;
DEBUGLOG(("GetTransactionToHold txn_amount NOT FOUND!!!\n"));
	}

	if (GetField_CString(myHash,"txn_date",&csTmp)) {
		hv_txn_date.len = strlen(csTmp);
		memcpy(hv_txn_date.arr, csTmp, hv_txn_date.len);
		ind_txn_date = 0;
DEBUGLOG(("GetTransactionToHold txn_date = [%.*s]\n", hv_txn_date.len, hv_txn_date.arr));
	} else {
		iRet = PD_ERR;
DEBUGLOG(("GetTransactionToHold txn_date NOT FOUND!!!\n"));
	}

	if (GetField_CString(myHash,"txn_time",&csTmp)) {
		hv_txn_time.len = strlen(csTmp);
		memcpy(hv_txn_time.arr, csTmp, hv_txn_time.len);
		ind_txn_time = 0;
DEBUGLOG(("GetTransactionToHold txn_time = [%.*s]\n", hv_txn_time.len, hv_txn_time.arr));
	} else {
		iRet = PD_ERR;
DEBUGLOG(("GetTransactionToHold txn_time NOT FOUND!!!\n"));
	}

	if (GetField_CString(myHash,"bank_code",&csTmp)) {
		hv_bank_code.len = strlen(csTmp);
		memcpy(hv_bank_code.arr, csTmp, hv_bank_code.len);
		ind_bank_code = 0;
DEBUGLOG(("GetTransactionToHold bank_code = [%.*s]\n", hv_bank_code.len, hv_bank_code.arr));
	} else {
		iRet = PD_ERR;
DEBUGLOG(("GetTransactionToHold bank_code NOT FOUND!!!\n"));
	}

	if (GetField_CString(myHash,"bank_acct_num",&csTmp)) {
		hv_bank_acct_num.len = strlen(csTmp);
		memcpy(hv_bank_acct_num.arr, csTmp, hv_bank_acct_num.len);
		ind_bank_acct_num = 0;
DEBUGLOG(("GetTransactionToHold bank_acct_num = [%.*s]\n", hv_bank_acct_num.len, hv_bank_acct_num.arr));
	} else {
		iRet = PD_ERR;
DEBUGLOG(("GetTransactionToHold bank_acct_num NOT FOUND!!!\n"));
	}

	if (iRet == PD_OK) {
		EXEC SQL EXECUTE
			BEGIN
				:hv_return_value := sp_ol_txn_deposit_hold(
							:hv_stat_txn_id:ind_stat_txn_id,
							:hv_txn_ccy:ind_txn_ccy,
							:hv_txn_amount:ind_txn_amount,
							:hv_txn_date:ind_txn_date,
							:hv_txn_time:ind_txn_time,
							:hv_bank_code:ind_bank_code,
							:hv_bank_acct_num:ind_bank_acct_num,
							:v_txn_id:ind_txn_id);
			END;
		END-EXEC;

		if (hv_return_value == SP_OK) {
			if (ind_txn_id >= 0) {
				v_txn_id.arr[v_txn_id.len] = '\0';
				PutField_CString(myHash,"txn_id",(char*)v_txn_id.arr);
				iRet = PD_OK;
DEBUGLOG(("GetTransactionToHold Found txn_id = [%s], Normal Exit\n",(char*)v_txn_id.arr));
			} else {
				iRet = PD_OK;
DEBUGLOG(("GetTransactionToHold Not Found, Normal Exit\n"));
			}
		} else {
DEBUGLOG(("GetTransactionToHold Ret = [%d] FAILURE!!!\n",hv_return_value));
			iRet = PD_ERR;
		}
	}

	return iRet;

gettxntohold_error:
DEBUGLOG(("gettxntohold_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}

