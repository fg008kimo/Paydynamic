CREATE OR REPLACE FUNCTION sp_ol_txn_deposit_hold (
   in_txn_ccy             ol_txn_psp_detail.otp_txn_ccy%TYPE,
   in_txn_amount          ol_txn_psp_detail.otp_txn_amount%TYPE,
   in_txn_date            ol_txn_psp_detail.otp_txn_date%TYPE,
   in_txn_time            ol_txn_psp_detail.otp_txn_time%TYPE,
   in_bank_code           ol_txn_psp_detail.otp_bank_code%TYPE,
   in_bank_acct_num       ol_txn_psp_detail.otp_bank_acct_num%TYPE,
   in_remark              ol_txn_deposit_hold_log.otdh_remark%TYPE,
   out_txn_id         OUT ol_txn_psp_detail.otp_txn_id%TYPE)
   RETURN NUMBER
IS
   hold_range   NUMBER := 0;
   iCnt         INTEGER := 0;
BEGIN
   SELECT to_number(SP_VAL,'9999.99')
     INTO hold_range
     FROM SYSTEM_PARAMETER
    WHERE SP_CODE = 'OFL_AUTO_HOLD_RANGE';

     SELECT COUNT (*)
       INTO iCnt
       FROM OL_TXN_PSP_DETAIL
      WHERE     otp_txn_ccy = in_txn_ccy
            AND otp_txn_amount = in_txn_amount
            AND otp_txn_timestamp >=
                     TO_DATE (in_txn_date || in_txn_time, 'YYYYMMDDHH24MISS')
                   - hold_range / 24
            AND otp_txn_timestamp <=
                   TO_DATE (in_txn_date || in_txn_time, 'YYYYMMDDHH24MISS')
            AND otp_bank_code = in_bank_code
            AND otp_bank_acct_num = in_bank_acct_num
            AND otp_txn_hold_ind = 0
            AND EXISTS
                   (SELECT oth_txn_id
                      FROM OL_TXN_HEADER
                     WHERE     oth_txn_id = otp_txn_id
                           AND oth_txn_code = 'OBD'
                           AND oth_status = 'C'
                           AND oth_ar_ind = 'A'
                           AND oth_sub_status IN (139))
   ORDER BY otp_txn_id DESC;

   IF iCnt > 0
   THEN
      SELECT otp_txn_id
        INTO out_txn_id
        FROM (  SELECT otp_txn_id
                  FROM OL_TXN_PSP_DETAIL
                 WHERE     otp_txn_ccy = in_txn_ccy
                       AND otp_txn_amount = in_txn_amount
                       AND otp_txn_timestamp >=
                                TO_DATE (in_txn_date || in_txn_time,
                                         'YYYYMMDDHH24MISS')
                              - hold_range / 24
                       AND otp_txn_timestamp <=
                              TO_DATE (in_txn_date || in_txn_time,
                                       'YYYYMMDDHH24MISS')
                       AND otp_bank_code = in_bank_code
                       AND otp_bank_acct_num = in_bank_acct_num
                       AND otp_txn_hold_ind = 0
                       AND EXISTS
                              (SELECT oth_txn_id
                                 FROM OL_TXN_HEADER
                                WHERE     oth_txn_id = otp_txn_id
                                      AND oth_txn_code = 'OBD'
                                      AND oth_status = 'C'
                                      AND oth_ar_ind = 'A'
                                      AND oth_sub_status IN (139))
              ORDER BY otp_txn_id DESC)
       WHERE ROWNUM = 1;

      UPDATE OL_TXN_PSP_DETAIL
         SET OTP_UPDATE_USER = 'SYSTEM',
             OTP_UPDATE_TIMESTAMP = SYSDATE,
             OTP_TXN_HOLD_IND = 1
       WHERE OTP_TXN_ID = out_txn_id;

      IF SQL%ROWCOUNT = 0
      THEN
         RETURN 1;
      END IF;
   END IF;

   RETURN 0;
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN 9;
END sp_ol_txn_deposit_hold;
/

