CREATE OR REPLACE FUNCTION sp_ol_txn_deposit_hold (
   in_txn_ccy             ol_txn_psp_detail.otp_txn_ccy%TYPE,
   in_txn_amount          ol_txn_psp_detail.otp_txn_amount%TYPE,
   in_txn_date            ol_txn_psp_detail.otp_txn_date%TYPE,
   in_txn_time            ol_txn_psp_detail.otp_txn_time%TYPE,
   in_bank_code           ol_txn_psp_detail.otp_bank_code%TYPE,
   in_bank_acct_num       ol_txn_psp_detail.otp_bank_acct_num%TYPE,
   out_txn_id         OUT ol_txn_psp_detail.otp_txn_id%TYPE)
   RETURN NUMBER
IS
BEGIN
   FOR RESULT
      IN (  SELECT otp_txn_id
              FROM OL_TXN_PSP_DETAIL
             WHERE     otp_txn_ccy = in_txn_ccy
                   AND otp_txn_amount = in_txn_amount
                   AND otp_txn_timestamp >=
                            TO_DATE (in_txn_date || in_txn_time,
                                     'YYYYMMDDHH24MISS')
                          -   (SELECT TO_NUMBER (SP_VAL)
                                 FROM SYSTEM_PARAMETER
                                WHERE SP_CODE = 'OFL_AUTO_HOLD_RANGE')
                            / 24
                   AND otp_txn_timestamp <=
                          TO_DATE (in_txn_date || in_txn_time,
                                   'YYYYMMDDHH24MISS')
                   AND otp_bank_code = in_bank_code
                   AND otp_bank_acct_num = in_bank_acct_num
                   AND otp_txn_hold_ind = 0
                   AND EXISTS
                          (SELECT oth_txn_id
                             FROM OL_TXN_HEADER
                            WHERE     oth_txn_id = otp_txn_id
                                  AND oth_txn_code = 'OBD'
                                  AND oth_status = 'C'
                                  AND oth_ar_ind = 'A'
                                  AND oth_sub_status IN ('139'))
          ORDER BY otp_txn_id DESC)
   LOOP
      UPDATE OL_TXN_PSP_DETAIL
         SET OTP_UPDATE_USER = 'SYSTEM',
             OTP_UPDATE_TIMESTAMP = SYSDATE,
             OTP_TXN_HOLD_IND = 1
       WHERE     OTP_TXN_ID = RESULT.otp_txn_id
             AND EXISTS
                    (SELECT oth_txn_id
                       FROM OL_TXN_HEADER
                      WHERE     oth_txn_id = RESULT.otp_txn_id
                            AND oth_txn_code = 'OBD'
                            AND oth_status = 'C'
                            AND oth_ar_ind = 'A'
                            AND oth_sub_status IN ('139'));

      IF SQL%ROWCOUNT = 1
      THEN
         out_txn_id := RESULT.otp_txn_id;
         RETURN 0;
      END IF;
   END LOOP;

   RETURN 0;
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN 9;
END sp_ol_txn_deposit_hold;
/

