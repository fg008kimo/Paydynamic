CREATE OR REPLACE FUNCTION sp_ol_merch_upload_dt_rand_rec(
  in_merchant_id		ol_merchant_upload_file_header.ouh_merchant_id%type,
  in_batch_id_list		VARCHAR2,
  in_bank_name			ol_merchant_upload_file_detail.oud_bank_name%type,
  in_status			ol_merchant_upload_file_detail.oud_status%type,
  in_batch_mode			ol_merchant_upload_file_detail.oud_batch_mode%type,
  in_payout_ccy			ol_merchant_upload_file_detail.oud_payout_currency%type,
  in_merch_grp                  ol_merchant_upload_file_detail.oud_merchant_payout_grp%type,
  in_psp_grp                    ol_merchant_upload_file_detail.oud_psp_payout_grp%type,
  in_pregen_id			ol_payout_generated_tmp.opt_id%type,
  in_psp_id			ol_psp_detail.opd_psp_id%type,
  out_cursor		out	sys_refcursor)

RETURN NUMBER Is
	iCnt	integer := 0;

Begin
	select count(oud_txn_id)
	  into	iCnt
	  from	ol_merchant_upload_file_detail,
		ol_merchant_upload_file_header
	  where oud_batch_id = ouh_batch_id
	  and   (oud_batch_id in (SELECT REGEXP_SUBSTR (in_batch_id_list,'[^,]+',1,LEVEL) token
		FROM DUAL CONNECT BY LEVEL <= LENGTH (in_batch_id_list)- LENGTH (REPLACE(in_batch_id_list,',',''))+ 1)
		or in_batch_id_list is NULL)
	  and	(oud_bank_name like in_bank_name or in_bank_name is NULL)
	  and	(select oud_bank_name from
		   (select '%' || re_bank_name || '%' as bname
		    from rule_payout_exclude,
			 ol_psp_detail
		    where re_psp_client_id = opd_client_id
		    and opd_psp_id = in_psp_id
		    and re_disabled = 0
		   )
		where oud_bank_name like bname) is null
	  and	(ouh_merchant_id = in_merchant_id or in_merchant_id is NULL)
	  and	ouh_disabled=0
	  and	oud_disabled=0
	  and	oud_status = in_status 
	  and	oud_batch_mode = in_batch_mode
	  and   oud_payout_currency = in_payout_ccy
	  and   (oud_psp_payout_grp = in_psp_grp or in_psp_grp is NULL)
          and   (oud_merchant_payout_grp = in_merch_grp or in_merch_grp is NULL)
	  and	oud_txn_id not in (select opt_txn_id from ol_payout_generated_tmp where opt_id = in_pregen_id);

	if iCnt > 0 THEN
		OPEN out_cursor for
		select	
			oud_txn_id,
                        oud_payout_amount
		from	(SELECT 
				oud_txn_id,
				oud_batch_id,
				oud_payout_amount
 			 FROM ol_merchant_upload_file_detail
			 where (oud_bank_name like in_bank_name or in_bank_name is NULL)
			 and	(select oud_bank_name from
				 (select '%' || re_bank_name || '%' as bname
				  from rule_payout_exclude,
				  ol_psp_detail
				  where re_psp_client_id = opd_client_id
				  and opd_psp_id = in_psp_id
				  and re_disabled = 0
				 )
				 where oud_bank_name like bname) is null
			 and   oud_disabled=0
			 and   (oud_batch_id in (SELECT REGEXP_SUBSTR (in_batch_id_list,'[^,]+',1,LEVEL) token
				FROM DUAL CONNECT BY LEVEL <= LENGTH (in_batch_id_list)- LENGTH (REPLACE(in_batch_id_list,',',''))+ 1)
				or in_batch_id_list is NULL)
			 and   oud_status = in_status
			 and   oud_batch_mode = in_batch_mode
			 and   oud_payout_currency = in_payout_ccy
			 and   (oud_psp_payout_grp = in_psp_grp or in_psp_grp is NULL)
			 and   (oud_merchant_payout_grp = in_merch_grp or in_merch_grp is NULL)
			 and   oud_txn_id not in (select opt_txn_id from ol_payout_generated_tmp where opt_id = in_pregen_id)
			 ORDER BY dbms_random.value),
			ol_merchant_upload_file_header
	  	where	oud_batch_id = ouh_batch_id
		and   (ouh_merchant_id = in_merchant_id or in_merchant_id is NULL)
		and   ouh_disabled=0
		for update;

		return 1;
	end if;

	return 0;

exception
   WHEN OTHERS THEN
     RETURN 0;
END sp_ol_merch_upload_dt_rand_rec;
/
