/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission 
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/06/25              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <sqlca.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "internal.h"
#include "MmsAdjustmentTypeEntity.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


char    cDebug;

void MmsAdjustmentTypeEntity(char    cdebug)
{
        cDebug = cdebug;
}


int Add(const hash_t *hRls)
{
	int	iTmp;

	char	*csTmp;

	EXEC SQL WHENEVER SQLERROR GOTO sync_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_adj_code[PD_MMS_ADJ_CODE_LEN];
		varchar		hv_adj_entity_type[PD_MMS_ADJ_ENTITY_TYPE_LEN];
		int             hv_disabled;
		varchar		hv_create_user[PD_USER_LEN];

		short		ind_adj_code = -1;
		short		ind_adj_entity_type = -1;
		short		ind_disabled = -1;
		short		ind_create_user = -1;
	
		short		hv_return_value;	
		
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Add: Begin\n"));

/* adj_code */
        if(GetField_CString(hRls,"adj_code",&csTmp)) {
                hv_adj_code.len = strlen(csTmp);
                strncpy((char*)hv_adj_code.arr, csTmp, hv_adj_code.len);
                ind_adj_code = 0;
DEBUGLOG(("Add:adj_code = [%.*s]\n",hv_adj_code.len, hv_adj_code.arr));
        }

/* adj_entity_type */
        if(GetField_CString(hRls,"adj_entity_type",&csTmp)) {
                hv_adj_entity_type.len = strlen(csTmp);
                strncpy((char*)hv_adj_entity_type.arr, csTmp, hv_adj_entity_type.len);
                ind_adj_entity_type = 0;
DEBUGLOG(("Add:adj_entity_type = [%.*s]\n",hv_adj_entity_type.len, hv_adj_entity_type.arr));
        }

/* disabled */
	if(GetField_Int(hRls, "disabled", &iTmp)) {
                hv_disabled = iTmp;
                ind_disabled = 0;
DEBUGLOG(("Add:disabled = [%d]\n",hv_disabled));
        }

/* create_user */
        if(GetField_CString(hRls,"create_user",&csTmp)) {
                hv_create_user.len = strlen(csTmp);
                strncpy((char*)hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
        }
DEBUGLOG(("Add:create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_mms_adj_type_entity_insert(
								:hv_adj_code:ind_adj_code,
								:hv_adj_entity_type:ind_adj_entity_type,
								:hv_disabled:ind_disabled,
								:hv_create_user:ind_create_user); 
		END;
	END-EXEC;

DEBUGLOG(("Add:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("Add:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("MmsAdjustmentTypeEntity_Add: SP_OTHER_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_OTHER_ERR TxnAbort\n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("MmsAdjustmentTypeEntity_Add: SP_ERR TxnAbort\n");
DEBUGLOG(("Add: SP_ERR TxnAbort\n"));
                return PD_ERR;
        }

sync_error:
DEBUGLOG(("sync_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MmsAdjustmentTypeEntity_Add: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int Update(const hash_t *hRls)
{
	int	iTmp;	

	char	*csTmp;
	char    *csBuf;

        EXEC SQL WHENEVER SQLERROR GOTO update_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                varchar        hv_dynstmt[PD_TMP_MSG_BUF_LEN];

		varchar hv_adj_code[PD_MMS_ADJ_CODE_LEN];
		varchar hv_adj_entity_type[PD_MMS_ADJ_ENTITY_TYPE_LEN];

		short ind_adj_code = -1;
		short ind_adj_entity_type = -1;

        EXEC SQL END DECLARE SECTION;

	csBuf = (char*) malloc (PD_TMP_BUF_LEN + 1);

DEBUGLOG(("Update: Begin\n"));

        strcpy((char*)hv_dynstmt.arr,"update mms_adjustment_type_entity set mae_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

/* disabled */
        if (GetField_Int(hRls,"disabled",&iTmp)) {
DEBUGLOG(("Update:update_disabled = [%d]\n",iTmp));
		sprintf(csBuf,"%d",iTmp);
                strcat((char*)hv_dynstmt.arr, ",mae_disabled = ");
                strcat((char*)hv_dynstmt.arr, csBuf);
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/*update_user*/
        if (GetField_CString(hRls,"update_user",&csTmp)) {
DEBUGLOG(("Update:update_user = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",mae_update_user = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

/* Primary Key: adj_code */
        if (GetField_CString(hRls,"adj_code",&csTmp)) {
DEBUGLOG(("Update: adj_code = [%s]\n", csTmp));
		strcat((char*)hv_dynstmt.arr, " WHERE mae_code = '");
        	strcat((char*)hv_dynstmt.arr, csTmp);
       		strcat((char*)hv_dynstmt.arr, "'");
        	hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

		hv_adj_code.len = strlen(csTmp);
		strncpy((char*)hv_adj_code.arr, csTmp, hv_adj_code.len);
		ind_adj_code = 0;
	}

/* Primary Key: adj_entity_type */
      	if (GetField_CString(hRls,"adj_entity_type",&csTmp)) {
DEBUGLOG(("Update: adj_entity_type = [%s]\n", csTmp));
        	strcat((char*)hv_dynstmt.arr, " AND mae_entity_type = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

		hv_adj_entity_type.len = strlen(csTmp);
                strncpy((char*)hv_adj_entity_type.arr, csTmp, hv_adj_entity_type.len);
                ind_adj_entity_type = 0;
	}

DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

DEBUGLOG(("Update Normal Exit\n"));
        return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("MmsAdjustmentTypeEntity:Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
        return PD_INTERNAL_ERR;
}

int Find(hash_t* hRls)
{
        int     iRet = PD_NOT_FOUND;

	char*	csTmp;

        EXEC SQL WHENEVER SQLERROR GOTO find_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_adj_code[PD_MMS_ADJ_CODE_LEN + 1];
                varchar         hv_adj_entity_type[PD_MMS_ADJ_ENTITY_TYPE_LEN + 1];

		int             v_disabled;	
        
		short 		ind_disabled = -1;
	EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Find()\n"));

/* adj_code */
        if (GetField_CString(hRls,"adj_code",&csTmp)) {
                hv_adj_code.len = strlen(csTmp);
                strncpy((char*)hv_adj_code.arr, csTmp, hv_adj_code.len);
DEBUGLOG(("Find: adj_code = [%.*s]\n", hv_adj_code.len, hv_adj_code.arr));
        }

/* adj_entity_type */
	if (GetField_CString(hRls,"adj_entity_type",&csTmp)) {
                hv_adj_entity_type.len = strlen(csTmp);
                strncpy((char*)hv_adj_entity_type.arr, csTmp, hv_adj_entity_type.len);
DEBUGLOG(("Find: adj_entity_type = [%.*s]\n", hv_adj_entity_type.len, hv_adj_entity_type.arr));
        }

        EXEC SQL	SELECT mae_disabled
			  INTO :v_disabled:ind_disabled	
	          	  FROM mms_adjustment_type_entity
		 	 WHERE mae_code = :hv_adj_code
		   	   AND mae_entity_type = :hv_adj_entity_type;

/* disabled */
       	if (ind_disabled >= 0 ) {
		PutField_Int(hRls,"disabled",v_disabled);
DEBUGLOG(("Find: disabled = [%d]\n",v_disabled));
		iRet = PD_FOUND;
     	}

DEBUGLOG(("Find: Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

find_error:
DEBUGLOG(("find_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MmsAdjustmentTypeEntity find_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

int FindEntityType(const hash_t* hRls, recordset_t* rRecordSet)
{
	int 	iRet = PD_NOT_FOUND;

	int	iCnt;

	char*	csTmp;
        
	hash_t *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO findentitytype_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_adj_code[PD_MMS_ADJ_CODE_LEN + 1];

                varchar         v_adj_entity_type[PD_MMS_ADJ_ENTITY_TYPE_LEN + 1];
                short           ind_adj_entity_type = -1;
        EXEC SQL END DECLARE SECTION;

/* adj_code */
	if (GetField_CString(hRls,"adj_code",&csTmp)) {
        	hv_adj_code.len = strlen(csTmp);
        	strncpy((char*)hv_adj_code.arr, csTmp, hv_adj_code.len);
DEBUGLOG(("FindEntityType adj_code = [%s]\n",(char*)hv_adj_code.arr));
	}

	EXEC SQL DECLARE c_cursor_findentitytype CURSOR FOR
                SELECT  mae_entity_type
                FROM    mms_adjustment_type_entity
                WHERE   mae_code = :hv_adj_code;
        EXEC SQL OPEN c_cursor_findentitytype;

	for (;;) {
                EXEC SQL FETCH c_cursor_findentitytype
                INTO    :v_adj_entity_type:ind_adj_entity_type;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

		iCnt++;

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash, 0);

		// adj_entity_type
		if (ind_adj_entity_type >= 0) {
                        v_adj_entity_type.arr[v_adj_entity_type.len] = '\0';
                        PutField_CString(myHash, "adj_entity_type", (const char*)v_adj_entity_type.arr);
DEBUGLOG(("FindEntityType: adj_entity_type = [%s]\n", (const char*)v_adj_entity_type.arr));
                }

                RecordSet_Add(rRecordSet, myHash);	
	}
	EXEC SQL CLOSE c_cursor_findentitytype;

	if (iCnt > 0) {
                iRet = PD_FOUND;
DEBUGLOG(("FindEntityType FOUND\n"));
        } else {
DEBUGLOG(("FindEntityType NOT FOUND!!!\n"));
        }

DEBUGLOG(("FindEntityType: Normal Exit! iRet = [%d]\n", iRet));
        return iRet;

findentitytype_error:
DEBUGLOG(("findentitytype_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("MmsAdjustmentTypeEntity findentitytype_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
        EXEC SQL CLOSE c_cursor_findentitytype;
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;
}

