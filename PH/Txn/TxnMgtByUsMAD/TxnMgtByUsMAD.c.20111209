/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/12/08              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsMAD.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnMgtByUsMAD(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;

        char        *csTmp = NULL;
        char        *csMerchantId = NULL;
        char        *csCode = NULL;

        char        *csService = NULL;
        char        *csTxnCountry = NULL;
        char        *csTxnCcy = NULL;
        char        *csUpdateUser = NULL;  
        double       dAmt=0.0;


        char    csTmpRtnTxnCode[PD_TXN_CODE_LEN + 1];
        char    csRtnTxnCode[PD_TXN_CODE_LEN + 1];


/*
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);
*/

        if(GetField_CString(hContext,"txn_seq",&csTmp)){
DEBUGLOG(("Authorize::txn_seq= [%s]\n",csTmp));
        }
        else{
DEBUGLOG(("Authorize::txnid not found!!\n"));
ERRLOG("TxnMgtByUsMAD::Authorize::txnid not found!!\n");
                iRet=INT_INVALID_TXN;
        }


        if(GetField_CString(hRequest,"add_user",&csUpdateUser)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csUpdateUser));
                PutField_CString(hContext,"add_user",csUpdateUser);
                PutField_CString(hContext,"update_user",csUpdateUser);
        }

        if(GetField_CString(hRequest,"merchant_id",&csMerchantId)){
DEBUGLOG(("Authorize::merchant_id = [%s]\n",csMerchantId));
                PutField_CString(hContext,"merchant_id",csMerchantId);
        }
	else {
DEBUGLOG(("Authorize::merchant_id not found!!\n"));
ERRLOG("TxnMgtByUsMAD::Authorize::merchant_id not found!!\n");
		iRet = INT_MERCHANT_ID_NOT_FOUND;
	}

        if(GetField_CString(hRequest,"code",&csCode)){
DEBUGLOG(("Authorize::code = [%s]\n",csCode));
                PutField_CString(hContext,"code",csCode);

		memset(csTmpRtnTxnCode, 0, sizeof(csTmpRtnTxnCode));
                memset(csRtnTxnCode, 0, sizeof(csRtnTxnCode));

                sprintf(csTmpRtnTxnCode, "%c%s", PD_TYPE_MERCHANT, csCode);
                U2L(csTmpRtnTxnCode, strlen(csTmpRtnTxnCode), csRtnTxnCode);
DEBUGLOG(("Authorize::new Txn code = [%s]\n",csRtnTxnCode));

        } 
	else {
DEBUGLOG(("Authorize::code not found!!\n"));
ERRLOG("TxnMgtByUsMAD::Authorize::code not found!!\n");
                        iRet=INT_CODE_ERROR;
	}


        if(GetField_CString(hRequest,"service_code",&csService)){
DEBUGLOG(("Authorize::service = [%s]\n",csService));
                PutField_CString(hContext,"service_code",csService);
        }
        else {
DEBUGLOG(("Authorize::service_code not found!!\n"));
ERRLOG("TxnMgtByUsMAD::Authorize::serivce_code not found!!\n");
                iRet = INT_SERVICE_CODE_MISSING;
        }


	if(GetField_CString(hRequest,"txn_country",&csTxnCountry)){
                PutField_CString(hContext,"txn_country",csTxnCountry);
DEBUGLOG(("Authorize::txn_country= [%s]\n",csTxnCountry));
        }
        else{
		if (iRet == PD_OK) {
			DBObjPtr = CreateObj(DBPtr,"DBService","FindCountryByService");
			if ((unsigned long)(DBObjPtr)(csService,csTxnCountry) == PD_FOUND) {
				PutField_CString(hContext,"txn_country",csTxnCountry);
DEBUGLOG(("Authorize::Found Country [%s] for Service [%s]\n",csTxnCountry,csService));
        	        }
                	else{
                        	iRet = INT_INVALID_SERVICE_CODE;
DEBUGLOG(("Authorize::invalid service code[%s]\n",csService));
ERRLOG("TxnMgtByUsMAD:Authorize::invalid service code [%s]\n",csService);
                	}
		}
        }


        if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTxnCcy));
                PutField_CString(hContext,"txn_ccy",csTxnCcy);
        }
        else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMgtByUsMAD::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
        }


        if(GetField_Double(hContext,"txn_amt",&dAmt)){
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dAmt));
        }
        else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMgtByUsMAD::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
        }

	PutField_Char(hContext, "party_type", PD_TYPE_MERCHANT);


        PutField_CString(hContext,"process_code","000000");
        PutField_CString(hContext,"process_type","0000");

 
	//Update Balance
        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call BOAdjustment:ProcessPartyBalance\n"));
                BOObjPtr = CreateObj(BOPtr,"BOAdjustment","ProcessPartyBalance");
		if((unsigned long)((*BOObjPtr)(hContext) != PD_OK)){
DEBUGLOG(("Authorize::BOAdjustment:ProcessPartyBalance Failed\n"));
ERRLOG("TxnMgtByUsATD::BOADjustment::ProcesspartyBalance Failed\n");
		iRet = INT_ERR;
		}
        } 


        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:AddDetail\n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK)
                        iRet = INT_ERR;
        }
   

        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:UpdateDetail\n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK)
                        iRet = INT_ERR;
        }




	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Assign new Txn code = [%s]\n",csRtnTxnCode));
                PutField_CString(hContext, "new_txn_code", csRtnTxnCode);
	}

        if(iRet!=PD_OK){
                PutField_Int(hContext,"internal_error",iRet);
        }

/*	FREE_ME(rRecordSet);*/

DEBUGLOG(("TxnMgtByUsMAD Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}
