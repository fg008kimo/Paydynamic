/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/09/08              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsHDI.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

#include "sha1.h"

#define PD_DETAIL_TAG   "dt"
#define PD_TAG_DELIMITER ","

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMgtByUsHDI(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{

	int	iRet = PD_OK;
	int	iTmpRtn = PD_OK;

	char	*csTmp;
	char	*csTmpTok;

	char	cAction;

	int	iCnt = 0;
	int	iCountryCnt = 0;
	int	iServiceCnt = 0;

	char	*csDate = NULL;
	char	*csCountry = NULL;
	char	*csService = NULL;

	//char	*csCountry;
	char	csTag[PD_TAG_LEN+1];
	int	i = 0, j = 0, k = 0;

	hash_t  *hTxn;

	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn, 0);


DEBUGLOG(("TxnMgtByUsHDI::Authorize\n"));

/* action */
	if (GetField_CString(hRequest, "action", &csTmp)) {
		cAction = csTmp[0];
DEBUGLOG(("Authorize::action = [%c]\n",cAction));
		//support add, update(desc) and delete
		if (cAction != PD_ACTION_ADD && cAction != PD_ACTION_UPDATE && cAction != PD_ACTION_DELETE) {
DEBUGLOG(("Authorize::action [%d] not support!!\n", cAction));
ERRLOG("TxnMgtByUsHDI::Authorize::action not support!!\n");
			iRet=INT_ACTION_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
		}
	}
	else {
DEBUGLOG(("Authorize::action not found!!\n"));
ERRLOG("TxnMgtByUsHDI::Authorize::action not found!!\n");
		iRet=INT_ACTION_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}


/* total_cnt */
	if (GetField_Int(hContext, "total_cnt", &iCnt)) {
DEBUGLOG(("Authorize::total_cnt = [%d]\n", iCnt));
		//PutField_Int(hResponse, "total_cnt", iCnt);
	}
	else {
DEBUGLOG(("Authorize::total_cnt not found\n"));
ERRLOG("TxnMgtByUsHDI::Authorize::total_cnt not found\n");
		iRet = INT_FORMAT_ERR;
		PutField_Int(hContext,"internal_error",iRet);
	}

/* Countries */
	if (GetField_CString(hRequest, "countries", &csTmp)) {
DEBUGLOG(("Authorize::countries= [%s]\n",csTmp));
		csTmpTok = mystrtok(csTmp, PD_TAG_DELIMITER);

		iCountryCnt++;  // start by 1
		memset(csTag, 0, sizeof(csTag));
		sprintf(csTag, "country_%d", iCountryCnt);
		
		PutField_CString(hTxn, csTag, csTmpTok);

DEBUGLOG(("Authorize:: country cnt [%d] = [%s]\n", iCountryCnt, csTmpTok));

		while ( (csTmpTok = mystrtok(NULL, PD_TAG_DELIMITER)) != NULL) {

			iCountryCnt++;
			
			memset(csTag, 0, sizeof(csTag));
			sprintf(csTag, "country_%d", iCountryCnt);

			PutField_CString(hTxn, csTag, csTmpTok);

DEBUGLOG(("Authorize:: country cnt [%d] = [%s]\n", iCountryCnt, csTmpTok));
		}

DEBUGLOG(("Authorize:: Total country [%d]\n", iCountryCnt)); 

	} else {
DEBUGLOG(("Authorize::countries not found\n"));
ERRLOG("TxnMgtByUsHDI::Authorize::countries not found\n");
		iRet = INT_TXN_COUNTRY_NOT_FOUND;	
		PutField_Int(hContext, "internal_error", iRet);
	}


/* Services */
        if (GetField_CString(hRequest, "services", &csTmp)) {
DEBUGLOG(("Authorize::services = [%s]\n",csTmp));
                csTmpTok = mystrtok(csTmp, PD_TAG_DELIMITER);

                iServiceCnt++;  // start by 1
                memset(csTag, 0, sizeof(csTag));
                sprintf(csTag, "service_%d", iServiceCnt);

                PutField_CString(hTxn, csTag, csTmpTok);

DEBUGLOG(("Authorize:: service cnt [%d] = [%s]\n", iServiceCnt, csTmpTok));

		while ( (csTmpTok = mystrtok(NULL, PD_TAG_DELIMITER)) != NULL) {
                        iServiceCnt++;

                        memset(csTag, 0, sizeof(csTag));
                        sprintf(csTag, "service_%d", iServiceCnt);

                        PutField_CString(hTxn, csTag, csTmpTok);

DEBUGLOG(("Authorize:: service cnt [%d] = [%s]\n", iServiceCnt, csTmpTok));
                }

DEBUGLOG(("Authorize:: Total Service [%d]\n", iServiceCnt)); 

        } else {
DEBUGLOG(("Authorize::services not found\n"));
ERRLOG("TxnMgtByUsHDI::Authorize::services not found\n");
                iRet = INT_SERVICE_CODE_MISSING;
                PutField_Int(hContext, "internal_error", iRet);
        }

/* desc */
	if (GetField_CString(hRequest, "desc", &csTmp)) {
DEBUGLOG(("Authorize::desc = [%s]\n", csTmp));
		PutField_CString(hTxn, "desc", csTmp);
	}


/* add_user */
	if(GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hTxn,"create_user",csTmp);
		PutField_CString(hTxn,"update_user",csTmp);
DEBUGLOG(("Authorize::create_user= [%s]\n",csTmp));
DEBUGLOG(("Authorize::update_user= [%s]\n",csTmp));
	}


	if (iRet == PD_OK) {
		for (i = 0; i < iCnt; i++) {

			memset(csTag, 0, sizeof(csTag));
			sprintf(csTag, "%s_date_%d", PD_DETAIL_TAG, i+1);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("Authorize::() [%s] = [%s]\n", csTag, csTmp));

				memset(csTag, 0, sizeof(csTag));
				sprintf(csTag, "date_%d", i+1);

DEBUGLOG(("Authorize::() Formatted hash Date [%s] = [%s]\n", csTag, csTmp));
                                PutField_CString(hTxn, csTag, csTmp);

                        }
                        else {
DEBUGLOG(("Authorize::[%s] not found\n", csTag));
ERRLOG("TxnMgtByUsHDI::Authorize::[%s] not found\n", csTag);
                                iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
				break;
                        }
		}
	}


	//The checking is moved into ADD, 
	//if already exists, just skip; otherwise, add record
	/*
	if (iRet == PD_OK){
		if (cAction == PD_ACTION_ADD) {
			// need to check if already exists
			for (i = 0; i < iCnt; i++) {  // Date
			
				csDate = NULL;
				memset(csTag, 0, sizeof(csTag));
				sprintf(csTag, "date_%d", i+1);

				GetField_CString(hTxn, csTag, &csDate);

				for (j = 0; j < iCountryCnt; j++) { // Country

					memset(csTag, 0, sizeof(csTag));
					sprintf(csTag, "country_%d", j+1);
					GetField_CString(hTxn, csTag, &csCountry);

					for (k = 0; k < iServiceCnt; k++) { // Service

						memset(csTag, 0, sizeof(csTag));
						sprintf(csTag, "service_%d", k+1);
						GetField_CString(hTxn, csTag, &csService);

DEBUGLOG(("Authorize:: Looping [%s] [%s] [%s]\n", csDate, csCountry, csService));

						DBObjPtr = CreateObj(DBPtr,"DBHoliday","ChkHolidayExists");
						iTmpRtn = (unsigned long)((*DBObjPtr)(csCountry, csService, csDate));
						if (iTmpRtn == PD_FOUND) {
							iRet = INT_REC_ALREADY_EXISTS;
							PutField_Int(hContext, "internal_error", iRet);
						}
					}
				}
			}
		}
	}
	*/

	if (iRet == PD_OK) {

		for (i = 0; i < iCnt; i++) {
			csDate = NULL;
			memset(csTag, 0, sizeof(csTag));
			sprintf(csTag, "date_%d", i+1);

			GetField_CString(hTxn, csTag, &csDate);

			for (j = 0; j < iCountryCnt; j++) { // Country

				memset(csTag, 0, sizeof(csTag));
				sprintf(csTag, "country_%d", j+1);
				GetField_CString(hTxn, csTag, &csCountry);

				for (k = 0; k < iServiceCnt; k++) { // Service
					memset(csTag, 0, sizeof(csTag));
					sprintf(csTag, "service_%d", k+1);
					GetField_CString(hTxn, csTag, &csService);


					PutField_CString(hTxn, "country", csCountry);
					PutField_CString(hTxn, "service_code", csService);
					PutField_CString(hTxn, "date", csDate);

					if (cAction == PD_ACTION_ADD) {
						PutField_Int(hTxn,"non_holiday", PD_FALSE);  // false means holiday

DEBUGLOG(("Authorize:: Looping [%s] [%s] [%s]\n", csDate, csCountry, csService));

						// Chk if holiday exists
						DBObjPtr = CreateObj(DBPtr,"DBHoliday","ChkHolidayExists");
						iTmpRtn = (unsigned long)((*DBObjPtr)(csCountry, csService, csDate));

						// add if not found
						if (iTmpRtn == PD_NOT_FOUND ) {
							DBObjPtr = CreateObj(DBPtr,"DBHoliday","Add");
							if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)) {
DEBUGLOG(("Authorize::DBHoliday:Add Failed\n"));
ERRLOG("TxnMgtByUsHDI::Authorize::DBHoliday:Add Failed\n");
								iRet = INT_ERR;
								break;
							}
							else {
DEBUGLOG(("Authorize::DBHoliday:Add Succ\n"));
							}
						} else {
							// Cater as update desc
DEBUGLOG(("Authorize::(Add) Call DBHoliday:UpdateDesc\n"));
							DBObjPtr = CreateObj(DBPtr,"DBHoliday","UpdateDesc");
							if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::(Add)DBHoliday:UpdateDesc Failed\n"));
ERRLOG("TxnMgtByUsHDI::(Add)Authorize::DBHoliday:UpdateDesc Failed\n");
								iRet = INT_ERR;
								break;
							}
							else {
DEBUGLOG(("Authorize::(Add) DBHoliday:UpdateDesc Succ\n"));
							}
						}
					} 
					else if (cAction==PD_ACTION_UPDATE) {
DEBUGLOG(("Authorize::Call DBHoliday:UpdateDesc\n"));
						DBObjPtr = CreateObj(DBPtr,"DBHoliday","UpdateDesc");
						if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBHoliday:UpdateDesc Failed\n"));
ERRLOG("TxnMgtByUsHDI::Authorize::DBHoliday:UpdateDesc Failed\n");
							iRet = INT_ERR;
							break;
						}
						else {
DEBUGLOG(("Authorize::DBHoliday:UpdateDesc Succ\n"));
						}
					}
					else if(cAction==PD_ACTION_DELETE){
DEBUGLOG(("Authorize::Call DBHoliday:Delete\n"));
						DBObjPtr = CreateObj(DBPtr,"DBHoliday","Delete");
						if((unsigned long)((*DBObjPtr)(csCountry,csService,csDate) != PD_OK)){
DEBUGLOG(("Authorize::DBHoliday:Delete Failed\n"));
ERRLOG("TxnMgtByUsHDI::Authorize::DBHoliday:Delete Failed\n");
							iRet = INT_ERR;
							break;
						}
						else {
DEBUGLOG(("Authorize::DBHoliday:Delete Succ\n"));
						}
					}
				} // end service
                        } // end country
		} // end date
	}


	hash_destroy(hTxn);
	FREE_ME(hTxn);

DEBUGLOG(("TxnMgtByUsHDI Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
