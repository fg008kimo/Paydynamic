/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/12/06              Virginia Yun
Include TxnCode Table for diff actions             2012/01/27		   Virginia Yun
Handle dual_contrl flag                            2012/03/30		   Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsATD.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMgtByUsATD(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{

	int	iRet = PD_OK;
	char	*csTmp = NULL;	
	char	*csUser = NULL;
	int	iTmp;

	int	iCurrentCode = -1;

	char	csRtnTxnCode[PD_TXN_CODE_LEN + 1];
	char	csTagAction[PD_TAG_LEN + 1];

	char	csVoidDesc[PD_DESC_LEN + 1];
	char	csVoidTxnCode[PD_TXN_CODE_LEN + 1];

	char	cPartyType;
	char	cDCInd;
	char	cAction;

	hash_t  *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn, 0);


DEBUGLOG(("TxnMgtByUsATD::Authorize\n"));

/* party_type */
	if(GetField_CString(hRequest,"party_type",&csTmp)){
		cPartyType = csTmp[0];
DEBUGLOG(("Authorize::party_type = [%c]\n",cPartyType));

		PutField_Char(hTxn, "party_type", cPartyType);
	}
	else {
DEBUGLOG(("Authorize::party_type not found!!\n"));
ERRLOG("TxnMgtByUsATD::Authorize::party_type not found!!\n");
		iRet=INT_PARTY_TYPE_NOT_FOUND;

		PutField_Int(hContext,"internal_error",iRet);
	}

/* dc_ind */
	if(GetField_CString(hRequest,"dc_ind",&csTmp)){
		cDCInd = csTmp[0];
DEBUGLOG(("Authorize::dc_ind = [%c]\n",cDCInd));
		PutField_Char(hTxn, "dc_ind", cDCInd);
	}
	else {
DEBUGLOG(("Authorize::dc_ind not found!!\n"));
ERRLOG("TxnMgtByUsATD::Authorize::dc_ind not found!!\n");
		iRet=INT_DC_IND_NOT_FOUND;

		PutField_Int(hContext,"internal_error",iRet);
	}

/* desc */
	if (GetField_CString(hRequest, "desc", &csTmp)) {
DEBUGLOG(("Authorize::desc = [%s]\n",csTmp));
		PutField_CString(hTxn, "desc", csTmp);
	}
	else {
DEBUGLOG(("Authorize::desc not found!!\n"));
ERRLOG("TxnMgtByUsATD::Authorize::desc not found!!\n");
		iRet=INT_DESC_NOT_FOUND;

		PutField_Int(hContext,"internal_error",iRet);
	}

/* dual control */
	if (GetField_CString(hRequest, "dual_control", &csTmp)) {
		iTmp = atoi(csTmp);
DEBUGLOG(("Authorize::dual_control = [%d]\n",iTmp));
		PutField_Int(hTxn, "dual_control", iTmp);

	}

/* disabled */
	if (GetField_CString(hRequest, "disabled", &csTmp)) {
		iTmp = atoi(csTmp);
DEBUGLOG(("Authorize::disabled = [%d]\n",iTmp));
		PutField_Int(hTxn, "disabled", iTmp);
	}
	else {
DEBUGLOG(("Authorize::disabled not found!!\n"));
	}



/* add_user */
        if(GetField_CString(hRequest,"add_user",&csUser)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csUser));
                PutField_CString(hTxn,"create_user",csUser);
                PutField_CString(hTxn,"update_user",csUser);
        }


/* action - A or U or D */
	if(GetField_CString(hRequest,"action",&csTmp)){
		cAction = csTmp[0];
DEBUGLOG(("Authorize::action = [%c]\n",cAction));
		PutField_Char(hTxn, "action", cAction);
	}
	else {
DEBUGLOG(("Authorize::action not found!!\n"));
ERRLOG("TxnMgtByUsATD::Authorize::action not found!!\n");
		iRet=INT_ACTION_NOT_FOUND;

		PutField_Int(hContext,"internal_error",iRet);
	}

/* apply_fee , voidable , dual_control */
	if (cAction == PD_ACTION_ADD) {

		if (cPartyType == PD_TYPE_MERCHANT) {
			if (GetField_CString(hRequest, "apply_fee", &csTmp)) {
				iTmp = atoi(csTmp);
				PutField_Int(hTxn, "apply_fee", iTmp);
DEBUGLOG(("Authorize:: [%c] apply_fee [%d]\n", cPartyType, iTmp));
			}
			else {
				PutField_Int(hTxn, "apply_fee", PD_TRUE);
DEBUGLOG(("Authorize:: [%c] (default) apply_fee [%d]\n", cPartyType, iTmp));
			}
		} else {
			PutField_Int(hTxn, "apply_fee", PD_FALSE);
DEBUGLOG(("Authorize:: [%c] (default) apply_fee [%d]\n", cPartyType, iTmp));
		}

		if (GetField_CString(hRequest, "voidable", &csTmp)) {
			iTmp = atoi(csTmp);
			PutField_Int(hTxn, "voidable", iTmp);
DEBUGLOG(("Authorize:: voidable [%d]\n", iTmp));
		}
		else {
			PutField_Int(hTxn, "voidable", PD_TRUE);
DEBUGLOG(("Authorize:: (default) apply_fee [%d]\n", iTmp));
		}

		if (!GetField_Int(hTxn, "dual_control", &iTmp)) {
			PutField_Int(hTxn, "dual_control", PD_TRUE);
DEBUGLOG(("Authorize:: (default) dual_control [%d]\n", PD_TRUE));
		}
	}

	if (cAction == PD_ACTION_UPDATE) {
		if (cPartyType == PD_TYPE_MERCHANT) {
			if (GetField_CString(hRequest, "apply_fee", &csTmp)) {
				iTmp = atoi(csTmp);
				PutField_Int(hTxn, "apply_fee", iTmp);
DEBUGLOG(("Authorize:: (update) apply_fee to [%d]\n", iTmp));
				
			} 
		}

		if (GetField_CString(hRequest, "voidable", &csTmp)) {
			iTmp = atoi(csTmp);
			PutField_Int(hTxn, "voidable", iTmp);
DEBUGLOG(("Authorize:: (update) voidable to [%d]\n", iTmp));

		}

	}


/* code */
	if (GetField_CString(hRequest, "code", &csTmp)) {
DEBUGLOG(("Authorize::code = [%s]\n",csTmp));
		PutField_CString(hTxn, "code", csTmp);

		iCurrentCode = atoi(csTmp + 1);
		PutField_Int(hTxn, "code_in_num", iCurrentCode);

DEBUGLOG(("Authorize::CodeInNum = [%d]\n",iCurrentCode));
	}
	else {
DEBUGLOG(("Authorize::Call BOAdjustment:GetCurrentCode\n"));
		BOObjPtr = CreateObj(BOPtr,"BOAdjustment","GetCurrentCode");
		if((unsigned long)((*BOObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::GetCurrentCode Failed\n"));
ERRLOG("TxnMgtByUsATD::Authorize::GetCurrentCode Failed\n");
                        iRet=INT_CODE_ERROR;

			PutField_Int(hContext,"internal_error",iRet);
                }

		if (iRet == PD_OK) {
			if (GetField_Int(hTxn, "code_in_num", &iCurrentCode)) {
DEBUGLOG(("Authorize::CurrentCodeInNum [%d]\n", iCurrentCode));

				sprintf(csRtnTxnCode, "%c%02d", tolower(cPartyType), iCurrentCode);
DEBUGLOG(("Authorize::CurrentCode [%s]\n", csRtnTxnCode));
				PutField_CString(hTxn, "code", csRtnTxnCode);
			}
		}
	}





/* Validate to process while update or delete */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call BOAdjustment:ValidateProcess\n"));
                BOObjPtr = CreateObj(BOPtr,"BOAdjustment","ValidateProcess");	
                if((unsigned long)((*BOObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::validateProcess Failed\n"));
/*ERRLOG("TxnMgtByUsATD::Authorize::ValidateProcess Failed\n");*/
			iRet = INT_PROCESS_VALIDATE_ERROR;

			PutField_Int(hContext,"internal_error",iRet);
		}
	}

/* call Add or Update or Delete*/
	if (iRet == PD_OK) {
		memset(csTagAction, 0, sizeof(csTagAction));
		switch (cAction) {
			case PD_ACTION_ADD:
				sprintf(csTagAction, "%s", "Add");
				break;
			case PD_ACTION_UPDATE:
				sprintf(csTagAction, "%s", "Update");
				break;
			case PD_ACTION_DELETE:
				sprintf(csTagAction, "%s", "Delete");
				break;
			default:
				iRet = INT_ERR;
				break;
		}

		if (iRet == PD_OK) {
DEBUGLOG(("Authorize::TagAction = [%s]\n", csTagAction));
	                DBObjPtr = CreateObj(DBPtr,"DBAdjustmentType", csTagAction);
			if((unsigned long)((*DBObjPtr)(hTxn)) != PD_OK) {
DEBUGLOG(("Authorize:: FAIL to [%s]\n", csTagAction));
				iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                	} else {
DEBUGLOG(("Authorize:: SUCC to [%s]\n", csTagAction));
			}
		}
	}

	/********************************************/
	/* Include TxnCode - Normal*/
	if (iRet == PD_OK) {

		/* txn_code */
		if (GetField_CString(hTxn, "code", &csTmp)) {
DEBUGLOG(("Authorize::TxnCode: Txn code = [%s]\n",csTmp));
			PutField_CString(hTxn, "txn_code", csTmp);
		}

		/* desc */
		if (GetField_CString(hTxn, "desc", &csTmp)) {
DEBUGLOG(("Authorize::TxnCode: Desc = [%s]\n",csTmp));
		}

		if (cAction == PD_ACTION_ADD) {
			PutField_CString(hTxn, "process_type", "0000");
			PutField_CString(hTxn, "process_code", "000000");

			//PutField_Int(hTxn, "apply_fee", PD_FALSE);
			//PutField_Int(hTxn, "voidable", PD_TRUE);
			PutField_Int(hTxn, "apply_limit", PD_FALSE);
		}

DEBUGLOG(("Authorize::TxnCode: TagAction = [%s]\n", csTagAction));
		DBObjPtr = CreateObj(DBPtr,"DBTxnCode", csTagAction);
		if((unsigned long)((*DBObjPtr)(hTxn)) != PD_OK) {
DEBUGLOG(("Authorize::TxnCode FAIL to [%s]\n", csTagAction));
			iRet = INT_ADJUSTMENT_PROCESS_ERROR;
		} else {
DEBUGLOG(("Authorize::TxnCode SUCC to [%s]\n", csTagAction));
                }
	}

	/* Include TxnCode - Void */
	if (iRet == PD_OK) {

		/* txn_code */
		GetField_CString(hTxn, "txn_code", &csTmp);

		memset(csVoidTxnCode, 0, sizeof(csVoidTxnCode));
		if (cPartyType == PD_TYPE_PSP) {
			sprintf(csVoidTxnCode, "%c%s", PD_ADJ_VOID_PSP_PREFIX, csTmp+1);  // x replace p
		} else if (cPartyType == PD_TYPE_MERCHANT) {
			sprintf(csVoidTxnCode, "%c%s", PD_ADJ_VOID_MERCH_PREFIX, csTmp+1); // y replace m
		}
DEBUGLOG(("Authorize::TxnCode(void): Txn code = [%s]\n",csVoidTxnCode));
		PutField_CString(hTxn, "txn_code", csVoidTxnCode);


		/* desc */
		GetField_CString(hTxn, "desc", &csTmp);
		memset(csVoidDesc, 0, sizeof(csVoidDesc));

		strcpy(csVoidDesc, PD_ADJ_VOID_DESC_PREFIX);  // "Void "
		strncpy(&csVoidDesc[strlen(PD_ADJ_VOID_DESC_PREFIX)], csTmp, PD_DESC_LEN - strlen(PD_ADJ_VOID_DESC_PREFIX));

DEBUGLOG(("Authorize::TxnCode(void): Desc = [%s]\n",csVoidDesc));
		PutField_CString(hTxn, "desc", csVoidDesc);

		if (cAction == PD_ACTION_ADD) {
			// void by default
			PutField_Int(hTxn, "voidable", PD_FALSE);
			PutField_Int(hTxn, "apply_fee", PD_FALSE);
		}

		if (cAction == PD_ACTION_UPDATE) {
			// not update apply_fee or voidable for void
			if (GetField_Int(hTxn, "apply_fee", &iTmp)) {
				RemoveField_Int(hTxn, "apply_fee");
			}

			if (GetField_Int(hTxn, "voidable", &iTmp)) {
				RemoveField_Int(hTxn, "voidable");
			}
		}

DEBUGLOG(("Authorize::TxnCode(void): TagAction = [%s]\n", csTagAction));
                DBObjPtr = CreateObj(DBPtr,"DBTxnCode", csTagAction);
                if((unsigned long)((*DBObjPtr)(hTxn)) != PD_OK) {
DEBUGLOG(("Authorize::TxnCode(void) FAIL to [%s]\n", csTagAction));
                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                } else {
DEBUGLOG(("Authorize::TxnCode(void) SUCC to [%s]\n", csTagAction));
                }

	}
	/********************************************/


/* rtn code */
	if (iRet == PD_OK) {
		if (GetField_CString(hTxn, "code", &csTmp)) {
DEBUGLOG(("Authorize::Rtn Txn code = [%s]\n",csTmp));
			PutField_CString(hResponse, "rtn_code", csTmp);
		}
	}



/*
	if(iRet!=PD_OK){
		PutField_Int(hContext,"internal_error",iRet);
	}
*/


	hash_destroy(hTxn);
	FREE_ME(hTxn);

DEBUGLOG(("TxnMgtByUsATD Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}

