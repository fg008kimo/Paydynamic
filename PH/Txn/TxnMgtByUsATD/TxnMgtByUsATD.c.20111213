/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/12/06              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsATD.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMgtByUsATD(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{

	int	iRet = PD_OK;
	char	*csTmp = NULL;	
	char	*csUser = NULL;
	char	*csCurrentCode = NULL;

	char	csRtnTxnCode[PD_TXN_CODE_LEN + 1];
	char	csTagAction[PD_TAG_LEN + 1];

	char	cPartyType;
	char	cDCInd;
	char	cAction;

	hash_t  *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn, 0);


DEBUGLOG(("TxnMgtByUsATD::Authorize\n"));

/* party_type */
	if(GetField_CString(hRequest,"party_type",&csTmp)){
		cPartyType = csTmp[0];
DEBUGLOG(("Authorize::party_type = [%c]\n",cPartyType));

		PutField_Char(hTxn, "party_type", cPartyType);
	}
	else {
DEBUGLOG(("Authorize::party_type not found!!\n"));
ERRLOG("TxnMgtByUsATD::Authorize::party_type not found!!\n");
		iRet=INT_PARTY_TYPE_NOT_FOUND;
	}

/* dc_ind */
	if(GetField_CString(hRequest,"dc_ind",&csTmp)){
		cDCInd = csTmp[0];
DEBUGLOG(("Authorize::dc_ind = [%c]\n",cDCInd));
		PutField_Char(hTxn, "dc_ind", cDCInd);
	}
	else {
DEBUGLOG(("Authorize::dc_ind not found!!\n"));
ERRLOG("TxnMgtByUsATD::Authorize::dc_ind not found!!\n");
		iRet=INT_DC_IND_NOT_FOUND;
	}

/* desc */
	if (GetField_CString(hRequest, "desc", &csTmp)) {
DEBUGLOG(("Authorize::desc = [%s]\n",csTmp));
		PutField_CString(hTxn, "desc", csTmp);
	}
	else {
DEBUGLOG(("Authorize::desc not found!!\n"));
ERRLOG("TxnMgtByUsATD::Authorize::desc not found!!\n");
		iRet=INT_DESC_NOT_FOUND;
	}


/* add_user */
        if(GetField_CString(hRequest,"add_user",&csUser)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csUser));
                PutField_CString(hTxn,"create_user",csUser);
                PutField_CString(hTxn,"update_user",csUser);
        }


/* action - A or U or D */
	if(GetField_CString(hRequest,"action",&csTmp)){
		cAction = csTmp[0];
DEBUGLOG(("Authorize::action = [%c]\n",cAction));
		PutField_Char(hTxn, "action", cAction);
	}
	else {
DEBUGLOG(("Authorize::action not found!!\n"));
ERRLOG("TxnMgtByUsATD::Authorize::action not found!!\n");
		iRet=INT_ACTION_NOT_FOUND;
	}


/* code */
	if (GetField_CString(hRequest, "code", &csTmp)) {
DEBUGLOG(("Authorize::code = [%s]\n",csTmp));
		PutField_CString(hTxn, "code", csTmp);
	}
	else {
DEBUGLOG(("Authorize::code not found!!\n"));
DEBUGLOG(("Authorize::Call BOAdjustment:GetCurrentCode\n"));
		BOObjPtr = CreateObj(BOPtr,"BOAdjustment","GetCurrentCode");
		if((unsigned long)((*BOObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::GetCurrentCode Failed\n"));
ERRLOG("TxnMgtByUsATD::Authorize::GetCurrentCode Failed\n");
                        iRet=INT_CODE_ERROR;
                }
	}

	if (iRet == PD_OK) {
		if (GetField_CString(hTxn, "code", &csCurrentCode)) {
DEBUGLOG(("Authorize::csCurrentCode [%s]\n", csCurrentCode));
			memset(csRtnTxnCode, 0, sizeof(csRtnTxnCode)); 
	
DEBUGLOG(("Authorize::Call BOAdjustment:FormNewTxnCode\n"));
			BOObjPtr = CreateObj(BOPtr,"BOAdjustment","FormNewTxnCode");
			(*BOObjPtr)(cPartyType, csCurrentCode, &csRtnTxnCode);

DEBUGLOG(("Authorize::Call BOAdjustment:FormNewTxnCode csRtnTxnCode [%s]\n", csRtnTxnCode));

			PutField_CString(hTxn, "full_code", csRtnTxnCode);
		}
	}

/* Validate to process while update or delete */
	if (iRet == PD_OK) {
                BOObjPtr = CreateObj(BOPtr,"BOAdjustment","ValidateProcess");	
                if((unsigned long)((*BOObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::validateProcess Failed\n"));
/*ERRLOG("TxnMgtByUsATD::Authorize::ValidateProcess Failed\n");*/
			iRet = INT_PROCESS_VALIDATE_ERROR;
		}
	}

/* call Add or Update or Delete*/
	if (iRet == PD_OK) {
		memset(csTagAction, 0, sizeof(csTagAction));
		switch (cAction) {
			case PD_ADJ_TYPE_ACTION_ADD:
				sprintf(csTagAction, "%s", "Add");
				break;
			case PD_ADJ_TYPE_ACTION_UPDATE:
				sprintf(csTagAction, "%s", "Update");
				break;
			case PD_ADJ_TYPE_ACTION_DELETE:
				sprintf(csTagAction, "%s", "Delete");
				break;
			default:
				iRet = INT_ERR;
				break;
		}

		if (iRet == PD_OK) {
DEBUGLOG(("Authorize::TagAction = [%s]\n", csTagAction));
	                DBObjPtr = CreateObj(DBPtr,"DBAdjustmentType", csTagAction);
			if((unsigned long)((*DBObjPtr)(hTxn)) != PD_OK) {
DEBUGLOG(("Authorize:: FAIL to [%s]\n", csTagAction));
				iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                	} else {
DEBUGLOG(("Authorize:: SUCC to [%s]\n", csTagAction));
			}
		}
	}
	

/* rtn code */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Rtn Txn code = [%s] [%s]\n",csRtnTxnCode, csCurrentCode));
		/*PutField_CString(hResponse, "rtn_code", csRtnTxnCode);*/
		PutField_CString(hResponse, "rtn_code", csCurrentCode);
	}


	if(iRet!=PD_OK){
		PutField_Int(hContext,"internal_error",iRet);
	}


	hash_destroy(hTxn);
	FREE_ME(hTxn);

DEBUGLOG(("TxnMgtByUsATD Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}

