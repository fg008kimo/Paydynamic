/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/07/15              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsOPR.h"
#include "myrecordset.h"
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

int	isAllowProcess(hash_t *hContext);
int	UpdatePayoutGenerateTxn(hash_t *hUpdateTxn);


void TxnOmtByUsOPR(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
	int	iRet = PD_OK;
	char	*csOrgTxnSeq;
	char	*csTxnSeq;
	char	*csOrgGenTxnSeq;
	char	csNewTxnSeq[PD_TXN_SEQ_LEN+1];
	char	*csTmp;
	char	*csPHDate;
	char	*csOrgPostDate;
	char	csTag[PD_TAG_LEN+1];
	double	dTmp;
	double	dPreFee=0.0;
	int	iStatus;
	int	i = 0;
	int	iCnt = 0;
	int	iSameDate = PD_TRUE;//always put back to ava po
	int	iReturnFee = PD_FALSE;
	int	iReturnPspFee = PD_FALSE;
	int	iRefundParty = 0;
	char    *csHandler;
	hash_t  *hRec, *hTxn;

	char	cTmp;
	int	iTmp;
	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);


DEBUGLOG(("TxnOmtByUsOPR: Authroize()\n"));

	if (GetField_CString(hContext,"txn_seq",&csTxnSeq)) {
		//new txn id of OPA
DEBUGLOG(("txn seq = [%s]\n",csTxnSeq));
	}

	if (GetField_CString(hContext,"org_txn_seq",&csOPATxnId)) {
		//Merhchant Payout Txn ID
DEBUGLOG(("Merchant Payout Txn ID = [%s]\n",csOPATxnId));

		//TODO:
		//1. find latest Payout transaction(s) in TEMP
		//check - split payout?
		//check - multi recon?
		//	  if multi recon come from same source split payout, allow to process
		// 	  if multi recon not come from same source payout, reject!
		//
		//2. find the latest recon patten
		// - number of bank statement reconciled with the PSP payout transaction(s)

	}
	else{
		iRet = INT_TXN_ID_MISSING;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Merchant Payout Txn ID is missing!!!!\n"));
ERRLOG("TxnOmtByUsOPR: Merchant Payout Txn ID is missing!!!!\n");
	}

	if(GetField_Int(hContext,"total_cnt",&iCnt)){
DEBUGLOG(("Number of Statement pairs = [%d]\n",iCnt));
	}

	for(i=0; i<iCnt; i++){
		sprintf(csTag,"obp_txnid_%d",i);
		if (GetField_CString(hContext,csTag,&csTmp)) {
			//Statement Txn ID (Classicfied as Payout and Reconed)
DEBUGLOG(("Payout Statement Txn ID [%d] = [%s]\n",i,csTmp));
		}

		sprintf(csTag,"stmt_txnid_%d",i);
		if (GetField_CString(hContext,csTag,&csTmp)) {
			//Unknown Credit Statment Txn ID
DEBUGLOG(("Unknown Credit Statment Txn ID [%d] = [%s]\n",i,csTmp));
		}


		//TODO:
		//1. check each statement pair is in same bank account and same amount
		//2. check the number of statement pairs is the same with the recon patten
		//3. should not have amount difference with the recon patten

	}

	if(GetField_CString(hContext,"update_user",&csUser)){
DEBUGLOG(("Authorize::update_user= [%s]\n",csUser));
        }

	if(GetField_CString(hRequest,"remark",&csRemark)){
DEBUGLOG(("Authorize::remark= [%s]\n",csRemark));
        }

	if(GetField_Int(hRequest,"return_pspfee",&iReturnPspFee)){
DEBUGLOG(("Authorize::return psp fee = [%d]\n",iReturnPspFee));
	}

	if(GetField_Int(hRequest,"return_mfee",&iReturnFee)){
DEBUGLOG(("Authorize::return merchant fee = [%d]\n",iReturnFee));
	}


	if(iRet==PD_OK){
		PutField_Int(hContext,"same_date_cancel",PD_TRUE);
		BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","VoidOrgTxnElements");
		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("Authorize:: BOOLTxnElements:VoidOrgTxnElements iRet = [%d]\n",iRet));

		PutField_CString(hContext,"txn_code",PD_OL_PAYOUT_VOID_MERCHANT);
		PutField_Int(hContext,"do_logging",PD_NO_LOG);

		csHandler = (char*) malloc (20);
		sprintf(csHandler,"TxnOmtByUs%s",PD_PAYOUT_VOID);
DEBUGLOG(("Authorize:: Create Txn Object [%s]\n",csHandler));
		TxnObjPtr = CreateObj(TxnPtr,csHandler,"Authorize");
		iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
		FREE_ME(csHandler);

		//TODO:
		//get the created PSP Return Payout transaction(s)
		//follow the recon patten to pass return transation(s) and unknown CR stmt(s) pair to the API "REC"

	}

	if(iRet==PD_OK){
		PutField_CString(hContext,"sub_status",PD_REFUND_APPROVED);
        }



	RecordSet_Destroy(rRecordSet);
        FREE_ME(hTxn);
	FREE_ME(rRecordSet);

DEBUGLOG(("Normal exit iRet = [%d]\n",iRet));	
	return iRet;
}
