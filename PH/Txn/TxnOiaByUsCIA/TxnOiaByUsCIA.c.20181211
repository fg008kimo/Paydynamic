/*
PDProTech (c)2018. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2018/11/26              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOiaByUsCIA.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"


static char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);
OBJPTR(Msg);


int 	AddTxnLog(const hash_t *hContext, const hash_t* hRequest);
int     UpdateTxnLog(const hash_t *hContext, const hash_t* hRequest, const hash_t* hResponse);
int     UpdateTxnReqRef(const hash_t *hContext, const hash_t *hRequest);
int     FormOmtMessage(hash_t *hContext, const hash_t *hRequest);
int     ProcessOmtTxn(hash_t *hContext, const hash_t *hRequest, hash_t *hResponse);


void 	TxnOiaByUsCIA(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{
	int	iRet = PD_OK;

	int     iInternalErr = 0;
	int     iDoLog = PD_NO_LOG;
        double  dTxnAmt = 0.0;
	char    *csChannelCode = NULL;
        char    *csTxnCode  = NULL;
        char    *csTmp = NULL;
        char    *csData = (char*) malloc (64);

	hash_t  *hOmtContext;
	hOmtContext = (hash_t*) malloc(sizeof(hash_t));
        hash_init(hOmtContext, 0);
	
        hash_t  *hFrBAIDDetails = NULL;
        hFrBAIDDetails = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hFrBAIDDetails,0);

        hash_t  *hToBAIDDetails = NULL;
        hToBAIDDetails = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hToBAIDDetails,0);

DEBUGLOG(("TxnOiaByUsCIA::Authorize\n"));

/* channel_code */
        if (GetField_CString(hContext, "channel_code", &csTmp)) {
DEBUGLOG(("Authorize::channel_code [%s] \n", csTmp));
        } else {
DEBUGLOG(("Authorize::channel_code not found!!\n"));
ERRLOG("TxnOiaByUsCIA::Authorize::channel_code not found!!\n");
                iRet=INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
	}

/* txn_code */
	if (iRet == PD_OK) {
		if (GetField_CString(hContext, "txn_code", &csTmp)) {
DEBUGLOG(("Authorize::(OIA) txn_code [%s] \n", csTmp));
        	} else {
DEBUGLOG(("Authorize::txn_code not found!!\n"));
ERRLOG("TxnOiaByUsCIA::Authorize::txn_code not found!!\n");
                	iRet=INT_TXN_CODE_NOT_FOUND;
                	PutField_Int(hContext,"internal_error",iRet);
		}
	}

/* txn_seq */
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "txn_seq", &csTmp)) {
DEBUGLOG(("Authorize::(OIA) txn_seq [%s] \n", csTmp));
			PutField_CString(hOmtContext, "req_txn_seq", csTmp);
                }
        }

/* org_txn_seq */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "org_txn_seq", &csTmp)) {
DEBUGLOG(("Authorize::(OIA) org_txn_seq [%s] \n", csTmp));
                	PutField_CString(hOmtContext, "org_txn_seq", csTmp);
        	}
	}

/* req_id */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest,"req_ref",&csTmp)) {
DEBUGLOG(("Authorize::req_id = [%s]\n",csTmp));
			PutField_CString(hOmtContext, "txn_id", csTmp);
			PutField_CString(hResponse, "req_ref", csTmp);
        	} else {
DEBUGLOG(("Authorize::req_id not found!!\n"));
ERRLOG("TxnOiaByUsCIA::Authorize::req_id not found!!\n");
                	iRet=INT_INVALID_MERCHANT_REF;
                	PutField_Int(hContext,"internal_error",iRet);
        	}
	}

/* baid */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRequest, "baid", &csTmp)) {
DEBUGLOG(("Authorize::baid [%s]\n", csTmp));
                	PutField_CString(hFrBAIDDetails, "baid", csTmp);
                	PutField_CString(hToBAIDDetails, "baid", csTmp);
			PutField_CString(hOmtContext, "fr_baid", csTmp);
                	PutField_CString(hResponse, "baid", csTmp);
        	} else {
DEBUGLOG(("Authorize::baid not found!!\n"));
ERRLOG("TxnOiaByUsCIA::Authorize::baid not found!!\n");
                	iRet=INT_BANK_ACCT_ID_NOT_FOUND;
               	 	PutField_Int(hContext,"internal_error",iRet);
        	}
	}

/* to_baid */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRequest, "to_baid", &csTmp)) {
DEBUGLOG(("Authorize::to_baid [%s]\n", csTmp));
                	PutField_CString(hToBAIDDetails, "to_baid", csTmp);
			PutField_CString(hOmtContext, "to_baid", csTmp);
                	PutField_CString(hResponse, "to_baid", csTmp);
        	} else {
DEBUGLOG(("Authorize::to_baid not found!!\n"));
ERRLOG("TxnOiaByUsCIA::Authorize::to_baid not found!!\n");
                	iRet=INT_BANK_ACCT_ID_NOT_FOUND;
                	PutField_Int(hContext,"internal_error",iRet);
        	}
	}

/* txn_ccy */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRequest,"txn_ccy",&csTmp)) {
DEBUGLOG(("Authorize::txn_ccy = [%s]\n",csTmp));
                	PutField_CString(hFrBAIDDetails,"limit_ccy",csTmp);
                	PutField_CString(hToBAIDDetails,"currency_id",csTmp);
                	PutField_CString(hOmtContext,"txn_ccy",csTmp);
        	} else {
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnOiaByUsCIA::Authorize::ccy not found!!\n");
                	iRet=INT_CURRENCY_CODE_NOT_FOUND;
                	PutField_Int(hContext,"internal_error",iRet);
        	}
	}

/* txn_amt */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRequest,"txn_amt",&csTmp)) {
			dTxnAmt = string2double((const unsigned char *)csTmp);
DEBUGLOG(("Authorize::txn_amt = [%lf]\n",dTxnAmt));
                	PutField_Double(hFrBAIDDetails,"txn_amt",dTxnAmt);
                	PutField_Double(hOmtContext,"txn_amt",dTxnAmt);
        	} else {
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnOiaByUsCIA::Authorize::txn_amt not found!!\n");
                	iRet=INT_PAY_AMOUNT_NOT_FOUND;
                	PutField_Int(hContext,"internal_error",iRet);
		}
        }	

/* gen_unique_amt */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRequest,"gen_unique_amt",&csTmp)) {
			PutField_CString(hOmtContext,"gen_unique_amt",csTmp);
DEBUGLOG(("Authorize::gen_unique_amt = [%s]\n",csTmp));
        	} else {
                	sprintf(csData, "%d", PD_FALSE);
               	 	PutField_CString(hContext, "gen_unique_amt", csData);
			PutField_CString(hOmtContext,"gen_unique_amt",csData);
DEBUGLOG(("Authorize::gen_unique_amt = [%s]\n",csData));
        	}
	}

/* report_date */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRequest,"report_date",&csTmp)) {
DEBUGLOG(("Authorize::report_date = [%s]\n",  csTmp));
			PutField_CString(hOmtContext,"report_date",csTmp);
		}
	}

/* PHDATE */
	if (iRet == PD_OK) {
		if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("Authorize::PHDATE = [%s]\n", csTmp));
              		PutField_CString(hOmtContext,"PHDATE",csTmp);
		}
	}

/* transmission_datetime */
	if (iRet == PD_OK) {
                if (GetField_CString(hContext,"transmission_datetime",&csTmp)) {
DEBUGLOG(("Authorize::transmission_datetime = [%s]\n",csTmp));
                        PutField_CString(hOmtContext,"transmission_datetime",csTmp);
                }
	}

/* local_tm_date */
	if (iRet == PD_OK) {
                if (GetField_CString(hContext,"local_tm_date",&csTmp)) {
DEBUGLOG(("Authorize::local_tm_date = [%s]\n",csTmp));
                        PutField_CString(hOmtContext,"local_tm_date",csTmp);
                }	
	}

/* local_tm_time */
	if (iRet == PD_OK) {
                if (GetField_CString(hContext,"local_tm_time",&csTmp)) {
DEBUGLOG(("Authorize::local_tm_time = [%s]\n",csTmp));
                        PutField_CString(hOmtContext,"local_tm_time",csTmp);
		}
	}

/* client_ip */
	if (iRet == PD_OK) {
                if (GetField_CString(hRequest,"ip_addr",&csTmp)) {
DEBUGLOG(("Authorize::client_ip = [%s]\n",csTmp));
                       	PutField_CString(hOmtContext,"ip_addr",csTmp);
                }
	}

/* add_user */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRequest,"add_user",&csTmp)) {
DEBUGLOG(("Authorize::add_user = [%s]\n",csTmp));
			PutField_CString(hOmtContext,"add_user",csTmp);
			PutField_CString(hOmtContext,"update_user",csData);
        	} else {
                	sprintf(csData, "%s", PD_UPDATE_USER);
                	PutField_CString(hContext, "add_user", csData);
			PutField_CString(hOmtContext,"add_user",csData);
			PutField_CString(hOmtContext,"update_user",csData);
DEBUGLOG(("Authorize::add_user= [%s]\n",csData));
        	}
	}

	// Check fr_baid Details
	if (iRet == PD_OK) {

                // Call BOOLBaid(CheckIntraFrBAIDDetails)
                BOObjPtr = CreateObj(BOPtr,"BOOLBaid","CheckIntraFrBAIDDetails");
                iRet = (unsigned long)(BOObjPtr)(hFrBAIDDetails);
                if (iRet == PD_OK) {
DEBUGLOG(("Authorize::BOOLBaid::GetIntraFrBAIDDetails::Success\n"));
                } else {
DEBUGLOG(("Authorize::Call BOOLBaid::GetIntraFrBAIDDetails::Failure\n"));
ERRLOG("TxnOiaByUsCIA::Authorize::Call BOOLBaid::GetIntraFrBAIDDetails::Failure\n");
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
                }
        }	

	// Check to_baid Details
	if (iRet == PD_OK) {

                // Call BOOLBaid(CheckIntraToBAIDDetails)
                BOObjPtr = CreateObj(BOPtr,"BOOLBaid","CheckIntraToBAIDDetails");
                iRet = (unsigned long)(BOObjPtr)(hToBAIDDetails);
                if (iRet == PD_OK) {
DEBUGLOG(("Authorize::BOOLBaid::GetIntraToBAIDDetails::Success\n"));
                } else {
DEBUGLOG(("Authorize::Call BOOLBaid::GetIntraToBAIDDetails::Failure\n"));
ERRLOG("TxnOiaByUsCIA::Authorize::Call BOOLBaid::GetIntraToBAIDDetails::Failure\n");
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
                }
        }	

	// Use OMT and PBF to get logging
	if (iRet == PD_OK) {

		PutField_CString(hOmtContext, "channel_code", PD_CHANNEL_OMT); 	
		PutField_CString(hOmtContext, "txn_code", "PBF"); 	
		PutField_CString(hOmtContext, "reply_txn_code", "PBF"); 	

		PutField_CString(hOmtContext, "process_type", PD_PROCESS_TYPE_DEF);
		PutField_CString(hOmtContext, "process_code", PD_PROCESS_CODE_DEF);

		if ((GetField_CString(hOmtContext, "channel_code", &csChannelCode)) &&
	    	    (GetField_CString(hOmtContext, "txn_code", &csTxnCode))) {

                 	DBObjPtr = CreateObj(DBPtr,"DBTxnSupported","IsDoLogging");
                        iDoLog = (unsigned long)(*DBObjPtr)(csChannelCode,csTxnCode);

DEBUGLOG(("Authorize::channel_code [%s] txn_code [%s] DoLog [%d]!!\n", csChannelCode, csTxnCode, iDoLog));
			PutField_Int(hOmtContext, "do_logging", iDoLog);

		} else {
DEBUGLOG(("Authorize::channel_code or txn_code not found!!\n"));
ERRLOG("TxnOiaByUsCIA::Authorize::channel_code or txn_code not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
		}
	}

	// Form OMT Message
        if (iRet == PD_OK) {
		iRet = FormOmtMessage(hOmtContext, hOmtContext);
	}

	// Add Txn Log
	if (iRet == PD_OK) {
		iRet = AddTxnLog(hOmtContext, hOmtContext);
	}
	
	// Process OMT Txn (TxnOmtByUsCOM and TxnOmtByUsPBF)
        if (iRet == PD_OK) {
		iRet = ProcessOmtTxn(hOmtContext, hOmtContext, hOmtContext);
	}

	// Check OMT Message
        if (iRet == PD_OK) {
                // iRet = CheckOmtMessage(hOmtContext, hOmtContext);
       	}

	// Update Txn Log and OLTxnRequestRef
        if ((iRet == PD_OK) 
	    || (GetField_Int(hContext,"internal_error",&iInternalErr))
	) {

		// response_code
                sprintf(csData,"%d",iInternalErr);
                PutField_CString(hOmtContext,"response_code",csData);

		// status
                PutField_Char(hOmtContext,"status",PD_COMPLETE);

		// internal_code
		if (iInternalErr != 0 ) {

			// ar_ind
                     	PutField_Char(hOmtContext,"ar_ind",PD_REJECT);
                } else {
			
                        iInternalErr = INT_NO_ERR;
			
			// ar_ind
			PutField_Char(hOmtContext,"ar_ind",PD_ACCEPT);
                }
                PutField_Int(hOmtContext,"internal_code",iInternalErr);

		// Update Txn Log
                iRet = UpdateTxnLog(hOmtContext, hOmtContext, hOmtContext);
 
		// Update OLTxnRequestRef 
		if (iRet == PD_OK) {

/* t1_txn_id */	
			if (GetField_CString(hOmtContext, "txn_seq_tf", &csTmp)) {
DEBUGLOG(("Authorize::t1_txn_id = [%s]\n", csTmp));
				PutField_CString(hOmtContext, "t1_txn_id", csTmp);
                	        PutField_CString(hResponse, "txn_id", csTmp);
                	} else {
DEBUGLOG(("Authorize::t1_txn_id not found!!\n"));
ERRLOG("TxnOiaByUsCIA::Authorize::t1_txn_id not found!!\n");
                	        iRet=INT_ERR;
              		}

/* t2_txn_id */
			if (iRet == PD_OK) {
               		 	if (GetField_CString(hOmtContext, "txn_seq_tt", &csTmp)) {
DEBUGLOG(("Authorize::t2_txn_id = [%s]\n", csTmp));
                        		PutField_CString(hOmtContext, "t2_txn_id", csTmp);
                        		PutField_CString(hResponse, "to_txn_id", csTmp);
                		} else {
DEBUGLOG(("Authorize::t2_txn_id not found!!\n"));
ERRLOG("TxnOiaByUsCIA::Authorize::t2_txn_id not found!!\n");
                        		iRet=INT_ERR;
                		}		
			}

			if (iRet == PD_OK) {
				iRet = UpdateTxnReqRef(hOmtContext, hOmtContext);
			}
		}
	}

	FREE_ME(csData);

	hash_destroy(hOmtContext);
        FREE_ME(hOmtContext);

        hash_destroy(hFrBAIDDetails);
        FREE_ME(hFrBAIDDetails);

        hash_destroy(hToBAIDDetails);
        FREE_ME(hToBAIDDetails);

DEBUGLOG(("TxnOiaByUsCIA Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}

int     AddTxnLog(const hash_t *hContext, 
		  const hash_t *hRequest)
{
        int 	iRet = PD_OK;

	int     iPtr = 0;

        char    *csTxnSeq = NULL;
	char    *csTxnCcy = NULL;
        char    *csTxnCountry = NULL;
	char    *csPtr = NULL;
        char    csTxnDateTime[PD_DATETIME_LEN + 1];

        hash_t  *hTxn;
	hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);

DEBUGLOG(("AddTxnLog\n"));

/* do_logging */
        if(GetField_Int(hContext,"do_logging",&iPtr)){
                if(iPtr!=PD_ADD_LOG)
                        return iRet;
        }

/* txn_seq */
        if (GetField_CString(hContext,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("AddTxnLog:: txn_seq = [%s]\n",csTxnSeq));
                PutField_CString(hTxn,"txn_seq",csTxnSeq);
	} else {
DEBUGLOG(("AddTxnLog:: txn_seq not found!!\n"));
ERRLOG("TxnOiaByUsCIA:: AddTxnLog:: txn_seq not found!!\n");
		iRet = INT_ERR;
	}

	if (iRet == PD_OK) {

/* add_user */
		if (GetField_CString(hContext,"add_user",&csPtr)) {
DEBUGLOG(("AddTxnLog:: add_user = [%s]\n",csPtr));
                        PutField_CString(hTxn,"add_user",csPtr);
                } else {
                        PutField_CString(hTxn,"add_user",PD_UPDATE_USER);
                }

/* db_commit */
		if (GetField_Int(hContext,"db_commit",&iPtr)) {
DEBUGLOG(("AddTxnLog:db_commit = [%d]\n",iPtr));
                        PutField_Int(hTxn,"db_commit",iPtr);
                }

/* org_txn_seq */
                if (GetField_CString(hContext,"org_txn_seq",&csPtr)) {
DEBUGLOG(("AddTxnLog:: org_txn_seq = [%s]\n",csPtr));
                        PutField_CString(hTxn,"org_txn_seq",csPtr);
                }

/* channel_code */
                if (GetField_CString(hContext,"channel_code",&csPtr)) {
DEBUGLOG(("AddTxnLog:: channel_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"channel_code",csPtr);
                }

/* txn_code */
                if (GetField_CString(hContext,"txn_code",&csPtr)) {
DEBUGLOG(("AddTxnLog:: txn_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"txn_code",csPtr);
                }

/* process_code */
                if (GetField_CString(hContext,"process_code",&csPtr)) {
DEBUGLOG(("AddTxnLog:: process_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"process_code",csPtr);
                }

/* process_type */
                if (GetField_CString(hContext,"process_type",&csPtr)) {
DEBUGLOG(("AddTxnLog:: process_type = [%s]\n",csPtr));
                        PutField_CString(hTxn,"process_type",csPtr);
                }

/* client ip */
                if (GetField_CString(hRequest,"ip_addr",&csPtr)) {
DEBUGLOG(("AddTxnLog:: client_ip = [%s]\n",csPtr));
                        PutField_CString(hTxn,"ip_addr",csPtr);
                }

/* client id */
                if (GetField_CString(hRequest,"client_id",&csPtr)) {
DEBUGLOG(("AddTxnLog:: client id = [%s]\n",csPtr));
                        PutField_CString(hTxn,"client_id",csPtr);
                }

/* merchant ref */
                if (GetField_CString(hRequest,"merchant_ref",&csPtr)) {
DEBUGLOG(("AddTxnLog:: merchant ref = [%s]\n",csPtr));
                        PutField_CString(hTxn,"merchant_ref",csPtr);
                }

/* merchant_id */
                if (GetField_CString(hRequest,"merchant_id",&csPtr)) {
DEBUGLOG(("AddTxnLog:: merchant_id = [%s]\n",csPtr));
                        PutField_CString(hTxn,"merchant_id",csPtr);
                }

/* service_code */
                if (GetField_CString(hRequest,"service_code",&csPtr)) {
DEBUGLOG(("AddTxnLog:: service_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"service_code",csPtr);
                }

/* net_ccy */
                if (GetField_CString(hRequest,"net_ccy",&csPtr)) {
DEBUGLOG(("AddTxnLog:: net_ccy = [%s]\n",csPtr));
                        PutField_CString(hTxn,"net_ccy",csPtr);
                }

/* PHDATE */
		if (GetField_CString(hContext,"PHDATE",&csPtr)) {
DEBUGLOG(("AddTxnLog:: host_posting_date = [%s]\n",csPtr));
                        PutField_CString(hTxn,"host_posting_date",csPtr);
                        //PutField_CString(hTxn,"transmission_datetime",csPtr);
                        //PutField_CString(hTxn,"tm_date",csPtr);
                }

/* transmission_datetime */
                if (GetField_CString(hContext,"transmission_datetime",&csPtr)) {
DEBUGLOG(("AddTxnLog:: transmission_datetime = [%s]\n",csPtr));
                        PutField_CString(hTxn,"transmission_datetime",csPtr);
                }

/* local_tm_date */
                if (GetField_CString(hContext,"local_tm_date",&csPtr)) {
DEBUGLOG(("AddTxnLog:: local_tm_date = [%s]\n",csPtr));
                        PutField_CString(hTxn,"local_tm_date",csPtr);

                        strcpy(csTxnDateTime, csPtr);
                        PutField_CString(hTxn,"transmission_datetime",csTxnDateTime);

                        PutField_CString(hTxn,"tm_date",csPtr);
                }

/* local_tm_time */
                if (GetField_CString(hContext,"local_tm_time",&csPtr)) {
DEBUGLOG(("AddTxnLog:: local_tm_time = [%s]\n",csPtr));
                        PutField_CString(hTxn,"local_tm_time",csPtr);

                        strcat(csTxnDateTime, csPtr);
                        PutField_CString(hTxn,"transmission_datetime",csTxnDateTime);
                }

/* user_agent*/
                if (GetField_CString(hRequest,"user_agent",&csPtr)) {
DEBUGLOG(("AddTxnLog:: user_agent = [%s]\n",csPtr));
                        PutField_CString(hTxn,"user_agent",csPtr);
                }
	
		// status
		PutField_Char(hTxn,"status",PD_PROCESSING);

		// Add Txn Header
		DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Add");
                iRet = (unsigned long) ((*DBObjPtr)(hTxn));
		if (iRet != PD_OK) {
DEBUGLOG(("AddTxnLog::Call DBOLTransaction::Add Failure!!\n"));
ERRLOG("TxnOiaByUsCIA::AddTxnLog::Call DBOLTransaction::Add Failure!!\n");
                     	iRet = INT_ERR;
               	}		

		// Add Txn Detail
		if (iRet == PD_OK) {

                	if (GetField_CString(hRequest,"txn_ccy",&csTxnCcy)) {
DEBUGLOG(("AddTxnLog:: txn_ccy = [%s]\n",csTxnCcy));

                        	hash_t* hDetail;
                        	hDetail = (hash_t*)  malloc (sizeof(hash_t));
                        	hash_init(hDetail,0);

                        	PutField_CString(hDetail,"txn_seq",csTxnSeq);
                        	PutField_CString(hDetail,"txn_ccy",csTxnCcy);

/* txn_country*/
                        	if (GetField_CString(hRequest,"txn_country",&csTxnCountry)) {
                                	PutField_CString(hDetail,"txn_country",csTxnCountry);
				}

/* remark */
                        	if (GetField_CString(hRequest,"remark",&csPtr)) {
                                	PutField_CString(hDetail,"remark",csPtr);
				}

/* add_user */
				if (GetField_CString(hTxn, "add_user", &csPtr)) {
                                        PutField_CString(hDetail,"add_user",csPtr);
                                        PutField_CString(hDetail,"update_user",csPtr);
                                }

                        	DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","AddDetail");
                        	iRet = (unsigned long) ((*DBObjPtr)(hDetail));
				if (iRet != PD_OK) {
DEBUGLOG(("AddTxnLog::Call DBOLTransaction::AddDetail Failure!!\n"));
ERRLOG("TxnOiaByUsCIA::AddTxnLog::Call DBOLTransaction::AddDetail Failure!!\n");
                        		iRet = INT_ERR;
                		}

                        	hash_destroy(hDetail);
                        	FREE_ME(hDetail);
			}
                }
	}

	hash_destroy(hTxn);
        FREE_ME(hTxn);

DEBUGLOG(("AddTxnLog Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     UpdateTxnLog(const hash_t *hContext,
                     const hash_t *hRequest,
                     const hash_t *hResponse)
{
	int     iRet = PD_OK;
	
	int     iPtr = 0;

        double  dPtr = 0.0;
        
        char    cPtr;
	
	char    *csTxnSeq = NULL;
        char	*csPtr = NULL;

	hash_t  *hTxn;
	hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);

/* do_logging */
        if(GetField_Int(hContext,"do_logging",&iPtr)){
                if(iPtr==PD_NO_LOG)
                        return iRet;
        }

/* txn_seq */
	if (GetField_CString(hContext,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("UpdateTxnLog:: txn_seq = [%s]\n",csTxnSeq));
                PutField_CString(hTxn,"txn_seq",csTxnSeq);
        } else {
DEBUGLOG(("UpdateTxnLog:: txn_seq not found!!\n"));
ERRLOG("TxnOiaByUsCIA:: UpdateTxnLog:: txn_seq not found!!\n");
                iRet = INT_ERR;
        }

	if (iRet == PD_OK) {

/* update_user */
                if (GetField_CString(hContext,"update_user",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: add_user = [%s]\n",csPtr));
                        PutField_CString(hTxn,"update_user",csPtr);
                } else {
                        PutField_CString(hTxn,"update_user",PD_UPDATE_USER);
                }

/* org_txn_seq */
                if (GetField_CString(hContext,"org_txn_seq",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: org_txn_seq = [%s]\n",csPtr));
                        PutField_CString(hTxn,"org_txn_seq",csPtr);
                }

/* process_code */
                if (GetField_CString(hContext,"process_code",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: process_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"process_code",csPtr);
                }

/* process_type */
                if (GetField_CString(hContext,"process_type",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: process_type = [%s]\n",csPtr));
                        PutField_CString(hTxn,"process_type",csPtr);
                }

/* status */
                if (GetField_Char(hContext,"status",&cPtr)) {
DEBUGLOG(("UpdateTxnLog:: status = [%c]\n",cPtr));
                        PutField_Char(hTxn,"status",cPtr);
                }

/* sub_status */
                if (GetField_CString(hContext,"sub_status",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: sub_status = [%s]\n",csPtr));
                        PutField_CString(hTxn,"sub_status",csPtr);
                }

/* ar_ind */
                if (GetField_Char(hContext,"ar_ind",&cPtr)) {
DEBUGLOG(("UpdateTxnLog:: ar_ind = [%c]\n",cPtr));
                        PutField_Char(hTxn,"ar_ind",cPtr);
                }

/* internal_code */
                if (GetField_Int(hContext,"internal_code",&iPtr)) {
DEBUGLOG(("UpdateTxnLog:: internal_code = [%d]\n",iPtr));
                        PutField_Int(hTxn,"internal_code",iPtr);
                }

/* response_code */
		if (GetField_CString(hResponse,"response_code",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: response_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"response_code",csPtr);
                } else if (GetField_CString(hContext,"response_code",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: response_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"response_code",csPtr);
                }

/* merchant_client_id */
                if (GetField_CString(hContext,"merchant_client_id",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: client_id = [%s]\n",csPtr));
                        PutField_CString(hTxn,"client_id",csPtr);
                }

/* net_ccy */
                if (GetField_CString(hContext,"net_ccy",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: net_ccy = [%s]\n",csPtr));
                        PutField_CString(hTxn,"net_ccy",csPtr);
                }

/* txn_amt */
                if (GetField_Double(hContext,"txn_amt",&dPtr)) {
DEBUGLOG(("UpdateTxnLog:: txn_amt = [%f]\n",dPtr));
                        PutField_Double(hTxn,"txn_amt",dPtr);
                }

/* net_amt */
                if (GetField_Double(hContext,"net_amt",&dPtr)) {
DEBUGLOG(("UpdateTxnLog:: net_amt = [%f]\n",dPtr));
                        PutField_Double(hTxn,"net_amt",dPtr);
                }

/* ex_rate */
                if (GetField_Double(hContext,"ex_rate",&dPtr)) {
DEBUGLOG(("UpdateTxnLog:: ex_rate = [%f]\n",dPtr));
                        PutField_Double(hTxn,"ex_rate",dPtr);
                }

/* ex_party */
                if (GetField_Char(hContext,"ex_party",&cPtr)) {
DEBUGLOG(("UpdateTxnLog:: ex_supplier = [%f]\n",cPtr));
                        PutField_Char(hTxn,"ex_supplier",cPtr);
                }

/* markup ccy */
                if(GetField_CString(hContext,"markup_ccy",&csPtr)){
DEBUGLOG(("UpdateTxnLog:: markup_ccy = [%s]\n",csPtr));
                        PutField_CString(hTxn,"markup_ccy",csPtr);
                }
      
/* markup rate */
                if(GetField_Double(hContext,"markup_rate",&dPtr)){
DEBUGLOG(("UpdateTxnLog:: markup_rate = [%f]\n",dPtr));
                        PutField_Double(hTxn,"markup_rate",dPtr);
                }

/* markup amount */
                if(GetField_Double(hContext,"markup_amt",&dPtr)){
DEBUGLOG(("UpdateTxnLog:: markup_amount = [%f]\n",dPtr));
                        PutField_Double(hTxn,"markup_amt",dPtr);
                }

/* dst_txn_amt */
                if(GetField_Double(hContext,"dst_txn_amt",&dPtr)){
DEBUGLOG(("UpdateTxnLog:: dst_txn_amt = [%f]\n",dPtr));
                        PutField_Double(hTxn,"dst_txn_amt",dPtr);
                }

/* reserve_amt */
                if (GetField_Double(hRequest,"reserve_amt",&dPtr)) {
DEBUGLOG(("UpdateRespTxnLog:: reserve_amt = [%f]\n",dPtr));
                        PutField_Double(hTxn,"reserve_amt",dPtr);
                }

/* settlement_txn_amt */
                if(GetField_Double(hContext,"settlement_txn_amt",&dPtr)){
DEBUGLOG(("UpdateTxnLog:: settlement_txn_amt = [%f]\n",dPtr));
                        PutField_Double(hTxn,"settlement_txn_amt",dPtr);
                }

/* display_amt */
                if (GetField_Double(hContext,"display_amt",&dPtr)) {
DEBUGLOG(("UpdateTxnLog:: display_amt = [%f]\n",dPtr));
                        PutField_Double(hTxn,"display_amt",dPtr);
                }

/* merchant_id */
                if (GetField_CString(hContext,"merchant_id",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: merchant_id = [%s]\n",csPtr));
                        PutField_CString(hTxn,"merchant_id",csPtr);
                }

/* merchant_ref */
                if (GetField_CString(hContext,"merchant_ref",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: merchant_ref = [%s]\n",csPtr));
                        PutField_CString(hTxn,"merchant_ref",csPtr);
                }

/* service_code */
                if (GetField_CString(hContext,"service_code",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: service_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"service_code",csPtr);
                }

/* approval_date */
                if (GetField_CString(hContext,"approval_date",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: approval_date = [%s]\n",csPtr));
                        PutField_CString(hTxn,"approval_date",csPtr);
                }

/* approval_timestamp */
                if (GetField_CString(hContext,"approval_timestamp",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: approval_timestamp = [%s]\n",csPtr));
                        PutField_CString(hTxn,"approval_timestamp",csPtr);
                }

/* new_txn_code */
                if (GetField_CString(hContext,"new_txn_code",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: new_txn_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"txn_code",csPtr);
                }

/* user_agent */
                if (GetField_CString(hRequest,"user_agent",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: user_agent = [%s]\n",csPtr));
                        PutField_CString(hTxn,"user_agent",csPtr);
                }

/* recon_status */
                if (GetField_Char(hContext,"recon_status",&cPtr)) {
DEBUGLOG(("UpdateTxnLog:: recon_status = [%c]\n",cPtr));
                        PutField_Char(hTxn,"recon_status",cPtr);
                }

/* recon_date */
                if (GetField_CString(hContext,"recon_date",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: recon_date = [%c]\n",csPtr));
                        PutField_CString(hTxn,"recon_date",csPtr);
                }

/* recon_time */
                if (GetField_CString(hContext,"recon_time",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: recon_time = [%c]\n",csPtr));
                        PutField_CString(hTxn,"recon_time",csPtr);
                }

		// Update Txn Header
                DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxn);
		if (iRet != PD_OK) {
DEBUGLOG(("UpdateTxnLog::Call DBOLTransaction::Update Failure!!\n"));
ERRLOG("TxnOiaByUsCIA::UpdateTxnLog::Call DBOLTransaction::Update Failure!!\n");
                        iRet = INT_ERR;
                }
        }

        hash_destroy(hTxn);
        FREE_ME(hTxn);

DEBUGLOG(("UpdateTxnLog iRet = [%d]\n",iRet));
        return  iRet;
}

int     UpdateTxnReqRef(const hash_t *hContext,
                        const hash_t *hRequest)
{
        int     iRet = PD_OK;
	
	int     iPtr;

	char    cPtr;
	
        char    *csPtr = NULL;

        hash_t  *hTxn;
	hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn, 0);


/* txn_seq */
      	if (GetField_CString(hContext, "req_txn_seq", &csPtr)) {
DEBUGLOG(("UpdateTxnReqRef:: txn_seq = [%s]\n", csPtr));
      		PutField_CString(hTxn, "txn_seq", csPtr);
       	}

	if (iRet == PD_OK) {

/* t1_txn_id */
	      	if (GetField_CString(hContext, "t1_txn_id", &csPtr)) {
DEBUGLOG(("UpdateTxnReqRef:: t1_txn_id = [%s]\n", csPtr));
	             	PutField_CString(hTxn, "t1_txn_id", csPtr);
	      	}

/* t2_txn_id */
	       	if (GetField_CString(hContext, "t2_txn_id", &csPtr)) {
DEBUGLOG(("UpdateTxnReqRef:: t2_txn_id = [%s]\n", csPtr));
	              	PutField_CString(hTxn, "t2_txn_id", csPtr);
	       	}

/* status */
       		if (GetField_Char(hContext, "status", &cPtr)) {
DEBUGLOG(("UpdateTxnReqRef:: status = [%c]\n", cPtr));
        	     	PutField_Char(hTxn, "status", cPtr);
      		}

/* internal_code */
       		if (GetField_Int(hContext, "internal_code", &iPtr)) {
DEBUGLOG(("UpdateTxnReqRef:: internal_code = [%d]\n", iPtr));
        	     	PutField_Int(hTxn, "ret_code", iPtr);
     		}

/* update_user */
     		if (GetField_CString(hContext,"update_user",&csPtr)) {
DEBUGLOG(("UpdateTxnReqRef:: update_user = [%s]\n",csPtr));
        	     	PutField_CString(hTxn,"update_user",csPtr);
   		}

DEBUGLOG(("UpdateTxnReqRef:: Call DBOLTxnRequestRef:: Update!\n"));
              	DBObjPtr = CreateObj(DBPtr,"DBOLTxnRequestRef","Update");
             	iRet = (unsigned long) ((*DBObjPtr)(hTxn));
             	if (iRet != PD_OK) {
DEBUGLOG(("UpdateTxnReqRef:: Call DBOLTxnRequestRef:: Update Failure!!\n"));
ERRLOG("TxnOiaByUsCIA:: UpdateTxnReqRef:: Call DBOLTxnRequestRef:: Update Failure!!\n");
             	}
     	}

        hash_destroy(hTxn);
        FREE_ME(hTxn);

DEBUGLOG(("UpdateTxnReqRef:: iRet = [%d]\n",iRet));

        return iRet;
}

int     FormOmtMessage(hash_t *hContext, const hash_t *hRequest)
{
        int     iRet = PD_OK;

        char    *csTxnSeq;

DEBUGLOG(("FormOmtMesage:: Start\n"));

        // Get OmtTxnSeq
        DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextOmtTxnSeq");
        csTxnSeq = (DBObjPtr)();
DEBUGLOG(("FormOmtMessage:: txn_seq = [%s]\n",csTxnSeq));
        PutField_CString(hContext, "txn_seq",csTxnSeq);

DEBUGLOG(("FormOmtMessage Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessOmtTxn(hash_t *hContext, const hash_t *hRequest, hash_t *hResponse)
{
	int     iRet = PD_OK;

DEBUGLOG(("ProcessOmtTxn:: Start\n"));
	TxnObjPtr = CreateObj(TxnPtr,"TxnOmtByUsCOM","Authorize");
      	iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
       	if (iRet == PD_OK) {

             	TxnObjPtr = CreateObj(TxnPtr,"TxnOmtByUsPBF","Authorize");
              	iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
             	if (iRet != PD_OK) {
DEBUGLOG(("ProcessOmtTxn::Call TxnOmtByUsPBF::Authorize Failure!!\n"));
ERRLOG("TxnOiaByUsCIA::ProcessOmtTxn::Call TxnOmtByUsPBF::Authorize Failure!!\n");
                     	iRet = INT_ERR;
             	}

      	} else {
DEBUGLOG(("ProcessOmtTxn::Call TxnOmtByUsCOM::Authorize Failure!!\n"));
ERRLOG("TxnOiaByUsCIA::ProcessOmtTxn::Call TxnOmtByUsCOM::Authorize Failure!!\n");
              	iRet = INT_ERR;
       	}

DEBUGLOG(("ProcessOmtTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;	
}

