/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/07/25              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsFEU.h"
#include "myrecordset.h"
#include <math.h>

char cDebug;

void TxnMgtByUsFEU(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(BO);
OBJPTR(DB);

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
	int	iRet = PD_OK;

	char	*csTmp = NULL;
	char	*csOrgTxnSeq = NULL;

	char	*csTxnCode = NULL;
	char	*csMerchantId = NULL;
	char	*csServiceCode = NULL;
	char	*csTxnCountry = NULL;
	char	*csLanguage = NULL;
	char    csTxnSeq[PD_TXN_SEQ_LEN +1];

	hash_t  *hRec;
        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

        recordset_init(rRecordSet,0);

DEBUGLOG(("TxnMgtByUsFEU Authorize()\n"));

	if (GetField_CString(hRequest,"org_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("TxnMGtByUsFEU org_txn_seq [%s]\n", csOrgTxnSeq));
	} else {
		if (GetField_CString(hRequest, "enc_txn_seq", &csTmp)) {
DEBUGLOG(("TxnMGtByUsFEU enc_txn_seq [%s]\n", csTmp));

			memset(csTxnSeq, 0, sizeof(csTxnSeq));

			BOObjPtr = CreateObj(BOPtr,"BOSecurity","Decrypt3DESTxnSeq");
			(BOObjPtr)(csTmp, csTxnSeq);
DEBUGLOG(("Authorize() txn_seq = [%s]\n",csTxnSeq));

			PutField_CString(hRequest, "org_txn_seq", csTxnSeq);
		}
		else {
DEBUGLOG(("Authorize ::get txn_seq fail\n"));
ERRLOG("TxnMgtByUsFEU:: Authorize:: get txn_seq fail!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}


	if (iRet == PD_OK)  {
		if (GetField_CString(hRequest, "org_txn_seq", &csOrgTxnSeq)) {
DEBUGLOG(("Authorize :: record = [%s]\n",csOrgTxnSeq));

			DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
			if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {

DEBUGLOG(("Authorize :: found record = [%s]\n",csOrgTxnSeq));
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
                                	if (GetField_CString(hRec,"txn_code",&csTxnCode)) {
DEBUGLOG(("Authorize ::txn_code= [%s]\n",csTxnCode));
                                	}

                                	if (GetField_CString(hRec,"merchant_id",&csMerchantId)) {
DEBUGLOG(("Authorize ::merchant_id= [%s]\n",csMerchantId));
                                	}

	                                if (GetField_CString(hRec,"service_code",&csServiceCode)) {
DEBUGLOG(("Authorize ::service_code= [%s]\n",csServiceCode));
					}
					hRec = RecordSet_GetNext(rRecordSet);
				}
			} else {
DEBUGLOG(("Authorize ::not found record for [%s]\n",csOrgTxnSeq));
ERRLOG("TxnMgtByUsFEU:: Authorize:: not found record for [%s]\n", csOrgTxnSeq);
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
			}
		}
		else {
DEBUGLOG(("Authorize ::not found org_txn_seq\n"));
ERRLOG("TxnMgtByUsFEU:: Authorize:: not found org_txn_seq\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}
	RecordSet_Destroy(rRecordSet);
	

	if (iRet == PD_OK) {	
		recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
		if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec,"txn_country",&csTxnCountry)) {
DEBUGLOG(("Authorize ::txn_country = [%s]\n",csTxnCountry));
                                }
				if (GetField_CString(hRec,"language",&csLanguage)) {
DEBUGLOG(("Authorize ::language = [%s]\n",csLanguage));
                                }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                } else {
DEBUGLOG(("Authorize ::not found detail record for [%s]\n",csOrgTxnSeq));
ERRLOG("TxnMgtByUsFEU:: Authorize:: not found detail record for [%s]\n", csOrgTxnSeq);
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
		RecordSet_Destroy(rRecordSet);
       }


	if (iRet == PD_OK) {

		recordset_init(rRecordSet,0);

DEBUGLOG(("Authorize ::Prepare to call DBTxnFeUrl\n"));

		DBObjPtr = CreateObj(DBPtr,"DBTxnFeUrl","GetFeUrl");
		if ((unsigned long)(DBObjPtr)(csTxnCode,csServiceCode,csMerchantId,csTxnCountry,csLanguage,PD_TXN_RESPONSE,rRecordSet) == PD_OK) {

			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if (GetField_CString(hRec,"fe_url",&csTmp)) {
DEBUGLOG(("Authorize() GetFeUrl - url only = [%s]\n",csTmp));
					PutField_CString(hResponse,"redirect_url",csTmp);
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		else{
DEBUGLOG(("Authorize() GetFeUrl Failed! [%s][%s][%s]\n", csTxnCode, csServiceCode, csTxnCountry));
ERRLOG("TxnMgtBUsFEU::Authorize() Unable to find FE URL for [%s][%s][%s] Direction[%c]\n",csTxnCode,csServiceCode,csTxnCountry);
			iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
		}
		RecordSet_Destroy(rRecordSet);
	}
	
	FREE_ME(rRecordSet);
DEBUGLOG(("Authorize :: exit [%d]\n", iRet));
	return iRet;

}
