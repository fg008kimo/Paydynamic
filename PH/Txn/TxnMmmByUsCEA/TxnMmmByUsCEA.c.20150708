/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/06/23              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMmmByUsCEA.h"
#include "myrecordset.h"

char cDebug;

OBJPTR(BO);

void TxnMmmByUsCEA(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                  hash_t* hResponse)
{
        int     iRet = PD_OK;

	int	iAdjEtypeCnt = 0;
	int	i = 0;
	int	iTmp = 0;

	char	cAction;
	char	cTmp;

	char*	csAdjCode = NULL;
	char*   csTmp = NULL;

	char    csTag[PD_TAG_LEN + 1];

	hash_t  *hData = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hData,0);

	cAction = ' ';
	cTmp = ' ';

DEBUGLOG(("Authorize()\n"));

/* action */
	if (GetField_Char(hRequest,"action",&cAction)) {
		PutField_Char(hData,"action",cAction);
DEBUGLOG(("Authorize: action = [%c]\n",cAction));
	} else {
DEBUGLOG(("Authorize:: action missing!!\n"));
ERRLOG("TxnMmsByUsCEA:: Authorize:: action missing!!\n");
		iRet = INT_ACTION_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

/* code */
        if (GetField_CString(hRequest,"type_data.code",&csAdjCode)) {
		PutField_CString(hData,"adj_code",csAdjCode);
DEBUGLOG(("Authorize: code = [%s]\n",csAdjCode));
        } else {
		if (cAction != PD_ACTION_ADD) {
DEBUGLOG(("Authorize:: code missing!!\n"));
ERRLOG("TxnMmsByUsCEA:: Authorize:: code missing!!\n");
                	iRet = INT_MMS_ADJ_CODE_NOT_FOUND;
                	PutField_Int(hContext,"internal_error",iRet);
		}
        }

/* name */
	if (GetField_CString(hRequest,"type_data.name",&csTmp)) {
		PutField_CString(hData,"adj_desc",csTmp);
DEBUGLOG(("Authorize: name = [%s]\n",csTmp));
        } else {
		if (cAction != PD_ACTION_DELETE) {
DEBUGLOG(("Authorize:: name missing!!\n"));
ERRLOG("TxnMmsByUsCEA:: Authorize:: name missing!!\n");
                	iRet = INT_MMS_ADJ_NAME_NOT_FOUND;
                	PutField_Int(hContext,"internal_error",iRet);
		}
        }

/* etype_cnt */
	if (GetField_CString(hRequest,"type_data.etype_cnt",&csTmp)) {
                iAdjEtypeCnt = atoi(csTmp);
		PutField_Int(hData,"adj_etype_cnt",iAdjEtypeCnt);
DEBUGLOG(("Authorize: etype_cnt = [%d]\n",iAdjEtypeCnt));
        } else {
		if (cAction != PD_ACTION_DELETE) {
DEBUGLOG(("Authorize:: etype_cnt missing!!\n"));
ERRLOG("TxnMmsByUsCEA:: Authorize:: etype_cnt missing!!\n");
                	iRet = INT_MMS_ADJ_ETYPE_CNT_NOT_FOUND;
                	PutField_Int(hContext,"internal_error",iRet);
		}
        }

	if (iRet == PD_OK) {

                // Get Adj Etype 
                for (i=1; i<=iAdjEtypeCnt; i++)
                {
/* et */
			sprintf(csTag,"type_data.etype.%d.et",i);
                        if (GetField_CString(hRequest,csTag,&csTmp)) {
				sprintf(csTag,"adj_etype.%d.etype",i);
				PutField_CString(hData,csTag,csTmp);
DEBUGLOG(("Authorize: et = [%s]\n",csTmp));
			} else {
				if (cAction != PD_ACTION_DELETE) {
DEBUGLOG(("Authorize:: et missing!!\n"));
ERRLOG("TxnMmsByUsCEA:: Authorize:: et missing!!\n");
                			iRet = INT_MMS_ADJ_ETYPE_NOT_FOUND;
                			PutField_Int(hContext,"internal_error",iRet);
				}
			}
		}
	}

/* amt_type */
	if (GetField_CString(hRequest,"type_data.amt_type",&csTmp)) {
		PutField_CString(hData,"amt_type",csTmp);
DEBUGLOG(("Authorize: amt_type = [%s]\n",csTmp));
        } else {
		if (cAction != PD_ACTION_DELETE) {
DEBUGLOG(("Authorize:: amt_type missing!!\n"));
ERRLOG("TxnMmsByUsCEA:: Authorize:: amt_type missing!!\n");
               	 	iRet = INT_AMT_TYPE_NOT_FOUND;
                	PutField_Int(hContext,"internal_error",iRet);
		}
        }	

/* bal_type */
	if (GetField_CString(hRequest,"type_data.bal_type",&csTmp)) {
		cTmp = csTmp[0];
		PutField_Char(hData,"bal_type",cTmp);
DEBUGLOG(("Authorize: bal_type = [%c]\n",cTmp));
        } else {
		if (cAction != PD_ACTION_DELETE) {
DEBUGLOG(("Authorize:: bal_type missing!!\n"));
ERRLOG("TxnMmsByUsCEA:: Authorize:: bal_type missing!!\n");
                	iRet = INT_MMS_BAL_TYPE_NOT_FOUND;
                	PutField_Int(hContext,"internal_error",iRet);
		}
        }

/* adj_nat */
	if (GetField_CString(hRequest,"type_data.adj_nat",&csTmp)) {
		cTmp = csTmp[0];
		PutField_Char(hData,"adj_nat",cTmp);
DEBUGLOG(("Authorize: adj_nat = [%c]\n",cTmp));
        } else {
		if (cAction != PD_ACTION_DELETE) {
DEBUGLOG(("Authorize:: adj_nat missing!!\n"));
ERRLOG("TxnMmsByUsCEA:: Authorize:: adj_nat missing!!\n");
                	iRet = INT_MMS_ADJ_NAT_NOT_FOUND;
                	PutField_Int(hContext,"internal_error",iRet);
		}
        }

/* disabled */
	if (GetField_CString(hRequest,"type_data.disabled",&csTmp)) {
                iTmp = atoi(csTmp);
		PutField_Int(hData,"disabled",iTmp);
DEBUGLOG(("Authorize: disabled = [%d]\n",iTmp));
        } else {
		if (cAction != PD_ACTION_DELETE) {
DEBUGLOG(("Authorize:: disabled missing!!\n"));
ERRLOG("TxnMmsByUsCEA:: Authorize:: disabled missing!!\n");
                	iRet = INT_DISABLED_NOT_FOUND;
                	PutField_Int(hContext,"internal_error",iRet);
		}
        }

/* create_user */
	if (GetField_CString(hRequest,"user",&csTmp)) {
		PutField_CString(hData,"user",csTmp);
		PutField_CString(hData,"create_user",csTmp);
		PutField_CString(hData,"update_user",csTmp);
DEBUGLOG(("Authorize: create_user = [%s]\n",csTmp));
	} else {
DEBUGLOG(("Authorize:: user missing!!\n"));
ERRLOG("TxnMmsByUsCEA:: Authorize:: user missing!!\n");
		iRet = INT_USER_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

	// Action: Add/Update/Delete
	if (iRet == PD_OK) {

		memset(csTag, 0, sizeof(csTag));
                switch (cAction) {
                        case PD_ACTION_ADD:
                                sprintf(csTag, "%s", "AddAdjustmentType");
                                break;
                        case PD_ACTION_UPDATE:
                                sprintf(csTag, "%s", "UpdateAdjustmentType");
                                break;
                        case PD_ACTION_DELETE:
                                sprintf(csTag, "%s", "DeleteAdjustmentType");
                                break;
                        default:
                                iRet = INT_ERR;
                                break;
                }

		if (iRet == PD_OK) {
DEBUGLOG(("Authorize: %s()\n", csTag));
	
DEBUGLOG(("Authorize:: Call BOMMSAdjustment %s\n", csTag));
                    	BOObjPtr = CreateObj(BOPtr, "BOMMSAdjustment",csTag);
                      	iRet = (unsigned long)(*BOObjPtr)(hData,hContext);
                       	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: Call BOMMSAdjustment:: Success!!!\n"));
                      	} else {
                           	iRet = INT_ERR;
                             	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: Call BOMMSAdjustment:: Failure!!!\n"));
ERRLOG("TxnOmtByUsCEA::Authorize::Call BOMMSAdjustment:: Failure!!!\n");
                     	}
		}
	}
	
	// Response
	PutField_CString(hResponse,"reply_txn_code","CEA");
	if (GetField_CString(hData,"adj_code",&csAdjCode)) {
		PutField_CString(hResponse,"adj_code",csAdjCode);
	}
	PutField_Int(hResponse,"ret",iRet);
	
	hash_destroy(hData);
        FREE_ME(hData);

DEBUGLOG(("TxnMmsByUsCEA Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
