/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/11/18              Dirk Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsDLO.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

#define	PD_DETAIL_TAG	"dt"

char cDebug;
OBJPTR(DB);
OBJPTR(Txn);

void TxnMgtByUsDLO(char    cdebug)
{
        cDebug = cdebug;
}

int	Authorize(hash_t* hContext,
		  hash_t* hRequest,
		  hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iDtlRet = PD_OK;

	int	iCnt = 0;
	int	i=0;
	char	csTag[PD_TAG_LEN+1];
	char	*csPartyType = NULL;
	char	*csTxnCode = NULL;
	char	*csTmp = NULL;
	char	*csTmpTxn = NULL;
	char	*csBatchId = NULL;
	char	cTmp;
	double	dTmp = 0.0;

	hash_t *hBatchHeader;
	hBatchHeader = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hBatchHeader,0);

	hash_t *hBatchDetail;
	recordset_t *rBatchDetail;
	rBatchDetail = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rBatchDetail,0);

	hash_t *hTxnHeader;
	recordset_t *rTxnHeader;
	rTxnHeader = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rTxnHeader,0);

DEBUGLOG(("Authorize::Start\n"));
/* txn_seq */
        if(GetField_CString(hContext,"txn_seq",&csTmp)){
		PutField_CString(hResponse,"org_txn_seq",csTmp);
DEBUGLOG(("Authorize::txn_seq = [%s]\n", csTmp));
                PutField_CString(hContext, "from_txn_seq", csTmp);
        }
        else{
DEBUGLOG(("Authorize::txnid not found!!\n"));
ERRLOG("TxnMgtByUsDLO::Authorize::txnid not found!!\n");
                iRet=INT_TXN_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_code*/
        if(GetField_CString(hRequest,"txn_code",&csTmp)){
DEBUGLOG(("Authorize::txn_code = [%s]\n",csTmp));
		PutField_CString(hContext,"txn_code",csTmp);
        }
        else{
DEBUGLOG(("Authorize::txn_code not found!!\n"));
ERRLOG("TxnMgtByUsDLO::Authorize::txn_code not found!!\n");
                iRet=INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* add_user */
        if(GetField_CString(hRequest,"add_user",&csTmp)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csTmp));
                PutField_CString(hContext,"add_user",csTmp);
                PutField_CString(hContext,"update_user",csTmp);
        }

/* PHDATE */
	if(GetField_CString(hContext,"PHDATE",&csTmp)){
		PutField_CString(hContext, "report_date", csTmp);
		PutField_CString(hContext, "txn_date", csTmp);
DEBUGLOG(("Authorize::report_date (PH date) = [%s]\n", csTmp));
	}

/* remark */
        if(GetField_CString(hRequest,"remark",&csTmp)){
DEBUGLOG(("Authorize::remark = [%s]\n",csTmp));
                PutField_CString(hContext,"remark",csTmp);
        } else{
DEBUGLOG(("Authorize::remark not found!!\n"));
ERRLOG("TxnMgtByUsDLO::Authorize::remark not found!!\n");
                iRet=INT_MI_REMARK_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
         }


/* entity_id */
        if(GetField_CString(hRequest,"entity_id",&csTmp)){
DEBUGLOG(("Authorize::entity_id = [%s]\n",csTmp));
                PutField_CString(hContext,"entity_id",csTmp);
        }
	else {
DEBUGLOG(("Authorize::entity_id not found!!\n"));
ERRLOG("TxnMgtByUsDLO::Authorize::entity_id not found!!\n");
		iRet = INT_MI_ENTITY_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
	}

/* txn_country */
	if(GetField_CString(hRequest,"txn_country",&csTmp)){
                PutField_CString(hContext,"txn_country",csTmp);
                PutField_CString(hContext,"country",csTmp);
DEBUGLOG(("Authorize::txn_country= [%s]\n",csTmp));
	} else {
DEBUGLOG(("Authorize::txn_country not found!!\n"));
ERRLOG("TxnMgtByUsDLO::Authorize::txn_country not found!!\n");
		iRet=INT_TXN_COUNTRY_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
        }

/* product_code */
        if(GetField_CString(hRequest,"product_code",&csTmp)){
DEBUGLOG(("Authorize::product_code = [%s]\n",csTmp));
                PutField_CString(hContext,"product_code",csTmp);
                PutField_CString(hContext,"txn_product",csTmp);
        } 
	else {
DEBUGLOG(("Authorize::product_code not found!!\n"));
ERRLOG("TxnMgtByUsDLO::Authorize::product_code not found!!\n");
		iRet=INT_MI_PRODUCT_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
	}

/* txn_ccy */
        if(GetField_CString(hRequest,"txn_ccy",&csTmp)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTmp));
                PutField_CString(hContext,"ccy",csTmp);
                PutField_CString(hContext,"txn_ccy",csTmp);
                PutField_CString(hContext,"net_ccy",csTmp);
                PutField_CString(hContext,"org_txn_ccy",csTmp);
                PutField_CString(hContext,"entity_ccy",csTmp);
        }
        else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMgtByUsDLO::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_amt */
        if(GetField_Double(hContext,"txn_amt",&dTmp)){
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dTmp));
                PutField_Double(hContext, "net_amt", dTmp);
                PutField_Double(hContext, "org_txn_amt", dTmp);
                PutField_Double(hContext, "entity_txn_amount", dTmp);
        }
        else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMgtByUsDLO::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
        }

/* cost_rate */
	if(GetField_CString(hRequest,"cost_rate",&csTmp)){
DEBUGLOG(("Authorize: cost_rate = [%s]\n",csTmp));
	}

/* cost_amt */
	if(GetField_CString(hRequest,"cost_amt",&csTmp)){
DEBUGLOG(("Authorize: cost_amt = [%s]\n",csTmp));
	} else{
DEBUGLOG(("Authorize::cost_amt not found!!\n"));
ERRLOG("TxnMgtByUsDLO::Authorize::cost_amt not found!!\n");
                iRet=INT_MI_COST_AMT_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

/* remit_slip_date */
        if(GetField_CString(hRequest,"remit_slip_date",&csTmp)){
DEBUGLOG(("Authorize::remit_slip_date = [%s]\n", csTmp)); 
		PutField_CString(hContext,"remit_slip_date",csTmp);
        }

/* remit_rate */
	if(GetField_CString(hRequest,"remit_rate",&csTmp)){
DEBUGLOG(("Authorize: remit_rate = [%s]\n",csTmp));
	}

/* cvt_ccy */
        if(GetField_CString(hRequest,"cvt_ccy",&csTmp)){
DEBUGLOG(("Authorize::cvt_ccy= [%s]\n",csTmp));
		PutField_CString(hContext,"cvt_ccy",csTmp);
        }

/* cvt_amt */
	if(GetField_CString(hRequest,"cvt_amt",&csTmp)){
DEBUGLOG(("Authorize: cvt_amt = [%s]\n",csTmp));
	}
	
/* total_cnt */
	if(GetField_Int(hContext,"total_cnt",&iCnt)) {
DEBUGLOG(("Authorize::total_cnt= [%d]\n",iCnt));
	} else {
DEBUGLOG(("Authorize::total_cnt not found!!\n"));
ERRLOG("TxnMgtByUsDLO::Authorize::total_cnt not found!!\n");
		iRet=INT_ERR;
		PutField_Int(hContext,"internal_error",iRet);
	}

	if (iRet == PD_OK) {

		hash_t *hTmp;
		hTmp = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hTmp,0);

		iDtlRet = PD_OK;
		for (i=0; i<iCnt; i++) {

			/* PSP Settlement TxnID */
			sprintf(csTag, "%s_txnid_%d", PD_DETAIL_TAG, i+1);
			if (GetField_CString(hRequest, csTag, &csTmpTxn)) {
DEBUGLOG(("Authorize::[%s] = [%s]\n",csTag, csTmpTxn));
			}

			hash_destroy(hTmp);
			hash_init(hTmp,0);

			PutField_CString(hTmp,"txn_id",csTmpTxn);


			//Call DBMiBatchDetail::GetLastBatchDtByTxnId
DEBUGLOG(("Authorize:: Call DBMiBatchDetail:GetLastBatchDtByTxnId\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMiBatchDetail","GetLastBatchDtByTxnId");
			iDtlRet = ((unsigned long)(*DBObjPtr)(csTmpTxn,hTmp));

			if (iDtlRet != PD_FOUND) {
DEBUGLOG(("Authorize:: DBMiBatchDetail:GetLastBatchDtByTxnId() not found\n"));
ERRLOG("TxnMgtByUsDLO:Authorize:: DBMiBatchDetail:GetLastBatchDtByTxnId() not found\n");
			} else {
				if (GetField_CString(hTmp,"batch_id",&csBatchId)) {
					PutField_CString(hContext,"org_batch_id",csBatchId);
DEBUGLOG(("Authorize:: Last Batch ID = [%s]\n",csBatchId));
				}

				if (GetField_CString(hTmp,"process_type",&csTmp)) {
					if (strcmp(csTmp,PD_MI_TXN_TYPE_PSP_SETTLE) != 0) {
DEBUGLOG(("Authorize:: Batch Process Type [%s] is not PSP Settle!!\n",csTmp));
ERRLOG("TxnMgtByUsDLO:Authorize:: Batch Process Type [%s] is not PSP Settle!!\n",csTmp);
						iDtlRet = INT_ERR;
						break;
					}
				}
			}

			RecordSet_Destroy(rBatchDetail);
			recordset_init(rBatchDetail,0);

DEBUGLOG(("Authorize:: Call DBMiBatchDetail:GetAllDetailByBatchId\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMiBatchDetail","GetAllDetailByBatchId");
			iDtlRet = ((unsigned long)(*DBObjPtr)(csBatchId,rBatchDetail));

			if (iDtlRet != PD_FOUND) {
DEBUGLOG(("Authorize:: DBMiBatchDetail:GetAllDetailByBatchId() not found\n"));
ERRLOG("TxnMgtByUsDLO:Authorize:: DBMiBatchDetail:GetAllDetailByBatchId() not found\n");
			} else {
DEBUGLOG(("Authorize:: record found \n"));
				hBatchDetail = RecordSet_GetFirst(rBatchDetail);
				while (hBatchDetail) {

					//Party Type
					if (GetField_CString(hBatchDetail, "party_type", &csPartyType)) {
DEBUGLOG(("Authorize:: GetAllDetailByBatchId party_type = [%s]\n",csPartyType));
					}

					//Txn Id
					if (GetField_CString(hBatchDetail, "txn_id", &csTmpTxn)) {
DEBUGLOG(("Authorize:: GetAllDetailByBatchId txn_id = [%s]\n",csTmpTxn));

						//Get TxnHeader
						RecordSet_Destroy(rTxnHeader);
						recordset_init(rTxnHeader, 0);
DEBUGLOG(("Authorize:: Call DBTransaction:GetTxnHeader()\n"));
						DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
						iDtlRet = ((unsigned long)(*DBObjPtr)(csTmpTxn,rTxnHeader));

						if (iDtlRet != PD_OK) {
DEBUGLOG(("Authorize:: DBTransaction:GetTxnHeader() not found\n"));
ERRLOG("TxnMgtByUsDLO:Authorize:: DBTransaction:GetTxnHeader() not found\n");
						} else {
							hTxnHeader = RecordSet_GetFirst(rTxnHeader);

							//Check TxnCode
							if (GetField_CString(hTxnHeader,"txn_code",&csTxnCode)) {
DEBUGLOG(("Authorize:: txn_code = [%s]\n",csTxnCode));
							}
							//Check Status
							if (GetField_Char(hTxnHeader,"status",&cTmp)) {
								if (cTmp != PD_COMPLETE) {
									iDtlRet = INT_ERR;
DEBUGLOG(("Authorize:: status [%c] is not completed!!\n",cTmp));
								}
							}
							//Check AR_IND
							if (GetField_Char(hTxnHeader,"ar_ind",&cTmp)) {
								if (cTmp != PD_ACCEPT) {
									iDtlRet = INT_ERR;
DEBUGLOG(("Authorize:: ar_ind [%c] is not accept!!\n",cTmp));
								}
							}
							//Check sub_status
							if (GetField_CString(hTxnHeader,"sub_status",&csTmp)) {
								if (strcmp(csTmp,PD_APPROVED) != 0) {
								iDtlRet = INT_ERR;
DEBUGLOG(("Authorize:: sub_status [%s] is not approved!!\n",csTmp));
								}
							}
DEBUGLOG(("Authorize:: success!\n"));
						}
					}

					if (iDtlRet == PD_OK) {
						if (!strcmp(csTxnCode,PD_TIER_DEPOSIT_COST_TXN)) {
DEBUGLOG(("Authorize:: Skip process [%s] transaction\n",PD_TIER_DEPOSIT_COST_TXN));
						} else {

							//Txn Id
							sprintf(csTag, "%s_txnid_%d", csPartyType,i);
							PutField_CString(hContext,csTag,csTmpTxn);
DEBUGLOG(("Authorize:: GetAllDetailByBatchId [%s] = [%s]\n",csTag,csTmpTxn));

							//Batch ID
							sprintf(csTag, "batchid_%d",i);
							PutField_CString(hContext,csTag,csBatchId);
DEBUGLOG(("Authorize:: GetAllDetailByBatchId [%s] = [%s]\n",csTag,csBatchId));

							//Party ID
							if (GetField_CString(hBatchDetail, "party_id", &csTmp)) {
								sprintf(csTag, "%s_partyid_%d", csPartyType,i);
								PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("Authorize:: GetAllDetailByBatchId [%s] = [%s]\n",csTag,csTmp));
							}

							//Entity ID
							if(!strcmp(csPartyType,PD_MI_ENTITY_RSP)) {
								if (GetField_CString(hBatchDetail, "entity_id",&csTmp)) {
									sprintf(csTag, "%s_entityid_%d", csPartyType,i);
									PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("Authorize:: GetAllDetailByBatchId [%s] = [%s]\n",csTag,csTmp));
								}
							}
						}
					}

					hBatchDetail = RecordSet_GetNext(rBatchDetail);
DEBUGLOG(("Authorize:: Next\n"));
				}
DEBUGLOG(("Authorize:: Call DBMiBatchDetail:GetAllDetailByBatchId Success\n"));
			}

		}
		FREE_ME(hTmp);

		if (iDtlRet != PD_OK) {
			iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
		}

	}




        PutField_CString(hContext,"mini_txn_type",PD_MI_TXN_TYPE_DELIV_OUT);


DEBUGLOG(("Authorize::Call TxnMgtByUs2MiniMMM:Authorize\n"));
	TxnObjPtr = CreateObj(TxnPtr,"TxnMgtByUs2MiniMMM","Authorize");
	iRet = (unsigned long)((*TxnObjPtr)(hContext,hRequest,hResponse));
	if (iRet != PD_OK) {
DEBUGLOG(("Authorize::Call TxnMgtByUs2MiniMMM:Authorize FAILED, ret [%d]\n",iRet));
ERRLOG("TxnMgtByUsDLO::Authorize::Call TxnMgtByUs2MiniMMM:Authorize FAILED, ret [%d]\n",iRet);
	}


	hash_destroy(hBatchHeader);
	FREE_ME(hBatchHeader);

	RecordSet_Destroy(rBatchDetail);
	FREE_ME(rBatchDetail);

	RecordSet_Destroy(rTxnHeader);
	FREE_ME(rTxnHeader);

DEBUGLOG(("TxnMgtByUsDLO Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}
