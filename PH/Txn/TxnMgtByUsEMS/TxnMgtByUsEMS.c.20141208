/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/11/13              Elvis Wong
*/


#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsEMS.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);

void TxnMgtByUsEMS(char cdebug)
{
	cDebug = cdebug;
}

int SetEmailNotifyList(hash_t *hRls)
{
	int	iRet = PD_OK;

	int     iEmailId = 0;

DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord()\n"));
	DBObjPtr = CreateObj(DBPtr, "DBEmailNotifyList", "CheckEmailAddressRecord");
       	iRet = (unsigned long)(*DBObjPtr)(hRls);
       	if (iRet == FOUND) {
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord() email_addr found!!!\n"));

/* mail_id */
       		if (GetField_Int(hRls, "mail_id", &iEmailId)) {
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord() mail_id = [%d]\n", iEmailId));
       		}
	
		iRet = PD_OK;
     	} else if (iRet == NOT_FOUND) {
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord() email_addr not found!!!\n"));

DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::GetLatestEmailId()\n"));	
		DBObjPtr = CreateObj(DBPtr, "DBEmailNotifyList", "GetLatestEmailId");
                iRet = (unsigned long)(*DBObjPtr)(hRls);
                if (iRet == FOUND) {
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::GetLatestEmailId() email_id found!!!\n"));

/* mail_id */
               		if (GetField_Int(hRls, "mail_id", &iEmailId)) {
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::GetLatestEmailId() mail_id = [%d]\n", iEmailId));
                      	}
					
			iRet = PD_OK;
            	} else {
                   	iRet = INT_ERR;
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::GetLatestEmailId() FAILURE!!!\n"));
ERRLOG("TxnMgtByUsEMS::ValidateProcess::Add::failed!!\n");
           	}

		if (iRet == PD_OK) {
/* mail_id */
             		iEmailId++;
                       	PutField_Int(hRls,"mail_id",iEmailId);
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::Add() mail_id = [%d]\n", iEmailId));

DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::Add()\n"));
                      	DBObjPtr = CreateObj(DBPtr, "DBEmailNotifyList", "Add");
                       	iRet = (unsigned long)(*DBObjPtr)(hRls);
                      	if (iRet != PD_OK) {
                        	iRet = INT_ERR;
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::Add() FAILURE!!!\n"));
ERRLOG("TxnMgtByUsEMS::ValidateProcess::Add::failed!!\n");
                      	}
              	}
 	} else {
		iRet = INT_ERR;
DEBUGLOG(("SetEmailNotifyList() call DBEmailNotifyList::CheckEmailAddressRecord() FAILURE!!!\n"));
ERRLOG("TxnMgtByUsEMS::ValidateProcess::CheckEmailAddressRecord::failed!!\n");
	}	

	return iRet;
}

int SetEmailSetting(hash_t *hRls)
{
	int 	iRet = PD_OK;

	int	iDisabled = 0;

/* disabled */
        iDisabled = 0;
      	PutField_Int(hRls,"disabled",iDisabled);
DEBUGLOG(("SetEmailSetting() disabled = [%d]\n", iDisabled));

DEBUGLOG(("SetEmailSetting() call DBEmailSetting::CheckEmailSettingRecord()!!!\n"));
	DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "CheckEmailSettingRecord");
        iRet = (unsigned long)(*DBObjPtr)(hRls);
       	if (iRet == FOUND) {
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::CheckEmailSettingRecord() email_id found!!!\n"));	

DEBUGLOG(("SetEmailSetting() call DBEmailSetting::Update()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "Update");
              	iRet = (unsigned long)(*DBObjPtr)(hRls);
                if (iRet != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::Update() FAILURE!!!\n"));
ERRLOG("TxnMgtByUsEMS::ValidateProcess::Update::failed!!\n");
               	}						
	} else if (iRet == NOT_FOUND) {
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::CheckEmailSettingRecord() email_id not found!!!\n"));

DEBUGLOG(("SetEmailSetting() call DBEmailSetting::Add()\n"));
              	DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "Add");
               	iRet = (unsigned long)(*DBObjPtr)(hRls);
               	if (iRet != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::Add() FAILURE!!!\n"));
ERRLOG("TxnMgtByUsEMS::ValidateProcess::Add::failed!!\n");
              	}	
	} else {
		iRet = INT_ERR;
DEBUGLOG(("SetEmailSetting() call DBEmailSetting::CheckEmailSettingRecord() Failed!!!\n"));
	}

	return iRet;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int	iRet = PD_OK;
	char	cAction;
	
	char	*csEmailAddr;
	char	*csEmailAddrCode;
	
	int	iEmailAddrCodeLen = 0;
	int 	iTotalEmailNum = 0;
	int     i = 0;

	char	*csTmp;
	char	cTmp;
	int	iTmp = 0;
	
	char    csTag[PD_TAG_LEN + 1];

	csEmailAddr = (char*) malloc (1024);
        csEmailAddrCode = (char*) malloc (1024);

/* action */
	if (GetField_CString(hRequest, "action", &csTmp)) {
		cAction = csTmp[0];
DEBUGLOG(("Authorize() action = [%c]\n", cAction));
		PutField_Char(hContext,"action",cAction);
	} else {
DEBUGLOG(("Authorize:: action not found!!\n"));
ERRLOG("TxnMgtByUsEMS:: Authorize:: action not found!!\n");
                iRet = INT_ACTION_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* funct */
        if (GetField_CString(hRequest, "funct", &csTmp)) {
DEBUGLOG(("Authorize() funct = [%s]\n", csTmp));
                PutField_CString(hContext,"funct",csTmp);
        } else {
                iRet = INT_EML_FUNCT_NOT_FOUND;
DEBUGLOG(("Authorize() funct NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsBSE:: Authorize() funct NOT FOUND!!!\n");
        }

/* party_type */
        if (GetField_CString(hRequest, "party_type", &csTmp)) {
                cTmp = csTmp[0];
DEBUGLOG(("Authorize() party_type = [%c]\n", cTmp));
                PutField_Char(hContext,"party_type",cTmp);
        } else {
                iRet = INT_PARTY_TYPE_NOT_FOUND;
DEBUGLOG(("Authorize() party_type NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsBSE:: Authorize() party_type NOT FOUND!!!\n");
        }

/* party_id */
        if (GetField_CString(hRequest, "party_id", &csTmp)) {
DEBUGLOG(("Authorize() party_id = [%s]\n", csTmp));
                PutField_CString(hContext,"party_id",csTmp);
        } else {
                iRet = INT_PARTY_ID_NOT_FOUND;
DEBUGLOG(("Authorize() party_id NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsBSE:: Authorize() party_id NOT FOUND!!!\n");
        }

/* total_email_num */
	if (GetField_CString(hRequest, "total_email_num", &csTmp)) {
                iTotalEmailNum = atoi(csTmp);
DEBUGLOG(("Authorize() total_email_num = [%d]\n", iTotalEmailNum));
                PutField_Int(hContext,"total_email_num",iTotalEmailNum);
        } else {
                iRet = INT_ERR;
DEBUGLOG(("Authorize() total_email_num NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsBSE:: Authorize() total_email_num NOT FOUND!!!\n");
        }

/* email_addr */	
       	if (GetField_CString(hRequest, "email_addr", &csEmailAddr)) {
DEBUGLOG(("Authorize() email_addr = [%s]\n", csEmailAddr));

                iEmailAddrCodeLen = 0; 

		for (i=0; i<iTotalEmailNum; i++) {
			sprintf(csEmailAddrCode,"%s",&csEmailAddr[iEmailAddrCodeLen]);
                     	if (csEmailAddrCode[0] == PD_EMAIL_ADDR_DELIMIT_SYMBOL_CHECK) {
                      		iEmailAddrCodeLen++;

                            	sprintf(csEmailAddrCode,"%s","\0");

                             	sprintf(csTag, "email_addr_%d", i+1);
                   	} else {
                            	strtok(csEmailAddrCode,PD_EMAIL_ADDR_DELIMIT_SYMBOL);
                              	iEmailAddrCodeLen += (strlen(csEmailAddrCode) + 1);

                             	sprintf(csTag, "email_addr_%d", i+1);
                            	PutField_CString(hContext,csTag,csEmailAddrCode);
                     	}
DEBUGLOG(("Authorize() [%s] = [%s]\n",csTag,csEmailAddrCode));
			
		}
       	}

/* default */
        if (GetField_CString(hRequest, "default", &csTmp)) {
                iTmp = atoi(csTmp);
DEBUGLOG(("Authorize() default = [%d]\n", iTmp));
                PutField_Int(hContext,"default",iTmp);
        }

/* user */
        if (GetField_CString(hRequest, "add_user", &csTmp)) {
DEBUGLOG(("Authorize() user = [%s]\n", csTmp));
                PutField_CString(hContext,"create_user",csTmp);
                PutField_CString(hContext,"update_user",csTmp);
        } else {
                iRet = INT_USER_NOT_FOUND;
DEBUGLOG(("Authorize() user NOT FOUND!!!\n"));
ERRLOG("TxnMgtByUsEMS::Authorize() user NOT FOUND!!!\n");
        }

	if (iRet == PD_OK) {	
		if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize() action = add()\n"));

			for (i=0; i<iTotalEmailNum; i++) {
/* mail_addr */
                                sprintf(csTag, "email_addr_%d", i+1);
                                if (GetField_CString(hContext, csTag, &csTmp)) {
DEBUGLOG(("Authorize() [%s] = [%s]\n", csTag, csTmp));
                                        PutField_CString(hContext,"mail_addr",csTmp);
                                } else {
                                       iRet = INT_ERR;
DEBUGLOG(("Authorize() email_addr_%d NOT FOUND!!!\n", i+1));
ERRLOG("TxnOmtByUsBSE:: Authorize() email_addr NOT FOUND!!!\n");
                                }

// SetEmailNotifyList
				if (iRet == PD_OK) {
					iRet = SetEmailNotifyList(hContext);
				}

// AddEmailSetting
				if (iRet == PD_OK) {
/* disabled */
        				iTmp = 0;
        				PutField_Int(hContext,"disabled",iTmp);
DEBUGLOG(("Authorize() disabled = [%d]\n", iTmp));

DEBUGLOG(("Authorize() call DBEmailSetting::AddOriginal()\n"));
					DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "AddOriginal");
					iRet = (unsigned long)(*DBObjPtr)(hContext);
					if (iRet != PD_OK) {
						iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBEmailSetting::AddOriginal() FAILURE!!!\n"));
ERRLOG("TxnMgtByUsEMS::ValidateProcess::AddOriginal::failed!!\n");
					}
				}
			}
		}
		else if (cAction == PD_ACTION_UPDATE) { 
DEBUGLOG(("Authorize() action = update()\n"));

// GetEmailSettingHistoryLogSeq
DEBUGLOG(("Authorize() call DBEmailSettingHistory::GetLatestLogSeq()\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBEmailSettingHistory", "GetLatestLogSeq");
                        iRet = (unsigned long)(*DBObjPtr)(hContext);
                        if (iRet == FOUND) {
DEBUGLOG(("Authorize() call DBEmailSettingHistory::GetLatestLogSeq() found!!!\n"));			

				if (GetField_Int(hContext, "log_seq", &iTmp)) {
					iTmp++;
					PutField_Int(hContext,"log_seq",iTmp);
DEBUGLOG(("Authorize() call DBEmailSettingHistory:: log_seq = [%d]\n", iTmp));
				}

				iRet = PD_OK;
			} else if (iRet == NOT_FOUND) {
DEBUGLOG(("Authorize() call DBEmailSettingHistory::GetLatestLogSeq() not found!!!\n"));

DEBUGLOG(("Authorize() call DBEmailSettingHostory::AddOriginalLog()\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBEmailSettingHistory", "AddOriginalLog");
                                iRet = (unsigned long)(*DBObjPtr)(hContext);
				if (iRet == PD_OK) {
					if (GetField_Int(hContext, "log_seq", &iTmp)) { 
						iTmp++;
                                		PutField_Int(hContext,"log_seq",iTmp);
DEBUGLOG(("Authorize() call DBEmailSettingHistory:: log_seq = [%d]\n", iTmp));
					}
				} else {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBEmailSettingHistory::AddOriginalLog() FAILURE!!!\n"));
ERRLOG("TxnMgtByUsEMS::ValidateProcess::AddOriginalLog::failed!!\n");
                                }
			} else {
DEBUGLOG(("Authorize() call DBEmailSettingHistory::GetLatestLogSeq() FAILURE!!!\n"));
ERRLOG("TxnMgtByUsEMS::ValidateProcess::GetLatestLogSeq::failed!!\n");
			}		

// DisableEmailSetting
			if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBEmailSetting::DisableEmailSettingRecord()\n"));
				DBObjPtr = CreateObj(DBPtr, "DBEmailSetting", "DisableEmailSettingRecord");
                        	iRet = (unsigned long)(*DBObjPtr)(hContext);
                        	if (iRet != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBEmailSetting::DisableEmailSettingRecord() FAILURE!!!\n"));
ERRLOG("TxnMgtByUsEMS::ValidateProcess::DisableEmailSettingRecord::failed!!\n");
                        	}
			}

			for (i=0; i<iTotalEmailNum; i++) {
/* mail_addr */	
				sprintf(csTag, "email_addr_%d", i+1);	
				if (GetField_CString(hContext, csTag, &csTmp)) {				
DEBUGLOG(("Authorize() [%s] = [%s]\n", csTag, csTmp));
					PutField_CString(hContext,"mail_addr",csTmp);
				} else {
         			       iRet = INT_ERR;
DEBUGLOG(("Authorize() email_addr_%d NOT FOUND!!!\n", i+1));
ERRLOG("TxnOmtByUsBSE:: Authorize() email_addr NOT FOUND!!!\n");
        			}

// SetEmailNotifyList
				if (iRet == PD_OK) {
					iRet = SetEmailNotifyList(hContext);
				}
				
// SetEmailSetting
				if (iRet == PD_OK) {
					iRet = SetEmailSetting(hContext);
				}
			}
		}	
	}

	if (iRet != PD_OK) {
		PutField_Int(hContext, "internal_error", iRet);
	}

	FREE_ME(csEmailAddr);
	FREE_ME(csEmailAddrCode);

DEBUGLOG(("Authorize() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;
}
