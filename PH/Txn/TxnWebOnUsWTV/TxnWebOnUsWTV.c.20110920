/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/04/02              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnWebOnUsWTV.h"
#include "myrecordset.h"
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnWebOnUsWTV(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
	int	iRet = PD_OK;
	hash_t  *hOrgTxn,*hTxn,*hRec, *hDetail, *hPsp;
	recordset_t     *rRecordSet;
	char	*csOrgTxnSeq,*csTxnSeq;
	char	*csVal;
	double	dVal;

	hOrgTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hOrgTxn,0);

	hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	hDetail = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hDetail,0);

	hPsp = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hPsp,0);

	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("TxnWebOnUsWTV: Authroize()\n"));
	if (GetField_CString(hRequest,"txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("org txn seq = [%s]\n",csOrgTxnSeq));
		PutField_CString(hOrgTxn,"txn_seq",csOrgTxnSeq);
		PutField_CString(hTxn,"org_txn_seq",csOrgTxnSeq);
		PutField_Char(hOrgTxn,"status",PD_REVERSED);
	}

	
DEBUGLOG(("Call Update Org Transaction\n"));
        DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
        iRet = (unsigned long)(*DBObjPtr)(hOrgTxn);

DEBUGLOG(("New Txn*************\n"));
	if (GetField_CString(hContext,"txn_seq",&csTxnSeq)) {
		PutField_CString(hTxn,"txn_seq",csTxnSeq);
		PutField_CString(hDetail,"txn_seq",csTxnSeq);
		PutField_CString(hPsp,"txn_seq",csTxnSeq);
DEBUGLOG(("New Txn txn seq = [%s]\n",csTxnSeq));
	}
/*db_commit */
	PutField_Int(hTxn,"db_commit",PD_FALSE);

/* ar_id */
	PutField_Char(hTxn,"ar_ind",PD_ACCEPT);
/* status */
	PutField_Char(hTxn,"status",PD_COMPLETE);

/* process type */
	PutField_CString(hTxn,"process_type","0200");

/* process code */
	PutField_CString(hTxn,"process_code","220008");

/* txn_code*/
	PutField_CString(hTxn,"txn_code",PD_WITHDRAW_VOID_TXN_CODE);

/* posting date */
	if (GetField_CString(hContext,"PHDATE",&csVal)) {
DEBUGLOG(("host_posting_date = [%s]\n",csVal));
        	PutField_CString(hTxn,"host_posting_date",csVal);
        	PutField_CString(hTxn,"approval_date",csVal);
        }

/* local_tm_date */
	if (GetField_CString(hContext,"local_tm_date",&csVal)) {
DEBUGLOG(("local_tm_date = [%s]\n",csVal));
        	PutField_CString(hTxn,"local_tm_date",csVal);
        }

/* local_tm_time */
	if (GetField_CString(hContext,"local_tm_time",&csVal)) {
DEBUGLOG(("local_tm_time = [%s]\n",csVal));
        	PutField_CString(hTxn,"local_tm_time",csVal);
        }

	DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
        if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {
/* client id */
			if (GetField_CString(hRec,"client_id",&csVal)) {
DEBUGLOG(("client id = [%s]\n",csVal));
        			PutField_CString(hTxn,"client_id",csVal);
			}
/* merchan_id */
			if (GetField_CString(hRec,"merchant_id",&csVal)) {
DEBUGLOG(("merchant_id = [%s]\n",csVal));
        			PutField_CString(hTxn,"merchant_id",csVal);
			}
/* merchan_ref */
			if (GetField_CString(hRec,"merchant_ref",&csVal)) {
DEBUGLOG(("merchant_ref = [%s]\n",csVal));
        			PutField_CString(hTxn,"merchant_ref",csVal);
			}
/* channel_code */
			if (GetField_CString(hRec,"channel_code",&csVal)) {
DEBUGLOG(("channel_code = [%s]\n",csVal));
        			PutField_CString(hTxn,"channel_code",csVal);
			}
/* transmission_datetime*/
			if (GetField_CString(hRec,"transmission_datetime",&csVal)) {
DEBUGLOG(("transmission_datetime = [%s]\n",csVal));
        			PutField_CString(hTxn,"transmission_datetime",csVal);
			}
/* tm_date */
			if (GetField_CString(hRec,"tm_date",&csVal)) {
DEBUGLOG(("tm_date = [%s]\n",csVal));
        			PutField_CString(hTxn,"tm_date",csVal);
			}
/* tm_time */
			if (GetField_CString(hRec,"tm_time",&csVal)) {
DEBUGLOG(("tm_time = [%s]\n",csVal));
        			PutField_CString(hTxn,"tm_time",csVal);
			}
/* txn_amt */
			if (GetField_Double(hRec,"txn_amt",&dVal)) {
DEBUGLOG(("txn_amt = [%f]\n",dVal));
        			PutField_Double(hTxn,"txn_amt",dVal);
			}

/* net_amt */
			if (GetField_Double(hRec,"net_amt",&dVal)) {
DEBUGLOG(("net_amt = [%f]\n",dVal));
        			PutField_Double(hTxn,"net_amt",dVal);
			}

			 hRec = RecordSet_GetNext(rRecordSet);
		}
        }

DEBUGLOG(("add record\n"));
	if (iRet == PD_OK) {
        	DBObjPtr = CreateObj(DBPtr,"DBTransaction","Add");
        	iRet = (unsigned long)(*DBObjPtr)(hTxn);
	}

	RecordSet_Destroy(rRecordSet);

///////////Txn Detail/////////////

	if (iRet == PD_OK) {

DEBUGLOG(("Get TxnDetail*************\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
        	if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
                	while (hRec) {
/* txn_ccy */
				if (GetField_CString(hRec,"txn_ccy",&csVal)) {
DEBUGLOG(("txn_ccy = [%s]\n",csVal));
        				PutField_CString(hDetail,"txn_ccy",csVal);
				}
/* txn_country */
				if (GetField_CString(hRec,"txn_country",&csVal)) {
DEBUGLOG(("txn_country = [%s]\n",csVal));
        				PutField_CString(hDetail,"txn_country",csVal);
				}
/* pay_method */
				if (GetField_CString(hRec,"pay_method",&csVal)) {
DEBUGLOG(("pay_method = [%s]\n",csVal));
        				PutField_CString(hDetail,"pay_method",csVal);
				}
/* bank_code */
				if (GetField_CString(hRec,"bank_code",&csVal)) {
DEBUGLOG(("bank_code = [%s]\n",csVal));
        				PutField_CString(hDetail,"bank_code",csVal);
				}

/* bank_name */
				if (GetField_CString(hRec,"bank_name",&csVal)) {
DEBUGLOG(("bank_name = [%s]\n",csVal));
        				PutField_CString(hDetail,"bank_name",csVal);
				}

/* branch_name */
				if (GetField_CString(hRec,"branch",&csVal)) {
DEBUGLOG(("branch_name = [%s]\n",csVal));
        				PutField_CString(hDetail,"branch_name",csVal);
				}

/* account_id */
				if (GetField_CString(hRec,"account_id",&csVal)) {
DEBUGLOG(("account_id= [%s]\n",csVal));
        				PutField_CString(hDetail,"account_id",csVal);
				}

/* account_name */
				if (GetField_CString(hRec,"account_name",&csVal)) {
DEBUGLOG(("account_name = [%s]\n",csVal));
        				PutField_CString(hDetail,"account_name",csVal);
				}

/* batch_id */
				if (GetField_CString(hRec,"batch_id",&csVal)) {
DEBUGLOG(("batch_id = [%s]\n",csVal));
        				PutField_CString(hDetail,"batch_id",csVal);
				}

/* identity_id */
				if (GetField_CString(hRec,"identity_id",&csVal)) {
DEBUGLOG(("identity_id= [%s]\n",csVal));
        				PutField_CString(hDetail,"identity_id",csVal);
				}


				 hRec = RecordSet_GetNext(rRecordSet);
			}
        	}

	}
DEBUGLOG(("add txn detail record\n"));
        if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                iRet = (unsigned long)(*DBObjPtr)(hDetail);
        }


	RecordSet_Destroy(rRecordSet);

////////////Txn psp Detail////////////


DEBUGLOG(("Get TxnPspDetail*************\n"));

	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","GetTxnPspDetail");
        	if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
               		while (hRec) {
/* txn_ccy */
				if (GetField_CString(hRec,"txn_ccy",&csVal)) {
DEBUGLOG(("txn_ccy = [%s]\n",csVal));
        				PutField_CString(hPsp,"txn_ccy",csVal);
				}

/* psp_id */
				if (GetField_CString(hRec,"psp_id",&csVal)) {
DEBUGLOG(("psp_id= [%s]\n",csVal));
        				PutField_CString(hPsp,"psp_id",csVal);
				}

/*status */
				if (GetField_CString(hRec,"status",&csVal)) {
DEBUGLOG(("status= [%s]\n",csVal));
        				PutField_CString(hPsp,"status",csVal);
				}

/* notice_status  */
				if (GetField_CString(hRec,"notice_status",&csVal)) {
DEBUGLOG(("notice_status= [%s]\n",csVal));
        				PutField_CString(hPsp,"notice_status",csVal);
				}

/* batch_id*/
				if (GetField_CString(hRec,"batch_id",&csVal)) {
DEBUGLOG(("batch_id= [%s]\n",csVal));
        				PutField_CString(hPsp,"batch_id",csVal);
				}

/* bank_code*/
				if (GetField_CString(hRec,"bank_code",&csVal)) {
DEBUGLOG(("bank_code= [%s]\n",csVal));
        				PutField_CString(hPsp,"bank_code",csVal);
				}

/* bank_branch*/
				if (GetField_CString(hRec,"bank_branch",&csVal)) {
DEBUGLOG(("bank_branch= [%s]\n",csVal));
        				PutField_CString(hPsp,"bank_branch",csVal);
				}

/* account_name*/
				if (GetField_CString(hRec,"account_name",&csVal)) {
DEBUGLOG(("account_name= [%s]\n",csVal));
        				PutField_CString(hPsp,"account_name",csVal);
				}

/* account_no*/
				if (GetField_CString(hRec,"account_no",&csVal)) {
DEBUGLOG(("account_no= [%s]\n",csVal));
        				PutField_CString(hPsp,"account_no",csVal);
				}

/* txn_date*/
				if (GetField_CString(hRec,"txn_date",&csVal)) {
DEBUGLOG(("txn_date= [%s]\n",csVal));
        				PutField_CString(hPsp,"txn_date",csVal);
				}

/* fundin_date*/
				if (GetField_CString(hRec,"fundin_date",&csVal)) {
DEBUGLOG(("fundin_date= [%s]\n",csVal));
        				PutField_CString(hPsp,"fundin_date",csVal);
				}

/* fundout_date*/
				if (GetField_CString(hRec,"fundout_date",&csVal)) {
DEBUGLOG(("fundout_date= [%s]\n",csVal));
        				PutField_CString(hPsp,"fundout_date",csVal);
				}

/* txn_amt */
				if (GetField_Double(hRec,"txn_amt",&dVal)) {
DEBUGLOG(("txn_amt= [%lf]\n",dVal));
        				PutField_Double(hPsp,"txn_amt",dVal);
				}

				hRec = RecordSet_GetNext(rRecordSet);

			}
		}

	}

DEBUGLOG(("add txn psp detail record\n"));
        if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Add");
                iRet = (unsigned long)(*DBObjPtr)(hPsp);
        }

/*
	if (iRet == PD_OK) {

		if (GetField_CString(hRec,"txn_code",&csVal)) {
			if(!strcmp(csVal,PD_WITHDRAW_BATCH_TXN_CODE)){

DEBUGLOG(("call BOBalance:UpdatePayoutResponse()\n"));
				PutField_Char(hContext,"response_mode",PD_REVERSED);

				BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutResponse");
				iRet = (unsigned long)(*DBObjPtr)(hContext);
				if(iRet !=PD_OK){
DEBUGLOG(("BOBalance:UpdatePayoutResponse() Failed\n"));
				}
			}
		}

	}
*/

	iRet = PD_ERR;

	hash_destroy(hOrgTxn);
        FREE_ME(hOrgTxn);

	hash_destroy(hTxn);
        FREE_ME(hTxn);

	hash_destroy(hDetail);
        FREE_ME(hDetail);

	hash_destroy(hPsp);
        FREE_ME(hPsp);

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
DEBUGLOG(("Normal exit iRet = [%d]\n",iRet));	
	return iRet;
}


int PostTxn(hash_t* hContext,
            const hash_t* hRequest,
            hash_t* hResponse)
{
        int     iRet = PD_OK;
DEBUGLOG(("TxnWebOnUsWTV::PostTxn()\n"));
/* precal psp fee if define */
        if (iRet == PD_OK) {
                /* Update Stat */
DEBUGLOG(("TxnWebOnUsWTV::PostTxn():: Call BOPsp CalPspFee\n"));
                BOObjPtr = CreateObj(BOPtr,"BOPsp","CalPspFee");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnWebOnUsWTV::PostTxn():: BOStat::CalPspFee() result = [%d]\n",iRet));
        }



        if (iRet == PD_OK) {
                /* Update Balance */
DEBUGLOG(("TxnWebOnUsWTV::PostTxn():: Call BOBalance\n"));
		PutField_Char(hContext,"response_mode",PD_REVERSED);
                BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutResponse");
                iRet = (unsigned long)(*BOObjPtr)(hContext);
DEBUGLOG(("TxnWebOnUsWTV::PostTxn():: BOBalance::UpdatePayoutResponse() result = [%d]\n",iRet));
        }

/*
        if (iRet == PD_OK) {
                /// Update Stat ///
DEBUGLOG(("TxnWebOnUsWTV::PostTxn():: Call BOStat\n"));
                BOObjPtr = CreateObj(BOPtr,"BOStat","UpdateDspStat");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnWebOnUsWTV::PostTxn():: BOStat::UpdateDspStat() result = [%d]\n",iRet));
        }

        if (iRet == PD_OK) {
                /// Update Stat ///
DEBUGLOG(("TxnWebOnUsWTV::PostTxn():: Call BOStat\n"));
                BOObjPtr = CreateObj(BOPtr,"BOStat","UpdateDspMerchantStat");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnWebOnUsWTV::PostTxn():: BOStat::UpdateDspMerchantStat() result = [%d]\n",iRet));
        }
*/

DEBUGLOG(("TxnWebOnUsWTV::PostTxn() Normal exit iret = [%d]\n",iRet));
        return iRet;
}
