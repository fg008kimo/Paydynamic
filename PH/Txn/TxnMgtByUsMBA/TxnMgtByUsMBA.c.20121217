/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/01/16              Virginia Yun
Include merchant_pay_method			   2012/05/28		   Virginia Yun
Move Merchant_pay_method to TxnMgtByUsMPM	   2012/06/13	           Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsMBA.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

#define PD_DETAIL_TAG   "dt"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMgtByUsMBA(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{

	int	iRet = PD_OK;
	int	iDtlRet = PD_OK;

	char	*csTmp = NULL;	
	int	iCnt, i ;
	//int	iTmp = 0;

	char	*csMid = NULL;
	char	*csService = NULL;
	char	*csCountry = strdup("");

	char	*csCcy = NULL;
	char	*csUser = NULL;

        char    csTag[PD_TAG_LEN +1];

	char	cAction;
	char	cTmp;

        hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));

	recordset_t 	*rRecordSet;
	rRecordSet = (recordset_t *)malloc(sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	//hash_t		*hRec;


DEBUGLOG(("TxnMgtByUsMBA::Authorize\n"));

/* mid */
        if (GetField_CString(hRequest, "merchant_id", &csMid)){
DEBUGLOG(("Authorize::merchant_id = [%s]\n", csMid));
	}
	else {
DEBUGLOG(("Authorize::merchant_Id not found\n"));
ERRLOG("TxnMgtByUsMBA::Authorize::merchant_id not found\n");
		iRet = INT_MERCHANT_ID_NOT_FOUND;

		PutField_Int(hContext,"internal_error",iRet);
	}

/* action */
	if (GetField_CString(hRequest, "action", &csTmp)) {
		cAction = csTmp[0];
DEBUGLOG(("Authorize::action = [%c]\n",cAction));

		// not support delete
		if (cAction != PD_ACTION_ADD && cAction != PD_ACTION_UPDATE) {
DEBUGLOG(("Authorize::action [%d] not accepted!!\n", cAction));
ERRLOG("TxnMgtByUsMBA::Authorize::action not found!!\n");
	                iRet=INT_ACTION_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
		}
	}
	else {
DEBUGLOG(("Authorize::action not found!!\n"));
ERRLOG("TxnMgtByUsMBA::Authorize::action not found!!\n");
                iRet=INT_ACTION_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
	}


/* total_cnt */
	if (GetField_Int(hContext, "total_cnt", &iCnt)) {
DEBUGLOG(("Authorize::total_cnt = [%d]\n", iCnt));
		PutField_Int(hResponse, "total_cnt", iCnt);
	}
	else {
DEBUGLOG(("Authorize::total_cnt not found\n"));
ERRLOG("TxnMgtByUsMBA::Authorize::total_cnt not found\n");
		iRet = INT_FORMAT_ERR;

		PutField_Int(hContext,"internal_error",iRet);
	}


	if (iRet == PD_OK) {
		for (i = 0; i < iCnt; i++) {
       	 		hash_init(hTxn, 0);

/* merchant_id */
			PutField_CString(hTxn, "merchant_id", csMid);

/* ccy */
			memset(csTag, 0, sizeof(csTag));	
			sprintf(csTag, "%s_ccy_%d", PD_DETAIL_TAG, i+1);
			if (GetField_CString(hRequest, csTag, &csCcy)) {
DEBUGLOG(("Authorize::() [%s] = [%s]\n", csTag, csCcy));
                		PutField_CString(hTxn, "ccy", csCcy);
			}	
			else {		
DEBUGLOG(("Authorize::[%s] not found\n", csTag));
ERRLOG("TxnMgtByUsMBA::Authorize::[%s] not found\n", csTag);
				iDtlRet = INT_CURRENCY_CODE_NOT_FOUND;
			}

/* txn_type */
			memset(csTag, 0, sizeof(csTag));	
			sprintf(csTag, "%s_txn_type_%d", PD_DETAIL_TAG, i+1);
			if (GetField_CString(hRequest, csTag, &csTmp)) {
				cTmp = csTmp[0];
DEBUGLOG(("Authorize::() [%s] = [%c]\n", csTag, cTmp));
				PutField_Char(hTxn, "txn_type", cTmp);
			}
			else {
DEBUGLOG(("Authorize::[%s] not found\n", csTag));
ERRLOG("TxnMgtByUsMBA::Authorize::[%s] not found\n", csTag);
                                iDtlRet = INT_ERR; 
			}
				
/* country */
			memset(csTag, 0, sizeof(csTag));	
			sprintf(csTag, "%s_country_%d", PD_DETAIL_TAG, i+1);
                        if (GetField_CString(hRequest, csTag, &csCountry)) {
DEBUGLOG(("Authorize::() [%s] = [%s]\n", csTag, csCountry));
                                PutField_CString(hTxn, "country", csCountry); 
                        } 
                        else {
DEBUGLOG(("Authorize::[%s] not found\n", csTag));
ERRLOG("TxnMgtByUsMBA::Authorize::[%s] not found\n", csTag);
                                iDtlRet = INT_TXN_COUNTRY_NOT_FOUND;
                        }

/* service */
			memset(csTag, 0, sizeof(csTag));	
			sprintf(csTag, "%s_service_%d", PD_DETAIL_TAG, i+1);
                        if (GetField_CString(hRequest, csTag, &csService)) {
DEBUGLOG(("Authorize::() [%s] = [%s]\n", csTag, csService));
                                PutField_CString(hTxn, "service_code", csService); // for add
                                PutField_CString(hTxn, "service", csService); // for update
                        } 
                        else {
DEBUGLOG(("Authorize::[%s] not found\n", csTag));
ERRLOG("TxnMgtByUsMBA::Authorize::[%s] not found\n", csTag);
                                iDtlRet = INT_SERVICE_CODE_MISSING;
                        }

/* status */
			memset(csTag, 0, sizeof(csTag));
			sprintf(csTag, "%s_status_%d", PD_DETAIL_TAG, i+1);
			if (GetField_CString(hRequest, csTag, &csTmp)){
DEBUGLOG(("Authorize::() [%s] = [%s]\n",csTag, csTmp));
				PutField_CString(hTxn, "status", csTmp);
			}
		        else{
               			 PutField_CString(hTxn, "status",PD_ACC_OPEN);
DEBUGLOG(("Authorize::status(default) = [%s]\n",PD_ACC_OPEN));
        		}

/* find country by service */
/*
			if (iDtlRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBService:FindCountryByService\n"));

				DBObjPtr = CreateObj(DBPtr,"DBService","FindCountryByService");
				if((unsigned long)(*DBObjPtr)(csService, csCountry) != FOUND){
DEBUGLOG(("Authorize::DBService:FindCountryByService Failed\n"));
ERRLOG("TxnMgtByUsMBA::Authorize::DBService:FindCountryByService Failed\n");
					iDtlRet = INT_TXN_COUNTRY_NOT_FOUND;
				}
				else {
DEBUGLOG(("Authorize::DBService:FindCountryByService country [%s]\n", csCountry));
                                	PutField_CString(hTxn, "country", csCountry);
				}
			}
*/

/* add_user */
			if(GetField_CString(hRequest,"add_user",&csUser)) {
DEBUGLOG(("Authorize::add_user= [%s]\n",csUser));
				PutField_CString(hTxn,"create_user",csUser);
				PutField_CString(hTxn, "update_user", csUser);
        		}




			if (iDtlRet == PD_OK &&  cAction == PD_ACTION_ADD) {
/* disabled */	
				PutField_Int(hTxn, "disabled", PD_FALSE);
/* status */
				//PutField_CString(hTxn, "status", PD_ACC_OPEN);

				/* Merchant Bal Acct*/
				if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMerchantBalAcct:Add\n"));
					DBObjPtr = CreateObj(DBPtr,"DBMerchantBalAcct","Add");
					if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBMerchantBalAcct:Add Failed\n"));
ERRLOG("TxnMgtByUsMBA::Authorize::DBMerchantBalAcct:Add Failed\n");

						iDtlRet = INT_ERR;
						iRet = INT_ERR;
                			}
			                else {
DEBUGLOG(("Authorize::DBMerchantBalAcct:Add Succ\n"));
                			}
        			}

				/* Merchant Balance */
				if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMerchantBalance:Add\n"));
					DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","Add");
					if((unsigned long)((*DBObjPtr)(csMid,csCountry,csCcy,csService,csUser) != PD_OK)){
DEBUGLOG(("Authorize::DBMerchantBalance:Add Failed\n"));
ERRLOG("TxnMgtByUsMBA::Authorize::DBMerchantBalance:Add Failed\n");

						iDtlRet = INT_ERR;
						iRet = INT_ERR;
                			}
			                else {
DEBUGLOG(("Authorize::DBMerchantBalance:Add Succ\n"));
                			}
        			}

				/* TODO here */
				/* check the system parameter "SP121MAP"
				 * If 'Y' - 1. get pay_method by service_code from service_pay_method table,
				 * 	  - 2. insert merchant_id with pay_method to merchant_pay_method_table.
				 * Else - do nothing.
				 */

			}
			else if (iDtlRet == PD_OK && cAction == PD_ACTION_UPDATE) {

				if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMerchantBalAcct:UpdateMerchantBalAcctStatus\n"));
					DBObjPtr = CreateObj(DBPtr,"DBMerchantBalAcct","UpdateMerchantBalAcctStatus");
                                        if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBMerchantBalAcct:UpdateMerchantBalAcctStatus Failed\n"));
ERRLOG("TxnMgtByUsMBA::Authorize::DBMerchantBalAcct:UpdateMerchantBalAcctStatus Failed\n");

                                                iDtlRet = INT_ERR;
                                                iRet = INT_ERR;
                                        }
                                        else {
DEBUGLOG(("Authorize::DBMerchantBalAcct:UpdateMerchantBalAcctStatus Succ\n"));
                                        }


				}
			}

			
			memset(csTag, 0, sizeof(csTag));
			sprintf(csTag, "ret_%d", i+1);
DEBUGLOG(("Authorize::() [%s] = [%d]\n",csTag, iDtlRet));
			PutField_Int(hResponse, csTag ,iDtlRet);

			if (iDtlRet != PD_OK) {
				iRet = INT_ERR;
			}

		}
	}


        hash_destroy(hTxn);
        FREE_ME(hTxn);

	FREE_ME(csCountry);

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);


DEBUGLOG(("TxnMgtByUsMBA Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}

