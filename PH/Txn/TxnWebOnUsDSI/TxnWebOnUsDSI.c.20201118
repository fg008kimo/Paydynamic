/*
PDProTech (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/05/16              [GOD]
Change Calling Order				   2013/02/25		   [GOD]
for difference ccy case, precal exrate/dstamt	   2013/08/21		   [MSN]
Support VMobile Service New Phase
	update PostTxn				   2017/11/23              [WMC]
Revised PostTxn for PRD255			   2020/03/27		   [MSN]
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnWebOnUsDSI.h"
#include "myrecordset.h"

static char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnWebOnUsDSI(char    cdebug)
{
        cDebug = cdebug;
}

int     PostTxn(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse);
int     AddTxnLog(hash_t *hContext,
                const hash_t* hRequest);
int     UpdateTxnLog(const hash_t* hRequest);

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	char*	csTmp = NULL;
	char*	csTxnCcy;
	char*	csMerchantId;
	char*	csServiceCode;
	char*	csDstCcy;
	double	dTmp;

	//hash_t	*hRec;
	hash_t	*hTxn;
	hTxn = (hash_t*) malloc(sizeof(hash_t));
	hash_init(hTxn, 0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

DEBUGLOG(("TxnWebOnUsDSI: Authroize()\n"));

// fe_url
	if (GetField_CString(hResponse,"fe_url",&csTmp)) {
DEBUGLOG(("Authroize: fe_url = [%s]\n",csTmp));
		PutField_CString(hResponse,"redirect_url",csTmp);
	}

	if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
		PutField_CString(hTxn,"txn_ccy",csTxnCcy);
		PutField_CString(hTxn,"src_ccy",csTxnCcy);
DEBUGLOG(("Authroize: txn_ccy = [%s]\n",csTxnCcy));
	}

	if(GetField_CString(hRequest,"merchant_id",&csMerchantId)){
		PutField_CString(hTxn,"merchant_id",csMerchantId);
DEBUGLOG(("Authroize: merchant_id = [%s]\n",csMerchantId));
	}

	if(GetField_CString(hRequest,"service_code",&csServiceCode)){
		PutField_CString(hTxn,"service_code",csServiceCode);
DEBUGLOG(("Authroize: service_code = [%s]\n",csServiceCode));
	}

	DBObjPtr = CreateObj(DBPtr,"DBRuleLB","GetDstCcyWithoutRule");
	if((unsigned long)(DBObjPtr)(csMerchantId,csServiceCode,hTxn)==PD_OK){
		if (GetField_CString(hTxn,"psp_ccy",&csDstCcy)) {
			PutField_CString(hTxn,"dst_txn_ccy",csDstCcy);
			PutField_CString(hTxn,"dst_ccy",csDstCcy);
DEBUGLOG(("Authroize: Get Psp ccy [%s]\n",csDstCcy));
		}
	}

	if(strcmp(csTxnCcy,csDstCcy)){
DEBUGLOG(("Authroize: src and dst ccy are different, do precal...\n"));
                char cExParty;
                double dExRate;
                double dMarkupRate;
                double dMarkupAmt;
                char* csMarkupCcy;
                double dInterRate;
                char* csInterCcy;
                double dDstAmt;
                double dDstTxnFee;
                double dNetAmt;
                double dTxnFee;

		if(GetField_CString(hContext,"txn_seq",&csTmp)){
			PutField_CString(hTxn,"txn_seq",csTmp);
DEBUGLOG(("Authroize: txn_seq = [%s]\n",csTmp));
		}
		if(GetField_CString(hContext,"txn_code",&csTmp)){
			PutField_CString(hTxn,"txn_code",csTmp);
DEBUGLOG(("Authroize: txn_code = [%s]\n",csTmp));
		}

		if(GetField_CString(hContext,"channel_code",&csTmp)){
			PutField_CString(hTxn,"channel_code",csTmp);
DEBUGLOG(("Authroize: channel_code = [%s]\n",csTmp));
		}

		if (GetField_CString(hRequest,"txn_country",&csTmp)) {
			PutField_CString(hTxn,"txn_country",csTmp);
DEBUGLOG(("Authroize: txn_country = [%s]\n",csTmp));
		}

		if(GetField_CString(hContext,"merchant_client_id",&csTmp)){
			PutField_CString(hTxn,"merchant_client_id",csTmp);
DEBUGLOG(("Authroize: merchant_client_id = [%s]\n",csTmp));
		}

		if(GetField_CString(hContext,"selected_pay_method",&csTmp)){
			PutField_CString(hTxn,"selected_pay_method",csTmp);
DEBUGLOG(("Authroize: selected_pay_method = [%s]\n",csTmp));
		}

		if(GetField_Double(hContext,"txn_amt",&dTmp)){
			PutField_Double(hTxn,"txn_amt",dTmp);
DEBUGLOG(("Authroize: txn_amt = [%lf]\n",dTmp));
		}

		PutField_Int(hTxn,"get_info_only",PD_TRUE);
		BOObjPtr = CreateObj(BOPtr,"BOExchange","GetExchangeInfo");
		iRet = (unsigned long)(*BOObjPtr)(hTxn,hTxn);
DEBUGLOG(("Authorize() BOExchange->GetExchangeInfo = [%d]\n",iRet));

		if(iRet == PD_OK){
                        BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
                        iRet = (unsigned long)(*BOObjPtr)(hTxn,hTxn);
DEBUGLOG(("Authorize() GetTxnFee result = [%d]\n",iRet));
                }

		if(iRet==PD_OK){
                        if(GetField_Char(hTxn,"ex_party",&cExParty)){
DEBUGLOG(("ex_party = [%c]\n",cExParty));
                        }
                        if(GetField_Double(hTxn,"ex_rate",&dExRate)){
DEBUGLOG(("ex_rate = [%lf]\n",dExRate));
                        }
                        if(GetField_Double(hTxn,"markup_rate",&dMarkupRate)){
DEBUGLOG(("markup_rate = [%lf]\n",dMarkupRate));
                        }
                        if(GetField_Double(hTxn,"markup_amt",&dMarkupAmt)){
DEBUGLOG(("markup_amt = [%lf]\n",dMarkupAmt));
                        }
                        if(GetField_CString(hTxn,"markup_ccy",&csMarkupCcy)){
DEBUGLOG(("markup_ccy = [%s]\n",csMarkupCcy));
                        }
                        if(GetField_Double(hTxn,"inter_rate",&dInterRate)){
DEBUGLOG(("inter_rate = [%lf]\n",dInterRate));
                        }
                        if(GetField_CString(hTxn,"inter_ccy",&csInterCcy)){
DEBUGLOG(("inter_ccy = [%s]\n",csInterCcy));
                        }
                        if(GetField_CString(hTxn,"dst_txn_ccy",&csDstCcy)){
DEBUGLOG(("dst_txn_ccy = [%s]\n",csDstCcy));
                        }
                        if(GetField_Double(hTxn,"dst_net_amt",&dDstAmt)){
DEBUGLOG(("dst_net_amt = [%lf]\n",dDstAmt));
			}
			if(GetField_Double(hTxn,"dst_txn_fee",&dDstTxnFee)){
				PutField_Double(hTxn,"dst_fee",dDstTxnFee);
DEBUGLOG(("dst_txn_fee = [%lf]\n",dDstTxnFee));
                        }
                        if(GetField_Double(hTxn,"net_amt",&dNetAmt)){
				PutField_Double(hTxn,"src_net_amt",dNetAmt);
DEBUGLOG(("net_amt = [%lf]\n",dNetAmt));
                        }
                        if(GetField_Double(hTxn,"src_txn_fee",&dTxnFee)){
				PutField_Double(hTxn,"src_fee",dTxnFee);
DEBUGLOG(("src_txn_fee = [%lf]\n",dTxnFee));
			}

			DBObjPtr = CreateObj(DBPtr,"DBTmpCalAmount","Add");
			if((unsigned long)(DBObjPtr)(hTxn)==PD_OK){
DEBUGLOG(("Authorize() DBTmpCalAmount:Add success\n"));
			}
			else{
DEBUGLOG(("Authorize() DBTmpCalAmount:Add failed!!!\n"));
ERRLOG("TxnWebOnUsDSI: Authorize() DBTmpCalAmount:Add failed!!!\n");
			}
		}

	}
	


	iRet = AddTxnLog(hContext,hRequest);


	FREE_ME(hTxn);
	FREE_ME(rRecordSet);
	//FREE_ME(csTmp);
	

DEBUGLOG(("Normal exit iret = [%d]\n",iRet));	
	return iRet;
}

int     AddTxnLog(hash_t *hContext,
                const hash_t* hRequest)
{
        int iRet = PD_OK;
        hash_t  *hPspDetail;
        char*   csTmp;
//        double  dTmp;

        hPspDetail = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hPspDetail,0);

        PutField_CString(hPspDetail,"add_user",PD_UPDATE_USER);
/* txn_seq  */
        if (GetField_CString(hContext,"txn_seq",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_seq = [%s]\n",csTmp));
                PutField_CString(hPspDetail,"txn_seq",csTmp);
        }
/* psp id */
        if (GetField_CString(hContext,"psp_id",&csTmp)) {
DEBUGLOG(("AddTxnLog:: psp_id = [%s]\n",csTmp));
                PutField_CString(hPspDetail,"psp_id",csTmp);
        }

/* txn amt*/
/*
        if (GetField_Double(hContext,"psp_txn_amt",&dTmp)) {
DEBUGLOG(("AddTxnLog:: txn_amt = [%f]\n",dTmp));
                PutField_Double(hPspDetail,"txn_amt",dTmp);
        }
*/
/* txn_ccy*/
/*
       if (GetField_CString(hRequest,"txn_ccy",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_ccy = [%s]\n",csTmp));
                PutField_CString(hPspDetail,"txn_ccy",csTmp);
       }
*/

/* txn_desc */
       if (GetField_CString(hContext,"txn_desc",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_desc = [%s]\n",csTmp));
                PutField_CString(hPspDetail,"desc",csTmp);
        }
        DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Add");
        iRet = (unsigned long)(*DBObjPtr)(hPspDetail);

        hash_destroy(hPspDetail);
        FREE_ME(hPspDetail);

        return iRet;
};

int     UpdateTxnLog(const hash_t* hRequest)
{
        int iRet = PD_OK;
        hash_t  *hCon;
        char*   csTmp;

        hCon = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hCon,0);

        PutField_CString(hCon,"add_user",PD_UPDATE_USER);

/* txn_seq  */
        if (GetField_CString(hRequest,"txn_seq",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_seq = [%s]\n",csTmp));
                PutField_CString(hCon,"txn_seq",csTmp);
        }

/* bank_code  */
        if (GetField_CString(hRequest,"bank_code",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: bank_code = [%s]\n",csTmp));
                PutField_CString(hCon,"bank_code",csTmp);
        }

        DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
        iRet = (unsigned long)(*DBObjPtr)(hCon);

        hash_destroy(hCon);
        FREE_ME(hCon);

        return iRet;
};



int     PostTxn(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
	int 	iRet = PD_OK;
	//int 	iTmpRet = PD_OK;
	//int	iPhase = 0;
	hash_t	*hReq;
	hash_t	*hCon;
	char*	csPtr = NULL;
	char*	csTxnSeq = NULL;
	char*	csMerchantId = NULL;
	char*	csCountry = NULL;
	char*	csCcy = NULL;
	char*	csDstCcy = NULL;
	char*	csChannel = NULL;
	char*	csDate = NULL;
	char*	csServiceCode = NULL;
	char*	csCustomerTag = NULL;
	char*	csCustomerGroup = NULL;
	//char*	csPIDGroup = NULL;
	char*	csPspId = NULL;
	double	dDstTxnAmt = 0.0;
	double	dPtr = 0.0;
	double	dPspCost = 0.0;
		
DEBUGLOG(("PostTxn() Start\n"));

/* Get ReserveAmount */
/* return reserve_amt if rule defined, only return PD_OK*/
DEBUGLOG(("Call BOReserve::GetReserveAmount()\n"));
	BOObjPtr = CreateObj(BOPtr,"BOReserve","GetReserveAmount");
        iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("GetReserve result = [%d]\n",iRet));

	if (iRet == PD_OK) {
/* POST */
		hCon = (hash_t*)  malloc (sizeof(hash_t));
       		hash_init(hCon,0);
		
		hReq = (hash_t*)  malloc (sizeof(hash_t));
        	hash_init(hReq,0);

		PutField_Char(hCon,"post_txn",PD_YES);

/* txn_seq */
		if (GetField_CString(hContext,"org_txn_seq",&csTxnSeq)) {
DEBUGLOG((" txn_seq = [%s]\n",csTxnSeq));
			PutField_CString(hCon,"txn_seq",csTxnSeq);
			PutField_CString(hCon,"from_txn_seq",csTxnSeq);
		}
/* txn_code */
		if (GetField_CString(hContext,"txn_code",&csPtr)) {
DEBUGLOG((" txn_code = [%s]\n",csPtr));
			PutField_CString(hCon,"txn_code",csPtr);
		}

/* dst_txn_amt */
		if (GetField_Double(hContext,"org_dst_txn_amt",&dDstTxnAmt)) {
DEBUGLOG((" dst_txn_amt = [%f]\n",dDstTxnAmt));
			PutField_Double(hCon,"dst_txn_amt",dDstTxnAmt);
		}
/* dst_txn_ccy */
		if (GetField_CString(hContext,"org_dst_txn_ccy",&csDstCcy)) {
DEBUGLOG((" dst_txn_ccy = [%s]\n",csDstCcy));
			PutField_CString(hCon,"dst_txn_ccy",csDstCcy);
		}

/* txn_amt */
		if (GetField_Double(hContext,"org_txn_amt",&dPtr)) {
DEBUGLOG((" txn_amt = [%f]\n",dPtr));
			PutField_Double(hCon,"txn_amt",dPtr);
		}
/* txn_country */
		if (GetField_CString(hContext,"org_txn_country",&csCountry)) {
DEBUGLOG((" txn_country = [%s]\n",csCountry));
			PutField_CString(hReq,"txn_country",csCountry);
		}
/* txn_ccy */
		if (GetField_CString(hContext,"org_txn_ccy",&csCcy)) {
DEBUGLOG((" txn_ccy = [%s]\n",csCcy));
			PutField_CString(hReq,"txn_ccy",csCcy);
		}
/* channel_code */
		if (GetField_CString(hContext,"org_channel_code",&csChannel)) {
DEBUGLOG((" channel_code = [%s]\n",csChannel));
			PutField_CString(hCon,"channel_code",csChannel);
		}
/* service_code */
		if (GetField_CString(hContext,"org_service_code",&csServiceCode)) {
DEBUGLOG((" service_code = [%s]\n",csServiceCode));
			PutField_CString(hReq,"service_code",csServiceCode);
		}
/* merchant_id */
		if (GetField_CString(hContext,"org_merchant_id",&csMerchantId)) {
DEBUGLOG((" merchant_id = [%s]\n",csMerchantId));
			PutField_CString(hReq,"merchant_id",csMerchantId);
		}
/* merchant_client_id */
		if (GetField_CString(hContext,"org_client_id",&csPtr)) {
DEBUGLOG((" merchant_client_id = [%s]\n",csPtr));
			PutField_CString(hCon,"merchant_client_id",csPtr);
		}
/* org_pay_method */
		if (GetField_CString(hContext,"org_pay_method",&csPtr)) {
DEBUGLOG((" org_pay_method = [%s]\n",csPtr));
			PutField_CString(hCon,"selected_pay_method",csPtr);
		}
		if (GetField_CString(hContext,"org_customer_group",&csPtr)) {
DEBUGLOG((" org_customer_group = [%s]\n",csPtr));
		}
		if (GetField_CString(hContext,"org_customer_tag",&csPtr)) {
DEBUGLOG((" org_customer_tag = [%s]\n",csPtr));
		}

		if (GetField_CString(hContext,"PHDATE",&csDate)) {
DEBUGLOG((" PHDATE = [%s]\n",csDate));
		}
/* org_psp_id*/
		if (GetField_CString(hContext,"org_psp_id",&csPspId)) {
DEBUGLOG((" org_psp_id = [%s]\n",csPspId));
		}

		if (iRet == PD_OK) {
/* only get the "Post Source" fee (if any), the normal fee should be calculated in DSR */
DEBUGLOG(("Call BOFee::GetTxnFee() for [Post Source] fee\n"));
                        BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
                        iRet = (unsigned long)(*BOObjPtr)(hCon,hReq);
DEBUGLOG(("GetTxnFee result = [%d]\n",iRet));
                }
		if (iRet == PD_OK) {
DEBUGLOG(("Call BOTxnElements::AddTxnFeeElements() for [Post Source] fee (if any)\n"));
			BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnFeeElements");
                        iRet = (unsigned long)(*BOObjPtr)(hCon);
DEBUGLOG(("AddTxnFeeElements result = [%d]\n",iRet));
		}
		hash_destroy(hReq);
        	FREE_ME(hReq);

		hash_destroy(hCon);
       		FREE_ME(hCon);
	}
	

/* get merchant TFEE element then calculate and return service_fee, net_amt */
	if(iRet == PD_OK){
DEBUGLOG(("Call BOFee::UpdateAmt()\n"));
		BOObjPtr = CreateObj(BOPtr,"BOFee","UpdateAmt");
       		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("UpdateAmt result = [%d]\n",iRet));
	}


/* precal psp cost if rule defined, only return PD_OK */
	if (iRet == PD_OK) {
		PutField_Char(hContext,"txn_type",PD_TYPE_DEPOSIT);
DEBUGLOG(("Call BOPsp::CalPspCosts()\n"));
                BOObjPtr = CreateObj(BOPtr,"BOPsp","CalPspCosts");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);

		if(GetField_Double(hContext, "precal_fee", &dPspCost)){
DEBUGLOG(("CalPspCosts cost = [%lf]\n", dPspCost));
		}
		else{
			if(GetField_Double(hRequest, "service_fee", &dPspCost)){
				PutField_Double(hContext, "precal_fee", dPspCost);
DEBUGLOG(("no rule defined, use the cost returned by PSP = [%lf]\n", dPspCost));
			}
		}
	}

/*  update TxnPspDetail when psp cost > 0.0*/
	if (iRet == PD_OK && dPspCost > 0.0) {

		hash_t *hPspDetail;
		hPspDetail= (hash_t*)  malloc (sizeof(hash_t));
       		hash_init(hPspDetail,0);

DEBUGLOG(("Call DBTxnPspDetail::Update()\n"));
		PutField_CString(hPspDetail, "txn_seq", csTxnSeq);
		PutField_Double(hPspDetail, "service_fee", dPspCost);
		DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
		iRet = (unsigned long)(*DBObjPtr)(hPspDetail);
DEBUGLOG(("Update result = [%d]\n",iRet));

		hash_destroy(hPspDetail);
                FREE_ME(hPspDetail);
	}


/* Update Stat */
	if (iRet == PD_OK) {
DEBUGLOG(("Call BOStat::UpdateDspStat\n"));
                BOObjPtr = CreateObj(BOPtr,"BOStat","UpdateDspStat");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("UpdateDspStat result = [%d]\n",iRet));
	}


	if (iRet == PD_OK) {
DEBUGLOG(("Call BOStat::UpdateDspMerchantStat()\n"));
                BOObjPtr = CreateObj(BOPtr,"BOStat","UpdateDspMerchantStat");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("UpdateDspMerchantStat result = [%d]\n",iRet));
	}

	if (iRet == PD_OK) {
/* Found customer_group,let's insert counter*/
		if (GetField_CString(hContext,"org_customer_group",&csCustomerGroup) &&
		    GetField_CString(hContext,"org_customer_tag",&csCustomerTag)){
DEBUGLOG(("Call BOStat::UpdateCustomerGroupCounter()\n"));
                		BOObjPtr = CreateObj(BOPtr,"BOStat","UpdateCustomerGroupCounter");
				iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("UpdateDspMerchantStat result = [%d]\n",iRet));
		}

	}

/* update Balance at the end to shortend the row lock time */
	if (iRet == PD_OK) {
DEBUGLOG(("Call BOBalance::UpdateTxnAmount()\n"));
                BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdateTxnAmount");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("UpdateTxnAmount result = [%d]\n",iRet));
	}

DEBUGLOG(("PostTxn() Normal exit iret = [%d]\n",iRet));	
	return iRet;
}
