/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/05/16              Cody Chan
Change Calling Order				   2013/02/25		   Cody Chan
for difference ccy case, precal exrate/dstamt	   2013/08/21		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnWebOnUsDSI.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnWebOnUsDSI(char    cdebug)
{
        cDebug = cdebug;
}

int     PostTxn(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse);
int     AddTxnLog(hash_t *hContext,
                const hash_t* hRequest);
int     UpdateTxnLog(const hash_t* hRequest);

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	char*	csTmp = NULL;
	char*	csTxnCcy;
	char*	csMerchantId;
	char*	csServiceCode;
	char*	csDstCcy;
	double	dTmp;

	//hash_t	*hRec;
	hash_t	*hTxn;
	hTxn = (hash_t*) malloc(sizeof(hash_t));
	hash_init(hTxn, 0);

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

DEBUGLOG(("TxnWebOnUsDSI: Authroize()\n"));

// fe_url
	if (GetField_CString(hResponse,"fe_url",&csTmp)) {
DEBUGLOG(("Authroize: fe_url = [%s]\n",csTmp));
		PutField_CString(hResponse,"redirect_url",csTmp);
	}

	if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
		PutField_CString(hTxn,"txn_ccy",csTxnCcy);
		PutField_CString(hTxn,"src_ccy",csTxnCcy);
DEBUGLOG(("Authroize: txn_ccy = [%s]\n",csTxnCcy));
	}

	if(GetField_CString(hRequest,"merchant_id",&csMerchantId)){
		PutField_CString(hTxn,"merchant_id",csMerchantId);
DEBUGLOG(("Authroize: merchant_id = [%s]\n",csMerchantId));
	}

	if(GetField_CString(hRequest,"service_code",&csServiceCode)){
		PutField_CString(hTxn,"service_code",csServiceCode);
DEBUGLOG(("Authroize: service_code = [%s]\n",csServiceCode));
	}

	DBObjPtr = CreateObj(DBPtr,"DBRuleLB","GetDstCcyWithoutRule");
	if((unsigned long)(DBObjPtr)(csMerchantId,csServiceCode,hTxn)==PD_OK){
		if (GetField_CString(hTxn,"psp_ccy",&csDstCcy)) {
			PutField_CString(hTxn,"dst_txn_ccy",csDstCcy);
			PutField_CString(hTxn,"dst_ccy",csDstCcy);
DEBUGLOG(("Authroize: Get Psp ccy [%s]\n",csDstCcy));
		}
	}

	if(strcmp(csTxnCcy,csDstCcy)){
DEBUGLOG(("Authroize: src and dst ccy are different, do precal...\n"));
                char cExParty;
                double dExRate;
                double dMarkupRate;
                double dMarkupAmt;
                char* csMarkupCcy;
                double dInterRate;
                char* csInterCcy;
                double dDstAmt;
                double dDstTxnFee;
                double dNetAmt;
                double dTxnFee;

		if(GetField_CString(hContext,"txn_seq",&csTmp)){
			PutField_CString(hTxn,"txn_seq",csTmp);
DEBUGLOG(("Authroize: txn_seq = [%s]\n",csTmp));
		}
		if(GetField_CString(hContext,"txn_code",&csTmp)){
			PutField_CString(hTxn,"txn_code",csTmp);
DEBUGLOG(("Authroize: txn_code = [%s]\n",csTmp));
		}

		if(GetField_CString(hContext,"channel_code",&csTmp)){
			PutField_CString(hTxn,"channel_code",csTmp);
DEBUGLOG(("Authroize: channel_code = [%s]\n",csTmp));
		}

		if (GetField_CString(hRequest,"txn_country",&csTmp)) {
			PutField_CString(hTxn,"txn_country",csTmp);
DEBUGLOG(("Authroize: txn_country = [%s]\n",csTmp));
		}

		if(GetField_CString(hContext,"merchant_client_id",&csTmp)){
			PutField_CString(hTxn,"merchant_client_id",csTmp);
DEBUGLOG(("Authroize: merchant_client_id = [%s]\n",csTmp));
		}

		if(GetField_CString(hContext,"selected_pay_method",&csTmp)){
			PutField_CString(hTxn,"selected_pay_method",csTmp);
DEBUGLOG(("Authroize: selected_pay_method = [%s]\n",csTmp));
		}

		if(GetField_Double(hContext,"txn_amt",&dTmp)){
			PutField_Double(hTxn,"txn_amt",dTmp);
DEBUGLOG(("Authroize: txn_amt = [%lf]\n",dTmp));
		}

		PutField_Int(hTxn,"get_info_only",PD_TRUE);
		BOObjPtr = CreateObj(BOPtr,"BOExchange","GetExchangeInfo");
		iRet = (unsigned long)(*BOObjPtr)(hTxn,hTxn);
DEBUGLOG(("Authorize() BOExchange->GetExchangeInfo = [%d]\n",iRet));

		if(iRet == PD_OK){
                        BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
                        iRet = (unsigned long)(*BOObjPtr)(hTxn,hTxn);
DEBUGLOG(("Authorize() GetTxnFee result = [%d]\n",iRet));
                }

		if(iRet==PD_OK){
                        if(GetField_Char(hTxn,"ex_party",&cExParty)){
DEBUGLOG(("ex_party = [%c]\n",cExParty));
                        }
                        if(GetField_Double(hTxn,"ex_rate",&dExRate)){
DEBUGLOG(("ex_rate = [%lf]\n",dExRate));
                        }
                        if(GetField_Double(hTxn,"markup_rate",&dMarkupRate)){
DEBUGLOG(("markup_rate = [%lf]\n",dMarkupRate));
                        }
                        if(GetField_Double(hTxn,"markup_amt",&dMarkupAmt)){
DEBUGLOG(("markup_amt = [%lf]\n",dMarkupAmt));
                        }
                        if(GetField_CString(hTxn,"markup_ccy",&csMarkupCcy)){
DEBUGLOG(("markup_ccy = [%s]\n",csMarkupCcy));
                        }
                        if(GetField_Double(hTxn,"inter_rate",&dInterRate)){
DEBUGLOG(("inter_rate = [%lf]\n",dInterRate));
                        }
                        if(GetField_CString(hTxn,"inter_ccy",&csInterCcy)){
DEBUGLOG(("inter_ccy = [%s]\n",csInterCcy));
                        }
                        if(GetField_CString(hTxn,"dst_txn_ccy",&csDstCcy)){
DEBUGLOG(("dst_txn_ccy = [%s]\n",csDstCcy));
                        }
                        if(GetField_Double(hTxn,"dst_net_amt",&dDstAmt)){
DEBUGLOG(("dst_net_amt = [%lf]\n",dDstAmt));
			}
			if(GetField_Double(hTxn,"dst_txn_fee",&dDstTxnFee)){
				PutField_Double(hTxn,"dst_fee",dDstTxnFee);
DEBUGLOG(("dst_txn_fee = [%lf]\n",dDstTxnFee));
                        }
                        if(GetField_Double(hTxn,"net_amt",&dNetAmt)){
				PutField_Double(hTxn,"src_net_amt",dNetAmt);
DEBUGLOG(("net_amt = [%lf]\n",dNetAmt));
                        }
                        if(GetField_Double(hTxn,"src_txn_fee",&dTxnFee)){
				PutField_Double(hTxn,"src_fee",dTxnFee);
DEBUGLOG(("src_txn_fee = [%lf]\n",dTxnFee));
			}

			DBObjPtr = CreateObj(DBPtr,"DBTmpCalAmount","Add");
			if((unsigned long)(DBObjPtr)(hTxn)==PD_OK){
DEBUGLOG(("Authorize() DBTmpCalAmount:Add success\n"));
			}
			else{
DEBUGLOG(("Authorize() DBTmpCalAmount:Add failed!!!\n"));
ERRLOG("TxnWebOnUsDSI: Authorize() DBTmpCalAmount:Add failed!!!\n");
			}
		}

	}
	


	iRet = AddTxnLog(hContext,hRequest);


	FREE_ME(hTxn);
	FREE_ME(rRecordSet);
	//FREE_ME(csTmp);
	

DEBUGLOG(("Normal exit iret = [%d]\n",iRet));	
	return iRet;
}

int     AddTxnLog(hash_t *hContext,
                const hash_t* hRequest)
{
        int iRet = PD_OK;
        hash_t  *hPspDetail;
        char*   csTmp;
//        double  dTmp;

        hPspDetail = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hPspDetail,0);

        PutField_CString(hPspDetail,"add_user",PD_UPDATE_USER);
/* txn_seq  */
        if (GetField_CString(hContext,"txn_seq",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_seq = [%s]\n",csTmp));
                PutField_CString(hPspDetail,"txn_seq",csTmp);
        }
/* psp id */
        if (GetField_CString(hContext,"psp_id",&csTmp)) {
DEBUGLOG(("AddTxnLog:: psp_id = [%s]\n",csTmp));
                PutField_CString(hPspDetail,"psp_id",csTmp);
        }

/* txn amt*/
/*
        if (GetField_Double(hContext,"psp_txn_amt",&dTmp)) {
DEBUGLOG(("AddTxnLog:: txn_amt = [%f]\n",dTmp));
                PutField_Double(hPspDetail,"txn_amt",dTmp);
        }
*/
/* txn_ccy*/
/*
       if (GetField_CString(hRequest,"txn_ccy",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_ccy = [%s]\n",csTmp));
                PutField_CString(hPspDetail,"txn_ccy",csTmp);
       }
*/

/* txn_desc */
       if (GetField_CString(hContext,"txn_desc",&csTmp)) {
DEBUGLOG(("AddTxnLog:: txn_desc = [%s]\n",csTmp));
                PutField_CString(hPspDetail,"desc",csTmp);
        }
        DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Add");
        iRet = (unsigned long)(*DBObjPtr)(hPspDetail);

        hash_destroy(hPspDetail);
        FREE_ME(hPspDetail);

        return iRet;
};

int     UpdateTxnLog(const hash_t* hRequest)
{
        int iRet = PD_OK;
        hash_t  *hCon;
        char*   csTmp;

        hCon = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hCon,0);

        PutField_CString(hCon,"add_user",PD_UPDATE_USER);

/* txn_seq  */
        if (GetField_CString(hRequest,"txn_seq",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_seq = [%s]\n",csTmp));
                PutField_CString(hCon,"txn_seq",csTmp);
        }

/* bank_code  */
        if (GetField_CString(hRequest,"bank_code",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: bank_code = [%s]\n",csTmp));
                PutField_CString(hCon,"bank_code",csTmp);
        }

        DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
        iRet = (unsigned long)(*DBObjPtr)(hCon);

        hash_destroy(hCon);
        FREE_ME(hCon);

        return iRet;
};


int     PostTxn(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
	int 	iRet = PD_OK;
	int 	iTmpRet = PD_OK;
	hash_t	*hReq;
	hash_t	*hCon;
	char*	csPtr;
	char*	csTxnSeq;
	char*	csMerchantId;
	char*	csCountry;
	char*	csCcy;
	char*	csChannel;
	char*	csDate;
	char*	csServiceCode;
	char*	csCustomerTag;
	char*	csCustomerGroup;
	char*	csPIDGroup;
	char*	csPspId;
DEBUGLOG(("TxnWebOnUsDSI::PostTxn()\n"));
/* Get ReserveAmount */
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: Call BOReserve\n"));
	BOObjPtr = CreateObj(BOPtr,"BOReserve","GetReserveAmount");
        iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: GetReserve result = [%d]\n",iRet));

	if (iRet == PD_OK) {
/* POST */
		double	dTmp;
		hCon = (hash_t*)  malloc (sizeof(hash_t));
       		hash_init(hCon,0);
		
		hReq = (hash_t*)  malloc (sizeof(hash_t));
        	hash_init(hReq,0);

		PutField_Char(hCon,"post_txn",PD_YES);

/* txn_seq */
		if (GetField_CString(hContext,"org_txn_seq",&csTxnSeq)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn txn_seq = [%s]\n",csTxnSeq));
			PutField_CString(hCon,"txn_seq",csTxnSeq);
			PutField_CString(hCon,"from_txn_seq",csTxnSeq);
		}
/* txn_code */
		if (GetField_CString(hContext,"txn_code",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn txn_code = [%s]\n",csPtr));
			PutField_CString(hCon,"txn_code",csPtr);
		}

/* dst_txn_amt */
		if (GetField_Double(hContext,"org_dst_txn_amt",&dTmp)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn dst_txn_amt = [%f]\n",dTmp));
			PutField_Double(hCon,"dst_txn_amt",dTmp);
		}
/* dst_txn_ccy */
		if (GetField_CString(hContext,"org_dst_txn_ccy",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn dst_txn_ccy = [%s]\n",csPtr));
			PutField_CString(hCon,"dst_txn_ccy",csPtr);
		}

/* txn_amt */
		if (GetField_Double(hContext,"org_txn_amt",&dTmp)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn txn_amt = [%f]\n",dTmp));
			PutField_Double(hCon,"txn_amt",dTmp);
		}
/* txn_country */
		if (GetField_CString(hContext,"org_txn_country",&csCountry)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn txn_country = [%s]\n",csCountry));
			PutField_CString(hReq,"txn_country",csCountry);
		}
/* txn_ccy */
		if (GetField_CString(hContext,"org_txn_ccy",&csCcy)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn txn_ccy = [%s]\n",csCcy));
			PutField_CString(hReq,"txn_ccy",csCcy);
		}
/* channel_code */
		if (GetField_CString(hContext,"org_channel_code",&csChannel)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn channel_code = [%s]\n",csChannel));
			PutField_CString(hCon,"channel_code",csChannel);
		}
/* service_code */
		if (GetField_CString(hContext,"org_service_code",&csServiceCode)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn service_code = [%s]\n",csServiceCode));
			PutField_CString(hReq,"service_code",csServiceCode);
		}
/* merchant_id */
		if (GetField_CString(hContext,"org_merchant_id",&csMerchantId)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn merchant_id = [%s]\n",csMerchantId));
			PutField_CString(hReq,"merchant_id",csMerchantId);
		}
/* merchant_client_id */
		if (GetField_CString(hContext,"org_client_id",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn merchant_client_id = [%s]\n",csPtr));
			PutField_CString(hCon,"merchant_client_id",csPtr);
		}
/* org_pay_method */
		if (GetField_CString(hContext,"org_pay_method",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn org_pay_method = [%s]\n",csPtr));
			PutField_CString(hCon,"selected_pay_method",csPtr);
		}
/* bank_code */
		if (GetField_CString(hContext,"bank_code",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn bank_code = [%s]\n",csPtr));
			PutField_CString(hCon,"bank_code",csPtr);
		}
		else if (GetField_CString(hResponse,"bank_code",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn bank_code = [%s]\n",csPtr));
			PutField_CString(hCon,"bank_code",csPtr);
		}
/*** update bank code */
		if (GetField_CString(hCon,"bank_code",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn UpdateTxnLog for Bank Code\n"));
			UpdateTxnLog(hCon);
		}
		if (GetField_CString(hContext,"org_customer_group",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn org_customer_group = [%s]\n",csPtr));
		}
		if (GetField_CString(hContext,"org_customer_tag",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn org_customer_tag = [%s]\n",csPtr));
		}

		if (GetField_CString(hContext,"PHDATE",&csDate)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn PHDATE = [%s]\n",csDate));
		}
/* org_psp_id*/
		if (GetField_CString(hContext,"org_psp_id",&csPspId)) {
DEBUGLOG(("TxnWebOnUsDSI::PostTxn org_psp_id = [%s]\n",csPspId));
		}

		if (iRet == PD_OK) {
DEBUGLOG(("TxnWebOnUsDSI:: Call BOFee\n"));
                        BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
                        iRet = (unsigned long)(*BOObjPtr)(hCon,hReq);
DEBUGLOG(("TxnWebOnUsDSI:: GetTxnFee result = [%d]\n",iRet));
                }
		if (iRet == PD_OK) {
			BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnFeeElements");
                        iRet = (unsigned long)(*BOObjPtr)(hCon);
DEBUGLOG(("TxnWebOnUsDSI:: BOTxnElements: AddTxnFeeElements result = [%d]\n",iRet));
		}
		hash_destroy(hReq);
        	FREE_ME(hReq);

/***** post *******/

DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: Call BOFee\n"));
		BOObjPtr = CreateObj(BOPtr,"BOFee","UpdateAmt");
       		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: GetTxnFee result = [%d]\n",iRet));

		hash_destroy(hCon);
       		FREE_ME(hCon);
		
	}
	

/* precal psp fee if define */
	if (iRet == PD_OK) {
		/* Update Stat */
		PutField_Char(hContext,"txn_type",PD_TYPE_DEPOSIT);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: Call BOPsp CalPspCosts\n"));
                BOObjPtr = CreateObj(BOPtr,"BOPsp","CalPspCosts");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: BOStat::CalPspFee() result = [%d]\n",iRet));
	}

/* overwrite the returned service fee to precal fee*/
	/*if(GetField_Double(hRequest,"service_fee",&dTmp)){
		PutField_Double(hContext,"precal_fee",dTmp);
	}*/

	if (iRet == PD_OK) {
		/* Update Stat */
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: Call BOStat\n"));
                BOObjPtr = CreateObj(BOPtr,"BOStat","UpdateDspStat");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: BOStat::UpdateDspStat() result = [%d]\n",iRet));
	}


/* update Balance at the end to shortend the row lock time */
	if (iRet == PD_OK) {
		/* Update Balance */
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: Call BOBalance\n"));
                BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdateTxnAmount");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: updatetxnamount result = [%d]\n",iRet));
	}

	if (iRet == PD_OK) {
		/* Update Stat */
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: Call BOStat\n"));
                BOObjPtr = CreateObj(BOPtr,"BOStat","UpdateDspMerchantStat");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: BOStat::UpdateDspMerchantStat() result = [%d]\n",iRet));
	}

	if (iRet == PD_OK) {
		if (GetField_CString(hContext,"org_customer_group",&csCustomerGroup) &&
		    GetField_CString(hContext,"org_pid_group",&csPIDGroup)) {
			if(!strcmp(csCustomerGroup,csPIDGroup)){
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: Found customer_group,let's insert counter\n"));
                		BOObjPtr = CreateObj(BOPtr,"BOStat","UpdateCustomerGroupCounter");
				iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: BOStat::UpdateDspMerchantStat() result = [%d]\n",iRet));
			}
		}

		//mobile segment
		if(!strcmp(csServiceCode,PD_MOBILE_SERVICE)){
			hash_t  *hRec;
			recordset_t     *rRecordSet;
			rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
			recordset_init(rRecordSet,0);

			hash_t *hTxn;
			hTxn = (hash_t*) malloc (sizeof(hash_t));
			hash_init(hTxn,0);
			if (GetField_CString(hContext,"org_customer_group",&csCustomerGroup) &&
			    GetField_CString(hContext,"org_customer_tag",&csCustomerTag)) {
				//check customer exist in DB or not
				char    csFindGroup[PD_CUSTOMER_GROUP_CODE_LEN +1];

				PutField_CString(hTxn,"customer_group",csCustomerGroup);
				PutField_CString(hTxn,"merchant_id",csMerchantId);
				PutField_CString(hTxn,"customer_tag",csCustomerTag);
				PutField_CString(hTxn,"service_code",csServiceCode);
				PutField_CString(hTxn,"txn_country",csCountry);
				PutField_CString(hTxn,"txn_ccy",csCcy);
				PutField_CString(hTxn,"channel_code",csChannel);
				PutField_CString(hTxn,"PHDATE",csDate);
				PutField_CString(hTxn,"create_user",PD_UPDATE_USER);
				PutField_CString(hTxn,"update_user",PD_UPDATE_USER);

				DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","FindGroup");
				iTmpRet = (unsigned long)(DBObjPtr)(csMerchantId,csCustomerTag,&csFindGroup);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: DBCustomerGroupDetail::FindGroup iRet = [%d]\n",iTmpRet));

				if(iTmpRet==NOT_FOUND){
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: No customer record found, insert to CustomerGroupDetail\n"));
					//check org_customer_group with final pid's customer group 
					DBObjPtr = CreateObj(DBPtr,"DBMobBankMap","FindGroupByPID");
					iTmpRet = (unsigned long)(DBObjPtr)(csPspId,rRecordSet);
					if(iTmpRet == PD_OK){
						hRec = RecordSet_GetFirst(rRecordSet);
						while(hRec){
							if(GetField_CString(hRec,"pid_group",&csPIDGroup)){

								//***If more than one non same group and no same group, need enhancement***//
								if(strcmp(csCustomerGroup,csPIDGroup)){
									//not same, tag to pid's customer group
									PutField_CString(hTxn,"customer_group",csPIDGroup);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: org group[%s] <> pid's group[%s] \n",csCustomerGroup,csPIDGroup));
								}
								else{
									//if same, tag to org_customer_group
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: org group[%s] == pid's group[%s] \n",csCustomerGroup,csPIDGroup));
									break;
								}
							}
							hRec = RecordSet_GetNext(rRecordSet);
						}
					}

					if(iTmpRet == PD_OK){
						DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","Add");
						iTmpRet =  (unsigned long)(DBObjPtr)(hTxn);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: CustomerGroupDetail::Add iRet = [%d]\n",iTmpRet));
					}
				}
				else if(iTmpRet==FOUND){
					int iCanTrf = PD_FALSE;
					PutField_CString(hTxn,"customer_group",csFindGroup);
					//check org_customer_group with final pid's customer group
					DBObjPtr = CreateObj(DBPtr,"DBMobBankMap","FindGroupByPID");
					iTmpRet = (unsigned long)(DBObjPtr)(csPspId,rRecordSet);
					if(iTmpRet == PD_OK){
						hRec = RecordSet_GetFirst(rRecordSet);
						while(hRec){
							if(GetField_CString(hRec,"pid_group",&csPIDGroup)){
								if(strcmp(csFindGroup,csPIDGroup)){
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: org group[%s] <> pid's group[%s] \n",csFindGroup,csPIDGroup));
									//check the trf_out and trf_in flag
									//if both are ON, re-tag the customer to pid's customer group
									//***If more than one non same group, need enhancement***//
									DBObjPtr = CreateObj(DBPtr,"DBMobBankSelection","CheckGroupTransfer");
									iTmpRet = (unsigned long)(DBObjPtr)(csFindGroup,csPIDGroup,&iCanTrf);
									if(iTmpRet == PD_OK && iCanTrf){
										PutField_CString(hTxn,"from_customer_group",csFindGroup);
										PutField_CString(hTxn,"to_customer_group",csPIDGroup);
										PutField_CString(hTxn,"customer_group",csPIDGroup);
										PutField_Int(hTxn,"is_change_his",PD_FALSE);
										BOObjPtr = CreateObj(BOPtr,"BOCustomerGroup","ChangeGroup");
										iRet = (unsigned long)(BOObjPtr)(hTxn);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: BOCustomerGroup ChangeGroup iRet = [%d]\n",iRet));
										break;
									}
								}
								else{
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: org group[%s] == pid's group[%s] \n",csFindGroup,csPIDGroup));
									break;
								}
							}
							hRec = RecordSet_GetNext(rRecordSet);
						}
					}
				}

				if(iTmpRet == PD_OK){
					hash_t * hDtl= (hash_t*)  malloc (sizeof(hash_t));
					hash_init(hDtl,0);
					PutField_CString(hDtl,"txn_seq",csTxnSeq);
					if(GetField_CString(hTxn,"customer_group",&csPtr))
						PutField_CString(hDtl,"customer_group",csPtr);
					DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
					iTmpRet =  (unsigned long)(DBObjPtr)(hDtl);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: DBTransaction::updateDetail iRet = [%d]\n",iTmpRet));
					FREE_ME(hDtl);
				}
				if(iTmpRet == PD_OK){
					BOObjPtr = CreateObj(BOPtr,"BOCustomerGroup","HandleMobSegmentThreshold");
					iTmpRet =  (unsigned long)(BOObjPtr)(hTxn);
DEBUGLOG(("TxnWebOnUsDSI::PostTxn():: BOCustomerGroup::HandleMobSegmentThreshold iRet = [%d]\n",iTmpRet));
				}

			}

			FREE_ME(hTxn);
			RecordSet_Destroy(rRecordSet);
			FREE_ME(rRecordSet);
		}
	}

DEBUGLOG(("TxnWebOnUsDSI::PostTxn() Normal exit iret = [%d]\n",iRet));	
	return iRet;
}
