/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/06/18              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMmmByUsCOM.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

int CheckAmt(char* csCcy,char* csAmt,double *dAmt);
int GetNatureId(hash_t* hContext,const hash_t *hReq);

void TxnMmmByUsCOM(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	char	*csTxnCcy;
	char	*csTxnAmt;
	char	*csPtr;
	hash_t	*hTmpData;

	double	dTxnAmt;
DEBUGLOG(("Authorize()\n"));


	hTmpData = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpData,0);

/* check txn country */

/* check txn amt */
	if (GetField_CString(hRequest,"txn_amt",&csTxnAmt)) {
		if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
                	DBObjPtr = CreateObj(DBPtr,"DBCurrency","FindCurrency");
                       	if ((unsigned long)(DBObjPtr)(csTxnCcy) == FOUND) {
DEBUGLOG(("Authorize() DBCurrency->FindCurrency [%s]success\n",csTxnCcy));
/* net ccy */
                      		PutField_CString(hContext,"net_ccy",csTxnCcy);
                                PutField_CString(hContext,"org_txn_ccy",csTxnCcy);
                        }
                        else{
                       		iRet = INT_INVALID_CURRENCY_CODE;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Currency code invalid [%s]\n",csTxnCcy));
ERRLOG("TxnMmmByUsCOM:Authorize() Currency code invalid\n");
                        }
            	}
               	else{
               		iRet = INT_CURRENCY_CODE_NOT_FOUND;
                      	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Currency code not found\n"));
ERRLOG(("TxnMmmByUsCOM:Authorize() Currency code not found\n"));
		}
		if (iRet == PD_OK ) {
			iRet =  CheckAmt(csTxnCcy,csTxnAmt,&dTxnAmt);
			if (iRet != PD_OK)
               			PutField_Int(hContext,"internal_error",iRet);
			else 
               			PutField_Double(hContext,"txn_amt",dTxnAmt);
		}
	}

/* check entity id if exist */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest,"entity_id",&csPtr)) {
DEBUGLOG(("Authorize() entity id from Request = [%s]\n",csPtr));
                	BOObjPtr = CreateObj(BOPtr,"BOMMSEntity","GetEntityId");
                       	iRet = (unsigned long)(BOObjPtr)(csPtr,hTmpData);

			if (iRet != PD_OK) {
				iRet = INT_MMS_ENTITY_ID_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() entity id [%s] record not found\n",csPtr));
ERRLOG("TxnMmmByUsCOM:Authorize() entity id [%s] record not found\n",csPtr);
			}
			else {
				PutField_CString(hContext,"entity_id",csPtr);
			}
		}
	}
/* check nature group if exist */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest,PD_NATURE_COUNT_TAG,&csPtr)) {
DEBUGLOG(("Authorize() [%s] = [%s]\n",PD_NATURE_COUNT_TAG,csPtr));
			if (!is_numeric(csPtr)) {
				iRet = INT_INVALID_COUNT;
DEBUGLOG(("Authorize() Invalid [%s] = [%s]\n",PD_NATURE_COUNT_TAG,csPtr));
ERRLOG("TxnMmmByUsCOM:Authorize() Invalid Count [%s] = [%s]\n",PD_NATURE_COUNT_TAG,csPtr);
			}
			else {
				PutField_Int(hContext,PD_NATURE_COUNT_TAG, ctos((const unsigned char*)csPtr,(strlen(csPtr))));
			}

			if (iRet == PD_OK) {
				iRet = GetNatureId(hContext,hRequest);
DEBUGLOG(("Authorize()  iRet = [%d] from GetNatureId\n",iRet));
				if (iRet != PD_OK) {
					iRet = INT_MMS_NATURE_ID_NOT_FOUND;
               				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()  Nature ID not found\n"));
ERRLOG("TxnMmmByUsCOM:Authorize()  Nature ID not found\n");
				}
			}
		}
	}


	hash_destroy(hTmpData);
	FREE_ME(hTmpData);
DEBUGLOG(("TxnMmmByUsCOM Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}

int CheckAmt(char* csCcy,char* csAmt,double *dTxnAmt)
{
	int	iRet = PD_OK;

	long	lTmp;
DEBUGLOG(("CheckAmt()\n"));
	if(strlen(csAmt)>(PD_DIGIT_LEN+PD_DECIMAL_LEN)){
       		iRet =  INT_INVALID_PAY_AMOUNT;
DEBUGLOG(("CheckAmt()txn_amt length too long[%s]\n",csAmt));
ERRLOG("TxnMmmByUsCOM::CheckAmt() txn_amt length too long\n");
       	}
        else{
DEBUGLOG(("CheckAmt amt in string = [%s]\n",csAmt));
       		*dTxnAmt = string2double((const unsigned char*)csAmt);
DEBUGLOG(("CheckAmt() txn_amt = [%f]\n",*dTxnAmt));
	}

/* if TWD */
        if (iRet==PD_OK) {
DEBUGLOG(("TxnMmmByUsCOM::CheckAmt() check is support decimal\n"));
		DBObjPtr = CreateObj(DBPtr,"DBCurrency","IsSupportDecimal");
               	if ((unsigned long)((DBObjPtr)(csCcy))!=PD_TRUE){
DEBUGLOG(("TxnMmmByUsCOM::CheckAmt() [%s] doesn't support decimal\n",csCcy));
			lTmp = (long) *dTxnAmt;
                       	if (*dTxnAmt > lTmp) {
                       		iRet = INT_UNSUPPORTED_PAY_AMOUNT;
ERRLOG("TxnMmmByUsCOM::CheckAmt() unsupported transaction amount [%f]\n",*dTxnAmt);
                  	}
              	}
       	}

DEBUGLOG(("CheckAmt() Normal Return iRet = [%d]\n",iRet));
	return 	iRet;
}

int GetNatureId(hash_t* hContext,const hash_t* hReq)
{
	int	iRet = PD_OK;
	char	csNatureId[PD_NATURE_ID_LEN +1];
DEBUGLOG(("GetNatureId ()\n"));

	BOObjPtr = CreateObj(BOPtr,"BOMMSEntityNature","FindEntityNatureId");
	iRet =	(unsigned long)(*BOObjPtr)(hContext,hReq,csNatureId);
DEBUGLOG(("GetNatureId() return from BOMMSEntityNature iRet = [%d] \n",iRet));
	if (iRet == PD_OK) {
		PutField_CString(hContext,"nature_id",csNatureId);
DEBUGLOG(("GetNatureId() nature id = [%s]\n",csNatureId));
	}

DEBUGLOG(("GetNatureId () Normal exit iRet = [%d]\n",iRet));
	return	iRet;
}
