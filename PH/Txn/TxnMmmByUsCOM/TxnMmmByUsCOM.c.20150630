/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/06/18              Cody Chan
CheckEntityBalAcct				   2015/06/25		   Cody Chan
Add return entity_type into hContext		   2015/06/25		   Dirk Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMmmByUsCOM.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

int CheckAmt(char* csCcy,char* csAmt,double *dAmt);
int GetSrcNatureId(hash_t* hContext,const hash_t *hReq);

void TxnMmmByUsCOM(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK,i,iBalCnt = 0;
	char	*csTxnCcy;
	char	*csTxnAmt;
	char	*csPtr;
	char	*csEntityType;
	char	*csTxnCode;
	char	csTag[PD_TAG_LEN +1];
	hash_t	*hTmpData;

	double	dTxnAmt;
DEBUGLOG(("Authorize()\n"));


	hTmpData = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpData,0);


	GetField_CString(hContext,"txn_code",&csTxnCode);
DEBUGLOG(("Authorize txn_code = [%s]\n",csTxnCode));
/* check txn country */

/* check txn amt */
	if (GetField_CString(hRequest,"txn_amt",&csTxnAmt)) {
		if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
                	DBObjPtr = CreateObj(DBPtr,"DBCurrency","FindCurrency");
                       	if ((unsigned long)(DBObjPtr)(csTxnCcy) == FOUND) {
DEBUGLOG(("Authorize() DBCurrency->FindCurrency [%s]success\n",csTxnCcy));
/* net ccy */
                      		PutField_CString(hContext,"net_ccy",csTxnCcy);
                                PutField_CString(hContext,"org_txn_ccy",csTxnCcy);
                        }
                        else{
                       		iRet = INT_INVALID_CURRENCY_CODE;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Currency code invalid [%s]\n",csTxnCcy));
ERRLOG("TxnMmmByUsCOM:Authorize() Currency code invalid\n");
                        }
            	}
               	else{
               		iRet = INT_CURRENCY_CODE_NOT_FOUND;
                      	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Currency code not found\n"));
ERRLOG(("TxnMmmByUsCOM:Authorize() Currency code not found\n"));
		}
		if (iRet == PD_OK ) {
			iRet =  CheckAmt(csTxnCcy,csTxnAmt,&dTxnAmt);
			if (iRet != PD_OK)
               			PutField_Int(hContext,"internal_error",iRet);
			else 
               			PutField_Double(hContext,"txn_amt",dTxnAmt);
		}
	}

/* check entity id if exist */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest,"txn_data.entity_id",&csPtr)) {
DEBUGLOG(("Authorize() entity id from Request = [%s]\n",csPtr));
                	BOObjPtr = CreateObj(BOPtr,"BOMMSEntity","GetEntityId");
                       	iRet = (unsigned long)(BOObjPtr)(csPtr,hTmpData);

			if (iRet != PD_OK) {
				iRet = INT_MMS_ENTITY_ID_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() entity id [%s] record not found\n",csPtr));
ERRLOG("TxnMmmByUsCOM:Authorize() entity id [%s] record not found\n",csPtr);
			}
			else {
				PutField_CString(hContext,"entity_id",csPtr);
				if (GetField_CString(hTmpData,"entity_type",&csEntityType))
					PutField_CString(hContext,"entity_type",csEntityType);
			}

			if (iRet == PD_OK ) {
				if (GetField_CString(hRequest,"txn_ccy",&csPtr) && GetField_CString(hRequest,"txn_country",&csPtr)) {
                			BOObjPtr = CreateObj(BOPtr,"BOMMSEntityBalAcct","CheckEntityBalAcct");
                			iRet = (unsigned long)((BOObjPtr)(hContext,hRequest));
DEBUGLOG(("TxnMmmByUsCOM: iRet = [%d] return from BOMMSEntityBalAcct:CheckEntityBalAcct\n",iRet));
				}
			}
		}
	}
/* check nature group if exist */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest,"txn_data.bal_cnt",&csPtr)) {
DEBUGLOG(("Authorize() [%s] = [%s]\n","txn_data.bal_cnt",csPtr));
			if (!is_numeric(csPtr)) {
				iRet = INT_INVALID_COUNT;
DEBUGLOG(("Authorize() Invalid [%s] = [%s]\n","txn_data.bal_cnt",csPtr));
ERRLOG("TxnMmmByUsCOM:Authorize() Invalid Count [%s] = [%s]\n","txn_data.bal_cnt",csPtr);
			}
			else {
				iBalCnt = ctos((const unsigned char*)csPtr,(strlen(csPtr)));
				PutField_Int(hContext,"bal_cnt", iBalCnt);
			}

			if (iRet == PD_OK) {

/* skip check if it is balance account */
				if (strcmp(csTxnCode,PD_TXN_CODE_MMM_BALACE_ACCOUNT)) {
					iRet = GetSrcNatureId(hContext,hRequest);
DEBUGLOG(("Authorize()  iRet = [%d] from GetSrcNatureId\n",iRet));
					if (iRet != PD_OK) {
						iRet = INT_MMS_NATURE_ID_NOT_FOUND;
               					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()  Nature ID not found\n"));
ERRLOG("TxnMmmByUsCOM:Authorize()  Nature ID not found\n");
					}
				}
			}
			if (iRet == PD_OK) {
				for (i = 0 ; i < iBalCnt; i++) {
					sprintf(csTag,"txn_data.bal.%d.sel_type",i+1);
DEBUGLOG(("TxnMmmByUsCOM:Authorize() sel_type from message = [%s]\n",csTag));
					if (GetField_CString(hRequest,csTag,&csPtr)) {
DEBUGLOG(("TxnMmmByUsCOM:Authorize() sel_type from message = [%s]\n",csPtr));
                		       		if (csPtr[0] != PD_MMS_SELECT_BAL && csPtr[0] != PD_MMS_SELECT_TXN ) {
                             				iRet = INT_MMS_INVALID_SELECT_TYPE;
                                			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()  invalid select_type\n"));
ERRLOG("TxnMmmByUsCOM:Authorize()  invalid select_type\n");
                        			}
						else {
							sprintf(csTag,"bal.%d.sel_type",i+1);
DEBUGLOG(("TxnMmmByUsCOM:Authorize() [%s] = [%s]\n",csTag,csPtr));
                                			PutField_Char(hContext,csTag,csPtr[0]);
						}
                			}
				}
			}
		}
	}


	hash_destroy(hTmpData);
	FREE_ME(hTmpData);
DEBUGLOG(("TxnMmmByUsCOM Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}

int CheckAmt(char* csCcy,char* csAmt,double *dTxnAmt)
{
	int	iRet = PD_OK;

	long	lTmp;
DEBUGLOG(("CheckAmt()\n"));
	if(strlen(csAmt)>(PD_DIGIT_LEN+PD_DECIMAL_LEN)){
       		iRet =  INT_INVALID_PAY_AMOUNT;
DEBUGLOG(("CheckAmt()txn_amt length too long[%s]\n",csAmt));
ERRLOG("TxnMmmByUsCOM::CheckAmt() txn_amt length too long\n");
       	}
        else{
DEBUGLOG(("CheckAmt amt in string = [%s]\n",csAmt));
       		*dTxnAmt = string2double((const unsigned char*)csAmt);
DEBUGLOG(("CheckAmt() txn_amt = [%f]\n",*dTxnAmt));
	}

/* if TWD */
        if (iRet==PD_OK) {
DEBUGLOG(("TxnMmmByUsCOM::CheckAmt() check is support decimal\n"));
		DBObjPtr = CreateObj(DBPtr,"DBCurrency","IsSupportDecimal");
               	if ((unsigned long)((DBObjPtr)(csCcy))!=PD_TRUE){
DEBUGLOG(("TxnMmmByUsCOM::CheckAmt() [%s] doesn't support decimal\n",csCcy));
			lTmp = (long) *dTxnAmt;
                       	if (*dTxnAmt > lTmp) {
                       		iRet = INT_UNSUPPORTED_PAY_AMOUNT;
ERRLOG("TxnMmmByUsCOM::CheckAmt() unsupported transaction amount [%f]\n",*dTxnAmt);
                  	}
              	}
       	}

DEBUGLOG(("CheckAmt() Normal Return iRet = [%d]\n",iRet));
	return 	iRet;
}

int GetSrcNatureId(hash_t* hContext,const hash_t* hReq)
{
	int	iRet = PD_OK;
	char	csTag[PD_TAG_LEN +1];
	char	*csTxnCcy;
	char	*csPtr;
	int	iBalCnt = 0,iNatureCnt = 0,i,j;
	double	dTmpAmt;
DEBUGLOG(("GetSrcNatureId ()\n"));


	GetField_CString(hContext,"org_txn_ccy",&csTxnCcy);
DEBUGLOG(("GetSrcNatureId() txn_ccy = [%s]\n",csTxnCcy));

	if (GetField_Int(hContext,"bal_cnt",&iBalCnt)) {
DEBUGLOG(("GetSrcNatureId() bal_cnt = [%d]\n",iBalCnt));
	}
	else {
DEBUGLOG(("GetSrcNatureId() bal_cnt not found\n"));
ERRLOG("GetSrcNatureId() bal_cnt not found\n");
		iRet = PD_ERR;
	}

	if (iRet == PD_OK) {
		for (i= 0; i < iBalCnt; i++ ) {
			sprintf(csTag,"txn_data.bal.%d.nat_cnt",i+1);
			if (GetField_CString(hReq,csTag,&csPtr)) {
DEBUGLOG(("GetSrcNatureId() [%s] = [%s]\n",csTag,csPtr));
				if (!is_numeric(csPtr))
					iRet = INT_INVALID_COUNT;
				else {
					iNatureCnt = ctos((const unsigned char*)csPtr,strlen(csPtr));
					sprintf(csTag,"bal.%d.nat_cnt",i+1);
DEBUGLOG(("GetSrcNatureId() [%s] = [%d]\n",csTag,iNatureCnt));
					PutField_Int(hContext,csTag,iNatureCnt);
				}
			}
			sprintf(csTag,"txn_data.bal.%d.amt",i+1);
			if (GetField_CString(hReq,csTag,&csPtr)) {
DEBUGLOG(("GetSrcNatureId() [%s] = [%s]\n",csTag,csPtr));
				iRet =  CheckAmt(csTxnCcy,csPtr,&dTmpAmt);
				if (iRet != PD_OK)
               				PutField_Int(hContext,"internal_error",iRet);
				else  {
					sprintf(csTag,"bal.%d.amt",i+1);
DEBUGLOG(("GetSrcNatureId() [%s] = [%lf]\n",csTag,dTmpAmt));
               				PutField_Double(hContext,csTag,dTmpAmt);
				}
			}
			else {
				iRet = INT_MMS_NATURE_AMT_NOT_FOUND;
			}
			
			if  (iRet == PD_OK) {
				for (j= 0; j < iNatureCnt; j++ ) {
/* grp */
					sprintf(csTag,"txn_data.bal.%d.nat.%d.grp",i+1,j+1);
					if (GetField_CString(hReq,csTag,&csPtr)) {
//DEBUGLOG(("GetSrcNatureId() [%s] = [%s]\n",csTag,csPtr));
						sprintf(csTag,"bal.%d.nat.%d.grp",i+1,j+1);
DEBUGLOG(("GetSrcNatureId() [%s] = [%s]\n",csTag,csPtr));
						PutField_CString(hContext,csTag,csPtr);
					}
/* val */
					sprintf(csTag,"txn_data.bal.%d.nat.%d.val",i+1,j+1);
					if (GetField_CString(hReq,csTag,&csPtr)) {
//DEBUGLOG(("GetSrcNatureId() [%s] = [%s]\n",csTag,csPtr));
						sprintf(csTag,"bal.%d.nat.%d.val",i+1,j+1);
DEBUGLOG(("GetSrcNatureId() [%s] = [%s]\n",csTag,csPtr));
						PutField_CString(hContext,csTag,csPtr);
					}
				}
/* this call will return an new nature id if not found */
				BOObjPtr = CreateObj(BOPtr,"BOMMSEntityNature","FindEntityNatureId");
				iRet =	(unsigned long)(*BOObjPtr)(hContext);
				if (iRet != PD_OK) {
DEBUGLOG(("GetSrcNatureId() return from BOMMSEntityNature iRet = [%d] \n",iRet));
					break;
				}
			}
		}

	}

DEBUGLOG(("GetSrcNatureId () Normal exit iRet = [%d]\n",iRet));
	return	iRet;
}
