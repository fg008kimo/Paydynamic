/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/10/03              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsPTF.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnMgtByUsPTF(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;

	char        *csOrgTxnSeq = NULL;
        char        *csTmp = NULL;
	char        *csOrgTxnCode = NULL;

        char        *csFrPspId = NULL;
        char        *csToPspId = NULL;
        char        *csFrTxnCountry = NULL;
        char        *csToTxnCountry = NULL;

        char        *csTxnCcy = NULL;
        char        *csUpdateUser = NULL;  
        char        *csPHPostingDate= NULL;  
        double       dAmt=0.0;
	int	    iTmp;
	char	    cDCInd;

	int	    iInternalErr = 0;

	hash_t	    *hTxnDetail;
	hTxnDetail = (hash_t *)malloc(sizeof(hash_t));

	hash_t	    *hFrContext;
	hash_t	    *hToContext;

	hFrContext = (hash_t *)malloc(sizeof(hash_t));
	hash_init(hFrContext, 0);

	hToContext = (hash_t *)malloc(sizeof(hash_t));
	hash_init(hToContext, 0);
	

        hash_t      *hRec;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));



DEBUGLOG(("Authorize::Start\n"));
/* txn_seq */
        if(GetField_CString(hContext,"txn_seq",&csTmp)){
DEBUGLOG(("Authorize::txn_seq = [%s]\n", csTmp));
		PutField_CString(hFrContext, "txn_seq", csTmp);

		PutField_CString(hFrContext, "from_txn_seq", csTmp);
        }
        else{
DEBUGLOG(("Authorize::txnid not found!!\n"));
ERRLOG("TxnMgtByUsPTF::Authorize::txnid not found!!\n");
                iRet=INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_code*/
        if(GetField_CString(hRequest,"txn_code",&csOrgTxnCode)){
DEBUGLOG(("Authorize::txn_code = [%s]\n",csTmp));
        }
        else{
DEBUGLOG(("Authorize::txn_code not found!!\n"));
ERRLOG("TxnMgtByUsPTF::Authorize::txn_code not found!!\n");
                iRet=INT_ERR;

                PutField_Int(hContext,"internal_error",iRet);
        }

/* add_user */
        if(GetField_CString(hRequest,"add_user",&csUpdateUser)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csUpdateUser));
		PutField_CString(hFrContext, "add_user", csUpdateUser);
		PutField_CString(hToContext, "add_user", csUpdateUser);
        }

/* psp_id */
        if(GetField_CString(hRequest,"psp_id",&csFrPspId)){
DEBUGLOG(("Authorize::psp_id = [%s]\n",csFrPspId));
                PutField_CString(hFrContext,"psp_id",csFrPspId);
        }
	else {
DEBUGLOG(("Authorize::psp_id not found!!\n"));
ERRLOG("TxnMgtByUsPTF::Authorize::psp_id not found!!\n");
		iRet = INT_PSP_RETURN_ERROR;
                PutField_Int(hContext,"internal_error",iRet);
	}

/* to psp_id */
        if(GetField_CString(hRequest,"to_psp_id",&csToPspId)){
DEBUGLOG(("Authorize::to psp_id = [%s]\n",csToPspId));
                PutField_CString(hToContext,"psp_id",csToPspId);
        }
	else {
DEBUGLOG(("Authorize::to_psp_id not found!!\n"));
ERRLOG("TxnMgtByUsPTF::Authorize::psp_id not found!!\n");
		iRet = INT_PSP_RETURN_ERROR;
                PutField_Int(hContext,"internal_error",iRet);
	}

/* txn_ccy */
        if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTxnCcy));
                PutField_CString(hContext,"txn_ccy",csTxnCcy);

                PutField_CString(hFrContext,"org_txn_ccy",csTxnCcy);
                PutField_CString(hToContext,"org_txn_ccy",csTxnCcy);

		PutField_CString(hFrContext, "txn_ccy", csTxnCcy);
		PutField_CString(hToContext, "txn_ccy", csTxnCcy);
        }
        else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMgtByUsPTF::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_amt */
        if(GetField_Double(hContext,"txn_amt",&dAmt)){
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dAmt));
                PutField_Double(hContext, "org_txn_amt", dAmt);

		PutField_Double(hFrContext, "net_amt", dAmt);
		PutField_Double(hFrContext, "txn_amt", dAmt);

        }
        else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMgtByUsPTF::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_country */

	if (iRet == PD_OK) {
        	recordset_init(rRecordSet,0);
DEBUGLOG(("Authorize::Call DBPspCountry:GetPspCountry (FROM)\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspCountry","GetPspCountry");
		if((unsigned long) ((*DBObjPtr)(csFrPspId,rRecordSet))==PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if (GetField_CString(hRec,"country",&csFrTxnCountry)) {
					PutField_CString(hFrContext,"txn_country",csFrTxnCountry);
DEBUGLOG(("Authorize::txn_country (from) by psp_id = [%s]\n",csFrTxnCountry));
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		else{
DEBUGLOG(("Authorize::txn_country (from) not found!!\n"));
ERRLOG("TxnMgtByUsPTF::Authorize::txn_country (from) not found!!\n");
			iRet=INT_COUNTRY_PSP_NOT_AVABILE;
			PutField_Int(hContext,"internal_error",iRet);
		}
		RecordSet_Destroy(rRecordSet);

		recordset_init(rRecordSet, 0);
DEBUGLOG(("Authorize::Call DBPspCountry:GetPspCountry (TO)\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspCountry","GetPspCountry");
		if((unsigned long) ((*DBObjPtr)(csToPspId,rRecordSet))==PD_OK){
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if (GetField_CString(hRec,"country",&csToTxnCountry)) {
					PutField_CString(hToContext,"txn_country",csToTxnCountry);
DEBUGLOG(("Authorize::txn_country (to) by psp_id = [%s]\n",csToTxnCountry));
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		else{
DEBUGLOG(("Authorize::txn_country (to) not found!!\n"));
ERRLOG("TxnMgtByUsPTF::Authorize::txn_country (to) not found!!\n");
			iRet=INT_COUNTRY_PSP_NOT_AVABILE;
			PutField_Int(hContext,"internal_error",iRet);
		}
		RecordSet_Destroy(rRecordSet);
	}

	if (iRet == PD_OK) {
		if (strcmp(csFrTxnCountry, csToTxnCountry)) {
			iRet = INT_INVALID_TXN;
DEBUGLOG(("Authorize::() difference country not allow\n"));
ERRLOG("TxnMgtOnUSTFF:Authorize() difference country not allow\n");
                        PutField_Int(hContext,"internal_error",iRet);
		}
	}


/* approval_date */
        if(!GetField_CString(hRequest,"approval_date",&csPHPostingDate)){
                if(!GetField_CString(hContext,"PHDATE",&csPHPostingDate)){
DEBUGLOG(("Authorize::approval_date not found!!\n"));
ERRLOG("TxnMgtByUsPTF::Authorize::approval_date not found!!\n");
                        iRet=INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
                }
                else {
                        PutField_CString(hContext, "approval_date", csPHPostingDate);
DEBUGLOG(("Authorize::approval_date (phdate) = [%s]\n", csPHPostingDate)); 
                }
        }
	else {
		PutField_CString(hContext, "approval_date", csPHPostingDate);
DEBUGLOG(("Authorize::approval_date = [%s]\n", csPHPostingDate)); 
	}


	//PutField_CString(hRequest, "service_code", PD_DEFAULT_SERVICE);
	
	PutField_Char(hFrContext, "party_type", PD_TYPE_PSP);

	PutField_Int(hFrContext, "balance_transfer", PD_TRUE);
	PutField_Char(hFrContext, "dc_ind", PD_ADJ_TYPE_DEBIT);

	PutField_CString(hFrContext, "sub_status", PD_APPROVED);
	PutField_CString(hFrContext, "approval_date", csPHPostingDate);

	//Update Balance (FROM)
        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call BOAdjustment:ProcessPartyBalance\n"));
                BOObjPtr = CreateObj(BOPtr,"BOAdjustment","ProcessPartyBalance");
		iRet = (unsigned long)((*BOObjPtr)(hFrContext));

		if (iRet != PD_OK) {
DEBUGLOG(("Authorize::BOAdjustment:ProcessPartyBalance Failed Ret [%d]\n", iRet));
ERRLOG("TxnMgtByUsPTF::BOADjustment::ProcesspartyBalance Failed [%d]\n", iRet);

			if (GetField_Int(hFrContext, "internal_error", &iTmp)) {
				PutField_Int(hContext, "internal_error", iTmp);
			}

		} else {
                        if (GetField_Char(hFrContext,"dc_ind",&cDCInd)) {
DEBUGLOG(("Authorize::dc_ind = [%c]\n", cDCInd));
                                if (cDCInd == PD_ADJ_TYPE_CREDIT) {
                                        PutField_CString(hFrContext, "amount_type", PD_CR);
                                }
                                else if (cDCInd == PD_ADJ_TYPE_DEBIT) {
                                        PutField_CString(hFrContext, "amount_type", PD_DR);
                                }
                        }
                        else {
DEBUGLOG(("Authorize::BOAdjustment:ProcessPartyBalance Failed to get dc_ind\n"));
ERRLOG("TxnMgtByUsPTF::BOADjustment::ProcesspartyBalance Failed to get dc_ind\n");
                                iRet = PD_ERR;
                        }
		}
        } 


       if(GetField_Int(hContext,"do_logging",&iTmp)){
DEBUGLOG(("Authorize::do_logging [%d]\n", iTmp));

                if(iTmp!=PD_ADD_LOG) {
                        /* nothing */
                }
                else {
		
			PutField_CString(hContext, "net_ccy", csTxnCcy);

        		if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:AddDetail\n"));
		                DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
				if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK)
					iRet = INT_ERR;
        		}
   
        		if(iRet==PD_OK){
				// To prevent update current bal, total_float and total_hold
				hash_init(hTxnDetail, 0);
				
				if (GetField_CString(hFrContext, "txn_seq", &csTmp)) {
					PutField_CString(hTxnDetail, "txn_seq", csTmp);
				}
				if (GetField_CString(hFrContext, "txn_country", &csTmp)) {
					PutField_CString(hTxnDetail, "txn_country", csTmp);
				}
				if (GetField_CString(hFrContext, "update_user", &csTmp)) {
					PutField_CString(hTxnDetail, "update_user", csTmp);
				}

DEBUGLOG(("Authorize::Call DBTransaction:UpdateDetail\n"));
                		DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
	                	if((unsigned long) ((*DBObjPtr)(hTxnDetail))!=PD_OK) {
       		                 	iRet = INT_ERR;
				}

				hash_destroy(hTxnDetail);
       	 		}
		}
	}

        // for handling TXNPSPDETAIL??
        if(iRet==PD_OK){
                if (GetField_CString(hContext, "PHDATE", &csTmp)) {
DEBUGLOG(("Authorize::PHDATE = [%s]\n",csTmp));
                    PutField_CString(hFrContext, "txn_date", csTmp);
                }


DEBUGLOG(("Authorize::Call DBTxnPspDetail:Add\n"));
		PutField_CString(hFrContext, "desc", "Psp Balance Transfer From");

                DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Add");
                if((unsigned long) ((*DBObjPtr)(hFrContext))!=PD_OK) {
                        iRet = INT_ERR;
                } 
        }

	if (iRet==PD_OK) {
DEBUGLOG(("Authorize::Call DBTxnPspDetail:Update\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
		if((unsigned long) ((*DBObjPtr)(hFrContext))!=PD_OK) {
			iRet = INT_ERR;
		}
	}
         
        if (iRet == PD_OK) {
		PutField_Double(hFrContext, "org_txn_amt", dAmt);

DEBUGLOG(("Authorize::Call BOTxnElements:AddTxnAmtElement\n"));
                BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnAmtElement");
                if ((unsigned long)((*BOObjPtr)(hFrContext)) != PD_OK) {
                        iRet = INT_ERR;
                }

        }

/* no fee
        if (iRet == PD_OK) {
		PutField_CString(hFrContext, "amount_type", PD_DR);

DEBUGLOG(("Authorize::Call BOTxnElements:AddTxnFeeElements\n"));
                BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnFeeElements");
                if ((unsigned long)((*BOObjPtr)(hFrContext)) != PD_OK) {
                        iRet = INT_ERR;
                }
        }
*/

        if(GetField_CString(hContext,"txn_seq",&csOrgTxnSeq)){
		PutField_CString(hResponse, "txn_seq_tf", csOrgTxnSeq);
	}

	//Update Balance (TO)
	if (iRet == PD_OK) {

		hash_t	*hReq;
		hReq = (hash_t*)malloc (sizeof(hash_t));
		hash_init(hReq, 0);

		unsigned char	csTmpTxnSeq[PD_TXN_SEQ_LEN + 1];

                DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextMgtTxnSeq");
                strcpy((char*)csTmpTxnSeq,(*DBObjPtr)());

		PutField_CString(hResponse, "txn_seq_tt", (const char *)csTmpTxnSeq);
		PutField_CString(hToContext, "txn_seq", (const char *)csTmpTxnSeq);
		PutField_CString(hToContext, "from_txn_seq", (const char *)csTmpTxnSeq);

		PutField_CString(hToContext, "org_txn_seq", csOrgTxnSeq);
		
		PutField_Int(hToContext, "db_commit", PD_FALSE);		

/* local tm date */
                if (GetField_CString(hContext,"local_tm_date",&csTmp)) {
                        PutField_CString(hToContext,"local_tm_date",csTmp);
                }
/* local tm time */
                if (GetField_CString(hContext,"local_tm_time",&csTmp)) {
                        PutField_CString(hToContext,"local_tm_time",csTmp);
                }
/* add user */
                if (GetField_CString(hRequest,"add_user",&csTmp)) {
                        PutField_CString(hToContext,"add_user",csTmp);
                }
/* ip addr */
                if (GetField_CString(hRequest,"ip_addr",&csTmp)) {
                        PutField_CString(hReq,"ip_addr",csTmp);
                }
/* host_posting_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
                        PutField_CString(hToContext,"PHDATE",csTmp);
                }

                PutField_CString(hToContext,"channel_code",PD_CHANNEL_MGT);
                PutField_CString(hToContext,"txn_code", "PTT");
                PutField_CString(hToContext,"process_code",PD_PROCESS_CODE_DEF);
                PutField_CString(hToContext,"process_type",PD_PROCESS_TYPE_DEF);

/* txn_amt */
		PutField_Double(hToContext, "txn_amt", dAmt);
/* update context */
		ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateContext");
		iRet = (unsigned long)(*ChannelObjPtr)(hToContext);

		if (GetField_CString(hToContext, "txn_ccy", &csTmp)) {
			PutField_CString(hReq, "txn_ccy", csTmp);
		}

		if (GetField_CString(hToContext, "txn_country", &csTmp)) {
			PutField_CString(hReq, "txn_country", csTmp);
		}

/* logging */
       		if(GetField_Int(hContext,"do_logging",&iTmp)){
			PutField_Int(hToContext, "do_logging", iTmp);
		}

DEBUGLOG(("Authorize: Call MGTChannel.AddTxnLog\n"));
		ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnLog");
		iRet = (unsigned long)(*ChannelObjPtr)(hToContext,hReq);

		if (iRet == PD_OK) {

			PutField_Char(hToContext, "party_type", PD_TYPE_PSP);

			PutField_Int(hToContext, "balance_transfer", PD_TRUE);
			PutField_Char(hToContext, "dc_ind", PD_ADJ_TYPE_CREDIT);


DEBUGLOG(("Authorize::Call BOAdjustment:ProcessPartyBalance (TO)\n"));
			BOObjPtr = CreateObj(BOPtr,"BOAdjustment","ProcessPartyBalance");
			iRet = (unsigned long)((*BOObjPtr)(hToContext));

			if (iRet != PD_OK) {
DEBUGLOG(("Authorize::BOAdjustment:ProcessPartyBalance Failed Ret [%d]\n", iRet));
ERRLOG("TxnMgtByUsPTF::BOADjustment::ProcesspartyBalance Failed [%d]\n", iRet);
			} else {
				if (GetField_Char(hToContext,"dc_ind",&cDCInd)) {
DEBUGLOG(("Authorize::dc_ind = [%c]\n", cDCInd));
					if (cDCInd == PD_ADJ_TYPE_CREDIT) {
						PutField_CString(hToContext, "amount_type", PD_CR);
					}
					else if (cDCInd == PD_ADJ_TYPE_DEBIT) {
						PutField_CString(hToContext, "amount_type", PD_DR);
					}
				}
				else {
DEBUGLOG(("Authorize::BOAdjustment:ProcessPartyBalance Failed to get dc_ind\n"));
ERRLOG("TxnMgtByUsPTF::BOADjustment::ProcesspartyBalance Failed to get dc_ind\n");
					iRet = PD_ERR;
                        	}
			}

			if (GetField_Int(hToContext, "do_logging", &iTmp)) {
DEBUGLOG(("Authorize::do_logging [%d]\n", iTmp));
				if(iTmp!=PD_ADD_LOG) {
					/* nothing */
				} 
				else {
					PutField_CString(hToContext, "net_ccy", csTxnCcy);

					PutField_Char(hToContext, "status", PD_COMPLETE);
					PutField_Char(hToContext, "ar_ind", PD_ACCEPT);

					PutField_CString(hToContext, "sub_status", PD_APPROVED);
					PutField_CString(hToContext, "approval_date", csPHPostingDate);

					if(iRet==PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:AddDetail\n"));
						DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
						if((unsigned long) ((*DBObjPtr)(hToContext))!=PD_OK)
							iRet = INT_ERR;
                        		}

					if (iRet == PD_OK) {
						// To prevent update current bal, total_float and total_hold
						hash_init(hTxnDetail, 0);

						if (GetField_CString(hToContext, "txn_seq", &csTmp)) {
							PutField_CString(hTxnDetail, "txn_seq", csTmp);
						}
						if (GetField_CString(hToContext, "txn_country", &csTmp)) {
							PutField_CString(hTxnDetail, "txn_country", csTmp);
						}
						if (GetField_CString(hToContext, "update_user", &csTmp)) {
							PutField_CString(hTxnDetail, "update_user", csTmp);
						}

DEBUGLOG(("Authorize::Call DBTransaction:UpdateDetail\n"));
						DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
						if((unsigned long) ((*DBObjPtr)(hTxnDetail))!=PD_OK) {
							iRet = INT_ERR;
						}

						hash_destroy(hTxnDetail);				
					}

				}

			}

			if (iRet == PD_OK) {
				if (GetField_CString(hContext, "PHDATE", &csTmp)) {
DEBUGLOG(("Authorize::PHDATE = [%s]\n",csTmp));
					PutField_CString(hToContext, "txn_date", csTmp);
                		}

DEBUGLOG(("Authorize::Call DBTxnPspDetail:Add\n"));
				PutField_CString(hToContext, "desc", "Psp Balance Transfer to");

				DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Add");
				if((unsigned long) ((*DBObjPtr)(hToContext))!=PD_OK) {
					iRet = INT_ERR;
                		}
        		}

			if (iRet==PD_OK) {
DEBUGLOG(("Authorize::Call DBTxnPspDetail:Update\n"));
				DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
				if((unsigned long) ((*DBObjPtr)(hToContext))!=PD_OK) {
					iRet = INT_ERR;
                		}
        		}

			if (iRet == PD_OK) {
				PutField_Double(hToContext, "org_txn_amt", dAmt);

DEBUGLOG(("Authorize::Call BOTxnElements:AddTxnAmtElement\n"));
				BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnAmtElement");
				if ((unsigned long)((*BOObjPtr)(hToContext)) != PD_OK) {
					iRet = INT_ERR;
                		}
        		}

/*
			if (iRet == PD_OK) {
				PutField_CString(hContext, "amount_type", PD_DR);
DEBUGLOG(("Authorize::Call BOTxnElements:AddTxnFeeElements\n"));
				BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnFeeElements");
				if ((unsigned long)((*BOObjPtr)(hToContext)) != PD_OK) {
					iRet = INT_ERR;
                		}
        		}
*/
		}
		if (iRet == PD_OK || GetField_Int(hToContext,"internal_error",&iInternalErr)) {
			char* csBuf = (char*) malloc (128);
                        sprintf(csBuf,"%d",iInternalErr);
                        PutField_CString(hToContext,"response_code",csBuf);
                        PutField_Int(hToContext,"internal_code",iInternalErr);
DEBUGLOG(("Result_Code = %s\n",csBuf));
                        FREE_ME(csBuf);

                        PutField_Char(hToContext,"status",PD_COMPLETE);
                        PutField_CString(hToContext,"sub_status",PD_APPROVED);
                        PutField_CString(hContext,"sub_status",PD_APPROVED);

                        if (iInternalErr != 0 ) {
                                PutField_Char(hToContext,"ar_ind",PD_REJECT);
                        }
                        else {
                                PutField_Char(hToContext,"ar_ind",PD_ACCEPT);
                        }

                        PutField_CString(hToContext,"approval_date",csPHPostingDate);
                        ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateTxnLog");
                        iRet = (unsigned long)(*ChannelObjPtr)(hToContext,hReq,hResponse);
		}
		hash_destroy(hReq);
		FREE_ME(hReq);
	}


	if (iRet == PD_OK) {
		PutField_CString(hContext,"approval_date",csPHPostingDate);
		PutField_Double(hContext, "net_amt", dAmt);
	}


	FREE_ME(hTxnDetail);

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);


DEBUGLOG(("TxnMgtByUsPTF Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}
