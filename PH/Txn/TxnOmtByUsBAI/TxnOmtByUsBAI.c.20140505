/*
Partnerdelight (c)2014. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/01/29              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsBAI.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

#include "sha1.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnOmtByUsBAI(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{

	int	iRet = PD_OK;

	char	*csTmp = NULL;	
	double	dTmp = 0.0;

	char	*csBAID = strdup("");
	char	cAction;
	char	*csStatus = NULL;

	char	*csOrgBAID = NULL;
	char	*csOrgStatus = NULL;

	char	*csBankCode = NULL;
	char	*csAcctNum = NULL;
	char	*csPspId = NULL;

	char	*csOrgBankCode = NULL;
	char	*csOrgAcctNum = NULL;


	hash_t  *hTxn, *hOrgTxn, *hPSPDetail;

	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn, 0);

	hOrgTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hOrgTxn, 0);

	hPSPDetail = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hPSPDetail, 0);

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("TxnOmtByUsBAI::Authorize\n"));

/* Action */
	if (GetField_CString(hRequest, "action", &csTmp)) {
		cAction = csTmp[0];
		// not support delete
		if (cAction != PD_ACTION_ADD && cAction != PD_ACTION_UPDATE) {
DEBUGLOG(("Authorize::action [%c] not accepted!!\n", cAction));
ERRLOG("TxnOmtByUsBAI::Authorize::action not found!!\n");
			iRet=INT_ACTION_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
		}
DEBUGLOG(("Authorize:: action [%c]\n", cAction));

	} 
	else {
DEBUGLOG(("Authorize::action not found!!\n"));
ERRLOG("TxnOmtByUsBAI::Authorize::action not found!!\n");
                iRet=INT_ACTION_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
	}

/* BAID */
	// BAID is expected input !
	if (GetField_CString(hRequest, "new_baid", &csBAID)){
		PutField_CString(hTxn, "baid", csBAID);
DEBUGLOG(("Authorize::baid = [%s]\n",csBAID));
	}
	else {
DEBUGLOG(("Authorize::baid not found!!\n"));
ERRLOG("TxnOmtByUsBAI::Authorize::baid not found!!\n");
		iRet=INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
	}

/* status */
	if (GetField_CString(hRequest, "status", &csStatus)) {
		PutField_CString(hTxn, "status", csStatus);
DEBUGLOG(("Authorize()::status = [%s]\n",csStatus));
	} else {
DEBUGLOG(("Authorize::status not found!!\n"));
ERRLOG("TxnOmtByUsBAI::Authorize::status not found!!\n");
		iRet = INT_STATUS_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
	}

/* add_user */
        if(GetField_CString(hRequest,"add_user",&csTmp)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csTmp));
                PutField_CString(hTxn,"create_user",csTmp);
		PutField_CString(hTxn, "update_user", csTmp);
        }


	if (iRet == PD_OK) {
		// Try to get the BAID record
DEBUGLOG(("Authorize::Call DBOLBankAcctId:GetBankAcctIdDtl\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLBankAcctId","GetBankAcctIdDtl");
		if ((unsigned long)(*DBObjPtr)(csBAID, hOrgTxn) != PD_OK) {
DEBUGLOG(("Authorize::DBOLBankAcctId:GetBankAcctIdDtl Failed!\n"));
ERRLOG("TxnOmtByUsBAI::Authorize::DBOLBankAcctId:GetBankAcctIdDtl Failed!\n");
		} else {
			if (cAction == PD_ACTION_ADD) {
				if (GetField_CString(hOrgTxn, "org_baid", &csOrgBAID)) {
					iRet = INT_BAID_ALREADY_EXISTS;
					PutField_Int(hContext, "internal_error", iRet);
				}
			} else if (cAction == PD_ACTION_UPDATE) {
				if (GetField_CString(hOrgTxn, "status", &csOrgStatus)) {
DEBUGLOG(("Authorize:: org_status [%s]\n", csOrgStatus));
				}

				if (GetField_CString(hOrgTxn, "int_bank_code", &csOrgBankCode)) {
DEBUGLOG(("Authorize:: org_bank_code [%s]\n", csOrgBankCode));
				}

				if (GetField_CString(hOrgTxn, "bank_acct_num", &csOrgAcctNum)) {
DEBUGLOG(("Authorize:: org_acct_num [%s]\n", csOrgAcctNum));
				}
			}
	
		}
	}

	if (iRet == PD_OK) {
		/* Checking for Add */
		if (cAction == PD_ACTION_ADD) {
			/* BAID Name */
			if (GetField_CString(hRequest, "baid_name", &csTmp)) {
DEBUGLOG(("Authorize:: new baid name [%s]\n", csTmp));
				PutField_CString(hTxn, "baid_name", csTmp);
			}
			else {
DEBUGLOG(("Authorize::baid name not found!!\n"));
ERRLOG("TxnOmtByUsBAI::Authorize::baid name not found!!\n");
				iRet=INT_ERR;
				PutField_Int(hContext,"internal_error",iRet);
			}

			/* Optional for bank_code and acct_num */
			if (GetField_CString(hRequest, "int_bank_code", &csBankCode)) {
DEBUGLOG(("Authorize:: bank_code [%s]\n", csBankCode));
				PutField_CString(hTxn, "int_bank_code", csBankCode);
			}

			if (GetField_CString(hRequest, "bank_acct_num", &csAcctNum)) {
DEBUGLOG(("Authorize:: acct_num [%s]\n", csAcctNum));
				PutField_CString(hTxn, "bank_acct_num", csAcctNum);
			}

			if (GetField_CString(hRequest, "psp_id", &csPspId)) {
DEBUGLOG(("Authorize:: psp_id [%s]\n", csPspId));
				PutField_CString(hTxn, "psp_id", csPspId);
			}
			else {
DEBUGLOG(("Authorize::psp id not found!!\n"));
ERRLOG("TxnOmtByUsBAI::Authorize::psp id not found!!\n");
				iRet=INT_PSP_ID_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
			}
			
			if (GetField_CString(hRequest, "init_bal", &csTmp)) {
				dTmp = string2double((const unsigned char *) csTmp);
				PutField_Double(hTxn, "init_bal", dTmp);
DEBUGLOG(("Authorize:: init_bal [%f]\n", dTmp));
			}


			if (iRet == PD_OK) {
				if (csBankCode != NULL && csAcctNum != NULL) {
					/* Check Bank Account Exists */
DEBUGLOG(("Authorize::Call DBOLBankAccts:GetBankAccts\n"));
					hash_destroy(hOrgTxn);
					hash_init(hOrgTxn,0);

					DBObjPtr = CreateObj(DBPtr,"DBOLBankAccts","GetBankAccts");
					if ((unsigned long)(*DBObjPtr)(csBankCode, csAcctNum, hOrgTxn) != PD_OK) {
						iRet = INT_BANK_ACCT_ID_NOT_FOUND;
						PutField_Int(hContext,"internal_error",iRet);
					} else {
						/* Need to check bank acct status? */
DEBUGLOG(("Authorize::Call DBOLBankAccts:GetBankAccts Valid\n"));
					}
				}
			}

			if (iRet == PD_OK) {
				/* Get PSP Exists */
DEBUGLOG(("Authorize::Call DBOLPspDetail:GetPspDetail\n"));
				DBObjPtr = CreateObj(DBPtr,"DBOLPspDetail","GetPspDetail");
				if ((unsigned long)(*DBObjPtr)(csPspId, hPSPDetail) != PD_OK) {
DEBUGLOG(("Authorize::Call DBOLPspDetail:GetPspDetail Failed\n"));
ERRLOG("TxnOmtByUsBAI::Authorize::Call DBOLPspDetail:GetPspDetail Failed\n");
				}
				else {
					if (!GetField_CString(hPSPDetail, "client_id", &csTmp)) {
DEBUGLOG(("Authorize:: PSP Not Found\n")); 
ERRLOG("TxnOmtByUsBAI::Authorize::PSP Not Found!\n");
						iRet = INT_PSP_ID_NOT_FOUND;
						PutField_Int(hContext,"internal_error",iRet);
					}
				}
			}
				
			if (iRet == PD_OK) {
				/* Check Status NO OPEN record */
				if (!strcmp(csStatus, PD_BAID_STATUS_OPEN)) {
					hash_destroy(hOrgTxn);
					hash_init(hOrgTxn,0);

DEBUGLOG(("Authorize::Call DBOLBankAcctId:GetDtlByBankAcct\n"));
					DBObjPtr = CreateObj(DBPtr,"DBOLBankAcctId","GetDtlByBankAcct");
					if ((unsigned long)(*DBObjPtr)(csBankCode, csAcctNum, hOrgTxn) != PD_OK) {
						/* Not Found Open BAID */
DEBUGLOG(("Authorize::Call DBOLBankAcctId:GetDtlByBankAcct NOT Found OPEN BAID, continue to process\n"));
					} else {
DEBUGLOG(("Authorize::Call DBOLBankAcctId:GetDtlByBankAcct Found OPEN BAID !!!!\n"));
ERRLOG("TxnOmtByUsBAI::Authorize::Call DBOLBankAcctId:GetDtlByBankAcct Found OPEN BAID !!!!\n");
						iRet = INT_OTHER_OPEN_BAID_FOUND;
						PutField_Int(hContext,"internal_error",iRet);
					}
				}
			}
		} else if (cAction == PD_ACTION_UPDATE) {
			/* Update */
			/* BAID Name */
			if (GetField_CString(hRequest, "baid_name", &csTmp)) {
DEBUGLOG(("Authorize:: new baid name [%s]\n", csTmp));
				PutField_CString(hTxn, "baid_name", csTmp);
			}

			if (iRet == PD_OK) {
				/* Check Status */

DEBUGLOG(("Authorize:: org status [%s] new status [%s]\n", csOrgStatus, csStatus));

				if (strcmp(csStatus, csOrgStatus)) {
					/* Status Not the same */
					/* NEW -> OPEN / CLOSE */
					/* OPEN -> CLOSE */

					if (	((!strcmp(csOrgStatus, PD_BAID_STATUS_NEW)) && 
							(!strcmp(csStatus, PD_BAID_STATUS_OPEN) || !strcmp(csStatus, PD_BAID_STATUS_CLOSE)))  ||
						((!strcmp(csOrgStatus, PD_BAID_STATUS_OPEN)) && (!strcmp(csStatus, PD_BAID_STATUS_CLOSE)))
					   ) 
					{
DEBUGLOG(("Authorize:: status from [%s] to [%s]\n", csOrgStatus, csStatus));
					} else {
						iRet = INT_INVALID_BAID_STATUS;
						PutField_Int(hContext,"internal_error",iRet);
					}
				}	
			}


			if (iRet == PD_OK) {
				/* Check Status NO OPEN record */
                                if (strcmp(csStatus, csOrgStatus) && !strcmp(csStatus, PD_BAID_STATUS_OPEN)) {
                                        hash_destroy(hOrgTxn);
                                        hash_init(hOrgTxn,0);

					if (csOrgBankCode != NULL && csOrgAcctNum != NULL) {
DEBUGLOG(("Authorize::(Update) Call DBOLBankAcctId:GetDtlByBankAcct\n"));
	                                        DBObjPtr = CreateObj(DBPtr,"DBOLBankAcctId","GetDtlByBankAcct");
						if ((unsigned long)(*DBObjPtr)(csBankCode, csAcctNum, hOrgTxn) != PD_OK) {
                                                	/* Not Found Open BAID */
DEBUGLOG(("Authorize::(Update) Call DBOLBankAcctId:GetDtlByBankAcct NOT Found OPEN BAID, continue to process\n"));
	                                        } else {
DEBUGLOG(("Authorize::(Update) Call DBOLBankAcctId:GetDtlByBankAcct Found OPEN BAID !!!!\n"));
ERRLOG("TxnOmtByUsBAI::(Update) Authorize::Call DBOLBankAcctId:GetDtlByBankAcct Found OPEN BAID !!!!\n");
							iRet = INT_OTHER_OPEN_BAID_FOUND;
							PutField_Int(hContext,"internal_error",iRet);
						}
					}
                                }
			}
		}
	}		
	

	/* BAID Detail */
        if (iRet == PD_OK) {
 		if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize::Call DBOLBankAcctId:Add\n"));
                	DBObjPtr = CreateObj(DBPtr,"DBOLBankAcctId","Add");
	                if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBOLBankAcctId:Add Failed\n"));
ERRLOG("TxnOmtByUsBAI::Authorize::DBOLBankAcctId:Add Failed\n");
       	                 iRet = INT_ERR;
			}
			else {
DEBUGLOG(("Authorize::DBOLBankAcctId:Add Succ\n"));
			}
		} else if (cAction == PD_ACTION_UPDATE) {
DEBUGLOG(("Authorize::Call DBOLBankAcctId:Update\n"));
	               	DBObjPtr = CreateObj(DBPtr,"DBOLBankAcctId","Update");
			if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBOLBankAcctId:Update Failed\n"));
ERRLOG("TxnOmtByUsBAI::Authorize::DBOLBankAcctId:Update Failed\n");
				iRet = INT_ERR;
			}
			else {
DEBUGLOG(("Authorize::DBOLBankAcctId:Update Succ\n"));
			}	
		}

	}

	hash_destroy(hTxn);
	FREE_ME(hTxn);

	hash_destroy(hOrgTxn);
	FREE_ME(hOrgTxn);

	hash_destroy(hPSPDetail);
	FREE_ME(hPSPDetail);

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);


DEBUGLOG(("TxnOmtByUsBAI Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}

