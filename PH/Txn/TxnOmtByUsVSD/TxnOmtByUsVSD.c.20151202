/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/01/14              Virginia Yun
Check if MMS mode = ON, not update SEBBalance      2015/08/13              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsVSD.h"
#include "myrecordset.h"
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(BO);
OBJPTR(DB);

void TxnOmtByUsVSD(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
	int	iRet = PD_OK;
	hash_t  *hRec;
	hash_t  *hOrgTxn;
	char    *csOrgTxnSeq;
	char    *csOrgPSFSeq;
        char    *csTmp;
        char    *csOrgTxnCode;
	char	*csOrgPostingDate;
        char    *csFundsInId;
        char    *csCcy;
        char    *csFromCcy;
        char    *csBankCcy;
	char	*csUpdateUser;
	//char	*csPspId;
	char	cStatus;
	char	cArInd;
	char	*csSubStatus;
        double  dRate= 0.0;
        double  dRatio= 0.0;
        double  dBankBal= 0.0;
        double  dOrgBankBal= 0.0;
        double  dNewAmt= 0.0;
        double  dBankAmt= 0.0;
        double  dRatioD= 0.0;
        double  dTmp= 0.0;
        double  dTotal= 0.0;
        int     i = 0;
        int     iCnt = 0;
	char	csTag[PD_TAG_LEN+1];

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

        hOrgTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hOrgTxn,0);

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

DEBUGLOG(("TxnOmtByUsVSD: Authroize()\n"));
	if (GetField_CString(hRequest,"org_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("TxnOmtByUsVSD: org txn seq = [%s]\n",csOrgTxnSeq));
		PutField_CString(hOrgTxn,"txn_seq",csOrgTxnSeq);
                PutField_Char(hOrgTxn,"status",PD_REVERSED);
                PutField_CString(hOrgTxn,"sub_status",PD_UNDO);
                PutField_CString(hContext,"org_txn_seq",csOrgTxnSeq);
	}
	if (GetField_CString(hContext,"add_user",&csUpdateUser)) {
DEBUGLOG(("TxnOmtByUsVSD: update_user = [%s]\n",csUpdateUser));
	}

	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBOLTransaction:GetTxnHeader\n"));
                DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","GetTxnHeader");
                if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("GetTxnHeader::found record = [%s]\n",csOrgTxnSeq));
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
                                if (GetField_CString(hRec,"txn_code",&csOrgTxnCode)) {
DEBUGLOG(("GetTxnHeader::txn_code = [%s]\n",csOrgTxnCode));
                                }
                                if (GetField_CString(hRec,"org_txn_id",&csOrgPSFSeq)) {
DEBUGLOG(("GetTxnHeader::org_txn_id = [%s]\n",csOrgPSFSeq));
                                }
                                if (GetField_CString(hRec,"host_posting_date",&csOrgPostingDate)) {
DEBUGLOG(("GetTxnHeader::org_host_posting_date = [%s]\n",csOrgPostingDate));
                                }
                                if (GetField_Char(hRec,"status",&cStatus)) {
DEBUGLOG(("GetTxnHeader::status = [%c]\n",cStatus));
                                }
                                if (GetField_Char(hRec,"ar_ind",&cArInd)) {
DEBUGLOG(("GetTxnHeader::ar_ind = [%c]\n",cArInd));
                                }
                                if (GetField_CString(hRec,"sub_status",&csSubStatus)) {
DEBUGLOG(("GetTxnHeader::sub_status = [%s]\n",csSubStatus));
                                }
                                hRec = RecordSet_GetNext(rRecordSet);
                        }

			if(cStatus==PD_COMPLETE &&
			   cArInd==PD_ACCEPT &&
			   !strcmp(csSubStatus,PD_APPROVED)){
DEBUGLOG(("Authorize::Valid txn[%s]: [%c][%c][%s]\n",csOrgTxnSeq,cStatus,cArInd,csSubStatus));
			}
			else{
DEBUGLOG(("Authorize::Invalid txn[%s]: [%c][%c][%s]\n",csOrgTxnSeq,cStatus,cArInd,csSubStatus));
				iRet=INT_INVALID_TXN;
                        	PutField_Int(hContext,"internal_error",iRet);
			}
                }
                else{
DEBUGLOG(("GetTxnHeader:: not found record for [%s]\n",csOrgTxnSeq));
ERRLOG("TxnOmtByUsVSD:Authorize::GetTxnHeader::not found record!!\n");
                        iRet=INT_NOT_RECORD;
                        PutField_Int(hContext,"internal_error",iRet);
                }
	}

	if(iRet == PD_OK && !strcmp(csOrgTxnCode,PD_PSP_DELIVER_FROM)){
		//if(iRet==PD_OK){
			//find all related PST(s) and update their sub-status to Approved
			recordset_init(rRecordSet,0);
			hash_init(hTxn,0);
			
			DBObjPtr = CreateObj(DBPtr,"DBOLTxnPspDetail","GetOLTxnPspDetailByDlvId");
			if((unsigned long)(*DBObjPtr)(csOrgTxnSeq, PD_DELIVERING, rRecordSet)==PD_OK){
				hRec = RecordSet_GetFirst(rRecordSet);
				while(hRec && iRet==PD_OK){
					if (GetField_CString(hRec,"txn_id",&csTmp)){
						PutField_CString(hTxn,"txn_seq",csTmp);
						PutField_CString(hTxn,"sub_status",PD_APPROVED);
DEBUGLOG(("Authorize::Call DBOLTransaction:Update PST [%s]\n",csTmp));
						DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Update");
						iRet = (unsigned long)(*DBObjPtr)(hTxn);
DEBUGLOG(("Authorize::DBOLTransaction:Update iRet = [%d]\n",iRet));
					}
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
		//}
	}
	else if(iRet == PD_OK && !strcmp(csOrgTxnCode,PD_PSP_DELIVER_TO)){

		//check MMS Mode
		if (iRet == PD_OK) {
			char*   csValue;
			csValue = (char*) malloc (128);
			DBObjPtr = CreateObj(DBPtr,"DBSystemParameter","FindCode");
			if ((unsigned long)(DBObjPtr)(PD_MMSMODE,csValue) == FOUND) {
DEBUGLOG(("MMS Mode = [%s]\n",csValue));
				if (!strcmp(csValue, PD_ENABLE_MMSMODE)){
					iRet = PD_SKIP_OK;
DEBUGLOG(("MMS Mode is 'ON'. Skip Process!!!\n"));
				}
			}
			FREE_ME(csValue);
		}


		if(iRet==PD_OK){
			iRet = INT_ERR;
			//restore the balance and rate in Average cost FX table
DEBUGLOG(("Authorize::Call DBOLTransaction:GetTxnDetail\n"));
			recordset_init(rRecordSet,0);
			DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","GetTxnDetail");
			if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
                        	hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if (GetField_CString(hRec,"batch_id",&csFundsInId)) {
						iRet=PD_OK;
DEBUGLOG(("Authorize::org_finds_in_id = [%s]\n",csFundsInId));
					}
					hRec = RecordSet_GetNext(rRecordSet);
				}
			
			}
		}
		if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBFundsIn:GetFundsInDetail\n"));
			iRet = INT_ERR;
			hash_init(hTxn,0);
			recordset_init(rRecordSet,0);
			DBObjPtr = CreateObj(DBPtr,"DBFundsIn","GetFundsInDetail");
			PutField_CString(hTxn,"fundsin_id",csFundsInId);
			if ((*DBObjPtr)(csFundsInId,rRecordSet) == PD_OK) {
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if(GetField_CString(hRec,"fundin_date",&csTmp)){
						PutField_CString(hTxn,"fundin_date",csTmp);
DEBUGLOG(("Authorize::org_findin_date = [%s]\n",csTmp));
					}
					if(GetField_CString(hRec,"fundin_ccy",&csFromCcy)){
						PutField_CString(hTxn,"fundin_ccy",csFromCcy);
DEBUGLOG(("Authorize::org_findin_ccy = [%s]\n",csFromCcy));
					}
					if(GetField_Double(hRec,"fundin_amt",&dTmp)){
						PutField_Double(hTxn,"fundin_amt",dTmp);
DEBUGLOG(("Authorize::org_findin_amt = [%f]\n",dTmp));
					}
					if(GetField_CString(hRec,"bank_ccy",&csBankCcy)){
						PutField_CString(hTxn,"bank_ccy",csBankCcy);
DEBUGLOG(("Authorize::org_bank_ccy = [%s]\n",csBankCcy));
					}
					if(GetField_Double(hRec,"bank_amt",&dBankAmt)){
						PutField_Double(hTxn,"bank_amt",dBankAmt);
DEBUGLOG(("Authorize::org_bank_amt = [%f]\n",dBankAmt));
					}

					iRet = PD_OK;
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}

		}
		if(iRet==PD_OK){
			iRet = INT_ERR;
			iCnt = 0;
			recordset_init(rRecordSet,0);
			DBObjPtr = CreateObj(DBPtr,"DBSebBalance","FindBankBalanceInfo");
			if ((unsigned long)(*DBObjPtr)(csBankCcy,rRecordSet) == PD_OK) {
				hRec = RecordSet_GetFirst(rRecordSet);
                                while (hRec) {
					if(GetField_CString(hRec,"from_ccy",&csCcy)){
						sprintf(csTag,"ccy_%d",iCnt);
						PutField_CString(hTxn,csTag,csCcy);

						if(GetField_Double(hRec,"rate",&dTmp)){
							sprintf(csTag,"rate_%s",csCcy);
							PutField_Double(hTxn,csTag,dTmp);
						}
						if(GetField_Double(hRec,"ratio",&dTmp)){
							sprintf(csTag,"ratio_%s",csCcy);
							PutField_Double(hTxn,csTag,dTmp);
						}

						if(GetField_Double(hRec,"bank_bal",&dOrgBankBal)){
							sprintf(csTag,"bank_bal_%s",csCcy);
							PutField_Double(hTxn,csTag,dOrgBankBal);
DEBUGLOG(("Authorize::org_bank_bal [%s][%s][%f]\n",csCcy,csBankCcy,dOrgBankBal));

							GetField_Double(hTxn,"ratio_D",&dTotal);

							if(!strcmp(csCcy, csFromCcy)){
								dNewAmt = dOrgBankBal-dBankAmt;

								sprintf(csTag,"bank_bal_%s",csCcy);
								PutField_Double(hTxn,csTag,dNewAmt);

								if (dNewAmt < 0.0)
									dNewAmt = 0.0;
								sprintf(csTag,"ratio_%s",csCcy);
								PutField_Double(hTxn,csTag,dNewAmt);
DEBUGLOG(("Authorize::1. ratio_%s = [%f]\n",csCcy,dNewAmt));

								PutField_Double(hTxn,"ratio_D",dTotal+dNewAmt);
DEBUGLOG(("Authorize::1. ratio_D = [%f]+[%f]\n",dTotal,dNewAmt));
							}
							else{
								if(dOrgBankBal>0.0){
									PutField_Double(hTxn,"ratio_D",dTotal+dOrgBankBal);
DEBUGLOG(("Authorize::2. ratio_D = [%f]+[%f]\n",dTotal,dNewAmt));
DEBUGLOG(("Authorize::2. ratio_%s = [%f]\n",csCcy,dOrgBankBal));
									sprintf(csTag,"ratio_%s",csCcy);
									PutField_Double(hTxn,csTag,dOrgBankBal);
								}
								else{
									sprintf(csTag,"ratio_%s",csCcy);
									PutField_Double(hTxn,csTag,0.0);
DEBUGLOG(("Authorize::3. ratio_%s = [0.0]\n",csCcy));
								}
							}
						}
					}

					iRet = PD_OK;
					iCnt ++;
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
		}
		if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBFundsInHistory:GetFundsInHistory\n"));
			iRet = INT_ERR;
			recordset_init(rRecordSet,0);
			DBObjPtr = CreateObj(DBPtr,"DBFundsInHistory","GetFundsInHistory");
			if ((*DBObjPtr)(hTxn,rRecordSet) == PD_OK) {
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if(GetField_Double(hRec,"old_rate",&dRate)){
						sprintf(csTag,"rate_%s",csFromCcy);
						PutField_Double(hTxn,csTag,dRate);
DEBUGLOG(("Authorize::org_old_rate = [%f]\n",dRate));
					}

					iRet = PD_OK;
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
		}
		if(iRet==PD_OK){
			GetField_Double(hTxn,"ratio_D",&dRatioD);
DEBUGLOG(("Authorize::loop. ratio_D = [%f]\n",dRatioD));
			for(i=0; i<iCnt; i++){
				dRate = 0.0;
				dRatio = 0.0;
				dBankBal = 0.0;
				sprintf(csTag, "ccy_%d",i);
				if(GetField_CString(hTxn,csTag,&csCcy)){
					PutField_CString(hTxn,"from_ccy",csCcy);

					sprintf(csTag,"rate_%s",csCcy);
					GetField_Double(hTxn,csTag,&dRate);
					PutField_Double(hTxn,"rate",dRate);

					sprintf(csTag,"bank_bal_%s",csCcy);
					GetField_Double(hTxn,csTag,&dBankBal);
					PutField_Double(hTxn,"bank_bal",dBankBal);

					sprintf(csTag,"ratio_%s",csCcy);
					GetField_Double(hTxn,csTag,&dTmp);
DEBUGLOG(("Authorize::loop. ratio_%s = [%f]\n",csCcy,dTmp));

					if(dRatioD>0.0 && dTmp>0.0)
						dRatio = dTmp/dRatioD;
					PutField_Double(hTxn,"ratio",dRatio);

DEBUGLOG(("Authorize::Call DBSebBalance:Add [%s]to[%s] Bal:[%f] Rate:[%f] Ratio:[%f]\n",csCcy,csBankCcy,dBankBal,dRate,dRatio));
					DBObjPtr = CreateObj(DBPtr,"DBSebBalance","Add");
					iRet = (unsigned long)(*DBObjPtr)(hTxn);
					if (iRet!=PD_OK){
DEBUGLOG(("Authorize::Call DBSebBalance:Add failed\n"));
						break;
					}
					
				}
			}
		}

		if(iRet==PD_SKIP_OK)
			iRet = PD_OK;

		if(iRet==PD_OK){
			//find the related PSF and update their sub-status to Approved
			//csOrgPSFSeq
			hash_init(hTxn,0);
			PutField_CString(hTxn,"txn_seq",csOrgPSFSeq);
			PutField_CString(hTxn,"sub_status",PD_APPROVED);
DEBUGLOG(("Authorize::Call DBOLTransaction:Update PSF [%s]\n",csOrgPSFSeq));
			DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Update");
			iRet = (unsigned long)(*DBObjPtr)(hTxn);
DEBUGLOG(("Authorize::DBOLTransaction:Update iRet = [%d]\n",iRet));
		}
		if(iRet==PD_OK){
			//find all related PST(s) and update their sub-status to Delivering
			recordset_init(rRecordSet,0);
			hash_init(hTxn,0);
			
			DBObjPtr = CreateObj(DBPtr,"DBOLTxnPspDetail","GetOLTxnPspDetailByDlvId");
			if((unsigned long)(*DBObjPtr)(csOrgPSFSeq,PD_DELIVERED, rRecordSet)==PD_OK){
				hRec = RecordSet_GetFirst(rRecordSet);
				while(hRec && iRet==PD_OK){
					if (GetField_CString(hRec,"txn_id",&csTmp)){
						PutField_CString(hTxn,"txn_seq",csTmp);
						PutField_CString(hTxn,"sub_status",PD_DELIVERING);
DEBUGLOG(("Authorize::Call DBOLTransaction:Update PST [%s]\n",csTmp));
						DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Update");
						iRet = (unsigned long)(*DBObjPtr)(hTxn);
DEBUGLOG(("Authorize::DBOLTransaction:Update iRet = [%d]\n",iRet));
					}
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
		}
	}
	else{
///////////////unknown txn_code, DO nothing.
		iRet = INT_ERR;
	}


///update PSF/PSD to 'R','A','Voided'
	if(iRet==PD_OK){
DEBUGLOG(("Call Update Org Transaction\n"));
                DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Update");
                if((unsigned long) ((*DBObjPtr)(hOrgTxn))!=PD_OK)
                        iRet = INT_ERR;
        }
	if(iRet==PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
		(*DBObjPtr)(hContext);
DEBUGLOG(("Authorize:: SystemControl::GetApprovalDT called\n"));
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(hOrgTxn);
	FREE_ME(hTxn);
	FREE_ME(rRecordSet);


DEBUGLOG(("Normal exit iRet = [%d]\n",iRet));	
	return iRet;
}
