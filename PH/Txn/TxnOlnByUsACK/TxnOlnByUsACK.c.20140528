/*
Partnerdelight (c)2014. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/01/23              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOlnByUsACK.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"
#include "dbutility.h"

#define PD_ACK_RESEND   "resend_oln_rck.sh"
char cDebug;

#define	POSTOFFICE_ATM	"B081010"
#define	POSTOFFICE_ATM_METHOD	"031"
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Msg);
void TxnOlnByUsACK(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	int	iTmp;
	long	lKey;
	long	lRspKey;
	double	dTmp;
        char    *csValue = strdup("");
        char    *csChannelCode = strdup("");
	char	csTmpChannelCode[PD_CHANNEL_CODE_LEN *2  +1];
	//char	csDateTime[PD_DATETIME_LEN +1];
	char*	csPtr = NULL;
	char*	csOrgTxnSeq;
	char*	csOrgDstTxnSeq;
	//char	cPtr;
	char*	csBatchTxnSeq;
	char	*csOrgProcessType;
	char	*csOrgProcessCode;
	char	*csMerchantId;
	char	cArInd;
	int	iIgnore = PD_FALSE;
 	struct msg_t* msg;
 	//struct msg_t* rMsg;
	hash_t  *hRec;
	hash_t  *hDtl;
	hex_t   *h_msg;
	
	hash_t  *hRsp, *hAck;
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	recordset_t     *rMerchantSet;
        rMerchantSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rMerchantSet,0);
	
        hRsp = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRsp,0);
        hAck = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hAck,0);


DEBUGLOG(("TxnOlnByUsACK Authorize()\n"));
	if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {

/* ACK LOG  */
		PutField_CString(hAck,"org_txn_seq",csOrgTxnSeq);
		if (GetField_CString(hRequest,"add_user",&csPtr)) {
			PutField_CString(hAck,"add_user",csPtr);
		}
		else {
			PutField_CString(hAck,"add_user",PD_UPDATE_USER);
		}
		PutField_Char(hAck,"status",PD_TO_PSP);

		if (GetField_CString(hContext,"batch_txn_seq",&csBatchTxnSeq)) {
        		PutField_CString(hAck,"txn_seq",csBatchTxnSeq);
DEBUGLOG(("TxnOlnByUsACK batch_txn_seq = [%s]\n",csBatchTxnSeq));
		}
		else {
			char	csTxnSeq[PD_TXN_SEQ_LEN +1];
			DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextOmtTxnSeq");
        		strcpy(csTxnSeq,(*DBObjPtr)());
			csBatchTxnSeq = csTxnSeq;
        		PutField_CString(hAck,"txn_seq",csTxnSeq);
DEBUGLOG(("TxnOlnByUsACK new_txn_seq = [%s]\n",csTxnSeq));
		}
/* end ack log */

/* hard code for xpay*/
		PutField_CString(hRsp,"currency_code","100");
		PutField_CString(hRsp,"language","GB");
		PutField_CString(hRsp,"remark","");

		PutField_CString(hRsp,"txn_seq",csOrgTxnSeq);
DEBUGLOG(("TxnOlnByUsACK org_txn_seq = [%s]\n",csOrgTxnSeq));
        	DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","GetTxnHeader");
        	if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("TxnOlnByUsACK found record = [%s]\n",csOrgTxnSeq));
               		hRec = RecordSet_GetFirst(rRecordSet);
                	while (hRec) {
                       	 	if (GetField_CString(hRec,"process_type",&csOrgProcessType)) {
DEBUGLOG(("TxnOlnByUsACK:process_type= [%s]\n",csOrgProcessType));

					if(!strcmp(csOrgProcessType,PD_PROCESS_TYPE_DSP)) {
						PutField_CString(hRsp,"process_type",PD_PROCESS_TYPE_ACK);
					} else {
						PutField_CString(hRsp,"process_type",csOrgProcessType);
					}
				}
                       	 	if (GetField_CString(hRec,"process_code",&csOrgProcessCode)) {
DEBUGLOG(("TxnOlnByUsACK:process_code= [%s]\n",csOrgProcessCode));
					if(!strcmp(csOrgProcessCode,PD_PROCESS_CODE_DSP)) {
						PutField_CString(hRsp,"process_code",PD_PROCESS_CODE_ACK);
					}
					else if (!strcmp(csOrgProcessCode,PD_PROCESS_CODE_ODD)) {
						PutField_CString(hRsp,"process_code",PD_PROCESS_CODE_ODD_ACK);
					}
					else {
						PutField_CString(hRsp,"process_code",csOrgProcessCode);
					}
				}
                       	 	if (GetField_CString(hRec,"response_code",&csPtr)) {
DEBUGLOG(("TxnOlnByUsACK:response_code= [%s]\n",csPtr));
					PutField_CString(hRsp,"response_code",csPtr);
				}

                       	 	if (GetField_Char(hRec,"ar_ind",&cArInd)) {
DEBUGLOG(("TxnOlnByUsACK:ar_ind= [%c]\n",cArInd));
					PutField_Char(hRsp,"ar_ind",cArInd);
				}
                       	 	if (GetField_CString(hRec,"merchant_id",&csMerchantId)) {
DEBUGLOG(("TxnOlnByUsACK:merchant_id= [%s]\n",csMerchantId));
					PutField_CString(hRsp,"merchant_id",csMerchantId);
                        	}
                       	 	if (GetField_CString(hRec,"merchant_ref",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:merchant_id= [%s]\n",csValue));
					PutField_CString(hRsp,"merchant_ref",csValue);
                        	}
                       	 	if (GetField_CString(hRec,"transmission_datetime",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:transmission_datetime= [%s]\n",csValue));
					PutField_CString(hRsp,"transmission_datetime",csValue);
                        	}
                       	 	if (GetField_CString(hRec,"local_transmission_datetime",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:local_transmission_datetime= [%s]\n",csValue));
					PutField_CString(hRsp,"local_transmission_datetime",csValue);
                        	}
                       	 	if (GetField_CString(hRec,"channel_code",&csChannelCode)) {
DEBUGLOG(("TxnOlnByUsACK:channel_code= [%s]\n",csChannelCode));
                        	}
                       	 	if (GetField_Double(hRec,"net_amt",&dTmp)) {
DEBUGLOG(("TxnOlnByUsACK:net_amt= [%f]\n",dTmp));
					PutField_Double(hRsp,"net_amt",dTmp);
                        	}
                       	 	if (GetField_Double(hRec,"txn_amt",&dTmp)) {
DEBUGLOG(("TxnOlnByUsACK:txn_amt= [%f]\n",dTmp));
					PutField_Double(hRsp,"txn_amt",dTmp);
                        	}
                       	 	if (GetField_Int(hRec,"internal_error",&iTmp)) {
DEBUGLOG(("TxnOlnByUsACK:internal_error= [%d]\n",iTmp));
					PutField_Int(hRsp,"internal_error",iTmp);
                        	}
/*
                       	 	if (GetField_Double(hRec,"fee",&dTmp)) {
DEBUGLOG(("TxnOlnByUsACK:fee= [%f]\n",dTmp));
					PutField_Double(hRsp,"service_fee",dTmp);
                        	}

*/

				if (GetField_CString(hRec, "dst_txn_id", &csOrgDstTxnSeq)) {
DEBUGLOG(("TxnOlnByUsACK: dst_txn_id= [%s]\n", csOrgDstTxnSeq));
				}

				if (GetField_Double(hRec, "display_amt", &dTmp)) {
DEBUGLOG(("TxnOlnByUsACK:display_amt= [%f]\n",dTmp));
					// display_amt -> pay_amt
					PutField_Double(hRsp, "display_amt", dTmp);
				}
				if (GetField_Double(hRec, "deposit_amt", &dTmp)) {
DEBUGLOG(("TxnOlnByUsACK:deposit_amt= [%f]\n",dTmp));
					PutField_Double(hRsp, "deposit_amt", dTmp);
				}



                        	hRec = RecordSet_GetNext(rRecordSet);

/////check return nack or not
				if(cArInd != PD_ACCEPT){
					DBObjPtr = CreateObj(DBPtr,"DBOLMerchDetail","GetMerchant");
					if ((*DBObjPtr)(csMerchantId,
							rMerchantSet) == PD_OK){
						hDtl = RecordSet_GetFirst(rMerchantSet);
						while (hDtl) {
							if (GetField_Int(hDtl,"ignore_nack",&iIgnore)) {
DEBUGLOG(("BOMerchant::GetMerchantTxnInfo() GetMerchantDetail - ignore_nack = [%d]\n",iIgnore));
							}
							if(iIgnore){
								iRet = INT_MERCHANT_IGNORE_NACK;
							}
							hDtl = RecordSet_GetNext(rMerchantSet);
						}
					}
				}

                	}
        	}
		else {
DEBUGLOG(("TxnOlnByUsACK not found record for [%s]\n",csOrgTxnSeq));
			iRet = INT_ORG_TXN_NOT_FOUND;
		}

/* fee charge detail */
		if (iRet == PD_OK) {
                	recordset_init(rRecordSet,0);
        		DBObjPtr = CreateObj(DBPtr,"DBOLTxnElements","GetFeeChgDetailByType");
        		if ((*DBObjPtr)(csOrgTxnSeq,PD_ELEMENT_TXN_FEE,PD_TYPE_MERCHANT,rRecordSet) == PD_OK) {
               			hRec = RecordSet_GetFirst(rRecordSet);
                		while (hRec) {
                       	 		if (GetField_Double(hRec,"amount",&dTmp)) {
DEBUGLOG(("TxnOlnByUsACK:fee= [%f]\n",dTmp));
						PutField_Double(hRsp,"service_fee",dTmp);
					}

                        		hRec = RecordSet_GetNext(rRecordSet);
				}
			}
		}
	}
	else 	
		iRet = INT_ERR;
	
	if (iRet == PD_OK ) {
        	recordset_init(rRecordSet,0);
        	DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","GetTxnDetail");
        	if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
               		hRec = RecordSet_GetFirst(rRecordSet);
                	while (hRec) {
				if (GetField_CString(hRec,"success_callback_url",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:success_callback_url= [%s]\n",csValue));
					PutField_CString(hRsp,"success_callback_url",csValue);
				}
				if (GetField_CString(hRec,"failure_callback_url",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:failure_callback_url= [%s]\n",csValue));
					PutField_CString(hRsp,"failure_callback_url",csValue);
				}


                       	 	if (GetField_CString(hRec,"success_url",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:success_url= [%s]\n",csValue));
					PutField_CString(hRsp,"success_url",csValue);
                        	}
                       	 	if (GetField_CString(hRec,"failure_url",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:failure_url= [%s]\n",csValue));
					PutField_CString(hRsp,"failure_url",csValue);
                        	}
				if(GetField_CString(hRec,"encrypt_type",&csValue)){
DEBUGLOG(("TxnOlnByUsACK:encrypt_type= [%s]\n",csValue));
                                        PutField_CString(hRsp,"encrypt_type",csValue);
                                }
                                else{
DEBUGLOG(("TxnOlnByUsACK:use default encrypt_type= [01]\n"));
                                        PutField_CString(hRsp,"encrypt_type","01");
                                }
/* remark */
                       	 	if (GetField_CString(hRec,"remark",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:remark= [%s]\n",csValue));
					PutField_CString(hRsp,"remark",csValue);
                        	}
/* txn_ccy */
                       	 	if (GetField_CString(hRec,"txn_ccy",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:txn_ccy= [%s]\n",csValue));
					PutField_CString(hRsp,"txn_ccy",csValue);
					PutField_CString(hRsp,"net_ccy",csValue);
					PutField_CString(hRsp,"service_fee_ccy",csValue);
				
					PutField_CString(hRsp, "deposit_ccy", csValue);
					PutField_CString(hRsp, "display_ccy", csValue);
                        	}

/* echo_msg_1 */
                       	 	if (GetField_CString(hRec,"echo_msg_1",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:echo_msg_1 = [%s]\n",csValue));
					PutField_CString(hRsp,"echo_msg_1",csValue);
				}
/* echo_msg_2 */
                       	 	if (GetField_CString(hRec,"echo_msg_2",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:echo_msg_2 = [%s]\n",csValue));
					PutField_CString(hRsp,"echo_msg_2",csValue);
				}
/* echo_msg_3 */
                       	 	if (GetField_CString(hRec,"echo_msg_3",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:echo_msg_3 = [%s]\n",csValue));
					PutField_CString(hRsp,"echo_msg_3",csValue);
				}

/* bank acct num */
				if (GetField_CString(hRec, "bank_acct_num", &csValue)) {
DEBUGLOG(("TxnOlnByUsACK:bank_acct_num = [%s]\n",csValue));
					PutField_CString(hRsp,"bank_acct_num",csValue);
				}
/* bank_deposit date */
				if (GetField_CString(hRec, "bank_deposit_datetime", &csValue)) {
DEBUGLOG(("TxnOlnByUsACK:bank_deposit_datetime= [%s]\n",csValue));
					PutField_CString(hRsp,"bank_deposit_datetime",csValue);
				}



                       		hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}

	if (iRet == PD_OK) {
		if (cArInd == PD_ACCEPT) {
			if (!GetField_CString(hRsp,"success_callback_url",&csPtr)) {
DEBUGLOG(("TxnOlnByUsACK: unable to get success_callback_url!!!\n")); 
				iRet = INT_SUCC_CB_URL_NOT_FOUND;
			}
		} else {
			if (!GetField_CString(hRsp,"failure_callback_url",&csPtr)) {
DEBUGLOG(("TxnOlnByUsACK: unable to get failure_callback_url!!!\n")); 
				iRet = INT_SUCC_CB_URL_NOT_FOUND;
			}
		}

		if (iRet != PD_OK) {
			char *csCmd=(char*) malloc(PD_MAX_FILE_LEN  +1);
			sprintf(csCmd,"check_merchant_url.sh %s %s %c", csMerchantId, csOrgTxnSeq, cArInd);
			system(csCmd);
			FREE_ME(csCmd);
		}
	}

	if (iRet == PD_OK ) {
                recordset_init(rRecordSet,0);
                DBObjPtr = CreateObj(DBPtr,"DBOLTxnPspDetail","GetTxnPspDetail");
                //if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) 
                if ((*DBObjPtr)(csOrgDstTxnSeq,rRecordSet) == PD_OK) {
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
                                if (GetField_CString(hRec,"tid",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:tid= [%s]\n",csValue));
                                        PutField_CString(hRsp,"tid",csValue);
                                }
                                if (GetField_CString(hRec,"fundin_date",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:fundin_date= [%s]\n",csValue));
                                        PutField_CString(hRsp,"fundin_date",csValue);
                                }
                                if (GetField_CString(hRec,"txn_date",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:txn_date= [%s]\n",csValue));
                                        PutField_CString(hRsp,"txn_date",csValue);
                                }
                                if (GetField_CString(hRec,"notice_status",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:notice_status= [%s]\n",csValue));
                                        PutField_CString(hRsp,"notice_status",csValue);
                                }
                                if (GetField_CString(hRec,"error_code",&csValue)) {
DEBUGLOG(("TxnOlnByUsACK:error_code= [%s]\n",csValue));
                                        PutField_CString(hRsp,"error_code",csValue);
                                }
                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                }
        }
        
	if (iRet == PD_OK) {
DEBUGLOG(("TxnOlnByUsACK:BUILD AckAuthData\n"));
		MsgObjPtr = CreateObj(MsgPtr,"OlnMsg","BuildAckAuthData");
        	iRet = (unsigned long)(*MsgObjPtr)(hRsp);
	}

	if (iRet == PD_OK) {
/* Check Merchant Sign*/
               	BOObjPtr = CreateObj(BOPtr,"BOSecurity","GenerateMac");
               	iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest,hRsp);
DEBUGLOG(("BOSecurity->GenerateMac = [%d]\n",iRet));
	}

	if (iRet == PD_OK) {
		sprintf(csTmpChannelCode,"%c%c%cMsg",csChannelCode[0],tolower(csChannelCode[1]),tolower(csChannelCode[2]));
DEBUGLOG(("TxnOlnByUsACK Calling [%s]->[FormatAckMsg]\n",csTmpChannelCode));
	 	MsgObjPtr = CreateObj(MsgPtr,csTmpChannelCode,"FormatAckMsg");
        	h_msg = (hex_t*) malloc (sizeof(hex_t));
        	if ((*MsgObjPtr)(hRsp,h_msg->msg,&h_msg->len) == PD_OK) {
DEBUGLOG(("h_msg->len = [%d]\n",h_msg->len));
			lKey = GetMQKey((unsigned char*)"OLACKQ");
			lRspKey = GetMQKey((unsigned char*)"OLACKRSPQ");
       	         	msg = (struct msg_t*)malloc(sizeof(struct msg_t)+MAX_MSG_SIZE);
                       	msg->mtype  = ctol((const unsigned char *)csOrgTxnSeq,strlen(csOrgTxnSeq));
                	memset(msg->mtext,0,sizeof(msg->mtext));
                        MQ_build_header((unsigned char*)msg->mtext,
                       		 MQ_REQ,
                        	"OCK",
				0,
				"OLACKRSPQ",
				0);
                		memcpy(&msg->mtext[MQ_HEADER_LEN],h_msg->msg,h_msg->len);
                		msg->mtext[MQ_HEADER_LEN + h_msg->len] = '\0';
DEBUGLOG(("send len = [%d]\n",MQ_HEADER_LEN + h_msg->len));

/* set batch txn id to remote reply queue name without 'G' */
			memcpy(&msg->mtext[MQ_REMOTE_REPLY_QUEUE_ID_OS],&csBatchTxnSeq[1],PD_TXN_SEQ_LEN - 1);
                
                	iRet = MQSend(lKey,msg,MQ_HEADER_LEN + h_msg->len);

			if(iRet == PD_OK){
				DBObjPtr = CreateObj(DBPtr,"DBOLTxnAckLog","Add");
				if ((*DBObjPtr)(hAck) != PD_OK) {
DEBUGLOG(("DBTxnAckLog: Add Failed\n"));
					iRet = INT_ERR;
				}

			}
			else {
				PutField_Char(hAck,"status",PD_REJECT);
				PutField_Int(hAck,"internal_erro",iRet);
				DBObjPtr = CreateObj(DBPtr,"DBOLTxnAckLog","Add");
				if ((*DBObjPtr)(hAck) != PD_OK) {
DEBUGLOG(("DBTxnAckLog: Add Failed\n"));
					iRet = INT_ERR;
				}
			}
			TxnCommit();
		}
		FREE_ME(h_msg);
	}

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
        RecordSet_Destroy(rMerchantSet);
        FREE_ME(rMerchantSet);
	FREE_ME(hRsp);
	FREE_ME(csPtr);
        FREE_ME(csValue);

DEBUGLOG(("TxnOlnByUsACK Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
