/*
Partnerdelight (c)2014. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/01/02              Dirk Wong
Special Handling for Pending Fund                  2015/04/28              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsOOP.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnOmtByUsOOP(char    cdebug)
{
        cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int	iRet = PD_OK;

	char	*csTmp = NULL;
	char	cTmp;
	int	iTmp = 0;

	char	*csProviderId = NULL;
	char	*csBAID = NULL;
	char	*csTxnCcy = NULL;
	char	*csUpdateUser = NULL;  
	char	*csTxnCode = NULL;
	char	csTxnCountry[PD_COUNTRY_LEN+1];
	double	dAmt=0.0;
	double	dOrgTxnAmt=0.0;
	int	iGenUniqueAmt=0;

	char*	csBaidCat = NULL;
	char*	csPspId = NULL;
	char*	csPspAcctType = NULL;

	hash_t	*hRec;
	hRec = (hash_t *) malloc (sizeof(hash_t));
	hash_t	*hBalTrfMap;
	hBalTrfMap = (hash_t *) malloc (sizeof(hash_t));
	hash_t	*hOLPspCostsRule;
	hOLPspCostsRule = (hash_t *) malloc (sizeof(hash_t));
	hash_t	*hDt;
	hDt = (hash_t *) malloc (sizeof(hash_t));;
	hash_init(hDt,0);

//From hContext (txn_header already create in channel)
/* txn_seq */

        if(GetField_CString(hContext,"txn_seq",&csTmp)){
                PutField_CString(hResponse,"org_txn_seq",csTmp);
DEBUGLOG(("Authorize::txn_seq= [%s]\n",csTmp));
		PutField_CString(hContext, "from_txn_seq", csTmp);
		PutField_CString(hDt, "txn_seq", csTmp);
        }
        else{
DEBUGLOG(("Authorize::txnid not found!!\n"));
ERRLOG("TxnOmtByUsOOP::Authorize::txnid not found!!\n");
                iRet=INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }



//From API
/* add_user */
        if(GetField_CString(hRequest,"add_user",&csUpdateUser)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csUpdateUser));
DEBUGLOG(("Authorize::update_user= [%s]\n", csUpdateUser));
                PutField_CString(hContext,"add_user",csUpdateUser);
                PutField_CString(hContext,"update_user",csUpdateUser);
		PutField_CString(hDt,"update_user",csUpdateUser);
        }

/* baid */
	if(GetField_CString(hRequest,"baid",&csBAID)){
DEBUGLOG(("Authorize::baid=[%s]\n",csBAID));
		PutField_CString(hContext,"baid",csBAID);
DEBUGLOG(("Authorize:: Call DBOLBankAcctId::GetBankAcctIdDtl\n"));
		hash_init(hRec, 0);

		//DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetBankAcctIdDtl");
		//iRet = (unsigned long)(*DBObjPtr)(csBAID,hRec);
		
		if (iRet == PD_OK) {

			if (GetField_CString(hContext, "baid_status", &csTmp)) {
				if (strcmp(csTmp, PD_BAID_STATUS_OPEN)) {
DEBUGLOG(("Authorize::baid is CLOSED\n"));
ERRLOG("TxnOmtByUsOOP::Authorize::baid is CLOSED\n");
					iRet = INT_INVALID_BAID;
					PutField_Int(hContext,"internal_error",iRet);
				}
			}

			if (GetField_CString(hContext, "baid_psp_id", &csPspId)) {
				PutField_CString(hContext,"psp_id",csPspId);
DEBUGLOG(("Authorize::psp id = [%s]\n",csPspId));
			}

			if (GetField_CString(hContext,"baid_category",&csBaidCat)) {
DEBUGLOG(("Authorize::baid category = [%s]\n",csBaidCat));
			}

			if (GetField_CString(hContext,"baid_bank_code",&csTmp)) {
DEBUGLOG(("Authorize::baid bank_code = [%s]\n",csTmp));
				PutField_CString(hContext, "bank_code", csTmp);
			}

			if (GetField_CString(hContext,"baid_bank_acct_num",&csTmp)) {
DEBUGLOG(("Authorize::baid bank_acct_num = [%s]\n",csTmp));
				PutField_CString(hContext, "bank_acct_num", csTmp);
			}
	
			//Get Country
DEBUGLOG(("Authorize:: Call DBOLBankAcctId:GetBankAcctIdCountry\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetBankAcctIdCountry");
			if ((unsigned long)(*DBObjPtr)(csBAID,csTxnCountry) == FOUND) {
				PutField_CString(hContext,"txn_country",csTxnCountry);
DEBUGLOG(("Authorize::txn_country= [%s]\n",csTxnCountry));
			} else {
				iRet = INT_BAID_COUNTRY_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::baid country NOT FOUND\n"));
ERRLOG("TxnOmtByUsOOP::Authorize::baid country NOT FOUND\n");
			}
		} else {
			iRet = INT_BANK_ACCT_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: Call DBOLBankAcctId::GetBankAcctIdDtl FAILED\n"));
ERRLOG("TxnOmtByUsOOP:: Authorize:: Call DBOLBankAcctId::GetBankAcctIdDtl FAILED\n");
		}
	}

/* txn_ccy */
        if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTxnCcy));
                PutField_CString(hContext,"txn_ccy",csTxnCcy);
		PutField_CString(hContext,"net_ccy", csTxnCcy);
                PutField_CString(hContext,"org_txn_ccy",csTxnCcy);
        }
        else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnOmtByUsOOP::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
        }

// Get Exchange Rate 
	if (iRet == PD_OK) {
		PutField_CString(hContext,"dst_txn_ccy",csTxnCcy);
DEBUGLOG(("Authorize:: Call BOExchange: GetExchangeInfo\n"));
		BOObjPtr = CreateObj(BOPtr, "BOExchange", "GetExchangeInfo");
		iRet = (unsigned long)(*BOObjPtr)(hContext, hRequest);
		if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call: BOExchange.GetExchangeInfo failed, return = [%d]\n", iRet));
ERRLOG("TxnOmtByUsPBF::SetFrTxnRecord:: Call: BOExchange.GetExhcnageInfo failed, return = [%d]\n", iRet);
		}
	}

/* txn_amt */
        if(GetField_Double(hContext,"txn_amt",&dAmt)){
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dAmt));
		dOrgTxnAmt = dAmt;
		PutField_Double(hContext, "txn_amt", dAmt);
		PutField_Double(hContext, "net_amt", dAmt);
		PutField_Double(hContext, "txn_amount", dAmt);
		PutField_Double(hContext, "display_amt", dAmt);
        }
        else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnOmtByUsOOP::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
        }

/* remark */
	if(GetField_CString(hRequest,"remark",&csTmp)){
DEBUGLOG(("Authorize::remark= [%s]\n",csTmp));
		PutField_CString(hContext,"remark",csTmp);
	}

/* report_date */
	if(GetField_CString(hRequest,"report_date",&csTmp)){
DEBUGLOG(("Authorize::report_date= [%s]\n",csTmp));
		PutField_CString(hContext,"report_date",csTmp);
	}

/* gen_unique_amt */
	if(GetField_CString(hRequest,"gen_unique_amt",&csTmp)){
		iGenUniqueAmt = atoi(csTmp);
DEBUGLOG(("Authorize::gen_unique_amt= [%d]\n",iGenUniqueAmt));
		PutField_Int(hContext,"gen_unique_amt",iGenUniqueAmt);
	} else {
DEBUGLOG(("Authorize::gen_unique_amt not found!!\n"));
ERRLOG("TxnOmtByUsOOP::Authorize::gen_unique_amt not found!!\n");
		iRet=INT_GEN_UNIQUE_AMT_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

	hash_destroy(hRec);
	hash_init(hRec,0);
DEBUGLOG(("Authorize:: Call DBOLPspDetail:GetPspDetail\n"));
	DBObjPtr = CreateObj(DBPtr, "DBOLPspDetail","GetPspDetail");
	iRet = (unsigned long)(*DBObjPtr)(csPspId,hRec);
	if (iRet == PD_OK) {
		if (GetField_CString(hRec,"bank_acct_type",&csPspAcctType)) {
DEBUGLOG(("Authorize:: DBOLPspDetail:GetPspDetail bank_acct_type = [%s]\n",csPspAcctType));
		}
		if (GetField_CString(hRec,"client_id",&csProviderId)) {
DEBUGLOG(("Aithorize:: DBOLPspDetail:GetPspDetail client_id = [%s]\n",csProviderId));
		}
	} else {
		iRet = INT_ERR;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: DBOLPspDetail:GetPspDetail FAILED\n"));
ERRLOG("TxnOmtByUsOOP::Authorize:: DBOLPspDetail:GetPspDetail FAILED\n");
	}

	hash_init(hBalTrfMap,0);
	PutField_CString(hBalTrfMap,"bal_trf_type",PD_BAL_TRF_TYPE_CROSS_PLATF);
	PutField_CString(hBalTrfMap,"from_acct_type",PD_CHANNEL_OLN);

//get by BAID>PSP>Nature
	PutField_CString(hBalTrfMap,"to_acct_type",csPspAcctType);

//get by BAID>acct_type
	PutField_CString(hBalTrfMap,"to_baid_category",csBaidCat);

	PutField_CString(hBalTrfMap,"bal_trf_txn_code_type",PD_BAL_TRF_TC_TYPE_SWEEP_IN);

DEBUGLOG(("Authorize:: Call DBOLTcBalTrfMap:GetBalTransferTxnCode\n"));
	DBObjPtr = CreateObj(DBPtr, "DBOLTcBalTrfMap", "GetBalTransferTxnCode");
	if ((unsigned long)(*DBObjPtr)(hBalTrfMap) == PD_FOUND) {
		if (GetField_Int(hBalTrfMap,"allow_fe_init",&iTmp)) {
DEBUGLOG(("Authorize::DBOLTcBalTrfMap::GetBalTransferTxnCode allow_fe_init = [%d]\n",iTmp));
			if (iTmp == 0) {
DEBUGLOG(("Authorize::DBOLTcBalTrfMap::GetBalTransferTxnCode NOT ALLOW FE INIT\n"));
ERRLOG("TxnOmtByUsOOP::Authorize::DBOLTcBalTrfMap::GetBalTransferTxnCode NOT ALLOW FE INIT\n");
				iRet = INT_TXN_CODE_NOT_AVAILABLE;
				PutField_Int(hContext,"internal_error",iRet);
			}
		}
		if (GetField_CString(hBalTrfMap,"map_txn_code",&csTxnCode)) {
DEBUGLOG(("Authorize::DBOLTcBalTrfMap:GetBalTransferTxnCode map_txn_code = [%s]\n",csTxnCode));
/* txn_code */
			PutField_CString(hContext,"txn_code",csTxnCode);
		} else {
DEBUGLOG(("Authorize::DBOLTcBalTrfMap:GetBalTransferTxnCode map_txn_code NOT FOUND!\n"));
ERRLOG("TxnOmtByUsOOP::Authorize::DBOLTcBalTrfMap:GetBalTransferTxnCode map_txn_code NOT FOUND!\n");
			iRet = INT_TXN_CODE_NOT_AVAILABLE;
			PutField_Int(hContext,"internal_error",iRet);
		}
	} else {
		iRet = INT_ERR;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: Call DBOLTcBalTrfMap:GetBalTransferTxnCode FAILED\n"));
ERRLOG("TxnOmtByUsOOP::Authorize:: Call DBOLTcBalTrfMap:GetBalTransferTxnCode FAILED\n");
	}

	hash_init(hOLPspCostsRule,0);
	PutField_CString(hOLPspCostsRule,"provider_id",csProviderId);
	PutField_CString(hOLPspCostsRule,"psp_id",csPspId);
	PutField_CString(hOLPspCostsRule,"baid",csBAID);
	PutField_CString(hOLPspCostsRule,"org_txn_code",csTxnCode);
	PutField_Double(hOLPspCostsRule,"txn_amt",dAmt);
	hash_destroy(hRec);
        hash_init(hRec,0);
DEBUGLOG(("Authorize:: Call  BOOLPspCosts:CalOLPspCostsByParty\n"));
	DBObjPtr = CreateObj(DBPtr, "BOOLPspCosts","CalOLPspCostsByParty");
	iRet = (unsigned long)(*DBObjPtr)(hOLPspCostsRule,hRec);
	if (iRet == PD_OK) {
		if (GetField_Int(hRec,"rule_id",&iTmp)) {
			PutField_Int(hContext,"charge_rule_id",iTmp);
			PutField_Int(hContext,"charge_txn_created",0);
		}
		if (GetField_Char(hRec,"charge_period_type",&cTmp)) {
			PutField_Char(hContext,"charge_period_type",cTmp);
		}
	} else {
DEBUGLOG(("Authorize:: BOOLPspCosts:CalOLPspCostsByParty Not found!\n"));
	}

	if (iGenUniqueAmt == PD_TRUE) {
		PutField_CString(hContext, "channel_code", PD_CHANNEL_OMT);
		PutField_CString(hContext, "org_txn_code", csTxnCode);
		PutField_Double(hContext, "org_txn_amt", dAmt);
DEBUGLOG(("Authorize:: Call BOUniqueNumber:GetUniqueAmt\n"));
		BOObjPtr = CreateObj(BOPtr, "BOUniqueNumber", "GetUniqueAmt");
		iRet = (unsigned long)(*BOObjPtr)(hContext, hContext, hContext);
		if (iRet != PD_OK) {
			iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: Call BOUniqueNumber:GetUniqueAmt FAILED, return = [%d]\n", iRet));
ERRLOG("TxnOmtByUsPBF:: Authorize:: Call BOUniqueNumber:GetUniqueAmt FAILED, return = [%d]\n", iRet);
		} else {
			if (GetField_Double(hContext,"display_amt",&dAmt)) {
				PutField_Double(hContext, "txn_amt", dAmt);
				PutField_Double(hContext, "net_amt", dAmt);
				PutField_Double(hContext, "txn_amount", dAmt);
			} else {
				iRet = INT_ERR;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: BOUniqueNumber:GetUniqueAmt display_amt NOT FOUND\n"));
ERRLOG("TxnOmtByUsPBF:: Authorize:: BOUniqueNumber:GetUniqueAmt display_amt NOT FOUND\n");
			}
		}
	}

	PutField_Char(hContext, "recon_status",PD_UNRECONCILED);
	PutField_Int(hContext, "balance_transfer", PD_TRUE);
	PutField_CString(hContext, "amount_type", PD_CR);
	PutField_Char(hContext,"amt_type",PD_ADJ_TYPE_CREDIT);
// for pending fund, credit account balance instead of in-transit
 	if (!strcmp(csPspAcctType, PD_NATURE_PENDING_FUND)) {
		PutField_CString(hContext, "pool", PD_ACCT_BAL_POOL);
 	} else {
		PutField_CString(hContext, "pool", PD_INTRANSIT_POOL);
	}
	PutField_CString(hContext, "sub_status", PD_APPROVED);

//only use system control CURRENT DATE
	if (GetField_CString(hContext,"local_tm_date",&csTmp)) {
		PutField_CString(hContext,"local_tm_date",csTmp);
		PutField_CString(hContext,"txn_date",csTmp);
	}
	if (GetField_CString(hContext,"local_tm_time",&csTmp)) {
		PutField_CString(hContext,"local_tm_time",csTmp);
		PutField_CString(hContext,"tm_time",csTmp);
		PutField_CString(hContext,"txn_time",csTmp);
	}

	//Update Balance
	if(iRet==PD_OK){
DEBUGLOG(("Authorize:: Call BOOLBalance:UpdateAmount\n"));
                BOObjPtr = CreateObj(BOPtr,"BOOLBalance","UpdateAmount");
		iRet = (unsigned long)((*BOObjPtr)(hContext));
		if (iRet != PD_OK) {
DEBUGLOG(("Authorize::BOOLBalance:UpdateAmount Failed Ret [%d]\n", iRet));
ERRLOG("TxnOmtByUsOOP::BOOLBalance::UpdateAmount Failed Ret [%d]\n", iRet);
                }
	}
	
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBOLTxnPspDetail:Add & DBOLTxnPspDetail:Update\n"));
		//PutField_CString(hContext,"txn_date",csTmDate);
		//PutField_CString(hContext,"txn_time",csTmTime);
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Add");
		iRet = (unsigned long)(*DBObjPtr)(hContext);
		if(iRet==PD_OK){
			DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Update");
			iRet = (unsigned long)(*DBObjPtr)(hContext);
			if (iRet != PD_OK){
DEBUGLOG(("Authorize::DBOLTxnPspDetail:Update Failed Ret [%d]\n", iRet));
ERRLOG("TxnOmtByUsOOP::DBOLTxnPspDetail:Update Failed Ret [%d]\n", iRet);
			}
		} else {
DEBUGLOG(("Authorize::DBOLTxnPspDetail:Add Failed Ret [%d]\n", iRet));
ERRLOG("TxnOmtByUsOOP::DBOLTxnPspDetail:Add Failed Ret [%d]\n", iRet);
		}
	}
	
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call BOOLTxnElements:AddPspTxnElement\n"));
// for pending fund, credit account balance instead of in-transit
		if (!strcmp(csPspAcctType, PD_NATURE_PENDING_FUND)) {
			PutField_CString(hContext,"txn_element_type",PD_ELEMENT_TXN_AMT);
		} else {
			PutField_CString(hContext,"txn_element_type",PD_ELEMENT_IN_TRANSIT);
		}
                BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddPspTxnElement");
		if ((unsigned long)((*BOObjPtr)(hContext)) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize::BOOLTxnElements:AddPspTxnElement Failed Ret [%d]\n", iRet));
ERRLOG("TxnOmtByUsOOP::BOOLTxnElements:AddPspTxnElement Failed Ret [%d]\n", iRet);
		}

	}

	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBOLTransaction:Update\n"));
		PutField_Double(hContext,"txn_amt",dOrgTxnAmt);
		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
		if((unsigned long)(*DBObjPtr)(hContext)!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("Authorize::DBOLTransaction:Update Failed Ret [%d]\n", iRet));
ERRLOG("TxnOmtByUsOOP::DBOLTransaction:Update Failed Ret [%d]\n", iRet);
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBOLTransaction:UpdateDetail\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "UpdateDetail");
		if((unsigned long)(*DBObjPtr)(hDt)!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("Authorize::DBOLTransaction:Update Failed Ret [%d]\n", iRet));
ERRLOG("TxnOmtByUsOOP::DBOLTransaction:Update Failed Ret [%d]\n", iRet);
		}
	}

	if(iRet != PD_OK){
		RemoveField_CString(hContext, "approval_date");
		RemoveField_CString(hContext, "sub_status");
		RemoveField_CString(hContext, "approval_timestamp");
	}

	FREE_ME(hBalTrfMap);
	FREE_ME(hRec);
	FREE_ME(hOLPspCostsRule);

DEBUGLOG(("TxnOmtByUsOOP Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}
