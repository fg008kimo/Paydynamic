/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/09/07              Virginia Yun
Add amount checking	                           2012/10/17		   Virginia Yun
check amount with merch_remain_ava_po		   2014/01/29		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsRTF.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"
#include "dbutility.h"


char cDebug;
OBJPTR(BO);
OBJPTR(DB);
OBJPTR(Channel);

void TxnMgtByUsRTF(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	double	dTxnAmt;
	char	*csFromMid;
	char	*csToMid;
	char	*csFromService;
	char	*csToService;
	char	*csFromCcy;
	char	*csToCcy;
	char	*csCountry;
	//char	*csFromCountry = NULL;
	char	*csToCountry = NULL;
	char	*csTxnSeq;

	char	*csTmp;

	char	*csPHPostingDate;
	char	*csPtr;
	int	iInternalErr;

	hash_t	*hTxn;
	hTxn = (hash_t*) malloc(sizeof(hash_t));
	hash_init(hTxn, 0);

	double	dTmp = 0.0;
	double	dAvaPOBal = 0.0;
	


DEBUGLOG(("Authorize::()\n"));

	if (GetField_CString(hContext,"PHDATE",&csPHPostingDate)) {
DEBUGLOG(("Authorize::()PH DATE = [%s]\n",csPHPostingDate));
	}

/* txn amt */
	if (GetField_Double(hContext,"txn_amt",&dTxnAmt)) {
DEBUGLOG(("Authorize::() txn_amt = [%f]\n",dTxnAmt));
	}
	else {
		iRet = INT_TXN_AMT_MISSING;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::() txn_amt is missing\n"));
ERRLOG("TxnMgtByUsRTF:Authorize() txn amount is missing\n");
	}

	if (dTxnAmt <= 0 ) {
		iRet = INT_INVALID_PAY_AMOUNT;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::() txn_amt is missing\n"));
ERRLOG("TxnMgtByUsRTF:Authorize() txn amount is missing\n");
	}

/* txn country */
/*
	if (GetField_CString(hRequest,"txn_country",&csCountry)) {
		PutField_CString(hContext,"txn_country",csCountry);
DEBUGLOG(("Authorize::() txn_country = [%s]\n",csCountry));
	}
	else {
		iRet = INT_TXN_COUNTRY_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::() txn_country missing\n"));
ERRLOG("TxnMgtByUsRTF:Authorize() txn_country is missing\n");
	}
*/

/* mrechant_id */
	if (GetField_CString(hRequest,"merchant_id",&csFromMid)) {
DEBUGLOG(("Authorize::() merchant_id = [%s]\n",csFromMid));
	}
	else {
		iRet = INT_MERCHANT_ID_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::() merchant_id missing\n"));
ERRLOG("TxnMgtByUsRTF:Authorize() merchant_id is missing\n");
	}

/* to merchant_id */
	if (GetField_CString(hRequest,"to_merchant_id",&csToMid)) {
DEBUGLOG(("Authorize::() to_merchant_id = [%s]\n",csToMid));
	}
	else {
		iRet = INT_MERCHANT_ID_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::() to_merchant_id missing\n"));
ERRLOG("TxnMgtByUsRTF:Authorize() to_merchant_id is missing\n");
	}

/* service */
	if (GetField_CString(hRequest,"service_code",&csFromService)) {
DEBUGLOG(("Authorize::() service = [%s]\n",csFromService));
	}
	else {
		iRet = INT_SERVICE_CODE_MISSING;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::() service missing\n"));
ERRLOG("TxnMgtByUsRTF:Authorize() service is missing\n");
	}

/* to service */
	if (GetField_CString(hRequest,"to_service_code",&csToService)) {
DEBUGLOG(("Authorize::() to_service = [%s]\n",csToService));
	}
	else {
		iRet = INT_SERVICE_CODE_MISSING;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::() to_service missing\n"));
ERRLOG("TxnMgtByUsRTF:Authorize() to_service is missing\n");
	}

/* txn_ccy */
	if (GetField_CString(hRequest,"txn_ccy",&csFromCcy)) {
DEBUGLOG(("Authorize::() txn_ccy = [%s]\n",csFromCcy));
	}
	else {
		iRet = INT_CURRENCY_CODE_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::() txn_ccy missing\n"));
ERRLOG("TxnMgtByUsRTF:Authorize() txn_ccy is missing\n");
	}

/* to txn_ccy */
	if (GetField_CString(hRequest,"dst_txn_ccy",&csToCcy)) {
DEBUGLOG(("Authorize::() dst_txn_ccy = [%s]\n",csToCcy));
	}
	else {
		iRet = INT_CURRENCY_CODE_NOT_FOUND;
DEBUGLOG(("Authorize::() dst_txn_ccy missing\n"));
ERRLOG("TxnMgtByUsRTF:Authorize() dst_txn_ccy is missing\n");
	}
/* from country */
        if (GetField_CString(hRequest,"from_country",&csCountry)) {
DEBUGLOG(("Authorize::() from_country = [%s]\n",csCountry));
        }

/* to_country */
        if (GetField_CString(hRequest,"to_country",&csToCountry)) {
DEBUGLOG(("Authorize::() to_country = [%s]\n",csToCountry));
        }

/*support same country only*/
        if (iRet == PD_OK) {
                if (strcmp(csCountry, csToCountry)) {
                        iRet = INT_NOT_ALLOW_DIFF_COUNTRY;
DEBUGLOG(("Authorize::() difference country not allow\n"));
ERRLOG("TxnMgtOnUSRTF:Authorize() difference country not allow\n");
                        PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* support same service only 
	if (iRet == PD_OK) {
		if (strcmp(csFromService, csToService)) {
			iRet = INT_INVALID_TXN;
DEBUGLOG(("Authorize::() difference service_code not allow\n"));
ERRLOG("TxnMgtByUsRTF:Authorize() difference service_code not allow\n");
		}
	}
*/

/* check same account */
	if (iRet == PD_OK) {
		if (!strcmp(csFromMid,csToMid) && !strcmp(csFromService,csToService) && !strcmp(csFromCcy,csToCcy)) {
			iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::() same account transfer\n"));
ERRLOG("TxnMgtByUsRTF:Authorize() same account transfer\n");
		}
	}

/* txn_amt checking */
	if (iRet == PD_OK) {
		
                DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetRemainPOBalance");
                iRet = (unsigned long)(*DBObjPtr)(hTxn,
						  csFromMid,
						  csFromCcy,
						  csCountry,
						  csFromService,
						  &dTmp);
		if (iRet == PD_OK) {
			if (GetField_Double(hTxn, "merchant_remain_aval_po", &dAvaPOBal)) {
DEBUGLOG(("TxnMgtByUsRTF merchant_aval_po = [%lf]\n",dAvaPOBal));
			}

			if (dTxnAmt > dAvaPOBal) {
				iRet = INT_INSUFFICIENT_FUND;
				PutField_Int(hContext, "internal_error", iRet);
			}
		} else {
DEBUGLOG(("Authorize GetRemainPOBalance FAILED!\n"));
ERRLOG("TxnMgtByUsRTF::Authorize GetRemainPOBalance FAILED\n");
		}
	}



/* check merchant account */
	if (iRet == PD_OK) {
        	hash_t *hReq;
        	hReq = (hash_t*) malloc (sizeof(hash_t));
        	hash_init(hReq,0);

		PutField_CString(hContext,"merchant_id",csFromMid);
		PutField_CString(hContext,"service_code",csFromService);
		PutField_CString(hContext,"txn_ccy",csFromCcy);
		PutField_CString(hContext,"txn_country",csCountry);
		PutField_CString(hContext,"net_ccy",csFromCcy);

		PutField_CString(hReq,"merchant_id",csFromMid);
		PutField_CString(hReq,"service_code",csFromService);
		PutField_CString(hReq,"txn_ccy",csFromCcy);
		PutField_CString(hReq,"txn_country",csCountry);

		if (GetField_CString(hContext,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("Authorize() txn_seq = [%s]\n",csTxnSeq));
		}

DEBUGLOG(("Authorize() BOMerchant->GetMerchantTxnInfo\n"));
		BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantTxnInfo");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hReq);
DEBUGLOG(("Authorize() BOMerchant->GetMerchantTxnInfo = [%d]\n",iRet));
		hash_destroy(hReq);
        	FREE_ME(hReq);


		RemoveField_CString(hContext,"org_txn_seq");
		if (iRet == PD_OK) {
			if(GetField_CString(hContext,"txn_seq",&csTmp)){
				PutField_CString(hContext,"from_txn_seq",csTmp);
				PutField_CString(hResponse,"txn_seq_tf",csTmp);
			}
		}

		/* for update country */
		if (iRet == PD_OK) {
DEBUGLOG(("Authorize() RTF UpdateTxnDetailLog\n"));
			ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateTxnDetailLog");
               		iRet = (unsigned long)(*ChannelObjPtr)(hContext,hRequest,hResponse);
		}
	}


/* check to merchant account */
        if (iRet == PD_OK) {
DEBUGLOG(("check To merchant\n"));

DEBUGLOG(("to mid = [%s]\n",csToMid));
DEBUGLOG(("to service = [%s]\n",csToService));
DEBUGLOG(("to txn_ccy = [%s]\n",csToCcy));
DEBUGLOG(("to txn_country = [%s]\n",csCountry));
        	hash_t *hReq,*hNewContext;
        	hReq = (hash_t*) malloc (sizeof(hash_t));
        	hash_init(hReq,0);
        	hNewContext = (hash_t*) malloc (sizeof(hash_t));
        	hash_init(hNewContext,0);

DEBUGLOG(("Authorize() new txn for TFT\n"));
		unsigned char   csTmpTxnSeq[PD_TXN_SEQ_LEN +1];

/* don't commit */
                PutField_Int(hNewContext,"db_commit",PD_FALSE);

		DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextMgtTxnSeq");
                strcpy((char*)csTmpTxnSeq,(*DBObjPtr)());
/* new txn seq */
                PutField_CString(hNewContext,"txn_seq",(const char*)csTmpTxnSeq);
		PutField_CString(hResponse,"txn_seq_tt",(const char*)csTmpTxnSeq);
/* org txn seq */
		PutField_CString(hNewContext,"org_txn_seq",csTxnSeq);

/* local tm date */
		if (GetField_CString(hContext,"local_tm_date",&csPtr)) {
			PutField_CString(hNewContext,"local_tm_date",csPtr);
		}
/* local tm time */
		if (GetField_CString(hContext,"local_tm_time",&csPtr)) {
			PutField_CString(hNewContext,"local_tm_time",csPtr);
		}
/* add user */
		if (GetField_CString(hRequest,"add_user",&csPtr)) {
			PutField_CString(hNewContext,"add_user",csPtr);
		}
/* ip addr */
		if (GetField_CString(hRequest,"ip_addr",&csPtr)) {
			PutField_CString(hReq,"ip_addr",csPtr);
		}
/* host_posting_date */
		if (GetField_CString(hContext,"PHDATE",&csPtr)) {
			PutField_CString(hNewContext,"PHDATE",csPtr);
		}
	
		PutField_CString(hNewContext,"channel_code",PD_CHANNEL_MGT);
		PutField_CString(hNewContext,"txn_code", PD_AVA_PAYOUT_REQ_TF_TO);
		PutField_CString(hNewContext,"process_code",PD_PROCESS_CODE_DEF);
		PutField_CString(hNewContext,"process_type",PD_PROCESS_TYPE_DEF);

/* txn amt */	
		PutField_Double(hNewContext,"txn_amt",dTxnAmt);
/* update context */
		ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateContext");
               	iRet = (unsigned long)(*ChannelObjPtr)(hContext);


		PutField_CString(hNewContext,"merchant_id",csToMid);
		PutField_CString(hNewContext,"service_code",csToService);
		PutField_CString(hNewContext,"txn_ccy",csFromCcy);
		PutField_CString(hNewContext,"dst_txn_ccy",csToCcy);
		PutField_CString(hNewContext,"bal_ccy",csToCcy);
DEBUGLOG(("Authorize() dst_txn_ccy = [%s]\n",csToCcy));
		PutField_CString(hNewContext,"txn_country",csCountry);
		PutField_CString(hNewContext,"net_ccy",csToCcy);

		PutField_CString(hReq,"merchant_id",csToMid);
		PutField_CString(hReq,"service_code",csToService);
		PutField_CString(hReq,"txn_ccy",csToCcy);
		PutField_CString(hReq,"txn_country",csCountry);

/* update merchant info */
DEBUGLOG(("Authorize() BOMerchant->GetMerchantTxnInfo to merchant\n"));
                BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantTxnInfo");
                iRet = (unsigned long)(*BOObjPtr)(hNewContext,hReq);
DEBUGLOG(("Authorize() BOMerchant->GetMerchantTxnInfo for To Merchant = [%d]\n",iRet));
/* Add New Txn */
		if (iRet == PD_OK) {
			///* txn currency will be same as source */
			PutField_CString(hReq,"txn_ccy",csFromCcy);
			ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnLog");
               		iRet = (unsigned long)(*ChannelObjPtr)(hNewContext,hReq);
		}
		else {
			RemoveField_Int(hNewContext,"internal_error");
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize internal_error [%d]\n", iRet));
		}

                if (iRet == PD_OK) {
DEBUGLOG(("Authorize call UpdateTxnDetailLog\n"));
                        ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateTxnDetailLog");
                        iRet = (unsigned long)(*ChannelObjPtr)(hNewContext,hReq,hResponse);
                }

/* update txn header */
		if (iRet == PD_OK || GetField_Int(hNewContext,"internal_error",&iInternalErr)) {
			char* csBuf = (char*) malloc (128);
                	sprintf(csBuf,"%d",iInternalErr);
                	PutField_CString(hNewContext,"response_code",csBuf);
			PutField_Int(hNewContext,"internal_code",iInternalErr);
DEBUGLOG(("Result_Code = %s\n",csBuf));
                	FREE_ME(csBuf);

                        PutField_CString(hNewContext,"sub_status",PD_REQUESTED);
                        PutField_CString(hContext,"sub_status",PD_REQUESTED);

			if (iInternalErr != 0 ) {
                        	PutField_Char(hNewContext,"status",PD_COMPLETE);
                       	 	PutField_Char(hNewContext,"ar_ind",PD_REJECT);
                	}

			//PutField_CString(hNewContext,"approval_date",csPHPostingDate);

			ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateTxnLog");
               		iRet = (unsigned long)(*ChannelObjPtr)(hNewContext,hReq,hResponse);
		}


		hash_destroy(hReq);
        	FREE_ME(hReq);
		hash_destroy(hNewContext);
        	FREE_ME(hNewContext);
        }

/*
	if (iRet == PD_OK) {
		PutField_CString(hContext,"approval_date",csPHPostingDate);
	}
*/

	hash_destroy(hTxn);
	FREE_ME(hTxn);

DEBUGLOG(("TxnMgtByUsRTF Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
