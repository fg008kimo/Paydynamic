/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/12/23              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMmcByUsIBI.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);

void TxnMmcByUsIBI(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{

	int	iRet = PD_OK;
	int	iHasNextBankId = PD_OK;

	char	cQueryType;
	char	*csBankId = NULL;
	char	*csLastId = NULL;
	char	*csMmcId = NULL;
	int	iMaxRtn = PD_TXN_IPY_MAX_RECORD;
	
	char	*csTmp = NULL;
	int	iTmp = 0;

        char    csTag[PD_TAG_LEN +1];
	char	csStartBankId[PD_BANK_ID_LEN  + 1];

        hash_t *hRec;
        recordset_t     *rRecordSet;

        rRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);



	if (GetField_Char(hContext, "query_type", &cQueryType)) {
DEBUGLOG(("Authorize::query_type = [%c]\n",cQueryType));
	}
	else {
DEBUGLOG(("Authorize::query_type not found!!\n"));
ERRLOG("TxnMmcByUsIBI::Authorize::query_type not found!!\n");
		iRet = INT_ERR;
	}

	if (GetField_CString(hContext, "node_id", &csMmcId)) {
DEBUGLOG(("Authorize::node_id = [%s]\n",csMmcId));
	}
	else {
DEBUGLOG(("Authorize::node_id not found!!\n"));
ERRLOG("TxnMmcByUsIBI::Authorize::node_id not found!!\n");
		iRet = INT_ERR;
	}

	if (GetField_CString(hRequest,"last_id", &csLastId)) {
DEBUGLOG(("Authorize::last_id = [%s]\n", csLastId));

DEBUGLOG(("Authorize::Call DBMmsBankDetail: GetNextBankId\n"));

		memset(csStartBankId, 0, sizeof(csStartBankId));

                DBObjPtr = CreateObj(DBPtr,"DBMmsBankDetail","GetNextBankId");
		iHasNextBankId = (unsigned long)((*DBObjPtr)(csLastId, &csStartBankId));

		if (iHasNextBankId == PD_OK) {
DEBUGLOG(("Authorize::GetNextBankId Succ [%s]\n", csStartBankId));
                }
                else if (iHasNextBankId == PD_NOT_FOUND) {
DEBUGLOG(("Authorize::GetNextBankId Fail - no more Bank id\n"));
		}
		else {
DEBUGLOG(("Authorize::GetNextBankId Fail\n"));
ERRLOG("TxnMmcByUsIBI::Authorize::GetNextBankId Fail!!\n");
			iRet = INT_ERR;
		}
	}
	else {
DEBUGLOG(("Authorize::last_id not found and assign default NULL value\n"));
		strcpy(csStartBankId, PD_MMS_SP_NULL_VALUE);
DEBUGLOG(("Authorize::Assigned Start BankId [%s]\n", csStartBankId));
	}

	if (iRet == PD_OK) {
		if (cQueryType == PD_MMS_SINGLE_QUERY) {
			if (GetField_CString(hContext, "bank_id", &csBankId)) {
DEBUGLOG(("Authorize::bank_id = [%s]\n",csBankId));
			}
			else {
DEBUGLOG(("Authorize::bank_id not found!!\n"));
ERRLOG("TxnMmcByUsIBI::Authorize::bank_id not found!!\n");
				iRet = INT_BANK_ID_NOT_FOUND;
			}
		} 
		else {
			if (GetField_Int(hContext, "max_rtn", &iMaxRtn)) {
DEBUGLOG(("Authorize::max_rtn = [%d]\n",iMaxRtn));
			}
		}
	}

	if (iRet == PD_OK) {

		if (cQueryType == PD_MMS_SINGLE_QUERY) {    // Single
DEBUGLOG(("Authorize::Call DBMmsBankDetail: GetBankDetail\n"));
                	DBObjPtr = CreateObj(DBPtr,"DBMmsBankDetail","GetBankDetail");
			if ((unsigned long)((*DBObjPtr)(csBankId, hContext)) == PD_OK) {

				iTmp++;

				memset(csTag, 0, sizeof(csTag));
				sprintf(csTag, "party_id_%d", iTmp);
				PutField_CString(hResponse, csTag, csBankId);
DEBUGLOG(("Authorize::GetBankDetail [%d] party_id = [%s]\n", iTmp, csBankId));

				if (GetField_CString(hContext, "bank_name", &csTmp)) {
					memset(csTag, 0, sizeof(csTag));
					sprintf(csTag, "party_name_%d", iTmp);
					PutField_CString(hResponse, csTag, csTmp);
DEBUGLOG(("Authorize::GetBankDetail [%d] party_name = [%s]\n", iTmp, csTmp));
				}

				if (GetField_CString(hContext, "bank_acct", &csTmp)) {
					memset(csTag, 0, sizeof(csTag));
					sprintf(csTag, "bank_acct_%d", iTmp);
					PutField_CString(hResponse, csTag, csTmp);
DEBUGLOG(("Authorize::GetBankDetail [%d] bank_acct = [%s]\n", iTmp, csTmp));
				}
				
				memset(csTag, 0, sizeof(csTag));
				sprintf(csTag, "mmc_id_%d", iTmp);
				PutField_CString(hResponse, csTag, csMmcId);
DEBUGLOG(("Authorize::GetBankDetail [%d] mmc_id= [%s]\n", iTmp, csMmcId));

				PutField_Int(hResponse, "total_cnt", iTmp);
				PutField_Int(hResponse, "end_ind", PD_MMS_FETCH_END);
			} 
			else {
DEBUGLOG(("Authorize::Call DBMmsBankDetail: GetBankDetail Fail\n"));
ERRLOG("TxnMmcByUsIBI::Authorize::Call DBMmsBankDetail: GetBankDetail Fail!!\n");
				iRet = PD_ERR;
			}
		
		}
		else {  // Multiple

			if (iHasNextBankId == PD_OK) {

DEBUGLOG(("Authorize::Call DBMmsBankDetail: GetBankDetailbyRange\n"));
				DBObjPtr = CreateObj(DBPtr,"DBMmsBankDetail","GetBankDetailbyRange");

				if ((unsigned long)((*DBObjPtr)(csStartBankId, rRecordSet)) != PD_OK) {
DEBUGLOG(("Authorize::DBMmsBankDetail:GetBankDetailbyRange Failed\n"));
ERRLOG("TxnMmcByUsIBI::Authorize::DBMmsBankDetail:GetBankDetailbyRange Failed\n");
					iRet=INT_ERR;
				}	
				else {

					PutField_Int(hResponse, "total_cnt", iTmp);
					PutField_Int(hResponse, "end_ind", PD_MMS_FETCH_END);

					hRec = RecordSet_GetFirst(rRecordSet);
					while (hRec) {
						iTmp++;

						if (iTmp <= iMaxRtn) {

							if (GetField_CString(hRec, "bank_id", &csTmp)) {
								memset(csTag, 0, sizeof(csTag));
								sprintf(csTag, "party_id_%d", iTmp);
								PutField_CString(hResponse, csTag, csTmp);
DEBUGLOG(("Authorize::GetBankDetailbyRange [%d] party_id = [%s]\n", iTmp, csTmp));
							}

							if (GetField_CString(hRec, "bank_name", &csTmp)) {
								memset(csTag, 0, sizeof(csTag));
								sprintf(csTag, "party_name_%d", iTmp);
								PutField_CString(hResponse, csTag, csTmp);
DEBUGLOG(("Authorize::GetBankDetailbyRange [%d] party_name = [%s]\n", iTmp, csTmp));
							}

							if (GetField_CString(hRec, "bank_acct", &csTmp)) {
								memset(csTag, 0, sizeof(csTag));
								sprintf(csTag, "bank_acct_%d", iTmp);
								PutField_CString(hResponse, csTag, csTmp);
DEBUGLOG(("Authorize::GetBankDetailbyRange [%d] bank_acct = [%s]\n", iTmp, csTmp));
							}

							memset(csTag, 0, sizeof(csTag));
							sprintf(csTag, "mmc_id_%d", iTmp);
							PutField_CString(hResponse, csTag, csMmcId);
DEBUGLOG(("Authorize::GetBankDetailbyRange [%d] mmc_id= [%s]\n", iTmp, csMmcId));

							PutField_Int(hResponse, "total_cnt", iTmp);
						}
						else {
							PutField_Int(hResponse, "end_ind", PD_MMS_FETCH_PENDING);
							break;
						}
						hRec = RecordSet_GetNext(rRecordSet);
					}
				}
			}
			else {
DEBUGLOG(("Authorize::No More Record to fetch\n"));
				PutField_Int(hResponse, "total_cnt", iTmp);
				PutField_Int(hResponse, "end_ind", PD_MMS_FETCH_END);
			}
		} 
	}
		
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);


	if(iRet!=PD_OK){
		PutField_Int(hContext,"internal_error",iRet);
	}


DEBUGLOG(("TxnMmcByUsIBI Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
