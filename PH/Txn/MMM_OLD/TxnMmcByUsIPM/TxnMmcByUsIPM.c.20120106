/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/12/23              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMmcByUsIPM.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);

void TxnMmcByUsIPM(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{

	int	iRet = PD_OK;
	int	iTmpRet = PD_OK;

	char	cQueryType;
	char	cBusinessType;
	char	cPartyType;

	char	*csPartyId = NULL;
	char	*csLastId = NULL;
	char	*csMmcId = strdup("");

	int	iMaxRtn = PD_TXN_IPY_MAX_RECORD;
	int	iRefreshInterval = PD_REFRESH_INTERVAL;
	
	char	*csTmp = NULL;
	int	iTmp = 0;

	char	csStartPartyId[PD_MMS_PARTY_ID_LEN  + 1];
        char    csTag[PD_TAG_LEN +1];

        hash_t *hRec;
        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	hash_t *hTxn;
        hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);


	if(GetField_CString(hRequest,"add_user",&csTmp)){
DEBUGLOG(("Authorize::user = [%s]\n",csTmp));

/*
                PutField_CString(hContext, "update_user", csTmp);
                PutField_CString(hContext, "add_user", csTmp);
*/

		PutField_CString(hTxn, "update_user", csTmp);
		PutField_CString(hTxn, "add_user", csTmp);
	}


	if (GetField_CString(hContext, "node_id", &csTmp)) {
DEBUGLOG(("Authorize::node_id = [%s]\n",csTmp));
		PutField_CString(hTxn, "node_id", csTmp);
	}
	if (GetField_CString(hContext, "mms_key", &csTmp)) {
DEBUGLOG(("Authorize::mms_key = [%s]\n",csTmp));
		PutField_CString(hTxn, "mms_key", csTmp);
	}


	if (GetField_Char(hContext, "query_type", &cQueryType)) {
DEBUGLOG(("Authorize::query_type = [%c]\n",cQueryType));

		PutField_Char(hTxn, "query_type", cQueryType);
	}
	else {
DEBUGLOG(("Authorize::query_type not found!!\n"));
ERRLOG("TxnMmcByUsIPM::Authorize::query_type not found!!\n");
		iRet = INT_ERR;
	}

	if (GetField_CString(hRequest, "mmc_id", &csMmcId)) {
DEBUGLOG(("Authorize::mmc_id = [%s]\n",csMmcId));
	}
	else {
DEBUGLOG(("Authorize::mmc_id not found!!\n"));
		csMmcId = strdup(PD_MMS_SP_NULL_VALUE);
DEBUGLOG(("Authorize::set mmc_id to null default value [%s]!!\n", csMmcId));
	}

	if (GetField_Char(hContext, "business_type", &cBusinessType)) {
DEBUGLOG(("Authorize::business_type = [%c]\n",cBusinessType));
		PutField_Char(hTxn, "business_type", cBusinessType);
	}
	else {
DEBUGLOG(("Authorize::business_type not found!!\n"));
ERRLOG("TxnMmcByUsIPM::Authorize::business_type not found!!\n");
		iRet = INT_ERR;
	}

	if (GetField_Char(hContext, "party_type", &cPartyType)) {
DEBUGLOG(("Authorize::party_type = [%c]\n",cPartyType));

		PutField_Char(hTxn, "party_type", cPartyType);
	}
	else {
DEBUGLOG(("Authorize::party_type not found!!\n"));
ERRLOG("TxnMmcByUsIPM::Authorize::party_type not found!!\n");
		iRet = INT_ERR;
	}

	if (GetField_Int(hContext, "refresh_interval", &iRefreshInterval)) {
DEBUGLOG(("Authorize::refresh_interval = [%d]\n",iRefreshInterval));
		PutField_Int(hTxn, "refresh_interval", iRefreshInterval);
	}
	else {
DEBUGLOG(("Authorize::refresh_interval not found!!\n"));
		PutField_Int(hTxn, "refresh_interval", PD_REFRESH_INTERVAL);
	}


	if (iRet == PD_OK) {
		if (cQueryType == PD_MMS_SINGLE_QUERY) {
			if (GetField_CString(hContext, "party_id", &csPartyId)) {
DEBUGLOG(("Authorize::party_id = [%s]\n",csPartyId));
				PutField_CString(hTxn, "party_id",csPartyId);
			}
			else {
DEBUGLOG(("Authorize::party_id not found!!\n"));
ERRLOG("TxnMmcByUsIPM::Authorize::party_id not found!!\n");
				iRet = INT_ERR;
			}
		} 
		else {
			if (GetField_Int(hContext, "max_rtn", &iMaxRtn)) {
DEBUGLOG(("Authorize::max_rtn = [%d]\n",iMaxRtn));
			}
		}
	}

	if (GetField_CString(hContext, "merchant_id", &csTmp)) {
DEBUGLOG(("Authorize::merchant_id = [%s]\n",csTmp));
		PutField_CString(hTxn, "merchant_id", csTmp);
	}

	if (GetField_CString(hContext, "psp_id", &csTmp)) {
DEBUGLOG(("Authorize::psp_id = [%s]\n",csTmp));
		PutField_CString(hTxn, "psp_id", csTmp);
	}


	if (cPartyType == PD_TYPE_PSP) {

DEBUGLOG(("Authorize:: set txn_code = [%s]\n","IPI"));
		PutField_CString(hTxn,"txn_code", "IPI");
	} 
	else if (cPartyType ==  PD_TYPE_MERCHANT) {

DEBUGLOG(("Authorize:: set txn_code = [%s]\n","ICI"));
		PutField_CString(hTxn,"txn_code", "ICI");

	}


/********************************* For MmsInstantPMAcct Tables ***************************/
	if (iRet == PD_OK) {
		PutField_Char(hTxn, "status",  PD_COMPLETE);

DEBUGLOG(("Authorize::Call BMmsInstantPMAcctHd: ChkValidHeader\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMmsInstantPMAcctHd","ChkValidHeader");
		if ((unsigned long)((*DBObjPtr)(hTxn)) != PD_FOUND) {

DEBUGLOG(("Authorize::Call BMmsInstantPMAcctHd: ChkValidHeader - No Valid Header\n"));



			/******** Update Header or insert header, status = 'P' ********/
			PutField_Char(hTxn, "status", PD_PROCESSING);

DEBUGLOG(("Authorize::Call DBMmsInstantPMAcctHd: UpdateRec\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMmsInstantPMAcctHd","UpdateRec");
			if ((unsigned long)((*DBObjPtr)(hTxn)) != PD_OK) {

DEBUGLOG(("Authorize::DBMmsIntantPMAcctHd:UpdateRec Failed!!\n"));
ERRLOG("TxnMmcByUsIPM::Authorize::DBMmsInstantPMAcctHd:UpdateRec Failed!!\n");
				iRet = INT_ERR;
			}
			else {
DEBUGLOG(("Authorize::DBMmsIntantPMAcctHd:UpdateRec Succ!!\n"));
			}


			/******** Delete Detail ********/
			if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMmsInstantPMAcctDt: Delete\n"));
                        	DBObjPtr = CreateObj(DBPtr,"DBMmsInstantPMAcctDt","Delete");
	                        if ((unsigned long)((*DBObjPtr)(cPartyType, cBusinessType)) != PD_OK) {

DEBUGLOG(("Authorize::DBMmsIntantPMAcctDt:Delete Failed!!\n"));
ERRLOG("TxnMmcByUsIPM::Authorize::DBMmsInstantPMAcctDt:Delete Failed!!\n");
					iRet = INT_ERR;
       	                 	}
	                        else {
DEBUGLOG(("Authorize::DBMmsIntantPMAcctDt:Delete Succ!!\n"));
				}
			}

	                /***** START Call 2 Host *****/
			if (iRet == PD_OK) {
                        	/* if return ok,
                          	* to retrieve data from table */
                	}
	                /***** END Call 2 Host *****/

/**** TESTING *****/
/*
DEBUGLOG(("Authorize:: Call TxnMmcByUsRIA !!\n"));
TxnObjPtr = CreateObj(TxnPtr, "TxnMmcByUsRIA","Authorize");
iRet = (unsigned long)(*TxnObjPtr)(hTxn,hRequest,hResponse);
DEBUGLOG(("Authorize:: End TxnMmcByUsRIA iRet = [%d]!!\n", iRet));
*/


TxnObjPtr = CreateObj(TxnPtr, "TxnMmcByUs2Host","Authorize");
iRet = (unsigned long)(*TxnObjPtr)(hTxn, hRequest,hResponse);

DEBUGLOG(("Authorize:: 2 Host End iRet = [%d]!!\n", iRet));

/*** TESTING ****/




			if (iRet == PD_OK)  {
				/******** Update Header status to 'C' ********/
	                        PutField_Char(hTxn, "status", PD_COMPLETE);

DEBUGLOG(("Authorize::Call DBMmsInstantPMAcctHd: UpdateRec\n"));
				DBObjPtr = CreateObj(DBPtr,"DBMmsInstantPMAcctHd","UpdateRec");
				if ((unsigned long)((*DBObjPtr)(hTxn)) != PD_OK) {

DEBUGLOG(("Authorize::DBMmsIntantPMAcctHd:UpdateRec Failed!!\n"));
ERRLOG("TxnMmcByUsIPM::Authorize::DBMmsInstantPMAcctHd:UpdateRec Failed!!\n");
                                	iRet = INT_ERR;
                        	}
                        	else {
DEBUGLOG(("Authorize::DBMmsIntantPMAcctHd:UpdateRec Succ!!\n"));
                        	}
			}

		}
		else {
DEBUGLOG(("Authorize::DBMmsIntantPMAcctHd:ChkValidHeader Succ!!\n"));
		}

	}


/********************************* Get Results from MmsInstantPMAcct Tables ***************************/
	if (iRet == PD_OK) {

		if (cQueryType == PD_MMS_SINGLE_QUERY) {    // Single
DEBUGLOG(("Authorize::Call BMmsInstantPMAcctDt: GetSingleDetail\n"));
                	DBObjPtr = CreateObj(DBPtr,"DBMmsInstantPMAcctDt","GetSingleDetail");
			if ((unsigned long)((*DBObjPtr)(cPartyType, cBusinessType, csPartyId, hContext)) == PD_OK) {

				iTmp++;

				memset(csTag, 0, sizeof(csTag));
				sprintf(csTag, "party_id_%d", iTmp);
				PutField_CString(hResponse, csTag, csPartyId);
DEBUGLOG(("Authorize::DBMmsInstantPMAcctDt [%d] party_id = [%s]\n", iTmp, csPartyId));

				if (GetField_CString(hContext, "party_name", &csTmp)) {
					memset(csTag, 0, sizeof(csTag));
					sprintf(csTag, "party_name_%d", iTmp);
					PutField_CString(hResponse, csTag, csTmp);
DEBUGLOG(("Authorize::DBMmsInstantPMAcctDt [%d] party_name = [%s]\n", iTmp, csTmp));
				}

				if (GetField_CString(hContext, "mmc_id", &csTmp)) {
					memset(csTag, 0, sizeof(csTag));
					sprintf(csTag, "mmc_id_%d", iTmp);
					PutField_CString(hResponse, csTag, csTmp);
DEBUGLOG(("Authorize::DBMmsInstantPMAcctDt [%d] mmc_id= [%s]\n", iTmp, csTmp));
				}

				PutField_Int(hResponse, "total_cnt", iTmp);
				PutField_Int(hResponse, "end_ind", PD_MMS_FETCH_END);
			} 
			else {
DEBUGLOG(("Authorize::Call DBMmsInstantPMAcctDt : GetSingleDetail Fail\n"));
ERRLOG("TxnMmcByUsIPM::Authorize::Call DBMmsInstantPMAcctDt: GetSingleDetail Fail!!\n");
				iRet = PD_ERR;
			}
		
		}
		else {  // Multiple

		        if (GetField_CString(hRequest,"last_id", &csLastId)) {
DEBUGLOG(("Authorize::last_id = [%s]\n", csLastId));

				memset(csStartPartyId, 0, sizeof(csStartPartyId));

DEBUGLOG(("Authorize::Call MmsInstantPMAcctDt: GetNextPartyId\n"));
				DBObjPtr = CreateObj(DBPtr,"DBMmsInstantPMAcctDt","GetNextPartyId");
				iTmpRet = (unsigned long)((*DBObjPtr)(cPartyType, cBusinessType, csLastId, csMmcId, &csStartPartyId));

				if (iTmpRet == PD_OK) {
DEBUGLOG(("Authorize::GetNextPartyId Succ [%s]\n", csStartPartyId));
				} 
				else if (iTmpRet == PD_NOT_FOUND) {
DEBUGLOG(("Authorize::GetNextPartyId Fail - no more psp id\n"));
				}
				else {
DEBUGLOG(("Authorize::GetNextPartyId Fail\n"));
ERRLOG("TxnMmcByUsIPM::Authorize::GetNextPartyId Fail!!\n");
					iRet = INT_ERR;
				}
			}
			else {
DEBUGLOG(("Authorize::last_id not found and assign default NULL value\n"));
				strcpy(csStartPartyId, PD_MMS_SP_NULL_VALUE);
DEBUGLOG(("Authorize::Assigned Start PartyId [%s]\n", csStartPartyId));
        		}


			if (iTmpRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMmsInstantPMAcctDt: GetDetailRec\n"));
                                DBObjPtr = CreateObj(DBPtr,"DBMmsInstantPMAcctDt","GetDetailRec");

                                if ((unsigned long)((*DBObjPtr)(cPartyType, cBusinessType, csMmcId, csStartPartyId, rRecordSet)) != PD_OK) {
DEBUGLOG(("Authorize::DBMmsInstantPMAcctDt:GetDetailRec Failed\n"));
ERRLOG("TxnMmcByUsIPM::Authorize::DBMmsInstantPMAcctDt:GetDetailRec Failed\n");
                                        iRet=INT_ERR;
                                }
                                else {

                                        PutField_Int(hResponse, "total_cnt", iTmp);
                                        PutField_Int(hResponse, "end_ind", PD_MMS_FETCH_END);

                                        hRec = RecordSet_GetFirst(rRecordSet);
                                        while (hRec) {
						iTmp++;

						if (iTmp <= iMaxRtn) {

                                                        if (GetField_CString(hRec, "party_id", &csTmp)) {
                                                                memset(csTag, 0, sizeof(csTag));
                                                                sprintf(csTag, "party_id_%d", iTmp);
                                                                PutField_CString(hResponse, csTag, csTmp);
DEBUGLOG(("Authorize::GetDetailRec [%d] party_id = [%s]\n", iTmp, csTmp));
                                                        }

                                                        if (GetField_CString(hRec, "party_name", &csTmp)) {
                                                                memset(csTag, 0, sizeof(csTag));
                                                                sprintf(csTag, "party_name_%d", iTmp);
                                                                PutField_CString(hResponse, csTag, csTmp);
DEBUGLOG(("Authorize::GetDetailRec [%d] party_name = [%s]\n", iTmp, csTmp));
                                                        }

							if (GetField_CString(hRec, "mmc_id", &csTmp)) {
                                                        	memset(csTag, 0, sizeof(csTag));
	                                                        sprintf(csTag, "mmc_id_%d", iTmp);
       		                                                 PutField_CString(hResponse, csTag, csTmp);
DEBUGLOG(("Authorize::GetDetailRec [%d] mmc_id= [%s]\n", iTmp, csTmp));
							}
                                                       PutField_Int(hResponse, "total_cnt", iTmp);
                                                }
                                                else {
                                                        PutField_Int(hResponse, "end_ind", PD_MMS_FETCH_PENDING);
                                                        break;
                                                }
                                                hRec = RecordSet_GetNext(rRecordSet);

					}
				}
			
			}
			else {
DEBUGLOG(("Authorize::No More Record to fetch\n"));
                                PutField_Int(hResponse, "total_cnt", iTmp);
                                PutField_Int(hResponse, "end_ind", PD_MMS_FETCH_END);
			}
		}
	}
		
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(csMmcId);
        FREE_ME(hTxn);

	if(iRet!=PD_OK){
		PutField_Int(hContext,"internal_error",iRet);
	}


DEBUGLOG(("TxnMmcByUsIPM Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
