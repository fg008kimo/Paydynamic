/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/12/16              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMmcByUsPTP.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMmcByUsPTP(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{

	int	iRet = PD_OK;

        char    *csTmp;
	char	cTmp;

	double  dTmp ;

	hash_t *hTxn;
	hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);


/* txn_seq */
        if(GetField_CString(hRequest,"txn_seq",&csTmp)){
DEBUGLOG(("Authorize::txn_seq= [%s]\n",csTmp));
                PutField_CString(hTxn,"txn_seq",csTmp);
		PutField_CString(hResponse,"txn_seq",csTmp);
        }
        else{
DEBUGLOG(("Authorize::txnid not found!!\n"));
ERRLOG("TxnMmcByUsPTP::Authorize::txnid not found!!\n");
                iRet=INT_INVALID_TXN;
        }

/* dtl_txn_seq */
/* hRequest - org_dtl_txn_seq */
/*
        if(GetField_CString(hRequest,"dtl_txn_seq",&csTmp)){
DEBUGLOG(("Authorize::dtl_txn_seq= [%s]\n",csTmp));
                PutField_CString(hTxn,"dtl_txn_seq",csTmp);
        }
        else{
DEBUGLOG(("Authorize::dtl_txnid not found!!\n"));
ERRLOG("TxnMmcByUsPTP::Authorize::dtl_txnid not found!!\n");
                iRet=INT_INVALID_TXN;
	}
*/

/* dtl_txn_seq */
        if(GetField_CString(hContext,"dtl_txn_seq",&csTmp)){
DEBUGLOG(("Authorize::dtl_txn_seq= [%s]\n",csTmp));
                PutField_CString(hTxn,"dtl_txn_seq",csTmp);
                PutField_CString(hResponse,"dtl_txn_seq",csTmp);
        }
        else{
DEBUGLOG(("Authorize::dtl_txnid not found!!\n"));
ERRLOG("TxnMmcByUsPTP::Authorize::dtl_txnid not found!!\n");
                iRet=INT_INVALID_TXN;
        }



/* add_user */
        if(GetField_CString(hRequest,"add_user",&csTmp)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csTmp));
                PutField_CString(hTxn,"update_user",csTmp);
        }

/* psp_id */
        if(GetField_CString(hContext,"psp_id",&csTmp)){
DEBUGLOG(("Authorize::psp_id = [%s]\n",csTmp));
                PutField_CString(hTxn,"psp_id",csTmp);
		PutField_CString(hTxn,"src_party_type",PD_MMS_PARTY_PSP);
		PutField_CString(hTxn,"dst_party_type",PD_MMS_PARTY_PSP);
        }


/* isd_ind  */
        if(GetField_Char(hContext,"isd_ind",&cTmp)){
DEBUGLOG(("Authorize::isd_ind = [%c]\n",cTmp));
                PutField_Char(hTxn,"isd_ind",cTmp);
        }

/* txn_amt */
       if(GetField_Double(hContext,"txn_amt",&dTmp)){
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dTmp));
                PutField_Double(hTxn,"txn_amt",dTmp);
        }
        else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMmcByUsPTP::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
        }

/* txn_ccy */
	if(GetField_CString(hRequest,"txn_ccy",&csTmp)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTmp));
                PutField_CString(hTxn,"txn_ccy",csTmp);
	}
	else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMmcByUsPTP::Authorize::ccy not found!!\n");
		iRet=INT_CURRENCY_CODE_NOT_FOUND;
	}

/* adjustment*/
/*
       if(GetField_Double(hContext,"adjustment",&dTmp)){
DEBUGLOG(("Authorize::adjustment = [%f]\n",dTmp));
                PutField_Double(hTxn,"adjustment",dTmp);
        }
        else{
DEBUGLOG(("Authorize::adjustment not found!!\n"));
        }
*/

/* rate */
/*
       if(GetField_Double(hContext,"exchange_rate",&dTmp)){
DEBUGLOG(("Authorize::rate = [%f]\n",dTmp));
                PutField_Double(hTxn,"exchange_rate",dTmp);
        }
        else{
DEBUGLOG(("Authorize::rate not found!!\n"));
        }
*/

/* processing_cost */
       if(GetField_Double(hContext,"processing_cost",&dTmp)){
DEBUGLOG(("Authorize::processing_cost = [%f]\n",dTmp));
                PutField_Double(hTxn,"processing_cost",dTmp);
        }
        else{
DEBUGLOG(("Authorize::processing_cost not found!!\n"));
/*ERRLOG("TxnMmcByUsPTP::Authorize::processing_cost not found!!\n");*/
        }

/* bank_charge */
       if(GetField_Double(hContext,"bank_charge",&dTmp)){
DEBUGLOG(("Authorize::bank_charge = [%f]\n",dTmp));
                PutField_Double(hTxn,"bank_charge",dTmp);
        }
        else{
DEBUGLOG(("Authorize::bank_charge not found!!\n"));
/*ERRLOG("TxnMmcByUsPTP::Authorize::bank_charge not found!!\n");*/
        }

/* bank_charge_refund */
/*
       if(GetField_Double(hConext,"bank_charge_refund",&dTmp)){
DEBUGLOG(("Authorize::bank_charge_refund = [%f]\n",dTmp));
                PutField_Double(hTxn,"bank_charge_refund",dTmp);
        }
        else{
DEBUGLOG(("Authorize::bank_charge_refund not found!!\n"));
ERRLOG("TxnMmcByUsPTP::Authorize::bank_charge_refund not found!!\n");
        }
*/

/* txn_country */
/*
       if(GetField_CString(hRequest,"txn_country",&csTmp)){
DEBUGLOG(("Authorize::txn_country = [%s]\n",csTmp));
                PutField_CString(hTxn,"txn_country",csTmp);
        }
        else{
DEBUGLOG(("Authorize::txn_country not found!!\n"));
        }
*/


/**************************************/
/* Call BO for Cal PSP or MB Bal      */
/**************************************/
/* ??????????????
If isd_ind == SOURCE 
	Debit(-) PSP Balance : processing_cost
	Debit(-) PSP Balance : txn_amt 
   else 
	Credit(+) PSP Balance : txn_amt 
	Debit (-) PSP Balance : processing_cost
	Debit (-) PSP Balance : bank_charge    
*/
/**************************************/



	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call BOMmsBalance: TxnTypeHandler\n"));
                BOObjPtr = CreateObj(BOPtr,"BOMmsBalance","TxnTypeHandler");
		iRet = (unsigned long)((*BOObjPtr)(hTxn));

		if (iRet != PD_OK) {
DEBUGLOG(("Authorize::PTPHandler Failed\n"));
ERRLOG("TxnMmcByUsPTP::Authorize::PTPHandler Failed\n");
                }
        }




	if(iRet!=PD_OK){
		PutField_Int(hContext,"internal_error",iRet);
	}

	FREE_ME(hTxn);

DEBUGLOG(("TxnMmcByUsPTP Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
