/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/11/28              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMmcByUsGDA.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMmcByUsGDA(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{

	int	iRet = PD_OK;

        char    *csTmp;
	char    *csTxnSeq = NULL;
        char    *csFromType = NULL;
        char    *csFromTypeID = NULL;
        char    *csToType = NULL;
        char    *csToTypeID = NULL;
        char    csTag[PD_TAG_LEN+1];

        double  dTmp = 0.0;

	hash_t *hTxn;
	hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);

        if(GetField_CString(hRequest,"txn_seq",&csTxnSeq)){
DEBUGLOG(("Authorize::txn_seq= [%s]\n",csTxnSeq));
                PutField_CString(hTxn,"txn_seq",csTxnSeq);
        }
        else{
DEBUGLOG(("Authorize::txnid not found!!\n"));
ERRLOG("TxnMmsByUsGDA::Authorize::txnid not found!!\n");
                iRet=INT_INVALID_TXN;
        }         

        if(GetField_CString(hRequest,"dtl_txn_seq",&csTmp)){
DEBUGLOG(("Authorize::dtl_txn_seq= [%s]\n",csTmp));
                PutField_CString(hTxn,"dtl_txn_seq",csTmp);
        }
        else{
DEBUGLOG(("Authorize::dtl_txnid not found!!\n"));
ERRLOG("TxnMmsByUsGDA::Authorize::dtl_txnid not found!!\n");
                iRet=INT_INVALID_TXN;
        }         

        if(GetField_CString(hRequest,"add_user",&csTmp)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csTmp));
                PutField_CString(hTxn,"update_user",csTmp);

        }

        if(GetField_CString(hRequest,"transmission_datetime",&csTmp)){
DEBUGLOG(("Authorize::transmission_datetime = [%s]\n",csTmp));
        }
/*        else{
DEBUGLOG(("Authorize::transmission_datetime not found!!\n"));
ERRLOG("TxnMmsByUsGDA::Authorize::txnid not found!!\n");
                iRet=INT_TRASMISSION_TIME_NOT_FOUND;
        }         
*/ 
/*********************/
/* GET SOURCE DETAIL */
/*********************/
/* txn_amt */
       if(GetField_Double(hContext,"txn_amt",&dTmp)){
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dTmp));
        }
        else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMmcByUsGDA::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
        }

/* txn_ccy */
	if(GetField_CString(hRequest,"txn_ccy",&csTmp)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTmp));
	}
	else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMmcByUsGDA::Authorize::ccy not found!!\n");
		iRet=INT_CURRENCY_CODE_NOT_FOUND;
	}

/* adjustment*/
       if(GetField_Double(hContext,"adjustment",&dTmp)){
DEBUGLOG(("Authorize::adjustment = [%f]\n",dTmp));
        }
        else{
DEBUGLOG(("Authorize::adjustment not found!!\n"));
        }

/* rate */
       if(GetField_Double(hContext,"exchange_rate",&dTmp)){
DEBUGLOG(("Authorize::exchange_rate = [%f]\n",dTmp));
        }
        else{
DEBUGLOG(("Authorize::exchange_rate not found!!\n"));
        }

/* processing_cost */
       if(GetField_Double(hContext,"processing_cost",&dTmp)){
DEBUGLOG(("Authorize::processing_cost = [%f]\n",dTmp));
        }
        else{
DEBUGLOG(("Authorize::processing_cost not found!!\n"));
//ERRLOG("TxnMmcByUsGDA::Authorize::processing_cost not found!!\n");
        }

/* bank_charge */
       if(GetField_Double(hContext,"bank_charge",&dTmp)){
DEBUGLOG(("Authorize::bank_charge = [%f]\n",dTmp));
        }
        else{
DEBUGLOG(("Authorize::bank_charge not found!!\n"));
//ERRLOG("TxnMmcByUsGDA::Authorize::bank_charge not found!!\n");
        }

/* bank_charge_refund */
       if(GetField_Double(hContext,"bank_charge_refund",&dTmp)){
DEBUGLOG(("Authorize::bank_charge_refund = [%f]\n",dTmp));
        }
        else{
DEBUGLOG(("Authorize::bank_charge_refund not found!!\n"));
//ERRLOG("TxnMmcByUsGDA::Authorize::bank_charge_refund not found!!\n");
        }


/* filing Number */
       if(GetField_Double(hRequest,"filing_number",&csTmp)){
DEBUGLOG(("Authorize::filing_number = [%d]\n",csTmp));
        }
        else{
DEBUGLOG(("Authorize::filing_number not found!!\n"));
//ERRLOG("TxnMmcByUsGDA::Authorize::filing_num not found!!\n");
        }



/*****************************/
/* GET SOURCE AND DEST PARTY */
/*****************************/
/* from_type */
        if(GetField_CString(hRequest,"mms_from_type",&csFromType)){
DEBUGLOG(("Authorize::from_type = [%s]\n",csFromType));
        }
        else{
DEBUGLOG(("Authorize::from_type not found!!\n"));
ERRLOG("TxnMmcByUsGDA::Authorize::from_type not found!!\n");
		iRet=INT_ERR;
        }

/* from_id */
        if(GetField_CString(hRequest,"mms_from_id",&csFromTypeID)){
DEBUGLOG(("Authorize::from_id = [%s]\n",csFromTypeID));
        }
        else{
DEBUGLOG(("Authorize::from_id not found!!\n"));
ERRLOG("TxnMmcByUsGDA::Authorize::from_id not found!!\n");
		iRet=INT_ERR;
        }

/* to_type */
        if(GetField_CString(hRequest,"mms_to_type",&csToType)){
DEBUGLOG(("Authorize::to_type = [%s]\n",csToType));
        }
        else{
DEBUGLOG(("Authorize::to_type not found!!\n"));
ERRLOG("TxnMmcByUsGDA::Authorize::to_type not found!!\n");
		iRet=INT_ERR;
        }

/* to_id */
        if(GetField_CString(hRequest,"mms_to_id",&csToTypeID)){
DEBUGLOG(("Authorize::to_id = [%s]\n",csToTypeID));
        }
        else{
DEBUGLOG(("Authorize::to_id not found!!\n"));
ERRLOG("TxnMmcByUsGDA::Authorize::to_id not found!!\n");
		iRet=INT_ERR;
	}

/* destination */
	PutField_Char(hContext, "isd_ind", PD_DESTINATION);

/* Assign Correct Source ID */
	if (!strcmp(csToType, PD_MMS_PARTY_MERCH)) {
		sprintf(csTag,"merchant_id");
	} else if (!strcmp(csToType, PD_MMS_PARTY_PSP)) {
		sprintf(csTag,"psp_id");
	} else if (!strcmp(csToType, PD_MMS_PARTY_MB)) {
		sprintf(csTag,"mb_id");
	} else if (!strcmp(csToType, PD_MMS_PARTY_BANK)) {
		sprintf(csTag,"bank_id");
	} else{
		sprintf(csTag,"from_id");
	}
	PutField_CString(hContext,csTag,csToTypeID);
DEBUGLOG(("Authorize::%s = [%s]\n",csTag,csToTypeID));


/* Get Txn Code */
        if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call BOMmsTask:NewTask\n"));

		BOObjPtr = CreateObj(BOPtr,"BOMmsTask","NewTask");
                if((unsigned long) ((*BOObjPtr)(hContext, hRequest, hResponse)) != PD_OK){
                        iRet = INT_ERR;
		}
	}

 
       if (iRet == PD_OK) {
		PutField_Char(hTxn, "status", PD_COMPLETE);
		PutField_Char(hTxn, "ar_ind", PD_ACCEPT);

DEBUGLOG(("Authorize::Call DBMmsTransaction:UpdateDetail\n"));

		DBObjPtr = CreateObj(DBPtr,"DBMmsTransaction","UpdateDetail");
		if((unsigned long) ((*DBObjPtr)(hTxn)) != PD_OK){
			iRet = INT_ERR;
		}
	}


	if(iRet!=PD_OK){
		PutField_Int(hContext,"internal_error",iRet);
	}

	FREE_ME(hTxn);

DEBUGLOG(("TxnMmcByUsGDA Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
