/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/11/28              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMmcByUsGSA.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMmcByUsGSA(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{

	int	iRet = PD_OK;

        char    *csTmp;
	char    *csTxnSeq = NULL;
        char    *csFromType = NULL;
        char    *csFromTypeID = NULL;
        char    *csToType = NULL;
        char    *csToTypeID = NULL;

        double  dTmp = 0.0;

        char    *csTxnCode = NULL;
        char    *csTxnDesc = NULL;

        hash_t   *hTxn; /* for handle previous detail record */

	hTxn = (hash_t *) malloc(sizeof(hash_t));
	hash_init(hTxn, 0);

        if(GetField_CString(hContext,"txn_seq",&csTxnSeq)){
DEBUGLOG(("Authorize::txn_seq= [%s]\n",csTxnSeq));
		PutField_CString(hContext, "txn_seq", csTxnSeq);
		PutField_CString(hTxn, "txn_seq", csTxnSeq);
        }
        else{
DEBUGLOG(("Authorize::txnid not found!!\n"));
ERRLOG("TxnMmsByUsGSA::Authorize::txnid not found!!\n");
                iRet=INT_INVALID_TXN;
        }         

        if(GetField_CString(hRequest,"add_user",&csTmp)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csTmp));
                PutField_CString(hContext,"add_user",csTmp);
                PutField_CString(hContext,"update_user",csTmp);

                PutField_CString(hTxn,"update_user",csTmp);
        }

        if(GetField_CString(hRequest,"transmission_datetime",&csTmp)){
DEBUGLOG(("Authorize::transmission_datetime = [%s]\n",csTmp));
		PutField_CString(hContext, "transmission_datetime", csTmp);
        }
        else{
DEBUGLOG(("Authorize::transmission_datetime not found!!\n"));
ERRLOG("TxnMmsByUsGSA::Authorize::txnid not found!!\n");
                iRet=INT_TRASMISSION_TIME_NOT_FOUND;
        }         
 
/*********************/
/* GET SOURCE DETAIL */
/*********************/
/* txn_amt */
       if(GetField_Double(hContext,"txn_amt",&dTmp)){
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dTmp));
		/*PutField_Double(hContext, "txn_amt", dTmp);*/
        }
        else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMmcByUsGSA::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
        }

/* txn_ccy */
	if(GetField_CString(hContext,"txn_ccy",&csTmp)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTmp));
		/*PutField_CString(hContext, "txn_ccy", csTmp);*/
	}
	else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMmcByUsGSA::Authorize::ccy not found!!\n");
		iRet=INT_CURRENCY_CODE_NOT_FOUND;
	}

/* adjustment*/
       if(GetField_Double(hRequest,"adjustment",&dTmp)){
DEBUGLOG(("Authorize::adjustment = [%f]\n",dTmp));
		PutField_Double(hContext, "txn_amt", dTmp);
        }
        else{
DEBUGLOG(("Authorize::adjustment not found!!\n"));
        }

/* rate */
       if(GetField_Double(hRequest,"rate",&dTmp)){
DEBUGLOG(("Authorize::rate = [%f]\n",dTmp));
        }
        else{
DEBUGLOG(("Authorize::rate not found!!\n"));
        }

/* processing_cost */
       if(GetField_Double(hRequest,"pc",&dTmp)){
DEBUGLOG(("Authorize::processing_cost = [%f]\n",dTmp));
		PutField_Double(hContext, "processing_cost", dTmp);
        }
        else{
DEBUGLOG(("Authorize::processing_cost not found!!\n"));
ERRLOG("TxnMmcByUsGSA::Authorize::processing_cost not found!!\n");
        }

/* bank_charge */
       if(GetField_Double(hRequest,"bk_chrg",&dTmp)){
DEBUGLOG(("Authorize::bank_charge = [%f]\n",dTmp));
		PutField_Double(hContext, "bank_charge", dTmp);
        }
        else{
DEBUGLOG(("Authorize::bank_charge not found!!\n"));
ERRLOG("TxnMmcByUsGSA::Authorize::bank_charge not found!!\n");
        }

/* bank_charge_refund */
       if(GetField_Double(hRequest,"bk_chrg_refund",&dTmp)){
DEBUGLOG(("Authorize::bank_charge_refund = [%f]\n",dTmp));
		PutField_Double(hContext, "bank_charge_refund", dTmp);
        }
        else{
DEBUGLOG(("Authorize::bank_charge_refund not found!!\n"));
ERRLOG("TxnMmcByUsGSA::Authorize::bank_charge_refund not found!!\n");
        }


/* filing Number */
       if(GetField_Double(hRequest,"filing_num",&csTmp)){
DEBUGLOG(("Authorize::filing_num = [%d]\n",csTmp));
		PutField_CString(hContext, "filing_num", csTmp);
        }
        else{
DEBUGLOG(("Authorize::filing_num not found!!\n"));
ERRLOG("TxnMmcByUsGSA::Authorize::filing_num not found!!\n");
        }


/* txn_country */
        if(GetField_CString(hContext,"txn_country",&csTmp)){
DEBUGLOG(("Authorize::txn_country= [%s]\n",csTmp));
		/*PutField_CString(hContext, "txn_country", csTmp);*/
        }
        else{
DEBUGLOG(("Authorize::country not found!!\n"));
ERRLOG("TxnMmcByUsGSA::Authorize::country not found!!\n");
                iRet=INT_TXN_COUNTRY_NOT_FOUND;
        }

/* version_no */
        if(GetField_CString(hRequest,"version_no",&csTmp)){
DEBUGLOG(("Authorize::version_no = [%s]\n",csTmp));
		PutField_CString(hContext, "version_no", csTmp);
        }
        else{
DEBUGLOG(("Authorize::version_no not found!!\n"));
ERRLOG("TxnMmcByUsGSA::Authorize::version_no not found!!\n");
		iRet=INT_ERR;
        }


/* encrypt_type */
        if(GetField_CString(hRequest,"encrypt_type",&csTmp)){
DEBUGLOG(("Authorize::encrypt_type = [%s]\n",csTmp));
		PutField_CString(hContext, "encrypt_type", csTmp);
        }
        else{
DEBUGLOG(("Authorize::encrypt_type not found!!\n"));
ERRLOG("TxnMmcByUsGSA::Authorize::encrypt_type not found!!\n");
		iRet=INT_ERR;
        }

/*****************************/
/* GET SOURCE AND DEST PARTY */
/*****************************/
/* from_type */
        if(GetField_CString(hRequest,"from_type",&csFromType)){
DEBUGLOG(("Authorize::from_type = [%s]\n",csFromType));
        }
        else{
DEBUGLOG(("Authorize::from_type not found!!\n"));
ERRLOG("TxnMmcByUsGSA::Authorize::from_type not found!!\n");
		iRet=INT_ERR;
        }

/* from_id */
        if(GetField_CString(hRequest,"from_id",&csFromTypeID)){
DEBUGLOG(("Authorize::from_id = [%s]\n",csFromTypeID));
        }
        else{
DEBUGLOG(("Authorize::from_id not found!!\n"));
ERRLOG("TxnMmcByUsGSA::Authorize::from_id not found!!\n");
		iRet=INT_ERR;
        }

/* to_type */
        if(GetField_CString(hRequest,"to_type",&csToType)){
DEBUGLOG(("Authorize::to_type = [%s]\n",csToType));
        }
        else{
DEBUGLOG(("Authorize::to_type not found!!\n"));
ERRLOG("TxnMmcByUsGSA::Authorize::to_type not found!!\n");
		iRet=INT_ERR;
        }

/* to_id */
        if(GetField_CString(hRequest,"to_id",&csToTypeID)){
DEBUGLOG(("Authorize::to_id = [%s]\n",csToTypeID));
        }
        else{
DEBUGLOG(("Authorize::to_id not found!!\n"));
ERRLOG("TxnMmcByUsGSA::Authorize::to_id not found!!\n");
		iRet=INT_ERR;
	}

/* Get Txn Code */
        if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMmsTxnCode:FindTxnCodeByType\n"));

		DBObjPtr = CreateObj(DBPtr,"DBMmsTxnCode","FindTxnCodeByType");
                if((unsigned long) ((*DBObjPtr)(csTxnCode, csTxnDesc, csFromType, csToType)) != FOUND){
                        iRet = INT_ERR;
		}
                else{
DEBUGLOG(("Authorize::Call DBMmsTxnCode: csTxnCode [%s] Desc [%s]\n", csTxnCode, csTxnDesc));
			PutField_CString(hContext,"txn_code",csTxnCode);
                }
	}

/* Assign Correct Source ID */
        if (!strcmp(csFromType, PD_MMS_PARTY_MERCH)) {
		PutField_CString(hContext, "merchant_id", csFromTypeID);
	} else if (!strcmp(csFromType, PD_MMS_PARTY_PSP)) {
		PutField_CString(hContext, "psp_id", csFromTypeID);
        } else if (!strcmp(csFromType, PD_MMS_PARTY_MB)) {
		PutField_CString(hContext, "mb_id", csFromTypeID);
        } else if (!strcmp(csFromType, PD_MMS_PARTY_BANK)) {
		PutField_CString(hContext, "bank_id", csFromTypeID);
        } else {
           iRet = INT_ERR;
        }
 

/************************************/
/* ASSIGN VALUE FOR STATUS, ISD_IND */
/************************************/
	PutField_Char(hContext, "status", PD_MMC_PENDING);

	PutField_Char(hTxn, "status", PD_COMPLETE);
	PutField_Char(hTxn, "ar_ind", PD_ACCEPT);

	PutField_Char(hContext, "isd_ind",PD_MMS_ISD_IND_SOURCE);


/************************************/
/* BO: Calculation on Bal           */
/************************************/
/* .....................*/
/* NOT HANDLE...........*/
/* .....................*/



/**************************/
/* GEN NEW DETAIL TXN SEQ */
/**************************/
/** Get from MMCChannel */
/*
	DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextMmsTxnRunningSeq");
	strcpy(csTmp,(*DBObjPtr)());
DEBUGLOG(("Authorize::DBTxnSeq:GetNextMmsTxnRunningSeq [%s]\n", csTmp));
	PutField_CString(hContext,"dtl_txn_seq",csTmp);
	PutField_CString(hResponse,"dtl_txn_seq",csTmp);
*/
/** Get from MMCChannel */



/**********************************/
/* UPDATE PREVIOUS MMS_TXN_DETAIL */
/**********************************/
/*
	if (iRet == PD_OK) {

		/* Get Max Detail Seq */
DEBUGLOG(("Authorize::Call DBMmsTransaction:GetMaxDetailSeq\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMmsTransaction","GetMaxDetailSeq");
                if((unsigned long) ((*DBObjPtr)(csTxnSeq, csTmp)) == FOUND) {
DEBUGLOG(("Authorize::Call DBMmsTransaction:Previous Detail Seq = [%s]\n", csTmp));
			PutField_CString(hTxn, "dtl_txn_seq", csTmp);

DEBUGLOG(("Authorize::Call DBMmsTransaction:UpdateDetail\n"));

			DBObjPtr = CreateObj(DBPtr,"DBMmsTransaction","UpdateDetail");
			if((unsigned long) ((*DBObjPtr)(hTxn)) != PD_OK){
				iRet = INT_ERR;
			}
		}
                else {
DEBUGLOG(("Authorize::Call DBMmsTransaction:Previous Detail Seq NOT FOUND"));
		}
	}
*/

/******************************/
/* INSERT INTO MMS_TXN_DETAIL */
/******************************/
/*
        if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMmsTransaction:AddDetail\n"));

		DBObjPtr = CreateObj(DBPtr,"DBMmsTransaction","AddDetail");
                if((unsigned long) ((*DBObjPtr)(hContext)) != PD_OK){
                        iRet = INT_ERR;
		}
	}
*/


	hash_destroy(hTxn);
	FREE_ME(hTxn);

	if(iRet!=PD_OK){
		PutField_Int(hContext,"internal_error",iRet);
	}


DEBUGLOG(("TxnMmcByUsGSA Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
