/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/01/12              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnWebByUsINQ.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;

OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Msg);
void TxnWebByUsINQ(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	int	iTmp;
	long	lKey;
	double	dTmp;
        char    *csValue = strdup("");
        char    *csChannelCode = strdup("");
	char*	csPtr = NULL;
	char*	csOrgTxnSeq;
	char	cPtr;
	char	*csPspId;
 	struct msg_t* msg;
	hash_t  *hRec;
	hex_t   *h_msg;
	
	hash_t  *hRsp;
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	
        hRsp = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRsp,0);

DEBUGLOG(("TxnWebByUsINQ Authorize()\n"));
	if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {
	
		PutField_CString(hRsp,"txn_seq",csOrgTxnSeq);
		PutField_CString(hContext,"txn_seq",csOrgTxnSeq);

DEBUGLOG(("TxnWebByUsINQ org_txn_seq = [%s]\n",csOrgTxnSeq));
        	DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
        	if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("TxnWebByUsINQ found record = [%s]\n",csOrgTxnSeq));
               		hRec = RecordSet_GetFirst(rRecordSet);
                	while (hRec) {
                       	 	if (GetField_Char(hRec,"status",&cPtr)) {
DEBUGLOG(("TxnWebByUsINQ:status= [%c]\n",cPtr));
					PutField_Char(hRsp,"txn_status",cPtr);
				}
                       	 	if (GetField_CString(hRec,"merchant_id",&csValue)) {
DEBUGLOG(("TxnWebByUsINQ:merchant_id= [%s]\n",csValue));
					PutField_CString(hRsp,"merchant_id",csValue);
                        	}
                       	 	if (GetField_CString(hRec,"merchant_ref",&csValue)) {
DEBUGLOG(("TxnWebByUsINQ:merchant_id= [%s]\n",csValue));
					PutField_CString(hRsp,"merchant_ref",csValue);
                        	}
                       	 	if (GetField_CString(hRec,"transmission_datetime",&csValue)) {
DEBUGLOG(("TxnWebByUsINQ:transmission_datetime= [%s]\n",csValue));
					PutField_CString(hRsp,"transmission_datetime",csValue);
                        	}
                       	 	if (GetField_CString(hRec,"local_transmission_datetime",&csValue)) {
DEBUGLOG(("TxnWebByUsINQ:local_transmission_datetime= [%s]\n",csValue));
					PutField_CString(hRsp,"local_transmission_datetime",csValue);
                        	}
                       	 	if (GetField_CString(hRec,"channel_code",&csChannelCode)) {
DEBUGLOG(("TxnWebByUsINQ:channel_code= [%s]\n",csChannelCode));
                        	}
/* net_amt */
                       	 	if (GetField_Double(hRec,"net_amt",&dTmp)) {
DEBUGLOG(("TxnWebByUsINQ:net_amt= [%f]\n",dTmp));
					PutField_Double(hRsp,"net_amt",dTmp);
                        	}
/* txn_amt */
                       	 	if (GetField_Double(hRec,"txn_amt",&dTmp)) {
DEBUGLOG(("TxnWebByUsINQ:txn_amt= [%f]\n",dTmp));
					PutField_Double(hRsp,"txn_amt",dTmp);
                        	}

                       	 	if (GetField_Int(hRec,"internal_error",&iTmp)) {
DEBUGLOG(("TxnWebByUsINQ:internal_error= [%d]\n",iTmp));
					PutField_Int(hRsp,"internal_error",iTmp);
                        	}
                        	hRec = RecordSet_GetNext(rRecordSet);
                	}
        	}
		else {
DEBUGLOG(("TxnWebByUsINQ not found record for [%s]\n",csOrgTxnSeq));
			iRet = PD_ERR;
		}

/* txn detail */
		if (iRet == PD_OK) {
        		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
        		if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
                       	 		if (GetField_CString(hRec,"language",&csValue)) {
DEBUGLOG(("TxnWebByUsINQ:language= [%s]\n",csValue));
						PutField_CString(hRsp,"language",csValue);
                        		}
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
		}
/* txn psp detail */
		if (iRet == PD_OK) {
        		DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","GetTxnPspDetail");
        		if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
                       	 		if (GetField_CString(hRec,"txn_ccy",&csValue)) {
DEBUGLOG(("TxnWebByUsINQ:txn_ccy= [%s]\n",csValue));
						PutField_CString(hRsp,"txn_ccy",csValue);
                        		}

                       	 		if (GetField_CString(hRec,"psp_id",&csPspId)) {
DEBUGLOG(("TxnWebByUsINQ:psp_id= [%s]\n",csPspId));
						PutField_CString(hRsp,"psp_id",csPspId);
                        		}
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
		}

		if (iRet == PD_OK) {
               		BOObjPtr = CreateObj(BOPtr,"BOPsp","GetTxnPspByPspId");
                       	iRet = (unsigned long)(*BOObjPtr)(hContext,hRsp,csPspId);
			if (iRet == PD_OK) {
                       		if (GetField_CString(hContext,"psp_merchant_id",&csValue)) {
DEBUGLOG(("TxnWebByUsINQ:psp_merchant_id= [%s]\n",csValue));
					PutField_CString(hRsp,"psp_merchant_id",csValue);
                        	}
			}
		}

	}
	else 	
		iRet = INT_ERR;

	if (iRet == PD_OK) {
		/* tO ESKY Request */
               	if (!strcmp(csPspId,PD_PSP_ESKY)) {
               		BOObjPtr = CreateObj(BOPtr,"BOSecurity","GenerateEskySign");
                       	iRet = (unsigned long)(*BOObjPtr)(hContext,hRsp);
DEBUGLOG(("BOSecurity->GenerateEskySign = [%d]\n",iRet));
                       	char* csPspUrl;
                       	char* csRequestFunction;
                       	char  csTmpBuf[PD_TMP_BUF_LEN + 1];
                       	GetField_CString(hContext,"psp_url",&csPspUrl);
                       	GetField_CString(hContext,"request_function",&csRequestFunction);
                       	sprintf(csTmpBuf,"%s/%s",csPspUrl,csRequestFunction);
                       	PutField_CString(hRsp,"redirect_url",csTmpBuf);
DEBUGLOG(("redirect_url = [%s]\n",csTmpBuf));
             	}
	}
	
        

	if (iRet == PD_OK) {
		char* 	csPspChannelCode;
		char	csCode[PD_TMP_BUF_LEN +1];
		char	csVal[PD_TMP_BUF_LEN +1];
		GetField_CString(hContext,"psp_channel_code",&csPspChannelCode);
DEBUGLOG(("Authorize() psp_channel_code = [%s]\n",csPspChannelCode));
        	sprintf(csCode,"RSP_%s",csPspChannelCode);
DEBUGLOG(("Authorize() code = [%s]\n",csCode));
                        
        	DBObjPtr = CreateObj(DBPtr,"DBSystemParameter","FindCode");
        	if ((unsigned long)(DBObjPtr)(csCode,csVal) == FOUND) {
DEBUGLOG(("Authorize() Return url: = [%s]\n",csVal));
               		PutField_CString(hRsp,"return_url_only",csVal);
DEBUGLOG(("Authorize() Return url only: = [%s]\n",csVal));
                }
                else {
               		iRet = INT_ERR;
ERRLOG("TxnWebByUSINQ::Authorize() Unable to find return URL for TWV\n");
                }
	}

	if (iRet == PD_OK) {
		PutField_Char(hRsp,"status",PD_TO_PSP);

DEBUGLOG(("TxnWebByUsINQ Calling [WebMsg]->[FormatMsg]\n"));
	 	MsgObjPtr = CreateObj(MsgPtr,"WebMsg","FormatMsg");
        	h_msg = (hex_t*) malloc (sizeof(hex_t));
        	if ((*MsgObjPtr)(hRsp,h_msg->msg,&h_msg->len) == PD_OK) {
	return 0;
DEBUGLOG(("h_msg->len = [%d]\n",h_msg->len));
			lKey = GetMQKey((unsigned char*)"INQQ");
       	         	msg = (struct msg_t*)malloc(sizeof(struct msg_t)+MAX_MSG_SIZE);
                	msg->mtype  = 1;
                	memset(msg->mtext,0,sizeof(msg->mtext));
                        MQ_build_header((unsigned char*)msg->mtext,
                       		 MQ_RESP,
                        	"WEB",
				0,
				NULL);
                		memcpy(&msg->mtext[MQ_HEADER_LEN],h_msg->msg,h_msg->len);
                		msg->mtext[MQ_HEADER_LEN + h_msg->len] = '\0';
DEBUGLOG(("send len = [%d]\n",MQ_HEADER_LEN + h_msg->len));
                
                	iRet = MQSend(lKey,msg,MQ_HEADER_LEN + h_msg->len);
		}
		FREE_ME(h_msg);
	}

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
	FREE_ME(hRsp);
	FREE_ME(csPtr);
        FREE_ME(csValue);

DEBUGLOG(("TxnWebByUsINQ Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
