/*
Partnerdelight (c)2014. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/01/02              Elvis Wong
Add Relation                                       2015/01/12              Virginia Yun
Add Batch Txn Relation				   2015/01/23		   Elvis Wong
Update User					   2015/02/03		   Elvis Wong
Update Report Date				   2015/03/17		   Elvis Wong
Add batch_sub_type, 
Add is_input_txn and is_regen_txn		   2015/05/15              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsPBF.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnOmtByUsPBF(char    cdebug)
{
        cDebug = cdebug;
}

int  	SetFrTxnRecord(hash_t* hContext,
                        hash_t* hRequest,
			hash_t* hFrContext,
			const double dAmt,
			double dFinalAmt)	
{
	int     iRet = PD_OK;

	int	iDoLogging = 0;

	char    *csTmp = NULL;
	char	cTmp;
	double	dTmp = 0.0;
	
	hash_t      *hTxnDetail;

	hTxnDetail = (hash_t *)malloc(sizeof(hash_t));

// Get Exchange Rate 
	if (iRet == PD_OK) {
		PutField_Double(hFrContext, "org_txn_amt", dFinalAmt);
		PutField_Double(hFrContext, "txn_amt", dFinalAmt);

DEBUGLOG(("SetFrTxnRecord:: Call BOExchange: GetExchangeInfo\n"));
                BOObjPtr = CreateObj(BOPtr, "BOExchange", "GetExchangeInfo");
                iRet = (unsigned long)(*BOObjPtr)(hFrContext, hRequest);
                if (iRet == PD_OK) {

/* dst_txn_ccy */
			if (GetField_CString(hFrContext, "dst_txn_ccy", &csTmp)) {
DEBUGLOG(("SetFrTxnRecord::Call BOExchange:dst_txn_ccy [%s]\n", csTmp));
				PutField_CString(hContext, "dst_txn_ccy", csTmp);
                        }

/* dst_txn_amt */
			if (GetField_Double(hFrContext, "dst_txn_amt", &dFinalAmt)) {
DEBUGLOG(("SetFrTxnRecord::Call BOExchange:dst_txn_amt [%f]\n", dFinalAmt));
				PutField_Double(hContext, "dst_txn_amt", dFinalAmt);
                        }

/* ex_rate */
			if (GetField_Double(hFrContext, "ex_rate", &dTmp)) {
DEBUGLOG(("SetFrTxnRecord::Call BOExchange:ex_rate [%f]\n", dTmp));
				PutField_Double(hContext, "ex_rate", dTmp);
                        }

/* ex_party */
			if (GetField_Char(hFrContext, "ex_party", &cTmp)) {
DEBUGLOG(("SetFrTxnRecord::Call BOExchange:ex_party [%c]\n", cTmp));	
				PutField_Char(hContext, "ex_party", cTmp);
                        }

 		} else {
DEBUGLOG(("SetFrTxnRecord:: Call: BOExchange.GetExchangeInfo failed, return = [%d]\n", iRet));
ERRLOG("TxnOmtByUsPBF::SetFrTxnRecord:: Call: BOExchange.GetExhcnageInfo failed, return = [%d]\n", iRet);
                }
        }		

// Update Balance
	if (iRet == PD_OK) {
		PutField_Char(hFrContext, "party_type", PD_TYPE_PSP);
		PutField_Int(hFrContext, "balance_transfer", PD_TRUE);
                PutField_CString(hFrContext, "pool", PD_ACCT_BAL_POOL);
                PutField_Char(hFrContext, "amt_type", PD_IND_DEBIT);
                PutField_CString(hFrContext, "amount_type", PD_DR);
		
		PutField_Double(hFrContext, "txn_amt", dFinalAmt);

DEBUGLOG(("SetFrTxnRecord::Call BOOLBalance:UpdateAmount\n"));
                BOObjPtr = CreateObj(BOPtr,"BOOLBalance","UpdateAmount");
                iRet = (unsigned long)(*BOObjPtr)(hFrContext);
                if (iRet == PD_OK) {

/* open_bal */
                        if (GetField_CString(hFrContext, "open_bal", &dTmp)) {
DEBUGLOG(("SetFrTxnRecord::Call BOOLBalance:open_bal [%f]\n", dTmp));
                        }

/* open_in_transit */
                        if (GetField_CString(hFrContext, "open_in_transit", &dTmp)) {
DEBUGLOG(("SetFrTxnRecord::Call BOOLBalance:open_in_transit [%f]\n", dTmp));
                        }

/* approval_date */
                        if (GetField_CString(hFrContext, "approval_date", &csTmp)) {
DEBUGLOG(("SetFrTxnRecord::Call BOOLBalance:approval_date [%s]\n", csTmp));
                        }

/* approval_timestamp */
                        if (GetField_CString(hFrContext, "approval_timestamp", &csTmp))  {
DEBUGLOG(("SetFrTxnRecord::Call BOOLBalance:approval_timestamp [%s]\n", csTmp));
                        }

/* bal */
                        if (GetField_Double(hFrContext, "bal", &dTmp)) {
DEBUGLOG(("SetFrTxnRecord::Call BOOLBalance:balance = [%f]\n", dTmp));
                        }

/* total_hold */
                        if (GetField_Double(hFrContext, "total_hold", &dTmp)) {
DEBUGLOG(("SetFrTxnRecord::Call BOOLBalance:total_hold = [%f]\n", dTmp));
                        }

/* prepaid */
                        if (GetField_Double(hFrContext, "prepaid", &dTmp)) {
DEBUGLOG(("SetFrTxnRecord::Call BOOLBalance:prepaid = [%f]\n", dTmp));
                        }

/* in_transit */
                        if (GetField_Double(hFrContext, "in_transit", &dTmp)) {
DEBUGLOG(("SetFrTxnRecord::Call BOOLBalance:in_transit = [%f]\n", dTmp));
                        }

                }
        }

// Add/Update Txn Header and Detail	
	if (iRet == PD_OK) {

/* do_logging */
		if (GetField_Int(hContext, "do_logging", &iDoLogging)) {
DEBUGLOG(("SetFrTxnRecord::do_logging = [%d]\n", iDoLogging));
               
			PutField_Char(hFrContext, "recon_status", PD_UNRECONCILED);
			PutField_Double(hFrContext, "txn_amt", dAmt);
	
                	if(iDoLogging==PD_ADD_LOG) {
DEBUGLOG(("SetFrTxnRecord::Call DBOLTransaction:AddDetail\n"));
                        	DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","AddDetail");
                        	iRet = (unsigned long)(*DBObjPtr)(hFrContext);
                        	if(iRet == PD_OK) {

                                	hash_init(hTxnDetail, 0);

/* txn_seq */
                                	if (GetField_CString(hFrContext, "txn_seq", &csTmp)) {
                                        	PutField_CString(hTxnDetail, "txn_seq", csTmp);
                                	}

/* txn_country */
                                	if (GetField_CString(hFrContext, "txn_country", &csTmp)) {
                                        	PutField_CString(hTxnDetail, "txn_country", csTmp);
                                	}

/* update_user */
                                	if (GetField_CString(hFrContext, "update_user", &csTmp)) {
                                        	PutField_CString(hTxnDetail, "update_user", csTmp);
                                	}

DEBUGLOG(("SetFrTxnRecord::Call DBTransaction:UpdateDetail\n"));
                                	DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","UpdateDetail");
                                	if((unsigned long) ((*DBObjPtr)(hTxnDetail)) != PD_OK) {
                                        	iRet = INT_ERR;
                                	}

                                	hash_destroy(hTxnDetail);

                        	} else {
                                	iRet = INT_ERR;
                        	}
                	}
		}
        }

// Add Txn PSP Detail
	if (iRet == PD_OK) {

/* PHDATE */
                if (GetField_CString(hContext, "PHDATE", &csTmp)) {
DEBUGLOG(("SetFrTxnRecord:: PHDATE = [%s]\n", csTmp));
                        PutField_CString(hFrContext, "txn_date", csTmp);
                }

                PutField_CString(hFrContext, "desc", "BAID Balance Transfer From");
		PutField_Double(hFrContext, "txn_amount", dFinalAmt);

		if (GetField_CString(hFrContext, "fr_bank_code", &csTmp)) {
			PutField_CString(hFrContext, "bank_code", csTmp);
		}
		if (GetField_CString(hFrContext, "fr_bank_acct_num", &csTmp)) {
			PutField_CString(hFrContext, "bank_acct_num", csTmp);
		}

DEBUGLOG(("SetFrTxnRecord:: Call DBOLTxnPspDetail: Add\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Add");
                if ((unsigned long)(*DBObjPtr)(hFrContext) != PD_OK) {
                        iRet = INT_ERR;
                }
        }

// Update Txn PSP Detail
	if (iRet == PD_OK) {
		PutField_Double(hFrContext, "txn_amount", dFinalAmt);

DEBUGLOG(("SetFrTxnRecord:: Call DBOLTxnPspDetail: Update\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Update");
                if ((unsigned long)(*DBObjPtr)(hFrContext) != PD_OK) {
                        iRet = INT_ERR;
                }
        }

// Add Txn Elements
	if (iRet == PD_OK) {
		PutField_Double(hFrContext, "org_txn_amt", dFinalAmt);

DEBUGLOG(("SetFrTxnRecord:: Call BOOLTxnElements: AddTxnAmtElement\n"));
                BOObjPtr = CreateObj(BOPtr, "BOOLTxnElements", "AddTxnAmtElement");
                if ((unsigned long)(*BOObjPtr)(hFrContext) != PD_OK) {
                        iRet = INT_ERR;
                }
        } 

       	FREE_ME(hTxnDetail);

	return iRet;
}

int     SetToTxnRecord(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hToContext,
			hash_t* hToReq,
			const double dAmt,
                        double dFinalAmt)
{
	int     iRet = PD_OK;

        int     iDoLogging = 0;

        char    *csTmp = NULL;
        char	cTmp;
	double  dTmp = 0.0;

	char    csToTxnSeq[PD_TXN_SEQ_LEN + 1];

        hash_t 	*hTxnDetail;

        hTxnDetail = (hash_t *)malloc(sizeof(hash_t));

// Generate Next Txn Seq
	if (iRet == PD_OK) {
DEBUGLOG(("SetToTxnRecord:: Call DBOLTxnSeq: GetNextOmtTxnSeq\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextOmtTxnSeq");
                strcpy((char*)csToTxnSeq, (*DBObjPtr)());
		
		PutField_CString(hToContext, "txn_seq", (const char *)csToTxnSeq);
                PutField_CString(hToContext, "from_txn_seq", (const char *)csToTxnSeq);
                //PutField_CString(hToContext, "org_txn_seq", (const char *)csToTxnSeq);

                PutField_Int(hToContext, "db_commit", PD_FALSE);
        }	

// Update OMT Channel Context
	if (iRet == PD_OK) {

/* local_tm_date */
                if (GetField_CString(hContext,"local_tm_date",&csTmp)) {
                        PutField_CString(hToContext,"local_tm_date",csTmp);
                }

/* local_tm_time */
                if (GetField_CString(hContext,"local_tm_time",&csTmp)) {
                        PutField_CString(hToContext,"local_tm_time",csTmp);
                }

/* host_posting_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
                        PutField_CString(hToContext,"PHDATE",csTmp);
                }

/* add_user */
                if (GetField_CString(hRequest, "add_user", &csTmp)) {
                        PutField_CString(hToContext,"add_user",csTmp);
                }

                PutField_CString(hToContext,"channel_code",PD_CHANNEL_OMT);
                PutField_CString(hToContext,"process_code",PD_PROCESS_CODE_DEF);
                PutField_CString(hToContext,"process_type",PD_PROCESS_TYPE_DEF);

/* Update Context */
DEBUGLOG(("SetToTxnRecord:: Call OMTChannel: UpdateContext\n"));
                ChannelObjPtr = CreateObj(ChannelPtr,"OMTChannel","UpdateContext");
                iRet = (unsigned long)(*ChannelObjPtr)(hToContext);		

	}

// Add Txn Log
	if (iRet == PD_OK) {

/* ip_addr */
                if (GetField_CString(hRequest,"ip_addr",&csTmp)) {
                        PutField_CString(hToReq,"ip_addr",csTmp);
                }

/* txn_ccy */
		if (GetField_CString(hToContext, "txn_ccy", &csTmp)) {
                        PutField_CString(hToReq, "txn_ccy", csTmp);
                }

/* txn_country */
                if (GetField_CString(hToContext, "txn_country", &csTmp)) {
                        PutField_CString(hToReq, "txn_country", csTmp);
                }

/* do_logging */
                if(GetField_Int(hContext,"do_logging",&iDoLogging)){
                        PutField_Int(hToContext, "do_logging", iDoLogging);
                }

DEBUGLOG(("SetToTxnRecord: Call OMTChannel: AddTxnLog\n"));
                ChannelObjPtr = CreateObj(ChannelPtr,"OMTChannel","AddTxnLog");
                iRet = (unsigned long)(*ChannelObjPtr)(hToContext,hToReq);	
	}

// Get Exchange Rate
	if (iRet == PD_OK) {
		PutField_Double(hToContext, "org_txn_amt", dFinalAmt);
		PutField_Double(hToContext, "txn_amt", dFinalAmt);

DEBUGLOG(("SetToTxnRecord:: Call BOExchange: GetExchangeInfo\n"));
                BOObjPtr = CreateObj(BOPtr, "BOExchange", "GetExchangeInfo");
                iRet = (unsigned long)(*BOObjPtr)(hToContext, hRequest);
                if (iRet == PD_OK) {

/* dst_txn_ccy */
                        if (GetField_CString(hToContext, "dst_txn_ccy", &csTmp)) {
DEBUGLOG(("SetToTxnRecord::Call BOExchange:dst_txn_ccy [%s]\n", csTmp));
                        }

/* dst_txn_amt */
                        if (GetField_Double(hToContext, "dst_txn_amt", &dFinalAmt)) {
DEBUGLOG(("SetToTxnRecord::Call BOExchange:dst_txn_amt [%f]\n", dFinalAmt));
                        }

/* ex_rate */
                        if (GetField_Double(hToContext, "ex_rate", &dTmp)) {
DEBUGLOG(("SetToTxnRecord::Call BOExchange:ex_rate [%f]\n", dTmp));
                        }

/* ex_party */
                        if (GetField_Char(hToContext, "ex_party", &cTmp)) {
DEBUGLOG(("SetToTxnRecord::Call BOExchange:ex_party [%c]\n", cTmp));
                        }

                } else {
DEBUGLOG(("SetToTxnRecord:: Call: BOExchange.GetExchangeInfo failed, return = [%d]\n", iRet));
ERRLOG("TxnOmtByUsPBF::SetFrTxnRecord:: Call: BOExchange.GetExhcnageInfo failed, return = [%d]\n", iRet);
                }
        }

// Update Balance
	if (iRet == PD_OK) {
		PutField_Char(hToContext, "party_type", PD_TYPE_PSP);
                PutField_Int(hToContext, "balance_transfer", PD_TRUE);
		PutField_CString(hToContext, "pool", PD_ACCT_BAL_POOL);
		PutField_Char(hToContext, "amt_type", PD_IND_CREDIT);
                PutField_CString(hToContext, "amount_type", PD_CR);
	
		PutField_Double(hToContext, "txn_amt", dFinalAmt);

DEBUGLOG(("SetToTxnRecord::Call BOOLBalance:UpdateAmount\n"));
                BOObjPtr = CreateObj(BOPtr,"BOOLBalance","UpdateAmount");
                iRet = (unsigned long)(*BOObjPtr)(hToContext);
                if (iRet == PD_OK) {

/* open_bal */
                        if (GetField_CString(hToContext, "open_bal", &dTmp)) {
DEBUGLOG(("SetToTxnRecord::Call BOOLBalance:open_bal [%f]\n", dTmp));
                        }

/* open_in_transit */
                        if (GetField_CString(hToContext, "open_in_transit", &dTmp)) {
DEBUGLOG(("SetToTxnRecord::Call BOOLBalance:open_in_transit [%f]\n", dTmp));
                        }

/* approval_date */
                        if (GetField_CString(hToContext, "approval_date", &csTmp)) {
DEBUGLOG(("SetToTxnRecord::Call BOOLBalance:approval_date [%s]\n", csTmp));
                        }

/* approval_timestamp */
                        if (GetField_CString(hToContext, "approval_timestamp", &csTmp))  {
DEBUGLOG(("SetToTxnRecord::Call BOOLBalance:approval_timestamp [%s]\n", csTmp));
                        }

/* bal */
                        if (GetField_Double(hToContext, "bal", &dTmp)) {
DEBUGLOG(("SetToTxnRecord::Call BOOLBalance:balance = [%f]\n", dTmp));
                        }

/* total_hold */
                        if (GetField_Double(hToContext, "total_hold", &dTmp)) {
DEBUGLOG(("SetToTxnRecord::Call BOOLBalance:total_hold = [%f]\n", dTmp));
                        }

/* prepaid */
                        if (GetField_Double(hToContext, "prepaid", &dTmp)) {
DEBUGLOG(("SetToTxnRecord::Call BOOLBalance:prepaid = [%f]\n", dTmp));
                        }

/* in_transit */
                        if (GetField_Double(hToContext, "in_transit", &dTmp)) {
DEBUGLOG(("SetToTxnRecord::Call BOOLBalance:in_transit = [%f]\n", dTmp));
                        }

                }
	}

// Add/Update Txn Header and Detail
	if (iRet == PD_OK) {

/* do_logging */
		if (GetField_Int(hToContext, "do_logging", &iDoLogging)) {
DEBUGLOG(("SetToTxnRecord:: do_logging [%d]\n", iDoLogging));
              		if (iDoLogging == PD_ADD_LOG) {

                             	PutField_Char(hToContext, "status", PD_COMPLETE);
                              	PutField_Char(hToContext, "ar_ind", PD_ACCEPT);
                            	PutField_CString(hToContext, "sub_status", PD_APPROVED);
				PutField_Char(hToContext, "recon_status", PD_UNRECONCILED);
			
				PutField_Double(hToContext, "txn_amt", dAmt);

                              	if (iRet == PD_OK) {
DEBUGLOG(("SetToTxnRecord:: Call DBOLTransaction: AddDetail\n"));
                               		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "AddDetail");
                                   	if ((unsigned long)(*DBObjPtr)(hToContext) != PD_OK) {
                                        	iRet = INT_ERR;
                                       	}
				}
					
                          	if (iRet == PD_OK) {
					
					// To prevent update current bal and total_hold
					hash_init(hTxnDetail, 0);

/* txn_seq */ 
                                     	if (GetField_CString(hToContext, "txn_seq", &csTmp)) {
                                        	PutField_CString(hTxnDetail, "txn_seq", csTmp);
                                     	}

/* txn_country */
                                 	if (GetField_CString(hToContext, "txn_country", &csTmp)) {
                                          	PutField_CString(hTxnDetail, "txn_country", csTmp);
                                      	}

/* update_user */
                                   	if (GetField_CString(hToContext, "update_user", &csTmp)) {
                                         	PutField_CString(hTxnDetail, "update_user", csTmp);
                                   	}

DEBUGLOG(("SetToTxnRecord:: Call DBOLTransaction: UpdateDetail\n"));
                                       	DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "UpdateDetail");
                                     	if ((unsigned long)(*DBObjPtr)(hTxnDetail) != PD_OK) {
                                           	iRet = INT_ERR;
                                    	}

                                     	hash_destroy(hTxnDetail);
				}			
			}
		}
	}

// Add Txn PSP Detail
	if (iRet == PD_OK) {

/* PHDATE */
            	if (GetField_CString(hContext, "PHDATE", &csTmp)) {
DEBUGLOG(("SetToTxnRecord:: PHDATE = [%s]\n", csTmp));
                    	PutField_CString(hToContext, "txn_date", csTmp);
             	}

            	PutField_CString(hToContext, "desc", "BAID Balance Transfer To");
		PutField_Double(hToContext, "txn_amount", dFinalAmt);

		if (GetField_CString(hToContext, "to_bank_code", &csTmp)) {
			PutField_CString(hToContext, "bank_code", csTmp);
		}
		if (GetField_CString(hToContext, "to_bank_acct_num", &csTmp)) {
			PutField_CString(hToContext, "bank_acct_num", csTmp);
		}

DEBUGLOG(("SetToTxnRecord:: Call DBOLTxnPspDetail: Add\n"));
               	DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Add");
             	if ((unsigned long)(*DBObjPtr)(hToContext) != PD_OK) {
                  	iRet = INT_ERR;
               	}
	}

// Update Txn PSP Detail	
	if (iRet == PD_OK) {
		PutField_Double(hToContext, "txn_amount", dFinalAmt);

DEBUGLOG(("SetToTxnRecord:: Call DBOLTxnPspDetail: Update\n"));
              	DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Update");
            	if ((unsigned long)(*DBObjPtr)(hToContext) != PD_OK) {
                    	iRet = INT_ERR;
              	}	
	}

// Add Txn Elements
	if (iRet == PD_OK) {
		PutField_Double(hToContext, "org_txn_amt", dFinalAmt);

DEBUGLOG(("SetToTxnRecord:: Call BOOLTxnElements: AddTxnAmtElement\n"));
            	BOObjPtr = CreateObj(BOPtr, "BOOLTxnElements", "AddTxnAmtElement");
            	if ((unsigned long)(*BOObjPtr)(hToContext) != PD_OK) {
                 	iRet = INT_ERR;
            	}
	}

        FREE_ME(hTxnDetail);

	return iRet;	
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;

        char    *csUser = NULL;
	char	*csFrBaid = NULL;
	char	*csToBaid = NULL;
	char    *csFrBaidCategory = NULL;
        char    *csToBaidCategory = NULL;
	char    *csFrPspId = NULL;
        char    *csToPspId = NULL;
	char    *csFrPspAcctType = NULL;
        char    *csToPspAcctType = NULL;
	char    *csFrTxnCountry=strdup("");
	char    *csToTxnCountry=strdup("");
	char	*csTxnCcy = NULL;
	char	*csFrTxnSeq= NULL;
	char	*csToTxnSeq= NULL;
	char	*csFrTxnCode= NULL;
	char	*csToTxnCode= NULL;
	double	dAmt = 0.0;
	double	dFinalAmt = 0.0;
	int	iGenUniqueAmt = 0;	
	int	iAllowFeInit = 0;	
	int     iInternalErr = 0;
	
	char	*csTmp = NULL;
	int	iTmp = 0;

	char    csBatchSeq[PD_TXN_SEQ_LEN + 1];
		
	hash_t      *hFrContext;
        hash_t      *hToContext;

	hash_t      *hToReq;
	
	hash_t 	    *hRec;
	hash_t 	    *hRelation;

        hFrContext = (hash_t *)malloc(sizeof(hash_t));
        hash_init(hFrContext, 0);

        hToContext = (hash_t *)malloc(sizeof(hash_t));
        hash_init(hToContext, 0);

	hToReq = (hash_t *)malloc(sizeof(hash_t));
        hash_init(hToReq, 0);

        hRec = (hash_t *) malloc (sizeof(hash_t));
        hRelation = (hash_t *) malloc (sizeof(hash_t));

/* txn_seq */
	if(GetField_CString(hContext,"txn_seq",&csFrTxnSeq)){
DEBUGLOG(("Authorize::txn_seq= [%s]\n",csFrTxnSeq));
            	PutField_CString(hFrContext, "txn_seq", csFrTxnSeq);
            	PutField_CString(hFrContext, "from_txn_seq", csFrTxnSeq);
            	PutField_CString(hFrContext, "org_txn_seq", csFrTxnSeq);
            	
		PutField_CString(hToContext, "org_txn_seq", csFrTxnSeq);
     	}
	else{
DEBUGLOG(("Authorize::txn_seq not found!!\n"));
ERRLOG("TxnOmtByUsPBF::Authorize::txn_seq not found!!\n");
                iRet=INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* fr_baid */
	if(GetField_CString(hRequest,"fr_baid",&csFrBaid)){
DEBUGLOG(("Authorize::fr_baid= [%s]\n",csFrBaid));
		PutField_CString(hFrContext,"baid",csFrBaid);
	}
	else{
DEBUGLOG(("Authorize::fr_baid not found!!\n"));
ERRLOG("TxnOmtByUsPBF::Authorize::fr_baid not found!!\n");
		iRet=INT_INVALID_BAID;
		PutField_Int(hContext,"internal_error",iRet);
	}

/* to_baid */
        if(GetField_CString(hRequest,"to_baid",&csToBaid)){
DEBUGLOG(("Authorize::to_baid= [%s]\n",csToBaid));
                PutField_CString(hToContext,"baid",csToBaid);
        }
        else{
DEBUGLOG(("Authorize::to_baid not found!!\n"));
ERRLOG("TxnOmtByUsPBF::Authorize::to_baid not found!!\n");
                iRet=INT_INVALID_BAID;
                PutField_Int(hContext,"internal_error",iRet);
        }

	if (iRet == PD_OK) {
                hash_init(hRec, 0);
DEBUGLOG(("Authorize:: Call DBOLBankAcctId: GetBankAcctIdDtl (from)\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetBankAcctIdDtl");
                if ((unsigned long)(*DBObjPtr)(csFrBaid, hRec) != PD_OK) {
DEBUGLOG(("Authorize:: Call DBOLBankAcctId: GetBankAcctIdDtl (from) failed!!\n"));
ERRLOG("TxnOmtByUsPBF:: Authorize:: Call DBOLBankAcctId: GetBankAcctIdDtl (from) failed!!\n");
                        iRet = INT_ERR;
                        PutField_Int(hContext, "internal_error", iRet);
                } else {

/* fr_category */
  			if (GetField_CString(hRec,"category",&csFrBaidCategory)) {
DEBUGLOG(("Authorize::baid_category (from) = [%s]\n",csFrBaidCategory));
				PutField_CString(hFrContext, "category", csFrBaidCategory);
  			}

/* fr_psp_id */ 
                        if (GetField_CString(hRec, "psp_id", &csFrPspId)) {
DEBUGLOG(("Authorize:: psp_id (from) = [%s]\n", csFrPspId));
                                PutField_CString(hFrContext, "psp_id", csFrPspId);
                        } else {
DEBUGLOG(("Authorize:: psp_id (from) not found!!\n"));
ERRLOG("TxnOmtByUsPBF:: Authorize:: psp_id (from) not found!!\n");
                                iRet = INT_PSP_ID_NOT_FOUND;
                                PutField_Int(hContext, "internal_error", iRet);
                        }

/* fr_baid_status */
                        if (GetField_CString(hRec, "baid_status", &csTmp)) {
				// check baid_status_open
				if (strcmp(csTmp, PD_BAID_STATUS_OPEN)) {
DEBUGLOG(("Authorize::baid status (from) is not open !!\n"));
ERRLOG("TxnOmtByUsPBF::Authorize::baid status (from) is not open!!\n");
                                        iRet=INT_INVALID_BAID;
                                        PutField_Int(hContext,"internal_error",iRet);
                                }
                        }

			if (GetField_CString(hRec, "int_bank_code", &csTmp)) {
DEBUGLOG(("Authorize:: bank_code (from) = [%s]\n", csTmp));
				PutField_CString(hFrContext, "fr_bank_code", csTmp);
			}
			if (GetField_CString(hRec, "bank_acct_num", &csTmp)) {
DEBUGLOG(("Authorize:: bank acct num (from) = [%s]\n", csTmp));
				PutField_CString(hFrContext, "fr_bank_acct_num", csTmp);
			}

                }
                hash_destroy(hRec);
        }

	if (iRet == PD_OK) {
                hash_init(hRec, 0);
DEBUGLOG(("Authorize:: Call DBOLBankAcctId: GetBankAcctIdDtl (to)\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetBankAcctIdDtl");
                if ((unsigned long)(*DBObjPtr)(csToBaid, hRec) != PD_OK) {
DEBUGLOG(("Authorize:: Call DBOLBankAcctId: GetBankAcctIdDtl (to) failed!!\n"));
ERRLOG("TxnOmtByUsPBF:: Authorize:: Call DBOLBankAcctId: GetBankAcctIdDtl (to) failed!!\n");
                        iRet = INT_ERR;
                        PutField_Int(hContext, "internal_error", iRet);
                } else {

/* to_category */
                        if (GetField_CString(hRec,"category",&csToBaidCategory)) {
DEBUGLOG(("Authorize::baid_category (to) = [%s]\n",csToBaidCategory));
				PutField_CString(hToContext, "category", csToBaidCategory);
                        }

/* to_psp_id */
                        if (GetField_CString(hRec, "psp_id", &csToPspId)) {
DEBUGLOG(("Authorize:: psp_id (to) = [%s]\n", csToPspId));
                                PutField_CString(hToContext, "psp_id", csToPspId);
                        } else {
DEBUGLOG(("Authorize:: psp_id (to) not found!!\n"));
ERRLOG("TxnOmtByUsPBF:: Authorize:: psp_id (to) not found!!\n");
                                iRet = INT_PSP_ID_NOT_FOUND;
                                PutField_Int(hContext, "internal_error", iRet);
                        }

/* to_baid_status */
                        if (GetField_CString(hRec, "baid_status", &csTmp)) {
				// check baid_status_open
				if (strcmp(csTmp, PD_BAID_STATUS_OPEN)) {
DEBUGLOG(("Authorize::baid status (to) is not open !!\n"));
ERRLOG("TxnOmtByUsPBF::Authorize::baid status (to) is not open!!\n");
                                        iRet=INT_INVALID_BAID;
                                        PutField_Int(hContext,"internal_error",iRet);
                                }
                        }

			if (GetField_CString(hRec, "int_bank_code", &csTmp)) {
DEBUGLOG(("Authorize:: bank_code (to) = [%s]\n", csTmp));
				PutField_CString(hToContext, "to_bank_code", csTmp);
			}
			if (GetField_CString(hRec, "bank_acct_num", &csTmp)) {
DEBUGLOG(("Authorize:: bank acct num (to) = [%s]\n", csTmp));
				PutField_CString(hToContext, "to_bank_acct_num", csTmp);
			}
                }
                hash_destroy(hRec);
        }

/* fr_txn_country */
	if(GetField_CString(hRequest,"txn_country",&csFrTxnCountry)){
DEBUGLOG(("Authorize::txn_country(from)= [%s]\n",csFrTxnCountry));
		PutField_CString(hFrContext,"txn_country",csFrTxnCountry);
	}
	else{
DEBUGLOG(("Authorize:: Call DBOLBankAcctId: GetBankAcctIdCountry\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetBankAcctIdCountry");
                if ((unsigned long)(*DBObjPtr)(csFrBaid, csFrTxnCountry) == FOUND) {
DEBUGLOG(("Authorize:: txn_country(from) by baid = [%s]\n", csFrTxnCountry));
                        PutField_CString(hRequest, "txn_country", csFrTxnCountry);
                        PutField_CString(hFrContext, "txn_country", csFrTxnCountry);
                } else {
DEBUGLOG(("Authorize:: txn_country(from) not found!!\n"));
ERRLOG("TxnOmtByUsPBF:: Authorize:: txn_country(from) not found!!\n");
                        iRet = INT_COUNTRY_PSP_NOT_AVABILE;
                        PutField_Int(hContext, "internal_error", iRet);
                }
	}

/* to_txn_country */	
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: Call DBOLBankAcctId: GetBankAcctIdCountry\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetBankAcctIdCountry");
                if ((unsigned long)(*DBObjPtr)(csToBaid, csToTxnCountry) == FOUND) {
DEBUGLOG(("Authorize:: txn_country(to) by baid = [%s]\n", csToTxnCountry));
                        PutField_CString(hToContext, "txn_country", csToTxnCountry);
                } else {
DEBUGLOG(("Authorize:: txn_country(to) not found!!\n"));
ERRLOG("TxnOmtByUsPBF:: Authorize:: txn_country(to) not found!!\n");
                        iRet = INT_COUNTRY_PSP_NOT_AVABILE;
			PutField_Int(hContext, "internal_error", iRet);
                  }
	}		

	if (iRet == PD_OK) {
		// check differency between fr_txn_country and to_txn_country
                if (strcmp(csFrTxnCountry, csToTxnCountry)) {
                        iRet = INT_INVALID_TXN;
DEBUGLOG(("Authorize::() difference country not allow\n"));
ERRLOG("TxnOmtByUsPBF:: Authorize() difference country not allow\n");
                        PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* txn_ccy */
        if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTxnCcy));
                PutField_CString(hContext,"txn_ccy",csTxnCcy);
                PutField_CString(hContext,"net_ccy",csTxnCcy);
                PutField_CString(hContext,"org_txn_ccy",csTxnCcy);
                PutField_CString(hContext,"dst_txn_ccy",csTxnCcy);

		PutField_CString(hFrContext,"txn_ccy",csTxnCcy);
                PutField_CString(hFrContext,"net_ccy",csTxnCcy);
                PutField_CString(hFrContext,"org_txn_ccy",csTxnCcy);
                PutField_CString(hFrContext,"dst_txn_ccy",csTxnCcy);

		PutField_CString(hToContext,"txn_ccy",csTxnCcy);
                PutField_CString(hToContext,"net_ccy",csTxnCcy);
                PutField_CString(hToContext,"org_txn_ccy",csTxnCcy);
                PutField_CString(hToContext,"dst_txn_ccy",csTxnCcy);
        }
        else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnOmtByUsPBF::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_amt */
	if(GetField_Double(hContext,"txn_amt",&dAmt)){
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dAmt));
		PutField_Double(hContext, "org_txn_amt", dAmt);
		PutField_Double(hContext, "txn_amt", dAmt);
		PutField_Double(hContext, "net_amt", dAmt);
		PutField_Double(hContext, "txn_amount", dAmt);
		PutField_Double(hContext, "display_amt", dAmt);
		
                PutField_Double(hFrContext, "org_txn_amt", dAmt);
		PutField_Double(hFrContext, "txn_amt", dAmt);
		PutField_Double(hFrContext, "net_amt", dAmt);
                PutField_Double(hFrContext, "txn_amount", dAmt);
                PutField_Double(hFrContext, "display_amt", dAmt);
		
		PutField_Double(hToContext, "org_txn_amt", dAmt);
                PutField_Double(hToContext, "txn_amt", dAmt);
                PutField_Double(hToContext, "org_txn_amt", dAmt);
		PutField_Double(hToContext, "txn_amount", dAmt);
		PutField_Double(hToContext, "display_amt", dAmt);
	}
	else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnOmtByUsPBF::Authorize::txn_amt not found!!\n");
		iRet=INT_PAY_AMOUNT_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

/* gen_unique_amt */
	if(GetField_CString(hRequest,"gen_unique_amt",&csTmp)){
		iGenUniqueAmt = atoi(csTmp);
DEBUGLOG(("Authorize::gen_unique_amt= [%d]\n",iGenUniqueAmt));
	}
	else {
DEBUGLOG(("Authorize::gen_unique_amt not found!\n"));
ERRLOG("TxnOmtByUsPBF""Authorize::gen_unique_amt not found!\n");
            	iRet = INT_INVALID_TXN;
               	PutField_Int(hContext, "internal_error", iRet);
	}

/* report_date */
        if(!GetField_CString(hRequest,"report_date",&csTmp)){
DEBUGLOG(("Authorize::report_date not found!!\n"));
//ERRLOG("TxnOmtByUsPBF::Authorize::report_date not found!!\n");

/* PHDATE */
/*
                if(GetField_CString(hContext,"PHDATE",&csTmp)){
                        PutField_CString(hFrContext, "report_date", csTmp);
                        PutField_CString(hToContext, "report_date", csTmp);
DEBUGLOG(("Authorize::report_date (PH date) = [%s]\n", csTmp));
                }
*/
        }
        else {
                PutField_CString(hFrContext, "report_date", csTmp);
                PutField_CString(hToContext, "report_date", csTmp);
DEBUGLOG(("Authorize::report_date = [%s]\n", csTmp));
        }

/* fr_remark */
        if(GetField_CString(hRequest,"fr_remark",&csTmp)){
DEBUGLOG(("Authorize::fr_remark = [%s]\n", csTmp));
		PutField_CString(hFrContext, "remark", csTmp);
	}

/* to_remark */
        if(GetField_CString(hRequest,"to_remark",&csTmp)){
DEBUGLOG(("Authorize::to_remark = [%s]\n", csTmp));
                PutField_CString(hToContext, "remark", csTmp);
        }

/* do_logging */
	if(GetField_Int(hContext,"do_logging",&iTmp)){
DEBUGLOG(("Authorize::do_logging [%d]\n", iTmp));
	}

/* add_user */
        if(GetField_CString(hRequest,"add_user",&csUser)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csUser));
		PutField_CString(hContext, "user", csUser);
                PutField_CString(hFrContext, "user", csUser);
                PutField_CString(hToContext, "user", csUser);

		PutField_CString(hContext, "create_user", csUser);
                PutField_CString(hFrContext, "create_user", csUser);
                PutField_CString(hToContext, "create_user", csUser);

		PutField_CString(hContext, "add_user", csUser);
		PutField_CString(hFrContext, "add_user", csUser);
                PutField_CString(hToContext, "add_user", csUser);

                PutField_CString(hContext,"update_user",csUser);
                PutField_CString(hFrContext,"update_user",csUser);
                PutField_CString(hToContext,"update_user",csUser);
        }

// Get Bank Acct Type (from)
	if (iRet == PD_OK) {
        	hash_init(hRec,0);

DEBUGLOG(("Authorize:: Call DBOLPspDetail:GetPspDetail (from)\n"));
        	DBObjPtr = CreateObj(DBPtr, "DBOLPspDetail","GetPspDetail");
        	iRet = (unsigned long)(*DBObjPtr)(csFrPspId,hRec);
        	if (iRet == PD_OK) {

/* bank_acct_type */
                	if (GetField_CString(hRec,"bank_acct_type",&csFrPspAcctType)) {
DEBUGLOG(("Authorize:: DBOLPspDetail:GetPspDetail bank_acct_type (from) = [%s]\n",csFrPspAcctType));
                	}

        	} else {
                	iRet = INT_ERR;
                	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: DBOLPspDetail:GetPspDetail (from) FAILED\n"));
ERRLOG("TxnOmtByUsPBF::Authorize:: DBOLPspDetail:GetPspDetail (from) FAILED\n");
		}
		
		hash_destroy(hRec);
        }

// Get Bank Acct Type (to) 
	if (iRet == PD_OK) {
                hash_init(hRec,0);

DEBUGLOG(("Authorize:: Call DBOLPspDetail:GetPspDetail (to)\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLPspDetail","GetPspDetail");
                iRet = (unsigned long)(*DBObjPtr)(csToPspId,hRec);
                if (iRet == PD_OK) {

/* bank_acct_type */
                        if (GetField_CString(hRec,"bank_acct_type",&csToPspAcctType)) {
DEBUGLOG(("Authorize:: DBOLPspDetail:GetPspDetail bank_acct_type (to) = [%s]\n",csToPspAcctType));
                        }

                } else {
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: DBOLPspDetail:GetPspDetail (to) FAILED\n"));
ERRLOG("TxnOmtByUsPBF::Authorize:: DBOLPspDetail:GetPspDetail (to) FAILED\n");
                }

                hash_destroy(hRec);
        }

// Check Allow Fe Init and Get Txn Code (from)
	if (iRet == PD_OK) {
                hash_init(hRec,0);

                PutField_CString(hRec,"bal_trf_type",PD_BAL_TRF_TYPE_SAME_PLATF);
                PutField_CString(hRec,"from_acct_type",csFrPspAcctType);
                PutField_CString(hRec,"to_acct_type",csToPspAcctType);
                PutField_CString(hRec,"bal_trf_txn_code_type",PD_BAL_TRF_TC_TYPE_SWEEP_OUT);
                PutField_CString(hRec,"to_baid_category",csToBaidCategory);

DEBUGLOG(("Authorize:: Call DBOLTcBalTrfMap:GetBalTransferTxnCode\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTcBalTrfMap", "GetBalTransferTxnCode");
                if ((unsigned long)(*DBObjPtr)(hRec) == PD_FOUND) {

/* allow_fe_init */
                        if (GetField_Int(hRec,"allow_fe_init",&iAllowFeInit)) {
DEBUGLOG(("Authorize::DBOLTcBalTrfMap::GetBalTransferTxnCode allow_fe_init = [%d]\n",iAllowFeInit));

				// Check Allow FE Init
                                if (iAllowFeInit == 0) {
DEBUGLOG(("Authorize::DBOLTcBalTrfMap::GetBalTransferTxnCode NOT ALLOW FE INIT!!\n"));
ERRLOG("TxnOmtByUsPBF::Authorize::DBOLTcBalTrfMap::GetBalTransferTxnCode NOT ALLOW FE INIT!!\n");
                                        iRet = INT_ERR;
                                        PutField_Int(hContext,"internal_error",iRet);
                                }
                        }

/* map_txn_code */
                        if (GetField_CString(hRec,"map_txn_code",&csFrTxnCode)) {
DEBUGLOG(("Authorize::DBOLTcBalTrfaMap:GetBalTransferTxnCode map_txn_code = [%s]\n",csFrTxnCode));
                                PutField_CString(hFrContext,"txn_code",csFrTxnCode);
				PutField_CString(hFrContext,"new_txn_code",csFrTxnCode);

				PutField_CString(hContext,"new_txn_code",csFrTxnCode);

                        } else {
DEBUGLOG(("Authorize::DBOLTcBalTrfMap:GetBalTransferTxnCode map_txn_code NOT FOUND!!\n"));
ERRLOG("TxnOmtByUsPBF::Authorize::DBOLTcBalTrfMap:GetBalTransferTxnCode map_txn_code NOT FOUND!!\n");
                                iRet = INT_ERR;
                                PutField_Int(hContext,"internal_error",iRet);
                        }
                } else {
                        iRet = INT_ERR;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: Call DBOLTcBalTrfMap:GetBalTransferTxnCode FAILED\n"));
ERRLOG("TxnOmtByUsPBF::Authorize:: Call DBOLTcBalTrfMap:GetBalTransferTxnCode FAILED\n");
                }

                hash_destroy(hRec);
        }

// Check Allow Fe Init and Get Txn Code (to)
	if (iRet == PD_OK) {
		hash_init(hRec,0);
	
		PutField_CString(hRec,"bal_trf_type",PD_BAL_TRF_TYPE_SAME_PLATF);
        	PutField_CString(hRec,"from_acct_type",csFrPspAcctType);
        	PutField_CString(hRec,"to_acct_type",csToPspAcctType);
		PutField_CString(hRec,"bal_trf_txn_code_type",PD_BAL_TRF_TC_TYPE_SWEEP_IN);
		PutField_CString(hRec,"to_baid_category",csToBaidCategory);

DEBUGLOG(("Authorize:: Call DBOLTcBalTrfMap:GetBalTransferTxnCode\n"));
        	DBObjPtr = CreateObj(DBPtr, "DBOLTcBalTrfMap", "GetBalTransferTxnCode");
        	if ((unsigned long)(*DBObjPtr)(hRec) == PD_FOUND) {

/* allow_fe_init */
                	if (GetField_Int(hRec,"allow_fe_init",&iAllowFeInit)) {
DEBUGLOG(("Authorize::DBOLTcBalTrfMap::GetBalTransferTxnCode allow_fe_init = [%d]\n",iAllowFeInit));

				// Check Allow FE Init
                        	if (iAllowFeInit == 0) {
DEBUGLOG(("Authorize::DBOLTcBalTrfMap::GetBalTransferTxnCode NOT ALLOW FE INIT!!\n"));
ERRLOG("TxnOmtByUsPBF::Authorize::DBOLTcBalTrfMap::GetBalTransferTxnCode NOT ALLOW FE INIT!!\n");
                                	iRet = INT_ERR;
                                	PutField_Int(hContext,"internal_error",iRet);
                        	}
                	}

/* map_txn_code */
                	if (GetField_CString(hRec,"map_txn_code",&csToTxnCode)) {
DEBUGLOG(("Authorize::DBOLTcBalTrfaMap:GetBalTransferTxnCode map_txn_code = [%s]\n",csToTxnCode));
                        	PutField_CString(hToContext,"txn_code",csToTxnCode);
                        	PutField_CString(hToContext,"new_txn_code",csToTxnCode);

                	} else {
DEBUGLOG(("Authorize::DBOLTcBalTrfMap:GetBalTransferTxnCode map_txn_code NOT FOUND!!\n"));
ERRLOG("TxnOmtByUsPBF::Authorize::DBOLTcBalTrfMap:GetBalTransferTxnCode map_txn_code NOT FOUND!!\n");
                        	iRet = INT_ERR;
                        	PutField_Int(hContext,"internal_error",iRet);
                	}
        	} else {
                	iRet = INT_ERR;
                	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: Call DBOLTcBalTrfMap:GetBalTransferTxnCode FAILED\n"));
ERRLOG("TxnOmtByUsPBF::Authorize:: Call DBOLTcBalTrfMap:GetBalTransferTxnCode FAILED\n");
        	}

		hash_destroy(hRec);
	}
	
// Get Unique Amount
	if (iRet == PD_OK) {
                if (iGenUniqueAmt == PD_TRUE) {
                        PutField_CString(hFrContext, "channel_code", PD_CHANNEL_OMT);
			PutField_CString(hFrContext, "org_txn_code", csFrTxnCode);
			PutField_Double(hFrContext, "org_txn_amt", dAmt);

DEBUGLOG(("Authorize:: Call BOUniqueNumber: GetUniqueAmt\n"));
                        BOObjPtr = CreateObj(BOPtr, "BOUniqueNumber", "GetUniqueAmt");
                        iRet = (unsigned long)(*BOObjPtr)(hFrContext, hRequest, hFrContext);
                        if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call: BOUniqueNumber.GetUniqueAmt failed, return = [%d]\n", iRet));
ERRLOG("TxnOmtByUsPBF:: Authorize:: Call: BOUniqueNumber.GetUniqueAmt failed, return = [%d]\n", iRet);
                        }
                        else {

/* display_amt */
                                if (GetField_Double(hFrContext, "display_amt", &dFinalAmt)) {
DEBUGLOG(("Authorize:: unique_amt [%f]\n", dFinalAmt));
					PutField_Double(hToContext, "display_amt", dFinalAmt);
					PutField_Double(hContext, "display_amt", dFinalAmt);
                                }
                        }
                } else {
                        dFinalAmt = dAmt;
                }

                PutField_Double(hFrContext, "org_txn_amt", dAmt);
		PutField_Double(hFrContext, "txn_amt", dAmt);
		PutField_Double(hFrContext, "net_amt", dFinalAmt);
                PutField_Double(hFrContext, "txn_amount", dFinalAmt);

                PutField_Double(hToContext, "org_txn_amt", dAmt);
		PutField_Double(hToContext, "txn_amt", dAmt);
		PutField_Double(hToContext, "net_amt", dFinalAmt);
		PutField_Double(hToContext, "txn_amount", dFinalAmt);

                PutField_Double(hContext, "org_txn_amt", dAmt);
		PutField_Double(hContext, "txn_amt", dAmt);
		PutField_Double(hContext, "net_amt", dFinalAmt);
                PutField_Double(hContext, "txn_amount", dFinalAmt);
        }

// Set From Txn Record
	if (iRet == PD_OK) {
		iRet = SetFrTxnRecord(hContext, hRequest, hFrContext, dAmt, dFinalAmt); 
	}

// Set To Txn Record	
	if (iRet == PD_OK) {
                iRet = SetToTxnRecord(hContext, hRequest, hToContext, hToReq, dAmt, dFinalAmt);
        }

// Response
        if (iRet == PD_OK) {
                PutField_CString(hResponse, "txn_seq_tf", csFrTxnSeq);

/* txn_seq */
                if (GetField_CString(hToContext,"txn_seq",&csToTxnSeq)) {
                        PutField_CString(hResponse, "txn_seq_tt", csToTxnSeq);
                }
        }

// Add Txn Relation
	if (iRet == PD_OK) {
		hash_init(hRelation, 0);

		PutField_Char(hRelation, "party", PD_TYPE_PSP);
		PutField_CString(hRelation, "p1_txn_id", csFrTxnSeq);
		PutField_CString(hRelation, "p2_txn_id", csToTxnSeq);
		PutField_Char(hRelation, "txn_level", PD_TXN_LEVEL);
		PutField_Char(hRelation, "relation_type", PD_REL_BAL_TRF);
		PutField_CString(hRelation, "create_user", csUser);

DEBUGLOG(("Authorize:: DBOLTxnRelation:Add [%s][%s]\n", csFrTxnSeq, csToTxnSeq));

                DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation", "Add");
                if ((unsigned long)(*DBObjPtr)(hRelation) != PD_OK) {
                        iRet = INT_ERR;
                }

		hash_destroy(hRelation);
	}

// Add Batch Txn Relation
	if (iRet == PD_OK) {
                hash_init(hRelation, 0);

DEBUGLOG(("Authorize: call DBOLTxnSeq GetNextActionBatchSeq\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextActionBatchSeq");
                strcpy(csBatchSeq, (*DBObjPtr)());
                PutField_CString(hContext, "batch_txn_seq", csBatchSeq);
DEBUGLOG(("Authorize: call DBOLTxnSeq GetNextActionBatchSeq: new_batch_id = [%s]\n",csBatchSeq));

		PutField_Char(hRelation, "batch_type", PD_GENERAL);
		PutField_Char(hRelation, "batch_sub_type", PD_GENERAL_BAL_TRF);
                PutField_CString(hRelation, "batch_id", csBatchSeq);
                PutField_Char(hRelation, "txn_level", PD_TXN_LEVEL);
                PutField_Int(hRelation, "is_input_txn", 1);
                PutField_Int(hRelation, "is_regen_txn", 0);
		PutField_CString(hRelation, "create_user", csUser);

		// From Txn Seq
                PutField_CString(hRelation, "txn_id", csFrTxnSeq);

DEBUGLOG(("Authorize: call DBOLBatchTxnRelation Add: fr_txn_seq = [%s]\n",csFrTxnSeq));
		DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation", "Add");
                if ((unsigned long)(*DBObjPtr)(hRelation) != PD_OK) {
                        iRet = INT_ERR;
                }		

		// To Txn Seq
		PutField_CString(hRelation, "txn_id", csToTxnSeq);

DEBUGLOG(("Authorize: call DBOLBatchTxnRelation Add: to_txn_seq = [%s]\n",csToTxnSeq));
		DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation", "Add");
                if ((unsigned long)(*DBObjPtr)(hRelation) != PD_OK) {
                        iRet = INT_ERR;
                }

                hash_destroy(hRelation);
        }

// Update Txn Log
        if ((iRet == PD_OK) || (GetField_Int(hToContext, "internal_error", &iInternalErr))) {
            	char* csBuf = (char*) malloc (128);

             	sprintf(csBuf, "%d", iInternalErr);
DEBUGLOG(("SetToTxnRecord::result_code = %s\n", csBuf));
            	PutField_CString(hToContext, "response_code", csBuf);
             	PutField_Int(hToContext, "internal_code", iInternalErr);
             	FREE_ME(csBuf);

             	PutField_Char(hToContext, "status", PD_COMPLETE);
             	PutField_CString(hToContext, "sub_status", PD_APPROVED);

             	if (iInternalErr != 0 ) {
                   	PutField_Char(hToContext, "ar_ind", PD_REJECT);
             	} else {
                     	PutField_Char(hToContext, "ar_ind", PD_ACCEPT);
              	}

		PutField_Char(hToContext, "recon_status", PD_UNRECONCILED);

DEBUGLOG(("SetToTxnRecord:: Call OMTChannel: UpdateTxnLog\n"));
            	ChannelObjPtr = CreateObj(ChannelPtr, "OMTChannel", "UpdateTxnLog");
              	iRet = (unsigned long)(*ChannelObjPtr)(hToContext, hToReq, hResponse);
               	if (iRet != PD_OK) {
                     	iRet = INT_ERR;
            	}
        }

// Update Sub Status and Recon Status
	if (iRet == PD_OK) {
		PutField_CString(hContext, "sub_status", PD_APPROVED);
		PutField_Char(hContext, "recon_status", PD_UNRECONCILED);

/* approval_date */
		if (GetField_CString(hFrContext, "approval_date", &csTmp)) {
                        PutField_CString(hContext, "approval_date", csTmp);
                }

/* approval_timestamp */
                if (GetField_CString(hFrContext, "approval_timestamp", &csTmp)) {
                        PutField_CString(hContext, "approval_timestamp", csTmp);
                }
	}

	FREE_ME(csFrTxnCountry);
	FREE_ME(csToTxnCountry);

        FREE_ME(hRec);
	FREE_ME(hRelation);

	hash_destroy(hFrContext);
        FREE_ME(hFrContext);

	hash_destroy(hToContext);
        FREE_ME(hToContext);	

	hash_destroy(hToReq);
        FREE_ME(hToReq);

DEBUGLOG(("TxnOmtByUsPBF Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
