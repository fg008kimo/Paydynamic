/*
PDProTech (c)2019. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2020/03/03              [WMC]
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnBalOnUsUPDBAL.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

static char cDebug;
OBJPTR(BO);
OBJPTR(DB);

void TxnBalOnUsUPDBAL(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{
	int	iRet = PD_OK;

	double	dOpenBal = 0.0;
	double	dOpenBalSett = 0.0;
	double	dCurrBal = 0.0;
	double	dCurrBalSett = 0.0;
	double 	dNetAmt = 0.0;
	double 	dResAmt = 0.0;
	double	dTmp = 0.0;
	
	char	*csTxnSeq = NULL;
	char	*csDate = NULL;
	char	*csTime = NULL;
	char	*csTmp = NULL;

	char	csDatetime[PD_DATETIME_LEN + 1];
	
	hash_t  *hTxn;
	hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	hash_t  *hPspTxn;
        hPspTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hPspTxn,0);

DEBUGLOG(("Authorize()\n"));

/* txnid */
	if (GetField_CString(hContext,"txnid",&csTxnSeq)) {
DEBUGLOG(("Authorize:: txnid = [%s]\n",csTxnSeq));
                PutField_CString(hTxn,"txn_seq",csTxnSeq);
                PutField_CString(hPspTxn,"txn_id",csTxnSeq);
	} else {
DEBUGLOG(("Authorize:: txnid missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: txnid missing!!\n");
                iRet = INT_ERR;
	}

/* txncode */
	if (iRet == PD_OK) {
        	if (GetField_CString(hContext, "txncode", &csTmp)) {
DEBUGLOG(("Authorize:: txncode = [%s]\n",csTmp));
        	} else {
DEBUGLOG(("Authorize:: txncode missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: txncode missing!!\n");
			iRet = INT_ERR;
        	}
	}

/* country */
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "country", &csTmp)) {
DEBUGLOG(("Authorize:: country = [%s]\n",csTmp));
                } else {
DEBUGLOG(("Authorize:: country missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: country missing!!\n");
			iRet = INT_ERR;
                }
        }

/* mid */
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "mid", &csTmp)) {
DEBUGLOG(("Authorize:: mid = [%s]\n",csTmp));
                } else {
DEBUGLOG(("Authorize:: mid missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: mid missing!!\n");
			iRet = INT_ERR;
                }
        }

/* ccy */
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "ccy", &csTmp)) {
DEBUGLOG(("Authorize:: ccy = [%s]\n",csTmp));
                } else {
DEBUGLOG(("Authorize:: ccy missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: ccy missing!!\n");
			iRet = INT_ERR;
                }
        }

/* service_code */
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "service_code", &csTmp)) {
DEBUGLOG(("Authorize:: service_code = [%s]\n",csTmp));
                } else {
DEBUGLOG(("Authorize:: service_code missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: service_code missing!!\n");
			iRet = INT_ERR;
                }
        }

/* bal */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "bal", &dCurrBal)) {
DEBUGLOG(("Authorize:: bal = [%.2f]\n",dCurrBal));
			PutField_Double(hTxn,"current_bal",dCurrBal);
                } else {
DEBUGLOG(("Authorize:: bal missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: bal missing!!\n");
			iRet = INT_ERR;
                }
        }

/* float */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "float", &dTmp)) {
DEBUGLOG(("Authorize:: float = [%.2f]\n",dTmp));
			PutField_Double(hTxn,"total_float",dTmp);
                } else {
DEBUGLOG(("Authorize:: float missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: float missing!!\n");
			iRet = INT_ERR;
                }
        }

/* holdback */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "holdback", &dTmp)) {
DEBUGLOG(("Authorize:: holdback = [%.2f]\n",dTmp));
			PutField_Double(hTxn,"total_reserved_amount",dTmp);
                } else {
DEBUGLOG(("Authorize:: holdback missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: holdback missing!!\n");
			iRet = INT_ERR;
                }
        }

/* hold */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "hold", &dTmp)) {
DEBUGLOG(("Authorize:: hold = [%.2f]\n",dTmp));
			PutField_Double(hTxn,"total_hold",dTmp);
                } else {
DEBUGLOG(("Authorize:: hold missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: hold missing!!\n");
			iRet = INT_ERR;
                }
        }

/* bal_sett */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "bal_sett", &dCurrBalSett)) {
DEBUGLOG(("Authorize:: bal_sett = [%.2f]\n",dCurrBalSett));
			PutField_Double(hTxn,"current_bal_settlement",dCurrBalSett);
                } else {
DEBUGLOG(("Authorize:: bal_sett missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: bal_sett missing!!\n");
			iRet = INT_ERR;
                }
        }

/* float_sett */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "float_sett", &dTmp)) {
DEBUGLOG(("Authorize:: float_sett = [%.2f]\n",dTmp));
			PutField_Double(hTxn,"total_float_settlement",dTmp);
                } else {
DEBUGLOG(("Authorize:: float_sett missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: float_sett missing!!\n");
			iRet = INT_ERR;
                }
        }

/* hold_sett */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "hold_sett", &dTmp)) {
DEBUGLOG(("Authorize:: hold_sett = [%.2f]\n",dTmp));
			PutField_Double(hTxn,"total_hold_settlement",dTmp);
                } else {
DEBUGLOG(("Authorize:: hold_sett missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: hold_sett missing!!\n");
			iRet = INT_ERR;
                }
        }

/* fundin_po */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "fundin_po", &dTmp)) {
DEBUGLOG(("Authorize:: fundin_po = [%.2f]\n",dTmp));
			PutField_Double(hTxn,"fundin_payout",dTmp);
                } else {
DEBUGLOG(("Authorize:: fundin_po missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: fundin_po missing!!\n");
			iRet = INT_ERR;
                }
        }

/* resv_po */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "resv_po", &dTmp)) {
DEBUGLOG(("Authorize:: resv_po = [%.2f]\n",dTmp));
			PutField_Double(hTxn,"reserved_payout",dTmp);
                } else {
DEBUGLOG(("Authorize:: resv_po missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: resv_po missing!!\n");
			iRet = INT_ERR;
                }
        }

/* afpo_float */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "afpo_float", &dTmp)) {
DEBUGLOG(("Authorize:: afpo_float = [%.2f]\n",dTmp));
			PutField_Double(hTxn,"total_float_after_payout",dTmp);
                } else {
DEBUGLOG(("Authorize:: afpo_float missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: afpo_float missing!!\n");
			iRet = INT_ERR;
                }
        }

/* psp_id */
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "psp_id", &csTmp)) {
DEBUGLOG(("Authorize:: psp_id = [%s]\n",csTmp));
                        PutField_CString(hPspTxn,"psp_id",csTmp);
                } else {
DEBUGLOG(("Authorize:: psp_id missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: psp_id missing!!\n");
			iRet = INT_ERR;
                }
        }

/* psp_ccy */
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "psp_ccy", &csTmp)) {
DEBUGLOG(("Authorize:: psp_ccy = [%s]\n",csTmp));
                } else {
DEBUGLOG(("Authorize:: psp_ccy missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: psp_ccy missing!!\n");
			iRet = INT_ERR;
                }
        }

/* psp_bal */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "psp_bal", &dTmp)) {
DEBUGLOG(("Authorize:: psp_bal = [%.2f]\n",dTmp));
			PutField_Double(hTxn,"bal",dTmp);
                } else {
DEBUGLOG(("Authorize:: psp_bal missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: psp_bal missing!!\n");
			iRet = INT_ERR;
                }
        }

/* psp_float */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "psp_float", &dTmp)) {
DEBUGLOG(("Authorize:: psp_float = [%.2f]\n",dTmp));
			PutField_Double(hTxn,"total_float",dTmp);
                } else {
DEBUGLOG(("Authorize:: psp_float missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: psp_float missing!!\n");
			iRet = INT_ERR;
                }
        }

/* psp_hold */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "psp_hold", &dTmp)) {
DEBUGLOG(("Authorize:: psp_hold = [%.2f]\n",dTmp));
			PutField_Double(hTxn,"total_hold",dTmp);
                } else {
DEBUGLOG(("Authorize:: psp_hold missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: psp_hold missing!!\n");
			iRet = INT_ERR;
                }
        }

/* local_tm_date and local_tm_time*/
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "local_tm_date", &csDate)) {
DEBUGLOG(("Authorize:: local_tm_date = [%s]\n",csDate));
                        PutField_CString(hPspTxn,"txn_date",csDate);
                        PutField_CString(hPspTxn,"fundin_date_short",csDate);

			if (GetField_CString(hContext, "local_tm_time", &csTime)) {
DEBUGLOG(("Authorize:: local_tm_time = [%s]\n",csTime));
				sprintf(csDatetime, "%s%s", csDate, csTime);
				PutField_CString(hPspTxn,"fundin_date",csDatetime);
DEBUGLOG(("Authorize:: datetime = [%s]\n",csDatetime));
			} else {
DEBUGLOG(("Authorize:: local_tm_time missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: local_tm_time missing!!\n");
                	}
                } else {
DEBUGLOG(("Authorize:: local_tm_date missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: local_tm_date missing!!\n");
                }
        }

/* PHDATE */
	if (iRet == PD_OK) {
                if (GetField_CString(hContext, "PHDATE", &csTmp)) {
DEBUGLOG(("Authorize:: PHDATE = [%s]\n",csTmp));
                } else {
DEBUGLOG(("Authorize:: PHDATE missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: PHDATE missing!!\n");
         	}
	}
         
/* based_ccy */
	if (iRet == PD_OK) {
                if (GetField_CString(hContext, "based_ccy", &csTmp)) {
DEBUGLOG(("Authorize:: based_ccy = [%s]\n",csTmp));
                } else {
DEBUGLOG(("Authorize:: based_ccy missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: based_ccy missing!!\n");
                }
        }

/* notice_status */
/*
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "notice_status", &csTmp)) {
DEBUGLOG(("Authorize:: notice_status = [%s]\n",csTmp));
			PutField_CString(hPspTxn,"notice_status",csTmp);
                } else {
DEBUGLOG(("Authorize:: notice_status missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL::Authorize:: notice_status missing!!\n");
                }
        }
*/

	// update_user
        PutField_CString(hTxn,"update_user",PD_UPDATE_USER);
        PutField_CString(hPspTxn,"update_user",PD_UPDATE_USER);

	// Get Txn Header
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: Call Get Transaction Header\n"));
		
		hash_t  *hRec;

		recordset_t     *rRecordSet;
		rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        	recordset_init(rRecordSet,0);

		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
          	if ((*DBObjPtr)(csTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("Authorize:: Call DBTransaction:: GetTxnHeader:: found record = [%s]\n",csTxnSeq));

                    	hRec = RecordSet_GetFirst(rRecordSet);
                     	while (hRec) {

/* net_amt */
                           	if(GetField_Double(hRec,"net_amt",&dNetAmt)){
DEBUGLOG(("Authorize:: Call DBTransaction:: GetTxnHeader:: net_amt = [%.2f]\n",dNetAmt));
                             	} else {
DEBUGLOG(("Authorize:: Call DBTransaction:: GetTxnHeader:: net_amt missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: Authorize:: Call DBTransaction:: GetTxnHeader:: net_amt missing!!\n");
				}

/* reserve_amt */
				if(GetField_Double(hRec,"reserve_amt",&dResAmt)){
DEBUGLOG(("Authorize:: Call DBTransaction:: GetTxnHeader:: reserve_amt = [%.2f]\n",dResAmt));
                                }
			
				hRec = RecordSet_GetNext(rRecordSet);
                    	}
		} else {
                   	iRet = INT_TXN_ID_NOT_FOUND;
DEBUGLOG(("Authorize:: Call DBTransaction:: GetTxnHeader:: txn id not found\n"));
ERRLOG("TxnBalOnUsUPDBAL:: Call DBTransaction:: Authorize:: GetTxnHeader:: txn id not found\n");
		}
	}

	// Calculate Merchant Open Balance
	if (iRet == PD_OK) {

		// Testing
		/*
		dNetAmt = 1000.35;
		dResAmt = 200.36;		
DEBUGLOG(("Authorize:: net_amt = [%.2f]\n",dNetAmt));
DEBUGLOG(("Authorize:: reserve_amt = [%.2f]\n",dResAmt));		
		*/
	
		// Open Balance
		dOpenBal = dCurrBal - (dNetAmt - dResAmt);
		PutField_Double(hTxn,"open_bal",dOpenBal);	
DEBUGLOG(("Authorize:: merchant open balance = [%.2f]\n",dOpenBal));	

		// Open Balance Settlement
		dOpenBalSett = dCurrBalSett - dResAmt;
		PutField_Double(hTxn,"open_bal_settlement",dOpenBalSett);	
DEBUGLOG(("Authorize:: merchant open balance settlement = [%.2f]\n",dOpenBalSett));
	}	

	// Select Txn Detail for Update By Merchant Balance
	/*
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","MatchRespTxnByMerchBal");
             	if ((unsigned long)(DBObjPtr)(csTxnSeq, PD_COMPLETE) == PD_FOUND) {
DEBUGLOG(("Authorize:: Call DBTransaction:: MatchRespTxnByMerchBal Success!!\n"));
		} else {
DEBUGLOG(("Authorize:: Call DBTransaction:: MatchRespTxnByMerchBal Failure!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: Authorize:: Call DBTransaction:: MatchRespTxnByMerchBal Failure!!\n");
			iRet = INT_ERR;
		}
	}
	*/

	// Update Txn Detail
	/*
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: Call Update Transaction Detail\n"));
          	DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
             	iRet = (unsigned long)(*DBObjPtr)(hTxn);
		if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call DBTransaction:: UpdateDetail Failure!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: Authorize:: Call DBTransaction:: UpdateDetail Failure!!\n");
			iRet = INT_ERR;
		}
      	}
	*/
	
	// Select Txn Psp Detail for Update By Psp Balance
	/*
	if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","MatchRespTxnByPspBal");
                if ((unsigned long)(DBObjPtr)(csTxnSeq, PD_COMPLETE) == PD_FOUND) {
DEBUGLOG(("Authorize:: Call DBTxnPspDetail:: MatchRespTxnByPspBal Success!!\n"));			
		} else {
DEBUGLOG(("Authorize:: Call DBTxnPspDetail:: MatchRespTxnByPspBal Failure!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: Authorize:: Call DBTxnPspDetail:: MatchRespTxnByPspBal Failure!!\n");
                        iRet = INT_ERR;
                }
        }
	*/

	// Update Txn Psp Detail
	/* 
    	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: Call Update TxnPspDetail\n"));
               	DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
             	iRet = (unsigned long)(*DBObjPtr)(hPspTxn);
		if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call DBTxnPspDetail:: Update Failure!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: Authorize:: Call DBTxnPspDetail:: Update Failure!!\n");
			iRet = INT_ERR;
		}
      	}
	*/

	hash_destroy(hTxn);
        FREE_ME(hTxn);	

	hash_destroy(hPspTxn);
        FREE_ME(hPspTxn);

DEBUGLOG(("Authorize() iRet = [%d]\n",iRet));
	return iRet;
}

