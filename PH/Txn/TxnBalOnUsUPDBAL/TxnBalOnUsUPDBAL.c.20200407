/*
PDProTech (c)2019. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2020/03/03              [WMC]
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnBalOnUsUPDBAL.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

static char cDebug;
OBJPTR(BO);
OBJPTR(DB);

int     CalOpenBalance(const char *csTxnCode, hash_t *hBalance);

void TxnBalOnUsUPDBAL(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{
	int	iRet = PD_OK;

	double	dPtr = 0.0;
	
	char	*csTxnSeq = NULL;
	char	*csTxnCode = NULL;
	char	*csMerchantId = NULL;
	char	*csCcy = NULL;
	char	*csServiceCode = NULL;
	char	*csPspId = NULL;
	char	*csPspCcy = NULL;
	char	*csPtr = NULL;

	char	cPtr;
	
	hash_t  *hTxn;
	hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	hash_t  *hPspTxn;
        hPspTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hPspTxn,0);

DEBUGLOG(("Authorize()\n"));

/* txnid */
	if (GetField_CString(hContext,"txnid",&csTxnSeq)) {
DEBUGLOG((" txnid = [%s]\n",csTxnSeq));
                PutField_CString(hTxn,"txn_seq",csTxnSeq);
                PutField_CString(hPspTxn,"txn_id",csTxnSeq);
	} else {
                iRet = INT_TXN_ID_NOT_FOUND;
DEBUGLOG((" txnid missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: txnid missing!!\n");
	}

/* txncode */
	if (iRet == PD_OK) {
        	if (GetField_CString(hContext, "txncode", &csTxnCode)) {
DEBUGLOG((" txncode = [%s]\n",csTxnCode));
        	} else {
			iRet = INT_TXN_CODE_NOT_FOUND;
DEBUGLOG((" txncode missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: txncode missing!!\n");
        	}
	}

/* country */
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "country", &csPtr)) {
DEBUGLOG((" country = [%s]\n",csPtr));
                } else {
			iRet = INT_TXN_COUNTRY_NOT_FOUND;
DEBUGLOG((" country missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: country missing!!\n");
                }
        }

/* mid */
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "mid", &csMerchantId)) {
DEBUGLOG((" mid = [%s]\n",csMerchantId));
                } else {
			iRet = INT_MERCHANT_ID_NOT_FOUND;
DEBUGLOG((" mid missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: mid missing!!\n");
                }
        }

/* ccy */
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "ccy", &csCcy)) {
DEBUGLOG((" ccy = [%s]\n",csCcy));
                } else {
			iRet = INT_CURRENCY_CODE_NOT_FOUND;
DEBUGLOG((" ccy missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: ccy missing!!\n");
                }
        }

/* service_code */
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "service_code", &csServiceCode)) {
DEBUGLOG((" service_code = [%s]\n",csServiceCode));
                } else {
			iRet = INT_SERVICE_CODE_MISSING;
DEBUGLOG((" service_code missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: service_code missing!!\n");
                }
        }

/* bal */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "bal", &dPtr)) {
DEBUGLOG((" bal = [%.2f]\n", dPtr));
			PutField_Double(hTxn, "current_bal", dPtr);
                } else {
			iRet = INT_ERR;
DEBUGLOG((" bal missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: bal missing!!\n");
                }
        }

/* float */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "float", &dPtr)) {
DEBUGLOG((" float = [%.2f]\n",dPtr));
			PutField_Double(hTxn,"total_float",dPtr);
                } else {
			iRet = INT_ERR;
DEBUGLOG((" float missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: float missing!!\n");
                }
        }

/* holdback */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "holdback", &dPtr)) {
DEBUGLOG((" holdback = [%.2f]\n",dPtr));
			PutField_Double(hTxn,"total_reserved_amount",dPtr);
                } else {
			iRet = INT_ERR;
DEBUGLOG((" holdback missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: holdback missing!!\n");
                }
        }

/* hold */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "hold", &dPtr)) {
DEBUGLOG((" hold = [%.2f]\n",dPtr));
			PutField_Double(hTxn,"total_hold",dPtr);
                } else {
			iRet = INT_ERR;
DEBUGLOG((" hold missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: hold missing!!\n");
                }
        }

/* bal_sett */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "bal_sett", &dPtr)) {
DEBUGLOG((" bal_sett = [%.2f]\n", dPtr));
			PutField_Double(hTxn, "current_bal_settlement", dPtr);
                } else {
			iRet = INT_ERR;
DEBUGLOG((" bal_sett missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: bal_sett missing!!\n");
                }
        }

/* float_sett */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "float_sett", &dPtr)) {
DEBUGLOG((" float_sett = [%.2f]\n",dPtr));
			PutField_Double(hTxn,"total_float_settlement",dPtr);
                } else {
			iRet = INT_ERR;
DEBUGLOG((" float_sett missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: float_sett missing!!\n");
                }
        }

/* hold_sett */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "hold_sett", &dPtr)) {
DEBUGLOG((" hold_sett = [%.2f]\n",dPtr));
			PutField_Double(hTxn,"total_hold_settlement",dPtr);
                } else {
			iRet = INT_ERR;
DEBUGLOG((" hold_sett missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: hold_sett missing!!\n");
                }
        }

/* fundin_po */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "fundin_po", &dPtr)) {
DEBUGLOG((" fundin_po = [%.2f]\n",dPtr));
			PutField_Double(hTxn,"fundin_payout",dPtr);
                } else {
			iRet = INT_ERR;
DEBUGLOG((" fundin_po missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: fundin_po missing!!\n");
                }
        }

/* resv_po */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "resv_po", &dPtr)) {
DEBUGLOG((" resv_po = [%.2f]\n",dPtr));
			PutField_Double(hTxn,"reserved_payout",dPtr);
                } else {
			iRet = INT_ERR;
DEBUGLOG((" resv_po missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: resv_po missing!!\n");
                }
        }

/* afpo_float */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "afpo_float", &dPtr)) {
DEBUGLOG((" afpo_float = [%.2f]\n",dPtr));
			PutField_Double(hTxn,"total_float_after_payout",dPtr);
                } else {
			iRet = INT_ERR;
DEBUGLOG((" afpo_float missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: afpo_float missing!!\n");
                }
        }

/* psp_id */
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "psp_id", &csPspId)) {
DEBUGLOG((" psp_id = [%s]\n", csPspId));
                } else {
			iRet = INT_PSP_ID_NOT_FOUND;
DEBUGLOG((" psp_id missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: psp_id missing!!\n");
                }
        }

/* psp_ccy */
        if (iRet == PD_OK) {
                if (GetField_CString(hContext, "psp_ccy", &csPspCcy)) {
DEBUGLOG((" psp_ccy = [%s]\n", csPspCcy));
                } else {
			iRet = INT_CURRENCY_CODE_NOT_FOUND;
DEBUGLOG((" psp_ccy missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: psp_ccy missing!!\n");
                }
        }

/* psp_bal */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "psp_bal", &dPtr)) {
DEBUGLOG((" psp_bal = [%.2f]\n",dPtr));
			PutField_Double(hTxn,"bal",dPtr);
                } else {
			iRet = INT_ERR;
DEBUGLOG((" psp_bal missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: psp_bal missing!!\n");
                }
        }

/* psp_float */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "psp_float", &dPtr)) {
DEBUGLOG((" psp_float = [%.2f]\n",dPtr));
			PutField_Double(hTxn,"total_float",dPtr);
                } else {
			iRet = INT_ERR;
DEBUGLOG((" psp_float missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: psp_float missing!!\n");
                }
        }

/* psp_hold */
        if (iRet == PD_OK) {
                if (GetField_Double(hContext, "psp_hold", &dPtr)) {
DEBUGLOG((" psp_hold = [%.2f]\n",dPtr));
			PutField_Double(hTxn,"total_hold",dPtr);
                } else {
			iRet = INT_ERR;
DEBUGLOG((" psp_hold missing!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: psp_hold missing!!\n");
                }
        }


	// update_user
        PutField_CString(hTxn,"update_user",PD_UPDATE_USER);
        PutField_CString(hPspTxn,"update_user",PD_UPDATE_USER);


	// Get txn_header & txn_psp_detail
	if (iRet == PD_OK) {
DEBUGLOG(("Call BOTransaction::GetTxnInfo()\n"));
		
		hash_t  *hIn;
		hIn = (hash_t*)  malloc (sizeof(hash_t));
		hash_init(hIn,0);

		hash_t  *hOut;
		hOut = (hash_t*)  malloc (sizeof(hash_t));
		hash_init(hOut,0);

		PutField_CString(hIn, "txn_seq", csTxnSeq);
		PutField_Int(hIn, "get_txn_header", PD_TRUE);
		PutField_Int(hIn, "get_txn_psp_detail", PD_TRUE);

		BOObjPtr = CreateObj(BOPtr, "BOTransaction", "GetTxnInfo");
          	if ((*BOObjPtr)(hIn, hOut) == PD_OK) {

/* check txn_code */
			if(GetField_CString(hOut, "txn_code", &csPtr)){
				if(strcmp(csTxnCode, csPtr)){
					iRet = INT_INVALID_TXN;
DEBUGLOG((" txn_code not matched!! [%s][%s]\n", csTxnCode, csPtr));
ERRLOG("TxnBalOnUsUPDBAL:: txn_code not matched!! [%s][%s]\n", csTxnCode, csPtr);
				}
			}

/* check merchant_id */
			if(GetField_CString(hOut, "merchant_id", &csPtr)){
				if(strcmp(csMerchantId, csPtr)){
					iRet = INT_INVALID_TXN;
DEBUGLOG((" merchant_id not matched!! [%s][%s]\n", csMerchantId, csPtr));
ERRLOG("TxnBalOnUsUPDBAL:: merchant_id not matched!! [%s][%s]\n", csMerchantId, csPtr);
				}
			}

/* check net_ccy */
			if(GetField_CString(hOut, "net_ccy", &csPtr)){
				if(strcmp(csCcy, csPtr)){
					iRet = INT_INVALID_TXN;
DEBUGLOG((" net_ccy not matched!! [%s][%s]\n", csCcy, csPtr));
ERRLOG("TxnBalOnUsUPDBAL:: net_ccy not matched!! [%s][%s]\n", csCcy, csPtr);
				}
			}

/* check service_code */
			if(GetField_CString(hOut, "service_code", &csPtr)){
				if(strcmp(csServiceCode, csPtr)){
					iRet = INT_INVALID_TXN;
DEBUGLOG((" service_code not matched!! [%s][%s]\n", csServiceCode, csPtr));
ERRLOG("TxnBalOnUsUPDBAL:: service_code not matched!! [%s][%s]\n", csServiceCode, csPtr);
				}
			}

/* check psp_id */
			if(GetField_CString(hOut, "psp_id", &csPtr)){
				if(strcmp(csPspId, csPtr)){
					iRet = INT_INVALID_TXN;
DEBUGLOG((" psp_id not matched!! [%s][%s]\n", csPspId, csPtr));
ERRLOG("TxnBalOnUsUPDBAL:: psp_id not matched!! [%s][%s]\n", csPspId, csPtr);
				}
			}

/* check psp_txn_ccy */
			if(GetField_CString(hOut, "psp_txn_ccy", &csPtr)){
				if(strcmp(csPspCcy, csPtr)){
					iRet = INT_INVALID_TXN;
DEBUGLOG((" psp_txn_ccy not matched!! [%s][%s]\n",csPspCcy , csPtr));
ERRLOG("TxnBalOnUsUPDBAL:: psp_txn_ccy not matched!! [%s][%s]\n", csPspCcy, csPtr);
				}
			}

/* check status */
			if(GetField_Char(hOut, "status", &cPtr)){
				if(cPtr != PD_COMPLETE){
					iRet = INT_INVALID_TXN;
DEBUGLOG((" txn status invalid!! [%c]\n",cPtr));
ERRLOG("TxnBalOnUsUPDBAL:: txn status invalid!! [%c]\n",cPtr);
				}
			}
			
/* check ar_ind */
			if(GetField_Char(hOut, "ar_ind", &cPtr)){
				if(cPtr != PD_ACCEPT){
					iRet = INT_INVALID_TXN;
DEBUGLOG((" txn ar_ind invalid!! [%c]\n",cPtr));
ERRLOG("TxnBalOnUsUPDBAL:: txn ar_ind invalid!! [%c]\n",cPtr);
				}
			}

/* net_amt */
			if(GetField_Double(hOut, "net_amt", &dPtr)){
				PutField_Double(hTxn, "net_amt", dPtr);
DEBUGLOG((" net_amt = [%.2f]\n", dPtr));
			}

/* reserve_amt */
			if(GetField_Double(hOut, "reserve_amt", &dPtr)){
				PutField_Double(hTxn, "reserve_amt", dPtr);
DEBUGLOG((" reserve_amt = [%.2f]\n", dPtr));
			}
			
		} else {
                   	iRet = INT_ERR;
DEBUGLOG(("GetTxnInfo for [%s] failed, csTxnSeq\n"));
		}

		hash_destroy(hIn);
		FREE_ME(hIn);

		hash_destroy(hOut);
		FREE_ME(hOut);
	}

	// Calculate Merchant Open Balance
	if (iRet == PD_OK) {
		iRet = CalOpenBalance(csTxnCode, hTxn);
	}	

	// Select Txn Detail for Update By Merchant Balance
	if (iRet == PD_OK) {

DEBUGLOG(("Call DBTransaction::MatchRespTxnByMerchBal()\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","MatchRespTxnByMerchBal");
             	if ((unsigned long)(DBObjPtr)(csTxnSeq, PD_COMPLETE) != PD_FOUND) {
			iRet = INT_ERR;
DEBUGLOG(("MatchRespTxnByMerchBal failed!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: DBTransaction:: MatchRespTxnByMerchBal Failure!!\n");
		} else {
	
			// Update Txn Detail
DEBUGLOG(("Call DBTransaction::UpdateDetail()\n"));
          		DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
             		iRet = (unsigned long)(*DBObjPtr)(hTxn);
			if (iRet != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("UpdateDetail failed!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: DBTransaction:: UpdateDetail Failure!!\n");
			}
    		}
	}
	
	// Select Txn Psp Detail for Update By Psp Balance
	if (iRet == PD_OK) {

DEBUGLOG(("Call DBTxnPspDetail::MatchRespTxnByPspBal()\n"));
 	        DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","MatchRespTxnByPspBal");
                if ((unsigned long)(DBObjPtr)(csTxnSeq, PD_COMPLETE) != PD_FOUND) {
                        iRet = INT_ERR;
DEBUGLOG(("MatchRespTxnByPspBal failed!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: DBTxnPspDetail:: MatchRespTxnByPspBal Failure!!\n");
                } else {

			// Update Txn Psp Detail
DEBUGLOG(("Call DBTxnPspDetail::Update()\n"));
        	       	DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
        	     	iRet = (unsigned long)(*DBObjPtr)(hPspTxn);
			if (iRet != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("Update failed!!\n"));
ERRLOG("TxnBalOnUsUPDBAL:: DBTxnPspDetail:: Update Failure!!\n");
			}
      		}
	}

	hash_destroy(hTxn);
        FREE_ME(hTxn);	

	hash_destroy(hPspTxn);
        FREE_ME(hPspTxn);

DEBUGLOG(("Authorize() iRet = [%d]\n",iRet));
	return iRet;
}


int	CalOpenBalance(const char *csTxnCode, hash_t *hBalance)
{
	int iRet = PD_OK;

	double	dNetAmt = 0.0;
	double	dResAmt= 0.0;
	double	dCurrBal = 0.0;
	double	dCurrBalSett = 0.0;
	double	dOpenBal = 0.0;
	double	dOpenBalSett = 0.0;

DEBUGLOG(("CalOpenBalance() Start!\n"));

	if(!GetField_Double(hBalance, "current_bal", &dCurrBal)){
		iRet = INT_ERR;
DEBUGLOG((" current_bal missing\n"));
	}

	if(!GetField_Double(hBalance, "current_bal_settlement", &dCurrBalSett)){
		iRet = INT_ERR;
DEBUGLOG((" current_bal_settlement missing\n"));
	}

	if(!GetField_Double(hBalance, "net_amt", &dNetAmt)){
		iRet = INT_ERR;
DEBUGLOG((" net_amt missing\n"));
	}
	else{
		if(dNetAmt <= 0.0){
			iRet = INT_INVALID_PAY_AMOUNT;
DEBUGLOG(("Cannot calculate merchant open balance!! invalid net_amt [%.2f]!!\n", dNetAmt));
ERRLOG("TxnBalOnUsUPDBAL::CalOpenBalance() Cannot calculate merchant open balance!! invalid net_amt [%.2f]!!\n", dNetAmt);
		}
	}

	if(!GetField_Double(hBalance, "reserve_amt", &dResAmt)){
DEBUGLOG((" reserve_amt missing\n"));
	}

/* calculate balance */
	if(iRet == PD_OK){
		/* Deposit */
		if(!strcmp(csTxnCode, PD_INITIAL_TXN_CODE)){
			// Open Balance
			dOpenBal = dCurrBal - (dNetAmt - dResAmt);

			// Open Balance Settlement
			dOpenBalSett = dCurrBalSett - dResAmt;
		}
		else{
			/* if support other txn, add the handling here */
			iRet = INT_INVALID_TXN;
DEBUGLOG(("Unsupported Transaction [%s] !!\n", csTxnCode));
		}


		if(iRet == PD_OK){
			PutField_Double(hBalance, "open_bal", dOpenBal);	
			PutField_Double(hBalance, "open_bal_settlement", dOpenBalSett);	
DEBUGLOG((" Merchant open balance = [%.2f]\n", dOpenBal));	
DEBUGLOG((" Merchant open balance settlement = [%.2f]\n", dOpenBalSett));
		}
	}

DEBUGLOG(("CalOpenBalance() iRet = [%d]\n",iRet));
	return iRet;
}
