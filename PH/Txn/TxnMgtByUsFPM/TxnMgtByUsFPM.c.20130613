/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/08/17              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsFPM.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);
OBJPTR(Channel);

void TxnMgtByUsFPM(char	cdebug)
{
	cDebug = cdebug;
}

int	Authorize(hash_t* hContext,
			hash_t* hRequest,
			hash_t* hResponse)
{
	int	iRet = PD_OK;

	char	*csTxnId = NULL;
	char	*csUser = NULL;
	char	*csMerchantId = NULL;
	char	*csTxnCountry=strdup("");
	char	*csTxnCcy = NULL;
	char	*csDstTxnCcy = NULL;
	char	*csServiceCode = NULL;
	char	*csTmp = NULL;
	double	dOrgAmt = 0.0;
	double	dDstAmt = 0.0;
	double	dTmp = 0.0;
	char	cTmp;
	int	iId = 0;
	char    csId[PD_TXN_SEQ_LEN+1];

	double	dMarkupAmt = 0.0;
	double	dExRate = 0.0;
	char	*csMarkupCcy = NULL;

	hash_t	*hReq;
	hReq = (hash_t *) malloc(sizeof(hash_t));
	hash_init(hReq, 0);
	hash_t	*hTxn;
	hTxn = (hash_t *) malloc(sizeof(hash_t));
	hash_init(hTxn, 0);

/* add_user */
	if(GetField_CString(hRequest,"add_user",&csUser)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csUser));
		PutField_CString(hContext,"update_user",csUser);
	}

/* merchant_id */
	if(GetField_CString(hRequest,"merchant_id",&csMerchantId)){
DEBUGLOG(("Authorize::merchant_id= [%s]\n",csMerchantId));
		PutField_CString(hContext,"merchant_id",csMerchantId);
	}
	else{
DEBUGLOG(("Authorize::merchant_id not found!!\n"));
ERRLOG("TxnMgtByUsFPM::Authorize::merchant_id not found!!\n");
		iRet=INT_MERCHANT_ID_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

/* service_code */
	if(GetField_CString(hRequest,"service_code",&csServiceCode)){
DEBUGLOG(("Authorize::sevice_code= [%s]\n",csServiceCode));
		PutField_CString(hContext,"service_code",csServiceCode);
	}
	else{
DEBUGLOG(("Authorize::service_code not found!!\n"));
ERRLOG("TxnMgtByUsFPM::Authorize::service_code not found!!\n");
		iRet=INT_SERVICE_CODE_MISSING;
		PutField_Int(hContext,"internal_error",iRet);
	}

/* txn_ccy */
	if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTxnCcy));
		PutField_CString(hContext,"txn_ccy",csTxnCcy);
	}
	else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMgtByUsFPM::Authorize::ccy not found!!\n");
		iRet=INT_CURRENCY_CODE_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

/* dst_txn_ccy */
	if(GetField_CString(hRequest,"dst_txn_ccy",&csDstTxnCcy)){
DEBUGLOG(("Authorize::dst_txn_ccy= [%s]\n",csDstTxnCcy));
		PutField_CString(hContext,"dst_txn_ccy",csDstTxnCcy);
	}
	else{
DEBUGLOG(("Authorize::dst_ccy not found!!\n"));
ERRLOG("TxnMgtByUsFPM::Authorize::dst_ccy not found!!\n");
		iRet=INT_CURRENCY_CODE_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

/* txn_country */
	if(GetField_CString(hRequest,"txn_country",&csTxnCountry)){
DEBUGLOG(("Authorize::txn_country= [%s]\n",csTxnCountry));
		PutField_CString(hContext,"txn_country",csTxnCountry);
	}
	else{
/*
		if (iRet == PD_OK) {
			DBObjPtr = CreateObj(DBPtr,"DBService","FindCountryByService");
			if ((unsigned long)(DBObjPtr)(csServiceCode,csTxnCountry) == PD_FOUND) {
				PutField_CString(hContext,"txn_country",csTxnCountry);
DEBUGLOG(("Authorize::Found Country [%s] for Service [%s]\n",csTxnCountry,csServiceCode));
			}
			else{
				iRet = INT_INVALID_SERVICE_CODE;
DEBUGLOG(("Authorize::invalid service code[%s]\n",csServiceCode));
ERRLOG("TxnMgtByUsFPM:Authorize::invalid service code [%s]\n",csServiceCode);

				PutField_Int(hContext,"internal_error",iRet);
			}
		}
*/
DEBUGLOG(("Authorize::country not found!!\n"));
ERRLOG("TxnMgtByUsFPM::Authorize::country not found!!\n");
                iRet=INT_TXN_COUNTRY_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
	}

/* txn_amt */
	if(GetField_Double(hContext,"txn_amt",&dOrgAmt)){
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dOrgAmt));
	}
	else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMgtByUsFPM::Authorize::txn_amt not found!!\n");
		iRet=INT_PAY_AMOUNT_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}


	/* GetMerchantTxnInfo */
	if (iRet == PD_OK) {
		PutField_CString(hReq, "merchant_id", csMerchantId);
		PutField_CString(hReq, "service_code", csServiceCode);
		PutField_CString(hReq, "txn_ccy", csDstTxnCcy);
		PutField_CString(hReq, "txn_country", csTxnCountry);

DEBUGLOG(("Authorize() BOMerchant->GetMerchantTxnInfo\n"));
		BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantTxnInfo");
		iRet = (unsigned long)(*BOObjPtr)(hContext,hReq);
DEBUGLOG(("Authorize() BOMerchant->GetMerchantTxnInfo = [%d]\n",iRet));
	}

	/* GetExchangeInfo */
	if (iRet == PD_OK) {
		BOObjPtr = CreateObj(DBPtr,"BOExchange","GetExchangeInfo");
		if ((*BOObjPtr)(hContext,hRequest) == PD_OK) {
DEBUGLOG(("GetExternalExchangeInfo Success\n"));
			if(GetField_Double(hContext,"dst_txn_amt",&dDstAmt)){
DEBUGLOG(("Destination Amount=[%lf]\n",dDstAmt));
				PutField_Double(hContext, "txn_amt", dDstAmt);
				PutField_CString(hContext,"txn_ccy", csDstTxnCcy);
				PutField_CString(hRequest,"txn_ccy", csDstTxnCcy);
			}

			if(GetField_Double(hContext,"ex_rate",&dExRate)){
DEBUGLOG(("Exchange rate=[%lf]\n",dExRate));
			}

			if(GetField_Double(hContext,"markup_amt",&dMarkupAmt)){
DEBUGLOG(("Markup Amount=[%lf]\n",dMarkupAmt));
			}
			if(GetField_Double(hContext,"markup_rate",&dTmp)){
DEBUGLOG(("Markup rate=[%lf]\n",dTmp));
			}
			if(GetField_Char(hContext,"ex_party",&cTmp)){
				PutField_Char(hContext,"ex_supplier",cTmp);
DEBUGLOG(("Exchange Party=[%c]\n",cTmp));
			}

			if (GetField_CString(hContext, "markup_ccy", &csMarkupCcy)) {
DEBUGLOG(("Markup ccy =[%s]\n", csMarkupCcy));
			}

			if (dMarkupAmt > 0.0) {
				if (strcmp(csMarkupCcy, csDstTxnCcy)) {
					dMarkupAmt = dMarkupAmt * dExRate;

DEBUGLOG(("Actaul Markup amt [%lf] in Ccy [%s]\n", dMarkupAmt, csDstTxnCcy));
	
					PutField_Double(hContext, "markup_amt", dMarkupAmt);
					PutField_CString(hContext, "markup_ccy", csDstTxnCcy);
				}
			}

		}
		else {
			iRet = INT_ERR;
DEBUGLOG(("Authorize::GetExchangeInfo Error\n"));
ERRLOG("TxnMgtByUsFPM:Authorize::GetExchangeInfo Error\n");
		}
	}
	

	PutField_Char(hContext, "party_type", PD_TYPE_MERCHANT);
	PutField_Char(hContext, "dc_ind", PD_IND_CREDIT); 
	PutField_Int(hContext, "chg_bal_mode", PD_TRUE); 


	// **************** Get Fee ***************
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call BOFee:GetTxnFee\n"));


		//PutField_CString(hRequest,"txn_ccy",csTxnCcy);

		BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
		if ((unsigned long)((*BOObjPtr)(hContext, hRequest)) != PD_OK) {
DEBUGLOG(("Authorize::BOFee:GetTxnFee Failed Ret [%d]\n", iRet));
ERRLOG("TxnMgtByUsFPM::BOFee::GetTxnFee Failed Ret [%d]\n", iRet);
			iRet = INT_ERR;
		}
		else {
			if (GetField_Double(hContext, "dst_txn_fee", &dTmp)) {
DEBUGLOG(("Authorize::BOFee:GetTxnFee dst_txn_fee [%lf]\n", dTmp));
				PutField_Double(hContext, "src_txn_fee", dTmp);
			}
			else {

				dTmp = 0.0;
				PutField_Double(hContext, "src_txn_fee", dTmp);
DEBUGLOG(("Authorize::BOFee:GetTxnFee dst_txn_fee (by default) [%lf]\n", dTmp));
			}

			if (GetField_CString(hContext, "dst_txn_fee_ccy", &csTmp)) {
DEBUGLOG(("Authorize::BOFee:GetTxnFee dst_txn_fee_ccy [%s]\n", csTmp));
				PutField_CString(hContext, "src_txn_fee_ccy", csTmp);
			
			}
			else {
				PutField_CString(hContext, "src_txn_fee_ccy", csTxnCcy);
			}

		}

		RemoveField_Double(hContext, "dst_txn_fee");
	}



	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call BOBalance: ProcessFundinPayout\n"));
		BOObjPtr = CreateObj(BOPtr,"BOBalance","ProcessFundinPayout");
		iRet = (unsigned long)((*BOObjPtr)(hContext));

		if (GetField_Double(hContext, "net_amt", &dTmp)) {
DEBUGLOG(("Authorize::Call BOBalance: ProcessFundinPayout net_amt [%lf]\n", dTmp));
		}
	}

	if (iRet == PD_OK) {
		PutField_Double(hContext, "txn_amt", dOrgAmt);
		PutField_CString(hContext,"txn_ccy", csTxnCcy);
		PutField_CString(hContext,"net_ccy",csDstTxnCcy);
	}


	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call MGTChannel:UpdateTxnDetailLog\n"));
		ChannelObjPtr = CreateObj(ChannelPtr, "MGTChannel","UpdateTxnDetailLog");
		if ((unsigned long)((*ChannelObjPtr)(hContext, hRequest, hResponse)) != PD_OK) {
			iRet = INT_ERR;
		}
	}

	if(iRet==PD_OK){
		PutField_Double(hRequest,"bank_amt",dOrgAmt);
		PutField_CString(hRequest,"bank_ccy",csTxnCcy);
		PutField_Double(hRequest,"fin_amt",dOrgAmt);
		PutField_CString(hRequest,"fin_ccy",csTxnCcy);
DEBUGLOG(("Authorize::Call TxnMgtByUsFIR\n"));
		TxnObjPtr = CreateObj(TxnPtr, "TxnMgtByUsFIR","Authorize");
		if ((unsigned long)((*TxnObjPtr)(hContext, hRequest, hResponse)) != PD_OK) {
			iRet = INT_ERR;
		}
		else{
                        if(GetField_Int(hContext,"fundsin_id",&iId)){
DEBUGLOG(("Authorize::TxnMgtByUsFIR return fundsin_id[%d]\n",iId));
                                sprintf(csId,"%d",iId);
                                PutField_CString(hTxn,"td_batch_id",csId);
                        }
                }
	}


	if (iRet == PD_OK) {
		GetField_CString(hContext, "PHDATE", &csTmp);

		// for add approve timestamp
		PutField_CString(hContext, "approval_date", csTmp);
		PutField_CString(hContext, "sub_status", PD_APPROVED);
		
	}

	if(iRet==PD_OK){
		if(GetField_CString(hContext,"txn_seq",&csTxnId)){
			PutField_CString(hResponse,"org_txn_seq",csTxnId);
		}
	}
	if(iRet==PD_OK){
		//Update td_batch_id
		PutField_CString(hTxn,"txn_seq",csTxnId);
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
		if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
DEBUGLOG(("Authorize::TxnMgtByUsFIR DBTransaction->UpdateDetail Failed\n"));
		}
	}

	hash_destroy(hReq);
	FREE_ME(hReq);
	FREE_ME(hTxn);

	FREE_ME(csTxnCountry);
DEBUGLOG(("TxnMgtByUsFPM Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
