/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/05/18              Simon Fung
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtOnUsJLC.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(Txn);
OBJPTR(BO);
OBJPTR(DB);

void TxnMgtOnUsJLC(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
	char*   csHandler = NULL;
  int     iRet = PD_OK;
	char*	csTmp = NULL;
	char	csValue[PD_VALUE_LEN +1];
	char*	csPspId = "JLC";
	double	dTmp;
	hash_t	*hReq,*hRps;

	hReq = (hash_t*) malloc (sizeof(hash_t));
	hRps = (hash_t*) malloc (sizeof(hash_t));

	hash_init(hReq,0);
	hash_init(hRps,0);

	//double	dTmp;

	DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): Authroize()\n"));

		/* jnl_header_id */
	if (GetField_CString(hRequest,"jnl_header_id",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): jnl_header_id = [%s]\n",csTmp));
		PutField_CString(hReq,"jnl_header_id",csTmp);
	}
		/* jnl_type_id */
	if (GetField_CString(hRequest,"jnl_type_id",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): jnl_type_id = [%s]\n",csTmp));
		PutField_CString(hReq,"jnl_type_id",csTmp);
	}
		/* description */
	if (GetField_CString(hRequest,"description",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): description = [%s]\n",csTmp));
		PutField_CString(hReq,"description",csTmp);
	}
		/* txn_date */
	if (GetField_CString(hRequest,"txn_date",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): txn_date = [%s]\n",csTmp));
		PutField_CString(hReq,"txn_date",csTmp);
	}
		/* acc_year */
	if (GetField_CString(hRequest,"acc_year",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): acc_year = [%s]\n",csTmp));
		PutField_CString(hReq,"acc_year",csTmp);
	}
		/* acc_month */
	if (GetField_CString(hRequest,"acc_month",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): acc_month = [%s]\n",csTmp));
		PutField_CString(hReq,"acc_month",csTmp);
	}
		/* ref_no */
	if (GetField_CString(hRequest,"ref_no",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): ref_no = [%s]\n",csTmp));
		PutField_CString(hReq,"ref_no",csTmp);
	}
		/* remarks */
	if (GetField_CString(hRequest,"remarks",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): remarks = [%s]\n",csTmp));
		PutField_CString(hReq,"remarks",csTmp);
	}
		/* status */
	if (GetField_CString(hRequest,"status",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): status = [%s]\n",csTmp));
		PutField_CString(hReq,"status",csTmp);
	}
		/* approved */
	if (GetField_CString(hRequest,"approved",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): approved = [%s]\n",csTmp));
		PutField_CString(hReq,"approved",csTmp);
	}
		/* disabled */
	if (GetField_CString(hRequest,"disabled",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): disabled = [%s]\n",csTmp));
		PutField_CString(hReq,"disabled",csTmp);
	}
		/* create_timestamp */
	if (GetField_CString(hRequest,"create_timestamp",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): create_timestamp = [%s]\n",csTmp));
		PutField_CString(hReq,"create_timestamp",csTmp);
	}
		/* update_timestamp */
	if (GetField_CString(hRequest,"update_timestamp",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): update_timestamp = [%s]\n",csTmp));
		PutField_CString(hReq,"update_timestamp",csTmp);
	}
		/* post_date */
	if (GetField_CString(hRequest,"post_date",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): post_date = [%s]\n",csTmp));
		PutField_CString(hReq,"post_date",csTmp);
	}
		/* approve_timestamp */
	if (GetField_CString(hRequest,"approve_timestamp",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): approve_timestamp = [%s]\n",csTmp));
		PutField_CString(hReq,"approve_timestamp",csTmp);
	}
		/* create_user */
	if (GetField_CString(hRequest,"create_user",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): create_user = [%s]\n",csTmp));
		PutField_CString(hReq,"create_user",csTmp);
	}
		/* update_user */
	if (GetField_CString(hRequest,"update_user",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): update_user = [%s]\n",csTmp));
		PutField_CString(hReq,"update_user",csTmp);
	}
		/* post_user */
	if (GetField_CString(hRequest,"post_user",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): post_user = [%s]\n",csTmp));
		PutField_CString(hReq,"post_user",csTmp);
	}
		/* approve_user */
	if (GetField_CString(hRequest,"approve_user",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): approve_user = [%s]\n",csTmp));
		PutField_CString(hReq,"approve_user",csTmp);
	}
	/*
	else {
		PutField_Int(hContext,"internal_error",INT_ERR);
ERRLOG("TxnMgtOnUsJLC::Authorize() can't find PSP ID\n");
		iRet = INT_ERR;
	}
	*/
	
	
	DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): csPspId = [%s]\n",csPspId));

	iRet = INT_ERR;

	if (iRet == PD_OK) {
		csHandler = (char*) malloc (20);
		sprintf(csHandler,"TxnMgtOnUs2%s",csPspId);
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize() Txn Object [%s]\n",csHandler));
		TxnObjPtr = CreateObj(TxnPtr,csHandler,"Authorize");
		FREE_ME(csHandler);
		iRet = (unsigned long)(*TxnObjPtr)(hContext,hReq,hRps);
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize() iRet = [%d]\n",iRet));	
	}

	if (iRet == PD_OK) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize() Format Sucess Resp\n"));
		if (GetField_CString(hContext,"local_tm_date",&csTmp)) {
			PutField_CString(hResponse,"local_tm_date",csTmp);
			DEBUGLOG(("TxnMgtOnUsJLC::Authorize() Format local_tm_date = [%s]\n",csTmp));
		}
		if (GetField_CString(hContext,"local_tm_time",&csTmp)) {
			PutField_CString(hResponse,"local_tm_time",csTmp);
			DEBUGLOG(("TxnMgtOnUsJLC::Authorize() Format local_tm_time = [%s]\n",csTmp));
		}

		if (GetField_Double(hContext,"net_amt",&dTmp)) {
			dtoc(dTmp,PD_DIGIT_LEN,0,csTmp);
			trim_leading_zero(csValue,csTmp);
			PutField_CString(hResponse,"net_amount",csValue);
			PutField_Double(hResponse,"net_amt",dTmp);
			DEBUGLOG(("TxnMgtOnUsJLC::Authorize() Format net_amt = [%s]\n",csValue));
		}

		if (GetField_CString(hContext,"based_ccy",&csTmp)) {
			PutField_CString(hResponse,"net_ccy",csTmp);
DEBUGLOG(("TxnMgtOnUsJLC::Authorize() Format net_ccy = [%s]\n",csTmp));
		}
		if (GetField_CString(hContext,"redirect_url",&csTmp)) {
			PutField_CString(hResponse,"redirect_url",csTmp);
DEBUGLOG(("TxnMgtOnUsJLC::Authorize() Format redirect_url = [%s]\n",csTmp));
		}
	}

	FREE_ME(csTmp);
	FREE_ME(csPspId);
	
	hash_destroy(hReq);
	hash_destroy(hRps);
	FREE_ME(hReq);
	FREE_ME(hRps);
DEBUGLOG(("TxnMgtOnUsJLC::Authorize() Normal exit iret = [%d]\n",iRet));	
	return iRet;
}
int     CreateTxn(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
	int 	iRet = PD_OK;
DEBUGLOG(("TxnMgtOnUsJLC::CreateTxn()\n"));
/* Get ReserveAmount */
DEBUGLOG(("TxnMgtOnUsJLC::CreateTxn():: Call BOReserve\n"));
	BOObjPtr = CreateObj(BOPtr,"BOReserve","GetReserveAmount");
        iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnMgtOnUsJLC::CreateTxn():: GetReserve result = [%d]\n",iRet));

	if (iRet == PD_OK) {

DEBUGLOG(("TxnMgtOnUsJLC::CreateTxn():: Call BOReserve\n"));
	BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
        iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnMgtOnUsJLC::CreateTxn():: GetTxnFee result = [%d]\n",iRet));
	}
	
/* precal psp fee if define */
	if (iRet == PD_OK) {
		/* Update Stat */
DEBUGLOG(("TxnMgtOnUsJLC::CreateTxn():: Call BOPsp CalPspFee\n"));
                BOObjPtr = CreateObj(BOPtr,"BOPsp","CalPspFee");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnMgtOnUsJLC::CreateTxn():: BOStat::CalPspFee() result = [%d]\n",iRet));
	}

	if (iRet == PD_OK) {
		/* Update Balance */
DEBUGLOG(("TxnMgtOnUsJLC::CreateTxn():: Call BOBalance\n"));
                BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdateTxnAmount");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnMgtOnUsJLC::CreateTxn():: updatetxnamount result = [%d]\n",iRet));
	}


	if (iRet == PD_OK) {
		/* Update Stat */
DEBUGLOG(("TxnMgtOnUsJLC::CreateTxn():: Call BOStat\n"));
                BOObjPtr = CreateObj(BOPtr,"BOStat","UpdateDspStat");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnMgtOnUsJLC::CreateTxn():: BOStat::UpdateDspStat() result = [%d]\n",iRet));
	}

	if (iRet == PD_OK) {
		/* Update Stat */
DEBUGLOG(("TxnMgtOnUsJLC::CreateTxn():: Call BOStat\n"));
                BOObjPtr = CreateObj(BOPtr,"BOStat","UpdateDspMerchantStat");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnMgtOnUsJLC::CreateTxn():: BOStat::UpdateDspMerchantStat() result = [%d]\n",iRet));
	}


DEBUGLOG(("TxnMgtOnUsJLC::CreateTxn() Normal exit iret = [%d]\n",iRet));	
	return iRet;
}
