/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/05/18              Simon Fung
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtOnUsJLC.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMgtOnUsJLC(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
  int     iRet = PD_OK;
	char*	csTmp = NULL;
	int	iTmp;
	char	cTmp;
	char cStatus;
	//double 	dTmp;
	double dTxnAmt;
	hash_t	*hReq;
	char* csLineCnt = NULL;
	//char* csBaseCcyCnt = NULL;
	int iLineCnt;
	//int iBaseCcyCnt;
	int iLineTmp;
	//int iBaseCcyTmp;
	char csName[PD_TMP_MSG_BUF_LEN];
	
	char*	csJnlNo = NULL;
	int iLineNo;	
	char* csTxnCcy;
	char* csBaseCcy;
	double dFxRate;
	double dConvertAmt;
	int iDisabled;
	char* csCreateUser;
	char* csTxnDate;

	hReq = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hReq,0);
	
	hash_t *hBaseCcy;

	recordset_t *rsBaseCcy;
	rsBaseCcy = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rsBaseCcy,0);	
	// Get All Base Currencies for conversion
	DBObjPtr = CreateObj(DBPtr,"DBCrrBaseCurrency","GetAllCcy");
	(unsigned long)((*DBObjPtr)(rsBaseCcy));

	DEBUGLOG(("TxnMgtOnUsJLC::Authorize()\n"));

  //return PD_ERR;

		// jnl_id //
	/*
	if (GetField_CString(hRequest,"jnl_id",&csJnlNo)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): jnl_id (provided) = [%s]\n",csJnlNo));
		PutField_CString(hReq,"jnl_id",csJnlNo);
	} else {	
		// Generate Journal No.
		DBObjPtr = CreateObj(DBPtr,"DBCrrJnlHeaderSeq","GetNextCrrJnlHeaderSeq");
		csJnlNo  = strdup((*DBObjPtr)());
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): jnl_id (generated) = [%s]\n",csJnlNo));
		PutField_CString(hReq,"jnl_id",csJnlNo);
	}
	*/
	if (GetField_CString(hContext,"txn_seq",&csJnlNo)) {
		DEBUGLOG(("TxnMgtOnUsJLC:: jnl_id = [%s]\n",csJnlNo));
		PutField_CString(hReq,"jnl_id",csJnlNo);	
		
		// Add to response for return
		PutField_CString(hResponse,"jnl_id",csJnlNo);
	} else {
		iRet = PD_ERR;
		DEBUGLOG(("TxnMgtOnUsJLC:: missing jnl_id\n"));
		PutField_Int(hContext,"internal_error",INT_JL_INVALID_MSG_FORMAT);
	}		
	
		// jnl_type_id //
	if (GetField_CString(hRequest,"jnl_type_id",&csTmp)) {
		iTmp = atoi(csTmp);
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): jnl_type_id = [%d]\n",iTmp));
		PutField_Int(hReq,"jnl_type_id",iTmp);
	}
		// description //
	if (GetField_CString(hRequest,"description",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): description = [%s]\n",csTmp));
		PutField_CString(hReq,"description",csTmp);
	}
		// txn_date //
	if (GetField_CString(hRequest,"txn_date",&csTxnDate)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): txn_date = [%s]\n",csTxnDate));
		PutField_CString(hReq,"txn_date",csTxnDate);
	}
		// bank_update_date //
	if (GetField_CString(hRequest,"bank_update_date",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): bank_update_date = [%s]\n",csTmp));
		PutField_CString(hReq,"bank_update_date",csTmp);
	}
		// acc_year //
	if (GetField_CString(hRequest,"acc_year",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): acc_year = [%s]\n",csTmp));
		PutField_CString(hReq,"acc_year",csTmp);
	}
		// acc_month //
	if (GetField_CString(hRequest,"acc_month",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): acc_month = [%s]\n",csTmp));
		PutField_CString(hReq,"acc_month",csTmp);
	}
	
		// country_code //
	if (GetField_CString(hRequest,"country_code",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): country_code = [%s]\n",csTmp));
		PutField_CString(hReq,"country_code",csTmp);
	}
	
		// product_code //
	if (GetField_CString(hRequest,"product_code",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): product_code = [%s]\n",csTmp));
		PutField_CString(hReq,"product_code",csTmp);
	}
			
		// ref_no //
	if (GetField_CString(hRequest,"ref_no",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): ref_no = [%s]\n",csTmp));
		PutField_CString(hReq,"ref_no",csTmp);
	}
		// remarks //
	if (GetField_CString(hRequest,"remarks",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): remarks = [%s]\n",csTmp));
		PutField_CString(hReq,"remarks",csTmp);
	}
		// status //
	if (GetField_CString(hRequest,"status",&csTmp)) {
		//cTmp = (char) csTmp;
		cTmp = csTmp[0];
		cStatus = cTmp;
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): status = [%c]\n",cTmp));
		PutField_Char(hReq,"status",cTmp);
	}
		// disabled //
	if (GetField_CString(hRequest,"disabled",&csTmp)) {
		iTmp = atoi(csTmp);
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): disabled = [%d]\n",iTmp));
		PutField_Int(hReq,"disabled",iTmp);
	}
		// create_user //
	if (GetField_CString(hRequest,"create_user",&csCreateUser)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): create_user = [%s]\n",csCreateUser));
		PutField_CString(hReq,"create_user",csCreateUser);
	}
		// update_user //
	if (GetField_CString(hRequest,"update_user",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): update_user = [%s]\n",csTmp));
		PutField_CString(hReq,"update_user",csTmp);
	}
		// approve_user //
	if (GetField_CString(hRequest,"approve_user",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): approve_user = [%s]\n",csTmp));
		PutField_CString(hReq,"approve_user",csTmp);
	} else {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): approve_user = [%s]\n",csCreateUser));
		PutField_CString(hReq,"approve_user",csCreateUser);		
	}

		// line_count //
	if (GetField_CString(hRequest,"line_count",&csLineCnt)) {
		iLineCnt = atoi(csLineCnt);
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): line_count = [%d]\n",iLineCnt));
		PutField_Int(hReq,"line_count",iLineCnt);
	}	else {
		DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): No Journal Detail\n"));
		iRet = PD_ERR;
		//sprintf(csResponseCode, "%d", INT_JL_INVALID_MSG_FORMAT);
		PutField_Int(hContext,"internal_error",INT_JL_INVALID_MSG_FORMAT);
		//PutField_CString(hResponse,"response_code",csResponseCode);
	}

	
	if(iRet==PD_OK) {
		
		// Insert Journal Header
		DBObjPtr = CreateObj(DBPtr,"DBCrrJnlHeader","Add");
		iRet = (unsigned long) ((*DBObjPtr)(hReq));			

		if(iRet==PD_OK) {

			strcpy(csName,""); 
			
				// jnl_id //
			/*
			if (GetField_CString(hRequest,"jnl_id",&csTmp)) {
				DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): jnl_id = [%s]\n",csTmp));
				PutField_CString(hReq,"jnl_id",csTmp);
			}
			*/		
			
			// Get Journal Details (multiple) //		
			for (iLineTmp=1;iLineTmp<=iLineCnt;iLineTmp++) {
				//DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): Inside Loop \n"));
				
				// Convert to string
				sprintf(csLineCnt,"%d",iLineTmp);
				
				
				// Concat the parameter name

				// Generate Line No.
				DBObjPtr = CreateObj(DBPtr,"DBCrrJnlDetail","GetNextLineNo");
				iLineNo  = (unsigned long)((*DBObjPtr)(csJnlNo));
				DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): JnlId = [%s], line_no (generated) = [%d]\n",csJnlNo, iLineNo));
				PutField_Int(hReq,"line_no",iLineNo);
				
				// gl_id //
				strcpy(csName, "jd2");
				strcat(csName, "_");
				strcat(csName, csLineCnt);		
				DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): Getting %s \n",csName));
				if (GetField_CString(hRequest,csName,&csTmp)) {
					iTmp = atoi(csTmp);
					DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): %s = [%d]\n",csName, iTmp));
					PutField_Int(hReq,"gl_id",iTmp);
				}
				
					// currency_id //
				strcpy(csName, "jd3");
				strcat(csName, "_");
				strcat(csName, csLineCnt);		
				DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): Getting %s \n",csName));
				if (GetField_CString(hRequest,csName,&csTxnCcy)) {
					DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): %s = [%s]\n",csName, csTxnCcy));
					PutField_CString(hReq,"currency_id",csTxnCcy);
				}
					// txn_amt //
				strcpy(csName, "jd4");
				strcat(csName, "_");
				strcat(csName, csLineCnt);		
				DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): Getting %s \n",csName));
				if (GetField_CString(hRequest,csName,&csTmp)) {
					dTxnAmt = atof(csTmp);
					DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): %s = [%f]\n",csName, dTxnAmt));
					PutField_Double(hReq,"txn_amt",dTxnAmt);
				}
					// cr_ind //
				strcpy(csName, "jd5");
				strcat(csName, "_");
				strcat(csName, csLineCnt);		
				DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): Getting %s \n",csName));
				if (GetField_CString(hRequest,csName,&csTmp)) {
					cTmp = csTmp[0];
					DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): %s = [%c]\n",csName, cTmp));
					PutField_Char(hReq,"cr_ind",cTmp);
				}

					// remarks //
				strcpy(csName, "jd6");
				strcat(csName, "_");
				strcat(csName, csLineCnt);		
				DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): Getting %s \n",csName));
				if (GetField_CString(hRequest,csName,&csTmp)) {
					DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): %s = [%s]\n",csName, csTmp));
					PutField_CString(hReq,"jd_remarks",csTmp);
				}

					// disabled //
				strcpy(csName, "jd7");
				strcat(csName, "_");
				strcat(csName, csLineCnt);		
				DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): Getting %s \n",csName));
				if (GetField_CString(hRequest,csName,&csTmp)) {
					iDisabled = atoi(csTmp);
					DEBUGLOG(("TxnMgtOnUsJLC::Authorize(): %s = [%d]\n",csName, iDisabled));
					PutField_Int(hReq,"disabled",iDisabled);
				}			
				
				// Insert Journal Details
				DBObjPtr = CreateObj(DBPtr,"DBCrrJnlDetail","Add");
				iRet = (unsigned long) ((*DBObjPtr)(hReq));	
				
				if(iRet!=PD_OK) {
					DEBUGLOG(("TxnMgtOnUsJLC::CrrJnlDetail->Add Failed\n"));
					break;
				} else {
					DEBUGLOG(("TxnMgtOnUsJLC::CrrJnlDetail->Add Success\n"));

					DEBUGLOG(("TxnMgtOnUsJLC::CrrJnlDetailAmt->Add Start\n"));

					hBaseCcy = RecordSet_GetFirst(rsBaseCcy);
				
					while (hBaseCcy) {
						if (GetField_CString(hBaseCcy,"ccy",&csBaseCcy)) {
							if (strcmp(csBaseCcy,csTxnCcy)) {
								// Get FX rate
								BOObjPtr = CreateObj(DBPtr,"BOExchange","GetExternalExchangeRateByDate");
								dFxRate = 0.0;
								dConvertAmt = 0.0;
								if ((*BOObjPtr)(csTxnDate,csTxnCcy,csBaseCcy,dTxnAmt,&dFxRate,&dConvertAmt) == PD_OK) {
									DEBUGLOG(("TxnMgtOnUsJLC: ex rate = [%lf] ex amt = [%lf]\n",dFxRate,dConvertAmt));
									DBObjPtr = CreateObj(DBPtr,"DBCrrJnlDetailAmt","Add");
									iRet = (unsigned long)(*DBObjPtr)(csJnlNo, iLineNo, csBaseCcy, dFxRate, dConvertAmt,	iDisabled, csCreateUser);

									if (iRet!=PD_OK) {
										DEBUGLOG(("TxnMgtOnUsJLC::CrrJnlDetailAmt->Add Failed at detail [%d-%s]\n",iLineNo,csBaseCcy));
										break;
									} else {
										DEBUGLOG(("TxnMgtOnUsJLC::CrrJnlDetailAmt->Add Success at detail [%d-%s]\n",iLineNo,csBaseCcy));
									}
								} else {
									DEBUGLOG(("TxnMgtOnUsJLC::CrrJnlDetailAmt->Fail to get FX rate at detail [%d-%s]\n",iLineNo,csBaseCcy));
									break;
								}
							}
						}
						hBaseCcy = RecordSet_GetNext(rsBaseCcy);
					} // while
						
					FREE_ME(hBaseCcy);
					
					// break for converted error
					if (iRet!=PD_OK) {
						break;
					}
				
				}	// if
			} // for
			
			if(iRet==PD_OK) {
				DEBUGLOG(("TxnMgtOnUsJLC::CrrJnlHeader->Add Success\n"));
					
				if (cStatus=='A') {
					// Approve Journal Details
					DBObjPtr = CreateObj(DBPtr,"DBCrrJnlHeader","Approve");
					iRet = (unsigned long) ((*DBObjPtr)(hReq));						

					if(iRet!=PD_OK) {				
						DEBUGLOG(("TxnMgtOnUsJLC::CrrJnlHeader->Approve Failed\n"));					
					} else {					
						DEBUGLOG(("TxnMgtOnUsJLC::CrrJnlHeader->Approve Success\n"));
					}
				}
			} else {
				DEBUGLOG(("TxnMgtOnUsJLC::CrrJnlHeader->Add Failed\n"));	
			}			 					
		} else {
			DEBUGLOG(("TxnMgtOnUsJLC::CrrJnlHeader->Add Failed\n"));	
		}			 	
	}
	else{
		DEBUGLOG(("TxnMgtOnUsJLC::CrrJnlHeader->Add Failed\n"));	
	}

	
	hash_destroy(hReq);
	FREE_ME(hReq);
	RecordSet_Destroy(rsBaseCcy);
	
	DEBUGLOG(("TxnMgtOnUsJLC::Authorize() Before exit = [%d]\n",iRet));	
	
	DEBUGLOG(("TxnMgtOnUsJLC::Authorize() Normal exit iret = [%d]\n",iRet));	
	return iRet;
}
