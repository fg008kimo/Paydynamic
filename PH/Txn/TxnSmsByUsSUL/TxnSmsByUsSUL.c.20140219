/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/11              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnSmsByUsSUL.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnSmsByUsSUL(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int iRet = PD_OK;
	int iTmpRet;
	char *csTmp = NULL;

	hash_t *hSms;
	hSms = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hSms, 0);

	hash_t *hText;
	hText = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hText, 0);

	hash_t *hRec;
	hRec = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRec, 0);

	char *csBaid;
	double dBal = 0;
	double dTxnAmt;
	char *csTxnCcy;
	char csTxnDateTime[PD_DATETIME_LEN + 1];

DEBUGLOG(("TxnSmsByUsSul:: Authorize\n"));

	// txn id
	if (iRet == PD_OK) {
		if (GetField_CString(hContext, "txn_seq", &csTmp)) {
			PutField_CString(hSms, "txn_id", csTmp);
DEBUGLOG(("Authorize:: txn_id = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: txn_id not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: txn_id not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// sender
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "sender", &csTmp)) {
			PutField_CString(hSms, "sender", csTmp);
DEBUGLOG(("Authorize:: sender = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: sender not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: sender not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// text
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "text", &csTmp)) {
			PutField_CString(hSms, "text", csTmp);
DEBUGLOG(("Authorize:: text = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: text not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: text not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// scts
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "scts", &csTmp)) {
			PutField_CString(hSms, "scts", csTmp);
DEBUGLOG(("Authorize:: scts = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: scts not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: scts not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// tag
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "tag", &csTmp)) {
			PutField_CString(hSms, "tag", csTmp);
DEBUGLOG(("Authorize:: tag = [%s]\n", csTmp));
		}
	}

	// has_missing_parts
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "has_missing_parts", &csTmp)) {
			PutField_CString(hSms, "has_missing_parts", csTmp);
DEBUGLOG(("Authorize:: has_missing_parts = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: has_missing_parts not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: has_missing_parts not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// smsc
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "smsc", &csTmp)) {
			PutField_CString(hSms, "smsc", csTmp);
DEBUGLOG(("Authorize:: smsc = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: smsc not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: smsc not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// ref_num
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "ref_num", &csTmp)) {
			PutField_CString(hSms, "ref_num", csTmp);
DEBUGLOG(("Authorize:: ref_num = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: ref_num not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: ref_num not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// sender_num_type
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "sender_num_type", &csTmp)) {
			PutField_CString(hSms, "sender_num_type", csTmp);
DEBUGLOG(("Authorize:: sender_num_type = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: sender_num_type not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: sender_num_type not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// seq_num
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "seq_num", &csTmp)) {
			PutField_CString(hSms, "seq_num", csTmp);
DEBUGLOG(("Authorize:: seq_num = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: seq_num not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: seq_num not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// total
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "total", &csTmp)) {
			PutField_CString(hSms, "total", csTmp);
DEBUGLOG(("Authorize:: total = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: total not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: total not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// ip_addr
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "ip_addr", &csTmp)) {
			PutField_CString(hSms, "req_ip", csTmp);
DEBUGLOG(("Authorize:: ip_address = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: ip_address not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: ip_address not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// create_user
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "create_user", &csTmp)) {
			PutField_CString(hSms, "create_user", csTmp);
DEBUGLOG(("Authorize:: create_user = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: create_user not found!! default = [%s]\n", PD_UPDATE_USER));
			PutField_CString(hSms, "create_user", PD_UPDATE_USER);
		}
	}

	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: call BOOLSms::ProcessSmsText()\n"));
		BOObjPtr = CreateObj(BOPtr, "BOOLSms", "ProcessSmsText");
		iTmpRet = (unsigned long)(*BOObjPtr)(hSms, hText);
		if (iTmpRet != PD_OK) {
DEBUGLOG(("Authorize:: call BOOLSms::ProcessSmsText() failed\n"));
			iRet = PD_ERR;
		}
	}

	if (iRet == PD_OK) {
		// insert into stmt detail
DEBUGLOG(("Authorize:: call DBOLStatement::AddSmsDetail()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "AddSmsDetail");
		iTmpRet = (unsigned long)(*DBObjPtr)(hSms, hText);
		if (iTmpRet != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLStatement::AddSmsDetail() failed\n"));
			PutField_CString(hText, "req_status", "FAILED");
			iRet = PD_ERR;
		}
	}

	if (iRet == PD_OK) {
// for add ol_txn_header
		if (iRet == PD_OK) {
			PutField_Int(hRec, "db_commit", PD_FALSE);

			// txn_id
			GetField_CString(hContext, "txn_seq", &csTmp);
			PutField_CString(hRec, "txn_seq", csTmp);

			// input_channel
			GetField_CString(hContext, "channel_code", &csTmp);
			PutField_CString(hRec, "channel_code", csTmp);

			// status
			PutField_Char(hRec, "status", PD_TO_PSP);

			// txn_code
			GetField_CString(hContext, "txn_code", &csTmp);
			PutField_CString(hRec, "txn_code", csTmp);

			// process_type
			if (GetField_CString(hRequest, "process_type", &csTmp)) {
				PutField_CString(hRec, "process_type", csTmp);
			}

			// process_code
			if (GetField_CString(hRequest, "process_code", &csTmp)) {
				PutField_CString(hRec, "process_code", csTmp);
			}

			// host_posting_date
			if (GetField_CString(hContext, "PHDATE", &csTmp)) {
				PutField_CString(hRec, "host_posting_date", csTmp);
			}

			// internal_code
			PutField_Int(hRec, "internal_code", 0);

			// response_code
			PutField_CString(hRec, "response_code", "0");

			// transaction_amount
			GetField_CString(hText, "req_bank_amount", &csTmp);
			dTxnAmt = atof(csTmp);
			PutField_Double(hRec, "txn_amt", dTxnAmt);

			// deposit_amount
			PutField_Double(hRec, "deposit_amt", dTxnAmt);

			// display_amount
			PutField_Double(hRec, "display_amt", dTxnAmt);

			// local_tm_date
			if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
				PutField_CString(hRec, "local_tm_date", csTmp);
				strcpy(csTxnDateTime, csTmp);
				PutField_CString(hRec, "transmission_datetime", csTxnDateTime);
				PutField_CString(hRec, "tm_date", csTmp);
			}

			// local_tm_time
			if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
				PutField_CString(hRec, "local_tm_time", csTmp);
				strcat(csTxnDateTime, csTmp);
				PutField_CString(hRec, "transmission_datetime", csTxnDateTime);
				PutField_CString(hRec, "tm_time", csTmp);
			}

			// create_user
			PutField_CString(hRec, "add_user", PD_UPDATE_USER);

			// client_ip
			if (GetField_CString(hRequest, "ip_addr", &csTmp)) {
				PutField_CString(hRec, "ip_addr", csTmp);
			}

			// service_code
			PutField_CString(hRec, "service_code", "LBT");

DEBUGLOG(("Authorize() call DBOLTransaction::Add()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Add");
			iTmpRet = (unsigned long)(*DBObjPtr)(hRec);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLTransaction::Add() failed\n"));
				PutField_CString(hText, "req_status", "FAILED");
				iRet = PD_ERR;
			}
		}

// for add ol_txn_psp_detail
		if (iRet == PD_OK) {
			// psp_id
			GetField_CString(hText, "psp_id", &csTmp);
			PutField_CString(hRec, "psp_id", csTmp);

			// baid
			GetField_CString(hText, "baid", &csBaid);
			PutField_CString(hRec, "baid", csBaid);

			// txn_ccy
			GetField_CString(hText, "acct_ccy", &csTxnCcy);
			PutField_CString(hRec, "txn_ccy", csTxnCcy);

			// txn_amount
			PutField_Double(hRec, "txn_amount", dTxnAmt);

			// txn_date
			GetField_CString(hText, "req_bank_date", &csTmp);
			PutField_CString(hRec, "txn_date", csTmp);

			// txn_time
			GetField_CString(hText, "req_bank_time", &csTmp);
			PutField_CString(hRec, "txn_time", csTmp);

			// bank_code
			GetField_CString(hText, "int_bank_code", &csTmp);
			PutField_CString(hRec, "bank_code", csTmp);

			// bank_acct_num
			GetField_CString(hText, "full_bank_acct_num", &csTmp);
			PutField_CString(hRec, "bank_acct_num", csTmp);

			// cost
			PutField_Double(hRec, "cost", 0.0);

			// open_bal
			PutField_Double(hRec, "open_bal", 0.0);

			// total_hold
			PutField_Double(hRec, "total_hold", 0.0);

			// bal
			dBal += dTxnAmt;
			PutField_Double(hRec, "bal", dBal);

			// pending_fund
			PutField_Double(hRec, "pending_fund", 0.0);

			// process_group
			PutField_Char(hRec, "process_group", 'S');

			// customer_text
			if (GetField_CString(hText, "customer_text", &csTmp)) {
				PutField_CString(hRec, "customer_text", csTmp);
			}

			// sender_name
			if (GetField_CString(hText, "sender_name", &csTmp)) {
				PutField_CString(hRec, "sender_name", csTmp);
			}

			// txn_ref_num
			if (GetField_CString(hText, "txn_ref_num", &csTmp)) {
				PutField_CString(hRec, "txn_ref_num", csTmp);
			}

DEBUGLOG(("Authorize() call DBOLTxnPspDetail::Add()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Add");
			iTmpRet = (unsigned long)(*DBObjPtr)(hRec);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLTxnPspDetail::Add() failed\n"));
				PutField_CString(hText, "req_status", "FAILED");
				iRet = PD_ERR;
			}
		}

// for add ol_txn_elements
		if (iRet == PD_OK) {
			// txn_element_type
			PutField_CString(hRec, "txn_element_type", PD_ELEMENT_TXN_AMT);

			// amount
			PutField_Double(hRec, "amount", dTxnAmt);

			// ccy
			PutField_CString(hRec, "ccy", csTxnCcy);

			// amt_type
			GetField_CString(hText, "amt_type", &csTmp);
			PutField_CString(hRec, "amount_type", csTmp);

			// party_type
			PutField_Char(hRec, "party_type", PD_TYPE_PSP);

DEBUGLOG(("Authorize() call DBOLTxnElements::Add()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLTxnElements", "Add");
			iTmpRet = (unsigned long)(*DBObjPtr)(hRec);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLTxnElements::Add() failed\n"));
				PutField_CString(hText, "req_status", "FAILED");
				iRet = PD_ERR;
			}
		}

// for update ol_txn_header
		if (iRet == PD_OK) {
			// status
			PutField_Char(hRec, "status", PD_COMPLETE);

			// ar_ind
			PutField_Char(hRec, "ar_ind", PD_ACCEPT);

			// sub_status
			PutField_CString(hRec, "sub_status", PD_UNALLOCATED);

			// net_amt
			PutField_Double(hRec, "net_amt", dTxnAmt);

			// net_ccy
			PutField_CString(hRec, "net_ccy", csTxnCcy);

			// approval_date
			if (GetField_CString(hContext, "PHDATE", &csTmp)) {
				PutField_CString(hRec, "approval_date", csTmp);
			}

			// approval_timestamp
			DBObjPtr = CreateObj(DBPtr, "DBSystemControl", "GetApprovalDT");
			(*DBObjPtr)(hRec);

DEBUGLOG(("Authorize() call DBOLTransaction::Update()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
			iTmpRet = (unsigned long)(*DBObjPtr)(hRec);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLTransaction::Update() failed\n"));
				PutField_CString(hText, "req_status", "FAILED");
				iRet = PD_ERR;
			}
		}

		hash_destroy(hRec);
		FREE_ME(hRec);
	}

	// insert into sms txn log
DEBUGLOG(("Authorize:: call DBOLSmsTxnLog::Add()\n"));
	DBObjPtr = CreateObj(DBPtr, "DBOLSmsTxnLog", "Add");
	iTmpRet = (unsigned long)(*DBObjPtr)(hSms, hText);
	if (iTmpRet != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLSmsTxnLog::Add() failed\n"));
		iRet = PD_ERR;
	} else {
		iRet = PD_OK;
	}

	hash_destroy(hSms);
	FREE_ME(hSms);
	hash_destroy(hText);
	FREE_ME(hText);

DEBUGLOG(("Authorize() iRet = [%d]\n", iRet));
	return iRet;
}
