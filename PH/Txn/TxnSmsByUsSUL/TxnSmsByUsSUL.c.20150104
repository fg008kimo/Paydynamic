/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/11              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnSmsByUsSUL.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnSmsByUsSUL(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int iRet = PD_OK;
	int iTmpRet;
	char *csTmp = NULL;

	hash_t *hSms;
	hSms = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hSms, 0);

	hash_t *hText;
	hText = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hText, 0);

	hash_t *hRec;
	hRec = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRec, 0);

	char *csBaid;
	double dTxnAmt;
	char *csTxnCcy;
	char csTxnDateTime[PD_DATETIME_LEN + 1];
	char csBaidTxnSeq[PD_TXN_SEQ_LEN + 1];
	char csStmtTxnSeq[PD_TXN_SEQ_LEN + 1];

DEBUGLOG(("TxnSmsByUsSul:: Authorize\n"));

	// sender
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "sender", &csTmp)) {
			PutField_CString(hSms, "sender", csTmp);
DEBUGLOG(("Authorize:: sender = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: sender not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: sender not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// text
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "text", &csTmp)) {
			PutField_CString(hSms, "text", csTmp);
DEBUGLOG(("Authorize:: text = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: text not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: text not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// scts
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "scts", &csTmp)) {
			PutField_CString(hSms, "scts", csTmp);
DEBUGLOG(("Authorize:: scts = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: scts not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: scts not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// tag
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "tag", &csTmp)) {
			PutField_CString(hSms, "tag", csTmp);
DEBUGLOG(("Authorize:: tag = [%s]\n", csTmp));
		}
	}

	// has_missing_parts
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "has_missing_parts", &csTmp)) {
			PutField_CString(hSms, "has_missing_parts", csTmp);
DEBUGLOG(("Authorize:: has_missing_parts = [%s]\n", csTmp));
		}/* else {
DEBUGLOG(("Authorize:: has_missing_parts not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: has_missing_parts not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}*/
	}

	// smsc
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "smsc", &csTmp)) {
			PutField_CString(hSms, "smsc", csTmp);
DEBUGLOG(("Authorize:: smsc = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: smsc not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: smsc not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

	// ref_num
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "ref_num", &csTmp)) {
			PutField_CString(hSms, "ref_num", csTmp);
DEBUGLOG(("Authorize:: ref_num = [%s]\n", csTmp));
		}/* else {
DEBUGLOG(("Authorize:: ref_num not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: ref_num not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}*/
	}

	// sender_num_type
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "sender_num_type", &csTmp)) {
			PutField_CString(hSms, "sender_num_type", csTmp);
DEBUGLOG(("Authorize:: sender_num_type = [%s]\n", csTmp));
		}/* else {
DEBUGLOG(("Authorize:: sender_num_type not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: sender_num_type not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}*/
	}

	// seq_num
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "seq_num", &csTmp)) {
			PutField_CString(hSms, "seq_num", csTmp);
DEBUGLOG(("Authorize:: seq_num = [%s]\n", csTmp));
		}/* else {
DEBUGLOG(("Authorize:: seq_num not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: seq_num not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}*/
	}

	// total
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "total", &csTmp)) {
			PutField_CString(hSms, "total", csTmp);
DEBUGLOG(("Authorize:: total = [%s]\n", csTmp));
		}/* else {
DEBUGLOG(("Authorize:: total not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: total not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}*/
	}

	// ip_addr
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "ip_addr", &csTmp)) {
			PutField_CString(hSms, "req_ip", csTmp);
DEBUGLOG(("Authorize:: ip_address = [%s]\n", csTmp));
		}/* else {
DEBUGLOG(("Authorize:: ip_address not found!!\n"));
ERRLOG("TxnSmsByUsSul:: Authorize:: ip_address not found!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}*/
	}

	// create_user
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "create_user", &csTmp)) {
			PutField_CString(hSms, "create_user", csTmp);
DEBUGLOG(("Authorize:: create_user = [%s]\n", csTmp));
		} else {
DEBUGLOG(("Authorize:: create_user not found!! default = [%s]\n", PD_UPDATE_USER));
			PutField_CString(hSms, "create_user", PD_UPDATE_USER);
		}
	}

	// process sms text
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: call BOOLSms::ProcessSmsText()\n"));
		BOObjPtr = CreateObj(BOPtr, "BOOLSms", "ProcessSmsText");
		iTmpRet = (unsigned long)(*BOObjPtr)(hSms, hText);
		if (iTmpRet != PD_OK) {
DEBUGLOG(("Authorize:: call BOOLSms::ProcessSmsText() failed\n"));
			iRet = PD_ERR;
		}
	}

	// get stmt_txn_seq
	DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextStmtTxnSeq");
	strcpy(csStmtTxnSeq, (*DBObjPtr)());
	PutField_CString(hText, "stat_txn_id", csStmtTxnSeq);

	// insert into ol_statement_detail
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: call DBOLStatement::AddSmsDetail()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "AddSmsDetail");
		iTmpRet = (unsigned long)(*DBObjPtr)(hSms, hText);
		if (iTmpRet != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLStatement::AddSmsDetail() failed\n"));
			PutField_CString(hText, "req_status", "FAILED");
			iRet = PD_ERR;
		}
	}

	// for add ol_baid_txn
	if (iRet == PD_OK) {
		PutField_Int(hRec, "db_commit", PD_FALSE);

		// get baid_txn_seq
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextBaidTxnSeq");
		strcpy(csBaidTxnSeq, (*DBObjPtr)());
		PutField_CString(hRec, "txn_seq", csBaidTxnSeq);

		// channel_code
		GetField_CString(hContext, "channel_code", &csTmp);
		PutField_CString(hRec, "channel_code", csTmp);

		// status
		PutField_Char(hRec, "status", PD_COMPLETE);

		// ar_ind
		PutField_Char(hRec, "ar_ind", PD_ACCEPT);

		// sub_status
		PutField_CString(hRec, "sub_status", PD_APPROVED);

		// stat_txn_id
		PutField_CString(hRec, "stat_txn_id", csStmtTxnSeq);

		// txn_code
		GetField_CString(hContext, "txn_code", &csTmp);
		PutField_CString(hRec, "txn_code", csTmp);

		// pid
		GetField_CString(hText, "psp_id", &csTmp);
		PutField_CString(hRec, "pid", csTmp);

		// baid
		GetField_CString(hText, "baid", &csBaid);
		PutField_CString(hRec, "baid", csBaid);

		// host_posting_date
		if (GetField_CString(hContext, "PHDATE", &csTmp)) {
			PutField_CString(hRec, "posting_date", csTmp);
		}

		// transmission_datetime
		if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
			strcpy(csTxnDateTime, csTmp);
			PutField_CString(hRec, "transmission_datetime", csTxnDateTime);
		}
		if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
			strcat(csTxnDateTime, csTmp);
			PutField_CString(hRec, "transmission_datetime", csTxnDateTime);
		}

		// txn_ccy
		GetField_CString(hText, "acct_ccy", &csTxnCcy);
		PutField_CString(hRec, "txn_ccy", csTxnCcy);

		// txn_amt
		GetField_CString(hText, "req_bank_amount", &csTmp);
		dTxnAmt = atof(csTmp);
		PutField_Double(hRec, "txn_amt", dTxnAmt);

		// open_bal
		PutField_Double(hRec, "open_bal", 0.0);

		// curr_bal
		PutField_Double(hRec, "curr_bal", 0.0);

		// approval_date & approval_timestamp
		DBObjPtr = CreateObj(DBPtr, "DBSystemControl", "GetApprovalDT");
		(*DBObjPtr)(hRec);

		// bank_code
		GetField_CString(hText, "int_bank_code", &csTmp);
		PutField_CString(hRec, "bank_code", csTmp);

		// bank_acct_num
		GetField_CString(hText, "full_bank_acct_num", &csTmp);
		PutField_CString(hRec, "bank_acct_num", csTmp);

		// pid_txn_hold_ind
		PutField_Int(hRec, "pid_txn_hold_ind", 0);

		// pid_sys_match_ind
		PutField_Int(hRec, "pid_sys_match_ind", 1);

		// posted_ind
		PutField_Int(hRec, "posted_ind", 0);

		// create_user
		PutField_CString(hRec, "add_user", PD_UPDATE_USER);

DEBUGLOG(("Authorize() call DBOLBAIDTxn::Add()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Add");
		iTmpRet = (unsigned long)(*DBObjPtr)(hRec);
		if (iTmpRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLBAIDTxn::Add() failed\n"));
			PutField_CString(hText, "req_status", "FAILED");
			iRet = PD_ERR;
		}

		if (iRet == PD_OK) {
			hash_destroy(hRec);
			hash_init(hRec, 0);

			PutField_Int(hRec, "db_commit", PD_FALSE);

			// update_user
			PutField_CString(hRec, "update_user", PD_UPDATE_USER);

			// txn_id
			PutField_CString(hRec, "txn_id", csBaidTxnSeq);

			// stat_txn_id
			PutField_CString(hRec, "stat_txn_id", csStmtTxnSeq);

DEBUGLOG(("Authorize() call DBOLStatement::UpdateTxnId()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "UpdateTxnId");
			iTmpRet = (unsigned long)(*DBObjPtr)(hRec);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatement::UpdateTxnId() failed\n"));
				PutField_CString(hText, "req_status", "FAILED");
				iRet = PD_ERR;
			}
		}
	}

	// post ol_baid_txn
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: call BOOLBaid::PostBaidTxn()\n"));
		BOObjPtr = CreateObj(BOPtr, "BOOLBaid", "PostBaidTxn");
		iTmpRet = (unsigned long)(*BOObjPtr)(csBaidTxnSeq);
		if (iTmpRet != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLBaid::PostBaidTxn() failed\n"));
			PutField_CString(hText, "req_status", "FAILED");
			iRet = PD_ERR;
		}
	}

	// insert into ol_sms_txn_log
DEBUGLOG(("Authorize:: call DBOLSmsTxnLog::Add()\n"));
	DBObjPtr = CreateObj(DBPtr, "DBOLSmsTxnLog", "Add");
	iTmpRet = (unsigned long)(*DBObjPtr)(hSms, hText);
	if (iTmpRet != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLSmsTxnLog::Add() failed\n"));
		iRet = PD_ERR;
	} else {
		iRet = PD_OK;
		GetField_CString(hText, "req_status", &csTmp);
DEBUGLOG(("Authorize:: req_status = [%s]\n", csTmp));
		PutField_CString(hContext, "req_status", csTmp);

DEBUGLOG(("Authorize:: stat_txn_id = [%s]\n", csStmtTxnSeq));
		PutField_CString(hContext, "stat_txn_id", csStmtTxnSeq);
	}

	hash_destroy(hSms);
	FREE_ME(hSms);
	hash_destroy(hText);
	FREE_ME(hText);
	hash_destroy(hRec);
	FREE_ME(hRec);

DEBUGLOG(("Authorize() iRet = [%d]\n", iRet));
	return iRet;
}
