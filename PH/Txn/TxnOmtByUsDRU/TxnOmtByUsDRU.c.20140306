/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/27              Stan Poon
Add Action Upload, Cancel, Approve		   2013/11/11		   Stan Poon
*/


#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsDRU.h"
#include "myrecordset.h"
#include "math.h"

char cDebug;
OBJPTR(BO);
OBJPTR(DB);

void TxnOmtByUsDRU(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int	iRet = PD_OK;
	char	*csInFileName = NULL, *csInFilePath = NULL, csFileName[PD_TMP_BUF_LEN];
	char	*csMerchantId = NULL, *csIntBankCode = NULL, *csBankAcctNum = NULL, *csUser = NULL;
	char	cAction, cParty;

	char	*csTmp = NULL;
	char	cTmp;
	int	iTmp;
	double	dTmp;
	FILE	*fin = NULL;

	recordset_t *myRec;
	hash_t *hRec;

	PutField_CString(hContext,"input_channel",PD_DEPOSIT_REQUEST_FILE);

/* Action */
	if (GetField_CString(hRequest, "action", &csTmp)) {
		cAction = csTmp[0];
DEBUGLOG(("Authorize() action = [%c]\n",cAction));
		if (cAction == PD_DEPOSIT_FILE_UPLOAD) {
			PutField_Char(hContext,"status",PD_DEPOSIT_FILE_PENDING);
		} else if (cAction == PD_DEPOSIT_FILE_CANCEL) {
			PutField_Char(hContext,"status",PD_DEPOSIT_FILE_DECLINED);
		} else if (cAction == PD_DEPOSIT_FILE_APPROVE) {
			PutField_Char(hContext,"status",PD_DEPOSIT_FILE_APPROVED);
		}

		if (cAction != PD_DEPOSIT_FILE_UPLOAD && cAction != PD_DEPOSIT_FILE_CANCEL && cAction != PD_DEPOSIT_FILE_APPROVE) {
			iRet = INT_ACTION_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() action [%c] not accepted!!\n", cAction));
ERRLOG("TxnOmtByUsDRU::Authorize() action not found!!\n");
		}
	} else {
                iRet = INT_ACTION_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() action not found!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() action not found!!\n");
	}
/* in_file_name */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "in_file_name", &csInFileName)) {
			PutField_CString(hContext,"in_file_name",csInFileName);
			PutField_CString(hContext,"filename",csInFileName);
DEBUGLOG(("Authorize() in_file_name = [%s]\n", csInFileName));
		} else {
			iRet = INT_FILE_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() in_file_name is missing!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() in_file_name is missing!!!\n");
		}
	}
/* Party */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "party", &csTmp)) {
			cParty = csTmp[0];
			PutField_Char(hContext,"party",cParty);
DEBUGLOG(("Authorize() party [%c]\n", cParty));
		} else {
			iRet = INT_PARTY_TYPE_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() party is missing!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() party is missing!!!\n");
		}
	}
/* user */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "add_user", &csUser)) {
			PutField_CString(hContext,"create_user",csUser);
			PutField_CString(hContext,"update_user",csUser);
DEBUGLOG(("Authorize() user = [%s]\n", csUser));
		} else {
			iRet = INT_USER_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() user is missing!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() user is missing!!!\n");
		}
	}
/* ip_addr */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "ip_addr", &csTmp)) {
			PutField_CString(hContext,"ip_addr",csTmp);
DEBUGLOG(("Authorize() ip_addr = [%s]\n", csTmp));
		}
	}



/* 1.get - upload*/
	if (cAction == PD_DEPOSIT_FILE_UPLOAD) {
	/* merchant_id */
		if (iRet == PD_OK) {
			if (GetField_CString(hRequest, "merchant_id", &csMerchantId)) {
				PutField_CString(hContext, "merchant_id", csMerchantId);
DEBUGLOG(("Authorize() merchant_id = [%s]\n", csMerchantId));
			} else {
				iRet = INT_MERCHANT_ID_NOT_FOUND;
				PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() merchant_id is missing!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() merchant_id is missing!!!\n");
			}
		}
	/* int_bank_code */
	/*
		if (iRet == PD_OK) {
			if (GetField_CString(hRequest, "int_bank_code", &csIntBankCode)) {
				PutField_CString(hContext, "int_bank_code", csIntBankCode);
DEBUGLOG(("Authorize() int_bank_code = [%s]\n", csIntBankCode));
			} else {
				iRet = INT_BANK_CODE_NOT_FOUND;
				PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() int_bank_code is missing!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() int_bank_code is missing!!!\n");
			}
		}
	*/
	/* bank_acct_num */
	/*
		if (iRet == PD_OK) {
			if (GetField_CString(hRequest, "bank_acct_num", &csBankAcctNum)) {
				PutField_CString(hContext, "bank_acct_num", csBankAcctNum);
DEBUGLOG(("Authorize() bank_acct_num = [%s]\n", csBankAcctNum));
			} else {
				iRet = INT_BANK_ACCT_NOT_FOUND;
				PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() acct_num is missing!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() acct_num is missing!!!\n");
			}
		}
	*/
	/* in_file_path */
		if (iRet == PD_OK) {
			if (GetField_CString(hRequest, "in_file_path", &csInFilePath)) {
				if (csInFilePath[strlen(csInFilePath)-1] == '/')
					csInFilePath[strlen(csInFilePath)-1] = '\0';
				PutField_CString(hContext,"in_file_path",csInFilePath);
DEBUGLOG(("Authorize() in_file_path = [%s]\n", csInFilePath));
			} else {
				iRet = INT_FILE_NOT_FOUND;
				PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() in_file_path is missing!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() in_file_path is missing!!!\n");
			}
		}
	/* get file */
		if (iRet == PD_OK) {
			snprintf(csFileName,sizeof(csFileName),"%s/%s",csInFilePath,csInFileName);
			fin = fopen(csFileName, "r");
			if (fin == NULL) {
				iRet = INT_FILE_NOT_FOUND;
				PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() cannot open file [%s]!!!\n", csInFileName));
ERRLOG("TxnOmtByUsDRU::Authorize() cannot open file [%s]!!!\n", csInFileName);
			} else {
				PutField_CString(hContext,"in_full_filename",csFileName);
				fclose(fin);
			}
		}
	/* check filename */
		if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLDepositRequest:: CheckFileExist()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLDepositRequest", "CheckFileExist");
			if ((unsigned long)(*DBObjPtr)(csInFileName) != NOT_FOUND) {
				iRet = INT_FILE_ALREADY_EXIST;
				PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call DBOLDepositRequest::CheckFileExist() [%s] file DUPLICATED!!!\n", csInFileName));
// ERRLOG("TxnOmtByUsDRU::Authorize() call DBOLDepositRequest::CheckFileExist() [%s] file DUPLICATED!!!\n", csInFileName);
			} else {
DEBUGLOG(("Authorize() call DBOLDepositRequest::AddHeader()\n"));
				DBObjPtr = CreateObj(DBPtr,"DBOLDepositRequest","AddHeader");
				if ((*DBObjPtr)(hContext) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLDepositRequest::AddHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() call DBOLDepositRequest::AddHeader() FAILURE!!!\n");
				}
			}
		}
/* 1.get - approve,cancel */
	} else if (cAction == PD_DEPOSIT_FILE_APPROVE || cAction == PD_DEPOSIT_FILE_CANCEL) {
	/* remark */
		if (iRet == PD_OK) {
			if (GetField_CString(hRequest, "remark", &csTmp)) {
				PutField_CString(hContext, "remark", csTmp);
DEBUGLOG(("Authorize() remark = [%s]\n", csTmp));
			}
		}
	/* get Deposit Header */
		if (iRet == PD_OK) {
			hRec = (hash_t*) malloc (sizeof(hash_t));
			hash_init(hRec,0);

DEBUGLOG(("Authorize() call DBOLDepositRequest::GetDepositHeader()\n"));
			BOObjPtr = CreateObj(BOPtr, "DBOLDepositRequest", "GetDepositHeader");
			iRet = (unsigned long)(*BOObjPtr)(csInFileName, hRec);
			if (iRet != PD_OK) {
				iRet = INT_INVALID_TXN;
				PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call DBOLDepositRequest::GetDepositHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() call DBOLDepositRequest::GetDepositHeader() FAILURE!!!\n");
			} else {
				if (!GetField_CString(hRec,"merchant_id",&csMerchantId)) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() merchant_id NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() merchant_id NOT FOUND!!!\n");
				} else {
					PutField_CString(hContext,"merchant_id",csMerchantId);
DEBUGLOG(("Authorize() merchant_id = [%s]\n",csMerchantId));
				}
				if (!GetField_CString(hRec,"int_bank_code",&csIntBankCode)) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() int_bank_code NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() int_bank_code NOT FOUND!!!\n");
				} else {
					PutField_CString(hContext,"int_bank_code",csIntBankCode);
DEBUGLOG(("Authorize() int_bank_code = [%s]\n",csIntBankCode));
				}
				if (!GetField_CString(hRec,"bank_acct_num",&csBankAcctNum)) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() bank_acct_num NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() bank_acct_num NOT FOUND!!!\n");
				} else {
					PutField_CString(hContext,"bank_acct_num",csBankAcctNum);
DEBUGLOG(("Authorize() bank_acct_num = [%s]\n",csBankAcctNum));
				}
				if (!GetField_Char(hRec,"party",&cTmp)) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() party NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() party NOT FOUND!!!\n");
				} else if (cTmp != cParty) {
					iRet = INT_INVALID_PARTY_TYPE;
					PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() org party FAILURE!!! [%c]\n",cTmp));
ERRLOG("TxnOmtByUsDRU::Authorize() org party FAILURE!!! [%c]\n",cTmp);
				}
				if (!GetField_Char(hRec,"status",&cTmp)) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() status NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() status NOT FOUND!!!\n");
				} else if (cTmp != PD_DEPOSIT_FILE_PENDING) {
					iRet = INT_FILE_NOT_FOUND;
					PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() org status FAILURE!!! [%c]\n",cTmp));
ERRLOG("TxnOmtByUsDRU::Authorize() org status FAILURE!!! [%c]\n",cTmp);
				}
			}

			hash_destroy(hRec);
			FREE_ME(hRec);
		}
	}



/* 2.get - upload,approve */
	if (cAction == PD_DEPOSIT_FILE_UPLOAD || cAction == PD_DEPOSIT_FILE_APPROVE) {
	/* get service_code, acct_ccy, branch_name, owner_name */
		if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLMerchantBankAcct::FindDetailByAvaMerchBankAcct()\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBankAcct","FindDetailByAvaMerchBankAcct");
			if ((unsigned long)(*DBObjPtr)(csMerchantId,csIntBankCode,csBankAcctNum,hContext) != PD_OK) {
				iRet = INT_BANK_ACCT_NOT_FOUND;
				PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call DBOLMerchantBankAcct::FindDetailByAvaMerchBankAcct() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() call DBOLMerchantBankAcct::FindDetailByAvaMerchBankAcct() FAILURE!!!\n");
			}
		}

	/* get client_id, deposit_requset_ver */
		if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLMerchDetail::GetMerchant()\n"));
			myRec = (recordset_t*) malloc (sizeof(recordset_t));
			recordset_init(myRec, 0);

			DBObjPtr = CreateObj(DBPtr,"DBOLMerchDetail","GetMerchant");
			if ((unsigned long)(*DBObjPtr)(csMerchantId,myRec) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLMerchDetail::GetMerchant() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() call DBOLMerchDetail::GetMerchant() FAILURE!!!\n");
			} else {
				hRec = RecordSet_GetFirst(myRec);
				if (hRec != NULL) {
					if (GetField_CString(hRec,"merchant_client_id",&csTmp)) {
						PutField_CString(hContext,"client_id",csTmp);
DEBUGLOG(("Authorize() client_id = [%s]\n",csTmp));
					}
					if (GetField_Int(hRec,"deposit_req_ver",&iTmp)) {
						PutField_Int(hContext,"deposit_req_ver",iTmp);
DEBUGLOG(("Authorize() deposit_requestV_ver = [%d]\n",iTmp));
					}
				}
			}

			RecordSet_Destroy(myRec);
			FREE_ME(myRec);
		}
	}



/* 3.Process - upload */
	if (cAction == PD_DEPOSIT_FILE_UPLOAD) {
	/* Process Deposit Request */
		if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call BOOLDepositReq::ProcessDepositReq()\n"));
			BOObjPtr = CreateObj(BOPtr, "BOOLDepositReq", "ProcessDepositReq");
			iRet = (unsigned long)(*BOObjPtr)(hContext, hRequest);
			if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call BOOLDepositReq::ProcessDepositReq() SUCCESS\n"));
			} else {
DEBUGLOG(("Authorize() call BOOLDepositReq::ProcessDepositReq() FAILURE!!!\n"));
			}
		}
	/* Result */
		if (!GetField_Int(hContext,"total_count",&iTmp)) {
			PutField_Int(hResponse,"total",0);
		} else {
			PutField_Int(hResponse,"total",iTmp);
		}
		if (!GetField_Int(hContext,"accept_count",&iTmp) || !GetField_Double(hContext,"accept_amount",&dTmp)) {
			PutField_Char(hContext,"status",PD_DEPOSIT_FILE_DECLINED);
			PutField_Int(hResponse,"accept",0);
			PutField_Double(hResponse,"accept_amt",0.0);
		} else {
			PutField_Int(hResponse,"accept",iTmp);
			PutField_Double(hResponse,"accept_amt",dTmp);
		}
/* 3.Process - approve */
	} else if (cAction == PD_DEPOSIT_FILE_APPROVE) {
	/* Confirm Deposit Request */
		if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call BOOLDepositReq::ConfirmDepositReq()\n"));
			BOObjPtr = CreateObj(BOPtr, "BOOLDepositReq", "ConfirmDepositReq");
			iRet = (unsigned long)(*BOObjPtr)(hContext, hRequest);
			if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call BOOLDepositReq::ConfirmDepositReq() SUCCESS\n"));
			} else {
DEBUGLOG(("Authorize() call BOOLDepositReq::ConfirmDepositReq() FAILURE!!!\n"));
			}
		}
	}



/* 4.Update Deposit Header - upload,approve,cancel */
	if (iRet == PD_OK || (cAction == PD_DEPOSIT_FILE_UPLOAD && GetField_Int(hContext,"internal_error",&iTmp))) {
DEBUGLOG(("Authorize() call DBOLDepositRequest::UpdateHeader()\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLDepositRequest","UpdateHeader");
		if ((*DBObjPtr)(hContext) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLDepositRequest::UpdateHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() DBOLDepositRequest::UpdateHeader() FAILURE!!!\n"); 
		}
	}



/* 5.Add Error Log - upload,approve */
	if (iRet != PD_OK && GetField_Int(hContext,"result_cnt",&iTmp)) {
DEBUGLOG(("Authorize() call DBOLUploadError::AddError()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLUploadError", "AddError");
		if ((unsigned long)(*DBObjPtr)(hContext) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLUploadError::AddError() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() call DBOLUploadError::AddError() FAILURE!!!\n");
		}
	}

DEBUGLOG(("Authorize() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;
}

