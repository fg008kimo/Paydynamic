/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/27              Stan Poon
*/


#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsDRU.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(BO);
OBJPTR(DB);

void TxnOmtByUsDRU(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int	iRet = PD_OK;
	char	*csInFileName, *csInFilePath;
	char	*csMerchantID, *csIntBankCode, *csBankAcctNum;
	char	*csTmDateTime, *csTmDate, *csTmTime;
	char	*csUser;
	char	csFileName[PD_TMP_BUF_LEN], csCountry[PD_COUNTRY_LEN + 1];
	char	*csTmp;
	int	iTmp;
	double	dTmp;
	int	iTotalCount;
	FILE	*fin = NULL;
	char	*csTag = (char*)malloc(64);
	strcpy(csTag,"");

	recordset_t *rRecord;
	hash_t *hRecord, *hRec;

	PutField_CString(hContext,"input_channel",PD_DEPOSIT_REQUEST_FILE);

/* merchant_id */
	if (GetField_CString(hRequest, "merchant_id", &csMerchantID)) {
		PutField_CString(hContext, "merchant_id", csMerchantID);
DEBUGLOG(("Authorize() merchant_id = [%s]\n", csMerchantID));
	} else {
		iRet = INT_MERCHANT_ID_NOT_FOUND;
DEBUGLOG(("Authorize() merchant_id is missing!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() merchant_id is missing!!!\n");
	}
/* int_bank_code */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "int_bank_code", &csIntBankCode)) {
			PutField_CString(hContext, "int_bank_code", csIntBankCode);
DEBUGLOG(("Authorize() int_bank_code = [%s]\n", csIntBankCode));
		} else {
			iRet = INT_BANK_CODE_NOT_FOUND;
DEBUGLOG(("Authorize() int_bank_code is missing!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() int_bank_code is missing!!!\n");
		}
	}
/* bank_acct_num */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "bank_acct_num", &csBankAcctNum)) {
			PutField_CString(hContext, "bank_acct_num", csBankAcctNum);
DEBUGLOG(("Authorize() bank_acct_num = [%s]\n", csBankAcctNum));
		} else {
			iRet = INT_BANK_AC_ID_NOT_FOUND;
DEBUGLOG(("Authorize() acct_num is missing!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() acct_num is missing!!!\n");
		}
	}
/* in_file_name */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "in_file_name", &csInFileName)) {
			PutField_CString(hContext,"in_file_name",csInFileName);
			PutField_CString(hContext,"filename",csInFileName);
DEBUGLOG(("Authorize() in_file_name = [%s]\n", csInFileName));
		} else {
			iRet = INT_FILE_NOT_FOUND;
DEBUGLOG(("Authorize() in_file_name is missing!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() in_file_name is missing!!!\n");
		}
	}
/* in_file_path */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "in_file_path", &csInFilePath)) {
			if (csInFilePath[strlen(csInFilePath)-1] == '/')
				csInFilePath[strlen(csInFilePath)-1] = '\0';
			PutField_CString(hContext,"in_file_path",csInFilePath);
DEBUGLOG(("Authorize() in_file_path = [%s]\n", csInFilePath));
		} else {
			iRet = INT_FILE_NOT_FOUND;
DEBUGLOG(("Authorize() in_file_path is missing!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() in_file_path is missing!!!\n");
		}
	}
/* get file */
	if (iRet == PD_OK) {
		snprintf(csFileName,sizeof(csFileName),"%s/%s",csInFilePath,csInFileName);
		fin = fopen(csFileName, "r");
		if (fin == NULL) {
			iRet = INT_FILE_NOT_FOUND;
DEBUGLOG(("Authorize(): cannot open file [%s]!!!\n", csInFileName));
ERRLOG("TxnOmtByUsDRU::Authorize(): cannot open file [%s]!!!\n", csInFileName);
		} else {
			PutField_CString(hContext,"in_full_filename",csFileName);
			fclose(fin);
		}
	}
/* user */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "add_user", &csUser)) {
			PutField_CString(hContext,"create_user",csUser);
			PutField_CString(hContext,"update_user",csUser);
DEBUGLOG(("Authorize() user = [%s]\n", csUser));
		} else {
			iRet = INT_USER_NOT_FOUND;
DEBUGLOG(("Authorize() user is missing!!!\n"));
ERRLOG("TxnOmtByUsDRU::Authorize() user is missing!!!\n");
		}
	}
/* ip_addr */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "ip_addr", &csTmp)) {
			PutField_CString(hContext,"ip_addr",csTmp);
DEBUGLOG(("Authorize() ip_addr = [%s]\n", csTmp));
		}
	}
/* transmission_datetime */
	if (GetField_CString(hRequest,"transmission_datetime",&csTmDateTime)) {
DEBUGLOG(("Authorize() datetime = [%s]\n",csTmDateTime));
	} else {
		csTmDateTime = csTag;
	}
/* tm_date */
	if (GetField_CString(hRequest,"tm_date",&csTmDate)) {
DEBUGLOG(("Authorize() tm_date = [%s]\n",csTmDate));
	} else {
		csTmDate = csTag;
	}
/* tm_time */
	if (GetField_CString(hRequest,"tm_time",&csTmTime)) {
DEBUGLOG(("Authorize() tm_time = [%s]\n",csTmTime));
	} else {
		csTmTime = csTag;
	}


/* check filename */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLDepositRequest:: CheckFileExist()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLDepositRequest", "CheckFileExist");
		if ((unsigned long)(*DBObjPtr)(csInFileName) != NOT_FOUND) {
			iRet = INT_FILE_ALREADY_EXIST;
DEBUGLOG(("Authorize() call DBOLDepositRequest::CheckFileExist() [%s] file DUPLICATED!!!\n", csInFileName));
		} else {
DEBUGLOG(("ProcessDepositReq() call DBOLDepositRequest::AddHeader()\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLDepositRequest","AddHeader");
			if ((*DBObjPtr)(hContext) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("ProcessDepositReq() call DBOLDepositRequest::AddHeader() FAILURE!!!\n"));
			} else {
				TxnCommit();
			}
		}
	}


/* Check Ava Bank Acct */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLMerchantBankAcct:: CheckAvaDepositBankAccts()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLMerchantBankAcct", "CheckAvaDepositBankAccts");
		if ((unsigned long)(*DBObjPtr)(hContext) != FOUND) {
			iRet = INT_BANK_ACCT_NOT_AVAILABLE;
			PutField_Int(hContext, "result_cnt", 1);
			PutField_CString(hContext, "msg_1", "Bank Acct Not Avaliable");
DEBUGLOG(("Authorize() call DBOLMerchantBankAcct::CheckAvaDepositBankAccts() FAILURE!!!\n"));
		}
	}

/* get service_code */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLMerchantBankAcct::FindServiceByBankAcct()\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBankAcct","FindServiceByBankAcct");
		if ((unsigned long)(*DBObjPtr)(csMerchantID,csIntBankCode,csBankAcctNum,hContext) != PD_OK) {
			iRet = INT_BANK_ACCT_NOT_AVAILABLE;
			PutField_Int(hContext, "result_cnt", 1);
			PutField_CString(hContext, "result_1", "Bank Acct Not Available");
DEBUGLOG(("Authorize() call DBOLMerchantBankAcct::FindServiceByBankAcct() FAILURE!!!\n"));
		}
	}
/* get acct_ccy, branch_name, owner_name */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLBankAccts::GetBankAccts()\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLBankAccts","GetBankAccts");
		if ((unsigned long)(*DBObjPtr)(csIntBankCode,csBankAcctNum,hContext) != PD_OK) {
			iRet = INT_BANK_ACCT_NOT_AVAILABLE;
			PutField_Int(hContext, "result_cnt", 1);
			PutField_CString(hContext, "result_1", "Bank Acct Not Available");
DEBUGLOG(("Authorize() call DBOLBankAccts::GetBankAccts() FAILURE!!!\n"));
		}
	}
/* get country */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBBankDesc::GetBankCountry()\n"));
		DBObjPtr = CreateObj(DBPtr,"DBBankDesc","GetBankCountry");
		if ((unsigned long)(*DBObjPtr)(csIntBankCode,csCountry) != FOUND) {
			iRet = INT_BANK_ACCT_NOT_AVAILABLE;
			PutField_Int(hContext, "result_cnt", 1);
			PutField_CString(hContext, "result_1", "Bank Acct Not Available");
DEBUGLOG(("Authorize() call DBBankDesc::GetBankCountry() FAILURE!!!\n"));
		} else {
			PutField_CString(hContext,"country",csCountry);
		}
	}
/* get client_id deposit_requset_ver */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLMerchDetail::GetMerchant()\n"));
		rRecord = (recordset_t*) malloc (sizeof(recordset_t));
		recordset_init(rRecord, 0);
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchDetail","GetMerchant");
		if ((unsigned long)(*DBObjPtr)(csMerchantID,rRecord) != PD_OK) {
			iRet = INT_ERR;
			PutField_Int(hContext, "result_cnt", 1);
			PutField_CString(hContext, "result_1", "Bank Acct Not Available");
DEBUGLOG(("Authorize() call DBOLMerchDetail::GetMerchant() FAILURE!!!\n"));
		} else {
			hRecord = RecordSet_GetFirst(rRecord);
			if (hRecord != NULL) {
				if (GetField_CString(hRecord,"merchant_client_id",&csTmp)) {
					PutField_CString(hContext,"client_id",csTmp);
DEBUGLOG(("Authorize() client_id = [%s]\n",csTmp));
				}
				if (GetField_Int(hRecord,"deposit_req_ver",&iTmp)) {
					PutField_Int(hContext,"deposit_req_ver",iTmp);
DEBUGLOG(("Authorize() deposit_requestV_ver = [%d]\n",iTmp));
				}
			}
		}
		RecordSet_Destroy(rRecord);
		FREE_ME(rRecord);
	}

	rRecord = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecord, 0);

/* Process Deposit Request */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call BOOLDepositReq::ProcessDepositReq()\n"));
		BOObjPtr = CreateObj(BOPtr, "BOOLDepositReq", "ProcessDepositReq");
		iRet = (unsigned long)(*BOObjPtr)(hContext, rRecord);
		if (iRet != PD_OK) {
			TxnAbort();
DEBUGLOG(("Authorize() call BOOLDepositReq::ProcessDepositReq() FAILURE!!!\n"));
		}
	}


/* response */
	if (!GetField_Int(hContext,"accept_count",&iTmp)) iTmp = 0;
	PutField_Int(hResponse,"accept",iTmp);
	if (!GetField_Double(hContext,"accept_amount",&dTmp)) dTmp = 0.0;
	PutField_Double(hResponse,"accept_amt",dTmp);
	if (!GetField_Int(hContext,"total_count",&iTotalCount)) iTotalCount = 0;
	PutField_Int(hResponse,"total",iTotalCount);


/* Update Deposit Header */
	if (iTotalCount > 0) {
DEBUGLOG(("ProcessDepositReq() call DBOLDepositRequest::UpdateHeader()\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLDepositRequest","UpdateHeader");
		if ((*DBObjPtr)(hContext) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("ProcessDepositReq() call DBOLDepositRequest::UpdateHeader() FAILURE!!!\n"));
		}
	}


/* Add Txn */
	if (iRet == PD_OK) {
		char csNewTxnSeq[PD_TXN_SEQ_LEN + 1];
		char csOrgDepositBank[PD_BANK_NAME_LEN + 1], csDepositBankCode[PD_BANK_CODE_LEN + 1];
		char *csDepositBank;
		char csLocalTxnDateTime[PD_DATETIME_LEN+1];
		char csLocalTmDate[PD_DATE_LEN+1];
		char csLocalTmTime[PD_TIME_LEN+1];

		hRecord = RecordSet_GetFirst(rRecord);
		while(hRecord) { 
			hRec = (hash_t*) malloc (sizeof(hash_t*));
			hash_init(hRec,0);

			DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextTxnSeq");
			strcpy(csNewTxnSeq,(*DBObjPtr)());
DEBUGLOG(("Authorize() csNewTxnSeq = [%s]\n",csNewTxnSeq));

/* txn header */
			PutField_CString(hRec,"filename",csInFileName);
			if (GetField_Int(hRecord,"deposit_seq",&iTmp))
				PutField_Int(hRec,"deposit_seq",iTmp);

			PutField_Int(hRec,"db_commit",PD_TRUE);
			PutField_CString(hRec,"txn_seq",csNewTxnSeq);
			PutField_CString(hRec,"channel_code","OLN");
			PutField_Char(hRec,"status",PD_SENT);
			PutField_CString(hRec,"sub_status",PD_SENT_TO_PSP);
			PutField_CString(hRec,"txn_code",PD_INITIAL_OLN_TXN_CODE);
			PutField_CString(hRec,"process_type","0200");
			PutField_CString(hRec,"process_code","200102");
			PutField_CString(hRec,"merchant_id",csMerchantID);
			if (GetField_CString(hRecord,"merch_ref",&csTmp))
				PutField_CString(hRec,"merchant_ref",csTmp);
			if (GetField_CString(hContext,"client_id",&csTmp))
				PutField_CString(hRec,"client_id",csTmp);
			if (GetField_CString(hContext,"PHDATE",&csTmp))
				PutField_CString(hRec,"host_posting_date",csTmp);
			PutField_Int(hRec,"internal_code",0);
			PutField_CString(hRec,"response_code","0");
			if (GetField_Double(hRecord,"deposit_amount",&dTmp))
				PutField_Double(hRec,"txn_amt",dTmp);

			PutField_CString(hRec,"transmission_datetime",csTmDateTime);
			PutField_CString(hRec,"tm_date",csTmDate);
			PutField_CString(hRec,"tm_time",csTmTime);
			strcpy(csLocalTxnDateTime,getdatetime());
			sprintf(csLocalTmDate,"%.*s",PD_DATE_LEN,csLocalTxnDateTime);
			PutField_CString(hRec,"local_tm_date",csLocalTmDate);
			sprintf(csLocalTmTime,"%.*s",PD_TIME_LEN,&csLocalTxnDateTime[PD_DATE_LEN]);
			PutField_CString(hRec,"local_tm_time",csLocalTmTime);

			PutField_CString(hRec,"add_user",PD_UPDATE_USER);
			PutField_CString(hRec,"update_user",PD_UPDATE_USER);
			if (GetField_CString(hContext,"ip_addr",&csTmp))
				PutField_CString(hRec,"ip_addr",csTmp);
			if (GetField_CString(hContext,"service_code",&csTmp))
				PutField_CString(hRec,"service_code",csTmp);
			if (GetField_CString(hRequest,"user_agent",&csTmp)) {
				PutField_CString(hRec,"user_agent",csTmp);
DEBUGLOG(("user_agent: [%s]\n",csTmp));
			}
/* txn detail */
			if (GetField_CString(hRecord,"deposit_ccy",&csTmp))
				PutField_CString(hRec,"txn_ccy",csTmp);
			if (GetField_CString(hRecord,"country",&csTmp))
				PutField_CString(hRec,"txn_country",csTmp);
			if (GetField_CString(hRecord,"deposit_datetime",&csTmp))
				PutField_CString(hRec,"deposit_datetime",csTmp);
			PutField_CString(hRec,"bank_acct_num",csBankAcctNum);
			if (GetField_CString(hRecord,"deposit_bank",&csDepositBank))
				PutField_CString(hRec,"deposit_bank",csDepositBank);
			if (GetField_CString(hRecord,"deposit_ref",&csTmp))
				PutField_CString(hRec,"deposit_ref",csTmp);

			if (strcmp(csOrgDepositBank, csDepositBank) || !strcmp(csOrgDepositBank,"")) {
DEBUGLOG(("Authorize() call DBOLDepositRequest::GetBankCode()\n"));
				strcpy(csOrgDepositBank, csDepositBank);
				DBObjPtr = CreateObj(DBPtr,"DBOLDepositRequest","GetBankCode");
				if ((unsigned long)(*DBObjPtr)(csDepositBank,csDepositBankCode) == PD_FOUND) {
DEBUGLOG(("Authorize() call DBOLDepositRequest::GetBankCode() FOUND\n"));
				} else {
					strcpy(csDepositBankCode,"");
					PutField_CString(hRec,"deposit_bank","");
DEBUGLOG(("Authorize() call DBOLDepositRequest::GetBankCode() NOT FOUND\n"));
				}
			}
			PutField_CString(hRec,"deposit_bank_code",csDepositBankCode);
			PutField_CString(hRec,"bank_code",csIntBankCode);

			if (GetField_CString(hContext,"branch_name",&csTmp))
				PutField_CString(hRec,"branch_name",csTmp);
			if (GetField_CString(hContext,"owner_name",&csTmp))
				PutField_CString(hRec,"account_name",csTmp);
			PutField_CString(hRec,"add_user",PD_UPDATE_USER);

			if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLTransaction::Add()\n"));
				DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Add");
				if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction::Add() FAILURE!!!\n"));
				}
			}

			if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLTransaction::AddDetail()\n"));
				DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","AddDetail");
				if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction::AddDetail() FAILURE!!!\n"));
				}
			}

			if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLDepositRequest::UpdateDetail()\n"));
				PutField_CString(hRec,"update_user",csUser);
				DBObjPtr = CreateObj(DBPtr,"DBOLDepositRequest","UpdateDetail");
				if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLDepositRequest::UpdateDetail() FAILURE!!!\n"));
				}
			}

			hRecord = RecordSet_GetNext(rRecord);

			hash_destroy(hRec);
			FREE_ME(hRec);
		}
	}


/* add error log */
	if (iRet != PD_OK) {
		if (iRet != PD_ERR && iRet != INT_ERR && iRet != INT_FILE_ALREADY_EXIST) {
DEBUGLOG(("Authorize() call DBOLUploadError::AddError()\n"));
			BOObjPtr = CreateObj(BOPtr, "DBOLUploadError", "AddError");
			if ((unsigned long)(*BOObjPtr)(hContext) == PD_OK) {
DEBUGLOG(("Authorize() call DBOLUploadError::AddError() Success\n"));
			} else {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLUploadError::AddError() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call DBOLUploadError::AddError() FAILURE!!!\n");
			}
		}
		if (iRet == PD_ERR || iRet == INT_ERR) {
DEBUGLOG(("Authorize() call DBOLUploadError::Addrror() Internal Error\n"));
			PutField_Int(hContext, "result_cnt", 1);
			PutField_CString(hContext, "msg_1", "Internal Error");
			RemoveField_CString(hContext, "desc_1");
			RemoveField_CString(hContext, "line_1");
			RemoveField_Int(hContext, "line_1");
			BOObjPtr = CreateObj(BOPtr, "DBOLUploadError", "AddError");
			if ((unsigned long)(*BOObjPtr)(hContext) == PD_OK) {
DEBUGLOG(("Authorize() call DBOLUploadError::Addrror() Internal Error Called\n"));
			} else {
DEBUGLOG(("Authorize() call DBOLUploadError::AddError() Internal Error FAILURE!!!\n"));
			}
		}
		PutField_Int(hContext, "internal_error", iRet);
	}


	FREE_ME(csTag);

	RecordSet_Destroy(rRecord);
	FREE_ME(rRecord);

DEBUGLOG(("Authorize() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;
}

