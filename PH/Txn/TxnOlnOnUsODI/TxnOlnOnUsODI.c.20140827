/*
Partnerdelight (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/09/02              Cody Chan
Cater Method2 to log bank information              2013/11/12              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOlnOnUsODI.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnOlnOnUsODI(char    cdebug)
{
        cDebug = cdebug;
}

int     PostTxn(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse);
int     UpdateTxnLog(const hash_t* hRequest);
int	GetRequestBankInfo(const hash_t* hRequest, hash_t *hContext);

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	char*	csPtr;
	//double  dTmp;
	//char	cTmp;

DEBUGLOG(("TxnOlnOnUsODI: Authroize()\n"));

// fe_url
	if (GetField_CString(hResponse,"fe_url",&csPtr)) {
DEBUGLOG(("Authroize: fe_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"redirect_url",csPtr);
	}

// method 2
//	if (GetField_CString(hRequest,"deposit_datetime",&csPtr)) {
//DEBUGLOG(("Authorize: METHOD 2 deposit_datetime = [%s]\n",csPtr));
//
//		iRet = GetRequestBankInfo(hRequest, hContext);
//
//		if (GetField_Double(hContext, "txn_amt", &dTmp)) {
//DEBUGLOG(("Authorize: METHOD 2 deposit_amt = display_amt = txn_amt = [%lf]\n", dTmp));
//			PutField_Double(hContext, "display_amt", dTmp);
//			PutField_Double(hContext, "deposit_amt", dTmp);
//		}
//	}

// method 2
/*
	if (GetField_Char(hRequest, "deposit_flow", &cTmp)) {
DEBUGLOG(("Authorize: METHOD 2 deposit_flow = [%c]\n", cTmp));
		iRet = GetRequestBankInfo(hRequest, hContext);
	}
*/

DEBUGLOG(("Normal exit iret = [%d]\n",iRet));	
	return iRet;
}


int     UpdateTxnLog(const hash_t* hRequest)
{
        int iRet = PD_OK;
        hash_t  *hCon;
        char*   csTmp;

        hCon = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hCon,0);

        PutField_CString(hCon,"add_user",PD_UPDATE_USER);

/* txn_seq  */
        if (GetField_CString(hRequest,"txn_seq",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_seq = [%s]\n",csTmp));
                PutField_CString(hCon,"txn_seq",csTmp);
        }

/* bank_code  */
        if (GetField_CString(hRequest,"bank_code",&csTmp)) {
DEBUGLOG(("UpdateTxnLog:: bank_code = [%s]\n",csTmp));
                PutField_CString(hCon,"bank_code",csTmp);
        }

        DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","UpdateDetail");
        iRet = (unsigned long)(*DBObjPtr)(hCon);

        hash_destroy(hCon);
        FREE_ME(hCon);

        return iRet;
};


int     PostTxn(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
	int 	iRet = PD_OK;
	hash_t	*hReq;
	hash_t	*hCon;
	char*	csPtr;
	//double	dTmp;
DEBUGLOG(("TxnOlnOnUsODI::PostTxn()\n"));
/* Get ReserveAmount */
DEBUGLOG(("TxnOlnOnUsODI::PostTxn():: Call BOReserve\n"));
	BOObjPtr = CreateObj(BOPtr,"BOReserve","GetReserveAmount");
        iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnOlnOnUsODI::PostTxn():: GetReserve result = [%d]\n",iRet));

	if (iRet == PD_OK) {
/* POST */
		double	dTmp;
		hCon = (hash_t*)  malloc (sizeof(hash_t));
       		hash_init(hCon,0);
		
		hReq = (hash_t*)  malloc (sizeof(hash_t));
        	hash_init(hReq,0);

		PutField_Char(hCon,"post_txn",PD_YES);

/* txn_seq */
		if (GetField_CString(hContext,"org_txn_seq",&csPtr)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn txn_seq = [%s]\n",csPtr));
			PutField_CString(hCon,"txn_seq",csPtr);
			PutField_CString(hCon,"from_txn_seq",csPtr);
		}
/* txn_code */
		if (GetField_CString(hContext,"txn_code",&csPtr)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn txn_code = [%s]\n",csPtr));
			PutField_CString(hCon,"txn_code",csPtr);
		}

/* dst_txn_amt */
		if (GetField_Double(hContext,"org_dst_txn_amt",&dTmp)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn dst_txn_amt = [%f]\n",dTmp));
			PutField_Double(hCon,"dst_txn_amt",dTmp);
		}
/* dst_txn_ccy */
		if (GetField_CString(hContext,"org_dst_txn_ccy",&csPtr)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn dst_txn_ccy = [%s]\n",csPtr));
			PutField_CString(hCon,"dst_txn_ccy",csPtr);
		}

/* txn_amt */
		if (GetField_Double(hContext,"org_txn_amt",&dTmp)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn txn_amt = [%f]\n",dTmp));
			PutField_Double(hCon,"txn_amt",dTmp);
		}
/* txn_country */
		if (GetField_CString(hContext,"org_txn_country",&csPtr)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn txn_country = [%s]\n",csPtr));
			PutField_CString(hReq,"txn_country",csPtr);
		}
/* txn_ccy */
		if (GetField_CString(hContext,"org_txn_ccy",&csPtr)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn txn_ccy = [%s]\n",csPtr));
			PutField_CString(hReq,"txn_ccy",csPtr);
		}
/* channel_code */
		if (GetField_CString(hContext,"org_channel_code",&csPtr)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn channel_code = [%s]\n",csPtr));
			PutField_CString(hCon,"channel_code",csPtr);
		}
/* service_code */
		if (GetField_CString(hContext,"org_service_code",&csPtr)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn service_code = [%s]\n",csPtr));
			PutField_CString(hReq,"service_code",csPtr);
		}
/* merchant_id */
		if (GetField_CString(hContext,"org_merchant_id",&csPtr)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn merchant_id = [%s]\n",csPtr));
			PutField_CString(hReq,"merchant_id",csPtr);
		}
/* merchant_client_id */
		if (GetField_CString(hContext,"org_client_id",&csPtr)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn merchant_client_id = [%s]\n",csPtr));
			PutField_CString(hCon,"merchant_client_id",csPtr);
		}
/* org_pay_method */
		if (GetField_CString(hContext,"org_pay_method",&csPtr)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn org_pay_method = [%s]\n",csPtr));
			PutField_CString(hCon,"selected_pay_method",csPtr);
		}
/* bank_code */
		if (GetField_CString(hContext,"bank_code",&csPtr)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn bank_code = [%s]\n",csPtr));
			PutField_CString(hCon,"bank_code",csPtr);
		}
		else if (GetField_CString(hResponse,"bank_code",&csPtr)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn bank_code = [%s]\n",csPtr));
			PutField_CString(hCon,"bank_code",csPtr);
		}
/*** update bank code */
		if (GetField_CString(hCon,"bank_code",&csPtr)) {
DEBUGLOG(("TxnOlnOnUsODI::PostTxn UpdateTxnLog for Bank Code\n"));
			UpdateTxnLog(hCon);
		}



		if (iRet == PD_OK) {
DEBUGLOG(("TxnOlnOnUsODI:: Call BOFee\n"));
                        BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
                        iRet = (unsigned long)(*BOObjPtr)(hCon,hReq);
DEBUGLOG(("TxnOlnOnUsODI:: GetTxnFee result = [%d]\n",iRet));
                }
		if (iRet == PD_OK) {
			BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnFeeElements");
                        iRet = (unsigned long)(*BOObjPtr)(hCon);
DEBUGLOG(("TxnOlnOnUsODI:: BOTxnElements: AddTxnFeeElements result = [%d]\n",iRet));
		}
		hash_destroy(hReq);
        	FREE_ME(hReq);

/***** post *******/

DEBUGLOG(("TxnOlnOnUsODI::PostTxn():: Call BOFee\n"));
		BOObjPtr = CreateObj(BOPtr,"BOFee","UpdateAmt");
       		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnOlnOnUsODI::PostTxn():: GetTxnFee result = [%d]\n",iRet));

		hash_destroy(hCon);
       		FREE_ME(hCon);
		
	}
	

/* precal psp fee if define */
	if (iRet == PD_OK) {
		/* Update Stat */
		PutField_Char(hContext,"txn_type",PD_TYPE_DEPOSIT);
DEBUGLOG(("TxnOlnOnUsODI::PostTxn():: Call BOPsp CalPspCosts\n"));
                BOObjPtr = CreateObj(BOPtr,"BOPsp","CalPspCosts");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnOlnOnUsODI::PostTxn():: BOStat::CalPspFee() result = [%d]\n",iRet));
	}

/* overwrite the returned service fee to precal fee*/
	/*if(GetField_Double(hRequest,"service_fee",&dTmp)){
		PutField_Double(hContext,"precal_fee",dTmp);
	}*/

	if (iRet == PD_OK) {
		/* Update Stat */
DEBUGLOG(("TxnOlnOnUsODI::PostTxn():: Call BOStat\n"));
                BOObjPtr = CreateObj(BOPtr,"BOStat","UpdateDspStat");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnOlnOnUsODI::PostTxn():: BOStat::UpdateDspStat() result = [%d]\n",iRet));
	}


/* update Balance at the end to shortend the row lock time */
	if (iRet == PD_OK) {
		/* Update Balance */
DEBUGLOG(("TxnOlnOnUsODI::PostTxn():: Call BOBalance\n"));
                BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdateTxnAmount");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnOlnOnUsODI::PostTxn():: updatetxnamount result = [%d]\n",iRet));
	}

	if (iRet == PD_OK) {
		/* Update Stat */
DEBUGLOG(("TxnOlnOnUsODI::PostTxn():: Call BOStat\n"));
                BOObjPtr = CreateObj(BOPtr,"BOStat","UpdateDspMerchantStat");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnOlnOnUsODI::PostTxn():: BOStat::UpdateDspMerchantStat() result = [%d]\n",iRet));
	}

DEBUGLOG(("TxnOlnOnUsODI::PostTxn() Normal exit iret = [%d]\n",iRet));	
	return iRet;
}



int	GetRequestBankInfo(const hash_t* hRequest, hash_t *hContext)
{
	int 	iRet = PD_OK;
	
	char	*csMerchantId = NULL;
	char	*csCountry = NULL;
	char	*csCcy = NULL;
	char	*csAcctNum = NULL;
	char	*csPtr;

        hash_t  *hBankInfo;

	char	*csBankCode;

        hBankInfo = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hBankInfo,0);

	if (GetField_CString(hRequest,"bank_acct_num",&csAcctNum)) {
DEBUGLOG(("TxnOlnOnUsODI::GetRequestBankInfo() bank_acct_num = [%s]\n",csAcctNum));	

		if (GetField_CString(hRequest, "merchant_id", &csMerchantId)) {
DEBUGLOG(("TxnOlnOnUsODI::GetRequestBankInfo() merchant_id = [%s]\n",csMerchantId));	
		}
		if (GetField_CString(hRequest, "txn_country", &csCountry)) {
DEBUGLOG(("TxnOlnOnUsODI::GetRequestBankInfo() txn_country = [%s]\n",csCountry));	
		}
		if (GetField_CString(hRequest, "txn_ccy", &csCcy)) {
DEBUGLOG(("TxnOlnOnUsODI::GetRequestBankInfo() txn_ccy= [%s]\n",csCcy));	
		}

		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBankAcct","GetBeneficiaryBank");
		if ((unsigned long)(*DBObjPtr)(csMerchantId, csCountry, csCcy, csAcctNum, hBankInfo) != PD_OK) {
DEBUGLOG(("TxnOlnOnUsODI::GetRequestBankInfo() Failed to get bank acct for merchant!!!!\n"));
			iRet = INT_BANK_ACCT_NOT_AVAILABLE;
			PutField_Int(hContext,"internal_error",iRet);
		} else {

			if (GetField_CString(hBankInfo, "int_bank_code", &csPtr)) {
DEBUGLOG(("TxnOlnOnUsODI::GetRequestBankInfo() int_bank_code [%s]\n", csPtr));
				PutField_CString(hContext, "bank_code", csPtr);
			}
			if (GetField_CString(hBankInfo, "bank_name", &csPtr)) {
				PutField_CString(hContext, "bank_name", csPtr);
			}
		}
	}
	
	if (iRet == PD_OK) {

		csBankCode = (char*) malloc (PD_BANK_CODE_LEN + 1);

		if (GetField_CString(hRequest, "deposit_bank", &csPtr)) {
			DBObjPtr = CreateObj(DBPtr,"DBOLDepositRequest","GetDepositBankCode");
			if ((unsigned long)(*DBObjPtr)(csPtr, csBankCode) == PD_FOUND) {
DEBUGLOG(("TxnOlnOnUsODI::GetRequestBankInfo() deposit_bank_code [%s]\n", csBankCode));
				PutField_CString(hContext, "deposit_bank_code", csBankCode);
			}
			else {
				PutField_CString(hContext, "deposit_bank_code", PD_OTHER_BANK_CODE);
			}
		}

	        FREE_ME(csBankCode);
	}

	hash_destroy(hBankInfo);
	FREE_ME(hBankInfo);

DEBUGLOG(("TxnOlnOnUsODI::GetRequestBankInfo() Normal exit iret = [%d]\n",iRet));	
	return iRet;

}
