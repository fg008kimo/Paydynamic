/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/09              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsBKA.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnOmtByUsBKA(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		const hash_t* hRequest,
		hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iTmp;
	char	*csTmp = NULL;
	int 	iTmpRet = PD_FOUND;

	char	cAction;
	int	iOnlyStatus = PD_FALSE;

	char	*csIntBankCode = NULL;
	char	*csBankAcctNum = NULL;
	char	*csStatusType = NULL;
	char	*csRegMobileNum = NULL;
	char	*csProviderID = NULL;

	hash_t *hBankAcct;
	hBankAcct = (hash_t*) malloc (sizeof(hash_t));

	hash_t	*hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn, 0);

DEBUGLOG(("TxnOmtByUsBKA:: Authorize\n"));

/* action */
	if (GetField_CString(hRequest, "action", &csTmp)) {
		cAction = csTmp[0];
DEBUGLOG(("Authorize:: action = [%c]\n", cAction));
		// not support delete
		if (cAction != PD_ACTION_ADD && cAction != PD_ACTION_UPDATE) {
DEBUGLOG(("Authorize:: action [%d] not accepted!!\n", cAction));
ERRLOG("TxnOmtByUsBKA:: Authorize:: action not accepted!!\n");
			iRet = INT_ACTION_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
		}
	} else {
DEBUGLOG(("Authorize:: action not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: action not found!!\n");
		iRet = INT_ACTION_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
	}

/* bank code */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "int_bank_code", &csIntBankCode)) {
			PutField_CString(hTxn, "bank_code", csIntBankCode);
DEBUGLOG(("Authorize:: bank_code = [%s]\n", csIntBankCode));
		} else {
DEBUGLOG(("Authorize:: bank_code not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: bank_code not found!!\n");
			iRet = INT_BANK_CODE_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

/* new acct num */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "new_acct_num", &csBankAcctNum)) {
			PutField_CString(hTxn, "new_acct_num", csBankAcctNum);
DEBUGLOG(("Authorize:: new_acct_num = [%s]\n", csBankAcctNum));
		} else {
DEBUGLOG(("Authorize:: new_acct_num not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: new_acct_num not found!!\n");
			iRet = INT_BANK_AC_ID_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

/* user */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "add_user", &csTmp)) {
DEBUGLOG(("Authorize:: user = [%s]\n", csTmp));
			PutField_CString(hTxn, "create_user", csTmp);
			PutField_CString(hTxn, "update_user", csTmp);
		}
	}

/* name */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "name", &csTmp)) {
DEBUGLOG(("Authorize:: name = [%s]\n", csTmp));
			PutField_CString(hTxn, "name", csTmp);
		} else {
			if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize:: name not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: name not found!!\n");
				iRet = INT_BANK_AC_NAME_NOT_FOUND;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

/* short name */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "short_name", &csTmp)) {
DEBUGLOG(("Authorize:: short_name = [%s]\n", csTmp));
			PutField_CString(hTxn, "short_name", csTmp);
		} else {
			if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize:: short_name not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: short_name not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

/* ccy */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "txn_ccy", &csTmp)) {
DEBUGLOG(("Authorize:: ccy = [%s]\n", csTmp));
			PutField_CString(hTxn, "ccy", csTmp);
		} else {
			if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize:: ccy not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: ccy not found!!\n");
				iRet = INT_CURRENCY_CODE_NOT_FOUND;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

/* acct type */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "acct_type", &csTmp)) {
DEBUGLOG(("Authorize:: acct_type = [%s]\n", csTmp));
			PutField_CString(hTxn, "acct_type", csTmp);
		} else {
			if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize:: acct_type not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: acct_type not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

/* share */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "share", &csTmp)) {
			iTmp = atoi(csTmp);
DEBUGLOG(("Authorize:: share = [%d]\n", iTmp));
			PutField_Int(hTxn, "share", iTmp);
		} else {
			if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize:: share not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: share not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

/* rec datetime */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "rec_datetime", &csTmp)) {
DEBUGLOG(("Authorize:: rec_datetime = [%s]\n", csTmp));
			PutField_CString(hTxn, "rec_datetime", csTmp);
		} else {
			if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize:: rec_datetime not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: rec_datetime not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

/* rec by */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "rec_by", &csTmp)) {
DEBUGLOG(("Authorize:: rec_by = [%s]\n", csTmp));
			PutField_CString(hTxn, "rec_by", csTmp);
		} else {
			if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize:: rec_by not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: rec_by not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

/* support sms stmt */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "sms_stmt", &csTmp)) {
			iTmp = atoi(csTmp);
DEBUGLOG(("Authorize:: support_sms_stmt = [%d]\n", iTmp));
			PutField_Int(hTxn, "support_sms_stmt", iTmp);
		} else {
			if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize:: support_sms_stmt not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: support_sms_stmt not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}


/* reg mob num */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "reg_mob_num", &csRegMobileNum)) {
DEBUGLOG(("Authorize:: reg_mob_num = [%s]\n", csRegMobileNum));
			PutField_CString(hTxn, "reg_mob_num", csRegMobileNum);
		}
	}

/* status type */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "status_type", &csStatusType)) {
DEBUGLOG(("Authorize:: status_type = [%s]\n", csStatusType));
			PutField_CString(hTxn, "status_type", csStatusType);
		} else {
			if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize:: status_type not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: status_type not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

/* prov id */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "prov_id", &csProviderID)) {
DEBUGLOG(("Authorize:: prov_id = [%s]\n", csProviderID));
			PutField_CString(hTxn, "prov_id", csProviderID);
		} else {
			if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize:: prov_id not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: prov_id not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

/* owner id */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "owner_id", &csTmp)) {
DEBUGLOG(("Authorize:: owner_id = [%s]\n", csTmp));
			PutField_CString(hTxn, "owner_id", csTmp);
		}
	}

/* owner */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "owner", &csTmp)) {
DEBUGLOG(("Authorize:: owner = [%s]\n", csTmp));
			PutField_CString(hTxn, "owner", csTmp);
		} else {
			if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize:: owner not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: owner not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

/* branch code */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "branch_code", &csTmp)) {
DEBUGLOG(("Authorize:: branch_code = [%s]\n", csTmp));
			PutField_CString(hTxn, "branch_code", csTmp);
		}
	}

/* branch */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "branch", &csTmp)) {
DEBUGLOG(("Authorize:: branch = [%s]\n", csTmp));
			PutField_CString(hTxn, "branch", csTmp);
		} else {
			if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize:: branch not found!!\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: branch not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

/* swift code */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "swift_code", &csTmp)) {
DEBUGLOG(("Authorize:: swift_code = [%s]\n", csTmp));
			PutField_CString(hTxn, "swift_code", csTmp);
		}
	}

/* remark */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "remark", &csTmp)) {
DEBUGLOG(("Authorize:: remark = [%s]\n", csTmp));
			PutField_CString(hTxn, "remark", csTmp);
		}
	}

/* Check Unique Last 4 Digit By Bank */
	if (iRet == PD_OK) {
		if (cAction == PD_ACTION_ADD) {
			iTmpRet = PD_FOUND;

DEBUGLOG(("Authorize::Call DBOLBankAccts:ChkBankAcctsUnique\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLBankAccts","ChkBankAcctsUnique");
			iTmpRet = (unsigned long)(*DBObjPtr)(csIntBankCode, csBankAcctNum);
			if (iTmpRet == PD_NOT_FOUND) {
DEBUGLOG(("Authorize::DBOLBankAccts:ChkBankAcctsUnique NOT FOUND, OK for Add!\n"));
			} else {
DEBUGLOG(("Authorize::DBOLBankAccts:ChkBankAcctsUnique FOUND\n"));
ERRLOG("TxnOmtByUsBKA::Authorize::DBOLBankAccts:ChkBankAcctsUnique FOUND!\n");
				iRet = INT_BANK_ACCT_DUPLICATE;
				PutField_Int(hContext,"internal_error",iRet);
			}
		}
	}

/* if Update, and existing status is Frozen, and new status is not frozen, only update status */
/* if Update, and existing status is Frozen, and new status is frozen, return error */
	if (iRet == PD_OK) {
		if (cAction == PD_ACTION_UPDATE) {
			hash_init(hBankAcct, 0);

                        DBObjPtr = CreateObj(DBPtr,"DBOLBankAccts","GetBankAccts");
                        if ((*DBObjPtr)(csIntBankCode, csBankAcctNum, hBankAcct) != PD_OK) {
ERRLOG("TxnOmtByUsBKA:: Authorize:: DBOLBankAccts:GetBankAccts Failed\n");
DEBUGLOG(("Authorize:DBOLBankAccts: GetBankAccts Failed\n"));
                                iRet = PD_ERR;
                        } else {
				if (GetField_CString(hBankAcct, "status_type", &csTmp)) {
					if (!strcmp(csTmp, PD_BANK_ACCT_STATUS_FROZEN)) {
						if (!strcmp(csStatusType, PD_BANK_ACCT_STATUS_FROZEN)) {
							// error
							iRet = INT_ALREADY_FROZEN_STATUS;
							PutField_Int(hContext, "internal_error",iRet);
						} else {
							// only update Status!!
							iOnlyStatus = PD_TRUE;
						}
					}
				}
			}
		
			hash_destroy(hBankAcct);
		}
	}
	
/* Check Mobile Number if already exists */
	if (iRet == PD_OK) {
		if ((csIntBankCode != NULL) && (csBankAcctNum != NULL) && (csRegMobileNum != NULL)) {

DEBUGLOG(("Authorize::Call DBOLBankAccts:ChkMobileNumByBank\n"));
			iTmpRet = PD_FOUND;

                        DBObjPtr = CreateObj(DBPtr,"DBOLBankAccts","ChkMobileNumByBank");
                        iTmpRet = (unsigned long)(*DBObjPtr)(csIntBankCode, csBankAcctNum, csRegMobileNum);
                        if (iTmpRet == PD_NOT_FOUND) {
DEBUGLOG(("Authorize::DBOLBankAccts:ChkMobileNumByBank NOT FOUND, OK to Add or Update\n")); 
                        } else {
DEBUGLOG(("Authorize::DBOLBankAccts:ChkMobileNumByBank FOUND\n"));
ERRLOG("TxnOmtByUsBKA::Authorize::DBOLBankAccts:ChkMobileNumByBank FOUND!\n");
				iRet = INT_MOBILE_NUM_DUPLICATE;
				PutField_Int(hContext,"internal_error",iRet);
                        }
		}
	}

/* povider_id should be Offline or All */
	if (iRet == PD_OK) {
		if (csProviderID != NULL) {
			hash_init(hBankAcct, 0);

DEBUGLOG(("Authorize::Call DBPspMaster:GetPspMasterMode provider_id [%s]\n", csProviderID));

			DBObjPtr = CreateObj(DBPtr,"DBPspMaster","GetPspMasterMode");

			iTmpRet = PD_FOUND;
			if ((unsigned long)(DBObjPtr)(csProviderID, hBankAcct) == PD_OK) {
				if (GetField_CString(hBankAcct, "mode_type", &csTmp)) {
DEBUGLOG(("Authorize::DBPspMaster: GetPspMasterMode mode_type [%s]\n", csTmp));
					if (strcmp(csTmp, PD_PSP_MASTER_MODE_OFFLINE) &&
					    strcmp(csTmp, PD_PSP_MASTER_MODE_ALL)) {
DEBUGLOG(("Authorize::Call DBPspMaster:GetPspMasterMode NOT CORRECT\n"));
						iTmpRet = PD_NOT_FOUND;
					}
				} else {
DEBUGLOG(("Authorize::DBPspMaster: GetPspMasterMode mode_type NOT FOUND\n")); 
					iTmpRet = PD_NOT_FOUND;
				}
			} else {
DEBUGLOG(("Authorize::DBPspMaster: GetPspMasterMode NOT_FOUND\n")); 
				iTmpRet = PD_NOT_FOUND;
			}

			if (iTmpRet == PD_NOT_FOUND) {
DEBUGLOG(("Authorize::DBPspMaster:GetPspMasterMode NOT FOUND\n"));
ERRLOG("TxnOmtByUsBKA::Authorize::DBPspMaster:GetPspMasterMode NOT FOUND!\n");
				iRet = INT_CLIENT_ID_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
			}
			hash_destroy(hBankAcct);
		}
	}


	if (iRet == PD_OK) {
		if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize:: Call DBOLBankAccts:Add\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLBankAccts", "Add");
			if ((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)) {
DEBUGLOG(("Authorize:: DBOLBankAccts:Add Failed\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: DBOLBankAccts:Add Failed\n");
				iRet = INT_ERR;
			} else {
DEBUGLOG(("Authorize:: DBOLBankAccts:Add Success\n"));
			}
		} else if (cAction == PD_ACTION_UPDATE) {
			// Update !!!!

			if (iOnlyStatus == PD_TRUE) {
DEBUGLOG(("Authorize:: Call DBOLBankAccts:UpdateStatus\n"));
				DBObjPtr = CreateObj(DBPtr, "DBOLBankAccts", "UpdateStatus");
				if ((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)) {
DEBUGLOG(("Authorize:: DBOLBankAccts:UpdateStatus Failed\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: DBOLBankAccts:UpdateStatus Failed\n");
					iRet = INT_ERR;
				} else {
DEBUGLOG(("Authorize:: DBOLBankAccts:UpdateStatus Success\n"));
				}
			} else {
DEBUGLOG(("Authorize:: Call DBOLBankAccts:Update\n"));
				DBObjPtr = CreateObj(DBPtr, "DBOLBankAccts", "Update");
				if ((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)) {
DEBUGLOG(("Authorize:: DBOLBankAccts:Update Failed\n"));
ERRLOG("TxnOmtByUsBKA:: Authorize:: DBOLBankAccts:Update Failed\n");
					iRet = INT_ERR;
				} else {
DEBUGLOG(("Authorize:: DBOLBankAccts:Update Success\n"));
				}
			}
		}
	}

	hash_destroy(hTxn);

	FREE_ME(hBankAcct);
	FREE_ME(hTxn);

DEBUGLOG(("TxnOmtByUsBKA Normal Exit() iRet = [%d]\n", iRet));
	return iRet;
}

