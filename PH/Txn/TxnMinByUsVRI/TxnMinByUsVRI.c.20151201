/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/11/27              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMinByUsVRI.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

int	GetOrgBatchInfo(hash_t* hContext, recordset_t* rOrgBatchRecordSet);

int	CheckBatchValid(hash_t* hContext, recordset_t* rOrgBatchRecordSet);

int	ProcessVoidRspDeliveryIn(hash_t* hContext);
int     FormVoidRspDeliveryInTxn(hash_t* hContext, hash_t* hTxnRec);
int     ProcessVoidRspDeliveryInTxn(hash_t* hContext, hash_t* hTxnRec);

int     ProcessOrgBatch(hash_t* hContext, recordset_t* rOrgBatchRecordSet);
int	GetOrgBatchTxnInfo(hash_t* hTxnRec);
int     ProcessOrgBatchTxn(hash_t* hContext, hash_t* hTxnRec);

int     ProcessVoidBatch(hash_t* hContext, recordset_t* rOrgBatchRecordSet);

int	ProcessVoidACR(hash_t* hContext, recordset_t* rOrgBatchRecordSet);

void TxnMinByUsVRI(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
		  hash_t* hRequest,
		  hash_t* hResponse)
{
        int	iRet = PD_OK;

	char	*csTmp = NULL;

	recordset_t *rOrgBatchRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rOrgBatchRecordSet,0);

DEBUGLOG(("Authorize::TxnMinByUsVRI Begin\n"));

/* txn_seq */
        if (GetField_CString(hContext,"txn_seq",&csTmp)) {
DEBUGLOG(("Authorize::txn_seq = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::txn_seq not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::txn_seq not found!!\n");
                iRet = INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* batch_id */
        if (GetField_CString(hContext,"batch_id",&csTmp)) {
DEBUGLOG(("Authorize::batch_id = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
	}

/* org_batch_id */
        if (GetField_CString(hContext,"org_batch_id",&csTmp)) {
DEBUGLOG(("Authorize::org_batch_id = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* process_type */
        if (GetField_CString(hContext,"process_type",&csTmp)) {
DEBUGLOG(("Authorize::process_type = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::process_type not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::process_type not found!!\n");
                iRet = INT_MI_PROCESS_TYPE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* org_process_type */
        if (GetField_CString(hContext,"org_process_type",&csTmp)) {
DEBUGLOG(("Authorize::org_process_type = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::process_type not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::process_type not found!!\n");
                iRet = INT_MI_PROCESS_TYPE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* add_user */
        if (GetField_CString(hContext,"add_user",&csTmp)) {
DEBUGLOG(("Authorize::add_user = [%s]\n",csTmp));
        }

/* update_user */
        if (GetField_CString(hContext,"update_user",&csTmp)) {
DEBUGLOG(("Authorize::update_user = [%s]\n",csTmp));
        }

	//
	// Get Org Batch Info:		1. Org Batch Header
	// 				2. Org Batch Detail
	//
	if (iRet == PD_OK) {
		iRet = GetOrgBatchInfo(hContext, rOrgBatchRecordSet);
                if (iRet != PD_OK) {
                        PutField_Int(hContext,"internal_error",iRet);
                }
	}

	//
	// Check Batch Valid:		1. Org Batch
	// 				2. Void Batch
	//
	if (iRet == PD_OK) {
		iRet = CheckBatchValid(hContext, rOrgBatchRecordSet);
		if (iRet != PD_OK) {
			PutField_Int(hContext,"internal_error",iRet);
		}
	}

	//	
	// Generate a New Txn:		1. Void Rsp Delivery In Txn 	- Creit(Void) Rsp Available Balance
	//
	if (iRet == PD_OK) {
                iRet = ProcessVoidRspDeliveryIn(hContext);
        }

	//
	// Update Org Batch:		1. RSP Delivery In Txn 		- Update Sub Status
	// 				2. OPB Fund In Txn 		- Update Sub Status and Debit(Void) Op Bank Balance
	//				3. RSP Amt Diff Txn 		- Update Sub Status and Credit/Debit(Void) AR Balance
	//				4. RSP Delivery Out Txn		- Update Sub Status
	//				5. RSP Settlement Txn 		- Update Sub Status
	//				6. PSP Settlement Txn		- Update Sub Status		
	//
	if (iRet == PD_OK) {
		iRet = ProcessOrgBatch(hContext, rOrgBatchRecordSet);
        }

	//
	// Generate a Void Batch:	1. Void Rsp Delivery In Txn
	// 				2. RSP Delivery In Txn
	// 				3. OPB Fund In Txn
	// 				4. RSP Amt Diff Txn
	// 				5. RSP Delivery Out Txn
	// 				6, RSP Settlement Txn
	// 				7. PSP Settlement Txn
	// 
	if (iRet == PD_OK) {
		iRet = ProcessVoidBatch(hContext, rOrgBatchRecordSet);
        }	

	//
	// Update ACR:			1. Sum of OPB Fund In Txn	- Debit(Void) ACR Balance
	// 
	if (iRet == PD_OK) {
		iRet = ProcessVoidACR(hContext, rOrgBatchRecordSet);
	}

	RecordSet_Destroy(rOrgBatchRecordSet);
        FREE_ME(rOrgBatchRecordSet);

DEBUGLOG(("TxnMinByUsVRI Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     GetOrgBatchInfo(hash_t* hContext, recordset_t* rOrgBatchRecordSet)
{

	int     iRet = PD_OK;
	int	iDtlRet = PD_NOT_FOUND;

	int	iTmp = 0;

	char	cTmp;
	
	char    *csOrgBatchId = NULL;
	char	*csTmp = NULL;
	
	hash_t  *hOrgBatchRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hOrgBatchRec,0);

	hash_t  *hOrgBatchHdRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hOrgBatchHdRec,0);

	hash_t *hOrgBatchDtRec;
        recordset_t *rOrgBatchDtRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rOrgBatchDtRecordSet,0);

/* org_batch_id */
        if (GetField_CString(hContext,"org_batch_id",&csOrgBatchId)) {
DEBUGLOG(("GetOrgBatchInfo::org_batch_id = [%s]\n",csOrgBatchId));
		PutField_CString(hOrgBatchRec,"batch_id",csOrgBatchId);
        } else {
DEBUGLOG(("GetOrgBatchInfo::org_batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::GetOrgBatchInfo::org_batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
        }

	// Get Org Batch Info
	if (iRet == PD_OK) {
	
		// Get Batch Header	
DEBUGLOG(("GetOrgBatchInfo::Call DBMiBatchHeader:: GetBatchHeader\n"));
          	DBObjPtr = CreateObj(DBPtr,"DBMiBatchHeader","GetBatchHeader");
              	iDtlRet = (unsigned long)(*DBObjPtr)(csOrgBatchId,hOrgBatchHdRec);
              	if (iDtlRet == PD_FOUND) {

/* status */
			if (GetField_Char(hOrgBatchHdRec,"status",&cTmp)) {
DEBUGLOG(("GetOrgBatchInfo::status = [%c]\n",cTmp));
				PutField_Char(hOrgBatchRec,"status",cTmp);
			}
		} else {
DEBUGLOG(("GetOrgBatchInfo:::Call DBMiBatchHeader:: GetBatchHeader Failed\n"));
ERRLOG("TxnMinByUsVRI::GetOrgBatchInfo:::Call DBMiBatchHeader:: GetBatchHeader Failed\n");
			iRet = INT_ERR;
		}

		// Get Batch Detail by Batch Id
		if (iRet == PD_OK) {

DEBUGLOG(("GetOrgBatchInfo::Call DBMiBatchDetail::GetAllDetailByBatchId:: org_batch_id [%s]\n",csOrgBatchId));
                	DBObjPtr = CreateObj(DBPtr,"DBMiBatchDetail","GetAllDetailByBatchId");
                	iDtlRet = (unsigned long)(*DBObjPtr)(csOrgBatchId,rOrgBatchDtRecordSet);
                	if (iDtlRet == PD_FOUND) {
                        	hOrgBatchDtRec = RecordSet_GetFirst(rOrgBatchDtRecordSet);
                        	while (hOrgBatchDtRec) {

/* seq */		
					if (GetField_Int(hOrgBatchDtRec,"seq",&iTmp)) {
DEBUGLOG(("GetOrgBatchInfo::seq = [%d]\n",iTmp));
                                		PutField_Int(hOrgBatchRec,"seq",iTmp);
                        		}

/* entity_id */                               
                                        if (GetField_CString(hOrgBatchDtRec,"entity_id",&csTmp)) {
DEBUGLOG(("GetOrgBatchInfo::entity_id = [%s]\n",csTmp));
                                                PutField_CString(hOrgBatchRec,"entity_id",csTmp);
                                        }

/* party_type */
                                        if (GetField_CString(hOrgBatchDtRec,"party_type",&csTmp)) {
DEBUGLOG(("GetOrgBatchInfo::party_type = [%s]\n",csTmp));
                                                PutField_CString(hOrgBatchRec,"party_type",csTmp);
                                        }

/* party_id */
                                        if (GetField_CString(hOrgBatchDtRec,"party_id",&csTmp)) {
DEBUGLOG(("GetOrgBatchInfo::party_id = [%s]\n",csTmp));
                                                PutField_CString(hOrgBatchRec,"party_id",csTmp);
                                        }

/* oper_ind */
                                        if (GetField_Char(hOrgBatchDtRec,"oper_ind",&cTmp)) {
DEBUGLOG(("GetOrgBatchInfo::oper_ind = [%c]\n",cTmp));
                                                PutField_Char(hOrgBatchRec,"oper_ind",cTmp);
                                        }

/* txn_id */
                                        if (GetField_CString(hOrgBatchDtRec,"txn_id",&csTmp)) {
DEBUGLOG(("GetOrgBatchInfo::txn_id = [%s]\n",csTmp));
                                                PutField_CString(hOrgBatchRec,"txn_id",csTmp);
                                        }

					RecordSet_Add(rOrgBatchRecordSet, hOrgBatchRec);

                        	        hOrgBatchDtRec = RecordSet_GetNext(rOrgBatchDtRecordSet);
                        	}
               	 	} else {
DEBUGLOG(("GetOrgBatchInfo::Call DBMiBatchDetail::GetAllDetailByBatchId Failed\n"));
ERRLOG("TxnMinByUsVRI::GetOrgBatchInfo::Call DBMiBatchDetail::GetAllDetailByBatchId Failed\n");
                        	iRet = INT_ERR;
                	}
		}
	}	

	hash_destroy(hOrgBatchRec);
        FREE_ME(hOrgBatchRec);

	hash_destroy(hOrgBatchHdRec);
        FREE_ME(hOrgBatchHdRec);

	RecordSet_Destroy(rOrgBatchDtRecordSet);
        FREE_ME(rOrgBatchDtRecordSet);

DEBUGLOG(("GetOrgBatchInfo Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     CheckBatchValid(hash_t* hContext, recordset_t* rOrgBatchRecordSet)
{
	int     iRet = PD_OK;

	char    *csOrgBatchId = NULL;
	char    *csProcessType = NULL;
	char    *csOrgProcessType = NULL;
	char    *csTxnId = NULL;
	char	*csTxnCode = NULL;
	char	*csSubStatus = NULL;

	char	cStatus;

	hash_t *hOrgBatchRec;

	hash_t *hTxnHdRec;
        recordset_t *rTxnHdRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rTxnHdRecordSet,0);

/* org_batch_id */
        if (GetField_CString(hContext,"org_batch_id",&csOrgBatchId)) {
DEBUGLOG(("CheckBatchValid::org_batch_id = [%s]\n",csOrgBatchId));
        } else {
DEBUGLOG(("CheckBatchValid::org_batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::org_batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
        }

/* process_type */
        if (GetField_CString(hContext,"process_type",&csProcessType)) {
DEBUGLOG(("CheckBatchValid::process_type = [%s]\n",csProcessType));

		// Compare process type - PD_MI_TXN_TYPE_VOID_DELIV_IN
		if (!strcmp(csProcessType, PD_MI_TXN_TYPE_VOID_DELIV_IN)) {
DEBUGLOG(("CheckBatchValid::process_type invalid!!\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::process_type invalid!!\n");
			iRet = INT_ERR;
                }
        } else {
DEBUGLOG(("CheckBatchValid::process_type not found!!\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::process_type not found!!\n");
                iRet = INT_MI_PROCESS_TYPE_NOT_FOUND;
        }

/* org_process_type */
        if (GetField_CString(hContext,"org_process_type",&csOrgProcessType)) {
DEBUGLOG(("CheckBatchValid::org_process_type = [%s]\n",csOrgProcessType));
		
		// Compare org process type - PD_MI_TXN_TYPE_DELIV_IN
                if (!strcmp(csOrgProcessType, PD_MI_TXN_TYPE_DELIV_IN)) {
DEBUGLOG(("CheckBatchValid::org_process_type invalid!!\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::org_process_type invalid!!\n");
                        iRet = INT_ERR;
                }
        } else {
DEBUGLOG(("CheckBatchValid::org_process_type not found!!\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::org_process_type not found!!\n");
                iRet = INT_MI_PROCESS_TYPE_NOT_FOUND;
        }
	
	// Check Org Batch Info
	if (iRet == PD_OK) {
              	hOrgBatchRec = RecordSet_GetFirst(rOrgBatchRecordSet);
                while (hOrgBatchRec) {

/* status */
                        if (GetField_Char(hOrgBatchRec,"status",&cStatus)) {
DEBUGLOG(("CheckBatchValid::status = [%c]\n",cStatus));

                                // Compare Status - PD_MI_BATCH_STATUS_INOPERATIVE
                                if (cStatus == PD_MI_BATCH_STATUS_INOPERATIVE) {
DEBUGLOG(("CheckBatchValid::batch status is inoperative\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::batch status is inoperative\n");
                                       iRet = INT_ERR;
                                }
			}

/* txn_id */
                	if (GetField_CString(hOrgBatchRec, "txn_id", &csTxnId)) {
DEBUGLOG(("CheckBatchValid::txn_id = [%s]\n", csTxnId));

DEBUGLOG(("CheckBatchValid::Call DBTransaction::GetTxnHeader:: txn_id [%s]\n",csTxnId));
                              	DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
                                iRet = (unsigned long)(*DBObjPtr)(csTxnId,rTxnHdRecordSet);
                                if (iRet == PD_OK) {
                                    	hTxnHdRec = RecordSet_GetFirst(rTxnHdRecordSet);
                                       	while (hTxnHdRec) {

/* txn_code */
						if (GetField_CString(hTxnHdRec,"txn_code",&csTxnCode)) {
DEBUGLOG(("CheckBatchValid::Call DBTransaction::GetTxnHeader:: txn_code = [%s]\n",csTxnCode));
                                              	}

/* sub_status */
                        			if (GetField_CString(hTxnHdRec,"sub_status",&csSubStatus)) {
DEBUGLOG(("CheckBatchValid::Call DBTransaction::GetTxnHeader:: sub_status = [%s]\n",csSubStatus));												
						}

						// Compare SubStatus according to different TxnCode
						if ((!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT))
                    				    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_BANK_RECEIVE_FROM_RSP))
                    				    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_UNDERPAID))
                    			 	    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_OVERPAID))
                				)
                				{
							// Compare SubStatus - PD_APPROVED (118)
							if (strcmp(csSubStatus,PD_APPROVED)) {
DEBUGLOG(("CheckBatchValid::Call DBTransaction::GetTxnHeader sub_status invalid\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::Call DBTransaction::GetTxnHeader sub_status invalid\n");
								iRet = INT_ERR;
							}
               	 				}
                				else if ((!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_IN))
                         				 || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_IN_TRANSIT))
                         				 || (!strcmp(csTxnCode,PD_PSP_SETTLEMENT))
                				)
						{
							// Compare SubStatus - PD_DELIVERED (117)
							if (strcmp(csSubStatus,PD_DELIVERED)) {
DEBUGLOG(("CheckBatchValid::Call DBTransaction::GetTxnHeader sub_status invalid\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::Call DBTransaction::GetTxnHeader sub_status invalid\n");
                                                        	iRet = INT_ERR;
                                                     	}
						}
								
						hTxnHdRec = RecordSet_GetNext(rTxnHdRecordSet);
					}
				} else {
DEBUGLOG(("CheckBatchValid::Call DBTransaction::GetTxnHeader Failed\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::Call DBTransaction::GetTxnHeader Failed\n");
                                	iRet = INT_ERR;
				}
			}

               		hOrgBatchRec = RecordSet_GetNext(rOrgBatchRecordSet);
      		}
	}

	RecordSet_Destroy(rTxnHdRecordSet);
        FREE_ME(rTxnHdRecordSet);

DEBUGLOG(("CheckBatchValid Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessVoidRspDeliveryIn(hash_t* hContext)
{
	int     iRet = PD_OK;

	char 	*csTmp = NULL;

	hash_t 	*hVoidRspDeliInTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hVoidRspDeliInTxnRec, 0);

DEBUGLOG(("===== PrcoessVoidRspDeliveryIn ===== START!!\n"));

/* txn_seq */
        if (GetField_CString(hContext,"txn_seq",&csTmp)) {
DEBUGLOG(("ProcessVoidRspDeliveryIn::txn_id = [%s]\n",csTmp));
        } else {
DEBUGLOG(("ProcessVoidRspDeliveryIn::txn_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::ProcessVoidRspDeliveryIn::txn_id not found!!\n");
                iRet = INT_INVALID_TXN;
        }

/* add_user */
        if (GetField_CString(hContext,"add_user",&csTmp)) {
DEBUGLOG(("ProcessVoidRspDeliveryIn::add_user = [%s]\n",csTmp));
                PutField_CString(hVoidRspDeliInTxnRec,"add_user",csTmp);
                PutField_CString(hVoidRspDeliInTxnRec,"update_user",csTmp);
        }

        // Form New Txn
        if (iRet == PD_OK) {
               	iRet = FormVoidRspDeliveryInTxn(hContext, hVoidRspDeliInTxnRec);
        }

        // Create Txn + Update Balance (with add approval_date, approval_timestamp)
        if (iRet == PD_OK) {
                iRet = ProcessVoidRspDeliveryInTxn(hContext, hVoidRspDeliInTxnRec);
        }

DEBUGLOG(("PrcoessVoidRspDeliveryIn:: iRet [%d]\n", iRet));
DEBUGLOG(("===== PrcoessVoidRspDeliveryIn ===== END !!\n"));

	hash_destroy(hVoidRspDeliInTxnRec);
        FREE_ME(hVoidRspDeliInTxnRec);

DEBUGLOG(("ProcessVoidRspDeliveryIn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     FormVoidRspDeliveryInTxn(hash_t* hContext, hash_t* hTxnRec)
{
        int     iRet = PD_OK;
        int     iDtlRet = PD_FOUND;

        double  dTmp = 0.0;
	
	char	cTmp;

	char	*csOrgTxnCode = NULL;
        char    *csTmp = NULL;

	char    csVoidTxnCode[PD_TXN_CODE_LEN + 1];
        char    csTxnDateTime[PD_DATETIME_LEN + 1];

/* txn_seq */
        if (GetField_CString(hTxnRec, "txn_seq", &csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: txn_seq [%s]\n", csTmp));
	}

	// Txn Header
	if (iRet == PD_OK) {

/* channel_code */
                if (GetField_CString(hContext, "channel_code", &csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: channel_code [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "channel_code", csTmp);
                }

/* service_code */
                if (GetField_CString(hContext, "service_code", &csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: service_code [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "service_code", csTmp);
                }

/* status */
                PutField_Char(hTxnRec,"status",PD_PROCESSING);
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: status [%c]\n", PD_PROCESSING));

/* txn_code */
		if (GetField_CString(hContext, "org_txn_code", &csOrgTxnCode)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: org_txn_code [%s]\n", csOrgTxnCode));			

			// Get void txn code from DBTxnCode
DEBUGLOG(("FormVoidRspDeliveryInTxn::Call DBTxnCode:: FindVoidTxnCode\n"));
			DBObjPtr = CreateObj(DBPtr, "DBTxnCode", "FindVoidTxnCode");
                       	iDtlRet = (unsigned long)(*DBObjPtr)(csOrgTxnCode,csVoidTxnCode);
                        if (iDtlRet == PD_FOUND) {
				PutField_CString(hTxnRec, "txn_code", csVoidTxnCode);
DEBUGLOG(("FormVoidRspDeliveryInTxn::txn_code [%s]\n", csVoidTxnCode));
			} else {
DEBUGLOG(("FormVoidRspDeliveryInTxn::Call DBTxnCode:: FindVoidTxnCode Failed\n"));
                            	iRet = INT_ERR;
                   	}	
		}

/* process_type */
                PutField_CString(hTxnRec,"process_code", PD_PROCESS_CODE_DEF);
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: process_code [%s]\n", PD_PROCESS_CODE_DEF));

/* process_code */
                PutField_CString(hTxnRec,"process_type", PD_PROCESS_TYPE_DEF);
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: process_type [%s]\n", PD_PROCESS_TYPE_DEF));

/* response_code */
                PutField_CString(hTxnRec, "response_code", "0");
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: response_code [%s]\n", "0"));

/* internal_code */
                PutField_Int(hTxnRec, "internal_code", 0);
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: internal_code [%d]\n", 0));

/* host_posting_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: PHDATE [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"PHDATE",csTmp);
                }

/* transmission_datetime */
                if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: local_tm_date [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "local_tm_date", csTmp);
                        PutField_CString(hTxnRec, "tm_date", csTmp);

                        strcpy(csTxnDateTime, csTmp);
                        PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);

                        if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: local_tm_time [%s]\n", csTmp));
                                PutField_CString(hTxnRec, "local_tm_time", csTmp);
                                strcat(csTxnDateTime, csTmp);
                                PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);
                        }
                }

/* net_ccy */
                if (GetField_CString(hContext,"net_ccy",&csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: net_ccy = [%s]\n",csTmp));
                        PutField_CString(hTxnRec,"net_ccy",csTmp);
                }

/* net_amt */
                if (GetField_Double(hContext,"net_amt",&dTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: net_amt = [%lf]\n",dTmp));
                        PutField_Double(hTxnRec,"net_amt",dTmp);
                }

/* txn_amt */
                if (GetField_Double(hContext,"txn_amt",&dTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: txn_amt = [%lf]\n",dTmp));
                        PutField_Double(hTxnRec,"txn_amt",dTmp);
                }

/* ex_supplier */
		if (GetField_Char(hContext,"ex_supplier",&cTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: ex_supplier [%c]\n", cTmp));
                 	PutField_Char(hTxnRec,"ex_supplier",cTmp);
		}

/* ex_rate */
		if (GetField_Double(hContext,"ex_rate",&dTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: ex_rate = [%lf]\n",dTmp));
                	PutField_Double(hTxnRec,"ex_rate",dTmp);
		}
        }

	// Txn Detail
	if (iRet == PD_OK) {

/* txn_country */
                if (GetField_CString(hContext, "txn_country", &csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: txn_country = [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "txn_country", csTmp);
                }

/* txn_ccy */
                if (GetField_CString(hContext, "txn_ccy", &csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn (TxnLog):: txn_ccy = [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "txn_ccy", csTmp);
                }
        }

	// Txn Mi Detail
	if (iRet == PD_OK) {

/* entity_id */
                if (GetField_CString(hContext,"entity_id",&csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: entity_id = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"entity_id",csTmp);
                }

/* party_type */
                if (GetField_CString(hContext,"party_type",&csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: party_type = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"party_type",csTmp);
                }

/* party_id */
                if (GetField_CString(hContext,"party_id",&csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: party_id = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"party_id",csTmp);
                }

/* txn_ccy */
                if (GetField_CString(hContext,"txn_ccy",&csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: txn_ccy = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"txn_ccy",csTmp);
                        PutField_CString(hTxnRec,"ccy",csTmp);
                }

/* txn_country */
                if (GetField_CString(hContext,"txn_country",&csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: txn_country = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"txn_country",csTmp);
                        PutField_CString(hTxnRec,"country",csTmp);
                }

/* txn_product */
                if (GetField_CString(hContext,"txn_product",&csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: txn_product = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"txn_product",csTmp);
                }

/* txn_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: txn_date = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"txn_date",csTmp);
                }

/* report_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: report_date = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"report_date",csTmp);
                }

/* cost_rate */
           	if (GetField_Double(hContext,"cost_rate",&dTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: cost_rate = [%f]\n", dTmp));
                     	PutField_Double(hTxnRec,"cost_rate",dTmp);
             	}

/* actual_cost */
             	if (GetField_Double(hContext,"actual_cost",&dTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: actual_cost = [%f]\n", dTmp));
                      	PutField_Double(hTxnRec,"actual_cost",dTmp);
             	}

/* remittance_slip_date */
              	if (GetField_CString(hContext,"remittance_slip_date",&csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: remittance_slip_date = [%s]\n", csTmp));
                   	PutField_CString(hTxnRec,"remittance_slip_date",csTmp);
           	}

/* converted_ccy */
               	if (GetField_CString(hContext,"converted_ccy",&csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: converted_ccy = [%s]\n", csTmp));
                      	PutField_CString(hTxnRec,"converted_ccy",csTmp);
            	}

/* converted_amount */
            	if (GetField_Double(hContext,"converted_amount",&dTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: converted_amount = [%f]\n", dTmp));
                     	PutField_Double(hTxnRec,"converted_amount",dTmp);
            	}

/* entity_ccy */
                if (GetField_CString(hContext,"entity_ccy",&csTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: entity_ccy = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"entity_ccy",csTmp);
                }

/* entity_txn_amount */
                if (GetField_Double(hContext,"entity_txn_amount",&dTmp)) {
DEBUGLOG(("FormVoidRspDeliveryInTxn:: entity_txn_amount = [%f]\n", dTmp));
                        PutField_Double(hTxnRec,"entity_txn_amount",dTmp);
                }

/* acr_prorata */
		PutField_Int(hTxnRec,"acr_prorata",PD_FALSE);
DEBUGLOG(("FormVoidRspDeliveryInTxn:: acr_prorata = [%d]\n", PD_FALSE));
	
	}

DEBUGLOG(("FormVoidRspDeliveryInTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessVoidRspDeliveryInTxn(hash_t* hContext, hash_t* hTxnRec)
{
        int     iRet = PD_OK;

        int     iTmp = 0;

        double  dTmp = 0.0;

        char    *csTxnId = NULL;
        char    *csApprovalDate = NULL;
        char    *csApprovalTimestamp = NULL;

/* txn_seq */
        if (GetField_CString(hTxnRec, "txn_seq", &csTxnId)) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn:: txn_seq [%s]\n", csTxnId));
        }

	// Update Txn Header
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Update TxnHeader
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call DBTransaction:: Update\n"));
                                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                                iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                if (iRet != PD_OK) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call DBTransaction:: Update Failed\n"));
                                        iRet = INT_ERR;
                                }
                        }
                }
        }

	// Add and Update Txn Detail
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add TxnDetail
                                if (iRet == PD_OK) {

DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call DBTransaction:: AddDetail\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call DBTransaction:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }

                                // Update TxnDetail
                                if (iRet == PD_OK) {
/*
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call DBTransaction:: Update\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call DBTransaction:: Update Failed\n"));
                                                iRet = INT_ERR;
                                        }
*/
                                }
                        }
                }
        }	
	
	// Update Entity Balance
	if (iRet == PD_OK) {

                // batch_mode
                PutField_Char(hTxnRec, "batch_mode", PD_ONLINE);
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::batch_mode = [%c]\n",PD_ONLINE));

                // amt_type
                PutField_CString(hTxnRec, "amt_type", PD_CR);
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::amt_type = [%s]\n",PD_CR));

                // bal_type
                PutField_Char(hTxnRec, "bal_type", PD_MI_ENTITY_POOL_ACCT_BAL);
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::bal_type = [%c]\n",PD_MI_ENTITY_POOL_ACCT_BAL));

                // UpdateEntityBalance
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call BOMiEntityBalance:: UpdateEntityBalance\n"));
                BOObjPtr = CreateObj(BOPtr, "BOMiEntityBalance", "UpdateEntityBalance");
                iRet = (unsigned long)(*BOObjPtr)(hTxnRec,hTxnRec);
                if (iRet == PD_OK) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Success\n"));

                        if (GetField_CString(hTxnRec, "approval_date", &csApprovalDate)) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call BOMiEntityBalance:: approval_date [%s]\n", csApprovalDate));
                        }

                        if (GetField_CString(hTxnRec, "approval_timestamp", &csApprovalTimestamp))  {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call BOMiEntityBalance:: approval_timestamp [%s]\n", csApprovalTimestamp));
                        }

                        // Open Balance
                        if (GetField_Double(hTxnRec, "open_acct_bal", &dTmp)) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call BOMiEntityBalance:: open_acct_bal = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "open_intransit", &dTmp)) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call BOMiEntityBalance:: open_intransit = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "open_ar_bal", &dTmp)) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call BOMiEntityBalance:: open_ar_bal = [%f]\n", dTmp));
                        }

                        // Close Balance
                        if (GetField_Double(hTxnRec, "acct_bal", &dTmp)) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call BOMiEntityBalance:: closing acct_bal = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "intransit", &dTmp)) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call BOMiEntityBalance:: closing intransit = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "ar_bal", &dTmp)) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call BOMiEntityBalance:: closing ar_bal = [%f]\n", dTmp));
                        }

                } else {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n"));
ERRLOG("TxnMinByUsVRI::ProcessVoidRspDeliveryInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n");
                        iRet = INT_ERR;
                }
        }

	// Add Txn Mi Detail
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add TxnMiDetail
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call DBTxnMiDetail:: Add\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Add");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call DBTxnMiDetail:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
        }

	// Add Mi Txn Log
	if (iRet == PD_OK) {

                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add MiTxnLog
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call DBTransaction:: AddMiTxnLog\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddMiTxnLog");
                                        iRet = (unsigned long)(*DBObjPtr)(csTxnId);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call DBTransaction:: AddMiTxnLog Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
        }

	// Update Status, Ar_Ind, Sub Status, Approval Date and Approval Timestamp
	if (iRet == PD_OK) {

/* status */
                PutField_Char(hTxnRec,"status",PD_COMPLETE);
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::status [%c]\n", PD_COMPLETE));

/* ar_ind */
                PutField_Char(hTxnRec,"ar_ind",PD_ACCEPT);
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::ar_ind [%c]\n", PD_ACCEPT));

/* sub_status */
                PutField_CString(hTxnRec,"sub_status",PD_APPROVED);
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::sub_status [%s]\n", PD_APPROVED));

/* approval_date */
                PutField_CString(hTxnRec, "approval_date", csApprovalDate);
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::approval_date [%s]\n", csApprovalDate));

/* approval_timestamp */
                PutField_CString(hTxnRec, "approval_timestamp", csApprovalTimestamp);
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::approval_timestamp [%s]\n", csApprovalTimestamp));

DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call DBTransaction: Update \n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("ProcessVoidRspDeliveryInTxn::Call DBTransaction:: Update Failed\n"));
                }
        }

DEBUGLOG(("ProcessVoidRspDeliveryInTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int	ProcessOrgBatch(hash_t* hContext, recordset_t *rOrgBatchRecordSet)
{
	int     iRet = PD_OK;

	char	*csBatchId = NULL;
	char	*csTxnId = NULL;
	char	*csTxnCode = NULL;
	char	*csUser = NULL;

	hash_t 	*hOrgBatchRec;
	
	hash_t  *hOrgBatchTxnRec;
	hOrgBatchTxnRec = (hash_t*) malloc (sizeof(hash_t));
	
	hash_t *hTxnRec;
        recordset_t *rTxnRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rTxnRecordSet,0);

/* org_batch_id */
        if (GetField_CString(hContext,"org_batch_id",&csBatchId)) {
DEBUGLOG(("ProcessOrgBatch::org_batch_id = [%s]\n",csBatchId));
        } else {
DEBUGLOG(("ProcessOrgBatch::batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::ProcessOrgBatch::batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
        }

/* add_user */
        if (GetField_CString(hContext, "add_user", &csUser)) {
DEBUGLOG(("ProcessOrgBatch:: upate_user [%s]\n", csUser));
        }

	// Get Org Batch Info
	if (iRet == PD_OK) {
           	hOrgBatchRec = RecordSet_GetFirst(rOrgBatchRecordSet);
               	while (hOrgBatchRec) {

			hash_init(hOrgBatchTxnRec,0);	

/* txn_id */
			if (GetField_CString(hOrgBatchRec, "txn_id", &csTxnId)) {
DEBUGLOG(("ProcessOrgBatch::Call DBMiBatchDetail::GetAllDetailByBatchId txn_id [%s]\n", csTxnId));
				PutField_CString(hOrgBatchTxnRec, "txn_seq", csTxnId);

DEBUGLOG(("ProcessOrgBatch::Call DBTransaction::GetTxnHeader:: txn_id [%s]\n",csTxnId));
                		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
                		iRet = (unsigned long)(*DBObjPtr)(csTxnId,rTxnRecordSet);
                		if (iRet == PD_OK) {
                        		hTxnRec = RecordSet_GetFirst(rTxnRecordSet);
                        		while (hTxnRec) {

/* txn_code */
						if (GetField_CString(hTxnRec, "txn_code", &csTxnCode)) {
DEBUGLOG(("ProcessOrgBatch::Call DBTransaction::GetTxnHeader txn_code [%s]\n", csTxnCode));
							PutField_CString(hOrgBatchTxnRec, "txn_code", csTxnCode);

							// user
							PutField_CString(hOrgBatchTxnRec, "update_user", csUser);
			
							// Compare TxnCode
							if ((!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT))
							    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_BANK_RECEIVE_FROM_RSP))
							    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_UNDERPAID))
							    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_OVERPAID))
							    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_IN))
							)
							{	
								// Lock Org Batch Txn + Get Org Batch Txn
								iRet =  GetOrgBatchTxnInfo(hOrgBatchTxnRec);
                                                       	}
				
							// Update Org Batch Txn
							if (iRet == PD_OK) {
								iRet = ProcessOrgBatchTxn(hContext, hOrgBatchTxnRec);
							}
						}

						hTxnRec = RecordSet_GetNext(rTxnRecordSet);
                        		}
                		} else {
DEBUGLOG(("ProcessOrgBatch::Call DBTransaction::GetTxnHeader Failed\n"));
                        		iRet = INT_ERR;
                		}
			}			

			hash_destroy(hOrgBatchTxnRec);

			hOrgBatchRec = RecordSet_GetNext(rOrgBatchRecordSet);
                }
	}

        FREE_ME(hOrgBatchTxnRec);

	RecordSet_Destroy(rTxnRecordSet);
	FREE_ME(rTxnRecordSet);

DEBUGLOG(("ProcessOrgBatch Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     GetOrgBatchTxnInfo(hash_t* hTxnRec)
{	
        int     iRet = PD_OK;

	double	dTmp = 0.0;

        char    *csTxnId = (char*) malloc (PD_TXN_SEQ_LEN);
        char    *csTmp = NULL;

        hash_t  *hRec = NULL;

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

/* txn_seq */
        if (GetField_CString(hTxnRec,"txn_seq",&csTxnId)) {
DEBUGLOG(("GetOrgBatchTxnInfo::txn_id = [%s]\n",csTxnId));
        } else {
DEBUGLOG(("GetOrgBatchTxnInfo::txn_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::GetOrgBatchTxnInfo::txn_id not found!!\n");
                iRet = INT_INVALID_TXN;
        }

	// Get Txn Header
	if(iRet==PD_OK){	
		recordset_init(rRecordSet,0);

DEBUGLOG(("GetOrgBatchTxnInfo::Call DBTransaction::GetTxnHeader:: txn_id [%s]\n",csTxnId));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
                iRet = (unsigned long)(*DBObjPtr)(csTxnId,rRecordSet);
                if (iRet == PD_OK) {
DEBUGLOG(("GetOrgBatchTxnInfo::Call DBTransaction::GetTxnHeader Success\n"));
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* txn_code */		
                                if(GetField_CString(hRec,"txn_code",&csTmp)){
DEBUGLOG(("GetOrgBatchTxnInfo::txn_code = [%s]\n",csTmp));
                                        PutField_CString(hTxnRec,"txn_code",csTmp);
                                }

/* net_ccy */
                                if(GetField_CString(hRec,"net_ccy",&csTmp)){
DEBUGLOG(("GetOrgBatchTxnInfo::net_ccy = [%s]\n",csTmp));
                                        PutField_CString(hTxnRec,"net_ccy",csTmp);
                                }

/* net_amt */
                                if(GetField_Double(hRec,"net_amt",&dTmp)){
DEBUGLOG(("GetOrgBatchTxnInfo::net_amt = [%lf]\n",dTmp));
                                        PutField_Double(hTxnRec,"net_amt",dTmp);
                                }

/* txn_amt */
                                if(GetField_Double(hRec,"txn_amt",&dTmp)){
DEBUGLOG(("GetOrgBatchTxnInfo::txn_amt = [%lf]\n",dTmp));
                                        PutField_Double(hTxnRec,"txn_amt",dTmp);
                                }
			
				hRec = RecordSet_GetNext(rRecordSet);				
			}
                } else {
DEBUGLOG(("GetOrgBatchTxnInfo::Call DBTransaction::GetTxnHeader Failed\n"));
                        iRet = INT_ERR;
                }

		RecordSet_Destroy(rRecordSet);
	}

	// Get Txn Mi Detail
	if(iRet==PD_OK){
                recordset_init(rRecordSet,0);

DEBUGLOG(("GetOrgBatchTxnInfo::Call TxnMiDetail:GetTxnMiDetail: txn_id = [%s]\n", csTxnId));
                DBObjPtr = CreateObj(DBPtr, "DBTxnMiDetail", "GetTxnMiDetail");
                iRet = (unsigned long)(*DBObjPtr)(csTxnId, rRecordSet);
                if (iRet == PD_OK) {
DEBUGLOG(("GetOrgBatchTxnInfo::Call TxnMiDetail:GetTxnMiDetail:SUCCESS\n"));

                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* entity_id */
                                if (GetField_CString(hRec,"entity_id",&csTmp)) {
DEBUGLOG(("GetOrgBatchTxnInfo::Call TxnMiDetail:GetTxnMiDetail: entity_id = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"entity_id",csTmp);
                                }

/* party_type */
                                if (GetField_CString(hRec,"party_type",&csTmp)) {
DEBUGLOG(("GetOrgBatchTxnInfo::Call TxnMiDetail:GetTxnMiDetail: party_type = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"party_type",csTmp);
                                }

/* party_id */
                                if (GetField_CString(hRec,"party_id",&csTmp)) {
DEBUGLOG(("GetOrgBatchTxnInfo::Call TxnMiDetail:GetTxnMiDetail: party_id = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"party_id",csTmp);
                                }

/* txn_ccy */
                                if (GetField_CString(hRec,"txn_ccy",&csTmp)) {
DEBUGLOG(("GetOrgBatchTxnInfo::Call TxnMiDetail:GetTxnMiDetail: txn_ccy = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"txn_ccy",csTmp);
                                }

/* txn_country */
                                if (GetField_CString(hRec,"txn_country",&csTmp)) {
DEBUGLOG(("GetOrgBatchTxnInfo::Call TxnMiDetail:GetTxnMiDetail: txn_country = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"txn_country",csTmp);
                                }

/* entity_ccy */
                                if (GetField_CString(hRec,"entity_ccy",&csTmp)) {
DEBUGLOG(("GetOrgBatchTxnInfo::Call TxnMiDetail:GetTxnMiDetail: entity_ccy = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"entity_ccy",csTmp);
                                }

/* entity_txn_amount */
                                if (GetField_Double(hRec,"entity_txn_amount",&dTmp)) {
DEBUGLOG(("GetOrgBatchTxnInfo::Call TxnMiDetail:GetTxnMiDetail: entity_txn_amount = [%f]\n", dTmp));
                                        PutField_Double(hTxnRec,"entity_txn_amount",dTmp);
                                }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
		} else {
DEBUGLOG(("GetOrgBatchTxnInfo::Call TxnMiDetail:GetTxnMiDetail:Failed\n"));
                        iRet = INT_ERR;
                }

                RecordSet_Destroy(rRecordSet);
        }

        FREE_ME(csTxnId);
        FREE_ME(rRecordSet);

DEBUGLOG(("GetOrgBatchTxnInfo Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}	

int     ProcessOrgBatchTxn(hash_t* hContext, hash_t* hTxnRec)
{
	int     iRet = PD_OK;

	int	iTmp = 0;

        char    *csTxnId = NULL;
	char	*csTxnCode = NULL;
        char    *csApprovalDate = NULL;
        char    *csApprovalTimestamp = NULL;

/* txn_seq */
        if (GetField_CString(hTxnRec, "txn_seq", &csTxnId)) {
DEBUGLOG(("ProcessOrgBatchTxn:: txn_seq [%s]\n", csTxnId));
        }

/* txn_code */
	if (GetField_CString(hTxnRec, "txn_code", &csTxnCode)) {
DEBUGLOG(("ProcessOrgBatchTxn:: txn_code [%s]\n", csTxnCode));
        }

	// Do Logging
	if (iRet == PD_OK) {

/* do_logging */
                PutField_Int(hTxnRec, "do_logging", PD_TRUE);
DEBUGLOG(("ProcessOrgBatchTxn:: do_logging [%d]\n", PD_TRUE));

	}
			
	// Update Entity Balance
	if (iRet == PD_OK) {

	}
	
	// Update Mi Txn Detail
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hTxnRec,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessOrgBatchTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Update TxnMiDetail
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessOrgBatchTxn::Call DBTxnMiDetail:: Update\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Update");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessOrgBatchTxn::Call DBTxnMiDetail:: Update Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }

				// Update Prev Grp Txn Id to NULL
				if (iRet == PD_OK) {
					if (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT)) {
DEBUGLOG(("ProcessOrgBatchTxn::Call DBTxnMiDetail: UpdatePrevGrpTxnId2NULL \n"));
                        			DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","UpdatePrevGrpTxnId2NULL");
                        			iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                        			if (iRet != PD_OK) {
DEBUGLOG(("ProcessOrgBatchTxn::Call DBTxnMiDetail: UpdatePrevGrpTxnId2NULL Failed\n"));
                                			iRet = INT_ERR;
                        			}
					}
				}

				// Update Next Grp Txn Id to NULL
				if (iRet == PD_OK) {
					if (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_IN)) {
DEBUGLOG(("ProcessOrgBatchTxn::Call DBTxnMiDetail: UpdateNextGrpTxnId2NULL \n"));
                        			DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","UpdateNextGrpTxnId2NULL");
	                		        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
        		        	        if (iRet != PD_OK) {
DEBUGLOG(("ProcessOrgBatchTxn::Call DBTxnMiDetail: UpdateNextGrpTxnId2NULL Failed\n"));
                                			iRet = INT_ERR;
                        			}
					}
				}
                        }
                }
	}	

	// Update Txn Header (Sub Status, Approval Date and Approval Timestamp)
        if (iRet == PD_OK) {

/* sub_status */
		if ((!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT))
		    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_BANK_RECEIVE_FROM_RSP))
		    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_UNDERPAID))
		    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_OVERPAID))  
		)
		{	
                	PutField_CString(hTxnRec,"sub_status",PD_UNDO);
DEBUGLOG(("ProcessOrgBatchTxn::sub_status [%s]\n", PD_UNDO));
		} 
		else if ((!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_IN))
			 || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_IN_TRANSIT))
			 || (!strcmp(csTxnCode,PD_PSP_SETTLEMENT)) 
		)
		{
			PutField_CString(hTxnRec,"sub_status",PD_APPROVED);
DEBUGLOG(("ProcessOrgBatchTxn::sub_status [%s]\n", PD_APPROVED));
		}

/* approval_date */
                PutField_CString(hTxnRec, "approval_date", csApprovalDate);
DEBUGLOG(("ProcessOrgBatchTxn::approval_date [%s]\n", csApprovalDate));

/* approval_timestamp */
                PutField_CString(hTxnRec, "approval_timestamp", csApprovalTimestamp);
DEBUGLOG(("ProcessOrgBatchTxn::approval_timestamp [%s]\n", csApprovalTimestamp));

/* do_logging */
                PutField_Int(hTxnRec, "do_logging", PD_FALSE);
DEBUGLOG(("ProcessOrgBatchTxn:: do_logging [%d]\n", PD_FALSE));

DEBUGLOG(("ProcessOrgBatchTxn::Call DBTransaction: Update \n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("ProcessOrgBatchTxn::Call DBTransaction:: Update Failed\n"));
                }
        }

DEBUGLOG(("ProcessOrgBatchTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessVoidBatch(hash_t* hContext, recordset_t *rOrgBatchRecordSet)
{
	int     iRet = PD_OK;

	int	iSeq = 0;

	char	*csBatchId = NULL;
	char	*csUser = NULL;
        char    *csTmp = NULL;

        hash_t *hOrgBatchRec;

	hash_t *hVoidBatchRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hVoidBatchRec, 0);

/* batch_id */
        if (GetField_CString(hContext,"batch_id",&csBatchId)) {
DEBUGLOG(("ProcessVoidBatch::batch_id = [%s]\n",csBatchId));
        } else {
DEBUGLOG(("ProcessVoidBatch::batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::ProcessVoidBatch::batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* org_batch_id */
        if (GetField_CString(hContext,"org_batch_id",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::org_batch_id = [%s]\n",csTmp));
        } else {
DEBUGLOG(("ProcessVoidBatch::batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::ProcessVoidBatch::batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* add_user */
        if (GetField_CString(hContext, "add_user", &csUser)) {
DEBUGLOG(("ProcessVoidBatch:: upate_user [%s]\n", csUser));
        }

	// Add Void RSP Delivery In Txn
	if (iRet == PD_OK) {

		hash_init(hVoidBatchRec, 0);

// batch_id
		PutField_CString(hVoidBatchRec,"batch_id",csBatchId);
DEBUGLOG(("ProcessVoidBatch::batch_id = [%s]\n", csBatchId));

// seq
		PutField_Int(hVoidBatchRec,"seq",++iSeq);
DEBUGLOG(("ProcessVoidBatch::seq = [%d]\n", iSeq));

// txn_oper_ind
             	PutField_Char(hVoidBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_INSERT);
DEBUGLOG(("ProcessVoidBatch::txn_oper_ind = [%c]\n", PD_MI_BATCH_TXN_OPER_INSERT));

// user
		PutField_CString(hVoidBatchRec,"add_user",csUser);
                PutField_CString(hVoidBatchRec,"update_user",csUser);
DEBUGLOG(("ProcessVoidBatch::user = [%s]\n", csUser));

/* txn_id */
              	if (GetField_CString(hContext, "txn_seq", &csTmp)) {
DEBUGLOG(("ProcessVoidBatch::txn_seq = [%s]\n", csTmp));
                      	PutField_CString(hVoidBatchRec,"txn_id",csTmp);
               	}

/* entity_id */
             	if (GetField_CString(hContext,"entity_id",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::entity_id = [%s]\n", csTmp));
                     	PutField_CString(hVoidBatchRec,"entity_id",csTmp);
              	}

/* party_type */
              	if (GetField_CString(hContext,"party_type",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::party_type = [%s]\n", csTmp));
                    	PutField_CString(hVoidBatchRec,"party_type",csTmp);
               	}

/* party_id */
             	if (GetField_CString(hContext,"party_id",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::party_id = [%s]\n", csTmp));
                     	PutField_CString(hVoidBatchRec,"party_id",csTmp);
              	}

		// Add Void Batch
DEBUGLOG(("ProcessVoidBatch::Call MiBatchDetail: Add \n"));
             	DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
             	iRet = (unsigned long)(*DBObjPtr)(hVoidBatchRec);
             	if (iRet != PD_OK) {
                      	iRet = INT_ERR;
DEBUGLOG(("ProcessVoidBatch::Call MiBatchDetail:: Add Failed\n"));
            	}

		hash_destroy(hVoidBatchRec);
	}

	// Add Org Batch Txn
        if (iRet == PD_OK) {
		hOrgBatchRec = RecordSet_GetFirst(rOrgBatchRecordSet);
                while (hOrgBatchRec) {

			hash_init(hVoidBatchRec, 0);

// batch_id
			PutField_CString(hVoidBatchRec,"batch_id",csBatchId);
DEBUGLOG(("ProcessVoidBatch::batch_id = [%s]\n", csBatchId));

// seq
                        PutField_Int(hVoidBatchRec,"seq",++iSeq);
DEBUGLOG(("ProcessVoidBatch::seq = [%d]\n", iSeq));

// txn_oper_ind
                	PutField_Char(hVoidBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_UPDATE);
DEBUGLOG(("ProcessVoidBatch::txn_oper_ind = [%c]\n", PD_MI_BATCH_TXN_OPER_UPDATE));

// user
                	PutField_CString(hVoidBatchRec,"add_user",csUser);
                	PutField_CString(hVoidBatchRec,"update_user",csUser);
DEBUGLOG(("ProcessVoidBatch::user = [%s]\n", csUser));

/* txn_id */
                       	if (GetField_CString(hOrgBatchRec, "txn_id", &csTmp)) {
DEBUGLOG(("ProcessVoidBatch::batch_txn_id = [%s]\n", csTmp));
                          	 PutField_CString(hVoidBatchRec,"txn_id",csTmp);
                     	}

/* entity_id */
        		if (GetField_CString(hOrgBatchRec,"entity_id",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::entity_id = [%s]\n", csTmp));
                		PutField_CString(hVoidBatchRec,"entity_id",csTmp);
        		}

/* party_type */
        		if (GetField_CString(hOrgBatchRec,"party_type",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::party_type = [%s]\n", csTmp));
                		PutField_CString(hVoidBatchRec,"party_type",csTmp);
        		}

/* party_id */
        		if (GetField_CString(hOrgBatchRec,"party_id",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::party_id = [%s]\n", csTmp));
                		PutField_CString(hVoidBatchRec,"party_id",csTmp);
        		}

			// Add Void Batch
DEBUGLOG(("ProcessVoidBatch::Call MiBatchDetail: Add \n"));
        		DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
        		iRet = (unsigned long)(*DBObjPtr)(hVoidBatchRec);
        		if (iRet != PD_OK) {
                		iRet = INT_ERR;
DEBUGLOG(("ProcessVoidBatch::Call MiBatchDetail:: Add Failed\n"));
        		}

			hash_destroy(hVoidBatchRec);
			
			hOrgBatchRec = RecordSet_GetNext(rOrgBatchRecordSet);
                }
	}
	
	FREE_ME(hVoidBatchRec);

DEBUGLOG(("ProcessVoidBatch Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessVoidACR(hash_t* hContext, recordset_t* rOrgBatchRecordSet)
{
	int     iRet = PD_OK;

        char    *csBatchId = NULL;
        char    *csUser = NULL;
        //char    *csTmp = NULL;

/* batch_id */
        if (GetField_CString(hContext,"batch_id",&csBatchId)) {
DEBUGLOG(("ProcessVoidACR::batch_id = [%s]\n",csBatchId));
        } else {
DEBUGLOG(("ProcessVoidACR::batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::ProcessVoidBatch::batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* add_user */
        if (GetField_CString(hContext, "add_user", &csUser)) {
DEBUGLOG(("ProcessVoidACR:: upate_user [%s]\n", csUser));
        }

DEBUGLOG(("ProcessVoidACR Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}
