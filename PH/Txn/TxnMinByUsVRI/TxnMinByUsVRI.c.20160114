/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/11/27              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMinByUsVRI.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

int	GetOrgBatchInfo(hash_t* hContext, recordset_t* rOrgBatchRecordSet);
int	CheckBatchValid(hash_t* hContext, recordset_t* rOrgBatchRecordSet);
int	ProcessNew(hash_t* hContext, recordset_t* rOrgBatchRecordSet);
int     GetOrgTxnInfo(hash_t* hTxnRec);
int     FormNewTxn(hash_t* hContext, hash_t* hOrgTxnRec, hash_t* hTxnRec);
int     ProcessNewTxn(hash_t* hContext, hash_t* hTxnRec);
int     ProcessOrgBatch(hash_t* hContext, recordset_t* rOrgBatchRecordSet);
int     ProcessVoidBatch(hash_t* hContext, recordset_t* rOrgBatchRecordSet);
int	ProcessVoidACR(hash_t* hContext);

void TxnMinByUsVRI(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
		  hash_t* hRequest,
		  hash_t* hResponse)
{
        int	iRet = PD_OK;

	char	*csTmp = NULL;

	recordset_t *rOrgBatchRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rOrgBatchRecordSet,0);

DEBUGLOG(("Authorize::TxnMinByUsVRI Begin\n"));

/* txn_seq */
        if (GetField_CString(hContext,"txn_seq",&csTmp)) {
DEBUGLOG(("Authorize::txn_seq = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::txn_seq not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::txn_seq not found!!\n");
                iRet = INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* org_txn_seq */
        if (GetField_CString(hContext,"org_txn_seq",&csTmp)) {
DEBUGLOG(("Authorize::org_txn_seq = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::org_txn_seq not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::org_txn_seq not found!!\n");
                iRet = INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* batch_id */
        if (GetField_CString(hContext,"batch_id",&csTmp)) {
DEBUGLOG(("Authorize::batch_id = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
	}

/* org_batch_id */
        if (GetField_CString(hContext,"org_batch_id",&csTmp)) {
DEBUGLOG(("Authorize::org_batch_id = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::org_batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::org_batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* last_batch_id */
        if (GetField_CString(hContext,"last_batch_id",&csTmp)) {
DEBUGLOG(("Authorize::last_batch_id = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::last_batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::last_batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* mini_txn_type (process_type) */
        if (GetField_CString(hContext,"mini_txn_type",&csTmp)) {
DEBUGLOG(("Authorize::mini_txn_type (process_type) = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::mini_txn_type (process_type) not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::process_type not found!!\n");
                iRet = INT_MI_PROCESS_TYPE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* org_process_type */
        if (GetField_CString(hContext,"org_process_type",&csTmp)) {
DEBUGLOG(("Authorize::org_process_type = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::org_process_type not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::org_process_type not found!!\n");
                iRet = INT_MI_PROCESS_TYPE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* last_process_type */
        if (GetField_CString(hContext,"last_process_type",&csTmp)) {
DEBUGLOG(("Authorize::last_process_type = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::last_process_type not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::last_process_type not found!!\n");
                iRet = INT_MI_PROCESS_TYPE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* add_user */
        if (GetField_CString(hContext,"add_user",&csTmp)) {
DEBUGLOG(("Authorize::add_user = [%s]\n",csTmp));
        }

/* update_user */
        if (GetField_CString(hContext,"update_user",&csTmp)) {
DEBUGLOG(("Authorize::update_user = [%s]\n",csTmp));
        }

/*
 *
 * Get Org Batch Info:		1. Org Batch Header
 * 				2. Org Batch Detail
 * 				3. Org Batch - Txn Header
 * 				4. Org Batch - Txn Code
 *
 */
	if (iRet == PD_OK) {
		iRet = GetOrgBatchInfo(hContext, rOrgBatchRecordSet);
                if (iRet != PD_OK) {
                        PutField_Int(hContext,"internal_error",iRet);
                }
	}

/*
 *
 * Check Batch Valid:		1. Org Batch
 * 				2. Void Batch
 *
 */
	if (iRet == PD_OK) {
		iRet = CheckBatchValid(hContext, rOrgBatchRecordSet);
		if (iRet != PD_OK) {
			PutField_Int(hContext,"internal_error",iRet);
		}
	}

/*
 * 
 * Generate New Txn:          	1. Void RSP Delivery Out Txn    - Creit(Void) Rsp Available Balance
 * 				2. Void OPB Fund In Txn    	- Debit(Void) Op Bank Balance
 * 				3. Void RSP Amt Diff Txn        - Debit/Cebit(Void) AR Balance
 * 
 */
        if (iRet == PD_OK) {
                iRet = ProcessNew(hContext, rOrgBatchRecordSet);
        }

/*
 *
 * Update Org Batch:		1. RSP Delivery Out Txn 	- Update Sub Status, Status and Ar Ind
 * 				2. OPB Fund In Txn 		- Update Sub Status, Status and Ar Ind
 *				3. RSP Amt Diff Txn 		- Update Sub Status, Status and Ar Ind
 *				4. RSP Delivery In Txn		- Update Sub Status and next grp txn id
 *				5. RSP Settlement Txn 		- Update Sub Status
 *				6. PSP Settlement Txn		- Update Sub Status		
 *
 */
	if (iRet == PD_OK) {
		iRet = ProcessOrgBatch(hContext, rOrgBatchRecordSet);
        }

/*
 *
 * Generate a Void Batch:	1. Void Rsp Delivery Out Txn
 * 				2  Void OPB Fund In Txn
 * 				3. Void RSP Amt Diff Txn
 * 				4. RSP Delivery Out Txn
 * 				5. OPB Fund In Txn
 * 				6. RSP Amt Diff Txn
 * 				7. RSP Delivery In Txn
 * 				8, RSP Settlement Txn
 * 				9. PSP Settlement Txn
 *
 */ 
	if (iRet == PD_OK) {
		iRet = ProcessVoidBatch(hContext, rOrgBatchRecordSet);
        }	

/*
 *
 * Update ACR:			1. Sum of OPB Fund In Txn	- Debit(Void) ACR Balance
 *
 */
	if (iRet == PD_OK) {
		iRet = ProcessVoidACR(hContext);
	}

	RecordSet_Destroy(rOrgBatchRecordSet);
        FREE_ME(rOrgBatchRecordSet);

DEBUGLOG(("TxnMinByUsVRI Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     GetOrgBatchInfo(hash_t* hContext, recordset_t* rOrgBatchRecordSet)
{
	int     iRet = PD_OK;
	int	iDtlRet = PD_NOT_FOUND;

	int	iTxnCnt = 0;
	int	iTmp = 0;

	char	cStatus;
	char	cTmp;
	
	char    *csOrgBatchId = NULL;
	char    *csTxnId = NULL;
	char	*csPartyType = NULL;
	char	*csTxnCode = NULL;
	char	*csTmp = NULL;
	
	hash_t  *hOrgBatchRec;

	hash_t  *hOrgBatchHdRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hOrgBatchHdRec,0);

	hash_t *hOrgBatchDtRec;
        recordset_t *rOrgBatchDtRecordSet;
	rOrgBatchDtRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

	hash_t *hTxnHdRec;
        recordset_t *rTxnHdRecordSet;
	rTxnHdRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

/* last_batch_id */
        if (GetField_CString(hContext,"last_batch_id",&csOrgBatchId)) {
DEBUGLOG(("GetOrgBatchInfo::last_batch_id = [%s]\n",csOrgBatchId));
        } else {
DEBUGLOG(("GetOrgBatchInfo::last_batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::GetOrgBatchInfo::last_batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
        }

	// Get Org Batch Info
	if (iRet == PD_OK) {
	
		// Get Batch Header	
DEBUGLOG(("GetOrgBatchInfo::Call DBMiBatchHeader:: GetBatchHeader\n"));
          	DBObjPtr = CreateObj(DBPtr,"DBMiBatchHeader","GetBatchHeader");
              	iDtlRet = (unsigned long)(*DBObjPtr)(csOrgBatchId,hOrgBatchHdRec);
              	if (iDtlRet == PD_FOUND) {

/* status */
			if (GetField_Char(hOrgBatchHdRec,"status",&cStatus)) {
DEBUGLOG(("GetOrgBatchInfo::status = [%c]\n",cStatus));
			}
		} else {
DEBUGLOG(("GetOrgBatchInfo:::Call DBMiBatchHeader:: GetBatchHeader Failed\n"));
ERRLOG("TxnMinByUsVRI::GetOrgBatchInfo:::Call DBMiBatchHeader:: GetBatchHeader Failed\n");
			iRet = INT_ERR;
		}

		// Get Batch Detail by Batch Id
		if (iRet == PD_OK) {

			recordset_init(rOrgBatchDtRecordSet,0);			

DEBUGLOG(("GetOrgBatchInfo::Call DBMiBatchDetail::GetAllDetailByBatchId:: org_batch_id [%s]\n",csOrgBatchId));
                	DBObjPtr = CreateObj(DBPtr,"DBMiBatchDetail","GetAllDetailByBatchId");
                	iDtlRet = (unsigned long)(*DBObjPtr)(csOrgBatchId,rOrgBatchDtRecordSet);
                	if (iDtlRet == PD_FOUND) {
                        	hOrgBatchDtRec = RecordSet_GetFirst(rOrgBatchDtRecordSet);
                        	while (hOrgBatchDtRec) {
					
					hOrgBatchRec = (hash_t*) malloc (sizeof(hash_t));
					hash_init(hOrgBatchRec,0);					

					// batch_id
					PutField_CString(hOrgBatchRec,"batch_id",csOrgBatchId);				
	
					// status
					PutField_Char(hOrgBatchRec,"status",cStatus);

/* seq */		
					if (GetField_Int(hOrgBatchDtRec,"seq",&iTmp)) {
DEBUGLOG(("GetOrgBatchInfo::seq = [%d]\n",iTmp));
                                		PutField_Int(hOrgBatchRec,"seq",iTmp);
                        		}

/* entity_id */                               
                                        if (GetField_CString(hOrgBatchDtRec,"entity_id",&csTmp)) {
DEBUGLOG(("GetOrgBatchInfo::entity_id = [%s]\n",csTmp));
                                                PutField_CString(hOrgBatchRec,"entity_id",csTmp);
                                        }

/* party_type */
                                        if (GetField_CString(hOrgBatchDtRec,"party_type",&csPartyType)) {
DEBUGLOG(("GetOrgBatchInfo::party_type = [%s]\n",csPartyType));
                                                PutField_CString(hOrgBatchRec,"party_type",csPartyType);
	
						if (!strcmp(csPartyType, PD_MI_ENTITY_OPBANK)) {
							
							// txn_cnt
							PutField_Int(hOrgBatchRec,"txn_cnt",++iTxnCnt);				
DEBUGLOG(("GetOrgBatchInfo::txn_cnt = [%d]\n",iTxnCnt));
						}
                                        }

/* party_id */
                                        if (GetField_CString(hOrgBatchDtRec,"party_id",&csTmp)) {
DEBUGLOG(("GetOrgBatchInfo::party_id = [%s]\n",csTmp));
                                                PutField_CString(hOrgBatchRec,"party_id",csTmp);
                                        }

/* oper_ind */
                                        if (GetField_Char(hOrgBatchDtRec,"oper_ind",&cTmp)) {
DEBUGLOG(("GetOrgBatchInfo::oper_ind = [%c]\n",cTmp));
                                                PutField_Char(hOrgBatchRec,"oper_ind",cTmp);
                                        }

/* txn_id */
                                        if (GetField_CString(hOrgBatchDtRec,"txn_id",&csTxnId)) {
DEBUGLOG(("GetOrgBatchInfo::txn_id = [%s]\n",csTxnId));
                                                PutField_CString(hOrgBatchRec,"txn_id",csTxnId);

						recordset_init(rTxnHdRecordSet,0);						

						// Get Txn Header		
DEBUGLOG(("GetOrgBatchInfo::Call DBTransaction::GetTxnHeader:: txn_id [%s]\n",csTxnId));
                                		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
                                		iRet = (unsigned long)(*DBObjPtr)(csTxnId,rTxnHdRecordSet);
                                		if (iRet == PD_OK) {
                                        		hTxnHdRec = RecordSet_GetFirst(rTxnHdRecordSet);
                                        		while (hTxnHdRec) {

/* txn_code */
                                                		if (GetField_CString(hTxnHdRec,"txn_code",&csTxnCode)) {
DEBUGLOG(("GetOrgBatchInfo::txn_code = [%s]\n",csTxnCode));
									PutField_CString(hOrgBatchRec,"txn_code",csTxnCode);

									// Check TxnCcode is Voidable
DEBUGLOG(("GetOrgBatchInfo::Call DBTxnCode::OflIsVoidable:: txn_code [%s]\n",csTxnCode));		
									DBObjPtr = CreateObj(DBPtr,"DBTxnCode","OflIsVoidable");
									if ((unsigned long)(*DBObjPtr)(csTxnCode) == PD_TRUE) {

/* is_voidable */
DEBUGLOG(("GetOrgBatchInfo::Call DBTxnCode::OflIsVoidable:: TxnCode IsVoidable = TRUE\n"));
                  								PutField_Int(hOrgBatchRec,"tc_is_voidable",PD_TRUE);
			                              			} else {

/* is_voidable */
DEBUGLOG(("GetOrgBatchInfo::Call DBTxnCode::OflIsVoidable:: TxnCode IsVoidable = FALSE\n"));
                                                                                PutField_Int(hOrgBatchRec,"tc_is_voidable",PD_FALSE);
									}
								}

/* sub_status */
                                                		if (GetField_CString(hTxnHdRec,"sub_status",&csTmp)) {
DEBUGLOG(("GetOrgBatchInfo::sub_status = [%s]\n",csTmp));
									PutField_CString(hOrgBatchRec,"sub_status",csTmp);
                                                		}

								hTxnHdRec = RecordSet_GetNext(rTxnHdRecordSet);
                                        		}
                                		} else {
DEBUGLOG(("GetOrgBatchInfo::Call DBTransaction::GetTxnHeader Failed\n"));
ERRLOG("TxnMinByUsVRI::GetOrgBatchInfo::Call DBTransaction::GetTxnHeader Failed\n");
                                        		iRet = INT_ERR;
                                		}

						RecordSet_Destroy(rTxnHdRecordSet);
					}

					RecordSet_Add(rOrgBatchRecordSet, hOrgBatchRec);

                        	        hOrgBatchDtRec = RecordSet_GetNext(rOrgBatchDtRecordSet);
                        	}

				FREE_ME(rTxnHdRecordSet);
               	 	} else {
DEBUGLOG(("GetOrgBatchInfo::Call DBMiBatchDetail::GetAllDetailByBatchId Failed\n"));
ERRLOG("TxnMinByUsVRI::GetOrgBatchInfo::Call DBMiBatchDetail::GetAllDetailByBatchId Failed\n");
                        	iRet = INT_ERR;
                	}

			RecordSet_Destroy(rOrgBatchDtRecordSet);
			FREE_ME(rOrgBatchDtRecordSet);
		}
	}	

	hash_destroy(hOrgBatchHdRec);
        FREE_ME(hOrgBatchHdRec);

DEBUGLOG(("GetOrgBatchInfo Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     CheckBatchValid(hash_t* hContext, recordset_t* rOrgBatchRecordSet)
{
	int     iRet = PD_OK;

	int	iIsVoidable = PD_FALSE;

	char    *csOrgTxnId = NULL;
	char    *csOrgBatchId = NULL;
	char    *csProcessType = NULL;
	char    *csOrgProcessType = NULL;
	char    *csTxnId = NULL;
	char	*csTxnCode = NULL;
	char	*csSubStatus = NULL;

	char	cStatus;

	hash_t *hOrgBatchRec;

/* org_txn_seq */
        if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnId)) {
DEBUGLOG(("CheckBatchValid::org_txn_seq = [%s]\n",csOrgTxnId));
        } else {
DEBUGLOG(("CheckBatchValid::org_txn_seq not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::org_txn_seq not found!!\n");
                iRet = INT_INVALID_TXN;
        }

/* last_batch_id */
        if (GetField_CString(hContext,"last_batch_id",&csOrgBatchId)) {
DEBUGLOG(("CheckBatchValid::last_batch_id = [%s]\n",csOrgBatchId));
        } else {
DEBUGLOG(("CheckBatchValid::last_batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::last_batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
        }

/* mini_txn_type (process_type) */
        if (GetField_CString(hContext,"mini_txn_type",&csProcessType)) {
DEBUGLOG(("CheckBatchValid::mini_txn_type (process_type) = [%s]\n",csProcessType));

		// Compare mini_txn_type (process type) - PD_MI_TXN_TYPE_VOID_DELIV_OUT
		if (strcmp(csProcessType, PD_MI_TXN_TYPE_VOID_DELIV_OUT)) {
DEBUGLOG(("CheckBatchValid::process_type invalid!!\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::process_type invalid!!\n");
			iRet = INT_INVALID_TXN;
                }
        } else {
DEBUGLOG(("CheckBatchValid::mini_txn_type (process_type) not found!!\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::process_type not found!!\n");
                iRet = INT_MI_PROCESS_TYPE_NOT_FOUND;
        }

/* last_process_type */
        if (GetField_CString(hContext,"last_process_type",&csOrgProcessType)) {
DEBUGLOG(("CheckBatchValid::last_process_type = [%s]\n",csOrgProcessType));
		
		// Compare last process type - PD_MI_TXN_TYPE_DELIV_OUT
                if (strcmp(csOrgProcessType, PD_MI_TXN_TYPE_DELIV_OUT)) {
DEBUGLOG(("CheckBatchValid::last_process_type invalid!!\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::last_process_type invalid!!\n");
                        iRet = INT_INVALID_TXN;
                }
        } else {
DEBUGLOG(("CheckBatchValid::last_process_type not found!!\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::last_process_type not found!!\n");
                iRet = INT_MI_PROCESS_TYPE_NOT_FOUND;
        }

	// Check Org Batch Info
	if (iRet == PD_OK) {
              	hOrgBatchRec = RecordSet_GetFirst(rOrgBatchRecordSet);
                while (hOrgBatchRec) {

/* status */
                        if (GetField_Char(hOrgBatchRec,"status",&cStatus)) {
DEBUGLOG(("CheckBatchValid::status = [%c]\n",cStatus));

                                // Compare Status - PD_MI_BATCH_STATUS_INOPERATIVE
                                if (cStatus == PD_MI_BATCH_STATUS_INOPERATIVE) {
DEBUGLOG(("CheckBatchValid::batch status is inoperative\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::batch status is inoperative\n");
                                       	iRet = INT_MI_BATCH_INOPERATIVE;
					break;
                                }
			}

/* txn_id */
                	if (GetField_CString(hOrgBatchRec, "txn_id", &csTxnId)) {
DEBUGLOG(("CheckBatchValid::txn_id = [%s]\n", csTxnId));
			}

/* txn_code */
			if (GetField_CString(hOrgBatchRec,"txn_code",&csTxnCode)) {
DEBUGLOG(("CheckBatchValid::txn_code = [%s]\n",csTxnCode));
                       	}

/* tc_is_voidable */
			if (GetField_Int(hOrgBatchRec,"tc_is_voidable",&iIsVoidable)) {
DEBUGLOG(("CheckBatchValid::tc_is_voidable = [%d]\n",iIsVoidable));
                        }

/* sub_status */
                       	if (GetField_CString(hOrgBatchRec,"sub_status",&csSubStatus)) {
DEBUGLOG(("CheckBatchValid::sub_status = [%s]\n",csSubStatus));												
			}

			// Check Org Txn Id (RSP Delivery In Txn Id)
			if (!strcmp(csTxnId, csOrgTxnId)) {			
				if (strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_IN)) {
DEBUGLOG(("CheckBatchValid::org_txn_id txn_code invalid\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid:: org_txn_id txn_code invalid\n");
                                        iRet = INT_MI_TXN_CODE_INVALID;
					break;	
				}
			}

			// Check is voidable
			if ((!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT))
                            || (!strcmp(csTxnCode,PD_MI_TXN_CODE_BANK_RECEIVE_FROM_RSP))
                            || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_UNDERPAID))
                            || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_OVERPAID))
                        )
			{
				if (iIsVoidable == PD_FALSE) {
DEBUGLOG(("CheckBatchValid::org_txn_id txn_code is not voidable\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid:: org_txn_id txn_code is not voidable invalid\n");
                           		iRet = INT_INVALID_TXN;
                             		break;
                       		}
			}
			
			// Compare SubStatus according to different TxnCode
			if ((!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT))
                    	    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_BANK_RECEIVE_FROM_RSP))
                    	    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_UNDERPAID))
               		    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_OVERPAID))
                	)
                	{
				// Compare SubStatus - PD_APPROVED (118)
				if (strcmp(csSubStatus,PD_APPROVED)) {
DEBUGLOG(("CheckBatchValid::sub_status invalid\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid:: sub_status invalid\n");
					iRet = INT_TXN_SUB_STATUS;
					break;
				}
               	 	}
                	else if ((!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_IN))
                         	 || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_IN_TRANSIT))
                         	 || (!strcmp(csTxnCode,PD_PSP_SETTLEMENT))
                	)
			{
				// Compare SubStatus - PD_DELIVERED (117)
				if (strcmp(csSubStatus,PD_DELIVERED)) {
DEBUGLOG(("CheckBatchValid:: sub_status invalid\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::sub_status invalid\n");
                                      	iRet = INT_TXN_SUB_STATUS;
					break;
                            	}
			}
			else
			{
DEBUGLOG(("CheckBatchValid:: txn_code invalid\n"));
ERRLOG("TxnMinByUsVRI::CheckBatchValid::txn_code invalid\n");
                             	iRet = INT_ERR;
                               	break;		
			}

			hOrgBatchRec = RecordSet_GetNext(rOrgBatchRecordSet);
      		}
	}

DEBUGLOG(("CheckBatchValid Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessNew(hash_t* hContext, recordset_t* rOrgBatchRecordSet)
{
	int     iRet = PD_OK;

	int	iOpbCnt = 0;
	int	iAmtDiffCnt = 0;

	double	dTmp = 0.0;

	char	*csTxnCode = NULL;
        char	*csUser = NULL;
	char    *csTmp = NULL;

	char    csTag[PD_TAG_LEN + 1];

	hash_t  *hOrgBatchRec;

	hash_t  *hOrgTxnRec;
	hOrgTxnRec = (hash_t*) malloc (sizeof(hash_t));

	hash_t  *hNewTxnRec;
        hNewTxnRec = (hash_t*) malloc (sizeof(hash_t));

/* last_batch_id */
        if (GetField_CString(hContext,"last_batch_id",&csTmp)) {
DEBUGLOG(("ProcessNew::last_batch_id = [%s]\n",csTmp));
        } else {
DEBUGLOG(("ProcessNew::last_batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::ProcessNew::last_batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
        }

/* add_user */
        if (GetField_CString(hContext, "add_user", &csUser)) {
DEBUGLOG(("ProcessNew:: upate_user [%s]\n", csUser));
        }

	if (iRet == PD_OK) {
                hOrgBatchRec = RecordSet_GetFirst(rOrgBatchRecordSet);
                while (hOrgBatchRec) {

DEBUGLOG(("===== ProcessNew ===== START!!\n"));

			hash_init(hOrgTxnRec,0);	
			hash_init(hNewTxnRec,0);	

/* txn_id */
                        if (GetField_CString(hOrgBatchRec, "txn_id", &csTmp)) {
DEBUGLOG(("ProcessNew: txn_id [%s]\n", csTmp));
                                PutField_CString(hOrgTxnRec, "txn_seq", csTmp);
                        }

/* txn_code */
			if (GetField_CString(hOrgBatchRec,"txn_code",&csTxnCode)) {
DEBUGLOG(("ProcessNew::txn_code = [%s]\n",csTxnCode));
				PutField_CString(hNewTxnRec, "org_txn_code", csTxnCode);

				// Compare TxnCode
				if ((!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT))
				    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_BANK_RECEIVE_FROM_RSP))
                    		    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_UNDERPAID))
                    		    || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_OVERPAID))
                		)
				{
					// user
					PutField_CString(hNewTxnRec, "add_user", csUser);
					PutField_CString(hNewTxnRec, "update_user", csUser);
DEBUGLOG(("ProcessNew:: user [%s]\n", csUser));

					// Lock Org Batch Txn + Get Org Batch Txn
			    		if (iRet == PD_OK) {
                                                iRet =  GetOrgTxnInfo(hOrgTxnRec);
                                        }
                                
					// Form New Txn
					if (iRet == PD_OK) {
                				iRet = FormNewTxn(hContext, hOrgTxnRec, hNewTxnRec);
        				}
	
        	                        // Create Txn + Update Balance (with add approval_date, approval_timestamp)
        	                        if (iRet == PD_OK) {
        	                                iRet = ProcessNewTxn(hContext, hNewTxnRec);
        	                        }
	
					if (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT))			
					{
						// org_txn_seq
						if (GetField_CString(hNewTxnRec,"org_txn_seq",&csTmp)) {
							PutField_CString(hContext, "org_txn_seq", csTmp);
DEBUGLOG(("ProcessNew:: org_txn_seq = [%s]\n", csTmp));						
						}
	
						// net_amt
						if (GetField_Double(hNewTxnRec,"net_amt",&dTmp)) {
DEBUGLOG(("ProcessNew:: net_amt = [%f]\n",dTmp));
                                        		PutField_Double(hContext,"net_amt",dTmp);
                                		}
							
						// dli_txn_id
						if (GetField_CString(hNewTxnRec,"txn_seq",&csTmp)) {
                                                        PutField_CString(hContext,"dli_txn_id",csTmp);
DEBUGLOG(("ProcessNew:: dli_txn_id = [%s]\n", csTmp));
                                                }

                                                // dli_txn_code
                                                if (GetField_CString(hNewTxnRec,"txn_code",&csTmp)) {
                                                        PutField_CString(hContext,"dli_txn_code",csTmp);
DEBUGLOG(("ProcessNew:: dli_txn_code = [%s]\n", csTmp));
                                                }

                                                // dli_entity_id
                                                if (GetField_CString(hNewTxnRec,"entity_id",&csTmp)) {
                                                        PutField_CString(hContext,"dli_entity_id",csTmp);
DEBUGLOG(("ProcessNew:: dli_entity_id = [%s]\n", csTmp));
                                                }

                                                // dli_party_type
                                                if (GetField_CString(hNewTxnRec,"party_type",&csTmp)) {
                                                        PutField_CString(hContext,"dli_party_type",csTmp);
DEBUGLOG(("ProcessNew:: dli_party_type = [%s]\n", csTmp));
                                                }

                                                // dli_party_id
                                                if (GetField_CString(hNewTxnRec,"party_id",&csTmp)) {
                                                        PutField_CString(hContext,"dli_party_id",csTmp);
DEBUGLOG(("ProcessNew:: dli_party_id = [%s]\n", csTmp));
                                                }
					}
					else if (!strcmp(csTxnCode,PD_MI_TXN_CODE_BANK_RECEIVE_FROM_RSP))
                                	{
						iOpbCnt++;

						// opb_cnt
						PutField_Int(hContext,"opb_cnt",iOpbCnt);
DEBUGLOG(("ProcessNew:: opb_cnt = [%d]\n", iOpbCnt));

						// opb_txn_id
						if (GetField_CString(hNewTxnRec,"txn_seq",&csTmp)) {
							sprintf(csTag, "opb_txn_id_%d", iOpbCnt);	
							PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("ProcessNew:: opb_txn_id = [%s]\n", csTmp));
						}

						// opb_txn_code
						if (GetField_CString(hNewTxnRec,"txn_code",&csTmp)) {
                                                        PutField_CString(hContext,"opb_txn_code",csTmp);
DEBUGLOG(("ProcessNew:: opb_txn_code = [%s]\n", csTmp));
                                                }

						// opb_entity_id
						if (GetField_CString(hNewTxnRec,"entity_id",&csTmp)) {
                        				PutField_CString(hContext,"opb_entity_id",csTmp);
DEBUGLOG(("ProcessNew:: opb_entity_id = [%s]\n", csTmp));
						}

						// opb_party_type
						if (GetField_CString(hNewTxnRec,"party_type",&csTmp)) {
                        				PutField_CString(hContext,"opb_party_type",csTmp);
DEBUGLOG(("ProcessNew:: opb_party_type = [%s]\n", csTmp));
						}

						// opb_party_id
						if (GetField_CString(hNewTxnRec,"party_id",&csTmp)) {
                        				PutField_CString(hContext,"opb_party_id",csTmp);
DEBUGLOG(("ProcessNew:: opb_party_id = [%s]\n", csTmp));
						}
					}	
					else if ((!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_UNDERPAID))
                                            	 || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_OVERPAID))
					)
					{
						iAmtDiffCnt++;
	
						// amtdiff_cnt
						PutField_Int(hContext,"amtdiff_cnt",iAmtDiffCnt);
DEBUGLOG(("ProcessNew:: amtdiff_cnt = [%d]\n", iAmtDiffCnt));
	
						// amtdiff_txn_id
						if (GetField_CString(hNewTxnRec,"txn_seq",&csTmp)) {
							sprintf(csTag, "amtdiff_txn_id_%d", iAmtDiffCnt);
                                                	PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("ProcessNew:: amtdiff_txn_id = [%s]\n", csTmp));
						}

 						// amtdiff_entity_id
 						if (GetField_CString(hNewTxnRec,"entity_id",&csTmp)) {
                                                	PutField_CString(hContext,"amtdiff_entity_id",csTmp);
DEBUGLOG(("ProcessNew:: amtdiff_entity_id = [%s]\n", csTmp));
						}

                                                // amtdiff_party_type
                                                if (GetField_CString(hNewTxnRec,"party_type",&csTmp)) {
                                                	PutField_CString(hContext,"amtdiff_party_type",csTmp);
DEBUGLOG(("ProcessNew:: amtdiff_party_type = [%s]\n", csTmp));
						}
						
                                                // amtdiff_party_id
                                                if (GetField_CString(hNewTxnRec,"party_id",&csTmp)) {
                                                	PutField_CString(hContext,"amtdiff_party_id",csTmp);
DEBUGLOG(("ProcessNew:: amtdiff_party_id = [%s]\n", csTmp));
						}
					}		
				}
			}

			hash_destroy(hOrgTxnRec);
			hash_destroy(hNewTxnRec);

DEBUGLOG(("ProcessNew:: iRet [%d]\n", iRet));
DEBUGLOG(("===== ProcessNew ===== END !!\n"));

                        hOrgBatchRec = RecordSet_GetNext(rOrgBatchRecordSet);
                }

		FREE_ME(hOrgTxnRec);
        	FREE_ME(hNewTxnRec);
        }

DEBUGLOG(("ProcessNew Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     GetOrgTxnInfo(hash_t* hTxnRec)
{

        int     iRet = PD_OK;

        int     iTmp = 0;

        double  dTmp = 0.0;

	char	cTmp;

        char    *csTxnId = (char*) malloc (PD_TXN_SEQ_LEN);
        char    *csTmp = NULL;

        hash_t  *hRec = NULL;
        recordset_t     *rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

/* txn_seq */
        if (GetField_CString(hTxnRec,"txn_seq",&csTxnId)) {
DEBUGLOG(("GetOrgTxnInfo::txn_id = [%s]\n",csTxnId));
        } else {
DEBUGLOG(("GetOrgTxnInfo::txn_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::GetOrgTxnInfo::txn_id not found!!\n");
                iRet = INT_INVALID_TXN;
        }

	// Get Txn Header
	if(iRet==PD_OK){

DEBUGLOG(("GetOrgTxnInfo::Call DBTransaction::GetTxnHeader:: txn_id [%s]\n",csTxnId));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
                iRet = (unsigned long)(*DBObjPtr)(csTxnId,rRecordSet);
                if (iRet == PD_OK) {
DEBUGLOG(("GetOrgTxnInfo::Call DBTransaction::GetTxnHeader Success\n"));
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* channel_code */
                                if(GetField_CString(hRec,"channel_code",&csTmp)){
DEBUGLOG(("GetOrgTxnInfo::channel_code = [%s]\n",csTmp));
                                        PutField_CString(hTxnRec,"channel_code",csTmp);
                                }

/* service_code */
                                if(GetField_CString(hRec,"service_code",&csTmp)){
DEBUGLOG(("GetOrgTxnInfo::service_code = [%s]\n",csTmp));
                                        PutField_CString(hTxnRec,"service_code",csTmp);
                                }

/* net_ccy */
                                if(GetField_CString(hRec,"net_ccy",&csTmp)){
DEBUGLOG(("GetOrgTxnInfo::net_ccy = [%s]\n",csTmp));
                                        PutField_CString(hTxnRec,"net_ccy",csTmp);
                                }

/* net_amt */
                                if(GetField_Double(hRec,"net_amt",&dTmp)){
DEBUGLOG(("GetOrgTxnInfo::net_amt = [%lf]\n",dTmp));
                                        PutField_Double(hTxnRec,"net_amt",dTmp);
                                }

/* txn_amt */
                                if(GetField_Double(hRec,"txn_amt",&dTmp)){
DEBUGLOG(("GetOrgTxnInfo::txn_amt = [%lf]\n",dTmp));
                                        PutField_Double(hTxnRec,"txn_amt",dTmp);
                                }

/* ip_addr */
                		if (GetField_CString(hRec, "ip_addr", &csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::ip_addr [%s]\n", csTmp));
                			PutField_CString(hTxnRec, "ip_addr", csTmp);
                		}

/* ex_supplier */
                		if (GetField_Char(hRec,"ex_supplier",&cTmp)) {
DEBUGLOG(("GetOrgTxnInfo::ex_supplier [%c]\n", cTmp));
                        		PutField_Char(hTxnRec,"ex_supplier",cTmp);
                		}

/* ex_rate */
                		if (GetField_Double(hRec,"ex_rate",&dTmp)) {
DEBUGLOG(("GetOrgTxnInfo::ex_rate = [%lf]\n",dTmp));
                        		PutField_Double(hTxnRec,"ex_rate",dTmp);
                		}
	
                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                } else {
DEBUGLOG(("GetOrgTxnInfo::Call DBTransaction::GetTxnHeader Failed\n"));
                        iRet = INT_ERR;
                }

                RecordSet_Destroy(rRecordSet);
        }

	// Get Txn Detail
	if(iRet==PD_OK){
                recordset_init(rRecordSet,0);

DEBUGLOG(("GetOrgTxnInfo::Call DBTransaction::GetTxnDetail:: txn_id [%s]\n",csTxnId));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
                iRet = (unsigned long)(*DBObjPtr)(csTxnId,rRecordSet);
                if (iRet == PD_OK) {
DEBUGLOG(("GetOrgTxnInfo::Call DBTransaction::GetTxnDetail Success\n"));
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* txn_country */
                                if(GetField_CString(hRec,"txn_country",&csTmp)){
DEBUGLOG(("GetOrgTxnInfo::txn_country = [%s]\n",csTmp));
                                        PutField_CString(hTxnRec,"txn_country",csTmp);
                                }

/* txn_country */
                                if(GetField_CString(hRec,"txn_ccy",&csTmp)){
DEBUGLOG(("GetOrgTxnInfo::txn_ccy = [%s]\n",csTmp));
                                        PutField_CString(hTxnRec,"txn_ccy",csTmp);
                                }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                } else {
DEBUGLOG(("GetOrgTxnInfo::Call DBTransaction::GetTxnDetail Failed\n"));
                        iRet = INT_ERR;
                }

                RecordSet_Destroy(rRecordSet);
        }

	// Get Txn Mi Detail
	if(iRet==PD_OK){
                recordset_init(rRecordSet,0);
	
DEBUGLOG(("GetOrgTxnInfo::Call TxnMiDetail:GetTxnMiDetail: txn_id = [%s]\n", csTxnId));
                DBObjPtr = CreateObj(DBPtr, "DBTxnMiDetail", "GetTxnMiDetail");
                iRet = (unsigned long)(*DBObjPtr)(csTxnId, rRecordSet);
                if (iRet == PD_OK) {
DEBUGLOG(("GetOrgTxnInfo::Call TxnMiDetail:GetTxnMiDetail:SUCCESS\n"));

                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* entity_id */
                                if (GetField_CString(hRec,"entity_id",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::entity_id = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"entity_id",csTmp);
                                }

/* party_type */
                                if (GetField_CString(hRec,"party_type",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::party_type = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"party_type",csTmp);
                                }

/* party_id */
                                if (GetField_CString(hRec,"party_id",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::party_id = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"party_id",csTmp);
                                }

/* txn_ccy */
                                if (GetField_CString(hRec,"txn_ccy",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::txn_ccy = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"txn_ccy",csTmp);
                                }

/* txn_country */
                                if (GetField_CString(hRec,"txn_country",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::txn_country = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"txn_country",csTmp);
                                }

/* txn_product */
                                if (GetField_CString(hRec,"txn_product",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::txn_product = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"txn_product",csTmp);
                                }

/* open_acct_bal */
                                if (GetField_Double(hRec,"open_acct_bal",&dTmp)) {
DEBUGLOG(("GetOrgTxnInfo::open_acct_bal = [%f]\n", dTmp));
                                        PutField_Double(hTxnRec,"open_acct_bal",dTmp);
                                }

/* acct_bal */
                                if (GetField_Double(hRec,"acct_bal",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::acct_bal = [%f]\n", dTmp));
                                        PutField_Double(hTxnRec,"acct_bal",dTmp);
                                }

/* open_intransit */
                                if (GetField_Double(hRec,"open_intransit",&dTmp)) {
DEBUGLOG(("GetOrgTxnInfo::open_intransit = [%f]\n", dTmp));
                                        PutField_Double(hTxnRec,"open_intransit",dTmp);
                                }

/* intransit */
                                if (GetField_Double(hRec,"intransit",&dTmp)) {
DEBUGLOG(("GetOrgTxnInfo::intransit = [%f]\n", dTmp));
                                        PutField_Double(hTxnRec,"intransit",dTmp);
                                }

/* open_ar_bal */
                                if (GetField_Double(hRec,"open_ar_bal",&dTmp)) {
DEBUGLOG(("GetOrgTxnInfo::open_ar_bal = [%f]\n", dTmp));
                                        PutField_Double(hTxnRec,"open_ar_bal",dTmp);
                                }

/* ar_bal */
                                if (GetField_Double(hRec,"ar_bal",&dTmp)) {
DEBUGLOG(("GetOrgTxnInfo::ar_bal = [%f]\n", dTmp));
                                        PutField_Double(hTxnRec,"ar_bal",dTmp);
                                }

/* txn_date */
                                if (GetField_CString(hRec,"txn_date",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::txn_date = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"txn_date",csTmp);
                                }

/* report_date */
                                if (GetField_CString(hRec,"report_date",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::report_date = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"report_date",csTmp);
                                }

/* cost_rate */
                                if (GetField_Double(hRec,"cost_rate",&dTmp)) {
DEBUGLOG(("GetOrgTxnInfo::cost_rate = [%f]\n", dTmp));
                                        PutField_Double(hTxnRec,"cost_rate",dTmp);
                                }

/* actual_cost */
                                if (GetField_Double(hRec,"actual_cost",&dTmp)) {
DEBUGLOG(("GetOrgTxnInfo::actual_cost = [%f]\n", dTmp));
                                        PutField_Double(hTxnRec,"actual_cost",dTmp);
                                }

/* remittance_slip_date */
                                if (GetField_CString(hRec,"remittance_slip_date",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::remittance_slip_date = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"remittance_slip_date",csTmp);
                                }

/* converted_ccy */
                                if (GetField_CString(hRec,"converted_ccy",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::converted_ccy = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"converted_ccy",csTmp);
                                }

/* converted_amount */
                                if (GetField_Double(hRec,"converted_amount",&dTmp)) {
DEBUGLOG(("GetOrgTxnInfo::converted_amount = [%f]\n", dTmp));
                                        PutField_Double(hTxnRec,"converted_amount",dTmp);
                                }

/* remark */
                                if (GetField_CString(hRec,"remark",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::remark = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"remark",csTmp);
                                }

/* remit_rate */
                                if (GetField_Double(hRec,"remit_rate",&dTmp)) {
DEBUGLOG(("GetOrgTxnInfo::remit_rate = [%f]\n", dTmp));
                                        PutField_Double(hTxnRec,"remit_rate",dTmp);
                                }

/* prev_grp_txn_id */
                                if (GetField_CString(hRec,"prev_grp_txn_id",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::prev_grp_txn_id = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"prev_grp_txn_id",csTmp);
                                }

/* next_grp_txn_id */
                                if (GetField_CString(hRec,"next_grp_txn_id",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::next_grp_txn_id = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"next_grp_txn_id",csTmp);
                                }

/* acr_prorata */
                                if (GetField_Int(hRec,"acr_prorata",&iTmp)) {
DEBUGLOG(("GetOrgTxnInfo::acr_prorata = [%d]\n", iTmp));
                                        PutField_Int(hTxnRec,"acr_prorata",iTmp);
                                }

/* entity_ccy */
                                if (GetField_CString(hRec,"entity_ccy",&csTmp)) {
DEBUGLOG(("GetOrgTxnInfo::entity_ccy = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"entity_ccy",csTmp);
                                }

/* entity_txn_amount */
                                if (GetField_Double(hRec,"entity_txn_amount",&dTmp)) {
DEBUGLOG(("GetOrgTxnInfo::entity_txn_amount = [%f]\n", dTmp));
                                        PutField_Double(hTxnRec,"entity_txn_amount",dTmp);
                                }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                } else {
DEBUGLOG(("GetOrgTxnInfo::Call TxnMiDetail:GetTxnMiDetail:Failed\n"));
                        iRet = INT_ERR;
                }

		RecordSet_Destroy(rRecordSet);
        }

        FREE_ME(csTxnId);
        FREE_ME(rRecordSet);

DEBUGLOG(("GetOrgTxnInfo Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     FormNewTxn(hash_t* hContext, hash_t* hOrgTxnRec, hash_t* hTxnRec)
{
	int     iRet = PD_OK;

	int	iTmp = 0;

        double  dTmp = 0.0;

	char	cTmp;

	char	*csOrgTxnCode = NULL;
        char    *csTmp = NULL;

        char    csTxnDateTime[PD_DATETIME_LEN + 1];

	// Txn Header
	if (iRet == PD_OK) {

/* org_txn_seq */
		if (GetField_CString(hOrgTxnRec, "txn_seq", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnLog):: org_txn_seq [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "org_txn_seq", csTmp);
                }

/* channel_code */
                if (GetField_CString(hOrgTxnRec, "channel_code", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnLog):: channel_code [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "channel_code", csTmp);
                }

/* service_code */
                if (GetField_CString(hOrgTxnRec, "service_code", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnLog):: service_code [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "service_code", csTmp);
                }

/* status */
                PutField_Char(hTxnRec,"status",PD_PROCESSING);
DEBUGLOG(("FormNewTxn (TxnLog):: status [%c]\n", PD_PROCESSING));

/* txn_code */
		if (GetField_CString(hTxnRec, "org_txn_code", &csOrgTxnCode)) {
DEBUGLOG(("FormNewTxn (TxnLog):: org_txn_code [%s]\n", csOrgTxnCode));

			// Get void txn code
			if (!strcmp(csOrgTxnCode, PD_MI_TXN_CODE_RSP_DELIVERY_OUT)) {
				PutField_CString(hTxnRec, "txn_code", PD_MI_TXN_CODE_VOID_RSP_DELIVERY_OUT);
DEBUGLOG(("FormNewTxn (TxnLog):: txn_code [%s]\n", PD_MI_TXN_CODE_VOID_RSP_DELIVERY_OUT));
			} else if (!strcmp(csOrgTxnCode, PD_MI_TXN_CODE_BANK_RECEIVE_FROM_RSP)) {
				PutField_CString(hTxnRec, "txn_code", PD_MI_TXN_CODE_VOID_BANK_RECEIVE_FROM_RSP);
DEBUGLOG(("FormNewTxn (TxnLog):: txn_code [%s]\n", PD_MI_TXN_CODE_VOID_BANK_RECEIVE_FROM_RSP));
			} else if (!strcmp(csOrgTxnCode, PD_MI_TXN_CODE_RSP_DELIVERY_OUT_UNDERPAID)) {
				PutField_CString(hTxnRec, "txn_code", PD_MI_TXN_CODE_VOID_RSP_DELIVERY_OUT_UNDERPAID);
DEBUGLOG(("FormNewTxn (TxnLog):: txn_code [%s]\n", PD_MI_TXN_CODE_VOID_RSP_DELIVERY_OUT_UNDERPAID));
			} else if (!strcmp(csOrgTxnCode, PD_MI_TXN_CODE_RSP_DELIVERY_OUT_OVERPAID)) {
				PutField_CString(hTxnRec, "txn_code", PD_MI_TXN_CODE_VOID_RSP_DELIVERY_OUT_OVERPAID);
DEBUGLOG(("FormNewTxn (TxnLog):: txn_code [%s]\n", PD_MI_TXN_CODE_VOID_RSP_DELIVERY_OUT_OVERPAID));
			}
                }

/* process_code */
                PutField_CString(hTxnRec,"process_code", PD_PROCESS_CODE_DEF);
DEBUGLOG(("FormNewTxn (TxnLog):: process_code [%s]\n", PD_PROCESS_CODE_DEF));

/* process_type */
                PutField_CString(hTxnRec,"process_type", PD_PROCESS_TYPE_DEF);
DEBUGLOG(("FormNewTxn (TxnLog):: process_type [%s]\n", PD_PROCESS_TYPE_DEF));

/* response_code */
                PutField_CString(hTxnRec, "response_code", "0");
DEBUGLOG(("FormNewTxn (TxnLog):: response_code [%s]\n", "0"));

/* internal_code */
                PutField_Int(hTxnRec, "internal_code", 0);
DEBUGLOG(("FormNewTxn (TxnLog):: internal_code [%d]\n", 0));

/* host_posting_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("FormNewTxn (TxnLog):: PHDATE [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"host_posting_date",csTmp);
                }

/* ip_addr */
                if (GetField_CString(hOrgTxnRec, "ip_addr", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnLog):: ip_addr [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "ip_addr", csTmp);
                }

/* transmission_datetime */
                if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnLog):: local_tm_date [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "local_tm_date", csTmp);
                        PutField_CString(hTxnRec, "tm_date", csTmp);

                        strcpy(csTxnDateTime, csTmp);
                        PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);

                        if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnLog):: local_tm_time [%s]\n", csTmp));
                                PutField_CString(hTxnRec, "local_tm_time", csTmp);
                                strcat(csTxnDateTime, csTmp);
                                PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);
                        }
                }

/* net_ccy */
                if (GetField_CString(hOrgTxnRec,"net_ccy",&csTmp)) {
DEBUGLOG(("FormNewTxn (TxnLog):: net_ccy = [%s]\n",csTmp));
                        PutField_CString(hTxnRec,"net_ccy",csTmp);
                        PutField_CString(hContext,"net_ccy",csTmp);
                }

/* net_amt */
                if (GetField_Double(hOrgTxnRec,"net_amt",&dTmp)) {
DEBUGLOG(("FormNewTxn (TxnLog):: net_amt = [%lf]\n",dTmp));
                        PutField_Double(hTxnRec,"net_amt",dTmp);
                }

/* txn_amt */
                if (GetField_Double(hOrgTxnRec,"txn_amt",&dTmp)) {
DEBUGLOG(("FormNewTxn (TxnLog):: txn_amt = [%lf]\n",dTmp));
                        PutField_Double(hTxnRec,"txn_amt",dTmp);
                }

/* ex_supplier */
                if (GetField_Char(hOrgTxnRec,"ex_supplier",&cTmp)) {
DEBUGLOG(("FormNewTxn (TxnLog):: ex_supplier [%c]\n", cTmp));
                        PutField_Char(hTxnRec,"ex_supplier",cTmp);
                }

/* ex_rate */
                if (GetField_Double(hOrgTxnRec,"ex_rate",&dTmp)) {
DEBUGLOG(("FormNewTxn (TxnLog):: ex_rate = [%lf]\n",dTmp));
                        PutField_Double(hTxnRec,"ex_rate",dTmp);
                }

/* do_logging */
                PutField_Int(hTxnRec, "do_logging", PD_TRUE);
DEBUGLOG(("FormNewTxn (TxnLog):: do_logging [%d]\n", PD_TRUE));

/* db_commit */
                PutField_Int(hTxnRec, "db_commit", PD_FALSE);
DEBUGLOG(("FormNewTxn (TxnLog):: db_commit [%d]\n", PD_FALSE));

        }

	// Txn Detail
	if (iRet == PD_OK) {

/* txn_country */
                if (GetField_CString(hOrgTxnRec, "txn_country", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnLog):: txn_country = [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "txn_country", csTmp);
                }

/* txn_ccy */
                if (GetField_CString(hOrgTxnRec, "txn_ccy", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnLog):: txn_ccy = [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "txn_ccy", csTmp);
                }
        }

	// Txn Mi Detail
	if (iRet == PD_OK) {	

/* entity_id */
                if (GetField_CString(hOrgTxnRec,"entity_id",&csTmp)) {
DEBUGLOG(("FormNewTxn:: entity_id = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"entity_id",csTmp);
                }

/* party_type */
                if (GetField_CString(hOrgTxnRec,"party_type",&csTmp)) {
DEBUGLOG(("FormNewTxn:: party_type = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"party_type",csTmp);
                }

/* party_id */
                if (GetField_CString(hOrgTxnRec,"party_id",&csTmp)) {
DEBUGLOG(("FormNewTxn:: party_id = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"party_id",csTmp);
                }

/* txn_ccy */
                if (GetField_CString(hOrgTxnRec,"txn_ccy",&csTmp)) {
DEBUGLOG(("FormNewTxn:: txn_ccy = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"txn_ccy",csTmp);
                        PutField_CString(hTxnRec,"ccy",csTmp);
                }

/* txn_country */
                if (GetField_CString(hOrgTxnRec,"txn_country",&csTmp)) {
DEBUGLOG(("FormNewTxn:: txn_country = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"txn_country",csTmp);
                        PutField_CString(hTxnRec,"country",csTmp);
                }

/* txn_product */
                if (GetField_CString(hOrgTxnRec,"txn_product",&csTmp)) {
DEBUGLOG(("FormNewTxn:: txn_product = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"txn_product",csTmp);
                }

/* txn_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("FormNewTxn:: txn_date = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"txn_date",csTmp);
                }

/* report_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("FormNewTxn:: report_date = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"report_date",csTmp);
                }

/* cost_rate */
             	if (GetField_Double(hOrgTxnRec,"cost_rate",&dTmp)) {
DEBUGLOG(("FormNewTxn:: cost_rate = [%f]\n", dTmp));
                     	PutField_Double(hTxnRec,"cost_rate",dTmp);
            	}

/* actual_cost */
         	if (GetField_Double(hOrgTxnRec,"actual_cost",&dTmp)) {
DEBUGLOG(("FormNewTxn:: actual_cost = [%f]\n", dTmp));
                       	PutField_Double(hTxnRec,"actual_cost",dTmp);
              	}

/* remittance_slip_date */
              	if (GetField_CString(hOrgTxnRec,"remittance_slip_date",&csTmp)) {
DEBUGLOG(("FormNewTxn:: remittance_slip_date = [%s]\n", csTmp));
                    	PutField_CString(hTxnRec,"remittance_slip_date",csTmp);
             	}

/* converted_ccy */
               	if (GetField_CString(hOrgTxnRec,"converted_ccy",&csTmp)) {
DEBUGLOG(("FormNewTxn:: converted_ccy = [%s]\n", csTmp));
                    	PutField_CString(hTxnRec,"converted_ccy",csTmp);
              	}

/* converted_amount */
            	if (GetField_Double(hOrgTxnRec,"converted_amount",&dTmp)) {
DEBUGLOG(("FormNewTxn:: converted_amount = [%f]\n", dTmp));
                     	PutField_Double(hTxnRec,"converted_amount",dTmp);
         	}

/* remit_rate */
               	if (GetField_Double(hOrgTxnRec,"remit_rate",&dTmp)) {
DEBUGLOG(("FormNewTxn:: remit_rate = [%f]\n", dTmp));
                   	PutField_Double(hTxnRec,"remit_rate",dTmp);
               	}

/* entity_ccy */
                if (GetField_CString(hOrgTxnRec,"entity_ccy",&csTmp)) {
DEBUGLOG(("FormNewTxn:: entity_ccy = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"entity_ccy",csTmp);
                }

/* entity_txn_amount */
                if (GetField_Double(hOrgTxnRec,"entity_txn_amount",&dTmp)) {
DEBUGLOG(("FormNewTxn:: entity_txn_amount = [%f]\n", dTmp));
                        PutField_Double(hTxnRec,"entity_txn_amount",dTmp);
                }

/* acr_prorata */
		if (GetField_Int(hOrgTxnRec,"acr_prorata",&iTmp)) {
DEBUGLOG(("FormNewTxn:: acr_prorata = [%d]\n", iTmp));
                	PutField_Int(hTxnRec,"acr_prorata",iTmp);
		}
        }

DEBUGLOG(("FormNewTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessNewTxn(hash_t* hContext, hash_t* hTxnRec)
{
	int     iRet = PD_OK;
        int     iDtlRet = PD_FOUND;

        int     iTmp = 0;

        double  dTmp = 0.0;

	char	*csOrgTxnCode = NULL;
	char    *csAmtType = NULL;
        char    *csApprovalDate = NULL;
        char    *csApprovalTimestamp = NULL;
        char    *csStatus = NULL;
        char    *csTmp = NULL;

        char    csTxnId[PD_TXN_SEQ_LEN + 1];
        char    csTag[PD_TAG_LEN + 1];

	hash_t  *hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec,0);

/* org_txn_code */
        if (GetField_CString(hTxnRec, "org_txn_code", &csOrgTxnCode)) {
DEBUGLOG(("ProcessNewTxn:: org_txn_code [%s]\n", csOrgTxnCode));
        }

       	// Compare TxnCode
      	if (!strcmp(csOrgTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT))
        {

/* do_logging */
		if(GetField_Int(hContext,"do_logging",&iTmp)) {
			PutField_Int(hTxnRec, "do_logging", iTmp);
		}
	}

	// Generate Next Txn Seq
	if (iRet == PD_OK) {
		
		// Compare TxnCode
		if (!strcmp(csOrgTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT)) 
		{

/* txn_seq */
        		if (GetField_CString(hContext, "txn_seq", &csTmp)) {
DEBUGLOG(("ProcessNewTxn:: txn_seq [%s]\n", csTmp));
                		PutField_CString(hTxnRec, "txn_seq", csTmp);
		
				sprintf(csTxnId,csTmp);
        		}

		}
		else if ((!strcmp(csOrgTxnCode,PD_MI_TXN_CODE_BANK_RECEIVE_FROM_RSP))
			 || (!strcmp(csOrgTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_UNDERPAID))
                         || (!strcmp(csOrgTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_OVERPAID)) 
		)
		{
DEBUGLOG(("ProcessNewTxn:: Call DBTxnSeq: GetNextMgtTxnSeq\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBTxnSeq", "GetNextMgtTxnSeq");
                	strcpy((char*)csTxnId, (*DBObjPtr)());

                	PutField_CString(hTxnRec, "txn_seq", (const char *)csTxnId);
DEBUGLOG(("ProcessNewTxn:: Call DBTxnSeq: txn_seq = [%s]\n", csTxnId));

                	if (GetField_Int(hTxnRec,"seq",&iTmp)) {
DEBUGLOG(("ProcessNewTxn:: seq [%d]\n", iTmp));

                        	sprintf(csTag, "txn_seq_%d", iTmp);
                        	PutField_CString(hTxnRec, csTag, (const char *)csTxnId);
DEBUGLOG(("ProcessNewTxn:: [%s] = [%s]\n", csTag, csTxnId));
                	}
		}
        }

	// Add and Update Txn Header
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hTxnRec,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessNewTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

				// Compare TxnCode
				if ((!strcmp(csOrgTxnCode,PD_MI_TXN_CODE_BANK_RECEIVE_FROM_RSP))
                         	    || (!strcmp(csOrgTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_UNDERPAID))
                         	    || (!strcmp(csOrgTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_OVERPAID))        
                		)
				{
                                	// Add TxnHeader
                                	if (iRet == PD_OK) {
DEBUGLOG(("ProcessNewTxn::Call DBTransaction:: Add\n"));
                                        	DBObjPtr = CreateObj(DBPtr,"DBTransaction","Add");
                                        	iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        	if (iRet != PD_OK) {
DEBUGLOG(("ProcessNewTxn::Call DBTransaction:: Add Failed\n"));
                                        	        iRet = INT_ERR;
                                       	 	}
                                	}
				}

                                // Update TxnHeader
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessNewTxn::Call DBTransaction:: Update\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessNewTxn::Call DBTransaction:: Update Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
        }

	// Add and Update Txn Detail
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hTxnRec,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessNewTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add TxnDetail
                                if (iRet == PD_OK) {

DEBUGLOG(("ProcessNewTxn::Call DBTransaction:: AddDetail\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessNewTxn::Call DBTransaction:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }

                                // Update TxnDetail
                                if (iRet == PD_OK) {

/*
DEBUGLOG(("ProcessNewTxn::Call DBTransaction:: Update\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessNewTxn::Call DBTransaction:: Update Failed\n"));
                                                iRet = INT_ERR;
                                        }
*/
                                }
                        }
                }
        }

	// Update Entity Balance
	if (iRet == PD_OK) {
		// Check Entity Balance Acct Exist
DEBUGLOG(("ProcessNewTxn::Call DBMiEntityBalAcct:: GetEntityBalAcct\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMiEntityBalAcct", "GetEntityBalAcct");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTxnRec,hTxnRec);
                if (iDtlRet == PD_FOUND) {

/* status */
                        if (GetField_CString(hTxnRec, "status", &csStatus)) {
DEBUGLOG(("ProcessNewTxn::Call DBMiEntityBalAcct:: status = [%s]\n", csStatus));

                                // Check Entity Bal Acct Status
                                if (!strcmp(csStatus, PD_MI_ENTITY_BAL_ACCT_STATUS_CLOSE)) {
DEBUGLOG(("ProcessNewTxn::Call DBMiEntityBalAcct:: GetEntityBalAcct Disabled\n"));
ERRLOG("TxnMinByUsVRI::ProcessNewTxn::Call DBMiEntityBalAcct:: GetEntityBalAcct Disabled\n");
                                        iRet = INT_MMS_ENTITY_BAL_ACCT_DISABLED;
                                }
                        }

                } else {
DEBUGLOG(("ProcessNewTxn::Call DBMiEntityBalAcct:: GetEntityBalAcct Not Found\n"));
ERRLOG("TxnMinByUsVRI::ProcessNewTxn::Call DBMiEntityBalAcct:: GetEntityBalAcct Not Found\n");
                        iRet = INT_MMS_ENTITY_BAL_ACCT_NOT_FOUND;
                }

		if (iRet == PD_OK) {

/* txn_code */
		        if (GetField_CString(hTxnRec, "org_txn_code", &csOrgTxnCode)) {
DEBUGLOG(("ProcessNewTxn:: org_txn_code [%s]\n", csOrgTxnCode));
        		}

/* entity_id */
                        if (GetField_CString(hTxnRec,"entity_id",&csTmp)) {
DEBUGLOG(("ProcessNewTxn::entity_id = [%s]\n", csTmp));
                        }

/* txn_ccy */
                        if (GetField_CString(hTxnRec,"txn_ccy",&csTmp)) {
DEBUGLOG(("ProcessNewTxn::txn_ccy = [%s]\n", csTmp));
                        }

/* txn_country */
                        if (GetField_CString(hTxnRec,"txn_country",&csTmp)) {
DEBUGLOG(("ProcessNewTxn::txn_country = [%s]\n", csTmp));
                        }

			// batch_mode
			PutField_Char(hTxnRec, "batch_mode", PD_ONLINE);
DEBUGLOG(("ProcessNewTxn::batch_mode = [%c]\n",PD_ONLINE));

			// update_element (Set PD_FALSE for void case)
			PutField_Int(hTxnRec, "update_element", PD_FALSE);
DEBUGLOG(("ProcessNewTxn::update_element = [%d]\n",PD_FALSE));

			// amt_type, bal_type
			if (!strcmp(csOrgTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT))
			{

				PutField_CString(hTxnRec, "amt_type", PD_CR);
DEBUGLOG(("ProcessNewTxn::amt_type = [%s]\n",PD_CR));

                                PutField_Char(hTxnRec, "bal_type", PD_MI_ENTITY_POOL_ACCT_BAL);
DEBUGLOG(("ProcessNewTxn::bal_type = [%c]\n",PD_MI_ENTITY_POOL_ACCT_BAL));
	
			}	
                        else if (!strcmp(csOrgTxnCode,PD_MI_TXN_CODE_BANK_RECEIVE_FROM_RSP))
                        {

                              	PutField_CString(hTxnRec, "amt_type", PD_DR);
DEBUGLOG(("ProcessNewTxn::amt_type = [%s]\n",PD_DR));

                              	PutField_Char(hTxnRec, "bal_type", PD_MI_ENTITY_POOL_ACCT_BAL);
DEBUGLOG(("ProcessNewTxn::bal_type = [%c]\n",PD_MI_ENTITY_POOL_ACCT_BAL));

                                }
                    	else if ((!strcmp(csOrgTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_UNDERPAID))
                                 || (!strcmp(csOrgTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_OVERPAID))
                       	)
                     	{

DEBUGLOG(("ProcessNewTxn::Call MiDefArBal:: GetArBalParameterByTxnCode\n"));
                           	DBObjPtr = CreateObj(DBPtr,"DBMiDefArBal","GetArBalParameterByTxnCode");
                              	iRet = (unsigned long)(*DBObjPtr)(csOrgTxnCode,hRec);
                             	if (iRet == PD_OK) {
/* amt_type */
                                     	if (GetField_CString(hRec,"amt_type",&csAmtType)) {
DEBUGLOG(("ProcessNewTxn:: amt_type [%s]\n", csAmtType));

                                             	if (!strcmp(csAmtType,PD_CR)) {
                                                  	PutField_CString(hTxnRec, "amt_type", PD_DR);
                                               	} else if (!strcmp(csAmtType,PD_DR)) {
                                                      	PutField_CString(hTxnRec, "amt_type", PD_CR);
                                              	}
                                   	}

                          	} else {
DEBUGLOG(("ProcessNewTxn::Call MiDefArBal:: GetArBalParameterByTxnCode Failed\n"));
                                       	iRet = INT_ERR;
                              	}

                              	PutField_Char(hTxnRec, "bal_type", PD_MI_ENTITY_POOL_AR_BAL);
DEBUGLOG(("ProcessNewTxn::bal_type = [%c]\n",PD_MI_ENTITY_POOL_ACCT_BAL));

                    	}
			
			// UpdateEntityBalance
DEBUGLOG(("ProcessNewTxn::Call BOMiEntityBalance:: UpdateEntityBalance\n"));
                        BOObjPtr = CreateObj(BOPtr, "BOMiEntityBalance", "UpdateEntityBalance");
                        iRet = (unsigned long)(*BOObjPtr)(hTxnRec,hTxnRec);
                        if (iRet == PD_OK) {
DEBUGLOG(("ProcessNewTxn::Call BOMiEntityBalance:: UpdateEntityBalance Success\n"));

                                if (GetField_CString(hTxnRec, "approval_date", &csApprovalDate)) {
DEBUGLOG(("ProcessNewTxn::Call BOMiEntityBalance:: approval_date [%s]\n", csApprovalDate));
                                }

                                if (GetField_CString(hTxnRec, "approval_timestamp", &csApprovalTimestamp))  {
DEBUGLOG(("ProcessNewTxn::Call BOMiEntityBalance:: approval_timestamp [%s]\n", csApprovalTimestamp));
                                }

                                // Open Balance
                                if (GetField_Double(hTxnRec, "open_acct_bal", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOMiEntityBalance:: open_acct_bal = [%f]\n", dTmp));
                                }

                                if (GetField_Double(hTxnRec, "open_intransit", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOMiEntityBalance:: open_intransit = [%f]\n", dTmp));
                                }

                                if (GetField_Double(hTxnRec, "open_ar_bal", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOMiEntityBalance:: open_ar_bal = [%f]\n", dTmp));
                                }

                                // Close Balance
                                if (GetField_Double(hTxnRec, "acct_bal", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOMiEntityBalance:: closing acct_bal = [%f]\n", dTmp));
                                }

                                if (GetField_Double(hTxnRec, "intransit", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOMiEntityBalance:: closing intransit = [%f]\n", dTmp));
                                }

                                if (GetField_Double(hTxnRec, "ar_bal", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOMiEntityBalance:: closing ar_bal = [%f]\n", dTmp));
                                }

                        } else {
DEBUGLOG(("ProcessNewTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n"));
ERRLOG("TxnMinByUsVRI::ProcessNewTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n");
                                iRet = INT_ERR;
                        }

			// UpdateVoidTxnElements
			if (iRet == PD_OK) {
DEBUGLOG(("ProcessNewTxn::Call BOTxnElements:: VoidOrgTxnElements\n"));			
                        	BOObjPtr = CreateObj(BOPtr,"BOTxnElements","VoidOrgTxnElements");
                        	iRet = (unsigned long)(*BOObjPtr)(hTxnRec,hTxnRec);
				if (iRet != PD_OK) {
DEBUGLOG(("ProcessNewTxn::Call BOTxnElements:: VoidOrgTxnElements Failed\n"));
ERRLOG("TxnMinByUsVRI::ProcessNewTxn::Call BOTxnElements:: VoidOrgTxnElements Failed\n");
                		}
			}
		}
	}

	// Add Txn Mi Detail
        if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hTxnRec,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessNewTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add TxnMiDetail
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessNewTxn::Call DBTxnMiDetail:: Add\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Add");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessNewTxn::Call DBTxnMiDetail:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
        }

	// Add Mi Txn Log
        if (iRet == PD_OK) {

                if(GetField_Int(hTxnRec,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessNewTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add MiTxnLog
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessNewTxn::Call DBTransaction:: AddMiTxnLog\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddMiTxnLog");
                                        iRet = (unsigned long)(*DBObjPtr)(csTxnId);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessNewTxn::Call DBTransaction:: AddMiTxnLog Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
        }
	
	// Update Status, Ar_Ind, Sub Status, Approval Date and Approval Timestamp
        if (iRet == PD_OK) {

/* status */
                PutField_Char(hTxnRec,"status",PD_COMPLETE);
DEBUGLOG(("ProcessNewTxn::status [%c]\n", PD_COMPLETE));

/* ar_ind */
                PutField_Char(hTxnRec,"ar_ind",PD_ACCEPT);
DEBUGLOG(("ProcessNewTxn::ar_ind [%c]\n", PD_ACCEPT));

/* sub_status */
                PutField_CString(hTxnRec,"sub_status",PD_APPROVED);
DEBUGLOG(("ProcessNewTxn::sub_status [%s]\n", PD_APPROVED));

/* approval_date */
                PutField_CString(hTxnRec, "approval_date", csApprovalDate);
DEBUGLOG(("ProcessNewTxn::approval_date [%s]\n", csApprovalDate));

/* approval_timestamp */
                PutField_CString(hTxnRec, "approval_timestamp", csApprovalTimestamp);
DEBUGLOG(("ProcessNewTxn::approval_timestamp [%s]\n", csApprovalTimestamp));

/* do_logging */
                PutField_Int(hTxnRec, "do_logging", PD_FALSE);
DEBUGLOG(("ProcessNewTxn:: do_logging [%d]\n", PD_FALSE));

DEBUGLOG(("ProcessNewTxn::Call DBTransaction: Update \n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("ProcessNewTxn::Call DBTransaction:: Update Failed\n"));
                }
        }

	hash_destroy(hRec);
        FREE_ME(hRec);

DEBUGLOG(("ProcessNewTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int	ProcessOrgBatch(hash_t* hContext, recordset_t *rOrgBatchRecordSet)
{
	int     iRet = PD_OK;

	char	*csBatchId = NULL;
	char	*csTxnId = NULL;
	char	*csTxnCode = NULL;
	char	*csUser = NULL;

	hash_t 	*hOrgBatchRec;
	
	hash_t  *hOrgBatchTxnRec;
	hOrgBatchTxnRec = (hash_t*) malloc (sizeof(hash_t));
	
/* last_batch_id */
        if (GetField_CString(hContext,"last_batch_id",&csBatchId)) {
DEBUGLOG(("ProcessOrgBatch::last_batch_id = [%s]\n",csBatchId));
        } else {
DEBUGLOG(("ProcessOrgBatch::last_batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::ProcessOrgBatch::last_batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
        }

/* add_user */
        if (GetField_CString(hContext, "add_user", &csUser)) {
DEBUGLOG(("ProcessOrgBatch:: upate_user [%s]\n", csUser));
        }

	// Update Org Batch Txn
	if (iRet == PD_OK) {
           	hOrgBatchRec = RecordSet_GetFirst(rOrgBatchRecordSet);
               	while (hOrgBatchRec) {

DEBUGLOG(("===== ProcessOrgBatch ===== START!!\n"));

			hash_init(hOrgBatchTxnRec,0);	

/* txn_id */
			if (GetField_CString(hOrgBatchRec, "txn_id", &csTxnId)) {
DEBUGLOG(("ProcessOrgBatch: txn_id [%s]\n", csTxnId));
				PutField_CString(hOrgBatchTxnRec, "txn_seq", csTxnId);
			}

/* txn_code */
			if (GetField_CString(hOrgBatchRec, "txn_code", &csTxnCode)) {
DEBUGLOG(("ProcessOrgBatch:: txn_code [%s]\n", csTxnCode));
				PutField_CString(hOrgBatchTxnRec, "txn_code", csTxnCode);

				// user
				PutField_CString(hOrgBatchTxnRec, "update_user", csUser);
DEBUGLOG(("ProcessOrgBatch:: update_user [%s]\n", csUser));
			
                                // Update Next Grp Txn Id to NULL
                                if (iRet == PD_OK) {
                                        if (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_IN)) {
DEBUGLOG(("ProcessOrgBatch::Call DBTxnMiDetail: UpdateNextGrpTxnId2NULL \n"));
                                                DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","UpdateNextGrpTxnId2NULL");
                                                iRet = (unsigned long)(*DBObjPtr)(hOrgBatchTxnRec);
                                                if (iRet != PD_OK) {
DEBUGLOG(("ProcessOrgBatch::Call DBTxnMiDetail: UpdateNextGrpTxnId2NULL Failed\n"));
                                                        iRet = INT_ERR;
                                                }
                                        }
                                }

				// Update Txn Header (Status, Ar Ind and Sub Status)
                                if (iRet == PD_OK) {

/* status, ar_ind and sub_status */
                                        if ((!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT))
                                            || (!strcmp(csTxnCode,PD_MI_TXN_CODE_BANK_RECEIVE_FROM_RSP))
                                            || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_UNDERPAID))
                                            || (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_OUT_OVERPAID))
                                        )
                                        {
						// Set Status - PD_REVERSED ('R')
						PutField_Char(hOrgBatchTxnRec,"status",PD_REVERSED);
DEBUGLOG(("ProcessOrgBatch::status [%c]\n", PD_REVERSED));						

						// Set Ar Ind - PD_ACCEPT ('A')
						PutField_Char(hOrgBatchTxnRec,"ar_ind",PD_ACCEPT);
DEBUGLOG(("ProcessOrgBatch::ar_ind [%c]\n", PD_ACCEPT));

                                                // Set SubStatus - PD_UNDO (130)
                                                PutField_CString(hOrgBatchTxnRec,"sub_status",PD_UNDO);
DEBUGLOG(("ProcessOrgBatch::sub_status [%s]\n", PD_UNDO));
                                        }
                                        else if (!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_DELIVERY_IN)
                                        )
                                        {
                                                // Set SubStatus - PD_APPROVED (118)
                                                PutField_CString(hOrgBatchTxnRec,"sub_status",PD_APPROVED);
DEBUGLOG(("ProcessOrgBatch::sub_status [%s]\n", PD_APPROVED));
                                        }
                                        else if ((!strcmp(csTxnCode,PD_MI_TXN_CODE_RSP_IN_TRANSIT))
                                                 || (!strcmp(csTxnCode,PD_PSP_SETTLEMENT))
                                        )
                                        {
                                                // Set SubStatus - PD_DELIVERING (129)
                                                PutField_CString(hOrgBatchTxnRec,"sub_status",PD_DELIVERING);
DEBUGLOG(("ProcessOrgBatch::sub_status [%s]\n", PD_DELIVERING));
                                        }

DEBUGLOG(("ProcessOrgBatch::Call DBTransaction: Update \n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                                        iRet = (unsigned long)(*DBObjPtr)(hOrgBatchTxnRec);
                                        if (iRet != PD_OK) {
                                                iRet = INT_ERR;
DEBUGLOG(("ProcessOrgBatch::Call DBTransaction:: Update Failed\n"));
                                        }
                                }
			}

			hash_destroy(hOrgBatchTxnRec);

DEBUGLOG(("ProcessOrgBatch:: iRet [%d]\n", iRet));
DEBUGLOG(("===== ProcessOrgBatch ===== END !!\n"));

			hOrgBatchRec = RecordSet_GetNext(rOrgBatchRecordSet);
                }
	
		FREE_ME(hOrgBatchTxnRec);
	}

DEBUGLOG(("ProcessOrgBatch Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessVoidBatch(hash_t* hContext, recordset_t *rOrgBatchRecordSet)
{
	int     iRet = PD_OK;

	int	iSeq = 0;
	int	iOpbCnt = 0;
	int	iAmtDiffCnt = 0;
	int	i = 0;

	char	*csBatchId = NULL;
	char	*csProcessType = NULL;
	char	*csUser = NULL;
        char    *csTmp = NULL;

	char    csTag[PD_TAG_LEN + 1];

        hash_t *hOrgBatchRec;

	hash_t *hVoidBatchRec;
	hVoidBatchRec  = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hVoidBatchRec, 0);

/* batch_id */
        if (GetField_CString(hContext,"batch_id",&csBatchId)) {
DEBUGLOG(("ProcessVoidBatch::batch_id = [%s]\n",csBatchId));
        } else {
DEBUGLOG(("ProcessVoidBatch::batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::ProcessVoidBatch::batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
        }

/* last_batch_id */
        if (GetField_CString(hContext,"last_batch_id",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::last_batch_id = [%s]\n",csTmp));
        } else {
DEBUGLOG(("ProcessVoidBatch::last_batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::ProcessVoidBatch::last_batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
        }

/* mini_txn_type (process_type) */
        if (GetField_CString(hContext,"mini_txn_type",&csProcessType)) {
DEBUGLOG(("ProcessVoidBatch::mini_txn_type (process_type) = [%s]\n",csProcessType));
        } else {
DEBUGLOG(("ProcessVoidBatch::mini_txn_type (process_type) not found!!\n"));
ERRLOG("TxnMinByUsVRI::Authorize::process_type not found!!\n");
                iRet = INT_MI_PROCESS_TYPE_NOT_FOUND;
        }

/* add_user */
        if (GetField_CString(hContext, "add_user", &csUser)) {
DEBUGLOG(("ProcessVoidBatch::upate_user [%s]\n", csUser));
        }

	// Add Void Batch Header
	if (iRet == PD_OK) {

		// batch_id
		PutField_CString(hVoidBatchRec,"batch_id",csBatchId);
DEBUGLOG(("ProcessVoidBatch::batch_id = [%s]\n", csBatchId));

                // process_type
                PutField_CString(hVoidBatchRec,"process_type",csProcessType);
DEBUGLOG(("ProcessVoidBatch::process_type = [%s]\n", csProcessType));

                // status
                PutField_Char(hVoidBatchRec,"status",PD_MI_BATCH_STATUS_NORMAL);
DEBUGLOG(("ProcessVoidBatch::status = [%c]\n", PD_MI_BATCH_STATUS_NORMAL));

		// user
		PutField_CString(hVoidBatchRec,"add_user",csUser);
                PutField_CString(hVoidBatchRec,"update_user",csUser);		
DEBUGLOG(("ProcessVoidBatch::csUser = [%s]\n", csUser));

DEBUGLOG(("ProcessVoidBatch::Call MiBatchHeader:: Add\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMiBatchHeader", "Add");
                iRet = (unsigned long)(*DBObjPtr)(hVoidBatchRec);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("ProcessVoidBatch::Call MiBatchHeader:: Add Failed\n"));
                }

		hash_destroy(hVoidBatchRec);		
        }

	// Add Void RSP Delivery Out Txn into Void Batch
	if (iRet == PD_OK) {

		hash_init(hVoidBatchRec, 0);

// batch_id
		PutField_CString(hVoidBatchRec,"batch_id",csBatchId);
DEBUGLOG(("ProcessVoidBatch::batch_id = [%s]\n", csBatchId));

// seq
		PutField_Int(hVoidBatchRec,"seq",++iSeq);
DEBUGLOG(("ProcessVoidBatch::seq = [%d]\n", iSeq));

// txn_oper_ind
             	PutField_Char(hVoidBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_INSERT);
DEBUGLOG(("ProcessVoidBatch::txn_oper_ind = [%c]\n", PD_MI_BATCH_TXN_OPER_INSERT));

// user
		PutField_CString(hVoidBatchRec,"add_user",csUser);
                PutField_CString(hVoidBatchRec,"update_user",csUser);
DEBUGLOG(("ProcessVoidBatch::user = [%s]\n", csUser));

/* txn_id */
              	if (GetField_CString(hContext, "dli_txn_id", &csTmp)) {
DEBUGLOG(("ProcessVoidBatch::dli_txn_id = [%s]\n", csTmp));
                      	PutField_CString(hVoidBatchRec,"txn_id",csTmp);
               	}

/* entity_id */
             	if (GetField_CString(hContext,"dli_entity_id",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::dli_entity_id = [%s]\n", csTmp));
                     	PutField_CString(hVoidBatchRec,"entity_id",csTmp);
              	}

/* party_type */
              	if (GetField_CString(hContext,"dli_party_type",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::dli_party_type = [%s]\n", csTmp));
                    	PutField_CString(hVoidBatchRec,"party_type",csTmp);
               	}

/* party_id */
             	if (GetField_CString(hContext,"dli_party_id",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::dli_party_id = [%s]\n", csTmp));
                     	PutField_CString(hVoidBatchRec,"party_id",csTmp);
              	}

		// Add Void Batch
DEBUGLOG(("ProcessVoidBatch::Call MiBatchDetail: Add \n"));
             	DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
             	iRet = (unsigned long)(*DBObjPtr)(hVoidBatchRec);
             	if (iRet != PD_OK) {
                      	iRet = INT_ERR;
DEBUGLOG(("ProcessVoidBatch::Call MiBatchDetail:: Add Failed\n"));
            	}

		hash_destroy(hVoidBatchRec);
	}

	// Add Void OPB Fund In Txn into Void Batch
	if (iRet == PD_OK) {

		hash_init(hVoidBatchRec, 0);

// batch_id
		PutField_CString(hVoidBatchRec,"batch_id",csBatchId);
DEBUGLOG(("ProcessVoidBatch::batch_id = [%s]\n", csBatchId));

// txn_oper_ind
             	PutField_Char(hVoidBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_INSERT);
DEBUGLOG(("ProcessVoidBatch::txn_oper_ind = [%c]\n", PD_MI_BATCH_TXN_OPER_INSERT));

// user
		PutField_CString(hVoidBatchRec,"add_user",csUser);
                PutField_CString(hVoidBatchRec,"update_user",csUser);
DEBUGLOG(("ProcessVoidBatch::user = [%s]\n", csUser));


/* entity_id */
                if (GetField_CString(hContext,"opb_entity_id",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::opb_entity_id = [%s]\n", csTmp));
                        PutField_CString(hVoidBatchRec,"entity_id",csTmp);
                }

/* party_type */
                if (GetField_CString(hContext,"opb_party_type",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::opb_party_type = [%s]\n", csTmp));
                        PutField_CString(hVoidBatchRec,"party_type",csTmp);
                }

/* party_id */
                if (GetField_CString(hContext,"opb_party_id",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::opb_party_id = [%s]\n", csTmp));
                        PutField_CString(hVoidBatchRec,"party_id",csTmp);
                }

/* opb_cnt */
		if (GetField_Int(hContext, "opb_cnt", &iOpbCnt)) {
DEBUGLOG(("ProcessVoidBatch::opb_cnt = [%d]\n", iOpbCnt));
               	}	

		for (i=0; i<iOpbCnt; i++) {
		
/* txn_id */
			sprintf(csTag, "opb_txn_id_%d", i+1);		
              		if (GetField_CString(hContext, csTag, &csTmp)) {
DEBUGLOG(("ProcessVoidBatch::txn_seq = [%s]\n", csTmp));
                      		PutField_CString(hVoidBatchRec,"txn_id",csTmp);
               		}
			
// seq
                	PutField_Int(hVoidBatchRec,"seq",++iSeq);
DEBUGLOG(("ProcessVoidBatch::seq = [%d]\n", iSeq));

			// Add Void Batch
DEBUGLOG(("ProcessVoidBatch::Call MiBatchDetail: Add \n"));
             		DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
             		iRet = (unsigned long)(*DBObjPtr)(hVoidBatchRec);
             		if (iRet != PD_OK) {
                	      	iRet = INT_ERR;
DEBUGLOG(("ProcessVoidBatch::Call MiBatchDetail:: Add Failed\n"));
            		}
		}

		hash_destroy(hVoidBatchRec);
	}
	
	// Add Void RSP AmtDiff Txn into Void Batch
	if (iRet == PD_OK) {

		hash_init(hVoidBatchRec, 0);

// batch_id
		PutField_CString(hVoidBatchRec,"batch_id",csBatchId);
DEBUGLOG(("ProcessVoidBatch::batch_id = [%s]\n", csBatchId));

// txn_oper_ind
             	PutField_Char(hVoidBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_INSERT);
DEBUGLOG(("ProcessVoidBatch::txn_oper_ind = [%c]\n", PD_MI_BATCH_TXN_OPER_INSERT));

// user
		PutField_CString(hVoidBatchRec,"add_user",csUser);
                PutField_CString(hVoidBatchRec,"update_user",csUser);
DEBUGLOG(("ProcessVoidBatch::user = [%s]\n", csUser));


/* entity_id */
                if (GetField_CString(hContext,"amtdiff_entity_id",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::amtdiff_entity_id = [%s]\n", csTmp));
                        PutField_CString(hVoidBatchRec,"entity_id",csTmp);
                }

/* party_type */
                if (GetField_CString(hContext,"amtdiff_party_type",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::amtdiff_party_type = [%s]\n", csTmp));
                        PutField_CString(hVoidBatchRec,"party_type",csTmp);
                }

/* party_id */
                if (GetField_CString(hContext,"amtdiff_party_id",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::amtdiff_party_id = [%s]\n", csTmp));
                        PutField_CString(hVoidBatchRec,"party_id",csTmp);
                }

/* amtdiff_cnt */
		if (GetField_Int(hContext, "amtdiff_cnt", &iAmtDiffCnt)) {
DEBUGLOG(("ProcessVoidBatch::amtdiff_cnt = [%d]\n", iAmtDiffCnt));
               	}	

		for (i=0; i<iAmtDiffCnt; i++) {
		
/* txn_id */
			sprintf(csTag, "amtdiff_txn_id_%d", i+1);		
              		if (GetField_CString(hContext, csTag, &csTmp)) {
DEBUGLOG(("ProcessVoidBatch::txn_seq = [%s]\n", csTmp));
                      		PutField_CString(hVoidBatchRec,"txn_id",csTmp);
               		}

// seq
   		       	PutField_Int(hVoidBatchRec,"seq",++iSeq);
DEBUGLOG(("ProcessVoidBatch::seq = [%d]\n", iSeq));
			
			// Add Void Batch
DEBUGLOG(("ProcessVoidBatch::Call MiBatchDetail: Add \n"));
             		DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
             		iRet = (unsigned long)(*DBObjPtr)(hVoidBatchRec);
             		if (iRet != PD_OK) {
                	      	iRet = INT_ERR;
DEBUGLOG(("ProcessVoidBatch::Call MiBatchDetail:: Add Failed\n"));
            		}
		}

		hash_destroy(hVoidBatchRec);
	}

	// Add Org Batch Txn into Void Batch
        if (iRet == PD_OK) {
		hOrgBatchRec = RecordSet_GetFirst(rOrgBatchRecordSet);
                while (hOrgBatchRec) {

			hash_init(hVoidBatchRec, 0);

// batch_id
			PutField_CString(hVoidBatchRec,"batch_id",csBatchId);
DEBUGLOG(("ProcessVoidBatch::batch_id = [%s]\n", csBatchId));

// seq
                        PutField_Int(hVoidBatchRec,"seq",++iSeq);
DEBUGLOG(("ProcessVoidBatch::seq = [%d]\n", iSeq));

// txn_oper_ind
                	PutField_Char(hVoidBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_UPDATE);
DEBUGLOG(("ProcessVoidBatch::txn_oper_ind = [%c]\n", PD_MI_BATCH_TXN_OPER_UPDATE));

// user
                	PutField_CString(hVoidBatchRec,"add_user",csUser);
                	PutField_CString(hVoidBatchRec,"update_user",csUser);
DEBUGLOG(("ProcessVoidBatch::user = [%s]\n", csUser));

/* txn_id */
                       	if (GetField_CString(hOrgBatchRec, "txn_id", &csTmp)) {
DEBUGLOG(("ProcessVoidBatch::batch_txn_id = [%s]\n", csTmp));
                          	 PutField_CString(hVoidBatchRec,"txn_id",csTmp);
                     	}

/* entity_id */
        		if (GetField_CString(hOrgBatchRec,"entity_id",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::entity_id = [%s]\n", csTmp));
                		PutField_CString(hVoidBatchRec,"entity_id",csTmp);
        		}

/* party_type */
        		if (GetField_CString(hOrgBatchRec,"party_type",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::party_type = [%s]\n", csTmp));
                		PutField_CString(hVoidBatchRec,"party_type",csTmp);
        		}

/* party_id */
        		if (GetField_CString(hOrgBatchRec,"party_id",&csTmp)) {
DEBUGLOG(("ProcessVoidBatch::party_id = [%s]\n", csTmp));
                		PutField_CString(hVoidBatchRec,"party_id",csTmp);
        		}

			// Add Void Batch
DEBUGLOG(("ProcessVoidBatch::Call MiBatchDetail: Add \n"));
        		DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
        		iRet = (unsigned long)(*DBObjPtr)(hVoidBatchRec);
        		if (iRet != PD_OK) {
                		iRet = INT_ERR;
DEBUGLOG(("ProcessVoidBatch::Call MiBatchDetail:: Add Failed\n"));
        		}

			hash_destroy(hVoidBatchRec);
			
			hOrgBatchRec = RecordSet_GetNext(rOrgBatchRecordSet);
                }
	}
	
	FREE_ME(hVoidBatchRec);

DEBUGLOG(("ProcessVoidBatch Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessVoidACR(hash_t* hContext)
{
	int     iRet = PD_OK;

	int     iOpbCnt = 0;
	int	i = 0;

        char	*csTxnId = NULL;
	char    *csTmp = NULL;

        char    csTag[PD_TAG_LEN + 1];

        hash_t *hAcr;
        hAcr = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hAcr,0);

/* batch_id */
        if (GetField_CString(hContext,"batch_id",&csTmp)) {
DEBUGLOG(("ProcessVoidACR::batch_id = [%s]\n",csTmp));
		PutField_CString(hAcr,"batch_id",csTmp);
        } else {
DEBUGLOG(("ProcessVoidACR::batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::ProcessVoidBatch::batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
        }

/* last_batch_id */
        if (GetField_CString(hContext,"last_batch_id",&csTmp)) {
DEBUGLOG(("ProcessVoidACR::last_batch_id = [%s]\n",csTmp));
		PutField_CString(hAcr,"org_batch_id",csTmp);
        } else {
DEBUGLOG(("ProcessVoidACR::last_batch_id not found!!\n"));
ERRLOG("TxnMinByUsVRI::ProcessVoidACR::last_batch_id not found!!\n");
                iRet = INT_MI_BATCH_ID_NOT_FOUND;
        }

/* txn_date */
	if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("ProcessVoidACR::txn_date = [%s]\n",csTmp));
                PutField_CString(hAcr,"txn_date",csTmp);
	}

/* add_user */
        if (GetField_CString(hContext, "add_user", &csTmp)) {
DEBUGLOG(("ProcessVoidACR:: upate_user [%s]\n", csTmp));
        	PutField_CString(hAcr,"add_user",csTmp);
                PutField_CString(hAcr,"update_user",csTmp);
	}

/* is_void */
                PutField_Int(hAcr,"is_void",PD_TRUE);
DEBUGLOG(("ProcessVoidACR:: is_void = [%d]\n", PD_TRUE));

/* entity_id */
        if (GetField_CString(hContext,"opb_entity_id",&csTmp)) {
DEBUGLOG(("ProcessVoidACR:: opb_entity_id = [%s]\n",csTmp));
                PutField_CString(hAcr,"entity_id",csTmp);
        }

/* entity_type */
   	if (GetField_CString(hContext,"opb_party_type",&csTmp)) {
DEBUGLOG(("ProcessVoidACR:: opb_entity_type = [%s]\n",csTmp));
            	PutField_CString(hAcr,"entity_type",csTmp);
       	}

/* party_id */
       	if (GetField_CString(hContext,"opb_party_id",&csTmp)) {
DEBUGLOG(("ProcessVoidACR:: opb_party_id = [%s]\n",csTmp));
              	PutField_CString(hAcr,"party_id",csTmp);
      	}

/* txn_code */
      	if (GetField_CString(hContext,"opb_txn_code",&csTmp)) {
DEBUGLOG(("ProcessVoidACR:: opb_txn_code = [%s]\n",csTmp));
          	PutField_CString(hAcr,"txn_code",csTmp);
     	}

/* opb_cnt */
        if (GetField_Int(hContext, "opb_cnt", &iOpbCnt)) {
DEBUGLOG(("ProcessVoidACR:: opb_cnt [%d]\n", iOpbCnt));
                PutField_Int(hAcr,"txn_cnt",iOpbCnt);
        }

	if (iRet == PD_OK) {	

		if (iOpbCnt == 1) {

			sprintf(csTag, "opb_txn_id_%d", i+1);
			if (GetField_CString(hContext,csTag,&csTxnId)) {
DEBUGLOG(("ProcessVoidACR:: txn_id = [%s]\n",csTxnId));
						
				PutField_CString(hAcr,"txn_id",csTxnId);
			}

		} else if (iOpbCnt > 1) {

			for (i=0; i<iOpbCnt; i++) {

/* txn_id */			
				sprintf(csTag, "opb_txn_id_%d", i+1);
				if (GetField_CString(hContext,csTag,&csTxnId)) {
DEBUGLOG(("ProcessVoidACR:: txn_id = [%s]\n",csTxnId));
		
					sprintf(csTag, "txn_id_%d", i);
					PutField_CString(hAcr,csTag,csTxnId);
				}
			}	
		} else {
DEBUGLOG(("ProcessVoidACR:: txn_cnt Failed\n"));
			iRet = INT_ERR;
		}
	}
	
	if (iRet == PD_OK) {	
DEBUGLOG(("ProcessVoidACR::Call BOMiAcr::CalculateACR \n"));
                BOObjPtr = CreateObj(BOPtr,"BOMiAcr","CalculateACR");
                iRet = (unsigned long) ((*BOObjPtr)(hAcr));
                if (iRet != PD_OK) {
DEBUGLOG(("ProcessVoidACR::Call BOMiAcr::CalculateACR Failed\n"));
                        iRet = INT_ERR;
                } 
	}

	hash_destroy(hAcr);
        FREE_ME(hAcr);

DEBUGLOG(("ProcessVoidACR Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}
