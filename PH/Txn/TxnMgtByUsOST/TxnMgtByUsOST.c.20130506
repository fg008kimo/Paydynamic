/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/04/14              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsOST.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"
#include "dbutility.h"


char cDebug;
OBJPTR(BO);
OBJPTR(DB);
OBJPTR(Txn);
OBJPTR(Channel);

void TxnMgtByUsOST(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	double	dTxnAmt;
	char	*csFromCcy;
	char	*csToCcy;
	char	*csCountry;
	//char	*csFromCountry = NULL;
	char	*csTxnSeq;
	char	*csTmp;
	char	*csPHPostingDate;
	char	*csPtr;
	char	csId[PD_TXN_SEQ_LEN+1];
	int	iInternalErr = 0;
	char	cTmp = PD_NO;

	double  dDstAmt = 0.0;

	int	iCheck = 0;
	int	iId= 0;
	char	*p;

DEBUGLOG(("Authorize::()\n"));
	if (GetField_CString(hContext,"PHDATE",&csPHPostingDate)) {
DEBUGLOG(("Authorize::()PH DATe = [%s]\n",csPHPostingDate));
	}
/* txn amt */
	if (GetField_Double(hContext,"txn_amt",&dTxnAmt)) {
DEBUGLOG(("Authorize::() txn_amt = [%f]\n",dTxnAmt));
	}
	else {
		iRet = INT_TXN_AMT_MISSING;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::() txn_amt is missing\n"));
ERRLOG("TxnMgtOnUSOST:Authorize() txn amount is missing\n");
	}

	if (dTxnAmt <= 0 ) {
		iRet = INT_INVALID_PAY_AMOUNT;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::() txn_amt is missing\n"));
ERRLOG("TxnMgtOnUSOST:Authorize() txn amount is missing\n");
	}
/* txn country */

	if (GetField_CString(hRequest,"txn_country",&csCountry)) {
		PutField_CString(hContext,"txn_country",csCountry);
DEBUGLOG(("Authorize::() txn_country = [%s]\n",csCountry));
	}
/*
	else {
		iRet = INT_TXN_COUNTRY_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::() txn_country missing\n"));
ERRLOG("TxnMgtOnUSOST:Authorize() txn_country is missing\n");
	}
*/


/* txn_ccy */
	if (GetField_CString(hRequest,"txn_ccy",&csFromCcy)) {
DEBUGLOG(("Authorize::() txn_ccy = [%s]\n",csFromCcy));
	}
	else {
		iRet = INT_CURRENCY_CODE_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::() txn_ccy missing\n"));
ERRLOG("TxnMgtOnUSOST:Authorize() txn_ccy is missing\n");
	}

	if(GetField_CString(hRequest,"to_amt",&csTmp)){
                iCheck = PD_FALSE;
                p = (char*)strchr(csTmp, '.');
                if (p == NULL){
                        iCheck = is_numeric(csTmp);
                        if(iCheck!=PD_FALSE){
                                if(sscanf(csTmp,"%lf",&dDstAmt)==1){
DEBUGLOG(("Authorize() dst_txn_amt = [%f]\n",dDstAmt));
                                }
                        }
                }
                else{
                        if(sscanf(csTmp,"%lf",&dDstAmt)==1){
DEBUGLOG(("Authorize() dst_txn_amt = [%f]\n",dDstAmt));
                                iCheck = PD_TRUE;
                        }
                }
                if(iCheck==PD_FALSE){
                        iRet =  INT_INVALID_PAY_AMOUNT;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()dst_txn_amt Invalid[%s]\n",csTmp));
ERRLOG("TxnMgtByUsCOM::Authorize() dst_txn_amt Invalid\n");
                }
        }
        else{
DEBUGLOG(("Authorize::to_amt not found!!\n"));
ERRLOG("TxnMgtByUsPSF::Authorize::to_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }


/* to txn_ccy */
	if (GetField_CString(hRequest,"dst_txn_ccy",&csToCcy)) {
DEBUGLOG(("Authorize::() dst_txn_ccy = [%s]\n",csToCcy));
	}
	else {
		iRet = INT_CURRENCY_CODE_NOT_FOUND;
DEBUGLOG(("Authorize::() dst_txn_ccy missing\n"));
ERRLOG("TxnMgtOnUSOST:Authorize() dst_txn_ccy is missing\n");
	}

/* from country 
	if (GetField_CString(hRequest,"from_country",&csCountry)) {
		PutField_CString(hRequest,"txn_country",csCountry);
DEBUGLOG(("Authorize::() from_country = [%s]\n",csCountry));
	}

// to_country 
	if (GetField_CString(hRequest,"to_country",&csToCountry)) {
		//PutField_CString(hContext,"_country",csToCountry);
DEBUGLOG(("Authorize::() to_country = [%s]\n",csToCountry));
	}
*/

/* remark */
	if (GetField_CString(hRequest,"remark",&csPtr)) {
DEBUGLOG(("Authorize::() remark = [%s]\n",csPtr));
	}


/* user */
	if (GetField_CString(hRequest,"add_user",&csPtr)) {
		PutField_CString(hContext,"add_user",csPtr);
DEBUGLOG(("Authorize::() add_user = [%s]\n",csPtr));
	}


	if(iRet == PD_OK){
DEBUGLOG(("Authorize:: call SystemParameter:FindCode Allow Offline Settlement\n"));
		DBObjPtr = CreateObj(DBPtr,"DBSystemParameter","FindCode");
		if ((unsigned long)(DBObjPtr)(PD_OFFLINE_SETTLE,csTmp) == FOUND) {
			cTmp = csTmp[0];
DEBUGLOG(("FindCode Allow Offline Settlement = [%c]\n",cTmp));
			if(cTmp != PD_YES){
DEBUGLOG(("Authorize:: Offline Settlement not allowed!!!!!!!!\n"));
ERRLOG("TxnMgtByUsOST::Authorize: Offline Settlement not allowed!!!!!!!!\n");
				iRet=INT_INVALID_TXN;
			}
		}
	}



	if (iRet == PD_OK) {

		PutField_CString(hContext,"txn_ccy",csFromCcy);
		//PutField_CString(hContext,"txn_country",csCountry);
		PutField_CString(hContext,"net_ccy",csFromCcy);

		if (GetField_CString(hContext,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("Authorize() txn_seq = [%s]\n",csTxnSeq));
		}

		if (iRet == PD_OK) {
			ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateTxnDetailLog");
               		iRet = (unsigned long)(*ChannelObjPtr)(hContext,hRequest,hResponse);
		}
	}


/* check to merchant account */
        if (iRet == PD_OK) {
DEBUGLOG(("check To merchant\n"));

DEBUGLOG(("to txn_ccy = [%s]\n",csToCcy));
//DEBUGLOG(("to txn_country = [%s]\n",csCountry));
        	hash_t *hReq,*hNewContext, *hTxn;
        	hReq = (hash_t*) malloc (sizeof(hash_t));
        	hash_init(hReq,0);
        	hNewContext = (hash_t*) malloc (sizeof(hash_t));
        	hash_init(hNewContext,0);
        	hTxn = (hash_t*) malloc (sizeof(hash_t));
        	hash_init(hTxn,0);

DEBUGLOG(("Authorize() new txn for TFT\n"));
		unsigned char   csTmpTxnSeq[PD_TXN_SEQ_LEN +1];

/* don't commit */
                PutField_Int(hNewContext,"db_commit",PD_FALSE);

		DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextMgtTxnSeq");
                strcpy((char*)csTmpTxnSeq,(*DBObjPtr)());
/* new txn seq */
                PutField_CString(hNewContext,"txn_seq",(const char*)csTmpTxnSeq);
		//PutField_CString(hResponse,"txn_seq_tt",(const char*)csTmpTxnSeq);
/* org txn seq */
		PutField_CString(hNewContext,"org_txn_seq",csTxnSeq);

/* local tm date */
		if (GetField_CString(hContext,"local_tm_date",&csPtr)) {
			PutField_CString(hNewContext,"local_tm_date",csPtr);
		}
/* local tm time */
		if (GetField_CString(hContext,"local_tm_time",&csPtr)) {
			PutField_CString(hNewContext,"local_tm_time",csPtr);
		}
/* remark */
		if (GetField_CString(hRequest,"remark",&csPtr)) {
			PutField_CString(hReq,"remark",csPtr);
		}
/* add user */
		if (GetField_CString(hRequest,"add_user",&csPtr)) {
			PutField_CString(hNewContext,"add_user",csPtr);
		}
/* ip addr */
		if (GetField_CString(hRequest,"ip_addr",&csPtr)) {
			PutField_CString(hReq,"ip_addr",csPtr);
		}
/* host_posting_date */
		if (GetField_CString(hContext,"PHDATE",&csPtr)) {
			PutField_CString(hNewContext,"PHDATE",csPtr);
		}
	
		PutField_CString(hNewContext,"channel_code",PD_CHANNEL_MGT);
		PutField_CString(hNewContext,"txn_code",PD_OFFLINE_SETTLE_TO);
		PutField_CString(hNewContext,"process_code",PD_PROCESS_CODE_DEF);
		PutField_CString(hNewContext,"process_type",PD_PROCESS_TYPE_DEF);

/* txn amt */	
		PutField_Double(hNewContext,"txn_amt",dDstAmt);
/* update context */
		ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateContext");
               	iRet = (unsigned long)(*ChannelObjPtr)(hContext);


		PutField_CString(hNewContext,"txn_ccy",csToCcy);
DEBUGLOG(("Authorize() dst_txn_ccy = [%s]\n",csToCcy));
		PutField_CString(hNewContext,"net_ccy",csToCcy);

		PutField_CString(hReq,"txn_ccy",csToCcy);

/* Add New Txn */
		if (iRet == PD_OK) {
			ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnLog");
               		iRet = (unsigned long)(*ChannelObjPtr)(hNewContext,hReq);
		}
		else {
			RemoveField_Int(hNewContext,"internal_error");
			PutField_Int(hContext,"internal_error",iRet);
		}


                if (iRet == PD_OK) {
			///handle fundin
			PutField_Double(hRequest,"bank_amt",dDstAmt);
			PutField_CString(hRequest,"bank_ccy",csToCcy);
			PutField_Double(hRequest,"fin_amt",dTxnAmt);
			PutField_CString(hRequest,"fin_ccy",csFromCcy);
DEBUGLOG(("Authorize::Call TxnMgtByUsFIR\n"));
			TxnObjPtr = CreateObj(TxnPtr, "TxnMgtByUsFIR","Authorize");
			iRet = (unsigned long)((*TxnObjPtr)(hContext, hRequest, hResponse));
			if (iRet== PD_OK){ 
				if(GetField_Int(hContext,"fundsin_id",&iId)){
DEBUGLOG(("Authorize::TxnMgtByUsFIR return fundsin_id[%d]\n",iId));
					sprintf(csId,"%d",iId);
					PutField_CString(hTxn,"td_batch_id",csId);
				}
			}
			else{
				PutField_Int(hContext,"internal_error",iRet);
				PutField_Int(hNewContext,"internal_error",iRet);
			}

		}

		

                if (iRet == PD_OK) {
DEBUGLOG(("Authorize call DBTransaction:UpdateDetail\n"));
			PutField_CString(hTxn,"txn_seq",(const char*)csTmpTxnSeq);
                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                        iRet = (unsigned long)(*DBObjPtr)(hTxn);
                }

/* update txn header */
		if (iRet == PD_OK || GetField_Int(hNewContext,"internal_error",&iInternalErr)) {
			char* csBuf = (char*) malloc (128);
                	sprintf(csBuf,"%d",iInternalErr);
                	PutField_CString(hNewContext,"response_code",csBuf);
			PutField_Int(hNewContext,"internal_code",iInternalErr);
DEBUGLOG(("Result_Code = %s\n",csBuf));
                	FREE_ME(csBuf);

                        PutField_Char(hNewContext,"status",PD_COMPLETE);

			if (iInternalErr != 0 ) {
                       	 	PutField_Char(hNewContext,"ar_ind",PD_REJECT);
                	}
			else {
				PutField_Char(hNewContext,"ar_ind",PD_ACCEPT);
				PutField_CString(hNewContext,"sub_status",PD_APPROVED);
				PutField_CString(hContext,"sub_status",PD_APPROVED);
				PutField_CString(hNewContext,"approval_date",csPHPostingDate);
			}

			ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateTxnLog");
               		if((unsigned long)(*ChannelObjPtr)(hNewContext,hReq,hResponse)!= PD_OK){
DEBUGLOG(("Authorize::MGTChannel:UpdateTxnLog Failed\n"));
			}
		}


		hash_destroy(hReq);
        	FREE_ME(hReq);
		hash_destroy(hNewContext);
        	FREE_ME(hNewContext);
		hash_destroy(hTxn);
        	FREE_ME(hTxn);
        }

	if (iRet == PD_OK) {
		PutField_CString(hContext,"approval_date",csPHPostingDate);
	}

DEBUGLOG(("TxnMgtByUsOST Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
