/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/10/03              Virginia Yun
Not by batch					   2011/10/14		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsPOG.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"


#define PD_TR           "<tr>"
#define PD_TD           "<td>"
#define PD_BOLD         "<b>"
#define PD_TD_STYLE     "<td class=\"format\">"
#define PD_TR_END       "</tr>"
#define PD_TD_END       "</td>"
#define PD_BOLD_END     "</b>"



char cDebug;
OBJPTR(DB);
OBJPTR(BO);

int CreatePayoutFile(const char* csPid, hash_t* hContext);
int WritePayoutFile(const char* csPayOutFile, hash_t* hRec);

void TxnMgtByUsPOG(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;

        char    *csBatchId;
        char    *csMerchantId;
        char    *csTmp;
        char    *csPspId;
        char    *csFilePath;
        char    *csFile;
        char    *csFileId;
        char    *csTxnCcy;

        double  dTmp;
        double  dAmt;

        //char    cBatchMode;
        //int     iStatus;
        int     iSeqNum;
 
        long    lBatchId;
        long    lTmp=0l;

        int     i, iCnt, iMerch, iTxnCnt, iTmp, iResult;
        char    csTag[PD_TAG_LEN +1];

        hash_t  *hRec;
        recordset_t        *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("Authorize\n"));

        hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

        hash_t  *hHeader;
        hHeader = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hHeader,0);

        hash_t  *hDetail;
        hDetail = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hDetail,0);

        
        if(GetField_CString(hRequest,"merchant_id",&csMerchantId)){
DEBUGLOG(("Authorize::merchant_id= [%s]\n",csMerchantId));
		iMerch=PD_TRUE;
                PutField_CString(hTxn,"merchant_id",csMerchantId);
        }


        if(GetField_CString(hRequest,"add_user",&csTmp)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csTmp));
                PutField_CString(hTxn,"update_user",csTmp);
                PutField_CString(hDetail,"add_user",csTmp);
        }

	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBMerchantUploadFileDetail:GetExistingPsp\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetExistingPsp");
		iRet = (unsigned long)(*DBObjPtr)(hTxn,rRecordSet);

		if (iRet == PD_OK) {
			i = 0;
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec, "psp_id", &csPspId)) {
					sprintf(csTag, "psp_id_%d", i);
					PutField_CString(hContext,csTag,csPspId);
DEBUGLOG(("GetExistingPid::psp_id = [%s]\n",csPspId));


					if(CreatePayoutFile(csPspId,hContext)!=PD_OK){
						iRet=INT_ERR;
DEBUGLOG(("CreatePayoutFile Failed!!!!\n"));
					}
                                }
				i++;
				hRec = RecordSet_GetNext(rRecordSet);
				PutField_Int(hContext,"psp_count",i);
			}
		}
	}
        RecordSet_Destroy(rRecordSet);

        if(iRet==PD_OK){
                recordset_init(rRecordSet, 0);
DEBUGLOG(("Authorize::Call DBMerchantUploadFileDetail:GetPspAssignedTxn\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetPspAssignedTxn");
		iRet = (unsigned long)(*DBObjPtr)(hTxn,rRecordSet);
                if (iRet == PD_OK) {
                        i = 0;
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
                                if (GetField_CString(hRec, "psp_id", &csPspId)) {
					sprintf(csTag, "%s_file", csPspId);
					GetField_CString(hContext,csTag,&csFile);
					PutField_CString(hTxn,"generated_file_name",csFile);

					sprintf(csTag, "%s_file_id", csPspId);
					GetField_CString(hContext,csTag,&csFileId);
					PutField_CString(hDetail,"file_id",csFileId);

					sprintf(csTag, "%s_path", csPspId);
					GetField_CString(hContext,csTag,&csFilePath);
DEBUGLOG(("GetPspAssignedTxn::psp_id = [%s]\n",csPspId));
                                }              
                                if (GetField_CString(hRec, "batch_id", &csBatchId)) {
					sprintf(csTag, "batch_id_%d", i);
					PutField_CString(hTxn,csTag,csBatchId);
					PutField_CString(hDetail,"batch_id",csBatchId);
DEBUGLOG(("GetPspAssignedTxn::batch_id = [%s]\n",csBatchId));
                                }
                                if (GetField_Int(hRec, "seq_num", &iSeqNum)) {
					PutField_Int(hDetail,"seq_num",iSeqNum);
DEBUGLOG(("GetPspAssignedTxn::seq_num = [%d]\n",iSeqNum));
                                }
				if (GetField_CString(hRec,"txn_country", &csTmp)) {
					sprintf(csTag, "%s_txn_country", csPspId);
					PutField_CString(hTxn,csTag,csTmp);
					PutField_CString(hDetail,"txn_country",csTmp);
DEBUGLOG(("GetPspAssignedTxn::txn_country = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"request_ccy", &csTmp)) {
					PutField_CString(hDetail,"request_ccy",csTmp);
DEBUGLOG(("GetPspAssignedTxn::request_ccy = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"payout_ccy", &csTmp)) {
					if(strcmp(csTmp,"RMB"))
                                                csTxnCcy=strdup(csTmp);
                                        else
                                                csTxnCcy=strdup(PD_CCY_ISO_CNY);

					sprintf(csTag, "%s_payout_ccy", csPspId);
					PutField_CString(hTxn,csTag,csTxnCcy);
					PutField_CString(hDetail,"payout_ccy",csTmp);
					FREE_ME(csTxnCcy);
DEBUGLOG(("GetPspAssignedTxn::payout_ccy = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"account_name", &csTmp)) {
					PutField_CString(hDetail,"account_name",csTmp);
DEBUGLOG(("GetPspAssignedTxn::account_name = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"account_num", &csTmp)) {
					PutField_CString(hDetail,"account_num",csTmp);
DEBUGLOG(("GetPspAssignedTxn::account_num = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"bank_name", &csTmp)) {
					PutField_CString(hDetail,"bank_name",csTmp);
DEBUGLOG(("GetPspAssignedTxn::bank_name = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"branch", &csTmp)) {
					PutField_CString(hDetail,"branch",csTmp);
DEBUGLOG(("GetPspAssignedTxn::branch = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"identity_id", &csTmp)) {
					PutField_CString(hDetail,"identity_id",csTmp);
DEBUGLOG(("GetPspAssignedTxn::identity_id = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"phone_num", &csTmp)) {
					PutField_CString(hDetail,"phone_num",csTmp);
DEBUGLOG(("GetPspAssignedTxn::phone_num = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"merchant_ref", &csTmp)) {
					PutField_CString(hDetail,"merchant_ref",csTmp);
DEBUGLOG(("GetPspAssignedTxn::merchant_ref = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"remark", &csTmp)) {
DEBUGLOG(("GetPspAssignedTxn::remark = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"province", &csTmp)) {
					PutField_CString(hDetail,"province",csTmp);
DEBUGLOG(("GetPspAssignedTxn::province = [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"city", &csTmp)) {
					PutField_CString(hDetail,"city",csTmp);
DEBUGLOG(("GetPspAssignedTxn::city = [%s]\n",csTmp));
				}
				if (GetField_Double(hRec,"request_amount", &dTmp)) {
					PutField_Double(hDetail,"request_amount",dTmp);
DEBUGLOG(("GetPspAssignedTxn::request_amount = [%lf]\n",dTmp));
				}
				if (GetField_Double(hRec,"payout_amount", &dTmp)) {
					PutField_Double(hDetail,"payout_amount",dTmp);
DEBUGLOG(("GetPspAssignedTxn::payout_amount = [%lf]\n",dTmp));

					sprintf(csTag,"org_dst_net_amt_%s",csPspId);
					if(GetField_Double(hContext,csTag,&dAmt)){
						dAmt += dTmp;
					}
					else{
						dAmt = dTmp;
					}
					PutField_Double(hContext,csTag,dAmt);

					sprintf(csTag,"%s_txn_amt",csPspId);
					if(GetField_Double(hContext,csTag,&dAmt)){
						dAmt += dTmp;
					}
					else{
						dAmt = dTmp;
					}
					PutField_Double(hContext,csTag,dAmt);
				}
				
				if (GetField_CString(hRec,"merchant_fee_ccy", &csTmp)) {
					sprintf(csTag,"%s_merchant_fee_ccy",csPspId);
					PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::merchant_fee_ccy = [%s]\n",csTmp));
				}

				if (GetField_Double(hRec,"merchant_fee", &dTmp)) {
					sprintf(csTag,"%s_merchant_fee",csPspId);
					if(GetField_Double(hContext,csTag,&dAmt)){
                                                dAmt += dTmp;
                                        }
                                        else{
                                                dAmt = dTmp;
                                        }
                                        PutField_Double(hContext,csTag,dAmt);
DEBUGLOG(("GetPspAssignedTxn::merchant_fee = [%lf]\n",dTmp));
				}

				if (GetField_CString(hRec,"member_fee_ccy", &csTmp)) {
					sprintf(csTag,"%s_member_fee_ccy",csPspId);
					PutField_CString(hContext,csTag,csTmp);
DEBUGLOG(("GetPspAssignedTxn::member_fee_ccy = [%s]\n",csTmp));
				}

				if (GetField_Double(hRec,"markup_amt", &dTmp)) {
DEBUGLOG(("GetPspAssignedTxn::markup_amt = [%lf]\n",dTmp));
				}

				if (GetField_Double(hRec,"member_fee", &dTmp)) {
					sprintf(csTag,"%s_member_fee",csPspId);
					if(GetField_Double(hContext,csTag,&dAmt)){
                                                dAmt += dTmp;
                                        }
                                        else{
                                                dAmt = dTmp;
                                        }
                                        PutField_Double(hContext,csTag,dAmt);
DEBUGLOG(("GetPspAssignedTxn::member_fee = [%lf]\n",dTmp));
				}

				iTxnCnt = 0;
				sprintf(csTag,"%s_txn_cnt",csPspId);
				GetField_Int(hContext,csTag,&iTxnCnt);
				PutField_Int(hContext,csTag,iTxnCnt+1);

				if(WritePayoutFile(csFilePath,hRec)!=PD_OK){
					iRet = INT_ERR;
DEBUGLOG(("GetpspAssignedTxn:: WritePayoutFile Error!!!\n"));
ERRLOG("TxnMgtByUsPOG::GetpspAssignedTxn:: WritePayoutFile Error!!!\n");
				}
				else{
					PutField_Int(hTxn, "status", PAYOUT_MASTER_TRANSACTION_GENERATED);

DEBUGLOG(("Authorize::Call DBMerchantUploadFileDetail:UpdateDetailByBatchId\n"));
					DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","UpdateDetailByBatchId");
					if ((unsigned long)(*DBObjPtr)(csBatchId,iSeqNum,hTxn) != PD_OK) {
						iRet = INT_ERR;
DEBUGLOG(("Authorize::DBMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
					}

DEBUGLOG(("Authorize::Call DBPayoutGeneratedFileDT:Add\n"));
					DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileDT","Add");
					if ((unsigned long)(*DBObjPtr)(hDetail) != PD_OK) {
						iRet = INT_ERR;
DEBUGLOG(("Authorize::DBPayoutGeneratedFileDT:Add Failed\n"));
					}
				}
				
                                i++;
                                hRec = RecordSet_GetNext(rRecordSet);
                        } 
                        PutField_Int(hContext,"total_count",i);
DEBUGLOG(("GetPspAssignedTxn::total_count= [%d]\n",i));
                }
                else{
DEBUGLOG(("GetpspAssignedTxn::Failed!!!!\n"));
ERRLOG("TxnMgtByUsPOG:Authorize::GetPspAssignedTxn::Failed!!\n");
                        iRet=INT_NOT_RECORD;
                }
        }
        RecordSet_Destroy(rRecordSet);

	if(iRet==PD_OK){
		GetField_Int(hContext,"psp_count",&iCnt);
		for(i=0; i<iCnt; i++){
			sprintf(csTag,"psp_id_%d",i);
			if(GetField_CString(hContext,csTag,&csPspId)){
				sprintf(csTag, "%s_file_id", csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"file_id",csTmp);
				}

				sprintf(csTag, "%s_txn_cnt", csPspId);
				if(GetField_Int(hContext,csTag,&iTmp)){
					PutField_Int(hHeader,"txn_cnt",iTmp);
				}

				sprintf(csTag, "%s_txn_amt", csPspId);
				if(GetField_Double(hContext,csTag,&dTmp)){
					PutField_Double(hHeader,"txn_amt",dTmp);
				}

				sprintf(csTag, "%s_merchant_fee_ccy", csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"merchant_fee_ccy",csTmp);
				}

				sprintf(csTag, "%s_member_fee_ccy", csPspId);
				if(GetField_CString(hContext,csTag,&csTmp)){
					PutField_CString(hHeader,"member_fee_ccy",csTmp);
				}

				sprintf(csTag, "%s_merchant_fee", csPspId);
				if(GetField_Double(hContext,csTag,&dTmp)){
					PutField_Double(hHeader,"merchant_fee",dTmp);
				}

				sprintf(csTag, "%s_member_fee", csPspId);
				if(GetField_Double(hContext,csTag,&dTmp)){
					PutField_Double(hHeader,"member_fee",dTmp);
				}

				sprintf(csTag, "%s_path", csPspId);
				GetField_CString(hContext,csTag,&csFilePath);

				PutField_Int(hContext,"end_file",PD_TRUE);
				if(WritePayoutFile(csFilePath,hContext)!=PD_OK){
DEBUGLOG(("Authorize::WritePayoutFile Error!!![%s]\n",csTmp));
				}

				sprintf(csTag, "%s_txn_country", csPspId);
				GetField_CString(hTxn,csTag,&csTmp);
				PutField_CString(hContext,"org_txn_country",csTmp);

				sprintf(csTag, "%s_payout_ccy", csPspId);
				GetField_CString(hTxn,csTag,&csTmp);
				PutField_CString(hContext,"org_psp_txn_ccy",csTmp);

				sprintf(csTag,"org_dst_net_amt_%s",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					PutField_CString(hContext,"org_psp_id",csPspId);
					PutField_Double(hContext,"org_dst_net_amt",dAmt);
					PutField_Char(hContext,"response_mode",PD_ACCEPT);
					PutField_Char(hContext,"party_type",PD_TYPE_PSP);
					
					BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
					if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("Authorize::BOBalance:UpdatePayoutAmount Failed[%s][%lf]!!!\n",csTmp,dAmt));
ERRLOG("Authorize::BOBalance:UpdatePayoutAmount Failed!!!\n");
						iRet = INT_ERR;
					}
				}

				PutField_Int(hHeader,"status",PD_PAYOUTFILE_GENERATED);

				DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Update");
				if((unsigned long)(*DBObjPtr)(hHeader)!=PD_OK){
DEBUGLOG(("Authorize::PayoutGeneratedFileHD::Add Error!!!\n"));
					iRet = INT_ERR;
				}

			}
		}
	}
/*
	if(iRet==PD_OK){
		GetField_Int(hContext,"psp_count",&iCnt);
		for(i=0; i<iCnt; i++){
			sprintf(csTag,"psp_id_%d",i);
			if(GetField_CString(hContext,csTag,&csPspId)){
				
				sprintf(csTag, "%s_txn_country", csPspId);
				GetField_CString(hTxn,csTag,&csTmp);
				PutField_CString(hContext,"org_txn_country",csTmp);

				sprintf(csTag, "%s_payout_ccy", csPspId);
				GetField_CString(hTxn,csTag,&csTmp);
				PutField_CString(hContext,"org_psp_txn_ccy",csTmp);

				sprintf(csTag,"org_dst_net_amt_%s",csPspId);
				if(GetField_Double(hContext,csTag,&dAmt)){
					PutField_CString(hContext,"org_psp_id",csPspId);
					PutField_Double(hContext,"org_dst_net_amt",dAmt);
					PutField_Char(hContext,"response_mode",PD_ACCEPT);
					PutField_Char(hContext,"party_type",PD_TYPE_PSP);
					
					BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
					if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("Authorize::BOBalance:UpdatePayoutAmount Failed[%s][%lf]!!!\n",csTmp,dAmt));
ERRLOG("Authorize::BOBalance:UpdatePayoutAmount Failed!!!\n");
						iRet = INT_ERR;
					}
				}
			}
		}
	}
*/
	if(iRet==PD_OK){
		iCnt=0;
		if(GetField_Int(hContext,"total_count",&iCnt)){
DEBUGLOG(("Authorize::total_count= [%d]\n",iCnt));
		}
		for(i=0; i<iCnt; i++){
			sprintf(csTag, "batch_id_%d", i);
			GetField_CString(hTxn,csTag,&csBatchId);
			PutField_CString(hTxn,"batch_id",csBatchId);
			lBatchId = ctol((const unsigned char *)csBatchId,strlen(csBatchId));
			if (lTmp==lBatchId)
				continue;

			lTmp = lBatchId;

			DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","MatchCount");
			iResult = (unsigned long) ((*DBObjPtr)(lBatchId,PAYOUT_MASTER_TRANSACTION_GENERATED));
			if(iResult!=PD_ERR && iResult!=PD_NOT_FOUND){
				if(iResult==PD_TRUE)
                			PutField_Int(hTxn, "status", PD_PAYOUTFILE_GENERATED);
				else if (iResult==PD_FALSE)
                			PutField_Int(hTxn, "status", PD_PAYOUTFILE_PARTIAL_GENERATED);
			
DEBUGLOG(("Authorize::DBMerchantUploadFileHeader:UpdateHeader\n"));
                		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","UpdateHeader");
                		if((unsigned long) ((*DBObjPtr)(hTxn))!=PD_OK){
                        		iRet = INT_ERR;
DEBUGLOG(("Authorize::DBMerchantUploadFileHeader:UpdateHeader Failed\n"));
                		}
			}
		}
	}


        if(iRet!=PD_OK){
                PutField_Int(hContext,"internal_error",iRet);
        }

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
        FREE_ME(hTxn);
        FREE_ME(hDetail);
        FREE_ME(hHeader);


DEBUGLOG(("TxnMgtByUsPOG Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}


int CreatePayoutFile(const char* csPspId, hash_t* hContext)
{
	int iRet = PD_OK;

        FILE    *fp;
        //char    csDateTime[PD_DATETIME_LEN + 1];
        char*    csDate;
        char    csPayOutFile[PD_MAX_FILE_LEN + 1];
        char    csPayOutFilePath[PD_MAX_FILE_LEN + 1];
        char    csPayOutFileName[PD_FILENAME_LEN + 1];
	char    csTag[PD_TAG_LEN +1];
        char    csFileId[PD_TXN_SEQ_LEN + 1];
	unsigned long lFileId=0l;
	int	iSeqNum=0;

	//memset(csDate, 0, sizeof(csDate));
	//memset(csDateTime, 0, sizeof(csDateTime));
	memset(csPayOutFilePath, 0, sizeof(csPayOutFilePath));
	memset(csPayOutFileName, 0, sizeof(csPayOutFileName));
	memset(csFileId, 0, sizeof(csFileId));

	//strcpy(csDateTime, getdatetime());
	//strncpy(csDate, csDateTime, PD_DATE_LEN);

 	if(GetField_CString(hContext,"PHDATE",&csDate)){                                           
		PutField_CString(hContext,"file_date",csDate);
		PutField_CString(hContext,"file_pid",csPspId);
DEBUGLOG(("Authorize::File Date[%s], PID[%s]\n", csDate,csPspId));
	}

DEBUGLOG(("Authorize::DBPayoutGeneratedFileHD:GetNextSeq\n"));
	DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetNextSeq");
	if((unsigned long) ((*DBObjPtr)(csDate,csPspId,&iSeqNum))!=PD_OK){
		iRet = INT_ERR;
DEBUGLOG(("Authorize::DBPayoutGeneratedFileHD:GetNextSeq Failed\n"));
	}
	else{
		sprintf(csPayOutFilePath, "%s/%s", getenv("REPORT_DATA"),"payout_files");
		sprintf(csPayOutFileName, "%s_%s%02d.xls", csPspId, csDate,iSeqNum);
	
		sprintf(csTag,"%s_seq_num",csPspId);
		PutField_Int(hContext,csTag,iSeqNum);
		PutField_Int(hContext,"seq_num",iSeqNum);

		sprintf(csTag,"%s_file",csPspId);
		PutField_CString(hContext,csTag,csPayOutFileName);
		PutField_CString(hContext,"filename",csPayOutFileName);

		sprintf(csPayOutFile, "%s/%s", csPayOutFilePath, csPayOutFileName);
		sprintf(csTag,"%s_path",csPspId);
		PutField_CString(hContext,csTag,csPayOutFile);
	}

	if(iRet==PD_OK){
DEBUGLOG(("Authorize::DBPayoutGeneratedFileHD:GetNextFileId\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","GetNextFileId");
		if((unsigned long) ((*DBObjPtr)(&lFileId))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("Authorize::DBPayoutGeneratedFileHD:GetNextFileId Failed\n"));
		}
		else{
			sprintf(csFileId,"%ld",lFileId);
			sprintf(csTag,"%s_file_id",csPspId);
			PutField_CString(hContext,csTag,csFileId);
			PutField_CString(hContext,"file_id",csFileId);
		}
	}
	

	if(iRet==PD_OK) {
DEBUGLOG(("Authorize::Open PayoutFile [%s] for psp id [%s]\n", csPayOutFile, csPspId));
		fp = fopen(csPayOutFile, "w");
		if (fp == NULL) {
DEBUGLOG(("Authorize::Open Payoutfile [%s] problem\n", csPayOutFile));
ERRLOG("TxnMgtByUsPOG:Authorize::Open Payoutfile problem!!\n");
			iRet=INT_ERR;
		}
	}

	if(iRet==PD_OK) {
		fprintf(fp, "<html><body><table>\n");  
		fprintf(fp, "%s%s%s%s Payout Records%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s\n",
				PD_TR, PD_TD, PD_BOLD, csPspId, PD_BOLD_END, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TD, PD_TD_END,
				PD_TR_END);


		fprintf(fp, "<style type=\"text/css\"> .format{ mso-number-format:'\\@';} </style>\n");


		fprintf(fp, "%s%sPayout Trans No.%s%sReceiver Name%s%sID Card No.%s%sMobile No.%s%sBank%s%sBranch%s%sBank Account%s%sAmount%s%sProvince%s%sCity%s%sRemarks%s%s\n", PD_TR, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TD, PD_TD_END, PD_TR_END);


		fclose(fp);
	}

	if(iRet==PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBPayoutGeneratedFileHD","Add");
		if((unsigned long)(*DBObjPtr)(hContext)!=PD_OK){
DEBUGLOG(("Authorize::PayoutGeneratedFileHD::Add Error!!!\n"));
			iRet = INT_ERR;
		}
		
	}
	
	return iRet;
}


int WritePayoutFile(const char* csPayOutFile, hash_t* hRec)
{
	int	iRet=PD_OK;
	int	iTmp;
	char*	csTmp;
	double	dTmp;

        FILE    *fp;
	fp = fopen(csPayOutFile, "a");
	if (fp == NULL) {
DEBUGLOG(("Authorize::Open Payoutfile [%s] problem\n", csPayOutFile));
ERRLOG("TxnMgtByUsPOG:Authorize::Open Payoutfile problem!!\n");
		iRet=INT_ERR;
	}

	if(iRet==PD_OK) {
		if(GetField_Int(hRec,"end_file",&iTmp)){
			if(iTmp==PD_TRUE){
				fprintf(fp, "</table></body></html>\n");  
				fclose(fp);
				return iRet;
			}
		}
	}

	if(iRet==PD_OK) {
		fprintf(fp, "%s", PD_TR);

		if (!GetField_CString(hRec, "merchant_ref", &csTmp)) {
			csTmp = strdup(""); 
		}
DEBUGLOG(("Authorize::GetDetail:merchant_ref [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "account_name", &csTmp)) {
			csTmp = strdup(""); 
		}
DEBUGLOG(("Authorize::GetDetail:account_name [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "identity_id", &csTmp)) {
			csTmp = strdup("0000000"); 
		}
DEBUGLOG(("Authorize::GetDetail:identity_id [%s]\n", csTmp));
		fprintf(fp, "%s[%s]%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "phone_num", &csTmp)) {
			csTmp = strdup("0000000"); 
		}
DEBUGLOG(("Authorize::GetDetail:phone_num [%s]\n", csTmp));
		fprintf(fp, "%s[%s]%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "bank_name", &csTmp)) {
			csTmp = strdup(""); 
		}
DEBUGLOG(("Authorize::GetDetail:bank_name [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "branch", &csTmp)) {
			csTmp = strdup(""); 
		}
DEBUGLOG(("Authorize::GetDetail:branch [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "account_num", &csTmp)) {
			csTmp = strdup(""); 
		}
DEBUGLOG(("Authorize::GetDetail:account_num [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD_STYLE,csTmp,PD_TD_END);

		if (!GetField_Double(hRec, "payout_amount", &dTmp)) {
			dTmp = 0.0;
		}
DEBUGLOG(("Authorize::GetDetail:payout_amount [%f]\n", dTmp));
		fprintf(fp, "%s%f%s",PD_TD,dTmp,PD_TD_END);

		if (!GetField_CString(hRec, "province", &csTmp)) {
			csTmp = strdup(""); 
		}
DEBUGLOG(("Authorize::GetDetail:province [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "city", &csTmp)) {
			csTmp = strdup(""); 
		}
DEBUGLOG(("Authorize::GetDetail:city [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		if (!GetField_CString(hRec, "remark", &csTmp)) {
			csTmp = strdup(""); 
		}
DEBUGLOG(("Authorize::GetDetail:remark [%s]\n", csTmp));
		fprintf(fp, "%s%s%s",PD_TD,csTmp,PD_TD_END);

		fprintf(fp, "%s\n", PD_TR_END);
		
	}

	FREE_ME(csTmp);
	fclose(fp);
	return iRet;
}
