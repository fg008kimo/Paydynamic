/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/11/13              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMinByUsPST.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMinByUsPST(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
		  hash_t* hRequest,
		  hash_t* hResponse)
{
        int	iRet = PD_OK;
        int	iDtlRet = PD_FOUND;

	int	iSeq = 1;
        int     iTmp = 0;

	double  dTmp = 0.0;

	char  	*csTxnId = NULL;
	char  	*csCostTxnId = NULL;
	char    *csEntityId = NULL;
        char    *csEntityType = NULL;
        char    *csRspId = NULL;
        char	*csStatus = NULL;
	char	*csApprovalDate = NULL;
        char	*csApprovalTimestamp = NULL;	
	char  	*csUser = NULL;
        char	*csTmp = NULL;
	
	char  	*csPspId = (char*) malloc (PD_PSP_ID_LEN);

	char    csRspTxnId[PD_TXN_SEQ_LEN + 1];
	char    csBatchId[PD_TXN_SEQ_LEN + 1];
	char    csTxnDateTime[PD_DATETIME_LEN + 1];

	hash_t  *hData = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hData,0);

	hash_t *hTxnHeader = (hash_t*) malloc (sizeof(hash_t));
      	hash_init(hTxnHeader, 0);

	hash_t *hTxnDetail = (hash_t*) malloc (sizeof(hash_t));
      	hash_init(hTxnDetail, 0);

	hash_t *hBatchRec = (hash_t*) malloc (sizeof(hash_t));
      	hash_init(hBatchRec, 0);

DEBUGLOG(("Authorize::TxnMinByUsPST Begin\n"));

/* txn_seq */
	if (GetField_CString(hContext,"txn_seq",&csTxnId)) {
DEBUGLOG(("Authorize::txn_id = [%s]\n",csTxnId));		
        } else {
DEBUGLOG(("Authorize::txn_id not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::txn_id not found!!\n");
                iRet = INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* cost_txn_seq */
        if (GetField_CString(hContext,"cost_txn_seq",&csTmp)) {
DEBUGLOG(("Authorize::cost_txn_id = [%s]\n",csTmp));
		PutField_CString(hData, "cost_txn_seq", csTmp);		
        }

/* psp_id */
	if (GetField_CString(hContext,"psp_id",&csPspId)) {
DEBUGLOG(("Authorize::psp_id = [%s]\n",csPspId));
        } else {
DEBUGLOG(("Authorize::psp_id not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::psp_id not found!!\n");
                iRet=INT_PSP_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_country */
	if (GetField_CString(hContext,"txn_country",&csTmp)) {
DEBUGLOG(("Authorize::txn_country = [%s]\n",csTmp));
		PutField_CString(hData, "txn_country", csTmp);
		PutField_CString(hData, "country", csTmp);
        } else {
DEBUGLOG(("Authorize::txn_country not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::txn_country not found!!\n");
            	iRet=INT_TXN_COUNTRY_NOT_FOUND;
              	PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_ccy */
        if (GetField_CString(hContext,"txn_ccy",&csTmp)) {
DEBUGLOG(("Authorize::txn_ccy = [%s]\n",csTmp));
		PutField_CString(hData, "txn_ccy", csTmp);
		PutField_CString(hData, "ccy", csTmp);
		PutField_CString(hData,"net_ccy",csTmp);
                PutField_CString(hData, "org_txn_ccy", csTmp);
                PutField_CString(hData, "entity_ccy", csTmp);
        } else {
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_amt */
	if (GetField_Double(hContext,"txn_amt",&dTmp)) {
DEBUGLOG(("Authorize::txn_amt = [%f]\n",dTmp));
		PutField_Double(hData, "txn_amt", dTmp);
		PutField_Double(hData, "net_amt", dTmp);
		PutField_Double(hData,"display_amt",dTmp);
        	PutField_Double(hData,"org_txn_amt",dTmp);
        	PutField_Double(hData,"org_dst_net_amt",dTmp);
        	PutField_Double(hData,"entity_txn_amount",dTmp);
        } else {
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* report_date */
	if (GetField_CString(hContext,"report_date",&csTmp)) {
DEBUGLOG(("Authorize::report_date = [%s]\n", csTmp));
		PutField_CString(hData, "report_date", csTmp);
		PutField_CString(hData, "txn_date", csTmp);
        } else {
DEBUGLOG(("Authorize::report_date not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::report_date not found!!\n");
                iRet=INT_PHDATE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* remark */
	if (GetField_CString(hContext,"mi_remark",&csTmp)){
DEBUGLOG(("Authorize::remark = [%s]\n",csTmp));
		PutField_CString(hData, "remark", csTmp);
        }

/* entity_id */
      	if (GetField_CString(hContext,"entity_id",&csEntityId)) {
DEBUGLOG(("Authorize::entity_id = [%s]\n",csEntityId));
		PutField_CString(hData, "entity_id", csEntityId);
       	} else {
DEBUGLOG(("Authorize::entity_id not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::entity_id not found!!\n");
             	iRet = INT_MI_ENTITY_ID_NOT_FOUND;
            	PutField_Int(hContext,"internal_error",iRet);
  	}

/* entity_type */
      	if (GetField_CString(hContext,"entity_type",&csEntityType)) {
DEBUGLOG(("Authorize::entity_type = [%s]\n",csEntityType));
		PutField_CString(hData,"entity_type",csEntityType);
		PutField_CString(hData,"party_type",csEntityType);
     	} else {
DEBUGLOG(("Authorize::entity_type not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::entity_type not found!!\n");
             	iRet = INT_MI_ENTITY_TYPE_NOT_FOUND;
             	PutField_Int(hContext,"internal_error",iRet);
    	}

/* rsp_id */
     	if (GetField_CString(hContext,"rsp_id",&csRspId)) {
DEBUGLOG(("Authorize::rsp_id = [%s]\n",csRspId));
		PutField_CString(hData,"party_id",csRspId);
    	} else {
DEBUGLOG(("Authorize::rsp_id not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::rso_id not found!!\n");
              	iRet = INT_MI_RSP_ID_NOT_FOUND;
              	PutField_Int(hContext,"internal_error",iRet);
    	}

/* mini_txn_type */
	if (GetField_CString(hContext,"mini_txn_type",&csTmp)) {
DEBUGLOG(("Authorize::mini_txn_type = [%s]\n",csTmp));	
		PutField_CString(hData,"mini_txn_type",csTmp);
	}

/* add_user */
        if (GetField_CString(hContext,"add_user",&csUser)) {
DEBUGLOG(("Authorize::add_user = [%s]\n",csUser));
		PutField_CString(hData,"add_user",csUser);
		PutField_CString(hData,"update_user",csUser);
		PutField_CString(hBatchRec,"add_user",csUser);
		PutField_CString(hBatchRec,"update_user",csUser);
        }

/* update_user */
        if (GetField_CString(hContext,"update_user",&csTmp)) {
DEBUGLOG(("Authorize::update_user = [%s]\n",csTmp));
	}

	// Generate RSP Txn Id 
	if (iRet == PD_OK) {	

		// Generate Next Txn Seq
DEBUGLOG(("Authorize::Call TxnSeq: GetNextMgtTxnSeq\n"));
                DBObjPtr = CreateObj(DBPtr, "DBTxnSeq", "GetNextMgtTxnSeq");
                strcpy((char*)csRspTxnId, (*DBObjPtr)());

                PutField_CString(hData,"txn_seq",csRspTxnId);
DEBUGLOG(("Authorize::Call TxnSeq: GetNextMgtTxnSeq:: rsp_txn_seq = [%s]\n", csRspTxnId));

		PutField_Int(hData, "db_commit", PD_FALSE);
	}

	// Add and Update Txn Header
	if (iRet == PD_OK) {

/* channel_code */
		PutField_CString(hData, "channel_code", PD_CHANNEL_MGT);

/* status */
		PutField_Char(hData,"status",PD_PROCESSING);

/* txn_code */		
		PutField_CString(hData, "txn_code", PD_MI_TXN_CODE_RSP_IN_TRANSIT);

/* process_type, process_code */
		PutField_CString(hData,"process_code", PD_PROCESS_CODE_DEF);
                PutField_CString(hData,"process_type", PD_PROCESS_TYPE_DEF);

/* response_code */
		PutField_CString(hData, "response_code", "0");

/* internal_code */
		PutField_Int(hData, "internal_code", 0);

/* host_posting_date */
		if (GetField_CString(hContext, "PHDATE", &csTmp)) {
                        PutField_CString(hData, "host_posting_date", csTmp);
                }
		
/* transmission_datetime */
		if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
                        PutField_CString(hData, "local_tm_date", csTmp);
                        PutField_CString(hData, "tm_date", csTmp);

                        strcpy(csTxnDateTime, csTmp);
                        PutField_CString(hData, "transmission_datetime", csTxnDateTime);

                        if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
                                PutField_CString(hData, "local_tm_time", csTmp);
                                strcat(csTxnDateTime, csTmp);
                                PutField_CString(hData, "transmission_datetime", csTxnDateTime);
                        }
                }

/* ex_supplier */
                PutField_Char(hData,"ex_supplier",PD_INT_EX);

/* ex_rate */
                PutField_Double(hData,"ex_rate",1);

/* do_logging */
                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("Authorize::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else { 

				// Add TxnHeader
                                if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:: Add\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","Add");
                                        iRet = (unsigned long)(*DBObjPtr)(hData);
                                        if (iRet != PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }

                                // Update TxnHeader
                                if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:: Update\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                                        iRet = (unsigned long)(*DBObjPtr)(hData);
                                        if (iRet != PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:: Update Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }	
			}
		}
	}

	// Add and Update Txn Detail
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("Authorize::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add TxnDetail
                                if (iRet == PD_OK) {

DEBUGLOG(("Authorize::Call DBTransaction:: AddDetail\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                                        iRet = (unsigned long)(*DBObjPtr)(hData);
                                        if (iRet != PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }

                                // Update TxnDetail
                                if (iRet == PD_OK) {

/* txn_seq */
                                        PutField_CString(hTxnDetail, "txn_seq", csRspTxnId);

/* update_user */
                                       	PutField_CString(hTxnDetail, "update_user", csUser);

DEBUGLOG(("Authorize::Call DBTransaction:: Update\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnDetail);
                                        if (iRet != PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:: Update Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
        }
	
	// Update Entity Balance
        if (iRet == PD_OK) {
	
		// Check Entity Balance Acct Exist
DEBUGLOG(("Authorize::Call DBMiEntityBalAcct:: GetEntityBalAcct\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMiEntityBalAcct", "GetEntityBalAcct");
                iDtlRet = (unsigned long)(*DBObjPtr)(hData,hData);
                if (iDtlRet == PD_FOUND) {

/* status */
                        if (GetField_CString(hData, "status", &csStatus)) {
DEBUGLOG(("Authorize::Call DBMiEntityBalAcct:: status = [%s]\n", csStatus));

                                // Check Entity Bal Acct Status
                                if (!strcmp(csStatus, PD_MI_ENTITY_BAL_ACCT_STATUS_CLOSE)) {
DEBUGLOG(("Authorize::Call DBMiEntityBalAcct:: GetEntityBalAcct Disabled\n"));
ERRLOG("TxnMinByUsPST::Authorize::Call DBMiEntityBalAcct:: GetEntityBalAcct Disabled\n");
                                        iRet = INT_MMS_ENTITY_BAL_ACCT_DISABLED;
                                }
                        }

                } else {
DEBUGLOG(("Authorize::Call DBMiEntityBalAcct:: GetEntityBalAcct Not Found\n"));
ERRLOG("TxnMinByUsPST::Authorize::Call DBMiEntityBalAcct:: GetEntityBalAcct Not Found\n");
                        iRet = INT_MMS_ENTITY_BAL_ACCT_NOT_FOUND;
                }

		if (iRet == PD_OK) {

			// batch_mode
			PutField_Char(hData, "batch_mode", PD_ONLINE);
DEBUGLOG(("Authorize::batch_mode = [%c]\n",PD_ONLINE));

			// amt_type
			PutField_CString(hData, "amt_type", PD_CR);
DEBUGLOG(("Authorize::amt_type = [%s]\n",PD_CR));

			// bal_type
			PutField_Char(hData, "bal_type", PD_MI_ENTITY_POOL_INTRANSIT);
DEBUGLOG(("Authorize::bal_type = [%c]\n",PD_MI_ENTITY_POOL_INTRANSIT));

			// UpdateEntityBalance
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: UpdateEntityBalance\n"));
             		BOObjPtr = CreateObj(BOPtr, "BOMiEntityBalance", "UpdateEntityBalance");
              		iRet = (unsigned long)(*BOObjPtr)(hData,hData);
			if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: UpdateEntityBalance Success\n"));

                    		if (GetField_CString(hData, "approval_date", &csApprovalDate)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: approval_date [%s]\n", csApprovalDate));
                      		}

                      		if (GetField_CString(hData, "approval_timestamp", &csApprovalTimestamp))  {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: approval_timestamp [%s]\n", csApprovalTimestamp));
                    		}

                     		// Open Balance
                      		if (GetField_Double(hData, "open_acct_bal", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: open_acct_bal = [%f]\n", dTmp));
                     		}

                       		if (GetField_Double(hData, "open_intransit", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: open_intransit = [%f]\n", dTmp));
                    		}

                       		if (GetField_Double(hData, "open_ar_bal", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: open_ar_bal = [%f]\n", dTmp));
                     		}

                     		// Close Balance
                     		if (GetField_Double(hData, "acct_bal", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: closing acct_bal = [%f]\n", dTmp));
                      		}

                      		if (GetField_Double(hData, "intransit", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: closing intransit = [%f]\n", dTmp));
                   		}

                    		if (GetField_Double(hData, "ar_bal", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: closing ar_bal = [%f]\n", dTmp));
                      		}

          		} else {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n"));
ERRLOG("TxnMinByUsPST::Authorize::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n");
                	     	iRet = INT_ERR;
               		}
       		}
	}

	// Add Txn Mi Detail
	if (iRet == PD_OK) {

/* actual_cost */
                PutField_Double(hData,"actual_cost",0.0);

/* acr_prorata */
  		PutField_Int(hData,"acr_prorata",PD_FALSE);

/* psp_id */
		PutField_CString(hData,"psp_id",csPspId);

/* business_type */
		PutField_Char(hData,"business_type",PD_BUSINESS_TYPE_GAMING);

		// Get PSP Product Code
DEBUGLOG(("Authorize::Call CrrPspProductCodeMap:: GetPSPProductCode\n"));
                DBObjPtr = CreateObj(DBPtr, "DBCrrPspProductCodeMap", "GetPSPProductCode");
                iRet = (unsigned long)(*DBObjPtr)(hData,hData);
                if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call CrrPspProductCodeMap:: GetPSPProductCode Success\n"));
		
/* product_code */
			if (GetField_CString(hData, "product_code", &csTmp)) {
DEBUGLOG(("Authorize::Call CrrPspProductCodeMap:: GetPSPProductCode:: product_code = [%s]\n", csTmp));
				PutField_CString(hData,"txn_product",csTmp);
                        } else {
DEBUGLOG(("Authorize::Call CrrPspProductCodeMap:: GetPSPProductCode product_code not found\n"));
ERRLOG("TxnMinByUsPST::Authorize::Call CrrPspProductCodeMap:: GetPSPProductCode product_code not found\n");
                        	iRet = INT_ERR;
			}

		} else {
DEBUGLOG(("Authorize::Call CrrPspProductCodeMap:: GetPSPProductCode Failed\n"));
ERRLOG("TxnMinByUsPST::Authorize::Call CrrPspProductCodeMap:: GetPSPProductCode Failed\n");
                        iRet = INT_ERR;
		}
	
/* do_logging */
		if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("Authorize::do_logging [%d]\n", iTmp));

                	if (iTmp != PD_ADD_LOG) {
                        	/* nothing */
                	} else {
				
				// Add TxnMiDetail
				if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBTxnMiDetail:: Add\n"));
                                	DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Add");
                                	iRet = (unsigned long)(*DBObjPtr)(hData);
					if (iRet != PD_OK) {
DEBUGLOG(("Authorize::Call DBTxnMiDetail:: Add Failed\n"));
						iRet = INT_ERR;
					}
				}
                        }
                }
	}

	// Add Mi Txn Log
	if (iRet == PD_OK) {

                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("Authorize::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add MiTxnLog (RSP Txn)
                                if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:: AddMiTxnLog (RSP Txn)\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddMiTxnLog");
                                        iRet = (unsigned long)(*DBObjPtr)(csRspTxnId);
                                        if (iRet != PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:: AddMiTxnLog (RSP Txn) Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }

				// Add MiTxnLog (RSP Cost Txn)
				if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:: AddMiTxnLog (RSP Cost Txn)\n"));
					if (GetField_CString(hData,"cost_txn_seq",&csCostTxnId)) {
						DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddMiTxnLog");
                                        	iRet = (unsigned long)(*DBObjPtr)(csCostTxnId);
                                        	if (iRet != PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:: AddMiTxnLog (RSP Cost Txn) Failed\n"));
                                        	        iRet = INT_ERR;
                                        	}
					}
				}
                        }
                }
	}

	// Handle Batch Info
	if (iRet == PD_OK) {
		
		// Generate Batch Id
DEBUGLOG(("Authorize::Call TxnSeq:: GetNextMiActionBatchSeq\n"));
		DBObjPtr = CreateObj(DBPtr, "DBTxnSeq", "GetNextMiActionBatchSeq");
             	strcpy(csBatchId, (*DBObjPtr)());
DEBUGLOG(("Authorize::Call TxnSeq:: GetNextMiActionBatchSeq: [%s]\n",csBatchId));

		// Add Batch Header
		if (iRet == PD_OK) {
	
			// batch_id
			PutField_CString(hBatchRec,"batch_id",csBatchId);

			// process_type
                	PutField_CString(hBatchRec,"process_type",PD_MI_TXN_TYPE_PSP_SETTLE);
	
			// status
                	PutField_Char(hBatchRec,"status",PD_MI_BATCH_STATUS_NORMAL);

DEBUGLOG(("Authorize::Call MiBatchHeader:: Add\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBMiBatchHeader", "Add");
                	iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
                	if (iRet != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize::Call MiBatchHeader:: Add Failed\n"));  
			}
		}
	
		// Add Batch Detail
		if (iRet == PD_OK) {	

			// batch_id
                        PutField_CString(hBatchRec,"batch_id",csBatchId);

			// txn_oper_ind
			PutField_Char(hBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_INSERT);			

			// RSP
			if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: Add Batch Detail:RSP \n"));
		
				// entity_id
				PutField_CString(hBatchRec,"entity_id",csEntityId);

				// party_type
                		PutField_CString(hBatchRec,"party_type",PD_MI_ENTITY_RSP);
	
				// party_id 
                		PutField_CString(hBatchRec,"party_id",csRspId);	

				// txn_id
				PutField_CString(hBatchRec,"txn_id",csRspTxnId);

				// seq
                		PutField_Int(hBatchRec,"seq",iSeq++);

DEBUGLOG(("Authorize::Call MiBatchDetail: Add \n"));
                                DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
                                iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
                                if (iRet != PD_OK) {
                             		iRet = INT_ERR;
DEBUGLOG(("Authorize::Call MiBatchDetail:: Add Failed\n"));
                               	}
			}

			// PSP
			if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: Add Batch Detail:PSP \n"));

				// entity_id
				RemoveField_CString(hBatchRec,"entity_id");
	
				// party_type
                		PutField_CString(hBatchRec,"party_type",PD_MI_ENTITY_PSP);
	
				// party_id 
                		PutField_CString(hBatchRec,"party_id",csPspId);	

				// txn_id
				PutField_CString(hBatchRec,"txn_id",csTxnId);

				// seq
                		PutField_Int(hBatchRec,"seq",iSeq++);

DEBUGLOG(("Authorize::Call MiBatchDetail: Add \n"));
                                DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
                                iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
                                if (iRet != PD_OK) {
                                        iRet = INT_ERR;
DEBUGLOG(("Authorize::Call MiBatchDetail:: Add Failed\n"));
                                }
			}

			// PSP Cost
			if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: Add Batch Detail:PSP Cost \n"));
		
				// Check PSP Cost Txn Exists
				if (GetField_CString(hData, "cost_txn_seq", &csCostTxnId)) {	
				
					// party_type
                			PutField_CString(hBatchRec,"party_type",PD_MI_ENTITY_PSP);
	
					// party_id 
                			PutField_CString(hBatchRec,"party_id",csPspId);	

					// txn_id
					PutField_CString(hBatchRec,"txn_id",csCostTxnId);

					// seq
                			PutField_Int(hBatchRec,"seq",iSeq++);

DEBUGLOG(("Authorize::Call MiBatchDetail: Add \n"));
                                	DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
                                	iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
                                	if (iRet != PD_OK) {
                                	        iRet = INT_ERR;
DEBUGLOG(("Authorize::Call MiBatchDetail:: Add Failed\n"));
                                	}
				}
			}
		}
	}	

	// Update Status, Ar_Ind, Sub Status, Approval Date and Approval Timestamp
	if (iRet == PD_OK) {

/* txn_seq */
              	PutField_CString(hTxnHeader, "txn_seq", csRspTxnId);
               	
/* status */
            	PutField_Char(hTxnHeader,"status",PD_COMPLETE);

/* ar_ind */
              	PutField_Char(hTxnHeader,"ar_ind",PD_ACCEPT);
            
/* sub_status */
		PutField_CString(hTxnHeader,"sub_status",PD_APPROVED);

/* approval_date */
		PutField_CString(hTxnHeader, "approval_date", csApprovalDate);
		
/* approval_timestamp */
		PutField_CString(hTxnHeader, "approval_timestamp", csApprovalTimestamp);
		
DEBUGLOG(("Authorize::Call DBTransaction: Update \n"));
             	DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxnHeader);
		if (iRet != PD_OK) {
                      	iRet = INT_ERR;
DEBUGLOG(("Authorize::Call DBTransaction:: Update Failed\n"));
               	}
      	}

	FREE_ME(csPspId);
	
	FREE_ME(hData);
	FREE_ME(hTxnHeader);
	FREE_ME(hTxnDetail);
	FREE_ME(hBatchRec);
	
DEBUGLOG(("TxnMinByUsPST Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

