/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/11/13              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMinByUsPST.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnMinByUsPST(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
		  hash_t* hRequest,
		  hash_t* hResponse)
{
        int	iRet = PD_OK;

	char  	*csTxnId = NULL;
        char  	*csPspId = NULL;
        char 	*csTxnCountry = NULL;
        char   	*csTxnCcy = NULL;
        char   	*csDate = NULL;
	char    *csEntityId = NULL;
        char    *csEntityType = NULL;
        char    *csRspId = NULL;
        char    *csProductCode = NULL;
 	char	*csTxnType = NULL;
        char  	*csUser = NULL;
        char	*csTmp = NULL;

	double	dAmt=0.0;
	double  dFee=0.0;
        double 	dTmp=0.0;

	int	iTmp = 0;

/* txn_seq */
	if (GetField_CString(hContext,"txn_seq",&csTxnId)) {
                PutField_CString(hResponse,"org_txn_seq",csTxnId);
DEBUGLOG(("Authorize::txn_id = [%s]\n",csTxnId));
        } else {
DEBUGLOG(("Authorize::txn_id not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::txn_id not found!!\n");
                iRet = INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* from_txn_seq */
	if (GetField_CString(hContext,"from_txn_seq",&csTmp)) {
DEBUGLOG(("Authorize::from_txn_id = [%s]\n",csTmp));
	} else {
DEBUGLOG(("Authorize::from_txn_id not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::from_txn_id not found!!\n");
                iRet = INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
	}

/* psp_id */
	if (GetField_CString(hContext,"psp_id",&csPspId)) {
DEBUGLOG(("Authorize::psp_id = [%s]\n",csPspId));
        } else {
DEBUGLOG(("Authorize::psp_id not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::psp_id not found!!\n");
                iRet=INT_PSP_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* org_psp_id */
	if (GetField_CString(hContext,"org_psp_id",&csTmp)) {
DEBUGLOG(("Authorize::org_psp_id = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::org_psp_id not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::org_psp_id not found!!\n");
                iRet=INT_PSP_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_country */
	if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {
DEBUGLOG(("Authorize::txn_country = [%s]\n",csTxnCountry));
        } else {
DEBUGLOG(("Authorize::txn_country not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::txn_country not found!!\n");
            	iRet=INT_TXN_COUNTRY_NOT_FOUND;
              	PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_ccy */
        if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {
DEBUGLOG(("Authorize::txn_ccy = [%s]\n",csTxnCcy));
        } else {
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* net_ccy */
	if (GetField_CString(hContext,"net_ccy",&csTmp)) {
DEBUGLOG(("Authorize::net_ccy = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::net_ccy not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::net_ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* org_txn_ccy */
	if (GetField_CString(hContext,"org_txn_ccy",&csTmp)) {
DEBUGLOG(("Authorize::org_txn_ccy = [%s]\n",csTmp));
        } else {
DEBUGLOG(("Authorize::org_txn_ccy not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::org_txn_ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_amt */
	if (GetField_Double(hContext,"txn_amt",&dAmt)) {
DEBUGLOG(("Authorize::txn_amt = [%f]\n",dAmt));
        } else {
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* org_txn_amt */
	if (GetField_Double(hContext,"org_txn_amt",&dTmp)) {
DEBUGLOG(("Authorize::org_txn_amt = [%f]\n",dTmp));
        } else {
DEBUGLOG(("Authorize::org_txn_amt not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::org_txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* org_dst_net_amt */
	if (GetField_Double(hContext,"org_dst_net_amt",&dTmp)) {
DEBUGLOG(("Authorize::org_dst_net_amt = [%f]\n",dTmp));
        } else {
DEBUGLOG(("Authorize::org_dst_net_amt not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::org_dst_net_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* net_amt */
	if (GetField_Double(hContext,"net_amt",&dTmp)) {
DEBUGLOG(("Authorize::net_amt = [%f]\n",dTmp));
        } else {
DEBUGLOG(("Authorize::net_amt not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::net_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* approval_date */ 	
/*
        if (GetField_CString(hContext,"approval_date",&csTmp)) {
DEBUGLOG(("Authorize::approval_date = [%s]\n", csTmp));
        } else {
DEBUGLOG(("Authorize::approval_date not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::approval_date not found!!\n");
             	iRet=INT_PHDATE_NOT_FOUND;
               	PutField_Int(hContext,"internal_error",iRet);
        }
*/

/* settlement_date */
	if (GetField_CString(hContext,"settlement_date",&csDate)) {
DEBUGLOG(("Authorize::settlement_date = [%s]\n", csDate));
	} else {
DEBUGLOG(("Authorize::settlement_date not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::settlement_date not found!!\n");
          	iRet=INT_PHDATE_NOT_FOUND;
             	PutField_Int(hContext,"internal_error",iRet);
	}

/* report_date */
	if (GetField_CString(hContext,"report_date",&csTmp)) {
DEBUGLOG(("Authorize::report_date = [%s]\n", csTmp));
        } else {
DEBUGLOG(("Authorize::report_date not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::report_date not found!!\n");
                iRet=INT_PHDATE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* remark */
	if (GetField_CString(hContext,"remark",&csTmp)){
DEBUGLOG(("Authorize::remark = [%s]\n",csTmp));
        }

/* process_code */
	if (GetField_CString(hContext,"process_code",&csTmp)) {
DEBUGLOG(("Authorize::process_code = [%s]\n",csTmp));
        }

/* process_type */
	if (GetField_CString(hContext,"process_type",&csTmp)) {
DEBUGLOG(("Authorize::process_type = [%s]\n",csTmp));
        }

/* entity_id */
      	if (GetField_CString(hContext,"entity_id",&csEntityId)) {
DEBUGLOG(("Authorize::entity_id = [%s]\n",csEntityId));
       	} else {
DEBUGLOG(("Authorize::entity_id not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::entity_id not found!!\n");
             	iRet = INT_MI_ENTITY_ID_NOT_FOUND;
            	PutField_Int(hContext,"internal_error",iRet);
  	}

/* entity_type */
      	if (GetField_CString(hContext,"entity_type",&csEntityType)) {
DEBUGLOG(("Authorize::ent_party_type = [%s]\n",csEntityType));
     	} else {
DEBUGLOG(("Authorize::entity_type not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::entity_type not found!!\n");
             	iRet = INT_MI_ENTITY_TYPE_NOT_FOUND;
             	PutField_Int(hContext,"internal_error",iRet);
    	}

/* rsp_id */
     	if (GetField_CString(hContext,"rsp_id",&csRspId)) {
DEBUGLOG(("Authorize::entity_id = [%s]\n",csRspId));
    	} else {
DEBUGLOG(("Authorize::rsp_id not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::rso_id not found!!\n");
              	iRet = INT_MI_RSP_ID_NOT_FOUND;
              	PutField_Int(hContext,"internal_error",iRet);
    	}

/* product_code */
      	if (GetField_CString(hContext,"product_code",&csProductCode)) {
DEBUGLOG(("Authorize::product_code = [%s]\n",csProductCode));
		PutField_CString(hContext,"txn_product",csProductCode);
   	} else {
DEBUGLOG(("Authorize::product_code not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::product_code not found!!\n");
             	iRet=INT_MI_PRODUCT_CODE_NOT_FOUND;
             	PutField_Int(hContext,"internal_error",iRet);
	}

/* txn_type */
	if (GetField_CString(hContext,"mini_txn_type",&csTxnType)) {
DEBUGLOG(("Authorize::mini_txn_type = [%s]\n",csTxnType));	
	}

/* precal_fee */
	if (GetField_Double(hContext,"precal_fee",&dFee)) {
DEBUGLOG(("Authorize::precal_fee = [%f]\n",dFee));
        }

/* add_user */
        if (GetField_CString(hContext,"add_user",&csUser)) {
DEBUGLOG(("Authorize::add_user = [%s]\n",csUser));
        }

/* update_user */
        if (GetField_CString(hContext,"update_user",&csTmp)) {
DEBUGLOG(("Authorize::update_user = [%s]\n",csTmp));
        }

	// Update Entity Balance
        if (iRet == PD_OK) {
		
		// country
		PutField_CString(hContext, "country", csTxnCountry);
		
		// ccy	
		PutField_CString(hContext, "ccy", csTxnCcy);

		// amt_type
		PutField_CString(hContext, "amt_type", PD_CR);

		// bal_type
		PutField_Char(hContext, "bal_type", PD_MI_ENTITY_POOL_INTRANSIT);

		// UpdateEntityBalance
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: UpdateEntityBalance\n"));
             	BOObjPtr = CreateObj(BOPtr, "BOMiEntityBalance", "UpdateEntityBalance");
              	iRet = (unsigned long)(*BOObjPtr)(hContext,hContext);
		if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: UpdateEntityBalance Success\n"));

                    	if (GetField_CString(hContext, "approval_date", &csTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: approval_date [%s]\n", csTmp));
                      	}

                      	if (GetField_CString(hContext, "approval_timestamp", &csTmp))  {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: approval_timestamp [%s]\n", csTmp));
                    	}

                     	// Open Balance
                      	if (GetField_Double(hContext, "open_acct_bal", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: open_acct_bal = [%f]\n", dTmp));
                     	}

                       	if (GetField_Double(hContext, "open_intransit", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: open_intransit = [%f]\n", dTmp));
                    	}

                       	if (GetField_Double(hContext, "open_ar_bal", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: open_ar_bal = [%f]\n", dTmp));
                     	}

                     	// Close Balance
                     	if (GetField_Double(hContext, "acct_bal", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: closing acct_bal = [%f]\n", dTmp));
                      	}

                      	if (GetField_Double(hContext, "intransit", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: closing intransit = [%f]\n", dTmp));
                   	}

                    	if (GetField_Double(hContext, "ar_bal", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: closing ar_bal = [%f]\n", dTmp));
                      	}

          	} else {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n"));
ERRLOG("TxnMinByUsPST::Authorize::Call BOMiEntityBalance:: UpdateEntityBalanc Failed\n");
                     	iRet = INT_ERR;
               	}
       	}
	
	// Add and Update TxnMiDetail
	if (iRet == PD_OK) {
	
/* do_logging */
		if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("Authorize::do_logging [%d]\n", iTmp));

                	if (iTmp != PD_ADD_LOG) {
                        	/* nothing */
                	} else {
				
				// Add TxnMiDetail
				if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBTxnMiDetail:: Add\n"));
                                	DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Add");
                                	iRet = (unsigned long)(*DBObjPtr)(hContext);
					if (iRet != PD_OK) {
DEBUGLOG(("Authorize::Call DBTxnMiDetail:: Add Failed\n"));
						iRet = INT_ERR;
					}
				}

				// Update TxnMiDetail
				if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBTxnMiDetail:: Update\n"));
 	                             	DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Update");
        	                      	iRet = (unsigned long)(*DBObjPtr)(hContext);
					if (iRet != PD_OK) {
DEBUGLOG(("Authorize::Call DBTxnMiDetail:: Update Failed\n"));
                	                        iRet = INT_ERR;
					}
				}
                        }
                }
	}
		
DEBUGLOG(("TxnMinByUsPST Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}
