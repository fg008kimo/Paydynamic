/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/11/13              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMinByUsPST.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMinByUsPST(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
		  hash_t* hRequest,
		  hash_t* hResponse)
{
        int	iRet = PD_OK;

	int     i = 0;
        int     iBatchCnt = 2;
        int     iTmp = 0;

	double  dTmp = 0.0;

	char  	*csTxnId = NULL;
	char    *csEntityId = NULL;
        char    *csEntityType = NULL;
        char    *csRspId = NULL;
        char  	*csUser = NULL;
        char	*csTmp = NULL;
	
	char  	*csPspId = (char*) malloc (64);

	char    csRspTxnId[PD_TXN_SEQ_LEN + 1];
	char    csBatchId[PD_TXN_SEQ_LEN + 1];

	hash_t *hBatchRec;
       	hBatchRec = (hash_t*) malloc (sizeof(hash_t));
      	hash_init(hBatchRec, 0);

/* txn_seq */
	if (GetField_CString(hContext,"txn_seq",&csTxnId)) {
DEBUGLOG(("Authorize::txn_id = [%s]\n",csTxnId));
        } else {
DEBUGLOG(("Authorize::txn_id not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::txn_id not found!!\n");
                iRet = INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* psp_id */
	if (GetField_CString(hContext,"psp_id",&csPspId)) {
DEBUGLOG(("Authorize::psp_id = [%s]\n",csPspId));
        } else {
DEBUGLOG(("Authorize::psp_id not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::psp_id not found!!\n");
                iRet=INT_PSP_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_country */
	if (GetField_CString(hContext,"txn_country",&csTmp)) {
DEBUGLOG(("Authorize::txn_country = [%s]\n",csTmp));
		PutField_CString(hContext, "country", csTmp);
        } else {
DEBUGLOG(("Authorize::txn_country not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::txn_country not found!!\n");
            	iRet=INT_TXN_COUNTRY_NOT_FOUND;
              	PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_ccy */
        if (GetField_CString(hContext,"txn_ccy",&csTmp)) {
DEBUGLOG(("Authorize::txn_ccy = [%s]\n",csTmp));
		PutField_CString(hContext, "ccy", csTmp);
        } else {
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_amt */
	if (GetField_Double(hContext,"txn_amt",&dTmp)) {
DEBUGLOG(("Authorize::txn_amt = [%f]\n",dTmp));
        } else {
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* report_date */
	if (GetField_CString(hContext,"report_date",&csTmp)) {
DEBUGLOG(("Authorize::report_date = [%s]\n", csTmp));
		PutField_CString(hContext, "txn_date", csTmp);
        } else {
DEBUGLOG(("Authorize::report_date not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::report_date not found!!\n");
                iRet=INT_PHDATE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* remark */
	if (GetField_CString(hContext,"remark",&csTmp)){
DEBUGLOG(("Authorize::remark = [%s]\n",csTmp));
        }

/* entity_id */
      	if (GetField_CString(hContext,"entity_id",&csEntityId)) {
DEBUGLOG(("Authorize::entity_id = [%s]\n",csEntityId));
       	} else {
DEBUGLOG(("Authorize::entity_id not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::entity_id not found!!\n");
             	iRet = INT_MI_ENTITY_ID_NOT_FOUND;
            	PutField_Int(hContext,"internal_error",iRet);
  	}

/* entity_type */
      	if (GetField_CString(hContext,"entity_type",&csEntityType)) {
DEBUGLOG(("Authorize::entity_type = [%s]\n",csEntityType));
		PutField_CString(hContext,"party_type",csEntityType);
     	} else {
DEBUGLOG(("Authorize::entity_type not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::entity_type not found!!\n");
             	iRet = INT_MI_ENTITY_TYPE_NOT_FOUND;
             	PutField_Int(hContext,"internal_error",iRet);
    	}

/* rsp_id */
     	if (GetField_CString(hContext,"rsp_id",&csRspId)) {
DEBUGLOG(("Authorize::rsp_id = [%s]\n",csRspId));
		PutField_CString(hContext,"party_id",csRspId);
    	} else {
DEBUGLOG(("Authorize::rsp_id not found!!\n"));
ERRLOG("TxnMinByUsPST::Authorize::rso_id not found!!\n");
              	iRet = INT_MI_RSP_ID_NOT_FOUND;
              	PutField_Int(hContext,"internal_error",iRet);
    	}

/* mini_txn_type */
	if (GetField_CString(hContext,"mini_txn_type",&csTmp)) {
DEBUGLOG(("Authorize::mini_txn_type = [%s]\n",csTmp));	
	}

/* add_user */
        if (GetField_CString(hContext,"add_user",&csUser)) {
DEBUGLOG(("Authorize::add_user = [%s]\n",csUser));
        }

/* update_user */
        if (GetField_CString(hContext,"update_user",&csTmp)) {
DEBUGLOG(("Authorize::update_user = [%s]\n",csTmp));
        }

	// Update Entity Balance
        if (iRet == PD_OK) {
		
		// amt_type
		PutField_CString(hContext, "amt_type", PD_CR);

		// bal_type
		PutField_Char(hContext, "bal_type", PD_MI_ENTITY_POOL_INTRANSIT);

		// UpdateEntityBalance
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: UpdateEntityBalance\n"));
             	BOObjPtr = CreateObj(BOPtr, "BOMiEntityBalance", "UpdateEntityBalance");
              	iRet = (unsigned long)(*BOObjPtr)(hContext,hContext);
		if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: UpdateEntityBalance Success\n"));

                    	if (GetField_CString(hContext, "approval_date", &csTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: approval_date [%s]\n", csTmp));
                      	}

                      	if (GetField_CString(hContext, "approval_timestamp", &csTmp))  {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: approval_timestamp [%s]\n", csTmp));
                    	}

                     	// Open Balance
                      	if (GetField_Double(hContext, "open_acct_bal", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: open_acct_bal = [%f]\n", dTmp));
                     	}

                       	if (GetField_Double(hContext, "open_intransit", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: open_intransit = [%f]\n", dTmp));
                    	}

                       	if (GetField_Double(hContext, "open_ar_bal", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: open_ar_bal = [%f]\n", dTmp));
                     	}

                     	// Close Balance
                     	if (GetField_Double(hContext, "acct_bal", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: closing acct_bal = [%f]\n", dTmp));
                      	}

                      	if (GetField_Double(hContext, "intransit", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: closing intransit = [%f]\n", dTmp));
                   	}

                    	if (GetField_Double(hContext, "ar_bal", &dTmp)) {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: closing ar_bal = [%f]\n", dTmp));
                      	}

          	} else {
DEBUGLOG(("Authorize::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n"));
ERRLOG("TxnMinByUsPST::Authorize::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n");
                     	iRet = INT_ERR;
               	}
       	}
	
	// Add and Update TxnMiDetail
	if (iRet == PD_OK) {

		// Generate RSP Txn Id
DEBUGLOG(("Authorize::Call TxnSeq: GetNextMgtTxnSeq\n"));
                DBObjPtr = CreateObj(DBPtr, "DBTxnSeq", "GetNextMgtTxnSeq");
                strcpy((char*)csRspTxnId, (*DBObjPtr)());

		PutField_CString(hContext,"txn_seq",csRspTxnId);
DEBUGLOG(("Authorize::Call TxnSeq: GetNextMgtTxnSeq:: rsp_txn_seq = [%s]\n", csRspTxnId));

		// Get PSP Product Code
DEBUGLOG(("Authorize::Call CrrPspProductCodeMap:: GetPSPProductCode\n"));
                DBObjPtr = CreateObj(DBPtr, "DBCrrPspProductCodeMap", "GetPSPProductCode");
                iRet = (unsigned long)(*DBObjPtr)(csPspId,hContext);
                if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call CrrPspProductCodeMap:: GetPSPProductCode Success\n"));
		
/* product_code */
			if (GetField_CString(hContext, "product_code", &csTmp)) {
DEBUGLOG(("Authorize::Call CrrPspProductCodeMap:: GetPSPProductCode:: product_code = [%s]\n", csTmp));
				PutField_CString(hContext,"txn_product",csTmp);
                        }

		} else {
DEBUGLOG(("Authorize::Call CrrPspProductCodeMap:: GetPSPProductCode Failed\n"));
ERRLOG("TxnMinByUsPST::Authorize::Call CrrPspProductCodeMap:: GetPSPProductCode Failed\n");
                        iRet = INT_ERR;
		}
	
/* do_logging */
		if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("Authorize::do_logging [%d]\n", iTmp));

                	if (iTmp != PD_ADD_LOG) {
                        	/* nothing */
                	} else {
				
				// Add TxnMiDetail
				if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBTxnMiDetail:: Add\n"));
                                	DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Add");
                                	iRet = (unsigned long)(*DBObjPtr)(hContext);
					if (iRet != PD_OK) {
DEBUGLOG(("Authorize::Call DBTxnMiDetail:: Add Failed\n"));
						iRet = INT_ERR;
					}
				}

				// Update TxnMiDetail
				if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBTxnMiDetail:: Update\n"));
 	                             	DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Update");
        	                      	iRet = (unsigned long)(*DBObjPtr)(hContext);
					if (iRet != PD_OK) {
DEBUGLOG(("Authorize::Call DBTxnMiDetail:: Update Failed\n"));
                	                        iRet = INT_ERR;
					}
				}
                        }
                }
	}

	// Handle Batch Info
	if (iRet == PD_OK) {
		
		// Generate Batch Id
DEBUGLOG(("Authorize::Call TxnSeq:: GetNextMiActionBatchSeq\n"));
		DBObjPtr = CreateObj(DBPtr, "DBTxnSeq", "GetNextMiActionBatchSeq");
             	strcpy(csBatchId, (*DBObjPtr)());
DEBUGLOG(("Authorize::Call TxnSeq:: GetNextMiActionBatchSeq: [%s]\n",csBatchId));

		// Add Batch Header
		if (iRet == PD_OK) {
	
			// batch_id
			PutField_CString(hBatchRec,"batch_id",csBatchId);

			// process_type
                	PutField_CString(hBatchRec,"process_type",PD_MI_TXN_TYPE_PSP_SETTLE);
	
			// status
                	PutField_Char(hBatchRec,"status",PD_MI_BATCH_STATUS_NORMAL);

			// user
			PutField_CString(hBatchRec,"add_user",csUser);

DEBUGLOG(("Authorize::Call MiBatchHeader:: Add\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBMiBatchHeader", "Add");
                	iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
                	if (iRet != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize::Call MiBatchHeader:: Add Failed\n"));  
			}
		}
	
		// Add Batch Detail
		if (iRet == PD_OK) {	

			// PSP and RSP
			for (i = 1; i < iBatchCnt + 1; i++) {
DEBUGLOG(("Authorize::batch_cnt = [%d]\n", i));
		
				if (i == 1) {
					
					// party_type
                			PutField_CString(hBatchRec,"party_type",PD_MI_ENTITY_PSP);
	
					// party_id 
                			PutField_CString(hBatchRec,"party_id",csPspId);	

					// txn_id
					PutField_CString(hBatchRec,"txn_id",csTxnId);

				} else if (i == 2) {

					// entity_id
                			PutField_CString(hBatchRec,"entity_id",csEntityId);
					
					// party_type
                			PutField_CString(hBatchRec,"party_type",PD_MI_ENTITY_RSP);

					// party_id 
                			PutField_CString(hBatchRec,"party_id",csRspId);
	
					// txn_id
					PutField_CString(hBatchRec,"txn_id",csRspTxnId);	
				}
	
				// batch_id
				PutField_CString(hBatchRec,"batch_id",csBatchId);

				// seq
                		PutField_Int(hBatchRec,"seq",i);

				// txn_oper_ind
                		PutField_Char(hBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_INSERT);

				// user
				PutField_CString(hBatchRec,"add_user",csUser);

DEBUGLOG(("Authorize::Call MiBatchDetail:Add \n"));
	                	DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
	                	iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
	                	if (iRet != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize::Call MiBatchDetail:: Add Failed\n"));
	                	}
			}
		}
	}	

	// Reset Txn Seq
	if (iRet == PD_OK) {
		PutField_CString(hContext,"txn_seq",csTxnId);
	}

	FREE_ME(csPspId);
	FREE_ME(hBatchRec);
	
DEBUGLOG(("TxnMinByUsPST Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}
