/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/12/07              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsPAD.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnMgtByUsPAD(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;

        char        *csTmp = NULL;
        char        *csPspId = NULL;
        char        *csCode = NULL;

        char        *csTxnCountry = NULL;
        char        *csTxnCcy = NULL;
        char        *csUpdateUser = NULL;  
        char        *csDate = NULL;  
        double       dAmt=0.0;
	int	    iTmp;

/*        char    csRtnTxnCode[PD_TXN_CODE_LEN + 1];*/

        hash_t      *hRec;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("Authorize::Start\n"));
/* txn_seq */
        if(GetField_CString(hContext,"txn_seq",&csTmp)){
		PutField_CString(hResponse,"org_txn_seq",csTmp);
DEBUGLOG(("Authorize::txn_seq = [%s]\n", csTmp));
        }
        else{
DEBUGLOG(("Authorize::txnid not found!!\n"));
ERRLOG("TxnMgtByUsPAD::Authorize::txnid not found!!\n");
                iRet=INT_INVALID_TXN;
        }

/* add_user */
        if(GetField_CString(hRequest,"add_user",&csUpdateUser)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csUpdateUser));
                PutField_CString(hContext,"add_user",csUpdateUser);
                PutField_CString(hContext,"update_user",csUpdateUser);
        }

/* remark */
        if(GetField_CString(hRequest,"remark",&csTmp)){
DEBUGLOG(("Authorize::remark = [%s]\n",csTmp));
                PutField_CString(hContext,"remark",csTmp);
        }


/* psp_id */
        if(GetField_CString(hRequest,"psp_id",&csPspId)){
DEBUGLOG(("Authorize::psp_id = [%s]\n",csPspId));
                PutField_CString(hContext,"psp_id",csPspId);
        }
	else {
DEBUGLOG(("Authorize::psp_id not found!!\n"));
ERRLOG("TxnMgtByUsPAD::Authorize::psp_id not found!!\n");
		iRet = INT_PSP_RETURN_ERROR;
	}

/* code */
        if(GetField_CString(hRequest,"code",&csCode)){
DEBUGLOG(("Authorize::code = [%s]\n",csCode));
                PutField_CString(hContext,"code",csCode);
DEBUGLOG(("Authorize::Assign new Txn code = [%s]\n",csCode));
	PutField_CString(hContext, "new_txn_code", csCode);

/*
                memset(csRtnTxnCode, 0, sizeof(csRtnTxnCode));

DEBUGLOG(("Authorize::Call BOAdjustment:FormNewTxnCode\n"));
		BOObjPtr = CreateObj(BOPtr,"BOAdjustment","FormNewTxnCode");
                (*BOObjPtr)(PD_TYPE_PSP, csCode, &csRtnTxnCode);

DEBUGLOG(("Authorize::Call BOAdjustment:FormNewTxnCode csRtnTxnCode [%s]\n", csRtnTxnCode));
*/
        } 
	else {
DEBUGLOG(("Authorize::code not found!!\n"));
ERRLOG("TxnMgtByUsPAD::Authorize::code not found!!\n");
                        iRet=INT_CODE_ERROR;
	}

/* txn_country */
	if(GetField_CString(hRequest,"txn_country",&csTxnCountry)){
                PutField_CString(hContext,"txn_country",csTxnCountry);
DEBUGLOG(("Authorize::txn_country= [%s]\n",csTxnCountry));
        }
        else{
DEBUGLOG(("Authorize::Call DBPspCountry:GetPspCountry\n"));
                DBObjPtr = CreateObj(DBPtr,"DBPspCountry","GetPspCountry");
                if((unsigned long) ((*DBObjPtr)(csPspId,rRecordSet))==PD_OK){
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while(hRec){
                                if (GetField_CString(hRec,"country",&csTxnCountry)) {
                                        PutField_CString(hContext,"txn_country",csTxnCountry);
DEBUGLOG(("Authorize::txn_country by psp_id = [%s]\n",csTxnCountry));
                                }
                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                }
                else{
DEBUGLOG(("Authorize::txn_country not found!!\n"));
ERRLOG("TxnMgtByUsPAD::Authorize::txn_country not found!!\n");
                        iRet=INT_COUNTRY_PSP_NOT_AVABILE;
                }
        }

/* txn_ccy */
        if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTxnCcy));
                PutField_CString(hContext,"txn_ccy",csTxnCcy);
        }
        else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMgtByUsPAD::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
        }


/* txn_amt */
        if(GetField_Double(hContext,"txn_amt",&dAmt)){
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dAmt));
        }
        else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMgtByUsPAD::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
        }

/* approval_date */
        if(!GetField_CString(hRequest,"approval_date",&csDate)){
                if(!GetField_CString(hContext,"PHDATE",&csDate)){
DEBUGLOG(("Authorize::approval_date not found!!\n"));
ERRLOG("TxnMgtByUsPAD::Authorize::approval_date not found!!\n");
                        iRet=INT_INVALID_TXN;
                }
                else {
                        PutField_CString(hContext, "approval_date", csDate);
DEBUGLOG(("Authorize::approval_date (phdate) = [%s]\n", csDate)); 
                }
        }
	else {
		PutField_CString(hContext, "approval_date", csDate);
DEBUGLOG(("Authorize::approval_date = [%s]\n", csDate)); 
	}


	PutField_Char(hContext, "party_type", PD_TYPE_PSP);


        PutField_CString(hContext,"process_code","000000");
        PutField_CString(hContext,"process_type","0000");

 
	//Update Balance
        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call BOAdjustment:ProcessPartyBalance\n"));
                BOObjPtr = CreateObj(BOPtr,"BOAdjustment","ProcessPartyBalance");
		iRet = (unsigned long)((*BOObjPtr)(hContext));

		if (iRet != PD_OK) {
DEBUGLOG(("Authorize::BOAdjustment:ProcessPartyBalance Failed Ret [%d]\n", iRet));
ERRLOG("TxnMgtByUsPAD::BOADjustment::ProcesspartyBalance Failed [%d]\n", iRet);
		}

/*
		if((unsigned long)((*BOObjPtr)(hContext) != PD_OK)){
DEBUGLOG(("Authorize::BOAdjustment:ProcessPartyBalance Failed\n"));
ERRLOG("TxnMgtByUsPAD::BOADjustment::ProcesspartyBalance Failed\n");
		iRet = INT_ERR;
		}
*/
        } 


       if(GetField_Int(hContext,"do_logging",&iTmp)){
DEBUGLOG(("Authorize::do_logging [%d]\n", iTmp));
                if(iTmp!=PD_ADD_LOG) {
                        /* nothing */
                }
                else {
        		if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:AddDetail\n"));
		                DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
				if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK)
					iRet = INT_ERR;
        		}
   
        		if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:UpdateDetail\n"));
                		DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
	                	if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK)
       		                 	iRet = INT_ERR;
       	 		}
		}
	}


        // for handling TXNPSPDETAIL??
        if(iRet==PD_OK){
                if (GetField_CString(hContext, "PHDATE", &csTmp)) {
DEBUGLOG(("Authorize::PHDATE = [%s]\n",csTmp));
                    PutField_CString(hContext, "txn_date", csTmp);
                }

DEBUGLOG(("Authorize::Call DBTxnPspDetail:Add\n"));
		PutField_CString(hContext, "desc", "Psp Adjustment");

                DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Add");
                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK) {
                        iRet = INT_ERR;
                } 
        }

	if (iRet==PD_OK) {
DEBUGLOG(("Authorize::Call DBTxnPspDetail:Update\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
		if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK) {
			iRet = INT_ERR;
		}
	}
         

/*
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Assign new Txn code = [%s]\n",csRtnTxnCode));
                PutField_CString(hContext, "new_txn_code", csRtnTxnCode);
	}
*/



        if(iRet!=PD_OK){
                PutField_Int(hContext,"internal_error",iRet);
        }


	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

DEBUGLOG(("TxnMgtByUsPAD Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}
