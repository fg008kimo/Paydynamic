/*
Partnerdelight (c)2014. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/12/30              Virginia Yun
Special Handling for Pending Fund		   2015/05/04		   Dirk Wong
Check if MMS mode = ON, not update SEBBalance      2015/08/13              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsOPF.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnOmtByUsOPF(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;

        char    *csUser = NULL;
	char	*csBaid = NULL;
	char	*csPspId = NULL;
	char	*csPspAcctType = NULL;
	char    *csTxnCountry=strdup("");
	char	*csTxnCcy = NULL;
	char	*csFromCcy = NULL;
	char	*csDate = NULL;
	char	*csTxnSeq= NULL;
	char	*csTmp = NULL;
	double	dAmt = 0.0;
	double	dSrcAmt = 0.0;
	double	dTmp = 0.0;
	int	iMMSModeOff = PD_TRUE;

/*
	hash_t	*hRec;
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);
*/

	
	if(GetField_CString(hRequest,"add_user",&csUser)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csUser));
		PutField_CString(hContext,"update_user",csUser);
	}


	if(GetField_CString(hRequest,"baid",&csBaid)){
DEBUGLOG(("Authorize::psp_id= [%s]\n",csBaid));
		PutField_CString(hContext,"baid",csBaid);
	}
	else{
DEBUGLOG(("Authorize::psp_id not found!!\n"));
ERRLOG("TxnOmtByUsOPF::Authorize::psp_id not found!!\n");
		iRet=INT_INVALID_BAID;
		PutField_Int(hContext,"internal_error",iRet);
	}

        if  (GetField_CString(hContext, "baid_psp_id", &csPspId)) {
                PutField_CString(hContext, "psp_id", csPspId);
        }
        if (GetField_CString(hContext, "baid_status", &csTmp)) {
		// if not open, return error
		if (strcmp(csTmp, PD_BAID_STATUS_OPEN)) {
DEBUGLOG(("Authorize::baid status is not open !!\n"));
ERRLOG("TxnOmtByUsOPF::Authorize::baid status is not open!!\n");
			iRet=INT_INVALID_BAID;
			PutField_Int(hContext,"internal_error",iRet);
		}
	}

	hash_t  *hRec;
	hRec = (hash_t*)malloc (sizeof(hash_t));
	hash_init(hRec,0);
DEBUGLOG(("Authorize:: Call DBOLPspDetail:GetPspDetail\n"));
	DBObjPtr = CreateObj(DBPtr, "DBOLPspDetail","GetPspDetail");
	iRet = (unsigned long)(*DBObjPtr)(csPspId,hRec);
	if (iRet == PD_OK) {
		if (GetField_CString(hRec,"bank_acct_type",&csPspAcctType)) {
DEBUGLOG(("Authorize:: DBOLPspDetail:GetPspDetail bank_acct_type = [%s]\n",csPspAcctType));
		}
	} else {
		iRet = INT_ERR;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: DBOLPspDetail:GetPspDetail FAILED\n"));
ERRLOG("TxnOmtByUsOPF::Authorize:: DBOLPspDetail:GetPspDetail FAILED\n");
	}
	

	if(GetField_CString(hRequest,"bank_ccy",&csFromCcy)){
DEBUGLOG(("Authorize::bank_ccy= [%s]\n",csFromCcy));
	}
	else{
DEBUGLOG(("Authorize::bank_ccy not found!!\n"));
ERRLOG("TxnOmtByUsOPF::Authorize::bank_ccy not found!!\n");
		iRet=INT_CURRENCY_CODE_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

	if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTxnCcy));
		PutField_CString(hContext,"txn_ccy",csTxnCcy);
		PutField_CString(hContext,"net_ccy",csTxnCcy);
		PutField_CString(hContext,"org_txn_ccy",csTxnCcy);
		PutField_CString(hContext,"dst_txn_ccy",csTxnCcy);
	}
	else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnOmtByUsOPF::Authorize::ccy not found!!\n");
		iRet=INT_CURRENCY_CODE_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

	if(GetField_CString(hRequest,"txn_country",&csTxnCountry)){
DEBUGLOG(("Authorize::txn_country= [%s]\n",csTxnCountry));
		PutField_CString(hContext,"txn_country",csTxnCountry);
	}
	else{
DEBUGLOG(("Authorize:: Call DBOLBankAcctId: GetBankAcctIdCountry\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetBankAcctIdCountry");
                if ((unsigned long)(*DBObjPtr)(csBaid, csTxnCountry) == FOUND) {
DEBUGLOG(("Authorize:: txn_country by baid = [%s]\n", csTxnCountry));
                        PutField_CString(hContext, "txn_country", csTxnCountry);
                        PutField_CString(hRequest, "txn_country", csTxnCountry);
                } else {
DEBUGLOG(("Authorize:: txn_country not found!!\n"));
ERRLOG("TxnOmtByUsOPF:: Authorize:: txn_country not found!!\n");
                        iRet = INT_COUNTRY_PSP_NOT_AVABILE;
                        PutField_Int(hContext, "internal_error", iRet);
                }
	}

	if(GetField_CString(hRequest,"bank_amt",&csTmp)){
                int iCheck = PD_FALSE;
		char    *p = NULL;
                p = (char*)strchr(csTmp, '.');
                if (p == NULL){
                        iCheck = is_numeric(csTmp);
                        if(iCheck!=PD_FALSE){
                                if(sscanf(csTmp,"%lf",&dSrcAmt)==1){
DEBUGLOG(("Authorize() src_txn_amt = [%f]\n",dSrcAmt));
                                }
                        }
                }
                else{
                        if(sscanf(csTmp,"%lf",&dSrcAmt)==1){
DEBUGLOG(("Authorize() src_txn_amt = [%f]\n",dSrcAmt));
                                iCheck = PD_TRUE;
                        }
                }
                if(iCheck==PD_FALSE){
                        iRet =  INT_INVALID_PAY_AMOUNT;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()src_txn_amt Invalid[%s]\n",csTmp));
ERRLOG("TxnOmtByUsOPF::Authorize() src_txn_amt Invalid\n");
                }
        }
        else{
DEBUGLOG(("Authorize::src_txn_amt not found!!\n"));
ERRLOG("TxnOmtByUsOPF::Authorize::src_txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }


	if(GetField_Double(hContext,"txn_amt",&dAmt)){
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dAmt));
		PutField_Double(hContext, "net_amt", dAmt);
		PutField_Double(hContext, "display_amt", dAmt);
		PutField_Double(hContext, "txn_amount", dAmt);
		PutField_Double(hContext, "org_txn_amt", dAmt);
	}
	else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnOmtByUsOPF::Authorize::txn_amt not found!!\n");
		iRet=INT_PAY_AMOUNT_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

/* report_date */
        if(!GetField_CString(hRequest,"report_date",&csTmp)){
DEBUGLOG(("Authorize::report_date not found!!\n"));
ERRLOG("TxnOmtByUsOPF::Authorize::report_date not found!!\n");
                if(GetField_CString(hContext,"PHDATE",&csTmp)){
                        PutField_CString(hContext, "report_date", csTmp);
DEBUGLOG(("Authorize::report_date (PH date) = [%s]\n", csTmp));
                }
        }
        else {
                PutField_CString(hContext, "report_date", csTmp);
DEBUGLOG(("Authorize::report_date = [%s]\n", csTmp));
        }

/* remark */
        if(GetField_CString(hRequest,"remark",&csTmp)){
DEBUGLOG(("Authorize::remark = [%s]\n", csTmp));
	}


	//check MMS Mode
	if (iRet == PD_OK) {
		char*   csValue;
		csValue = (char*) malloc (128);
		DBObjPtr = CreateObj(DBPtr,"DBSystemParameter","FindCode");
		if ((unsigned long)(DBObjPtr)(PD_MMSMODE,csValue) == FOUND) {
DEBUGLOG(("MMS Mode = [%s]\n",csValue));
			if (!strcmp(csValue, PD_ENABLE_MMSMODE))
				iMMSModeOff = PD_FALSE;
			else
				iMMSModeOff = PD_TRUE;
		}
		FREE_ME(csValue);
	}

//////debit SebBalance
	if(iRet==PD_OK && iMMSModeOff){
		PutField_CString(hContext,"bank_ccy",csFromCcy);
		PutField_Double(hContext,"bank_bal",dSrcAmt);
DEBUGLOG(("Authorize::Call BOOLBalance:DebitSebBalance\n"));
		BOObjPtr = CreateObj(BOPtr,"BOOLBalance","DebitSebBalance");
		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
		if(iRet==PD_ERR){
			iRet = INT_ERR;
DEBUGLOG(("Authorize::BOOLBalance:DebitSebBalance Error\n"));
ERRLOG("TxnOmtByUsOPF::Authorize::BOOLBalance:DebitSebBalance Error\n");
		}
	}

// Get Exchange Rate
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: Call BOExchange: GetExchangeInfo\n"));
		BOObjPtr = CreateObj(BOPtr, "BOExchange", "GetExchangeInfo");
		iRet = (unsigned long)(*BOObjPtr)(hContext, hRequest);
		if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call: BOExchange.GetExchangeInfo failed, return = [%d]\n", iRet));
ERRLOG("TxnOmtByUsOPF:: Authorize:: Call: BOExchange.GetExhcnageInfo failed, return = [%d]\n", iRet);
		}
	}


// Update Balance 
	if (iRet == PD_OK) {
		PutField_Char(hContext, "amt_type", PD_IND_CREDIT); 
// for pending fund, credit account balance instead of in-transit
		if (!strcmp(csPspAcctType, PD_NATURE_PENDING_FUND)) {
			PutField_CString(hContext, "pool", PD_ACCT_BAL_POOL); 
		} else {
			PutField_CString(hContext, "pool", PD_INTRANSIT_POOL); 
		}

DEBUGLOG(("Authorize::Call BOOLBalance:UpdateAmount\n"));
		BOObjPtr = CreateObj(BOPtr,"BOOLBalance","UpdateAmount");
		iRet = (unsigned long)(*BOObjPtr)(hContext);
		if (iRet == PD_OK) {

                        if (GetField_Double(hContext, "open_bal", &dTmp)) {
DEBUGLOG(("Authorize::Call BOOLBalance:open_bal [%f]\n", dTmp));
                        }

                        if (GetField_Double(hContext, "open_in_transit", &dTmp)) {
DEBUGLOG(("Authorize::Call BOOLBalance:open_in_transit [%f]\n", dTmp));
                        }


                        if (GetField_CString(hContext, "approval_date", &csTmp)) {
DEBUGLOG(("Authorize::Call BOOLBalance:approval_date [%s]\n", csTmp));
                        }

                        if (GetField_CString(hContext, "approval_timestamp", &csTmp))  {
DEBUGLOG(("Authorize::Call BOOLBalance:approval_timestamp [%s]\n", csTmp));
                        }

                        if (GetField_Double(hContext, "bal", &dTmp)) {
DEBUGLOG(("Authorize::Call BOOLBalance:balance = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hContext, "total_hold", &dTmp)) {
DEBUGLOG(("Authorize::Call BOOLBalance:total_hold = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hContext, "prepaid", &dTmp)) {
DEBUGLOG(("Authorize::Call BOOLBalance:prepaid = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hContext, "in_transit", &dTmp)) {
DEBUGLOG(("Authorize::Call BOOLBalance:in_transit = [%f]\n", dTmp));
                        }
		
		}

	}

       if (iRet == PD_OK) {
                /* ***Update Country*** */
DEBUGLOG(("Authorize::Call OMTChannel:UpdateTxnDetailLog\n"));
                ChannelObjPtr = CreateObj(ChannelPtr, "OMTChannel","UpdateTxnDetailLog");
                if ((unsigned long)((*ChannelObjPtr)(hContext, hRequest, hResponse)) != PD_OK) {
                        iRet = INT_ERR;
                }
        }


	if(iRet==PD_OK){

		PutField_CString(hContext, "desc", "FundIn Payout for PSP");

		if (GetField_CString(hContext, "baid_bank_code", &csTmp)) {
DEBUGLOG(("Authorize:: bank_code [%s]\n", csTmp));
			PutField_CString(hContext, "bank_code", csTmp);
		}

		if (GetField_CString(hContext, "baid_bank_acct_num", &csTmp)) {
DEBUGLOG(("Authorize:: bank_acct_num [%s]\n", csTmp));
			PutField_CString(hContext, "bank_acct_num", csTmp);
		}

		DBObjPtr = CreateObj(DBPtr,"DBOLTxnPspDetail","Add");
		if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK)
			iRet = INT_ERR;

		if(iRet==PD_OK){
			if(GetField_CString(hContext,"PHDATE",&csTmp)){
				PutField_CString(hContext,"txn_date",csTmp);
			}
DEBUGLOG(("Authorize::Call DBTxnPspDetail:Update\n"));
			DBObjPtr = CreateObj(DBPtr,"DBOLTxnPspDetail","Update");
			if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK) {
				iRet = INT_ERR;
			}
		}
	}

	if(iRet==PD_OK){
		if(GetField_CString(hContext,"txn_seq",&csTxnSeq)){
			PutField_CString(hResponse,"org_txn_seq",  csTxnSeq);
			PutField_CString(hContext, "from_txn_seq", csTxnSeq);
		}
	}

	if (iRet == PD_OK) {
// for pending fund, credit account balance instead of in-transit
		if (!strcmp(csPspAcctType, PD_NATURE_PENDING_FUND)) {
			PutField_CString(hContext, "txn_element_type", PD_ELEMENT_TXN_AMT);
		} else {
			PutField_CString(hContext, "txn_element_type", PD_ELEMENT_IN_TRANSIT);
		}
		PutField_Char(hContext, "party_type", PD_TYPE_PSP);
		PutField_CString(hContext, "amount_type", PD_CR);

DEBUGLOG(("Authorize::Call BOOLTxnElements:AddTxnAmtElement\n"));
                //BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddTxnAmtElement");
                BOObjPtr = CreateObj(BOPtr,"BOOLTxnElements","AddPspTxnElement");
                if ((unsigned long)((*BOObjPtr)(hContext)) != PD_OK) {
                        iRet = INT_ERR;
                }
        }



	if (iRet == PD_OK) {
		GetField_CString(hContext, "PHDATE", &csDate);

		PutField_CString(hContext, "sub_status", PD_APPROVED);
		PutField_Char(hContext, "recon_status", PD_UNRECONCILED);
		
	}


/////Add to FundsOut table (for SEB balance)
	if(iRet==PD_OK && iMMSModeOff){
		hash_t  *hTxn;
		hTxn = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hTxn,0);

		int	iId = 0;
		int	iCnt = 0;
		int	i = 0;
		double	dTmp = 0.0;
		char	csId[PD_TXN_SEQ_LEN+1];
		char	csTag[PD_TAG_LEN+1];

DEBUGLOG(("Authorize::call DBFundsOut->Add\n"));
		if(GetField_Double(hContext,"bal_after_fo",&dAmt)){
			PutField_Double(hTxn,"bank_bal",dAmt);
		}
		PutField_CString(hTxn,"txn_seq",csTxnSeq);
		PutField_Double(hTxn,"fundout_amt",dSrcAmt);
		PutField_CString(hTxn,"fundout_ccy",csFromCcy);
		PutField_CString(hTxn,"fundout_date",csDate);
		PutField_CString(hTxn,"add_user",csUser);
		DBObjPtr = CreateObj(DBPtr,"DBFundsOut","Add");
		if((unsigned long)(*DBObjPtr)(hTxn)==PD_OK){
			if(GetField_Int(hTxn,"fundsout_id",&iId)){
				sprintf(csId,"%d",iId);
				PutField_CString(hTxn,"td_batch_id",csId);

DEBUGLOG(("Authorize::call DBOLTransaction->UpdateDetail\n"));
				DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","UpdateDetail");
                                if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
DEBUGLOG(("Authorize::DBTransaction->UpdateDetail Failed\n"));
				}

				iCnt = 0;
				if(GetField_Int(hContext,"seb_ccy_cnt",&iCnt)){
DEBUGLOG(("Authorize::call DBFundsOutHistory insert [%d] record\n",iCnt));
				}

				for(i=0;i<iCnt;i++){
					dTmp = 0.0;
					sprintf(csTag,"from_ccy_%d",i);
					if(GetField_CString(hContext,csTag,&csTmp)){
						PutField_CString(hTxn,"from_ccy",csTmp);
					}
					sprintf(csTag,"fundout_amt_%d",i);
					if(GetField_Double(hContext,csTag,&dTmp)){
						PutField_Double(hTxn,"fundout_amt",dTmp);
					}
					sprintf(csTag,"old_bal_%d",i);
					if(GetField_Double(hContext,csTag,&dTmp)){
						PutField_Double(hTxn,"old_bal",dTmp);
					}
					sprintf(csTag,"new_bal_%d",i);
					if(GetField_Double(hContext,csTag,&dTmp)){
						PutField_Double(hTxn,"new_bal",dTmp);
					}
					DBObjPtr = CreateObj(DBPtr,"DBFundsOutHistory","Add");
					if((unsigned long)(*DBObjPtr)(hTxn)!=PD_OK){
DEBUGLOG(("Authorize::DBFundsOutHistory->Add Failed\n"));
					}
				}
			}

		}

		FREE_ME(hTxn);
	}

/*
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
*/
	FREE_ME(csTxnCountry);
DEBUGLOG(("TxnOmtByUsOPF Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
