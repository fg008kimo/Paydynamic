/*
Partnerdelight (c)2014. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/07/21              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsACN.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

#include "sha1.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);

void TxnOmtByUsACN(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		const hash_t* hRequest,
		hash_t* hResponse)
{
	int iRet = PD_OK;
	int iTmpRet;

	hash_t *hFromBaid, *hToBaid, *hBankAcct, *hTmp;

	hFromBaid = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hFromBaid, 0);

	hToBaid = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hToBaid, 0);

	hBankAcct = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hBankAcct, 0);

	hTmp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTmp, 0);

	char *csFromBaid = NULL;
	char *csToBaid = NULL;
	char *csFromPspId = NULL;
	char *csToPspId = NULL;
	char *csAddUser = NULL;
	char *csIntBankCode = NULL;
	char *csBankAcctNum = NULL;
	char *csBankAcctType = NULL;
	char *csTmp = NULL;
	char *csCcy = NULL;
	char csCountry[PD_COUNTRY_LEN + 1];

	char csFrTxnSeq[PD_TXN_SEQ_LEN + 1];
	char csToTxnSeq[PD_TXN_SEQ_LEN + 1];
	char csTxnDateTime[PD_DATETIME_LEN + 1];

	double dOrgBal = 0.0;
	int iNegBalInd = 0;
	double dNewBal = 0.0;

	char cExParty;
	double dExRate;

	time_t tNow;
	struct tm * tStruct;
	char csBuf[PD_TMP_BUF_LEN];

DEBUGLOG(("TxnOmtByUsACN:: Authorize\n"));

// fr_baid
	if (GetField_CString(hRequest, "fr_baid", &csFromBaid)) {
DEBUGLOG(("Authorize:: fr_baid = [%s]\n", csFromBaid));
		PutField_CString(hFromBaid, "new_baid", csFromBaid);
	} else {
DEBUGLOG(("Authorize:: fr_baid not found!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: fr_baid not found!!\n");
		iRet = INT_ERR;
		PutField_Int(hContext, "internal_error", iRet);
	}

// to_psp_id
	if (GetField_CString(hRequest, "to_psp_id", &csToPspId)) {
DEBUGLOG(("Authorize:: to_psp_id = [%s]\n", csToPspId));
		PutField_CString(hToBaid, "psp_id", csToPspId);
	} else {
DEBUGLOG(("Authorize:: to_psp_id not found!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: to_psp_id not found!!\n");
		iRet = INT_ERR;
		PutField_Int(hContext, "internal_error", iRet);
	}

// add_user
	if (GetField_CString(hRequest, "add_user", &csAddUser)) {
DEBUGLOG(("Authorize:: add_user = [%s]\n", csAddUser));
		PutField_CString(hFromBaid, "add_user", csAddUser);
		PutField_CString(hToBaid, "add_user", csAddUser);
		PutField_CString(hBankAcct, "add_user", csAddUser);
	} else {
DEBUGLOG(("Authorize:: default add_user = [%s]\n", PD_UPDATE_USER));
		PutField_CString(hFromBaid, "add_user", PD_UPDATE_USER);
		PutField_CString(hToBaid, "add_user", PD_UPDATE_USER);
		PutField_CString(hBankAcct, "add_user", PD_UPDATE_USER);
		strcpy(csAddUser, PD_UPDATE_USER);
	}

// get fr_baid record
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: call DBOLBankAcctId: GetBankAcctIdDtl\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetBankAcctIdDtl");
		if ((unsigned long)(*DBObjPtr)(csFromBaid, hFromBaid) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLBankAcctId: GetBankAcctIdDtl failed!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLBankAcctId: GetBankAcctIdDtl failed!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		} else {
			if (GetField_CString(hFromBaid, "int_bank_code", &csIntBankCode)) {
DEBUGLOG(("Authorize:: int_bank_code = [%s]\n", csIntBankCode));
				PutField_CString(hToBaid, "int_bank_code", csIntBankCode);
				PutField_CString(hBankAcct, "int_bank_code", csIntBankCode);
			} else {
DEBUGLOG(("Authorize:: int_bank_code not found!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: int_bank_code not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}

			if (GetField_CString(hFromBaid, "bank_acct_num", &csBankAcctNum)) {
DEBUGLOG(("Authorize:: bank_acct_num = [%s]\n", csBankAcctNum));
				PutField_CString(hToBaid, "bank_acct_num", csBankAcctNum);
				PutField_CString(hBankAcct, "new_acct_num", csBankAcctNum);
			} else {
DEBUGLOG(("Authorize:: bank_acct_num not found!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: bank_acct_num not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}

			if (GetField_CString(hFromBaid, "psp_id", &csFromPspId)) {
DEBUGLOG(("Authorize:: fr_psp_id = [%s]\n", csFromPspId));
			} else {
DEBUGLOG(("Authorize:: fr_psp_id not found!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: fr_psp_id not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

// get bank accts
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: call DBOLBankAccts: GetBankAccts\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBankAccts", "GetBankAccts");
		if ((unsigned long)(*DBObjPtr)(csIntBankCode, csBankAcctNum, hTmp) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLBankAccts: GetBankAccts failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLBankAccts: GetBankAccts failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		} else {
			if (GetField_CString(hTmp, "reg_mob_num", &csTmp)) {
DEBUGLOG(("Authorize:: bank reg_mob_num = [%s]\n", csTmp));
				PutField_CString(hBankAcct, "reg_mob_num", csTmp);
			}

			if (GetField_CString(hTmp, "owner_id", &csTmp)) {
DEBUGLOG(("Authorize:: bank owner_id = [%s]\n", csTmp));
				PutField_CString(hBankAcct, "owner_id", csTmp);
			}

			if (GetField_CString(hTmp, "branch_code", &csTmp)) {
DEBUGLOG(("Authorize:: bank branch_code = [%s]\n", csTmp));
				PutField_CString(hBankAcct, "branch_code", csTmp);
			}

			if (GetField_CString(hTmp, "swift_code", &csTmp)) {
DEBUGLOG(("Authorize:: bank swift_code = [%s]\n", csTmp));
				PutField_CString(hBankAcct, "swift_code", csTmp);
			}

			if (GetField_CString(hTmp, "acct_remark", &csTmp)) {
DEBUGLOG(("Authorize:: bank acct_remark = [%s]\n", csTmp));
				PutField_CString(hBankAcct, "remark", csTmp);
			}

			if (GetField_CString(hTmp, "acct_ccy", &csCcy)) {
DEBUGLOG(("Authorize:: bank acct_ccy = [%s]\n", csCcy));
			} else {
DEBUGLOG(("Authorize:: bank acct_ccy not found!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: bank acct_ccy not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

// get bank country
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: call DBBankDesc: GetBankCountry\n"));
		DBObjPtr = CreateObj(DBPtr, "DBBankDesc", "GetBankCountry");
		iTmpRet = (unsigned long)(*DBObjPtr)(csIntBankCode, csCountry);
		if (iTmpRet != FOUND) {
DEBUGLOG(("Authorize:: call DBBankDesc: GetBankCountry failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBBankDesc: GetBankCountry failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		} else {
DEBUGLOG(("Authorize:: bank country = [%s]\n", csCountry));
		}
	}

// get to_psp_id record
	if (iRet == PD_OK) {
		hash_destroy(hTmp);
		hash_init(hTmp, 0);

DEBUGLOG(("Authorize:: call DBOLPspDetail: GetPspDetail\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLPspDetail", "GetPspDetail");
		if ((unsigned long)(*DBObjPtr)(csToPspId, hTmp) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLPspDetail: GetPspDetail failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLPspDetail: GetPspDetail failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		} else {
			if (GetField_CString(hTmp, "bank_acct_type", &csBankAcctType)) {
DEBUGLOG(("Authorize:: to_psp_id bank_acct_type = [%s]\n", csBankAcctType));
				PutField_CString(hBankAcct, "acct_type", csBankAcctType);
			} else {
DEBUGLOG(("Authorize:: to_psp_id bank_acct_type not found!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: to_psp_id bank_acct_type not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

// close fr_baid record
	if (iRet == PD_OK) {
		PutField_CString(hFromBaid, "action", "Update");
		PutField_CString(hFromBaid, "status", PD_BAID_STATUS_CLOSE);

DEBUGLOG(("Authorize:: call TxnOmtByUsBAI: Authorize\n"));
		TxnObjPtr = CreateObj(TxnPtr, "TxnOmtByUsBAI", "Authorize");
		if ((unsigned long)(*TxnObjPtr)(hContext, hFromBaid, hResponse) != PD_OK) {
DEBUGLOG(("Authorize:: call TxnOmtByUsBAI: Authorize failed!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call TxnOmtByUsBAI: Authorize failed!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

// update bank acct
	if (iRet == PD_OK) {
		PutField_CString(hBankAcct, "action", "Update");

DEBUGLOG(("Authorize:: call TxnOmtByUsBKA: Authorize\n"));
		TxnObjPtr = CreateObj(TxnPtr, "TxnOmtByUsBKA", "Authorize");
		if ((unsigned long)(*TxnObjPtr)(hContext, hBankAcct, hResponse) != PD_OK) {
DEBUGLOG(("Authorize:: call TxnOmtByUsBKA: Authorize failed!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call TxnOmtByUsBKA: Authorize failed!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

// create new BAID record
	if (iRet == PD_OK) {
		PutField_CString(hToBaid, "action", "Add");
		PutField_CString(hToBaid, "status", PD_BAID_STATUS_OPEN);
		PutField_CString(hToBaid, "init_bal", "0.00");

DEBUGLOG(("Authorize:: call TxnOmtByUsBAI: Authorize\n"));
		TxnObjPtr = CreateObj(TxnPtr, "TxnOmtByUsBAI", "Authorize");
		if ((unsigned long)(*TxnObjPtr)(hContext, hToBaid, hResponse) != PD_OK) {
DEBUGLOG(("Authorize:: call TxnOmtByUsBAI: Authorize failed!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call TxnOmtByUsBAI: Authorize failed!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		} else {
			if (GetField_CString(hResponse, "new_baid", &csToBaid)) {
DEBUGLOG(("Authorize:: to_baid = [%s]\n", csToBaid));
			} else {
DEBUGLOG(("Authorize:: to_baid not found!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: to_baid not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

// lock fr_baid bal
	if (iRet == PD_OK) {
		hash_destroy(hTmp);
		hash_init(hTmp, 0);

DEBUGLOG(("Authorize:: call DBOLBAIDBal: GetBalanceForUpdate\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBAIDBal", "GetBalanceForUpdate");
		if ((unsigned long)(*DBObjPtr)(csFromBaid, csCountry, csCcy, hTmp) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLBAIDBal: GetBalanceForUpdate failed!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLBAIDBal: GetBalanceForUpdate failed!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		} else {
			if (GetField_Double(hTmp, "balance", &dOrgBal)) {
DEBUGLOG(("Authorize:: fr_baid balance = [%f]\n", dOrgBal));

				if (dOrgBal < 0) {
					iNegBalInd = 1;
					dNewBal = dOrgBal * -1;
				} else {
					dNewBal = dOrgBal;
				}
			} else {
DEBUGLOG(("Authorize:: fr_baid balance not found!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: fr_baid balance not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

// get exchange info
	if (iRet == PD_OK) {
		hash_destroy(hTmp);
		hash_init(hTmp, 0);

		PutField_Int(hTmp, "init_mode", 1);
		PutField_Double(hTmp, "org_txn_amt", dOrgBal);
		PutField_CString(hTmp, "txn_ccy", csCcy);
		PutField_CString(hTmp, "dst_txn_ccy", csCcy);
		PutField_CString(hTmp, "org_txn_code", "BTO");
		PutField_CString(hTmp, "org_txn_country", csCountry);
		PutField_CString(hTmp, "org_txn_ccy", csCcy);
		GetField_CString(hContext, "channel_code", &csTmp);
		PutField_CString(hTmp, "org_channel_code", csTmp);

DEBUGLOG(("Authorize:: call BOExchange: GetExchangeInfo\n"));
		BOObjPtr = CreateObj(BOPtr, "BOExchange", "GetExchangeInfo");
		if ((unsigned long)(*BOObjPtr)(hTmp, hTmp) != PD_OK) {
DEBUGLOG(("Authorize:: call BOExchange: GetExchangeInfo failed!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call BOExchange: GetExchangeInfo failed!!\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		} else {
			if (GetField_Char(hTmp, "ex_party", &cExParty)) {
DEBUGLOG(("Authorize:: ex_party = [%c]\n", cExParty));
			} else {
DEBUGLOG(("Authorize:: ex_party not found!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: ex_party not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}

			if (GetField_Double(hTmp, "ex_rate", &dExRate)) {
DEBUGLOG(("Authorize:: ex_rate = [%f]\n", dExRate));
			} else {
DEBUGLOG(("Authorize:: ex_rate not found!!\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: ex_rate not found!!\n");
				iRet = INT_ERR;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

/*
// add fr_baid balance transfer out txn
	if (iRet == PD_OK) {
		hash_destroy(hTmp);
		hash_init(hTmp, 0);

		PutField_Int(hTmp, "db_commit", PD_FALSE);

		// get baid_txn_seq
DEBUGLOG(("Authorize:: call DBOLTxnSeq: GetNextBaidTxnSeq\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextBaidTxnSeq");
		strcpy(csFrBaidTxnSeq, (*DBObjPtr)());
		PutField_CString(hTmp, "txn_seq", csFrBaidTxnSeq);

		// channel_code
		GetField_CString(hContext, "channel_code", &csTmp);
		PutField_CString(hTmp, "channel_code", csTmp);

		// status
		PutField_Char(hTmp, "status", PD_COMPLETE);

		// ar_ind
		PutField_Char(hTmp, "ar_ind", PD_ACCEPT);

		// sub_status
		PutField_CString(hTmp, "sub_status", PD_APPROVED);

		// stat_txn_id
		// not available

		// txn_code
		PutField_CString(hTmp, "txn_code", "BTO");

		// pid
		PutField_CString(hTmp, "pid", csFromPspId);

		// baid
		PutField_CString(hTmp, "baid", csFromBaid);

		// host_posting_date
		if (GetField_CString(hContext, "PHDATE", &csTmp)) {
			PutField_CString(hTmp, "posting_date", csTmp);
		}

		// transmission_datetime
		if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
			strcpy(csTxnDateTime, csTmp);
			PutField_CString(hTmp, "transmission_datetime", csTxnDateTime);
		}
		if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
			strcat(csTxnDateTime, csTmp);
			PutField_CString(hTmp, "transmission_datetime", csTxnDateTime);
		}

		// txn_ccy
		PutField_CString(hTmp, "txn_ccy", csCcy);

		// txn_amt
		PutField_Double(hTmp, "txn_amt", dOrgBal);

		// open_bal
		PutField_Double(hTmp, "open_bal", dOrgBal);

		// curr_bal
		PutField_Double(hTmp, "curr_bal", 0.00);

		// approval_date & approval_timestamp
		DBObjPtr = CreateObj(DBPtr, "DBSystemControl", "GetApprovalDT");
		(*DBObjPtr)(hTmp);

		// bank_code
		PutField_CString(hTmp, "bank_code", csIntBankCode);

		// bank_acct_num
		PutField_CString(hTmp, "bank_acct_num", csBankAcctNum);

		// pid_txn_hold_ind
		PutField_Int(hTmp, "pid_txn_hold_ind", 0);

		// pid_sys_match_ind
		PutField_Int(hTmp, "pid_sys_match_ind", 1);

		// posted_ind
		PutField_Int(hTmp, "posted_ind", 0);

		// create_user
		PutField_CString(hTmp, "add_user", csAddUser);

DEBUGLOG(("Authorize:: call DBOLBAIDTxn: Add\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Add");
		if ((unsigned long)(*DBObjPtr)(hTmp) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLBAIDTxn: Add failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLBAIDTxn: Add failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}
*/

// add fr_baid balance transfer out ol_txn_header
	if (iRet == PD_OK) {
		hash_destroy(hTmp);
		hash_init(hTmp, 0);

		PutField_Int(hTmp, "db_commit", PD_FALSE);

		// txn_id
DEBUGLOG(("Authorize:: call DBOLTxnSeq: GetNextOmtTxnSeq\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextOmtTxnSeq");
		strcpy(csFrTxnSeq, (*DBObjPtr)());
		PutField_CString(hTmp, "txn_seq", csFrTxnSeq);

		// input_channel
		GetField_CString(hContext, "channel_code", &csTmp);
		PutField_CString(hTmp, "channel_code", csTmp);

		// status
		PutField_Char(hTmp, "status", PD_TO_PSP);

		// txn_code
		PutField_CString(hTmp, "txn_code", "BTO");

		// process_type
		PutField_CString(hTmp, "process_type", "0000");

		// process_code
		PutField_CString(hTmp, "process_code", "000000");

		// host_posting_date
		if (GetField_CString(hContext, "PHDATE", &csTmp)) {
			PutField_CString(hTmp, "host_posting_date", csTmp);
		}

		// internal_code
		PutField_Int(hTmp, "internal_code", 0);

		// response_code
		PutField_CString(hTmp, "response_code", "0");

		// transaction_amount
		PutField_Double(hTmp, "txn_amt", dOrgBal);

		// transmission_datetime
		// local_tm_date
		// local_tm_time
		// tm_date
		// tm_time
		if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
			PutField_CString(hTmp, "local_tm_date", csTmp);
			strcpy(csTxnDateTime, csTmp);
			PutField_CString(hTmp, "transmission_datetime", csTxnDateTime);
			PutField_CString(hTmp, "tm_date", csTmp);
		}
		if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
			PutField_CString(hTmp, "local_tm_time", csTmp);
			strcat(csTxnDateTime, csTmp);
			PutField_CString(hTmp, "transmission_datetime", csTxnDateTime);
			PutField_CString(hTmp, "tm_time", csTmp);
		}

		// create_user
		PutField_CString(hTmp, "add_user", csAddUser);

DEBUGLOG(("Authorize:: call DBOLTransaction: Add\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Add");
		if ((unsigned long)(*DBObjPtr)(hTmp) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLTransaction: Add failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLTransaction: Add failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

// add fr_baid balance transfer out ol_txn_psp_detail
	if (iRet == PD_OK) {
		// psp_id
		PutField_CString(hTmp, "psp_id", csFromPspId);

		// baid
		PutField_CString(hTmp, "baid", csFromBaid);

		// txn_ccy
		PutField_CString(hTmp, "txn_ccy", csCcy);

		// txn_amount
		PutField_Double(hTmp, "txn_amount", dOrgBal);

		tNow = time(0);
		tStruct = localtime(&tNow);

		// txn_date
		strftime(csBuf, sizeof(csBuf), "%Y%m%d", tStruct);
		PutField_CString(hTmp, "txn_date", csBuf);

		// txn_time
		strftime(csBuf, sizeof(csBuf), "%H%M%S", tStruct);
		PutField_CString(hTmp, "txn_time", csBuf);

		// bank_code
		PutField_CString(hTmp, "bank_code", csIntBankCode);

		// bank_acct_num
		PutField_CString(hTmp, "bank_acct_num", csBankAcctNum);

		// cost
		PutField_Double(hTmp, "cost", 0.0);

		// open_bal
		PutField_Double(hTmp, "open_bal", dOrgBal);

		// total_hold
		PutField_Double(hTmp, "total_hold", 0.0);

		// bal
		PutField_Double(hTmp, "bal", 0.0);

		// pending_fund
		PutField_Double(hTmp, "pending_fund", 0.0);

		// txn_hold_ind
		PutField_Int(hTmp, "txn_hold_ind", 0);

		// sys_match_ind
		PutField_Int(hTmp, "sys_match_ind", 1);

DEBUGLOG(("Authorize:: call DBOLTxnPspDetail: Add\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Add");
		if ((unsigned long)(*DBObjPtr)(hTmp) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLTxnPspDetail: Add failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLTxnPspDetail: Add failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

// add fr_baid balance transfer out ol_txn_elements
	if (iRet == PD_OK) {
		// txn_element_type
		PutField_CString(hTmp, "txn_element_type", PD_ELEMENT_TXN_AMT);

		// amount
		PutField_Double(hTmp, "amount", dOrgBal);

		// ccy
		PutField_CString(hTmp, "ccy", csCcy);

		// amt_type
		PutField_CString(hTmp, "amount_type", PD_DR);

		// party_type
		PutField_Char(hTmp, "party_type", PD_TYPE_PSP);

DEBUGLOG(("Authorize:: call DBOLTxnElements: Add\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnElements", "Add");
		if ((unsigned long)(*DBObjPtr)(hTmp) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLTxnElements: Add failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLTxnElements: Add failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

// update fr_baid balance transfer out ol_txn_header
	if (iRet == PD_OK) {
		// status
		PutField_Char(hTmp, "status", PD_COMPLETE);

		// ar_ind
		PutField_Char(hTmp, "ar_ind", PD_ACCEPT);

		// sub_status
		PutField_CString(hTmp, "sub_status", PD_APPROVED);

		// net_amt
		PutField_Double(hTmp, "net_amt", dOrgBal);

		// net_ccy
		PutField_CString(hTmp, "net_ccy", csCcy);

		// ex_supplier
		PutField_Char(hTmp, "ex_supplier", cExParty);

		// ex_rate
		PutField_Double(hTmp, "ex_rate", dExRate);

		// approval_date & approval_timestamp
		DBObjPtr = CreateObj(DBPtr, "DBSystemControl", "GetApprovalDT");
		(*DBObjPtr)(hTmp);

DEBUGLOG(("Authorize:: call DBOLTransaction: Update\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
		if ((unsigned long)(*DBObjPtr)(hTmp) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLTransaction: Update failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLTransaction: Update failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

// update fr_baid bal
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: call DBOLBAIDBal: UpdateBalance\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBAIDBal", "UpdateBalance");
		if ((unsigned long)(*DBObjPtr)(csFromBaid, csCountry, csCcy, PD_IND_DEBIT, dOrgBal, csAddUser) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLBAIDBal: UpdateBalance failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLBAIDBal: UpdateBalance failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

/*
// post fr_baid txn
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: call BOOLBaid: PostBaidTxn\n"));
		BOObjPtr = CreateObj(BOPtr, "BOOLBaid", "PostBaidTxn");
		if ((unsigned long)(*BOObjPtr)(csFrBaidTxnSeq) != PD_OK) {
DEBUGLOG(("Authorize:: call BOOLBaid: PostBaidTxn failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call BOOLBaid: PostBaidTxn failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}
*/

/*
// add to_baid balance transfer in txn
	if (iRet == PD_OK) {
		hash_destroy(hTmp);
		hash_init(hTmp, 0);

		PutField_Int(hTmp, "db_commit", PD_FALSE);

		// get baid_txn_seq
DEBUGLOG(("Authorize:: call DBOLTxnSeq: GetNextBaidTxnSeq\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextBaidTxnSeq");
		strcpy(csToBaidTxnSeq, (*DBObjPtr)());
		PutField_CString(hTmp, "txn_seq", csToBaidTxnSeq);

		// org_txn_seq
		PutField_CString(hTmp, "org_txn_seq", csFrBaidTxnSeq);

		// channel_code
		GetField_CString(hContext, "channel_code", &csTmp);
		PutField_CString(hTmp, "channel_code", csTmp);

		// status
		PutField_Char(hTmp, "status", PD_COMPLETE);

		// ar_ind
		PutField_Char(hTmp, "ar_ind", PD_ACCEPT);

		// sub_status
		PutField_CString(hTmp, "sub_status", PD_APPROVED);

		// stat_txn_id
		// not available

		// txn_code
		PutField_CString(hTmp, "txn_code", "BTI");

		// pid
		PutField_CString(hTmp, "pid", csToPspId);

		// baid
		PutField_CString(hTmp, "baid", csToBaid);

		// host_posting_date
		if (GetField_CString(hContext, "PHDATE", &csTmp)) {
			PutField_CString(hTmp, "posting_date", csTmp);
		}

		// transmission_datetime
		if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
			strcpy(csTxnDateTime, csTmp);
			PutField_CString(hTmp, "transmission_datetime", csTxnDateTime);
		}
		if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
			strcat(csTxnDateTime, csTmp);
			PutField_CString(hTmp, "transmission_datetime", csTxnDateTime);
		}

		// txn_ccy
		PutField_CString(hTmp, "txn_ccy", csCcy);

		// txn_amt
		PutField_Double(hTmp, "txn_amt", dOrgBal);

		// open_bal
		PutField_Double(hTmp, "open_bal", 0.00);

		// curr_bal
		PutField_Double(hTmp, "curr_bal", dOrgBal);

		// approval_date & approval_timestamp
		DBObjPtr = CreateObj(DBPtr, "DBSystemControl", "GetApprovalDT");
		(*DBObjPtr)(hTmp);

		// bank_code
		PutField_CString(hTmp, "bank_code", csIntBankCode);

		// bank_acct_num
		PutField_CString(hTmp, "bank_acct_num", csBankAcctNum);

		// pid_txn_hold_ind
		PutField_Int(hTmp, "pid_txn_hold_ind", 0);

		// pid_sys_match_ind
		PutField_Int(hTmp, "pid_sys_match_ind", 1);

		// posted_ind
		PutField_Int(hTmp, "posted_ind", 0);

		// create_user
		PutField_CString(hTmp, "add_user", csAddUser);

DEBUGLOG(("Authorize:: call DBOLBAIDTxn: Add\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Add");
		if ((unsigned long)(*DBObjPtr)(hTmp) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLBAIDTxn: Add failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLBAIDTxn: Add failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}
*/

// add to_baid balance transfer in ol_txn_header
	if (iRet == PD_OK) {
		// txn_id
DEBUGLOG(("Authorize:: call DBOLTxnSeq: GetNextOmtTxnSeq\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextOmtTxnSeq");
		strcpy(csToTxnSeq, (*DBObjPtr)());
		PutField_CString(hTmp, "txn_seq", csToTxnSeq);

		// org_txn_id
		PutField_CString(hTmp, "org_txn_seq", csFrTxnSeq);

		// status
		PutField_Char(hTmp, "status", PD_TO_PSP);

		// txn_code
		PutField_CString(hTmp, "txn_code", "BTI");

		// host_posting_date
		if (GetField_CString(hContext, "PHDATE", &csTmp)) {
			PutField_CString(hTmp, "host_posting_date", csTmp);
		}

		RemoveField_Char(hTmp, "ar_ind");
		RemoveField_CString(hTmp, "sub_status");
		RemoveField_Double(hTmp, "net_amt");
		RemoveField_CString(hTmp, "net_ccy");
		RemoveField_Char(hTmp, "ex_supplier");
		RemoveField_Double(hTmp, "ex_rate");
		RemoveField_CString(hTmp, "approval_date");
		RemoveField_CString(hTmp, "approval_timestamp");

DEBUGLOG(("Authorize:: call DBOLTransaction: Add\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Add");
		if ((unsigned long)(*DBObjPtr)(hTmp) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLTransaction: Add failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLTransaction: Add failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

// add to_baid balance transfer in ol_txn_psp_detail
	if (iRet == PD_OK) {
		// psp_id
		PutField_CString(hTmp, "psp_id", csToPspId);

		// baid
		PutField_CString(hTmp, "baid", csToBaid);

		tNow = time(0);
		tStruct = localtime(&tNow);

		// txn_date
		strftime(csBuf, sizeof(csBuf), "%Y%m%d", tStruct);
		PutField_CString(hTmp, "txn_date", csBuf);

		// txn_time
		strftime(csBuf, sizeof(csBuf), "%H%M%S", tStruct);
		PutField_CString(hTmp, "txn_time", csBuf);

		// open_bal
		PutField_Double(hTmp, "open_bal", 0.0);

		// bal
		PutField_Double(hTmp, "bal", dOrgBal);

DEBUGLOG(("Authorize:: call DBOLTxnPspDetail: Add\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Add");
		if ((unsigned long)(*DBObjPtr)(hTmp) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLTxnPspDetail: Add failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLTxnPspDetail: Add failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

// add to_baid balance transfer in ol_txn_elements
	if (iRet == PD_OK) {
		// amt_type
		PutField_CString(hTmp, "amount_type", PD_CR);

DEBUGLOG(("Authorize:: call DBOLTxnElements: Add\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnElements", "Add");
		if ((unsigned long)(*DBObjPtr)(hTmp) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLTxnElements: Add failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLTxnElements: Add failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

// update to_baid balance transfer in ol_txn_header
	if (iRet == PD_OK) {
		// status
		PutField_Char(hTmp, "status", PD_COMPLETE);

		// ar_ind
		PutField_Char(hTmp, "ar_ind", PD_ACCEPT);

		// sub_status
		PutField_CString(hTmp, "sub_status", PD_APPROVED);

		// net_amt
		PutField_Double(hTmp, "net_amt", dOrgBal);

		// net_ccy
		PutField_CString(hTmp, "net_ccy", csCcy);

		// ex_supplier
		PutField_Char(hTmp, "ex_supplier", cExParty);

		// ex_rate
		PutField_Double(hTmp, "ex_rate", dExRate);

		// approval_date & approval_timestamp
		DBObjPtr = CreateObj(DBPtr, "DBSystemControl", "GetApprovalDT");
		(*DBObjPtr)(hTmp);

DEBUGLOG(("Authorize:: call DBOLTransaction: Update\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
		if ((unsigned long)(*DBObjPtr)(hTmp) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLTransaction: Update failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLTransaction: Update failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

// update to_baid bal
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: call DBOLBAIDBal: UpdateBalance\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBAIDBal", "UpdateBalance");
		if ((unsigned long)(*DBObjPtr)(csToBaid, csCountry, csCcy, PD_IND_CREDIT, dOrgBal, csAddUser) != PD_OK) {
DEBUGLOG(("Authorize:: call DBOLBAIDBal: UpdateBalance failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call DBOLBAIDBal: UpdateBalance failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}

/*
// post to_baid txn
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: call BOOLBaid: PostBaidTxn\n"));
		BOObjPtr = CreateObj(BOPtr, "BOOLBaid", "PostBaidTxn");
		if ((unsigned long)(*BOObjPtr)(csToBaidTxnSeq) != PD_OK) {
DEBUGLOG(("Authorize:: call BOOLBaid: PostBaidTxn failed\n"));
ERRLOG("TxnOmtByUsACN:: Authorize:: call BOOLBaid: PostBaidTxn failed\n");
			iRet = INT_ERR;
			PutField_Int(hContext, "internal_error", iRet);
		}
	}
*/

	hash_destroy(hFromBaid);
	FREE_ME(hFromBaid);

	hash_destroy(hToBaid);
	FREE_ME(hToBaid);

	hash_destroy(hBankAcct);
	FREE_ME(hBankAcct);

	hash_destroy(hTmp);
	FREE_ME(hTmp);

DEBUGLOG(("TxnOmtByUsACN Normal Exit() iRet = [%d]\n", iRet));
	return iRet;
}
