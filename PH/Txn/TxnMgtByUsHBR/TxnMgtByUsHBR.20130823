/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/08/22              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsHBR.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnMgtByUsHBR(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;

        char        *csTmp = NULL;
        char        *csMerchantId = NULL;

        char        *csService = NULL;
        char        *csTxnCountry = NULL;
        char        *csTxnCcy = NULL;
        char        *csUpdateUser = NULL;  
        double       dAmt=0.0;

	int	    iTmp;
	double      dTmp =0.0;

	char	    cDCInd;


/* txn_seq */
        if(GetField_CString(hContext,"txn_seq",&csTmp)){
                PutField_CString(hResponse,"org_txn_seq",csTmp);
DEBUGLOG(("Authorize::txn_seq= [%s]\n",csTmp));
		PutField_CString(hContext, "from_txn_seq", csTmp);
        }
        else{
DEBUGLOG(("Authorize::txnid not found!!\n"));
ERRLOG("TxnMgtByUsHBR::Authorize::txnid not found!!\n");
                iRet=INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* add_user*/
        if(GetField_CString(hRequest,"add_user",&csUpdateUser)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csUpdateUser));
                PutField_CString(hContext,"add_user",csUpdateUser);
                PutField_CString(hContext,"update_user",csUpdateUser);
        }

/* remark */
        if(GetField_CString(hRequest,"remark",&csTmp)){
DEBUGLOG(("Authorize::remark = [%s]\n",csTmp));
                PutField_CString(hContext,"remark",csTmp);
        }


/* merchant_id */
        if(GetField_CString(hRequest,"merchant_id",&csMerchantId)){
DEBUGLOG(("Authorize::merchant_id = [%s]\n",csMerchantId));
                PutField_CString(hContext,"merchant_id",csMerchantId);
        }
	else {
DEBUGLOG(("Authorize::merchant_id not found!!\n"));
ERRLOG("TxnMgtByUsHBR::Authorize::merchant_id not found!!\n");
		iRet = INT_MERCHANT_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
	}

/* service_code */
        if(GetField_CString(hRequest,"service_code",&csService)){
DEBUGLOG(("Authorize::service = [%s]\n",csService));
                PutField_CString(hContext,"service_code",csService);
        }
        else {
DEBUGLOG(("Authorize::service_code not found!!\n"));
ERRLOG("TxnMgtByUsHBR::Authorize::serivce_code not found!!\n");
                iRet = INT_SERVICE_CODE_MISSING;

                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_country */
	if(GetField_CString(hRequest,"txn_country",&csTxnCountry)){
                PutField_CString(hContext,"txn_country",csTxnCountry);
DEBUGLOG(("Authorize::txn_country= [%s]\n",csTxnCountry));
        }
        else{
DEBUGLOG(("Authorize::country not found!!\n"));
ERRLOG("TxnMgtByUsHBR::Authorize::country not found!!\n");
                iRet=INT_TXN_COUNTRY_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_ccy */
        if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTxnCcy));
                PutField_CString(hContext,"txn_ccy",csTxnCcy);
        }
        else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMgtByUsHBR::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;

		PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_amt */
        if(GetField_Double(hContext,"txn_amt",&dAmt)){
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dAmt));
		PutField_Double(hContext, "net_amt", dAmt);
        }
        else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMgtByUsHBR::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;

		PutField_Int(hContext,"internal_error",iRet);
        }

        PutField_CString(hContext,"process_code","000000");
        PutField_CString(hContext,"process_type","0000");
	PutField_CString(hContext, "sub_status", PD_APPROVED);

	PutField_CString(hContext, "hb_dc_type", PD_IND_CREDIT);


        //Handle Balance
        if (iRet == PD_OK) {
		iRet = UpdateFixedAmtHoldBack(hContent);
	}
        


	//Update Balance
        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call BOAdjustment:ProcessPartyBalance\n"));
                BOObjPtr = CreateObj(BOPtr,"BOAdjustment","ProcessPartyBalance");
		iRet = (unsigned long)((*BOObjPtr)(hContext));

		if (iRet != PD_OK) {
DEBUGLOG(("Authorize::BOAdjustment:ProcessPartyBalance Failed Ret [%d]\n", iRet));
ERRLOG("TxnMgtByUsHBR::BOADjustment::ProcesspartyBalance Failed Ret [%d]\n", iRet);
		} else {	
			if (GetField_Char(hContext,"dc_ind",&cDCInd)) {
DEBUGLOG(("Authorize::dc_ind = [%c]\n", cDCInd));
				if (cDCInd == PD_ADJ_TYPE_CREDIT) {
					PutField_CString(hContext, "amount_type", PD_CR);
				}
				else if (cDCInd == PD_ADJ_TYPE_DEBIT) {
					PutField_CString(hContext, "amount_type", PD_DR);
				}

				if (GetField_Double(hContext, "merchant_open_bal", &dTmp)) {
DEBUGLOG(("Authorize::BOAdjustment:ProcessPartyBalance merchant_open_bal [%lf]\n", dTmp));
					PutField_Double(hContext, "open_bal", dTmp);
				}

				if (GetField_Double(hContext, "merchant_open_bal_settlement", &dTmp)) {
DEBUGLOG(("Authorize::BOAdjustment:ProcessPartyBalance merchant_open_bal_settlement [%lf]\n", dTmp));
					PutField_Double(hContext, "open_bal_settlement", dTmp);
				}
			}
			else {
DEBUGLOG(("Authorize::BOAdjustment:ProcessPartyBalance Failed to get dc_ind\n"));
ERRLOG("TxnMgtByUsHBR::BOADjustment::ProcesspartyBalance Failed to get dc_ind\n");
				iRet = PD_ERR;
			}


		}
        } 


       if(GetField_Int(hContext,"do_logging",&iTmp)){
DEBUGLOG(("Authorize::do_logging [%d]\n", iTmp));
                if(iTmp!=PD_ADD_LOG) {
			/* nothing */
		}
		else {

        		if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:AddDetail\n"));
		                DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                		if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK)
		                        iRet = INT_ERR;
			}
  
			/* 
	        	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:UpdateDetail\n"));
				DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
				if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK)
                        		iRet = INT_ERR;
			}
			*/

			if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call MGTChannel:UpdateTxnDetailLog\n"));
                		ChannelObjPtr = CreateObj(ChannelPtr, "MGTChannel","UpdateTxnDetailLog");
		                if ((unsigned long)((*ChannelObjPtr)(hContext, hRequest, hResponse)) != PD_OK) {
               		        	iRet = INT_ERR;
                		}
			}
		}

	}
	
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call BOTxnElements:AddTxnAmtElement\n"));
                BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnAmtElement");
		if ((unsigned long)((*BOObjPtr)(hContext)) != PD_OK) {
			iRet = INT_ERR;
		}

	}


        if (iRet == PD_OK) {
		PutField_CString(hContext, "amount_type", PD_DR);

DEBUGLOG(("Authorize::Call BOTxnElements:AddTxnFeeElements\n"));
                BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnFeeElements");
                if ((unsigned long)((*BOObjPtr)(hContext)) != PD_OK) {
                        iRet = INT_ERR;
                }

        }

	if(iRet!= PD_OK){
		RemoveField_CString(hContext, "sub_status");
		RemoveField_CString(hContext, "approval_date");
		RemoveField_CString(hContext, "approval_timestamp");
		
	}



DEBUGLOG(("TxnMgtByUsHBR Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}


int	ProcessFixedAmtHoldBack(hash_t *hContent)
{
	int	iRet = PD_OK;

        char    *csTxnCountry;
        char    *csTxnCcy;
        char    *csMerchantId;
        char    *csServiceCode;
        char    cDCType;
	double	dNetAmt = 0.0;

	double	dBal = 0.0;

        hash_t* hVal;
        hVal = (hash_t*) malloc (sizeof(hash_t));


DEBUGLOG(("BOBalance:UpdateFixedAmtHoldBack()\n"));

/*merchant id */
	if (GetField_CString(hContext,"merchant_id",&csMerchantId)) {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() merchant_id = [%s]\n",csMerchantId));
        }
        else {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() merchant_id is missing!!!\n"));
        }

/*txn country */
        if (GetField_CString(hContext,"txn_country",&csTxnCountry)) {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() txn_country = [%s]\n",csTxnCountry));
        }
        else {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() txn_country is missing!!!\n"));
        }

/*txn ccy */
	if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() txn_ccy = [%s]\n",csTxnCcy));
	}
	else {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() txn_ccy is missing!!!\n"));
	}

/*service Code */
        if (GetField_CString(hContext,"service_code",&csServiceCode)) {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() service_code = [%s]\n",csServiceCode));
        }
        else {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() service_code is missing!!!\n"));
        }

/* HD DC Ind */
        if (GetField_Char(hContext, "hb_dc_type", &cDCType)) {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() cDCType = [%c]\n",cDCType));
        }
        else {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() cDCType is missing !!!\n"));
        }


/* net amount */
        if (GetField_Double(hContext,"net_amt",&dNetAmt)) {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() net_amt = [%lf]\n",dNetAmt));
        }
        else {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() net_amt is missing!!!\n"));
        }


/* add user */
	if (GetField_CString(hContext, "add_user", &csUser)) {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() User = [%s]\n",csUser));
	}
	else {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() User is missing !!!\n"));
	}


	if (iRet == PD_OK) {
		if (cDCType == PD_IND_CREDIT) {
			// Get Remain Available Settlement is allow to reserved
			hash_init(hVal, 0);

DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack(): GetSettAvalBalance\n"));
			DBObjPtr = CreateObj(DBPtr, "DBMerchantBalance", "GetSettAvalBalance");
			if((unsigned long)(*DBObjPtr)(hVal, csMerchantId, csTxnCcy, csTxnCountry, csServiceCode, &dBal) != PD_OK){
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() GetBalance Failed !\n"));
				iRet = INT_ERR;
			} else {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() GetBalance [%lf]\n", dBal));
				dBal = newround(dBal, 2);

				if (dBal < dNetAmt) {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() Remain Ava Sett [%lf] Request Reserved [%lf] insufficient\n", dBal, dNetAmt);
					iRet = INT_INSUFFICIENT_FUND;
				} else {

					if (GetField_Double(hVal, "merchant_open_bal", &dTmp)) {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() GetOpenBalanceForUpdate open_bal = [%f]\n",dTmp));
						PutField_Double(hContext, "merchant_open_bal", dTmp);
                        		}
					else {
						PutField_Double(hContext, "merchant_open_bal", 0.0);
                        		}

					if (GetField_Double(hVal, "merchant_open_bal_settlement", &dTmp)) {
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() GetOpenBalanceForUpdate open_bal_settlement = [%f]\n",dTmp));
						PutField_Double(hContext, "merchant_open_bal_settlement", dTmp);
					}
					else {
						PutField_Double(hContext, "merchant_open_bal_settlement", 0.0);
					}

	                        /*** Update Context for approval date and approval timestamp ****/
       	                 DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
                        (*DBObjPtr)(hContext);
DEBUGLOG(("BOBalance:ProcessFixedAmtHoldBack() GetApprovalDT called\n"));
		}
		hash_destory(hVal);
	}

	if (iRet == PD_OK) {

		if (
	}

}
