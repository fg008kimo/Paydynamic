/*
Partnerdelight (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/10/03              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsTSI.h"
#include "myrecordset.h"
#include "dbutility.h"

#define	PD_IN_HOUR	1
#define	PD_IN_MINUTES	2

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnOmtByUsTSI(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	char    csTxnSeq[PD_TXN_SEQ_LEN +1];
        char    csOrgDateTime[PD_DATETIME_LEN +1];
        char*   csEncTxnSeq;
	char	*csTxnCode;
        char    *csOrgTxnCcy;
        char    *csOrgTxnCountry;
        char    *csClientId;
        char    *csOrgMerchantId;
        char    *csOrgChannelCode;
        char    *csOrgServiceCode;
	char	*csPtr;
        char*   csIpAddr;
        char*   csUserAgent;

	double 	dTxnAmt;
	recordset_t	*rRecordSet;

	hash_t  *hTxn, *hRec;
                
        hTxn = (hash_t*) malloc(sizeof(hash_t));
        hash_init(hTxn, 0);

DEBUGLOG(("Authorize\n"));

	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
DEBUGLOG(("Authorize()\n"));
        memset(csTxnSeq,0,PD_TXN_SEQ_LEN);

        if (GetField_CString(hRequest,"enc_txn_seq",&csEncTxnSeq)) {
DEBUGLOG(("Authorize() enc_txn_seq = [%s]\n",csEncTxnSeq));
                BOObjPtr = CreateObj(BOPtr,"BOSecurity","Decrypt3DESTxnSeq");
                (BOObjPtr)(csEncTxnSeq,csTxnSeq);
DEBUGLOG(("Authorize() txn_seq = [%s]\n",csTxnSeq));
                PutField_CString(hResponse,"org_txn_seq",csTxnSeq);
                PutField_CString(hContext,"org_txn_seq",csTxnSeq);
                PutField_CString(hTxn,"from_txn_seq",csTxnSeq);
        }
        else {
                iRet = INT_ENC_TXN_ID_MISSING;
DEBUGLOG(("Authorize() enc_txn_seq is missing\n"));
ERRLOG("TxnMgtByUsTSI::Authorize() enc_txn_seq is missing\n");
                PutField_Int(hContext,"internal_error",iRet);
        }

        if (iRet == PD_OK){
                if (GetField_CString(hRequest,"ip_addr",&csIpAddr)) {
DEBUGLOG(("Authorize() ip_addr = [%s]\n",csIpAddr));
                }
                if (GetField_CString(hRequest,"user_agent",&csUserAgent)) {
DEBUGLOG(("Authorize() user_agent = [%s]\n",csUserAgent));
                }
        }

	if (iRet == PD_OK) {
                recordset_init(rRecordSet,0);
                DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","GetTxnDetail");
                if ((DBObjPtr)(csTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("Authorize::txn detail found record = [%s]\n",csTxnSeq));
                        hRec = RecordSet_GetFirst(rRecordSet);
                        int iTxn =0;
                        while (hRec) {

                                 if (GetField_CString(hRec,"txn_country",&csOrgTxnCountry)) {
                                        PutField_CString(hTxn,"txn_country",csOrgTxnCountry);
DEBUGLOG(("Authorize::GetTxnDetail - txn country = [%s]\n",csOrgTxnCountry));
                                 }

                                 if (GetField_CString(hRec,"txn_ccy",&csOrgTxnCcy)) {
                                        PutField_CString(hTxn,"txn_country",csOrgTxnCcy);
DEBUGLOG(("Authorize::GetTxnDetail - txn Ccy = [%s]\n",csOrgTxnCcy));
                                 }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                        if (iTxn == 1) {
                                PutField_Int(hResponse,"single_pay_method",iTxn);
                        }
DEBUGLOG(("Authorize: itxn = [%d]\n",iTxn));
                 }
                RecordSet_Destroy(rRecordSet);
        }

	if (iRet == PD_OK) {
                recordset_init(rRecordSet,0);
                DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","GetTxnHeader");
                if ((DBObjPtr)(csTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("Authorize::txn Header found record = [%s]\n",csTxnSeq));
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
                                 if (GetField_CString(hRec,"txn_code",&csTxnCode)) {
                                        PutField_CString(hTxn,"txn_code",csTxnCode);
                                 }
                                 if (GetField_Double(hRec,"txn_amt",&dTxnAmt)) {
DEBUGLOG(("Authorize::GetTxnHeader - txn_amt = [%lf]\n",dTxnAmt));
                                        PutField_Double(hResponse,"txn_amt",dTxnAmt);
                                        PutField_Double(hTxn,"org_txn_amt",dTxnAmt);
                                        PutField_Double(hTxn,"txn_amt",dTxnAmt);
                                 }
                                 if (GetField_CString(hRec,"net_ccy",&csOrgTxnCcy)) {
                                        PutField_CString(hResponse,"txn_ccy",csOrgTxnCcy);
                                        PutField_CString(hTxn,"txn_ccy",csOrgTxnCcy);
                                        PutField_CString(hTxn,"org_txn_ccy",csOrgTxnCcy);
DEBUGLOG(("Authorize::GetTxnHeader - net_ccy = [%s]\n",csOrgTxnCcy));
                                 }
                                 if (GetField_CString(hRec,"client_id",&csClientId)) {
DEBUGLOG(("Authorize::GetTxnHeader - org_client_id = [%s]\n",csClientId));
                                        PutField_CString(hTxn,"merchant_client_id",csClientId);
                                 }
                                 if (GetField_CString(hRec,"merchant_id",&csOrgMerchantId)) {
                                        PutField_CString(hResponse,"merchant_id",csOrgMerchantId);
                                        PutField_CString(hTxn,"merchant_id",csOrgMerchantId);
DEBUGLOG(("Authorize::GetTxnHeader - merchant_id = [%s]\n",csOrgMerchantId));
                                 }
	       			 if (GetField_CString(hRec,"merchant_ref",&csPtr)) {
                                        PutField_CString(hResponse,"merchant_ref",csPtr);
                                 }
                                 if (GetField_CString(hRec,"channel_code",&csOrgChannelCode)) {
                                        PutField_CString(hTxn,"channel_code",csOrgChannelCode);
DEBUGLOG(("Authorize::GetTxnHeader - channel_code = [%s]\n",csOrgChannelCode));
                                 }
                                 if (GetField_CString(hRec,"service_code",&csOrgServiceCode)) {
                                        PutField_CString(hTxn,"service_code",csOrgServiceCode);
DEBUGLOG(("Authorize::GetTxnHeader - service code = [%s]\n",csOrgServiceCode));
                                 }
                                 if (GetField_CString(hRec,"local_tm_date",&csPtr)) {
DEBUGLOG(("Authorize::GetTxnHeader - local_tm_date = [%s]\n",csPtr));
                                        strcpy(csOrgDateTime,csPtr);
                                 }
                                 if (GetField_CString(hRec,"local_tm_time",&csPtr)) {
DEBUGLOG(("Authorize::GetTxnHeader - local_tm_time = [%s]\n",csPtr));
                                        memcpy(&csOrgDateTime[PD_DATE_LEN],csPtr,PD_TIME_LEN);
                                        csOrgDateTime[PD_DATETIME_LEN] = '\0';
DEBUGLOG(("Authorize::GetTxnHeader - org_local_tm_datetime = [%s]\n",csOrgDateTime));
                                        PutField_CString(hContext,"org_local_tm_datetime",csOrgDateTime);
                                 }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                 }
                RecordSet_Destroy(rRecordSet);
        }


	if  (iRet == PD_OK) {
                recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBOLBankAccts","GetDepositBanks");
                if ((DBObjPtr)(csOrgTxnCountry,csOrgTxnCcy,rRecordSet) == PD_OK) {
DEBUGLOG(("Called DBOLBankAccts\n"));
			int i = 0;
			char 	*csTag;
			csTag = (char*) malloc (PD_TAG_LEN +1);

			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec,"int_bank_code",&csPtr)) {
DEBUGLOG(("Bank Code = [%s]\n",csPtr));
				}
				i++;
				sprintf(csTag,"bank_code_%d",i);
				PutField_CString(hResponse,csTag,csPtr);
				hRec = RecordSet_GetNext(rRecordSet);
			}

			PutField_Int(hResponse,"bank_code_cnt",i);

			FREE_ME(csTag);
		}
		else {
DEBUGLOG(("Call DBOLBankAccts Error\n"));
			iRet = PD_ERR;
		}

                RecordSet_Destroy(rRecordSet);
	}

	if (iRet == PD_OK) {
/* check if support displaying other bank */
		int	iPtr;
		char 	*csTag;
		csTag = (char*) malloc (PD_TAG_LEN +1);
                recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchDetail","GetMerchant");
                if ((DBObjPtr)(csOrgMerchantId,rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_Int(hRec,"display_other_bank",&iPtr)) {
DEBUGLOG(("display_other_bank = [%d]\n",iPtr));
					if (iPtr == PD_TRUE) {
						int	iBankCodeCnt;
						GetField_Int(hResponse,"bank_code_cnt",&iBankCodeCnt);
DEBUGLOG(("bank code cnt = [%d]\n",iBankCodeCnt));
						iBankCodeCnt++;
						sprintf(csTag,"bank_code_%d",iBankCodeCnt);
						PutField_CString(hResponse,csTag,PD_OTHER_BANK_CODE);
						PutField_Int(hResponse,"bank_code_cnt",iBankCodeCnt);
					}
					break;
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}

		FREE_ME(csTag);
                RecordSet_Destroy(rRecordSet);
	}

DEBUGLOG(("Normal exit = [%d]\n",iRet));
	FREE_ME(hTxn);
        FREE_ME(rRecordSet);
	return iRet;
}
