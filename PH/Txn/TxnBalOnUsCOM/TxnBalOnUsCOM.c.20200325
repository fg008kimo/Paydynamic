/*
PDProTech (c)2020. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2020/03/03              [WMC]
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnBalOnUsCOM.h"
#include "myrecordset.h"
#include "dbutility.h"

static char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnBalOnUsCOM(char    cdebug)
{
        cDebug = cdebug;
}

int	CheckBal(const char* csCcy, char* const csBal)
{
	int	iRet = PD_OK;

	double	dValue;

      	char    *p;
	char    *csValue;

      	csValue = (char*) malloc (PD_TMP_BUF_LEN + 1);
    	
	memset(csValue, 0, sizeof(csValue));
        
	strcpy(csValue, csBal);

     	p = mystrtok(csValue, ".");
       	if (p == NULL) {
            	iRet = INT_ERR;
       	} else {
            	if (is_numeric(p) != PD_TRUE) {
                     	iRet = INT_ERR;
              	} else {
                     	p = mystrtok(NULL, ".");
                   	if (p == NULL) {
                              	iRet = INT_ERR;
                     	} else if (is_numeric(p) != PD_TRUE || strlen(p) != PD_DECIMAL_LEN) {
                               	iRet = INT_ERR;
                    	}

                   	while( (p = mystrtok(NULL, ".")) != NULL) {
                             	iRet = INT_ERR;
                             	break;
                      	}
             	}
     	}

      	if (iRet == PD_OK) {

		long    lTmp;
 
       		dValue = newround(string2double((const unsigned char *)csValue), PD_DECIMAL_LEN);

              	DBObjPtr = CreateObj(DBPtr,"DBCurrency","FindCurrency");
                if ((unsigned long)(DBObjPtr)(csCcy) == FOUND) {
                     	
			DBObjPtr = CreateObj(DBPtr,"DBCurrency","IsSupportDecimal");
                    	if ((unsigned long)((DBObjPtr)(csCcy)) != PD_TRUE){
                              	
				lTmp = (long) dValue;
                            	if (dValue > lTmp) {
                                       	iRet = INT_ERR;
DEBUGLOG((" currency[%s] does not support decimal\n", csCcy));
                              	}
                     	}
               	} else {
DEBUGLOG((" currency[%s] not found\n", csCcy));
		}
     	}

	FREE_ME(csValue);

	return iRet;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;

	//int     iPtr = 0;
        //int     iCnt = 0;

	double	dPtr = 0.0;

	char	*csChannelCodePtr = NULL;
	//char	*csTxnCodePtr = NULL;
	char	*csMid = NULL;
	char	*csCcy = NULL;
	char	*csPspId = NULL;
	char	*csPspCcy = NULL;
	char	*csPtr = NULL;
	//char	*csTag = NULL;

	//hash_t *hRec;

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

DEBUGLOG(("Authroize()\n"));

/* channel_code */
        if (GetField_CString(hRequest,"channel_code",&csChannelCodePtr)) {
DEBUGLOG((" channel_code = [%s]\n",csChannelCodePtr));
                PutField_CString(hContext,"channel_code",csChannelCodePtr);
        } else {
DEBUGLOG((" channel_code is missing\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: channel_code is missing\n");
                iRet =  INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* balcode */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest,"balcode",&csPtr)) {
DEBUGLOG((" balcode = [%s]\n",csPtr));
			PutField_CString(hContext,"balcode",csPtr);	
        	} else {
DEBUGLOG((" balcode is missing\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: balcode is missing\n");			
                	iRet =  INT_ERR;
               	 	PutField_Int(hContext,"internal_error",iRet);
        	}
	}

/* txnid */
	if (iRet == PD_OK) {
                if (GetField_CString(hRequest,"txnid",&csPtr)) {
DEBUGLOG((" txnid = [%s]\n",csPtr));
                        PutField_CString(hContext,"txnid",csPtr);   
                } else {
DEBUGLOG((" txnid is missing\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: txnid is missing\n");
                       	iRet = INT_TXN_ID_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* txncode */
        if (iRet == PD_OK) {
                if (GetField_CString(hRequest,"txncode",&csPtr)) {
DEBUGLOG((" txncode = [%s]\n",csPtr));
                        PutField_CString(hContext,"txncode",csPtr);
                } else {
DEBUGLOG((" txncode is missing\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: txncode is missing\n");
                        iRet = INT_TXN_CODE_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* country */
	if (iRet == PD_OK) {
                if (GetField_CString(hRequest,"country",&csPtr)) {
DEBUGLOG((" country = [%s]\n",csPtr));
                        PutField_CString(hContext,"country",csPtr);
                } else {
DEBUGLOG((" country is missing\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: country is missing\n");
                        iRet = INT_TXN_COUNTRY_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* mid */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest,"mid",&csMid)) {
DEBUGLOG((" mid = [%s]\n",csMid));
         	       	DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GetMerchant");
         	       	if ((*DBObjPtr)(csMid, rRecordSet) == PD_OK) {
				PutField_CString(hContext,"mid",csMid);
			} else {
DEBUGLOG((" mid not found\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: mid not found\n");
         	               	iRet = INT_MERCHANT_ID_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
			}
		} else {
DEBUGLOG((" mid is missing\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: mid is missing\n");
                        iRet =  INT_MERCHANT_ID_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
		}
	}

/* ccy */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest,"ccy",&csCcy)) {
DEBUGLOG((" ccy = [%s]\n",csCcy));
			DBObjPtr = CreateObj(DBPtr,"DBCurrency","FindCurrency");
                  	if ((unsigned long)(DBObjPtr)(csCcy) == FOUND) {
                            	PutField_CString(hContext,"ccy",csPtr);
                      	} else {
DEBUGLOG((" ccy invalid\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: ccy invalid\n");
                             	iRet = INT_INVALID_CURRENCY_CODE;
				PutField_Int(hContext,"internal_error",iRet);
                  	}
		} else {
DEBUGLOG((" ccy is missing\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: ccy is missing\n");
                        iRet =  INT_CURRENCY_CODE_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
                }
	}

/* service_code */
	if (iRet == PD_OK) {
                if (GetField_CString(hRequest,"service_code",&csPtr)) {
DEBUGLOG((" service_code = [%s]\n",csPtr));
			PutField_CString(hContext,"service_code",csPtr);
		} else {
DEBUGLOG((" service_code is missing\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: service_code is missing\n");
                        iRet =  INT_SERVICE_CODE_MISSING;
                        PutField_Int(hContext,"internal_error",iRet);
                }
	}

/* bal */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "bal", &csPtr)) {
			iRet = CheckBal(csCcy, csPtr);
			if (iRet == PD_OK) {
				dPtr = newround(string2double((const unsigned char *)csPtr), PD_DECIMAL_LEN);
                        	PutField_Double(hContext,"bal",dPtr);
DEBUGLOG((" bal = [%lf]\n",dPtr));
			}
                } else {
DEBUGLOG((" bal is missing!!\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: bal is missing!!\n");
                	iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
                }
	}

/* float */
	if (iRet == PD_OK) {
                if (GetField_CString(hRequest, "float", &csPtr)) {
			iRet = CheckBal(csCcy, csPtr);
                        if (iRet == PD_OK) {
				dPtr = newround(string2double((const unsigned char *)csPtr), PD_DECIMAL_LEN);
                        	PutField_Double(hContext,"float",dPtr);
DEBUGLOG((" float = [%lf]\n",dPtr));
			}
                } else {
DEBUGLOG((" float is missing!!\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: float is missing!!\n");
                	iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* holdback */
	if (iRet == PD_OK) {
                if (GetField_CString(hRequest, "holdback", &csPtr)) {
			iRet = CheckBal(csCcy, csPtr);
                        if (iRet == PD_OK) {
				dPtr = newround(string2double((const unsigned char *)csPtr), PD_DECIMAL_LEN);
                        	PutField_Double(hContext,"holdback",dPtr);
DEBUGLOG((" holdback = [%lf]\n",dPtr));
			}
                } else {
DEBUGLOG((" holdback is missing!!\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: holdback is missing!!\n");
                	iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* hold */
	if (iRet == PD_OK) {
                if (GetField_CString(hRequest, "hold", &csPtr)) {
			iRet = CheckBal(csCcy, csPtr);
                        if (iRet == PD_OK) {
				dPtr = newround(string2double((const unsigned char *)csPtr), PD_DECIMAL_LEN);
                        	PutField_Double(hContext,"hold",dPtr);
DEBUGLOG((" hold = [%lf]\n",dPtr));
			}
                } else {
DEBUGLOG((" hold is missing!!\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: hold is missing!!\n");
                	iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* bal_sett */
	if (iRet == PD_OK) {
                if (GetField_CString(hRequest, "bal_sett", &csPtr)) {
			iRet = CheckBal(csCcy, csPtr);
                        if (iRet == PD_OK) {
				dPtr = newround(string2double((const unsigned char *)csPtr), PD_DECIMAL_LEN);
                        	PutField_Double(hContext,"bal_sett",dPtr);
DEBUGLOG((" bal_sett = [%lf]\n",dPtr));
			}
                } else {
DEBUGLOG((" bal_sett is missing!!\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: bal_sett is missing!!\n");
                	iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* float_sett */
	if (iRet == PD_OK) {
                if (GetField_CString(hRequest, "float_sett", &csPtr)) {
			iRet = CheckBal(csCcy, csPtr);
                        if (iRet == PD_OK) {
				dPtr = newround(string2double((const unsigned char *)csPtr), PD_DECIMAL_LEN);
                        	PutField_Double(hContext,"float_sett",dPtr);
DEBUGLOG((" float_sett = [%lf]\n",dPtr));
			}
                } else {
DEBUGLOG((" float_sett is missing!!\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: float_sett is missing!!\n");
                	iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* hold_sett */
	if (iRet == PD_OK) {
                if (GetField_CString(hRequest, "hold_sett", &csPtr)) {
			iRet = CheckBal(csCcy, csPtr);
                        if (iRet == PD_OK) {
				dPtr = newround(string2double((const unsigned char *)csPtr), PD_DECIMAL_LEN);
                        	PutField_Double(hContext,"hold_sett",dPtr);
DEBUGLOG((" hold_sett = [%lf]\n",dPtr));
			}
                } else {
DEBUGLOG((" hold_sett is missing!!\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: hold_sett is missing!!\n");
                	iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* fundin_po */
	if (iRet == PD_OK) {
                if (GetField_CString(hRequest, "fundin_po", &csPtr)) {
			iRet = CheckBal(csCcy, csPtr);
                        if (iRet == PD_OK) {
				dPtr = newround(string2double((const unsigned char *)csPtr), PD_DECIMAL_LEN);
                        	PutField_Double(hContext,"fundin_po",dPtr);
DEBUGLOG((" fundin_po = [%lf]\n",dPtr));
			}
                } else {
DEBUGLOG((" fundin_po is missing!!\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: fundin_po is missing!!\n");
                	iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* resv_po */
	if (iRet == PD_OK) {
                if (GetField_CString(hRequest, "resv_po", &csPtr)) {
			iRet = CheckBal(csCcy, csPtr);
                        if (iRet == PD_OK) {
				dPtr = newround(string2double((const unsigned char *)csPtr), PD_DECIMAL_LEN);
                        	PutField_Double(hContext,"resv_po",dPtr);
DEBUGLOG((" resv_po = [%lf]\n",dPtr));
			}
                } else {
DEBUGLOG((" resv_po is missing!!\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: resv_po is missing!!\n");
                	iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* afpo_float */
	if (iRet == PD_OK) {
                if (GetField_CString(hRequest, "afpo_float", &csPtr)) {
			iRet = CheckBal(csCcy, csPtr);
                        if (iRet == PD_OK) {
				dPtr = newround(string2double((const unsigned char *)csPtr), PD_DECIMAL_LEN);
                        	PutField_Double(hContext,"afpo_float",dPtr);
DEBUGLOG((" afpo_float = [%lf]\n",dPtr));
			}
                } else {
DEBUGLOG((" afpo_float is missing!!\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: afpo_float is missing!!\n");
                	iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* psp_id */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest,"psp_id",&csPspId)) {
DEBUGLOG((" psp_id = [%s]\n",csPspId));

			RecordSet_Destroy(rRecordSet);
			recordset_init(rRecordSet,0);

                        DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
                        if ((*DBObjPtr)(csPspId, rRecordSet) == PD_OK) {
                                PutField_CString(hContext,"psp_id",csPspId);
                        } else {
DEBUGLOG((" psp_id not found\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: psp_id not found\n");
                                iRet = INT_PSP_ID_NOT_FOUND;
                                PutField_Int(hContext,"internal_error",iRet);
                        }
                } else {
DEBUGLOG((" psp_id is missing\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: psp_id is missing\n");
                        iRet =  INT_PSP_ID_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
                }
        }	

/* psp_ccy */
	 if (iRet == PD_OK) {
                if (GetField_CString(hRequest,"psp_ccy",&csPspCcy)) {
DEBUGLOG((" psp_ccy = [%s]\n",csPspCcy));
                        DBObjPtr = CreateObj(DBPtr,"DBCurrency","FindCurrency");
                        if ((unsigned long)(DBObjPtr)(csPspCcy) == FOUND) {
                                PutField_CString(hContext,"psp_ccy",csPtr);
                        } else {
DEBUGLOG((" psp_ccy invalid\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: psp_ccy invalid\n");
                                iRet = INT_INVALID_CURRENCY_CODE;
                                PutField_Int(hContext,"internal_error",iRet);
                        }
                } else {
DEBUGLOG((" psp_ccy is missing\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: psp_ccy is missing\n");
                        iRet =  INT_CURRENCY_CODE_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
                }
        }	

/* psp_bal */
        if (iRet == PD_OK) {
                if (GetField_CString(hRequest, "psp_bal", &csPtr)) {
			iRet = CheckBal(csPspCcy, csPtr);
                        if (iRet == PD_OK) {
				dPtr = newround(string2double((const unsigned char *)csPtr), PD_DECIMAL_LEN);
                        	PutField_Double(hContext,"psp_bal",dPtr);
DEBUGLOG((" psp_bal = [%lf]\n",dPtr));
			}
                } else {
DEBUGLOG((" psp_bal is missing!!\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: psp_bal is missing!!\n");
                	iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* psp_float */
        if (iRet == PD_OK) {
                if (GetField_CString(hRequest, "psp_float", &csPtr)) {
			iRet = CheckBal(csPspCcy, csPtr);
                        if (iRet == PD_OK) {
				dPtr = newround(string2double((const unsigned char *)csPtr), PD_DECIMAL_LEN);
                        	PutField_Double(hContext,"psp_float",dPtr);
DEBUGLOG((" psp_float = [%lf]\n",dPtr));
			}
                } else {
DEBUGLOG((" psp_float is missing!!\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: psp_float is missing!!\n");
                	iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* psp_hold */
        if (iRet == PD_OK) {
                if (GetField_CString(hRequest, "psp_hold", &csPtr)) {
			iRet = CheckBal(csCcy, csPtr);
                        if (iRet == PD_OK) {
				dPtr = newround(string2double((const unsigned char *)csPtr), PD_DECIMAL_LEN);
                        	PutField_Double(hContext,"psp_hold",dPtr);
DEBUGLOG((" psp_hold = [%lf]\n",dPtr));
			}
                } else {
DEBUGLOG((" psp_hold is missing!!\n"));
ERRLOG("TxnBalOnUsCOM:: Authorize:: psp_hold is missing!!\n");
                	iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
                }
        }

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

DEBUGLOG(("Authroize() iRet = [%d]\n",iRet));	
	return iRet;
}

