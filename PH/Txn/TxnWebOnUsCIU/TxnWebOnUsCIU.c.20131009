/*
Partnerdelight (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/08/19              Cody Chan
Add  GetTotalMatchRec Checking		  	   2013/09/24              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnWebOnUsCIU.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;

OBJPTR(DB);
void TxnWebOnUsCIU(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	char*	csPtr;
	hash_t  *hTxn;

	int	iTotalCnt = -1;

DEBUGLOG(("TxnWebOnUsCIU Authorize\n"));

	hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);
/* magic num */
	if (GetField_CString(hRequest,"magic_num",&csPtr)) {
DEBUGLOG(("TxnWebOnUsCIU magic_num = [%s]\n",csPtr));
		PutField_CString(hTxn,"magic_num",csPtr);
	}
	else {
DEBUGLOG(("TxnWebOnUsCIU magic_num is missing\n"));
		iRet = INT_FORMAT_ERR;
	}

/* magic word */
	if (GetField_CString(hRequest,"magic_word",&csPtr) && iRet == PD_OK) {
DEBUGLOG(("TxnWebOnUsCIU magic_word = [%s]\n",csPtr));
		PutField_CString(hTxn,"magic_word",csPtr);
	}
	else {
DEBUGLOG(("TxnWebOnUsCIU magic_word is missing\n"));
		iRet = INT_FORMAT_ERR;
	}

/* customer_id */
	if (GetField_CString(hRequest,"customer_id",&csPtr) && iRet == PD_OK) {
DEBUGLOG(("TxnWebOnUsCIU customer_id = [%s]\n",csPtr));
		PutField_CString(hTxn,"customer_id",csPtr);
	}
	else {
DEBUGLOG(("TxnWebOnUsCIU customer_id is missing\n"));
		iRet = INT_FORMAT_ERR;
	}

/* key_id */
	if (GetField_CString(hRequest,"key_id",&csPtr) && iRet == PD_OK) {
DEBUGLOG(("TxnWebOnUsCIU key_id = [%s]\n",csPtr));
		PutField_CString(hTxn,"client_id",csPtr);
	}
	else {
DEBUGLOG(("TxnWebOnUsCIU key_id is missing\n"));
		iRet = INT_FORMAT_ERR;
	}

	if (iRet == PD_OK) {
DEBUGLOG(("TxnWebOnUsCIU GetTotalMatchRec\n")); 
		DBObjPtr = CreateObj(DBPtr,"DBClientMagic","GetTotalMatchRec");
		if (((unsigned long)(*DBObjPtr)(hTxn, &iTotalCnt)) == PD_OK) {
DEBUGLOG(("TxnWebOnUsCIU count [%d]!\n", iTotalCnt));
			if (iTotalCnt != 0 && iTotalCnt != 3) {
DEBUGLOG(("TxnWebOnUsCIU count Invalid!\n"));
				iRet = INT_INVALID_MAGIC_NUM;
				PutField_Int(hContext, "internal_error", iRet);
			}
		}
	}

	PutField_Int(hTxn, "disabled", PD_FALSE);
	PutField_CString(hTxn, "create_user", PD_UPDATE_USER);


	if (iRet == PD_OK) {
DEBUGLOG(("TxnWebOnUsCIU Call DBClientMagic::ADD\n"));
		DBObjPtr = CreateObj(DBPtr,"DBClientMagic","Add");
		iRet = (unsigned long)(*DBObjPtr)(hTxn);
	}

	hash_destroy(hTxn);
        FREE_ME(hTxn);

DEBUGLOG(("TxnWebOnUsCIU Authorize iRet = [%d]\n",iRet));
	return iRet;
}
