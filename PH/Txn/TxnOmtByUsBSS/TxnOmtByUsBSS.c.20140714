/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/04/22              Stan Poon
*/


#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsBSS.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);

void TxnOmtByUsBSS(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int	iRet = PD_OK;
	char	*csIntBankCode = NULL, *csBankAcctNum = NULL, *csBAID = NULL, *csPspId = NULL;
	char	*csFileId = NULL, *csStatTxnId = NULL, *csBAIDTxnId = NULL, *csAcctCcy = NULL, *csUser = NULL;
	char	csFileName[PD_FILENAME_LEN + 1], csTxnDateTime[PD_DATETIME_LEN + 1];
	char	*csTmp = NULL;
	double	dTxnAmt = 0.0, dBalance = 0.0, dLastBalance = 0.0;

	hash_t *hRec = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRec,0);

/* int_bank_code */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "int_bank_code", &csIntBankCode)) {
			PutField_CString(hContext,"int_bank_code",csIntBankCode);
DEBUGLOG(("Authorize() int_bank_code = [%s]\n", csIntBankCode));
		} else {
			iRet = INT_BANK_CODE_NOT_FOUND;
DEBUGLOG(("Authorize() int_bank_code is missing!!!\n"));
ERRLOG("TxnOmtByUsBSS::Authorize() int_bank_code is missing!!!\n");
		}
	}
/* bank_acct_num */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "bank_acct_num", &csBankAcctNum)) {
			PutField_CString(hContext,"bank_acct_num",csBankAcctNum);
DEBUGLOG(("Authorize() bank_acct_num = [%s]\n", csBankAcctNum));
		} else {
			iRet = INT_BANK_ACCT_NUM;
DEBUGLOG(("Authorize() bank_acct_num is missing!!!\n"));
ERRLOG("TxnOmtByUsBSS::Authorize() bank_acct_num is missing!!!\n");
		}
	}
/* deposit_amt */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "deposit_amt", &csTmp)) {
			dTxnAmt = atof(csTmp);
DEBUGLOG(("Authorize() deposit_amt = [%.2lf]\n", dTxnAmt));
		} else {
			iRet = INT_PAY_AMOUNT_NOT_FOUND;
DEBUGLOG(("Authorize() deposit_amt is missing!!!\n"));
ERRLOG("TxnOmtByUsBSS::Authorize() deposit_amt is missing!!!\n");
		}
	}
/* cust_text */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "cust_text", &csTmp)) {
DEBUGLOG(("Authorize() cust_text = [%s]\n", csTmp));
		}
	}
/* sender_name */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "sender_name", &csTmp)) {
DEBUGLOG(("Authorize() sender_name = [%s]\n", csTmp));
		}
	}
/* txn_ref_num */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "txn_ref_num", &csTmp)) {
DEBUGLOG(("Authorize() txn_ref_num = [%s]\n", csTmp));
		}
	}
/* ip_addr */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "ip_addr", &csTmp)) {
DEBUGLOG(("Authorize() ip_addr = [%s]\n", csTmp));
		}
	}
/* user */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "add_user", &csUser)) {
			PutField_CString(hContext,"create_user",csUser);
			PutField_CString(hContext,"update_user",csUser);
DEBUGLOG(("Authorize() user = [%s]\n", csUser));
		} else {
			iRet = INT_USER_NOT_FOUND;
DEBUGLOG(("Authorize() user is missing!!!\n"));
ERRLOG("TxnOmtByUsBSS::Authorize() user is missing!!!\n");
		}
	}

/* Get Last Balance */
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "GetLastBalance");
		iRet = (unsigned long)(*DBObjPtr)(hContext);
		if (iRet == FOUND) {
			if (GetField_Double(hContext,"last_balance",&dLastBalance)) {
				iRet = PD_OK;
DEBUGLOG(("Authorize() DBOLStatement::GetLastBalance() balance [%.2f] FOUND\n",dLastBalance)); 
			}
		} else if (iRet == NOT_FOUND) {
			iRet = PD_OK;
			dLastBalance = 0.0;
DEBUGLOG(("Authorize() DBOLStatement::GetLastBalance() NOT FOUND\n")); 
		} else {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() DBOLStatement::GetLastBalance() FAILURE!!!\n"));
ERRLOG("BOOLBankStmt::Authorize() DBOLStatement::GetLastBalance() FAILURE!!!\n");
		}
		dBalance = dLastBalance + dTxnAmt;
	}

/* get BAID */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLBankAcctId:: GetDtlByBankAcct()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetDtlByBankAcct");
		if ((unsigned long)(*DBObjPtr)(csIntBankCode,csBankAcctNum,hContext) != PD_OK) {
			iRet = INT_BANK_ACCT_NOT_AVAILABLE;
DEBUGLOG(("Authorize() call DBOLBankAcctId::GetDtlByBankAcct() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call DBOLBankAcctId::GetDtlByBankAcct() FAILURE!!!\n");
		} else {
			if (!GetField_CString(hContext,"baid",&csBAID)) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLBankAcctId::GetDtlByBankAcct() baid NOT FOUND!!!\n"));
			}
			if (!GetField_CString(hContext,"psp_id",&csPspId)) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLBankAcctId::GetDtlByBankAcct() psp_id NOT FOUND!!!\n"));
			}
		}
	}

/* Get Acct Ccy */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLBankAccts:: GetBankAccts()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBankAccts", "GetBankAccts");
		if ((unsigned long)(*DBObjPtr)(csIntBankCode, csBankAcctNum, hContext) != PD_OK) {
			iRet = INT_BANK_ACCT_NOT_AVAILABLE;
DEBUGLOG(("Authorize() call DBOLBankAccts::GetBankAccts() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call DBOLBankAccts::GetBankAccts() FAILURE!!!\n");
		} else {
			if (!GetField_CString(hContext,"acct_ccy",&csAcctCcy)) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLBankAccts::GetBankAccts() acct_ccy NOT FOUND!!!\n"));
			}
		}
	}


	if (iRet != PD_OK) {
		PutField_Int(hContext,"internal_error",iRet);
	}


/* Add Statement Header */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLTxnSeq::GetNextOdiFileSeq()\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextOdiFileSeq");
		csFileId = (*DBObjPtr)();
		PutField_CString(hRec,"file_id",csFileId);
DEBUGLOG(("Authorize() call DBOLTxnSeq::GetNextOdiFileSeq() file_id = [%s]\n",csFileId));
		strcpy(csTxnDateTime,"");
		if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
			strcpy(csTxnDateTime, csTmp);
		}
		if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
			strcat(csTxnDateTime, csTmp);
		}
		snprintf(csFileName,sizeof(csFileName),"SF%s",csFileId);
		//snprintf(csFileName,sizeof(csFileName),"File_%s_%d",csTxnDateTime,atoi(csFileId));
		PutField_CString(hRec,"new_file_name",csFileName);
		PutField_CString(hRec,"in_file_name",csFileName);
		PutField_CString(hRec,"int_bank_code",csIntBankCode);
		PutField_CString(hRec,"bank_acct_num",csBankAcctNum);
		PutField_CString(hRec,"baid",csBAID);
		PutField_Int(hRec,"accept_count",1);
		PutField_Int(hRec,"total_count",1);
		PutField_Int(hRec,"message_code",0);
		PutField_CString(hRec,"create_user",csUser);

DEBUGLOG(("Authorize() call DBOLStatement:: AddHeader()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "AddHeader");
		if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement:: AddHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call DBOLStatement:: AddHeader() FAILURE!!!\n");
		}
	}

/* Add Statement Detail */
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextStmtTxnSeq");
		csStatTxnId = (*DBObjPtr)();
		PutField_CString(hRec,"stat_txn_id",csStatTxnId);
		PutField_CString(hRec,"file_id",csFileId);
		PutField_CString(hRec,"int_bank_code",csIntBankCode);
		PutField_CString(hRec,"bank_acct_num",csBankAcctNum);
		PutField_CString(hRec,"baid",csBAID);
		PutField_Int(hRec,"statement_seq",1);
		DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextStmtRef");
		PutField_CString(hRec,"statement_ref",(*DBObjPtr)());
		PutField_CString(hRec,"input_channel",PD_BANK_STATEMENT);
		if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
			PutField_CString(hRec,"statement_date",csTmp);
		}
		if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
			PutField_CString(hRec,"statement_time",csTmp);
		}
		if (GetField_CString(hRequest,"cust_text",&csTmp)) {
			PutField_CString(hRec,"tfr_customer_text",csTmp);
		}
		if (GetField_CString(hRequest,"sender_name",&csTmp)) {
			PutField_CString(hRec,"sender_name",csTmp);
		}
		if (GetField_CString(hRequest,"txn_ref_num",&csTmp)) {
			PutField_CString(hRec,"txn_ref_num",csTmp);
		}
		PutField_Double(hRec,"balance",dBalance);
		PutField_CString(hRec,"amt_type",PD_CR);
		PutField_Double(hRec,"txn_amount",dTxnAmt);
		PutField_CString(hRec,"txn_ccy",csAcctCcy);
		PutField_CString(hRec,"create_user",csUser);

DEBUGLOG(("Authorize() call DBOLStatement::AddDetail()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "AddDetail");
		if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement::AddDetail() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSS::Authorize() call DBOLStatement::AddDetail() FAILURE!!!\n");
		}
	}

/* Add BAID Txn */
	if (iRet == PD_OK) {
		/* txn_seq */
		DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextBaidTxnSeq");
		csBAIDTxnId = (*DBObjPtr)();
		PutField_CString(hRec,"txn_seq",csBAIDTxnId);

		/* channel_code */
		if (GetField_CString(hContext, "channel_code", &csTmp)) {
			PutField_CString(hRec, "channel_code", csTmp);
		}

		/* status */
		PutField_Char(hRec, "status", PD_COMPLETE);

		/* ar_ind */
		PutField_Char(hRec, "ar_ind", PD_ACCEPT);

		/* sub_status */
		PutField_CString(hRec, "sub_status", PD_APPROVED);

		/* txn_code */
		PutField_CString(hRec, "txn_code", PD_BANK_DEPOSIT_TXN_CODE);

		/* stat_txn_id */
		PutField_CString(hRec, "stat_txn_id", csStatTxnId);

		/* pid */
		PutField_CString(hRec, "pid", csPspId);

		/* baid */
		PutField_CString(hRec, "baid", csBAID);

		/* transmission_datetime */
		PutField_CString(hRec, "transmission_datetime", csTxnDateTime);

		/* txn_ccy */
		PutField_CString(hRec, "txn_ccy", csAcctCcy);

		/* txn_amt */
		PutField_Double(hRec, "txn_amt", dTxnAmt);

		/* open_bal */
		PutField_Double(hRec, "open_bal", 0.0);

		/* curr_bal */
		PutField_Double(hRec, "curr_bal", 0.0);

		/* approval_date */
		if (GetField_CString(hContext, "PHDATE", &csTmp)) {
			PutField_CString(hRec, "posting_date", csTmp);
			PutField_CString(hRec, "approval_date", csTmp);
		}

		/* approval_timestamp */
		DBObjPtr = CreateObj(DBPtr, "DBSystemControl", "GetApprovalDT");
		(*DBObjPtr)(hRec);

		/* bank_code */
		PutField_CString(hRec, "bank_code", csIntBankCode);

		/* bank_acct_num */
		PutField_CString(hRec, "bank_acct_num", csBankAcctNum);

		/* pid_txn_hold_ind */
		PutField_Int(hRec, "pid_txn_hold_ind", 0);

		/* pid_sys_match_ind */
		PutField_Int(hRec, "pid_sys_match_ind", 1);

		/* posted_ind */
		PutField_Int(hRec, "posted_ind", 0);

		/* create_user */
		PutField_CString(hRec, "add_user", csUser);

DEBUGLOG(("Authorize() call DBOLBAIDTxn::Add()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Add");
		if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLBAIDTxn::Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSS::Authorize() call DBOLBAIDTxn::Add() FAILURE!!!\n");
		}
	}

	if (iRet == PD_OK) {
		PutField_CString(hRec, "txn_id", csBAIDTxnId);
		PutField_CString(hRec, "stat_txn_id", csStatTxnId);
		PutField_CString(hRec, "update_user", csUser);

DEBUGLOG(("MatchStmtWithSms() call DBOLStatement::UpdateTxnId()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "UpdateTxnId");
		if ((unsigned long)(*DBObjPtr)(hRec) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLStatement::UpdateTxnId() FAILURE!!!\n"));
ERRLOG("BOOLBankStmtMatch::MatchStmtWithSms() call DBOLStatement::UpdateTxnId() FAILURE!!!\n");
		}
	}

/* Auto Post Transaction */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call BOOLBaid::PostBaidTxn()\n"));
		BOObjPtr = CreateObj(BOPtr, "BOOLBaid", "PostBaidTxn");
		if ((unsigned long)(*BOObjPtr)(csBAIDTxnId) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call BOOLBaid::PostBaidTxn() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSS::Authorize() call BOOLBaid::PostBaidTxn() FAILURE!!!\n");
		}
	}

	hash_destroy(hRec);
	FREE_ME(hRec);

DEBUGLOG(("Authorize() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;
}

