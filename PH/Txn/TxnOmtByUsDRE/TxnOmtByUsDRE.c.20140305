/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/09/27              Stan Poon
*/


#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsDRE.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);

void TxnOmtByUsDRE(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int	iRet = PD_OK;
	char	*csTmp=NULL;
	char	*csTxnSeq=NULL, *csTxnCode=NULL, *csMerchantId=NULL;
	char	*csIntBankCode, *csBankAcctNum;
	char	cStatus;

	hash_t *hRec;
	recordset_t* myRec = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(myRec,0);

/* txn_id */
        if (GetField_CString(hRequest,"org_txn_seq",&csTxnSeq)) {
DEBUGLOG(("Authorize() txn_id = [%s]\n",csTxnSeq));
		PutField_CString(hContext,"txn_seq",csTxnSeq);
	} else {
		iRet = INT_TXN_ID_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() txn_seq NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsDRE::Authorize() txn_seq NOT FOUND!!!\n");
	}

/* int_bank_code */
	if (GetField_CString(hRequest, "int_bank_code", &csIntBankCode)) {
DEBUGLOG(("Authorize() int_bank_code = [%s]\n", csIntBankCode));
		PutField_CString(hContext,"int_bank_code",csIntBankCode);
	} else {
		iRet = INT_BANK_CODE_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() int_bank_code NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsDRE::Authorize() int_bank_code NOT FOUND!!!\n");
	}

/* bank_acct_num */
	if (GetField_CString(hRequest, "bank_acct_num", &csBankAcctNum)) {
DEBUGLOG(("Authorize() bank_acct_num = [%s]\n", csBankAcctNum));
		PutField_CString(hContext,"bank_acct_num",csBankAcctNum);
	} else {
		iRet = INT_BANK_ACCT_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() bank_acct_num NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsDRE::Authorize() bank_acct_num NOT FOUND!!!\n");
	}

/* deposit_amount */
	if (GetField_CString(hRequest, "deposit_amt", &csTmp)) {
DEBUGLOG(("Authorize() deposit_amount = [%s]\n", csTmp));
		PutField_CString(hContext,"deposit_amt",csTmp);
	} else {
		iRet = INT_PAY_AMOUNT_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() deposit_amount NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsDRE::Authorize() deposit_amount NOT FOUND!!!\n");
	}

/* deposit_datetime */
	if (GetField_CString(hRequest, "deposit_datetime", &csTmp)) {
DEBUGLOG(("Authorize() deposit_datetime = [%s]\n", csTmp));
		PutField_CString(hContext,"deposit_datetime",csTmp);
	}

/* deposit_bank */
	if (GetField_CString(hRequest, "deposit_bank", &csTmp)) {
DEBUGLOG(("Authorize() deposit_bank = [%s]\n", csTmp));
		PutField_CString(hContext,"deposit_bank",csTmp);
	}

/* deposit_ref */
	if (GetField_CString(hRequest, "deposit_ref", &csTmp)) {
DEBUGLOG(("Authorize() deposit_ref = [%s]\n", csTmp));
		PutField_CString(hContext,"deposit_ref",csTmp);
	}

/* user */
	if (GetField_CString(hRequest, "add_user", &csTmp)) {
DEBUGLOG(("Authorize() user = [%s]\n", csTmp));
		PutField_CString(hContext,"create_user",csTmp);
		PutField_CString(hContext,"update_user",csTmp);
	} else {
		iRet = INT_USER_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() user NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsDRE::Authorize() user NOT FOUND!!!\n");
	}

/* MatchRespTxn */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLTransaction:: MatchRespTxn()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "MatchRespTxn");
		if ((unsigned long)(*DBObjPtr)(csTxnSeq,PD_TO_PSP) != FOUND) {
			iRet = INT_INVALID_TXN;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() DBOLTransaction MatchRespTxn FAILURE!!!\n"));
ERRLOG("TxnOmtByUsDRE::Authorize() DBOLTransaction MatchRespTxn FAILURE!!!\n");
		}
	}

/* Get Ol Txn Header */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnHeader");
		if ((unsigned long)(*DBObjPtr)(csTxnSeq,myRec) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsDRE::Authorize() call DBOLTransaction:: GetTxnHeader() FAILURE!!!\n");
		} else {
			hRec = RecordSet_GetFirst(myRec);
			if (hRec) {
				if (GetField_CString(hRec,"txn_code",&csTxnCode)) {
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() txn_code = [%s]\n",csTxnCode));
				}
				if (GetField_CString(hRec,"merchant_id",&csMerchantId)) {
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() merchant_id = [%s]\n",csMerchantId));
				}
				if (GetField_Char(hRec,"status",&cStatus)) {
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() status = [%c]\n",cStatus));
				}

			/* txn_code, status */
				if (strcmp(csTxnCode,PD_INITIAL_OLN_TXN_CODE) && strcmp(csTxnCode,PD_INITIAL_REQ_OLN_TXN_CODE)) {
					iRet = INT_INVALID_TXN;
					PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() txn_code [%s] NOT SUPPORT for DRE!!!\n",csTxnCode));
ERRLOG("TxnOmtByUsDRE::Authorize() call DBOLTransaction:: GetTxnHeader() txn_code NOT SUPPORT for DRE!!!\n");
				}
				if (cStatus != PD_TO_PSP) {
					iRet = INT_INVALID_TXN;
					PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() Invalid status = [%c]\n",cStatus));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTransaction:: GetTxnHeader() Invalid status!!!\n");
				}
			} else {
				iRet = INT_INVALID_TXN;
				PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsDRE::Authorize() call DBOLTransaction:: GetTxnHeader() FAILURE\n");
			}
		}
	}

/* get country, acct_ccy */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLMerchantBankAcct::FindDetailByAvaMerchBankAcct()\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchantBankAcct","FindDetailByAvaMerchBankAcct");
		if ((unsigned long)(*DBObjPtr)(csMerchantId,csIntBankCode,csBankAcctNum,hContext) != PD_OK) {
			iRet = INT_BANK_ACCT_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call DBOLMerchantBankAcct::FindDetailByAvaMerchBankAcct() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsDRE::Authorize() call DBOLMerchantBankAcct::FindDetailByAvaMerchBankAcct() FAILURE!!!\n");
		}
	}

/* Deposit Request */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call BOOLDepositReq::EditDepositReq()\n"));
		BOObjPtr = CreateObj(BOPtr, "BOOLDepositReq", "EditDepositReq");
		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
		if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call BOOLDepositReq::EditDepositReq() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsDRE::Authorize() call BOOLDepositReq::EditDepositReq() FAILURE!!!\n");
		}
	}

	RecordSet_Destroy(myRec);
	FREE_ME(myRec);

DEBUGLOG(("Authorize() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;
}

