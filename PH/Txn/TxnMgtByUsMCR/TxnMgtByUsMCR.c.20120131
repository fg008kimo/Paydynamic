/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/01/10              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsMCR.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

#include "sha1.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMgtByUsMCR(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{

	int	iRet = PD_OK;
	int	iMerchDetail = PD_FALSE;

	char	*csTmp = NULL;	
	char	*csKeyType = NULL;
	char	csKeyValue[PD_MD5_KEY_LEN + 1];

        SHA1Context sha;
        char csDateTime[PD_DATETIME_LEN + 1];

	int	iTmp, i ;
	double	dTmp = 0.0;

	char	*csMid = strdup("");
	char	cType;


	hash_t  *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn, 0);

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	memset(csKeyValue, 0, sizeof(csKeyValue));
	memset(csDateTime, 0, sizeof(csDateTime));


DEBUGLOG(("TxnMgtByUsMCR::Authorize\n"));

/* Merchant ID */
        if (GetField_CString(hRequest, "merchant_id", &csMid)){
                PutField_CString(hTxn, "merchant_id", csMid);
DEBUGLOG(("Authorize::merhant_id handle key only= [%s]\n",csMid));
        }
        else {

DEBUGLOG(("Authorize::gen a new merhant_id\n"));
		iMerchDetail = PD_TRUE; /* need to create merch_detail */

                if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMerchDetail:GenMerchantId\n"));
                        DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GenMerchantId");
                        if((unsigned long)((*DBObjPtr)(csMid) != PD_OK)){
DEBUGLOG(("Authorize::DBMerchDetail:GenMerchantId Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBMerchDetail:GenMerchantId Failed\n");
                                iRet = PD_ERR;
                        }
                        else {
DEBUGLOG(("Authorize::DBMerchDetail:GenMerchantId mid = [%s]\n", csMid));
                                PutField_CString(hTxn, "merchant_id", csMid);
                        }
                }
        }

	if (iRet == PD_OK) {
		if (iMerchDetail == PD_TRUE) {
			/* name */
			if(GetField_CString(hRequest,"name",&csTmp)){
				PutField_CString(hTxn, "name", csTmp);
DEBUGLOG(("Authorize::name = [%s]\n",csTmp));
			}
			else {
DEBUGLOG(("Authorize::name not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::name not found!!\n");
				iRet=INT_MERCHANT_NAME_NOT_FOUND;
			}

			/* business_type */
			if (GetField_CString(hRequest, "type", &csTmp)) {
				cType = csTmp[0];
DEBUGLOG(("Authorize::type = [%c]\n",cType));
				PutField_Char(hTxn, "merchant_type", cType);
			}
			else {
DEBUGLOG(("Authorize::business_type not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::business_type not found!!\n");
				iRet=INT_BUSINESS_TYPE_NOT_FOUND;
			}

			/* client_id */
			if(GetField_CString(hRequest,"client_id",&csTmp)){
				PutField_CString(hTxn, "client_id", csTmp);
DEBUGLOG(("Authorize::client_id = [%s]\n",csTmp));
			}
			else {
DEBUGLOG(("Authorize::client_id not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::client_id not found!!\n");
				iRet=INT_CLIENT_ID_NOT_FOUND;
			}

			/* approximate_fee_rate */
			if(GetField_CString(hRequest,"fee_rate",&csTmp)){
				dTmp = string2double((const unsigned char *)csTmp);
				PutField_Double(hTxn,"approximate_fee_rate",dTmp);
DEBUGLOG(("Authorize() approximate_fee_rate = [%f]\n",dTmp));
			}
			else {
				dTmp = 0.0;
DEBUGLOG(("Authorize() approximate_fee_rate (default) = [%f]\n",dTmp));
				PutField_Double(hTxn, "approximate_fee_rate", dTmp);
			}

			/* disabled */
			if (GetField_CString(hRequest, "disabled", &csTmp)) {
				iTmp = atoi(csTmp);
DEBUGLOG(("Authorize::disabled = [%d]\n",iTmp));
				PutField_Int(hTxn, "disabled", iTmp);
			}
			else {
DEBUGLOG(("Authorize::disabled not found!!\n"));
				PutField_Int(hTxn, "disabled", PD_FALSE);
			}
		} /***** iMerchDetail == PD_TRUE ******/

		/* effect_date */
		if (GetField_CString(hRequest, "effect_date", &csTmp)) {
			PutField_CString(hTxn,"effect_date",csTmp);
DEBUGLOG(("Authorize:: effect_date = [%s]\n",csTmp));
		}
		else {
DEBUGLOG(("Authorize::effect_date not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::effect_date not found!!\n");
			iRet=INT_ERR;
		}

/*
		if (!GetField_CString(hRequest, "effect_date", &csTmp)) {
			if(GetField_CString(hContext,"PHDATE",&csTmp)){
DEBUGLOG(("Authorize::effect_date (phdate) = [%s]\n",csTmp));
				PutField_CString(hTxn,"effect_date",csTmp);
			}
			else{
DEBUGLOG(("Authorize::phdate not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::phdate not found!!\n");
				iRet=INT_PHDATE_NOT_FOUND;
			}
		}
		else {
			PutField_CString(hTxn,"effect_date",csTmp);
DEBUGLOG(("Authorize:: effect_date = [%s]\n",csTmp));
		}
*/

		/* key_type */
		if(GetField_CString(hRequest,"key_type",&csKeyType)){
                		PutField_CString(hTxn, "key", csKeyType);
DEBUGLOG(("Authorize::key type = [%s]\n",csKeyType));
        	}
		else {
DEBUGLOG(("Authorize::key type not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::key type not found!!\n");
                	iRet=INT_KEY_TYPE_NOT_FOUND;
        	}

		/* Gen key_value */
		if (iRet == PD_OK) {
			if (!strcmp(csKeyType, PD_PTK_KEY_NAME)) {
				// len 128
				strcpy(csKeyValue, random_gen(PD_MD5_KEY_LEN));
				csKeyValue[PD_MD5_KEY_LEN]='\0';

				PutField_CString(hTxn, "key_value", csKeyValue);
			} else if ((!strcmp(csKeyType, PD_SHA1_KEY_NAME)) || (!strcmp(csKeyType, PD_POK_KEY_NAME))) {

				// len 32
				strcpy(csDateTime,getdatetime());
				csDateTime[PD_DATETIME_LEN]='\0';

				SHA1Reset(&sha);
				SHA1Input(&sha, (const unsigned char *)csDateTime, strlen(csDateTime));

				if (SHA1Result(&sha)) {
					for(i = 0; i < 4 ; i++) {
						sprintf(&csKeyValue[i*8], "%08X", sha.Message_Digest[i]);
					}
					csKeyValue[PD_SHA_KEY_LEN]='\0';
					PutField_CString(hTxn, "key_value", csKeyValue);
				}
			} else {
				iRet = INT_KEY_TYPE_NOT_FOUND;
			}
DEBUGLOG(("Authorize::key_value = [%s]\n",csKeyValue));
		}
	}

/* status */
	PutField_CString(hTxn, "status", PD_ACC_OPEN);

/* add_user */
        if(GetField_CString(hRequest,"add_user",&csTmp)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csTmp));
                PutField_CString(hTxn,"create_user",csTmp);
        }


	/* Merch Detail */
        if (iRet == PD_OK && iMerchDetail == PD_TRUE) {
DEBUGLOG(("Authorize::Call DBMerchDetail:Add\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","Add");
                if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBMerchDetail:Add Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBMerchDetail:Add Failed\n");
                        iRet = INT_ERR;
                }
		else {
DEBUGLOG(("Authorize::DBMerchDetail:Add Succ\n"));
		}
        }

	/* Merch Keys */
        if (iRet == PD_OK) {
		if (iMerchDetail == PD_FALSE) {
DEBUGLOG(("Authorize::Call DBMerchDetail:GetMerchant\n"));
	                DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GetMerchant");
			if((unsigned long)((*DBObjPtr)(csMid, rRecordSet) != PD_OK)){
DEBUGLOG(("Authorize::Call DBMerchDetail:GetMerchant Fail\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBMerchDetail:GetMerchant Failed\n");
				iRet = INT_MERCHANT_ID_NOT_FOUND;
			}
		}

		if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMerchKeys:Add\n"));
			DBObjPtr = CreateObj(DBPtr,"DBMerchKeys","Add");
			if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBMerchKeys:Add Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBMerchKeys:Add Failed\n");
                        	iRet = INT_ERR;
                	}
	                else {
DEBUGLOG(("Authorize::DBMerchKeys:Add Succ\n"));
			}
        	}
	}

	if (iRet == PD_OK) {
		PutField_CString(hResponse, "merchant_id", csMid);
		PutField_CString(hResponse, "key_value", csKeyValue);
	}


	if(iRet!=PD_OK){
		PutField_Int(hContext,"internal_error",iRet);
	}


	hash_destroy(hTxn);
	FREE_ME(hTxn);

	FREE_ME(csMid);

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("TxnMgtByUsMCR Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}

