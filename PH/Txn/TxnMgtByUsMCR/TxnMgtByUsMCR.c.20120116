/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/01/10              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsMCR.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMgtByUsMCR(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{

	int	iRet = PD_OK;

	char	*csTmp = NULL;	
	int	iTmp;
	double	dTmp = 0.0;

	char	*csMid = strdup("");
	char	cType;

	hash_t  *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn, 0);


DEBUGLOG(("TxnMgtByUsMCR::Authorize\n"));

/* name */
	if(GetField_CString(hRequest,"name",&csTmp)){
		PutField_CString(hTxn, "name", csTmp);
DEBUGLOG(("Authorize::name = [%s]\n",csTmp));
	}
	else {
DEBUGLOG(("Authorize::name not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::name not found!!\n");
		iRet=INT_MERCHANT_NAME_NOT_FOUND;
	}

/* business_type */
	if (GetField_CString(hRequest, "type", &csTmp)) {
		cType = csTmp[0];
DEBUGLOG(("Authorize::type = [%c]\n",cType));
		PutField_Char(hTxn, "merchant_type", cType);
	}
	else {
DEBUGLOG(("Authorize::business_type not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::business_type not found!!\n");
		iRet=INT_BUSINESS_TYPE_NOT_FOUND;
	}

/* client_id */
        if(GetField_CString(hRequest,"client_id",&csTmp)){
                PutField_CString(hTxn, "client_id", csTmp);
DEBUGLOG(("Authorize::client_id = [%s]\n",csTmp));
        }
        else {
DEBUGLOG(("Authorize::client_id not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::client_id not found!!\n");
                iRet=INT_CLIENT_ID_NOT_FOUND;
        }

/* approximate_fee_rate */
        if(GetField_CString(hRequest,"fee_rate",&csTmp)){
                dTmp = string2double((const unsigned char *)csTmp);
                PutField_Double(hTxn,"approximate_fee_rate",dTmp);

DEBUGLOG(("Authorize() approximate_fee_rate = [%f]\n",dTmp));
        }
	else {
		dTmp = 0.0;
DEBUGLOG(("Authorize() approximate_fee_rate = [%f]\n",dTmp));
		PutField_Double(hTxn, "approximate_fee_rate", dTmp);
	}


/* disabled */
	if (GetField_CString(hRequest, "disabled", &csTmp)) {
		iTmp = atoi(csTmp);
DEBUGLOG(("Authorize::disabled = [%d]\n",iTmp));
		PutField_Int(hTxn, "disabled", iTmp);
	}
	else {
DEBUGLOG(("Authorize::disabled not found!!\n"));
		PutField_Int(hTxn, "disabled", PD_FALSE);
	}

/* effect_date */
	if (!GetField_CString(hRequest, "effect_date", &csTmp)) {
		if(GetField_CString(hContext,"PHDATE",&csTmp)){
DEBUGLOG(("Authorize::effect_date (phdate) = [%s]\n",csTmp));
			PutField_CString(hTxn,"effect_date",csTmp);
		}
		else{
DEBUGLOG(("Authorize::phdate not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::phdate not found!!\n");
			iRet=INT_PHDATE_NOT_FOUND;
		}
	}
	else {
		PutField_CString(hTxn,"effect_date",csTmp);
DEBUGLOG(("Authorize:: effect_date = [%s]\n",csTmp));
	}

/* key_type */
        if(GetField_CString(hRequest,"key_type",&csTmp)){
                PutField_CString(hTxn, "key", csTmp);
DEBUGLOG(("Authorize::key type = [%s]\n",csTmp));
        }
        else {
DEBUGLOG(("Authorize::key type not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::key type not found!!\n");
                iRet=INT_KEY_TYPE_NOT_FOUND;
        }

/* key_value */
        if(GetField_CString(hRequest,"key_value",&csTmp)){
                PutField_CString(hTxn, "key_value", csTmp);
DEBUGLOG(("Authorize::key value = [%s]\n",csTmp));
        }
        else {
DEBUGLOG(("Authorize::key value not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::key value not found!!\n");
                iRet=INT_KEY_VALUE_NOT_FOUND;
        }

/* txn_country */
        if(GetField_CString(hRequest,"txn_country",&csTmp)){
                PutField_CString(hTxn, "country", csTmp);
DEBUGLOG(("Authorize::country = [%s]\n",csTmp));
        }
        else {
DEBUGLOG(("Authorize::country not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::country not found!!\n");
                iRet=INT_TXN_COUNTRY_NOT_FOUND;
        }

/* ccy */
        if(GetField_CString(hRequest,"txn_ccy",&csTmp)){
                PutField_CString(hTxn, "ccy", csTmp);
DEBUGLOG(("Authorize::ccy = [%s]\n",csTmp));
        }
        else {
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
	}

/* service */
        if(GetField_CString(hRequest,"service_code",&csTmp)){
                PutField_CString(hTxn, "service_code", csTmp);
DEBUGLOG(("Authorize::service_code = [%s]\n",csTmp));
        }
        else {
DEBUGLOG(("Authorize::service_code not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::service_code not found!!\n");
                iRet=INT_SERVICE_CODE_MISSING;
	}


/* allow_payout */
        if(GetField_CString(hRequest,"allow_payout",&csTmp)){
		iTmp = atoi(csTmp);
                PutField_Int(hTxn, "allow_payout", iTmp);
DEBUGLOG(("Authorize::allow_payout = [%s]\n",csTmp));
        }
        else {
DEBUGLOG(("Authorize::allow_payout not found!!\n"));
		PutField_Int(hTxn, "allow_payout", PD_FALSE);
        }

/* status */
	PutField_CString(hTxn, "status", PD_ACC_OPEN);


/* add_user */
        if(GetField_CString(hRequest,"add_user",&csTmp)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csTmp));
                PutField_CString(hTxn,"create_user",csTmp);
        }

/* Merchant ID */
	if (GetField_CString(hRequest, "merchant_id", &csMid)){
                PutField_CString(hTxn, "merchant_id", csMid);
DEBUGLOG(("Authorize::merhant_id = [%s]\n",csMid));
	}
	else {
DEBUGLOG(("Authorize::gen a new merhant_id\n"));

		if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMerchDetail:GenMerchantId\n"));
	                DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GenMerchantId");
			if((unsigned long)((*DBObjPtr)(csMid) != PD_OK)){
DEBUGLOG(("Authorize::DBMerchDetail:GenMerchantId Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBMerchDetail:GenMerchantId Failed\n");
				iRet = PD_ERR;
			}
			else {
DEBUGLOG(("Authorize::DBMerchDetail:GenMerchantId mid = [%s]\n", csMid));
				PutField_CString(hTxn, "merchant_id", csMid);
			}
		}

	}

	
	/* Merch Detail */
        if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMerchDetail:Add\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","Add");
                if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBMerchDetail:Add Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBMerchDetail:Add Failed\n");
                        iRet = INT_ERR;
                }
		else {
DEBUGLOG(("Authorize::DBMerchDetail:Add Succ\n"));
		}
        }

	/* Merch Keys */
        if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMerchKeys:Add\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchKeys","Add");
                if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBMerchKeys:Add Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBMerchKeys:Add Failed\n");
                        iRet = INT_ERR;
                }
                else {
DEBUGLOG(("Authorize::DBMerchKeys:Add Succ\n"));
                }
        }

	/* Merchant Bal Acct*/
        if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMerchantBalAcct:Add\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchantBalAcct","Add");
                if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBMerchantBalAcct:Add Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBMerchantBalAcct:Add Failed\n");
                        iRet = INT_ERR;
                }
                else {
DEBUGLOG(("Authorize::DBMerchantBalAcct:Add Succ\n"));
                }
        }


	if (iRet == PD_OK) {
		PutField_CString(hResponse, "merchant_id", csMid);
	}


	if(iRet!=PD_OK){
		PutField_Int(hContext,"internal_error",iRet);
	}


	hash_destroy(hTxn);
	FREE_ME(hTxn);
	FREE_ME(csMid);

DEBUGLOG(("TxnMgtByUsMCR Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}

