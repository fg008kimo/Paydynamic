/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/01/10              Virginia Yun
Amend to include update action			   2012/06/13              Virginia Yun
Include allow_reserved, release_reserved_period
        allow_payout_dup_merch_ref                 2012/08/16              Virginia Yun
Include settlement_process_period		   2012/08/30		   Virginia Yun
Add aupport auto-settlement and sett_id
	and Call RuelAutoSettlement Add/Update	   2012/11/06		   LokMan Chow
Add short_name					   2012/12/06		   Stan Poon
Remove merchant_type				   2012/12/11		   LokMan Chow
Handle merchant level reserve rate		   2012/12/12		   Stan Poon
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsMCR.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

#include "sha1.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

char *csWeek[]={"0", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"};

void TxnMgtByUsMCR(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{

	int	iRet = PD_OK;

	char	*csTmp = NULL;	
	char	*csKeyType = strdup(""); 
	char	csKeyValue[PD_MD5_KEY_LEN + 1];

        SHA1Context sha;
        char csDateTime[PD_DATETIME_LEN + 1];
        char csDesc[PD_DESC_LEN + 1];

	int	iTmp, i ;
	double	dTmp = 0.0;
	double	dValue = 0.0;

	char	*csMid = strdup("");
	//char	cType;
	char	cAction;
	char	cUpdateType = '0';
	char	cSettType = 'M';

	int	iSupportAutoSett = PD_FALSE;

	hash_t  *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn, 0);

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	memset(csKeyValue, 0, sizeof(csKeyValue));
	memset(csDateTime, 0, sizeof(csDateTime));


DEBUGLOG(("TxnMgtByUsMCR::Authorize\n"));

/* Action */
	if (GetField_CString(hRequest, "action", &csTmp)) {
		cAction = csTmp[0];
		// not support delete
		if (cAction != PD_ACTION_ADD && cAction != PD_ACTION_UPDATE) {
DEBUGLOG(("Authorize::action [%d] not accepted!!\n", cAction));
ERRLOG("TxnMgtByUsMCR::Authorize::action not found!!\n");
			iRet=INT_ACTION_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
		}
	} 
	else {
DEBUGLOG(("Authorize::action not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::action not found!!\n");
                iRet=INT_ACTION_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
	}

	// Merchant ID is expected input also!
	if (GetField_CString(hRequest, "newmid", &csMid)){
		PutField_CString(hTxn, "merchant_id", csMid);
		PutField_Char(hTxn, "party_type", 'M');
		PutField_CString(hTxn, "party_id", csMid);
DEBUGLOG(("Authorize::merhant_id = [%s]\n",csMid));
DEBUGLOG(("Authorize::party_type = [%c]\n",'M'));
DEBUGLOG(("Authorize::party_id = [%s]\n",csMid));
	}
	else {
DEBUGLOG(("Authorize::merchant_id not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::merchant_id not found!!\n");
		iRet=INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
	}

/* add_user */
        if(GetField_CString(hRequest,"add_user",&csTmp)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csTmp));
                PutField_CString(hTxn,"create_user",csTmp);
		PutField_CString(hTxn, "update_user", csTmp);
        }


	if (iRet == PD_OK) {
		if (cAction == PD_ACTION_UPDATE) {
			if (GetField_CString(hRequest, "update_type", &csTmp)) {
				cUpdateType = csTmp[0];
			}
			else {
DEBUGLOG(("Authorize::update_type not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::update_type not found!!\n");
		                iRet=INT_ERR;
               			 PutField_Int(hContext,"internal_error",iRet);
			}
		}
	}


	if (iRet == PD_OK) {
		if (cAction == PD_ACTION_ADD || 
			(cAction == PD_ACTION_UPDATE && (cUpdateType == PD_UPDATE_MERCH_INFO || cUpdateType == PD_UPDATE_ALL))) {
			/* name */
			if(GetField_CString(hRequest,"name",&csTmp)){
				PutField_CString(hTxn, "name", csTmp);
DEBUGLOG(("Authorize::name = [%s]\n",csTmp));
			}
			else {
DEBUGLOG(("Authorize::name not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::name not found!!\n");
				iRet=INT_MERCHANT_NAME_NOT_FOUND;

				PutField_Int(hContext,"internal_error",iRet);
			}

			/*short_name*/
			if(GetField_CString(hRequest, "short_name", &csTmp)) {
				PutField_CString(hTxn, "short_name",csTmp);
DEBUGLOG(("Authorize::short_name = [%s]\n",csTmp));
			}

                        /* approximate_fee_rate */
                        if(GetField_CString(hRequest,"fee_rate",&csTmp)){
                                dTmp = string2double((const unsigned char *)csTmp);
                                PutField_Double(hTxn,"approximate_fee_rate",dTmp);
DEBUGLOG(("Authorize() approximate_fee_rate = [%f]\n",dTmp));
                        }
                        else {
                                dTmp = 0.0;
DEBUGLOG(("Authorize() approximate_fee_rate (default) = [%f]\n",dTmp));
                                PutField_Double(hTxn, "approximate_fee_rate", dTmp);
                        }

			/* status */
			if (GetField_CString(hRequest, "status", &csTmp)) {
DEBUGLOG(("Authorize() status = [%s]\n",csTmp));
				PutField_CString(hTxn, "status", csTmp);

			} else {
DEBUGLOG(("Authorize() status (default) = [%s]\n",PD_ACC_OPEN));
				PutField_CString(hTxn, "status", PD_ACC_OPEN);
			}

			/* allow_reserved */
			if (GetField_CString(hRequest, "allow_reserved", &csTmp)) {
				iTmp = atoi(csTmp);
				PutField_Int(hTxn, "allow_reserved", iTmp);
DEBUGLOG(("Authorize() allow_reserved = [%d]\n",iTmp));

			} else {
				PutField_Int(hTxn, "allow_reserved", PD_TRUE);
DEBUGLOG(("Authorize() allow_reserved (default) = [%d]\n",PD_TRUE));
			}

			/* release_reserved_period */
			if (GetField_CString(hRequest, "release_period", &csTmp)) {
				iTmp = atoi(csTmp);
				PutField_Int(hTxn, "release_reserved_period", iTmp);
DEBUGLOG(("Authorize() release_reserved_period = [%d]\n",iTmp));
			} else {
				PutField_Int(hTxn, "release_reserved_period", PD_DEF_RELEASE_PERIOD);
DEBUGLOG(("Authorize() release_reserved_period (default) = [%d]\n",PD_DEF_RELEASE_PERIOD));
			}

			/* allow_payout_dup_merch_ref */
			if (GetField_CString(hRequest, "allow_po_dup_merch_ref", &csTmp)) {
				iTmp = atoi(csTmp);
				PutField_Int(hTxn, "allow_payout_dup_merch_ref", iTmp);
DEBUGLOG(("Authorize() allow_po_dup_merch_ref = [%d]\n",iTmp));

			} else {
				PutField_Int(hTxn, "allow_payout_dup_merch_ref", PD_TRUE);
DEBUGLOG(("Authorize() allow_po_dup_merch_ref (default) = [%d]\n",PD_TRUE));
			}

			/* settlement_process_period */
			if (GetField_CString(hRequest, "sett_proc_period", &csTmp)) {
				iTmp = atoi(csTmp);
				PutField_Int(hTxn, "settlement_process_period", iTmp);
DEBUGLOG(("Authorize() settlement_process_period = [%d]\n",iTmp));

			} else {
				PutField_Int(hTxn, "settlement_process_period", 0);
DEBUGLOG(("Authorize() settlement_process_period (default) = [%d]\n", 0));

			}

			/* ind_reserve  +  reserve_rate */
			char *csIndRes = NULL, *csResRate = NULL;	
			if (GetField_CString(hRequest, "ind_reserve", &csIndRes) && GetField_CString(hRequest,"reserve_rate",&csResRate)){
				iTmp = atoi(csIndRes);
				dTmp = string2double((const unsigned char *)csResRate);
					
				PutField_Int(hTxn, "ind_reserve", iTmp);
				PutField_Double(hTxn,"reserve_rate",dTmp);
DEBUGLOG(("Authorize() ind_reserve = [%d]\n",iTmp));
DEBUGLOG(("Authorize() reserve_rate = [%f]\n",dTmp));

			}else {
				PutField_Int(hTxn, "ind_reserve", 0);
				PutField_Double(hTxn, "reserve_rate", 0.0);
DEBUGLOG(("Authorize() ind_reserve (default**) = [%d]\n", 0));
DEBUGLOG(("Authorize() reserve_rate (default**) = [%f]\n", 0.0));
			}

		}

		if (cAction == PD_ACTION_ADD) {
			/* business_type */
/*
			if (GetField_CString(hRequest, "type", &csTmp)) {
				cType = csTmp[0];
DEBUGLOG(("Authorize::type = [%c]\n",cType));
				PutField_Char(hTxn, "merchant_type", cType);
			}
			else {
DEBUGLOG(("Authorize::business_type not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::business_type not found!!\n");
				iRet=INT_BUSINESS_TYPE_NOT_FOUND;

				PutField_Int(hContext,"internal_error",iRet);
			}
*/
			/* client_id */
			if(GetField_CString(hRequest,"client_id",&csTmp)){
				PutField_CString(hTxn, "client_id", csTmp);
DEBUGLOG(("Authorize::client_id = [%s]\n",csTmp));
			}
			else {
DEBUGLOG(("Authorize::client_id not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::client_id not found!!\n");
				iRet=INT_CLIENT_ID_NOT_FOUND;

				PutField_Int(hContext,"internal_error",iRet);
			}

			/* disabled */
			if (GetField_CString(hRequest, "disabled", &csTmp)) {
				iTmp = atoi(csTmp);
DEBUGLOG(("Authorize::disabled = [%d]\n",iTmp));
				PutField_Int(hTxn, "disabled", iTmp);
			}
			else {
DEBUGLOG(("Authorize::disabled not found!!\n"));
				PutField_Int(hTxn, "disabled", PD_FALSE);
			}

			/* status */
			/*
			PutField_CString(hTxn, "status", PD_ACC_OPEN);
			*/

			/*support_auto_sett*/
			iSupportAutoSett = PD_FALSE;
			if(GetField_CString(hRequest, "support_auto_sett", &csTmp)) {
				iSupportAutoSett = atoi(csTmp);
DEBUGLOG(("Authorize::support_auto_sett = [%d]\n",iSupportAutoSett));
			}
			PutField_Int(hTxn, "support_auto_sett",iSupportAutoSett);

			if(iSupportAutoSett == PD_TRUE){
				/*auto_sett_type*/
				if(GetField_CString(hRequest, "sett_type", &csTmp)) {
					cSettType = csTmp[0];
					PutField_Char(hTxn, "sett_type", cSettType);
DEBUGLOG(("Authorize::auto_sett_type = [%c]\n",cSettType));
				}

				/*auto_sett_value*/
				dValue = 0.0;
				if(GetField_CString(hRequest,"sett_value",&csTmp)){
					sscanf(csTmp,"%lf",&dValue);
					if(dValue < 0.0){
						iRet = INT_INVALID_TXN;
					}
DEBUGLOG(("Authorize::auto_sett_value = [%lf]\n",dValue));
				}
				PutField_Double(hTxn, "sett_value",dValue);

				/*desc*/
				if(GetField_CString(hRequest,"sett_desc",&csTmp)){
					PutField_CString(hTxn, "desc",csTmp);
DEBUGLOG(("Authorize::sett_desc = [%s]\n",csTmp));
				}
				else{
					csDesc[0]='\0';
					if(cSettType!='A'){
						int iValue = (int)dValue;
						if(cSettType == 'D'){
							if(iValue>0)
								sprintf(csDesc,"Every %d Day(s)",iValue);
							else
								iRet = INT_INVALID_TXN;
						}
						else if(cSettType == 'W'){
							if(iValue < 1 || iValue > 7){
								iRet = INT_INVALID_TXN;
							}
							else{
								sprintf(csDesc,"Every %s", csWeek[iValue]);
							}
						}
						else if(cSettType == 'M'){
							if (iValue<=31)
								sprintf(csDesc,"Every Date %d",iValue);
							else if (iValue==99)
								sprintf(csDesc,"Every Month-End");
							else
								iRet = INT_INVALID_TXN;
						}
					}
					else{
						sprintf(csDesc,"Amount Exceed %.2f",dValue);
					}
					if(strlen(csDesc)){
						PutField_CString(hTxn, "desc", csDesc);
DEBUGLOG(("Authorize::sett_desc (auto generated)= [%s]\n",csDesc));
					}
				}
		
				if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBRuleAutoSettlement:Add\n"));
					DBObjPtr = CreateObj(DBPtr,"DBRuleAutoSettlement","Add");
					if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBRuleAutoSettlement:Add Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBRuleAutoSettlement:Add Failed\n");
						iRet = INT_ERR;
					}
					else{
						if(GetField_Int(hTxn,"auto_sett_id",&iTmp)){
DEBUGLOG(("Authorize::auto_sett_id = [%d]\n",iTmp));
						}
					}
				}
				else{
					PutField_Int(hContext,"internal_error",iRet);
				}
			}
		}
		if(cAction == PD_ACTION_UPDATE && (cUpdateType == PD_UPDATE_MERCH_INFO || cUpdateType == PD_UPDATE_ALL)){
			/*support_auto_sett*/
			if(GetField_CString(hRequest, "support_auto_sett", &csTmp)) {
				iSupportAutoSett = atoi(csTmp);
				PutField_Int(hTxn, "support_auto_sett",iSupportAutoSett);
DEBUGLOG(("Authorize::support_auto_sett = [%d]\n",iSupportAutoSett));
			}

			/*auto_sett_id*/
			int iSettId = PD_NOT_FOUND;
			if(GetField_CString(hRequest, "auto_sett_id", &csTmp)) {
				iTmp = atoi(csTmp);
				PutField_Int(hTxn, "auto_sett_id",iTmp);
				iSettId = PD_FOUND;
			}
			if(iSupportAutoSett){	
				/*auto_sett_type*/
				if(GetField_CString(hRequest, "sett_type", &csTmp)) {
					cSettType = csTmp[0];
					PutField_Char(hTxn, "sett_type", cSettType);
DEBUGLOG(("Authorize::auto_sett_type = [%c]\n",cSettType));
				}

				/*auto_sett_value*/
				dValue = 0.0;
				if(GetField_CString(hRequest,"sett_value",&csTmp)){
					sscanf(csTmp,"%lf",&dValue);
					if(dValue < 0.0){
						iRet = INT_INVALID_TXN;
					}
DEBUGLOG(("Authorize::auto_sett_value = [%lf]\n",dValue));
				}
				PutField_Double(hTxn, "sett_value",dValue);

				/*desc*/
				if(GetField_CString(hRequest,"sett_desc",&csTmp)){
					PutField_CString(hTxn, "desc",csTmp);
DEBUGLOG(("Authorize::sett_desc = [%s]\n",csTmp));
				}
				else{
					csDesc[0]='\0';
					if(cSettType!='A'){
						int iValue = (int)dValue;
						if(cSettType == 'D'){
							if(iValue>0)
								sprintf(csDesc,"Every %d Day(s)",iValue);
							else
								iRet = INT_INVALID_TXN;
						}
						else if(cSettType == 'W'){
							if(iValue < 1 || iValue > 7){
								iRet = INT_INVALID_TXN;
							}
							else{
								sprintf(csDesc,"Every %s", csWeek[iValue]);
							}
						}
						else if(cSettType == 'M'){
							if (iValue<=31)
								sprintf(csDesc,"Every Date %d",iValue);
							else if (iValue==99)
								sprintf(csDesc,"Every Month-End");
							else
								iRet = INT_INVALID_TXN;
						}
					}
					else{
						sprintf(csDesc,"Amount Exceed %.2f",dValue);
					}
					if(strlen(csDesc)){
						PutField_CString(hTxn, "desc", csDesc);
DEBUGLOG(("Authorize::sett_desc (auto generated)= [%s]\n",csDesc));
					}
				}

				if(iSettId==PD_FOUND){
DEBUGLOG(("Authorize::Call DBRuleAutoSettlement:Update\n"));
					DBObjPtr = CreateObj(DBPtr,"DBRuleAutoSettlement","Update");
					if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBRuleAutoSettlement:Update Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBRuleAutoSettlement:Update Failed\n");
						iRet = INT_ERR;
					}
				}
				else{
DEBUGLOG(("Authorize::Call DBRuleAutoSettlement:Add\n"));
					DBObjPtr = CreateObj(DBPtr,"DBRuleAutoSettlement","Add");
					if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBRuleAutoSettlement:Add Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBRuleAutoSettlement:Add Failed\n");
						iRet = INT_ERR;
					}
					else{
						if(GetField_Int(hTxn,"auto_sett_id",&iTmp)){
DEBUGLOG(("Authorize::auto_sett_id = [%d]\n",iTmp));
						}
					}
				}
			}
			else{
DEBUGLOG(("Authorize::Call DBMerchDetail:ClearAutoSettId\n"));
				DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","ClearAutoSettId");
				if((unsigned long)((*DBObjPtr)(csMid) != PD_OK)){
DEBUGLOG(("Authorize::DBMerchDetail:ClearAutoSettId Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBMerchDetail:ClearAutoSettId Failed\n");
					iRet = INT_ERR;
				}
			}
		}

		if (cAction == PD_ACTION_ADD || 
			(cAction == PD_ACTION_UPDATE && (cUpdateType == PD_UPDATE_KEY || cUpdateType == PD_UPDATE_ALL))) {
			/* effect_date */
			if (GetField_CString(hRequest, "effect_date", &csTmp)) {
				PutField_CString(hTxn,"effect_date",csTmp);
DEBUGLOG(("Authorize:: effect_date = [%s]\n",csTmp));
			}
			else {
				if (GetField_CString(hContext, "PHDATE", &csTmp)) {
DEBUGLOG(("Authorize::effect_date (phdate) = [%s]\n",csTmp));
					PutField_CString(hTxn,"effect_date",csTmp);

				} else {

DEBUGLOG(("Authorize::effect_date not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::effect_date not found!!\n");
					iRet=INT_ERR;
	
					PutField_Int(hContext,"internal_error",iRet);
				}
			}

			/* key_type */
			if(GetField_CString(hRequest,"key_type",&csKeyType)){
       	         		PutField_CString(hTxn, "key", csKeyType);
DEBUGLOG(("Authorize::key type = [%s]\n",csKeyType));
			}
			else {
				strcpy(csKeyType, PD_PTK_KEY_NAME);
       	         		PutField_CString(hTxn, "key", PD_PTK_KEY_NAME);
DEBUGLOG(("Authorize::key type (default) [%s]\n", PD_PTK_KEY_NAME));

/*
DEBUGLOG(("Authorize::key type not found!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::key type not found!!\n");
                		iRet=INT_KEY_TYPE_NOT_FOUND;

				PutField_Int(hContext,"internal_error",iRet);
*/
        		}

			/* Gen key_value */
			if (iRet == PD_OK) {
				if (!strcmp(csKeyType, PD_PTK_KEY_NAME)) {
DEBUGLOG(("Authorize::gen [%s]\n", csKeyType));

					// len 128
					strcpy(csKeyValue, random_gen(PD_MD5_KEY_LEN));
					csKeyValue[PD_MD5_KEY_LEN]='\0';


					PutField_CString(hTxn, "key_value", csKeyValue);
				} else if ((!strcmp(csKeyType, PD_SHA1_KEY_NAME)) || (!strcmp(csKeyType, PD_POK_KEY_NAME))) {

					// len 32
					strcpy(csDateTime,getdatetime());
					csDateTime[PD_DATETIME_LEN]='\0';

					SHA1Reset(&sha);
					SHA1Input(&sha, (const unsigned char *)csDateTime, strlen(csDateTime));

					if (SHA1Result(&sha)) {
						for(i = 0; i < 4 ; i++) {
							sprintf(&csKeyValue[i*8], "%08X", sha.Message_Digest[i]);
						}
						csKeyValue[PD_SHA_KEY_LEN]='\0';
						PutField_CString(hTxn, "key_value", csKeyValue);
					}
				} else {
DEBUGLOG(("Authorize::key type invalid!!\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::key type invalid !!\n");

					iRet = INT_KEY_TYPE_NOT_FOUND;
					PutField_Int(hContext,"internal_error",iRet);
				}
DEBUGLOG(("Authorize::key_value = [%s]\n",csKeyValue));
			}
		}
	}

	/* Merch Detail */
        if (iRet == PD_OK) {
 		if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize::Call DBMerchDetail:Add\n"));
                	DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","Add");
	                if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBMerchDetail:Add Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBMerchDetail:Add Failed\n");
       	                 iRet = INT_ERR;
			}
			else {
DEBUGLOG(("Authorize::DBMerchDetail:Add Succ\n"));
			}
		} else if (cAction == PD_ACTION_UPDATE) {
			if (cUpdateType == PD_UPDATE_MERCH_INFO || cUpdateType == PD_UPDATE_ALL) {
DEBUGLOG(("Authorize::Call DBMerchDetail:UpdateMerchantStatus\n"));
	                	DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","UpdateMerchantStatus");
		                if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBMerchDetail:UpdateMerchantStatus Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBMerchDetail:UpdateMerchantStatus Failed\n");
		       	                 iRet = INT_ERR;
				}
				else {
DEBUGLOG(("Authorize::DBMerchDetail:UpdateMerchantStatus Succ\n"));
				}	
			}
		}

		if (cAction == PD_ACTION_ADD || 
			(cAction == PD_ACTION_UPDATE && (cUpdateType == PD_UPDATE_MERCH_INFO || cUpdateType == PD_UPDATE_ALL))) {
DEBUGLOG(("Authorize::Call BOReserve:HandleReserveAmount\n"));
				DBObjPtr = CreateObj(DBPtr,"BOReserve","HandleReserveAmount");
				if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::BOReserve:HandleReserveAmount Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::BOReserve:HandleReserveAmount Failed\n");
					iRet = INT_ERR;
				}
				else {
DEBUGLOG(("Authorize::BOReserve:HandleReserveAmount Succ\n"));
				}	        	
		}
	}

	/* Merch Keys */
        if (iRet == PD_OK) {
		if (cAction == PD_ACTION_UPDATE) {
DEBUGLOG(("Authorize::Call DBMerchDetail:GetMerchant\n"));
	                DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GetMerchant");
			if((unsigned long)((*DBObjPtr)(csMid, rRecordSet) != PD_OK)){
DEBUGLOG(("Authorize::Call DBMerchDetail:GetMerchant Fail\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBMerchDetail:GetMerchant Failed\n");
				iRet = INT_MERCHANT_ID_NOT_FOUND;

				PutField_Int(hContext,"internal_error",iRet);
			}
		}

		if (iRet == PD_OK) {
			if (cAction == PD_ACTION_ADD||		
			    (cAction == PD_ACTION_UPDATE && (cUpdateType == PD_UPDATE_KEY || cUpdateType == PD_UPDATE_ALL))) {

DEBUGLOG(("Authorize::Call DBMerchKeys:Add\n"));
				DBObjPtr = CreateObj(DBPtr,"DBMerchKeys","Add");
				if((unsigned long)((*DBObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::DBMerchKeys:Add Failed\n"));
ERRLOG("TxnMgtByUsMCR::Authorize::DBMerchKeys:Add Failed\n");
					iRet = INT_ERR;
                		}
	                	else {
DEBUGLOG(("Authorize::DBMerchKeys:Add Succ\n"));
				}
        		}
		}
	}

	if (iRet == PD_OK) {
		PutField_CString(hResponse, "merchant_id", csMid);
		//PutField_CString(hResponse, "key_value", csKeyValue);
	}

	FREE_ME(csMid);
	FREE_ME(csKeyType);

	hash_destroy(hTxn);
	FREE_ME(hTxn);

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("TxnMgtByUsMCR Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}

