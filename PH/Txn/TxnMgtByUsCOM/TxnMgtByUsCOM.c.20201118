/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version  					   2011/06/23		   Cody Chan 
txn_amt not 0 or 0.0				   2012/12/21		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsCOM.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMgtByUsCOM(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iCnt;
	int	iCheck;
	char	*csPtr;
	char	*p;
	char	*csTxnCountry=strdup("");
	char	*csTxnCcy;
	double	dTmp;
	long    lTmp;


/* merchant id */
	if(GetField_CString(hRequest,"merchant_id",&csPtr)){
DEBUGLOG(("Authorize()merchant_id from request[%s]\n",csPtr));
		BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantDetail");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
		if(iRet!=PD_OK){
			iRet = INT_MERCHANT_ID_NOT_FOUND;
                       	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()merchant_id Invalid[%s]\n",csPtr));
ERRLOG("TxnMgtByUsCOM::Authorize() merchant_id Invalid\n");
		}
	}
/* to merchant id */
	if(GetField_CString(hRequest,"to_merchant_id",&csPtr) && iRet == PD_OK){
DEBUGLOG(("Authorize() to_merchant_id from request[%s]\n",csPtr));
		hash_t* hReq;
		hReq = (hash_t*) malloc (sizeof(hash_t));	
		hash_init(hReq,0);
		PutField_CString(hReq,"merchant_id",csPtr);

		BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantDetail");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hReq);
		if(iRet!=PD_OK){
			iRet = INT_MERCHANT_ID_NOT_FOUND;
                       	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() to_merchant_id Invalid[%s]\n",csPtr));
ERRLOG("TxnMgtByUsCOM::Authorize()  to_merchant_id Invalid\n");
		}
		FREE_ME(hReq);
	}

/* txn ccy */
        if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy) && iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBCurrency","FindCurrency");
             	if ((unsigned long)(DBObjPtr)(csTxnCcy) == FOUND) {
DEBUGLOG(("Authorize() Found txn_ccy [%s]\n",csTxnCcy));
                }
                else{
               		iRet = INT_INVALID_CURRENCY_CODE;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Currency code invalid [%s]\n",csTxnCcy));
ERRLOG("TxnMgtByUsCOM:Authorize() Currency code invalid\n",csTxnCcy);
                }
        }

/* txn amt */
	if(GetField_CString(hRequest,"txnamt",&csPtr) && iRet == PD_OK){
		iCheck = PD_FALSE;
		p = (char*)strchr(csPtr, '.');
		if (p == NULL){
			iCheck = is_numeric(csPtr);
			if(iCheck!=PD_FALSE){
				//dTmp = myctod(csPtr,strlen(csPtr) - PD_DECIMAL_LEN,PD_DECIMAL_LEN);
				if(sscanf(csPtr,"%lf",&dTmp)==1){
					PutField_Double(hContext,"txn_amt",dTmp);
DEBUGLOG(("Authorize() txn_amt = [%f]\n",dTmp));
				}
				/*
				if(!(dTmp > 0.0)){
					iRet =  INT_INVALID_PAY_AMOUNT;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()txn_amt Invalid[%s]\n",csPtr));
ERRLOG("TxnMgtByUsCOM::Authorize() txn_amt Invalid\n");
				}*/
			}
		}
		else{
			if(sscanf(csPtr,"%lf",&dTmp)==1){
				iCheck = PD_TRUE;
				PutField_Double(hContext,"txn_amt",dTmp);
DEBUGLOG(("Authorize() txn_amt = [%f]\n",dTmp));
			}
			/*if(!(dTmp > 0.0)){
				iRet =  INT_INVALID_PAY_AMOUNT;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()txn_amt Invalid[%s]\n",csPtr));
ERRLOG("TxnMgtByUsCOM::Authorize() txn_amt Invalid\n");
			}*/

			DBObjPtr = CreateObj(DBPtr,"DBCurrency","IsSupportDecimal");
			if ((unsigned long)((DBObjPtr)(csTxnCcy))!=PD_TRUE){
DEBUGLOG(("TxnMgtOnUsCOM::Authorize() [%s] doesn't support decimal\n",csTxnCcy));
				lTmp = (long) dTmp;
				if (dTmp > lTmp) {
					iRet = INT_UNSUPPORTED_PAY_AMOUNT;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("TxnMgtOnUsCOM::Authorize() unsupported transaction amount [%f]\n",dTmp));
ERRLOG("TxnMgtOnUsCOM::Authorize() unsupported transaction amount [%f]\n",dTmp);
				}
				else if(lTmp==0l){
					iRet =  INT_INVALID_PAY_AMOUNT;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()txn_amt Invalid[%s]\n",csPtr));
ERRLOG("TxnMgtByUsCOM::Authorize() txn_amt Invalid\n");
				}
			}
		}	
		if(iCheck==PD_FALSE){
			iRet =  INT_INVALID_PAY_AMOUNT;
                       	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()txn_amt Invalid[%s]\n",csPtr));
ERRLOG("TxnMgtByUsCOM::Authorize() txn_amt Invalid\n");
		}
	}

/* service_fee */
	if(GetField_CString(hRequest,"service_fee",&csPtr) && iRet == PD_OK){
		iCheck = PD_FALSE;
		p = (char*)strchr(csPtr, '.');
		if (p == NULL){
			iCheck = is_numeric(csPtr);
			if(iCheck!=PD_FALSE){
				//dTmp = myctod(csPtr,strlen(csPtr) - PD_DECIMAL_LEN,PD_DECIMAL_LEN);
				if(sscanf(csPtr,"%lf",&dTmp)==1){
					PutField_Double(hContext,"service_fee",dTmp);
DEBUGLOG(("Authorize() txn_amt = [%f]\n",dTmp));
				}
			}
		}
		else{
			if(sscanf(csPtr,"%lf",&dTmp)==1){
				PutField_Double(hContext,"service_fee",dTmp);
DEBUGLOG(("Authorize() txn_amt = [%f]\n",dTmp));
				iCheck = PD_TRUE;
			}
		}	
		if(iCheck==PD_FALSE){
			iRet =  INT_INVALID_PAY_AMOUNT;
                       	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() service_fee Invalid[%s]\n",csPtr));
ERRLOG("TxnMgtByUsCOM::Authorize() service_fee Invalid\n");
		}
	}
/*
	if(GetField_CString(hRequest,"txnamt",&csPtr) && iRet == PD_OK){       
		int iCheck = PD_FALSE;
DEBUGLOG(("Authorize()txn_amt from request[%s]\n",csPtr));
		iCheck = is_numeric(csPtr);
                if(iCheck==PD_FALSE){
               		iRet =  INT_INVALID_PAY_AMOUNT;
                        PutField_Int(hContext,"internal_error",INT_INVALID_PAY_AMOUNT);
DEBUGLOG(("Authorize()txn_amt Invalid[%s]\n",csPtr));
ERRLOG("TxnMgtByUsCOM::Authorize() txn_amt Invalid\n");
               	}     
                else {  
                        dTmp = myctod(csPtr,strlen(csPtr) - PD_DECIMAL_LEN,PD_DECIMAL_LEN);
               		PutField_Double(hContext,"txn_amt",dTmp);
DEBUGLOG(("Authorize() txn_amt = [%f]\n",dTmp));
                }
	}
*/

/* to txn ccy */
        if(GetField_CString(hRequest,"to_txn_ccy",&csPtr) && iRet == PD_OK){
		if(strcmp(csPtr,"RMB"))
			csTxnCcy = strdup(csPtr);
		else
			csTxnCcy=strdup(PD_CCY_ISO_CNY);
		DBObjPtr = CreateObj(DBPtr,"DBCurrency","FindCurrency");
             	if ((unsigned long)(DBObjPtr)(csTxnCcy) == FOUND) {
DEBUGLOG(("Authorize() Found to_txn_ccy [%s]\n",csTxnCcy));
                }
                else{
               		iRet = INT_INVALID_CURRENCY_CODE;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() to Currency code invalid [%s]\n",csPtr));
ERRLOG("TxnMgtByUsCOM:Authorize() to Currency code invalid\n",csPtr);
                }
		FREE_ME(csTxnCcy);
        }

/* txn country */
        if(GetField_CString(hRequest,"txn_country",&csTxnCountry) && iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBCountry","FindCountry");
             	if ((unsigned long)(DBObjPtr)(csTxnCountry) == PD_FOUND) {
DEBUGLOG(("Authorize() Found [%s]\n",csTxnCountry));
                }
                else{
               		iRet = INT_TXN_COUNTRY_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() invalid country [%s]\n",csTxnCountry));
ERRLOG("TxnMgtByUsCOM:Authorize() invalid country [%s]\n",csTxnCountry);
                }
	}

/* service */
	if(GetField_CString(hRequest,"service_code",&csPtr) && iRet == PD_OK){
		if(strlen(csPtr)>PD_SERVICE_CODE_LEN){
			iRet = INT_INVALID_SERVICE_CODE;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() invalid service code[%s]\n",csPtr));
ERRLOG("TxnMgtByUsCOM:Authorize() invalid service code [%s]\n",csPtr);
		}
/*
		else{
			DBObjPtr = CreateObj(DBPtr,"DBService","FindCountryByService");
			if ((unsigned long)(DBObjPtr)(csPtr,csTxnCountry) == PD_FOUND) {
				PutField_CString(hRequest,"txn_country",csTxnCountry);
DEBUGLOG(("Authorize() Found Country [%s] for Service [%s]\n",csTxnCountry,csPtr));
			}
               		else{
               			iRet = INT_INVALID_SERVICE_CODE;
                	       	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() invalid service code[%s]\n",csPtr));
ERRLOG("TxnMgtByUsCOM:Authorize() invalid service code [%s]\n",csPtr);
               		}
		}
*/
	}

/* to service */
        if(GetField_CString(hRequest,"to_service_code",&csPtr) && iRet == PD_OK){
		if(strlen(csPtr)>PD_SERVICE_CODE_LEN){
			iRet = INT_INVALID_SERVICE_CODE;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() invalid service code[%s]\n",csPtr));
ERRLOG("TxnMgtByUsCOM:Authorize() invalid service code [%s]\n",csPtr);
		}
/*
		else{
			DBObjPtr = CreateObj(DBPtr,"DBService","FindCountryByService");
             		if ((unsigned long)(DBObjPtr)(csPtr,csTxnCountry) == PD_FOUND) {
				PutField_CString(hRequest,"txn_country",csTxnCountry);
DEBUGLOG(("Authorize() Found To Country [%s] for Service [%s]\n",csTxnCountry,csPtr));
                	}
                	else{
               			iRet = INT_INVALID_SERVICE_CODE;
                        	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() invalid To service code[%s]\n",csPtr));
ERRLOG("TxnMgtByUsCOM:Authorize() invalid To service code [%s]\n",csPtr);
                	}
		}
*/
        }
/* total cnt */
	if(GetField_CString(hRequest,"total_cnt",&csPtr) && iRet == PD_OK){
		iCheck = is_numeric(csPtr);
		if(iCheck==PD_FALSE){
			iRet =  INT_INVALID_COUNT;
                       	PutField_Int(hContext,"internal_error",iRet);
		}
		else {
			iCnt = atoi(csPtr);
DEBUGLOG(("Authorize() total_cnt = [%d]\n",iCnt));
			PutField_Int(hContext,"total_cnt",iCnt);
		}
	}

	FREE_ME(csTxnCountry);
DEBUGLOG(("Authorize() iRet = [%d]\n",iRet));
	return iRet;
}
