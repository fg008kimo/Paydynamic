/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version  					   2011/06/23		   Cody Chan 
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtOnUsCOM.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMgtOnUsCOM(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iCnt;
	int	iCheck;
	char	*csPtr;
	char	*p;
	double	dTmp;


/* merchant id */
	if(GetField_CString(hRequest,"merchant_id",&csPtr)){
DEBUGLOG(("Authorize()merchant_id from request[%s]\n",csPtr));
		BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantDetail");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
		if(iRet!=PD_OK){
DEBUGLOG(("Authorize()merchant_id Invalid[%s]\n",csPtr));
ERRLOG("TxnMgtOnUsCOM::Authorize() merchant_id Invalid\n");
		}
	}
/* to merchant id */
	if(GetField_CString(hRequest,"to_merchant_id",&csPtr) && iRet == PD_OK){
DEBUGLOG(("Authorize() to_merchant_id from request[%s]\n",csPtr));
		hash_t* hReq;
		hReq = (hash_t*) malloc (sizeof(hash_t));	
		hash_init(hReq,0);
		PutField_CString(hReq,"merchant_id",csPtr);

		BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantDetail");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hReq);
		if(iRet!=PD_OK){
DEBUGLOG(("Authorize() to_merchant_id Invalid[%s]\n",csPtr));
ERRLOG("TxnMgtOnUsCOM::Authorize()  to_merchant_id Invalid\n");
		}
		FREE_ME(hReq);
	}

/* txn amt */
	if(GetField_CString(hRequest,"txnamt",&csPtr) && iRet == PD_OK){
		iCheck = PD_FALSE;
		p = (char*)strchr(csPtr, '.');
		if (p == NULL){
			iCheck = is_numeric(csPtr);
			if(iCheck!=PD_FALSE){
				//dTmp = myctod(csPtr,strlen(csPtr) - PD_DECIMAL_LEN,PD_DECIMAL_LEN);
				if(sscanf(csPtr,"%lf",&dTmp)==1){
					PutField_Double(hContext,"txn_amt",dTmp);
DEBUGLOG(("Authorize() txn_amt = [%f]\n",dTmp));
				}
			}
		}
		else{
			if(sscanf(csPtr,"%lf",&dTmp)==1){
				PutField_Double(hContext,"txn_amt",dTmp);
DEBUGLOG(("Authorize() txn_amt = [%f]\n",dTmp));
				iCheck = PD_TRUE;
			}
		}	
		if(iCheck==PD_FALSE){
			iRet =  INT_INVALID_PAY_AMOUNT;
                       	PutField_Int(hContext,"internal_error",INT_INVALID_PAY_AMOUNT);
DEBUGLOG(("Authorize()txn_amt Invalid[%s]\n",csPtr));
ERRLOG("TxnMgtOnUsCOM::Authorize() txn_amt Invalid\n");
		}
	}
/*
	if(GetField_CString(hRequest,"txnamt",&csPtr) && iRet == PD_OK){       
		int iCheck = PD_FALSE;
DEBUGLOG(("Authorize()txn_amt from request[%s]\n",csPtr));
		iCheck = is_numeric(csPtr);
                if(iCheck==PD_FALSE){
               		iRet =  INT_INVALID_PAY_AMOUNT;
                        PutField_Int(hContext,"internal_error",INT_INVALID_PAY_AMOUNT);
DEBUGLOG(("Authorize()txn_amt Invalid[%s]\n",csPtr));
ERRLOG("TxnMgtOnUsCOM::Authorize() txn_amt Invalid\n");
               	}     
                else {  
                        dTmp = myctod(csPtr,strlen(csPtr) - PD_DECIMAL_LEN,PD_DECIMAL_LEN);
               		PutField_Double(hContext,"txn_amt",dTmp);
DEBUGLOG(("Authorize() txn_amt = [%f]\n",dTmp));
                }
	}
*/

/* txn ccy */
        if(GetField_CString(hRequest,"txn_ccy",&csPtr) && iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBCurrency","FindCurrency");
             	if ((unsigned long)(DBObjPtr)(csPtr) == FOUND) {
DEBUGLOG(("Authorize() Found txn_ccy [%s]\n",csPtr));
                }
                else{
               		iRet = INT_INVALID_CURRENCY_CODE;
                        PutField_Int(hContext,"internal_error",INT_INVALID_CURRENCY_CODE);
DEBUGLOG(("Authorize() Currency code invalid [%s]\n",csPtr));
ERRLOG("TxnMgtOnUsCOM:Authorize() Currency code invalid\n",csPtr);
                }
        }
/* to txn ccy */
        if(GetField_CString(hRequest,"to_txn_ccy",&csPtr) && iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBCurrency","FindCurrency");
             	if ((unsigned long)(DBObjPtr)(csPtr) == FOUND) {
DEBUGLOG(("Authorize() Found to_txn_ccy [%s]\n",csPtr));
                }
                else{
               		iRet = INT_INVALID_CURRENCY_CODE;
                        PutField_Int(hContext,"internal_error",INT_INVALID_CURRENCY_CODE);
DEBUGLOG(("Authorize() to Currency code invalid [%s]\n",csPtr));
ERRLOG("TxnMgtOnUsCOM:Authorize() to Currency code invalid\n",csPtr);
                }
        }

/* txn country */
        if(GetField_CString(hRequest,"txn_country",&csPtr) && iRet == PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBCountry","FindCountry");
             	if ((unsigned long)(DBObjPtr)(csPtr) == PD_FOUND) {
DEBUGLOG(("Authorize() Found [%s]\n",csPtr));
                }
                else{
               		iRet = INT_TXN_COUNTRY_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() invalid country [%s]\n",csPtr));
ERRLOG("TxnMgtOnUsCOM:Authorize() invalid country [%s]\n",csPtr);
                }
        }


/* total cnt */
	if(GetField_CString(hRequest,"total_cnt",&csPtr) && iRet == PD_OK){
		iCheck = is_numeric(csPtr);
		if(iCheck==PD_FALSE){
			iRet =  INT_INVALID_COUNT;
                       	PutField_Int(hContext,"internal_error",INT_INVALID_PAY_AMOUNT);
		}
		else {
			iCnt = atoi(csPtr);
DEBUGLOG(("Authorize() total_cnt = [%d]\n",iCnt));
			PutField_Int(hContext,"total_cnt",iCnt);
		}
	}
	return iRet;
}
