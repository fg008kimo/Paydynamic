/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/08/31              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnWebOnUs2TWV.h"
#include "myrecordset.h"
#include "mq_db.h"
#include "mydb.h"
#include "queue_utility.h"

char cDebug;
OBJPTR(Msg);

void TxnWebOnUs2TWV(char    cdebug)
{
        cDebug = cdebug;
}

int     process_twv_resp_txn(hash_t *hContext,
                                const hex_t* inMsg)
{
        int     iRet = PD_OK;
        hash_t  *hResponse;
        hResponse = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hResponse,0);

DEBUGLOG(("process_twv_resp_txn()\n"));

        MsgObjPtr = CreateObj(MsgPtr,"TwvMsg","BreakDownMsg");
        if ((*MsgObjPtr)(hResponse,inMsg->msg,inMsg->len) != PD_OK)  {
                iRet = INT_BREAKDOWN_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("process_resp_txn:BreakDown TwvMsg Error\n"));
        }
        else {
                //if (iRet == PD_OK)
                 //       iRet = UpdateRespTxnLog(hContext,hRequest,hResponse);
        }
        hash_destroy(hResponse);
        FREE_ME(hResponse);

DEBUGLOG(("process_tww_resp_txn:exit iret = [%d]\n",iRet));
        return iRet;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
	hex_t   *h_msg;
        struct msg_t *msg, *recv_msg; 
        int     iRet = PD_OK;
	int	iSendLen,iRecvLen;
	long	lKey,lRspKey;
	char	*csTxnSeq;


DEBUGLOG(("TxnWebOnUs2TWV: Authroize()\n"));

	GetField_CString(hContext,"txn_seq",&csTxnSeq);

	MsgObjPtr = CreateObj(MsgPtr,"TwvMsg","FormatMsg");
        h_msg = (hex_t*) malloc (sizeof(hex_t));
        if ((*MsgObjPtr)(hRequest,h_msg->msg,&h_msg->len) == PD_OK) {

		lKey = GetMQKey("TWVREQQ");
		lRspKey = GetMQKey("TWVRSPQ");

                msg = (struct msg_t*)malloc(sizeof(struct msg_t)+MAX_MSG_SIZE);
                msg->mtype  = ctol(csTxnSeq,strlen(csTxnSeq));
                memset(msg->mtext,0,sizeof(msg->mtext));
                        MQ_build_header((unsigned char*)msg->mtext,
                        MQ_RESP,
                        "WEB");
                memcpy(&msg->mtext[MQ_HEADER_LEN],h_msg->msg,h_msg->len);
                msg->mtext[MQ_HEADER_LEN + h_msg->len] = '\0';
		iSendLen = MQ_HEADER_LEN + h_msg->len;
DEBUGLOG(("send len = [%d]\n",iSendLen));
DEBUGLOG(("rspkey = [%ld][%ld]\n",lRspKey,msg->mtype));


/*********/
		if (MQSendRecv(lKey,msg,iSendLen,lRspKey,recv_msg,&iRecvLen,2) != MQ_OK ) {
DEBUGLOG(("Recv Msg Error\n"));
                	iRet = PD_ERR;
        	}
        	else {
DEBUGLOG(("got resp\n"));
			h_msg->len = iRecvLen - MQ_HEADER_LEN;
			memcpy(h_msg->msg,&recv_msg->mtext[MQ_HEADER_LEN], h_msg->len);
			h_msg->msg[h_msg->len] = '\0';
			//iRet = process_twv_resp_txn(hContext,h_msg);
DEBUGLOG(("TxnWebOnUs2TWV: after process_twv_resp_txn iret = [%d]\n",iRet));
			//return iRet;
		}
/**************/
        //	FREE_ME(msg);
        }     
	else {
		iRet = INT_FORMAT_ERR;
	}	

	//FREE_ME(h_msg);

DEBUGLOG(("TxnWebOnUs2TWV: noraml exit iret = [%d]\n",iRet));
	return iRet;
}
