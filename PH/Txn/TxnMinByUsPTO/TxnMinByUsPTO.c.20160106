/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/11/20              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMinByUsPTO.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);
OBJPTR(Channel);

void TxnMinByUsPTO(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int iRet = PD_OK;
	int iTmpRet;

	char *csTmp = NULL;
	char *csPtoTxnId = NULL;
	char csToiTxnId[PD_TXN_SEQ_LEN + 1];
	char *csUpdateUser = NULL;
	char *csRemark = NULL;
	char *csPspId = NULL;
	char *csTxnCountry = NULL;
	char *csTxnCcy = NULL;
	double dTxnAmt = 0.0;
	char *csEntityId = NULL;
	char *csEntityType = NULL;
	char *csPitId = NULL;
	char *csEntityProductCode = NULL;
	char csTxnDateTime[PD_DATETIME_LEN + 1];
	char *csClientIp = NULL;
	char *csTxnDate = NULL;
	char *csReportDate = NULL;
	char csBatchId[PD_TXN_SEQ_LEN + 1];
	int iDoLogging = PD_FALSE;

	hash_t *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn, 0);

	hash_t *hTmp;
	hTmp = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTmp, 0);

	hash_t *hBatch;
	hBatch = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hBatch, 0);

DEBUGLOG(("Authorize:: Start\n"));

/* PTO txn_seq */
	if (GetField_CString(hContext, "txn_seq", &csPtoTxnId)) {
DEBUGLOG(("Authorize:: txn_seq = [%s]\n", csPtoTxnId));
	} else {
DEBUGLOG(("Authorize:: txn_seq not found!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: txn_seq not found!!\n");
		iRet = INT_INVALID_TXN;
		PutField_Int(hContext, "internal_error", iRet);
	}

/* add_user */
	if (GetField_CString(hContext, "add_user", &csUpdateUser)) {
DEBUGLOG(("Authorize:: add_user = [%s]\n", csUpdateUser));
		PutField_CString(hTxn, "add_user", csUpdateUser);
		PutField_CString(hTxn, "update_user", csUpdateUser);
		PutField_CString(hBatch, "add_user", csUpdateUser);
	} else {
DEBUGLOG(("Authorize:: add_user not found!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: add_user not found!!\n");
		iRet = INT_USER_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
	}

/* remark */
	if (GetField_CString(hContext, "remark", &csRemark)) {
DEBUGLOG(("Authorize:: remark = [%s]\n", csRemark));
		PutField_CString(hTxn, "remark", csRemark);
	}

/* client_ip */
	if (GetField_CString(hRequest, "ip_addr", &csClientIp)) {
DEBUGLOG(("Authorize:: ip_addr = [%s]\n", csClientIp));
		PutField_CString(hTxn, "ip_addr", csClientIp);
	}

/* psp_id */
	if (GetField_CString(hContext, "psp_id", &csPspId)) {
DEBUGLOG(("Authorize:: psp_id = [%s]\n", csPspId));
		PutField_CString(hTxn, "psp_id", csPspId);
	} else {
DEBUGLOG(("Authorize:: psp_id not found!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: psp_id not found!!\n");
		iRet = INT_PSP_ID_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
	}

/* txn_country */
	if (GetField_CString(hContext, "txn_country", &csTxnCountry)) {
DEBUGLOG(("Authorize:: txn_country = [%s]\n", csTxnCountry));
		PutField_CString(hTxn, "txn_country", csTxnCountry);
		PutField_CString(hTxn, "country", csTxnCountry);
	} else {
DEBUGLOG(("Authorize:: txn_country not found!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: txn_country not found!!\n");
		iRet = INT_TXN_COUNTRY_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
	}

/* txn_ccy */
	if (GetField_CString(hContext, "txn_ccy", &csTxnCcy)) {
DEBUGLOG(("Authorize:: txn_ccy = [%s]\n", csTxnCcy));
		PutField_CString(hTxn, "txn_ccy", csTxnCcy);
		PutField_CString(hTxn, "ccy", csTxnCcy);
		PutField_CString(hTxn, "entity_ccy", csTxnCcy);
	} else {
DEBUGLOG(("Authorize:: txn_ccy not found!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: txn_ccy not found!!\n");
		iRet = INT_CURRENCY_CODE_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
	}

/* txn_amt */
	if (GetField_Double(hContext, "txn_amt", &dTxnAmt)) {
DEBUGLOG(("Authorize:: txn_amt = [%f]\n", dTxnAmt));
		PutField_Double(hTxn, "txn_amt", dTxnAmt);
		PutField_Double(hTxn, "entity_txn_amount", dTxnAmt);
	} else {
DEBUGLOG(("Authorize:: txn_amt not found!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: txn_amt not found!!\n");
		iRet = INT_PAY_AMOUNT_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
	}

/* entity_id */
	if (GetField_CString(hRequest, "entity_id", &csEntityId)) {
DEBUGLOG(("Authorize:: entity_id = [%s]\n", csEntityId));
		PutField_CString(hTxn, "entity_id", csEntityId);
	} else {
DEBUGLOG(("Authorize:: entity_id not found!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: entity_id not found!!\n");
		iRet = INT_MI_ENTITY_ID_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
	}

/* entity_type */
	if (GetField_CString(hContext, "entity_type", &csEntityType)) {
DEBUGLOG(("Authorize:: entity_type = [%s]\n", csEntityType));
		PutField_CString(hTxn, "entity_type", csEntityType);
		PutField_CString(hTxn, "party_type", csEntityType);
	} else {
DEBUGLOG(("Authorize:: entity_type not found!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: entity_type not found!!\n");
		iRet = INT_MI_ENTITY_TYPE_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
	}

/* pit_id */
	if (GetField_CString(hContext, "pit_id", &csPitId)) {
DEBUGLOG(("Authorize:: pit_id = [%s]\n", csPitId));
		PutField_CString(hTxn, "pit_id", csPitId);
		PutField_CString(hTxn, "party_id", csPitId);
	} else {
DEBUGLOG(("Authorize:: pit_id not found!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: pit_id not found!!\n");
		iRet = INT_MI_PIT_ID_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
	}

/* entity_product_code */
	if (GetField_CString(hContext, "product_code", &csEntityProductCode)) {
DEBUGLOG(("Authorize:: entity_product_code = [%s]\n", csEntityProductCode));
	} else {
DEBUGLOG(("Authorize:: entity_product_code not found!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: entity_product_code not found!!\n");
		iRet = INT_MI_PRODUCT_CODE_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
	}

/* txn_date */
	if (GetField_CString(hContext, "PHDATE", &csTxnDate)) {
DEBUGLOG(("Authorize:: txn_date = [%s]\n", csTxnDate));
		PutField_CString(hTxn, "txn_date", csTxnDate);
	}

/* report_date */
	if (!GetField_CString(hContext, "report_date", &csReportDate)) {
DEBUGLOG(("Authorize:: report_date not found!!\n"));
		if (GetField_CString(hContext, "PHDATE", &csReportDate)) {
DEBUGLOG(("Authorize:: report_date = [%s]\n", csReportDate));
			PutField_CString(hTxn, "report_date", csReportDate);
		}
	} else {
DEBUGLOG(("Authorize:: report_date = [%s]\n", csReportDate));
		PutField_CString(hTxn, "report_date", csReportDate);
	}

/* do_logging */
	if (GetField_Int(hContext, "do_logging", &iDoLogging)) {
DEBUGLOG(("Authorize:: do_logging = [%d]\n", iDoLogging));
	}

/* Get PSP product code */
	if (iRet == PD_OK) {
		PutField_Char(hTxn, "business_type", PD_BUSINESS_TYPE_GAMING);

DEBUGLOG(("Authorize:: Call DBCrrPspProductCodeMap::GetPSPProductCode()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBCrrPspProductCodeMap", "GetPSPProductCode");
		iRet = (unsigned long)((*DBObjPtr)(hTxn, hTmp));
		if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call DBCrrPspProductCodeMap::GetPSPProductCode() failed!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: Call DBCrrPspProductCodeMap::GetPSPProductCode() failed!!\n");
			iRet = INT_ERR;
		} else {
			if (GetField_CString(hTmp, "product_code", &csTmp)) {
DEBUGLOG(("Authorize:: psp product_code = [%s]\n", csTmp));
				if (!strcmp(csTmp, csEntityProductCode)) {
					PutField_CString(hTxn, "txn_product", csTmp);
				} else {
DEBUGLOG(("Authorize:: entity product code is different from psp product code!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: entity product code is different from psp product code!!\n");
					iRet = INT_ERR;
				}
			}
		}
	}

/* Check PIT balance account exists */
	if (iRet == PD_OK) {
		hash_destroy(hTmp);
		hash_init(hTmp, 0);

DEBUGLOG(("Authorize:: Call DBMiEntityBalAcct::GetEntityBalAcct()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBMiEntityBalAcct", "GetEntityBalAcct");
		iTmpRet = (unsigned long)((*DBObjPtr)(hTxn, hTmp));
                if (iTmpRet != PD_FOUND) {
DEBUGLOG(("Authorize:: Call DBMiEntityBalAcct::GetEntityBalAcct() failed!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: Call DBMiEntityBalAcct::GetEntityBalAcct() failed!!\n");
			iRet = INT_ERR;
		} else {
			if (GetField_CString(hTmp, "status", &csTmp)) {
DEBUGLOG(("Authorize:: PIT balance account status = [%s]\n", csTmp));
				if (strcmp(csTmp, PD_MI_ENTITY_BAL_ACCT_STATUS_OPEN)) {
DEBUGLOG(("Authorize:: PIT balance account is not opened!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: PIT balance account is not opened!!\n");
					iRet = INT_ERR;
				}
			}
		}
	}

/* TOI txn_seq */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: Call DBTxnSeq::GetNextMgtTxnSeq()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBTxnSeq", "GetNextMgtTxnSeq");
		strcpy((char*)csToiTxnId, (*DBObjPtr)());
		PutField_CString(hTxn, "txn_seq", csToiTxnId);
DEBUGLOG(("Authorize:: Call DBTxnSeq::GetNextMgtTxnSeq() TOI txn_seq = [%s]\n", csToiTxnId));
	}

/* Add txn_header */
	if (iRet == PD_OK) {
		if (iDoLogging != PD_ADD_LOG) {
			/* nothing */
		} else {
			PutField_CString(hTxn, "channel_code", PD_CHANNEL_MGT);
			PutField_Char(hTxn, "status", PD_PROCESSING);
			PutField_CString(hTxn, "txn_code", PD_MI_TXN_CODE_PSP_BAL_TRF_OUT_IN_TRAN);
			PutField_CString(hTxn, "process_type", PD_PROCESS_TYPE_DEF);
			PutField_CString(hTxn, "process_code", PD_PROCESS_CODE_DEF);
			PutField_Char(hTxn, "ex_supplier", PD_INT_EX);
			PutField_Double(hTxn, "ex_rate", 1);
			if (GetField_CString(hContext, "PHDATE", &csTmp)) {
				PutField_CString(hTxn, "host_posting_date", csTmp);
			}
			if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
				PutField_CString(hTxn, "local_tm_date", csTmp);
				strcpy(csTxnDateTime, csTmp);
				PutField_CString(hTxn, "transmission_datetime", csTxnDateTime);
				PutField_CString(hTxn, "tm_date", csTmp);
			}
			if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
				PutField_CString(hTxn, "local_tm_time", csTmp);
				strcat(csTxnDateTime, csTmp);
				PutField_CString(hTxn, "transmission_datetime", csTxnDateTime);
				PutField_CString(hTxn, "tm_time", csTmp);
			}
			PutField_Int(hTxn, "internal_code", 0);
			PutField_CString(hTxn, "response_code", "0");

DEBUGLOG(("Authorize:: Call DBTransaction::Add()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBTransaction", "Add");
			iRet = (unsigned long)((*DBObjPtr)(hTxn));
			if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call DBTransaction::Add() failed!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: Call DBTransaction::Add() failed!!\n");
				iRet = INT_ERR;
			}
		}
	}

/* Add txn_detail */
	if (iRet == PD_OK) {
		if (iDoLogging != PD_ADD_LOG) {
			/* nothing */
		} else {
DEBUGLOG(("Authorize:: Call DBTransaction::AddDetail()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBTransaction", "AddDetail");
			iRet = (unsigned long)((*DBObjPtr)(hTxn));
			if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call DBTransaction::AddDetail() failed!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: Call DBTransaction::AddDetail() failed!!\n");
				iRet = INT_ERR;
			}
		}
	}

/* Update entity balance */
	if (iRet == PD_OK) {
		PutField_Char(hTxn, "batch_mode", PD_ONLINE);
		PutField_CString(hTxn, "amt_type", PD_CR);
		PutField_Char(hTxn, "bal_type", PD_MI_ENTITY_POOL_ACCT_BAL);

DEBUGLOG(("Authorize:: Call BOMiEntityBalance::UpdateEntityBalance()\n"));
		BOObjPtr = CreateObj(BOPtr, "BOMiEntityBalance", "UpdateEntityBalance");
		iRet = (unsigned long)((*BOObjPtr)(hTxn, hTxn));
		if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call BOMiEntityBalance::UpdateEntityBalance() failed!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: Call BOMiEntityBalance::UpdateEntityBalance() failed!!\n");
			iRet = INT_ERR;
		}
	}

/* Add txn_mi_detail */
	if (iRet == PD_OK) {
		if (iDoLogging != PD_ADD_LOG) {
			/* nothing */
		} else {
			PutField_Double(hTxn, "actual_cost", 0.0);
			PutField_Int(hTxn, "acr_prorata", 0);

DEBUGLOG(("Authorize:: Call DBTxnMiDetail::Add()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBTxnMiDetail", "Add");
			iRet = (unsigned long)((*DBObjPtr)(hTxn));
			if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call DBTxnMiDetail::Add() failed!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: Call DBTxnMiDetail::Add() failed!!\n");
				iRet = INT_ERR;
			}
		}
	}

/* Add mi_txn_log */
	if (iRet == PD_OK) {
		if (iDoLogging != PD_ADD_LOG) {
			/* nothing */
		} else {
DEBUGLOG(("Authorize:: Call DBTransaction::AddMiTxnLog()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBTransaction", "AddMiTxnLog");
			iRet = (unsigned long)((*DBObjPtr)(csToiTxnId));
			if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call DBTransaction::AddMiTxnLog() failed!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: Call DBTransaction::AddMiTxnLog() failed!!\n");
				iRet = INT_ERR;
			}
		}
	}

/* Get batch id */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: Call DBTxnSeq::GetNextMiActionBatchSeq()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBTxnSeq", "GetNextMiActionBatchSeq");
		strcpy((char*)csBatchId, (*DBObjPtr)());
		PutField_CString(hBatch, "batch_id", csBatchId);
DEBUGLOG(("Authorize:: Call DBTxnSeq::GetNextMiActionBatchSeq() batch_id = [%s]\n", csBatchId));
	}

/* Add mi_batch_header */
	if (iRet == PD_OK) {
		PutField_CString(hBatch, "process_type", PD_MI_TXN_TYPE_BALTRF_OUT);
		PutField_Char(hBatch, "status", PD_MI_BATCH_STATUS_NORMAL);

DEBUGLOG(("Authorize:: Call DBMiBatchHeader::Add()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBMiBatchHeader", "Add");
		iRet = (unsigned long)((*DBObjPtr)(hBatch));
		if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call DBMiBatchHeader::Add() failed!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: Call DBMiBatchHeader::Add() failed!!\n");
			iRet = INT_ERR;
		}
	}

/* Add mi_batch_detail */
	if (iRet == PD_OK) {
		PutField_Int(hBatch, "seq", 1);
		PutField_CString(hBatch, "party_type", PD_MI_ENTITY_PSP);
		PutField_CString(hBatch, "party_id", csPspId);
		PutField_CString(hBatch, "txn_id", csPtoTxnId);
		PutField_Char(hBatch, "txn_oper_ind", PD_MI_BATCH_TXN_OPER_INSERT);

DEBUGLOG(("Authorize:: Call DBMiBatchDetail::Add()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
		iRet = (unsigned long)((*DBObjPtr)(hBatch));
		if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call DBMiBatchDetail::Add() failed!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: Call DBMiBatchDetail::Add() failed!!\n");
			iRet = INT_ERR;
		}

		if (iRet == PD_OK) {
			PutField_Int(hBatch, "seq", 2);
			PutField_CString(hBatch, "entity_id", csEntityId);
			PutField_CString(hBatch, "party_type", PD_MI_ENTITY_PSP_INTR);
			PutField_CString(hBatch, "party_id", csPitId);
			PutField_CString(hBatch, "txn_id", csToiTxnId);

DEBUGLOG(("Authorize:: Call DBMiBatchDetail::Add()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
			iRet = (unsigned long)((*DBObjPtr)(hBatch));
			if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call DBMiBatchDetail::Add() failed!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: Call DBMiBatchDetail::Add() failed!!\n");
				iRet = INT_ERR;
			}
		}
	}

/* Update txn_header */
	if (iRet == PD_OK) {
		if (iDoLogging != PD_ADD_LOG) {
			/* nothing */
		} else {
			PutField_Char(hTxn, "status", PD_COMPLETE);
			PutField_Char(hTxn, "ar_ind", PD_ACCEPT);
			PutField_CString(hTxn, "sub_status", PD_APPROVED);
			PutField_Double(hTxn, "net_amt", dTxnAmt);
			PutField_CString(hTxn, "net_ccy", csTxnCcy);
			PutField_Double(hTxn, "reserve_amt", 0.0);
			PutField_CString(hTxn, "org_txn_seq", csPtoTxnId);

DEBUGLOG(("Authorize:: Call DBTransaction::Update()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBTransaction", "Update");
			iRet = (unsigned long)((*DBObjPtr)(hTxn));
			if (iRet != PD_OK) {
DEBUGLOG(("Authorize:: Call DBTransaction::Update() failed!!\n"));
ERRLOG("TxnMinByUsPTO::Authorize:: Call DBTransaction::Update() failed!!\n");
				iRet = INT_ERR;
			}
		}
	}

	hash_destroy(hTxn);
	FREE_ME(hTxn);

	hash_destroy(hTmp);
	FREE_ME(hTmp);

	hash_destroy(hBatch);
	FREE_ME(hBatch);

DEBUGLOG(("TxnMinByUsPTO Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}
