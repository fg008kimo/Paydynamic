/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/01/21              Stan Poon
*/


#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsCTT.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);

void TxnOmtByUsCTT(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int	iRet = PD_OK;
	char	*csTmp=NULL;
	char	*csOrgTxnSeq=NULL, *csVoidTxnSeq=NULL, csToTxnSeq[PD_TXN_SEQ_LEN + 1];
	char	*csOrgTxnCode=NULL, csVoidTxnCode[PD_TXN_CODE_LEN + 1], *csToTxnCode=NULL;
	char	csProcessType[PD_PROCESS_TYPE_LEN+1], csProcessCode[PD_PROCESS_CODE_LEN+1];
	char	*csRemark=NULL, *csUser=NULL;

	char	cStatus, cArInd, *csSubStatus=NULL, *csCcy=NULL;
	double	dTxnAmt=0.0;
	char	*csOrgAcctType=NULL, *csToAcctType=NULL;
	char	*csOrgAmtType=NULL, *csToAmtType=NULL;

	char csTxnDateTime[PD_DATETIME_LEN+1];
	double	dTmp=0.0;
	char	cTmp;

	hash_t *hTxn;

	recordset_t* myRec;
	hash_t *hRec;

/* txn_seq */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "org_txn_seq", &csOrgTxnSeq)) {
DEBUGLOG(("Authorize() txn_seq = [%s]\n", csOrgTxnSeq));
		} else {
			iRet = INT_TXN_ID_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() txn_seq is missing!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() txn_seq is missing!!!\n");
		}
	}
/* to_txntype */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "to_txntype", &csToTxnCode)) {
			strcpy(csProcessType,"0000");
			strcpy(csProcessCode,"000000");
DEBUGLOG(("Authorize() to_txntype = [%s]\n", csToTxnCode));
		} else {
			iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() to_txntype is missing!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() to_txntype is missing!!!\n");
		}
	}
/* remark */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "remark", &csRemark)) {
DEBUGLOG(("Authorize() remark = [%s]\n", csRemark));
		}
	}
/* user */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "add_user", &csUser)) {
DEBUGLOG(("Authorize() user = [%s]\n", csUser));
		} else {
			iRet = INT_USER_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() user is missing!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() user is missing!!!\n");
		}
	}


/* MatchRespTxn */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLTransaction:: MatchRespTxn()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "MatchRespTxn");
		if ((unsigned long)(*DBObjPtr)(csOrgTxnSeq,PD_COMPLETE) != PD_FOUND) {
			iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() call DBOLTransaction:: MatchRespTxn() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTransaction:: MatchRespTxn() FAILURE!!!\n");
		}
	}


/* Get Ol Txn Header - org */
	if (iRet == PD_OK) {
		myRec = (recordset_t*) malloc (sizeof(recordset_t));
		recordset_init(myRec,0);

DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnHeader");
		if ((unsigned long)(*DBObjPtr)(csOrgTxnSeq,myRec) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTransaction:: GetTxnHeader() FAILURE!!!\n");
		} else {
			hRec = RecordSet_GetFirst(myRec);
			if (hRec) {
				if (GetField_CString(hRec,"txn_code",&csOrgTxnCode)) {
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() txn_code = [%s]\n",csOrgTxnCode));
				}
				if (GetField_Char(hRec,"status",&cStatus)) {
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() status = [%c]\n",cStatus));
				}
				if (GetField_Char(hRec,"ar_ind",&cArInd)) {
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() ar_ind = [%c]\n",cArInd));
				}
				if (GetField_CString(hRec,"sub_status",&csSubStatus)) {
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() sub_status = [%s]\n",csSubStatus));
				}
				if (GetField_Double(hRec,"txn_amt",&dTxnAmt)) {
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() txn_amt = [%.2lf]\n",dTxnAmt));
				}
				if (GetField_CString(hRec,"net_ccy",&csCcy)) {
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() net_ccy= [%s]\n",csCcy));
				}

			/* status, ar_ind, sub_status */
				if (cStatus != PD_COMPLETE) {
					iRet = INT_INVALID_TXN;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Invalid status = [%c]\n",cStatus));
ERRLOG("TxnOmtByUsCTT::Authorize() Invalid status!!!\n");
				}
				if (cArInd != PD_ACCEPT) {
					iRet = INT_INVALID_TXN;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Invalid ar_ind = [%c]\n",cArInd));
ERRLOG("TxnOmtByUsCTT::Authorize() Invalid ar_ind!!!\n");
				}
				if (strcmp(csSubStatus,PD_UNALLOCATED)) {
					iRet = INT_INVALID_TXN;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Invalid sub_status = [%s]\n",csSubStatus));
ERRLOG("TxnOmtByUsCTT::Authorize() Invalid sub_status!!!\n");
				}
			} else {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTransaction:: GetTxnHeader() FAILURE!!!\n");
			}
		}

		RecordSet_Destroy(myRec);
		FREE_ME(myRec);
	}


/* txn_code - org voidable */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() Call DBTxnCode::IsVoidable()\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTxnCode","IsVoidable");
		if ((unsigned long)(*DBObjPtr)(csOrgTxnCode,csProcessType,csProcessCode) != PD_TRUE) {
			iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Call DBTxnCode::IsVoidable() FAILURE [%s][%s][%s]\n",csOrgTxnCode,csProcessCode,csProcessType));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBTxnCode::IsVoidable() FAILURE!!!\n");
		}
	}


/* compare txn_code - org and to*/
	if (iRet == PD_OK) {
		hRec = (hash_t*) malloc (sizeof(hash_t));

	/* org */
		if (iRet==PD_OK) {
			hash_init(hRec,0);

DEBUGLOG(("Authorize() Call DBOLDefFormat::GetStmtDesc() [%s]\n",csOrgTxnCode));
			DBObjPtr = CreateObj(DBPtr,"DBOLDefFormat","GetStmtDesc");
			if ((unsigned long)(*DBObjPtr)(csOrgTxnCode,hRec) != PD_FOUND) {
				iRet = INT_INVALID_TXN;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Call DBOLDefFormat::GetStmtDesc() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLDefFormat::GetStmtDesc() FAILURE!!!\n");
			} else {
				if (!GetField_CString(hRec,"acct_type",&csOrgAcctType)) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() Call DBOLDefFormat::GetStmtDesc() org acct_type NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLDefFormat::GetStmtDesc() org acct_type NOT FOUND!!!\n");
				} else if (!GetField_CString(hRec,"amt_type",&csOrgAmtType)) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() Call DBOLDefFormat::GetStmtDesc() org amt_type NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLDefFormat::GetStmtDesc() org amt_type NOT FOUND!!!\n");
				}
			}

			hash_destroy(hRec);
		}

	/* to */
		if (iRet==PD_OK) {
			hash_init(hRec,0);

DEBUGLOG(("Authorize() Call DBOLDefFormat::GetStmtDesc() [%s]\n",csToTxnCode));
			DBObjPtr = CreateObj(DBPtr,"DBOLDefFormat","GetStmtDesc");
			if ((unsigned long)(*DBObjPtr)(csToTxnCode,hRec) != PD_FOUND) {
				iRet = INT_INVALID_TXN;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Call DBOLDefFormat::GetStmtDesc() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLDefFormat::GetStmtDesc() FAILURE!!!\n");
			} else {
				if (!GetField_CString(hRec,"acct_type",&csToAcctType)) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() Call DBOLDefFormat::GetStmtDesc() to acct_type NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLDefFormat::GetStmtDesc() to acct_type NOT FOUND!!!\n");
				} else if (!GetField_CString(hRec,"amt_type",&csToAmtType)) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() Call DBOLDefFormat::GetStmtDesc() to amt_type NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLDefFormat::GetStmtDesc() to amt_type NOT FOUND!!!\n");
				}
			}

			hash_destroy(hRec);
		}

	/* void txn_code, acct_type, amt_type */
		if (iRet==PD_OK) {
			if (!strcmp(csOrgAmtType,PD_CR)) {
				strcpy(csVoidTxnCode,PD_TXN_CODE_VOID_UNKNOWN_CREDIT);
			} else if (!strcmp(csOrgAmtType,PD_DR)){
				strcpy(csVoidTxnCode,PD_TXN_CODE_VOID_UNKNOWN_DEBIT);
			}

			if (strcmp(csOrgAcctType,"ALL") &&
			    strcmp(csToAcctType,"ALL") &&
			    strcmp(csOrgAcctType,csToAcctType)) {
				iRet = INT_INVALID_TXN;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Call DBOLDefFormat::GetStmtDesc() acct_type Invalid!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLDefFormat::GetStmtDesc() acct_type Invalid!!!\n");
			}

			if (strcmp(csOrgAmtType,csToAmtType)) {
				iRet = INT_INVALID_TXN;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Call DBOLDefFormat::GetStmtDesc() amt_type Invalid!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLDefFormat::GetStmtDesc() amt_type Invalid!!!\n");
			}
		}

		FREE_ME(hRec);
	}


/* Add Txn Header */
	if (iRet == PD_OK) {
		hTxn = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hTxn,0);

	/* void */
		if (GetField_CString(hContext, "txn_seq", &csVoidTxnSeq)) {
			PutField_CString(hTxn,"txn_seq",csVoidTxnSeq);
DEBUGLOG(("Authorize() txn_seq = [%s]\n", csVoidTxnSeq));
		}
		PutField_CString(hTxn,"org_txn_seq",csOrgTxnSeq);
		PutField_Int(hTxn,"db_commit",PD_FALSE);

		PutField_CString(hTxn,"channel_code","OMT");
		PutField_Char(hTxn,"status",PD_TO_PSP);

		PutField_CString(hTxn,"txn_code",csVoidTxnCode);
		PutField_CString(hTxn,"process_type",csProcessType);
		PutField_CString(hTxn,"process_code",csProcessCode);
		if (GetField_CString(hContext,"PHDATE",&csTmp)) {
			PutField_CString(hTxn,"host_posting_date",csTmp);
		}
		PutField_Int(hTxn,"internal_code",0);
		PutField_CString(hTxn,"response_code","0");
		PutField_Double(hTxn,"txn_amt",dTxnAmt);

		if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
			PutField_CString(hTxn, "local_tm_date", csTmp);
			strcpy(csTxnDateTime, csTmp);
			PutField_CString(hTxn, "transmission_datetime", csTxnDateTime);
			PutField_CString(hTxn, "tm_date", csTmp);
		}
		if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
			PutField_CString(hTxn, "local_tm_time", csTmp);
			strcat(csTxnDateTime, csTmp);
			PutField_CString(hTxn, "transmission_datetime", csTxnDateTime);
			PutField_CString(hTxn, "tm_time", csTmp);
		}

		if (GetField_CString(hRequest,"ip_addr",&csTmp)) {
			PutField_CString(hTxn,"ip_addr",csTmp);
		}
		if (GetField_CString(hRequest,"user_agent",&csTmp)) {
			PutField_CString(hTxn,"user_agent",csTmp);
		}

		PutField_CString(hTxn,"add_user",csUser);
DEBUGLOG(("Authorize() call DBOLTransaction::Add()\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLTransaction","Add");
		if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction::Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTransaction::Add() FAILURE!!!\n");
		}

		RemoveField_CString(hTxn,"txn_seq");
		RemoveField_CString(hTxn,"txn_code");

	/* to */
		if (iRet == PD_OK) {
			DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextOmtTxnSeq");
			strcpy(csToTxnSeq,(*DBObjPtr)());
DEBUGLOG(("Authorize() txn_seq = [%s]\n", csToTxnSeq));
			PutField_CString(hTxn,"txn_seq",csToTxnSeq);
			PutField_CString(hTxn,"txn_code",csToTxnCode);
			PutField_CString(hTxn,"sub_status",csSubStatus);

DEBUGLOG(("Authorize() call DBOLTransaction:: Add()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Add");
			if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction:: Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTransaction:: Add() FAILURE!!!\n");
			}
		}

		hash_destroy(hTxn);
		FREE_ME(hTxn);
	}


/* Add Txn Psp Detail */
        if (iRet == PD_OK) {
		hRec = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hRec,0);

		hTxn = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hTxn,0);

	/* Get Ol Txn Psp Detail */
DEBUGLOG(("Authorize() call DBOLTxnPspDetail:: GetTxnPspDetail()\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "GetTxnPspDetail");
                if ((unsigned long)(*DBObjPtr)(csOrgTxnSeq,hRec) != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTxnPspDetail:: GetTxnPspDetail() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTxnPspDetail:: GetTxnPspDetail() FAILURE!!!\n");
                }

	/* void */
		if (iRet == PD_OK) {
			PutField_CString(hTxn,"txn_seq",csVoidTxnSeq);
			if (GetField_CString(hRec,"psp_id",&csTmp)) {
				PutField_CString(hTxn,"psp_id",csTmp);
			}
			if (GetField_CString(hRec,"baid",&csTmp)) {
				PutField_CString(hTxn,"baid",csTmp);
			}

			if (GetField_CString(hRec,"txn_ccy",&csTmp)) {
				PutField_CString(hTxn,"txn_ccy",csTmp);
			}
			if (GetField_Double(hRec,"txn_amount",&dTmp)) {
				PutField_Double(hTxn,"txn_amount",dTmp);
			}
			if (GetField_CString(hRec,"bank_code",&csTmp)) {
				PutField_CString(hTxn,"bank_code",csTmp);
			}
			if (GetField_CString(hRec,"bank_acct_num",&csTmp)) {
				PutField_CString(hTxn,"bank_acct_num",csTmp);
			}

			PutField_Double(hTxn,"cost",0.0);
			PutField_Double(hTxn,"open_bal",0.0);
			PutField_Double(hTxn,"total_hold",0.0);
			PutField_Double(hTxn,"bal",0.0);
			PutField_Double(hTxn,"pending_fund",0.0);

			PutField_CString(hTxn,"add_user",csUser);
DEBUGLOG(("Authorize() call DBOLTxnPspDetail:: Add()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Add");
			if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTxnPspDetail:: Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTxnPspDetail:: Add() FAILURE!!!\n");
			}
		}

		RemoveField_CString(hTxn,"txn_seq");

	/* to */
		if (iRet == PD_OK) {
			PutField_CString(hTxn,"txn_seq",csToTxnSeq);
			if (GetField_CString(hRec,"txn_date",&csTmp)) {
				PutField_CString(hTxn,"txn_date",csTmp);
			}
			if (GetField_CString(hRec,"txn_time",&csTmp)) {
				PutField_CString(hTxn,"txn_time",csTmp);
			}

			if (GetField_Char(hRec,"process_group",&cTmp)) {
				PutField_Char(hTxn,"process_group",cTmp);
			}
			if (GetField_CString(hRec,"customer_text",&csTmp)) {
				PutField_CString(hTxn,"customer_text",csTmp);
			}
			if (GetField_CString(hRec,"sender_name",&csTmp)) {
				PutField_CString(hTxn,"sender_name",csTmp);
			}
			if (GetField_CString(hRec,"txn_ref_num",&csTmp)) {
				PutField_CString(hTxn,"txn_ref_num",csTmp);
			}

DEBUGLOG(("Authorize() call DBOLTxnPspDetail:: Add()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Add");
			if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTxnPspDetail:: Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTxnPspDetail:: Add() FAILURE!!!\n");
			}
		}

		hash_destroy(hTxn);
		FREE_ME(hTxn);

		hash_destroy(hRec);
		FREE_ME(hRec);
	}


/* Add Ol Txn Fee */
	if (iRet == PD_OK) {
		myRec = (recordset_t*) malloc (sizeof(recordset_t));
		recordset_init(myRec,0);

		hTxn = (hash_t*) malloc (sizeof(hash_t));

		DBObjPtr = CreateObj(DBPtr,"DBOLTxnElements","GetAllFeeChgDetail");
		if ((unsigned long)(*DBObjPtr)(csOrgTxnSeq,myRec) == PD_OK) {
			hRec = RecordSet_GetFirst(myRec);
			while (hRec && iRet == PD_OK) {
		/* void */
				hash_init(hTxn,0);
				PutField_CString(hTxn,"txn_seq",csVoidTxnSeq);
				if(GetField_CString(hRec,"txn_element_type",&csTmp)){
					PutField_CString(hTxn,"txn_element_type",csTmp);
				}
				if(GetField_Char(hRec,"party_type",&cTmp)){
					PutField_Char(hTxn,"party_type",cTmp);
				}
				if(GetField_Double(hRec,"amount",&dTmp)){
					PutField_Double(hTxn,"amount",dTmp);
				}
				if(GetField_CString(hRec,"ccy",&csTmp)){
					PutField_CString(hTxn,"ccy",csTmp);
				}
				if(GetField_CString(hRec,"amt_type",&csTmp)){
					if(!strcmp(csTmp,PD_CR))
						PutField_CString(hTxn,"amount_type",PD_DR);
					else
						PutField_CString(hTxn,"amount_type",PD_CR);
				}
				PutField_CString(hTxn,"add_user",csUser);
DEBUGLOG(("Authorize() call DBOLTxnElements::Add()\n"));
				DBObjPtr = CreateObj(DBPtr,"DBOLTxnElements","Add");
				if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTxnElements::Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTxnElements::Add() FAILURE!!!\n");
				}
				hash_destroy(hTxn);

		/* to */
				hash_init(hTxn,0);
				PutField_CString(hTxn,"txn_seq",csToTxnSeq);
				if(GetField_CString(hRec,"txn_element_type",&csTmp)){
					PutField_CString(hTxn,"txn_element_type",csTmp);
				}
				if(GetField_Char(hRec,"party_type",&cTmp)){
					PutField_Char(hTxn,"party_type",cTmp);
				}
				if(GetField_Double(hRec,"amount",&dTmp)){
					PutField_Double(hTxn,"amount",dTmp);
				}
				if(GetField_CString(hRec,"ccy",&csTmp)){
					PutField_CString(hTxn,"ccy",csTmp);
				}
				if(GetField_CString(hRec,"amt_type",&csTmp)){
					PutField_CString(hTxn,"amount_type",csTmp);
				}
				PutField_CString(hTxn,"add_user",csUser);
DEBUGLOG(("Authorize() call DBOLTxnElements::Add()\n"));
				DBObjPtr = CreateObj(DBPtr,"DBOLTxnElements","Add");
				if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
					iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTxnElements::Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTxnElements::Add() FAILURE!!!\n");
				}
				hash_destroy(hTxn);

				hRec = RecordSet_GetNext(myRec);
			}
		}

		FREE_ME(hTxn);

		RecordSet_Destroy(myRec);
		FREE_ME(myRec);
	}


/* Update Ol Txn Header */
	if (iRet == PD_OK) {
		hTxn = (hash_t*) malloc (sizeof(hash_t));

	/* org */
		hash_init(hTxn,0);
		PutField_CString(hTxn,"txn_seq",csOrgTxnSeq);
		PutField_Char(hTxn,"status",PD_REJECT);
		PutField_Char(hTxn,"ar_ind",PD_ACCEPT);
		PutField_CString(hTxn,"update_user",PD_UPDATE_USER);

DEBUGLOG(("Authorize() call DBOLTransaction::Update()\n"));
		DBObjPtr = CreateObj(BOPtr, "DBOLTransaction", "Update");
		if ((unsigned long)(*DBObjPtr)(hTxn) == PD_OK) {
DEBUGLOG(("Authorize() call DBOLTransaction::Update() Success\n"));
		} else {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction::Update() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTransaction::Update() FAILURE!!!\n");
		}
		hash_destroy(hTxn);

	/* void */
		if (iRet == PD_OK) {
			hash_init(hTxn,0);
			PutField_CString(hTxn,"txn_seq",csVoidTxnSeq);
			PutField_Char(hTxn,"status",PD_COMPLETE);
			PutField_Char(hTxn,"ar_ind",PD_ACCEPT);
			PutField_Double(hTxn,"net_amt",dTxnAmt);
			PutField_CString(hTxn,"net_ccy",csCcy);
			if (GetField_CString(hContext,"PHDATE",&csTmp)) {
				PutField_CString(hTxn,"approval_date",csTmp);
			}
			DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
			(*DBObjPtr)(hTxn);
			PutField_CString(hTxn,"update_user",csUser);

DEBUGLOG(("Authorize() call DBOLTransaction::Update()\n"));
			DBObjPtr = CreateObj(BOPtr, "DBOLTransaction", "Update");
			if ((unsigned long)(*DBObjPtr)(hTxn) == PD_OK) {
DEBUGLOG(("Authorize() call DBOLTransaction::Update() Success\n"));
			} else {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction::Update() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTransaction::Update() FAILURE!!!\n");
			}
			hash_destroy(hTxn);
		}

	/* to */
		if (iRet == PD_OK) {
			hash_init(hTxn,0);
			PutField_CString(hTxn,"txn_seq",csToTxnSeq);
			PutField_Char(hTxn,"status",PD_COMPLETE);
			PutField_Char(hTxn,"ar_ind",PD_ACCEPT);
			PutField_Double(hTxn,"net_amt",dTxnAmt);
			PutField_CString(hTxn,"net_ccy",csCcy);
			if (GetField_CString(hContext,"PHDATE",&csTmp)) {
				PutField_CString(hTxn,"approval_date",csTmp);
			}
			DBObjPtr = CreateObj(DBPtr,"DBSystemControl","GetApprovalDT");
			(*DBObjPtr)(hTxn);
			PutField_CString(hTxn,"update_user",csUser);

DEBUGLOG(("Authorize() call DBOLTransaction::Update()\n"));
			DBObjPtr = CreateObj(BOPtr, "DBOLTransaction", "Update");
			if ((unsigned long)(*DBObjPtr)(hTxn) == PD_OK) {
DEBUGLOG(("Authorize() call DBOLTransaction::Update() Success\n"));
			} else {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction::Update() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTransaction::Update() FAILURE!!!\n");
			}
			hash_destroy(hTxn);
		}

		FREE_ME(hTxn);
	}



/* Add Ol Txn Remarks */
	if (iRet == PD_OK) {
		hTxn = (hash_t*) malloc (sizeof(hash_t));
	/* void */
		hash_init(hTxn,0);
		PutField_CString(hTxn,"txn_seq",csVoidTxnSeq);
		PutField_CString(hTxn,"txn_code",csVoidTxnCode);
		PutField_CString(hTxn,"remark",csRemark);
		PutField_CString(hTxn,"add_user",csUser);
DEBUGLOG(("Authorize() call DBOLTransaction:: Add()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnRemarks", "Add");
		if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction:: Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTransaction:: Add() FAILURE!!!\n");
		}
		hash_destroy(hTxn);

	/* to */
		if (iRet == PD_OK) {
			hash_init(hTxn,0);
			PutField_CString(hTxn,"txn_seq",csToTxnSeq);
			PutField_CString(hTxn,"txn_code",csToTxnCode);
			PutField_CString(hTxn,"remark",csRemark);
			PutField_CString(hTxn,"add_user",csUser);
DEBUGLOG(("Authorize() call DBOLTransaction:: Add()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLTxnRemarks", "Add");
			if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction:: Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsCTT::Authorize() call DBOLTransaction:: Add() FAILURE!!!\n");
			}
			hash_destroy(hTxn);
		}

		FREE_ME(hTxn);
	}

DEBUGLOG(("Authorize() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;
}

