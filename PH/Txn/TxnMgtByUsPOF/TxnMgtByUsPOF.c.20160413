/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2016/04/12              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsPOF.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnMgtByUsPOF(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int 	iRet = PD_OK;

	int     iTmp = 0;

	double  dAmt = 0.0;

	char  	*csOrgTxnCode = NULL;
	char	*csCode = NULL;
        char   	*csPspId = NULL;
        char  	*csTxnCountry = NULL;
        char   	*csTxnCcy = NULL;
        char   	*csUser = NULL;  
	char    *csTmp = NULL;

        hash_t	*hRec;

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("Authorize::Start\n"));

/* txn_seq */
        if(GetField_CString(hContext,"txn_seq",&csTmp)){
		PutField_CString(hResponse,"org_txn_seq",csTmp);
DEBUGLOG(("Authorize::txn_seq = [%s]\n", csTmp));
                PutField_CString(hContext, "from_txn_seq", csTmp);
        }
        else{
DEBUGLOG(("Authorize::txnid not found!!\n"));
ERRLOG("TxnMgtByUsPOF::Authorize::txnid not found!!\n");
                iRet=INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_code*/
        if(GetField_CString(hRequest,"txn_code",&csOrgTxnCode)){
DEBUGLOG(("Authorize::txn_code = [%s]\n",csOrgTxnCode));
        }
        else{
DEBUGLOG(("Authorize::txn_code not found!!\n"));
ERRLOG("TxnMgtByUsPOF::Authorize::txn_code not found!!\n");
                iRet=INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* code */
        if(GetField_CString(hRequest,"code",&csCode)){
DEBUGLOG(("Authorize::code = [%s]\n",csCode));
                PutField_CString(hContext,"code",csCode);
DEBUGLOG(("Authorize::Assign new Txn code = [%s]\n",csCode));
                PutField_CString(hContext, "new_txn_code", csCode);
        }
        else {
DEBUGLOG(("Authorize::code not found!!\n"));
ERRLOG("TxnMgtByUsPOF::Authorize::code not found!!\n");
                iRet=INT_CODE_ERROR;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* psp_id */
        if(GetField_CString(hRequest,"psp_id",&csPspId)){
DEBUGLOG(("Authorize::psp_id = [%s]\n",csPspId));
                PutField_CString(hContext,"psp_id",csPspId);
        }
        else {
DEBUGLOG(("Authorize::psp_id not found!!\n"));
ERRLOG("TxnMgtByUsPOF::Authorize::psp_id not found!!\n");
                iRet = INT_PSP_RETURN_ERROR;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_country */
	if(GetField_CString(hRequest,"txn_country",&csTxnCountry)){
                PutField_CString(hContext,"txn_country",csTxnCountry);
DEBUGLOG(("Authorize::txn_country= [%s]\n",csTxnCountry));
        }
        else{
DEBUGLOG(("Authorize::Call DBPspCountry:GetPspCountry\n"));
                DBObjPtr = CreateObj(DBPtr,"DBPspCountry","GetPspCountry");
                if((unsigned long) ((*DBObjPtr)(csPspId,rRecordSet))==PD_OK){
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while(hRec){
                                if (GetField_CString(hRec,"country",&csTxnCountry)) {
                                        PutField_CString(hContext,"txn_country",csTxnCountry);
                                        PutField_CString(hRequest,"txn_country",csTxnCountry);
DEBUGLOG(("Authorize::txn_country by psp_id = [%s]\n",csTxnCountry));
                                }
                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                }
                else{
DEBUGLOG(("Authorize::txn_country not found!!\n"));
ERRLOG("TxnMgtByUsPOF::Authorize::txn_country not found!!\n");
                        iRet=INT_COUNTRY_PSP_NOT_AVABILE;
                	PutField_Int(hContext,"internal_error",iRet);
                }
        }

/* txn_ccy */
        if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTxnCcy));
                PutField_CString(hContext,"txn_ccy",csTxnCcy);
                PutField_CString(hContext,"net_ccy",csTxnCcy);
                PutField_CString(hContext,"org_txn_ccy",csTxnCcy);
        }
        else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMgtByUsPOF::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_amt */
        if(GetField_Double(hContext,"txn_amt",&dAmt)){
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dAmt));
                PutField_Double(hContext, "org_txn_amt", dAmt);
        }
        else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMgtByUsPOF::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
        }

/* report_date */
        if(!GetField_CString(hRequest,"report_date",&csTmp)){
DEBUGLOG(("Authorize::report_date not found!!\n"));
                if(GetField_CString(hContext,"PHDATE",&csTmp)){
			PutField_CString(hContext, "report_date", csTmp);
DEBUGLOG(("Authorize::report_date (PH date) = [%s]\n", csTmp)); 
		}
		//iRet=INT_INVALID_TXN;
		//PutField_Int(hContext,"internal_error",iRet);
        }
	else {
		PutField_CString(hContext, "report_date", csTmp);
DEBUGLOG(("Authorize::report_date = [%s]\n", csTmp)); 
	}

/* remark */
        if(GetField_CString(hRequest,"remark",&csTmp)){
DEBUGLOG(("Authorize::remark = [%s]\n",csTmp));
                PutField_CString(hContext,"remark",csTmp);
        }

/* add_user */
        if(GetField_CString(hRequest,"add_user",&csUser)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csUser));
                PutField_CString(hContext,"add_user",csUser);
                PutField_CString(hContext,"update_user",csUser);
        }

	PutField_Char(hContext, "party_type", PD_TYPE_PSP);

	// Update Txn Header
        if(iRet==PD_OK){
		PutField_CString(hRequest, "service_code", PD_DEFAULT_SERVICE);
		PutField_CString(hContext,"process_code","000000");
        	PutField_CString(hContext,"process_type","0000");
                PutField_CString(hContext, "sub_status", PD_APPROVED);
        }

	// Update Balance
        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call BOOffset:ProcessPartyBalance\n"));
                BOObjPtr = CreateObj(BOPtr,"BOOffset","ProcessPartyBalance");
                iRet = (unsigned long)((*BOObjPtr)(hContext));
                if (iRet != PD_OK) {
DEBUGLOG(("Authorize::BOOffset:ProcessPartyBalance Failed Ret [%d]\n", iRet));
ERRLOG("TxnMgtByUsPOF::BOOffset::ProcesspartyBalance Failed [%d]\n", iRet);
                } 
		else {
                    	PutField_CString(hContext, "amount_type", PD_DR);
                }
        }

	// Add and Update Txn Detail
	if(iRet==PD_OK){
		if(GetField_Int(hContext,"do_logging",&iTmp)){
DEBUGLOG(("Authorize::do_logging [%d]\n", iTmp));
                	if(iTmp!=PD_ADD_LOG) {
                	        /* nothing */
                	}
                	else {
                	        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:AddDetail\n"));
                	                DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                	                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK) {
                	                        iRet = INT_ERR;
					}
                	        }

                	        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:UpdateDetail\n"));
                	                DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                	                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK) {
                	                        iRet = INT_ERR;
					}
                	        }
			}
                }
        }

	// Add and Update Txn Psp Detail
        if(iRet==PD_OK){
                if (GetField_CString(hContext, "PHDATE", &csTmp)) {
DEBUGLOG(("Authorize::PHDATE = [%s]\n",csTmp));
                    PutField_CString(hContext, "txn_date", csTmp);
                }

		if (!strcmp(csCode, PD_PSP_OFFSET_FROZEN_PROCESSOR_BAL)) {
			PutField_CString(hContext, "desc", "Offset Frozen Processor Balance (PSP)");
DEBUGLOG(("Authorize::Call DBTxnPspDetail:Add - Offset Frozen Processor Balance (PSP)\n"));
		} 
		else if (!strcmp(csCode, PD_PSP_BAD_DEBT)) {
                        PutField_CString(hContext, "desc", "Bad Debt (PSP)");
DEBUGLOG(("Authorize::Call DBTxnPspDetail:Add - Bad Debt (PSP)\n"));
                } 

                DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Add");
                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK) {
                        iRet = INT_ERR;
                }

		if (iRet==PD_OK) {
DEBUGLOG(("Authorize::Call DBTxnPspDetail:Update\n"));
                	DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
                	if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK) {
               	        	iRet = INT_ERR;
                	}
        	}
        }

	// Add Txn Elements
	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call BOTxnElements:AddTxnAmtElement\n"));
                BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnAmtElement");
                if ((unsigned long)((*BOObjPtr)(hContext)) != PD_OK) {
                        iRet = INT_ERR;
                }
        }

	// Remove Fields
        if(iRet != PD_OK){
                RemoveField_CString(hContext, "sub_status");
                RemoveField_CString(hContext, "approval_date");
                RemoveField_CString(hContext, "approval_timestamp");
        }
	
	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

DEBUGLOG(("TxnMgtByUsPOF Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

