/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/09/01              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsPOA.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

#define       PD_DETAIL_TAG   "dt"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);
OBJPTR(Channel);

void TxnMgtByUsPOA(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;

	//char	*csBatchId;
	char	*csDate;
	char	*csTmp;
	char	*p;
	int	i= 0;
	int	iTmp= 0;
	int	iCnt= 0;
	int	iCheck= 0;
	int	iDtlRet = 0;
	int	iDayOfWeek = 0;
	double	dTmp;
	char	cInputInd;
	char	csTag[PD_TAG_LEN+1];


DEBUGLOG(("Authorize\n"));

/* input ind*/
        if(GetField_CString(hRequest,"input_ind",&csTmp)){
                cInputInd = csTmp[0];
		PutField_Char(hContext,"input_ind",cInputInd);
DEBUGLOG(("Authorize::input_ind= [%c]\n",cInputInd));
        }

/* approval date */
	if(GetField_CString(hContext,"PHDATE",&csDate)){
DEBUGLOG(("Authorize::approval_date= [%s]\n",csDate));
		PutField_CString(hContext,"approval_date",csDate);
		PutField_CString(hContext,"posting_date",csDate);

		iDayOfWeek=day_of_week((const unsigned char *)csDate);
DEBUGLOG(("Authorize::day_of_week= [%d]\n",iDayOfWeek));
		PutField_Int(hContext,"day_of_week",iDayOfWeek);
	}

/* user */
        if(GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hContext,"update_user",csTmp);
DEBUGLOG(("Authorize::add_user= [%s]\n",csTmp));
        }

/* bank name */
        if(cInputInd == PD_BY_BANK){
		if(GetField_CString(hRequest,"batch_id",&csTmp)){
			PutField_CString(hContext,"batch_id",csTmp);
DEBUGLOG(("Authorize::batch_id= [%s]\n",csTmp));
		}
                if(GetField_CString(hRequest,"bank_name",&csTmp)){
			PutField_CString(hContext,"bank_name",csTmp);
DEBUGLOG(("Authorize::bank_name= [%s]\n",csTmp));
                }
		else{
DEBUGLOG(("Authorize::bank_name not found!!\n"));
ERRLOG("TxnMgtByUsPOA:Authorize::bank_name not found!!\n");
			iRet=INT_ERR;
		}

		if(GetField_CString(hRequest,"total_amt",&csTmp)){
			iCheck = PD_FALSE;
			p = (char*)strchr(csTmp, '.');
			if (p == NULL){
				iCheck = is_numeric(csTmp);
				if(iCheck!=PD_FALSE){
					if(sscanf(csTmp,"%lf",&dTmp)==1){
						PutField_Double(hContext,"total_amt",dTmp);
DEBUGLOG(("Authorize() total_amt = [%f]\n",dTmp));
					}
				}
			}
			else{
				if(sscanf(csTmp,"%lf",&dTmp)==1){
					PutField_Double(hContext,"total_amt",dTmp);
DEBUGLOG(("Authorize() total_amt = [%f]\n",dTmp));
					iCheck = PD_TRUE;
				}
			}
			if(iCheck==PD_FALSE){
				iRet =  INT_INVALID_PAY_AMOUNT;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()total_amt Invalid[%s]\n",csTmp));
ERRLOG("TxnMgtByUsPOA::Authorize() total_amt Invalid\n");
			}
		}
        }

/* batch id */
	else if(cInputInd == PD_BY_BATCH){
		if(GetField_CString(hRequest,"batch_id",&csTmp)){
			PutField_CString(hContext,"batch_id",csTmp);
DEBUGLOG(("Authorize::batch_id= [%s]\n",csTmp));
		}
		else{
DEBUGLOG(("Authorize::batch_id not found!!\n"));
ERRLOG("TxnMgtByUsPOA:Authorize::batch_id not found!!\n");
			iRet=INT_ERR;
		}
	}

/* total amt */
        else if(cInputInd == PD_BY_TOTAL_AMT){
		if(GetField_CString(hRequest,"batch_id",&csTmp)){
			PutField_CString(hContext,"batch_id",csTmp);
DEBUGLOG(("Authorize::batch_id= [%s]\n",csTmp));
		}
		if(GetField_CString(hRequest,"total_amt",&csTmp)){
			iCheck = PD_FALSE;
			p = (char*)strchr(csTmp, '.');
			if (p == NULL){
				iCheck = is_numeric(csTmp);
				if(iCheck!=PD_FALSE){
					if(sscanf(csTmp,"%lf",&dTmp)==1){
						PutField_Double(hContext,"total_amt",dTmp);
DEBUGLOG(("Authorize() total_amt = [%f]\n",dTmp));
					}
				}
			}
			else{
				if(sscanf(csTmp,"%lf",&dTmp)==1){
					PutField_Double(hContext,"total_amt",dTmp);
DEBUGLOG(("Authorize() total_amt = [%f]\n",dTmp));
					iCheck = PD_TRUE;
				}
			}
			if(iCheck==PD_FALSE){
				iRet =  INT_INVALID_PAY_AMOUNT;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()total_amt Invalid[%s]\n",csTmp));
ERRLOG("TxnMgtByUsPOA::Authorize() total_amt Invalid\n");
			}
		}
		else{
DEBUGLOG(("Authorize::total_amt not found!!\n"));
ERRLOG("TxnMgtByUsPOA:Authorize::total_amt not found!!\n");
			iRet=INT_ERR;
		}
        }

/* min/max amt */
        else if(cInputInd == PD_BY_TXN_AMT){
		if(GetField_CString(hRequest,"batch_id",&csTmp)){
			PutField_CString(hContext,"batch_id",csTmp);
DEBUGLOG(("Authorize::batch_id= [%s]\n",csTmp));
		}
		for(i = 0; i < 2; i++){
			if(i==0)
				sprintf(csTag,"min_amt");
			else
				sprintf(csTag,"max_amt");

			if(GetField_CString(hRequest,csTag,&csTmp)){
				iCheck = PD_FALSE;
				p = (char*)strchr(csTmp, '.');
				if (p == NULL){
					iCheck = is_numeric(csTmp);
					if(iCheck!=PD_FALSE){
						if(sscanf(csTmp,"%lf",&dTmp)==1){
							PutField_Double(hContext,csTag,dTmp);
DEBUGLOG(("Authorize() %s = [%f]\n",csTag,dTmp));
						}
					}
				}
				else{
					if(sscanf(csTmp,"%lf",&dTmp)==1){
						PutField_Double(hContext,csTag,dTmp);
DEBUGLOG(("Authorize() %s = [%f]\n",csTag,dTmp));
						iCheck = PD_TRUE;
					}
				}
				if(iCheck==PD_FALSE){
					iRet =  INT_INVALID_PAY_AMOUNT;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() %s Invalid[%s]\n",csTag,csTmp));
ERRLOG("TxnMgtByUsPOA::Authorize() %s Invalid[%s]\n",csTag,csTmp);
				}
			}
			else{
DEBUGLOG(("Authorize:: %s not found\n",csTag));
ERRLOG("TxnMgtByUsPOA::Authorize:: %s not found\n",csTag);
				iRet = INT_ERR;
			}
		}

		if(GetField_CString(hRequest,"total_amt",&csTmp)){
			iCheck = PD_FALSE;
			p = (char*)strchr(csTmp, '.');
			if (p == NULL){
				iCheck = is_numeric(csTmp);
				if(iCheck!=PD_FALSE){
					if(sscanf(csTmp,"%lf",&dTmp)==1){
						PutField_Double(hContext,"total_amt",dTmp);
DEBUGLOG(("Authorize() total_amt = [%f]\n",dTmp));
					}
				}
			}
			else{
				if(sscanf(csTmp,"%lf",&dTmp)==1){
					PutField_Double(hContext,"total_amt",dTmp);
DEBUGLOG(("Authorize() total_amt = [%f]\n",dTmp));
					iCheck = PD_TRUE;
				}
			}
			if(iCheck==PD_FALSE){
				iRet =  INT_INVALID_PAY_AMOUNT;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()total_amt Invalid[%s]\n",csTmp));
ERRLOG("TxnMgtByUsPOA::Authorize() total_amt Invalid\n");
			}
		}
	}

/* specified records */
	else if(cInputInd == PD_BY_TXN){
                if (GetField_Int(hContext, "total_cnt", &iCnt)) {
DEBUGLOG(("Authorize::total_cnt = [%d]\n", iCnt));
                }
                else {
DEBUGLOG(("Authorize::total_cnt not found\n"));
ERRLOG("TxnMgtByUsPOA::Authorize::total_cnt not found\n");
                        iRet = INT_ERR;
                }

                if (iRet == PD_OK) {
			iDtlRet = PD_OK;
                        for (i = 0; i < iCnt; i++) {
/* batch_id */
                                sprintf(csTag, "%s_batchid_%d", PD_DETAIL_TAG, i+1);
                                if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("Authorize::() [%s] = [%s]\n", csTag, csTmp));
					sprintf(csTag, "batch_id_%d",i);
					PutField_CString(hContext,csTag,csTmp);
                                }
                                else {
DEBUGLOG(("Authorize::[%s] not found\n", csTag));
ERRLOG("TxnMgtByUsPOA::Authorize::[%s] not found\n", csTag);
                                        iDtlRet = INT_ERR;
                                }

/* seq_num */
                                sprintf(csTag, "%s_seq_num_%d", PD_DETAIL_TAG, i+1);
                                if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("Authorize::() [%s] = [%s]\n", csTag, csTmp));
					sprintf(csTag, "seq_num_%d",i);
					PutField_CString(hContext,csTag,csTmp);
                                }
                                else {
DEBUGLOG(("Authorize::[%s] not found\n", csTag));
ERRLOG("TxnMgtByUsPOA::Authorize::[%s] not found\n", csTag);
                                        iDtlRet = INT_ERR;
                                }

                        }
			if(iDtlRet!=PD_OK){
                       		iRet = INT_ERR;
			}
                }
        }
	else{
DEBUGLOG(("Authorize::Invalid input ind!!!\n"));
ERRLOG("TxnMgtByUsPOA::Authorize::Invalid input ind!!!\n");
                        iRet = INT_ERR;
	}



	if(iRet==PD_OK){
		PutField_Int(hContext,"status",PAYOUT_MASTER_TRANSACTION_CONFIRMED);
DEBUGLOG(("Authorize::call BOPayout->GetPayoutRecordsByMode\n"));
                BOObjPtr = CreateObj(BOPtr,"BOPayout","GetPayoutRecordsByMode");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest,hResponse);
        }

	if(iRet==PD_OK){
DEBUGLOG(("Authorize::call BOPayout->CheckAvalBalance\n"));
                BOObjPtr = CreateObj(BOPtr,"BOPayout","CheckAvalBalance");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
	}

	if(iRet==PD_OK){
		if(GetField_Double(hContext,"merchant_net_float",&dTmp)){
			PutField_Double(hContext,"remain_merchant_net_float",dTmp);
DEBUGLOG(("Authorize::merchant_net_float = [%lf]\n",dTmp));
		}
		if(GetField_Double(hContext,"merchant_reserved_po",&dTmp)){
			PutField_Double(hContext,"remain_merchant_reserved_po",dTmp);
DEBUGLOG(("Authorize::merchant_reserved_po = [%lf]\n",dTmp));
		}
		if(GetField_Double(hContext,"merchant_fundin_po",&dTmp)){
DEBUGLOG(("Authorize::merchant_fundin_po = [%lf]\n",dTmp));
		}
	}

	if(iRet==PD_OK){
		int iApproveId = 0;
DEBUGLOG(("Authorize::DBMerchantUploadFileDetail:GetNextApproveId\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetNextApproveId");
		if((unsigned long) ((*DBObjPtr)(&iApproveId))!=PD_OK){
			iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize::DBMerchantUploadFileDetail:GetNextApproveId Failed\n"));
		}
		else{
DEBUGLOG(("Authorize:::GetNextApproveId [%d]\n",iApproveId));
			PutField_Int(hContext,"approve_id",iApproveId);
			PutField_Int(hResponse,"approve_id",iApproveId);
		}
	}


	if(iRet==PD_OK){
		iCnt = 0;
		if(GetField_Int(hContext,"total_cnt",&iCnt)){
DEBUGLOG(("Authorize::total count = [%d]\n",iCnt));
		}
		
		for(i=0;i<iCnt;i++){
			sprintf(csTag,"merchant_id_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
				PutField_CString(hContext,"merchant_id",csTmp);
				PutField_CString(hRequest,"merchant_id",csTmp);
			}
			sprintf(csTag,"merchant_client_id_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
				PutField_CString(hRequest,"client_id",csTmp);
			}
			sprintf(csTag,"service_code_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
				PutField_CString(hContext,"service_code",csTmp);
				PutField_CString(hRequest,"service_code",csTmp);
			}
			sprintf(csTag,"txn_country_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
				PutField_CString(hContext,"txn_country",csTmp);
				PutField_CString(hRequest,"txn_country",csTmp);
			}
			sprintf(csTag,"merchant_ref_%d",i);
			if(GetField_CString(hRequest,csTag,&csTmp)){
				PutField_CString(hRequest,"merchant_ref",csTmp);
			}
			sprintf(csTag,"seq_num_%d",i);
			if(GetField_Int(hRequest,csTag,&iTmp)){
				PutField_Int(hContext,"seq_num",iTmp);
			}
			sprintf(csTag,"dst_txn_ccy_%d",i);
			if(GetField_CString(hRequest,csTag,&csTmp)){
				PutField_CString(hRequest,"dst_txn_ccy",csTmp);
			}
			sprintf(csTag,"txn_ccy_%d",i);
			if(GetField_CString(hContext,csTag,&csTmp)){
				PutField_CString(hContext,"net_ccy",csTmp);
				PutField_CString(hContext,"txn_ccy",csTmp);
				PutField_CString(hRequest,"txn_ccy",csTmp);
			}
			sprintf(csTag,"txn_amt_%d",i);
			if(GetField_Double(hRequest,csTag,&dTmp)){
				PutField_Double(hRequest,"txn_amt",dTmp);
			}
			sprintf(csTag,"payout_amount_%d",i);
			if(GetField_Double(hRequest,csTag,&dTmp)){
				PutField_Double(hRequest,"payout_amount",dTmp);
			}
			sprintf(csTag,"org_merchant_fee_%d",i);
			if(GetField_Double(hRequest,csTag,&dTmp)){
				PutField_Double(hRequest,"org_merchant_fee",dTmp);
			}
			sprintf(csTag,"bank_name_%d",i);
			if(GetField_CString(hRequest,csTag,&csTmp)){
				PutField_CString(hRequest,"bank_name",csTmp);
			}
			sprintf(csTag,"bank_code_%d",i);
			if(GetField_CString(hRequest,csTag,&csTmp)){
				PutField_CString(hRequest,"bank_code",csTmp);
			}
			sprintf(csTag,"branch_%d",i);
			if(GetField_CString(hRequest,csTag,&csTmp)){
				PutField_CString(hRequest,"branch",csTmp);
			}
			sprintf(csTag,"account_id_%d",i);
			if(GetField_CString(hRequest,csTag,&csTmp)){
				PutField_CString(hRequest,"account_id",csTmp);
			}
			sprintf(csTag,"account_name_%d",i);
			if(GetField_CString(hRequest,csTag,&csTmp)){
				PutField_CString(hRequest,"account_name",csTmp);
			}
			sprintf(csTag,"batch_id_%d",i);
			if(GetField_CString(hRequest,csTag,&csTmp)){
				PutField_CString(hContext,"batch_id",csTmp);
			}

DEBUGLOG(("Authorize::call TxnMgtByUsPOT\n"));
			TxnObjPtr = CreateObj(TxnPtr,"TxnMgtByUsPOT","Authorize");
			iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
			if(iRet!=PD_OK){
DEBUGLOG(("Authorize::TxnMgtByUsPOT Failed!!!!!\n"));
				break;
			}

		}//end for loop
		

	}
/*
	if(iRet==PD_OK){
DEBUGLOG(("Authorize::call BOPayout->GenerateBatchSeq\n"));
                BOObjPtr = CreateObj(BOPtr,"BOPayout","GenerateBatchSeq");
                iRet = (unsigned long)(*BOObjPtr)(hContext);
	}

	if(iRet==PD_OK){
DEBUGLOG(("Authorize::call BOPayout->AddTxnLog\n"));
                BOObjPtr = CreateObj(BOPtr,"BOPayout","AddTxnLog");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
	}

	if(iRet==PD_OK){
DEBUGLOG(("Authorize::call BOPayout->GetPayoutFee\n"));
                BOObjPtr = CreateObj(BOPtr,"BOPayout","GetPayoutFee");
                iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
	}
	if(iRet==PD_OK){
		int iApproveId = 0;
DEBUGLOG(("Authorize::DBMerchantUploadFileDetail:GetNextApproveId\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetNextApproveId");
		if((unsigned long) ((*DBObjPtr)(&iApproveId))!=PD_OK){
			iRet = INT_ERR;
DEBUGLOG(("Authorize::DBMerchantUploadFileDetail:GetNextApproveId Failed\n"));
		}
		else{
DEBUGLOG(("Authorize:::GetNextApproveId [%d]\n",iApproveId));
			PutField_Int(hContext,"approve_id",iApproveId);
			PutField_Int(hResponse,"approve_id",iApproveId);
		}
	}

	if(iRet==PD_OK){
DEBUGLOG(("Authorize::call BOPayout->UpdateDetail\n"));
		BOObjPtr = CreateObj(BOPtr,"BOPayout","UpdateDetail");
		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
	}

	if(iRet==PD_OK){
		PutField_CString(hContext,"sub_status",PD_APPROVED_FOR_GENERATED);
		PutField_Char(hContext,"party_type",PD_TYPE_MERCHANT);
		PutField_Char(hContext,"response_mode",PD_ACCEPT);
DEBUGLOG(("Authorize::call BOPayout->HandlePayoutBalance\n"));
		BOObjPtr = CreateObj(BOPtr,"BOPayout","HandlePayoutBalance");
		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
	}
*/

DEBUGLOG(("TxnMgtByUsPOA Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
