/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/09/01              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtOnUsPOA.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnMgtOnUsPOA(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;

	char	*csBatchId;
	char	*csTxnCcy;
	char	*csToCcy;
	char	*csTxnCountry;
	char	*csServiceCode;
	char	*csMerchantId;
	char	*csTmp;
	char	cTmp;
	double	dAmt;
	double	dTmp;
	double	dSrcAmt;
	double	dNetAmt;
	double	dFee;
	//double	dSrcMarkup=0;
	//double	dTotalFee=0;
	double dExRate, dOrgDestAmt;
	double  dSettlementBal=0;
	long	lBatchId;
	int	iTmp;

	hash_t	*hRec;
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("Authorize\n"));

	hash_t  *hReq;
	hReq = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hReq,0);

	if(GetField_CString(hRequest,"batch_id",&csBatchId)){
DEBUGLOG(("Authorize::batch_id= [%s]\n",csBatchId));
		lBatchId = ctol(csBatchId,strlen(csBatchId));
	}
	else{
DEBUGLOG(("Authorize::batch_id not found!!\n"));
ERRLOG("TxnMgtOnUsPOA:Authorize::batch_id not found!!\n");
		iRet=INT_INVALID_TXN;
	}

	
	if(GetField_CString(hRequest,"add_user",&csTmp)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csTmp));
		PutField_CString(hContext,"update_user",csTmp);
	}

//get Header
	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBMerchantUploadFileHeader:GetHeader\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","GetHeader");
		if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
DEBUGLOG(("GetDetail::found record = [%ld]\n",lBatchId));
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec,"merchant_id",&csMerchantId)) {
					PutField_CString(hRequest,"merchant_id",csMerchantId);
DEBUGLOG(("GetDetail::merchant_id= [%s]\n",csMerchantId));
				}
				if (GetField_Int(hRec,"status",&iTmp)){
DEBUGLOG(("GetDetail::status= [%d]\n",iTmp));
					//Check Header ststus
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		else{
DEBUGLOG(("GetDetail:: not found record for [%s]\n",csBatchId));
ERRLOG("TxnMgtOnUsPOA:Authorize::GetDetail::not found record!!\n");
			iRet=INT_NOT_RECORD;
		}
	}
	RecordSet_Destroy(rRecordSet);


	if(iRet==PD_OK){
//////get merchant_client_id
DEBUGLOG(("Authorize::Call BOMerchant:GetMerchantDetail\n"));
                BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantDetail");
                if((unsigned long)(*BOObjPtr)(hContext,hRequest)!=PD_OK)
                        iRet = INT_ERR;
        }

//Get Detail
	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBMerchantUploadFileDetail:GetDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetail");
		if ((*DBObjPtr)((unsigned long)lBatchId,rRecordSet) == PD_OK) {
DEBUGLOG(("GetDetail::found record = [%ld]\n",lBatchId));
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if(GetField_Int(hRec,"seq_num",&iTmp)){
DEBUGLOG(("GetDetail::seq_num= [%d]\n",iTmp));
				}
				/*if (GetField_CString(hRec,"merchant_id",&csMerchantId)) {
DEBUGLOG(("GetDetail::merchant_id= [%s]\n",csMerchantId));
				}*/
				if (GetField_CString(hRec,"service_code",&csServiceCode)) {
					PutField_CString(hRequest,"service_code",csServiceCode);
DEBUGLOG(("GetDetail::service_code= [%s]\n",csServiceCode));
				}
				else{
					PutField_CString(hRequest,"service_code","DEF");
DEBUGLOG(("GetDetail::default service_code= [%s]\n","DEF"));
				}
                        	if (GetField_CString(hRec,"txn_country",&csTxnCountry)) {
					PutField_CString(hRequest,"txn_country",csTxnCountry);
DEBUGLOG(("GetDetail::txn_country= [%s]\n",csTxnCountry));
				}
				if (GetField_Double(hRec,"payout_amount",&dAmt)) {
					PutField_Double(hContext,"txn_amt",dAmt);
DEBUGLOG(("GetDetail::payout_amount= [%lf]\n",dAmt));
				}
				if (GetField_Double(hRec,"request_amount",&dNetAmt)) {
DEBUGLOG(("GetDetail::request_amount= [%lf]\n",dNetAmt));
				}
				if (GetField_CString(hRec,"payout_ccy",&csTmp)){
					PutField_CString(hRequest,"txn_ccy",csTmp);
DEBUGLOG(("GetDetail::payout_ccy= [%s]\n",csTmp));
				}
				if (GetField_CString(hRec,"request_ccy",&csTmp)){
					PutField_CString(hContext,"dst_txn_ccy",csTmp);
DEBUGLOG(("GetDetail::request_ccy= [%s]\n",csTmp));
				}
				if (GetField_Int(hRec,"status",&iTmp)) {
DEBUGLOG(("GetDetail::status = [%d]\n",iTmp));
				}

//////Call BOExchange
DEBUGLOG(("Authorize::Call BOExchange:GetExchangeInfo\n"));
                		///use [WTB] to find fx markup fee///
                		PutField_CString(hContext,"txn_code",PD_WITHDRAW_BATCH_TXN_CODE);
	
        	        	BOObjPtr = CreateObj(DBPtr,"BOExchange","GetExchangeInfo");
        	        	if ((*BOObjPtr)(hContext,hRequest) == PD_OK) {
DEBUGLOG(("GetExternalExchangeInfo Success\n"));
                	        	if(GetField_Double(hContext,"dst_txn_amt",&dTmp)){
DEBUGLOG(("Destination Amount=[%lf]\n",dTmp));
                       			}
					if(GetField_Double(hContext,"markup_amt",&dTmp)){
DEBUGLOG(("Markup Amount=[%lf]\n",dTmp));
                        		}
                        		if(GetField_Double(hContext,"markup_rate",&dTmp)){
DEBUGLOG(("Markup rate=[%lf]\n",dTmp));
                        		}
                        		if(GetField_Double(hContext,"ex_rate",&dTmp)){
DEBUGLOG(("Exchange rate=[%lf]\n",dTmp));
                        		}
                		}
                		else{
                        		iRet = INT_ERR;
DEBUGLOG(("Authorize::GetExchangeInfo Error\n"));
ERRLOG("TxnMgtOnUsPOA:Authorize::GetExchangeInfo Error\n");
                		}
				
//Call BOFee
DEBUGLOG(("Authorize::Call BOFee:GetTxnFee\n"));
                		BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
                		if((unsigned long)(*BOObjPtr)(hContext,hRequest)==PD_OK){
                        		if(GetField_Double(hContext,"total_src_txn_fee",&dTmp)){
DEBUGLOG(("Authorize::payout txn fee=[%f]\n",dTmp));
                        		}
                        		if(GetField_Double(hContext,"net_amt",&dTmp)){
DEBUGLOG(("Authorize::payout net amt=[%f]\n",dTmp));
                        		}
                        		if(GetField_Double(hContext,"dst_net_amt",&dTmp)){
DEBUGLOG(("Authorize::payout dest net amt=[%f]\n",dTmp));
                        		}
                		}
                		else{
                        		iRet = INT_ERR;
DEBUGLOG(("Authorize::GetTxnFee Error\n"));
ERRLOG("TxnMgtOnUsPOA:Authorize::GetTxnFee Error\n");
                		}

                		PutField_CString(hContext,"txn_code","POA");


				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		else{
DEBUGLOG(("GetDetail:: not found record for [%s]\n",csBatchId));
ERRLOG("TxnMgtOnUsPOA:Authorize::GetDetail::not found record!!\n");
			iRet=INT_NOT_RECORD;
		}

	}
	RecordSet_Destroy(rRecordSet);
/*
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:GetTxnDetail\n"));
        	recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
        	if ((*DBObjPtr)(csTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("GetTxnDetail::found record = [%s]\n",csTxnSeq));
               		hRec = RecordSet_GetFirst(rRecordSet);
                	while (hRec) {
                        	if (GetField_CString(hRec,"txn_ccy",&csToCcy)) {
        	        		PutField_CString(hContext,"to_txn_ccy",csToCcy);
DEBUGLOG(("GetTxnDetail::deliver_ccy = [%s]\n",csToCcy));
                        	}
                        	if (GetField_CString(hRec,"txn_country",&csTxnCountry)) {
        	        		PutField_CString(hRequest,"txn_country",csTxnCountry);
        	        		PutField_CString(hContext,"txn_country",csTxnCountry);
DEBUGLOG(("GetTxnDetail::txn_country = [%s]\n",csTxnCountry));
                        	}
                        	hRec = RecordSet_GetNext(rRecordSet);
                	}
        	}
        	else {
DEBUGLOG(("GetTxnDetail:: not found record for [%s]\n",csTxnSeq));
ERRLOG("TxnMgtOnUsPOA:Authorize::GetTxnDetail:: not found record!!\n");
               		iRet = INT_NOT_RECORD;
        	}
        	RecordSet_Destroy(rRecordSet);
	}

	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBMerchantSettlementDetail:GetSettlementDetail\n"));
        	recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBMerchantSettlementDetail","GetSettlementDetail");
		if((unsigned long)(*DBObjPtr)(csTxnSeq,rRecordSet)==PD_OK){
DEBUGLOG(("GetSettlementDetail::found record = [%s]\n",csTxnSeq));
			hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
				if(GetField_CString(hRec,"request_ccy",&csTxnCcy)){
        	        		PutField_CString(hRequest,"txn_ccy",csTxnCcy);
					PutField_CString(hContext,"txn_ccy",csTxnCcy);
					PutField_CString(hContext,"org_txn_ccy",csTxnCcy);
DEBUGLOG(("GetSettlementDetail::request_ccy = [%s]\n",csTxnCcy));
				}
				if(GetField_CString(hRec,"deliver_ccy",&csTmp)){
					PutField_CString(hContext,"dst_txn_ccy",csTmp);
DEBUGLOG(("GetSettlementDetail::deliver_ccy = [%s]\n",csTmp));
				}
				if (GetField_Char(hRec,"status",&cTmp)) {
DEBUGLOG(("GetSettlementDetail::status = [%c]\n",cTmp));
					if(cTmp!=PD_PROCESSING){
						iRet=INT_INVALID_TXN;
DEBUGLOG(("GetSettlementDetail::Invalid status\n"));
ERRLOG("TxnMgtOnUsPOA:Authorize::GetSettlementDetail::Invalid status!!\n");
					}
				}
                        	hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		else{
DEBUGLOG(("GetSettlementDetail:: not found record for [%s]\n",csTxnSeq));
ERRLOG("TxnMgtOnUsPOA:Authorize::GetSettlementDetail::not found record!!\n");
                        iRet = INT_NOT_RECORD;
		}
        	RecordSet_Destroy(rRecordSet);
	}


	if(iRet==PD_OK){
//////get merchant_client_id
DEBUGLOG(("Authorize::Call BOMerchant:GetMerchantDetail\n"));
		BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantDetail");
		if((unsigned long)(*BOObjPtr)(hContext,hRequest)!=PD_OK)
			iRet = INT_ERR;
	}



	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call BOExchange:GetExchangeInfo\n"));
//////////////////calculate fx and markup
		///use [STR] to find fx markup fee///
		PutField_CString(hContext,"txn_code",PD_SETTLEMENT_REQUEST);

		BOObjPtr = CreateObj(DBPtr,"BOExchange","GetExchangeInfo");
		if ((*BOObjPtr)(hContext,hRequest) == PD_OK) {
DEBUGLOG(("GetExternalExchangeInfo Success\n"));
			if(GetField_Double(hContext,"dst_txn_amt",&dOrgDestAmt)){
                                //PutField_Double(hReq,"deliver_amt",dOrgDestAmt);
DEBUGLOG(("Destination Amount=[%lf]\n",dOrgDestAmt));
			}
			if(GetField_Double(hContext,"markup_amt",&dTmp)){
DEBUGLOG(("Markup Amount=[%lf]\n",dTmp));
			}
			if(GetField_Double(hContext,"markup_rate",&dTmp)){
DEBUGLOG(("Markup rate=[%lf]\n",dTmp));
			}
			if(GetField_Double(hContext,"ex_rate",&dExRate)){
DEBUGLOG(("Exchange rate=[%lf]\n",dExRate));
			}
			if(GetField_Char(hContext,"ex_party",&cTmp)){
                                PutField_Char(hContext,"ex_supplier",cTmp);
DEBUGLOG(("Exchange Party=[%c]\n",cTmp));
			}

		}
		else{
                        iRet = INT_ERR;
DEBUGLOG(("Authorize::GetExchangeInfo Error\n"));
ERRLOG("TxnMgtOnUsPOA:Authorize::GetExchangeInfo Error\n");
		}

	}

	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call BOFee:GetTxnFee\n"));
		BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
                if((unsigned long)(*BOObjPtr)(hContext,hRequest)==PD_OK){
                        if(GetField_Double(hContext,"total_src_txn_fee",&dFee)){
DEBUGLOG(("Authorize::settlement txn fee=[%f]\n",dFee));
                        }
                        if(GetField_Double(hContext,"net_amt",&dSrcAmt)){
DEBUGLOG(("Authorize::settlement net amt=[%f]\n",dSrcAmt));
                        }
                        if(GetField_Double(hContext,"dst_txn_amt",&dTmp)){
				PutField_Double(hReq,"deliver_amt",dTmp);
DEBUGLOG(("Authorize::settlement dest net amt=[%f]\n",dTmp));
                        }
		}
		else{
                        iRet = INT_ERR;
DEBUGLOG(("Authorize::BOSettlementFee Error\n"));
ERRLOG("TxnMgtOnUsPOA:Authorize::BOSettlementFee Error\n");
                }
		
		
		PutField_CString(hContext,"txn_code",PD_SETTLEMENT_PROCESS);
	}


	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call BOBalance:GetAvalBalanceForUpdate\n"));
		BOObjPtr = CreateObj(BOPtr,"BOBalance","GetAvalBalanceForUpdate");
                if((unsigned long)(*BOObjPtr)(csTxnCountry,
						csTxnCcy,
						csServiceCode,
						csMerchantId,
						&dSettlementBal)==PD_OK){
DEBUGLOG(("GetAvalBalance for settlement=[%f]\n",dSettlementBal));
                        if(dSettlementBal<dSrcAmt){
                                iRet=INT_INSUFFICIENT_FUND;
DEBUGLOG(("Settlement Bal[%f] < Request Net Amt=[%f]\n",dSettlementBal,dSrcAmt));
ERRLOG("TxnMgtOnUsPOA::Authorize::insufficient aval settlement balance!!\n");
                        }
                }
                else{
DEBUGLOG(("GetAvalBalanceForUpdate Error\n"));
ERRLOG("TxnMgtOnUsPOA::Authorize::GetAvalBalanceForUpdate Error!!\n");
                        iRet = INT_ERR;
                }
        }

	if(iRet==PD_OK){
		ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnFeeChgLog");
               	iRet = (unsigned long)((*ChannelObjPtr)(hContext));
	}


	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBMerchantSettlementDetail:Update\n"));
                PutField_Char(hReq,"status",PD_TO_PSP);
                DBObjPtr = CreateObj(DBPtr,"DBMerchantSettlementDetail","Update");
                if((unsigned long) ((*DBObjPtr)(hReq))!=PD_OK)
			iRet = INT_ERR;
        }

	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call BOBalance:UpdateSettlementAmount\n"));
                BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdateSettlementAmount");
                if((unsigned long) ((*BOObjPtr)(hContext))!=PD_OK)
                        iRet = INT_ERR;
        }


	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:UpdateDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK)
			iRet = INT_ERR;
	}
*/
	if(iRet!=PD_OK){
                PutField_Int(hContext,"internal_error",iRet);
        }

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
        FREE_ME(hReq);
DEBUGLOG(("TxnMgtOnUsPOA Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
