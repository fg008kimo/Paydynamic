/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/07/25              Stan Poon
*/

#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsBSF.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);

void TxnOmtByUsBSF(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int	iRet = PD_OK;
	int	iTmp;
	char	*csTmp;
	char	cAction;

/* action */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "action", &csTmp)) {
			cAction = csTmp[0];
DEBUGLOG(("Authorize() action = [%c]\n", csTmp[0]));
		}
	}
/* int_bank_code */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "int_bank_code", &csTmp)) {
			PutField_CString(hContext,"int_bank_code",csTmp);
DEBUGLOG(("Authorize() int_bank_code = [%s]\n", csTmp));
		} else {
			//iRet = INT_ERR;
DEBUGLOG(("Authorize() int_bank_code is missing!!!\n"));
ERRLOG("TxnOmtByUsBSF::Authorize() int_bank_code is missing!!!\n");
		}
	}
/* format_type */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "type", &csTmp)) {
			PutField_CString(hContext,"format_type",csTmp);
DEBUGLOG(("Authorize() format_type = [%s]\n", csTmp));
		} else {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() format_type is missing!!!\n"));
ERRLOG("TxnOmtByUsBSF::Authorize() format_type is missing!!!\n");
		}
	}
/* format_value */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "value", &csTmp)) {
			PutField_Int(hContext,"format_value",atoi(csTmp));
DEBUGLOG(("Authorize() format_value = [%s]\n", csTmp));
		} else if (cAction == PD_ACTION_UPDATE || cAction == PD_ACTION_DELETE) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() format_value is missing!!!\n"));
ERRLOG("TxnOmtByUsBSF::Authorize() format_value is missing!!!\n");
		}
	}
/* format_txn_code */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "code", &csTmp)) {
			PutField_CString(hContext,"format_txn_code",csTmp);
DEBUGLOG(("Authorize() format_txn_code = [%s]\n", csTmp));
		}
	}
/* format_template */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "template", &csTmp)) {
			PutField_CString(hContext,"format_template",csTmp);
DEBUGLOG(("Authorize() format_template = [%s]\n", csTmp));
		}
	}
/* format_col_name */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "column", &csTmp)) {
			PutField_CString(hContext,"format_col_name",csTmp);
DEBUGLOG(("Authorize() format_col_name = [%s]\n", csTmp));
		}
	}
/* display_order */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "display_order", &csTmp)) {
			PutField_Int(hContext,"display_order",atoi(csTmp));
DEBUGLOG(("Authorize() display_order = [%s]\n", csTmp));
		} else if (cAction == PD_ACTION_UPDATE) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() display_order is missing!!!\n"));
ERRLOG("TxnOmtByUsBSF::Authorize() display_order is missing!!!\n");
		}
	}
/* user */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "add_user", &csTmp)) {
			PutField_CString(hContext,"create_user",csTmp);
			PutField_CString(hContext,"update_user",csTmp);
DEBUGLOG(("Authorize() user = [%s]\n", csTmp));
		} else {
			iRet = INT_USER_NOT_FOUND;
DEBUGLOG(("Authorize() user is missing!!!\n"));
ERRLOG("TxnOmtByUsBSF::Authorize() user is missing!!!\n");
		}
	}

/* Action */
	if (iRet == PD_OK) {
		if (cAction == PD_ACTION_ADD) {
DEBUGLOG(("Authorize() call DBOLStmtFormat::AddKeywords()\n"));
			DBObjPtr = CreateObj(BOPtr, "DBOLStmtFormat", "AddKeywords");
			if ((unsigned long)(*DBObjPtr)(hContext) == PD_OK) {
DEBUGLOG(("Authorize() call DBOLStmtFormat::AddKeywords() Success\n"));
				GetField_Int(hContext,"display_order",&iTmp);
				PutField_Int(hResponse,"display_order",iTmp);
DEBUGLOG(("Authorize() call DBOLStmtFormat::AddKeywords() display_order=[%d]\n",iTmp));
			} else {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStmtFormat::AddKeywords() FAILURE!!!\n"));
			}

		} else if (cAction == PD_ACTION_UPDATE) {
DEBUGLOG(("Authorize() call DBOLStmtFormat::UpdateKeywords()\n"));
			DBObjPtr = CreateObj(BOPtr, "DBOLStmtFormat", "UpdateKeywords");
			if ((unsigned long)(*DBObjPtr)(hContext) == PD_OK) {
DEBUGLOG(("Authorize() call DBOLStmtFormat::UpdateKeywords() Success\n"));
			} else {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStmtFormat::UpdateKeywords() FAILURE!!!\n"));
			}

		} else if (cAction == PD_ACTION_DELETE) {

			PutField_Int(hContext,"disabled",1);

DEBUGLOG(("Authorize() call DBOLStmtFormat::UpdateKeywords()\n"));
			DBObjPtr = CreateObj(BOPtr, "DBOLStmtFormat", "UpdateKeywords");
			if ((unsigned long)(*DBObjPtr)(hContext) == PD_OK) {
DEBUGLOG(("Authorize() call DBOLStmtFormat::UpdateKeywords() Success\n"));
			} else {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStmtFormat::UpdateKeywords() FAILURE!!!\n"));
			}

		}
	}

	if (iRet != PD_OK) {
		PutField_Int(hContext, "internal_error", iRet);
	}

DEBUGLOG(("Authorize() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;
}

