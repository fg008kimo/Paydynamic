/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/09/10              Dirk Wong
*/

#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsBSE.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);

void TxnOmtByUsBSE(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int	iRet = PD_OK;
	
	char	cAction;
	char	*csUser = NULL;
	char    *csFileId = NULL;
	char    csFileName[PD_FILENAME_LEN + 1];

	int	iHeaderVer = 0;
	int	iSkipCount = 0;
	int	iHoldCount = 0;
	int	iAcceptCount = 0;
	int	iTotalCount = 0;
	int	iSplitCount = 0;
	int	iAddCount = 0;
	int	iUpdateCount = 0;
	int	iDeleteCount = 0;
	int	iFileCount = 0;

	int	iSeq = 0;
	int	iVer = 0;
	int	iLatestVer = 0;
	int	iOrgSysSeq = 0;
	int	iSysSeq = 0;
	//int	iUserSeq = 0;	
	int	iDisabled = 0;
	//int	iSkip = 0;
	//int	iMaskSkip = 0;
	//char	csStatementDate = NULL;
	//char	csStatementTime = NULL;

	char 	csTag[PD_TAG_LEN+1];
	char	*csTmp;
	char	cTmp;
	double	dTmp;
	int	iTmp;

	hash_t *hRecHeaderGet = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRecHeaderGet,0);

	hash_t *hRecHeaderPut = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRecHeaderPut,0);

	hash_t *hRecDetailGet = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRecDetailGet,0);

	hash_t *hRecDetailPut = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRecDetailPut,0);

/* action */
	if (GetField_CString(hRequest, "action", &csTmp)) {
		cAction = csTmp[0];
		PutField_Char(hContext,"action",cAction);
DEBUGLOG(("Authorize() action = [%c]\n", cAction));
	} else {
                iRet = INT_ACTION_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: action not found!!\n"));
ERRLOG("TxnOmtByUsSCE:: Authorize:: action not found!!\n");
        }

/* file_id */
	if (GetField_CString(hRequest, "file_id", &csFileId)) {
		PutField_CString(hContext,"file_id",csFileId);
DEBUGLOG(("Authorize() file_id = [%s]\n", csFileId));
	} else {
              	//iRet = INT_FILE_ID_NOT_FOUND;
                //PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: file_id not found!!\n"));
ERRLOG("TxnOmtByUsSCE:: Authorize:: file_id not found!!\n");
        }

/* user */
        if (GetField_CString(hRequest, "add_user", &csUser)) {
                PutField_CString(hContext,"create_user",csUser);
                PutField_CString(hContext,"update_user",csUser);
DEBUGLOG(("Authorize() user = [%s]\n", csUser));
        } else {
                iRet = INT_USER_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() user NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsSCU::Authorize() user NOT FOUND!!!\n");
        }

	if ((iRet == PD_OK) && (cAction == PD_ACTION_ADD)) {	
DEBUGLOG(("Authorize()::CAction()::Add\n"));

/* Check File Exist */
DEBUGLOG(("Authorize() call DBOLStatement::CheckFileExist()\n"));
		snprintf(csFileName,sizeof(csFileName),"SF%s",csFileId);
DEBUGLOG(("Authorize() call DBOLTxnSeq::file_name = [%s]\n",csFileName));
                DBObjPtr = CreateObj(DBPtr,"DBOLStatement","CheckFileExist");
		if ((unsigned long)(*DBObjPtr)(csFileName) == FOUND) {

DEBUGLOG(("Authorize() call DBOLStatement::File Exist()!!! \n"));

/* Get Statement Tmp (Latest Seq Record) Detail */

			DBObjPtr = CreateObj(DBPtr,"DBOLStatementTmp","GetLatestSeqRecDetail");
                	iRet = (unsigned long)(*DBObjPtr)(csFileId,hRecDetailGet);
DEBUGLOG(("Authorize() GetLatestSeqRecDetail::iRet = [%d]\n",iRet));
                	if (iRet == PD_OK) {		

/* seq */
				if (GetField_Int(hRecDetailGet,"seq",&iSeq)) {
DEBUGLOG(("Authorize() GetLatestSeqRecDetail::seq = [%d]\n",iSeq));
        	                }

#if 0
/* ver */
				if (GetField_Int(hRecDetailGet,"ver",&iVer)) {
DEBUGLOG(("Authorize() GetLatestSeqRecDetail::ver = [%d]\n",iVer));
                        	}

/* latest_ver */
				if (GetField_Int(hRecDetailGet,"latest_ver",&iLatestVer)) {
DEBUGLOG(("Authorize() GetLatestSeqRecDetail::latest_ver = [%d]\n",iLatestVer));
                        	}
#endif

/* org_sys_seq */
				if (GetField_Int(hRecDetailGet,"org_sys_seq",&iOrgSysSeq)) {
DEBUGLOG(("Authorize() GetLatestSeqRecDetail::org_sys_seq = [%d]\n",iOrgSysSeq));
                        	}

/* sys_seq */
				if (GetField_Int(hRecDetailGet,"sys_seq",&iSysSeq)) {
DEBUGLOG(("Authorize() GetLatestSeqRecDetail::sys_seq = [%d]\n",iSysSeq));
                        	}

#if 0
/* user_seq */
				if (GetField_Int(hRecDetailGet,"user_seq",&iUserSeq)) {
DEBUGLOG(("Authorize() GetLatestSeqRecDetail::user_seq = [%d]\n",iUserSeq));
                        	}
#endif

			} else {
				iRet = INT_ERR;
DEBUGLOG(("Authorize:: GetLatestSeqRecDetail:: failed\n"));
ERRLOG("Authorize::ValidateProcess::GetLatestSeqRecDetail:: failed!!\n");
			}

/* Add Statement Tmp Detail */
			if (iRet == PD_OK) {

/* file_id */
				PutField_CString(hContext,"file_id",csFileId);
DEBUGLOG(("Authorize() AddDetail::file_id = [%s]\n",csFileId));

/* seq */
                              	PutField_Int(hContext, "seq",++iSeq);
DEBUGLOG(("Authorize() AddDetail::seq = [%d]\n",iSeq));

/* ver */
				iVer = 0;
				PutField_Int(hContext, "ver",iVer);		
DEBUGLOG(("Authorize() AddDetail::ver = [%d]\n",iVer));

#if 0
/* latest_ver */
				iLatestVer = 0;
				PutField_Int(hContext, "latest_ver",iLatestVer);		
DEBUGLOG(("Authorize() AddDetail::latest_ver = [%d]\n",iLatestVer));
#endif
		
/* org_sys_seq */
				PutField_Int(hContext, "org_sys_seq",++iOrgSysSeq);
DEBUGLOG(("Authorize() AddDetail::org_sys_seq = [%d]\n",iOrgSysSeq));
		
/* sys_seq */
				PutField_Int(hContext, "sys_seq",++iSysSeq);
DEBUGLOG(("Authorize() AddDetail::sys_seq = [%d]\n",iSysSeq));

#if 0	
/* user_seq */
				PutField_Int(hContext, "user_seq",++iUserSeq);
DEBUGLOG(("Authorize() AddDetail::user_seq = [%d]\n",iUserSeq));
#endif

/* disabled */
				iDisabled = 0;
                                PutField_Int(hContext, "disabled",iDisabled);
DEBUGLOG(("Authorize() AddDetail::disabled = [%d]\n",iDisabled));

/* skip */
                                if (GetField_CString(hRequest, "skip", &csTmp)) {
                                        iTmp = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::skip = [%d]\n", iTmp));
                                        PutField_Int(hContext, "skip",iTmp);
                                }

/* mask_skip */
                                if (GetField_CString(hRequest, "mask_skip", &csTmp)) {
                                        iTmp = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::mask_skip = [%d]\n", iTmp));
                                        PutField_Int(hContext, "mask_skip",iTmp);
                                }

/* int_bank_code */
                                if (GetField_CString(hRequest, "int_bank_code", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::int_bank_code = [%s]\n", csTmp));
                                        PutField_CString(hContext,"int_bank_code",csTmp);
                                }

/* bank_acct_num */
                                if (GetField_CString(hRequest, "bank_acct_num", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::bank_acct_num = [%s]\n", csTmp));
                                        PutField_CString(hContext,"bank_acct_num",csTmp);
                                }

/* raw_date */
                                if (GetField_CString(hRequest, "raw_date", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::raw_date = [%s]\n", csTmp));
                                        PutField_CString(hContext,"raw_date",csTmp);
                                }

/* raw_time */
                                if (GetField_CString(hRequest, "raw_time", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::raw_time = [%s]\n", csTmp));
                                        PutField_CString(hContext,"raw_time",csTmp);
				}

/* statement_date */
                                if (GetField_CString(hRequest, "statement_date", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::statement_date = [%s]\n", csTmp));
                                       PutField_CString(hContext,"statement_date",csTmp);
                                }

/* statement_time */
                                if (GetField_CString(hRequest, "statement_time", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::statement_time = [%s]\n", csTmp));
                                        PutField_CString(hContext,"statement_time",csTmp);
                                }

/* tfr_bank_name */
                                if (GetField_CString(hRequest, "tfr_bank_name", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_bank_name = [%s]\n", csTmp));
                                        PutField_CString(hContext,"tfr_bank_name",csTmp);
                                }

/* tfr_bank_acct_num */
                                if (GetField_CString(hRequest, "tfr_bank_acct_num", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_bank_acct_num = [%s]\n", csTmp));
                                        PutField_CString(hContext,"tfr_bank_acct_num",csTmp);
                                }

/* tfr_type */
                                if (GetField_CString(hRequest, "tfr_type", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_type = [%s]\n", csTmp));
                                        PutField_CString(hContext,"tfr_type",csTmp);
                                }

/* tfr_channel */
                                if (GetField_CString(hRequest, "tfr_channel", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_channel = [%s]\n", csTmp));
                                        PutField_CString(hContext,"tfr_channel",csTmp);
                                }

/* tft_text */
                                if (GetField_CString(hRequest, "tfr_text", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_text = [%s]\n", csTmp));
                                        PutField_CString(hContext,"tfr_text",csTmp);
                                }

/* tfr_customer_test */
                                if (GetField_CString(hRequest, "tfr_customer_text", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_customer_text = [%s]\n",csTmp));
                                        PutField_CString(hContext,"tfr_customer_text",csTmp);
                                }

/* sender_name */
                                if (GetField_CString(hRequest, "sender_name", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::sender_name = [%s]\n",csTmp));
                                        PutField_CString(hContext,"sender_name",csTmp);
                                }

/* txn_ref_num */
                                if (GetField_CString(hRequest, "txn_ref_num", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::txn_ref_num = [%s]\n",csTmp));
                                        PutField_CString(hContext,"txn_ref_num",csTmp);
                                }

/* balance */
                                if (GetField_CString(hRequest, "balance", &csTmp)) {
                                        dTmp = atof(csTmp);
DEBUGLOG(("Authorize() AddDetail::balance = [%.2f]\n",dTmp));
                                        //PutField_Double(hContext,"balance",dTmp);
                                        PutField_CString(hContext,"balance",csTmp);
                                }

/* amt_type */
                                if (GetField_CString(hRequest, "amt_type", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::amt_type = [%s]\n",csTmp));
                                        PutField_CString(hContext,"amt_type",csTmp);
                                }

/* txn_amount */
                                if (GetField_CString(hRequest, "txn_amount", &csTmp)) {
                                        dTmp = atof(csTmp);
DEBUGLOG(("Authorize() AddDetail::txn_amount = [%.2f]\n",dTmp));
					//PutField_Double(hContext,"txn_amount",dTmp);
					PutField_CString(hContext,"txn_amount",csTmp);
				}

/* bank_charge */
                                if (GetField_CString(hRequest, "bank_charge", &csTmp)) {
                                        dTmp = atof(csTmp);
DEBUGLOG(("Authorize() AddDetail::bank_charge = [%.2f]\n",dTmp));
					//PutField_Double(hContext,"bank_charge",dTmp);
                                        PutField_CString(hContext,"bank_charge",csTmp);
                                }

DEBUGLOG(("Authorize() call DBOLStatementTmp::Add()\n"));
                        	DBObjPtr = CreateObj(DBPtr, "DBOLStatementTmp", "AddDetail");
                        	iRet = (unsigned long)(*DBObjPtr)(hContext);
                        	if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatementTmp::Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: AddDetail() FAILURE!!!\n");
				}
			}
					
/* Get Statement Header */
			if (iRet == PD_OK) {
						
                        	DBObjPtr = CreateObj(DBPtr,"DBOLStatement","GetHeader");
                        	iRet = (unsigned long)(*DBObjPtr)(csFileId,hRecHeaderGet);
DEBUGLOG(("Authorize() GetHeader::iRet = [%d]\n",iRet));
                        	if (iRet == PD_OK) {

/* skip_count */
                                	if (GetField_Int(hRecHeaderGet,"skip_count",&iSkipCount)) {
DEBUGLOG(("Authorize() GetHeader::skip_count = [%d]\n",iSkipCount));
                                	}

/* hold_count */
                                	if (GetField_Int(hRecHeaderGet,"hold_count",&iHoldCount)) {
DEBUGLOG(("Authorize() GetHeader::hold_count = [%d]\n",iHoldCount));
                                	}

/* accept_count */
                                	if (GetField_Int(hRecHeaderGet,"accept_count",&iAcceptCount)) {
DEBUGLOG(("Authorize() GetHeader::accept_count = [%d]\n",iAcceptCount));
                                	}

/* total_count */
                                	if (GetField_Int(hRecHeaderGet,"total_count",&iTotalCount)) {
DEBUGLOG(("Authorize() GetHeader::total_count = [%d]\n",iTotalCount));
                                	}

/* ver */
                                	if (GetField_Int(hRecHeaderGet,"ver",&iHeaderVer)) {
DEBUGLOG(("Authorize() GetHeader::ver = [%d]\n",iHeaderVer));
                                	}

/* split_count */
                                	if (GetField_Int(hRecHeaderGet,"split_count",&iSplitCount)) {
DEBUGLOG(("Authorize() GetHeader::split_count = [%d]\n",iSplitCount));
                                	}

/* add_count */
                                	if (GetField_Int(hRecHeaderGet,"add_count",&iAddCount)) {
DEBUGLOG(("Authorize() GetHeader::add_count = [%d]\n",iAddCount));
                                	}

/* update_count */
                                	if (GetField_Int(hRecHeaderGet,"update_count",&iUpdateCount)) {
DEBUGLOG(("Authorize() GetSHeader::update_count = [%d]\n",iUpdateCount));
                                	}

/* delete_count */
                                	if (GetField_Int(hRecHeaderGet,"delete_count",&iDeleteCount)) {
DEBUGLOG(("Authorize() GetHeader::delete_count = [%d]\n",iDeleteCount));
                                	}

/* file_count */
                                	if (GetField_Int(hRecHeaderGet,"file_count",&iFileCount)) {
DEBUGLOG(("Authorize() GetHeader::file_count = [%d]\n",iFileCount));
                                	}

                        	} else {
                                	iRet = INT_ERR;
DEBUGLOG(("Authorize:: GetHeader:: failed\n"));
ERRLOG("Authorize::ValidateProcess::GetHeader:: failed!!\n");
                        	}
			}

/* Update Statement Header */
                        if (iRet == PD_OK) {

/* file_id */
                                PutField_CString(hRecHeaderPut,"file_id",csFileId);
DEBUGLOG(("Authorize() UpdateHeader::file_id = [%s]\n",csFileId));

/* skip_count */
                                PutField_Int(hRecHeaderPut, "skip_count",iSkipCount);
DEBUGLOG(("Authorize() UpdateHeader::skip_count = [%d]\n",iSkipCount));

/* hold_count */
                                PutField_Int(hRecHeaderPut, "hold_count",iHoldCount);
DEBUGLOG(("Authorize() UpdateHeader::hold_count = [%d]\n",iHoldCount));

/* accept_count */
                                PutField_Int(hRecHeaderPut, "accept_count",++iAcceptCount);
DEBUGLOG(("Authorize() UpdateHeader::accept_count = [%d]\n",iAcceptCount));

/* total_count */
                                PutField_Int(hRecHeaderPut, "total_count",++iTotalCount);
DEBUGLOG(("Authorize() UpdateHeader::total_count = [%d]\n",iTotalCount));

/* ver */
				if (iVer > iHeaderVer) {	
                                	PutField_Int(hRecHeaderPut, "ver",iVer);
DEBUGLOG(("Authorize() UpdateHeader::ver = [%d]\n",iVer));
				} else {
                                	PutField_Int(hRecHeaderPut, "ver",iHeaderVer);
DEBUGLOG(("Authorize() UpdateHeader::ver = [%d]\n",iHeaderVer));
				}

/* split_count */
                                PutField_Int(hRecHeaderPut, "split_count",iSplitCount);
DEBUGLOG(("Authorize() UpdateHeader::split_count = [%d]\n",iSplitCount));

/* add_count */
                                PutField_Int(hRecHeaderPut, "add_count",++iAddCount);
DEBUGLOG(("Authorize() UpdateHeader::add_count = [%d]\n",iAddCount));

/* updat_count */
                                PutField_Int(hRecHeaderPut, "update_count",iUpdateCount);
DEBUGLOG(("Authorize() UpdateHeader::update_count = [%d]\n",iUpdateCount));

/* delete_count */
                                PutField_Int(hRecHeaderPut, "delete_count",iDeleteCount);
DEBUGLOG(("Authorize() UpdateHeader::delete_count = [%d]\n",iDeleteCount));

/* file_count */
                                PutField_Int(hRecHeaderPut, "file_count",++iFileCount);
DEBUGLOG(("Authorize() UpdateHeader::file_count = [%d]\n",iFileCount));

/* update_user */
                                PutField_CString(hRecHeaderPut,"update_user",csUser);
DEBUGLOG(("Authorize() UpdateHeader::update_user = [%s]\n",csUser));

DEBUGLOG(("Authorize() call DBOLStatement::UpdateHeader()\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "UpdateHeader");
                                iRet = (unsigned long)(*DBObjPtr)(hRecHeaderPut);
                                if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatement::UpdateHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatement:: UpdateHeader() FAILURE!!!\n");
                                }
                        }
		} else {

DEBUGLOG(("Authorize() call DBOLStatement::File Not Exist()!!! \n"));

/* Get Next File Id */
DEBUGLOG(("Authorize() call DBOLTxnSeq::GetNextOdiFileSeq()\n"));
                        DBObjPtr = CreateObj(DBPtr,"DBOLTxnSeq","GetNextOdiFileSeq");
                        csFileId = (*DBObjPtr)();
DEBUGLOG(("Authorize() call DBOLTxnSeq::GetNextOdiFileSeq() file_id = [%s]\n",csFileId));
		
/* Add Statement Tmp Detail */

/* file_id */
			PutField_CString(hContext,"file_id",csFileId);
DEBUGLOG(("Authorize() AddDetail::file_id = [%s]\n", csFileId));

/* seq */
			iSeq = 1;
			PutField_Int(hContext, "seq",iSeq);		
DEBUGLOG(("Authorize() AddDetail::seq = [%d]\n",iSeq));

/* ver */
			iVer = 0;
			PutField_Int(hContext, "ver",iVer);
DEBUGLOG(("Authorize() AddDetail::ver = [%d]\n",iVer));

#if 0
/* latest_ver */
			iLatestVer = 0;
			PutField_Int(hContext, "latest_ver",iLatestVer);
DEBUGLOG(("Authorize() AddDetail::latest_ver = [%d]\n",iLatestVer));
#endif

/* org_sys_seq */
			iOrgSysSeq = 1;
			PutField_Int(hContext, "org_sys_seq",iOrgSysSeq);
DEBUGLOG(("Authorize() AddDetail::org_sys_seq = [%d]\n",iOrgSysSeq));

/* sys_seq */
			iSysSeq = 1;
			PutField_Int(hContext, "sys_seq",iSysSeq);
DEBUGLOG(("Authorize() AddDetail::sys_seq = [%d]\n",iSysSeq));

#if 0
/* user_seq */
			iUserSeq = 1;
			PutField_Int(hContext, "user_seq",iUserSeq);
DEBUGLOG(("Authorize() AddDetail::user_seq = [%d]\n", iUserSeq));
#endif

/* disabled */	
			iDisabled = 0;
			PutField_Int(hContext, "disabled",iDisabled);
DEBUGLOG(("Authorize() AddDetail::disabled = [%d]\n",iDisabled));

/* skip */
        		if (GetField_CString(hRequest, "skip", &csTmp)) {
                		iTmp = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::skip = [%d]\n", iTmp));
                		PutField_Int(hContext, "skip",iTmp);
        		}

/* mask_skip */
        		if (GetField_CString(hRequest, "mask_skip", &csTmp)) {
                		iTmp = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::mask_skip = [%d]\n", iTmp));
                		PutField_Int(hContext, "mask_skip",iTmp);
        		}

/* int_bank_code */
        		if (GetField_CString(hRequest, "int_bank_code", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::int_bank_code = [%s]\n", csTmp));
                		PutField_CString(hContext,"int_bank_code",csTmp);
        		}

/* bank_acct_num */
        		if (GetField_CString(hRequest, "bank_acct_num", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::bank_acct_num = [%s]\n", csTmp));
                		PutField_CString(hContext,"bank_acct_num",csTmp);
        		}

/* raw_date */
        		if (GetField_CString(hRequest, "raw_date", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::raw_date = [%s]\n", csTmp));
                		PutField_CString(hContext,"raw_date",csTmp);
        		}

/* raw_time */
        		if (GetField_CString(hRequest, "raw_time", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::raw_time = [%s]\n", csTmp));
                		PutField_CString(hContext,"raw_time",csTmp);
        		}

/* statement_date */
        		if (GetField_CString(hRequest, "statement_date", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::statement_date = [%s]\n", csTmp));
         		       PutField_CString(hContext,"statement_date",csTmp);
        		}

/* statement_time */
        		if (GetField_CString(hRequest, "statement_time", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::statement_time = [%s]\n", csTmp));
               			PutField_CString(hContext,"statement_time",csTmp);
        		}

/* tfr_bank_name */
        		if (GetField_CString(hRequest, "tfr_bank_name", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_bank_name = [%s]\n", csTmp));
                		PutField_CString(hContext,"tfr_bank_name",csTmp);
        		}

/* tfr_bank_acct_num */
        		if (GetField_CString(hRequest, "tfr_bank_acct_num", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_bank_acct_num = [%s]\n", csTmp));
                		PutField_CString(hContext,"tfr_bank_acct_num",csTmp);
        		}

/* tfr_type */
        		if (GetField_CString(hRequest, "tfr_type", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_type = [%s]\n", csTmp));
                		PutField_CString(hContext,"tfr_type",csTmp);
        		}

/* tfr_channel */
        		if (GetField_CString(hRequest, "tfr_channel", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_channel = [%s]\n", csTmp));
                		PutField_CString(hContext,"tfr_channel",csTmp);
        		}

/* tft_text */
        		if (GetField_CString(hRequest, "tfr_text", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_text = [%s]\n", csTmp));
                		PutField_CString(hContext,"tfr_text",csTmp);
        		}

/* tfr_customer_test */
        		if (GetField_CString(hRequest, "tfr_customer_text", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_customer_text = [%s]\n",csTmp));
                		PutField_CString(hContext,"tfr_customer_text",csTmp);
       	 		}

/* sender_name */
        		if (GetField_CString(hRequest, "sender_name", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::sender_name = [%s]\n",csTmp));
                		PutField_CString(hContext,"sender_name",csTmp);
        		}

/* txn_ref_num */
        		if (GetField_CString(hRequest, "txn_ref_num", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::txn_ref_num = [%s]\n",csTmp));
                		PutField_CString(hContext,"txn_ref_num",csTmp);
        		}

/* balance */
        		if (GetField_CString(hRequest, "balance", &csTmp)) {
                		dTmp = atof(csTmp);
DEBUGLOG(("Authorize() AddDetail::balance = [%.2f]\n",dTmp));
                		//PutField_Double(hContext,"balance",dTmp);
                		PutField_CString(hContext,"balance",csTmp);
                	}

/* amt_type */
        		if (GetField_CString(hRequest, "amt_type", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::amt_type = [%s]\n",csTmp));
                		PutField_CString(hContext,"amt_type",csTmp);
        		}

/* txn_amount */
        		if (GetField_CString(hRequest, "txn_amount", &csTmp)) {
                		dTmp = atof(csTmp);
DEBUGLOG(("Authorize() AddDetail::txn_amount = [%.2f]\n",dTmp));
				//PutField_Double(hContext,"txn_amount",dTmp);
                		PutField_CString(hContext,"txn_amount",csTmp);
        		}

/* bank_charge */
        		if (GetField_CString(hRequest, "bank_charge", &csTmp)) {
                		dTmp = atof(csTmp);
DEBUGLOG(("Authorize() AddDetail::bank_charge = [%.2f]\n",dTmp));
				//PutField_Double(hContext,"bank_charge",dTmp);
                		PutField_CString(hContext,"bank_charge",csTmp);
       		 	}

DEBUGLOG(("Authorize() call DBOLStatementTmp::Add()\n"));
                       	DBObjPtr = CreateObj(DBPtr, "DBOLStatementTmp", "AddDetail");
                       	iRet = (unsigned long)(*DBObjPtr)(hContext);
                       	if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatementTmp::Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: AddDetail() FAILURE!!!\n");
			}
		
/* Add Statement Header */

			if (iRet == PD_OK) {

/* file_id*/
                        	PutField_CString(hRecHeaderPut,"file_id",csFileId);
DEBUGLOG(("Authorize() AddHeader::file_id = [%s]\n",csFileId));


                        	snprintf(csFileName,sizeof(csFileName),"SF%s",csFileId);
/* new_file_name */
                        	PutField_CString(hRecHeaderPut,"new_file_name",csFileName);
DEBUGLOG(("Authorize() AddHeader::new_file_name = [%s]\n",csFileName));

/* in_file_name */
                        	PutField_CString(hRecHeaderPut,"in_file_name",csFileName);
DEBUGLOG(("Authorize() AddHeader::in_file_name = [%s]\n",csFileName));

/* skip_count */	
                        	iSkipCount = 0;
                        	PutField_Int(hRecHeaderPut,"skip_count",iSkipCount);
DEBUGLOG(("Authorize() AddHeader::skip_count = [%d]\n", iSkipCount));

#if 0
/* hold_count */
				iHoldCount = 0;
                        	PutField_Int(hRecHeaderPut,"hold_count",iHoldCount);
DEBUGLOG(("Authorize() AddHeader::hold_count = [%d]\n",iHoldCount));
#endif

/* accept_count */
                        	iAcceptCount = 1;
                        	PutField_Int(hRecHeaderPut,"accept_count",iAcceptCount);
DEBUGLOG(("Authorize() AddHeader::accept_count = [%d]\n", iAcceptCount));

/* total_count */
                        	iTotalCount = iSkipCount + iAcceptCount;
                       	 	PutField_Int(hRecHeaderPut,"total_count",iTotalCount);
DEBUGLOG(("Authorize() AddHeader::total_count = [%d]\n", iTotalCount));

/* message_code */
				iTmp = 0;
                        	PutField_Int(hRecHeaderPut,"message_code",iTmp);
DEBUGLOG(("Authorize() AddHeader::message_code = [%d]\n", iTmp));

/* format_id */
				sprintf(csTag,"086306_1");
                        	PutField_CString(hRecHeaderPut,"format_id",csTag);
DEBUGLOG(("Authorize() AddHeader::format_id = [%s]\n",csTag));

/* ver */
				if (iVer > iHeaderVer) {
                        		PutField_Int(hRecHeaderPut,"ver",iVer);
DEBUGLOG(("Authorize() AddHeader::ver = [%d]\n",iVer));
				} else {
                        		PutField_Int(hRecHeaderPut,"ver",iHeaderVer);
DEBUGLOG(("Authorize() AddHeader::ver = [%d]\n",iHeaderVer));
				}

/* status */
				cTmp = PD_STMT_APPROVED;	
                        	PutField_Char(hRecHeaderPut,"status",cTmp);
DEBUGLOG(("Authorize() AddHeader::status = [%c]\n", cTmp));

#if 0
/* split_count */
				iSplitCount = 0;
                        	PutField_Int(hRecHeaderPut,"split_count",iSplitCount);
DEBUGLOG(("Authorize() AddHeader::split_count = [%d]\n",iSplitCount));
#endif

/* add_count */
				iAddCount = 1;
                        	PutField_Int(hRecHeaderPut,"add_count",iAddCount);
DEBUGLOG(("Authorize() AddHeader::add_count = [%d]\n", iAddCount));

#if 0
/* update_count */
				iUpdateCount = 0;
                        	PutField_Int(hRecHeaderPut,"update_count",iUpdateCount);
DEBUGLOG(("Authorize() AddHeader::update_count = [%d]\n",iUpdateCount));

/* delete_count */
				iDeleteCount = 0;
                        	PutField_Int(hRecHeaderPut,"delete_count",iDeleteCount);
DEBUGLOG(("Authorize() AddHeader::delete_count = [%d]\n",iDeleteCount));
#endif

/* file_count */
				iFileCount = 1;
                        	PutField_Int(hRecHeaderPut,"file_count",iFileCount);
DEBUGLOG(("Authorize() AddHeader::file_count = [%d]\n", iFileCount));

/* create_user */
                        	PutField_CString(hRecHeaderPut,"create_user",csUser);
DEBUGLOG(("Authorize() AddHeader::create_user = [%s]\n", csUser));

/* int_bank_code */
                        	if (GetField_CString(hRequest, "int_bank_code", &csTmp)) {
DEBUGLOG(("Authorize() AddHeader::int_bank_code = [%s]\n", csTmp));
                                	PutField_CString(hRecHeaderPut,"int_bank_code",csTmp);
                        	}

/* bank_acct_num */
                        	if (GetField_CString(hRequest, "bank_acct_num", &csTmp)) {
DEBUGLOG(("Authorize() AddHeader::bank_acct_num = [%s]\n", csTmp));
                         	       PutField_CString(hRecHeaderPut,"bank_acct_num",csTmp);
                        	}

/* baid */
                        	if (GetField_CString(hRequest, "baid", &csTmp)) {
DEBUGLOG(("Authorize() AddHeader::baid = [%s]\n", csTmp));
                        	        PutField_CString(hRecHeaderPut,"baid",csTmp);
                        	}

DEBUGLOG(("Authorize() call DBOLStatement:: AddHeader()\n"));
                        	DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "AddHeader");
                        	iRet =	(unsigned long)(*DBObjPtr)(hRecHeaderPut);
				if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatement:: AddHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatement:: AddHeader() FAILURE!!!\n");
                        	}

			}
		}
	}

	else if ((iRet == PD_OK) && (cAction == PD_ACTION_UPDATE)) { 
DEBUGLOG(("Authorize()::CAction()::Update\n"));

/* Check File Exist */
DEBUGLOG(("Authorize() call DBOLStatement::CheckFileExist()\n"));
                snprintf(csFileName,sizeof(csFileName),"SF%s",csFileId);
DEBUGLOG(("Authorize() call DBOLTxnSeq::file_name = [%s]\n",csFileName));
                DBObjPtr = CreateObj(DBPtr,"DBOLStatement","CheckFileExist");
                if ((unsigned long)(*DBObjPtr)(csFileName) == FOUND) {
DEBUGLOG(("Authorize() call DBOLStatement::File Exist()!!! \n"));
		
/* Get Statement Tmp (Latest Ver Record) Detail */

/* seq */
                        if (GetField_CString(hRequest, "seq", &csTmp)) {
                                iSeq = atoi(csTmp);
DEBUGLOG(("Authorize() seq = [%d]\n", iSeq));
                                PutField_Int(hContext,"seq",iSeq);
                        } else {

                                iRet = INT_STATEMENT_SEQ_NOT_FOUND;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: seq not found!!\n"));
ERRLOG("TxnOmtByUsSCU:: Authorize:: seq not found!!\n");
                      	}

/* ver */
                        if (GetField_CString(hRequest, "ver", &csTmp)) {
                                iVer = atoi(csTmp);
DEBUGLOG(("Authorize() ver = [%d]\n", iVer));
                                PutField_Int(hContext, "ver",iVer);
                        } else {
                                iRet = INT_STATEMENT_VER_NOT_FOUND;
                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: ver not found!!\n"));
ERRLOG("TnOmtByUsBSE:: Authorize:: ver not found!!\n");
                        }

			if (iRet == PD_OK) {

                                DBObjPtr = CreateObj(DBPtr,"DBOLStatementTmp","GetLatestVerRecDetail");
                                iRet = (unsigned long)(*DBObjPtr)(csFileId,iSeq,hRecDetailGet);
DEBUGLOG(("Authorize() GetLatestVerRecDetail::iRet = [%d]\n",iRet));
                                if (iRet == PD_OK) {

#if 0
/* seq */
                                        if (GetField_Int(hRecDetailGet,"seq",&iSeq)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::seq = [%d]\n",iSeq));
                                        }
#endif

/* ver */
                                        if (GetField_Int(hRecDetailGet,"ver",&iTmp)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::ver = [%d]\n",iTmp));
                                        }

/* latest_ver */
                                        if (GetField_Int(hRecDetailGet,"latest_ver",&iLatestVer)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::latest_ver = [%d]\n",iLatestVer));
                                        }

/* org_sys_seq */
                                        if (GetField_Int(hRecDetailGet,"org_sys_seq",&iOrgSysSeq)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::org_sys_seq = [%d]\n",iOrgSysSeq));
                                        }

/* sys_seq */
                                        if (GetField_Int(hRecDetailGet,"sys_seq",&iSysSeq)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::sys_seq = [%d]\n",iSysSeq));
                                        }

#if 0
/* user_seq */
                                        if (GetField_Int(hRecDetailGet,"user_seq",&iUserSeq)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::user_seq = [%d]\n",iUserSeq));
                                        }
#endif

#if 0
/* skip */
                                        if (GetField_Int(hRecDetailGet,"skip",&iSkip)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::skip = [%d]\n",iSkip));
                                        }

/* mask_skip */
                                        if (GetField_Int(hRecDetailGet,"mask_skip",&iMaskSkip)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::mask_skip = [%d]\n",iMaskSkip));
                                        }
#endif

                                } else {
                                        iRet = INT_ERR;
DEBUGLOG(("Authorize:: GetLatestVerRecDetail:: failed\n"));
ERRLOG("Authorize::ValidateProcess::GetLatestVerRecDetail:: failed!!\n");
                                }
			}

/* Check Ver */ 
			if (iVer <= iTmp) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize:: CheckRecVer:: ver <= rec_ver \n"));
			}

/* Update Statement Tmp Detail */
			if (iRet == PD_OK) {

/* file_id */
                                PutField_CString(hRecDetailPut,"file_id",csFileId);
DEBUGLOG(("Authorize() UpdateRecDetail::file_id = [%s]\n",csFileId));

/* seq */
                                PutField_Int(hRecDetailPut, "seq",iSeq);
DEBUGLOG(("Authorize() UpdateRecDetail::seq = [%d]\n",iSeq));

/* ver */
                                PutField_Int(hRecDetailPut, "ver",iVer);
DEBUGLOG(("Authorize() UpdateRecDetail::ver = [%d]\n",iVer));

/* latest_ver */
                                PutField_Int(hRecDetailPut, "latest_ver",iLatestVer);
DEBUGLOG(("Authorize() UpdateRecDetail::latest_ver = [%d]\n",iLatestVer));

/* org_sys_seq */
                                PutField_Int(hRecDetailPut, "org_sys_seq",iOrgSysSeq);
DEBUGLOG(("Authorize() UpdateRecDetail::org_sys_seq = [%d]\n",iOrgSysSeq));

/* sys_seq */
                                PutField_Int(hRecDetailPut, "sys_seq",iSysSeq);
DEBUGLOG(("Authorize() UpdateRecDetail::sys_seq = [%d]\n",iSysSeq));

#if 0
/* user_seq */
				PutField_Int(hRecDetailPut, "user_seq",iUserSeq);
DEBUGLOG(("Authorize() UpdateRecDetail::user_seq = [%d]\n",iUserSeq));				
#endif

#if 0
/* skip */
                                PutField_Int(hRecDetailPut, "skip",iSkip);
DEBUGLOG(("Authorize() UpdateRecDetail::skip = [%d]\n",iSkip));

/* mask_skip */
                                PutField_Int(hRecDetailPut, "mask_skip",iMaskSkip);
DEBUGLOG(("Authorize() UpdateRecDetail::mask_skip = [%d]\n",iMaskSkip));

/* statement_date */
                                PutField_CString(hRecDetailPut,"statement_date",csStatementDate);
DEBUGLOG(("Authorize() UpdateRecDetail::statement_date = [%s]\n",csStatementDate));

/* statement_time */
                                PutField_CString(hRecDetailPut,"statement_time",csStatementTime);
DEBUGLOG(("Authorize() UpdateRecDetail::statement_time = [%s]\n",csStatementTime));
#endif

/* update_user */
                                PutField_CString(hRecDetailPut,"update_user",csUser);
DEBUGLOG(("Authorize() UpdateRecDetail::update_user = [%s]\n",csUser));

DEBUGLOG(("Authorize() call DBOLStatementTmp::Update()\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBOLStatementTmp", "UpdateRecDetail");
                                iRet = (unsigned long)(*DBObjPtr)(hRecDetailPut);
                                if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatementTmp::Update() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: UpdateRecDetail() FAILURE!!!\n");
                                }
                        }

/* Add Statement Tmp Detail */
                        if (iRet == PD_OK) {

/* file_id */
                                PutField_CString(hContext,"file_id",csFileId);
DEBUGLOG(("Authorize() AddDetail::file_id = [%s]\n",csFileId));

/* seq */
                                PutField_Int(hContext, "seq",iSeq);
DEBUGLOG(("Authorize() AddDetail::seq = [%d]\n",iSeq));

/* ver */
                                PutField_Int(hContext, "ver",iVer);
DEBUGLOG(("Authorize() AddDetail::ver = [%d]\n",iVer));

#if 0
/* latest_ver */
				iLatestVer = 0;
                                PutField_Int(hContext, "latest_ver",iLatest_Ver);
DEBUGLOG(("Authorize() AddDetail::latest_ver = [%d]\n",iLatestVer));
#endif

/* org_sys_seq */
                                PutField_Int(hContext, "org_sys_seq",iOrgSysSeq);
DEBUGLOG(("Authorize() AddDetail::org_sys_seq = [%d]\n",iOrgSysSeq));

/* sys_seq */
                                PutField_Int(hContext, "sys_seq",iSysSeq);
DEBUGLOG(("Authorize() AddDetail::sys_seq = [%d]\n",iSysSeq));

#if 0
/* user_seq */
				PutField_Int(hContext, "user_seq",iUserSeq);
DEBUGLOG(("Authorize() AddDetail::user_seq = [%d]\n",iUserSeq));
#endif

/* disabled */
				iDisabled = 0;
                                PutField_Int(hContext, "disabled",iDisabled);
DEBUGLOG(("Authorize() AddDetail::disabled = [%d]\n",iDisabled));

/* skip */
                                if (GetField_CString(hRequest, "skip", &csTmp)) {
                                        iTmp = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::skip = [%d]\n", iTmp));
                                        PutField_Int(hContext, "skip",iTmp);
                                }

/* mask_skip */
                                if (GetField_CString(hRequest, "mask_skip", &csTmp)) {
                                        iTmp = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::mask_skip = [%d]\n", iTmp));
                                        PutField_Int(hContext, "mask_skip",iTmp);
                                }

/* int_bank_code */
                                if (GetField_CString(hRequest, "int_bank_code", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::int_bank_code = [%s]\n", csTmp));
                                        PutField_CString(hContext,"int_bank_code",csTmp);
                                }

/* bank_acct_num */
                                if (GetField_CString(hRequest, "bank_acct_num", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::bank_acct_num = [%s]\n", csTmp));
                                        PutField_CString(hContext,"bank_acct_num",csTmp);
                                }

/* raw_date */
                                if (GetField_CString(hRequest, "raw_date", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::raw_date = [%s]\n", csTmp));
                                        PutField_CString(hContext,"raw_date",csTmp);
                                }

/* raw_time */
                                if (GetField_CString(hRequest, "raw_time", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::raw_time = [%s]\n", csTmp));
                                        PutField_CString(hContext,"raw_time",csTmp);
                                }

/* statement_date */
                                if (GetField_CString(hRequest, "statement_date", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::statement_date = [%s]\n", csTmp));
                                        PutField_CString(hContext,"statement_date",csTmp);
                                }

/* statement_time */
                                if (GetField_CString(hRequest, "statement_time", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::statement_time = [%s]\n", csTmp));
                                        PutField_CString(hContext,"statement_time",csTmp);
                                }

/* tfr_bank_name */
                                if (GetField_CString(hRequest, "tfr_bank_name", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_bank_name = [%s]\n", csTmp));
                                        PutField_CString(hContext,"tfr_bank_name",csTmp);
                                }

/* tfr_bank_acct_num */
                                if (GetField_CString(hRequest, "tfr_bank_acct_num", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_bank_acct_num = [%s]\n", csTmp));
                                        PutField_CString(hContext,"tfr_bank_acct_num",csTmp);
                                }

/* tfr_type */
                                if (GetField_CString(hRequest, "tfr_type", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_type = [%s]\n", csTmp));
                                        PutField_CString(hContext,"tfr_type",csTmp);
                                }

/* tfr_channel */
                                if (GetField_CString(hRequest, "tfr_channel", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_channel = [%s]\n", csTmp));
                                        PutField_CString(hContext,"tfr_channel",csTmp);
                                }

/* tft_text */
                                if (GetField_CString(hRequest, "tfr_text", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_text = [%s]\n", csTmp));
                                        PutField_CString(hContext,"tfr_text",csTmp);
                                }

/* tfr_customer_test */
                                if (GetField_CString(hRequest, "tfr_customer_text", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_customer_text = [%s]\n",csTmp));
                                        PutField_CString(hContext,"tfr_customer_text",csTmp);
                                }

/* sender_name */
                                if (GetField_CString(hRequest, "sender_name", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::sender_name = [%s]\n",csTmp));
                                        PutField_CString(hContext,"sender_name",csTmp);
                                }

/* txn_ref_num */
                                if (GetField_CString(hRequest, "txn_ref_num", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::txn_ref_num = [%s]\n",csTmp));
                                        PutField_CString(hContext,"txn_ref_num",csTmp);
                                }

/* balance */
                                if (GetField_CString(hRequest, "balance", &csTmp)) {
                                        dTmp = atof(csTmp);
DEBUGLOG(("Authorize() AddDetail::balance = [%.2f]\n",dTmp));
					//PutField_Double(hContext,"balance",dTmp);
					PutField_CString(hContext,"balance",csTmp);
				}

/* amt_type */
                                if (GetField_CString(hRequest, "amt_type", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::amt_type = [%s]\n",csTmp));
                                        PutField_CString(hContext,"amt_type",csTmp);
                                }

/* txn_amount */
                                if (GetField_CString(hRequest, "txn_amount", &csTmp)) {
                                        dTmp = atof(csTmp);
DEBUGLOG(("Authorize() AddDetail::txn_amount = [%.2f]\n",dTmp));
					//PutField_Double(hContext,"txn_amount",dTmp);
					PutField_CString(hContext,"txn_amount",csTmp);
				}

/* bank_charge */
				if (GetField_CString(hRequest, "bank_charge", &csTmp)) {
                                        dTmp = atof(csTmp);
DEBUGLOG(("Authorize() AddDetail::bank_charge = [%.2f]\n",dTmp));
					//PutField_Double(hContext,"bank_charge",dTmp);
					PutField_CString(hContext,"bank_charge",csTmp);
				}

DEBUGLOG(("Authorize() call DBOLStatementTmp::Add()\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBOLStatementTmp", "AddDetail");
                                iRet = (unsigned long)(*DBObjPtr)(hContext);
                                if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatementTmp::Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: AddDetail() FAILURE!!!\n");
                                }
                        }

/* Get Statement Header */
			if (iRet == PD_OK) {

                                DBObjPtr = CreateObj(DBPtr,"DBOLStatement","GetHeader");
                                iRet = (unsigned long)(*DBObjPtr)(csFileId,hRecHeaderGet);
DEBUGLOG(("Authorize() GetHeader::iRet = [%d]\n",iRet));
                                if (iRet == PD_OK) {

/* skip_count */
                                        if (GetField_Int(hRecHeaderGet,"skip_count",&iSkipCount)) {
DEBUGLOG(("Authorize() GetHeader::skip_count = [%d]\n",iSkipCount));
                                        }

/* hold_count */
                                        if (GetField_Int(hRecHeaderGet,"hold_count",&iHoldCount)) {
DEBUGLOG(("Authorize() GetHeader::hold_count = [%d]\n",iHoldCount));
                                        }

/* accept_count */
                                        if (GetField_Int(hRecHeaderGet,"accept_count",&iAcceptCount)) {
DEBUGLOG(("Authorize() GetHeader::accept_count = [%d]\n",iAcceptCount));
                                        }

/* total_count */
                                        if (GetField_Int(hRecHeaderGet,"total_count",&iTotalCount)) {
DEBUGLOG(("Authorize() GetHeader::total_count = [%d]\n",iTotalCount));
                                        }

/* ver */
                                        if (GetField_Int(hRecHeaderGet,"ver",&iHeaderVer)) {
DEBUGLOG(("Authorize() GetHeader::ver = [%d]\n",iHeaderVer));
                                        }

/* split_count */
                                        if (GetField_Int(hRecHeaderGet,"split_count",&iSplitCount)) {
DEBUGLOG(("Authorize() GetHeader::split_count = [%d]\n",iSplitCount));
                                        }

/* add_count */
                                        if (GetField_Int(hRecHeaderGet,"add_count",&iAddCount)) {
DEBUGLOG(("Authorize() GetHeader::add_count = [%d]\n",iAddCount));
                                        }

/* update_count */
                                        if (GetField_Int(hRecHeaderGet,"update_count",&iUpdateCount)) {
DEBUGLOG(("Authorize() GetHeader::update_count = [%d]\n",iUpdateCount));
                                        }

/* delete_count */
                                        if (GetField_Int(hRecHeaderGet,"delete_count",&iDeleteCount)) {
DEBUGLOG(("Authorize() GetHeader::delete_count = [%d]\n",iDeleteCount));
                                        }

/* file_count */
                                        if (GetField_Int(hRecHeaderGet,"file_count",&iFileCount)) {
DEBUGLOG(("Authorize() GetHeader::file_count = [%d]\n",iFileCount));
                                        }
                                }
                                else {
                                        iRet = INT_ERR;
DEBUGLOG(("Authorize:: GetHeader:: failed\n"));
ERRLOG("Authorize::ValidateProcess::GetHeader:: failed!!\n");
                                }
                        }

/* Update Statement Header */
                        if (iRet == PD_OK) {

/* file_id */
                                PutField_CString(hRecHeaderPut,"file_id",csFileId);
DEBUGLOG(("Authorize() AddHeader::file_cid = [%s]\n",csFileId));

/* skip_count */
                                PutField_Int(hRecHeaderPut, "skip_count",iSkipCount);
DEBUGLOG(("Authorize() AddHeader::skip_count = [%d]\n",iSkipCount));

/* hold_count */
                                PutField_Int(hRecHeaderPut, "hold_count",iHoldCount);
DEBUGLOG(("Authorize() AddHeader::hold_count = [%d]\n",iHoldCount));

/* accept_count */
                                PutField_Int(hRecHeaderPut, "accept_count",++iAcceptCount);
DEBUGLOG(("Authorize() AddHeader::accept_count = [%d]\n",iAcceptCount));

/* total_count */
                                PutField_Int(hRecHeaderPut, "total_count",++iTotalCount);
DEBUGLOG(("Authorize() AddHeader::total_count = [%d]\n",iTotalCount));

/* ver */
				if (iVer > iHeaderVer)
				{
                                	PutField_Int(hRecHeaderPut, "ver",iVer);
DEBUGLOG(("Authorize() AddHeader::ver = [%d]\n",iVer));
				} else {
                                	PutField_Int(hRecHeaderPut, "ver",iHeaderVer);
DEBUGLOG(("Authorize() AddHeader::ver = [%d]\n",iHeaderVer));
				}
	
/* split_count */
                                PutField_Int(hRecHeaderPut, "split_count",iSplitCount);
DEBUGLOG(("Authorize() AddHeader::split_count = [%d]\n",iSplitCount));

/* add_count */
                                PutField_Int(hRecHeaderPut, "add_count",iAddCount);
DEBUGLOG(("Authorize() AddHeader::add_count = [%d]\n",iAddCount));

/* update_count */
                                PutField_Int(hRecHeaderPut, "update_count",++iUpdateCount);
DEBUGLOG(("Authorize() AddHeader::update_count = [%d]\n",iUpdateCount));

/* delete_count */
                                PutField_Int(hRecHeaderPut, "delete_count",iDeleteCount);
DEBUGLOG(("Authorize() AddHeader::delete_count = [%d]\n",iDeleteCount));

/* file_count */
                                PutField_Int(hRecHeaderPut, "file_count",++iFileCount);
DEBUGLOG(("Authorize() AddHeader::file_count = [%d]\n",iFileCount));

/* update_user */
                                PutField_CString(hRecHeaderPut,"update_user",csUser);
DEBUGLOG(("Authorize() AddHeader::update_user = [%s]\n",csUser));

DEBUGLOG(("Authorize() call DBOLStatement::UpdateHeader()\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "UpdateHeader");
                                iRet = (unsigned long)(*DBObjPtr)(hRecHeaderPut);
                                if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatement::UpdateHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatement:: UpdateHeader() FAILURE!!!\n");
                                }
                        }
		}
                else {
                        iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement::File Not Exist()!!! \n"));
ERRLOG("Authorize::ValidateProcess::CheckFileExist:: failed!!\n");
                }	
	}
	else if ((iRet == PD_OK) && (cAction == PD_ACTION_DELETE)) { 	
DEBUGLOG(("Authorize()::CAction()::Delete\n"));

/* Check File Exist */
DEBUGLOG(("Authorize() call DBOLStatement::CheckFileExist()\n"));
                snprintf(csFileName,sizeof(csFileName),"SF%s",csFileId);
DEBUGLOG(("Authorize() call DBOLTxnSeq::file_name = [%s]\n",csFileName));
                DBObjPtr = CreateObj(DBPtr,"DBOLStatement","CheckFileExist"); 
		if ((unsigned long)(*DBObjPtr)(csFileName) == FOUND) {
DEBUGLOG(("Authorize() call DBOLStatement::File Exist()!!! \n"));

/* Get Statement Tmp (Latest Ver Record) Detail */

/* seq */
			if (GetField_CString(hRequest, "seq", &csTmp)) {
                		iSeq = atoi(csTmp);
DEBUGLOG(("Authorize() seq = [%d]\n", iSeq));
                		PutField_Int(hContext,"seq",iSeq);
       	 		} else {
				iRet = INT_STATEMENT_SEQ_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: seq not found!!\n"));
ERRLOG("TxnOmtByUsSCU:: Authorize:: seq not found!!\n");
        		}

/* ver */
			if (GetField_CString(hRequest, "ver", &csTmp)) {
                		iVer = atoi(csTmp);
DEBUGLOG(("Authorize() ver = [%d]\n", iVer));
                		PutField_Int(hContext, "ver",iVer);
        		} else {
				iRet = INT_STATEMENT_VER_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize:: ver not found!!\n"));
ERRLOG("TnOmtByUsBSE:: Authorize:: ver not found!!\n");
       	 		}

			if (iRet == PD_OK) {
              			DBObjPtr = CreateObj(DBPtr,"DBOLStatementTmp","GetLatestVerRecDetail");
                   		iRet = (unsigned long)(*DBObjPtr)(csFileId,iSeq,hRecDetailGet);
DEBUGLOG(("Authorize() GetLatestVerRecDetail::iRet = [%d]\n",iRet));
                        	if (iRet == PD_OK) {

/* disabled */
					if (GetField_Int(hRecDetailGet,"disabled",&iDisabled)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::disabled = [%d]\n",iDisabled));
                               		}

#if 0
/* seq */
					if (GetField_Int(hRecDetailGet,"seq",&iSeq)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::seq = [%d]\n",iSeq));
                               		}
#endif

/* ver */
                             		if (GetField_Int(hRecDetailGet,"ver",&iTmp)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::ver = [%d]\n",iTmp));
                            		}

/* latest_ver */
                             		if (GetField_Int(hRecDetailGet,"latest_ver",&iLatestVer)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::latest_ver = [%d]\n",iLatestVer));
                              		}

/* org_sys_seq */
                             		if (GetField_Int(hRecDetailGet,"org_sys_seq",&iOrgSysSeq)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::org_sys_seq = [%d]\n",iOrgSysSeq));
                           		}

/* sys_seq */
                             		if (GetField_Int(hRecDetailGet,"sys_seq",&iSysSeq)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::sys_seq = [%d]\n",iSysSeq));
                            		}

#if 0
/* user_seq */
                              		if (GetField_Int(hRecDetailGet,"user_seq",&iUserSeq)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::user_seq = [%d]\n",iUserSeq));
                               		}
#endif

#if 0
/* skip */
                              		if (GetField_Int(hRecDetailGet,"skip",&iSkip)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::skip = [%d]\n",iSkip));
                                	}

/* mask_skip */
                            		if (GetField_Int(hRecDetailGet,"mask_skip",&iMaskSkip)) {
DEBUGLOG(("Authorize() GetLatestVerRecDetail::mask_skip = [%d]\n",iMaskSkip));
                               		}
#endif

                        	}
                        	else {
                                	iRet = INT_ERR;
DEBUGLOG(("Authorize:: GetLatestVerRecDetail:: failed\n"));
ERRLOG("Authorize::ValidateProcess::GetLatestVerRecDetail:: failed!!\n");
                        	}
			}

/* Check Disabled and Ver */ 
			if (iDisabled == 1) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize:: CheckRecDisabled:: disabled = [%d]\n", iDisabled));
			} else if (iVer <= iTmp) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize:: CheckRecVer:: ver <= rec_ver \n"));
			}

/* Update Statement Tmp Detail */ 
             		if (iRet == PD_OK) {

/* file_id */     
	        		PutField_CString(hRecDetailPut,"file_id",csFileId);
DEBUGLOG(("Authorize() UpdateRecDetail::file_id = [%s]\n",csFileId));
             
/* seq */
                       	 	PutField_Int(hRecDetailPut, "seq",iSeq);
DEBUGLOG(("Authorize() UpdateRecDetail::seq = [%d]\n",iSeq));

/* ver */
		       		PutField_Int(hRecDetailPut, "ver",iVer);
DEBUGLOG(("Authorize() UpdateRecDetail::ver = [%d]\n",iVer));

/* latest_ver */
                      		PutField_Int(hRecDetailPut, "latest_ver",iLatestVer);
DEBUGLOG(("Authorize() UpdateRecDetail::latest_ver = [%d]\n",iLatestVer));
        
/* org_sys_seq */
	              		PutField_Int(hRecDetailPut, "org_sys_seq",iOrgSysSeq);
DEBUGLOG(("Authorize() UpdateRecDetail::org_sys_seq = [%d]\n",iOrgSysSeq));
         
/* sys_seq */	
	              		PutField_Int(hRecDetailPut, "sys_seq",iSysSeq);
DEBUGLOG(("Authorize() UpdateRecDetail::sys_seq = [%d]\n",iSysSeq));

#if 0	
/* user_seq */	
				PutField_Int(hRecDetailPut, "user_seq",iUserSeq);
DEBUGLOG(("Authorize() UpdateRecDetail::user_seq = [%d]\n",iUserSeq));
#endif

#if 0
/* skip */
                                PutField_Int(hRecDetailPut, "skip",iSkip);
DEBUGLOG(("Authorize() UpdateRecDetail::skip = [%d]\n",iSkip));

/* mask_skip */
                                PutField_Int(hRecDetailPut, "mask_skip",iMaskSkip);
DEBUGLOG(("Authorize() UpdateRecDetail::mask_skip = [%d]\n",iMaskSkip));

/* statement_date */
                                PutField_CString(hRecDetailPut,"statement_date",csStatementDate);
DEBUGLOG(("Authorize() UpdateRecDetail::statement_date = [%s]\n",csStatementDate));

/* statement_time */
                                PutField_CString(hRecDetailPut,"statement_time",csStatementTime);
DEBUGLOG(("Authorize() UpdateRecDetail::statement_time = [%s]\n",csStatementTime));
#endif

/* update_user */
                                PutField_CString(hRecDetailPut,"update_user",csUser);
DEBUGLOG(("Authorize() UpdateRecDetail::update_user = [%s]\n",csUser));

DEBUGLOG(("Authorize() call DBOLStatementTmp::Update()\n"));
                     		DBObjPtr = CreateObj(DBPtr, "DBOLStatementTmp", "UpdateRecDetail");
                     		iRet = (unsigned long)(*DBObjPtr)(hRecDetailPut);
                       		if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatementTmp::Update() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: UpdateRecDetail() FAILURE!!!\n");
                     		}
           		}

/* Add Statement Tmp Detail */
             		if (iRet == PD_OK) {

/* file_id */
                     		PutField_CString(hContext,"file_id",csFileId);
DEBUGLOG(("Authorize() AddDetail::file_id = [%s]\n",csFileId));

/* seq */
                        	PutField_Int(hContext, "seq",iSeq);
DEBUGLOG(("Authorize() AddDetail::seq = [%d]\n",iSeq));
             
/* ver */
		       		PutField_Int(hContext, "ver",iVer);
DEBUGLOG(("Authorize() AddDetail::ver = [%d]\n",iVer));
         
#if 0
/* latest_ver */
				iLatestVer = 0;
	             		PutField_Int(hContext, "latest_ver",iLatestVer);
DEBUGLOG(("Authorize() AddDetail::latest_ver = [%d]\n",iLatestVer));
#endif     
           
/* org_sys_seq */
	             		PutField_Int(hContext, "org_sys_seq",iOrgSysSeq);
DEBUGLOG(("Authorize() AddDetail::org_sys_seq = [%d]\n",iOrgSysSeq));
                 
/* sys_seq */
		      		PutField_Int(hContext, "sys_seq",iSysSeq);
DEBUGLOG(("Authorize() AddDetail::sys_seq = [%d]\n",iSysSeq));

#if 0	
/* user_seq */	
				PutField_Int(hContext, "user_seq",iUserSeq);
DEBUGLOG(("Authorize() AddDetail::user_seq = [%d]\n",iUserSeq));
#endif
          
/* disabled */
	         		PutField_Int(hContext, "disabled",1);
DEBUGLOG(("Authorize() AddDetail::disabled = [1]\n"));

/* skip */
                       		if (GetField_CString(hRequest, "skip", &csTmp)) {
                             		iTmp = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::skip = [%d]\n", iTmp));
                          		PutField_Int(hContext, "skip",iTmp);
                     		}

/* mask_skip */
                     		if (GetField_CString(hRequest, "mask_skip", &csTmp)) {
                              		iTmp = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::mask_skip = [%d]\n", iTmp));
                               		PutField_Int(hContext, "mask_skip",iTmp);
                       		}

/* int_bank_code */
                       		if (GetField_CString(hRequest, "int_bank_code", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::int_bank_code = [%s]\n", csTmp));
                             		PutField_CString(hContext,"int_bank_code",csTmp);
                      		}

/* bank_acct_num */
                      		if (GetField_CString(hRequest, "bank_acct_num", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::bank_acct_num = [%s]\n", csTmp));
                        	     	PutField_CString(hContext,"bank_acct_num",csTmp);
                     		}

/* raw_date */
                      		if (GetField_CString(hRequest, "raw_date", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::raw_date = [%s]\n", csTmp));
                              		PutField_CString(hContext,"raw_date",csTmp);
                      		}

/* raw_time */
                       		if (GetField_CString(hRequest, "raw_time", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::raw_time = [%s]\n", csTmp));
                              		PutField_CString(hContext,"raw_time",csTmp);
                      		}

/* statement_date */
                      		if (GetField_CString(hRequest, "statement_date", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::statement_date = [%s]\n", csTmp));
                           		PutField_CString(hContext,"statement_date",csTmp);
                    		}

/* statement_time */
                     		if (GetField_CString(hRequest, "statement_time", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::statement_time = [%s]\n", csTmp));
                        	     	PutField_CString(hContext,"statement_time",csTmp);
                     		}

/* tfr_bank_name */
                		if (GetField_CString(hRequest, "tfr_bank_name", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_bank_name = [%s]\n", csTmp));
                        	    	PutField_CString(hContext,"tfr_bank_name",csTmp);
                      		}

/* tfr_bank_acct_num */
                       		if (GetField_CString(hRequest, "tfr_bank_acct_num", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_bank_acct_num = [%s]\n", csTmp));
                        	     	PutField_CString(hContext,"tfr_bank_acct_num",csTmp);
                      		}

/* tfr_type */
                      		if (GetField_CString(hRequest, "tfr_type", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_type = [%s]\n", csTmp));
                        	    	PutField_CString(hContext,"tfr_type",csTmp);
                      		}

/* tfr_channel */
                     		if (GetField_CString(hRequest, "tfr_channel", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_channel = [%s]\n", csTmp));
                        	   	PutField_CString(hContext,"tfr_channel",csTmp);
                        	}

/* tft_text */
                     		if (GetField_CString(hRequest, "tfr_text", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_text = [%s]\n", csTmp));
                        	    	PutField_CString(hContext,"tfr_text",csTmp);
                     		}

/* tfr_customer_test */
                      		if (GetField_CString(hRequest, "tfr_customer_text", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_customer_text = [%s]\n",csTmp));
                        	     	PutField_CString(hContext,"tfr_customer_text",csTmp);
                       		}

/* sender_name */
                     		if (GetField_CString(hRequest, "sender_name", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::sender_name = [%s]\n",csTmp));
                              		PutField_CString(hContext,"sender_name",csTmp);
                      		}

/* txn_ref_num */
                    		if (GetField_CString(hRequest, "txn_ref_num", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::txn_ref_num = [%s]\n",csTmp));
                        	    	PutField_CString(hContext,"txn_ref_num",csTmp);
                       		}

/* balance */
                       		if (GetField_CString(hRequest, "balance", &csTmp)) {
                        	     	dTmp = atof(csTmp);
DEBUGLOG(("Authorize() AddDetail::balance = [%.2f]\n",dTmp));
					//PutField_Double(hContext,"balance",dTmp);
                               		PutField_CString(hContext,"balance",csTmp);
                      		}

/* amt_type */
                       		if (GetField_CString(hRequest, "amt_type", &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::amt_type = [%s]\n",csTmp));
                        	      	PutField_CString(hContext,"amt_type",csTmp);
                     		}

/* txn_amount */
                       		if (GetField_CString(hRequest, "txn_amount", &csTmp)) {
                       		      	dTmp = atof(csTmp);
DEBUGLOG(("Authorize() AddDetail::txn_amount = [%.2f]\n",dTmp));
					//PutField_Double(hContext,"txn_amount",dTmp);
                        	     	PutField_CString(hContext,"txn_amount",csTmp);
                    		}

/* bank_charge */
                     		if (GetField_CString(hRequest, "bank_charge", &csTmp)) {
                     	        	dTmp = atof(csTmp);
DEBUGLOG(("Authorize() AddDetail::bank_charge = [%.2f]\n",dTmp));
					//PutField_Double(hContext,"bank_charge",dTmp);
                	             	PutField_CString(hContext,"bank_charge",csTmp);
                	     	 }


DEBUGLOG(("Authorize() call DBOLStatementTmp::Add()\n"));
                	     	DBObjPtr = CreateObj(DBPtr, "DBOLStatementTmp", "AddDetail");
                     		iRet = (unsigned long)(*DBObjPtr)(hContext);
                       		if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatementTmp::Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: AddDetail() FAILURE!!!\n");
                     		}
           		}

/* Get Statement Header */
                        if (iRet == PD_OK) {

                       	 	DBObjPtr = CreateObj(DBPtr,"DBOLStatement","GetHeader");
                        	iRet = (unsigned long)(*DBObjPtr)(csFileId,hRecHeaderGet);
DEBUGLOG(("Authorize() GetHeader::iRet = [%d]\n",iRet));
                        	if (iRet == PD_OK) {

/* skip_count */
                                	if (GetField_Int(hRecHeaderGet,"skip_count",&iSkipCount)) {
DEBUGLOG(("Authorize() GetHeader::skip_count = [%d]\n",iSkipCount));
                                	}

/* hold_count */
                                	if (GetField_Int(hRecHeaderGet,"hold_count",&iHoldCount)) {
DEBUGLOG(("Authorize() GetHeader::hold_count = [%d]\n",iHoldCount));
                                	}

/* accept_count */
                                	if (GetField_Int(hRecHeaderGet,"accept_count",&iAcceptCount)) {
DEBUGLOG(("Authorize() GetHeader::accept_count = [%d]\n",iAcceptCount));
                                	}

/* total_count */
                                	if (GetField_Int(hRecHeaderGet,"total_count",&iTotalCount)) {
DEBUGLOG(("Authorize() GetHeader::total_count = [%d]\n",iTotalCount));
                                	}

/* ver */
                                	if (GetField_Int(hRecHeaderGet,"ver",&iHeaderVer)) {
DEBUGLOG(("Authorize() GetHeader::ver = [%d]\n",iHeaderVer));
                                	}

/* split_count */
                                	if (GetField_Int(hRecHeaderGet,"split_count",&iSplitCount)) {
DEBUGLOG(("Authorize() GetHeader::split_count = [%d]\n",iSplitCount));
                                	}

/* add_count */
                                	if (GetField_Int(hRecHeaderGet,"add_count",&iAddCount)) {
DEBUGLOG(("Authorize() GetHeader::add_count = [%d]\n",iAddCount));
                                	}

/* update_count */
                                	if (GetField_Int(hRecHeaderGet,"update_count",&iUpdateCount)) {
DEBUGLOG(("Authorize() GetHeader::update_count = [%d]\n",iUpdateCount));
                                	}

/* delete_count */
                                	if (GetField_Int(hRecHeaderGet,"delete_count",&iDeleteCount)) {
DEBUGLOG(("Authorize() GetHeader::delete_count = [%d]\n",iDeleteCount));
                                	}

/* file_count */
                                	if (GetField_Int(hRecHeaderGet,"file_count",&iFileCount)) {
DEBUGLOG(("Authorize() GetHeader::file_count = [%d]\n",iFileCount));
                                	}
                        	}
                        	else {
                        	        iRet = INT_ERR;
DEBUGLOG(("Authorize:: GetHeader:: failed\n"));
ERRLOG("Authorize::ValidateProcess::GetHeader:: failed!!\n");
                        	}
			}

/* Update Statement Header */
			if (iRet == PD_OK) {

/* file_id */
                     		PutField_CString(hRecHeaderPut,"file_id",csFileId);
DEBUGLOG(("Authorize() AddHeader::file_cid = [%s]\n",csFileId));

/* skip_count */
                     		PutField_Int(hRecHeaderPut, "skip_count",iSkipCount);
DEBUGLOG(("Authorize() AddHeader::skip_count = [%d]\n",iSkipCount));
                       	
/* hold_count */
				PutField_Int(hRecHeaderPut, "hold_count",iHoldCount);
DEBUGLOG(("Authorize() AddHeader::hold_count = [%d]\n",iHoldCount));

/* accept_count */
                       		PutField_Int(hRecHeaderPut, "accept_count",++iAcceptCount);
DEBUGLOG(("Authorize() AddHeader::accept_count = [%d]\n",iAcceptCount));

/* total_count */
                      		PutField_Int(hRecHeaderPut, "total_count",++iTotalCount);
DEBUGLOG(("Authorize() AddHeader::total_count = [%d]\n",iTotalCount));

/* ver */
				if (iVer > iHeaderVer) {
                       			PutField_Int(hRecHeaderPut, "ver",iVer);
DEBUGLOG(("Authorize() AddHeader::ver = [%d]\n,iVer"));
				} else {
                       			PutField_Int(hRecHeaderPut, "ver",iHeaderVer);
DEBUGLOG(("Authorize() AddHeader::ver = [%d]\n,iiHeaderVer"));
				}

/* split_count */
                      		PutField_Int(hRecHeaderPut, "split_count",iSplitCount);
DEBUGLOG(("Authorize() AddHeader::split_count = [%d]\n",iSplitCount));

/* add_count */
                     		PutField_Int(hRecHeaderPut, "add_count",iAddCount);
DEBUGLOG(("Authorize() AddHeader::add_count = [%d]\n",iAddCount));

/* update_count */
                      		PutField_Int(hRecHeaderPut, "update_count",iUpdateCount);
DEBUGLOG(("Authorize() AddHeader::update_count = [%d]\n",iUpdateCount));

/* delete_count */
                      		PutField_Int(hRecHeaderPut, "delete_count",++iDeleteCount);
DEBUGLOG(("Authorize() AddHeader::delete_count = [%d]\n",iDeleteCount));

/* file_count */
                       		PutField_Int(hRecHeaderPut, "file_count",++iFileCount);
DEBUGLOG(("Authorize() AddHeader::file_count = [%d]\n",iFileCount));

/* update_user */
                       	 	PutField_CString(hRecHeaderPut,"update_user",csUser);
DEBUGLOG(("Authorize() AddHeader::update_user = [%s]\n",csUser));

DEBUGLOG(("Authorize() call DBOLStatement::UpdateHeader()\n"));
                      		DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "UpdateHeader");
                    		iRet = (unsigned long)(*DBObjPtr)(hRecHeaderPut);
                       		if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatement::UpdateHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatement:: UpdateHeader() FAILURE!!!\n");
                    		}
               		}
		}
		else {
                        iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement::File Not Exist()!!! \n"));
ERRLOG("Authorize::ValidateProcess::CheckFileExist:: failed!!\n");
                }
	}

	if (iRet != PD_OK) {
		PutField_Int(hContext, "internal_error", iRet);
	}

	FREE_ME(hRecHeaderGet);
	FREE_ME(hRecHeaderPut);
	FREE_ME(hRecDetailGet);
	FREE_ME(hRecDetailPut);

DEBUGLOG(("Authorize() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;
}
