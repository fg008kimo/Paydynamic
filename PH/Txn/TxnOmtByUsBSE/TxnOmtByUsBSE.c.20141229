/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/09/22              Elvis Wong
*/

#define		PD_DETAIL_TAG  		"dt"
#define       	PD_ORDER_TAG   		"order"

#define	      	PD_KEY_TAGNAME_HD_FILE_ID		1
#define	      	PD_KEY_TAGNAME_HD_SEQ			2
#define	      	PD_KEY_TAGNAME_HD_VER			3

#define	      	PD_TAGNAME_HD_STATEMENT_DATE		1
#define	      	PD_TAGNAME_HD_STATEMENT_TIME		2
#define	      	PD_TAGNAME_HD_TFR_BANK_NAME		3
#define	      	PD_TAGNAME_HD_TFR_ACCT_NUM		4
#define	      	PD_TAGNAME_HD_TFR_TYPE			5
#define	      	PD_TAGNAME_HD_TFR_CHANNEL		6
#define	      	PD_TAGNAME_HD_TFR_TEXT			7
#define	      	PD_TAGNAME_HD_TFR_CUSTOMER_TEXT		8
#define	      	PD_TAGNAME_HD_TFR_SENDER_NAME		9
#define	      	PD_TAGNAME_HD_TXN_REF_NUM		10
#define	      	PD_TAGNAME_HD_BALANCE			11
#define	      	PD_TAGNAME_HD_AMT_TYPE			12
#define	      	PD_TAGNAME_HD_TXN_AMOUNT		13
#define	      	PD_TAGNAME_HD_BANK_CHARGE		14
#define	      	PD_TAGNAME_HD_MASK_SKIP			15

#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsBSE.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);

void TxnOmtByUsBSE(char cdebug)
{
	cDebug = cdebug;
}

int GetKeyTagName(int iHeader, char *csTagName)
{
        int     iRet = PD_OK;

        if (iHeader == PD_KEY_TAGNAME_HD_FILE_ID) {
/* file_id */
		sprintf(csTagName, "file_id");
	} else if (iHeader == PD_KEY_TAGNAME_HD_SEQ) {
/* seq */
		sprintf(csTagName, "seq");
	} else if (iHeader == PD_KEY_TAGNAME_HD_VER) {
/* ver */
		sprintf(csTagName, "ver");
	} else {
                sprintf(csTagName, "%s", "\0");
        }
//DEBUGLOG(("GetKeyTagName() iHeader = [%d], csTagName = [%s]\n",iHeader,csTagName));

        return iRet;
}

int GetSubDataTagName(int iHeader, char *csTagName)
{
	int	iRet = PD_OK;

	if (iHeader == PD_TAGNAME_HD_STATEMENT_DATE) {
/* statement_date */
		sprintf(csTagName, "statement_date");	
	} else if (iHeader == PD_TAGNAME_HD_STATEMENT_TIME) {	
/* statement_time */
		sprintf(csTagName, "statement_time");	
	} else if (iHeader == PD_TAGNAME_HD_TFR_BANK_NAME) {   
/* tfr_bank_name */
                sprintf(csTagName, "tfr_bank_name");
        } else if (iHeader == PD_TAGNAME_HD_TFR_ACCT_NUM) {   
/* tfr_bank_acct_num */
                sprintf(csTagName, "tfr_bank_acct_num");
        } else if (iHeader == PD_TAGNAME_HD_TFR_TYPE) {   
/* tfr_type */
                sprintf(csTagName, "tfr_type");
        } else if (iHeader == PD_TAGNAME_HD_TFR_CHANNEL) {   
/* tfr_channel */
                sprintf(csTagName, "tfr_channel");
        } else if (iHeader == PD_TAGNAME_HD_TFR_TEXT) {   
/* tfr_text */
                sprintf(csTagName, "tfr_text");
        } else if (iHeader == PD_TAGNAME_HD_TFR_CUSTOMER_TEXT) {   
/* tfr_customer_text */
                sprintf(csTagName, "tfr_customer_text");
        } else if (iHeader == PD_TAGNAME_HD_TFR_SENDER_NAME) {   
/* tfr_sender_name */
                sprintf(csTagName, "tfr_sender_name");
        } else if (iHeader == PD_TAGNAME_HD_TXN_REF_NUM) {   
/* txn_ref_num */
                sprintf(csTagName, "txn_ref_num");
        } else if (iHeader == PD_TAGNAME_HD_BALANCE) {  
/* balance */
                sprintf(csTagName, "balance"); 
        } else if (iHeader == PD_TAGNAME_HD_AMT_TYPE) {  
/* amt_type */
                sprintf(csTagName, "amt_type"); 
        } else if (iHeader == PD_TAGNAME_HD_TXN_AMOUNT) {   
/* txn_amount */
                sprintf(csTagName, "txn_amount");
        } else if (iHeader == PD_TAGNAME_HD_BANK_CHARGE) {   
/* bank_charge */
                sprintf(csTagName, "bank_charge");
        } else if (iHeader == PD_TAGNAME_HD_MASK_SKIP) {   
/* mask_skip */
                sprintf(csTagName, "mask_skip");
        } else {
		sprintf(csTagName, "%s", "\0");
   	}
//DEBUGLOG(("GetSubDataTagName() iHeader = [%d], csTagName = [%s]\n",iHeader,csTagName));
	
	return iRet;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int	iRet = PD_OK;
	//int     iDtlRet = PD_OK;	

	char	cAction;
	char	*csUser = NULL;
	char    *csFileId = NULL;

	int	iHeaderVer = 0;
	//int	iSkipCount = 0;
	//int	iHoldCount = 0;
	//int	iAcceptCount = 0;
	//int	iTotalCount = 0;
	int	iSplitCount = 0;
	int	iAddCount = 0;
	int	iUpdateCount = 0;
	int	iDeleteCount = 0;
	int	iFileCount = 0;

	int	iSeq = 0;
	int	iVer = 0;
	int	iLastVer = 0;
	int	iLatestVer = 0;
	int	iDisabled = 0;
	//int	iOrgSysSeq = 0;
	int	iSysSeq = 0;
	int	iUserSeq = 0;	
	int     iSkip = 0;
        //int     iMaskSkip = 0;

	char    *csOrderSeq = NULL;
        char    *csOrderVer = NULL;

	char	*csTmp;
	//char		cTmp;
	//double	dTmp;
	int	iTmp;

	char	csTag[PD_TAG_LEN + 1];
	char	csTagName[PD_TAG_LEN + 1];
	
	int	i = 0;
	int     iIdx = 0;
	int	iCnt = 0;
	int	iOrderCnt = 0;

	char    *csData;
	char	*csDataCode;
	int	iDataCodeLen = 0;

	char    *csKey;
	char	*csKeyCode;
	int	iKeyCodeLen = 0;
	
	hash_t *hRecTemp = (hash_t*) malloc (sizeof(hash_t));
	hash_t *hRecOrder = (hash_t*) malloc (sizeof(hash_t));

	hash_t *hRecGet = (hash_t*) malloc (sizeof(hash_t));
	hash_t *hRecAdd = (hash_t*) malloc (sizeof(hash_t));
	hash_t *hRecUpdate = (hash_t*) malloc (sizeof(hash_t));
	
	csData = (char*) malloc (4096);
	csDataCode = (char*) malloc (4096);

	csKey = (char*) malloc (128);
	csKeyCode = (char*) malloc (128);

/*----------------------------------------------------------------Get Data From hRequest----------------------------------------------------------------*/

	hash_init(hRecTemp,0);

/* user */
        if (GetField_CString(hRequest, "add_user", &csUser)) {
                PutField_CString(hRecTemp,"add_user",csUser);
                PutField_CString(hContext,"create_user",csUser);
                PutField_CString(hContext,"update_user",csUser);
DEBUGLOG(("Authorize() user = [%s]\n", csUser));
        } else {
                iRet = INT_USER_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() user NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsBSE:: Authorize() user NOT FOUND!!!\n");
        }

/* total_cnt */
        if (GetField_CString(hRequest, "cnt", &csTmp)) {
DEBUGLOG(("Authorize() total_cnt = [%s]\n", csTmp));
                iCnt = atoi(csTmp);
        } else {
                iRet = INT_ERR;
DEBUGLOG(("Authorize() total_cnt NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() total_cnt NOT FOUND!!!\n");
        }	

	if (iRet == PD_OK) {
                for (i = 0; i < iCnt; i++) {
DEBUGLOG(("Authorize() hRecTemp::cnt = [%d]\n", i));

/*------------------------------------------------------Get Data String------------------------------------------------------*/
			sprintf(csTag, "%s_i_%d", PD_DETAIL_TAG, i+1);
                        if (GetField_CString(hRequest, csTag, &csData)) {
DEBUGLOG(("Authorize() hRecTemp::data = [%s]\n", csData));

				iDataCodeLen = 0;
	
/* action */
				sprintf(csDataCode,"%s",&csData[iDataCodeLen]);
                                if (csDataCode[0] == PD_BANK_STATEMENT_DATA_DELIMIT_SYMBOL_CHECK)
                                {
					iDataCodeLen++;

                                        sprintf(csDataCode,"%s","\0");
                                } else {
                                        strtok(csDataCode,PD_BANK_STATEMENT_DATA_DELIMIT_SYMBOL);
                                        iDataCodeLen += (strlen(csDataCode) + 1);
					
					sprintf(csTag, "%s_action_%d", PD_DETAIL_TAG, i+1);
                                        PutField_CString(hRecTemp,csTag,csDataCode);
					
					cAction = csDataCode[0];
                                }
DEBUGLOG(("Authorize() hRecTemp::action = [%s]\n",csDataCode));

/* key (file_id_seq_ver) */
                                sprintf(csDataCode,"%s",&csData[iDataCodeLen]);
                                if (csDataCode[0] == PD_BANK_STATEMENT_DATA_DELIMIT_SYMBOL_CHECK)
                                {
                                        iDataCodeLen++;

					sprintf(csDataCode,"%s","\0");
DEBUGLOG(("Authorize() hRecTemp::key = [%s]\n",csDataCode));
                                } else {
                                        strtok(csDataCode,PD_BANK_STATEMENT_DATA_DELIMIT_SYMBOL);
					iDataCodeLen += (strlen(csDataCode) + 1);
					
					sprintf(csTag, "%s_key_%d", PD_DETAIL_TAG, i+1);
                                        PutField_CString(hRecTemp,csTag,csDataCode);
DEBUGLOG(("Authorize() hRecTemp::key = [%s]\n",csDataCode));

/*--------------------------------------------Get Key String--------------------------------------------*/
                			iIdx = 0;
			
		                        sprintf(csKey,"%s",csDataCode);
                                        iKeyCodeLen = 0;

					do {

                                           	iIdx++;
							
						sprintf(csKeyCode,"%s",&csKey[iKeyCodeLen]);
                                           	if (csKeyCode[0] == PD_BANK_STATEMENT_KEY_DELIMIT_SYMBOL_CHECK) {
                                                	iKeyCodeLen++;

                                                       	sprintf(csKeyCode,"%s","\0");

							GetKeyTagName(iIdx,csTagName);
                                                        sprintf(csTag, "%s_%s_%d", PD_DETAIL_TAG, csTagName, i+1);
                                              	} else {
                                                    	strtok(csKeyCode,PD_BANK_STATEMENT_KEY_DELIMIT_SYMBOL);
                                                      	iKeyCodeLen += (strlen(csKeyCode) + 1);

                                                       	GetKeyTagName(iIdx,csTagName);
                                                       	sprintf(csTag, "%s_%s_%d", PD_DETAIL_TAG, csTagName, i+1);
                                                     	PutField_CString(hRecTemp,csTag,csKeyCode);
                                              	}
DEBUGLOG(("Authorize() hRecTemp::%s = [%s]\n",csTagName,csKeyCode));

                                  	} while (iKeyCodeLen < strlen(csKey));
				}
	
/* sub_data */
				sprintf(csDataCode,"%s",&csData[iDataCodeLen]);
				if (iDataCodeLen >= strlen(csData))
                                {
                                        iDataCodeLen++;

                                        sprintf(csDataCode,"%s","\0");
DEBUGLOG(("Authorize() hRecTemp::sub_data = [%s]\n",csDataCode));
                                } else {
					iIdx = 0;
				
					sprintf(csTag, "%s_sub_data_%d", PD_DETAIL_TAG, i+1);
                                        PutField_CString(hRecTemp,csTag,csDataCode);
DEBUGLOG(("Authorize() hRecTemp::sub_data = [%s]\n",csDataCode));

/*--------------------------------------------Get Sub Data String--------------------------------------------*/
					if (cAction == PD_ACTION_ADD) {

						do {

							iIdx++;

							sprintf(csDataCode,"%s",&csData[iDataCodeLen]);
                                                        if (csDataCode[0] == PD_BANK_STATEMENT_DATA_DELIMIT_SYMBOL_CHECK) {
                                                                iDataCodeLen++;

                                                                sprintf(csDataCode,"%s","\0");

                                                                GetSubDataTagName(iIdx,csTagName);
                                                                sprintf(csTag, "%s_%s_%d", PD_DETAIL_TAG, csTagName, i+1);
                                                        } else {
                                                                strtok(csDataCode,PD_BANK_STATEMENT_DATA_DELIMIT_SYMBOL);
                                                                iDataCodeLen += (strlen(csDataCode) + 1);

                                                                GetSubDataTagName(iIdx,csTagName);
                                                                sprintf(csTag, "%s_%s_%d", PD_DETAIL_TAG, csTagName, i+1);
                                                                PutField_CString(hRecTemp,csTag,csDataCode);
                                                        }
DEBUGLOG(("Authorize() hRecTemp::%s = [%s]\n",csTagName,csDataCode));
							
						} while (iDataCodeLen < strlen(csData));

					} else if (cAction == PD_ACTION_UPDATE) {
				
						do {						
							
							iIdx++;

                                                        sprintf(csDataCode,"%s",&csData[iDataCodeLen]);
                                                        if (csDataCode[0] == PD_BANK_STATEMENT_DATA_DELIMIT_SYMBOL_CHECK) {
                                                                iDataCodeLen++;

                                                                sprintf(csDataCode,"%s","\0");
                                                        } else {
                                                                strtok(csDataCode,PD_BANK_STATEMENT_DATA_DELIMIT_SYMBOL);
                                                                iDataCodeLen += (strlen(csDataCode) + 1);

                                                                sprintf(csTag, "%s_sub_data_key_%d", PD_DETAIL_TAG, i+1);
                                                                PutField_CString(hRecTemp,csTag,csDataCode);
DEBUGLOG(("Authorize() hRecTemp::sub_data_key_%d = [%s]\n",iIdx,csDataCode));

/*----------------------------------Get Sub Data Key String----------------------------------*/
                                                                sprintf(csKey,"%s",csDataCode);
                                                                iKeyCodeLen = 0;

                                                                sprintf(csKeyCode,"%s",&csKey[iKeyCodeLen]);
                                                                if (csKeyCode[0] == PD_BANK_STATEMENT_KEY_DELIMIT_SYMBOL_CHECK)
                                                                {
                                                                        iKeyCodeLen++;

                                                                        sprintf(csKeyCode,"%s","\0");
                                                                } else {
                                                                        strtok(csKeyCode,PD_BANK_STATEMENT_KEY_DELIMIT_SYMBOL);
                                                                        iKeyCodeLen += (strlen(csKeyCode) + 1);

                                                                        iTmp = atoi(csKeyCode);
                                                                        GetSubDataTagName(iTmp,csTagName);
                                                                        sprintf(csKeyCode,"%s",&csKey[iKeyCodeLen]);
                                                                        sprintf(csTag, "%s_%s_%d", PD_DETAIL_TAG, csTagName, i+1);
                                                                        PutField_CString(hRecTemp,csTag,csKeyCode);
                                                                }
DEBUGLOG(("Authorize() hRecTemp::%s = [%s]\n",csTagName,csKeyCode));
                                                        }
                                                } while (iDataCodeLen < strlen(csData));						
					}	
				}
			}
		}
	}

/*------------------------------------------------------Get Order String------------------------------------------------------*/
	if (iRet == PD_OK) {
        	if (GetField_CString(hRequest, "order", &csData)) {
DEBUGLOG(("Authorize() hRecTemp::order = [%s]\n", csData));

			iOrderCnt = 0;
               		iDataCodeLen = 0;

			do {

				iOrderCnt++;

/* order_key (file_id_seq_ver) */
                        	sprintf(csDataCode,"%s",&csData[iDataCodeLen]);
                           	if (csDataCode[0] == PD_BANK_STATEMENT_DATA_DELIMIT_SYMBOL_CHECK) {
                                	iDataCodeLen++;

                                      	sprintf(csDataCode,"%s","\0");
                            	} else {
                                   	strtok(csDataCode,PD_BANK_STATEMENT_DATA_DELIMIT_SYMBOL);
                               		iDataCodeLen += (strlen(csDataCode) + 1);
					
					sprintf(csTag, "%s_%d", PD_ORDER_TAG, iOrderCnt);
                                        PutField_CString(hRecTemp,csTag,csDataCode);
DEBUGLOG(("Authorize() hRecTemp::order_%d = [%s]\n", iOrderCnt,csDataCode));

/*--------------------------------------------Get Key String--------------------------------------------*/
                                        iIdx = 0;

                                        sprintf(csKey,"%s",csDataCode);
                                        iKeyCodeLen = 0;

                                        do {

                                                iIdx++;

                                                sprintf(csKeyCode,"%s",&csKey[iKeyCodeLen]);
                                                if (csKeyCode[0] == PD_BANK_STATEMENT_KEY_DELIMIT_SYMBOL_CHECK) {
                                                        iKeyCodeLen++;

                                                        sprintf(csKeyCode,"%s","\0");

							GetKeyTagName(iIdx,csTagName);
                                                        sprintf(csTag, "%s_%s_%d", PD_ORDER_TAG, csTagName, iOrderCnt);
                                                } else {
                                                        strtok(csKeyCode,PD_BANK_STATEMENT_KEY_DELIMIT_SYMBOL);
                                                        iKeyCodeLen += (strlen(csKeyCode) + 1);

                                                        GetKeyTagName(iIdx,csTagName);
                                                        sprintf(csTag, "%s_%s_%d", PD_ORDER_TAG, csTagName, iOrderCnt);
                                                        PutField_CString(hRecTemp,csTag,csKeyCode);
                                                }
DEBUGLOG(("Authorize() hRecTemp::%s = [%s]\n",csTag,csKeyCode));

                                        } while (iKeyCodeLen < strlen(csKey));

/* order_user_seq */
                                      	sprintf(csTag, "%s_user_seq_%d", PD_ORDER_TAG, iOrderCnt);
                                    	PutField_Int(hRecTemp,csTag,iOrderCnt);
DEBUGLOG(("Authorize() hRecTemp::%s = [%d]\n",csTag,iOrderCnt));

                             	}

                	} while (iDataCodeLen < strlen(csData));

DEBUGLOG(("Authorize() hRecTemp::order_cnt = [%d]\n",iOrderCnt));
       	 	} else {
DEBUGLOG(("Authorize() hRecTemp::order NOT FOUND!!!\n"));
        	}
	}

/*----------------------------------------------------------------Get Data From hRecTemp----------------------------------------------------------------*/

	hash_init(hRecOrder,0);

	if (iRet == PD_OK) {

/*------------------------------------------------------File Header Ver------------------------------------------------------*/
DEBUGLOG(("Authorize() FileHeaderVer()\n"));

/*---------------Get Statement Header---------------*/

		hash_init(hRecGet,0);

/* file_id */
                sprintf(csTag, "%s_file_id_1", PD_DETAIL_TAG);
              	if (GetField_CString(hRecTemp, csTag, &csFileId)) {
DEBUGLOG(("Authorize() file_id = [%s]\n", csFileId));
                } else {
                	iRet = INT_FILE_ID_NOT_FOUND;
                      	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() file_id not found!!!\n"));
ERRLOG("TxnOmtByUsSCE:: Authorize() file_id not found!!!\n");
              	}

DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::csFileId = [%s]\n",csFileId));

          	DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "GetHeader");
              	iRet = (unsigned long)(*DBObjPtr)(csFileId,hRecGet);
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::iRet = [%d]\n",iRet));

              	if (iRet != PD_OK) {
                        iRet = INT_INVALID_TXN;
                      	PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader):: FAILURE\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatement:: GetHeader() FAILURE!!!\n");
               	} else {

/* header_ver */
                   	if (GetField_Int(hRecGet,"ver",&iHeaderVer)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::header_ver = [%d]\n",iHeaderVer));
				iHeaderVer++;
                       	}
              	}
	}

	if (iRet == PD_OK) {
                for (i = 0; i < iCnt; i++) {
DEBUGLOG(("Authorize() cnt = [%d]\n", i));

			hash_init(hRecGet,0);
			hash_init(hRecAdd,0);
			hash_init(hRecUpdate,0);

/* user */
        		if (GetField_CString(hRecTemp, "add_user", &csUser)) {
                		PutField_CString(hRecAdd,"create_user",csUser);
                		PutField_CString(hRecAdd,"update_user",csUser);
                		PutField_CString(hRecUpdate,"create_user",csUser);
                		PutField_CString(hRecUpdate,"update_user",csUser);
DEBUGLOG(("Authorize() user = [%s]\n", csUser));
        		} else {
                		iRet = INT_USER_NOT_FOUND;
                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() user NOT FOUND!!!\n"));
ERRLOG("TxnOmtByUsBSE:: Authorize() user NOT FOUND!!!\n");
        		}

/* action */
			sprintf(csTag, "%s_action_%d", PD_DETAIL_TAG, i+1);
			if (GetField_CString(hRecTemp, csTag, &csTmp)) {
				cAction = csTmp[0];
				PutField_Char(hRecAdd,"action",cAction);
				PutField_Char(hRecUpdate,"action",cAction);
DEBUGLOG(("Authorize() action = [%c]\n", cAction));
			} else {
                		iRet = INT_ACTION_NOT_FOUND;
                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() action not found!!!\n"));
ERRLOG("TxnOmtByUsSCE:: Authorize() action not found!!!\n");
        		}

/* file_id */
			sprintf(csTag, "%s_file_id_%d", PD_DETAIL_TAG, i+1);
			if (GetField_CString(hRecTemp, csTag, &csFileId)) {
				PutField_CString(hContext,"file_id",csFileId);
				PutField_CString(hRecAdd,"file_id",csFileId);
				PutField_CString(hRecUpdate,"file_id",csFileId);
DEBUGLOG(("Authorize() file_id = [%s]\n", csFileId));
			} else {
              			iRet = INT_FILE_ID_NOT_FOUND;
                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() file_id not found!!!\n"));
ERRLOG("TxnOmtByUsSCE:: Authorize() file_id not found!!!\n");
        		}

			if ((iRet == PD_OK) && (cAction == PD_ACTION_DELETE)) { 	

/*------------------------------------------------------Delete Record------------------------------------------------------*/
DEBUGLOG(("Authorize() DeleteRecord()\n"));

/*---------------Check File Exist---------------*/
DEBUGLOG(("Authorize() CheckFileIdExist()\n"));

				sprintf(csTag,"%s",csFileId);
DEBUGLOG(("Authorize() file_id = [%s]\n",csTag));

                		DBObjPtr = CreateObj(DBPtr,"DBOLStatement","CheckFileIdExist"); 
				if ((unsigned long)(*DBObjPtr)(csTag) == FOUND) {
DEBUGLOG(("Authorize() call DBOLStatement(CheckFileIdExist)::File Exist()!!!\n"));

/* ver */
                                     	sprintf(csTag, "%s_ver_%d", PD_DETAIL_TAG, i+1);
                                   	if (GetField_CString(hRecTemp, csTag, &csTmp)) {
                                           	iVer = atoi(csTmp);
DEBUGLOG(("Authorize() ver = [%d]\n", iVer));
                                            	PutField_Int(hRecAdd, "ver",iVer);
                                     	} else {
                                           	iRet = INT_STATEMENT_VER_NOT_FOUND;
                                             	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() ver not found!!!\n"));
ERRLOG("TnOmtByUsBSE:: Authorize() ver not found!!!\n");
                                        }

/*---------------Get Statement Tmp (Last Ver Record) Detail---------------*/

/* seq */
					sprintf(csTag, "%s_seq_%d", PD_DETAIL_TAG, i+1);		
					if (GetField_CString(hRecTemp, csTag, &csTmp)) {
                				iSeq = atoi(csTmp);
DEBUGLOG(("Authorize() seq = [%d]\n", iSeq));
                				PutField_Int(hRecAdd,"seq",iSeq);
       	 				} else {
						iRet = INT_STATEMENT_SEQ_NOT_FOUND;
						PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() seq not found!!!\n"));
ERRLOG("TxnOmtByUsBSE:: Authorize() seq not found!!!\n");
        				}

					if (iRet == PD_OK) {
              					DBObjPtr = CreateObj(DBPtr,"DBOLStatementTmp","GetLastVerRecDetail");
                   				iRet = (unsigned long)(*DBObjPtr)(csFileId,iSeq,hRecGet);
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::iRet = [%d]\n",iRet));

                        			if (iRet == PD_OK) {

/* ver */
                             				if (GetField_Int(hRecGet,"ver",&iLastVer)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::ver = [%d]\n",iLastVer));
                            				}

/* latest_ver */
                             				if (GetField_Int(hRecGet,"latest_ver",&iLatestVer)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::latest_ver = [%d]\n",iLatestVer));
                              				}

/* disabled */
                                                        if (GetField_Int(hRecGet,"disabled",&iDisabled)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::disabled = [%d]\n",iDisabled));
                                                        }

#if 1
/* sys_seq */
                             				if (GetField_Int(hRecGet,"sys_seq",&iSysSeq)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::sys_seq = [%d]\n",iSysSeq));
								PutField_Int(hRecAdd, "sys_seq",iSysSeq);
                            				}
#endif

#if 1
/* user_seq */
                              				if (GetField_Int(hRecGet,"user_seq",&iUserSeq)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::user_seq = [%d]\n",iUserSeq));
								PutField_Int(hRecAdd, "user_seq",iUserSeq);
                               				}
#endif

/* skip */
                                                        if (GetField_Int(hRecGet,"skip",&iSkip)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::skip = [%d]\n",iSkip));
								PutField_Int(hRecAdd, "skip",iSkip);
                                                        }

#if 0
/* mask_skip */
                                                        if (GetField_Int(hRecGet,"mask_skip",&iMaskSkip)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::mask_skip = [%d]\n",iMaskSkip));
								PutField_Int(hRecAdd, "mask_skip",iMaskSkip);
							}
#endif

/* int_bank_code */
                                                        if (GetField_CString(hRecGet,"int_bank_code",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::int_bank_code = [%s]\n",csTmp));
                                                                PutField_CString(hRecAdd, "int_bank_code",csTmp);
                                                        }

/* bank_acct_num */
                                                        if (GetField_CString(hRecGet,"bank_acct_num",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::bank_acct_num = [%s]\n",csTmp));
                                                                PutField_CString(hRecAdd, "bank_acct_num",csTmp);
                                                        }

/* raw_date */
                                                        if (GetField_CString(hRecGet,"raw_date",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::raw_date = [%s]\n",csTmp));
                                                                PutField_CString(hRecAdd, "raw_date",csTmp);
                                                        }

/* raw_time */
                                                        if (GetField_CString(hRecGet,"raw_time",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::raw_time = [%s]\n",csTmp));
                                                                PutField_CString(hRecAdd, "raw_time",csTmp);
                                                        }

/* statement_date */
							if (GetField_CString(hRecGet,"statement_date",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::statement_date = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "statement_date",csTmp);
							}

/* statement_time */
							if (GetField_CString(hRecGet,"statement_time",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::statement_time = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "statement_time",csTmp);
                                                        }

/* tfr_bank_name */
							if (GetField_CString(hRecGet,"tfr_bank_name",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::tfr_bank_name = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "tfr_bank_name",csTmp);
                                                        }

/* tfr_bank_acct_num */
                                                        if (GetField_CString(hRecGet,"tfr_bank_acct_num",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::tfr_bank_acct_num = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "tfr_bank_acct_num",csTmp);
                                                        }

/* tfr_channel */
                                                        if (GetField_CString(hRecGet,"tfr_channel",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::tfr_channel = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "tfr_channel",csTmp);
                                                        }

/* tfr_type */
                                                        if (GetField_CString(hRecGet,"tfr_type",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::tfr_type = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "tfr_type",csTmp);
                                                        }

/* tfr_text */
                                                        if (GetField_CString(hRecGet,"tfr_text",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::tfr_text = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "tfr_text",csTmp);
                                                        }

/* tfr_customer_text */
                                                        if (GetField_CString(hRecGet,"tfr_customer_text",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::tfr_customer_text = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "tfr_customer_text",csTmp);
                                                        }

/* tfr_sender_name */
                                                        if (GetField_CString(hRecGet,"sender_name",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::tfr_sender_name = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "sender_name",csTmp);
                                                        }

/* txn_ref_num */
                                                        if (GetField_CString(hRecGet,"txn_ref_num",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::txn_ref_num = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "txn_ref_num",csTmp);
                                                        }

/* amt_type */
                                                        if (GetField_CString(hRecGet,"amt_type",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::amt_type = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "amt_type",csTmp);
                                                        }

/* txn_amount */
                                                        if (GetField_CString(hRecGet,"txn_amount",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::txn_amount = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "txn_amount",csTmp);
                                                        }						

/* bank_charge */
                                                        if (GetField_CString(hRecGet,"bank_charge",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::bank_charge = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "bank_charge",csTmp);
                                                        }

/* balance */
                                                        if (GetField_CString(hRecGet,"balance",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::balance = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "balance",csTmp);
                                                        }

                        			}
                        			else {
                                			iRet = INT_ERR;
DEBUGLOG(("Authorize:: call DBOLStatementTmp(GetLastVerRecDetail):: failed\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: GetLastVerRecDetail:: failed!!!\n");
                        			}
					}

/*---------------Check Disabled---------------*/ 
					if (iRet == PD_OK) {
						if (iDisabled == 1) {
							iRet = INT_STATEMENT_RECORD_DELETED;
DEBUGLOG(("Authorize() CheckRecDisabled:: disabled = [%d]\n", iDisabled));
ERRLOG("TxnOmtByUsBSE::Authorize() CheckRecDisabled failed!!!\n");
						}
					}

/*---------------Update Statement Tmp Detail---------------*/ 
             				if (iRet == PD_OK) {

/* file_id */     
	        				PutField_CString(hRecUpdate,"file_id",csFileId);
DEBUGLOG(("Authorize() UpdateRecDetail::file_id = [%s]\n",csFileId));
             
/* seq */
                       	 			PutField_Int(hRecUpdate, "seq",iSeq);
DEBUGLOG(("Authorize() UpdateRecDetail::seq = [%d]\n",iSeq));

/* ver */
						iVer = iHeaderVer;
		       				PutField_Int(hRecUpdate, "ver",iVer);
DEBUGLOG(("Authorize() UpdateRecDetail::ver = [%d]\n",iVer));

/* latest_ver */
                      				PutField_Int(hRecUpdate, "latest_ver",iLatestVer);
DEBUGLOG(("Authorize() UpdateRecDetail::latest_ver = [%d]\n",iLatestVer));
        
#if 0
/* user_seq */	
						sprintf(csTag, "%s_user_seq_%d", PD_DETAIL_TAG, i+1);
                        			if (GetField_CString(hRecTemp, csTag, &csTmp)) {
                                			iUserSeq = atoi(csTmp);
DEBUGLOG(("Authorize() UpdateRecDetail::user_seq = [%d]\n", iUserSeq));
                                			PutField_Int(hRecUpdate, "user_seq",iUserSeq);
                        			}
#endif

#if 0
/* sys_seq */
						iSysSeq = iUserSeq;
                                                PutField_Int(hRecUpdate, "sys_seq",iSysSeq);
DEBUGLOG(("Authorize() UpdateRecDetail::sys_seq = [%d]\n",iSysSeq));
#endif

/* update_user */
                               			PutField_CString(hRecUpdate,"update_user",csUser);
DEBUGLOG(("Authorize() UpdateRecDetail::update_user = [%s]\n",csUser));

DEBUGLOG(("Authorize() call DBOLStatementTmp(UpdateRecDetail)::Update()\n"));

                     				DBObjPtr = CreateObj(DBPtr, "DBOLStatementTmp", "UpdateRecDetail");
                     				iRet = (unsigned long)(*DBObjPtr)(hRecUpdate);
                       				if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(UpdateRecDetail)::Update() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: UpdateRecDetail() FAILURE!!!\n");
                     				}
           				}

/*---------------Add Statement Tmp Detail---------------*/
             				if (iRet == PD_OK) {

/* file_id */
                     				PutField_CString(hRecAdd,"file_id",csFileId);
DEBUGLOG(("Authorize() AddDetail::file_id = [%s]\n",csFileId));

/* seq */
                        			PutField_Int(hRecAdd, "seq",iSeq);
DEBUGLOG(("Authorize() AddDetail::seq = [%d]\n",iSeq));
             
/* ver */
		       				PutField_Int(hRecAdd, "ver",iVer);
DEBUGLOG(("Authorize() AddDetail::ver = [%d]\n",iVer));
         
#if 0
/* latest_ver */
						iLatestVer = 0;
	             				PutField_Int(hRecAdd, "latest_ver",iLatestVer);
DEBUGLOG(("Authorize() AddDetail::latest_ver = [%d]\n",iLatestVer));
#endif     

/* disabled */
                                                iDisabled = 1;
                                                PutField_Int(hRecAdd, "disabled",iDisabled);
DEBUGLOG(("Authorize() AddDetail::disabled = [%d]\n", iDisabled));

#if 0	
/* user_seq */	
						sprintf(csTag, "%s_user_seq_%d", PD_DETAIL_TAG, i+1);
                	        		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
                        	        		iUserSeq = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::user_seq = [%d]\n", iUserSeq));
                                			PutField_Int(hRecAdd, "user_seq",iUserSeq);
                        			} 
#endif         

#if 0
/* sys_seq */
						iSysSeq = iUserSeq;
                                                PutField_Int(hRecAdd, "sys_seq",iSysSeq);
DEBUGLOG(("Authorize() AddDetail::sys_seq = [%d]\n",iSysSeq));
#endif
 
/* skip */
						sprintf(csTag, "%s_skip_%d", PD_DETAIL_TAG, i+1);
                                                if (GetField_CString(hRecTemp, csTag, &csTmp)) {
                                                        iSkip = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::skip = [%d]\n",iSkip));
							PutField_Int(hRecAdd, "skip",iSkip);
                                                }

/*
						PutField_Int(hRecAdd, "skip",iSkip);
DEBUGLOG(("Authorize() AddDetail::skip = [%d]\n",iSkip));
*/

#if 0
/* mask_skip */
						PutField_Int(hRecAdd, "mask_skip",iMaskSkip);
DEBUGLOG(("Authorize() AddDetail::mask_skip = [%d]\n",iMaskSkip));
#endif

DEBUGLOG(("Authorize() call DBOLStatementTmp(AddDetail)::Add()\n"));

                	     			DBObjPtr = CreateObj(DBPtr, "DBOLStatementTmp", "AddDetail");
                     				iRet = (unsigned long)(*DBObjPtr)(hRecAdd);
                       				if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(AddDetail)::Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: AddDetail() FAILURE!!!\n");
                     				}
           				}

/*---------------Save Statement Header into global---------------*/
                        		if (iRet == PD_OK) {

/* split_count */
DEBUGLOG(("Authorize() SaveHeader::split_count = [%d]\n",iSplitCount));

/* add_count */
DEBUGLOG(("Authorize() SaveHeader::add_count = [%d]\n",iAddCount));

/* update_count */
DEBUGLOG(("Authorize() SaveHeader::update_count = [%d]\n",iUpdateCount));

/* delete_count */
                                		iDeleteCount++;
DEBUGLOG(("Authorize() SaveHeader::delete_count = [%d]\n",iDeleteCount));

/* file_count */
                                		iFileCount = iSplitCount + iAddCount - iDeleteCount;
DEBUGLOG(("Authorize() SaveHeader::file_count = [%d]\n",iFileCount));

					}
				}
				else {
                        		iRet = INT_FILE_ID_NOT_FOUND;
DEBUGLOG(("Authorize() call DBOLStatement::File Not Exist()!!! \n"));
ERRLOG("TxnOmtByUsBSE::Authorize() CheckFileIdExist:: failed!!!\n");
                		}
			}
			else if ((iRet == PD_OK) && (cAction == PD_ACTION_UPDATE)) { 

/*------------------------------------------------------Update Record------------------------------------------------------*/
DEBUGLOG(("Authorize() UpdateRecord()\n"));

/*---------------Check File Exist---------------*/
DEBUGLOG(("Authorize() CheckFileIdExist()\n"));

				sprintf(csTag,"%s",csFileId);
DEBUGLOG(("Authorize() file_id = [%s]\n",csTag));

                		DBObjPtr = CreateObj(DBPtr,"DBOLStatement","CheckFileIdExist");
                		if ((unsigned long)(*DBObjPtr)(csTag) == FOUND) {
DEBUGLOG(("Authorize() call DBOLStatement(CheckFileIdExist)::File Exist()!!!\n"));

/* ver */
                                  	sprintf(csTag, "%s_ver_%d", PD_DETAIL_TAG, i+1);
                                   	if (GetField_CString(hRecTemp, csTag, &csTmp)) {
                                           	iVer = atoi(csTmp);
DEBUGLOG(("Authorize() ver = [%d]\n", iVer));
                                               	PutField_Int(hRecAdd, "ver",iVer);
                                  	} else {
                                            	iRet = INT_STATEMENT_VER_NOT_FOUND;
                                           	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() ver not found!!!\n"));
ERRLOG("TnOmtByUsBSE:: Authorize() ver not found!!!\n");
                                    	}
		
/*---------------Get Statement Tmp (Last Ver Record) Detail---------------*/

/* seq */
					sprintf(csTag, "%s_seq_%d", PD_DETAIL_TAG, i+1);
                        		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
                                		iSeq = atoi(csTmp);
DEBUGLOG(("Authorize() seq = [%d]\n", iSeq));
                                		PutField_Int(hRecAdd,"seq",iSeq);
                                		//PutField_Int(hContext,"seq",iSeq);
                        		} else {

                                		iRet = INT_STATEMENT_SEQ_NOT_FOUND;
                                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() seq not found!!!\n"));
ERRLOG("TxnOmtByUsBSE:: Authorize() seq not found!!!\n");
                      			}

					if (iRet == PD_OK) {

                                		DBObjPtr = CreateObj(DBPtr,"DBOLStatementTmp","GetLastVerRecDetail");
                                		iRet = (unsigned long)(*DBObjPtr)(csFileId,iSeq,hRecGet);
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::iRet = [%d]\n",iRet));
                                		if (iRet == PD_OK) {

/* ver */
                                        		if (GetField_Int(hRecGet,"ver",&iLastVer)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::ver = [%d]\n",iLastVer));
                                        		}

/* latest_ver */
                                        		if (GetField_Int(hRecGet,"latest_ver",&iLatestVer)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::latest_ver = [%d]\n",iLatestVer));
                                        		}

/* disabled */
                                                        if (GetField_Int(hRecGet,"disabled",&iDisabled)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::disabled = [%d]\n",iDisabled));
                                                        }

#if 0
/* sys_seq */
                                        		if (GetField_Int(hRecGet,"sys_seq",&iSysSeq)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::sys_seq = [%d]\n",iSysSeq));
                                        		}
#endif

#if 0
/* user_seq */
                                        		if (GetField_Int(hRecGet,"user_seq",&iUserSeq)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::user_seq = [%d]\n",iUserSeq));
                                        		}
#endif

/* skip */
                                                        if (GetField_Int(hRecGet,"skip",&iSkip)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::skip = [%d]\n",iSkip));
								PutField_Int(hRecAdd, "skip",iSkip);
                                                        }

#if 0
/* mask_skip */
                                                        if (GetField_Int(hRecGet,"mask_skip",&iMaskSkip)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::mask_skip = [%d]\n",iMaskSkip));
								PutField_Int(hRecAdd, "mask_skip",iMaskSkip);
							}
#endif

/* int_bank_code */
							if (GetField_CString(hRecGet,"int_bank_code",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::int_bank_code = [%s]\n",csTmp));
                                                                PutField_CString(hRecAdd, "int_bank_code",csTmp);
                                                        }

/* bank_acct_num */
							if (GetField_CString(hRecGet,"bank_acct_num",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::bank_acct_num = [%s]\n",csTmp));
                                                                PutField_CString(hRecAdd, "bank_acct_num",csTmp);
                                                        }

/* raw_date */
							if (GetField_CString(hRecGet,"raw_date",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::raw_date = [%s]\n",csTmp));
                                                                PutField_CString(hRecAdd, "raw_date",csTmp);
                                                        }							

/* raw_time */
 							if (GetField_CString(hRecGet,"raw_time",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::raw_time = [%s]\n",csTmp));
                                                                PutField_CString(hRecAdd, "raw_time",csTmp);
                                                        }                 

/* statement_date */
                                                        if (GetField_CString(hRecGet,"statement_date",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::statement_date = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "statement_date",csTmp);
                                                        }

/* statement_time */
                                                        if (GetField_CString(hRecGet,"statement_time",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::statement_time = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "statement_time",csTmp);
                                                        }

/* tfr_bank_name */
                                                        if (GetField_CString(hRecGet,"tfr_bank_name",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::tfr_bank_name = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "tfr_bank_name",csTmp);
                                                        }

/* tfr_bank_acct_num */
                                                        if (GetField_CString(hRecGet,"tfr_bank_acct_num",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::tfr_bank_acct_num = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "tfr_bank_acct_num",csTmp);
                                                        }

/* tfr_channel */
                                                        if (GetField_CString(hRecGet,"tfr_channel",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::tfr_channel = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "tfr_channel",csTmp);
                                                        }

/* tfr_type */
                                                        if (GetField_CString(hRecGet,"tfr_type",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::tfr_type = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "tfr_type",csTmp);
                                                        }

/* tfr_text */
                                                        if (GetField_CString(hRecGet,"tfr_text",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::tfr_text = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "tfr_text",csTmp);
                                                        }

/* tfr_customer_text */
                                                        if (GetField_CString(hRecGet,"tfr_customer_text",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::tfr_customer_text = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "tfr_customer_text",csTmp);
                                                        }

/* tfr_sender_name */
                                                        if (GetField_CString(hRecGet,"sender_name",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::tfr_sender_name = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "sender_name",csTmp);
                                                        }

/* txn_ref_num */
                                                        if (GetField_CString(hRecGet,"txn_ref_num",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::txn_ref_num = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "txn_ref_num",csTmp);
                                                        }

/* amt_type */
                                                        if (GetField_CString(hRecGet,"amt_type",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::amt_type = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "amt_type",csTmp);
                                                        }

/* txn_amount */
                                                        if (GetField_CString(hRecGet,"txn_amount",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::txn_amount = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "txn_amount",csTmp);
                                                        }

/* bank_charge */
                                                        if (GetField_CString(hRecGet,"bank_charge",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::bank_charge = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "bank_charge",csTmp);
                                                        }

/* balance */
                                                        if (GetField_CString(hRecGet,"balance",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail)::balance = [%s]\n",csTmp));
								PutField_CString(hRecAdd, "balance",csTmp);
                                                        }

                                		} else {
                                        		iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastVerRecDetail):: failed\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: GetLastVerRecDetail() failed!!!\n");
                                		}
					}

/*---------------Check Disabled---------------*/ 
					if (iRet == PD_OK) {
						if (iDisabled == 1) {
                                                        iRet = INT_STATEMENT_RECORD_DELETED;
DEBUGLOG(("Authorize() CheckRecDisabled:: disabled = [%d]\n", iDisabled));
ERRLOG("TxnOmtByUsBSE::Authorize() CheckRecDisabled failed!!!\n");
                                                }
					}

/*---------------Update Statement Tmp Detail---------------*/
					if (iRet == PD_OK) {

/* file_id */
                                		PutField_CString(hRecUpdate,"file_id",csFileId);
DEBUGLOG(("Authorize() UpdateRecDetail::file_id = [%s]\n",csFileId));

/* seq */
                                		PutField_Int(hRecUpdate, "seq",iSeq);
DEBUGLOG(("Authorize() UpdateRecDetail::seq = [%d]\n",iSeq));

/* ver */
						iVer = iHeaderVer;
                                		PutField_Int(hRecUpdate, "ver",iVer);
DEBUGLOG(("Authorize() UpdateRecDetail::ver = [%d]\n",iVer));

/* latest_ver */
                                		PutField_Int(hRecUpdate, "latest_ver",iLatestVer);
DEBUGLOG(("Authorize() UpdateRecDetail::latest_ver = [%d]\n",iLatestVer));

#if 0
/* user_seq */
						sprintf(csTag, "%s_user_seq_%d", PD_DETAIL_TAG, i+1);
              	          			if (GetField_CString(hRecTemp, csTag, &csTmp)) {
                                			iUserSeq = atoi(csTmp);
DEBUGLOG(("Authorize() UpdateRecDetail::user_seq = [%d]\n", iUserSeq));
                                			PutField_Int(hRecUpdate, "user_seq",iUserSeq);
                        			}
#endif

#if 0
/* sys_seq */
						iSysSeq = iUserSeq;
                                                PutField_Int(hRecUpdate, "sys_seq",iSysSeq);
DEBUGLOG(("Authorize() UpdateRecDetail::sys_seq = [%d]\n",iSysSeq));
#endif

/* update_user */
                                		PutField_CString(hRecUpdate,"update_user",csUser);
DEBUGLOG(("Authorize() UpdateRecDetail::update_user = [%s]\n",csUser));

DEBUGLOG(("Authorize() call DBOLStatementTmp(UpdateRecDetail)::Update()\n"));

                                		DBObjPtr = CreateObj(DBPtr, "DBOLStatementTmp", "UpdateRecDetail");
                                		iRet = (unsigned long)(*DBObjPtr)(hRecUpdate);
                                		if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(UpdateRecDetail)::Update() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: UpdateRecDetail() FAILURE!!!\n");
                                		}
                        		}

/*---------------Add Statement Tmp Detail---------------*/
                        		if (iRet == PD_OK) {

/* file_id */
                                		PutField_CString(hRecAdd,"file_id",csFileId);
DEBUGLOG(("Authorize() AddDetail::file_id = [%s]\n",csFileId));

/* seq */
                                		PutField_Int(hRecAdd, "seq",iSeq);
DEBUGLOG(("Authorize() AddDetail::seq = [%d]\n",iSeq));

/* ver */
                                		PutField_Int(hRecAdd, "ver",iVer);
DEBUGLOG(("Authorize() AddDetail::ver = [%d]\n",iVer));

#if 0
/* latest_ver */
						iLatestVer = 0;
                                		PutField_Int(hRecAdd, "latest_ver",iLatest_Ver);
DEBUGLOG(("Authorize() AddDetail::latest_ver = [%d]\n",iLatestVer));
#endif

/* disabled */
                                                iDisabled = 0;
                                                PutField_Int(hRecAdd, "disabled",iDisabled);
DEBUGLOG(("Authorize() AddDetail::disabled = [%d]\n",iDisabled));

#if 0
/* user_seq */
						sprintf(csTag, "%s_user_seq_%d", PD_DETAIL_TAG, i+1);
                        			if (GetField_CString(hRecTemp, csTag, &csTmp)) {
                                			iUserSeq = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::user_seq = [%d]\n", iUserSeq));
                                			PutField_Int(hRecAdd, "user_seq",iUserSeq);
                        			}
#endif

#if 0
/* sys_seq */
						iSysSeq = iUserSeq;
                                                PutField_Int(hRecAdd, "sys_seq",iSysSeq);
DEBUGLOG(("Authorize() AddDetail::sys_seq = [%d]\n",iSysSeq));
#endif

/* skip */
						sprintf(csTag, "%s_skip_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
                                        		iSkip = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::skip = [%d]\n", iSkip));
                                        		PutField_Int(hRecAdd, "skip",iSkip);
                                		}

#if 0
/* mask_skip */
						sprintf(csTag, "%s_mask_skip_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
                                        		iMaskSkip = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::mask_skip = [%d]\n", iMaskSkip));
                                        		PutField_Int(hRecAdd, "mask_skip",iMaskSkip);
						}
#endif
	
/* int_bank_code */
						sprintf(csTag, "%s_int_bank_code_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::int_bank_code = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"int_bank_code",csTmp);
                                		}

/* bank_acct_num */
						sprintf(csTag, "%s_bank_acct_num_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::bank_acct_num = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"bank_acct_num",csTmp);
                                		}

#if 0
/* raw_date */
						sprintf(csTag, "%s_statement_date_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::raw_date = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"raw_date",csTmp);
                                		}

/* raw_time */
						sprintf(csTag, "%s_statement_time_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::raw_time = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"raw_time",csTmp);
                                		}
#endif

#if 1
/* statement_date */
						sprintf(csTag, "%s_statement_date_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::statement_date = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"statement_date",csTmp);
						}

/* statement_time */
						sprintf(csTag, "%s_statement_time_%d", PD_DETAIL_TAG, i+1);
   		                             	if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::statement_time = [%s]\n", csTmp));
                 		                       PutField_CString(hRecAdd,"statement_time",csTmp);
						}
#endif

/* tfr_bank_name */
						sprintf(csTag, "%s_tfr_bank_name_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_bank_name = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"tfr_bank_name",csTmp);
						}

/* tfr_bank_acct_num */
						sprintf(csTag, "%s_tfr_bank_acct_num_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_bank_acct_num = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"tfr_bank_acct_num",csTmp);
						}

/* tfr_type */
						sprintf(csTag, "%s_tfr_type_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_type = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"tfr_type",csTmp);
						}

/* tfr_channel */
						sprintf(csTag, "%s_tfr_channel_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_channel = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"tfr_channel",csTmp);
						}

/* tft_text */
						sprintf(csTag, "%s_tfr_text_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_text = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"tfr_text",csTmp);
						}

/* tfr_customer_text */
						sprintf(csTag, "%s_tfr_customer_text_%d", PD_DETAIL_TAG, i+1);
                   		             	if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_customer_text = [%s]\n",csTmp));
                                		        PutField_CString(hRecAdd,"tfr_customer_text",csTmp);
						}

/* sender_name */
						sprintf(csTag, "%s_tfr_sender_name_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::sender_name = [%s]\n",csTmp));
                                        		PutField_CString(hRecAdd,"sender_name",csTmp);
						}

/* txn_ref_num */
						sprintf(csTag, "%s_txn_ref_num_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::txn_ref_num = [%s]\n",csTmp));
                                 		       PutField_CString(hRecAdd,"txn_ref_num",csTmp);
						}

/* balance */
						sprintf(csTag, "%s_balance_%d", PD_DETAIL_TAG, i+1);
		                                if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::balance = [%s]\n",csTmp));
							PutField_CString(hRecAdd,"balance",csTmp);
						}

/* amt_type */
						sprintf(csTag, "%s_amt_type_%d", PD_DETAIL_TAG, i+1);
		                                if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::amt_type = [%s]\n",csTmp));
                		                        PutField_CString(hRecAdd,"amt_type",csTmp);
						}

/* txn_amount */
						sprintf(csTag, "%s_txn_amount_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::txn_amount = [%s]\n",csTmp));
							PutField_CString(hRecAdd,"txn_amount",csTmp);
						}

/* bank_charge */
						sprintf(csTag, "%s_bank_charge_%d", PD_DETAIL_TAG, i+1);
						if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::bank_charge = [%s]\n",csTmp));
							PutField_CString(hRecAdd,"bank_charge",csTmp);
						}

DEBUGLOG(("Authorize() call DBOLStatementTmp(AddDetail)::Add()\n"));

                                		DBObjPtr = CreateObj(DBPtr, "DBOLStatementTmp", "AddDetail");
                                		iRet = (unsigned long)(*DBObjPtr)(hRecAdd);
                                		if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(AddDetail)::Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: AddDetail() FAILURE!!!\n");
                                		}
                        		}


/*---------------Save Statement Header into global---------------*/
					if (iRet == PD_OK) {

/* split_count */
DEBUGLOG(("Authorize() SaveHeader::split_count = [%d]\n",iSplitCount));

/* add_count */
DEBUGLOG(("Authorize() SaveHeader::add_count = [%d]\n",iAddCount));

/* update_count */
                                		iUpdateCount++;
DEBUGLOG(("Authorize() SaveHeader::update_count = [%d]\n",iUpdateCount));

/* delete_count */
DEBUGLOG(("Authorize() SaveHeader::delete_count = [%d]\n",iDeleteCount));

/* file_count */
                                		iFileCount = iSplitCount + iAddCount - iDeleteCount;
DEBUGLOG(("Authorize() SaveHeader::file_count = [%d]\n",iFileCount));

					}
				}
                		else {
                        		iRet = INT_FILE_ID_NOT_FOUND;
DEBUGLOG(("Authorize() call DBOLStatement::File Not Exist()!!! \n"));
ERRLOG("TxnOmtByUsBSE::Authorize::ValidateProcess::CheckFileIdExist:: failed!!!\n");
                		}
			}
			else if ((iRet == PD_OK) && (cAction == PD_ACTION_ADD)) {	

/*------------------------------------------------------Add Record------------------------------------------------------*/
DEBUGLOG(("Authorize() AddRecord()\n"));

DEBUGLOG(("Authorize() CheckFileIdExist()\n"));

				snprintf(csTag,sizeof(csTag),"%s",csFileId);
DEBUGLOG(("Authorize() file_id = [%s]\n",csTag));

#if 0
                		DBObjPtr = CreateObj(DBPtr,"DBOLStatement","CheckFileIdExist");
				if ((unsigned long)(*DBObjPtr)(csTag) == FOUND)
#endif
				{

/*-----------------------------------Add Record::File Exist-----------------------------------*/
DEBUGLOG(("Authorize() call DBOLStatement(CheckFileIdExist)::File Exist()!!!\n"));

/*---------------Get Statement Tmp (Laat Seq Record) Detail---------------*/
					DBObjPtr = CreateObj(DBPtr,"DBOLStatementTmp","GetLastSeqRecDetail");
                			iRet = (unsigned long)(*DBObjPtr)(csFileId,hRecGet);
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastSeqRecDetail)::iRet = [%d]\n",iRet));

                			if (iRet == PD_OK) {		

/* seq */
						if (GetField_Int(hRecGet,"seq",&iSeq)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastSeqRecDetail)::seq = [%d]\n",iSeq));
        	                		}

#if 0
/* sys_seq */
						if (GetField_Int(hRecGet,"sys_seq",&iSysSeq)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastSeqRecDetail)::sys_seq = [%d]\n",iSysSeq));
                        			}
#endif

#if 0
/* user_seq */
						if (GetField_Int(hRecGet,"user_seq",&iUserSeq)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastSeqRecDetail)::user_seq = [%d]\n",iUserSeq));
                        			}
#endif

/* int_bank_code */
                                             	if (GetField_CString(hRecGet,"int_bank_code",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastSeqRecDetail)::int_bank_code = [%s]\n",csTmp));
                                                      	PutField_CString(hRecAdd, "int_bank_code",csTmp);
                                              	}

/* bank_acct_num */
                                               	if (GetField_CString(hRecGet,"bank_acct_num",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetLastSeqRecDetail)::bank_acct_num = [%s]\n",csTmp));
                                               		PutField_CString(hRecAdd, "bank_acct_num",csTmp);
                                       		}

					} else {
						iRet = INT_ERR;
DEBUGLOG(("Authorize:: call DBOLStatementTmp(GetLastSeqRecDetail):: failed\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() DBOLStatementTmp:: GetLastSeqRecDetail() failed!!!\n");
					}

/*---------------Add Statement Tmp Detail---------------*/
					if (iRet == PD_OK) {

/* file_id */
						PutField_CString(hRecAdd,"file_id",csFileId);
DEBUGLOG(("Authorize() AddDetail::file_id = [%s]\n",csFileId));

/* seq */
						iSeq++;												
						PutField_Int(hRecAdd, "seq",iSeq);
DEBUGLOG(("Authorize() AddDetail::seq = [%d]\n", iSeq));

/* ver */
						iVer = iHeaderVer;
						PutField_Int(hRecAdd, "ver",iVer);		
DEBUGLOG(("Authorize() AddDetail::ver = [%d]\n",iVer));

#if 0
/* latest_ver */
						iLatestVer = 0;
						PutField_Int(hRecAdd, "latest_ver",iLatestVer);		
DEBUGLOG(("Authorize() AddDetail::latest_ver = [%d]\n",iLatestVer));
#endif

/* disabled */
                                                iDisabled = 0;
                                                PutField_Int(hRecAdd, "disabled",iDisabled);
DEBUGLOG(("Authorize() AddDetail::disabled = [%d]\n",iDisabled));

#if 0	
/* user_seq */
						sprintf(csTag, "%s_user_seq_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
                                        		iUserSeq = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::user_seq = [%d]\n", iUserSeq));
                                        		PutField_Int(hRecAdd, "user_seq",iUserSeq);
                                		}
#endif

#if 0
/* sys_seq */
                                                iSysSeq = iUserSeq;
                                                PutField_Int(hRecAdd, "sys_seq",iSysSeq);
DEBUGLOG(("Authorize() AddDetail::sys_seq = [%d]\n",iSysSeq));
#endif

/* skip */
						iSkip = 0;
                                              	PutField_Int(hRecAdd, "skip",iSkip);
DEBUGLOG(("Authorize() AddDetail::skip = [%d]\n", iSkip));

#if 0
/* mask_skip */
						sprintf(csTag, "%s_mask_skip_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
                                        		iTmp = atoi(csTmp);
DEBUGLOG(("Authorize() AddDetail::mask_skip = [%d]\n", iTmp));
                                        		PutField_Int(hRecAdd, "mask_skip",iTmp);
                                		}
#endif

#if 0
/* raw_date */
						sprintf(csTag, "%s_statement_date_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::raw_date = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"raw_date",csTmp);
                                		}

/* raw_time */
						sprintf(csTag, "%s_statement_time_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::raw_time = [%s]\n", csTmp));
                                       	 		PutField_CString(hRecAdd,"raw_time",csTmp);
						}
#endif

#if 1
/* statement_date */
						sprintf(csTag, "%s_statement_date_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::statement_date = [%s]\n", csTmp));
                                       			PutField_CString(hRecAdd,"statement_date",csTmp);
                                		}

/* statement_time */
						sprintf(csTag, "%s_statement_time_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::statement_time = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"statement_time",csTmp);
                                		}
#endif

/* tfr_bank_name */
						sprintf(csTag, "%s_tfr_bank_name_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_bank_name = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"tfr_bank_name",csTmp);
                                		}

/* tfr_bank_acct_num */
						sprintf(csTag, "%s_tfr_bank_acct_num_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_bank_acct_num = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"tfr_bank_acct_num",csTmp);
                                		}

/* tfr_type */
						sprintf(csTag, "%s_tfr_type_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_type = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"tfr_type",csTmp);
                                		}

/* tfr_channel */
						sprintf(csTag, "%s_tfr_channel_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_channel = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"tfr_channel",csTmp);
                                		}

/* tft_text */
						sprintf(csTag, "%s_tfr_text_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_text = [%s]\n", csTmp));
                                        		PutField_CString(hRecAdd,"tfr_text",csTmp);
                                		}

/* tfr_customer_text */
						sprintf(csTag, "%s_tfr_customer_text_%d", PD_DETAIL_TAG, i+1);
                   		             	if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::tfr_customer_text = [%s]\n",csTmp));
                        		                PutField_CString(hRecAdd,"tfr_customer_text",csTmp);
                                		}

/* tfr_sender_name */
						sprintf(csTag, "%s_tfr_sender_name_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::sender_name = [%s]\n",csTmp));
                                        		PutField_CString(hRecAdd,"sender_name",csTmp);
                                		}

/* txn_ref_num */
						sprintf(csTag, "%s_txn_ref_num_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::txn_ref_num = [%s]\n",csTmp));
                                        		PutField_CString(hRecAdd,"txn_ref_num",csTmp);
                                		}

/* balance */
						sprintf(csTag, "%s_balance_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::balance = [%s]\n",csTmp));
                                        		PutField_CString(hRecAdd,"balance",csTmp);
                                		}

/* amt_type */
						sprintf(csTag, "%s_amt_type_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::amt_type = [%s]\n",csTmp));
                                		        PutField_CString(hRecAdd,"amt_type",csTmp);
                                		}

/* txn_amount */
						sprintf(csTag, "%s_txn_amount_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::txn_amount = [%s]\n",csTmp));
							PutField_CString(hRecAdd,"txn_amount",csTmp);
						}

/* bank_charge */
						sprintf(csTag, "%s_bank_charge_%d", PD_DETAIL_TAG, i+1);
                                		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
DEBUGLOG(("Authorize() AddDetail::bank_charge = [%s]\n",csTmp));
                                        		PutField_CString(hRecAdd,"bank_charge",csTmp);
                                		}

DEBUGLOG(("Authorize() call DBOLStatementTmp(AddDetail)::Add()\n"));

                        			DBObjPtr = CreateObj(DBPtr, "DBOLStatementTmp", "AddDetail");
                        			iRet = (unsigned long)(*DBObjPtr)(hRecAdd);
                        			if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(AddDetail)::Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: AddDetail() FAILURE!!!\n");
						}
					}
			
/*---------------Get Statement Tmp (First Seq Record) Detail---------------*/
                        		if (iRet == PD_OK) {

                                		DBObjPtr = CreateObj(DBPtr,"DBOLStatementTmp","GetFirstSeqRecDetail");
                                		iRet = (unsigned long)(*DBObjPtr)(csFileId,hRecGet);
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetFirstSeqRecDetail)::iRet = [%d]\n",iRet));

                               			 if (iRet == PD_OK) {

/* create_user */
                                        		if (GetField_CString(hRecGet, "create_user", &csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetFirstSeqRecDetail)::create_user = [%s]\n", csTmp));
                                				PutField_CString(hRecUpdate,"create_user",csTmp);
                                        		}

/* create_timestamp */
                                        		if (GetField_CString(hRecGet, "create_timestamp", &csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetFirstSeqRecDetail)::create_timestamp = [%s]\n", csTmp));
                                				PutField_CString(hRecUpdate,"create_timestamp",csTmp);
                                        		}

                                		} else {
                                        		iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatementTmp(GetFirstSeqRecDetail):: failed\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: GetFirstSeqRecDetail() failed!!!\n");
                                		}
                        		}

/*---------------Update Statement Tmp Detail---------------*/
                        		if (iRet == PD_OK) {

/* file_id */
                                		PutField_CString(hRecUpdate,"file_id",csFileId);
DEBUGLOG(("Authorize() UpdateUserTimestampDetail::file_id = [%s]\n",csFileId));

/* seq */
                                		PutField_Int(hRecUpdate, "seq",iSeq);
DEBUGLOG(("Authorize() UpdateUserTimestampDetail::seq = [%d]\n",iSeq));

/* ver */
                                		PutField_Int(hRecUpdate, "ver",iVer);
DEBUGLOG(("Authorize() UpdateUserTimestampDetail::ver = [%d]\n",iVer));

DEBUGLOG(("Authorize() call DBOLStatementTmp(UpdateUserTimestampDetail)::Update()\n"));

                                		DBObjPtr = CreateObj(DBPtr, "DBOLStatementTmp", "UpdateUserTimestampDetail");
                                		iRet = (unsigned long)(*DBObjPtr)(hRecUpdate);
                                		if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatementTmp(UpdateUserTimestampDetail)::Update() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatementTmp:: UpdateUserTimestampDetail() FAILURE!!!\n");
                                		}

                        		}

/*---------------Add Order Detail---------------*/
                                        if (iRet == PD_OK) {

						sprintf(csTag, "%s_seq_%d", PD_DETAIL_TAG, i+1);
                                                if (GetField_CString(hRecTemp, csTag, &csOrderSeq)) {
DEBUGLOG(("Authorize() AddOrderDetail::order_seq = [%s]\n", csOrderSeq));
                                                }
						
						sprintf(csTag, "%s_ver_%d", PD_DETAIL_TAG, i+1);
                                                if (GetField_CString(hRecTemp, csTag, &csOrderVer)) {
DEBUGLOG(("Authorize() AddOrderDetail::order_ver = [%s]\n", csOrderVer));
                                                }
	
						sprintf(csTag, "%s_%s_%s", csFileId, csOrderSeq, csOrderVer);
						sprintf(csTmp, "%s_%d_%d", csFileId, iSeq, iVer);
						PutField_CString(hRecOrder,csTag,csTmp);  
DEBUGLOG(("Authorize() AddOrderDetail::%s = [%s]\n", csTag,csTmp));
	
						sprintf(csTag, "%s_%s_%s_file_id", csFileId, csOrderSeq, csOrderVer);
                                                sprintf(csTmp, "%s", csFileId);
						PutField_CString(hRecOrder,csTag,csTmp);
DEBUGLOG(("Authorize() AddOrderDetail::%s = [%s]\n", csTag,csTmp));

						sprintf(csTag, "%s_%s_%s_seq", csFileId, csOrderSeq, csOrderVer);
						sprintf(csTmp, "%d", iSeq);
						PutField_CString(hRecOrder,csTag,csTmp);
DEBUGLOG(("Authorize() AddOrderDetail::%s = [%s]\n", csTag,csTmp));

						sprintf(csTag, "%s_%s_%s_ver", csFileId, csOrderSeq, csOrderVer);
                                                sprintf(csTmp, "%d", iVer);
						PutField_CString(hRecOrder,csTag,csTmp);
DEBUGLOG(("Authorize() AddOrderDetail::%s = [%s]\n", csTag,csTmp));

					}

/*---------------Save Statement Header into global---------------*/
					if (iRet == PD_OK) {
						
/* split_count */
DEBUGLOG(("Authorize() SaveHeader::split_count = [%d]\n",iSplitCount));

/* add_count */
                                        	iAddCount++;
DEBUGLOG(("Authorize() SaveHeader::add_count = [%d]\n",iAddCount));

/* update_count */
DEBUGLOG(("Authorize() SaveHeader::update_count = [%d]\n",iUpdateCount));

/* delete_count */
DEBUGLOG(("Authorize() SaveHeader::delete_count = [%d]\n",iDeleteCount));

/* file_count */
						iFileCount = iSplitCount + iAddCount - iDeleteCount;
DEBUGLOG(("Authorize() SaveHeader::file_count = [%d]\n",iFileCount));

					}
				}
#if 0
				else {
/*-----------------------------------Add Record::File Not Exist-----------------------------------*/
					iRet = INT_INVALID_FILE_ID; 
DEBUGLOG(("Authorize() call DBOLStatement::File Not Exist()!!! \n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatement:: File Not Exist!!!\n");                         
				}
#endif
			}
		}
	}

/*------------------------------------------------------Order Record------------------------------------------------------*/
DEBUGLOG(("Authorize() OrderRecord()\n"));
	
 	if (iRet == PD_OK) {
                for (i = 0; i < iOrderCnt; i++) {
DEBUGLOG(("Authorize() order() order_cnt = [%d]\n", i));

			hash_init(hRecGet,0);
        		hash_init(hRecUpdate,0);

			sprintf(csTag, "%s_%d", PD_ORDER_TAG, i+1);
                        if (GetField_CString(hRecTemp, csTag, &csTmp)) {				
				sprintf(csTag, "%s", csTmp);
				if (GetField_CString(hRecOrder, csTag, &csTmp)) {
DEBUGLOG(("Authorize() order() %s = [%s]\n", csTag,csTmp));					

/*---------------Get file_id and seq from hRecTemp---------------*/
/* file_id */
                        		sprintf(csTagName, "%s_file_id", csTag);
                        		if (GetField_CString(hRecOrder, csTagName, &csFileId)) {
DEBUGLOG(("Authorize() order() file_id = [%s]\n", csFileId));
                                		PutField_CString(hRecUpdate,"file_id",csFileId);
                        		} else {
                                		iRet = INT_FILE_ID_NOT_FOUND;
                                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() order() file_id not found!!!\n"));
ERRLOG("TxnOmtByUsBSE:: Authorize() order() file_id not found!!!\n");
                       			}

/* seq */
					sprintf(csTagName, "%s_seq", csTag);
                                        if (GetField_CString(hRecOrder, csTagName, &csTmp)) {
                                		iSeq = atoi(csTmp);
DEBUGLOG(("Authorize() order() seq = [%d]\n", iSeq));
                                		PutField_Int(hRecUpdate,"seq",iSeq);
                        		} else {
                                		iRet = INT_STATEMENT_SEQ_NOT_FOUND;
                                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() order() seq not found!!!\n"));
ERRLOG("TxnOmtByUsBSE:: Authorize() order() seq not found!!!\n");
                        		}
				} else {
/*---------------Get file_id and seq from hRecOrder---------------*/
/* file_id */
                        		sprintf(csTag, "%s_file_id_%d", PD_ORDER_TAG, i+1);
                        		if (GetField_CString(hRecTemp, csTag, &csFileId)) {
DEBUGLOG(("Authorize() order() file_id = [%s]\n", csFileId));
                                		PutField_CString(hRecUpdate,"file_id",csFileId);
                        		} else {
                                		iRet = INT_FILE_ID_NOT_FOUND;
                                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() order() file_id not found!!!\n"));
ERRLOG("TxnOmtByUsBSE:: Authorize() order() file_id not found!!!\n");
                        		}

/* seq */
                        		sprintf(csTag, "%s_seq_%d", PD_ORDER_TAG, i+1);
                        		if (GetField_CString(hRecTemp, csTag, &csTmp)) {
                                		iSeq = atoi(csTmp);
DEBUGLOG(("Authorize() order() seq = [%d]\n", iSeq));
                                		PutField_Int(hRecUpdate,"seq",iSeq);
                        		} else {
                                		iRet = INT_STATEMENT_SEQ_NOT_FOUND;
                                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() order() seq not found!!!\n"));
ERRLOG("TxnOmtByUsBSE:: Authorize() order() seq not found!!!\n");
                        		}
				}
			}

/*---------------Get user_seq from hRecTemp---------------*/
			if (iRet == PD_OK) {
/* user_seq */
                        	sprintf(csTag, "%s_user_seq_%d", PD_ORDER_TAG, i+1);
                        	if (GetField_Int(hRecTemp, csTag, &iUserSeq)) {
DEBUGLOG(("Authorize() order() user_seq = [%d]\n", iUserSeq));
                                	PutField_Int(hRecUpdate,"user_seq",iUserSeq);
                        	}
			}

/*---------------Get ver from DB GetLastVerRecDetail---------------*/
			if (iRet == PD_OK) {
                        	DBObjPtr = CreateObj(DBPtr,"DBOLStatementTmp","GetLastVerRecDetail");
                            	iRet = (unsigned long)(*DBObjPtr)(csFileId,iSeq,hRecGet);
DEBUGLOG(("Authorize() order() call DBOLStatementTmp(GetLastVerRecDetail)::iRet = [%d]\n",iRet));

                           	if (iRet == PD_OK) {
/* ver */
                              		if (GetField_Int(hRecGet,"ver",&iLastVer)) {
DEBUGLOG(("Authorize() order() call DBOLStatementTmp(GetLastVerRecDetail)::ver = [%d]\n",iLastVer));
                                       	}

				} else {
                                 	iRet = INT_ERR;
DEBUGLOG(("Authorize() order() call DBOLStatementTmp(GetLastVerRecDetail):: failed\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() order() call DBOLStatementTmp:: GetLastVerRecDetail() failed!!!\n");
                           	}
			}

/*---------------Update Statement Tmp Seq Deatil---------------*/
		  	if (iRet == PD_OK) {

/* file_id */
                           	PutField_CString(hRecUpdate,"file_id",csFileId);
DEBUGLOG(("Authorize() order() UpdateSeqDetail::file_id = [%s]\n",csFileId));

/* seq */
                           	PutField_Int(hRecUpdate, "seq",iSeq);
DEBUGLOG(("Authorize() order() UpdateSeqDetail::seq = [%d]\n",iSeq));

/* ver */
                           	PutField_Int(hRecUpdate, "ver",iLastVer);
DEBUGLOG(("Authorize() order() UpdateSeqDetail::ver = [%d]\n",iLastVer));

/* sys_seq */
                                iSysSeq = iUserSeq;
                                PutField_Int(hRecUpdate,"sys_seq",iSysSeq);
DEBUGLOG(("Authorize() order() UpdateSeqDetail::sys_seq = [%d]\n",iSysSeq));

/* user_seq */
                            	PutField_Int(hRecUpdate,"user_seq",iUserSeq);
DEBUGLOG(("Authorize() order() UpdateSeqDetail::user_seq = [%d]\n",iUserSeq));

DEBUGLOG(("Authorize() order() call DBOLStatementTmp(UpdateSeqDetail)::Update()\n"));

                          	DBObjPtr = CreateObj(DBPtr, "DBOLStatementTmp", "UpdateSeqDetail");
                            	iRet = (unsigned long)(*DBObjPtr)(hRecUpdate);
                             	if (iRet != PD_OK) {
DEBUGLOG(("Authorize() order() call DBOLStatementTmp(UpdateSeqDetail)::Update() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() order() call DBOLStatementTmp:: UpdateSeqDetail() FAILURE!!!\n");
                             	}

                      	}
		}
	}	

/*----------------------------------------------------------------Update Header and Re-Upload Bank Statement----------------------------------------------------------------*/
#if 0
/* Get Statement Header*/
	if (iRet == PD_OK) {
		
		hash_init(hRecGet,0);
        	hash_init(hRecUpdate,0);

DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::csFileId = [%s]\n",csFileId));
                DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "GetHeader");
		iRet = (unsigned long)(*DBObjPtr)(csFileId,hRecGet);
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::iRet = [%d]\n",iRet));
                if (iRet != PD_OK) {
                        iRet = INT_INVALID_TXN;
                        PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader):: FAILURE\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatement:: GetHeader() FAILURE!!!\n");
                } else {
                        if (!GetField_CString(hRecGet,"filename",&csTmp)) {
                                iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader):: filename NOT FOUND!!!\n"));
                        } else if (!GetField_CString(hRecGet,"int_bank_code",&csTmp)) {
                                iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader):: int_bank_code NOT FOUND!!!\n"));
                        } else if (!GetField_CString(hRecGet,"bank_acct_num",&csTmp)) {
                                iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader):: bank_acct_num NOT FOUND!!!\n"));
                        } else if (!GetField_CString(hRecGet,"baid",&csTmp)) {
                                iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader):: baid NOT FOUND!!!\n"));
                        } else if (!GetField_CString(hRecGet,"format_id",&csTmp)) {
                                iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader):: format_id NOT FOUND!!!\n"));
                        } else if (!GetField_Double(hRecGet,"message_code",&dTmp)) {
                                iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader):: message_code NOT FOUND!!!\n"));
                        } else if (!GetField_Int(hRecGet,"ver",&iTmp)) {
                                iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader):: ver NOT FOUND!!!\n"));
                        } else if (!GetField_Char(hRecGet,"status",&cTmp)) {
                                iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader):: status NOT FOUND!!!\n"));
                        } else {
#if 0
                                if (cTmp != PD_STMT_PENDING) {
                                        iRet = INT_INVALID_TXN;
                                        PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader):: status NOT SUPPORT!!!\n"));
                                }
#endif
                        }

/* filename */
			if (GetField_CString(hRecGet,"filename",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::filename = [%s]\n",csTmp));
                        }

/* int_bank_code */
			if (GetField_CString(hRecGet,"int_bank_code",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::int_bank_code = [%s]\n",csTmp));
                        }

/* bank_acct_num */
			if (GetField_CString(hRecGet,"bank_acct_num",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::bank_acct_num = [%s]\n",csTmp));
                        }

/* baid */
			if (GetField_CString(hRecGet,"baid",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::baid = [%s]\n",csTmp));
                        }

/* format_id */
			if (GetField_CString(hRecGet,"format_id",&csTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::format_id = [%s]\n",csTmp));
                        }

/* message_code */
			if (GetField_Double(hRecGet,"message_code",&dTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::message_code = [%.2f]\n",dTmp));
                        }

/* status */
			if (GetField_Char(hRecGet,"status",&cTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::status = [%c]\n",cTmp));
                        }

/* skip_count */
                        if (GetField_Int(hRecGet,"skip_count",&iTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::skip_count = [%d]\n",iTmp));
                     	}

/* hold_count */
                      	if (GetField_Int(hRecGet,"hold_count",&iTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::hold_count = [%d]\n",iTmp));
                    	}

/* accept_count */
                  	if (GetField_Int(hRecGet,"accept_count",&iTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::accept_count = [%d]\n",iTmp));
                    	}

/* total_count */
                    	if (GetField_Int(hRecGet,"total_count",&iTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::total_count = [%d]\n",iTmp));
                   	}

/* split_count */
                  	if (GetField_Int(hRecGet,"split_count",&iTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::split_count = [%d]\n",iTmp));
				iSplitCount += iTmp;
				PutField_Int(hRecUpdate,"split_count",iSplitCount);
                     	}

/* add_count */
                  	if (GetField_Int(hRecGet,"add_count",&iTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::add_count = [%d]\n",iTmp));
				iAddCount += iTmp;
				PutField_Int(hRecUpdate,"add_count",iAddCount);
                    	}

/* update_count */
                    	if (GetField_Int(hRecGet,"update_count",&iTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::update_count = [%d]\n",iTmp));
				iUpdateCount += iTmp;
                   		PutField_Int(hRecUpdate,"update_count",iUpdateCount);
			}

/* delete_count */
                    	if (GetField_Int(hRecGet,"delete_count",&iTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::delete_count = [%d]\n",iTmp));
				iDeleteCount += iTmp;
                                PutField_Int(hRecUpdate,"delete_count",iDeleteCount);
                     	}

/* file_count */
                     	if (GetField_Int(hRecGet,"file_count",&iTmp)) {
DEBUGLOG(("Authorize() call DBOLStatement(GetHeader)::file_count = [%d]\n",iTmp));
				iFileCount += iTmp;
                                PutField_Int(hRecUpdate,"file_count",iFileCount);
                     	}
                }
        }

	/* Get BAID */
	
	/* Get country */

	/* Get acct_ccy, sys_switch, restricted */

	/* Check bank acct status */

	/* Get bank_acct_type */
	
	/* Get stmt file format */	

	/* Process Stmt Tmp */

	/* Process Stmt Detail */

/* result */
	PutField_Int(hRecUpdate,"message_code",iRet);

	if (iRet == PD_OK) {
/* Success */

/* status */
		PutField_Char(hRecUpdate,"status",PD_STMT_APPROVED);

/* Txn Commit */
               	//TxnCommit();
DEBUGLOG(("Authorize() call TxnCommit()\n"));
        }
        else {
/* Failure */

/* Txn Abort */
               	//TxnAbort();
DEBUGLOG(("Authorize() call TxnAbort()\n"));

		if (GetField_Int(hContext,"result_cnt",&iTmp)) {
/* status */
			PutField_Char(hRecUpdate,"status",PD_STMT_PENDING);

/* Add Error */
DEBUGLOG(("Authorize() call DBOLStatementTmp(DBOLStatementTmp)::AddError()\n"));

                     	DBObjPtr = CreateObj(DBPtr, "DBOLStatementTmp", "AddError");
                       	iRet = (unsigned long)(*DBObjPtr)(hContext);
                      	if (iRet != PD_OK) {
                           	iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement(DBOLStatementTmp)::AddError() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSC::Authorize() call DBOLStatementTmp::AddError() FAILURE!!!\n");
                     	} else {
                           	RemoveField_Int(hContext,"internal_error");
                    	}
		} else {
/* status */
                        PutField_Char(hRecUpdate,"status",PD_STMT_DECLINED);		
		}
        }

/* Update Header */
       	if (iRet == PD_OK) {

/* file_id */
                PutField_CString(hRecUpdate, "file_id",csFileId);
DEBUGLOG(("Authorize() UpdateHeader::file_id = [%s]\n",csFileId));

/* header_ver */
DEBUGLOG(("Authorize() UpdateHeader::header_ver = [%d]\n",iHeaderVer));

/* split_count */
DEBUGLOG(("Authorize() UpdateHeader::split_count = [%d]\n",iSplitCount));

/* add_count */
DEBUGLOG(("Authorize() UpdateHeader::add_count = [%d]\n",iAddCount));

/* update_count */
DEBUGLOG(("Authorize() UpdateHeader::update_count = [%d]\n",iUpdateCount));

/* delete_count */
DEBUGLOG(("Authorize() UpdateHeader::delete_count = [%d]\n",iDeleteCount));

/* file_count */
DEBUGLOG(("Authorize() UpdateHeader::file_count = [%d]\n",iFileCount));

/* update_user */
             	PutField_CString(hRecUpdate,"update_user",csUser);
DEBUGLOG(("Authorize() UpdateHeader::update_user = [%s]\n",csUser));

DEBUGLOG(("Authorize() call DBOLStatement(DBOLStatement)::UpdateHeader()\n"));

             	DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "UpdateHeader");
              	iRet = (unsigned long)(*DBObjPtr)(hRecUpdate);
               	if (iRet != PD_OK) {
                 	iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement(DBOLStatement)::UpdateHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatement:: UpdateHeader() FAILURE!!!\n");
               	}
       	}

	/* Update Stmt Tmp */	

#else
	/* Update Header */
        if (iRet == PD_OK) {

/* file_id */
                PutField_CString(hRecUpdate, "file_id",csFileId);
DEBUGLOG(("Authorize() UpdateHeader::file_id = [%s]\n",csFileId));

/* header_ver */
		PutField_Int(hRecUpdate, "ver",iHeaderVer);
DEBUGLOG(("Authorize() UpdateHeader::header_ver = [%d]\n",iHeaderVer));

/* update_user */
                PutField_CString(hRecUpdate,"update_user",csUser);
DEBUGLOG(("Authorize() UpdateHeader::update_user = [%s]\n",csUser));

DEBUGLOG(("Authorize() call DBOLStatement(DBOLStatement)::UpdateHeader()\n"));

                DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "UpdateHeader");
                iRet = (unsigned long)(*DBObjPtr)(hRecUpdate);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement(DBOLStatement)::UpdateHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSE::Authorize() call DBOLStatement:: UpdateHeader() FAILURE!!!\n");
                }
        }
#endif

/*----------------------------------------------------------------Results----------------------------------------------------------------*/
	if (iRet != PD_OK) {
		PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() internal_error! iRet = [%d]\n", iRet));
	}

	PutField_Int(hResponse,"ret",iRet);
	
	FREE_ME(csData);
        FREE_ME(csDataCode);
        FREE_ME(csKey);
        FREE_ME(csKeyCode);

	hash_destroy(hRecTemp);
        FREE_ME(hRecTemp);
	hash_destroy(hRecOrder);
	FREE_ME(hRecOrder);

	hash_destroy(hRecGet);
	FREE_ME(hRecGet);
	hash_destroy(hRecAdd);
        FREE_ME(hRecAdd);
	hash_destroy(hRecUpdate);
        FREE_ME(hRecUpdate);

DEBUGLOG(("Authorize() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;
}
