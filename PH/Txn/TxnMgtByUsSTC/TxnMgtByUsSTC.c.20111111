/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/07/08              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsSTC.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnMgtByUsSTC(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;

	char	*csTxnSeq;
	char	*csTxnCcy;
	char	*csTxnCountry;
	char	*csServiceCode;
	char	*csMerchantId;
	char	*csTmp;
	char	cTmp;
	double	dAmt;
	double	dNetAmt;
	hash_t	*hRec;
	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("Authorize\n"));
/*
	hash_t  *hReq;
	hReq = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hReq,0);
*/
	if(GetField_CString(hRequest,"org_txn_seq",&csTxnSeq)){
DEBUGLOG(("Authorize::txn_seq= [%s]\n",csTxnSeq));
		//PutField_CString(hReq,"txn_seq",csTxnSeq);
		PutField_CString(hContext,"txn_seq",csTxnSeq);
	}
	else{
DEBUGLOG(("Authorize::txnid not found!!\n"));
ERRLOG("TxnMgtByUsSTC:Authorize::txnid not found!!\n");
		iRet=INT_INVALID_TXN;
	}

	
	if(GetField_CString(hRequest,"add_user",&csTmp)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csTmp));
		PutField_CString(hContext,"update_user",csTmp);
		//PutField_CString(hReq,"update_user",csTmp);
	}


	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:GetTxnHeader\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
		if ((*DBObjPtr)(csTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("GetTxnHeader::found record = [%s]\n",csTxnSeq));
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec,"merchant_id",&csMerchantId)) {
        	        		//PutField_CString(hContext,"merchant_id",csMerchantId);
DEBUGLOG(("GetTxnHeader::merchant_id = [%s]\n",csMerchantId));
				}
				if (GetField_CString(hRec,"service_code",&csServiceCode)) {
        	        		//PutField_CString(hContext,"service_code",csServiceCode);
DEBUGLOG(("GetTxnHeader::service_code= [%s]\n",csServiceCode));
				}
				if (GetField_Double(hRec,"txn_amt",&dAmt)) {
					//PutField_Double(hReq,"txn_amt",dAmt);
DEBUGLOG(("GetTxnHeader::txn_amt = [%lf]\n",dAmt));
				}
				if (GetField_Double(hRec,"net_amt",&dNetAmt)) {
					//PutField_Double(hContext,"txn_amt",dNetAmt);
DEBUGLOG(("GetTxnHeader::net_amt = [%lf]\n",dNetAmt));
				}
				if (GetField_Char(hRec,"status",&cTmp)) {
DEBUGLOG(("GetTxnHeader::status = [%c]\n",cTmp));
					if(cTmp!=PD_PROCESSING){
						iRet=INT_INVALID_TXN;
DEBUGLOG(("GetTxnHeader::Invalid status\n"));
ERRLOG("TxnMgtByUsSTC:GetTxnHeader::Invalid status!!\n");
					}

				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		else{
DEBUGLOG(("GetTxnHeader:: not found record for [%s]\n",csTxnSeq));
ERRLOG("TxnMgtByUsSTC:Authorize::GetTxnHeader::not found record!!\n");
			iRet=INT_NOT_RECORD;
		}

	}
	RecordSet_Destroy(rRecordSet);

	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:GetTxnDetail\n"));
        	recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
        	if ((*DBObjPtr)(csTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("GetTxnDetail::found record = [%s]\n",csTxnSeq));
               		hRec = RecordSet_GetFirst(rRecordSet);
                	while (hRec) {
                        	if (GetField_CString(hRec,"txn_ccy",&csTxnCcy)) {
					//PutField_CString(hContext,"txn_ccy",csTxnCcy);
DEBUGLOG(("GetTxnDetail::txn_ccy = [%s]\n",csTxnCcy));
                        	}
                        	if (GetField_CString(hRec,"txn_country",&csTxnCountry)) {
        	        		//PutField_CString(hContext,"txn_country",csTxnCountry);
DEBUGLOG(("GetTxnDetail::txn_country = [%s]\n",csTxnCountry));
                        	}
                        	hRec = RecordSet_GetNext(rRecordSet);
                	}
        	}
        	else {
DEBUGLOG(("GetTxnDetail:: not found record for [%s]\n",csTxnSeq));
ERRLOG("TxnMgtByUsSTC:Authorize::GetTxnDetail:: not found record!!\n");
               		iRet = INT_NOT_RECORD;
        	}
        	RecordSet_Destroy(rRecordSet);
	}

	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBMerchantSettlementDetail:GetSettlementDetail\n"));
        	recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBMerchantSettlementDetail","GetSettlementDetail");
		if((unsigned long)(*DBObjPtr)(csTxnSeq,rRecordSet)==PD_OK){
DEBUGLOG(("GetSettlementDetail::found record = [%s]\n",csTxnSeq));
			hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
				if (GetField_Char(hRec,"status",&cTmp)) {
DEBUGLOG(("GetSettlementDetail::status = [%c]\n",cTmp));
					if(cTmp!=PD_PROCESSING){
						iRet=INT_INVALID_TXN;
DEBUGLOG(("GetSettlementDetail::Invalid status\n"));
ERRLOG("TxnMgtByUsSTC:Authorize::GetSettlementDetail::Invalid status!!\n");
					}
				}
                        	hRec = RecordSet_GetNext(rRecordSet);
			}
		}
		else{
DEBUGLOG(("GetSettlementDetail:: not found record for [%s]\n",csTxnSeq));
ERRLOG("TxnMgtByUsSTC:Authorize::GetSettlementDetail::not found record!!\n");
                        iRet = INT_NOT_RECORD;
		}
        	RecordSet_Destroy(rRecordSet);
	}

	


	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:UpdateDetail\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK)
			iRet = INT_ERR;
	}


/*
	if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBMerchantSettlementDetail:Update\n"));
                //PutField_Char(hReq,"status",'X');
                DBObjPtr = CreateObj(DBPtr,"DBMerchantSettlementDetail","Update");
                if((unsigned long) ((*DBObjPtr)(hReq))!=PD_OK)
			iRet = INT_ERR;
        }
*/
	if(iRet!=PD_OK){
                PutField_Int(hContext,"internal_error",iRet);
        }

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
	//FREE_ME(hReq);
DEBUGLOG(("TxnMgtByUsSTC Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}
