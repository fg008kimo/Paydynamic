/*
Partnerdelight (c)2014. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/01/14              Dirk Wong
Update						   2015/05/04		   Elvis Wong
Add manual_hold_recon to NewStmtTxn	   	   2015/09/09		   Elvis Wong
Add CheckIsBalTransInterBatch                      2015/12/30              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsRBT.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"
#include "dbutility.h"

#define PD_DEFAULT_DATE_FORMAT          "%Y%m%d"
#define PD_DEFAULT_DATETIME_FORMAT      "%Y%m%d%H%M%S"

#define PD_TXN_TYPE_LEN			50
#define PD_TXN_TYPE_GENERAL		"GENERAL"
#define PD_TXN_TYPE_BAL_TRF_INTRA	"BAL_TRF_INTRA"
#define PD_TXN_TYPE_BAL_TRF_INTER       "BAL_TRF_INTER"
#define PD_TXN_TYPE_HOLD_DEPOSIT	"HOLD_DEPOSIT"
#define PD_TXN_TYPE_PSP_SETTLEMENT	"PSP_SETTLEMENT"
#define PD_TXN_TYPE_PROVIDER_CHARGE	"PROVIDER_CHARGE"
#define PD_TXN_TYPE_SMS_BANK_DEPOSIT	"SMS_BANK_DEPOSIT"

#define PD_BATCH_DESC_ORDER_FIRST_REC	0		
#define PD_BATCH_DESC_ORDER_LAST_REC	1		

#define PD_STMT_TXN_ACTION_GEN_NEW_ID		0
#define PD_STMT_TXN_ACTION_KEEP_ORG_ID		1
#define PD_STMT_TXN_ACTION_CHANGE_ORG_STATUS	2

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

char	csTxnType[PD_TXN_TYPE_LEN + 1];
int 	iAction = PD_BATCH_ACTION_CANCEL;
int	iIsOrgBatchIdP1Void = PD_FALSE;
int	iIsOrgBatchIdP2Voided = PD_TRUE;
int	iNumOfBatchId = 0;	

int     AddTxnRelation(hash_t* hRls);
int     AddBatchTxnRelation(hash_t* hRls);
int     AddBatchRelation(hash_t* hRls);

int     GetBankAcctType(const char* csTxnId, hash_t* hBankAcctTypeRec);
int     GetBaidCategory(const char* csTxnId, hash_t* hBaidCategoryRec);
int	GetTxnHeaderInfo(const char* csTxnId, hash_t* hTxnHeaderRec);
int	GetBaidTxnInfo(const char* csStmtTxnId, hash_t* hBaidTxnRec);

int	GetVoidBatchIdInfo(const char* csTxnId, hash_t* hBatchIdInfo, hash_t *hContext);

int     CheckVoidTxnIdValidPSPSettlement(const char* csBatchId, const char* csTxnId, hash_t *hContext);
int     FindVoidBatchIdPSPSettlement(const char* csBatchId, const char* csTxnId, char* csFoundBatchId, char* csFoundTxnId, hash_t *hContext);
int     CheckVoidTxnIdValid(const char* csBatchId, const char* csTxnId, hash_t *hContext);
int     FindVoidBatchId(const char* csBatchId, const char* csTxnId, char* csFoundBatchId, char* csFoundTxnId, hash_t *hContext);

int 	GetBatchTypeInfo(const char* csBatchId, hash_t* hBatchTypeInfo, hash_t *hContext);
int	GetPrevBatchIdByReviveTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csPrevBatchId, char* csPrevTxnId, hash_t *hContext);
int	GetNextBatchIdByReviveTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csNextBatchId, char* csNextTxnId, hash_t *hContext);
int	GetPrevBatchIdByMultiBatchTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csPrevBatchId, char* csPrevTxnId, hash_t *hContext);
int	GetNextBatchIdByMultiBatchTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csNextBatchId, char* csNextTxnId, hash_t *hContext);
int	GetPrevBatchIdByBatchRelation(const char* csBatchId, const char* csTxnId, char* csPrevBatchId, hash_t *hContext);
int	GetNextBatchIdByBatchRelation(const char* csBatchId, const char* csTxnId, char* csNextBatchId, hash_t *hContext);
int	GetLastTxnIdByRTDescOrder(const char* csBatchId, char* csLastTxnId, hash_t *hContext);
int     IsInputTxnId(const char* csBatchId, const char* csTxnId, hash_t *hContext);
int     IsReviveTxnId(const char* csBatchId, const char* csTxnId, hash_t *hContext);
int     IsVoidTxnCodeTxnId(const char* csTxnId, hash_t *hContext);
int     IsOffsetTxnId(const char* csTxnId, hash_t *hContext);
int	IsMultiBatchTxnId(const char* csTxnId, hash_t *hContext);
int	IsP1VoidTxnId(const char* csTxnId, hash_t *hContext);
int	IsP2VoidedTxnId(const char* csTxnId, hash_t *hContext);
int	IsP1VoidBatchId(const char* csBatchId, hash_t *hContext);
int	IsP2VoidedBatchId(const char* csBatchId, hash_t *hContext);

int	CheckActionByTxnId(const char* csTxnId, hash_t *hTxnHeaderRec, hash_t *hContext);

int     IsPutTxnIdToBatch(const char* csTxnId, hash_t* hTxnHeaderRec);

int     ProcessOffset(const char* csOrgTxnSeq, hash_t* hOrgTxn, hash_t* hNewTxn, hash_t *hContext);
int  	GetTxnInfo(const char *csTxnSeq, hash_t *hContext, hash_t *hTxn);
int	FormNewTxn(int iIsLastTxn, hash_t *hOrgTxn, hash_t *hOfstTxn, hash_t *hContext);
int	ProcessNewTxn(int iIsLastTxn, hash_t *hOfstTxn, hash_t *hContext);
int	ProcessOrgTxn(hash_t *hOrgTxn, hash_t *hContext);
int	ProcessOrgTxnSeq(const char* csOrgTxnSeq, hash_t *hContext);

int	IsCreateLastTxnId(const char *csOrgBatchId, const char* csOrgTxnSeq, hash_t* hOrgTxn, hash_t *hContext);
int     ProcessLastTxn(const char* csTxnId, hash_t* hOrgTxn, hash_t* hNewTxn, hash_t *hContext);
int     StoreP1LastTxnInfo(const char* csOrgTxnSeq, const char *csNewTxnSeq, const char *csLastTxnSeq, recordset_t *rTmpP1LastTxnRecordSet, hash_t *hTmpP1LastTxnRec, hash_t *hContext);
int     StoreP2LastTxnInfo(const char* csOrgTxnSeq, const char *csNewTxnSeq, const char *csLastTxnSeq, recordset_t *rTmpP2LastTxnRecordSet, hash_t *hTmpP2LastTxnRec, hash_t *hContext);
int	ProcessLastTxnRelation(recordset_t *rTmpP1LastTxnRecordSet, recordset_t *rTmpP2LastTxnRecordSet, recordset_t *rLastTxnRecordSet, hash_t *hLastTxnRec, hash_t *hContext);

int	AddNewTxnRelationLinkage(const char *csOrgBatchId, hash_t *hContext, hash_t *hTxnRelation);
int	AddLastTxnRelationLinkage(hash_t *hRec);

int     IsPutStmtTxnIdToBatch(const char* csStmtTxnId, hash_t* hStmtTxnRec, hash_t* hBaidTxnRec, hash_t* hStmtTxnContext);

int     ProcessStmtOffset(const char* csOrgStmtTxnSeq, const hash_t* hStmtTxnRec, hash_t *hContext);
int     GetStmtTxnInfo(const char *csOrgStmtTxnSeq, hash_t *hContext, hash_t *hStmtTxn);
int     FormNewStmtTxn(hash_t *hOrgStmtTxn, hash_t *hOfstStmtTxn, hash_t *hContext);
int     ProcessNewStmtTxn(hash_t *hOfstStmtTxn, hash_t *hContext);
int     ProcessOrgStmtTxn(hash_t *hOrgStmtTxn, hash_t *hContext);
int     ProcessOrgStmtTxnToBatchTxnRelation(hash_t *hOrgStmtTxn, hash_t *hContext);

void 	TxnOmtByUsRBT(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	int     iDtlRet = PD_FALSE;

	char    *csTmp = NULL;
	char	csTag[PD_TMP_BUF_LEN+1];

	char	*csTxnSeq = NULL;
        char    *csUser = NULL;
	
	char	*csTmpTxnSeq = NULL;
	char	*csOrgTxnSeq = NULL;
	char	*csNewTxnSeq = NULL;
	char	*csLastTxnSeq = NULL;
	
        char    *csTmpStmtTxnSeq = NULL;
	char    *csOrgStmtTxnSeq = NULL;

	char	csOrgBatchId[PD_TXN_SEQ_LEN + 1];
	char	csNewBatchId[PD_TXN_SEQ_LEN + 1];

	char	cOrgBatchType;
	char	cNewBatchType;

	char	cOrgBatchSubType;
	char	cNewBatchSubType;

        hash_t  *hTmpTxnRec = NULL;
        hash_t  *hTxnRec = NULL;
        hash_t  *hTmpStmtTxnRec = NULL;
	hash_t  *hStmtTxnRec = NULL;

	hash_t          *hOrgBatchIdInfo;
        hOrgBatchIdInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hOrgBatchIdInfo,0);

	hash_t          *hTxnHeaderRec;
       	hTxnHeaderRec = (hash_t*) malloc (sizeof(hash_t));
       	hash_init(hTxnHeaderRec,0);

	hash_t          *hBaidTxnRec;
       	hBaidTxnRec = (hash_t*) malloc (sizeof(hash_t));
       	hash_init(hBaidTxnRec,0);
	
	hash_t  *hTmpP1LastTxnRec = NULL;
        hTmpP1LastTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpP1LastTxnRec,0);

	hash_t  *hTmpP2LastTxnRec = NULL;
        hTmpP2LastTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpP2LastTxnRec,0);

	recordset_t     *rTmpP1LastTxnRecordSet;
        rTmpP1LastTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTmpP1LastTxnRecordSet,0);

	recordset_t     *rTmpP2LastTxnRecordSet;
        rTmpP2LastTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTmpP2LastTxnRecordSet,0);

	hash_t  *hLastTxnRecGet = NULL;
	hash_t  *hLastTxnRec = NULL;
	hLastTxnRec = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hLastTxnRec,0);
        recordset_t     *rLastTxnRecordSet;
        rLastTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rLastTxnRecordSet,0);

	hash_t	*hTxnContext;
	hTxnContext = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxnContext,0);
        recordset_t     *rTmpTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTmpTxnRecordSet,0);
        recordset_t     *rTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTxnRecordSet,0);

	hash_t  *hStmtTxnContext;
        hStmtTxnContext = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hStmtTxnContext,0);
        recordset_t     *rTmpStmtTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTmpStmtTxnRecordSet,0);
        recordset_t     *rStmtTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rStmtTxnRecordSet,0);

	hash_t	*hTxnRelation;
	hTxnRelation = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxnRelation,0);

	cOrgBatchType = ' ';
	cNewBatchType = ' ';
	
	cOrgBatchSubType = ' ';
	cNewBatchSubType = ' ';

DEBUGLOG(("Authorize::TxnOmtByUsRBT: START!!!!!!!!!\n"));

	// global init
	iAction = PD_BATCH_ACTION_CANCEL;
	iIsOrgBatchIdP1Void = PD_FALSE;
	iIsOrgBatchIdP2Voided = PD_TRUE;
	iNumOfBatchId = 0; 	
	sprintf(csTxnType, "%s", PD_TXN_TYPE_GENERAL);

/* txn_seq */
	if(GetField_CString(hRequest, "org_txn_seq", &csTxnSeq)) {
DEBUGLOG(("Authorize::txn_seq = [%s]\n",csTxnSeq));
		PutField_CString(hContext,"txn_seq",csTxnSeq);
		PutField_CString(hContext,"org_txn_seq",csTxnSeq);
		PutField_CString(hResponse,"org_txn_seq",csTxnSeq);
        } else {
                iRet = INT_TXN_ID_MISSING;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize: txn_id missing\n"));
ERRLOG("TxnOmtByUsRBT::Authorize: txn_id missing\n");
        }

/* remark */
	if(GetField_CString(hRequest, "remark", &csTmp)) {
DEBUGLOG(("Authorize::remark = [%s]\n",csTmp));
                PutField_CString(hContext,"remark",csTmp);
        }

/* user */
        if(GetField_CString(hRequest,"add_user",&csUser)){
DEBUGLOG(("Authorize::add_user = [%s]\n",csUser));
                PutField_CString(hContext,"update_user",csUser);
                PutField_CString(hTxnContext,"update_user",csUser);
                PutField_CString(hStmtTxnContext,"update_user",csUser);
        } else {
                iRet = INT_USER_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize: add_user missing\n"));
ERRLOG("TxnOmtByUsRBT::Authorize: add_user missing\n");
        }

/*
 *
 * Get Batch Id (Order by approval_ts ASC) 
 * - Number Of Batch
 * - Txn Type (intra-balance-transfer/hold-deposit/psp-settlement/provider-charge/general)
 * - Org Batch Id   
 *
 */	
	if (iRet == PD_OK) {
		iRet = GetVoidBatchIdInfo(csTxnSeq, hOrgBatchIdInfo, hContext);

		if (iRet == PD_OK) {

DEBUGLOG(("===== Authorize (Org Txn Id and Batch Id Info) ===== START!!\n"));

/* txn_seq */
DEBUGLOG(("Authorize: txn_seq = [%s]\n",csTxnSeq));	

/* num_of_batch */
DEBUGLOG(("Authorize: num_of_batch = [%d]\n",iNumOfBatchId));

/* csTxnType */
DEBUGLOG(("Authorize: txn_type = [%s]\n",csTxnType));

			if (iNumOfBatchId > 0) {

/* org_batch_type */
				if(GetField_Char(hOrgBatchIdInfo, "org_batch_type", &cOrgBatchType)){	
DEBUGLOG(("Authorize: org_batch_type = [%c]\n",cOrgBatchType));		
					PutField_Char(hContext,"org_batch_type",cOrgBatchType);
				}

/* org_batch_sub_type */	
				if(GetField_Char(hOrgBatchIdInfo, "org_batch_sub_type", &cOrgBatchSubType)){
DEBUGLOG(("Authorize: org_batch_sub_type = [%c]\n",cOrgBatchSubType));		
					PutField_Char(hContext,"org_batch_sub_type",cOrgBatchSubType);
				}

/* org_batch_id */
				if(GetField_CString(hOrgBatchIdInfo, "org_batch_id", &csTmp)){
					sprintf(csOrgBatchId, "%s", csTmp);
DEBUGLOG(("Authorize: org_batch_id = [%s]\n",csOrgBatchId));		
					PutField_CString(hContext,"org_batch_txn_seq",csOrgBatchId);	
				}
			}

DEBUGLOG(("===== Authorize (Org Txn Id and Batch Id Info) ===== END!!\n"));
		} else {
DEBUGLOG(("Authorize: Txn Id NOT ALLOW to void/cancel!!!\n"));
		}
        }

/*
 * Check Batch Id (No Batah Id or Single Batch Id/Multi Batch Id) * * * * * * * * * * * * * * * * * * * *
 */
	if (iRet == PD_OK) {

		if (iNumOfBatchId <= 0) {
/* No Batch Id */

			hash_t  *hOrgTxn;
                	hOrgTxn = (hash_t*) malloc (sizeof(hash_t));
			hash_init(hOrgTxn, 0);
                
			hash_t  *hNewTxn;
                	hNewTxn = (hash_t*) malloc (sizeof(hash_t));
                	hash_init(hNewTxn, 0);

DEBUGLOG(("Authorize: iNumOfBatchId = [%d]\n",iNumOfBatchId));		

			if (GetField_CString(hContext, "txn_seq", &csOrgTxnSeq)) {
DEBUGLOG(("Authorize: org_txn_id = [%s]\n",csOrgTxnSeq));		

/*
 * No Batch Id - Step 1: Check Action Cancel/Void/False * * * * * * * * * * * * * * * * * * * *
 */
				if (iRet == PD_OK) {
					// Get txn header info
					iRet = GetTxnHeaderInfo(csOrgTxnSeq, hTxnHeaderRec);				

					// Get bank acct type
					if (iRet == PD_OK) {
                                                //iRet = GetBankAcctType(csOrgTxnSeq, hTxnHeaderRec);
                                        }

					// Get baid category
                        		if (iRet == PD_OK) {
                       				iRet = GetBaidCategory(csOrgTxnSeq, hTxnHeaderRec);
                    			}

					// Call function to check action
					if (iRet == PD_OK) {
						iDtlRet = CheckActionByTxnId(csOrgTxnSeq, hTxnHeaderRec, hContext);
		
DEBUGLOG(("===== Authorize (Txn Action Result) ===== START!!\n"));
	
						if (iDtlRet == PD_BATCH_ACTION_CANCEL) {
DEBUGLOG(("Authorize: CheckActionByTxnId: Action [CANCEL]\n"));
                        			} else if (iAction == PD_BATCH_ACTION_VOID) {
DEBUGLOG(("Authorize: CheckActionByTxnId: Action [VOID]\n"));
                        			} else if (iAction == PD_FALSE) {
DEBUGLOG(("Authorize: CheckActionByTxnId: Action [NOT ALLOW TO CANCEL/VOID]\n"));
							iRet = INT_INVALID_TXN;
                                                        PutField_Int(hContext,"internal_error",iRet);
                        			} else {
							iRet = iDtlRet;
                                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize: CheckActionByTxnId: Return Error, iRet = [%d]\n",iRet));
						}		

DEBUGLOG(("===== Authorize (Txn Action Result) ===== END!!\n"));
					}
				}

/*
 * No Batch Id - Step 2: Do Txn Level * * * * * * * * * * * * * * * * * * * *
 */

				if (iRet == PD_OK) {
					iRet = ProcessOffset(csOrgTxnSeq, hOrgTxn, hNewTxn, hContext);	
				}
	
				// Remove fields - element_acct_bal and element_intransit
				RemoveField_Double(hContext, "element_acct_bal");
				RemoveField_Double(hContext, "element_intransit");                                              
			}
	
			hash_destroy(hOrgTxn);
                	hash_destroy(hNewTxn);

			FREE_ME(hOrgTxn);
                	FREE_ME(hNewTxn);
		}
		else {		
/* Single/Multi Batch Id */

DEBUGLOG(("Authorize: iNumOfBatchId = [%d]\n",iNumOfBatchId));	

/*
 * Single / Multi Batch Id - Step 1: Check Batch Id is P1Void or P2Voided * * * * * * * * * * * * * * * * * * * *
 */

                	PutField_Char(hTxnContext,"batch_type",cOrgBatchType);
                	PutField_Char(hTxnContext,"batch_sub_type",cOrgBatchSubType);
                	PutField_CString(hTxnContext,"batch_id",csOrgBatchId);
			PutField_Char(hTxnContext,"txn_level",PD_TXN_LEVEL);

			// Get Txn Id recordset from Batch, order by approval_ts DESC
DEBUGLOG(("Authorize() Call DBOLBatchTxnRelation:GetTxnId\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetTxnId");
                	iRet = (unsigned long)(*DBObjPtr)(hTxnContext,rTmpTxnRecordSet);
                	if (iRet != PD_OK) {
                        	iRet = INT_ERR;
                        	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Call DBOLBatchTxnRelation::GetTxnId() Invalid Batch Id!!!\n"));
ERRLOG("TxnOmtByUsRBT::Call DBOLBatchTxnRelation::GetTxnId() Invalid Batch Id!!!\n");
                	}

			if (iRet == PD_OK) {
				hTmpTxnRec = RecordSet_GetFirst(rTmpTxnRecordSet);
				while ((hTmpTxnRec) && (iRet == PD_OK)) {
/* txn_id */
                       			if (GetField_CString(hTmpTxnRec,"txn_id",&csTmpTxnSeq)) {
DEBUGLOG(("Authorize() Call DBOLBatchTxnRelation::GetTxnId() txn_id = [%s]\n",csTmpTxnSeq));

						// Check P1Void Txn Id
						if (iRet == PD_OK) {
							iDtlRet = PD_FALSE;

                                 			iDtlRet = IsP1VoidTxnId(csTmpTxnSeq, hContext);
                                        		if (iDtlRet == PD_TRUE) {
								iIsOrgBatchIdP1Void = PD_TRUE;
                                        		 	break;
                                        		} else if (iDtlRet == PD_FALSE) {
								// Do Nothing...
							} else {
								iRet = iDtlRet;
							}
						}

						// Check P2Voided Txn Id
						if (iRet == PD_OK) {
							iDtlRet = PD_FALSE;

							iDtlRet = IsP2VoidedTxnId(csTmpTxnSeq, hContext);
							if (iDtlRet == PD_TRUE) {
								// Do Nothing...
							} else if (iDtlRet == PD_FALSE) {
								iIsOrgBatchIdP2Voided = PD_FALSE;
								break;
							} else {
                                                                iRet = iDtlRet;
                                                        }
						}
					}

					hTmpTxnRec = RecordSet_GetNext(rTmpTxnRecordSet);
				}
			
				// Check P2Voided Batch Id
                                if (iIsOrgBatchIdP2Voided == PD_TRUE) {
					if ((strcmp(csTxnType, PD_TXN_TYPE_PSP_SETTLEMENT))
  					    && (strcmp(csTxnType, PD_TXN_TYPE_PROVIDER_CHARGE))	
					) 
					{
                        	                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize: P2VOidedBatchId return error, iRet = [%d]\n",iRet));
					}
                                }

DEBUGLOG(("===== Authorize (Is P1Void/P2Voided Org Batch Id) ===== START!!\n"));
				if (iIsOrgBatchIdP1Void == PD_TRUE) {
DEBUGLOG(("Authorize: P1VOidBatchId [TRUE]\n"));
				} else {
DEBUGLOG(("Authorize: P1VOidBatchId [FALSE]\n"));
				}

				if (iIsOrgBatchIdP2Voided == PD_TRUE) {
DEBUGLOG(("Authorize: P2VOidedBatchId [TRUE]\n"));
				} else {
DEBUGLOG(("Authorize: P2VOidedBatchId [FALSE]\n"));
				}
DEBUGLOG(("===== Authorize (Is P1Void/P2Voided Org Batch Id) ===== END!!\n"));
			}

/*
 * Single / Multi Batch Id - Step 2: Check Action Cancel/Void/False * * * * * * * * * * * * * * * * * * * *
 */
                	if (iRet == PD_OK) {
                        	hTmpTxnRec = RecordSet_GetFirst(rTmpTxnRecordSet);
                        	while ((hTmpTxnRec) && (iRet == PD_OK)) {
/* txn_id */
                                	if (GetField_CString(hTmpTxnRec,"txn_id",&csTmpTxnSeq)) {
DEBUGLOG(("Authorize() Call DBOLBatchTxnRelation::GetTxnId() txn_id = [%s]\n",csTmpTxnSeq));

						// Store tmp txn seq
						PutField_CString(hTxnContext,"txn_id",csTmpTxnSeq);
                                        	PutField_CString(hTxnContext,"txn_seq",csTmpTxnSeq);

						// Get txn header info
						iRet = GetTxnHeaderInfo(csTmpTxnSeq, hTxnHeaderRec);

						// Get bank acct type
                                        	if (iRet == PD_OK) {
                                        	        //iRet = GetBankAcctType(csTmpTxnSeq, hTxnHeaderRec);
                                        	}

						// Get baid category
						if (iRet == PD_OK) {
                                        	        iRet = GetBaidCategory(csTmpTxnSeq, hTxnHeaderRec);
                                        	}
					}

					// Call function to check void/cancel/false
					if (iRet == PD_OK) {
						iDtlRet = PD_FALSE;

                                        	iDtlRet = CheckActionByTxnId(csTmpTxnSeq, hTxnHeaderRec, hContext);

DEBUGLOG(("===== Authorize (Txn Action Result) ===== START!!\n"));

                                                if (iDtlRet == PD_BATCH_ACTION_CANCEL) {
DEBUGLOG(("Authorize: CheckActionByTxnId: Action [CANCEL]\n"));
                                                } else if (iAction == PD_BATCH_ACTION_VOID) {
DEBUGLOG(("Authorize: CheckActionByTxnId: Action [VOID]\n"));
                                                } else if (iAction == PD_FALSE) {
DEBUGLOG(("Authorize: CheckActionByTxnId: Action [NOT ALLOW TO CANCEL/VOID]\n"));
                                                        iRet = INT_INVALID_TXN;
                                                        PutField_Int(hContext,"internal_error",iRet);
							break;
                                                } else {
                                                        iRet = iDtlRet;
                                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize: CheckActionByTxnId: Return Error, iRet = [%d]\n",iRet));
							break;
                                                }

DEBUGLOG(("===== Authorize (Txn Action Result) ===== END!!\n"));

                                	}

					hTmpTxnRec = RecordSet_GetNext(rTmpTxnRecordSet);
                        	}

DEBUGLOG(("===== Authorize (Batch Action Result) ===== START!!\n"));
                                      	if (iDtlRet == PD_BATCH_ACTION_CANCEL) {
DEBUGLOG(("Authorize: CheckActionByTxnId: Action [CANCEL]\n"));
                                   	} else if (iAction == PD_BATCH_ACTION_VOID) {
DEBUGLOG(("Authorize: CheckActionByTxnId: Action [VOID]\n"));
                                      	} else if (iAction == PD_FALSE) {
DEBUGLOG(("Authorize: CheckActionByTxnId: Action [NOT ALLOW TO CANCEL/VOID]\n"));
                                    	} else {
DEBUGLOG(("Authorize: CheckActionByTxnId: Return Error, iRet = [%d]\n",iRet));
                                    	}
DEBUGLOG(("===== Authorize (Batch Action Result) ===== END!!\n"));

                	}

/*
 * Single / Multi Batch Id - Step 3: Check All Txn Id in the Batch is put in the new Batch * * * * * * * * * * * * * * * * * * * *
 */
			if (iRet == PD_OK) {		
				hTmpTxnRec = RecordSet_GetFirst(rTmpTxnRecordSet);
                        	while ((hTmpTxnRec) && (iRet == PD_OK)) {
/* txn_id */
                                	if (GetField_CString(hTmpTxnRec,"txn_id",&csTmpTxnSeq)) {
DEBUGLOG(("Authorize() Call DBOLBatchTxnRelation::GetTxnId() txn_id = [%s]\n",csTmpTxnSeq));

						// Store tmp txn seq
						PutField_CString(hTxnContext,"txn_id",csTmpTxnSeq);
                                		PutField_CString(hTxnContext,"txn_seq",csTmpTxnSeq);

                                		// Get txn header info
                                		iRet = GetTxnHeaderInfo(csTmpTxnSeq, hTxnHeaderRec);

						// Get bank acct type
                                 	       	if (iRet == PD_OK) {
                                        	      	//iRet = GetBankAcctType(csTmpTxnSeq, hTxnHeaderRec);
                                        	}

                                		// Get Baid category
                                		if (iRet == PD_OK) {
                                       			iRet = GetBaidCategory(csTmpTxnSeq, hTxnHeaderRec);
                                        	}
                                	}

					// call function to check txn id is included in new batch
					if (iRet == PD_OK) {
						iDtlRet = PD_OK;

                                	        iDtlRet = IsPutTxnIdToBatch(csTmpTxnSeq, hTxnHeaderRec);
	
	                                        if (iDtlRet == PD_OK) {
	                                                RecordSet_Add(rTxnRecordSet, hTmpTxnRec);
	                                        }

DEBUGLOG(("===== Authorize (Is Txn Id put into the batch) ===== START!!\n"));
                                  	      	if (iDtlRet == PD_OK) {
DEBUGLOG(("Authorize: IsPutTxnIdToBatch: Txn Id [%s] is put into the batch\n",csTmpTxnSeq));
                                        	} else {
DEBUGLOG(("Authorize: IsPutTxnIdToBatch: Txn Id [%s] is NOT put into the batch\n",csTmpTxnSeq));
                                        	}
DEBUGLOG(("===== Authorize (Is Txn Id put into the batch) ===== END!!\n"));

	                                }
	
					hTmpTxnRec = RecordSet_GetNext(rTmpTxnRecordSet);
				}
			}

/*
 * Single / Multi Batch Id - Step 4: Do Txn Level * * * * * * * * * * * * * * * * * * * *
 */
			// Get New Batch Id
			if (iRet == PD_OK) {
				DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextActionBatchSeq");
				strcpy(csNewBatchId, (*DBObjPtr)());

DEBUGLOG(("===== Authorize (New Batch Id Info) ===== START!!\n"));

/* batch_type */
                               	cNewBatchType = cOrgBatchType;
                                PutField_Char(hContext, "batch_type", cNewBatchType);
DEBUGLOG(("Authorize: new_batch_type = [%c]\n",cNewBatchType));

/* batch_sub_type */
				if ((cOrgBatchSubType == PD_GENERAL_RECON) 
				    || (cOrgBatchSubType == PD_GENERAL_UNDO_RECON)
				) 
				{
					cNewBatchSubType = PD_GENERAL_UNDO_RECON;
				}
				else if ((cOrgBatchSubType == PD_GENERAL_BAL_TRF)
                                    || (cOrgBatchSubType == PD_GENERAL_UNDO_BAL_TRF)
                                )				
				{
					cNewBatchSubType = PD_GENERAL_UNDO_BAL_TRF;
				}
				else 
				{
					cNewBatchSubType = PD_COMBINE_UNDO_RECON;
				}
				PutField_Char(hContext, "batch_sub_type", cNewBatchSubType);	
DEBUGLOG(("Authorize: new_batch_sub_type = [%c]\n",cNewBatchSubType));
		
/* batch_txn_seq*/
                                PutField_CString(hContext, "batch_txn_seq", csNewBatchId);
DEBUGLOG(("Authorize: new_batch_id = [%s]\n",csNewBatchId));

DEBUGLOG(("===== Authorize (New Batch Id Info) ===== END!!\n"));

			}

			// Do org txn seq (provider-charge)
			if (iRet == PD_OK) {
				if (!strcmp(csTxnType, PD_TXN_TYPE_PROVIDER_CHARGE)) {
					iRet = ProcessOrgTxnSeq(csTxnSeq, hContext);
				}
			}

			// Loop txnid from batch for void/cancel action
			if (iRet == PD_OK) {
				hash_t  *hOrgTxn;
                		hOrgTxn = (hash_t*) malloc (sizeof(hash_t));

                		hash_t  *hNewTxn;
                		hNewTxn = (hash_t*) malloc (sizeof(hash_t));

                		hTxnRec = RecordSet_GetFirst(rTxnRecordSet);
                		while ((hTxnRec) && (iRet == PD_OK)) {
                        		hash_init(hOrgTxn, 0);

                        		if (GetField_CString(hTxnRec,"txn_id",&csOrgTxnSeq)) {
DEBUGLOG(("Authorize: org_txn_id [%s]\n", csOrgTxnSeq));
		
						hash_init(hNewTxn, 0);

                                		iRet = ProcessOffset(csOrgTxnSeq, hOrgTxn, hNewTxn, hContext);

						if (iRet == PD_OK) {
							if (GetField_CString(hNewTxn, "txn_seq", &csNewTxnSeq)) {
DEBUGLOG(("Authorize: new_txn_id [%s]\n", csNewTxnSeq));
        						}

							// Store new linkage of txnRelation into Hash
							sprintf(csTag,"id_%s",(const char*)csOrgTxnSeq);
							PutField_CString(hTxnRelation,csTag,(const char*)csNewTxnSeq);
DEBUGLOG(("Authorize: org_txn_id=[%s], new_txn_id=[%s]\n",(char*)csOrgTxnSeq,(char*)csNewTxnSeq));
						}
		
						hash_destroy(hNewTxn);
					}

					// Check if do last txn
					if (iRet == PD_OK) {
						iDtlRet = PD_FALSE;

						// Check last txn id is created		
						iDtlRet = IsCreateLastTxnId(csOrgBatchId, csOrgTxnSeq, hOrgTxn, hContext);
						if (iDtlRet == PD_TRUE) {

							// Do last txn
							if (iRet == PD_OK) {
								hash_init(hNewTxn, 0);

                                				iRet = ProcessLastTxn(csNewTxnSeq, hOrgTxn, hNewTxn, hContext);	

								if (iRet == PD_OK) {
									if (GetField_CString(hNewTxn, "txn_seq", &csLastTxnSeq)) {
DEBUGLOG(("Authorize() last_txn_id [%s]\n", csLastTxnSeq));
									}
								}

								hash_destroy(hNewTxn);
							}

							// Store last txn info (balance-transfer-intra)
							if (iRet == PD_OK) {
								if (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) {

									// p1 last txn info
									iRet = StoreP1LastTxnInfo(csOrgTxnSeq, csNewTxnSeq, csLastTxnSeq, rTmpP1LastTxnRecordSet, hTmpP1LastTxnRec, hContext);
				
									// p2 last txn info
									if (iRet == PD_OK) {
										iRet = StoreP2LastTxnInfo(csOrgTxnSeq, csNewTxnSeq, csLastTxnSeq, rTmpP2LastTxnRecordSet, hTmpP2LastTxnRec, hContext);
									}
								}
							}

						} else if (iDtlRet == PD_FALSE) {
DEBUGLOG(("Authorize() No last_txn_id created!!!\n"));
						} else {
							iRet = INT_ERR;
DEBUGLOG(("Authorize() last_txn_id created failure!!!\n"));
ERRLOG("TxnOmtByUsRBT:: last_txn_id created failure!!!\n");
						}
                        		}

					// Get next txn
					hTxnRec = RecordSet_GetNext(rTxnRecordSet);

					// Do last txn relation (balance-transfer-intra)
					if (iRet == PD_OK) {
						if (!hTxnRec) {
							if (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) {
								iRet = ProcessLastTxnRelation(rTmpP1LastTxnRecordSet, rTmpP2LastTxnRecordSet, rLastTxnRecordSet, hLastTxnRec, hContext);
							}	
						}
                                     	}

					// Remove fields - element_acct_bal and element_intransit
					RemoveField_Double(hContext, "element_acct_bal");
                        		RemoveField_Double(hContext, "element_intransit");

                        		hash_destroy(hOrgTxn);
                		}

                		FREE_ME(hOrgTxn);
                		FREE_ME(hNewTxn);
			}

/*
 * Single / Multi Batch Id - Step 5: Do Txn Relation (Linkage) * * * * * * * * * * * * * * * * * * * *
 */
			if (iRet == PD_OK) {

				if (iAction != PD_BATCH_ACTION_CANCEL) {
				
					// Add New Txn Relation Linkage
					iRet = AddNewTxnRelationLinkage(csOrgBatchId, hContext, hTxnRelation);

					// Add Last Txn Relation Linkage
					if (iRet == PD_OK) {
						hLastTxnRecGet = RecordSet_GetFirst(rLastTxnRecordSet);
                	        		while (hLastTxnRecGet) {
							iRet = AddLastTxnRelationLinkage(hLastTxnRecGet);
							hLastTxnRecGet = RecordSet_GetNext(rLastTxnRecordSet);
						}
					}
				}
			}

/*
 * Single / Multi Batch Id - Step 6: Check All Stmt Txn Id in the Batch is put in the new Batch * * * * * * * * * * * * * * * * * * * *
 */

			// Get Stmt Txn Id recordset, order by approval_ts DESC
			if (iRet == PD_OK) {

                		PutField_Char(hStmtTxnContext,"batch_type",cOrgBatchType);
                		PutField_Char(hStmtTxnContext,"batch_sub_type",cOrgBatchSubType);
                		PutField_CString(hStmtTxnContext,"batch_id",csOrgBatchId);
                		PutField_Char(hStmtTxnContext,"txn_level",PD_STMT_LEVEL);

DEBUGLOG(("Authorize() Call DBOLBatchTxnRelation:GetTxnId\n"));
                		DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetTxnId");
                		iRet = (unsigned long)(*DBObjPtr)(hStmtTxnContext,rTmpStmtTxnRecordSet);
				if (iRet != PD_OK) {
                        		iRet = INT_ERR;
DEBUGLOG(("Authorize() Call DBOLBatchTxnRelation::GetTxnId() Invalid Batch Id!!!\n"));
ERRLOG("TxnOmtByUsRBT::Call DBOLBatchTxnRelation::GetTxnId() Invalid Batch Id!!!\n");
                		}                

				if (iRet == PD_OK) {
                        		hTmpStmtTxnRec = RecordSet_GetFirst(rTmpStmtTxnRecordSet);
					while ((hTmpStmtTxnRec) && (iRet == PD_OK)) {

/* txn_id */
                                		if (GetField_CString(hTmpStmtTxnRec,"txn_id",&csTmpStmtTxnSeq)) {
							// Store tmp stmt txn seq			
							PutField_CString(hStmtTxnContext,"txn_id",csTmpStmtTxnSeq);
							PutField_CString(hStmtTxnContext,"txn_seq",csTmpStmtTxnSeq);
DEBUGLOG(("Authorize() Call DBOLBatchTxnRelation::GetTxnId() txn_id = [%s]\n",csTmpStmtTxnSeq));

							// Get Baid Txn Info
							iRet = GetBaidTxnInfo(csTmpStmtTxnSeq, hBaidTxnRec);      
						}			

						if (iRet == PD_OK) {
							iDtlRet = PD_FALSE;

							iDtlRet = IsPutStmtTxnIdToBatch(csTmpStmtTxnSeq, hTmpStmtTxnRec, hBaidTxnRec, hStmtTxnContext); 
					
							if (iDtlRet != INT_ERR) {
								if (iDtlRet == PD_TRUE) {
                                                			RecordSet_Add(rStmtTxnRecordSet, hTmpStmtTxnRec);
								}
							} else {
								iRet = iDtlRet;
							}

DEBUGLOG(("===== Authorize (Is Stmt Txn Id put into the batch) ===== START!!\n"));
                                                	if (iDtlRet == PD_TRUE) {
DEBUGLOG(("Authorize: IsPutStmtTxnIdToBatch: Txn Id [%s] is put into the batch\n",csTmpStmtTxnSeq));
                                                	} else {
DEBUGLOG(("Authorize: IsPutStmtTxnIdToBatch: Txn Id [%s] is NOT put into the batch\n",csTmpStmtTxnSeq));
                                                	}
DEBUGLOG(("===== Authorize (Is Stmt Txn Id put into the batch) ===== END!!\n"));

						}

                                		hTmpStmtTxnRec = RecordSet_GetNext(rTmpStmtTxnRecordSet);
                        		}
                		} 
        		}	

/*
 * Single / Multi Batch Id - Step 7: Do Stmt Txn Level * * * * * * * * * * * * * * * * * * * *
 */
			// Loop stmt txnid from batch for action
			if (iRet == PD_OK) {
                		hStmtTxnRec = RecordSet_GetFirst(rStmtTxnRecordSet);
                		while (hStmtTxnRec) {
                        		if (GetField_CString(hStmtTxnRec,"txn_id",&csOrgStmtTxnSeq)) {
DEBUGLOG(("Authorize: stmt_org_txn_id = [%s]\n",csOrgStmtTxnSeq));

                        			iRet = ProcessStmtOffset(csOrgStmtTxnSeq, hStmtTxnRec, hContext);
                        		}

                        		hStmtTxnRec = RecordSet_GetNext(rStmtTxnRecordSet);
                		}
        		}

/*
 * Single / Multi Batch Id - Step 8: Do Batch Relation * * * * * * * * * * * * * * * * * * * *
 */
			// Add Batch Relation	
			if (iRet == PD_OK) {

DEBUGLOG(("Authorize: org_batch_id = [%s], new_batch_id = [%s]\n",csOrgBatchId,csNewBatchId));
                		PutField_CString(hContext, "org_batch_id", csOrgBatchId);
                		PutField_CString(hContext, "batch_id", csNewBatchId);
				if (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) {
                        		PutField_Char(hContext, "batch_sub_type", PD_GENERAL_UNDO_BAL_TRF);
                		} else {
                			PutField_Char(hContext, "batch_sub_type", cNewBatchSubType);
				}

                		iRet = AddBatchRelation(hContext);
        		}
		}
	}

	hash_destroy(hOrgBatchIdInfo);
        FREE_ME(hOrgBatchIdInfo);

	hash_destroy(hTxnHeaderRec);
        FREE_ME(hTxnHeaderRec);

	hash_destroy(hBaidTxnRec);
        FREE_ME(hBaidTxnRec);

	RecordSet_Destroy(rTmpP1LastTxnRecordSet);
        FREE_ME(rTmpP1LastTxnRecordSet);

	RecordSet_Destroy(rTmpP2LastTxnRecordSet);
        FREE_ME(rTmpP2LastTxnRecordSet);

	RecordSet_Destroy(rLastTxnRecordSet);
        FREE_ME(rLastTxnRecordSet);

        RecordSet_Destroy(rTmpTxnRecordSet);
        FREE_ME(rTmpTxnRecordSet);
        
	RecordSet_Destroy(rTxnRecordSet);
        FREE_ME(rTxnRecordSet);

        RecordSet_Destroy(rTmpStmtTxnRecordSet);
        FREE_ME(rTmpStmtTxnRecordSet);

	RecordSet_Destroy(rStmtTxnRecordSet);
        FREE_ME(rStmtTxnRecordSet);

	hash_destroy(hTmpP1LastTxnRec);
        FREE_ME(hTmpP1LastTxnRec);

	hash_destroy(hTmpP2LastTxnRec);
        FREE_ME(hTmpP2LastTxnRec);

	hash_destroy(hLastTxnRec);
	FREE_ME(hLastTxnRec);

	FREE_ME(hTxnContext);
	FREE_ME(hStmtTxnContext);

DEBUGLOG(("Authorize::TxnOmtByUsRBT: END!!!!!!!!!\n"));

DEBUGLOG(("TxnOmtByUsRBT Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}

int     AddTxnRelation(hash_t* hRls)
{
        int     iRet = PD_OK;

        char    cTmp;
        char    *csTmp = NULL;

        hash_t  *hRelation = (hash_t *) malloc (sizeof(hash_t));
        hash_init(hRelation, 0);

/* org_txn_seq */
        if(GetField_CString(hRls,"p1_txn_id",&csTmp)){
DEBUGLOG(("AddTxnRelation: p1_txn_id = [%s]\n",csTmp));
                PutField_CString(hRelation,"p1_txn_id",csTmp);
        } else {
                iRet=INT_INVALID_TXN;
DEBUGLOG(("AddTxnRelation::txn_seq not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddTxnRelation::txn_seq not found!!\n");
        }

/* txn_seq */
        if(GetField_CString(hRls,"p2_txn_id",&csTmp)){
DEBUGLOG(("AddTxnRelation: p2_txn_id = [%s]\n",csTmp));
                PutField_CString(hRelation,"p2_txn_id",csTmp);
        } else {
                iRet=INT_INVALID_TXN;
DEBUGLOG(("AddTxnRelation::txn_seq not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddTxnRelation::txn_seq not found!!\n");
        }

/* party */
        if(GetField_Char(hRls,"party",&cTmp)){
DEBUGLOG(("AddTxnRelation: party = [%c]\n",cTmp));
                PutField_Char(hRelation,"party",cTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddTxnRelation::party not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddTxnRelation::party not found!!\n");
        }

/* txn_level */
        if(GetField_Char(hRls,"txn_level",&cTmp)){
DEBUGLOG(("AddTxnRelation: txn_level = [%c]\n",cTmp));
                PutField_Char(hRelation,"txn_level",cTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddTxnRelation::txn_level not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddTxnRelation::txn_level not found!!\n");
        }

/* relation_type */
        if(GetField_Char(hRls,"relation_type",&cTmp)){
DEBUGLOG(("AddTxnRelation: relation_type = [%c]\n",cTmp));
                PutField_Char(hRelation,"relation_type",cTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddTxnRelation::relation_type not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddTxnRelation::relation_type not found!!\n");
        }

/* user */
        if(GetField_CString(hRls,"add_user",&csTmp)){
DEBUGLOG(("AddTxnRelation: add_user= [%s]\n",csTmp));
                PutField_CString(hRelation,"add_user",csTmp);
                PutField_CString(hRelation,"create_user",csTmp);
                PutField_CString(hRelation,"update_user",csTmp);
        } else {
                iRet = INT_ERR;
DEBUGLOG(("AddTxnRelation: add_user missing\n"));
ERRLOG("TxnOmtByUsRBT::AddTxnRelation: add_user missing\n");
        }

        if (iRet == PD_OK) {
DEBUGLOG(("AddTxnRelation Call DBOLTxnRelation:Add\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation", "Add");
                iRet = (unsigned long)(*DBObjPtr)(hRelation);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("AddTxnRelation::call DBOLTxnRelation Add::failed!!!\n"));
ERRLOG("TxnOmtByUsRBT::AddTxnRelation::call DBOLTxnRelation Add::failed!!!\n");
                }
        }

        hash_destroy(hRelation);
        FREE_ME(hRelation);

DEBUGLOG(("AddTxnRelation Call DBOLTxnRelation: iRet = [%d]\n", iRet));
        return iRet;
}

int     AddBatchTxnRelation(hash_t* hRls)
{
        int     iRet = PD_OK;
	
	int	iTmp = 0;

        char    cTmp;
        char    *csTmp = NULL;

        hash_t  *hRelation = (hash_t *) malloc (sizeof(hash_t));
        hash_init(hRelation, 0);

/* batch_txn_seq */
        if(GetField_CString(hRls,"batch_txn_seq",&csTmp)){
DEBUGLOG(("AddBatchTxnRelation: batch_id = [%s]\n",csTmp));
                PutField_CString(hRelation,"batch_id",csTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddBatchTxnRelation::batch_txn_seq not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddBatchTxnRelation::batch_txn_seq not found!!\n");
        }

/* txn_seq */
        if(GetField_CString(hRls,"txn_seq",&csTmp)){
DEBUGLOG(("AddBatchTxnRelation: txn_id = [%s]\n",csTmp));
                PutField_CString(hRelation,"txn_id",csTmp);
        } else {
                iRet=INT_INVALID_TXN;
DEBUGLOG(("AddBatchTxnRelation::txn_seq not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddBatchTxnRelation::txn_seq not found!!\n");
        }

/* batch_type */
        if(GetField_Char(hRls,"batch_type",&cTmp)){
DEBUGLOG(("AddBatchTxnRelation: batch_type = [%c]\n",cTmp));
                PutField_Char(hRelation,"batch_type",cTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddBatchTxnRelation::batch_type not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddBatchTxnRelation::batch_type not found!!\n");
        }

/* batch_sub_type */
        if(GetField_Char(hRls,"batch_sub_type",&cTmp)){
DEBUGLOG(("AddBatchTxnRelation: batch_sub_type = [%c]\n",cTmp));
                PutField_Char(hRelation,"batch_sub_type",cTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddBatchTxnRelation::batch_sub_type not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddBatchTxnRelation::batch_sub_type not found!!\n");
        }

/* txn_level */
        if(GetField_Char(hRls,"txn_level",&cTmp)){
DEBUGLOG(("AddBatchTxnRelation: txn_level = [%c]\n",cTmp));
                PutField_Char(hRelation,"txn_level",cTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddBatchTxnRelation::txn_level not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddBatchTxnRelation::txn_level not found!!\n");
        }

/* is_input_txn */
        if(GetField_Int(hRls,"is_input_txn",&iTmp)){
DEBUGLOG(("AddBatchTxnRelation: is_input_txn = [%d]\n",iTmp));
                PutField_Int(hRelation,"is_input_txn",iTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddBatchTxnRelation::is_input_txn not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddBatchTxnRelation::is_input_txn not found!!\n");
        }

/* is_regen_txn */
        if(GetField_Int(hRls,"is_regen_txn",&iTmp)){
DEBUGLOG(("AddBatchTxnRelation: is_regen_txn = [%d]\n",iTmp));
                PutField_Int(hRelation,"is_regen_txn",iTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddBatchTxnRelation::is_regen_txn not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddBatchTxnRelation::is_regen_txn not found!!\n");
        }

/* user */
        if(GetField_CString(hRls,"add_user",&csTmp)){
DEBUGLOG(("AddBatchTxnRelation: add_user= [%s]\n",csTmp));
                PutField_CString(hRelation,"add_user",csTmp);
                PutField_CString(hRelation,"create_user",csTmp);
                PutField_CString(hRelation,"update_user",csTmp);
        } else {
                iRet = INT_ERR;
DEBUGLOG(("AddBatchTxnRelation: add_user missing\n"));
ERRLOG("TxnOmtByUsRBT::AddBatchTxnRelation: add_user missing\n");
        }

        if (iRet == PD_OK) {
DEBUGLOG(("AddBatchTxnRelation Call DBOLBatchTxnRelation:Add\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation", "Add");
                iRet = (unsigned long)(*DBObjPtr)(hRelation);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("AddBatchTxnRelation::call DBOLBatchTxnRelation Add::failed!!!\n"));
ERRLOG("TxnOmtByUsRBT::AddBatchTxnRelation::call DBOLBatchTxnRelation Add::failed!!!\n");
                }
        }

        hash_destroy(hRelation);
        FREE_ME(hRelation);

DEBUGLOG(("AddBatchTxnRelation Call DBOLBatchTxnRelation: iRet = [%d]\n", iRet));
        return iRet;
}

int     AddBatchRelation(hash_t* hRls)
{
        int     iRet = PD_OK;

	char	cTmp;	

        char    *csTmp = NULL;

        hash_t  *hRelation = (hash_t *) malloc (sizeof(hash_t));
        hash_init(hRelation, 0);

/* org_batch_id */
        if(GetField_CString(hRls,"org_batch_id",&csTmp)){
DEBUGLOG(("AddBatchRelation: org_batch_id = [%s]\n",csTmp));
                PutField_CString(hRelation,"org_batch_id",csTmp);
        } else {
                iRet=INT_INVALID_TXN;
DEBUGLOG(("AddBatchRelation::org_batch_id not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddBatchRelation::org_batch_id not found!!\n");
        }

/* batch_id */
        if(GetField_CString(hRls,"batch_id",&csTmp)){
DEBUGLOG(("AddBatchRelation: batch_id = [%s]\n",csTmp));
                PutField_CString(hRelation,"batch_id",csTmp);
        } else {
                iRet=INT_INVALID_TXN;
DEBUGLOG(("AddBatchRelation::batch_id not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddBatchRelation::batch_id not found!!\n");
        }

/* batch_sub_type */
        if(GetField_Char(hRls,"batch_sub_type",&cTmp)){
DEBUGLOG(("AddBatchRelation: batch_sub_type = [%c]\n",cTmp));
                PutField_Char(hRelation,"batch_sub_type",cTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddBatchRelation::batch_sub_type not found!!\n"));
ERRLOG("TxnOmtByUsRBT::AddBatchRelation::batch_sub_type not found!!\n");
        }

/* user */
        if(GetField_CString(hRls,"add_user",&csTmp)){
DEBUGLOG(("AddBatchRelation: add_user= [%s]\n",csTmp));
                PutField_CString(hRelation,"add_user",csTmp);
                PutField_CString(hRelation,"create_user",csTmp);
                PutField_CString(hRelation,"update_user",csTmp);
        } else {
                iRet = INT_ERR;
DEBUGLOG(("AddBatchRelation: add_user missing\n"));
ERRLOG("TxnOmtByUsRBT::AddBatchRelation: add_user missing\n");
        }

if (iRet == PD_OK) {
DEBUGLOG(("AddBatchRelation Call DBOLBatchRelation:Add\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLBatchRelation", "Add");
                iRet = (unsigned long)(*DBObjPtr)(hRelation);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("AddBatchRelation::call DBOLBatchRelation Add::failed!!!\n"));
ERRLOG("TxnOmtByUsRBT::AddBatchRelation::call DBOLBatchRelation Add::failed!!!\n");
                }
        }

        hash_destroy(hRelation);
        FREE_ME(hRelation);

DEBUGLOG(("AddBatchRelation Call DBOLBatchRelation: iRet = [%d]\n", iRet));
        return iRet;
}

int     GetBankAcctType(const char* csTxnId, hash_t* hBankAcctTypeRec)
{
        int     iRet = PD_OK;
        int     iDtlRet = PD_FOUND;

        char    *csBankAcctType = (char*) malloc (64);

DEBUGLOG(("GetBankAcctType::Call DBOLBankAccts:GetBankAcctTypeByTxnId [%s]\n", csTxnId));
        DBObjPtr = CreateObj(DBPtr, "DBOLBankAccts", "GetBankAcctTypeByTxnId");
        iDtlRet = (unsigned long)(*DBObjPtr)(csTxnId,csBankAcctType);
	if (iDtlRet == PD_FOUND) {
/* bank_acct_type */
                PutField_CString(hBankAcctTypeRec, "bank_acct_type", csBankAcctType);
DEBUGLOG(("GetBankAcctType::call DBOLBankAccts:: bank_acct_type = [%s]\n",csBankAcctType));
        } else if (iDtlRet == PD_NOT_FOUND) { 
DEBUGLOG(("GetBankAcctType::call DBOLBankAccts::not found record for [%s]\n", csTxnId));
	} else {
                iRet = INT_ERR;
DEBUGLOG(("GetBankAcctType::call DBOLBankAccts::return error for [%s]\n", csTxnId));
ERRLOG("TxnOmtByUsRBT::GetBankAcctType::call DBOLBankAccts::return error for [%s]\n", csTxnId);
        }

        FREE_ME(csBankAcctType);

DEBUGLOG(("GetBankAcctType: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetBaidCategory(const char* csTxnId, hash_t* hBaidCategoryRec)
{
        int     iRet = PD_OK;

        char    *csBaidCategory = (char*) malloc (64);

DEBUGLOG(("GetBaidCategory::Call DBOLBankAcctId:GetCategoryByTxnId [%s]\n", csTxnId));
        DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetCategoryByTxnId");
        if ((*DBObjPtr)(csTxnId,csBaidCategory) == PD_OK) {
/* baid_category */
                PutField_CString(hBaidCategoryRec, "baid_category", csBaidCategory);
DEBUGLOG(("GetBaidCategory::call DBOLBankAcctId:: baid_category = [%s]\n",csBaidCategory));

        } else {
                iRet = INT_INVALID_TXN;
DEBUGLOG(("GetBaidCategory::call DBOLBankAcctId::not found record for [%s]\n", csTxnId));
ERRLOG("TxnOmtByUsRBT::GetBaidCategory::call DBOLBankAcctId::not found record for [%s]\n", csTxnId);
        }

        FREE_ME(csBaidCategory);

DEBUGLOG(("GetBaidCategory: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetTxnHeaderInfo(const char* csTxnId, hash_t* hTxnHeaderRec)
{
	int     iRet = PD_OK;

	int	iTmp = 0;
        char    *csTmp = NULL;
        char    cTmp;

        hash_t  *hRec = NULL;

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

        cTmp = ' ';

	// Get Txn Header
	if (iRet == PD_OK) {
                recordset_init(rRecordSet,0);

DEBUGLOG(("GetTxnHeaderInfo::Call DBOLTransaction:GetTxnHeader [%s]\n", csTxnId));
                DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnHeader");
                if ((*DBObjPtr)(csTxnId,rRecordSet) == PD_OK) {
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* status */
                                if (GetField_Char(hRec,"status",&cTmp)) {
DEBUGLOG(("GetTxnHeaderInfo::call DBOLTransaction:: status = [%c]\n",cTmp));
					PutField_Char(hTxnHeaderRec, "status", cTmp);					
                                }

/* ar_ind */
                                if (GetField_Char(hRec, "ar_ind", &cTmp)) {
DEBUGLOG(("GetTxnHeaderInfo::call DBOLTransaction:: ar_ind = [%c]\n", cTmp));
					PutField_Char(hTxnHeaderRec, "ar_ind", cTmp);					
                                }

/* sub_status */
                                if (GetField_CString(hRec, "sub_status", &csTmp)) {
DEBUGLOG(("GetTxnHeaderInfo::call DBOLTransaction:: sub_status = [%s]\n", csTmp));
					PutField_CString(hTxnHeaderRec, "sub_status", csTmp);					
                                }

/* recon_status */
                                if (GetField_Char(hRec, "recon_status", &cTmp)) {
DEBUGLOG(("GetTxnHeaderInfo::call DBOLTransaction:: recon_status = [%c]\n", cTmp));
					PutField_Char(hTxnHeaderRec, "recon_status", cTmp);					
                                }

/* process_type */
                                if (GetField_CString(hRec,"process_type",&csTmp)) {
DEBUGLOG(("GetTxnHeaderInfo::call DBOLTransaction:: process_type = [%s]\n",csTmp));
					PutField_CString(hTxnHeaderRec, "process_type", csTmp);					
                                }

/* process_code */
                                if (GetField_CString(hRec,"process_code",&csTmp)) {
DEBUGLOG(("GetTxnHeaderInfo::call DBOLTransaction:: process_code = [%s]\n",csTmp));
					PutField_CString(hTxnHeaderRec, "process_code", csTmp);					
                                }

/* txn_code */
                                if (GetField_CString(hRec, "txn_code", &csTmp)) {
DEBUGLOG(("GetTxnHeaderInfo::call DBOLTransaction:: txn_code = [%s]\n", csTmp));
                                        PutField_CString(hTxnHeaderRec, "txn_code", csTmp);
                                }

/* is_offset */
                                DBObjPtr = CreateObj(DBPtr,"DBTxnCode","IsOffset");
                                iTmp = (unsigned long)(*DBObjPtr)(csTmp);
DEBUGLOG(("GetTxnHeaderInfo::call DBOLTransaction:: is_offset = [%d]\n",iTmp));
				PutField_Int(hTxnHeaderRec, "is_offset", iTmp);					

/* is_void */
				DBObjPtr = CreateObj(DBPtr,"DBTxnCode","IsVoid");
                                iTmp = (unsigned long)(*DBObjPtr)(csTmp);
DEBUGLOG(("GetTxnHeaderInfo::call DBOLTransaction:: is_void = [%d]\n",iTmp));
				PutField_Int(hTxnHeaderRec, "is_void", iTmp);					

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                } else {
                        iRet = INT_INVALID_TXN;
DEBUGLOG(("GetTxnHeaderInfo::call DBOLTransaction GetTxnHeader::not found record for [%s]\n", csTxnId));
ERRLOG("TxnOmtByUsRBT::GetTxnHeaderInfo::call DBOLTransaction GetTxnHeader::not found record for [%s]\n", csTxnId);
                }

		RecordSet_Destroy(rRecordSet);
	}

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("GetTxnHeaderInfo: iRet = [%d]\n",iRet));
        return iRet;
}

int	GetBaidTxnInfo(const char* csStmtTxnId, hash_t* hBaidTxnRec)
{
	int     iRet = PD_OK;

        char    *csTmp = NULL;

        char    cTmp;

        cTmp = ' ';

        // Get Baid Txn
        if (iRet == PD_OK) {
DEBUGLOG(("GetBaidTxnInfo:: Call DBOLBAIDTxn:GetBaidTxn [%s]\n", csStmtTxnId));
             	DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "GetBaidTxn");
                iRet = (unsigned long)(*DBObjPtr)(csStmtTxnId,hBaidTxnRec);
               	if (iRet == PD_OK) {

/* txn_code */
			if (GetField_CString(hBaidTxnRec, "txn_code", &csTmp)) {
DEBUGLOG(("GetBaidTxnInfo:: call DBOLBAIDTxn:: txn_code [%s]\n", csTmp));
                        }

/* status */
                   	if (GetField_Char(hBaidTxnRec, "status", &cTmp)) {
DEBUGLOG(("GetBaidTxnInfo:: call DBOLBAIDTxn:: status [%c]\n", cTmp));
                     	}

/* ar_ind */
                       	if (GetField_Char(hBaidTxnRec, "ar_ind", &cTmp)) {
DEBUGLOG(("GetBaidTxnInfo:: call DBOLBAIDTxn:: ar_ind [%c]\n", cTmp));
                    	}

           	} else {
                   	iRet = INT_ERR;
DEBUGLOG(("GetBaidTxnInfo:: call DBOLBAIDTxn GetBaidTxn::GetBaidTxn FAILED!!\n"));
ERRLOG("TxnOmtByUsRBT::call DBOLBAIDTxn GetBaidTxn::GetBaidTxn FAILED!!\n");
             	}

	}

DEBUGLOG(("GetBaidTxnInfo:: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetVoidBatchIdInfo(const char* csTxnSeq, hash_t *hBatchIdInfo, hash_t *hContext)
{
        int     iRet = PD_OK;
	int	iDtlRet = PD_TRUE;
	
        int     iRecCnt = 0;

	char	cTmpBatchType;
	char	cTmpBatchSubType;

        char    *csTmpBatchId = NULL;

	char    *csFoundTxnSeq = (char*) malloc (64);

	char    csSelectBatchId[PD_TXN_SEQ_LEN + 1];
	char	csFoundBatchId[PD_TXN_SEQ_LEN + 1];
       
	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
 
	hash_t          *hTmpBatchRec;
        hTmpBatchRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpBatchRec,0);

        hash_t          *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rBatchRecordSet,0);

	cTmpBatchType = ' ';
	cTmpBatchSubType = ' ';

DEBUGLOG(("===== GetVoidBatchIdInfo ===== START!!\n"));

        PutField_Char(hTmpBatchRec,"txn_level",PD_TXN_LEVEL);
        PutField_CString(hTmpBatchRec,"txn_id",csTxnSeq);

DEBUGLOG(("GetVoidBatchIdInfo:: Call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder\n"));
       	DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetBatchIdByRTAscOrder");
      	iRet = (unsigned long)(*DBObjPtr)(hTmpBatchRec,rBatchRecordSet);
       	if (iRet == PD_OK) {
       		hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                while (hBatchRec) {

/* batch_id */
                  	if (GetField_CString(hBatchRec,"batch_id",&csTmpBatchId)) {
DEBUGLOG(("GetVoidBatchIdInfo:: Call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder() batch_id = [%s]\n",csTmpBatchId));
			
				// is txn type - intra-balance-transfer
				DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","CheckIsBalTransBatch");
                               	if ((unsigned long)(*DBObjPtr)(csTmpBatchId) == PD_TRUE) {
                                    	sprintf(csTxnType, "%s", PD_TXN_TYPE_BAL_TRF_INTRA);
DEBUGLOG(("GetVoidBatchIdInfo:: call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder() txn_type = [%s]\n", csTxnType));
                                }

				// is txn type - inter-balance-transfer
                                DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","CheckIsBalTransInterBatch");
                                if ((unsigned long)(*DBObjPtr)(csTmpBatchId) == PD_TRUE) {
                                      	sprintf(csTxnType, "%s", PD_TXN_TYPE_BAL_TRF_INTER);
DEBUGLOG(("GetVoidBatchIdInfo:: call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder() txn_type = [%s]\n", csTxnType));
                                }
				
				// is txn type - hold-deposit
				DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","CheckIsHoldDepositBatch");
                               	if ((unsigned long)(*DBObjPtr)(csTmpBatchId) == PD_TRUE) {
                                     	sprintf(csTxnType, "%s", PD_TXN_TYPE_HOLD_DEPOSIT);
DEBUGLOG(("GetVoidBatchIdInfo:: call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder() txn_type = [%s]\n", csTxnType));

					strcpy(csSelectBatchId,csTmpBatchId);
DEBUGLOG(("GetVoidBatchIdInfo:: call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder() select_batch_id = [%s]\n", csSelectBatchId));
                              	}

				// is txn type - psp-settlement
				DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","CheckIsPSPSettlementBatch");
                               	if ((unsigned long)(*DBObjPtr)(csTmpBatchId) == PD_TRUE) {
                                  	sprintf(csTxnType, "%s", PD_TXN_TYPE_PSP_SETTLEMENT);
DEBUGLOG(("GetVoidBatchIdInfo:: call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder() txn_type = [%s]\n", csTxnType));
                           	}

				// is txn type - provider-charge
				DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","CheckIsProviderChargeBatch");
                             	if ((unsigned long)(*DBObjPtr)(csTmpBatchId) == PD_TRUE) {
                                   	sprintf(csTxnType, "%s", PD_TXN_TYPE_PROVIDER_CHARGE);
DEBUGLOG(("GetVoidBatchIdInfo:: call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder() txn_type = [%s]\n", csTxnType));
                            	}

				// is txn type - sms-bank-deposit
				DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","CheckIsSMSBankDepositBatch");
                                if ((unsigned long)(*DBObjPtr)(csTmpBatchId) == PD_TRUE) {
                                        sprintf(csTxnType, "%s", PD_TXN_TYPE_SMS_BANK_DEPOSIT);
DEBUGLOG(("GetVoidBatchIdInfo:: call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder() txn_type = [%s]\n", csTxnType));
                                }
			}
	
			iNumOfBatchId++;

                     	hBatchRec = RecordSet_GetNext(rBatchRecordSet);
             	}

		// Check Number of Found Batch Id
		if (iNumOfBatchId == 0) {
DEBUGLOG(("GetVoidBatchIdInfo:: Call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder() Batch Id Not Found!!!\n"));
             	} else if (iNumOfBatchId == 1) {
DEBUGLOG(("GetVoidBatchIdInfo:: Call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder() Single Batch Id Found!!!\n"));
             	} else if (iNumOfBatchId > 1) {
DEBUGLOG(("GetVoidBatchIdInfo:: Call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder() Multi-Batch Id Found!!!\n"));
            	}
	} else {
            	iRet = INT_ERR;
            	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetVoidBatchIdInfo:: Call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder() Invalid Txn Id!!!\n"));
ERRLOG("TxnOmtByUsRBT::Call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder() Invalid Txn Id!!!\n");
    	}
		
	// Check txn type
	if (iRet == PD_OK) {	

DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() txn_type = [%s]\n",csTxnType));		
		// intra-balance-transfer, multi-batch
		if ((!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) && (iNumOfBatchId > 1)) {
                	hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                       	while (hBatchRec) {

/* batch_type */
				if (GetField_Char(hBatchRec,"batch_type",&cTmpBatchType)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_type = [%c]\n",cTmpBatchType));
                                }

/* batch_sub_type */
                                if (GetField_Char(hBatchRec,"batch_sub_type",&cTmpBatchSubType)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_sub_type = [%c]\n",cTmpBatchSubType));
                                }

/* batch_id */
                                if (GetField_CString(hBatchRec,"batch_id",&csTmpBatchId)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_id = [%s]\n",csTmpBatchId));
                                }

                             	hBatchRec = RecordSet_GetNext(rBatchRecordSet);

				// Last Record
				if (!hBatchRec) {
					PutField_Char(hBatchIdInfo,"org_batch_type",cTmpBatchType);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_type = [%c]\n", cTmpBatchType));

					PutField_Char(hBatchIdInfo,"org_batch_sub_type",cTmpBatchSubType);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_sub_type = [%c]\n", cTmpBatchSubType));
				
					PutField_CString(hBatchIdInfo,"org_batch_id",csTmpBatchId);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_id = [%s]\n", csTmpBatchId));
				}
                    	}
		}	
		// hold-deposit, multi-batch
		else if ((!strcmp(csTxnType, PD_TXN_TYPE_HOLD_DEPOSIT)) && (iNumOfBatchId > 1)) {
			hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                       	while (hBatchRec) {

/* batch_type */
                                if (GetField_Char(hBatchRec,"batch_type",&cTmpBatchType)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_type = [%c]\n",cTmpBatchType));
                                }

/* batch_sub_type */
                                if (GetField_Char(hBatchRec,"batch_sub_type",&cTmpBatchSubType)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_sub_type = [%c]\n",cTmpBatchSubType));
                                }

/* batch_id */
                                if (GetField_CString(hBatchRec,"batch_id",&csTmpBatchId)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_id = [%s]\n",csTmpBatchId));
                                }				

				if (!strcmp(csTmpBatchId, csSelectBatchId)) {
					PutField_Char(hBatchIdInfo,"org_batch_type",cTmpBatchType);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_type = [%c]\n", cTmpBatchType));

					PutField_Char(hBatchIdInfo,"org_batch_sub_type",cTmpBatchSubType);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_sub_type = [%c]\n", cTmpBatchSubType));
                    
					PutField_CString(hBatchIdInfo,"org_batch_id",csTmpBatchId);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_id = [%s]\n", csTmpBatchId));
		           	}

                             	hBatchRec = RecordSet_GetNext(rBatchRecordSet);
                      	}
		}
		// psp-settlement, single-batch/multi-batch	
		else if ((!strcmp(csTxnType, PD_TXN_TYPE_PSP_SETTLEMENT)) && (iNumOfBatchId > 0)) {
                       	hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                      	while (hBatchRec) {

/* batch_type */
                                if (GetField_Char(hBatchRec,"batch_type",&cTmpBatchType)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_type = [%c]\n",cTmpBatchType));
                                }

/* batch_sub_type */
                                if (GetField_Char(hBatchRec,"batch_sub_type",&cTmpBatchSubType)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_sub_type = [%c]\n",cTmpBatchSubType));
                                }
			
/* batch_id */
                                if (GetField_CString(hBatchRec,"batch_id",&csTmpBatchId)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_id = [%s]\n",csTmpBatchId));
                                }
	
				// First Record
				if (iRecCnt == 0) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() first_record\n"));

                                        iDtlRet = PD_FALSE;

                                        iDtlRet = CheckVoidTxnIdValidPSPSettlement(csTmpBatchId, csTxnSeq, hContext);

                                        if (iDtlRet == PD_FALSE) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() txn_id not allow to void/cancel\n"));
                                                iRet = INT_INVALID_TXN;
                                                PutField_Int(hContext,"internal_error",iRet);
                                                break;
                                        }
                                }

                                iRecCnt++;

                                hBatchRec = RecordSet_GetNext(rBatchRecordSet);
	
				// Last Record
				if (!hBatchRec) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() last_record\n"));

                                        iDtlRet = PD_NOT_FOUND;

                                        iDtlRet = FindVoidBatchIdPSPSettlement(csTmpBatchId, csTxnSeq, csFoundBatchId, csFoundTxnSeq, hContext);

                                        if (iDtlRet == PD_FOUND) {
        					hash_init(hBatchTypeInfo,0);

						strcpy(csTmpBatchId, csFoundBatchId);

						// Get Batch Type Info
						iDtlRet = GetBatchTypeInfo(csTmpBatchId, hBatchTypeInfo, hContext);

						if (iDtlRet ==  PD_FOUND) {
/* batch_type */
        						if (GetField_Char(hBatchTypeInfo,"batch_type",&cTmpBatchType)) {
								PutField_Char(hBatchIdInfo,"org_batch_type",cTmpBatchType);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_type = [%c]\n", cTmpBatchType));
        						}

/* batch_sub_type */
        						if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cTmpBatchSubType)) {
								PutField_Char(hBatchIdInfo,"org_batch_sub_type",cTmpBatchSubType);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_sub_type = [%c]\n", cTmpBatchSubType));
        						}
						}

						PutField_CString(hBatchIdInfo,"org_batch_id",csTmpBatchId);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_id = [%s]\n", csTmpBatchId));

						hash_destroy(hBatchTypeInfo);
                                        } else {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() txn_id not allow to void/cancel\n"));
                                                iRet = INT_INVALID_TXN;
                                                PutField_Int(hContext,"internal_error",iRet);
                                                break;
                                        }
                                }
                  	}
		}
		// povider-charge, single-batch/multi-batch
		else if ((!strcmp(csTxnType, PD_TXN_TYPE_PROVIDER_CHARGE)) && (iNumOfBatchId > 0)) {
                       	hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                      	while (hBatchRec) {

/* batch_type */
                                if (GetField_Char(hBatchRec,"batch_type",&cTmpBatchType)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_type = [%c]\n",cTmpBatchType));
                                }

/* batch_sub_type */
                                if (GetField_Char(hBatchRec,"batch_sub_type",&cTmpBatchSubType)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_sub_type = [%c]\n",cTmpBatchSubType));
                                }

/* batch_id */
                                if (GetField_CString(hBatchRec,"batch_id",&csTmpBatchId)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_id = [%s]\n",csTmpBatchId));
                                }

				// First Record
				if (iRecCnt == 0) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() first_record\n"));

                                     	iDtlRet = PD_FALSE;

                                     	iDtlRet = CheckVoidTxnIdValid(csTmpBatchId, csTxnSeq, hContext);

                                    	if (iDtlRet == PD_FALSE) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() txn_id not allow to void/cancel\n"));
                                            	iRet = INT_INVALID_TXN;
                                             	PutField_Int(hContext,"internal_error",iRet);
                                              	break;
                                     	}
                           	}

                             	iRecCnt++;

                           	hBatchRec = RecordSet_GetNext(rBatchRecordSet);

				// Last Record
				if (!hBatchRec) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() last_record\n"));

                                  	iDtlRet = PD_NOT_FOUND;

                                    	iDtlRet = FindVoidBatchId(csTmpBatchId, csTxnSeq, csFoundBatchId, csFoundTxnSeq, hContext);

                                     	if (iDtlRet == PD_FOUND) {
						hash_init(hBatchTypeInfo,0);
			
						strcpy(csTmpBatchId, csFoundBatchId);	

						// Get Batch Type Info
                                                iDtlRet = GetBatchTypeInfo(csTmpBatchId, hBatchTypeInfo, hContext);

						if (iDtlRet ==  PD_FOUND) {
/* batch_type */
                                                        if (GetField_Char(hBatchTypeInfo,"batch_type",&cTmpBatchType)) {
                                                                PutField_Char(hBatchIdInfo,"org_batch_type",cTmpBatchType);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_type = [%c]\n", cTmpBatchType));
                                                        }

/* batch_sub_type */
                                                        if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cTmpBatchSubType)) {
                                                                PutField_Char(hBatchIdInfo,"org_batch_sub_type",cTmpBatchSubType);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_sub_type = [%c]\n", cTmpBatchSubType));
                                                        }
                                                }

						PutField_CString(hBatchIdInfo,"org_batch_id",csTmpBatchId);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_id = [%s]\n", csTmpBatchId));
						
						hash_destroy(hBatchTypeInfo);
                                     	} else {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() txn_id not allow to void/cancel\n"));
                                              	iRet = INT_INVALID_TXN;
                                               	PutField_Int(hContext,"internal_error",iRet);
                                              	break;
                                     	}
                           	}
			}
		}
		// others cases
		else {
			// single-batch/multi-batch
			if (iNumOfBatchId > 0) {
                    		hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                     		while (hBatchRec) {

/* batch_type */
                                	if (GetField_Char(hBatchRec,"batch_type",&cTmpBatchType)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_type = [%c]\n",cTmpBatchType));
                                	}

/* batch_sub_type */
                                	if (GetField_Char(hBatchRec,"batch_sub_type",&cTmpBatchSubType)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_sub_type = [%c]\n",cTmpBatchSubType));
                                	}

/* batch_id */
                                	if (GetField_CString(hBatchRec,"batch_id",&csTmpBatchId)) {
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() batch_id = [%s]\n",csTmpBatchId));
                                	}

                             		hBatchRec = RecordSet_GetNext(rBatchRecordSet);
			
					// Last Record
					if (!hBatchRec) {
						PutField_Char(hBatchIdInfo,"org_batch_type",cTmpBatchType);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_type = [%c]\n", cTmpBatchType));

						PutField_Char(hBatchIdInfo,"org_batch_sub_type",cTmpBatchSubType);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_sub_type = [%c]\n", cTmpBatchSubType));
			
						PutField_CString(hBatchIdInfo,"org_batch_id",csTmpBatchId);
DEBUGLOG(("GetVoidBatchIdInfo:: GetBatchIdByRTAscOrder() org_batch_id = [%s]\n", csTmpBatchId));
                               		}
				}
			}
		}
	}

	FREE_ME(hBatchTypeInfo);

	hash_destroy(hTmpBatchRec);
        FREE_ME(hTmpBatchRec);

        RecordSet_Destroy(rBatchRecordSet);
        FREE_ME(rBatchRecordSet);
	
	FREE_ME(csFoundTxnSeq);

DEBUGLOG(("GetVoidBatchIdInfo:: iRet = [%d]\n",iRet));
DEBUGLOG(("===== GetVoidBatchIdInfo ===== END!!\n"));

        return iRet;
}

int     CheckVoidTxnIdValidPSPSettlement(const char* csBatchId, const char* csTxnId, hash_t *hContext)
{
	int     iRet = PD_TRUE;

        int     iDtlRet = PD_TRUE;

        int     iBatchIdRet = PD_BATCH_ID_INVALID;

	char    csNextBatchId[PD_TXN_SEQ_LEN + 1];
	char    csVoidBatchId[PD_TXN_SEQ_LEN + 1];
	char    csNextTxnId[PD_TXN_SEQ_LEN + 1];
        char    csLastTxnId[PD_TXN_SEQ_LEN + 1];

/* batch_id */
DEBUGLOG(("CheckVoidTxnIdValidPSPSettlement:: csBatchId = [%s]\n",csBatchId));
	
	// check is void txn code 
	iDtlRet = IsVoidTxnCodeTxnId(csTxnId, hContext);	
	
	if (iDtlRet == PD_TRUE) {
		iBatchIdRet = PD_BATCH_ID_INVALID;
	} else if (iDtlRet == PD_FALSE) {

		// Check is offset
       		iDtlRet = IsOffsetTxnId(csTxnId, hContext);
	
		if (iDtlRet == PD_TRUE) {
        	        iBatchIdRet = PD_BATCH_ID_INVALID;
		} else if (iDtlRet == PD_FALSE) {
			iDtlRet = PD_OK;

			// Get last txn id in the batch
			iDtlRet = GetLastTxnIdByRTDescOrder(csBatchId, csLastTxnId, hContext);
			
			if (iDtlRet == PD_OK) {
				iDtlRet = PD_FOUND;

				// Get next batch by multi batch txn relation
                	        iDtlRet = GetNextBatchIdByMultiBatchTxnRelation(PD_BATCH_DESC_ORDER_LAST_REC, csBatchId, csLastTxnId, csNextBatchId, csNextTxnId, hContext);	

				if (iDtlRet == PD_FOUND) {				

					// Get next batch by batch relation
        	                        iDtlRet = GetNextBatchIdByBatchRelation(csNextBatchId, csLastTxnId, csVoidBatchId, hContext);
	
					if (iDtlRet == PD_FOUND) {		

						// Check is voided batch (Next Batch)
        	                        	iDtlRet = IsP2VoidedBatchId(csNextBatchId, hContext);
				
						if (iDtlRet == PD_TRUE) {

							// Check is voided batch
                                        		iDtlRet = IsP2VoidedBatchId(csBatchId, hContext);

                                        		if (iDtlRet == PD_TRUE) {
                                                		iBatchIdRet = PD_BATCH_ID_INVALID;
                                        		} else if (iDtlRet == PD_FALSE) {
                                                		iBatchIdRet = PD_BATCH_ID_VALID;
                                        		} else {
                                               	 		iRet = INT_ERR;
                                        		}
        	                     		} else if (iDtlRet == PD_FALSE) {
        	                        	     	iBatchIdRet = PD_BATCH_ID_INVALID;
        	                     		} else {
        	                        	      	iRet = INT_ERR;
        	                       		}
					} else if (iDtlRet == PD_NOT_FOUND) {
						iBatchIdRet = PD_BATCH_ID_INVALID;
					} else {
						iRet = INT_ERR;
					}
				} else if (iDtlRet == PD_NOT_FOUND) {

					// Check is voided batch
                	                iDtlRet = IsP2VoidedBatchId(csBatchId, hContext);

                	                if (iDtlRet == PD_TRUE) {
                	                        iBatchIdRet = PD_BATCH_ID_INVALID;
                	                } else if (iDtlRet == PD_FALSE) {
                	                        iBatchIdRet = PD_BATCH_ID_VALID;
                	                } else {
                	                        iRet = INT_ERR;
                	                }
                	        } else {
                	     		iRet = INT_ERR;
				}
			} else {
        	             	iRet = INT_ERR;
        	     	}
		} else {
			iRet = INT_ERR;
		}
        } else {
		iRet = INT_ERR;
	}

	if (iRet == INT_ERR) {
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("CheckVoidTxnIdValidPSPSettlement:: Internal Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::CheckVoidTxnIdValidPSPSettlement::Internal Error!!!\n");
        } else {
                if (iBatchIdRet == PD_BATCH_ID_VALID) {
                        iRet = PD_TRUE;
                } else {
                        iRet = PD_FALSE;
                }
        }

DEBUGLOG(("CheckVoidTxnIdValidPSPSettlement:: iRet = [%d]\n",iRet));
        return iRet;
}

int     FindVoidBatchIdPSPSettlement(const char* csBatchId, const char* csTxnId, char* csFoundBatchId, char* csFoundTxnId, hash_t *hContext)
{
	int     iRet = PD_FOUND;
        int     iDtlRet = PD_TRUE;

        int     iBatchIdRet = PD_BATCH_ID_FINDING;

        char    *csTmpTxnId = (char*) malloc (64);
        char    csTmpBatchId[PD_TXN_SEQ_LEN + 1];

        strcpy(csFoundBatchId, csBatchId);
        sprintf(csFoundTxnId, "%s", csTxnId);

        strcpy(csTmpBatchId, csBatchId);
        sprintf(csTmpTxnId, "%s", csTxnId);

DEBUGLOG(("FindVoidBatchIdPSPSettlement:: batch_id = [%s], txn_id = [%s], found_batch_id = [%s], found_txn_id = [%s]\n", csBatchId, csTxnId, csFoundBatchId, csFoundTxnId));

	while ((iBatchIdRet == PD_BATCH_ID_FINDING) && (iRet != INT_ERR)) {

		// Check is void txn code
		iDtlRet = IsVoidTxnCodeTxnId(csTmpTxnId, hContext);

		if (iDtlRet == PD_TRUE) {
                        iBatchIdRet = PD_BATCH_ID_INVALID;
		} else if (iDtlRet == PD_FALSE) {
	
			// Check is offset
			iDtlRet = IsOffsetTxnId(csTmpTxnId, hContext);

               		if (iDtlRet == PD_TRUE) {
                	    	iBatchIdRet = PD_BATCH_ID_INVALID;
             		} else if (iDtlRet == PD_FALSE) {
                	    	iBatchIdRet = GetPrevBatchIdByMultiBatchTxnRelation(PD_BATCH_DESC_ORDER_LAST_REC, csTmpBatchId, csTmpTxnId, csFoundBatchId, csFoundTxnId, hContext);
DEBUGLOG(("FindVoidBatchIdPSPSettlement:: found_batch_id = [%s], found_txn_id = [%s]\n", csFoundBatchId, csFoundTxnId));

                	    	strcpy(csTmpBatchId, csFoundBatchId);
                	      	sprintf(csTmpTxnId, "%s", csFoundTxnId);
             		} else {
                	      	iRet = INT_ERR;
               		}
		} else {
			iRet = INT_ERR;
		}	
	}	
	
DEBUGLOG(("FindVoidBatchIdPSPSettlement:: iBatchIdRet = [%d]\n", iBatchIdRet));

	if (iRet == INT_ERR) {
DEBUGLOG(("FindVoidBatchIdPSPSettlement:: Internal Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::FindVoidBatchIdPSPSettlement::Internal Error!!!\n");
        } else {
                if (iBatchIdRet == PD_BATCH_ID_VALID) {
                        iRet = PD_FOUND;
                } else {
                        iRet = PD_NOT_FOUND;
                }
        }

        FREE_ME(csTmpTxnId);

DEBUGLOG(("FindVoidBatchIdPSPSettlement:: iRet = [%d]\n",iRet));
        return iRet;
}

int	CheckVoidTxnIdValid(const char* csBatchId, const char* csTxnId, hash_t *hContext)
{
	int     iRet = PD_TRUE;
	int     iDtlRet = PD_FOUND;
	int	iBatchSubTypeUndoRet = PD_TRUE;

        int     iBatchIdRet = PD_BATCH_ID_FINDING;
        
	char    cBatchType;
	char    cBatchSubType;
	char    cPrevBatchType;
	char    cPrevBatchSubType;

	char    csTmpBatchId[PD_TXN_SEQ_LEN + 1];
        char    csTmpTxnId[PD_TXN_SEQ_LEN + 1];
	char    csTmpNextBatchId[PD_TXN_SEQ_LEN + 1];
	char    csNextBatchId[PD_TXN_SEQ_LEN + 1];
	char    csNextTxnId[PD_TXN_SEQ_LEN + 1];
	char    csPrevBatchId[PD_TXN_SEQ_LEN + 1];
	char    csPrevTxnId[PD_TXN_SEQ_LEN + 1];
	char    csLastTxnId[PD_TXN_SEQ_LEN + 1];

	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchTypeInfo,0);

        cBatchType = ' ';
        cBatchSubType = ' ';
        cPrevBatchType = ' ';
        cPrevBatchSubType = ' ';

	strcpy(csTmpBatchId, csBatchId);
	strcpy(csTmpTxnId, csTxnId);
	strcpy(csTmpNextBatchId, csBatchId);
	strcpy(csNextBatchId, csBatchId);
	strcpy(csNextTxnId, csTxnId);	
	strcpy(csPrevBatchId, csBatchId);
	strcpy(csPrevTxnId, csTxnId);	
	strcpy(csLastTxnId, csTxnId);

DEBUGLOG(("CheckVoidTxnIdValid:: batch_id = [%s], txn_id = [%s]\n", csBatchId, csTxnId));
DEBUGLOG(("CheckVoidTxnIdValid:: next_batch_id = [%s], next_txn_id = [%s], last_txn_id = [%s]\n", csNextBatchId, csNextTxnId, csLastTxnId));

	while ((iBatchIdRet == PD_BATCH_ID_FINDING) && (iRet != INT_ERR)) {

		// Get Batch Type Info
        	iDtlRet = GetBatchTypeInfo(csTmpBatchId, hBatchTypeInfo, hContext);

		if (iDtlRet == PD_FOUND) {

/* batch_type */
			if (GetField_Char(hBatchTypeInfo,"batch_type",&cBatchType)) {
DEBUGLOG(("CheckVoidTxnIdValid:: GetBatchTypeInfo, cBatchType = [%c]\n", cBatchType));
			}

/* batch_sub_type */
			if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cBatchSubType)) {
DEBUGLOG(("CheckVoidTxnIdValid:: GetBatchTypeInfo, cBatchSubType = [%c]\n", cBatchSubType));
			}
		}

/* batch_id */
DEBUGLOG(("CheckVoidTxnIdValid:: GetBatchTypeInfo, csBatchId = [%s]\n", csTmpBatchId));
	
		if (iDtlRet == PD_FOUND) {
          		iDtlRet = PD_FALSE;

			// Check if Batch Sub Type is Undo
             		if ((cBatchSubType == PD_GENERAL_UNDO_RECON)
                    	    || (cBatchSubType == PD_GENERAL_UNDO_BAL_TRF)
		    	    || (cBatchSubType == PD_COMBINE_UNDO_RECON)
           		)
              		{
				// Check is void txn code
                    		iDtlRet = IsVoidTxnCodeTxnId(csTmpTxnId, hContext);
	
                     		if (iDtlRet == PD_TRUE) {
                             		iBatchIdRet = PD_BATCH_ID_INVALID;
                      		} else if (iDtlRet == PD_FALSE) {

					// Check is multi batch
					iDtlRet = IsMultiBatchTxnId(csTmpTxnId, hContext);

					if (iDtlRet == PD_TRUE) {
						iDtlRet = PD_FOUND;		

						// Get next batch by revive txn relation
						iDtlRet = GetNextBatchIdByReviveTxnRelation(PD_BATCH_DESC_ORDER_LAST_REC, csTmpBatchId, csTmpTxnId, csNextBatchId, csNextTxnId, hContext);

						if (iDtlRet == PD_FOUND) {
DEBUGLOG(("CheckVoidTxnIdValid:: next_batch_id = [%s], next_txn_id = [%s]\n", csNextBatchId, csNextTxnId));

                                        		strcpy(csTmpBatchId, csNextBatchId);
                                        		strcpy(csTmpTxnId, csNextTxnId);

							iBatchIdRet = PD_BATCH_ID_FINDING;
                                        	} else if (iDtlRet == PD_NOT_FOUND) {
                                                	iBatchIdRet = PD_BATCH_ID_INVALID;
                                        	} else {
                                                	iRet = INT_ERR;
                                        	}
                       	 		} else if (iDtlRet == PD_FALSE) {
				
						while ((iBatchSubTypeUndoRet == PD_TRUE) && (iRet != INT_ERR)) {
							iDtlRet = PD_FOUND;

							// Get prev batch by revive txn relation
							iDtlRet = GetPrevBatchIdByReviveTxnRelation(PD_BATCH_DESC_ORDER_LAST_REC, csTmpBatchId, csTmpTxnId, csPrevBatchId, csPrevTxnId, hContext);						
							if (iDtlRet == PD_FOUND) {
DEBUGLOG(("CheckVoidTxnIdValid:: prev_batch_id = [%s], prev_txn_id = [%s]\n", csPrevBatchId, csPrevTxnId));

								strcpy(csTmpBatchId, csPrevBatchId);
                                                        	strcpy(csTmpTxnId, csPrevTxnId);

								// Get Batch Type Info
                						iDtlRet = GetBatchTypeInfo(csPrevBatchId, hBatchTypeInfo, hContext);

                						if (iDtlRet == PD_FOUND) {

/* batch_type */
                        						if (GetField_Char(hBatchTypeInfo,"batch_type",&cPrevBatchType)) {
DEBUGLOG(("CheckVoidTxnIdValid:: GetBatchTypeInfo, cPrevBatchType = [%c]\n", cPrevBatchType));
                        						}

/* batch_sub_type */
                        						if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cPrevBatchSubType)) {
DEBUGLOG(("CheckVoidTxnIdValid:: GetBatchTypeInfo, cPrevBatchSubType = [%c]\n", cPrevBatchSubType));
                        						}
                						}
					
								if ((cPrevBatchSubType != PD_GENERAL_UNDO_RECON)
                                                    		    && (cPrevBatchSubType != PD_GENERAL_UNDO_BAL_TRF)
                                                    		    && (cPrevBatchSubType != PD_COMBINE_UNDO_RECON)
                                                		)
                                                		{
									iBatchSubTypeUndoRet = PD_FALSE;

									iDtlRet = PD_TRUE;
									
									// Check is voided batch								
									iDtlRet = IsP2VoidedBatchId(csPrevBatchId, hContext);

                                                			if (iDtlRet == PD_TRUE) {
                                                        			iBatchIdRet = PD_BATCH_ID_INVALID;
                                                			} else if (iDtlRet == PD_FALSE) {
                                                        			iBatchIdRet = PD_BATCH_ID_VALID;
                                                			} else {
                                                        			iRet = INT_ERR;
                                                			}	
								}
								
							} else {
                                                        	iRet = INT_ERR;
                                                	}
						}
					} else {
						iRet = INT_ERR;
					}
                       		} else {
					iRet = INT_ERR;
				}
			} else {
				// Check is offset
                    		iDtlRet = IsOffsetTxnId(csTmpTxnId, hContext);

                    		if (iDtlRet == PD_TRUE) {
                           		iBatchIdRet = PD_BATCH_ID_INVALID;
				} else if (iDtlRet == PD_FALSE) {
					iDtlRet = PD_OK;

					// Get last txn id in the batch
					iDtlRet = GetLastTxnIdByRTDescOrder(csTmpBatchId, csLastTxnId, hContext);			
DEBUGLOG(("CheckVoidTxnIdValid:: tmp_batch_id = [%s], last_txn_id = [%s]\n", csTmpBatchId, csLastTxnId));

					if (iDtlRet == PD_OK) {
                                		iDtlRet = PD_FOUND;

						// Check is multi batch
                                		iDtlRet = IsMultiBatchTxnId(csLastTxnId, hContext);

                                		if (iDtlRet == PD_TRUE) {
							iDtlRet = PD_FOUND;
	
							// Get next batch by revive txn relation
							iDtlRet = GetNextBatchIdByReviveTxnRelation(PD_BATCH_DESC_ORDER_LAST_REC, csTmpBatchId, csLastTxnId, csNextBatchId, csNextTxnId, hContext);
	
                                        		if (iDtlRet == PD_FOUND) {

								// Get next batch by batch relation
								iDtlRet = GetNextBatchIdByBatchRelation(csTmpBatchId, csLastTxnId, csTmpNextBatchId, hContext); 
						
								if (iDtlRet == PD_FOUND) {
									iDtlRet = PD_TRUE;				

									// Check P2Voided Batch Id
                                        				iDtlRet = IsP2VoidedBatchId(csTmpBatchId, hContext);
                                        				if (iDtlRet == PD_TRUE) {
                                                				iBatchIdRet = PD_BATCH_ID_INVALID;
                                        				} else if (iDtlRet == PD_FALSE) {
DEBUGLOG(("CheckVoidTxnIdValid:: next_batch_id = [%s], next_txn_id = [%s]\n", csNextBatchId, csNextTxnId));

                                                                                strcpy(csTmpBatchId, csNextBatchId);
                                                                                strcpy(csTmpTxnId, csNextTxnId);

                                                                                iBatchIdRet = PD_BATCH_ID_FINDING;
                                        				} else {
                                                				iRet = INT_ERR;
                                					}
								} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("CheckVoidTxnIdValid:: next_batch_id = [%s], next_txn_id = [%s]\n", csNextBatchId, csNextTxnId));

                                                                       	strcpy(csTmpBatchId, csNextBatchId);
                                                                    	strcpy(csTmpTxnId, csNextTxnId);

                                                                    	iBatchIdRet = PD_BATCH_ID_FINDING;
                                        			} else {
                                         				iRet = INT_ERR;
								}
                                        		} else if (iDtlRet == PD_NOT_FOUND) {
                                        		        iBatchIdRet = PD_BATCH_ID_INVALID;
                                        		} else {
                                        		        iRet = INT_ERR;
                                        		}
                           			} else if (iDtlRet == PD_FALSE) {

							// Check is voided batch
							iDtlRet = IsP2VoidedBatchId(csTmpBatchId, hContext);
                                        
							if (iDtlRet == PD_TRUE) {
                                        		        iBatchIdRet = PD_BATCH_ID_INVALID;
                                        		} else if (iDtlRet == PD_FALSE) {

								// Check Input Txn Id
                                				iDtlRet = IsInputTxnId(csTmpBatchId, csLastTxnId, hContext);
                                				if (iDtlRet == PD_TRUE) {
                                        				iBatchIdRet = PD_BATCH_ID_INVALID;
                                				} else if (iDtlRet == PD_FALSE) {
                                        				iBatchIdRet = PD_BATCH_ID_VALID;
                               		 			} else {
                                        				iRet = INT_ERR;
                                				}						
                                        		} else {
                                        		        iRet = INT_ERR;
                                        		}					
                                		} else {
                                 		       iRet = INT_ERR;
                                		}
					} else {
						iRet = INT_ERR;
					}
                 	    	} else {
					iRet = INT_ERR;
                      		}				
			}
		} else {
			iRet = INT_ERR;
		}
	}

        if (iRet == INT_ERR) {
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("CheckVoidTxnIdValid:: Batch Sub Type Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT::Batch Sub Type Not Found!!!\n");
	} else {
                if (iBatchIdRet == PD_BATCH_ID_VALID) {
                        iRet = PD_TRUE;
                } else {
                        iRet = PD_FALSE;
                }
        }

	hash_destroy(hBatchTypeInfo);
        FREE_ME(hBatchTypeInfo);

DEBUGLOG(("CheckVoidTxnIdValid:: iRet = [%d]\n",iRet));
        return iRet;
}

int	FindVoidBatchId(const char* csBatchId, const char* csTxnId, char* csFoundBatchId, char* csFoundTxnId, hash_t *hContext)
{
	int     iRet = PD_FOUND;
	int	iDtlRet = PD_FOUND;

	int	iBatchIdRet = PD_BATCH_ID_FINDING;	

	char    cBatchType;
        char    cBatchSubType;
	char    cFoundBatchType;
        char    cFoundBatchSubType;

	char    *csTmpTxnId = (char*) malloc (64);
	char    csTmpBatchId[PD_TXN_SEQ_LEN + 1];

	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchTypeInfo,0);

	cBatchType = ' ';
	cBatchSubType = ' ';
	cFoundBatchType = ' ';
        cFoundBatchSubType = ' ';

	strcpy(csFoundBatchId, csBatchId);
        sprintf(csFoundTxnId, "%s", csTxnId);

	strcpy(csTmpBatchId, csBatchId);
        sprintf(csTmpTxnId, "%s", csTxnId);	

DEBUGLOG(("FindVoidBatchId:: batch_id = [%s], txn_id = [%s], found_batch_id = [%s], found_txn_id = [%s]\n", csBatchId, csTxnId, csFoundBatchId, csFoundTxnId));

	while ((iBatchIdRet == PD_BATCH_ID_FINDING) && (iRet != INT_ERR)) {
        	hash_init(hBatchTypeInfo,0);

		// Get Batch Sub Type
		iDtlRet = GetBatchTypeInfo(csTmpBatchId, hBatchTypeInfo, hContext);

		if (iDtlRet == PD_FOUND) {

/* batch_type */
        		if (GetField_Char(hBatchTypeInfo,"batch_type",&cBatchType)) {
DEBUGLOG(("FindVoidBatchId:: GetBatchTypeInfo, cBatchType = [%c]\n", cBatchType));
        		}

/* batch_sub_type */
        		if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cBatchSubType)) {
DEBUGLOG(("FindVoidBatchId:: GetBatchTypeInfo, cBatchSubType = [%c]\n", cBatchSubType));
        		}
		}

		hash_destroy(hBatchTypeInfo);

		if (iDtlRet == PD_FOUND) {
			iDtlRet = PD_FALSE;
			
			// Check if Batch Sub Type is Undo
			if ((cBatchSubType == PD_GENERAL_UNDO_RECON)
			    || (cBatchSubType == PD_GENERAL_UNDO_BAL_TRF)
			    || (cBatchSubType == PD_COMBINE_UNDO_RECON)
			)
			{
				// Check is void txn code
				iDtlRet = IsVoidTxnCodeTxnId(csTmpTxnId, hContext);
				
				if (iDtlRet == PD_TRUE) {
					iBatchIdRet = PD_BATCH_ID_INVALID;
				} else if (iDtlRet == PD_FALSE) {
					iDtlRet = PD_FOUND;					

					iDtlRet = GetPrevBatchIdByReviveTxnRelation(PD_BATCH_DESC_ORDER_FIRST_REC, csTmpBatchId, csTmpTxnId, csFoundBatchId, csFoundTxnId, hContext);	
DEBUGLOG(("FindVoidBatchId:: found_batch_id = [%s], found_txn_id = [%s]\n", csFoundBatchId, csFoundTxnId));
				
					strcpy(csTmpBatchId, csFoundBatchId);
                       	 		sprintf(csTmpTxnId, "%s", csFoundTxnId);
					
					if (iDtlRet == PD_FOUND) {
						iBatchIdRet = PD_BATCH_ID_FINDING;
					} else if (iDtlRet == PD_NOT_FOUND) {
						iBatchIdRet = PD_BATCH_ID_INVALID;
					} else {
						iRet = INT_ERR;
					}
				} else {
					iRet = INT_ERR;
				}			
			} else {
				// Check is offset
				iDtlRet = IsOffsetTxnId(csTmpTxnId, hContext);
					
				if (iDtlRet == PD_TRUE) {
                                        iBatchIdRet = PD_BATCH_ID_INVALID;
                                } else if (iDtlRet == PD_FALSE) { 
					iBatchIdRet = GetPrevBatchIdByMultiBatchTxnRelation(PD_BATCH_DESC_ORDER_LAST_REC, csTmpBatchId, csTmpTxnId, csFoundBatchId, csFoundTxnId, hContext);
DEBUGLOG(("FindVoidBatchId:: found_batch_id = [%s], found_txn_id = [%s]\n", csFoundBatchId, csFoundTxnId));
					
					strcpy(csTmpBatchId, csFoundBatchId);
                                        sprintf(csTmpTxnId, "%s", csFoundTxnId);

					// Check is most previous batch id
					if (iBatchIdRet == PD_BATCH_ID_FINDING) {
						iDtlRet = PD_FOUND;

						hash_init(hBatchTypeInfo,0);

               	 				// Get Batch Sub Type
                				iDtlRet = GetBatchTypeInfo(csFoundBatchId, hBatchTypeInfo, hContext);

                				if (iDtlRet == PD_FOUND) {

/* batch_type */
                        				if (GetField_Char(hBatchTypeInfo,"batch_type",&cFoundBatchType)) {
DEBUGLOG(("FindVoidBatchId:: GetBatchTypeInfo, cFoundBatchType = [%c]\n", cFoundBatchType));
                        				}

/* batch_sub_type */
                        				if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cFoundBatchSubType)) {
DEBUGLOG(("FindVoidBatchId:: GetBatchTypeInfo, cFoundBatchSubType = [%c]\n", cFoundBatchSubType));
                        				}
                				}

                				hash_destroy(hBatchTypeInfo);					 
	
						if ((cFoundBatchSubType != PD_GENERAL_UNDO_RECON)
                            		  	    && (cFoundBatchSubType != PD_GENERAL_UNDO_BAL_TRF)
                            			    && (cFoundBatchSubType != PD_COMBINE_UNDO_RECON)
                        			)
						{
							iBatchIdRet = PD_BATCH_ID_VALID;	
						}
					}
				} else {	
					iRet = INT_ERR;
				}		
			}
		} else {
			iRet = INT_ERR;
		}
	} 

DEBUGLOG(("FindVoidBatchId:: iBatchIdRet = [%d]\n", iBatchIdRet));

	if (iRet == INT_ERR) {
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("FindVoidBatchId:: Batch Sub Type Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT::Batch Sub Type Not Found!!!\n");
	} else {
		if (iBatchIdRet == PD_BATCH_ID_VALID) {
			iRet = PD_FOUND;
		} else {
			iRet = PD_NOT_FOUND;
		}
	} 

	FREE_ME(csTmpTxnId);

        FREE_ME(hBatchTypeInfo);

DEBUGLOG(("FindVoidBatchId:: iRet = [%d]\n",iRet));
        return iRet;        
}

int	GetBatchTypeInfo(const char* csBatchId, hash_t *hBatchTypeInfo, hash_t *hContext)
{
	int     iRet = PD_NOT_FOUND;

	char	cTmp;

        hash_t  *hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

	cTmp = ' ';

        PutField_CString(hTmpRec,"batch_id",csBatchId);

DEBUGLOG(("GetBatchTypeInfo:: Call DBOLBatchTxnRelation GetBatchTypeInfo, csBatchId[%s]\n", csBatchId));
        DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetBatchTypeInfo");
        iRet = (unsigned long)(*DBObjPtr)(hTmpRec);
        if (iRet == PD_FOUND) {
DEBUGLOG(("GetBatchTypeInfo:: Call DBOLBatchTxnRelation:: Batch Type Info Found!!!\n"));
		
/* batch_type */
		if (GetField_Char(hTmpRec, "batch_type", &cTmp)) {   
DEBUGLOG(("GetBatchTypeInfo:: Call DBOLBatchTxnRelation:: batch_type = [%c]\n", cTmp));
			PutField_Char(hBatchTypeInfo,"batch_type", cTmp);
		}

/* batch_sub_type */
		if (GetField_Char(hTmpRec, "batch_sub_type", &cTmp)) {
DEBUGLOG(("GetBatchTypeInfo:: Call DBOLBatchTxnRelation:: batch_sub_type = [%c]\n", cTmp));
			PutField_Char(hBatchTypeInfo,"batch_sub_type", cTmp);
                }
    
	} else if (iRet == PD_NOT_FOUND) {
DEBUGLOG(("GetBatchTypeInfo:: Call DBOLBatchTxnRelation:: Batch Type Info Not Found!!!\n"));
        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetBatchTypeInfo:: Call DBOLBatchTxnRelation:: Batch Type Info Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::GetBatchTypeInfo::Call DBOLBatchTxnRelation:: Batch Type Info Error!!!\n");
        }

        hash_destroy(hTmpRec);
        FREE_ME(hTmpRec);

DEBUGLOG(("GetBatchTypeInfo: iRet = [%d]\n",iRet));
        return iRet;
}	

int     GetPrevBatchIdByReviveTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csPrevBatchId, char* csPrevTxnId, hash_t *hContext)
{
	int     iRet = PD_FOUND;
	int     iDtlRet = PD_OK;

	char	*csTmp = NULL;

        hash_t  	*hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

        hash_t  	*hTmpBatchRec;
        hTmpBatchRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpBatchRec,0);

	hash_t  	*hRec = NULL;
        recordset_t     *rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	hash_t          *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rBatchRecordSet,0);

        PutField_Char(hTmpRec,"party_type",PD_TYPE_PSP);
        PutField_CString(hTmpRec,"p1_txn_id",csTxnId);
        PutField_Char(hTmpRec,"txn_level",PD_TXN_LEVEL);
        PutField_Char(hTmpRec,"relation_type",PD_REL_REGEN);

DEBUGLOG(("GetPrevBatchIdByReviveTxnRelation:: Call DBOLTxnRelation GetP2TxnId\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","GetP2TxnId");
        iRet = (unsigned long)(*DBObjPtr)(hTmpRec,rRecordSet);
        if (iRet == PD_FOUND) {
DEBUGLOG(("GetPrevBatchIdByReviveTxnRelation:: Call DBOLTxnRelation:: Txn Id Found!!!\n"));
		
		hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {

			if (GetField_CString(hRec, "p2_txn_id", &csTmp)) {
				sprintf(csPrevTxnId, "%s", csTmp);
DEBUGLOG(("GetPrevBatchIdByReviveTxnRelation:: Call DBOLTxnRelation:: p2_txn_id = [%s]\n", csPrevTxnId));
                		break;
			}
		
			hRec = RecordSet_GetNext(rRecordSet);
		}

		PutField_Char(hTmpBatchRec,"txn_level",PD_TXN_LEVEL);
	        PutField_CString(hTmpBatchRec,"txn_id",csPrevTxnId);

DEBUGLOG(("GetPrevBatchIdByReviveTxnRelation:: Call DBOLBatchTxnRelation::GetBatchId\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetBatchId");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTmpBatchRec,rBatchRecordSet);
                if (iDtlRet == PD_OK) {

                        hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                        while (hBatchRec) {		

				if (GetField_CString(hBatchRec, "batch_id", &csTmp)) {
					strcpy(csPrevBatchId, csTmp);				
DEBUGLOG(("GetPrevBatchIdByReviveTxnRelation:: Call DBOLTxnRelation:: batch_id = [%s]\n", csPrevBatchId));
					if (iBatchRTDesOrder == PD_BATCH_DESC_ORDER_FIRST_REC) {
						break;
					}
                        	}

				hBatchRec = RecordSet_GetNext(rBatchRecordSet);
			}

		} else {
                	iRet = INT_ERR;
                	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetPrevBatchIdByReviveTxnRelation:: Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT::GetPrevBatchIdByReviveTxnRelation::Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n");
        	}

        } else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("GetPrevBatchIdByReviveTxnRelation:: Call DBOLTxnRelation:: Txn Id Not Found!!!\n"));
        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetPrevBatchIdByReviveTxnRelation:: Call DBOLTxnRelation:: Txn Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::GetPrevBatchIdByReviveTxnRelation::Call DBOLTxnRelation:: Txn Id Error!!!\n");
        }

        hash_destroy(hTmpRec);
        FREE_ME(hTmpRec);

        hash_destroy(hTmpBatchRec);
        FREE_ME(hTmpBatchRec);

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

	RecordSet_Destroy(rBatchRecordSet);
        FREE_ME(rBatchRecordSet);

DEBUGLOG(("GetPrevBatchIdByReviveTxnRelation: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetNextBatchIdByReviveTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csNextBatchId, char* csNextTxnId, hash_t *hContext)
{
	int     iRet = PD_FOUND;
	int     iDtlRet = PD_OK;

	char	*csTmp = NULL;

        hash_t  	*hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

        hash_t  	*hTmpBatchRec;
        hTmpBatchRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpBatchRec,0);

	hash_t  	*hRec = NULL;
        recordset_t     *rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	hash_t          *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rBatchRecordSet,0);

        PutField_Char(hTmpRec,"party_type",PD_TYPE_PSP);
        PutField_CString(hTmpRec,"p2_txn_id",csTxnId);
        PutField_Char(hTmpRec,"txn_level",PD_TXN_LEVEL);
        PutField_Char(hTmpRec,"relation_type",PD_REL_REGEN);

DEBUGLOG(("GetNextBatchIdByReviveTxnRelation:: Call DBOLTxnRelation GetP1TxnId\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","GetP1TxnId");
        iRet = (unsigned long)(*DBObjPtr)(hTmpRec,rRecordSet);
        if (iRet == PD_FOUND) {
DEBUGLOG(("GetNextBatchIdByReviveTxnRelation:: Call DBOLTxnRelation:: Txn Id Found!!!\n"));
		
		hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {

			if (GetField_CString(hRec, "p1_txn_id", &csTmp)) {
				strcpy(csNextTxnId, csTmp);
DEBUGLOG(("GetNextBatchIdByReviveTxnRelation:: Call DBOLTxnRelation:: p1_txn_id = [%s]\n", csNextTxnId));
                		break;
			}
		
			hRec = RecordSet_GetNext(rRecordSet);
		}

		PutField_Char(hTmpBatchRec,"txn_level",PD_TXN_LEVEL);
	        PutField_CString(hTmpBatchRec,"txn_id",csNextTxnId);

DEBUGLOG(("GetNextBatchIdByReviveTxnRelation:: Call DBOLBatchTxnRelation::GetBatchId\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetBatchId");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTmpBatchRec,rBatchRecordSet);
                if (iDtlRet == PD_OK) {

                        hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                        while (hBatchRec) {		

				if (GetField_CString(hBatchRec, "batch_id", &csTmp)) {
					strcpy(csNextBatchId, csTmp);
DEBUGLOG(("GetNextBatchIdByReviveTxnRelation:: Call DBOLTxnRelation:: batch_id = [%s]\n", csNextBatchId));
					if (iBatchRTDesOrder == PD_BATCH_DESC_ORDER_FIRST_REC) {
						break;
					}
                        	}

				hBatchRec = RecordSet_GetNext(rBatchRecordSet);
			}

		} else {
                	iRet = INT_ERR;
                	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetNextBatchIdByReviveTxnRelation:: Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT::GetNextBatchIdByReviveTxnRelation::Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n");
        	}

        } else if (iRet == PD_NOT_FOUND) {
DEBUGLOG(("GetNextBatchIdByReviveTxnRelation:: Call DBOLTxnRelation:: Txn Id Not Found!!!\n"));
        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetNextBatchIdByReviveTxnRelation:: Call DBOLTxnRelation:: Txn Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::GetNextBatchIdByReviveTxnRelation::Call DBOLTxnRelation:: Txn Id Error!!!\n");
        }

        hash_destroy(hTmpRec);
        FREE_ME(hTmpRec);

        hash_destroy(hTmpBatchRec);
        FREE_ME(hTmpBatchRec);

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

	RecordSet_Destroy(rBatchRecordSet);
        FREE_ME(rBatchRecordSet);

DEBUGLOG(("GetNextBatchIdByReviveTxnRelation: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetPrevBatchIdByMultiBatchTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csPrevBatchId, char* csPrevTxnId, hash_t *hContext)
{
	int	iRet = PD_BATCH_ID_FINDING;
	int	iDtlRet = PD_OK;

	int	iCnt = 0;

	char 	*csTmpBatchId = NULL;

        hash_t          *hTmpBatchRec;
        hTmpBatchRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpBatchRec,0);

        hash_t          *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet = (recordset_t *)malloc (sizeof(recordset_t));

      	PutField_Char(hTmpBatchRec,"txn_level",PD_TXN_LEVEL);
      	PutField_CString(hTmpBatchRec,"txn_id",csTxnId);

DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation:: Call DBOLBatchTxnRelation::GetBatchId\n"));
      	recordset_init(rBatchRecordSet,0);
	
	DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetBatchId");
       	iDtlRet = (unsigned long)(*DBObjPtr)(hTmpBatchRec,rBatchRecordSet);
        if (iDtlRet == PD_OK) {

           	hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
             	while (hBatchRec) {

                    	if (GetField_CString(hBatchRec, "batch_id", &csTmpBatchId)) {
DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation:: Call DBOLTxnRelation:: batch_id = [%s]\n", csTmpBatchId));
				strcpy(csPrevBatchId,csTmpBatchId);
				if (iBatchRTDesOrder == PD_BATCH_DESC_ORDER_FIRST_REC) {
                              		break;
                             	}
                     	}

			iCnt++;		

                      	hBatchRec = RecordSet_GetNext(rBatchRecordSet);
             	}
		
		RecordSet_Destroy(rBatchRecordSet);
	
DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation: num_of_batch_id = [%d]\n", iCnt));
		iNumOfBatchId = iCnt;	

		// Check Multi Batch Id	
		if (iCnt == 1) {
			iDtlRet = PD_TRUE;

			// Check P2Voided Batch Id
			iDtlRet = IsP2VoidedBatchId(csBatchId, hContext);
                        if (iDtlRet == PD_TRUE) {
                        	iRet = PD_BATCH_ID_INVALID;  
                    	} else if (iDtlRet == PD_FALSE) {
                     		
				// Check Input Txn Id
                                iDtlRet = IsInputTxnId(csBatchId, csTxnId, hContext);                     		
				if (iDtlRet == PD_TRUE) {
					iRet = PD_BATCH_ID_INVALID;
				} else if (iDtlRet == PD_FALSE) {
					iRet = PD_BATCH_ID_VALID;
				} else {
                                	iRet = iDtlRet;
                       	 	}					
			} else {
                              	iRet = iDtlRet;
                       	}

		} else if ((iCnt > 1) && (strcmp(csBatchId, csPrevBatchId))){
 			iDtlRet = PD_OK;
			iCnt = 0;

DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation:: Call DBOLBatchRelation::GetBatchIdByOrgBatchId\n"));
	       		recordset_init(rBatchRecordSet,0);
        
        		DBObjPtr = CreateObj(DBPtr, "DBOLBatchRelation","GetBatchIdByOrgBatchId");
        		iDtlRet = (unsigned long)(*DBObjPtr)(csPrevBatchId,rBatchRecordSet);
        		if (iDtlRet == PD_OK) {

				hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                		while (hBatchRec) {

                        		if (GetField_CString(hBatchRec, "batch_id", &csTmpBatchId)) {
DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation:: Call DBOLBatchRelation:: batch_id = [%S]\n", csTmpBatchId));
                               	 		break;
                        		}

					iCnt++;					

                        		hBatchRec = RecordSet_GetNext(rBatchRecordSet);
                		}

                		RecordSet_Destroy(rBatchRecordSet);

				if (iCnt == 0) {
					if (!strcmp(csTxnType, PD_TXN_TYPE_PSP_SETTLEMENT)) {
						iRet = PD_BATCH_ID_VALID;
					} 
				} else {
					iDtlRet = PD_TRUE;

					// Check P2Voided Batch Id
                        		iDtlRet = IsP2VoidedBatchId(csPrevBatchId, hContext);
                        		if (iDtlRet == PD_TRUE) {
                                		iRet = PD_BATCH_ID_INVALID;
                        		} else if (iDtlRet == PD_FALSE) {
						if (!strcmp(csTxnType, PD_TXN_TYPE_PSP_SETTLEMENT)) {
							iRet = PD_BATCH_ID_VALID;
						}
                                	} else {
                                	        iRet = iDtlRet;
                                	}
				}
			
			} else {
				iRet = INT_ERR;
                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation:: Call DBOLBatchRelation:: Batch Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::GetPrevBatchIdByMultiBatchTxnRelation::Call DBOLBatchRelation:: Batch Id Error!!!\n");
			}
		}
       	} else {
             	iRet = INT_ERR;
               	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation:: Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT::GetPrevBatchIdByMultiBatchTxnRelation::Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n");
       	}	

	hash_destroy(hTmpBatchRec);
        FREE_ME(hTmpBatchRec);

        FREE_ME(rBatchRecordSet);

DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetNextBatchIdByMultiBatchTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csNextBatchId, char* csNextTxnId, hash_t *hContext)
{
	int     iRet = PD_FOUND;
	int     iDtlRet = PD_OK;

        int     iCnt = 0;

        char    *csTmpBatchId = NULL;

        hash_t          *hTmpBatchRec;
        hTmpBatchRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpBatchRec,0);

        hash_t          *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        
	PutField_Char(hTmpBatchRec,"txn_level",PD_TXN_LEVEL);
        PutField_CString(hTmpBatchRec,"txn_id",csTxnId);

DEBUGLOG(("GetNextBatchIdByMultiBatchTxnRelation:: Call DBOLBatchTxnRelation::GetBatchIdByRTAscOrder\n"));
        recordset_init(rBatchRecordSet,0);

        DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetBatchIdByRTAscOrder");
        iDtlRet = (unsigned long)(*DBObjPtr)(hTmpBatchRec,rBatchRecordSet);
        if (iDtlRet == PD_OK) {
		
		hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                while (hBatchRec) {

                        if (GetField_CString(hBatchRec, "batch_id", &csTmpBatchId)) {
DEBUGLOG(("GetNextBatchIdByMultiBatchTxnRelation:: Call DBOLTxnRelation:: batch_id = [%s]\n", csTmpBatchId));
                                strcpy(csNextBatchId,csTmpBatchId);
				if (iBatchRTDesOrder == PD_BATCH_DESC_ORDER_FIRST_REC) {
                                	break;
				}
                        }

                        iCnt++;

                        hBatchRec = RecordSet_GetNext(rBatchRecordSet);
                }

                RecordSet_Destroy(rBatchRecordSet);

DEBUGLOG(("GetNextBatchIdByMultiBatchTxnRelation: num_of_batch_id = [%d]\n", iCnt));

		// Check Multi Batch Id
		if (iCnt == 1) {
                        iRet = PD_NOT_FOUND;
		} else if ((iCnt > 1) && (strcmp(csBatchId, csNextBatchId))){
			iRet = PD_FOUND;
		}
	} else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetNextBatchIdByMultiBatchTxnRelation:: Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT::GetNextBatchIdByMultiBatchTxnRelation::Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n");
        }

	hash_destroy(hTmpBatchRec);
        FREE_ME(hTmpBatchRec);

        FREE_ME(rBatchRecordSet);
			
DEBUGLOG(("GetNextBatchIdByMultiBatchTxnRelation: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetPrevBatchIdByBatchRelation(const char* csBatchId, const char* csTxnId, char* csPrevBatchId, hash_t *hContext)
{
	int     iRet = PD_OK;
	int     iDtlRet = PD_OK;
	
	char    *csTmpBatchId = NULL;

        hash_t          *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rBatchRecordSet,0);

DEBUGLOG(("GetPrevBatchIdByBatchRelation:: Call DBOLBatchRelation::GetOrgBatchIdByBatchId\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLBatchRelation","GetOrgBatchIdByBatchId");
        iDtlRet = (unsigned long)(*DBObjPtr)(csBatchId,rBatchRecordSet);
        if (iDtlRet == PD_OK) {

                hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                while (hBatchRec) {

                        if (GetField_CString(hBatchRec, "batch_id", &csTmpBatchId)) {
DEBUGLOG(("GetPrevBatchIdByBatchRelation:: Call DBOLBatchRelation:: batch_id = [%s]\n", csTmpBatchId));
                                strcpy(csPrevBatchId,csTmpBatchId);
                                iRet = PD_FOUND;
                                break;
                        }

                        hBatchRec = RecordSet_GetNext(rBatchRecordSet);
                }

        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetPrevBatchIdByBatchRelation:: Call DBOLBatchRelation:: Batch Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::GetPrevBatchIdByBatchRelation::Call DBOLBatchRelation:: Batch Id Error!!!\n");
        }

        RecordSet_Destroy(rBatchRecordSet);
        FREE_ME(rBatchRecordSet);

DEBUGLOG(("GetPrevBatchIdByBatchRelation: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetNextBatchIdByBatchRelation(const char* csBatchId, const char* csTxnId, char* csNextBatchId, hash_t *hContext)
{
	int     iRet = PD_NOT_FOUND;
	int     iDtlRet = PD_OK;

        char    *csTmpBatchId = NULL;

        hash_t          *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rBatchRecordSet,0);

DEBUGLOG(("GetNextBatchIdByBatchRelation:: Call DBOLBatchRelation::GetBatchIdByOrgBatchId, csBatchId = [%s]\n", csBatchId));
       	DBObjPtr = CreateObj(DBPtr, "DBOLBatchRelation","GetBatchIdByOrgBatchId");
        iDtlRet = (unsigned long)(*DBObjPtr)(csBatchId,rBatchRecordSet);
     	if (iDtlRet == PD_OK) {

         	hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
              	while (hBatchRec) {

                 	if (GetField_CString(hBatchRec, "batch_id", &csTmpBatchId)) {
DEBUGLOG(("GetNextBatchIdByBatchRelation:: Call DBOLBatchRelation:: batch_id = [%s]\n", csTmpBatchId));
				strcpy(csNextBatchId,csTmpBatchId);
                        	iRet = PD_FOUND;       
				break;
                    	}

                    	hBatchRec = RecordSet_GetNext(rBatchRecordSet);
           	}

     	} else {
            	iRet = INT_ERR;
               	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetNextBatchIdByBatchRelation:: Call DBOLBatchRelation:: Batch Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::GetNextBatchIdByBatchRelation::Call DBOLBatchRelation:: Batch Id Error!!!\n");
       	}
	
        RecordSet_Destroy(rBatchRecordSet);
        FREE_ME(rBatchRecordSet);
	
DEBUGLOG(("GetNextBatchIdByBatchRelation: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetLastTxnIdByRTDescOrder(const char* csBatchId, char* csLastTxnId, hash_t *hContext)
{
	int     iRet = PD_OK;
	int     iDtlRet = PD_FOUND;

	int	iRecCnt = 0;

	char    cBatchType;
        char    cBatchSubType;

        char    *csTmpTxnId = NULL;

	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchTypeInfo,0);

        hash_t          *hRls;
        hRls = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRls,0);

        hash_t          *hTxnRec = NULL;
        recordset_t     *rTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTxnRecordSet,0);

	cBatchType = ' ';
        cBatchSubType = ' ';

	// Get Batch Type Info
        iDtlRet = GetBatchTypeInfo(csBatchId, hBatchTypeInfo, hContext);

	if (iDtlRet == PD_FOUND) {

/* batch_type */
	        if (GetField_Char(hBatchTypeInfo,"batch_type",&cBatchType)) {
DEBUGLOG(("GetLastTxnIdByRTDescOrder:: GetBatchTypeInfo, batch_type = [%c]\n",cBatchType));
        	}       

/* batch_sub_type */
        	if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cBatchSubType)) {
DEBUGLOG(("GetLastTxnIdByRTDescOrder:: GetBatchTypeInfo, batch_sub_type = [%c]\n",cBatchSubType));
        	}
	}

/* batch_id */
DEBUGLOG(("GetLastTxnIdByRTDescOrder:: GetBatchTypeInfo, csBatchId = [%s]\n",csBatchId));

        PutField_Char(hRls,"batch_type",cBatchType);
        PutField_Char(hRls,"batch_sub_type",cBatchSubType);
        PutField_CString(hRls,"batch_id",csBatchId);
        PutField_Char(hRls,"txn_level",PD_TXN_LEVEL);

	// Get TxnId from Batch
DEBUGLOG(("GetLastTxnIdByRTDescOrder:: Call DBOLBatchTxnRelation:GetTxnId\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetTxnId");
        iRet = (unsigned long)(*DBObjPtr)(hRls,rTxnRecordSet);
        if (iRet == PD_OK) {

                hTxnRec = RecordSet_GetFirst(rTxnRecordSet);
                while (hTxnRec) {

/* txn_id */
                        if (GetField_CString(hTxnRec,"txn_id",&csTmpTxnId)) {
DEBUGLOG(("GetLastTxnIdByRTDescOrder:: Call DBOLBatchTxnRelation::GetTxnId() txn_id = [%s]\n",csTmpTxnId));
			}				
				
			// First Record
			if (iRecCnt == 0) {
DEBUGLOG(("GetLastTxnIdByRTDescOrder:: Call DBOLBatchTxnRelation::GetTxnId() first_record\n"));

				strcpy(csLastTxnId,csTmpTxnId);
DEBUGLOG(("GetLastTxnIdByRTDescOrder:: Call DBOLBatchTxnRelation::GetTxnId() last_txn_id = [%s]\n", csLastTxnId));				
				break;
                       	}	

			iRecCnt++;

			hTxnRec = RecordSet_GetNext(rTxnRecordSet);
                }
        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetLastTxnIdByRTDescOrder:: Call DBOLBatchTxnRelation::GetTxnId() Invalid Batch Id!!!\n"));
ERRLOG("TxnOmtByUsRBT:: GetLastTxnIdByRTDescOrder:: Call DBOLBatchTxnRelation::GetTxnId() Invalid Batch Id!!!\n");
        }

	hash_destroy(hBatchTypeInfo);
        FREE_ME(hBatchTypeInfo);
	
	hash_destroy(hRls);
        FREE_ME(hRls);

        RecordSet_Destroy(rTxnRecordSet);
        FREE_ME(rTxnRecordSet);

DEBUGLOG(("GetLastTxnIdByRTDescOrder: iRet = [%d]\n",iRet));	
	return iRet;				
}

int     IsInputTxnId(const char* csBatchId, const char* csTxnId, hash_t *hContext)
{
        int     iRet = PD_FALSE;
	int     iDtlRet = PD_FOUND;

	char	cBatchType;
	char	cBatchSubType;	

	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchTypeInfo,0);

        hash_t  *hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

	cBatchType = ' ';
        cBatchSubType = ' ';

	//Get Batch Type Info
        iDtlRet = GetBatchTypeInfo(csBatchId, hBatchTypeInfo, hContext);

	if (iDtlRet == PD_FOUND) {

/* batch_type */
	        if (GetField_Char(hBatchTypeInfo,"batch_type",&cBatchType)) {
DEBUGLOG(("IsInputTxnId:: GetBatchTypeInfo, batch_type = [%c]\n",cBatchType));
	        }

/* batch_sub_type */
        	if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cBatchSubType)) {
DEBUGLOG(("IsInputTxnId:: GetBatchTypeInfo, batch_sub_type = [%c]\n",cBatchSubType));
        	}
	}

/* batch_id */
DEBUGLOG(("IsInputTxnId:: GetBatchTypeInfo, csBatchId = [%s]\n",csBatchId));

        PutField_Char(hTmpRec,"batch_type",cBatchType);
        PutField_Char(hTmpRec,"batch_sub_type",cBatchSubType);
        PutField_CString(hTmpRec,"batch_id",csBatchId);
        PutField_CString(hTmpRec,"txn_id",csTxnId);
	PutField_Char(hTmpRec,"txn_level",PD_TXN_LEVEL);

DEBUGLOG(("IsInputTxnId:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation CheckIsInputTxnId\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","CheckIsInputTxnId");
        iRet = (unsigned long)(*DBObjPtr)(hTmpRec);
        if (iRet == PD_TRUE) {
DEBUGLOG(("IsInputTxnId:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation:: Input Txn Id True!!!\n"));
        } else if (iRet == PD_FALSE) {
DEBUGLOG(("IsInputTxnId:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation:: Input Txn Id False!!!\n"));
        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsInputTxnId:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation:: Input Txn Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::IsInputTxnId::Call DBOLBatchTxnRelation:: Input Txn Id Error!!!\n");
        }

	hash_destroy(hBatchTypeInfo);
        FREE_ME(hBatchTypeInfo);

        hash_destroy(hTmpRec);
        FREE_ME(hTmpRec);

DEBUGLOG(("IsInputTxnId: iRet = [%d]\n",iRet));
        return iRet;
}

int     IsReviveTxnId(const char* csBatchId, const char* csTxnId, hash_t *hContext)
{
        int     iRet = PD_FALSE;
	int     iDtlRet = PD_FOUND;

	char    cBatchType;
        char    cBatchSubType;

	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchTypeInfo,0);

        hash_t  *hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);
	
	cBatchType = ' ';
        cBatchSubType = ' ';

	// Get Batch Type Info
        iDtlRet = GetBatchTypeInfo(csBatchId, hBatchTypeInfo, hContext);

	if (iDtlRet == PD_FOUND) {

/* batch_type */
	        if (GetField_Char(hBatchTypeInfo,"batch_type",&cBatchType)) {
DEBUGLOG(("IsReviveTxnId:: GetBatchTypeInfo, batch_type = [%c]\n",cBatchType));
        	}

/* batch_sub_type */
        	if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cBatchSubType)) {
DEBUGLOG(("IsReviveTxnId:: GetBatchTypeInfo, batch_sub_type = [%c]\n",cBatchSubType));
        	}
	}

/* batch_id */
DEBUGLOG(("IsReviveTxnId:: GetBatchTypeInfo, csBatchId = [%s]\n",csBatchId));

        PutField_Char(hTmpRec,"batch_type",cBatchType);
        PutField_Char(hTmpRec,"batch_sub_type",cBatchSubType);
        PutField_CString(hTmpRec,"batch_id",csBatchId);
        PutField_CString(hTmpRec,"txn_id",csTxnId);
        PutField_Char(hTmpRec,"txn_level",PD_TXN_LEVEL);

DEBUGLOG(("IsReviveTxnId:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation CheckIsReviveTxnId\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","CheckIsReviveTxnId");
        iRet = (unsigned long)(*DBObjPtr)(hTmpRec);
        if (iRet == PD_TRUE) {
DEBUGLOG(("IsReviveTxnId:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation:: Revive Txn Id True!!!\n"));
        } else if (iRet == PD_FALSE) {
DEBUGLOG(("IsReviveTxnId:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation:: Revive Txn Id False!!!\n"));
        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsReviveTxnId:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation:: Revive Txn Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::IsReviveTxnId::Call DBOLBatchTxnRelation:: Revive Txn Id Error!!!\n");
        }

	hash_destroy(hBatchTypeInfo);
        FREE_ME(hBatchTypeInfo);

        hash_destroy(hTmpRec);
        FREE_ME(hTmpRec);

DEBUGLOG(("IsReviveTxnId: iRet = [%d]\n",iRet));
        return iRet;
}

int     IsVoidTxnCodeTxnId(const char* csTxnId, hash_t *hContext)
{
	int     iRet = PD_FALSE;

	int	iTmp = 0;

        char    *csTmp = NULL;

        hash_t  *hRec = NULL;

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

	// Get Txn Header
        if (iRet == PD_OK) {
                recordset_init(rRecordSet,0);

DEBUGLOG(("IsVoidTxnCodeTxnId::Call DBOLTransaction:GetTxnHeader [%s]\n", csTxnId));
                DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnHeader");
                if ((*DBObjPtr)(csTxnId,rRecordSet) == PD_OK) {
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* txn_code */
                                if (GetField_CString(hRec, "txn_code", &csTmp)) {
DEBUGLOG(("IsVoidTxnCodeTxnId::call DBOLTransaction:: txn_code = [%s]\n", csTmp));
                                }

/* is_void */
                                DBObjPtr = CreateObj(DBPtr,"DBTxnCode","IsVoid");
                                iTmp = (unsigned long)(*DBObjPtr)(csTmp);
DEBUGLOG(("IsVoidTxnCodeTxnId::call DBOLTransaction:: is_void = [%d]\n",iTmp));
				if (iTmp == 1) {
					iRet = PD_TRUE;
				}

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                } else {
                        iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsVoidTxnCodeTxnId::call DBOLTransaction GetTxnHeader::not found record for [%s]\n", csTxnId));
ERRLOG("TxnOmtByUsRBT::IsVoidTxnCodeTxnId::call DBOLTransaction GetTxnHeader::not found record for [%s]\n", csTxnId);
                }

		RecordSet_Destroy(rRecordSet);
        }

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("IsVoidTxnCodeTxnId: iRet = [%d]\n",iRet));
        return iRet;
}

int     IsOffsetTxnId(const char* csTxnId, hash_t *hContext)
{
	int     iRet = PD_FALSE;

	int     iTmp = 0;

        char    *csTmp = NULL;

        hash_t  *hRec = NULL;

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

        // Get Txn Header
        if (iRet == PD_OK) {
                recordset_init(rRecordSet,0);

DEBUGLOG(("IsOffsetTxnId::Call DBOLTransaction:GetTxnHeader [%s]\n", csTxnId));
                DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnHeader");
                if ((*DBObjPtr)(csTxnId,rRecordSet) == PD_OK) {
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* txn_code */
                                if (GetField_CString(hRec, "txn_code", &csTmp)) {
DEBUGLOG(("IsOffsetTxnId::call DBOLTransaction:: txn_code = [%s]\n", csTmp));
                                }

/* is_offset */
				DBObjPtr = CreateObj(DBPtr,"DBTxnCode","IsOffset");
                                iTmp = (unsigned long)(*DBObjPtr)(csTmp);
DEBUGLOG(("IsOffsetTxnId::call DBOLTransaction:: is_offset = [%d]\n",iTmp));
                                if (iTmp == 1) {
                                        iRet = PD_TRUE;
                                }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                } else {
                        iRet = INT_INVALID_TXN;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsOffsetTxnId::call DBOLTransaction GetTxnHeader::not found record for [%s]\n", csTxnId));
ERRLOG("TxnOmtByUsRBT::IsOffsetTxnId::call DBOLTransaction GetTxnHeader::not found record for [%s]\n", csTxnId);
                }

                RecordSet_Destroy(rRecordSet);
        }

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("IsOffsetTxnId: iRet = [%d]\n",iRet));
        return iRet;
}

int     IsMultiBatchTxnId(const char* csTxnId, hash_t *hContext)
{
	int     iRet = PD_FALSE;

	int	iTmp = 0;

	hash_t  *hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

        PutField_Char(hTmpRec,"txn_level",PD_TXN_LEVEL);
        PutField_CString(hTmpRec,"txn_id",csTxnId);

DEBUGLOG(("IsMultiBatchTxnId:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation GetNumOfBatchId\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetNumOfBatchId");
        iRet = (unsigned long)(*DBObjPtr)(hTmpRec);
        if (iRet == PD_OK) {
		
/* cnt */
          	if (GetField_Int(hTmpRec, "cnt", &iTmp)) {
DEBUGLOG(("IsMultiBatchTxnId:: call DBOLBatchTxnRelation:: cnt = [%d]\n", iTmp));
            		if (iTmp > 1) {
DEBUGLOG(("IsMultiBatchTxnId:: call DBOLBatchTxnRelation:: multibatch_txn_id = True\n"));
				iRet = PD_TRUE;
			}
		}

        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsMultiBatchTxnId:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation:: Multi Batch Txn Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::IsMultiBatchTxnId::Call DBOLBatchTxnRelation:: Multi Batch Txn Id Error!!!\n");
        }

        hash_destroy(hTmpRec);
        FREE_ME(hTmpRec);

DEBUGLOG(("IsMultiBatchTxnId: iRet = [%d]\n",iRet));
        return iRet;
}

int	IsP1VoidTxnId(const char* csTxnId, hash_t *hContext)
{
	int     iRet = PD_FALSE;

	hash_t  *hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

       	PutField_CString(hTmpRec,"txn_id",csTxnId);

DEBUGLOG(("IsP1VoidTxnId:: Call DBOLTxnRelation:: Call DBOLTxnRelation CheckIsP1VoidTxnId\n"));
      	DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","CheckIsP1VoidTxnId");
       	iRet = (unsigned long)(*DBObjPtr)(hTmpRec);
       	if (iRet == PD_TRUE) {                        
DEBUGLOG(("IsP1VoidTxnId:: Call DBOLTxnRelation:: Call DBOLTxnRelation:: P1 Void Txn Id True!!!\n"));
	} else if (iRet == PD_FALSE) {
DEBUGLOG(("IsP1VoidTxnId:: Call DBOLTxnRelation:: Call DBOLTxnRelation:: P1 Void Txn Id False!!!\n"));
       	} else {
               	iRet = INT_ERR;
               	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsP1VoidTxnId:: Call DBOLTxnRelation:: Call DBOLTxnRelation:: P1 Void Txn Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::IsP1VoidTxnId::Call DBOLTxnRelation:: P1 Void Txn Id Error!!!\n");
       	}

	hash_destroy(hTmpRec);
	FREE_ME(hTmpRec);

DEBUGLOG(("IsP1VoidTxnId: iRet = [%d]\n",iRet));
        return iRet;	
}	

int     IsP2VoidedTxnId(const char* csTxnId, hash_t *hContext)
{
        int     iRet = PD_FALSE;

        hash_t  *hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

        PutField_CString(hTmpRec,"txn_id",csTxnId);

DEBUGLOG(("IsP2VoidedTxnId:: Call DBOLTxnRelation:: Call DBOLTxnRelation CheckIsP2VoidedTxnId\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","CheckIsP2VoidedTxnId");
        iRet = (unsigned long)(*DBObjPtr)(hTmpRec);
        if (iRet == PD_TRUE) {  
DEBUGLOG(("IsP2VoidedTxnId:: Call DBOLTxnRelation:: Call DBOLTxnRelation:: P2 Voided Txn Id True!!!\n"));
        } else if (iRet == PD_FALSE) {
DEBUGLOG(("IsP2VoidedTxnId:: Call DBOLTxnRelation:: Call DBOLTxnRelation:: P2 Voided Txn Id False!!!\n"));
        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsP2VoidedTxnId:: Call DBOLTxnRelation:: Call DBOLTxnRelation:: P2 Voided Txn Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::IsP2VoidedTxnId::Call DBOLTxnRelation:: P2 Voided Txn Id Error!!!\n");
        }

        hash_destroy(hTmpRec);
        FREE_ME(hTmpRec);

DEBUGLOG(("IsP2VoidedTxnId: iRet = [%d]\n",iRet));
        return iRet;
}

int     IsP1VoidBatchId(const char* csBatchId, hash_t *hContext)
{
	int     iRet = PD_FALSE;
	int	iDtlRet = PD_FOUND;

        char    cBatchType;
        char    cBatchSubType;

	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchTypeInfo,0);
	
        cBatchType = ' ';
        cBatchSubType = ' ';

	// Get Batch Type Info
        iDtlRet = GetBatchTypeInfo(csBatchId, hBatchTypeInfo, hContext);

	if (iDtlRet == PD_FOUND) {

/* batch_type */
       		if (GetField_Char(hBatchTypeInfo,"batch_type",&cBatchType)) {
DEBUGLOG(("IsP1VoidBatchId:: GetBatchTypeInfo, cBatchType = [%c]\n", cBatchType));
       		}

/* batch_sub_type */
      		if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cBatchSubType)) {
DEBUGLOG(("IsP1VoidBatchId:: GetBatchTypeInfo, cBatchSubType = [%c]\n", cBatchSubType));
       		}
	}

	if (iDtlRet == PD_FOUND) {
		if ((cBatchSubType == PD_GENERAL_UNDO_RECON)
                    || (cBatchSubType == PD_GENERAL_UNDO_BAL_TRF)
                    || (cBatchSubType == PD_COMBINE_UNDO_RECON)
               	)
              	{
DEBUGLOG(("IsP1VoidBatchId: p1void_txn_id = True\n"));
			iRet = PD_TRUE;
                }
       	} else {
            	iRet = INT_ERR;
            	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsP1VoidBatchId:: Batch Sub Type Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT::Batch Sub Type Not Found!!!\n");
     	}

	hash_destroy(hBatchTypeInfo);
        FREE_ME(hBatchTypeInfo);

DEBUGLOG(("IsP1VoidBatchId: iRet = [%d]\n",iRet));
	return iRet;
}

int     IsP2VoidedBatchId(const char* csBatchId, hash_t *hContext)
{
	int     iRet = PD_TRUE;
	int	iDtlRet = PD_FOUND;

	char	cBatchType;
	char	cBatchSubType;

	char	*csTmpTxnId = NULL;

	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchTypeInfo,0);

	hash_t          *hRls;
        hRls = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRls,0);

        hash_t          *hTxnRec = NULL;
        recordset_t     *rTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTxnRecordSet,0);

	cBatchType = ' ';
        cBatchSubType = ' ';

	// Get Batch Type Info
        iDtlRet = GetBatchTypeInfo(csBatchId, hBatchTypeInfo, hContext);

	if (iDtlRet == PD_FOUND) {

/* batch_type */
	        if (GetField_Char(hBatchTypeInfo,"batch_type",&cBatchType)) {
DEBUGLOG(("IsP2VoidedBatchId:: batch_type = [%c]\n",cBatchType));
	        }

/* batch_sub_type */
	        if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cBatchSubType)) {
DEBUGLOG(("IsP2VoidedBatchId:: batch_sub_type = [%c]\n",cBatchSubType));
	        }
	}

	iDtlRet = PD_OK;

       	PutField_Char(hRls,"batch_type",cBatchType);
       	PutField_Char(hRls,"batch_sub_type",cBatchSubType);
       	PutField_CString(hRls,"batch_id",csBatchId);
	PutField_Char(hRls,"txn_level",PD_TXN_LEVEL);

	// Get TxnId from Batch
DEBUGLOG(("IsP2VoidedBatchId:: Call DBOLBatchTxnRelation:GetTxnId\n"));
     	DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetTxnId");
       	iDtlRet = (unsigned long)(*DBObjPtr)(hRls,rTxnRecordSet);
       	if (iDtlRet == PD_OK) {
		iDtlRet = PD_FALSE;

		hTxnRec = RecordSet_GetFirst(rTxnRecordSet);
              	while ((hTxnRec) && (iRet != INT_ERR)) {

/* txn_id */
             		if (GetField_CString(hTxnRec,"txn_id",&csTmpTxnId)) {
DEBUGLOG(("IsP2VoidedBatchId:: Call DBOLBatchTxnRelation::GetTxnId() txn_id = [%s]\n",csTmpTxnId));

                       		// Check P2Voided
                               	iDtlRet = IsP2VoidedTxnId(csTmpTxnId, hContext);
                               	
				if (iDtlRet == PD_FALSE) {
DEBUGLOG(("IsP2VoidedBatchId:: Call DBOLBatchTxnRelation::p2voided_txn_id = False\n"));
					iRet = PD_FALSE;
                     			break;
				}
			}

                      	hTxnRec = RecordSet_GetNext(rTxnRecordSet);
          	}
	} else {
           	iRet = INT_ERR;
              	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsP2VoidedBatchId:: Call DBOLBatchTxnRelation::GetTxnId() Invalid Batch Id!!!\n"));
ERRLOG("TxnOmtByUsRBT:: IsP2VoidedBatchId:: Call DBOLBatchTxnRelation::GetTxnId() Invalid Batch Id!!!\n");
      	}

	hash_destroy(hBatchTypeInfo);
        FREE_ME(hBatchTypeInfo);
	
	hash_destroy(hRls);
        FREE_ME(hRls);

        RecordSet_Destroy(rTxnRecordSet);
        FREE_ME(rTxnRecordSet);

DEBUGLOG(("IsP2VoidedBatchId: iRet = [%d]\n",iRet));
	return iRet;
}

int 	CheckActionByTxnId(const char* csTxnId, hash_t* hTxnHeaderRec, hash_t* hContext)
{
	int 	iRet = PD_OK;

	int	iSkipCheckAction = PD_FALSE;

	int 	iIsOffset = PD_FALSE;
	int 	iIsVoid = PD_FALSE;
	
	char    *csBaidCategory = NULL;	
	char    *csTxnCode = NULL;	
        char    *csSubStatus = NULL;
        char    *csProcessType = NULL;
        char    *csProcessCode = NULL;
        char    cStatus;
        char    cArInd;
        char    cReconStatus;
	char	cOrgBatchSubType;

	cStatus = ' ';
	cArInd = ' ';
	cReconStatus = ' ';	
	cOrgBatchSubType = ' ';
	
/* org_batch_sub_type */
	if(GetField_Char(hContext, "org_batch_sub_type", &cOrgBatchSubType)){
DEBUGLOG(("CheckActionByTxnId:: org_batch_sub_type = [%c]\n",cOrgBatchSubType));
      	}

/* txn_type */
DEBUGLOG(("CheckActionByTxnId:: txn_type = [%s]\n", csTxnType));

/* baid_category */	
	if (GetField_CString(hTxnHeaderRec, "baid_category", &csBaidCategory)) {
DEBUGLOG(("CheckActionByTxnId:: baid_category = [%s]\n", csBaidCategory));
        }

/* txn_code */
     	if (GetField_CString(hTxnHeaderRec, "txn_code", &csTxnCode)) {
DEBUGLOG(("CheckActionByTxnId:: txn_code = [%s]\n", csTxnCode));
      	}

/* status */
	if (GetField_Char(hTxnHeaderRec,"status",&cStatus)) {
DEBUGLOG(("CheckActionByTxnId:: status = [%c]\n",cStatus));
       	}

/* ar_ind */
       	if (GetField_Char(hTxnHeaderRec, "ar_ind", &cArInd)) {
DEBUGLOG(("CheckActionByTxnId:: ar_ind = [%c]\n", cArInd));
      	}

/* sub_status */
        if (GetField_CString(hTxnHeaderRec, "sub_status", &csSubStatus)) {
DEBUGLOG(("CheckActionByTxnId:: sub_status = [%s]\n", csSubStatus));
     	}

/* recon_status */
       	if (GetField_Char(hTxnHeaderRec, "recon_status", &cReconStatus)) {
DEBUGLOG(("CheckActionByTxnId:: recon_status = [%c]\n", cReconStatus));
        }

/* process_type */ 	
	if (GetField_CString(hTxnHeaderRec,"process_type",&csProcessType)) {
DEBUGLOG(("CheckActionByTxnId:: process_type = [%s]\n",csProcessType));
        }

/* process_code */
       	if (GetField_CString(hTxnHeaderRec,"process_code",&csProcessCode)) {
DEBUGLOG(("CheckActionByTxnId:: process_code = [%s]\n",csProcessCode));
        }

/* is_offset */
        if (GetField_Int(hTxnHeaderRec, "is_offset", &iIsOffset)) {
DEBUGLOG(("CheckActionByTxnId:: is_offset = [%d]\n", iIsOffset));
        }

/* is_void */
        if (GetField_Int(hTxnHeaderRec, "is_void", &iIsVoid)) {
DEBUGLOG(("CheckActionByTxnId:: is_void = [%d]\n", iIsVoid));
        }

	if (iRet == PD_OK) {
DEBUGLOG(("CheckActionByTxnId: Default iAction = [%d]\n", iAction));
	
		// check is combine or recon
		if (iSkipCheckAction == PD_FALSE) {
			if (cOrgBatchSubType == PD_COMBINE_RECON) {
				iAction = PD_BATCH_ACTION_VOID;
DEBUGLOG(("CheckActionByTxnId: org_batch_sub_type = Combine [iAction = VOID]\n"));
			}
		}		
	
		// Check is offset
		if (iSkipCheckAction == PD_FALSE) {
			if (iIsOffset == PD_TRUE) {
				iSkipCheckAction = PD_TRUE;
DEBUGLOG(("CheckActionByTxnId: is_offset = true [SKIP]\n"));
			}
		}

		// Check is void
		if (iSkipCheckAction == PD_FALSE) {
                        if (iIsVoid == PD_TRUE) {
                                iSkipCheckAction = PD_TRUE;
DEBUGLOG(("CheckActionByTxnId: is_void = true [SKIP]\n"));
                        }
                }		

		// Check recon_status is NOT_REQ
		if (iSkipCheckAction == PD_FALSE) {
			if (cReconStatus == PD_RECON_NOT_REQ) {
                                iSkipCheckAction = PD_TRUE;
DEBUGLOG(("CheckActionByTxnId: recon_status = NOT_REQ [SKIP]\n"));
                        }
		}
	
		// Check Status + ARInd
		if (iSkipCheckAction == PD_FALSE) {
			if ((cStatus == PD_COMPLETE) && (cArInd == PD_ACCEPT)) {
				iSkipCheckAction = PD_FALSE;
			} else {
				iSkipCheckAction = PD_TRUE;
DEBUGLOG(("CheckActionByTxnId: status = false, ar_ind = false [SKIP]\n"));
			}
		}

		// Check Cases for Cancel/Void/Not Allow
		if (iSkipCheckAction == PD_FALSE) {

			// Check Txn Type
			if (!strcmp(csTxnType, PD_TXN_TYPE_HOLD_DEPOSIT)) {
DEBUGLOG(("CheckActionByTxnId: txn_type = hold_deposit\n"));
				iAction = PD_BATCH_ACTION_VOID;
	
			} else if ((!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) || (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTER))) {
DEBUGLOG(("CheckActionByTxnId: txn_type = bal_trf_intra/bal_trf_inter\n"));

				// Check Baid Category
				if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {
                                
					// Check Recon Status
					if (cReconStatus == PD_UNRECONCILED) {
						
						// Check Sub Status
						if ((!strcmp(csSubStatus, PD_UNDO)) 
						    || (!strcmp(csSubStatus, PD_CANCELLED))
						) {
                                                	iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category = pending_fund, recon_status = unrecon, sub_status = voided/cancelled [FAIL]\n"));
                                        	}
					} else if (cReconStatus == PD_RECONCILED) {
						iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category = pending_fund, recon_status = recon [FAIL]\n"));
					} else {
                                                iAction = PD_FALSE;
                                        }
				} else {

					// Check Recon Status
					if (cReconStatus == PD_UNRECONCILED) {
					
						// Check Sub Status
						if ((!strcmp(csSubStatus, PD_UNDO))
                                            	    || (!strcmp(csSubStatus, PD_CANCELLED))
                                        	) {
                                                	iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category != pending_fund, recon_status = unrecon, sub_status = voided/cancelled [FAIL]\n"));
                                        	}
					} else if (cReconStatus == PD_RECONCILED) {
                                        
						// Check Sub Status
						if ((!strcmp(csSubStatus, PD_UNDO))
                                            	    || (!strcmp(csSubStatus, PD_CANCELLED))
                                        	) {
                                                	iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category != pending_fund, recon_status = recon, sub_status = voided/cancelled [FAIL]\n"));
                                        	} else {
							iAction = PD_BATCH_ACTION_VOID;
						}
					} else {
                                                iAction = PD_FALSE;
                                        }
				}
			} else if (!strcmp(csTxnType, PD_TXN_TYPE_PSP_SETTLEMENT)) {
DEBUGLOG(("CheckActionByTxnId: txn_type = psp_settlement\n"));

				// Check Baid Category
				if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {
		
					// Check Recon Status
					if (cReconStatus == PD_UNRECONCILED) {

						// Check Sub Status
						if ((!strcmp(csSubStatus, PD_UNDO))
						    || (!strcmp(csSubStatus, PD_CANCELLED))
                                            	    || (!strcmp(csSubStatus, PD_DELIVERING))
                                            	    || (!strcmp(csSubStatus, PD_DELIVERED))
                                        	) {
                                                	iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category = pending_fund, recon_status = unrecon, sub_status = voided/cancelled/delivering/delivered [FAIL]\n"));
                                        	} else {

							// Check Number of Batch and P1Void/P2Voided
                                                	if ((iNumOfBatchId > 0)
                                                    	    && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                	)
                                                	{
                                                        	iAction = PD_BATCH_ACTION_VOID;
                                                	}
						}
                                        } else if (cReconStatus == PD_RECONCILED) {
                                                iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category = pending_fund, recon_status = recon [FAIL]\n"));
                                        } else {
                                                iAction = PD_FALSE;
                                        }
				} else {
					
					// Check Recon Status
					if (cReconStatus == PD_UNRECONCILED) {

						// Check Sub Status			
						if ((!strcmp(csSubStatus, PD_UNDO))
                                		    || (!strcmp(csSubStatus, PD_CANCELLED))
                                    		    || (!strcmp(csSubStatus, PD_DELIVERING))
                                    		    || (!strcmp(csSubStatus, PD_DELIVERED))
						) {
                                        		iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category != pending_fund, recon_status = unrecon, sub_status = voided/cancelled/delivering/delivered [FAIL]\n"));
                                		} else {
						
							// Check Number of Batch and P1Void/P2Voided
							if ((iNumOfBatchId > 0)
                                                            && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                        )
                                                        {
                                                                iAction = PD_BATCH_ACTION_VOID;
                                                        }
						}
					} else if (cReconStatus == PD_RECONCILED) {
						
						// Check Sub Status
						if ((!strcmp(csSubStatus, PD_UNDO))
                                                    || (!strcmp(csSubStatus, PD_CANCELLED))
                                                    || (!strcmp(csSubStatus, PD_DELIVERING))
                                                    || (!strcmp(csSubStatus, PD_DELIVERED))
                                                ) {
							iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category != pending_fund, recon_status = recon, sub_status = voided/cancelled/delivering/delivered [FAIL]\n"));
						} else {
							iAction = PD_BATCH_ACTION_VOID;
						}
					} else {
						iAction = PD_FALSE;
					}
				}
			} else if (!strcmp(csTxnType, PD_TXN_TYPE_PROVIDER_CHARGE)) {
DEBUGLOG(("CheckActionByTxnId: txn_type = provider_charge\n"));

				// Check Baid Category
                                if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {

					// Check Recon Status
					if (cReconStatus == PD_UNRECONCILED) {
			
						// Check Sub Status
						if ((!strcmp(csSubStatus, PD_UNDO))
                                            	    || (!strcmp(csSubStatus, PD_CANCELLED))
                                        	) {	
							iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: sub_status = voided/cancelled [FAIL]\n"));
						} else {
		
							// Check Number of Batch, P1Void Batch, P2Voided Batch
                                                        if ((iNumOfBatchId > 0)
                                                            && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                        )
                                                        {
                                                                iAction = PD_BATCH_ACTION_VOID;
                                                        }
						}	
					} else if (cReconStatus == PD_RECONCILED) {
						iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: recon_status = recon [FAIL]\n"));
                                       	} else {
                                            	iAction = PD_FALSE;
                                       	}
				} else {
		
					// Check Recon Status
                                        if (cReconStatus == PD_UNRECONCILED) {
				
						// Check Sub Status
                                                if ((!strcmp(csSubStatus, PD_UNDO))
                                                    || (!strcmp(csSubStatus, PD_CANCELLED))
                                                ) {
                                                        iAction = PD_FALSE;
						} else {

							// Check Number of Batch, P1Void Batch, P2Voided Batch
                                                        if ((iNumOfBatchId > 0)
                                                            && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                        )
                                                        {
                                                                iAction = PD_BATCH_ACTION_VOID;
                                                        }
						}
					} else if (cReconStatus == PD_RECONCILED) {

						// Check Sub Status
						if ((!strcmp(csSubStatus, PD_UNDO))
                                                    || (!strcmp(csSubStatus, PD_CANCELLED))
                                                ) {
                                                        iAction = PD_FALSE;
                                                } else {
							iAction = PD_BATCH_ACTION_VOID;	
						}
					} else {
                                                iAction = PD_FALSE;
                                        }
				}
			} else if (!strcmp(csTxnType, PD_TXN_TYPE_SMS_BANK_DEPOSIT)) {
DEBUGLOG(("CheckActionByTxnId: txn_type = sms_bank_deposit\n"));
	
				// Check Baid Category
				if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {

                                     	// Check Recon Status
                                     	if (cReconStatus == PD_UNRECONCILED) {

                                           	// Check Sub Status
                                             	if (!strcmp(csSubStatus, PD_UNALLOCATED)) {
                                                     	//iAction = PD_BATCH_ACTION_VOID;
                                            	} else {
                                                   	iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category = pending_fund, recon_status = unrecon, sub_status = voided/cancelled [FAIL]\n"));
                                             	}
                                    	} else if (cReconStatus == PD_RECONCILED) {
                                            	iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category = pending_fund, recon_status = recon [FAIL]\n"));
                                  	} else {
                                              	iAction = PD_FALSE;
                                    	}
                            	} else {

                                   	// Check Recon Status
                                     	if (cReconStatus == PD_UNRECONCILED) {

                                              	// Check Sub Status
                                              	if (!strcmp(csSubStatus, PD_UNALLOCATED)) {
                                                   	//iAction = PD_BATCH_ACTION_VOID;
                                             	} else {
                                                      	iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category != pending_fund, unrecon_status = recon, sub_status != unallocated [FAIL]\n"));
                                             	}
                                   	} else if (cReconStatus == PD_RECONCILED) {

                                            	// Check Sub Status
                                               	if (!strcmp(csSubStatus, PD_UNALLOCATED)) {
                                                    	//iAction = PD_BATCH_ACTION_VOID;
                                             	} else {
                                                   	iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category != pending_fund, recon_status = recon, sub_status != unallocated [FAIL]\n"));
                                              	}
                                     	} else {
                                              	iAction = PD_FALSE;
                                     	}
                          	}
			} else if (!strcmp(csTxnType, PD_TXN_TYPE_GENERAL)) {
DEBUGLOG(("CheckActionByTxnId: txn_type = general\n"));

				if (!strcmp(csTxnCode, PD_OL_PAYOUT_GENERATE)) {
DEBUGLOG(("CheckActionByTxnId: txn_code = payout (psp)\n"));

					// Check Baid Category
                                	if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {

						// Check Recon Status
						if (cReconStatus == PD_UNRECONCILED) {

							// Check Sub Status
							if ((!strcmp(csSubStatus, PD_UNDO))
                                                    	    || (!strcmp(csSubStatus, PD_CANCELLED))
                                                	) {
                                                        	iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category = pending_fund, recon_status = unrecon, sub_status = voided/cancelled [FAIL]\n"));
                                                	} else {

                                                        	// Check Number of Batch, P1Void Batch, P2Voided Batch
                                                        	if ((iNumOfBatchId > 0)
                                                            	    && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                        	)
                                                        	{
                                                                	iAction = PD_BATCH_ACTION_VOID;
                                                        	}
							}
						} else if (cReconStatus == PD_RECONCILED) {
                                                        iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category = pending_fund, recon_status = recon [FAIL]\n"));
						} else {
                                                        iAction = PD_FALSE;
                                                }
					} else if (!strcmp(csBaidCategory, PD_BAID_CAT_TEMP)) {

						// Check Recon Status
						if (cReconStatus == PD_UNRECONCILED) {
							iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category = temp, recon_status = unrecon [FAIL]\n"));
						} else if (cReconStatus == PD_RECONCILED) {
							
							// Check Sub Status
							if ((!strcmp(csSubStatus, PD_UNDO))
                                                            || (!strcmp(csSubStatus, PD_CANCELLED))
                                                        ) {
                                                                iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category = temp, recon_status = recon, sub_status = voided/cancelled [FAIL]\n"));
                                                        } else {
                                                                iAction = PD_BATCH_ACTION_VOID;
                                                        }

						} else {
							iAction = PD_FALSE;
						}	
                                	} else {
						// Check Recon Status
						if (cReconStatus == PD_UNRECONCILED) {						

							// Check Sub Status
							if ((!strcmp(csSubStatus, PD_UNDO))
                                                            || (!strcmp(csSubStatus, PD_CANCELLED))
                                                        ) {
                                                                iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category = internal/iq, recon_status = unrecon, sub_status = voided/cancelled [FAIL]\n"));
                                                        } else {
		
								// Check Number of Batch, P1Void Batch, P2Voided Batch
								if ((iNumOfBatchId > 0)
                                                                    && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                                )
                                                                {
                                                                        iAction = PD_BATCH_ACTION_VOID;
                                                                }
							}
						} else if (cReconStatus == PD_RECONCILED) {

							// Check Sub Status
							if ((!strcmp(csSubStatus, PD_UNDO))
                                                            || (!strcmp(csSubStatus, PD_CANCELLED))
                                                        ) {
                                                                iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category - internal/iq, recon_status = recon, sub_status = voided/cancelled [FAIL]\n"));
                                                        } else {
                                                                iAction = PD_BATCH_ACTION_VOID;
                                                        }
                                                } else {
                                                        iAction = PD_FALSE;
                                                }
					}
				} else {
DEBUGLOG(("CheckActionByTxnId: txn_code = general\n"));

					// Check Baid Category
                                	if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {

						// Check Recon Status
						if (cReconStatus == PD_UNRECONCILED) {

							// Check Sub Status
							if ((!strcmp(csSubStatus, PD_UNDO))
                                                    	    || (!strcmp(csSubStatus, PD_CANCELLED))
                                                	) {
                                                        	iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category = pending_fund, recon_status = unrecon, sub_status = voided/cancelled [FAIL]\n"));
                                                	} else {

                                                        	// Check Number of Batch, P1Void Batch, P2Voided Batch
                                                        	if ((iNumOfBatchId > 0)
                                                            	    && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                        	)
                                                        	{
                                                                	iAction = PD_BATCH_ACTION_VOID;
                                                        	}
							}
						} else if (cReconStatus == PD_RECONCILED) {
                                                        iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category = pending_fund, recon_status = recon [FAIL]\n"));
						} else {
                                                        iAction = PD_FALSE;
                                                }
                                	} else {
						// Check Recon Status
						if (cReconStatus == PD_UNRECONCILED) {						

							// Check Sub Status
							if ((!strcmp(csSubStatus, PD_UNDO))
                                                            || (!strcmp(csSubStatus, PD_CANCELLED))
                                                        ) {
                                                                iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category != pending_fund, recon_status = unrecon, sub_status = voided/cancelled [FAIL]\n"));
                                                        } else {
		
								// Check Number of Batch, P1Void Batch, P2Voided Batch
								if ((iNumOfBatchId > 0)
                                                                    && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                                )
                                                                {
                                                                        iAction = PD_BATCH_ACTION_VOID;
                                                                }
							}
						} else if (cReconStatus == PD_RECONCILED) {

							// Check Sub Status
							if ((!strcmp(csSubStatus, PD_UNDO))
                                                            || (!strcmp(csSubStatus, PD_CANCELLED))
                                                        ) {
                                                                iAction = PD_FALSE;
DEBUGLOG(("CheckActionByTxnId: baid_category != pending_fund, recon_status = recon, sub_status = voided/cancelled [FAIL]\n"));
                                                        } else {
                                                                iAction = PD_BATCH_ACTION_VOID;
                                                        }
                                                } else {
                                                        iAction = PD_FALSE;
                                                }
					}
				}
			}
		}
	}

	if (iRet == PD_OK) {
		if (iSkipCheckAction == PD_FALSE) {		
			if (iAction > PD_FALSE) {
                           	switch (iAction) {
                                    	case PD_BATCH_ACTION_VOID:
                                       		DBObjPtr = CreateObj(DBPtr,"DBTxnCode","OflIsVoidable");
                                             	if ((unsigned long)(*DBObjPtr)(csTxnCode) != PD_TRUE) {
DEBUGLOG(("CheckActionByTxnId: TxnCode IsVoidable = FALSE\n"));
                                                  	iAction = PD_FALSE;
                                             	}
DEBUGLOG(("CheckActionByTxnId: iAction [%d]\n",iAction));
                                              	break;
                                    	case PD_BATCH_ACTION_CANCEL:
                                            	DBObjPtr = CreateObj(DBPtr,"DBTxnCode","AllowCancel");
                                             	if ((unsigned long)(*DBObjPtr)(csTxnCode) != PD_TRUE) {
DEBUGLOG(("CheckActionByTxnId: TxnCode AllowCancel = FALSE\n"));
                                                 	iAction = PD_FALSE;
                                             	}
DEBUGLOG(("CheckActionByTxnId: iAction [%d]\n",iAction));
                                             	break;
                                    	default:
DEBUGLOG(("CheckActionByTxnId: iAction return Error [%d]\n",iAction));
                                           	break;
                            	}
                    	} else {
DEBUGLOG(("CheckActionByTxnId: iAction [%d]\n",iAction));
                    	}
		}
	}
	
	// Result
	if (iRet == PD_OK) {
		if (iAction > PD_FALSE) {
			iRet = iAction;
            	} else {
                 	iRet = INT_INVALID_TXN;
                   	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("CheckActionByTxnId: not allow to void/cancel\n"));
ERRLOG("TxnOmtByUsRBT::CheckActionByTxnId: not allow to void/cancel\n");
          	}
	}

DEBUGLOG(("CheckActionByTxnId: iRet = [%d]\n",iRet));
	return iRet;
}

int 	IsPutTxnIdToBatch(const char* csTxnId, hash_t* hTxnHeaderRec)
{
	int     iRet = PD_OK;

        int     iIsOffset = PD_FALSE;
        int     iIsVoid = PD_FALSE;

        char    cStatus;
        char    cArInd;

	char	*csTxnCode = NULL;

        cStatus = ' ';
        cArInd = ' ';

/* txn_id */
DEBUGLOG(("IsPutTxnIdToBatch:: txn_id = [%s]\n", csTxnId));

/* txn_type */
DEBUGLOG(("IsPutTxnIdToBatch:: txn_type = [%s]\n", csTxnType));

/* txn_code */
	if (GetField_CString(hTxnHeaderRec,"txn_code",&csTxnCode)) {
DEBUGLOG(("IsPutTxnIdToBatch:: txn_code = [%s]\n", csTxnCode));
        }

/* status */
        if (GetField_Char(hTxnHeaderRec,"status",&cStatus)) {
DEBUGLOG(("IsPutTxnIdToBatch:: status = [%c]\n", cStatus));
        }

/* ar_ind */
        if (GetField_Char(hTxnHeaderRec, "ar_ind", &cArInd)) {
DEBUGLOG(("IsPutTxnIdToBatch:: ar_ind = [%c]\n", cArInd));
        }

/* is_offset */
        if (GetField_Int(hTxnHeaderRec, "is_offset", &iIsOffset)) {
DEBUGLOG(("IsPutTxnIdToBatch:: is_offset = [%d]\n", iIsOffset));
        }

/* is_void */
        if (GetField_Int(hTxnHeaderRec, "is_void", &iIsVoid)) {
DEBUGLOG(("IsPutTxnIdToBatch:: is_void = [%d]\n", iIsVoid));
        }

	if (iRet == PD_OK) {
		// Check Txn Type -> Status+ARInd -> IsVoid -> Action
		if (!strcmp(csTxnType, PD_TXN_TYPE_HOLD_DEPOSIT)) { 
			if ((cStatus == PD_COMPLETE) && (cArInd == PD_ACCEPT)) {
				if (!strcmp(csTxnCode, PD_BANK_DEPOSIT_TXN_CODE)) {
                                	iRet = PD_ERR;
                        	} else {
					if (iIsVoid == PD_TRUE) {
                                        	iRet = PD_ERR;
                                	}
				}
			} else {
				if (iAction == PD_BATCH_ACTION_CANCEL) {
                                        iRet = PD_ERR;
                                }
			}
		} else {
			if ((cStatus == PD_COMPLETE) && (cArInd == PD_ACCEPT)) {	
				if (iIsVoid == PD_TRUE) {
					iRet = PD_ERR;
				}
			} else {	
				if (iAction == PD_BATCH_ACTION_CANCEL) {
					iRet = PD_ERR;
				}
			}
		}
	}

DEBUGLOG(("IsPutTxnIdToBatch: iRet = [%d]\n",iRet));
        return iRet;
}	

int	ProcessOffset(const char* csOrgTxnSeq, hash_t* hOrgTxn, hash_t* hNewTxn, hash_t* hContext)
{
	int	iRet = PD_OK;

DEBUGLOG(("===== ProcessOffset ===== START!!\n"));	

DEBUGLOG(("ProcessOffset:: txn_id [%s]\n", csOrgTxnSeq));

	// Lock Org Txn + Get Org Txn
	iRet = GetTxnInfo(csOrgTxnSeq, hContext, hOrgTxn);

	// Form Offset Txn (include reversal CR / DR sign)
	if (iRet == PD_OK) {
		iRet = FormNewTxn(PD_FALSE, hOrgTxn, hNewTxn, hContext);
	}

	// Create Txn + Update Balance (with add approval_date, approval_timestamp)
	if (iRet == PD_OK) {
		iRet = ProcessNewTxn(PD_FALSE, hNewTxn, hContext);
	}

	// Update Org Txn to (void)
	if (iRet == PD_OK) {
		iRet = ProcessOrgTxn(hOrgTxn, hContext);
	}

DEBUGLOG(("ProcessOffset:: iRet [%d]\n", iRet));
DEBUGLOG(("===== ProcessOffset ===== END !!\n"));	

	return iRet;
}

int     GetTxnInfo(const char *csTxnSeq, hash_t *hContext, hash_t *hTxn)
{
        int     iRet = PD_OK;

        char    *csTmp = NULL;
        char    cTmp;
        double  dTmp = 0.0;
        int     iTmp = 0;

        char   *csBaid = NULL;

        int     iTotalElement = 0;

	char    csBaidCountry[PD_COUNTRY_LEN + 1];
        char    csTag[PD_TAG_LEN + 1];

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

        hash_t  *hRec = NULL;

        hash_t  *hTxnPspDetail = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnPspDetail, 0);

        hash_t  *hBaidDetail = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBaidDetail, 0);

DEBUGLOG(("GetTxnInfo:: Call DBOLTransaction:GetTxnIdForUpdateNoWait [%s]\n", csTxnSeq));
        DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnIdForUpdateNoWait");
        iRet = (unsigned long)(*DBObjPtr)(csTxnSeq);
        if (iRet == PD_OK) {
                PutField_CString(hTxn, "txn_seq", csTxnSeq);
        } else {
                iRet = INT_OTHER_VOID_PROCESSING;
		PutField_Int(hContext,"internal_error",iRet);
		TxnAbort();
DEBUGLOG(("GetTxnInfo::call DBOLTransaction GetTxnIdForUpdateNoWait::Other Void Transaction is Processing!!!\n"));
ERRLOG("TxnOmtByUsRBT::GetTxnInfo::call DBOLTransaction GetTxnIdForUpdateNoWait::Other Void Transaction is Processing!!!\n");
        }

	// Baid Category
	if (iRet == PD_OK) {
		iRet = GetBaidCategory(csTxnSeq, hTxn);
	}

	// Txn Header
	if (iRet == PD_OK) {
                recordset_init(rRecordSet,0);

DEBUGLOG(("GetTxnInfo:: Call DBOLTransaction:GetTxnHeader [%s]\n", csTxnSeq));
                DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnHeader");
                iRet = (unsigned long)(*DBObjPtr)(csTxnSeq,rRecordSet);
                if (iRet == PD_OK) {
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* txn_code */
                                if (GetField_CString(hRec, "txn_code", &csTmp)) {
                                        PutField_CString(hTxn, "txn_code", csTmp);
DEBUGLOG(("GetTxnInfo (Header):: txn_code = [%s]\n", csTmp));
                                }

/* process_type */
                                if (GetField_CString(hRec, "process_type", &csTmp)) {
                                        PutField_CString(hTxn, "process_type", csTmp);
DEBUGLOG(("GetTxnInfo (Header):: process_type = [%s]\n", csTmp));
                                }

/* process_code */
                                if (GetField_CString(hRec, "process_code", &csTmp)) {
                                        PutField_CString(hTxn, "process_code", csTmp);
DEBUGLOG(("GetTxnInfo (Header):: process_code = [%s]\n", csTmp));
                                }

/* status */
                                if (GetField_Char(hRec, "status", &cTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: status = [%c]\n", cTmp));
                                }

/* ar_ind */
                                if (GetField_Char(hRec, "ar_ind", &cTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: ar_ind = [%c]\n", cTmp));
                                }

/* sub_status */
                                if (GetField_CString(hRec, "sub_status", &csTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: sub_status = [%s]\n", csTmp));
                                }

/* recon_status */
                                if (GetField_Char(hRec, "recon_status", &cTmp)) {
                                        PutField_Char(hTxn, "recon_status", cTmp);
DEBUGLOG(("GetTxnInfo (Header):: recon_status = [%c]\n", cTmp));
                                }

/* txn_amt */
                                if (GetField_Double(hRec, "txn_amt", &dTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: txn_amt = [%lf]\n", dTmp));
                                        PutField_Double(hTxn, "txn_amt", dTmp);
                                }

/* net_amt */
                                if (GetField_Double(hRec, "net_amt", &dTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: net_amt = [%lf]\n", dTmp));
                                        PutField_Double(hTxn, "net_amt", dTmp);
                                }

/* net_ccy */
                                if (GetField_CString(hRec, "net_ccy", &csTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: net_ccy = [%lf]\n",csTmp));
                                        PutField_CString(hTxn,"net_ccy",csTmp);
                                }

/* deposit_amt */
                                if (GetField_Double(hRec, "deposit_amt", &dTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: deposit_amt = [%lf]\n",dTmp));
                                        PutField_Double(hTxn,"deposit_amt",dTmp);
                                }

/* display_amt */
                                if (GetField_Double(hRec, "display_amt", &dTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: display_amt= [%lf]\n",dTmp));
                                        PutField_Double(hTxn,"display_amt",dTmp);
                                }

/* ex_supplier */
                                if (GetField_Char(hRec, "ex_supplier", &cTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: ex_supplier = [%c]\n", cTmp));
                                        PutField_Char(hTxn,"ex_supplier",cTmp);
                                }

/* ex_rate */
                                if (GetField_Double(hRec, "ex_rate", &dTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: ex_rate = [%lf]\n", dTmp));
                                        PutField_Double(hTxn,"ex_rate",dTmp);
                                }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                } else {
DEBUGLOG(("GetTxnInfo (Header):: not found record for [%s]\n",csTxnSeq));
                        iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
			TxnAbort();
                }

                RecordSet_Destroy(rRecordSet);
	}

	// TxnPspDetail
	if (iRet == PD_OK) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail)::Call OLTxnPspDetail:GetTxnPspDetail\n"));
                DBObjPtr = CreateObj(DBPtr,"DBOLTxnPspDetail","GetTxnPspDetail");
                iRet = (unsigned long)(*DBObjPtr)(csTxnSeq,hTxnPspDetail);
                if (iRet == PD_OK) {

/* psp_id */
                        if (GetField_CString(hTxnPspDetail, "psp_id", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: psp_id = [%s]\n", csTmp));
                                PutField_CString(hTxn, "psp_id", csTmp);
                        }

/* baid */
			if (GetField_CString(hTxnPspDetail, "baid", &csBaid)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: baid = [%s]\n", csBaid));
                                PutField_CString(hTxn, "baid", csBaid);

				// check baid country				
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: Call DBOLBAnkAcctId: GetBankAcctIdCountry\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetBankAcctIdCountry");
                                if ((unsigned long)(*DBObjPtr)(csBaid, csBaidCountry) == FOUND) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: baid country = [%s]\n", csBaidCountry));
					PutField_CString(hTxn, "txn_country", csBaidCountry);
                                } else {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: ERROR!! baid country NOT FOUND!!!\n"));
                                        iRet = INT_BAID_COUNTRY_NOT_FOUND;
					PutField_Int(hContext,"internal_error",iRet);
					TxnAbort();
                                }
                        }

/* txn_ccy */
                        if (GetField_CString(hTxnPspDetail, "txn_ccy", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: txn_ccy = [%s]\n", csTmp));
                                PutField_CString(hTxn, "txn_ccy", csTmp);
                        }

/* txn_amount */
                        if (GetField_Double(hTxnPspDetail, "txn_amount", &dTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: txn_amount = [%f]\n", dTmp));
                                PutField_Double(hTxn, "txn_amount", dTmp);
                        }

/* bank_code */
                        if (GetField_CString(hTxnPspDetail, "bank_code", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: bank_code = [%s]\n", csTmp));
                                PutField_CString(hTxn, "bank_code", csTmp);
                        }

/* bank_acct_num */
                        if (GetField_CString(hTxnPspDetail, "bank_acct_num", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: bank_acct_num = [%s]\n", csTmp));
                                PutField_CString(hTxn, "bank_acct_num", csTmp);
                        }

/* cost */
                        if (GetField_Double(hTxnPspDetail, "cost", &dTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: cost = [%lf]\n", dTmp));
                                PutField_Double(hTxn, "cost", dTmp);
                        }

/* txn_hold_ind */
                        if (GetField_Int(hTxnPspDetail, "txn_hold_ind", &iTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: txn_hold_ind = [%d]\n", iTmp));
                                PutField_Int(hTxn, "txn_hold_ind", iTmp);
                        }

/* sys_match_ind */
                        if (GetField_Int(hTxnPspDetail, "sys_match_ind", &iTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: sys_match_ind = [%d]\n", iTmp));
                                PutField_Int(hTxn, "sys_match_ind", iTmp);
                        }

/* customer_text */
                        if (GetField_CString(hTxnPspDetail, "customer_text", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: customer_text = [%s]\n", csTmp));
                                PutField_CString(hTxn, "customer_text", csTmp);
                        }

/* sender_name */
                        if (GetField_CString(hTxnPspDetail, "sender_name", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: sender_name = [%s]\n", csTmp));
                                PutField_CString(hTxn, "sender_name", csTmp);
                        }

/* txn_ref_num */
                        if (GetField_CString(hTxnPspDetail, "txn_ref_num", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: txn_ref_num = [%s]\n", csTmp));
                                PutField_CString(hTxn, "txn_ref_num", csTmp);
                        }

/* charge_rule_id */
/*
			if (GetField_Int(hTxnPspDetail, "charge_rule_id", &iTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: charge_rule_id = [%d]\n", iTmp));
				PutField_Int(hTxn, "charge_rule_id", iTmp);
			}
*/

/* charge_period_type */
/*
			if (GetField_Char(hTxnPspDetail, "charge_period_type", &cTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: charge_period_type = [%c]\n", cTmp));
				PutField_Char(hTxn, "charge_period_type", cTmp);
			}
*/

/* precal_charge */
/*
			if (GetField_Double(hTxnPspDetail, "precal_charge", &dTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: precal_charge = [%f]\n", dTmp));
				PutField_Double(hTxn, "precal_charge", dTmp);
			}
*/

/* grp_tracking_txn_id */
                        if (GetField_CString(hTxnPspDetail, "grp_tracking_txn_seq", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: grp_tracking_txn_seq = [%s]\n", csTmp));
                                PutField_CString(hTxn, "grp_tracking_txn_seq", csTmp);
                        }

/* tracking_txn_id */
                        if (GetField_CString(hTxnPspDetail, "tracking_txn_seq", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: tracking_txn_seq = [%s]\n", csTmp));
                                PutField_CString(hTxn, "tracking_txn_seq", csTmp);
                        }

/* report_date */
                        if (GetField_CString(hTxnPspDetail, "report_date", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: report_date = [%s]\n", csTmp));
                                PutField_CString(hTxn, "report_date", csTmp);
                        }

/* settlement_date */
                        if (GetField_CString(hTxnPspDetail, "settlement_date", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: settlement_date = [%s]\n", csTmp));
                                PutField_CString(hTxn, "settlement_date", csTmp);
                        }

/* manual_hold_recon  */
                     	if (GetField_Int(hTxnPspDetail, "manual_hold_recon", &iTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: manual_hold_recon = [%d]\n", iTmp));
                       		PutField_Int(hTxn,"manual_hold_recon",iTmp);
                    	}

                } else {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: not found record for [%s]\n",csTxnSeq));
                        iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
			TxnAbort();
                }
        }


	// Txn Elements
	if (iRet == PD_OK) {
DEBUGLOG(("GetTxnInfo (TxnElements):: call DBOLTxnElements:GetAllFeeChgDetail\n"));
                DBObjPtr = CreateObj(DBPtr,"DBOLTxnElements","GetAllFeeChgDetail");
                iRet = (unsigned long)(*DBObjPtr)(csTxnSeq,rRecordSet);
                if (iRet == PD_OK) {
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec && (iRet == PD_OK)) {
                                iTotalElement++;

/* txn_element_type */
                                if (GetField_CString(hRec, "txn_element_type", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnElements):: txn_id[%s] Cnt[%d] element_type = [%s]\n", csTxnSeq, iTotalElement, csTmp));
                                        sprintf(csTag, "element_type_%d", iTotalElement);
                                        PutField_CString(hTxn, csTag, csTmp);
                                }

/* amount */
                                if (GetField_Double(hRec, "amount", &dTmp)) {
DEBUGLOG(("GetTxnInfo (TxnElements):: txn_id[%s] Cnt[%d] amt_type = [%f]\n", csTxnSeq, iTotalElement, dTmp));
                                        sprintf(csTag, "element_amount_%d", iTotalElement);
                                        PutField_Double(hTxn, csTag, dTmp);
                                }

/* ccy */
                                if (GetField_CString(hRec, "ccy", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnElements):: txn_id[%s] Cnt[%d] ccy = [%s]\n", csTxnSeq, iTotalElement, csTmp));
                                        sprintf(csTag, "element_ccy_%d", iTotalElement);
                                        PutField_CString(hTxn, csTag, csTmp);
                                }

/* amt_type */
                                if (GetField_CString(hRec, "amt_type", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnElements):: txn_id[%s] Cnt[%d] amt_type = [%s]\n", csTxnSeq, iTotalElement, csTmp));
                                        sprintf(csTag, "element_amt_type_%d", iTotalElement);
                                        PutField_CString(hTxn, csTag, csTmp);
                                }

/* party_type */
                                if (GetField_Char(hRec, "party_type", &cTmp)) {
DEBUGLOG(("GetTxnInfo (TxnElements):: txn_id[%s] Cnt[%d] party_type = [%c]\n", csTxnSeq, iTotalElement, cTmp));
                                        sprintf(csTag, "element_party_type_%d", iTotalElement);
                                        PutField_Char(hTxn, csTag, cTmp);
                                }

/* rate */
                                if (GetField_Double(hRec, "rate", &dTmp)) {
DEBUGLOG(("GetTxnInfo (TxnElements):: txn_id[%s] Cnt[%d] rate = [%f]\n", csTxnSeq, iTotalElement, dTmp));
                                        sprintf(csTag, "element_rate_%d", iTotalElement);
                                        PutField_Double(hTxn, csTag, dTmp);
                                }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
			
			sprintf(csTag, "element_total_cnt");
                        PutField_Int(hTxn, csTag, iTotalElement);
DEBUGLOG(("GetTxnInfo (TxnElements):: total Expected Element [%d]\n", iTotalElement));

                        RecordSet_Destroy(rRecordSet);
                } else {
DEBUGLOG(("GetTxnInfo (TxnElements):: not found record for [%s]\n",csTxnSeq));
                        iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
			TxnAbort();
                }
        }

        hash_destroy(hTxnPspDetail);
        FREE_ME(hTxnPspDetail);

        hash_destroy(hBaidDetail);
        FREE_ME(hBaidDetail);

        FREE_ME(rRecordSet);

DEBUGLOG(("GetTxnInfo:: iRet = [%d]\n",iRet));
        return iRet;
}	

int     FormNewTxn(int iIsLastTxn, hash_t *hOrgTxn, hash_t *hOfstTxn, hash_t *hContext)
{
        int     iRet = PD_OK;

	char	csVoidTxnCode[PD_TXN_CODE_LEN + 1];
        char    csOfstTxnSeq[PD_TXN_SEQ_LEN + 1];
        char    csTxnDateTime[PD_DATETIME_LEN + 1];
        char    csTag[PD_TAG_LEN + 1];

        int     iElementCnt = 0;

        char    cPartyType;
        char    cTmpDCInd;
        char    *csOrgCcy = NULL;
        char    *csOrgElementCcy = NULL;
        char    *csOrgElementType = NULL;
        char    *csOrgElementAmtType = NULL;
        double  dOrgElementAmount = 0.0;
        double  dTotalAcctBal = 0.0;
        double  dTotalIntransitBal = 0.0;

        char    *csTmp = NULL;
        char    cTmp;
        double  dTmp = 0.0;
        int     iTmp = 0;

        int     i;

	cPartyType = ' ';
	cTmpDCInd = ' ';

/* txn_seq */
DEBUGLOG(("FormNewTxn:: Call DBOLTxnSeq: GetNextOmtTxnSeq\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextOmtTxnSeq");
        strcpy(csOfstTxnSeq, (*DBObjPtr)());

        PutField_CString(hOfstTxn, "txn_seq", csOfstTxnSeq);
DEBUGLOG(("FormNewTxn::Offset TxnSeq (Generated!!) [%s]\n", csOfstTxnSeq));

/* org_txn_id */
        if (GetField_CString(hOrgTxn, "txn_seq", &csTmp)) {
DEBUGLOG(("FormNewTxn::org_txn_seq [%s]\n", csTmp));
                PutField_CString(hOfstTxn, "org_txn_seq", csTmp);
        }

/* channel */
        if (GetField_CString(hContext, "channel_code", &csTmp)) {
DEBUGLOG(("FormNewTxn::channel_code [%s]\n", csTmp));
                PutField_CString(hOfstTxn, "channel_code", csTmp);
        }

	// Txn Header

/* status */
        PutField_Char(hOfstTxn,"status",PD_PROCESSING);

/* txn_code */
        if (GetField_CString(hOrgTxn, "txn_code", &csTmp)) {
DEBUGLOG(("FormNewTxn (Header)::Offset txn_code [%s]\n", csTmp));
		if (iIsLastTxn) {
			PutField_CString(hOfstTxn, "txn_code", csTmp);
		} else {
			//Get void txn code from DBTxnCode
			DBObjPtr = CreateObj(DBPtr, "DBTxnCode", "FindVoidTxnCode");
			if ((unsigned long)(*DBObjPtr)(csTmp,csVoidTxnCode) == PD_FOUND) {
	           		PutField_CString(hOfstTxn, "txn_code", csVoidTxnCode);
DEBUGLOG(("FormNewTxn (Header)::offset void_txn_code [%s]\n", csVoidTxnCode));
			}
		}

/* is_void */
              	DBObjPtr = CreateObj(DBPtr,"DBTxnCode","IsVoid");
              	iTmp = (unsigned long)(*DBObjPtr)(csVoidTxnCode);
DEBUGLOG(("FormNewTxn (Header)::call DBOLTransaction:: is_void = [%d]\n",iTmp));
             	PutField_Int(hContext, "is_void", iTmp);		
        }

/* amt_type */
	if (GetField_Char(hOrgTxn, "amt_type", &cTmp)) {
DEBUGLOG(("FormNewTxn (Header)::Offset amt_type [%c]\n", cTmp));
              	PutField_Char(hOfstTxn, "amt_type", cTmp);
	}

/* process_type */
        PutField_CString(hOfstTxn,"process_code", PD_PROCESS_CODE_DEF);

/* process_code */
        PutField_CString(hOfstTxn,"process_type", PD_PROCESS_TYPE_DEF);

/* host_posting_date */
        if (GetField_CString(hContext, "PHDATE", &csTmp)) {
DEBUGLOG(("FormNewTxn (Header)::Offset host_posting_date [%s]\n", csTmp));
                PutField_CString(hOfstTxn, "host_posting_date", csTmp);
        }

/* transmission_datetime */
        if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
DEBUGLOG(("FormNewTxn (Header)::Offset transmission_time [%s]\n", csTmp));
                PutField_CString(hOfstTxn, "local_tm_date", csTmp);
                PutField_CString(hOfstTxn, "tm_date", csTmp);

                strcpy(csTxnDateTime, csTmp);
                PutField_CString(hOfstTxn, "transmission_datetime", csTxnDateTime);

                if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
DEBUGLOG(("FormNewTxn (Header)::Offset transmission_date [%s]\n", csTmp));
                        PutField_CString(hOfstTxn, "local_tm_time", csTmp);

                        strcat(csTxnDateTime, csTmp);
                        PutField_CString(hOfstTxn, "transmission_datetime", csTxnDateTime);
                }
        }

/* transaction_amount */
        if  (GetField_Double(hOrgTxn, "txn_amt", &dTmp)) {
DEBUGLOG(("FormNewTxn (Header)::Offset transaction_amount [%f]\n", dTmp));
                PutField_Double(hOfstTxn, "txn_amt", dTmp);
        }

/* net_amt */
        if (GetField_Double(hOrgTxn, "net_amt", &dTmp)) {
DEBUGLOG(("FormNewTxn (Header)::Offset net_amt [%f]\n", dTmp));
                PutField_Double(hOfstTxn,"net_amt",dTmp);
        }

/* net_ccy */
        if (GetField_CString(hOrgTxn, "net_ccy", &csTmp)) {
DEBUGLOG(("FormNewTxn (Header)::Offset net_ccy [%s]\n", csTmp));
                PutField_CString(hOfstTxn,"net_ccy",csTmp);
        }

/* deposit_amt */
        if (GetField_Double(hOrgTxn, "deposit_amt", &dTmp)) {
DEBUGLOG(("FormNewTxn (Header)::Offset deposit_amt [%f]\n", dTmp));
                PutField_Double(hOfstTxn,"deposit_amt",dTmp);
        }

/* display_amt */
        if (GetField_Double(hOrgTxn, "display_amt", &dTmp)) {
DEBUGLOG(("FormNewTxn (Header)::Offset display_amt [%f]\n", dTmp));
                PutField_Double(hOfstTxn,"display_amt",dTmp);
        }

/* ex_supplier */
        if (GetField_Char(hOrgTxn, "ex_supplier", &cTmp)) {
DEBUGLOG(("FormNewTxn (Header)::Offset ex_supplier [%c]\n", cTmp));
                PutField_Char(hOfstTxn,"ex_supplier",cTmp);
        }

/* ex_rate */
        if (GetField_Double(hOrgTxn, "ex_rate", &dTmp)) {
DEBUGLOG(("FormNewTxn (Header)::Offset ex_supplier [%f]\n", dTmp));
                PutField_Double(hOfstTxn,"ex_rate",dTmp);
        }

/* response_code */
        PutField_CString(hOfstTxn, "response_code", "0");

/* internal_code */
        PutField_Int(hOfstTxn, "internal_code", 0);

	// Txn PSP Detail

/* psp_id */
        if (GetField_CString(hOrgTxn, "psp_id", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset psp_id [%s]\n", csTmp));
                PutField_CString(hOfstTxn, "psp_id", csTmp);
        }

/* baid */
        if (GetField_CString(hOrgTxn, "baid", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset baid [%s]\n", csTmp));
                PutField_CString(hOfstTxn, "baid", csTmp);
        }

/* txn_date */
        if (GetField_CString(hContext, "PHDATE", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset txn_date [%s]\n", csTmp));
                PutField_CString(hOfstTxn, "txn_date", csTmp);
        }

/* txn_ccy */
        if (GetField_CString(hOrgTxn, "txn_country", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset txn_country [%s]\n", csTmp));
                PutField_CString(hOfstTxn, "txn_country", csTmp);
        }

/* txn_ccy */
        if (GetField_CString(hOrgTxn, "txn_ccy", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset txn_ccy [%s]\n", csTmp));
                PutField_CString(hOfstTxn, "txn_ccy", csTmp);
        }

/* txn_amount */
        if (GetField_Double(hOrgTxn, "txn_amount", &dTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset txn_amount [%f]\n", dTmp));
                PutField_Double(hOfstTxn, "txn_amount", dTmp);
        }

/* bank_code */
        if (GetField_CString(hOrgTxn, "bank_code", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset bank_code [%s]\n", csTmp));
                PutField_CString(hOfstTxn, "bank_code", csTmp);
        }

/* bank_acct_num */
        if (GetField_CString(hOrgTxn, "bank_acct_num", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset bank_acct_num [%s]\n", csTmp));
                PutField_CString(hOfstTxn, "bank_acct_num", csTmp);
        }

/* cost */
        if (GetField_Double(hOrgTxn, "cost", &dTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset cost [%f]\n", dTmp));
                PutField_Double(hOfstTxn, "cost", dTmp);
        }

/* txn_hold_ind */
        if (GetField_Int(hOrgTxn, "txn_hold_ind", &iTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset txn_hold_ind [%d]\n", iTmp));
                PutField_Int(hOfstTxn, "txn_hold_int", iTmp);
        }

/* sys_match_ind */
        if (GetField_Int(hOrgTxn, "sys_match_ind", &iTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset sys_match_ind [%d]\n", iTmp));
                PutField_Int(hOfstTxn, "sys_match_ind", iTmp);
        }

/* customer_text */
        if (GetField_CString(hOrgTxn, "customer_text", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset customer_text [%s]\n", csTmp));
                PutField_CString(hOfstTxn, "customer_text", csTmp);
        }

/* sender_name */
        if (GetField_CString(hOrgTxn, "sender_name", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset sender_name [%s]\n", csTmp));
                PutField_CString(hOfstTxn, "sender_name", csTmp);
        }

/* txn_ref_num */
        if (GetField_CString(hOrgTxn, "txn_ref_num", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset txn_ref_num [%s]\n", csTmp));
                PutField_CString(hOfstTxn, "txn_ref_num", csTmp);
        }

/* charge_rule_id */
/*
	if (GetField_Int(hOrgTxn, "charge_rule_id", &iTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: charge_rule_id = [%d]\n", iTmp));
		PutField_Int(hOfstTxn, "charge_rule_id", iTmp);
	}
*/

/* charge_period_type */
/*
	if (GetField_Char(hOrgTxn, "charge_period_type", &cTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: charge_period_type = [%c]\n", cTmp));
		PutField_Char(hOfstTxn, "charge_period_type", cTmp);
	}
*/

/* precal_charge */
/*
	if (GetField_Double(hOrgTxn, "precal_charge", &dTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: precal_charge = [%f]\n", dTmp));
		PutField_Double(hOfstTxn, "precal_charge", dTmp);
	}
*/

/* grp_tracking_txn_seq */
	if (GetField_CString(hOrgTxn, "grp_tracking_txn_seq", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: grp_tracking_txn_Seq = [%s]\n", csTmp));
		PutField_CString(hOfstTxn, "grp_tracking_txn_seq", csTmp);
	}

/* tracking_txn_seq */
	if (GetField_CString(hOrgTxn, "tracking_txn_seq", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: tracking_txn_Seq = [%s]\n", csTmp));
		PutField_CString(hOfstTxn, "tracking_txn_seq", csTmp);
	}

/* report_date */
	if (GetField_CString(hOrgTxn, "report_date", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: report_date = [%s]\n", csTmp));
		PutField_CString(hOfstTxn, "report_date", csTmp);
	}

/* settlement_date */
	if (GetField_CString(hOrgTxn, "settlement_date", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: settlement_date = [%s]\n", csTmp));
		PutField_CString(hOfstTxn, "settlement_date", csTmp);
	}

/* manual_hold_recon */
        if (GetField_Int(hOrgTxn, "manual_hold_recon", &iTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail)::Offset manual_hold_recon [%d]\n", iTmp));
                PutField_Int(hOfstTxn,"manual_hold_recon",iTmp);
        }

	// Txn Elements

/* txn_ccy */
        if (GetField_CString(hOrgTxn, "txn_ccy", &csOrgCcy)) {
DEBUGLOG(("FormNewTxn (TxnElements)::txn_ccy [%s]\n", csOrgCcy));
        }

/* element_total_cnt */
        if (GetField_Int(hOrgTxn, "element_total_cnt", &iElementCnt)) {
DEBUGLOG(("FormNewTxn (TxnElements)::Offset element_total_cnt [%d]\n", iElementCnt));

                PutField_Int(hOfstTxn, "element_total_cnt", iElementCnt);

                for (i = 1; i < iElementCnt + 1; i++) {
DEBUGLOG(("FormNewTxn (TxnElements):: element_cnt = [%d]\n", i));

			// convert DR / CR
			// count diff_pool PD_ACCT_BAL_POOL / INTRANSIT_POOL

			sprintf(csTag, "element_party_type_%d", i);
                        if (GetField_Char(hOrgTxn, csTag, &cPartyType)) {
DEBUGLOG(("FormNewTxn (TxnElements): [%d] party_type [%c]\n", i, cPartyType));
                                PutField_Char(hOfstTxn, csTag, cPartyType);
                        }

                        sprintf(csTag, "element_ccy_%d", i);
                        if (GetField_CString(hOrgTxn, csTag, &csOrgElementCcy)) {
DEBUGLOG(("FormNewTxn (TxnElements): [%d] ccy [%s]\n", i, csOrgElementCcy));
                                PutField_CString(hOfstTxn, csTag, csOrgElementCcy);
                        }

                        sprintf(csTag, "element_amt_type_%d", i);
                        if (GetField_CString(hOrgTxn, csTag, &csOrgElementAmtType)) {
DEBUGLOG(("FormNewTxn (TxnElements): [%d] amt_type [%s]\n", i, csOrgElementAmtType));
                                PutField_CString(hOfstTxn, csTag, csOrgElementAmtType);

				if (iIsLastTxn) {
					if (!strcmp(csOrgElementAmtType, PD_CR)) {
                                                PutField_CString(hOfstTxn, csTag, PD_CR);
                                                cTmpDCInd = PD_IND_CREDIT;

                                        } else if (!strcmp(csOrgElementAmtType, PD_DR)) {
                                                PutField_CString(hOfstTxn, csTag, PD_DR);
                                                cTmpDCInd = PD_IND_DEBIT;
                                        }
				} else {
					// convert DR / CR
					if (!strcmp(csOrgElementAmtType, PD_CR)) {
	                                        PutField_CString(hOfstTxn, csTag, PD_DR);
	                                        cTmpDCInd = PD_IND_DEBIT;
	
	                                } else if (!strcmp(csOrgElementAmtType, PD_DR)) {
	                                        PutField_CString(hOfstTxn, csTag, PD_CR);
	                                        cTmpDCInd = PD_IND_CREDIT;
					}
				}
DEBUGLOG(("FormNewTxn (TxnElements): [%d] DR / CR [%c]\n", i, cTmpDCInd));
                        }

                        sprintf(csTag, "element_amount_%d", i);
                        if (GetField_Double(hOrgTxn, csTag, &dOrgElementAmount)) {
DEBUGLOG(("FormNewTxn (TxnElements): [%d] amount [%f]\n", i, dOrgElementAmount));
                                PutField_Double(hOfstTxn, csTag, dOrgElementAmount);
                        }

                        sprintf(csTag, "element_type_%d", i);
                        if (GetField_CString(hOrgTxn, csTag, &csOrgElementType)) {
DEBUGLOG(("FormNewTxn (TxnElements): [%d] type [%s]\n", i, csOrgElementType));
                                PutField_CString(hOfstTxn, csTag, csOrgElementType);

DEBUGLOG(("FormNewTxn (TxnElements): csOrgElementCcy [%s] csOrgCcy [%s]\n", csOrgElementCcy, csOrgCcy));
DEBUGLOG(("FormNewTxn (TxnElements): cPartyType [%c] PD_TYPE_PSP [%c]\n", cPartyType, PD_TYPE_PSP));
                                if (!strcmp(csOrgElementCcy, csOrgCcy) &&
                                        (cPartyType == PD_TYPE_PSP) ) {

                                        if (!strcmp(csOrgElementType, PD_ELEMENT_TXN_AMT) ||
                                            !strcmp(csOrgElementType, PD_ELEMENT_TXN_FEE)) {

DEBUGLOG(("FormNewTxn (TxnElements): cTmpDCInd [%c]\n", cTmpDCInd));
                                                if (cTmpDCInd == PD_IND_DEBIT) {
                                                        dTotalAcctBal = dTotalAcctBal - dOrgElementAmount;
                                                } else if (cTmpDCInd == PD_IND_CREDIT) {
                                                        dTotalAcctBal = dTotalAcctBal + dOrgElementAmount;
                                                }
                                        }
                                        else {

DEBUGLOG(("FormNewTxn (TxnElements): cTmpDCInd [%c]\n", cTmpDCInd));
                                                if (cTmpDCInd == PD_IND_DEBIT) {
                                                        dTotalIntransitBal = dTotalIntransitBal - dOrgElementAmount;
                                                } else if (cTmpDCInd == PD_IND_CREDIT) {
                                                        dTotalIntransitBal = dTotalIntransitBal + dOrgElementAmount;
                                                }
                                        }
                                }
                        }

			sprintf(csTag, "element_rate_%d", i);
                        if (GetField_Double(hOrgTxn, csTag, &dTmp)) {
DEBUGLOG(("FormNewTxn (TxnElements): [%d] rate [%f]\n", i, dTmp));
                                PutField_Double(hOfstTxn, csTag, dTmp);
                        }
                }

                dTotalAcctBal = newround(dTotalAcctBal, PD_DECIMAL_LEN);
                dTotalIntransitBal= newround(dTotalIntransitBal, PD_DECIMAL_LEN);

DEBUGLOG(("FormNewTxn (TxnElements):: AcctBal [%lf]\n", dTotalAcctBal));
DEBUGLOG(("FormNewTxn (TxnElements):: Intansit[%lf]\n", dTotalIntransitBal));

                PutField_Double(hContext, "element_acct_bal", dTotalAcctBal);
                PutField_Double(hContext, "element_intransit", dTotalIntransitBal);
        }

DEBUGLOG(("FormNewTxn:: iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessNewTxn(int iIsLastTxn, hash_t *hTxn, hash_t *hContext)
{
        int     iRet = PD_OK;

        char    csTag[PD_TAG_LEN + 1];

        char    *csTmp = NULL;
        char    cTmp;
        double  dTmp = 0.0;

        int     i;

        double  dTotalAcctBal = 0.0;
        double  dTotalIntransitBal = 0.0;

        char    *csOrgTxnSeq = NULL;
        char    *csTxnSeq = NULL;
	char	*csTxnCode = NULL;
        char    *csBatchSeq = NULL;
	
        char    cBatchType;
        char    cBatchSubType;
        char    cAmtType;
        int	iIsVoid = PD_FALSE;
	int     iElementCnt = 0;
        int     iGetOpenBal = PD_FALSE;
	
	hash_t  *hTxnDetail = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnDetail, 0);

        hash_t  *hTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnRec, 0);

        hash_t *hTxnElement;
        hTxnElement = (hash_t*) malloc(sizeof(hash_t));

        hash_t *hRelation;
        hRelation = (hash_t*) malloc(sizeof(hash_t));

	cBatchType = ' ';
	cBatchSubType = ' ';
	cAmtType = ' ';

/* org_txn_seq */
        if (GetField_CString(hTxn, "org_txn_seq", &csOrgTxnSeq)) {
DEBUGLOG(("ProcessNewTxn:: OrgTxnSeq [%s]\n", csOrgTxnSeq));
        }

/* txn_seq */
        if (GetField_CString(hTxn, "txn_seq", &csTxnSeq)) {
DEBUGLOG(("ProcessNewTxn::TxnSeq [%s]\n", csTxnSeq));
		PutField_CString(hTxnDetail, "txn_seq", csTxnSeq);
        }

/* txn_code */
	if (GetField_CString(hTxn, "txn_code", &csTxnCode)) {
DEBUGLOG(("ProcessNewTxn::TxnCode [%s]\n", csTxnCode));
        }

/* batch_txn_seq */
        if (GetField_CString(hContext, "batch_txn_seq", &csBatchSeq)) {
DEBUGLOG(("ProcessNewTxn:: BatchTxnSeq[%s]\n", csBatchSeq));
        }

/* batch_type */
        if (GetField_Char(hContext, "batch_type", &cBatchType)) {
DEBUGLOG(("ProcessNewTxn:: BatchType [%c]\n", cBatchType));
	}

/* batch_sub_type */
        if (GetField_Char(hContext, "batch_sub_type", &cBatchSubType)) {
DEBUGLOG(("ProcessNewTxn:: BatchSubType [%c]\n", cBatchSubType));
        }

/* is_void */
	if (GetField_Int(hContext, "is_void", &iIsVoid)) {
DEBUGLOG(("ProcessNewTxn:: is_void [%d]\n", iIsVoid));
        }

/* update_user */
        if (GetField_CString(hContext, "update_user", &csTmp)) {
DEBUGLOG(("ProcessNewTxn:: update_user [%s]\n", csTmp));

		PutField_CString(hTxnDetail, "add_user", csTmp);
                PutField_CString(hTxnDetail, "update_user", csTmp);
                PutField_CString(hTxnDetail, "create_user", csTmp);

		PutField_CString(hTxnRec, "add_user", csTmp);
                PutField_CString(hTxnRec, "update_user", csTmp);
                PutField_CString(hTxnRec, "create_user", csTmp);

                PutField_CString(hTxn, "add_user", csTmp);
                PutField_CString(hTxn, "update_user", csTmp);
                PutField_CString(hTxn, "create_user", csTmp);
        }

/* db_commit */
        PutField_Int(hTxn, "db_commit", PD_FALSE);
DEBUGLOG(("ProcessNewTxn: Call OMTChannel: AddTxnLog\n"));

DEBUGLOG(("ProcessNewTxn:: Call DBOLTransaction:Add\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Add");
        iRet = (unsigned long)(*DBObjPtr)(hTxn);
        if (iRet == PD_OK) {

/* baid */
                if (GetField_CString(hTxn, "baid", &csTmp)) {
DEBUGLOG(("ProcessNewTxn:: baid [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "baid", csTmp);
                }

/* txn_country */
                if (GetField_CString(hTxn, "txn_country", &csTmp)) {
DEBUGLOG(("ProcessNewTxn:: txn_country [%s]\n", csTmp));
                        PutField_CString(hTxnDetail, "txn_country", csTmp);
                        PutField_CString(hTxnRec, "txn_country", csTmp);
                }

/* txn_ccy */
                if (GetField_CString(hTxn, "txn_ccy", &csTmp)) {
DEBUGLOG(("ProcessNewTxn:: txn_ccy [%s]\n", csTmp));
                        PutField_CString(hTxnDetail, "txn_ccy", csTmp);
                        PutField_CString(hTxnRec, "txn_ccy", csTmp);
                }

/* element_acct_bal */
                if (GetField_Double(hContext, "element_acct_bal", &dTotalAcctBal)) {
DEBUGLOG(("ProcessNewTxn:: acct_bal [%lf]\n", dTotalAcctBal));
                }

/* element_intransit */
                if (GetField_Double(hContext, "element_intransit", &dTotalIntransitBal)) {
DEBUGLOG(("ProcessNewTxn:: intransit [%lf]\n", dTotalIntransitBal));
                }

		// Acct Bal
		if (dTotalAcctBal < 0.0) {
                        dTotalAcctBal = dTotalAcctBal * (-1.0);
                        cAmtType = PD_IND_DEBIT;
                } else if (dTotalAcctBal > 0.0) {
                        cAmtType = PD_IND_CREDIT;
                }

                if (dTotalAcctBal > 0.0) {

                        PutField_Char(hTxnRec, "amt_type", cAmtType);
                        PutField_Double(hTxnRec, "txn_amt", dTotalAcctBal);
                        PutField_CString(hTxnRec, "pool", PD_ACCT_BAL_POOL);

DEBUGLOG(("ProcessNewTxn:: Call BOOLBalance: UpdateAmount\n"));
                        BOObjPtr = CreateObj(BOPtr, "BOOLBalance", "UpdateAmount");
                        iRet = (unsigned long)(*BOObjPtr)(hTxnRec);
                        if (iRet == PD_OK) {

                                iGetOpenBal = PD_TRUE;

/* open_bal */
                                if (GetField_Double(hTxnRec, "open_bal", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:open_bal [%f]\n", dTmp));
                                        PutField_Double(hTxn, "open_bal", dTmp);
                                }

/* open_in_transit */
                                if (GetField_Double(hTxnRec, "open_in_transit", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:open_in_transit [%f]\n", dTmp));
                                        PutField_Double(hTxn, "open_in_transit", dTmp);
                                }

/* approval_date */
                                if (GetField_CString(hTxnRec, "approval_date", &csTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:approval_date [%s]\n", csTmp));
                                        PutField_CString(hTxn, "approval_date", csTmp);
                                }

/* approval_timestamp */
                                if (GetField_CString(hTxnRec, "approval_timestamp", &csTmp))  {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:approval_timestamp [%s]\n", csTmp));
                                        PutField_CString(hTxn, "approval_timestamp", csTmp);
                                }

/* bal */
                                if (GetField_Double(hTxnRec, "bal", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:balance = [%f]\n", dTmp));
                                        PutField_Double(hTxn, "bal", dTmp);
                                }

/* total_hold */
                                if (GetField_Double(hTxnRec, "total_hold", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:total_hold = [%f]\n", dTmp));
                                        PutField_Double(hTxn, "total_hold", dTmp);
                                }

/* prepaid */
                                if (GetField_Double(hTxnRec, "prepaid", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:prepaid = [%f]\n", dTmp));
                                        PutField_Double(hTxn, "prepaid", dTmp);
                                }

/* in_transit */
                                if (GetField_Double(hTxnRec, "in_transit", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:in_transit = [%f]\n", dTmp));
                                        PutField_Double(hTxn, "in_transit", dTmp);
                                }
                        }
                }

		// Intrasit
		if (iRet == PD_OK) {

                        if (dTotalIntransitBal < 0.0) {
                                dTotalIntransitBal = dTotalIntransitBal * (-1.0);
                                cAmtType = PD_IND_DEBIT;
                        } else if (dTotalIntransitBal > 0.0) {
                                cAmtType = PD_IND_CREDIT;
                        }

                        if (dTotalIntransitBal > 0.0) {

                                PutField_Char(hTxnRec, "amt_type", cAmtType);
                                PutField_Double(hTxnRec, "txn_amt", dTotalIntransitBal);
                                PutField_CString(hTxnRec, "pool", PD_INTRANSIT_POOL);

DEBUGLOG(("ProcessNewTxn:: Call BOOLBalance: UpdateAmount\n"));
                                BOObjPtr = CreateObj(BOPtr, "BOOLBalance", "UpdateAmount");
                                iRet = (unsigned long)(*BOObjPtr)(hTxnRec);
                                if (iRet == PD_OK) {

                                        if (iGetOpenBal == PD_FALSE) {

/* open_bal */
                                                if (GetField_Double(hTxnRec, "open_bal", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:open_bal [%f]\n", dTmp));
                                                        PutField_Double(hTxn, "open_bal", dTmp);
                                                }

/* open_in_transit */
                                                if (GetField_Double(hTxnRec, "open_in_transit", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:open_in_transit [%f]\n", dTmp));
                                                        PutField_Double(hTxn, "open_in_transit", dTmp);
                                                }

/* approval_date */
                                                if (GetField_CString(hTxnRec, "approval_date", &csTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:approval_date [%s]\n", csTmp));
                                                        PutField_CString(hTxn, "approval_date", csTmp);
                                                }

/* approval_timestamp */
                                                if (GetField_CString(hTxnRec, "approval_timestamp", &csTmp))  {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:approval_timestamp [%s]\n", csTmp));
                                                        PutField_CString(hTxn, "approval_timestamp", csTmp);
                                                }
                                        }

/* bal */
                                        if (GetField_Double(hTxnRec, "bal", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:balance = [%f]\n", dTmp));
                                                PutField_Double(hTxn, "bal", dTmp);
                                        }

/* total_hold */
                                        if (GetField_Double(hTxnRec, "total_hold", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:total_hold = [%f]\n", dTmp));
                                                PutField_Double(hTxn, "total_hold", dTmp);
                                        }

/* prepaid */
                                        if (GetField_Double(hTxnRec, "prepaid", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:prepaid = [%f]\n", dTmp));
                                                PutField_Double(hTxn, "prepaid", dTmp);
                                        }

/* in_transit */
                                        if (GetField_Double(hTxnRec, "in_transit", &dTmp)) {
DEBUGLOG(("ProcessNewTxn::Call BOOLBalance:in_transit = [%f]\n", dTmp));
                                                PutField_Double(hTxn, "in_transit", dTmp);
                                        }
                                }
                        }
                }
        }

	// Add Element
	if (iRet == PD_OK) {
                hash_init(hTxnElement, 0);

/* update_user */
                if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hTxnElement, "update_user", csTmp);
                        PutField_CString(hTxnElement, "add_user", csTmp);
                        PutField_CString(hTxnElement, "create_user", csTmp);
                }

/* element_total_cnt */
                if (GetField_Int(hTxn, "element_total_cnt", &iElementCnt)) {
DEBUGLOG(("ProcessNewTxn:: element_total_cnt [%d]\n", iElementCnt));
                }

                for (i = 1 ; i < iElementCnt + 1; i++) {

/* txn_seq */
                        PutField_CString(hTxnElement, "txn_seq", csTxnSeq);

/* txn_ccy */
                        sprintf(csTag, "element_ccy_%d", i);
                        if (GetField_CString(hTxn, csTag, &csTmp)) {
DEBUGLOG(("ProcessNewTxn:: [%d] txn_ccy [%s]\n", i, csTmp));
                                PutField_CString(hTxnElement, "txn_ccy", csTmp);
                        }

/* txn_amt */
                        sprintf(csTag, "element_amount_%d", i);
                        if (GetField_Double(hTxn, csTag, &dTmp)) {
DEBUGLOG(("ProcessNewTxn:: [%d] txn_amt [%d]\n", i, dTmp));
                                PutField_Double(hTxnElement, "txn_amt", dTmp);
                        }

/* txn_element_type */
                        sprintf(csTag, "element_type_%d", i);
                        if (GetField_CString(hTxn, csTag, &csTmp)) {
DEBUGLOG(("ProcessNewTxn:: [%d] txn_element_type [%s]\n", i, csTmp));
                                PutField_CString(hTxnElement, "txn_element_type", csTmp);
                        }

/* party_type */
                        sprintf(csTag, "part_type_%d", i);
                        if (GetField_Char(hTxn, csTag, &cTmp)) {
DEBUGLOG(("ProcessNewTxn:: [%d] party_type [%c]\n", i, cTmp));
                                PutField_Char(hTxnElement, "party_type", cTmp);
                        }

/* amount_type */
                        sprintf(csTag, "element_amt_type_%d", i);
                        if (GetField_CString(hTxn, csTag, &csTmp)) {
DEBUGLOG(("ProcessNewTxn:: [%d] amount_type [%s]\n", i, csTmp));
                                PutField_CString(hTxnElement, "amount_type", csTmp);
                        }

DEBUGLOG(("ProcessNewTxn Call BOOLTxnElements:AddPspTxnElement [%d]\n",i ));
                        BOObjPtr = CreateObj(BOPtr, "BOOLTxnElements", "AddPspTxnElement");
                        iRet = (unsigned long)(*BOObjPtr)(hTxnElement);
                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessNewTxn Call BOOLTxnElements:AddPspTxnElement [%d] error\n",i ));
                                break;
                        } else {
DEBUGLOG(("ProcessNewTxn Call BOOLTxnElements:AddPspTxnElement [%d] completed\n",i ));
                        }
                }

                hash_destroy(hTxnElement);
        }

	// Add Txn Detail
        if (iRet == PD_OK) {

DEBUGLOG(("ProcessNewTxn:: Call DBOLTransaction: AddDetail\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "AddDetail");
                iRet = (unsigned long)(*DBObjPtr)(hTxnDetail);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
                }
        }

	// Update Txn Header
        if (iRet == PD_OK) {

/* status, ar_ind, sub_status, recon_status */
                PutField_Char(hTxn, "status", PD_COMPLETE);
DEBUGLOG(("ProcessNewTxn:: status [%c]\n", PD_COMPLETE));

                PutField_Char(hTxn, "ar_ind", PD_ACCEPT);
DEBUGLOG(("ProcessNewTxn:: status [%c]\n", PD_ACCEPT));

		if ((iIsLastTxn == PD_TRUE) 
		    && (!strcmp(csTxnCode, PD_OL_PAYOUT_VOID_PSP))
		) 
		{
			PutField_CString(hTxn, "sub_status", PD_REFUND_APPROVED);
DEBUGLOG(("ProcessNewTxn:: sub_status [%s]\n", PD_REFUND_APPROVED));
		}
		else
		{
                	PutField_CString(hTxn, "sub_status", PD_APPROVED);		
DEBUGLOG(("ProcessNewTxn:: sub_status [%s]\n", PD_APPROVED));
		}

		if (iIsVoid == PD_TRUE) {
                	PutField_Char(hTxn, "recon_status", PD_RECON_NOT_REQ);
DEBUGLOG(("ProcessNewTxn:: recon_status [%c]\n", PD_RECON_NOT_REQ));
		} else {
                	PutField_Char(hTxn, "recon_status", PD_UNRECONCILED);
DEBUGLOG(("ProcessNewTxn:: recon_status [%c]\n", PD_UNRECONCILED));
		}
	
DEBUGLOG(("ProcessNewTxn Call DBOLTransaction:Update\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxn);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
                }
        }

	// Add Txn PSP Detail
        if (iRet == PD_OK) {

DEBUGLOG(("ProcessNewTxn Call DBOLTxnPspDetail:Add\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Add");
                iRet = (unsigned long)(*DBObjPtr)(hTxn);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
                }
        }

	// Update Txn PSP Detail
        if (iRet == PD_OK) {

DEBUGLOG(("ProcessNewTxn Call DBOLTxnPspDetail:Update\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxn);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
                }
        }

	// Add Txn Relation (Void)
	if ((iIsLastTxn == PD_FALSE) && (iRet == PD_OK)) {
DEBUGLOG(("ProcessNewTxn TxnRelation!\n"));

                hash_init(hRelation, 0);

		// Org Txn Seq
		PutField_Char(hRelation, "party", PD_TYPE_PSP);
                PutField_CString(hRelation, "p1_txn_id", csTxnSeq);
                PutField_CString(hRelation, "p2_txn_id", csOrgTxnSeq);
                PutField_Char(hRelation, "txn_level", PD_TXN_LEVEL);
                PutField_Char(hRelation, "relation_type", PD_REL_VOID);
                if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hRelation, "update_user", csTmp);
                        PutField_CString(hRelation, "add_user", csTmp);
                        PutField_CString(hRelation, "create_user", csTmp);
                }

                iRet = AddTxnRelation(hRelation);

                hash_destroy(hRelation);
        }


	// Add Batch Txn Relation (Txn Id)
	if ((iNumOfBatchId > 0) && (iRet == PD_OK)) {
DEBUGLOG(("ProcessNewTxn BatchTxnRelation!\n"));

                hash_init(hRelation, 0);

                PutField_Char(hRelation, "batch_type", cBatchType);
		if (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) {
			PutField_Char(hRelation, "batch_sub_type", PD_GENERAL_UNDO_BAL_TRF);
		} else {
                	PutField_Char(hRelation, "batch_sub_type", cBatchSubType);
		}
                PutField_CString(hRelation, "batch_txn_seq", csBatchSeq);
                PutField_Char(hRelation, "txn_level", PD_TXN_LEVEL);
                PutField_CString(hRelation, "txn_seq", csTxnSeq);
                PutField_Int(hRelation, "is_input_txn", 0);
		if (iIsLastTxn == PD_FALSE) {
                	PutField_Int(hRelation, "is_regen_txn", 0);
		} else {
                	PutField_Int(hRelation, "is_regen_txn", 1);
		}
		if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hRelation, "update_user", csTmp);
                        PutField_CString(hRelation, "add_user", csTmp);
                        PutField_CString(hRelation, "create_user", csTmp);
                }

                iRet = AddBatchTxnRelation(hRelation);

                hash_destroy(hRelation);
        }

	hash_destroy(hTxnDetail);
	hash_destroy(hTxnRec);
        hash_destroy(hTxnElement);

        FREE_ME(hTxnDetail);
        FREE_ME(hTxnRec);
        FREE_ME(hTxnElement);
        FREE_ME(hRelation);

DEBUGLOG(("ProcessNewTxn:: iRet = [%d]\n",iRet));
        return iRet;	
}

int     ProcessOrgTxn(hash_t *hOrgTxn, hash_t *hContext)
{
        int     iRet = PD_OK;

	char 	cReconStatus;
	
        char    *csTmp = NULL;
        char    *csTxnSeq = NULL;
	char	*csBaidCategory = NULL;

        hash_t  *hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec, 0);

	cReconStatus = ' ';

/* txn_seq */
        if (GetField_CString(hOrgTxn, "txn_seq", &csTxnSeq)) {
DEBUGLOG(("ProcessOrgTxn txn_seq [%s]\n", csTxnSeq));
                PutField_CString(hRec, "txn_seq", csTxnSeq);
        }
	
/* baid_category */
	if (GetField_CString(hOrgTxn, "baid_category", &csBaidCategory)) {
DEBUGLOG(("ProcessOrgTxn baid_category [%s]\n", csBaidCategory));
        }	

/* recon_status */
	if (GetField_Char(hOrgTxn, "recon_status", &cReconStatus)) {
DEBUGLOG(("ProcessOrgTxn recon_status = [%c]\n", cReconStatus));
	}

/* update_user */
        if (GetField_CString(hContext, "update_user", &csTmp)) {
DEBUGLOG(("ProcessOrgTxn upate_user [%s]\n", csTmp));
                PutField_CString(hRec, "update_user", csTmp);
        }

/* status, sub_status, recon_status */
        PutField_Char(hRec, "status", PD_REVERSED);
DEBUGLOG(("ProcessOrgTxn status [%c]\n", PD_REVERSED));

	if (!strcmp(csTxnType, PD_TXN_TYPE_SMS_BANK_DEPOSIT)) {
		if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {
                      	PutField_CString(hRec, "sub_status", PD_UNDO);
DEBUGLOG(("ProcessOrgTxn sub_status [%s]\n", PD_UNDO));

                        PutField_Char(hRec, "recon_status", PD_UNRECONCILED);
DEBUGLOG(("ProcessOrgTxn recon_status [%c]\n", PD_UNRECONCILED));
                } else {
                      	PutField_CString(hRec, "sub_status", PD_UNDO);
DEBUGLOG(("ProcessOrgTxn sub_status [%s]\n", PD_UNDO));
                }
	} else {
		if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {
			if (cReconStatus == PD_UNRECONCILED) {
				PutField_CString(hRec, "sub_status", PD_CANCELLED);
DEBUGLOG(("ProcessOrgTxn sub_status [%s]\n", PD_CANCELLED));
			} else if (cReconStatus == PD_RECONCILED) { 
				PutField_CString(hRec, "sub_status", PD_UNDO);
DEBUGLOG(("ProcessOrgTxn sub_status [%s]\n", PD_UNDO));
			}
		
			PutField_Char(hRec, "recon_status", PD_UNRECONCILED);
DEBUGLOG(("ProcessOrgTxn recon_status [%c]\n", PD_UNRECONCILED));
		} else {
			if (iAction == PD_BATCH_ACTION_CANCEL) {
        			PutField_CString(hRec, "sub_status", PD_CANCELLED);
DEBUGLOG(("ProcessOrgTxn sub_status [%s]\n", PD_CANCELLED));
			} else if (iAction == PD_BATCH_ACTION_VOID) {
				PutField_CString(hRec, "sub_status", PD_UNDO);
DEBUGLOG(("ProcessOrgTxn sub_status [%s]\n", PD_UNDO));
			}
		}
	}

DEBUGLOG(("ProcessOrgTxn() call DBOLTransaction::Update()\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
        iRet = (unsigned long)(*DBObjPtr)(hRec);
        if (iRet != PD_OK) {
                iRet = INT_ERR;
DEBUGLOG(("ProcessOrgTxn() call DBOLTransaction::Update() failed\n"));
ERRLOG("TxnOmtByUsRBT::ProcessOrgTxn() call DBOLTransaction::Update() failed\n");
        }

        hash_destroy(hRec);
        FREE_ME(hRec);

DEBUGLOG(("ProcessOrgTxn:: iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessOrgTxnSeq(const char* csOrgTxnSeq, hash_t *hContext)
{
	int     iRet = PD_OK;

        char    *csTmp = NULL;

        hash_t  *hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec, 0);

/* org_txn_seq */
       	PutField_CString(hRec, "txn_seq", csOrgTxnSeq);
DEBUGLOG(("ProcessOrgTxnSeq txn_seq [%s]\n", csOrgTxnSeq));

/* update_user */
        if (GetField_CString(hContext, "update_user", &csTmp)) {
DEBUGLOG(("ProcessOrgTxnSeq upate_user [%s]\n", csTmp));
                PutField_CString(hRec, "update_user", csTmp);
        }

/* status, sub_status */
        PutField_Char(hRec, "status", PD_REVERSED);
DEBUGLOG(("ProcessOrgTxnSeq status [%c]\n", PD_REVERSED));

        if (iAction == PD_BATCH_ACTION_CANCEL) {
                PutField_CString(hRec, "sub_status", PD_CANCELLED);
DEBUGLOG(("ProcessOrgTxnSeq sub_status [%s]\n", PD_CANCELLED));
        } else if (iAction == PD_BATCH_ACTION_VOID) {
                PutField_CString(hRec, "sub_status", PD_UNDO);
DEBUGLOG(("ProcessOrgTxnSeq sub_status [%s]\n", PD_UNDO));
        }

DEBUGLOG(("ProcessOrgTxnSeq() call DBOLTransaction::Update()\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
        iRet = (unsigned long)(*DBObjPtr)(hRec);
        if (iRet != PD_OK) {
                iRet = INT_ERR;
DEBUGLOG(("ProcessOrgTxnSeq() call DBOLTransaction::Update() failed\n"));
ERRLOG("TxnOmtByUsRBT::ProcessOrgTxnSeq() call DBOLTransaction::Update() failed\n");
        }

        hash_destroy(hRec);
        FREE_ME(hRec);

DEBUGLOG(("ProcessOrgTxnSeq:: iRet = [%d]\n",iRet));
        return iRet;
}

int	IsCreateLastTxnId(const char *csOrgBatchId, const char* csOrgTxnSeq, hash_t* hOrgTxn, hash_t *hContext)
{
	int     iRet = PD_TRUE;

	char	cOrgBatchType;
	char	cOrgBatchSubType;

	char    *csTxnCode = NULL;
        char    *csProcessType = NULL;
        char    *csProcessCode = NULL;

	cOrgBatchType = ' ';
	cOrgBatchSubType = ' ';

/* org_batch_sub_type */
        if(GetField_Char(hContext, "org_batch_sub_type", &cOrgBatchSubType)){
DEBUGLOG(("IsCreateLastTxnId:: org_batch_sub_type = [%c]\n",cOrgBatchSubType));
        }

	// Check Action	
	if (iAction == PD_BATCH_ACTION_CANCEL) {
		iRet = PD_FALSE;
	}

	// Check TxnType
	if (iRet == PD_TRUE) {
        	if (!strcmp(csTxnType, PD_TXN_TYPE_HOLD_DEPOSIT)) {
			iRet = PD_FALSE;
		}
	}

	// Check Batch Sub Type and Check Fe Init
	if (iRet == PD_TRUE) {

		if (cOrgBatchSubType != PD_COMBINE_RECON) {
/* txn_code */
                	if (GetField_CString(hOrgTxn, "txn_code", &csTxnCode)) {
DEBUGLOG(("IsCreateLastTxnId:: txn_code = [%s]\n", csTxnCode));
                	}

/* process_type */
                	if (GetField_CString(hOrgTxn, "process_type", &csProcessType)) {
DEBUGLOG(("IsCreateLastTxnId:: process_type = [%s]\n", csProcessType));
                	}

/* process_code */
                	if (GetField_CString(hOrgTxn, "process_code", &csProcessCode)) {
DEBUGLOG(("IsCreateLastTxnId:: process_code = [%s]\n", csProcessCode));
                	}

			DBObjPtr = CreateObj(DBPtr,"DBTxnCode","AllowFeInit");
                	iRet = (unsigned long)(*DBObjPtr)(csTxnCode);
                	if (iRet == PD_TRUE) {
DEBUGLOG(("IsCreateLastTxnId::call DBTxnCode AllowFeInit:: fe_init = PD_TRUE\n"));
                	} else if (iRet == PD_FALSE) {
DEBUGLOG(("IsCreateLastTxnId::call DBTxnCode AllowFeInit:: fe_init = PD_FALSE\n"));
                	} else {
                        	iRet = INT_ERR;
DEBUGLOG(("IsCreateLastTxnId::call DBTxnCode AllowFeInit::not found!!\n"));
ERRLOG("TxnOmtByUsRBT::IsCreateLastTxnId::call DBTxnCode AllowFeInit::not found!!\n");
                	}
		}
	}

	// Check Input Txn Id
	if (iRet == PD_TRUE) {
             	iRet = IsInputTxnId(csOrgBatchId, csOrgTxnSeq, hContext);
	}

DEBUGLOG(("IsCreateLastTxnId: iRet = [%d]\n",iRet));
        return iRet;	
}	

int     ProcessLastTxn(const char* csTxnId, hash_t* hOrgTxn, hash_t* hNewTxn, hash_t *hContext)
{
	int     iRet = PD_OK;
	int     iDtlRet = PD_OK;

	char	*csTmp = NULL;

	char    *csOrgTxnId = NULL;
        char    *csNewTxnId = NULL;
	
	char	*csTxnCode = NULL;

	hash_t  *hRec;
        hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec, 0);

	hash_t *hRelation;
        hRelation = (hash_t*) malloc(sizeof(hash_t));

DEBUGLOG(("===== ProcessLastTxn ===== START!!\n"));

DEBUGLOG(("ProcessLastTxn:: txn_id [%s]\n", csTxnId));
	
/* txn_code */
      	if (GetField_CString(hOrgTxn, "txn_code", &csTxnCode)) {
DEBUGLOG(("ProcessLastTxn:: txn_code = [%s]\n", csTxnCode));
      	}

	// Form Offset Txn (NOT reversal CR / DR sign)
	iRet = FormNewTxn(PD_TRUE,hOrgTxn,hNewTxn,hContext);

	// Create Txn (with add approval_date, approval_timestamp)
	if (iRet == PD_OK) {
		iRet = ProcessNewTxn(PD_TRUE,hNewTxn,hContext);
	}

	// Create Payout Gen File Detail Map (Payout Only)
	if (iRet == PD_OK) {
                if (!strcmp(csTxnCode, PD_OFFLINE_PAYOUT_TXN_CODE)) {

/* action_type */
                        PutField_Char(hRec, "action_type", PD_OL_ACTION_VOID);
DEBUGLOG(("ProcessLastTxn:: action_type [%s]\n", PD_OL_ACTION_VOID));

/* org_txn_id */
                        if (GetField_CString(hOrgTxn, "txn_seq", &csOrgTxnId)) {
DEBUGLOG(("ProcessLastTxn:: org_txn_id [%s]\n", csOrgTxnId));
                                PutField_CString(hRec, "org_txn_id", csOrgTxnId);
                        }

/* new_txn_id */
                        if (GetField_CString(hNewTxn, "txn_seq", &csNewTxnId)) {
DEBUGLOG(("ProcessLastTxn:: new_txn_id [%s]\n", csNewTxnId));
                                PutField_CString(hRec, "new_txn_id", csNewTxnId);
                        }

                        DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGenFileDtMap","Add");
                        iDtlRet = (unsigned long)(*DBObjPtr)(hRec);
                        if (iDtlRet != PD_OK) {
                                iRet = INT_ERR;
DEBUGLOG(("ProcessLastTxn::call DBOLPayoutGenFileDtMap Add::failed!!\n"));
ERRLOG("TxnOmtByUsRBT::ProcessLastTxn::call DBOLPayoutGenFileDtMap Add::failed!!\n");
                        }
                }
        }

	// Add Txn Relation (Linkage)
	if (iRet == PD_OK) {
DEBUGLOG(("ProcessLastTxn TxnRelation(Linkage)!\n"));
	
		hash_init(hRelation, 0);

		PutField_Char(hRelation, "party", PD_TYPE_PSP);
                PutField_CString(hRelation, "p1_txn_id", csTxnId);
DEBUGLOG(("ProcessLastTxn:: p1_txn_id [%s]\n", csTxnId));
              	if (GetField_CString(hNewTxn, "txn_seq", &csNewTxnId)) {
DEBUGLOG(("ProcessLastTxn:: p2_txn_id [%s]\n", csNewTxnId));
                  	PutField_CString(hRelation, "p2_txn_id", csNewTxnId);
               	}
                PutField_Char(hRelation, "txn_level", PD_TXN_LEVEL);
                PutField_Char(hRelation, "relation_type", PD_REL_LINKAGE);
                if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hRelation, "update_user", csTmp);
                        PutField_CString(hRelation, "add_user", csTmp);
                        PutField_CString(hRelation, "create_user", csTmp);
                }

                iRet = AddTxnRelation(hRelation);

                hash_destroy(hRelation);
	}

	// Add Txn Relation (Revive)
	if (iRet == PD_OK) {
DEBUGLOG(("ProcessLastTxn TxnRelation(Revive)!\n"));

                hash_init(hRelation, 0);

                PutField_Char(hRelation, "party", PD_TYPE_PSP);
                PutField_CString(hRelation, "p1_txn_id", csNewTxnId);
DEBUGLOG(("ProcessLastTxn:: p1_txn_id [%s]\n", csNewTxnId));
		if (GetField_CString(hOrgTxn, "txn_seq", &csOrgTxnId)) {	
DEBUGLOG(("ProcessLastTxn:: p2_txn_id [%s]\n", csOrgTxnId));
                        PutField_CString(hRelation, "p2_txn_id", csOrgTxnId);
                }
                PutField_Char(hRelation, "txn_level", PD_TXN_LEVEL);
                PutField_Char(hRelation, "relation_type", PD_REL_REGEN);
                if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hRelation, "update_user", csTmp);
                        PutField_CString(hRelation, "add_user", csTmp);
                        PutField_CString(hRelation, "create_user", csTmp);
                }

                iRet = AddTxnRelation(hRelation);

                hash_destroy(hRelation);
        }

        hash_destroy(hRec);

        FREE_ME(hRec);

	FREE_ME(hRelation);
	
DEBUGLOG(("ProcessLastTxn:: iRet = [%d]\n",iRet));
DEBUGLOG(("===== ProcessLastTxn ===== END !!\n"));

        return iRet;
}

int	StoreP1LastTxnInfo(const char* csOrgTxnSeq, const char *csNewTxnSeq, const char *csLastTxnSeq, recordset_t *rTmpP1LastTxnRecordSet, hash_t *hTmpP1LastTxnRec, hash_t *hContext)
{
	int     iRet = PD_OK;
        int     iDtlRet = PD_TRUE;

	hash_t  *hRec = NULL;
        hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec,0);

DEBUGLOG(("===== StoreLastTxnInfo ===== START!!\n"));
	
	PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

	// Check Bal Trf Txn Id (P1)
DEBUGLOG(("StoreLastTxnInfo:: Call DBOLTxnRelation:: CheckIsBalTransP1TxnId\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","CheckIsBalTransP1TxnId");
        iDtlRet = (unsigned long)(*DBObjPtr)(hRec);
        if (iDtlRet == PD_TRUE) {
DEBUGLOG(("StoreLastTxnInfo:: Call DBOLTxnRelation:: Bal Trf P1 Txn Id Found!!!\n"));

		PutField_CString(hTmpP1LastTxnRec, "p1_org_txn_seq" ,csOrgTxnSeq);
DEBUGLOG(("StoreLastTxnInfo:: Call DBOLTxnRelation:: p1_org_txn_seq = [%s]\n", csOrgTxnSeq));

		PutField_CString(hTmpP1LastTxnRec, "p1_new_txn_seq" ,csNewTxnSeq);
DEBUGLOG(("StoreLastTxnInfo:: Call DBOLTxnRelation:: p1_new_txn_seq = [%s]\n", csNewTxnSeq));

                PutField_CString(hTmpP1LastTxnRec, "p1_last_txn_seq" ,csLastTxnSeq);
DEBUGLOG(("StoreLastTxnInfo:: Call DBOLTxnRelation:: p1_last_txn_seq = [%s]\n", csLastTxnSeq));

		RecordSet_Add(rTmpP1LastTxnRecordSet, hTmpP1LastTxnRec);
	}

DEBUGLOG(("StoreLastTxnInfo:: iRet = [%d]\n",iRet));
DEBUGLOG(("===== StoreLastTxnInfo ===== END !!\n"));

	hash_destroy(hRec);
        FREE_ME(hRec);

        return iRet;
}

int     StoreP2LastTxnInfo(const char* csOrgTxnSeq, const char *csNewTxnSeq, const char *csLastTxnSeq, recordset_t *rTmpP2LastTxnRecordSet, hash_t *hTmpP2LastTxnRec, hash_t *hContext)
{
        int     iRet = PD_OK;
        int     iDtlRet = PD_TRUE;

        hash_t  *hRec = NULL;
        hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec,0);

DEBUGLOG(("===== StoreLastTxnInfo ===== START!!\n"));

        PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

	// Check Bal Trf Txn Id (P2)
DEBUGLOG(("StoreLastTxnInfo:: Call DBOLTxnRelation:: CheckIsBalTransP2TxnId\n"));
      	DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","CheckIsBalTransP2TxnId");
      	iDtlRet = (unsigned long)(*DBObjPtr)(hRec);
       	if (iDtlRet == PD_TRUE) {
DEBUGLOG(("StoreLastTxnInfo:: Call DBOLTxnRelation:: Bal Trf P2 Txn Id Found!!!\n"));

            	PutField_CString(hTmpP2LastTxnRec, "p2_org_txn_seq" ,csOrgTxnSeq);
DEBUGLOG(("StoreLastTxnInfo:: Call DBOLTxnRelation:: p2_org_txn_seq = [%s]\n", csOrgTxnSeq));

              	PutField_CString(hTmpP2LastTxnRec, "p2_new_txn_seq" ,csNewTxnSeq);
DEBUGLOG(("StoreLastTxnInfo:: Call DBOLTxnRelation:: p2_new_txn_seq = [%s]\n", csNewTxnSeq));

             	PutField_CString(hTmpP2LastTxnRec, "p2_last_txn_seq" ,csLastTxnSeq);
DEBUGLOG(("StoreLastTxnInfo:: Call DBOLTxnRelation:: p2_last_txn_seq = [%s]\n", csLastTxnSeq));

             	RecordSet_Add(rTmpP2LastTxnRecordSet, hTmpP2LastTxnRec);
      	}

DEBUGLOG(("StoreLastTxnInfo:: iRet = [%d]\n",iRet));
DEBUGLOG(("===== StoreLastTxnInfo ===== END !!\n"));

        hash_destroy(hRec);
        FREE_ME(hRec);

        return iRet;
}	
	
int     ProcessLastTxnRelation(recordset_t *rTmpP1LastTxnRecordSet, recordset_t *rTmpP2LastTxnRecordSet, recordset_t *rLastTxnRecordSet, hash_t *hLastTxnRec, hash_t *hContext)
{
	int     iRet = PD_OK;
	int     iDtlRet = PD_FOUND;

	char 	*csP2TxnId = NULL;
	
	char    *csP1OrgTxnId = NULL;
	char    *csP1NewTxnId = NULL;
	char    *csP1LastTxnId = NULL;
	char    *csP2OrgTxnId = NULL;
        char    *csP2NewTxnId = NULL;
        char    *csP2LastTxnId = NULL;

	char	*csTmp = NULL;
	
	hash_t  *hTmpP1LastTxnRecGet = NULL;
	hash_t  *hTmpP2LastTxnRecGet = NULL;

	hash_t          *hTmpP1OrgRec;
        hTmpP1OrgRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpP1OrgRec,0);

        hash_t          *hP1OrgRec = NULL;
        recordset_t     *rP1OrgRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rP1OrgRecordSet,0);

DEBUGLOG(("===== ProcessLastTxnRelation ===== START !!\n"));

	hTmpP1LastTxnRecGet = RecordSet_GetFirst(rTmpP1LastTxnRecordSet);
        while (hTmpP1LastTxnRecGet) {

/* p1_org_txn_seq */
             	if (GetField_CString(hTmpP1LastTxnRecGet, "p1_org_txn_seq", &csP1OrgTxnId)) {
DEBUGLOG(("ProcessLastTxnRelation:: p1_org_txn_seq = [%s]\n", csP1OrgTxnId));
             	}

/* p1_new_txn_seq */
            	if (GetField_CString(hTmpP1LastTxnRecGet, "p1_new_txn_seq", &csP1NewTxnId)) {
DEBUGLOG(("ProcessLastTxnRelation:: p1_new_txn_seq = [%s]\n", csP1NewTxnId));
             	}

/* p1_last_txn_seq */
              	if (GetField_CString(hTmpP1LastTxnRecGet, "p1_last_txn_seq", &csP1LastTxnId)) {
DEBUGLOG(("ProcessLastTxnRelation:: p1_last_txn_seq = [%s]\n", csP1LastTxnId));		
		}

		PutField_Char(hTmpP1OrgRec,"party_type",PD_TYPE_PSP);
               	PutField_CString(hTmpP1OrgRec,"p1_txn_id",csP1OrgTxnId);
               	PutField_Char(hTmpP1OrgRec,"txn_level",PD_TXN_LEVEL);
             	PutField_Char(hTmpP1OrgRec,"relation_type",PD_REL_BAL_TRF);

DEBUGLOG(("ProcessLastTxnRelation:: Call DBOLTxnRelation GetP2TxnId\n"));
            	DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","GetP2TxnId");
             	iDtlRet = (unsigned long)(*DBObjPtr)(hTmpP1OrgRec,rP1OrgRecordSet);
           	if (iDtlRet == PD_FOUND) {
DEBUGLOG(("ProcessLastTxnRelation:: Call DBOLTxnRelation:: Txn Id Found!!!\n"));

                    	hP1OrgRec = RecordSet_GetFirst(rP1OrgRecordSet);
                     	while (hP1OrgRec) {
			
/* p2_txn_id */
                            	if (GetField_CString(hP1OrgRec, "p2_txn_id", &csP2TxnId)) {
DEBUGLOG(("ProcessLastTxnRelation:: Call DBOLTxnRelation:: p2_txn_id = [%s]\n", csP2TxnId));

					hTmpP2LastTxnRecGet = RecordSet_GetFirst(rTmpP2LastTxnRecordSet);
        				while (hTmpP2LastTxnRecGet) {

/* p2_org_txn_seq */
                                		if (GetField_CString(hTmpP2LastTxnRecGet, "p2_org_txn_seq", &csP2OrgTxnId)) {
DEBUGLOG(("ProcessLastTxnRelation:: Call DBOLTxnRelation:: p2_org_txn_seq = [%s]\n", csP2OrgTxnId));
                                		}

						if (!strcmp(csP2TxnId, csP2OrgTxnId)) {		

/* p2_new_txn_seq */
                                			if (GetField_CString(hTmpP2LastTxnRecGet, "p2_new_txn_seq", &csP2NewTxnId)) {
DEBUGLOG(("ProcessLastTxnRelation:: p2_new_txn_seq = [%s]\n", csP2NewTxnId));
                                			}

/* p2_last_txn_seq */
                                			if (GetField_CString(hTmpP2LastTxnRecGet, "p2_last_txn_seq", &csP2LastTxnId)) {
DEBUGLOG(("ProcessLastTxnRelation:: p2_last_txn_seq = [%s]\n", csP2LastTxnId));
                                			}		

/* relation_type */
                                            		PutField_Char(hLastTxnRec,"relation_type",PD_REL_BAL_TRF);
DEBUGLOG(("ProcessLastTxnRelation:: relation_type = [%c]\n", PD_REL_BAL_TRF));

/* p1_last_txn_seq */	
                                            		PutField_CString(hLastTxnRec,"p1_last_txn_seq",csP1LastTxnId);
DEBUGLOG(("ProcessLastTxnRelation:: p1_last_txn_seq = [%s]\n", csP1LastTxnId));

/* p2_last_txn_seq */
                                            		PutField_CString(hLastTxnRec,"p2_last_txn_seq",csP2LastTxnId);
DEBUGLOG(("ProcessLastTxnRelation:: p2_last_txn_seq = [%s]\n", csP2LastTxnId));

/* update_user */
                                             		if (GetField_CString(hContext, "update_user", &csTmp)) {
                                                      		PutField_CString(hLastTxnRec,"update_user",csTmp);
DEBUGLOG(("ProcessLastTxnRelation:: update_user = [%s]\n", csTmp));
                                             		}

                                            		RecordSet_Add(rLastTxnRecordSet, hLastTxnRec);		
						}	

						hTmpP2LastTxnRecGet = RecordSet_GetNext(rTmpP2LastTxnRecordSet);
					}

				}

				hP1OrgRec = RecordSet_GetNext(rP1OrgRecordSet);
			}
		}

		hTmpP1LastTxnRecGet = RecordSet_GetNext(rTmpP1LastTxnRecordSet);
	}		

	hash_destroy(hTmpP1OrgRec);
        FREE_ME(hTmpP1OrgRec);

        RecordSet_Destroy(rP1OrgRecordSet);
        FREE_ME(rP1OrgRecordSet);

DEBUGLOG(("ProcessLastTxnRelation:: iRet = [%d]\n",iRet));
DEBUGLOG(("===== ProcessLastTxnRelation ===== END !!\n"));

        return iRet;	
}

int     AddNewTxnRelationLinkage(const char* csOrgBatchId, hash_t *hContext, hash_t *hTxnRelation)
{
      	int 	iRet = PD_OK;
        int 	iDtlRet = PD_FOUND;
	int	iTmpRet = PD_FALSE;

	char 	*csTmp = NULL;
	char	csTag[PD_TMP_BUF_LEN+1];

        hash_t  *hRec = NULL;

	hash_t	*hRls = NULL;
        hRls = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRls,0);
        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

DEBUGLOG(("===== AddNewTxnRelationLinkage ===== START!!\n"));

	PutField_CString(hRls,"batch_id",csOrgBatchId);
	if (GetField_CString(hContext,"update_user",&csTmp)) {
		PutField_CString(hRls,"update_user",csTmp);
		PutField_CString(hRls,"add_user",csTmp);
		PutField_CString(hRls,"create_user",csTmp);
	}

DEBUGLOG(("AddNewTxnRelationLinkage orgBatchId = [%s]\n",csOrgBatchId));
        DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","GetTxnRelationByBatchId");
        iDtlRet = (unsigned long)(*DBObjPtr)(hRls,rRecordSet);
	if (iDtlRet == PD_FOUND) {
        	hRec = RecordSet_GetFirst(rRecordSet);
                while ((hRec) && (iRet == PD_OK)) {
                	if (GetField_CString(hRec,"p1_txn_id",&csTmp)) {
				sprintf(csTag,"id_%s",csTmp);
DEBUGLOG(("AddNewTxnRelationLinkage old_p1_txn_id = [%s]\n",csTmp));
				if (GetField_CString(hTxnRelation,csTag,&csTmp)) {
DEBUGLOG(("AddNewTxnRelationLinkage new_p1_txn_id = [%s]\n",csTmp));
					PutField_CString(hRls,"p1_txn_id",csTmp);
					iTmpRet = PD_TRUE;
				} else {
					iTmpRet = PD_FALSE;
				}
                        }

			if (iTmpRet == PD_TRUE) {
                		if (GetField_CString(hRec,"p2_txn_id",&csTmp)) {
					sprintf(csTag,"id_%s",csTmp);
DEBUGLOG(("AddNewTxnRelationLinkage old_p2_txn_id = [%s]\n",csTmp));
					if (GetField_CString(hTxnRelation,csTag,&csTmp)) {
DEBUGLOG(("AddNewTxnRelationLinkage new_p2_txn_id = [%s]\n",csTmp));
						PutField_CString(hRls,"p2_txn_id",csTmp);
						iTmpRet = PD_TRUE;
					} else {
						iTmpRet = PD_FALSE;
					}
                        	}
			}
/*
			if (GetField_CString(hContext,"update_user",&csTmp)) {
                		PutField_CString(hRec,"update_user",csTmp);
                		PutField_CString(hRec,"add_user",csTmp);
                		PutField_CString(hRec,"create_user",csTmp);
        		}
*/
			PutField_Char(hRls, "party", PD_TYPE_PSP);
			PutField_Char(hRls, "txn_level", PD_TXN_LEVEL);
			PutField_Char(hRls, "relation_type", PD_REL_LINKAGE);			

			if (iTmpRet == PD_TRUE) {
DEBUGLOG(("AddNewTxnRelationLinkage AddTxnRelation!\n"));
                		iRet = AddTxnRelation(hRls);
DEBUGLOG(("AddNewTxnRelationLinkage AddTxnRelation Success!\n"));
			} else {
DEBUGLOG(("AddNewTxnRelationLinkage p1txnid/p2txnid void not found\n"));
			}

                        hRec = RecordSet_GetNext(rRecordSet);
                }
        } else {
DEBUGLOG(("AddNewTxnRelationLinkage() Call DBOLTxnRelation::GetTxnRelationByBatchId() No Record Found!!!\n"));
        }

        hash_destroy(hRls);
        FREE_ME(hRls);

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("AddNewTxnRelationLinkage iRet = [%d]\n", iRet));
DEBUGLOG(("===== AddNewTxnRelationLinkage ===== END!!\n"));
        return iRet;
}

int	AddLastTxnRelationLinkage(hash_t *hRec)
{	
        int     iRet = PD_OK;

	char	cTmp;
        char    *csTmp = NULL;
	
	hash_t *hRelation;
        hRelation = (hash_t*) malloc(sizeof(hash_t));
	hash_init(hRelation, 0);
	
DEBUGLOG(("===== AddLastTxnRelationLinkage ===== START!!\n"));

	if (GetField_CString(hRec, "p1_last_txn_seq", &csTmp)) {
DEBUGLOG(("AddLastTxnRelationLinkage p1_last_txn_seq = [%s]\n", csTmp));
		PutField_CString(hRelation, "p1_txn_id", csTmp);
	}

	if (GetField_CString(hRec, "p2_last_txn_seq", &csTmp)) {
DEBUGLOG(("AddLastTxnRelationLinkagseqp2_last_txn_seq = [%s]\n", csTmp));
		PutField_CString(hRelation, "p2_txn_id", csTmp);
        }

	if (GetField_Char(hRec,"relation_type",&cTmp)) {
DEBUGLOG(("AddLastTxnRelationLinkage relation_type = [%c]\n", cTmp));
                PutField_Char(hRelation, "relation_type", cTmp);
        }

	if (GetField_CString(hRec, "update_user", &csTmp)) {
DEBUGLOG(("AddLastTxnRelationLinkage update_user = [%s]\n", csTmp));
		PutField_CString(hRelation, "update_user", csTmp);
                PutField_CString(hRelation, "add_user", csTmp);
               	PutField_CString(hRelation, "create_user", csTmp);
	}

	PutField_Char(hRelation, "party", PD_TYPE_PSP);
	PutField_Char(hRelation, "txn_level", PD_TXN_LEVEL);	

	iRet = AddTxnRelation(hRelation);

       	hash_destroy(hRelation);
	FREE_ME(hRelation);

DEBUGLOG(("AddLastTxnRelationLinkage iRet = [%d]\n", iRet));
DEBUGLOG(("===== AddLastTxnRelationLinkage ===== END!!\n"));

        return iRet;
}

int     IsPutStmtTxnIdToBatch(const char* csStmtTxnId, hash_t* hStmtTxnRec, hash_t* hBaidTxnRec, hash_t* hStmtTxnContext)
{
	int     iRet = PD_TRUE;
	int	iDtlRet = PD_FOUND; 

	int	iStmtTxnAction = PD_STMT_TXN_ACTION_GEN_NEW_ID;

        char    cStatus;
        char    cARInd;
	char    cReconStatus;

	char	*csTxnCode = NULL;
	char	*csBatchId = NULL;
	char	*csTmp = NULL;

	hash_t  *hTxnRec = NULL;
        recordset_t     *rTxnRecordSet;
        rTxnRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

	hash_t  *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet;
        rBatchRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

        cStatus = ' ';
        cARInd = ' ';
	cReconStatus = ' ';

/* stmt_txn_id */
DEBUGLOG(("IsPutStmtTxnIdToBatch:: stmt_txn_id = [%s]\n", csStmtTxnId));

/* txn_type */
DEBUGLOG(("IsPutStmtTxnIdToBatch:: txn_type = [%s]\n", csTxnType));

/* batch_id */
	if (GetField_CString(hStmtTxnContext,"batch_id",&csBatchId)) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: batch_id = [%s]\n", csBatchId));
        }

/* txn_code */
        if (GetField_CString(hBaidTxnRec,"txn_code",&csTxnCode)) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: txn_code = [%s]\n", csTxnCode));
        }

/* status */
        if (GetField_Char(hBaidTxnRec,"status",&cStatus)) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: status = [%c]\n", cStatus));
        }

/* ar_ind */
        if (GetField_Char(hBaidTxnRec, "ar_ind", &cARInd)) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: ar_ind = [%c]\n", cARInd));
        }

/* recon_status */
        if (GetField_Char(hBaidTxnRec, "recon_status", &cReconStatus)) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: recon_status = [%c]\n", cReconStatus));
        }

	// Check stmt_txn_relation and batch_txn_relation
	if (iRet == PD_TRUE) {
		iRet = PD_FALSE;	
		
		// Check Status+ARInd
		if (cStatus == PD_COMPLETE && cARInd == PD_ACCEPT) {

        		recordset_init(rTxnRecordSet,0);

DEBUGLOG(("IsPutStmtTxnIdToBatch:: Call DBOLStmtTxnRelation:GetMultiTxnIdByStmtTxnId\n"));
                        DBObjPtr = CreateObj(DBPtr, "DBOLStmtTxnRelation","GetMultiTxnIdByStmtTxnId");
                        iDtlRet = (unsigned long)(*DBObjPtr)(csStmtTxnId,rTxnRecordSet);
                        if (iDtlRet == PD_FOUND) {
				hTxnRec = RecordSet_GetFirst(rTxnRecordSet);	
				while (hTxnRec) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: Call DBOLStmtTxnRelation::GetMultiTxnIdByStmtTxnId() Txn Id Found!!!\n"));
					
					if (GetField_CString(hTxnRec,"txn_id",&csTmp)) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: Call DBOLStmtTxnRelation::GetMultiTxnIdByStmtTxnId txn_id=[%s]\n",csTmp));
			
						iDtlRet = PD_OK;
	
        					recordset_init(rBatchRecordSet,0);

						PutField_Char(hStmtTxnContext,"txn_level",PD_TXN_LEVEL);
						PutField_CString(hStmtTxnContext,"txn_id",csTmp);

DEBUGLOG(("IsPutStmtTxnIdToBatch:: Call DBOLBatchTxnRelation:GetBatchId\n"));	
						DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetBatchId");
                      				iDtlRet = (unsigned long)(*DBObjPtr)(hStmtTxnContext,rBatchRecordSet);
                        			if (iDtlRet == PD_OK) {
                                			hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                                			while (hBatchRec) {
								if (GetField_CString(hBatchRec,"batch_id",&csTmp)) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: Call DBOLBatchTxnRelation::GetBatchId batch_id=[%s]\n",csTmp));
	
									if (!strcmp(csBatchId, csTmp)) {		
DEBUGLOG(("IsPutStmtTxnIdToBatch:: Call DBOLBatchTxnRelation::GetBatchId Success!!!\n"));
										iRet= PD_TRUE;
										break;
									}						
                                                		}
                                        			hBatchRec = RecordSet_GetNext(rBatchRecordSet);
							}
						}
						RecordSet_Destroy(rBatchRecordSet);
					}
					hTxnRec = RecordSet_GetNext(rTxnRecordSet);
				}
                        } else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: Call DBOLStmtTxnRelation::GetMultiTxnIdByStmtTxnId() Txn Id Not Found!!!\n"));
                        } else {
                                iRet = INT_ERR;
DEBUGLOG(("IsPutStmtTxnIdToBatch:: Call DBOLStmtTxnRelation::GetMultiTxnIdByStmtTxnId() Invalid Stmt Txn Id!!!\n"));
ERRLOG("TxnOmtByUsRBT::IsPutStmtTxnIdToBatch::Call DBOLStmtTxnRelation::GetMultiTxnIdByStmtTxnId() Invalid Stmt Txn Id!!!\n");
                        }
			RecordSet_Destroy(rTxnRecordSet);
		}
	}

	// Check Txn Type -> Status and ArInd -> Txn Code -> Recon Status
	if (iRet == PD_TRUE) {
                if (!strcmp(csTxnType, PD_TXN_TYPE_HOLD_DEPOSIT)) {
			if ((cStatus == PD_COMPLETE) && (cARInd == PD_ACCEPT)) {
				if (!strcmp(csTxnCode, PD_BANK_DEPOSIT_TXN_CODE)) {
					iStmtTxnAction = PD_STMT_TXN_ACTION_KEEP_ORG_ID;	
DEBUGLOG(("IsPutStmtTxnIdToBatch:: stmt_txn_action = [Keep Org Stmt Txn Id]\n"));
				} else if (!strcmp(csTxnCode, PD_TXN_CODE_UNKNOWN_DEBIT)) {
                        	        iRet = PD_FALSE;
                        	}
			} else {
				iRet = PD_FALSE;
			}
		} else if (!strcmp(csTxnType, PD_TXN_TYPE_SMS_BANK_DEPOSIT)) {
			if ((cStatus == PD_COMPLETE) && (cARInd == PD_ACCEPT)) {
                              	if (cReconStatus == PD_UNRECONCILED) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: stmt_txn_action = [Change Org Stmt Txn Status]\n"));
					iStmtTxnAction = PD_STMT_TXN_ACTION_CHANGE_ORG_STATUS;	
				}
			} else {
				iRet = PD_FALSE;
			}
                } else {
			if ((cStatus == PD_COMPLETE) && (cARInd == PD_ACCEPT)) {
                		// Do Nothing...
			} else {
                        	iRet = PD_FALSE;
                	}
		}
        }

	// Set keep org stmt txn flag
	PutField_Int(hStmtTxnRec, "stmt_txn_action", iStmtTxnAction);

        FREE_ME(rTxnRecordSet);
        FREE_ME(rBatchRecordSet);

DEBUGLOG(("IsPutStmtTxnIdToBatch:: iRet = [%d]\n",iRet));
        return iRet;		
}

int     ProcessStmtOffset(const char* csOrgStmtTxnSeq, const hash_t* hStmtTxnRec, hash_t* hContext)
{
        int     iRet = PD_OK;

	int	iStmtTxnAction = PD_STMT_TXN_ACTION_GEN_NEW_ID;

	hash_t  *hOrgStmtTxn;
        hOrgStmtTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hOrgStmtTxn, 0);

        hash_t  *hNewStmtTxn;
        hNewStmtTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hNewStmtTxn, 0);

DEBUGLOG(("===== ProcessStmtOffset ===== START!!\n"));

DEBUGLOG(("ProcessStmtOffset:: stmt_txn_id [%s]\n", csOrgStmtTxnSeq));

	if (GetField_Int(hStmtTxnRec,"stmt_txn_action",&iStmtTxnAction)) {
DEBUGLOG(("ProcessStmtOffset:: stmt_txn_action = [%d]\n",iStmtTxnAction));
	}

	// Lock Org Stmt Txn + Get Org Stmt Txn
	iRet = GetStmtTxnInfo(csOrgStmtTxnSeq, hContext, hOrgStmtTxn);

	// Check stmt txn action
	if (iStmtTxnAction == PD_STMT_TXN_ACTION_KEEP_ORG_ID) {

DEBUGLOG(("ProcessStmtOffset:: update org stmt txn and add to batch txn relation\n"));		
		// Update Org Stmt to (void)
		if (iRet == PD_OK) {
                        iRet = ProcessOrgStmtTxnToBatchTxnRelation(hOrgStmtTxn, hContext);
                }
	} else if (iStmtTxnAction == PD_STMT_TXN_ACTION_CHANGE_ORG_STATUS) {

DEBUGLOG(("ProcessStmtOffset:: update org stmt txn status only\n"));		
		// Update Org Stmt Status
		if (iRet == PD_OK) {
			iRet = ProcessOrgStmtTxn(hOrgStmtTxn, hContext);
                }
	} else {

		// Form Offset Stmt Txn
		if (iRet == PD_OK) {
        		iRet = FormNewStmtTxn(hOrgStmtTxn, hNewStmtTxn, hContext);
		}

        	// Create Stmt Txn (with add approval_date, approval_timestamp)
        	if (iRet == PD_OK) {
        		iRet = ProcessNewStmtTxn(hNewStmtTxn, hContext);
		}

DEBUGLOG(("ProcessStmtOffset:: update org stmt txn\n"));
		// Update Org Stmt to (void)
		if (iRet == PD_OK) {
			iRet = ProcessOrgStmtTxn(hOrgStmtTxn, hContext);
		}
	}

	hash_destroy(hOrgStmtTxn);
        hash_destroy(hNewStmtTxn);

        FREE_ME(hOrgStmtTxn);
        FREE_ME(hNewStmtTxn);

DEBUGLOG(("ProcessStmtOffset:: iRet = [%d]\n", iRet));
DEBUGLOG(("===== ProcessStmtOffset ===== END !!\n"));

        return iRet;
}

int     GetStmtTxnInfo(const char *csOrgStmtTxnSeq, hash_t *hContext, hash_t *hStmtTxn)
{
        int     iRet = PD_OK;

        char    *csTmp = NULL;
        char    cTmp;
        double  dTmp = 0.0;
        int     iTmp = 0;

	// Get BAID Txn
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: GetBaidTxn()\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "GetBaidTxn");
        iRet = (unsigned long)(*DBObjPtr)(csOrgStmtTxnSeq, hStmtTxn);
        if (iRet == PD_OK) {

/* txn_id */
		PutField_CString(hStmtTxn, "txn_seq", csOrgStmtTxnSeq);

/* org_txn_id */
                if (GetField_CString(hStmtTxn, "org_txn_seq", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: org_txn_seq [%s]\n", csTmp));
                }

/* input_channel */
                if (GetField_CString(hStmtTxn, "input_channel", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: input_channel [%s]\n", csTmp));
                }

/* status */
                if (GetField_Char(hStmtTxn, "status", &cTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: status [%c]\n", cTmp));
                }

/* ar_ind */
                if (GetField_Char(hStmtTxn, "ar_ind", &cTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: ar_ind [%c]\n", cTmp));
                }

/* sub_status */
                if (GetField_CString(hStmtTxn, "sub_status", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: sub_status [%s]\n", csTmp));
                }

/* stat_txn_id */
                if (GetField_CString(hStmtTxn, "stat_txn_id", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: stat_txn_id [%s]\n", csTmp));
                }

/* txn_code */
                if (GetField_CString(hStmtTxn, "txn_code", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: txn_code [%s]\n", csTmp));
                }

/* pid */
                if (GetField_CString(hStmtTxn, "pid", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: pid [%s]\n", csTmp));
                }

/* baid */
                if (GetField_CString(hStmtTxn, "baid", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: baid [%s]\n", csTmp));
                }

/* posting_date */
                if (GetField_CString(hStmtTxn, "posting_date", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: posting_date [%s]\n", csTmp));
                }

/* transmission_datetime */
                if (GetField_CString(hStmtTxn, "transmission_datetime", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: transmission_datetime [%s]\n", csTmp));
                }

/* txn_ccy */
                if (GetField_CString(hStmtTxn, "txn_ccy", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: txn_ccy [%s]\n", csTmp));
                }

/* txn_amt */
                if (GetField_Double(hStmtTxn, "txn_amt", &dTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: txn_amt [%f]\n", dTmp));
                }

/* open_bal */
                if (GetField_Double(hStmtTxn, "open_bal", &dTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: open_bal [%f]\n", dTmp));
                }

/* curr_bal */
                if (GetField_Double(hStmtTxn, "curr_bal", &dTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: curr_bal [%f]\n", dTmp));
                }

/* dst_txn_id */
                if (GetField_CString(hStmtTxn, "dst_txn_id", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: dst_txn_id [%s]\n", csTmp));
                }

/* bank_code */
                if (GetField_CString(hStmtTxn, "bank_code", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: bank_code [%s]\n", csTmp));
                }

/* bank_acct_num */
                if (GetField_CString(hStmtTxn, "bank_acct_num", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: bank_acct_num [%s]\n", csTmp));
                }

/* pid_txn_hold_ind */
                if (GetField_Int(hStmtTxn, "pid_txn_hold_ind", &iTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: pid_txn_hold_ind [%d]\n", iTmp));
                }

/* pid_sys_match_ind */
                if (GetField_Int(hStmtTxn, "pid_sys_match_ind", &iTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: pid_sys_match_ind [%d]\n", iTmp));
                }

/* posted_ind */
                if (GetField_Int(hStmtTxn, "posted_ind", &iTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: posted_ind [%d]\n", iTmp));
                }

/* recon_status */
                if (GetField_Char(hStmtTxn, "recon_status", &cTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: recon_status [%c]\n", cTmp));
                }

/* classified_status */
                if (GetField_Char(hStmtTxn, "classified_status", &cTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: classified_status [%c]\n", cTmp));
                }

/* hold_recon */
                if (GetField_Int(hStmtTxn, "hold_recon", &iTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: hold_recon [%d]\n", iTmp));
                }

/* manual_hold_recon */
                if (GetField_Int(hStmtTxn, "manual_hold_recon", &iTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: manual_hold_recon [%d]\n", iTmp));
                }

/* est_net_amount */
                if (GetField_Double(hStmtTxn, "est_net_amount", &dTmp)) {
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn:: est_net_amount [%f]\n", dTmp));
                }

	} else {
                iRet = INT_INVALID_TXN;
DEBUGLOG(("GetStmtTxnInfo::call DBOLBAIDTxn GetBaidTxn [%s] FAILURE!!!\n", csOrgStmtTxnSeq));
ERRLOG("TxnOmtByUsRBT::GetStmtTxnInfo::call DBOLBAIDTxn GetBaidTxn[%s] FAILURE!!!\n", csOrgStmtTxnSeq);
        }

DEBUGLOG(("GetStmtTxnInfo:: iRet = [%d]\n", iRet));
        return iRet;
}

int     FormNewStmtTxn(hash_t *hOrgStmtTxn, hash_t *hOfstStmtTxn, hash_t *hContext)
{
        int     iRet = PD_OK;

	char    csOfstStmtTxnSeq[PD_TXN_SEQ_LEN + 1];

	char	*csAmtType = NULL;
	char	*csDefaultBaidTxnCode = NULL;

        char    *csTmp = NULL;
        double  dTmp = 0.0;
        int     iTmp = 0;

/* db_commit */
        PutField_Int(hOfstStmtTxn, "db_commit", PD_FALSE);

/* txn_seq */
DEBUGLOG(("FormNewStmtTxn:: Call DBOLTxnSeq: GetNextBaidTxnSeq\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextBaidTxnSeq");
        strcpy(csOfstStmtTxnSeq, (*DBObjPtr)());

        PutField_CString(hOfstStmtTxn, "txn_seq", csOfstStmtTxnSeq);
DEBUGLOG(("FormNewStmtTxn::Offset StmtTxnSeq (Generated!!) [%s]\n", csOfstStmtTxnSeq));

/* org_txn_id */
        if (GetField_CString(hOrgStmtTxn, "txn_seq", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn::org_txn_seq [%s]\n", csTmp));
                PutField_CString(hOrgStmtTxn, "txn_id", csTmp);
                PutField_CString(hOfstStmtTxn, "org_txn_seq", csTmp);
        }

/* input_channel */
        if (GetField_CString(hOrgStmtTxn, "input_channel", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn::input_channel [%s]\n", csTmp));
                PutField_CString(hOfstStmtTxn, "channel_code", csTmp);
        }

/* stat_txn_id */
        if (GetField_CString(hOrgStmtTxn, "stat_txn_id", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: stat_txn_id [%s]\n", csTmp));
                PutField_CString(hOfstStmtTxn, "stat_txn_id", csTmp);
        }

/* txn_code */
        if (GetField_CString(hOrgStmtTxn, "txn_code", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: txn_code [%s]\n", csTmp));
                PutField_CString(hOfstStmtTxn, "txn_code", csTmp);
        }

/* pid */
        if (GetField_CString(hOrgStmtTxn, "pid", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: pid [%s]\n", csTmp));
                PutField_CString(hOfstStmtTxn, "pid", csTmp);
        }

/* baid */
        if (GetField_CString(hOrgStmtTxn, "baid", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: baid [%s]\n", csTmp));
                PutField_CString(hOfstStmtTxn, "baid", csTmp);
        }

/* posting_date */
        if (GetField_CString(hOrgStmtTxn, "posting_date", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: posting_date [%s]\n", csTmp));
                PutField_CString(hOfstStmtTxn, "posting_date", csTmp);
        }

/* transmission_datetime */
        if (GetField_CString(hOrgStmtTxn, "transmission_datetime", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: transmission_datetime [%s]\n", csTmp));
                PutField_CString(hOfstStmtTxn, "transmission_datetime", csTmp);
        }

/* txn_ccy */
        if (GetField_CString(hOrgStmtTxn, "txn_ccy", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: txn_ccy [%s]\n", csTmp));
                PutField_CString(hOfstStmtTxn, "txn_ccy", csTmp);
        }

/* txn_amt */
        if (GetField_Double(hOrgStmtTxn, "txn_amt", &dTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: txn_amt [%f]\n", dTmp));
                PutField_Double(hOfstStmtTxn, "txn_amt", dTmp);
        }

/* open_bal */
        if (GetField_Double(hOrgStmtTxn, "open_bal", &dTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: open_bal [%f]\n", dTmp));
                PutField_Double(hOfstStmtTxn, "open_bal", dTmp);
        }

/* curr_bal */
        if (GetField_Double(hOrgStmtTxn, "curr_bal", &dTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: curr_bal [%f]\n", dTmp));
                PutField_Double(hOfstStmtTxn, "curr_bal", dTmp);
        }

/* dst_txn_id */
        if (GetField_CString(hOrgStmtTxn, "dst_txn_id", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: dst_txn_id [%s]\n", csTmp));
                PutField_CString(hOfstStmtTxn, "dst_txn_id", csTmp);
        }

/* bank_code */
        if (GetField_CString(hOrgStmtTxn, "bank_code", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: bank_code [%s]\n", csTmp));
                PutField_CString(hOfstStmtTxn, "bank_code", csTmp);
        }

/* bank_acct_num */
        if (GetField_CString(hOrgStmtTxn, "bank_acct_num", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: bank_acct_num [%s]\n", csTmp));
                PutField_CString(hOfstStmtTxn, "bank_acct_num", csTmp);
        }

/* pid_txn_hold_ind */
        if (GetField_Int(hOrgStmtTxn, "pid_txn_hold_ind", &iTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: pid_txn_hold_ind [%d]\n", iTmp));
                PutField_Int(hOfstStmtTxn, "pid_txn_hold_ind", iTmp);
        }

/* pid_sys_match_ind */
        if (GetField_Int(hOrgStmtTxn, "pid_sys_match_ind", &iTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: pid_sys_match_ind [%d]\n", iTmp));
                PutField_Int(hOfstStmtTxn, "pid_sys_match_ind", iTmp);
        }

/* posted_ind */
        if (GetField_Int(hOrgStmtTxn, "posted_ind", &iTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: posted_ind [%d]\n", iTmp));
                PutField_Int(hOfstStmtTxn, "posted_ind", iTmp);
        }

/* hold_recon */
        PutField_Int(hOfstStmtTxn, "hold_recon", PD_TRUE);
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: hold_recon [%d]\n", PD_TRUE));

/* manual_hold_recon */
	if (GetField_Int(hOrgStmtTxn, "manual_hold_recon", &iTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: manual_hold_recon [%d]\n", iTmp));
        	PutField_Int(hOfstStmtTxn, "manual_hold_recon", iTmp);
	}

/* est_net_amount */
        if (GetField_Double(hOrgStmtTxn, "est_net_amount", &dTmp)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxn:: est_net_amount [%f]\n", dTmp));
                PutField_Double(hOfstStmtTxn, "est_net_amount", dTmp);
        }

/* txn_code */
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxnCode CheckDefaultBaidTxnCode\n"));
        DBObjPtr = CreateObj(DBPtr,"DBOLBAIDTxnCode","CheckDefaultBaidTxnCode");
        iRet = (unsigned long)(*DBObjPtr)(hOrgStmtTxn);
        if (iRet == PD_OK) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxnCode CheckDefaultBaidTxnCode Found\n"));

/* amt_type */	
		if (GetField_CString(hOrgStmtTxn, "amt_type", &csAmtType)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxnCode:: amt_type [%s]\n", csAmtType));
		} else {
			iRet = INT_ERR;
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxnCode amt_type Not Found\n"));
ERRLOG("TxnOmtByUsRBT::FormNewStmtTxn() Call DBOLBAIDTxnCode amt_type Not Found!!!\n");
		}

/* default_code */
                if (GetField_CString(hOrgStmtTxn, "default_code", &csDefaultBaidTxnCode)) {
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxnCode:: default_code [%s]\n", csDefaultBaidTxnCode));

                        if ((!strcmp(csDefaultBaidTxnCode, PD_TXN_CODE_UNKNOWN_SWEEP_IN)) ||
                            (!strcmp(csDefaultBaidTxnCode, PD_TXN_CODE_UNKNOWN_SWEEP_OUT))
                        )
                        {
                                PutField_CString(hOfstStmtTxn, "txn_code", csDefaultBaidTxnCode);
                        }
                        else
                        {
                           	if (!strcmp(csAmtType, PD_CR)) {
                           		PutField_CString(hOfstStmtTxn, "txn_code", PD_TXN_CODE_UNKNOWN_CREDIT);
                            	} else if (!strcmp(csAmtType, PD_DR)) {
                                    	PutField_CString(hOfstStmtTxn, "txn_code", PD_TXN_CODE_UNKNOWN_DEBIT);
                             	}
                        }
                } else {
                        if (!strcmp(csAmtType, PD_CR)) {
                                PutField_CString(hOfstStmtTxn, "txn_code", PD_TXN_CODE_UNKNOWN_CREDIT);
                        } else if (!strcmp(csAmtType, PD_DR)) {
                                PutField_CString(hOfstStmtTxn, "txn_code", PD_TXN_CODE_UNKNOWN_DEBIT);
                        }
                }

        } else {
		iRet = INT_ERR;
DEBUGLOG(("FormNewStmtTxn::call DBOLBAIDTxnCode CheckDefaultBaidTxnCode Not Found\n"));
ERRLOG("TxnOmtByUsRBT::FormNewStmtTxn() Call DBOLBAIDTxnCode CheckDefaultBaidTxnCode Not Found!!!\n");
	}

DEBUGLOG(("FormNewStmtTxn:: iRet = [%d]\n", iRet));
        return iRet;
}
	
int     ProcessNewStmtTxn(hash_t *hOfstStmtTxn, hash_t *hContext)
{
	int     iRet = PD_OK;

        char    *csOrgStmtTxnSeq = NULL;
        char    *csStmtTxnSeq = NULL;
        char    *csBatchSeq = NULL;

	char	cBatchType;
	char	cBatchSubType;

        char    *csTmp = NULL;

        char    csDate[PD_DATE_LEN + 1] = "";
        char    csDateTime[PD_DATETIME_LEN + 1] = "";

        time_t  tNow = time(NULL);
        struct  tm tStruct = *localtime(&tNow);

        hash_t *hRelation;
        hRelation = (hash_t*) malloc(sizeof(hash_t));

	cBatchType = ' ';
	cBatchSubType = ' ';

/* org_txn_seq */
        if (GetField_CString(hOfstStmtTxn, "org_txn_seq", &csOrgStmtTxnSeq)) {
DEBUGLOG(("ProcessNewStmtTxn:: OrgStmtTxnSeq [%s]\n", csOrgStmtTxnSeq));
        }

/* txn_seq */
        if (GetField_CString(hOfstStmtTxn, "txn_seq", &csStmtTxnSeq)) {
DEBUGLOG(("ProcessNewStmtTxn::StmtTxnSeq [%s]\n", csStmtTxnSeq));
        }

/* batch_txn_seq */
        if (GetField_CString(hContext, "batch_txn_seq", &csBatchSeq)) {
DEBUGLOG(("ProcessNewStmtTxn:: BatchTxnSeq[%s]\n", csBatchSeq));
        }

/* batch_type */
        if (GetField_Char(hContext, "batch_type", &cBatchType)) {
DEBUGLOG(("ProcessNewStmtTxn:: BatchType[%c]\n", cBatchType));
        }

/* batch_sub_type */
        if (GetField_Char(hContext, "batch_sub_type", &cBatchSubType)) {
DEBUGLOG(("ProcessNewStmtTxn:: BatchSubType[%c]\n", cBatchSubType));
        }

/* approval_date */
        strftime(csDate, sizeof(csDate), PD_DEFAULT_DATE_FORMAT, &tStruct);
        PutField_CString(hContext, "approval_date", csDate);
        PutField_CString(hOfstStmtTxn, "approval_date", csDate);
DEBUGLOG(("ProcessNewStmtTxn:: approval_date [%s]\n", csDate));

/* approval_timestamp */
        strftime(csDateTime, sizeof(csDateTime), PD_DEFAULT_DATETIME_FORMAT, &tStruct);
        PutField_CString(hContext, "approval_timestamp", csDateTime);
        PutField_CString(hOfstStmtTxn, "approval_timestamp", csDateTime);
DEBUGLOG(("ProcessNewStmtTxn:: approval_timestamp [%s]\n", csDateTime));

/* add user */
        if (GetField_CString(hContext, "update_user", &csTmp)) {
DEBUGLOG(("ProcessNewStmtTxn: update_user [%s]\n", csTmp));
                PutField_CString(hOfstStmtTxn, "update_user", csTmp);
                PutField_CString(hOfstStmtTxn, "add_user", csTmp);
                PutField_CString(hOfstStmtTxn, "create_user", csTmp);
        }

/* db_commit */
        PutField_Int(hOfstStmtTxn, "db_commit", PD_FALSE);
DEBUGLOG(("ProcessNewStmtTxn:: db_commit [%d]\n", PD_FALSE));

/* status, ar_ind, sub_status, recon_status, classified_status */
       	PutField_Char(hOfstStmtTxn, "status", PD_COMPLETE);
DEBUGLOG(("ProcessNewStmtTxn:: status [%c]\n", PD_COMPLETE));

	PutField_Char(hOfstStmtTxn, "ar_ind", PD_ACCEPT);
DEBUGLOG(("ProcessNewStmtTxn:: ar_ind [%c]\n", PD_ACCEPT));

        PutField_CString(hOfstStmtTxn, "sub_status", PD_APPROVED);
DEBUGLOG(("ProcessNewStmtTxn:: sub_status [%s]\n", PD_APPROVED));

        PutField_Char(hOfstStmtTxn, "recon_status", PD_UNRECONCILED);
DEBUGLOG(("ProcessNewStmtTxn:: recon_status [%c]\n", PD_UNRECONCILED));

        PutField_Char(hOfstStmtTxn, "classified_status", PD_UNCLASSIFIED);
DEBUGLOG(("ProcessNewStmtTxn:: classified_status [%c]\n", PD_UNCLASSIFIED));

DEBUGLOG(("ProcessNewStmtTxn() call DBOLBAIDTxn::Add()\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Add");
        iRet = (unsigned long)(*DBObjPtr)(hOfstStmtTxn);
        if (iRet != PD_OK) {
                iRet = INT_ERR;
DEBUGLOG(("ProcessNewStmtTxn() call DBOLBAIDTxn::Add() failed\n"));
ERRLOG("TxnOmtByUsRBT::ProcessNewStmtTxn() call DBOLBAIDTxn::Add() failed\n");
        }

	// Add Txn Relation (Linkage)
	if (iRet == PD_OK) {
DEBUGLOG(("ProcessNewStmtTxn TxnRelation!\n"));
	
		hash_init(hRelation, 0);

		// Org Txn Seq
		PutField_Char(hRelation, "party", PD_TYPE_PSP);
                PutField_CString(hRelation, "p1_txn_id", csOrgStmtTxnSeq);
                PutField_CString(hRelation, "p2_txn_id", csStmtTxnSeq);
                PutField_Char(hRelation, "txn_level", PD_STMT_LEVEL);
                PutField_Char(hRelation, "relation_type", PD_REL_LINKAGE);
                if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hRelation, "update_user", csTmp);
                        PutField_CString(hRelation, "add_user", csTmp);
                        PutField_CString(hRelation, "create_user", csTmp);
                }

                iRet = AddTxnRelation(hRelation);

                hash_destroy(hRelation);
        }

	// Add Batch Txn Relation (Stmt Txn Id)
	if ((iNumOfBatchId > 0) && (iRet == PD_OK)) {
DEBUGLOG(("ProcessNewStmtTxn BatchTxnRelation!\n"));

                hash_init(hRelation, 0);

                PutField_Char(hRelation, "batch_type", cBatchType);
		if (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) {
                        PutField_Char(hRelation, "batch_sub_type", PD_GENERAL_UNDO_BAL_TRF);
                } else {
                	PutField_Char(hRelation, "batch_sub_type", cBatchSubType);
		}
             	PutField_CString(hRelation, "batch_txn_seq", csBatchSeq);
                PutField_Char(hRelation, "txn_level", PD_STMT_LEVEL);
                PutField_CString(hRelation, "txn_seq", csStmtTxnSeq);
             	PutField_Int(hRelation, "is_input_txn", 0);
             	PutField_Int(hRelation, "is_regen_txn", 0);
		if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hRelation, "update_user", csTmp);
                        PutField_CString(hRelation, "add_user", csTmp);
                        PutField_CString(hRelation, "create_user", csTmp);
                }

                iRet = AddBatchTxnRelation(hRelation);

                hash_destroy(hRelation);
        }

	FREE_ME(hRelation);

DEBUGLOG(("ProcessNewStmtTxn:: iRet = [%d]\n", iRet));
        return iRet;
}

int     ProcessOrgStmtTxn(hash_t *hOrgStmtTxn, hash_t *hContext)
{
        int     iRet = PD_OK;

        char    *csTmp = NULL;
        char    *csStmtTxnSeq = NULL;
	
        hash_t  *hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec, 0);

/* txn_seq */
        if (GetField_CString(hOrgStmtTxn, "txn_seq", &csStmtTxnSeq)) {
DEBUGLOG(("ProcessOrgStmtTxn txn_seq [%s]\n", csStmtTxnSeq));
                PutField_CString(hRec, "txn_seq", csStmtTxnSeq);
        }

/* remark */
	if (GetField_CString(hContext, "remark", &csTmp)) {
DEBUGLOG(("ProcessOrgStmtTxn remark [%s]\n", csTmp));
                PutField_CString(hRec, "remark", csTmp);
        }

/* update_user */
        if (GetField_CString(hContext, "update_user", &csTmp)) {
DEBUGLOG(("ProcessOrgStmtTxn upate_user [%s]\n", csTmp));
                PutField_CString(hRec, "update_user", csTmp);
        }

/* status, sub_status */
        PutField_Char(hRec, "status", PD_REVERSED);
DEBUGLOG(("ProcessOrgStmtTxn status [%c]\n", PD_REVERSED));

	if (!strcmp(csTxnType, PD_TXN_TYPE_SMS_BANK_DEPOSIT)) {
		PutField_CString(hRec, "sub_status", PD_UNDO);
DEBUGLOG(("ProcessOrgStmtTxn sub_status [%s]\n", PD_UNDO));
	} else {
		if (iAction == PD_BATCH_ACTION_CANCEL) {
        		PutField_CString(hRec, "sub_status", PD_CANCELLED);
DEBUGLOG(("ProcessOrgStmtTxn sub_status [%s]\n", PD_CANCELLED));
		} else if (iAction == PD_BATCH_ACTION_VOID) {
			PutField_CString(hRec, "sub_status", PD_UNDO);
DEBUGLOG(("ProcessOrgStmtTxn sub_status [%s]\n", PD_UNDO));
		}
	}

DEBUGLOG(("ProcessOrgStmtTxn() call DBOLBAIDTxn::Update()\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Update");
        iRet = (unsigned long)(*DBObjPtr)(hRec);
        if (iRet != PD_OK) {
        	iRet = INT_ERR;
DEBUGLOG(("ProcessOrgStmtTxn() call DBOLBAIDTxn::Update() failed\n"));
ERRLOG("TxnOmtByUsRBT::ProcessOrgStmtTxn() call DBOLBAIDTxn::Update() failed\n");
        }

        hash_destroy(hRec);
        FREE_ME(hRec);

DEBUGLOG(("ProcessOrgStmtTxn:: iRet = [%d]\n", iRet));
        return iRet;
}

int     ProcessOrgStmtTxnToBatchTxnRelation(hash_t *hOrgStmtTxn, hash_t *hContext)
{
        int     iRet = PD_OK;

        char    *csTmp = NULL;
        char    *csStmtTxnSeq = NULL;
	char    *csBatchSeq = NULL;

        char    cBatchType;
        char    cBatchSubType;
	
        hash_t  *hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec, 0);

	hash_t *hRelation;
        hRelation = (hash_t*) malloc(sizeof(hash_t));

	cBatchType = ' ';
	cBatchSubType = ' ';

/* txn_seq */
        if (GetField_CString(hOrgStmtTxn, "txn_seq", &csStmtTxnSeq)) {
DEBUGLOG(("ProcessOrgStmtTxnToBatchTxnRelation txn_seq [%s]\n", csStmtTxnSeq));
                PutField_CString(hRec, "txn_seq", csStmtTxnSeq);
        }

/* batch_txn_seq */
        if (GetField_CString(hContext, "batch_txn_seq", &csBatchSeq)) {
DEBUGLOG(("ProcessOrgStmtTxnToBatchTxnRelation BatchTxnSeq[%s]\n", csBatchSeq));
        }

/* batch_type */
        if (GetField_Char(hContext, "batch_type", &cBatchType)) {
DEBUGLOG(("ProcessOrgStmtTxnToBatchTxnRelation BatchType[%c]\n", cBatchType));
        }

/* batch_sub_type */
        if (GetField_Char(hContext, "batch_sub_type", &cBatchSubType)) {
DEBUGLOG(("ProcessOrgStmtTxnToBatchTxnRelation BatchSubType[%c]\n", cBatchSubType));
        }

/* update_user */
        if (GetField_CString(hContext, "update_user", &csTmp)) {
DEBUGLOG(("ProcessOrgStmtTxnToBatchTxnRelation upate_user [%s]\n", csTmp));
                PutField_CString(hRec, "update_user", csTmp);
        }

/* status, ar_ind, sub_status, recon_status, classified_status */
        PutField_Char(hRec, "status", PD_COMPLETE);
DEBUGLOG(("ProcessOrgStmtTxnToBatchTxnRelation status [%c]\n", PD_COMPLETE));

        PutField_Char(hRec, "ar_ind", PD_ACCEPT);
DEBUGLOG(("ProcessOrgStmtTxnToBatchTxnRelation ar_ind [%c]\n", PD_ACCEPT));

        PutField_CString(hRec, "sub_status", PD_APPROVED);
DEBUGLOG(("ProcessOrgStmtTxnToBatchTxnRelation sub_status [%s]\n", PD_APPROVED));

        PutField_Char(hRec, "recon_status", PD_UNRECONCILED);
DEBUGLOG(("ProcessOrgStmtTxnToBatchTxnRelation recon_status [%c]\n", PD_UNRECONCILED));

        PutField_Char(hRec, "classified_status", PD_UNCLASSIFIED);
DEBUGLOG(("ProcessOrgStmtTxnToBatchTxnRelation classified_status [%c]\n", PD_UNCLASSIFIED));

        DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Update");
        iRet = (unsigned long)(*DBObjPtr)(hRec);
        if (iRet != PD_OK) {
      		iRet = INT_ERR;
DEBUGLOG(("ProcessOrgStmtTxnToBatchTxnRelation() call DBOLBAIDTxn::Update() failed\n"));
ERRLOG("TxnOmtByUsRBT::ProcessOrgStmtTxnToBatchTxnRelation() call DBOLBAIDTxn::Update() failed\n");
        }

	// Add Batch Txn Relation (Stmt Txn Id)	
	if ((iNumOfBatchId > 0) && (iRet == PD_OK)) {
DEBUGLOG(("ProcessOrgStmtTxnToBatchTxnRelation BatchTxnRelation!\n"));

                hash_init(hRelation, 0);

                PutField_Char(hRelation, "batch_type", cBatchType);
		if (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) {
                        PutField_Char(hRelation, "batch_sub_type", PD_GENERAL_UNDO_BAL_TRF);
                } else {
                	PutField_Char(hRelation, "batch_sub_type", cBatchSubType);
                }
		PutField_CString(hRelation, "batch_txn_seq", csBatchSeq);
                PutField_Char(hRelation, "txn_level", PD_STMT_LEVEL);
                PutField_CString(hRelation, "txn_seq", csStmtTxnSeq);
                PutField_Int(hRelation, "is_input_txn", 0);
                PutField_Int(hRelation, "is_regen_txn", 0);
                if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hRelation, "update_user", csTmp);
                        PutField_CString(hRelation, "add_user", csTmp);
                        PutField_CString(hRelation, "create_user", csTmp);
                }

                iRet = AddBatchTxnRelation(hRelation);

                hash_destroy(hRelation);
        }
        
	hash_destroy(hRec);
        FREE_ME(hRec);

	FREE_ME(hRelation);

DEBUGLOG(("ProcessOrgStmtTxnToBatchTxnRelation:: iRet = [%d]\n", iRet));
        return iRet;
}
