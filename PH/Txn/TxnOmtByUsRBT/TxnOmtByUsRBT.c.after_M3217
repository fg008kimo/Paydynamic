/*
PDProTech (c)2014. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/01/14              [WMC]
Update						   2015/05/04		   [WMC] 
Add manual_hold_recon to NewStmtTxn	   	   2015/09/09		   [WMC]
Add CheckIsBalTransInterBatch			   2015/12/30		   [WMC]	
Update HOLD_DEPOSIT transaction flow		   2017/05/22		   [WMC]			  
Update UpdateOrgTxn				   2020/08/10		   [WMC]
Add DBOLBaidIntraLogGen Functions
	- GetDetailByTxnId()
	- UpdateByTxnId()		   	   2020/08/24		   [WMC]
Update						   2021/05/06		   [WMC]
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsRBT.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"
#include "dbutility.h"

#define PD_DEFAULT_DATE_FORMAT          "%Y%m%d"
#define PD_DEFAULT_DATETIME_FORMAT      "%Y%m%d%H%M%S"

#define PD_TXN_TYPE_LENGTH		50
#define PD_TXN_TYPE_GENERAL		"GENERAL"
#define PD_TXN_TYPE_BAL_TRF_INTRA	"BAL_TRF_INTRA"
#define PD_TXN_TYPE_BAL_TRF_INTER	"BAL_TRF_INTER"
#define PD_TXN_TYPE_HOLD_DEPOSIT	"HOLD_DEPOSIT"
#define PD_TXN_TYPE_PSP_SETTLEMENT	"PSP_SETTLEMENT"
#define PD_TXN_TYPE_PROVIDER_CHARGE	"PROVIDER_CHARGE"
#define PD_TXN_TYPE_SMS_BANK_DEPOSIT	"SMS_BANK_DEPOSIT"

#define PD_BATCH_DESC_ORDER_FIRST_REC	0		
#define PD_BATCH_DESC_ORDER_LAST_REC	1		

#define PD_STMT_TXN_ACTION_GEN_NEW_ID		0
#define PD_STMT_TXN_ACTION_KEEP_ORG_ID		1
#define PD_STMT_TXN_ACTION_CHANGE_ORG_STATUS	2

static char cDebug;
OBJPTR(DB);
OBJPTR(BO);

char	csTxnType[PD_TXN_TYPE_LENGTH + 1];
int 	iAction = PD_BATCH_ACTION_CANCEL;
int	iIsOrgBatchIdP1Void = PD_FALSE;
int	iIsOrgBatchIdP2Voided = PD_TRUE;
int	iNumOfBatchId = 0;	

int	GetOrgBatchInfo(const char* csTxnId, hash_t* hBatchInfo, hash_t *hContext);

int     CheckVoidTxnIdValidPSPSettlement(const char* csBatchId, const char* csTxnId, hash_t *hContext);
int     FindVoidBatchIdPSPSettlement(const char* csBatchId, const char* csTxnId, char* csFoundBatchId, char* csFoundTxnId, hash_t *hContext);
int     CheckVoidTxnIdValidProviderCharge(const char* csBatchId, const char* csTxnId, hash_t *hContext);
int     FindVoidBatchIdProviderCharge(const char* csBatchId, const char* csTxnId, char* csFoundBatchId, char* csFoundTxnId, hash_t *hContext);

int 	GetBatchTypeInfo(const char* csBatchId, hash_t* hBatchTypeInfo, hash_t *hContext);
int	GetPrevBatchIdByRegenTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csPrevBatchId, char* csPrevTxnId, hash_t *hContext);
int	GetNextBatchIdByRegenTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csNextBatchId, char* csNextTxnId, hash_t *hContext);
int	GetPrevBatchIdByMultiBatchTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csPrevBatchId, char* csPrevTxnId, hash_t *hContext);
int	GetNextBatchIdByMultiBatchTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csNextBatchId, char* csNextTxnId, hash_t *hContext);
int	GetPrevBatchIdByBatchRelation(const char* csBatchId, const char* csTxnId, char* csPrevBatchId, hash_t *hContext);
int	GetNextBatchIdByBatchRelation(const char* csBatchId, const char* csTxnId, char* csNextBatchId, hash_t *hContext);
int	GetLastTxnIdByRTDescOrder(const char* csBatchId, char* csLastTxnId, hash_t *hContext);
int     GetTxnCodeInfo(const char* csTxnId, hash_t *hTxnCodeInfo, hash_t *hContext);
int     IsInputTxnId(const char* csBatchId, const char* csTxnId, hash_t *hContext);
int	IsMultiBatchTxnId(const char* csTxnId, hash_t *hContext);
int	IsP1VoidTxnId(const char* csTxnId, hash_t *hContext);
int	IsP2VoidedTxnId(const char* csTxnId, hash_t *hContext);
int	IsP1VoidBatchId(const char* csBatchId, hash_t *hContext);
int	IsP2VoidedBatchId(const char* csBatchId, hash_t *hContext);

int     GetTxnHeaderInfo(const char* csTxnId, hash_t* hTxnHeaderRec, hash_t *hContext);
int     IsPutTxnIdToBatch(const char* csTxnId, hash_t* hTxnHeaderRec);
int     CheckActionByTxnId(const char* csTxnId, hash_t *hTxnHeaderRec, hash_t *hContext);

int     GetBaidTxnInfo(const char* csStmtTxnId, hash_t* hBaidTxnRec);
int     IsPutStmtTxnIdToBatch(const char* csStmtTxnId, hash_t* hBaidTxnRec, hash_t* hStmtTxnHeaderRec, hash_t* hStmtTxnContext);

int	UpdateOrgTxnHeaderInfo(const char* csOrgTxnSeq, hash_t *hContext);

int     AddTxnRelation(hash_t* hRls);
int     AddBatchTxnRelation(hash_t* hRls);
int     AddBatchRelation(hash_t* hRls);
int     AddNewTxnRelationLinkage(const char *csOrgBatchId, hash_t *hContext, hash_t *hTxnRelation);
int     AddLastTxnRelationLinkage(hash_t *hRec);

int     ProcessOffsetTxn(const char* csOrgTxnSeq, hash_t* hOrgTxn, hash_t* hNewTxn, hash_t *hContext);
int  	GetTxnInfo(const char *csTxnSeq, hash_t *hContext, hash_t *hTxn);
int	FormNewTxn(int iIsLastTxn, hash_t *hOrgTxn, hash_t *hNewTxn, hash_t *hContext);
int	CreateNewTxn(int iIsLastTxn, hash_t *hNewTxn, hash_t *hContext);
int	UpdateOrgTxn(hash_t *hOrgTxn, hash_t *hContext);

int	IsCreateLastTxn(const char* csOrgTxnSeq, hash_t* hOrgTxn, hash_t* hOrgBatchInfo, hash_t *hContext);
int     ProcessLastTxn(const char* csTxnSeq, hash_t* hOrgTxn, hash_t* hNewTxn, hash_t *hContext);
int     StoreP1LastTxnInfo(const char* csOrgTxnSeq, const char *csNewTxnSeq, const char *csLastTxnSeq, recordset_t *rTmpP1LastTxnRecordSet, hash_t *hTmpP1LastTxnRec, hash_t *hContext);
int     StoreP2LastTxnInfo(const char* csOrgTxnSeq, const char *csNewTxnSeq, const char *csLastTxnSeq, recordset_t *rTmpP2LastTxnRecordSet, hash_t *hTmpP2LastTxnRec, hash_t *hContext);
int	ProcessLastTxnRelation(recordset_t *rTmpP1LastTxnRecordSet, recordset_t *rTmpP2LastTxnRecordSet, recordset_t *rLastTxnRecordSet, hash_t *hLastTxnRec, hash_t *hContext);

int     ProcessOffsetStmtTxn(const char* csOrgStmtTxnSeq, const int iStmtTxnAction, hash_t* hOrgStmtTxn, hash_t* hNewStmtTxn, hash_t* hContext);
int     GetStmtTxnInfo(const char *csStmtTxnSeq, hash_t *hContext, hash_t *hStmtTxn);
int     FormNewStmtTxn(hash_t *hOrgStmtTxn, hash_t *hNewStmtTxn, hash_t *hContext);
int     CreateNewStmtTxn(hash_t *hNewStmtTxn, hash_t *hContext);
int     UpdateOrgStmtTxn(hash_t *hOrgStmtTxn, hash_t *hContext);
int     AddOrgStmtTxnToBatchTxnRelation(hash_t *hOrgStmtTxn, hash_t *hContext);

void 	TxnOmtByUsRBT(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	int     iDtlRet = PD_FALSE;
	int     iTmpRet = PD_NOT_FOUND;

	int	iCnt = 0;
	int	iIsBAIDIntraLogGenTxnId = PD_FALSE;

	char    *csTmp = NULL;
	char	csTag[PD_TMP_BUF_LEN+1];

	char	*csTxnSeq = NULL;
        char    *csUser = NULL;
	
	char	*csBAIDIntraLogGenTxnIdFr = NULL;
	char	*csBAIDIntraLogGenTxnIdTo = NULL;
	
	char	*csTmpTxnId1 = NULL;
	char  	*csTmpTxnId2 = NULL;

	char	*csTmpTxnSeq = NULL;
	char	*csOrgTxnSeq = NULL;
	char	*csNewTxnSeq = NULL;
	char	*csLastTxnSeq = NULL;
	
        char    *csTmpStmtTxnSeq = NULL;
	char    *csOrgStmtTxnSeq = NULL;
	char    *csNewStmtTxnSeq = NULL;

	char	csOrgBatchId[PD_TXN_SEQ_LEN + 1];
	char	csNewBatchId[PD_TXN_SEQ_LEN + 1];

	char	cBAIDIntraLogGenStatus;

	char	cOrgBatchType;
	char	cNewBatchType;

	char	cOrgBatchSubType;
	char	cNewBatchSubType;

        hash_t  *hTmpTxnRec = NULL;
        hash_t  *hTxnRec = NULL;
        hash_t  *hTmpStmtTxnRec = NULL;
	hash_t  *hStmtTxnRec = NULL;

	hash_t  *hTmpTxnHdRec = NULL;
	hash_t 	*hBaidTxnRec = NULL;

	hash_t          *hBAIDIntraLogGen;
        hBAIDIntraLogGen = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBAIDIntraLogGen,0);

	hash_t          *hOrgBatchInfo;
        hOrgBatchInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hOrgBatchInfo,0);

	hash_t          *hTxnHeaderRec;
       	hTxnHeaderRec = (hash_t*) malloc (sizeof(hash_t));
       	hash_init(hTxnHeaderRec,0);

	hash_t  *hTmpP1LastTxnRec = NULL;
        hTmpP1LastTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpP1LastTxnRec,0);

	hash_t  *hTmpP2LastTxnRec = NULL;
        hTmpP2LastTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpP2LastTxnRec,0);

	recordset_t     *rTmpP1LastTxnRecordSet;
        rTmpP1LastTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTmpP1LastTxnRecordSet,0);

	recordset_t     *rTmpP2LastTxnRecordSet;
        rTmpP2LastTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTmpP2LastTxnRecordSet,0);

	hash_t  *hLastTxnRecGet = NULL;
	hash_t  *hLastTxnRec = NULL;
	hLastTxnRec = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hLastTxnRec,0);
        recordset_t     *rLastTxnRecordSet;
        rLastTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rLastTxnRecordSet,0);

	hash_t	*hTxnContext;
	hTxnContext = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxnContext,0);
        recordset_t     *rTmpTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTmpTxnRecordSet,0);
	recordset_t     *rTmpTxnHdRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTmpTxnHdRecordSet,0);
        recordset_t     *rTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTxnRecordSet,0);

	hash_t  *hStmtTxnContext;
        hStmtTxnContext = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hStmtTxnContext,0);
        recordset_t     *rTmpStmtTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTmpStmtTxnRecordSet,0);
	recordset_t     *rTmpBaidTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTmpBaidTxnRecordSet,0);
        recordset_t     *rStmtTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rStmtTxnRecordSet,0);

	hash_t	*hTxnRelation;
	hTxnRelation = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxnRelation,0);

	cBAIDIntraLogGenStatus = ' ';

	cOrgBatchType = ' ';
	cNewBatchType = ' ';
	
	cOrgBatchSubType = ' ';
	cNewBatchSubType = ' ';

DEBUGLOG(("TxnOmtByUsRBT: Authorize()\n"));

	// global init
	iAction = PD_BATCH_ACTION_CANCEL;
	iIsOrgBatchIdP1Void = PD_FALSE;
	iIsOrgBatchIdP2Voided = PD_TRUE;
	iNumOfBatchId = 0; 	
	sprintf(csTxnType, "%s", PD_TXN_TYPE_GENERAL);

/* txn_seq */
	if(GetField_CString(hRequest, "org_txn_seq", &csTxnSeq)) {
DEBUGLOG(("Authorize: txn_seq = [%s]\n",csTxnSeq));
		PutField_CString(hContext,"txn_seq",csTxnSeq);
		PutField_CString(hContext,"org_txn_seq",csTxnSeq);
		PutField_CString(hResponse,"org_txn_seq",csTxnSeq);
        } else {
                iRet = INT_TXN_ID_MISSING;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize: txn_seq missing\n"));
ERRLOG("TxnOmtByUsRBT: Authorize: txn_seq missing\n");
        }

/* remark */
	if(GetField_CString(hRequest, "remark", &csTmp)) {
DEBUGLOG(("Authorize: remark = [%s]\n",csTmp));
                PutField_CString(hContext,"remark",csTmp);
        }

/* user */
        if(GetField_CString(hRequest,"add_user",&csUser)){
DEBUGLOG(("Authorize: add_user = [%s]\n",csUser));
                PutField_CString(hContext,"update_user",csUser);
                PutField_CString(hTxnContext,"update_user",csUser);
                PutField_CString(hStmtTxnContext,"update_user",csUser);
        } else {
                iRet = INT_USER_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize: add_user missing\n"));
ERRLOG("TxnOmtByUsRBT: Authorize: add_user missing\n");
        }

/*
 *
 * Get Batch Id (Order by approval_ts ASC) 
 * - Number Of Batch
 * - Txn Type (intra-balance-transfer/hold-deposit/psp-settlement/provider-charge/general)
 * - Org Batch Id   
 *
 */	
	if (iRet == PD_OK) {

DEBUGLOG(("+++++++++++++++++++++++++++++++++++++++++++++++++++ Get Org Batch Info +++++++++++++++++++++++++++++++++++++++++++++++++++++\n"));

		iRet = GetOrgBatchInfo(csTxnSeq, hOrgBatchInfo, hContext);
		if (iRet == PD_OK) {

/* txn_seq */
//DEBUGLOG(("Authorize: txn_seq = [%s]\n",csTxnSeq));	

/* txn_type */
DEBUGLOG(("Authorize: txn_type = [%s]\n",csTxnType));

/* action */
DEBUGLOG(("Authorize: action = [%d]\n",iAction));

/* num_of_batch */
DEBUGLOG(("Authorize: num_of_batch = [%d]\n",iNumOfBatchId));

			if (iNumOfBatchId > 0) {

/* org_batch_type */
				if(GetField_Char(hOrgBatchInfo, "org_batch_type", &cOrgBatchType)){	
DEBUGLOG(("Authorize: org_batch_type = [%c]\n",cOrgBatchType));		
					PutField_Char(hContext,"org_batch_type",cOrgBatchType);
				}

/* org_batch_sub_type */	
				if(GetField_Char(hOrgBatchInfo, "org_batch_sub_type", &cOrgBatchSubType)){
DEBUGLOG(("Authorize: org_batch_sub_type = [%c]\n",cOrgBatchSubType));		
					PutField_Char(hContext,"org_batch_sub_type",cOrgBatchSubType);
				}

/* org_batch_id */
				if(GetField_CString(hOrgBatchInfo, "org_batch_id", &csTmp)){
					sprintf(csOrgBatchId, "%s", csTmp);
DEBUGLOG(("Authorize: org_batch_id = [%s]\n",csOrgBatchId));		
					PutField_CString(hContext,"org_batch_txn_seq",csOrgBatchId);	
				}
			}

		} else {
DEBUGLOG(("Authorize: txn_seq[%s] is NOT ALLOW to void/cancel!!!\n", csTxnSeq));
		}

DEBUGLOG(("--------------------------------------------------- Get Org Batch Info -----------------------------------------------------\n"));

        }

/*
 * Check Batch Id (No Batah Id or Single Batch Id/Multi Batch Id) * * * * * * * * * * * * * * * * * * * *
 */
	if (iRet == PD_OK) {

		if (iNumOfBatchId <= 0) {

/***************/
/* No Batch Id */
/***************/

			hash_t  *hOrgTxn;
                	hOrgTxn = (hash_t*) malloc (sizeof(hash_t));
			hash_init(hOrgTxn, 0);
                
			hash_t  *hNewTxn;
                	hNewTxn = (hash_t*) malloc (sizeof(hash_t));
                	hash_init(hNewTxn, 0);

			if (GetField_CString(hContext, "txn_seq", &csOrgTxnSeq)) {
DEBUGLOG(("Authorize: org_txn_id = [%s]\n",csOrgTxnSeq));		

/*
 * No Batch Id - Step 1: Check Action Cancel/Void/False * * * * * * * * * * * * * * * * * * * *
 */
				if (iRet == PD_OK) {

DEBUGLOG(("++++++++++++++++++++++++++++++++++++++++++++++ Check Action Cancel/Void/False ++++++++++++++++++++++++++++++++++++++++++++++\n"));

					// Get txn header info
					iRet = GetTxnHeaderInfo(csOrgTxnSeq, hTxnHeaderRec, hContext);				

					// Call function to check void/cancel/false
					if (iRet == PD_OK) {
						iRet = CheckActionByTxnId(csOrgTxnSeq, hTxnHeaderRec, hContext);
						if (iRet == PD_OK) {
							if (iAction == PD_BATCH_ACTION_CANCEL) {
DEBUGLOG(("Authorize: CheckActionByTxnId: Action [CANCEL]\n"));
                        				} else if (iAction == PD_BATCH_ACTION_VOID) {
DEBUGLOG(("Authorize: CheckActionByTxnId: Action [VOID]\n"));
							}
                        			} else {
                                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize: CheckActionByTxnId: Action [NOT ALLOW TO CANCEL/VOID], iRet = [%d]\n",iRet));
						}		
					}

DEBUGLOG(("---------------------------------------------- Check Action Cancel/Void/False ----------------------------------------------\n"));

				}

/*
 * No Batch Id - Step 2: Do Txn Level * * * * * * * * * * * * * * * * * * * *
 */
				if (iRet == PD_OK) {

DEBUGLOG(("++++++++++++++++++++++++++++++++++++++++++++++++++++ Process Offset Txn ++++++++++++++++++++++++++++++++++++++++++++++++++++\n"));

					iRet = ProcessOffsetTxn(csOrgTxnSeq, hOrgTxn, hNewTxn, hContext);	

DEBUGLOG(("---------------------------------------------------- Process Offset Txn ----------------------------------------------------\n"));

				}
	
				// Remove fields - element_acct_bal and element_intransit
				RemoveField_Double(hContext, "element_acct_bal");
				RemoveField_Double(hContext, "element_intransit");                                              
			}
	
			hash_destroy(hOrgTxn);
                	hash_destroy(hNewTxn);

			FREE_ME(hOrgTxn);
                	FREE_ME(hNewTxn);
		}
		else 
		{

/*************************/		
/* Single/Multi Batch Id */
/*************************/

DEBUGLOG(("++++++++++++++++++++++++++++++++++++++++++++++++++ Get Org Batch Txn Id ++++++++++++++++++++++++++++++++++++++++++++++++++++\n"));

                	PutField_Char(hTxnContext,"batch_type",cOrgBatchType);
                	PutField_Char(hTxnContext,"batch_sub_type",cOrgBatchSubType);
                	PutField_CString(hTxnContext,"batch_id",csOrgBatchId);
			PutField_Char(hTxnContext,"txn_level",PD_TXN_LEVEL);

			// Get Txn Id recordset from Batch, order by approval_ts DESC
DEBUGLOG(("Authorize: Call DBOLBatchTxnRelation:: GetTxnId(Txn Level)\n"));
                	DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetTxnId");
                	iRet = (unsigned long)(*DBObjPtr)(hTxnContext,rTmpTxnRecordSet);
                	if (iRet == PD_OK) {
				
				iCnt = 0;

				hTmpTxnRec = RecordSet_GetFirst(rTmpTxnRecordSet);
                                while ((hTmpTxnRec) && (iRet == PD_OK)) {

					if (GetField_CString(hTmpTxnRec,"txn_id",&csTmpTxnSeq)) {
DEBUGLOG(("Authorize: batch_id[%s] txn_id[%d][%s]\n",csOrgBatchId,iCnt,csTmpTxnSeq));

						hash_t 	*hTmpTxnHeaderRec;
        					hTmpTxnHeaderRec = (hash_t*) malloc (sizeof(hash_t));
        					hash_init(hTmpTxnHeaderRec,0);

						// Get txn header info
                                                iRet = GetTxnHeaderInfo(csTmpTxnSeq, hTmpTxnHeaderRec, hContext);
						if (iRet == PD_OK) {
							RecordSet_Add(rTmpTxnHdRecordSet, hTmpTxnHeaderRec);
						}
						
					} else {
						iRet = INT_ERR;
                                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize: Call DBOLBatchTxnRelation:: GetTxnId(Txn Level) Txn Id Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT:: Call DBOLBatchTxnRelation:: GetTxnId(Txn Level) Txn Id Not Found!!!\n");
					}

					iCnt++;
				
					hTmpTxnRec = RecordSet_GetNext(rTmpTxnRecordSet);	
				}

				if (iCnt == 0) {
DEBUGLOG(("Authorize: Call DBOLBatchTxnRelation:: GetTxnId(Txn Level) No Record Found!!!\n"));
				}

			} else {
                        	iRet = INT_ERR;
                        	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize: Call DBOLBatchTxnRelation:: GetTxnId(Txn Level) Invalid Batch Id!!!\n"));
ERRLOG("TxnOmtByUsRBT:: Call DBOLBatchTxnRelation:: GetTxnId(Txn Level) Invalid Batch Id!!!\n");
                	}

			// Get Stmt Txn Id recordset from Batch, order by approval_ts DESC
			if (iRet == PD_OK) {

				PutField_Char(hStmtTxnContext,"batch_type",cOrgBatchType);
                                PutField_Char(hStmtTxnContext,"batch_sub_type",cOrgBatchSubType);
                                PutField_CString(hStmtTxnContext,"batch_id",csOrgBatchId);
                                PutField_Char(hStmtTxnContext,"txn_level",PD_STMT_LEVEL);

DEBUGLOG(("Authorize: Call DBOLBatchTxnRelation:: GetTxnId(Stmt Level)\n"));
                                DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetTxnId");
                                iRet = (unsigned long)(*DBObjPtr)(hStmtTxnContext,rTmpStmtTxnRecordSet);
                                if (iRet == PD_OK) {

                                        iCnt = 0;

                                        hTmpStmtTxnRec = RecordSet_GetFirst(rTmpStmtTxnRecordSet);
                                        while ((hTmpStmtTxnRec) && (iRet == PD_OK)) {

                                                if (GetField_CString(hTmpStmtTxnRec,"txn_id",&csTmpStmtTxnSeq)) {
DEBUGLOG(("Authorize: batch_id[%s] stmt_txn_id[%d][%s]\n",csOrgBatchId,iCnt,csTmpStmtTxnSeq));

							hash_t  *hTmpBaidTxnRec;
                                                	hTmpBaidTxnRec = (hash_t*) malloc (sizeof(hash_t));
                                                	hash_init(hTmpBaidTxnRec,0);

							// Get baid txn info
							iRet = GetBaidTxnInfo(csTmpStmtTxnSeq, hTmpBaidTxnRec);
                                                	if (iRet == PD_OK) {
                                                        	RecordSet_Add(rTmpBaidTxnRecordSet, hTmpBaidTxnRec);
                                               	 	}

                                                } else {
                                                        iRet = INT_ERR;
							PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize: Call DBOLBatchTxnRelation:: GetTxnId(Stmt Level) Txn Id Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT:: Call DBOLBatchTxnRelation:: GetTxnId(Stmt Level) Txn Id Not Found!!!\n");
                                                }

                                                iCnt++;

                                                hTmpStmtTxnRec = RecordSet_GetNext(rTmpStmtTxnRecordSet);
                                        }

                                        if (iCnt == 0) {
DEBUGLOG(("Authorize: Call DBOLBatchTxnRelation:: GetTxnId(Stmt Level) No Record Found!!!\n"));
                                        }

                                } else {
                                        iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize: Call DBOLBatchTxnRelation:: GetTxnId(Stmt Level) Invalid Batch Id!!!\n"));
ERRLOG("TxnOmtByUsRBT:: Call DBOLBatchTxnRelation:: GetTxnId(Stmt Level) Invalid Batch Id!!!\n");
                                }
			}
		
DEBUGLOG(("-------------------------------------------------- Get Org Batch Txn Id ----------------------------------------------------\n"));
	
/*
 * Single / Multi Batch Id - Step 1: Check Txn Type (If Txn Type is Balance Transfer Intra, check BAID Intra Log Gen) * * * * * * * * * * * * * * * * * * * *
 */
			if (iRet == PD_OK) {

DEBUGLOG(("+++++++++++++++++++++++++++++++++++++++++++++++++ Check BAID Intra Log Gen +++++++++++++++++++++++++++++++++++++++++++++++++\n"));

                                if (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) {

                                        // BAID Intra Log Gen - Get Detail
                                        // - gen_txn_id_fr
                                        // - gen_txn_id_to

                                        PutField_CString(hBAIDIntraLogGen,"txn_id",csTxnSeq);
                                        DBObjPtr = CreateObj(DBPtr, "DBOLBaidIntraLogGen","GetDetailByTxnId");
                                        iTmpRet = (unsigned long)(*DBObjPtr)(hBAIDIntraLogGen);
                                        if (iTmpRet == PD_FOUND) {
DEBUGLOG(("Authorize: Call DBOLBaidIntraLogGen: GetDetailByTxnId: Found!!\n"));

                                                iIsBAIDIntraLogGenTxnId = PD_TRUE;

/* gen_txn_id_to */
                                                if (GetField_CString(hBAIDIntraLogGen, "gen_txn_id_to", &csBAIDIntraLogGenTxnIdTo)){
DEBUGLOG(("Authorize: Call DBOLBaidIntraLogGen: GetDetailByTxnId: gen_txn_id_to = [%s]\n", csBAIDIntraLogGenTxnIdTo));
                                                } else {
DEBUGLOG(("Authorize: Call DBOLBaidIntraLogGen: GetDetailByTxnId: gen_txn_id_to is not found!!\n"));
ERRLOG("TxnOmtByUsRBT: Authorize: Call DBOLBaidIntraLogGen: GetDetailByTxnId: gen_txn_id_to is not found!!\n");
                                                        iRet = INT_ERR;
                                                        PutField_Int(hContext,"internal_error",iRet);
                                                }

/* gen_txn_id_fr */
                                                if (iRet == PD_OK) {
                                                        if (GetField_CString(hBAIDIntraLogGen, "gen_txn_id_fr", &csBAIDIntraLogGenTxnIdFr)){
DEBUGLOG(("Authorize: Call DBOLBaidIntraLogGen: GetDetailByTxnId: gen_txn_id_fr = [%s]\n", csBAIDIntraLogGenTxnIdFr));
                                                        } else {
DEBUGLOG(("Authorize: Call DBOLBaidIntraLogGen: GetDetailByTxnId: gen_txn_id_fr is not found!!\n"));
ERRLOG("TxnOmtByUsRBT: Authorize: Call DBOLBaidIntraLogGen: GetDetailByTxnId: gen_txn_id_fr is not found!!\n");
                                                                iRet = INT_ERR;
                                                                PutField_Int(hContext,"internal_error",iRet);
                                                        }
                                                }

                                        } else if (iTmpRet == PD_NOT_FOUND) {
DEBUGLOG(("Authorize: Call DBOLBaidIntraLogGen: GetDetailByTxnId: Not Found!!\n"));
                                        } else {
DEBUGLOG(("Authorize: Call DBOLBaidIntraLogGen: GetDetailByTxnId: Error!!\n"));
ERRLOG("TxnOmtByUsRBT::Authorize: Call DBOLBaidIntraLogGen:GetDetailByTxnId: Error!!\n");
                                                iRet = INT_ERR;
                                                PutField_Int(hContext,"internal_error",iRet);
                                        }
                       
					if (iRet == PD_OK) {

                        	        	if (iIsBAIDIntraLogGenTxnId == PD_TRUE) {

							iCnt = 0;

                                	        	hTmpTxnRec = RecordSet_GetFirst(rTmpTxnRecordSet);
                                        		while ((hTmpTxnRec) && (iRet == PD_OK)) {
                                        		        if (iCnt == 0) {
                                        	        	        if (GetField_CString(hTmpTxnRec,"txn_id",&csTmpTxnId1)) {
//DEBUGLOG(("Authorize: Call DBOLBatchTxnRelation:: GetTxnId() txn_id_1 = [%s]\n",csTmpTxnId1));
                                        	        	        }
                                        	        	} else if (iCnt == 1) {
                                        	        	        if (GetField_CString(hTmpTxnRec,"txn_id",&csTmpTxnId2)) {
//DEBUGLOG(("Authorize: Call DBOLBatchTxnRelation:: GetTxnId() txn_id_2 = [%s]\n",csTmpTxnId2));
                                        	        	        }
                                        	        	}

                                        	        	iCnt++;

                                        	        	hTmpTxnRec = RecordSet_GetNext(rTmpTxnRecordSet);
                                        		}

                                        		if ((!strcmp(csTmpTxnId1, csBAIDIntraLogGenTxnIdTo))
                                        		   && (!strcmp(csTmpTxnId2, csBAIDIntraLogGenTxnIdFr))
                                        		)
                                        		{
DEBUGLOG(("Authorize: BAID Intra Log Gen Txn Id(s) Match!!\n"));
                                        		}
                                        		else
                                        		{
                                        		        if ((!strcmp(csTmpTxnId1, csBAIDIntraLogGenTxnIdFr))
                                        		           && (!strcmp(csTmpTxnId2, csBAIDIntraLogGenTxnIdTo))
                                        		        )
                                        		        {
DEBUGLOG(("Authorize: BAID Intra Log Gen Txn Id(s) Match!!\n"));
                                        		        }
                                        		        else
                                        		        {
DEBUGLOG(("Authorize: BAID Intra Log Gen Txn Id(s) NOT Match!!\n"));
                                        		                iRet = INT_ERR;
                                        		                PutField_Int(hContext,"internal_error",iRet);
                                        		        }
                                       			}
						}
					}
				} else {
DEBUGLOG(("Authorize: txn_type[%s] is not equal to [%s]\n", csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA));
				}				
			
				if (iRet == PD_OK) {	
                                	if (iIsBAIDIntraLogGenTxnId != PD_TRUE) {
DEBUGLOG(("Authorize: This is not BAID Intra Log Gen!!!\n"));
                                	}
				}

DEBUGLOG(("------------------------------------------------- Check BAID Intra Log Gen -------------------------------------------------\n"));

                        }

/*
 * Single / Multi Batch Id - Step 2: Check Batch Id is P1Void or P2Voided * * * * * * * * * * * * * * * * * * * *
 */
			if (iRet == PD_OK) {

DEBUGLOG(("+++++++++++++++++++++++++++++++++++++++++++ Check Batch Id is P1Void or P2Voided +++++++++++++++++++++++++++++++++++++++++++\n"));

				iCnt = 0;

				hTmpTxnRec = RecordSet_GetFirst(rTmpTxnRecordSet);
				while ((hTmpTxnRec) && (iRet == PD_OK)) {
/* txn_id */
                       			if (GetField_CString(hTmpTxnRec,"txn_id",&csTmpTxnSeq)) {
DEBUGLOG(("Authorize: [%d]txn_id = [%s]\n",iCnt,csTmpTxnSeq));

						// Check P1Void Txn Id
						if (iRet == PD_OK) {
							iDtlRet = PD_FALSE;

                                 			iDtlRet = IsP1VoidTxnId(csTmpTxnSeq, hContext);
                                        		if (iDtlRet == PD_TRUE) {
								iIsOrgBatchIdP1Void = PD_TRUE;
                                        		 	break;
                                        		} else if (iDtlRet == PD_FALSE) {
								// Do Nothing...
							} else {
								iRet = iDtlRet;
							}
						}

						// Check P2Voided Txn Id
						if (iRet == PD_OK) {
							iDtlRet = PD_FALSE;

							iDtlRet = IsP2VoidedTxnId(csTmpTxnSeq, hContext);
							if (iDtlRet == PD_TRUE) {
								// Do Nothing...
							} else if (iDtlRet == PD_FALSE) {
								iIsOrgBatchIdP2Voided = PD_FALSE;
								break;
							} else {
                                                                iRet = iDtlRet;
                                                        }
						}
					}

					iCnt++;

					hTmpTxnRec = RecordSet_GetNext(rTmpTxnRecordSet);
				}

				// Results
				if (iIsOrgBatchIdP1Void == PD_TRUE) {
DEBUGLOG(("Authorize: P1VoidBatchId = [TRUE]\n"));
                                } else {
DEBUGLOG(("Authorize: P1VoidBatchId = [FALSE]\n"));
                                }

				if (iIsOrgBatchIdP2Voided == PD_TRUE) {
DEBUGLOG(("Authorize: P2VoidedBatchId = [TRUE]\n"));

					if ((strcmp(csTxnType, PD_TXN_TYPE_PSP_SETTLEMENT))
                                            && (strcmp(csTxnType, PD_TXN_TYPE_PROVIDER_CHARGE))
                                        )
                                        {
DEBUGLOG(("Authorize: P2VoidedBatchId txn_type is equal to [%s]\n", csTxnType));
                                                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize: P2VoidedBatchId return error, iRet = [%d]\n",iRet));
                                        }
                                } else {
DEBUGLOG(("Authorize: P2VoidedBatchId = [FALSE]\n"));
              			}
			
DEBUGLOG(("------------------------------------------- Check Batch Id is P1Void or P2Voided -------------------------------------------\n"));

			}

/*
 * Single / Multi Batch Id - Step 3: Check Action Cancel/Void/False * * * * * * * * * * * * * * * * * * * *
 */

			if (iRet == PD_OK) {			
			
DEBUGLOG(("+++++++++++++++++++++++++++++++++++++++++++++++ Check Action Cancel/Void/False +++++++++++++++++++++++++++++++++++++++++++++\n"));

				iCnt = 0;

                                hTmpTxnHdRec = RecordSet_GetFirst(rTmpTxnHdRecordSet);
                                while ((hTmpTxnHdRec) && (iRet == PD_OK)) {
		
/* txn_id */
                                        if (GetField_CString(hTmpTxnHdRec,"txn_id",&csTmpTxnSeq)) {
//DEBUGLOG(("Authorize: [%d]txn_id = [%s]\n",iCnt,csTmpTxnSeq));
			
						// Store tmp_txn_seq
						PutField_CString(hTxnContext,"txn_id",csTmpTxnSeq);
                                                PutField_CString(hTxnContext,"txn_seq",csTmpTxnSeq);

						// Call function to check void/cancel/false
                                                iRet = CheckActionByTxnId(csTmpTxnSeq, hTmpTxnHdRec, hContext);
                                                if (iRet == PD_OK) {
                                                        if (iAction == PD_BATCH_ACTION_CANCEL) {
DEBUGLOG(("Authorize: [%d]CheckActionByTxnId: [%s][CANCEL]\n",iCnt,csTmpTxnSeq));
                                                        } else if (iAction == PD_BATCH_ACTION_VOID) {
DEBUGLOG(("Authorize: [%d]CheckActionByTxnId: [%s][VOID]\n",iCnt,csTmpTxnSeq));
                                                        }
                                                } else {
                                                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize: [%d]CheckActionByTxnId: [%s][NOT ALLOW TO CANCEL/VOID]\n",iCnt,csTmpTxnSeq));
DEBUGLOG(("Authorize: [%d]CheckActionByTxnId: [%s]Return Error, iRet = [%d]\n",iCnt,csTmpTxnSeq,iRet));
                                                        break;
                                                }
                                        }
			
					iCnt++;

                                        hTmpTxnHdRec = RecordSet_GetNext(rTmpTxnHdRecordSet);
				}	

				// Results
                                if (iAction == PD_BATCH_ACTION_CANCEL) {
DEBUGLOG(("Authorize: Batch Action [CANCEL]\n"));
                                } else if (iAction == PD_BATCH_ACTION_VOID) {
DEBUGLOG(("Authorize: Batch Action [VOID]\n"));
                                } else {
DEBUGLOG(("Authorize: Batch Action [NOT ALLOW TO CANCEL/VOID]\n"));
DEBUGLOG(("Authorize: Return Error, iRet = [%d]\n",iRet));
                                }

DEBUGLOG(("----------------------------------------------- Check Action Cancel/Void/False ---------------------------------------------\n"));

			}

/*
 * Single / Multi Batch Id - Step 4: Check All Txn Id is put in the new Batch * * * * * * * * * * * * * * * * * * * *
 */

                        if (iRet == PD_OK) {

DEBUGLOG(("++++++++++++++++++++++++++++++++++++++++++ Check All Txn Id is put in the new Batch ++++++++++++++++++++++++++++++++++++++++\n"));

                                iCnt = 0;

                                hTmpTxnHdRec = RecordSet_GetFirst(rTmpTxnHdRecordSet);
                                while ((hTmpTxnHdRec) && (iRet == PD_OK)) {

/* txn_id */
                                        if (GetField_CString(hTmpTxnHdRec,"txn_id",&csTmpTxnSeq)) {
//DEBUGLOG(("Authorize: [%d]txn_id = [%s]\n",iCnt,csTmpTxnSeq));

						int iPutToBatch = PD_OK;					

						// Store tmp_txn_seq
                                                PutField_CString(hTxnContext,"txn_id",csTmpTxnSeq);
                                                PutField_CString(hTxnContext,"txn_seq",csTmpTxnSeq);

						// Call function to check txn id is included in new batch
                                                iPutToBatch = IsPutTxnIdToBatch(csTmpTxnSeq, hTmpTxnHdRec);
                                                if (iPutToBatch == PD_OK) {
                                                        RecordSet_Add(rTxnRecordSet, hTmpTxnHdRec);
DEBUGLOG(("Authorize: [%d]IsPutTxnIdToBatch: [%s][PUT]\n",iCnt,csTmpTxnSeq));
                                                } else {
DEBUGLOG(("Authorize: [%d]IsPutTxnIdToBatch: [%s][NOT PUT]\n",iCnt,csTmpTxnSeq));
                                                }
                                        }

					iCnt++;

                                        hTmpTxnHdRec = RecordSet_GetNext(rTmpTxnHdRecordSet);
                                }

                            	if (iCnt == 0) {
DEBUGLOG(("Authorize: No TxnId(Txn Level) Record Found!!!\n"));
                             	}

DEBUGLOG(("------------------------------------------ Check All Txn Id is put in the new Batch ----------------------------------------\n"));

                        }

/*
 * Single / Multi Batch Id - Step 5: Update Org Txn Header Info depends on Action Cancel/Void * * * * * * * * * * * * * * * * * * * *
 */

			if (iRet == PD_OK) {

DEBUGLOG(("+++++++++++++++++++++++++++++++++++++++++++++++ Update Org Txn Header Info +++++++++++++++++++++++++++++++++++++++++++++++++\n"));

				// Update org txn header info (provider-charge)
				if (!strcmp(csTxnType, PD_TXN_TYPE_PROVIDER_CHARGE)) {
                                        iRet = UpdateOrgTxnHeaderInfo(csTxnSeq, hContext);
                                } else {
DEBUGLOG(("Authorize: txn_type[%s] is not equal to [%s]\n", csTxnType, PD_TXN_TYPE_PROVIDER_CHARGE));
				}	

DEBUGLOG(("----------------------------------------------- Update Org Txn Header Info -------------------------------------------------\n"));

			}	

			// Create New Batch Id
			if (iRet == PD_OK) {

DEBUGLOG(("+++++++++++++++++++++++++++++++++++++++++++++++++ Create New Batch Info ++++++++++++++++++++++++++++++++++++++++++++++++++++\n"));

				DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextActionBatchSeq");
				strcpy(csNewBatchId, (*DBObjPtr)());

/* batch_type */
                               	cNewBatchType = cOrgBatchType;
                                PutField_Char(hContext, "batch_type", cNewBatchType);
DEBUGLOG(("Authorize: new_batch_type = [%c]\n",cNewBatchType));

/* batch_sub_type */
				if ((cOrgBatchSubType == PD_GENERAL_RECON) 
				    || (cOrgBatchSubType == PD_GENERAL_UNDO_RECON)
				) 
				{
					cNewBatchSubType = PD_GENERAL_UNDO_RECON;
				}
				else if ((cOrgBatchSubType == PD_GENERAL_BAL_TRF)
                                    || (cOrgBatchSubType == PD_GENERAL_UNDO_BAL_TRF)
                                )				
				{
					cNewBatchSubType = PD_GENERAL_UNDO_BAL_TRF;
				}
				else 
				{
					cNewBatchSubType = PD_COMBINE_UNDO_RECON;
				}
				PutField_Char(hContext, "batch_sub_type", cNewBatchSubType);	
DEBUGLOG(("Authorize: new_batch_sub_type = [%c]\n",cNewBatchSubType));
		
/* batch_txn_seq*/
                                PutField_CString(hContext, "batch_txn_seq", csNewBatchId);
DEBUGLOG(("Authorize: new_batch_id = [%s]\n",csNewBatchId));

DEBUGLOG(("------------------------------------------------- Create New Batch Info ----------------------------------------------------\n"));

			}

/*
 * Single / Multi Batch Id - Step 6: Do Txn Level * * * * * * * * * * * * * * * * * * * *
 */

			// Loop txn id from batch for void/cancel action
			if (iRet == PD_OK) {
				hash_t  *hOrgTxn;
                		hOrgTxn = (hash_t*) malloc (sizeof(hash_t));

                		hash_t  *hNewTxn;
                		hNewTxn = (hash_t*) malloc (sizeof(hash_t));

				iCnt = 0;

                		hTxnRec = RecordSet_GetFirst(rTxnRecordSet);
                		while ((hTxnRec) && (iRet == PD_OK)) {
                        		hash_init(hOrgTxn, 0);

					// do offset txn
                        		if (GetField_CString(hTxnRec,"txn_id",&csOrgTxnSeq)) {

DEBUGLOG(("++++++++++++++++++++++++++++++++++++++++++++++++++++ Process Offset Txn ++++++++++++++++++++++++++++++++++++++++++++++++++++\n"));

						hash_init(hNewTxn, 0);

                                		iRet = ProcessOffsetTxn(csOrgTxnSeq, hOrgTxn, hNewTxn, hContext);
						if (iRet == PD_OK) {

							if (GetField_CString(hNewTxn, "txn_seq", &csNewTxnSeq)) {
					
								// Store new linkage of txnRelation into Hash
								sprintf(csTag,"id_%s",(const char*)csOrgTxnSeq);
								PutField_CString(hTxnRelation,csTag,(const char*)csNewTxnSeq);
DEBUGLOG(("Authorize: [%d]org_txn_id = [%s]\n",iCnt,(char*)csOrgTxnSeq));
DEBUGLOG(("Authorize: [%d]new_txn_id = [%s]\n",iCnt,(char*)csNewTxnSeq));
							}
						}
		
						hash_destroy(hNewTxn);

DEBUGLOG(("---------------------------------------------------- Process Offset Txn ----------------------------------------------------\n"));

					}

					// Check if do last txn
					if (iRet == PD_OK) {

DEBUGLOG(("+++++++++++++++++++++++++++++++++++++++++++++++++++++ Process Last Txn +++++++++++++++++++++++++++++++++++++++++++++++++++++\n"));

						iDtlRet = PD_FALSE;

						// Check last txn is created		
						iDtlRet = IsCreateLastTxn(csOrgTxnSeq, hOrgTxn, hOrgBatchInfo, hContext);
						if (iDtlRet == PD_TRUE) {

							// Do last txn
							if (iRet == PD_OK) {
								hash_init(hNewTxn, 0);

                                				iRet = ProcessLastTxn(csNewTxnSeq, hOrgTxn, hNewTxn, hContext);	

								if (iRet == PD_OK) {
									if (GetField_CString(hNewTxn, "txn_seq", &csLastTxnSeq)) {
DEBUGLOG(("Authorize: [%d]last_txn_id = [%s]\n", iCnt,csLastTxnSeq));
									}
								}

								hash_destroy(hNewTxn);
							}

							// Store last txn info (balance-transfer)
							if (iRet == PD_OK) {
								if (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA) || !strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTER)) {

									// p1 last txn info
									iRet = StoreP1LastTxnInfo(csOrgTxnSeq, csNewTxnSeq, csLastTxnSeq, rTmpP1LastTxnRecordSet, hTmpP1LastTxnRec, hContext);
				
									// p2 last txn info
									if (iRet == PD_OK) {
										iRet = StoreP2LastTxnInfo(csOrgTxnSeq, csNewTxnSeq, csLastTxnSeq, rTmpP2LastTxnRecordSet, hTmpP2LastTxnRec, hContext);
									}
								}
							}

						} else if (iDtlRet == PD_FALSE) {
DEBUGLOG(("Authorize: [%d]last_txn_id = [NOT CREATE]\n", iCnt));
						} else {
							iRet = INT_ERR;
DEBUGLOG(("Authorize: [%d]last_txn_id created failure!!!\n", iCnt));
ERRLOG("TxnOmtByUsRBT:: [%d]last_txn_id created failure!!!\n", iCnt);
						}

DEBUGLOG(("----------------------------------------------------- Process Last Txn -----------------------------------------------------\n"));

                        		}

					iCnt++;

					// Get next txn
					hTxnRec = RecordSet_GetNext(rTxnRecordSet);

					// Do last txn relation (balance-transfer)
					if (iRet == PD_OK) {
						if (!hTxnRec) {

DEBUGLOG(("++++++++++++++++++++++++++++++++++++++++++++++++ Process Last Txn Relation +++++++++++++++++++++++++++++++++++++++++++++++++\n"));

							if (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA) || !strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTER)) {
DEBUGLOG(("Authorize: txn_type[%s] equal to [%s] or [%s]\n", csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA, PD_TXN_TYPE_BAL_TRF_INTER));
								iRet = ProcessLastTxnRelation(rTmpP1LastTxnRecordSet, rTmpP2LastTxnRecordSet, rLastTxnRecordSet, hLastTxnRec, hContext);
							} else {
DEBUGLOG(("Authorize: txn_type[%s] is not equal to [%s] or [%s]\n", csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA, PD_TXN_TYPE_BAL_TRF_INTER));
							}	

DEBUGLOG(("------------------------------------------------ Process Last Txn Relation -------------------------------------------------\n"));

						}
                                     	}

					// Remove fields - element_acct_bal and element_intransit
					RemoveField_Double(hContext, "element_acct_bal");
                        		RemoveField_Double(hContext, "element_intransit");

                        		hash_destroy(hOrgTxn);
                		}

                		FREE_ME(hOrgTxn);
                		FREE_ME(hNewTxn);
			}

/*
 * Single / Multi Batch Id - Step 7: Do Txn Relation (Linkage) * * * * * * * * * * * * * * * * * * * *
 */
			if (iRet == PD_OK) {

DEBUGLOG(("+++++++++++++++++++++++++++++++++++++++++++ Add New and Last Txn Relation Linkage ++++++++++++++++++++++++++++++++++++++++++\n"));

				if (iAction != PD_BATCH_ACTION_CANCEL) {
				
					// Add New Txn Relation Linkage
					iRet = AddNewTxnRelationLinkage(csOrgBatchId, hContext, hTxnRelation);

					// Add Last Txn Relation Linkage
					if (iRet == PD_OK) {
						hLastTxnRecGet = RecordSet_GetFirst(rLastTxnRecordSet);
                	        		while (hLastTxnRecGet) {
							iRet = AddLastTxnRelationLinkage(hLastTxnRecGet);
							hLastTxnRecGet = RecordSet_GetNext(rLastTxnRecordSet);
						}
					}
				} else {
DEBUGLOG(("Authorize: Action [CANCEL], No New and Last Txn Relation Linkage!!!\n"));
				}

DEBUGLOG(("------------------------------------------- Add New and Last Txn Relation Linkage ------------------------------------------\n"));

			}

/*
 * Single / Multi Batch Id - Step 8: Check All Stmt Txn Id in the Batch is put in the new Batch * * * * * * * * * * * * * * * * * * * *
 */
			if (iRet == PD_OK) {

DEBUGLOG(("+++++++++++++++++++++++++++++++++++++++++++ Check Stmt Txn Id is put in the Batch ++++++++++++++++++++++++++++++++++++++++++\n"));
						
				iCnt = 0;

                        	hBaidTxnRec = RecordSet_GetFirst(rTmpBaidTxnRecordSet);
				while ((hBaidTxnRec) && (iRet == PD_OK)) {

/* txn_id */
                                	if (GetField_CString(hBaidTxnRec,"txn_id",&csTmpStmtTxnSeq)) {
			
						hash_t  *hTmpStmtTxnHeaderRec;
                                                hTmpStmtTxnHeaderRec = (hash_t*) malloc (sizeof(hash_t));
                                                hash_init(hTmpStmtTxnHeaderRec,0);			

						int iPutToBatch = PD_FALSE;

						// Store tmp stmt txn seq			
						PutField_CString(hStmtTxnContext,"txn_id",csTmpStmtTxnSeq);
						PutField_CString(hStmtTxnContext,"txn_seq",csTmpStmtTxnSeq);
	
						iPutToBatch = IsPutStmtTxnIdToBatch(csTmpStmtTxnSeq, hBaidTxnRec, hTmpStmtTxnHeaderRec, hStmtTxnContext); 
						if (iPutToBatch == PD_TRUE) {
							RecordSet_Add(rStmtTxnRecordSet, hTmpStmtTxnHeaderRec);
DEBUGLOG(("Authorize: [%d]IsPutStmtTxnIdToBatch:: [%s][PUT]\n",iCnt,csTmpStmtTxnSeq));
						} else if (iPutToBatch == PD_FALSE) {
DEBUGLOG(("Authorize: [%d]IsPutStmtTxnIdToBatch:: [%s][NOT PUT]\n",iCnt,csTmpStmtTxnSeq));
						} else {
							iRet = iPutToBatch;
DEBUGLOG(("Authorize: [%d]IsPutStmtTxnIdToBatch:: [%s]Return Error\n",iCnt,csTmpStmtTxnSeq,iRet));
						}
					}

					iCnt++;

                                	hBaidTxnRec = RecordSet_GetNext(rTmpBaidTxnRecordSet);
                        	}

				if (iCnt == 0) {
DEBUGLOG(("Authorize: No TxnId(Stmt Level) Record Found!!!\n"));
                                }

DEBUGLOG(("------------------------------------------- Check Stmt Txn Id is put in the Batch ------------------------------------------\n"));

        		}	

/*
 * Single / Multi Batch Id - Step 9: Do Stmt Txn Level * * * * * * * * * * * * * * * * * * * *
 */
			// Loop stmt txn id from batch for action
			if (iRet == PD_OK) {

				iCnt = 0;

                		hStmtTxnRec = RecordSet_GetFirst(rStmtTxnRecordSet);
                		while (hStmtTxnRec) {

					int 	iStmtTxnAction = PD_STMT_TXN_ACTION_GEN_NEW_ID;
			
					hash_t  *hOrgStmtTxn;
                                	hOrgStmtTxn = (hash_t*) malloc (sizeof(hash_t));
                                	hash_init(hOrgStmtTxn, 0);

                                	hash_t  *hNewStmtTxn;
                                	hNewStmtTxn = (hash_t*) malloc (sizeof(hash_t));
                                	hash_init(hNewStmtTxn, 0);

					// do offset stmt txn
                        		if (GetField_CString(hStmtTxnRec,"txn_id",&csOrgStmtTxnSeq)) {

DEBUGLOG(("+++++++++++++++++++++++++++++++++++++++++++++++++++ Process Stmt Offset Txn ++++++++++++++++++++++++++++++++++++++++++++++++\n"));

						if (GetField_Int(hStmtTxnRec,"stmt_txn_action",&iStmtTxnAction)) {

		                       			iRet = ProcessOffsetStmtTxn(csOrgStmtTxnSeq, iStmtTxnAction, hOrgStmtTxn, hNewStmtTxn, hContext);
							if (iRet == PD_OK) {

								if (GetField_CString(hNewStmtTxn, "txn_seq", &csNewStmtTxnSeq)) {
DEBUGLOG(("Authorize: [%d]org_stmt_txn_id = [%s]\n",iCnt,csOrgStmtTxnSeq));
DEBUGLOG(("Authorize: [%d]new_stmt_txn_id = [%s]\n",iCnt,csNewStmtTxnSeq));
								}
                        	                       	}
                        			}

DEBUGLOG(("--------------------------------------------------- Process Stmt Offset Txn ------------------------------------------------\n"));

					}

					iCnt++;

					hash_destroy(hOrgStmtTxn);
                               	 	hash_destroy(hNewStmtTxn);

                                	FREE_ME(hOrgStmtTxn);
                                	FREE_ME(hNewStmtTxn);

                        		hStmtTxnRec = RecordSet_GetNext(rStmtTxnRecordSet);
                		}
        		}

/*
 * Single / Multi Batch Id - Step 10: Do Batch Relation * * * * * * * * * * * * * * * * * * * *
 */
			// Add Batch Relation	
			if (iRet == PD_OK) {

DEBUGLOG(("++++++++++++++++++++++++++++++++++++++++++++++++++++++ Add Batch Relation ++++++++++++++++++++++++++++++++++++++++++++++++++\n"));

//DEBUGLOG(("Authorize: org_batch_id[%s]\n",csOrgBatchId));
//DEBUGLOG(("Authorize: new_batch_id[%s]\n",csNewBatchId));
                		PutField_CString(hContext, "org_batch_id", csOrgBatchId);
                		PutField_CString(hContext, "batch_id", csNewBatchId);
				if (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) {
                        		PutField_Char(hContext, "batch_sub_type", PD_GENERAL_UNDO_BAL_TRF);
                		} else {
                			PutField_Char(hContext, "batch_sub_type", cNewBatchSubType);
				}

                		iRet = AddBatchRelation(hContext);

DEBUGLOG(("------------------------------------------------------ Add Batch Relation --------------------------------------------------\n"));

        		}

/*
 * Single / Multi Batch Id - Step 11: Check BAID Intra Log Gen (If yes, update Status to Cancelled [C]) * * * * * * * * * * * * * * * * * * * *
 */
        		if (iRet == PD_OK) {

DEBUGLOG(("+++++++++++++++++++++++++++++++++++++++++++++++ Update BAID Intra Log Gen Status +++++++++++++++++++++++++++++++++++++++++++\n"));

				if (iIsBAIDIntraLogGenTxnId == PD_TRUE) {

					cBAIDIntraLogGenStatus = PD_BAID_INTRA_LOG_GEN_STATUS_CANCELLED;

					PutField_Char(hBAIDIntraLogGen,"status",cBAIDIntraLogGenStatus);
                        		PutField_CString(hBAIDIntraLogGen,"update_user",csUser);

DEBUGLOG(("Authorize: Call DBOLBaidIntraLogGen: UpdateByTxnId gen_txn_id_to = [%s]\n", csBAIDIntraLogGenTxnIdTo));
DEBUGLOG(("Authorize: Call DBOLBaidIntraLogGen: UpdateByTxnId gen_txn_id_fr = [%s]\n", csBAIDIntraLogGenTxnIdFr));
DEBUGLOG(("Authorize: Call DBOLBaidIntraLogGen: UpdateByTxnId status = [%c]\n", cBAIDIntraLogGenStatus));

                			DBObjPtr = CreateObj(DBPtr, "DBOLBaidIntraLogGen","UpdateByTxnId");
                			if ((unsigned long)(*DBObjPtr)(hBAIDIntraLogGen) == PD_OK) {
DEBUGLOG(("Authorize: Call DBOLBaidIntraLogGen: UpdateByTxnId() Success!!!\n"));
                			} else {
						iRet = INT_ERR;
DEBUGLOG(("Authorize: Call DBOLBaidIntraLogGen: UpdateByTxnId() Failure!!!\n"));
ERRLOG("TxnOmtByUsRBT::Authorize::Call DBOLBaidIntraLogGen::UpdateByTxnId() Failure!!!\n");
					}
				} else {
DEBUGLOG(("Authorize: This is not BAID Intra Log Gen!!!\n"));
				}
				
DEBUGLOG(("----------------------------------------------- Update BAID Intra Log Gen Status -------------------------------------------\n"));

        		}
		}
	}	

	hash_destroy(hBAIDIntraLogGen);
        FREE_ME(hBAIDIntraLogGen);

	hash_destroy(hOrgBatchInfo);
        FREE_ME(hOrgBatchInfo);

	hash_destroy(hTxnHeaderRec);
        FREE_ME(hTxnHeaderRec);

	RecordSet_Destroy(rTmpP1LastTxnRecordSet);
        FREE_ME(rTmpP1LastTxnRecordSet);

	RecordSet_Destroy(rTmpP2LastTxnRecordSet);
        FREE_ME(rTmpP2LastTxnRecordSet);

	RecordSet_Destroy(rLastTxnRecordSet);
        FREE_ME(rLastTxnRecordSet);

        RecordSet_Destroy(rTmpTxnRecordSet);
        FREE_ME(rTmpTxnRecordSet);

	RecordSet_Destroy(rTmpTxnHdRecordSet);
        FREE_ME(rTmpTxnHdRecordSet);

	RecordSet_Destroy(rTxnRecordSet);
        FREE_ME(rTxnRecordSet);

        RecordSet_Destroy(rTmpStmtTxnRecordSet);
        FREE_ME(rTmpStmtTxnRecordSet);

	RecordSet_Destroy(rTmpBaidTxnRecordSet);
        FREE_ME(rTmpBaidTxnRecordSet);

	RecordSet_Destroy(rStmtTxnRecordSet);
        FREE_ME(rStmtTxnRecordSet);

	hash_destroy(hTmpP1LastTxnRec);
        FREE_ME(hTmpP1LastTxnRec);

	hash_destroy(hTmpP2LastTxnRec);
        FREE_ME(hTmpP2LastTxnRec);

	hash_destroy(hLastTxnRec);
	FREE_ME(hLastTxnRec);

	hash_destroy(hTxnContext);
	FREE_ME(hTxnContext);

	hash_destroy(hStmtTxnContext);
	FREE_ME(hStmtTxnContext);

DEBUGLOG(("TxnOmtByUsRBT: Authorize() iRet = [%d]\n",iRet));
	return iRet;
}

int     GetOrgBatchInfo(const char* csTxnSeq, hash_t *hBatchInfo, hash_t *hContext)
{
        int     iRet = PD_OK;
	int	iDtlRet = PD_TRUE;
	
        int     iRecCnt = 0;

	char	cTmpBatchType;
	char	cTmpBatchSubType;

        char    *csTmpBatchId = NULL;

	char    *csFoundTxnSeq = (char*) malloc (64);

	char    csSelectBatchId[PD_TXN_SEQ_LEN + 1];
	char	csFoundBatchId[PD_TXN_SEQ_LEN + 1];
       
	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
 
	hash_t          *hTmpBatchRec;
        hTmpBatchRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpBatchRec,0);

        hash_t          *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rBatchRecordSet,0);

	cTmpBatchType = ' ';
	cTmpBatchSubType = ' ';

        PutField_Char(hTmpBatchRec,"txn_level",PD_TXN_LEVEL);
        PutField_CString(hTmpBatchRec,"txn_id",csTxnSeq);

       	DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetBatchIdByRTAscOrder");
      	iRet = (unsigned long)(*DBObjPtr)(hTmpBatchRec,rBatchRecordSet);
       	if (iRet == PD_OK) {
       		hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                while (hBatchRec) {

/* batch_id */
                  	if (GetField_CString(hBatchRec,"batch_id",&csTmpBatchId)) {
DEBUGLOG(("GetOrgBatchInfo:: Call DBOLBatchTxnRelation:: GetBatchIdByRTAscOrder:: batch_id = [%s]\n",csTmpBatchId));
			
				// is txn type - intra-balance-transfer
				DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","CheckIsBalTransBatch");
                               	if ((unsigned long)(*DBObjPtr)(csTmpBatchId) == PD_TRUE) {
                                    	sprintf(csTxnType, "%s", PD_TXN_TYPE_BAL_TRF_INTRA);
DEBUGLOG(("GetOrgBatchInfo:: Call DBOLBatchTxnRelation:: GetBatchIdByRTAscOrder:: txn_type = [%s]\n", csTxnType));
                                }

				// is txn type - inter-balance-transfer
                                DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","CheckIsBalTransInterBatch");
                                if ((unsigned long)(*DBObjPtr)(csTmpBatchId) == PD_TRUE) {
                                        sprintf(csTxnType, "%s", PD_TXN_TYPE_BAL_TRF_INTER);
DEBUGLOG(("GetOrgBatchInfo:: Call DBOLBatchTxnRelation:: GetBatchIdByRTAscOrder:: txn_type = [%s]\n", csTxnType));
                                }

				// is txn type - hold-deposit
				DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","CheckIsHoldDepositBatch");
                               	if ((unsigned long)(*DBObjPtr)(csTmpBatchId) == PD_TRUE) {
                                     	sprintf(csTxnType, "%s", PD_TXN_TYPE_HOLD_DEPOSIT);
DEBUGLOG(("GetOrgBatchInfo:: Call DBOLBatchTxnRelation:: GetBatchIdByRTAscOrder:: txn_type = [%s]\n", csTxnType));

					strcpy(csSelectBatchId,csTmpBatchId);
DEBUGLOG(("GetOrgBatchInfo:: Call DBOLBatchTxnRelation:: GetBatchIdByRTAscOrder:: select_batch_id = [%s]\n", csSelectBatchId));
                              	}

				// is txn type - psp-settlement
				DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","CheckIsPSPSettlementBatch");
                               	if ((unsigned long)(*DBObjPtr)(csTmpBatchId) == PD_TRUE) {
                                  	sprintf(csTxnType, "%s", PD_TXN_TYPE_PSP_SETTLEMENT);
DEBUGLOG(("GetOrgBatchInfo:: Call DBOLBatchTxnRelation:: GetBatchIdByRTAscOrder:: txn_type = [%s]\n", csTxnType));
                           	}

				// is txn type - provider-charge
				DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","CheckIsProviderChargeBatch");
                             	if ((unsigned long)(*DBObjPtr)(csTmpBatchId) == PD_TRUE) {
                                   	sprintf(csTxnType, "%s", PD_TXN_TYPE_PROVIDER_CHARGE);
DEBUGLOG(("GetOrgBatchInfo:: Call DBOLBatchTxnRelation:: GetBatchIdByRTAscOrder:: txn_type = [%s]\n", csTxnType));
                            	}

				// is txn type - sms-bank-deposit
				DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","CheckIsSMSBankDepositBatch");
                                if ((unsigned long)(*DBObjPtr)(csTmpBatchId) == PD_TRUE) {
                                        sprintf(csTxnType, "%s", PD_TXN_TYPE_SMS_BANK_DEPOSIT);
DEBUGLOG(("GetOrgBatchInfo:: Call DBOLBatchTxnRelation:: GetBatchIdByRTAscOrder:: txn_type = [%s]\n", csTxnType));
                                }
			}
	
			iNumOfBatchId++;

                     	hBatchRec = RecordSet_GetNext(rBatchRecordSet);
             	}

		// Check Number of Found Batch Id
		if (iNumOfBatchId == 0) {
DEBUGLOG(("GetOrgBatchInfo:: Call DBOLBatchTxnRelation:: GetBatchIdByRTAscOrder:: No Batch Found!!!\n"));
             	} else if (iNumOfBatchId == 1) {
DEBUGLOG(("GetOrgBatchInfo:: Call DBOLBatchTxnRelation:: GetBatchIdByRTAscOrder:: Single Batch Found!!!\n"));
             	} else if (iNumOfBatchId > 1) {
DEBUGLOG(("GetOrgBatchInfo:: Call DBOLBatchTxnRelation:: GetBatchIdByRTAscOrder:: Multi-Batch Found!!!\n"));
            	}
	} else {
            	iRet = INT_ERR;
            	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetOrgBatchInfo:: Call DBOLBatchTxnRelation:: GetBatchIdByRTAscOrder Invalid Txn Id!!!\n"));
ERRLOG("TxnOmtByUsRBT:: Call DBOLBatchTxnRelation:: GetBatchIdByRTAscOrder Invalid Txn Id!!!\n");
    	}
		
	// Check txn type
	if (iRet == PD_OK) {	
//DEBUGLOG(("GetOrgBatchInfo:: txn_type = [%s]\n",csTxnType));	
	
		// intra-balance-transfer, multi-batch
		if ((!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) && (iNumOfBatchId > 1)) {
                	hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                       	while (hBatchRec) {

/* batch_type */
				if (GetField_Char(hBatchRec,"batch_type",&cTmpBatchType)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_type = [%c]\n",iRecCnt,cTmpBatchType));
                                }

/* batch_sub_type */
                                if (GetField_Char(hBatchRec,"batch_sub_type",&cTmpBatchSubType)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_sub_type = [%c]\n",iRecCnt,cTmpBatchSubType));
                                }

/* batch_id */
                                if (GetField_CString(hBatchRec,"batch_id",&csTmpBatchId)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_id = [%s]\n",iRecCnt,csTmpBatchId));
                                }

                             	hBatchRec = RecordSet_GetNext(rBatchRecordSet);

				// Last Record
				if (!hBatchRec) {
					PutField_Char(hBatchInfo,"org_batch_type",cTmpBatchType);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_type = [%c]\n", cTmpBatchType));

					PutField_Char(hBatchInfo,"org_batch_sub_type",cTmpBatchSubType);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_sub_type = [%c]\n", cTmpBatchSubType));
				
					PutField_CString(hBatchInfo,"org_batch_id",csTmpBatchId);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_id = [%s]\n", csTmpBatchId));
				}

				iRecCnt++;
                    	}
		}	
		// hold-deposit, multi-batch
		else if ((!strcmp(csTxnType, PD_TXN_TYPE_HOLD_DEPOSIT)) && (iNumOfBatchId > 1)) {
			hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                       	while (hBatchRec) {

/* batch_type */
                                if (GetField_Char(hBatchRec,"batch_type",&cTmpBatchType)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_type = [%c]\n",iRecCnt,cTmpBatchType));
                                }

/* batch_sub_type */
                                if (GetField_Char(hBatchRec,"batch_sub_type",&cTmpBatchSubType)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_sub_type = [%c]\n",iRecCnt,cTmpBatchSubType));
                                }

/* batch_id */
                                if (GetField_CString(hBatchRec,"batch_id",&csTmpBatchId)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_id = [%s]\n",iRecCnt,csTmpBatchId));
                                }				

				if (!strcmp(csTmpBatchId, csSelectBatchId)) {
					PutField_Char(hBatchInfo,"org_batch_type",cTmpBatchType);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_type = [%c]\n", cTmpBatchType));

					PutField_Char(hBatchInfo,"org_batch_sub_type",cTmpBatchSubType);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_sub_type = [%c]\n", cTmpBatchSubType));
                    
					PutField_CString(hBatchInfo,"org_batch_id",csTmpBatchId);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_id = [%s]\n", csTmpBatchId));
		           	}

                             	hBatchRec = RecordSet_GetNext(rBatchRecordSet);
				
				iRecCnt++;
                      	}
		}
		// psp-settlement, single-batch/multi-batch	
		else if ((!strcmp(csTxnType, PD_TXN_TYPE_PSP_SETTLEMENT)) && (iNumOfBatchId > 0)) {
                       	hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                      	while (hBatchRec) {

/* batch_type */
                                if (GetField_Char(hBatchRec,"batch_type",&cTmpBatchType)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_type = [%c]\n",iRecCnt,cTmpBatchType));
                                }

/* batch_sub_type */
                                if (GetField_Char(hBatchRec,"batch_sub_type",&cTmpBatchSubType)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_sub_type = [%c]\n",iRecCnt,cTmpBatchSubType));
                                }
			
/* batch_id */
                                if (GetField_CString(hBatchRec,"batch_id",&csTmpBatchId)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_id = [%s]\n",iRecCnt,csTmpBatchId));
                                }
	
				// First Record
				if (iRecCnt == 0) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]first_record\n",iRecCnt));

                                        iDtlRet = PD_FALSE;

                                        iDtlRet = CheckVoidTxnIdValidPSPSettlement(csTmpBatchId, csTxnSeq, hContext);

                                        if (iDtlRet == PD_FALSE) {
DEBUGLOG(("GetOrgBatchInfo:: txn_id not allow to void/cancel\n"));
                                                iRet = INT_INVALID_TXN;
                                                PutField_Int(hContext,"internal_error",iRet);
                                                break;
                                        }
                                }

                                hBatchRec = RecordSet_GetNext(rBatchRecordSet);
	
				// Last Record
				if (!hBatchRec) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]last_record\n",iRecCnt));

                                        iDtlRet = PD_NOT_FOUND;

                                        iDtlRet = FindVoidBatchIdPSPSettlement(csTmpBatchId, csTxnSeq, csFoundBatchId, csFoundTxnSeq, hContext);

                                        if (iDtlRet == PD_FOUND) {
        					hash_init(hBatchTypeInfo,0);

						strcpy(csTmpBatchId, csFoundBatchId);

						// Get Batch Type Info
						iDtlRet = GetBatchTypeInfo(csTmpBatchId, hBatchTypeInfo, hContext);

						if (iDtlRet ==  PD_FOUND) {
/* batch_type */
        						if (GetField_Char(hBatchTypeInfo,"batch_type",&cTmpBatchType)) {
								PutField_Char(hBatchInfo,"org_batch_type",cTmpBatchType);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_type = [%c]\n", cTmpBatchType));
        						}

/* batch_sub_type */
        						if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cTmpBatchSubType)) {
								PutField_Char(hBatchInfo,"org_batch_sub_type",cTmpBatchSubType);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_sub_type = [%c]\n", cTmpBatchSubType));
        						}
						}

						PutField_CString(hBatchInfo,"org_batch_id",csTmpBatchId);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_id = [%s]\n", csTmpBatchId));

						hash_destroy(hBatchTypeInfo);
                                        } else {
DEBUGLOG(("GetOrgBatchInfo:: txn_id not allow to void/cancel\n"));
                                                iRet = INT_INVALID_TXN;
                                                PutField_Int(hContext,"internal_error",iRet);
                                                break;
                                        }
                                }

				iRecCnt++;
                  	}
		}
		// povider-charge, single-batch/multi-batch
		else if ((!strcmp(csTxnType, PD_TXN_TYPE_PROVIDER_CHARGE)) && (iNumOfBatchId > 0)) {
                       	hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                      	while (hBatchRec) {

/* batch_type */
                                if (GetField_Char(hBatchRec,"batch_type",&cTmpBatchType)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_type = [%c]\n",iRecCnt,cTmpBatchType));
                                }

/* batch_sub_type */
                                if (GetField_Char(hBatchRec,"batch_sub_type",&cTmpBatchSubType)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_sub_type = [%c]\n",iRecCnt,cTmpBatchSubType));
                                }

/* batch_id */
                                if (GetField_CString(hBatchRec,"batch_id",&csTmpBatchId)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_id = [%s]\n",iRecCnt,csTmpBatchId));
                                }

				// First Record
				if (iRecCnt == 0) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]first_record\n", iRecCnt));

                                     	iDtlRet = PD_FALSE;

                                     	iDtlRet = CheckVoidTxnIdValidProviderCharge(csTmpBatchId, csTxnSeq, hContext);

                                    	if (iDtlRet == PD_FALSE) {
DEBUGLOG(("GetOrgBatchInfo:: txn_id not allow to void/cancel\n"));
                                            	iRet = INT_INVALID_TXN;
                                             	PutField_Int(hContext,"internal_error",iRet);
                                              	break;
                                     	}
                           	}

                           	hBatchRec = RecordSet_GetNext(rBatchRecordSet);

				// Last Record
				if (!hBatchRec) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]last_record\n", iRecCnt));

                                  	iDtlRet = PD_NOT_FOUND;

                                    	iDtlRet = FindVoidBatchIdProviderCharge(csTmpBatchId, csTxnSeq, csFoundBatchId, csFoundTxnSeq, hContext);

                                     	if (iDtlRet == PD_FOUND) {
						hash_init(hBatchTypeInfo,0);
			
						strcpy(csTmpBatchId, csFoundBatchId);	

						// Get Batch Type Info
                                                iDtlRet = GetBatchTypeInfo(csTmpBatchId, hBatchTypeInfo, hContext);

						if (iDtlRet ==  PD_FOUND) {
/* batch_type */
                                                        if (GetField_Char(hBatchTypeInfo,"batch_type",&cTmpBatchType)) {
                                                                PutField_Char(hBatchInfo,"org_batch_type",cTmpBatchType);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_type = [%c]\n", cTmpBatchType));
                                                        }

/* batch_sub_type */
                                                        if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cTmpBatchSubType)) {
                                                                PutField_Char(hBatchInfo,"org_batch_sub_type",cTmpBatchSubType);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_sub_type = [%c]\n", cTmpBatchSubType));
                                                        }
                                                }

						PutField_CString(hBatchInfo,"org_batch_id",csTmpBatchId);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_id = [%s]\n", csTmpBatchId));
						
						hash_destroy(hBatchTypeInfo);
                                     	} else {
DEBUGLOG(("GetOrgBatchInfo:: txn_id not allow to void/cancel\n"));
                                              	iRet = INT_INVALID_TXN;
                                               	PutField_Int(hContext,"internal_error",iRet);
                                              	break;
                                     	}
                           	}

				iRecCnt++;
			}
		}
		// others cases
		else {
			// single-batch/multi-batch
			if (iNumOfBatchId > 0) {
                    		hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                     		while (hBatchRec) {

/* batch_type */
                                	if (GetField_Char(hBatchRec,"batch_type",&cTmpBatchType)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_type = [%c]\n",iRecCnt,cTmpBatchType));
                                	}

/* batch_sub_type */
                                	if (GetField_Char(hBatchRec,"batch_sub_type",&cTmpBatchSubType)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_sub_type = [%c]\n",iRecCnt,cTmpBatchSubType));
                                	}

/* batch_id */
                                	if (GetField_CString(hBatchRec,"batch_id",&csTmpBatchId)) {
DEBUGLOG(("GetOrgBatchInfo:: [%d]batch_id = [%s]\n",iRecCnt,csTmpBatchId));
                                	}

                             		hBatchRec = RecordSet_GetNext(rBatchRecordSet);
			
					// Last Record
					if (!hBatchRec) {
						PutField_Char(hBatchInfo,"org_batch_type",cTmpBatchType);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_type = [%c]\n", cTmpBatchType));

						PutField_Char(hBatchInfo,"org_batch_sub_type",cTmpBatchSubType);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_sub_type = [%c]\n", cTmpBatchSubType));
			
						PutField_CString(hBatchInfo,"org_batch_id",csTmpBatchId);
//DEBUGLOG(("GetOrgBatchInfo:: org_batch_id = [%s]\n", csTmpBatchId));
                               		}

					iRecCnt++;
				}
			}
		}
	}

	FREE_ME(hBatchTypeInfo);

	hash_destroy(hTmpBatchRec);
        FREE_ME(hTmpBatchRec);

        RecordSet_Destroy(rBatchRecordSet);
        FREE_ME(rBatchRecordSet);
	
	FREE_ME(csFoundTxnSeq);

DEBUGLOG(("GetOrgBatchInfo:: iRet = [%d]\n",iRet));
        return iRet;
}

int     CheckVoidTxnIdValidPSPSettlement(const char* csBatchId, const char* csTxnId, hash_t *hContext)
{
	int     iRet = PD_TRUE;

        int     iDtlRet = PD_OK;

	int	iIsVoidTxnCode = PD_FALSE;
	int	iIsOffsetTxnCode = PD_FALSE;
        int     iBatchIdRet = PD_BATCH_ID_INVALID;

	char    csNextBatchId[PD_TXN_SEQ_LEN + 1];
	char    csVoidBatchId[PD_TXN_SEQ_LEN + 1];
	char    csNextTxnId[PD_TXN_SEQ_LEN + 1];
        char    csLastTxnId[PD_TXN_SEQ_LEN + 1];

	hash_t  *hTxnCode;
        hTxnCode = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnCode,0);

/* batch_id */
DEBUGLOG(("CheckVoidTxnIdValidPSPSettlement:: batch_id = [%s]\n",csBatchId));
	
	// Get txn code type
	iDtlRet = GetTxnCodeInfo(csTxnId, hTxnCode, hContext);
	if (iDtlRet == PD_OK) {

		// is_void
		if (!GetField_Int(hTxnCode, "is_void", &iIsVoidTxnCode)) {
			iDtlRet = INT_ERR;
		}		

		// is_offset
		if (!GetField_Int(hTxnCode, "is_offset", &iIsOffsetTxnCode)) {
                        iDtlRet = INT_ERR;
                }
	}

	if (iDtlRet == PD_OK) {	
		
	 	// Check is void txn code or is offset txn code
		if ((iIsVoidTxnCode == PD_TRUE) || (iIsOffsetTxnCode == PD_TRUE)) {
			iBatchIdRet = PD_BATCH_ID_INVALID;
		} else {

			// Get last txn id in the batch
			iDtlRet = GetLastTxnIdByRTDescOrder(csBatchId, csLastTxnId, hContext);
			
			if (iDtlRet == PD_OK) {
				iDtlRet = PD_FOUND;

				// Get next batch by multi batch txn relation
                	        iDtlRet = GetNextBatchIdByMultiBatchTxnRelation(PD_BATCH_DESC_ORDER_LAST_REC, csBatchId, csLastTxnId, csNextBatchId, csNextTxnId, hContext);	

				if (iDtlRet == PD_FOUND) {				

					// Get next batch by batch relation
        	                        iDtlRet = GetNextBatchIdByBatchRelation(csNextBatchId, csLastTxnId, csVoidBatchId, hContext);
	
					if (iDtlRet == PD_FOUND) {		

						// Check is voided batch (Next Batch)
        	                        	iDtlRet = IsP2VoidedBatchId(csNextBatchId, hContext);
				
						if (iDtlRet == PD_TRUE) {

							// Check is voided batch
                                        		iDtlRet = IsP2VoidedBatchId(csBatchId, hContext);

                                        		if (iDtlRet == PD_TRUE) {
                                                		iBatchIdRet = PD_BATCH_ID_INVALID;
                                        		} else if (iDtlRet == PD_FALSE) {
                                                		iBatchIdRet = PD_BATCH_ID_VALID;
                                        		} else {
                                               	 		iRet = INT_ERR;
                                        		}
        	                     		} else if (iDtlRet == PD_FALSE) {
        	                        	     	iBatchIdRet = PD_BATCH_ID_INVALID;
        	                     		} else {
        	                        	      	iRet = INT_ERR;
        	                       		}
					} else if (iDtlRet == PD_NOT_FOUND) {
						iBatchIdRet = PD_BATCH_ID_INVALID;
					} else {
						iRet = INT_ERR;
					}
				} else if (iDtlRet == PD_NOT_FOUND) {

					// Check is voided batch
                	                iDtlRet = IsP2VoidedBatchId(csBatchId, hContext);

                	                if (iDtlRet == PD_TRUE) {
                	                        iBatchIdRet = PD_BATCH_ID_INVALID;
                	                } else if (iDtlRet == PD_FALSE) {
                	                        iBatchIdRet = PD_BATCH_ID_VALID;
                	                } else {
                	                        iRet = INT_ERR;
                	                }
                	        } else {
                	     		iRet = INT_ERR;
				}
			} else {
        	             	iRet = INT_ERR;
        	     	}
		}
        } else {
		iRet = INT_ERR;
	}

	if (iRet == INT_ERR) {
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("CheckVoidTxnIdValidPSPSettlement:: Internal Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::CheckVoidTxnIdValidPSPSettlement::Internal Error!!!\n");
	} else {
                if (iBatchIdRet == PD_BATCH_ID_VALID) {
                        iRet = PD_TRUE;
                } else {
                        iRet = PD_FALSE;
                }
	}

	hash_destroy(hTxnCode);
        FREE_ME(hTxnCode);

DEBUGLOG(("CheckVoidTxnIdValidPSPSettlement:: iRet = [%d]\n",iRet));
        return iRet;
}

int     FindVoidBatchIdPSPSettlement(const char* csBatchId, const char* csTxnId, char* csFoundBatchId, char* csFoundTxnId, hash_t *hContext)
{
	int     iRet = PD_FOUND;
        int     iDtlRet = PD_OK;

	int     iIsVoidTxnCode = PD_FALSE;
        int     iIsOffsetTxnCode = PD_FALSE;
        int     iBatchIdRet = PD_BATCH_ID_FINDING;

	int	iCnt = 0;

        char    *csTmpTxnId = (char*) malloc (64);
        char    csTmpBatchId[PD_TXN_SEQ_LEN + 1];

        strcpy(csFoundBatchId, csBatchId);
        sprintf(csFoundTxnId, "%s", csTxnId);

        strcpy(csTmpBatchId, csBatchId);
        sprintf(csTmpTxnId, "%s", csTxnId);

DEBUGLOG(("FindVoidBatchIdPSPSettlement:: batch_id = [%s], txn_id = [%s]\n", csBatchId, csTxnId));

	while ((iBatchIdRet == PD_BATCH_ID_FINDING) && (iRet != INT_ERR)) {

		hash_t  *hTxnCode;
        	hTxnCode = (hash_t*) malloc (sizeof(hash_t));
        	hash_init(hTxnCode,0);		

		// Get txn code type
        	iDtlRet = GetTxnCodeInfo(csTmpTxnId, hTxnCode, hContext);
        	if (iDtlRet == PD_OK) {

                	// is_void
                	if (!GetField_Int(hTxnCode, "is_void", &iIsVoidTxnCode)) {
                	        iDtlRet = INT_ERR;
                	}

                	// is_offset
                	if (!GetField_Int(hTxnCode, "is_offset", &iIsOffsetTxnCode)) {
                	        iDtlRet = INT_ERR;
                	}
        	}

		if (iDtlRet == PD_OK) {
		
			// Check is void txn code or is offset txn code
                	if ((iIsVoidTxnCode == PD_TRUE) || (iIsOffsetTxnCode == PD_TRUE)) {
                	        iBatchIdRet = PD_BATCH_ID_INVALID;
                	} else {		
                	    	iBatchIdRet = GetPrevBatchIdByMultiBatchTxnRelation(PD_BATCH_DESC_ORDER_LAST_REC, csTmpBatchId, csTmpTxnId, csFoundBatchId, csFoundTxnId, hContext);
DEBUGLOG(("FindVoidBatchIdPSPSettlement:: [%d]found_batch_id = [%s], found_txn_id = [%s]\n", iCnt, csFoundBatchId, csFoundTxnId));

                	    	strcpy(csTmpBatchId, csFoundBatchId);
                	      	sprintf(csTmpTxnId, "%s", csFoundTxnId);
               		}
		} else {
			iRet = INT_ERR;
		}

		iCnt++;

		hash_destroy(hTxnCode);
        	FREE_ME(hTxnCode);	
	}	
	
DEBUGLOG(("FindVoidBatchIdPSPSettlement:: iBatchIdRet = [%d]\n", iBatchIdRet));

	if (iRet == INT_ERR) {
DEBUGLOG(("FindVoidBatchIdPSPSettlement:: Internal Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::FindVoidBatchIdPSPSettlement::Internal Error!!!\n");
        } else {
                if (iBatchIdRet == PD_BATCH_ID_VALID) {
                        iRet = PD_FOUND;
                } else {
                        iRet = PD_NOT_FOUND;
                }
        }

        FREE_ME(csTmpTxnId);

DEBUGLOG(("FindVoidBatchIdPSPSettlement:: iRet = [%d]\n",iRet));
        return iRet;
}

int	CheckVoidTxnIdValidProviderCharge(const char* csBatchId, const char* csTxnId, hash_t *hContext)
{
	int     iRet = PD_TRUE;
	int     iDtlRet = PD_FOUND;
	int	iBatchSubTypeUndoRet = PD_TRUE;

        int     iIsVoidTxnCode = PD_FALSE;
        int     iIsOffsetTxnCode = PD_FALSE;
	int     iBatchIdRet = PD_BATCH_ID_FINDING;
        
	int	iCnt = 0;

	char    cBatchType;
	char    cBatchSubType;
	char    cPrevBatchType;
	char    cPrevBatchSubType;

	char    csTmpBatchId[PD_TXN_SEQ_LEN + 1];
        char    csTmpTxnId[PD_TXN_SEQ_LEN + 1];
	char    csTmpNextBatchId[PD_TXN_SEQ_LEN + 1];
	char    csNextBatchId[PD_TXN_SEQ_LEN + 1];
	char    csNextTxnId[PD_TXN_SEQ_LEN + 1];
	char    csPrevBatchId[PD_TXN_SEQ_LEN + 1];
	char    csPrevTxnId[PD_TXN_SEQ_LEN + 1];
	char    csLastTxnId[PD_TXN_SEQ_LEN + 1];

	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchTypeInfo,0);

        cBatchType = ' ';
        cBatchSubType = ' ';
        cPrevBatchType = ' ';
        cPrevBatchSubType = ' ';

	strcpy(csTmpBatchId, csBatchId);
	strcpy(csTmpTxnId, csTxnId);
	strcpy(csTmpNextBatchId, csBatchId);
	strcpy(csNextBatchId, csBatchId);
	strcpy(csNextTxnId, csTxnId);	
	strcpy(csPrevBatchId, csBatchId);
	strcpy(csPrevTxnId, csTxnId);	
	strcpy(csLastTxnId, csTxnId);

DEBUGLOG(("CheckVoidTxnIdValidProviderCharge:: batch_id = [%s], txn_id = [%s]\n", csBatchId, csTxnId));
//DEBUGLOG(("CheckVoidTxnIdValidProviderCharge:: next_batch_id = [%s], next_txn_id = [%s], last_txn_id = [%s]\n", csNextBatchId, csNextTxnId, csLastTxnId));

	while ((iBatchIdRet == PD_BATCH_ID_FINDING) && (iRet != INT_ERR)) {

		// Get Batch Type Info
        	iDtlRet = GetBatchTypeInfo(csTmpBatchId, hBatchTypeInfo, hContext);
		if (iDtlRet == PD_FOUND) {

/* batch_type */
			if (GetField_Char(hBatchTypeInfo,"batch_type",&cBatchType)) {
//DEBUGLOG(("CheckVoidTxnIdValidProviderCharge:: batch_type = [%c]\n", cBatchType));
			}

/* batch_sub_type */
			if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cBatchSubType)) {
//DEBUGLOG(("CheckVoidTxnIdValidProviderCharge:: batch_sub_type = [%c]\n", cBatchSubType));
			}
		}

/* batch_id */
DEBUGLOG(("CheckVoidTxnIdValidProviderCharge:: [%d]batch_id = [%s]\n", iCnt, csTmpBatchId));
	
		if (iDtlRet == PD_FOUND) {

          		iDtlRet = PD_OK;

			hash_t  *hTxnCode;
	                hTxnCode = (hash_t*) malloc (sizeof(hash_t));
	                hash_init(hTxnCode,0);

			// Get txn code type
                	iDtlRet = GetTxnCodeInfo(csTmpTxnId, hTxnCode, hContext);
                	if (iDtlRet == PD_OK) {

                        	// is_void
                        	if (!GetField_Int(hTxnCode, "is_void", &iIsVoidTxnCode)) {
                                	iDtlRet = INT_ERR;
                        	}

                        	// is_offset
                        	if (!GetField_Int(hTxnCode, "is_offset", &iIsOffsetTxnCode)) {
                                	iDtlRet = INT_ERR;
                        	}
                	}

			hash_destroy(hTxnCode);
        		FREE_ME(hTxnCode);

			if (iDtlRet == PD_OK) {

				// Check if Batch Sub Type is Undo
	             		if ((cBatchSubType == PD_GENERAL_UNDO_RECON)
        	            	    || (cBatchSubType == PD_GENERAL_UNDO_BAL_TRF)
			    	    || (cBatchSubType == PD_COMBINE_UNDO_RECON)
           			)
              			{
					// Check is void txn code
                	     		if (iIsVoidTxnCode == PD_TRUE) {
                	             		iBatchIdRet = PD_BATCH_ID_INVALID;
                	      		} else if (iIsVoidTxnCode == PD_FALSE) {

						// Check is multi batch
						iDtlRet = IsMultiBatchTxnId(csTmpTxnId, hContext);

						if (iDtlRet == PD_TRUE) {
							iDtlRet = PD_FOUND;		

							// Get next batch by regen txn relation
							iDtlRet = GetNextBatchIdByRegenTxnRelation(PD_BATCH_DESC_ORDER_LAST_REC, csTmpBatchId, csTmpTxnId, csNextBatchId, csNextTxnId, hContext);

							if (iDtlRet == PD_FOUND) {
DEBUGLOG(("CheckVoidTxnIdValidProviderCharge:: [%d]next_batch_id = [%s], next_txn_id = [%s]\n", iCnt, csNextBatchId, csNextTxnId));

                                        			strcpy(csTmpBatchId, csNextBatchId);
                                        			strcpy(csTmpTxnId, csNextTxnId);

								iBatchIdRet = PD_BATCH_ID_FINDING;
                                        		} else if (iDtlRet == PD_NOT_FOUND) {
                                                		iBatchIdRet = PD_BATCH_ID_INVALID;
                                        		} else {
                                                		iRet = INT_ERR;
                                        		}
                       	 			} else if (iDtlRet == PD_FALSE) {
				
							while ((iBatchSubTypeUndoRet == PD_TRUE) && (iRet != INT_ERR)) {
								iDtlRet = PD_FOUND;

								// Get prev batch by regen txn relation
								iDtlRet = GetPrevBatchIdByRegenTxnRelation(PD_BATCH_DESC_ORDER_LAST_REC, csTmpBatchId, csTmpTxnId, csPrevBatchId, csPrevTxnId, hContext);						
								if (iDtlRet == PD_FOUND) {
DEBUGLOG(("CheckVoidTxnIdValidProviderCharge:: [%d]prev_batch_id = [%s], prev_txn_id = [%s]\n", iCnt, csPrevBatchId, csPrevTxnId));
	
									strcpy(csTmpBatchId, csPrevBatchId);
                	                                        	strcpy(csTmpTxnId, csPrevTxnId);

									// Get Batch Type Info
                							iDtlRet = GetBatchTypeInfo(csPrevBatchId, hBatchTypeInfo, hContext);

                							if (iDtlRet == PD_FOUND) {

/* batch_type */
                        							if (GetField_Char(hBatchTypeInfo,"batch_type",&cPrevBatchType)) {
//DEBUGLOG(("CheckVoidTxnIdValidProviderCharge:: [%d]prev_batch_type = [%c]\n", iCnt, cPrevBatchType));
                        							}

/* batch_sub_type */
                        							if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cPrevBatchSubType)) {
//DEBUGLOG(("CheckVoidTxnIdValidProviderCharge:: [%d]prev_batch_sub_type = [%c]\n", iCnt, cPrevBatchSubType));
                        							}
                							}
					
									if ((cPrevBatchSubType != PD_GENERAL_UNDO_RECON)
                                                    			    && (cPrevBatchSubType != PD_GENERAL_UNDO_BAL_TRF)
                                                    			    && (cPrevBatchSubType != PD_COMBINE_UNDO_RECON)
                                                			)
                                                			{
										iBatchSubTypeUndoRet = PD_FALSE;

										iDtlRet = PD_TRUE;
									
										// Check is voided batch								
										iDtlRet = IsP2VoidedBatchId(csPrevBatchId, hContext);
	
	                                                			if (iDtlRet == PD_TRUE) {
	                                                        			iBatchIdRet = PD_BATCH_ID_INVALID;
	                                                			} else if (iDtlRet == PD_FALSE) {
	                                                        			iBatchIdRet = PD_BATCH_ID_VALID;
	                                                			} else {
	                                                        			iRet = INT_ERR;
	                                                			}	
									}								
								} else {
	                                                        	iRet = INT_ERR;
	                                                	}
							}
						} else {
							iRet = INT_ERR;
						}
					}
				} else {
					// Check is offset txn code
                    			if (iIsOffsetTxnCode == PD_TRUE) {
                           			iBatchIdRet = PD_BATCH_ID_INVALID;
					} else if (iIsOffsetTxnCode == PD_FALSE) {
						iDtlRet = PD_OK;

						// Get last txn id in the batch
						iDtlRet = GetLastTxnIdByRTDescOrder(csTmpBatchId, csLastTxnId, hContext);			
DEBUGLOG(("CheckVoidTxnIdValidProviderCharge:: [%d]batch_id = [%s], last_txn_id = [%s]\n", iCnt, csTmpBatchId, csLastTxnId));

						if (iDtlRet == PD_OK) {
                                			iDtlRet = PD_FOUND;

							// Check is multi batch
                                			iDtlRet = IsMultiBatchTxnId(csLastTxnId, hContext);
	
        	                        		if (iDtlRet == PD_TRUE) {
								iDtlRet = PD_FOUND;
	
								// Get next batch by regen txn relation
								iDtlRet = GetNextBatchIdByRegenTxnRelation(PD_BATCH_DESC_ORDER_LAST_REC, csTmpBatchId, csLastTxnId, csNextBatchId, csNextTxnId, hContext);
	
                                        			if (iDtlRet == PD_FOUND) {

									// Get next batch by batch relation
									iDtlRet = GetNextBatchIdByBatchRelation(csTmpBatchId, csLastTxnId, csTmpNextBatchId, hContext); 
						
									if (iDtlRet == PD_FOUND) {
										iDtlRet = PD_TRUE;				

										// Check P2Voided Batch Id
                                        					iDtlRet = IsP2VoidedBatchId(csTmpBatchId, hContext);
                                        					if (iDtlRet == PD_TRUE) {
                                                					iBatchIdRet = PD_BATCH_ID_INVALID;
                                        					} else if (iDtlRet == PD_FALSE) {
DEBUGLOG(("CheckVoidTxnIdValidProviderCharge:: [%d]next_batch_id = [%s], next_txn_id = [%s]\n", iCnt, csNextBatchId, csNextTxnId));
	
        	                                                                        strcpy(csTmpBatchId, csNextBatchId);
                	                                                                strcpy(csTmpTxnId, csNextTxnId);

                        	                                                        iBatchIdRet = PD_BATCH_ID_FINDING;
                        	                				} else {
                        	                        				iRet = INT_ERR;
                        	        					}
									} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("CheckVoidTxnIdValidProviderCharge:: [%d]next_batch_id = [%s], next_txn_id = [%s]\n", iCnt, csNextBatchId, csNextTxnId));
	
        	                                                               	strcpy(csTmpBatchId, csNextBatchId);
                	                                                    	strcpy(csTmpTxnId, csNextTxnId);

                        	                                            	iBatchIdRet = PD_BATCH_ID_FINDING;
                                	        			} else {
                                        	 				iRet = INT_ERR;
									}
                                        			} else if (iDtlRet == PD_NOT_FOUND) {
                                        			        iBatchIdRet = PD_BATCH_ID_INVALID;
                                        			} else {
                                        			        iRet = INT_ERR;
                                        			}
                           				} else if (iDtlRet == PD_FALSE) {

								// Check is voided batch
								iDtlRet = IsP2VoidedBatchId(csTmpBatchId, hContext);
                                        
								if (iDtlRet == PD_TRUE) {
                                        			        iBatchIdRet = PD_BATCH_ID_INVALID;
                                        			} else if (iDtlRet == PD_FALSE) {

									// Check Input Txn Id
                                					iDtlRet = IsInputTxnId(csTmpBatchId, csLastTxnId, hContext);
                                					if (iDtlRet == PD_TRUE) {
                                        					iBatchIdRet = PD_BATCH_ID_INVALID;
                                					} else if (iDtlRet == PD_FALSE) {
                                        					iBatchIdRet = PD_BATCH_ID_VALID;
                               		 				} else {
                                        					iRet = INT_ERR;
                                					}						
                                        			} else {
                                        			        iRet = INT_ERR;
                                        			}					
                                			} else {
                                 			       iRet = INT_ERR;
                                			}
						} else {
							iRet = INT_ERR;
						}
                      			}
				}
			} else {
				iRet = INT_ERR;
			}
		} else {
			iRet = INT_ERR;
		}
		
		iCnt++;
	}

        if (iRet == INT_ERR) {
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("CheckVoidTxnIdValidProviderCharge:: Batch Sub Type Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT::Batch Sub Type Not Found!!!\n");
	} else {
                if (iBatchIdRet == PD_BATCH_ID_VALID) {
                        iRet = PD_TRUE;
                } else {
                        iRet = PD_FALSE;
                }
        }

	hash_destroy(hBatchTypeInfo);
        FREE_ME(hBatchTypeInfo);

DEBUGLOG(("CheckVoidTxnIdValidProviderCharge:: iRet = [%d]\n",iRet));
        return iRet;
}

int	FindVoidBatchIdProviderCharge(const char* csBatchId, const char* csTxnId, char* csFoundBatchId, char* csFoundTxnId, hash_t *hContext)
{
	int     iRet = PD_FOUND;
	int	iDtlRet = PD_FOUND;

	int     iIsVoidTxnCode = PD_FALSE;
        int     iIsOffsetTxnCode = PD_FALSE;
	int	iBatchIdRet = PD_BATCH_ID_FINDING;	

	int	iCnt = 0;

	char    cBatchType;
        char    cBatchSubType;
	char    cFoundBatchType;
        char    cFoundBatchSubType;

	char    *csTmpTxnId = (char*) malloc (64);
	char    csTmpBatchId[PD_TXN_SEQ_LEN + 1];

	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchTypeInfo,0);

	hash_t  *hTxnCode;
        hTxnCode = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnCode,0);

	cBatchType = ' ';
	cBatchSubType = ' ';
	cFoundBatchType = ' ';
        cFoundBatchSubType = ' ';

	strcpy(csFoundBatchId, csBatchId);
        sprintf(csFoundTxnId, "%s", csTxnId);

	strcpy(csTmpBatchId, csBatchId);
        sprintf(csTmpTxnId, "%s", csTxnId);	

DEBUGLOG(("FindVoidBatchIdProviderCharge:: batch_id = [%s], txn_id = [%s]\n", csBatchId, csTxnId));

	while ((iBatchIdRet == PD_BATCH_ID_FINDING) && (iRet != INT_ERR)) {
        	hash_init(hBatchTypeInfo,0);

		// Get Batch Sub Type
		iDtlRet = GetBatchTypeInfo(csTmpBatchId, hBatchTypeInfo, hContext);

		if (iDtlRet == PD_FOUND) {

/* batch_type */
        		if (GetField_Char(hBatchTypeInfo,"batch_type",&cBatchType)) {
//DEBUGLOG(("FindVoidBatchIdProviderCharge:: batch_type = [%c]\n", cBatchType));
        		}

/* batch_sub_type */
        		if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cBatchSubType)) {
//DEBUGLOG(("FindVoidBatchIdProviderCharge:: batch_sub_type = [%c]\n", cBatchSubType));
        		}
		}

		hash_destroy(hBatchTypeInfo);

		if (iDtlRet == PD_FOUND) {

			iDtlRet = PD_OK;
			
			hash_t  *hTxnCode;
                        hTxnCode = (hash_t*) malloc (sizeof(hash_t));
                        hash_init(hTxnCode,0);
			
			// Get txn code type
                        iDtlRet = GetTxnCodeInfo(csTmpTxnId, hTxnCode, hContext);
                        if (iDtlRet == PD_OK) {

                                // is_void
                                if (!GetField_Int(hTxnCode, "is_void", &iIsVoidTxnCode)) {
                                        iDtlRet = INT_ERR;
                                }

                                // is_offset
                                if (!GetField_Int(hTxnCode, "is_offset", &iIsOffsetTxnCode)) {
                                        iDtlRet = INT_ERR;
                                }
                        }

                        hash_destroy(hTxnCode);
                        FREE_ME(hTxnCode);

			if (iDtlRet == PD_OK) {

				// Check if Batch Sub Type is Undo
				if ((cBatchSubType == PD_GENERAL_UNDO_RECON)
				    || (cBatchSubType == PD_GENERAL_UNDO_BAL_TRF)
				    || (cBatchSubType == PD_COMBINE_UNDO_RECON)
				)
				{
					// Check is void txn code
					if (iIsVoidTxnCode == PD_TRUE) {
						iBatchIdRet = PD_BATCH_ID_INVALID;
					} else if (iIsVoidTxnCode == PD_FALSE) {
						iDtlRet = PD_FOUND;					

						iDtlRet = GetPrevBatchIdByRegenTxnRelation(PD_BATCH_DESC_ORDER_FIRST_REC, csTmpBatchId, csTmpTxnId, csFoundBatchId, csFoundTxnId, hContext);	
DEBUGLOG(("FindVoidBatchIdProviderCharge:: [%d]found_batch_id = [%s], found_txn_id = [%s]\n", iCnt, csFoundBatchId, csFoundTxnId));
				
						strcpy(csTmpBatchId, csFoundBatchId);
                       		 		sprintf(csTmpTxnId, "%s", csFoundTxnId);
					
						if (iDtlRet == PD_FOUND) {
							iBatchIdRet = PD_BATCH_ID_FINDING;
						} else if (iDtlRet == PD_NOT_FOUND) {
							iBatchIdRet = PD_BATCH_ID_INVALID;
						} else {
							iRet = INT_ERR;
						}
					}			
				} else {
					// Check is offset txn code
					if (iIsOffsetTxnCode == PD_TRUE) {
                        	                iBatchIdRet = PD_BATCH_ID_INVALID;
                        	        } else if (iIsOffsetTxnCode == PD_FALSE) { 
						iBatchIdRet = GetPrevBatchIdByMultiBatchTxnRelation(PD_BATCH_DESC_ORDER_LAST_REC, csTmpBatchId, csTmpTxnId, csFoundBatchId, csFoundTxnId, hContext);
DEBUGLOG(("FindVoidBatchIdProviderCharge:: [%d]found_batch_id = [%s], found_txn_id = [%s]\n", iCnt, csFoundBatchId, csFoundTxnId));
					
						strcpy(csTmpBatchId, csFoundBatchId);
                        	                sprintf(csTmpTxnId, "%s", csFoundTxnId);

						// Check is most previous batch id
						if (iBatchIdRet == PD_BATCH_ID_FINDING) {
							iDtlRet = PD_FOUND;

							hash_init(hBatchTypeInfo,0);

               	 					// Get Batch Sub Type
                					iDtlRet = GetBatchTypeInfo(csFoundBatchId, hBatchTypeInfo, hContext);

                					if (iDtlRet == PD_FOUND) {

/* batch_type */
                        					if (GetField_Char(hBatchTypeInfo,"batch_type",&cFoundBatchType)) {
//DEBUGLOG(("FindVoidBatchIdProviderCharge:: [%d]found_batch_type = [%c]\n", iCnt, cFoundBatchType));
                        					}

/* batch_sub_type */
                        					if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cFoundBatchSubType)) {
//DEBUGLOG(("FindVoidBatchIdProviderCharge:: [%d]found_batch_sub_type = [%c]\n", iCnt, cFoundBatchSubType));
                        					}
                					}

                					hash_destroy(hBatchTypeInfo);					 
		
							if ((cFoundBatchSubType != PD_GENERAL_UNDO_RECON)
                	            		  	    && (cFoundBatchSubType != PD_GENERAL_UNDO_BAL_TRF)
                	            			    && (cFoundBatchSubType != PD_COMBINE_UNDO_RECON)
                	        			)
							{
								iBatchIdRet = PD_BATCH_ID_VALID;	
							}
						}
					}		
				}
			} else {
                        	iRet = INT_ERR;
                	}
		} else {
			iRet = INT_ERR;
		}

		iCnt++;
	} 

DEBUGLOG(("FindVoidBatchIdProviderCharge:: iBatchIdRet = [%d]\n", iBatchIdRet));

	if (iRet == INT_ERR) {
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("FindVoidBatchIdProviderCharge:: Batch Sub Type Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT::Batch Sub Type Not Found!!!\n");
	} else {
		if (iBatchIdRet == PD_BATCH_ID_VALID) {
			iRet = PD_FOUND;
		} else {
			iRet = PD_NOT_FOUND;
		}
	} 

	FREE_ME(csTmpTxnId);

        FREE_ME(hBatchTypeInfo);

DEBUGLOG(("FindVoidBatchIdProviderCharge:: iRet = [%d]\n",iRet));
        return iRet;        
}

int	GetBatchTypeInfo(const char* csBatchId, hash_t *hBatchTypeInfo, hash_t *hContext)
{
	int     iRet = PD_NOT_FOUND;

	char	cTmp;

        hash_t  *hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

	cTmp = ' ';

        PutField_CString(hTmpRec,"batch_id",csBatchId);

DEBUGLOG(("GetBatchTypeInfo:: Call DBOLBatchTxnRelation:: GetBatchTypeInfo [%s]\n", csBatchId));
        DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetBatchTypeInfo");
        iRet = (unsigned long)(*DBObjPtr)(hTmpRec);
        if (iRet == PD_FOUND) {
		
/* batch_type */
		if (GetField_Char(hTmpRec, "batch_type", &cTmp)) {   
DEBUGLOG(("GetBatchTypeInfo:: Call DBOLBatchTxnRelation:: batch_type = [%c]\n", cTmp));
			PutField_Char(hBatchTypeInfo,"batch_type", cTmp);
		}

/* batch_sub_type */
		if (GetField_Char(hTmpRec, "batch_sub_type", &cTmp)) {
DEBUGLOG(("GetBatchTypeInfo:: Call DBOLBatchTxnRelation:: batch_sub_type = [%c]\n", cTmp));
			PutField_Char(hBatchTypeInfo,"batch_sub_type", cTmp);
                }
    
	} else if (iRet == PD_NOT_FOUND) {
DEBUGLOG(("GetBatchTypeInfo:: Call DBOLBatchTxnRelation:: Batch Type Info Not Found!!!\n"));
        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetBatchTypeInfo:: Call DBOLBatchTxnRelation:: Batch Type Info Error!!!\n"));
ERRLOG("TxnOmtByUsRBT::GetBatchTypeInfo::Call DBOLBatchTxnRelation:: Batch Type Info Error!!!\n");
        }

        hash_destroy(hTmpRec);
        FREE_ME(hTmpRec);

DEBUGLOG(("GetBatchTypeInfo:: iRet = [%d]\n",iRet));
        return iRet;
}	

int     GetPrevBatchIdByRegenTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csPrevBatchId, char* csPrevTxnId, hash_t *hContext)
{
	int     iRet = PD_FOUND;
	int     iDtlRet = PD_OK;

	char	*csTmp = NULL;

        hash_t  	*hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

        hash_t  	*hTmpBatchRec;
        hTmpBatchRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpBatchRec,0);

	hash_t  	*hRec = NULL;
        recordset_t     *rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	hash_t          *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rBatchRecordSet,0);

        PutField_Char(hTmpRec,"party_type",PD_TYPE_PSP);
        PutField_CString(hTmpRec,"p1_txn_id",csTxnId);
        PutField_Char(hTmpRec,"txn_level",PD_TXN_LEVEL);
        PutField_Char(hTmpRec,"relation_type",PD_REL_REGEN);

DEBUGLOG(("GetPrevBatchIdByRegenTxnRelation:: Call DBOLTxnRelation:: GetP2TxnId\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","GetP2TxnId");
        iRet = (unsigned long)(*DBObjPtr)(hTmpRec,rRecordSet);
        if (iRet == PD_FOUND) {
		
		hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {

			if (GetField_CString(hRec, "p2_txn_id", &csTmp)) {
				sprintf(csPrevTxnId, "%s", csTmp);
DEBUGLOG(("GetPrevBatchIdByRegenTxnRelation:: Call DBOLTxnRelation:: p2_txn_id = [%s]\n", csPrevTxnId));
                		break;
			}
		
			hRec = RecordSet_GetNext(rRecordSet);
		}

		PutField_Char(hTmpBatchRec,"txn_level",PD_TXN_LEVEL);
	        PutField_CString(hTmpBatchRec,"txn_id",csPrevTxnId);

DEBUGLOG(("GetPrevBatchIdByRegenTxnRelation:: Call DBOLBatchTxnRelation:: GetBatchId\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetBatchId");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTmpBatchRec,rBatchRecordSet);
                if (iDtlRet == PD_OK) {

                        hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                        while (hBatchRec) {		

				if (GetField_CString(hBatchRec, "batch_id", &csTmp)) {
					strcpy(csPrevBatchId, csTmp);				
DEBUGLOG(("GetPrevBatchIdByRegenTxnRelation:: Call DBOLBatchTxnRelation:: batch_id = [%s]\n", csPrevBatchId));
					if (iBatchRTDesOrder == PD_BATCH_DESC_ORDER_FIRST_REC) {
						break;
					}
                        	}

				hBatchRec = RecordSet_GetNext(rBatchRecordSet);
			}

		} else {
                	iRet = INT_ERR;
                	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetPrevBatchIdByRegenTxnRelation:: Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT::GetPrevBatchIdByRegenTxnRelation:: Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n");
        	}

        } else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("GetPrevBatchIdByRegenTxnRelation:: Call DBOLTxnRelation:: Txn Id Not Found!!!\n"));
        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetPrevBatchIdByRegenTxnRelation:: Call DBOLTxnRelation:: Txn Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT:: GetPrevBatchIdByRegenTxnRelation:: Call DBOLTxnRelation:: Txn Id Error!!!\n");
        }

        hash_destroy(hTmpRec);
        FREE_ME(hTmpRec);

        hash_destroy(hTmpBatchRec);
        FREE_ME(hTmpBatchRec);

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

	RecordSet_Destroy(rBatchRecordSet);
        FREE_ME(rBatchRecordSet);

DEBUGLOG(("GetPrevBatchIdByRegenTxnRelation:: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetNextBatchIdByRegenTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csNextBatchId, char* csNextTxnId, hash_t *hContext)
{
	int     iRet = PD_FOUND;
	int     iDtlRet = PD_OK;

	char	*csTmp = NULL;

        hash_t  	*hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

        hash_t  	*hTmpBatchRec;
        hTmpBatchRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpBatchRec,0);

	hash_t  	*hRec = NULL;
        recordset_t     *rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

	hash_t          *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rBatchRecordSet,0);

        PutField_Char(hTmpRec,"party_type",PD_TYPE_PSP);
        PutField_CString(hTmpRec,"p2_txn_id",csTxnId);
        PutField_Char(hTmpRec,"txn_level",PD_TXN_LEVEL);
        PutField_Char(hTmpRec,"relation_type",PD_REL_REGEN);

DEBUGLOG(("GetNextBatchIdByRegenTxnRelation:: Call DBOLTxnRelation:: GetP1TxnId\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","GetP1TxnId");
        iRet = (unsigned long)(*DBObjPtr)(hTmpRec,rRecordSet);
        if (iRet == PD_FOUND) {
		
		hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {

			if (GetField_CString(hRec, "p1_txn_id", &csTmp)) {
				strcpy(csNextTxnId, csTmp);
DEBUGLOG(("GetNextBatchIdByRegenTxnRelation:: Call DBOLTxnRelation:: p1_txn_id = [%s]\n", csNextTxnId));
                		break;
			}
		
			hRec = RecordSet_GetNext(rRecordSet);
		}

		PutField_Char(hTmpBatchRec,"txn_level",PD_TXN_LEVEL);
	        PutField_CString(hTmpBatchRec,"txn_id",csNextTxnId);

DEBUGLOG(("GetNextBatchIdByRegenTxnRelation:: Call DBOLBatchTxnRelation:: GetBatchId\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetBatchId");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTmpBatchRec,rBatchRecordSet);
                if (iDtlRet == PD_OK) {

                        hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                        while (hBatchRec) {		

				if (GetField_CString(hBatchRec, "batch_id", &csTmp)) {
					strcpy(csNextBatchId, csTmp);
DEBUGLOG(("GetNextBatchIdByRegenTxnRelation:: Call DBOLBatchTxnRelation:: batch_id = [%s]\n", csNextBatchId));
					if (iBatchRTDesOrder == PD_BATCH_DESC_ORDER_FIRST_REC) {
						break;
					}
                        	}

				hBatchRec = RecordSet_GetNext(rBatchRecordSet);
			}

		} else {
                	iRet = INT_ERR;
                	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetNextBatchIdByRegenTxnRelation:: Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT:: GetNextBatchIdByRegenTxnRelation:: Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n");
        	}

        } else if (iRet == PD_NOT_FOUND) {
DEBUGLOG(("GetNextBatchIdByRegenTxnRelation:: Call DBOLTxnRelation:: Txn Id Not Found!!!\n"));
        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetNextBatchIdByRegenTxnRelation:: Call DBOLTxnRelation:: Txn Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT:: GetNextBatchIdByRegenTxnRelation:: Call DBOLTxnRelation:: Txn Id Error!!!\n");
        }

        hash_destroy(hTmpRec);
        FREE_ME(hTmpRec);

        hash_destroy(hTmpBatchRec);
        FREE_ME(hTmpBatchRec);

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

	RecordSet_Destroy(rBatchRecordSet);
        FREE_ME(rBatchRecordSet);

DEBUGLOG(("GetNextBatchIdByRegenTxnRelation:: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetPrevBatchIdByMultiBatchTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csPrevBatchId, char* csPrevTxnId, hash_t *hContext)
{
	int	iRet = PD_BATCH_ID_FINDING;
	int	iDtlRet = PD_OK;

	int	iCnt = 0;

	char 	*csTmpBatchId = NULL;

        hash_t          *hTmpBatchRec;
        hTmpBatchRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpBatchRec,0);

        hash_t          *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet = (recordset_t *)malloc (sizeof(recordset_t));

      	PutField_Char(hTmpBatchRec,"txn_level",PD_TXN_LEVEL);
      	PutField_CString(hTmpBatchRec,"txn_id",csTxnId);

DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation:: Call DBOLBatchTxnRelation:: GetBatchId\n"));
      	recordset_init(rBatchRecordSet,0);
	
	DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetBatchId");
       	iDtlRet = (unsigned long)(*DBObjPtr)(hTmpBatchRec,rBatchRecordSet);
        if (iDtlRet == PD_OK) {

           	hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
             	while (hBatchRec) {

                    	if (GetField_CString(hBatchRec, "batch_id", &csTmpBatchId)) {
DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation:: Call DBOLBatchTxnRelation:: batch_id = [%s]\n", csTmpBatchId));
				strcpy(csPrevBatchId,csTmpBatchId);
				if (iBatchRTDesOrder == PD_BATCH_DESC_ORDER_FIRST_REC) {
                              		break;
                             	}
                     	}

			iCnt++;		

                      	hBatchRec = RecordSet_GetNext(rBatchRecordSet);
             	}
		
		RecordSet_Destroy(rBatchRecordSet);
	
DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation:: num_of_batch_id = [%d]\n", iCnt));
		iNumOfBatchId = iCnt;	

		// Check Multi Batch Id	
		if (iCnt == 1) {
			iDtlRet = PD_TRUE;

			// Check P2Voided Batch Id
			iDtlRet = IsP2VoidedBatchId(csBatchId, hContext);
                        if (iDtlRet == PD_TRUE) {
                        	iRet = PD_BATCH_ID_INVALID;  
                    	} else if (iDtlRet == PD_FALSE) {
                     		
				// Check Input Txn Id
                                iDtlRet = IsInputTxnId(csBatchId, csTxnId, hContext);                     		
				if (iDtlRet == PD_TRUE) {
					iRet = PD_BATCH_ID_INVALID;
				} else if (iDtlRet == PD_FALSE) {
					iRet = PD_BATCH_ID_VALID;
				} else {
                                	iRet = iDtlRet;
                       	 	}					
			} else {
                              	iRet = iDtlRet;
                       	}

		} else if ((iCnt > 1) && (strcmp(csBatchId, csPrevBatchId))){
 			iDtlRet = PD_OK;
			iCnt = 0;

DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation:: Call DBOLBatchRelation:: GetBatchIdByOrgBatchId\n"));
	       		recordset_init(rBatchRecordSet,0);
        
        		DBObjPtr = CreateObj(DBPtr, "DBOLBatchRelation","GetBatchIdByOrgBatchId");
        		iDtlRet = (unsigned long)(*DBObjPtr)(csPrevBatchId,rBatchRecordSet);
        		if (iDtlRet == PD_OK) {

				hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                		while (hBatchRec) {

                        		if (GetField_CString(hBatchRec, "batch_id", &csTmpBatchId)) {
DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation:: Call DBOLBatchRelation:: batch_id = [%S]\n", csTmpBatchId));
                               	 		break;
                        		}

					iCnt++;					

                        		hBatchRec = RecordSet_GetNext(rBatchRecordSet);
                		}

                		RecordSet_Destroy(rBatchRecordSet);

				if (iCnt == 0) {
					if (!strcmp(csTxnType, PD_TXN_TYPE_PSP_SETTLEMENT)) {
						iRet = PD_BATCH_ID_VALID;
					} 
				} else {
					iDtlRet = PD_TRUE;

					// Check P2Voided Batch Id
                        		iDtlRet = IsP2VoidedBatchId(csPrevBatchId, hContext);
                        		if (iDtlRet == PD_TRUE) {
                                		iRet = PD_BATCH_ID_INVALID;
                        		} else if (iDtlRet == PD_FALSE) {
						if (!strcmp(csTxnType, PD_TXN_TYPE_PSP_SETTLEMENT)) {
							iRet = PD_BATCH_ID_VALID;
						}
                                	} else {
                                	        iRet = iDtlRet;
                                	}
				}
			
			} else {
				iRet = INT_ERR;
                		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation:: Call DBOLBatchRelation:: Batch Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT:: GetPrevBatchIdByMultiBatchTxnRelation:: Call DBOLBatchRelation:: Batch Id Error!!!\n");
			}
		}
       	} else {
             	iRet = INT_ERR;
               	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation:: Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT:: GetPrevBatchIdByMultiBatchTxnRelation:: Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n");
       	}	

	hash_destroy(hTmpBatchRec);
        FREE_ME(hTmpBatchRec);

        FREE_ME(rBatchRecordSet);

DEBUGLOG(("GetPrevBatchIdByMultiBatchTxnRelation:: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetNextBatchIdByMultiBatchTxnRelation(const int iBatchRTDesOrder, const char* csBatchId, const char* csTxnId, char* csNextBatchId, char* csNextTxnId, hash_t *hContext)
{
	int     iRet = PD_FOUND;
	int     iDtlRet = PD_OK;

        int     iCnt = 0;

        char    *csTmpBatchId = NULL;

        hash_t          *hTmpBatchRec;
        hTmpBatchRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpBatchRec,0);

        hash_t          *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        
	PutField_Char(hTmpBatchRec,"txn_level",PD_TXN_LEVEL);
        PutField_CString(hTmpBatchRec,"txn_id",csTxnId);

DEBUGLOG(("GetNextBatchIdByMultiBatchTxnRelation:: Call DBOLBatchTxnRelation:: GetBatchIdByRTAscOrder\n"));
        recordset_init(rBatchRecordSet,0);

        DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetBatchIdByRTAscOrder");
        iDtlRet = (unsigned long)(*DBObjPtr)(hTmpBatchRec,rBatchRecordSet);
        if (iDtlRet == PD_OK) {
		
		hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                while (hBatchRec) {

                        if (GetField_CString(hBatchRec, "batch_id", &csTmpBatchId)) {
DEBUGLOG(("GetNextBatchIdByMultiBatchTxnRelation:: Call DBOLBatchTxnRelation:: batch_id = [%s]\n", csTmpBatchId));
                                strcpy(csNextBatchId,csTmpBatchId);
				if (iBatchRTDesOrder == PD_BATCH_DESC_ORDER_FIRST_REC) {
                                	break;
				}
                        }

                        iCnt++;

                        hBatchRec = RecordSet_GetNext(rBatchRecordSet);
                }

                RecordSet_Destroy(rBatchRecordSet);

DEBUGLOG(("GetNextBatchIdByMultiBatchTxnRelation:: num_of_batch_id = [%d]\n", iCnt));

		// Check Multi Batch Id
		if (iCnt == 1) {
                        iRet = PD_NOT_FOUND;
		} else if ((iCnt > 1) && (strcmp(csBatchId, csNextBatchId))){
			iRet = PD_FOUND;
		}
	} else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetNextBatchIdByMultiBatchTxnRelation:: Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT:: GetNextBatchIdByMultiBatchTxnRelation:: Call DBOLBatchTxnRelation:: Batch Id Not Found!!!\n");
        }

	hash_destroy(hTmpBatchRec);
        FREE_ME(hTmpBatchRec);

        FREE_ME(rBatchRecordSet);
			
DEBUGLOG(("GetNextBatchIdByMultiBatchTxnRelation:: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetPrevBatchIdByBatchRelation(const char* csBatchId, const char* csTxnId, char* csPrevBatchId, hash_t *hContext)
{
	int     iRet = PD_OK;
	int     iDtlRet = PD_OK;
	
	char    *csTmpBatchId = NULL;

        hash_t          *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rBatchRecordSet,0);

DEBUGLOG(("GetPrevBatchIdByBatchRelation:: Call DBOLBatchRelation:: GetOrgBatchIdByBatchId\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLBatchRelation","GetOrgBatchIdByBatchId");
        iDtlRet = (unsigned long)(*DBObjPtr)(csBatchId,rBatchRecordSet);
        if (iDtlRet == PD_OK) {

                hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                while (hBatchRec) {

                        if (GetField_CString(hBatchRec, "batch_id", &csTmpBatchId)) {
DEBUGLOG(("GetPrevBatchIdByBatchRelation:: Call DBOLBatchRelation:: batch_id = [%s]\n", csTmpBatchId));
                                strcpy(csPrevBatchId,csTmpBatchId);
                                iRet = PD_FOUND;
                                break;
                        }

                        hBatchRec = RecordSet_GetNext(rBatchRecordSet);
                }

        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetPrevBatchIdByBatchRelation:: Call DBOLBatchRelation:: Batch Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT:: GetPrevBatchIdByBatchRelation:: Call DBOLBatchRelation:: Batch Id Error!!!\n");
        }

        RecordSet_Destroy(rBatchRecordSet);
        FREE_ME(rBatchRecordSet);

DEBUGLOG(("GetPrevBatchIdByBatchRelation:: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetNextBatchIdByBatchRelation(const char* csBatchId, const char* csTxnId, char* csNextBatchId, hash_t *hContext)
{
	int     iRet = PD_NOT_FOUND;
	int     iDtlRet = PD_OK;

        char    *csTmpBatchId = NULL;

        hash_t          *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rBatchRecordSet,0);

DEBUGLOG(("GetNextBatchIdByBatchRelation:: Call DBOLBatchRelation:: GetBatchIdByOrgBatchId, csBatchId = [%s]\n", csBatchId));
       	DBObjPtr = CreateObj(DBPtr, "DBOLBatchRelation","GetBatchIdByOrgBatchId");
        iDtlRet = (unsigned long)(*DBObjPtr)(csBatchId,rBatchRecordSet);
     	if (iDtlRet == PD_OK) {

         	hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
              	while (hBatchRec) {

                 	if (GetField_CString(hBatchRec, "batch_id", &csTmpBatchId)) {
DEBUGLOG(("GetNextBatchIdByBatchRelation:: Call DBOLBatchRelation:: batch_id = [%s]\n", csTmpBatchId));
				strcpy(csNextBatchId,csTmpBatchId);
                        	iRet = PD_FOUND;       
				break;
                    	}

                    	hBatchRec = RecordSet_GetNext(rBatchRecordSet);
           	}

     	} else {
            	iRet = INT_ERR;
               	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetNextBatchIdByBatchRelation:: Call DBOLBatchRelation:: Batch Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT:: GetNextBatchIdByBatchRelation:: Call DBOLBatchRelation:: Batch Id Error!!!\n");
       	}
	
        RecordSet_Destroy(rBatchRecordSet);
        FREE_ME(rBatchRecordSet);
	
DEBUGLOG(("GetNextBatchIdByBatchRelation:: iRet = [%d]\n",iRet));
        return iRet;
}

int     GetLastTxnIdByRTDescOrder(const char* csBatchId, char* csLastTxnId, hash_t *hContext)
{
	int     iRet = PD_OK;
	int     iDtlRet = PD_FOUND;

	int	iRecCnt = 0;

	char    cBatchType;
        char    cBatchSubType;

        char    *csTmpTxnId = NULL;

	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchTypeInfo,0);

        hash_t          *hRls;
        hRls = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRls,0);

        hash_t          *hTxnRec = NULL;
        recordset_t     *rTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTxnRecordSet,0);

	cBatchType = ' ';
        cBatchSubType = ' ';

/* batch_id */
//DEBUGLOG(("GetLastTxnIdByRTDescOrder:: batch_id = [%s]\n",csBatchId));

	// Get Batch Type Info
        iDtlRet = GetBatchTypeInfo(csBatchId, hBatchTypeInfo, hContext);

	if (iDtlRet == PD_FOUND) {

/* batch_type */
	        if (GetField_Char(hBatchTypeInfo,"batch_type",&cBatchType)) {
//DEBUGLOG(("GetLastTxnIdByRTDescOrder:: GetBatchTypeInfo, batch_type = [%c]\n",cBatchType));
        	}       

/* batch_sub_type */
        	if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cBatchSubType)) {
//DEBUGLOG(("GetLastTxnIdByRTDescOrder:: GetBatchTypeInfo, batch_sub_type = [%c]\n",cBatchSubType));
        	}
	}

        PutField_Char(hRls,"batch_type",cBatchType);
        PutField_Char(hRls,"batch_sub_type",cBatchSubType);
        PutField_CString(hRls,"batch_id",csBatchId);
        PutField_Char(hRls,"txn_level",PD_TXN_LEVEL);

	// Get TxnId from Batch
DEBUGLOG(("GetLastTxnIdByRTDescOrder:: Call DBOLBatchTxnRelation:: GetTxnId\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetTxnId");
        iRet = (unsigned long)(*DBObjPtr)(hRls,rTxnRecordSet);
        if (iRet == PD_OK) {

                hTxnRec = RecordSet_GetFirst(rTxnRecordSet);
                while (hTxnRec) {

/* txn_id */
                        if (GetField_CString(hTxnRec,"txn_id",&csTmpTxnId)) {
DEBUGLOG(("GetLastTxnIdByRTDescOrder:: Call DBOLBatchTxnRelation:: GetTxnId:: txn_id = [%s]\n",csTmpTxnId));
			}				
				
			// First Record
			if (iRecCnt == 0) {
DEBUGLOG(("GetLastTxnIdByRTDescOrder:: Call DBOLBatchTxnRelation:: GetTxnId:: first_record\n"));

				strcpy(csLastTxnId,csTmpTxnId);
DEBUGLOG(("GetLastTxnIdByRTDescOrder:: Call DBOLBatchTxnRelation:: GetTxnId:: last_txn_id = [%s]\n", csLastTxnId));				
				break;
                       	}	

			iRecCnt++;

			hTxnRec = RecordSet_GetNext(rTxnRecordSet);
                }
        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetLastTxnIdByRTDescOrder:: Call DBOLBatchTxnRelation:: GetTxnId Invalid Batch Id!!!\n"));
ERRLOG("TxnOmtByUsRBT:: GetLastTxnIdByRTDescOrder:: Call DBOLBatchTxnRelation:: GetTxnId Invalid Batch Id!!!\n");
        }

	hash_destroy(hBatchTypeInfo);
        FREE_ME(hBatchTypeInfo);
	
	hash_destroy(hRls);
        FREE_ME(hRls);

        RecordSet_Destroy(rTxnRecordSet);
        FREE_ME(rTxnRecordSet);

DEBUGLOG(("GetLastTxnIdByRTDescOrder:: iRet = [%d]\n",iRet));	
	return iRet;				
}

int     GetTxnCodeInfo(const char* csTxnId, hash_t *hTxnCodeInfo, hash_t *hContext)
{
        int     iRet = PD_OK;

        int     iTmp = 0;

        char    *csTmp = NULL;

        hash_t  *hRec = NULL;

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

        // Get Txn Header
DEBUGLOG(("GetTxnCodeInfo:: Call DBOLTransaction:: GetTxnHeader [%s]\n", csTxnId));
       	DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnHeader");
       	if ((*DBObjPtr)(csTxnId,rRecordSet) == PD_OK) {
               	hRec = RecordSet_GetFirst(rRecordSet);
               	while (hRec) {

/* txn_code */
                   	if (GetField_CString(hRec, "txn_code", &csTmp)) {
DEBUGLOG(("GetTxnCodeInfo:: Call DBOLTransaction:: txn_code = [%s]\n", csTmp));
                      	}

/* is_void */
                      	DBObjPtr = CreateObj(DBPtr,"DBTxnCode","IsVoid");
                     	iTmp = (unsigned long)(*DBObjPtr)(csTmp);
DEBUGLOG(("GetTxnCodeInfo:: Call DBOLTransaction:: is_void = [%d]\n",iTmp));
			PutField_Int(hTxnCodeInfo,"is_void",iTmp);

/* is_offset */
                     	DBObjPtr = CreateObj(DBPtr,"DBTxnCode","IsOffset");
                      	iTmp = (unsigned long)(*DBObjPtr)(csTmp);
DEBUGLOG(("GetTxnCodeInfo:: Call DBOLTransaction:: is_offset = [%d]\n",iTmp));
			PutField_Int(hTxnCodeInfo,"is_offset",iTmp);
		
                      	hRec = RecordSet_GetNext(rRecordSet);
             	}
        } else {
              	iRet = INT_INVALID_TXN;
              	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetTxnCodeInfo:: Call DBOLTransaction:: GetTxnHeader:: not found record for [%s]\n", csTxnId));
ERRLOG("TxnOmtByUsRBT:: GetTxnCodeInfo:: Call DBOLTransaction:: GetTxnHeader:: not found record for [%s]\n", csTxnId);
      	}

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("GetTxnCodeInfo:: iRet = [%d]\n",iRet));
	return iRet;
}

int     IsInputTxnId(const char* csBatchId, const char* csTxnId, hash_t *hContext)
{
        int     iRet = PD_FALSE;
	int     iDtlRet = PD_FOUND;

	char	cBatchType;
	char	cBatchSubType;	

	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchTypeInfo,0);

        hash_t  *hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

	cBatchType = ' ';
        cBatchSubType = ' ';

/* batch_id */
//DEBUGLOG(("IsInputTxnId:: batch_id = [%s]\n",csBatchId));

	// Get Batch Type Info
        iDtlRet = GetBatchTypeInfo(csBatchId, hBatchTypeInfo, hContext);

	if (iDtlRet == PD_FOUND) {

/* batch_type */
	        if (GetField_Char(hBatchTypeInfo,"batch_type",&cBatchType)) {
//DEBUGLOG(("IsInputTxnId:: GetBatchTypeInfo, batch_type = [%c]\n",cBatchType));
	        }

/* batch_sub_type */
        	if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cBatchSubType)) {
//DEBUGLOG(("IsInputTxnId:: GetBatchTypeInfo, batch_sub_type = [%c]\n",cBatchSubType));
        	}
	}

        PutField_Char(hTmpRec,"batch_type",cBatchType);
        PutField_Char(hTmpRec,"batch_sub_type",cBatchSubType);
        PutField_CString(hTmpRec,"batch_id",csBatchId);
        PutField_CString(hTmpRec,"txn_id",csTxnId);
	PutField_Char(hTmpRec,"txn_level",PD_TXN_LEVEL);

        DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","CheckIsInputTxnId");
        iRet = (unsigned long)(*DBObjPtr)(hTmpRec);
        if (iRet == PD_TRUE) {
DEBUGLOG(("IsInputTxnId:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation:: input_txn_id = [TRUE]\n"));
        } else if (iRet == PD_FALSE) {
DEBUGLOG(("IsInputTxnId:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation:: input_txn_id = [FALSE]\n"));
        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsInputTxnId:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation:: Input Txn Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT:: IsInputTxnId:: Call DBOLBatchTxnRelation:: Input Txn Id Error!!!\n");
        }

	hash_destroy(hBatchTypeInfo);
        FREE_ME(hBatchTypeInfo);

        hash_destroy(hTmpRec);
        FREE_ME(hTmpRec);

DEBUGLOG(("IsInputTxnId:: iRet = [%d]\n",iRet));
        return iRet;
}

int     IsMultiBatchTxnId(const char* csTxnId, hash_t *hContext)
{
	int     iRet = PD_FALSE;

	int	iTmp = 0;

	hash_t  *hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

        PutField_Char(hTmpRec,"txn_level",PD_TXN_LEVEL);
        PutField_CString(hTmpRec,"txn_id",csTxnId);

DEBUGLOG(("IsMultiBatchTxnId:: Call DBOLBatchTxnRelation:: GetNumOfBatchId\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetNumOfBatchId");
        iRet = (unsigned long)(*DBObjPtr)(hTmpRec);
        if (iRet == PD_OK) {
		
/* cnt */
          	if (GetField_Int(hTmpRec, "cnt", &iTmp)) {
DEBUGLOG(("IsMultiBatchTxnId:: Call DBOLBatchTxnRelation:: cnt = [%d]\n", iTmp));
            		if (iTmp > 1) {
DEBUGLOG(("IsMultiBatchTxnId:: Call DBOLBatchTxnRelation:: multi_batch_txn_id = [TRUE]\n"));
				iRet = PD_TRUE;
			}
		}

        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsMultiBatchTxnId:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation:: Multi Batch Txn Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT:: IsMultiBatchTxnId:: Call DBOLBatchTxnRelation:: Multi Batch Txn Id Error!!!\n");
        }

        hash_destroy(hTmpRec);
        FREE_ME(hTmpRec);

DEBUGLOG(("IsMultiBatchTxnId:: iRet = [%d]\n",iRet));
        return iRet;
}

int	IsP1VoidTxnId(const char* csTxnId, hash_t *hContext)
{
	int     iRet = PD_FALSE;

	hash_t  *hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

       	PutField_CString(hTmpRec,"txn_id",csTxnId);

      	DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","CheckIsP1VoidTxnId");
       	iRet = (unsigned long)(*DBObjPtr)(hTmpRec);
       	if (iRet == PD_TRUE) {                        
DEBUGLOG(("IsP1VoidTxnId:: Call DBOLTxnRelation:: CheckIsP1VoidTxnId:: p1_void_txn_id = [TRUE]\n"));
	} else if (iRet == PD_FALSE) {
DEBUGLOG(("IsP1VoidTxnId:: Call DBOLTxnRelation:: CheckIsP1VoidTxnId:: p1_void_txn_id = [FALSE]\n"));
       	} else {
               	iRet = INT_ERR;
               	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsP1VoidTxnId:: Call DBOLTxnRelation:: CheckIsP1VoidTxnId:: P1 Void Txn Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT:: IsP1VoidTxnId:: Call DBOLTxnRelation:: CheckIsP1VoidTxnId:: P1 Void Txn Id Error!!!\n");
       	}

	hash_destroy(hTmpRec);
	FREE_ME(hTmpRec);

DEBUGLOG(("IsP1VoidTxnId:: iRet = [%d]\n",iRet));
        return iRet;	
}	

int     IsP2VoidedTxnId(const char* csTxnId, hash_t *hContext)
{
        int     iRet = PD_FALSE;

        hash_t  *hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

        PutField_CString(hTmpRec,"txn_id",csTxnId);

        DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","CheckIsP2VoidedTxnId");
        iRet = (unsigned long)(*DBObjPtr)(hTmpRec);
        if (iRet == PD_TRUE) {  
DEBUGLOG(("IsP2VoidedTxnId:: Call DBOLTxnRelation:: CheckIsP2VoidedTxnId:: p2_voided_txn_id = [TRUE]\n"));
        } else if (iRet == PD_FALSE) {
DEBUGLOG(("IsP2VoidedTxnId:: Call DBOLTxnRelation:: CheckIsP2VoidedTxnId:: p2_voided_txn_id = [FALSE]\n"));
        } else {
                iRet = INT_ERR;
                PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsP2VoidedTxnId:: Call DBOLTxnRelation:: CheckIsP2VoidedTxnId:: P2 Voided Txn Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT:: IsP2VoidedTxnId:: Call DBOLTxnRelation:: CheckIsP2VoidedTxnId:: P2 Voided Txn Id Error!!!\n");
        }

        hash_destroy(hTmpRec);
        FREE_ME(hTmpRec);

DEBUGLOG(("IsP2VoidedTxnId:: iRet = [%d]\n",iRet));
        return iRet;
}

int     IsP1VoidBatchId(const char* csBatchId, hash_t *hContext)
{
	int     iRet = PD_FALSE;
	int	iDtlRet = PD_FOUND;

        char    cBatchType;
        char    cBatchSubType;

	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchTypeInfo,0);
	
        cBatchType = ' ';
        cBatchSubType = ' ';

	// Get Batch Type Info
        iDtlRet = GetBatchTypeInfo(csBatchId, hBatchTypeInfo, hContext);

	if (iDtlRet == PD_FOUND) {

/* batch_type */
       		if (GetField_Char(hBatchTypeInfo,"batch_type",&cBatchType)) {
//DEBUGLOG(("IsP1VoidBatchId:: GetBatchTypeInfo, cBatchType = [%c]\n", cBatchType));
       		}

/* batch_sub_type */
      		if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cBatchSubType)) {
//DEBUGLOG(("IsP1VoidBatchId:: GetBatchTypeInfo, cBatchSubType = [%c]\n", cBatchSubType));
       		}
	}

	if (iDtlRet == PD_FOUND) {
		if ((cBatchSubType == PD_GENERAL_UNDO_RECON)
                    || (cBatchSubType == PD_GENERAL_UNDO_BAL_TRF)
                    || (cBatchSubType == PD_COMBINE_UNDO_RECON)
               	)
              	{
DEBUGLOG(("IsP1VoidBatchId: p1_void_batch_id = [TRUE]\n"));
			iRet = PD_TRUE;
                }
       	} else {
            	iRet = INT_ERR;
            	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsP1VoidBatchId:: Batch Sub Type Not Found!!!\n"));
ERRLOG("TxnOmtByUsRBT:: IsP1VoidBatchId:: Batch Sub Type Not Found!!!\n");
     	}

	hash_destroy(hBatchTypeInfo);
        FREE_ME(hBatchTypeInfo);

DEBUGLOG(("IsP1VoidBatchId:: iRet = [%d]\n",iRet));
	return iRet;
}

int     IsP2VoidedBatchId(const char* csBatchId, hash_t *hContext)
{
	int     iRet = PD_TRUE;
	int	iDtlRet = PD_FOUND;

	char	cBatchType;
	char	cBatchSubType;

	char	*csTmpTxnId = NULL;

	hash_t  *hBatchTypeInfo;
        hBatchTypeInfo = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchTypeInfo,0);

	hash_t          *hRls;
        hRls = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRls,0);

        hash_t          *hTxnRec = NULL;
        recordset_t     *rTxnRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rTxnRecordSet,0);

	cBatchType = ' ';
        cBatchSubType = ' ';

	// Get Batch Type Info
        iDtlRet = GetBatchTypeInfo(csBatchId, hBatchTypeInfo, hContext);

	if (iDtlRet == PD_FOUND) {

/* batch_type */
	        if (GetField_Char(hBatchTypeInfo,"batch_type",&cBatchType)) {
//DEBUGLOG(("IsP2VoidedBatchId:: batch_type = [%c]\n",cBatchType));
	        }

/* batch_sub_type */
	        if (GetField_Char(hBatchTypeInfo,"batch_sub_type",&cBatchSubType)) {
//DEBUGLOG(("IsP2VoidedBatchId:: batch_sub_type = [%c]\n",cBatchSubType));
	        }
	}

	iDtlRet = PD_OK;

       	PutField_Char(hRls,"batch_type",cBatchType);
       	PutField_Char(hRls,"batch_sub_type",cBatchSubType);
       	PutField_CString(hRls,"batch_id",csBatchId);
	PutField_Char(hRls,"txn_level",PD_TXN_LEVEL);

	// Get TxnId from Batch
     	DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetTxnId");
       	iDtlRet = (unsigned long)(*DBObjPtr)(hRls,rTxnRecordSet);
       	if (iDtlRet == PD_OK) {
		iDtlRet = PD_FALSE;

		hTxnRec = RecordSet_GetFirst(rTxnRecordSet);
              	while ((hTxnRec) && (iRet != INT_ERR)) {

/* txn_id */
             		if (GetField_CString(hTxnRec,"txn_id",&csTmpTxnId)) {
DEBUGLOG(("IsP2VoidedBatchId:: Call DBOLBatchTxnRelation:: GetTxnId:: txn_id = [%s]\n",csTmpTxnId));

                       		// Check P2Voided
                               	iDtlRet = IsP2VoidedTxnId(csTmpTxnId, hContext);
                               	
				if (iDtlRet == PD_FALSE) {
DEBUGLOG(("IsP2VoidedBatchId:: Call DBOLBatchTxnRelation:: p2_voided_batch_id = [FALSE]\n"));
					iRet = PD_FALSE;
                     			break;
				}
			} else {
DEBUGLOG(("IsP2VoidedBatchId:: Call DBOLBatchTxnRelation:: GetTxnId:: Not Found!!!\n"));
			}

                      	hTxnRec = RecordSet_GetNext(rTxnRecordSet);
          	}
	} else {
           	iRet = INT_ERR;
              	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("IsP2VoidedBatchId:: Call DBOLBatchTxnRelation:: GetTxnId:: Invalid Batch Id!!!\n"));
ERRLOG("TxnOmtByUsRBT:: IsP2VoidedBatchId:: Call DBOLBatchTxnRelation:: GetTxnId:: Invalid Batch Id!!!\n");
      	}

	hash_destroy(hBatchTypeInfo);
        FREE_ME(hBatchTypeInfo);
	
	hash_destroy(hRls);
        FREE_ME(hRls);

        RecordSet_Destroy(rTxnRecordSet);
        FREE_ME(rTxnRecordSet);

DEBUGLOG(("IsP2VoidedBatchId:: iRet = [%d]\n",iRet));
	return iRet;
}

int     GetTxnHeaderInfo(const char* csTxnId, hash_t* hTxnHeaderRec, hash_t* hContext)
{
	int     iRet = PD_OK;

	int	iTmp = 0;

        char    *csTmp = NULL;
	char    *csBaidCategory = (char*) malloc (64);

        char    cTmp;

        hash_t  *hRec = NULL;

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

        cTmp = ' ';

	// Get Txn Header
	if (iRet == PD_OK) {
                recordset_init(rRecordSet,0);

//DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLTransaction:: GetTxnHeader [%s]\n", csTxnId));
                DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnHeader");
                if ((*DBObjPtr)(csTxnId,rRecordSet) == PD_OK) {
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* txn_id */
				PutField_CString(hTxnHeaderRec, "txn_id", csTxnId);
//DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLTransaction:: txn_id = [%s]\n",csTxnId));

/* status */
                                if (GetField_Char(hRec,"status",&cTmp)) {
//DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLTransaction:: status = [%c]\n",cTmp));
					PutField_Char(hTxnHeaderRec, "status", cTmp);					
                                }

/* ar_ind */
                                if (GetField_Char(hRec, "ar_ind", &cTmp)) {
//DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLTransaction:: ar_ind = [%c]\n", cTmp));
					PutField_Char(hTxnHeaderRec, "ar_ind", cTmp);					
                                }

/* sub_status */
                                if (GetField_CString(hRec, "sub_status", &csTmp)) {
//DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLTransaction:: sub_status = [%s]\n", csTmp));
					PutField_CString(hTxnHeaderRec, "sub_status", csTmp);					
                                }

/* recon_status */
                                if (GetField_Char(hRec, "recon_status", &cTmp)) {
//DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLTransaction:: recon_status = [%c]\n", cTmp));
					PutField_Char(hTxnHeaderRec, "recon_status", cTmp);					
                                }

/* process_type */
                                if (GetField_CString(hRec,"process_type",&csTmp)) {
//DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLTransaction:: process_type = [%s]\n",csTmp));
					PutField_CString(hTxnHeaderRec, "process_type", csTmp);					
                                }

/* process_code */
                                if (GetField_CString(hRec,"process_code",&csTmp)) {
//DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLTransaction:: process_code = [%s]\n",csTmp));
					PutField_CString(hTxnHeaderRec, "process_code", csTmp);					
                                }

/* txn_code */
                                if (GetField_CString(hRec, "txn_code", &csTmp)) {
//DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLTransaction:: txn_code = [%s]\n", csTmp));
                                        PutField_CString(hTxnHeaderRec, "txn_code", csTmp);
                                }

/* is_offset */
                                DBObjPtr = CreateObj(DBPtr,"DBTxnCode","IsOffset");
                                iTmp = (unsigned long)(*DBObjPtr)(csTmp);
//DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLTransaction:: is_offset = [%d]\n",iTmp));
				PutField_Int(hTxnHeaderRec, "is_offset", iTmp);					

/* is_void */
				DBObjPtr = CreateObj(DBPtr,"DBTxnCode","IsVoid");
                                iTmp = (unsigned long)(*DBObjPtr)(csTmp);
//DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLTransaction:: is_void = [%d]\n",iTmp));
				PutField_Int(hTxnHeaderRec, "is_void", iTmp);					

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                } else {
                        iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLTransaction:: GetTxnHeader:: not found record for [%s]\n", csTxnId));
ERRLOG("TxnOmtByUsRBT:: GetTxnHeaderInfo:: Call DBOLTransaction:: GetTxnHeader::not found record for [%s]\n", csTxnId);
                }

		RecordSet_Destroy(rRecordSet);
	}

	// Get BAID Category
        if (iRet == PD_OK) {
	
//DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLBankAcctId:: GetCategoryByTxnId [%s]\n", csTxnId));
        	DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetCategoryByTxnId");
        	if ((*DBObjPtr)(csTxnId,csBaidCategory) == PD_OK) {
/* baid_category */
                	PutField_CString(hTxnHeaderRec, "baid_category", csBaidCategory);
//DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLBankAcctId:: baid_category = [%s]\n",csBaidCategory));

        	} else {
                	iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("GetTxnHeaderInfo:: Call DBOLBankAcctId:: not found record for [%s]\n", csTxnId));
ERRLOG("TxnOmtByUsRBT:: GetTxnHeaderInfo:: Call DBOLBankAcctId:: not found record for [%s]\n", csTxnId);
        	}
	}	

	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

	FREE_ME(csBaidCategory);

//DEBUGLOG(("GetTxnHeaderInfo:: iRet = [%d]\n",iRet));
        return iRet;
}

int 	IsPutTxnIdToBatch(const char* csTxnId, hash_t* hTxnHeaderRec)
{
	int     iRet = PD_OK;

        int     iIsOffset = PD_FALSE;
        int     iIsVoid = PD_FALSE;

        char    cStatus;
        char    cArInd;

	char	*csTxnCode = NULL;

        cStatus = ' ';
        cArInd = ' ';

/* txn_id */
DEBUGLOG(("IsPutTxnIdToBatch:: txn_id = [%s]\n", csTxnId));

/* txn_type */
DEBUGLOG(("IsPutTxnIdToBatch:: txn_type = [%s]\n", csTxnType));

/* txn_code */
	if (GetField_CString(hTxnHeaderRec,"txn_code",&csTxnCode)) {
DEBUGLOG(("IsPutTxnIdToBatch:: txn_code = [%s]\n", csTxnCode));
        }

/* status */
        if (GetField_Char(hTxnHeaderRec,"status",&cStatus)) {
DEBUGLOG(("IsPutTxnIdToBatch:: status = [%c]\n", cStatus));
        }

/* ar_ind */
        if (GetField_Char(hTxnHeaderRec, "ar_ind", &cArInd)) {
DEBUGLOG(("IsPutTxnIdToBatch:: ar_ind = [%c]\n", cArInd));
        }

/* is_offset */
        if (GetField_Int(hTxnHeaderRec, "is_offset", &iIsOffset)) {
//DEBUGLOG(("IsPutTxnIdToBatch:: is_offset = [%d]\n", iIsOffset));
        }

/* is_void */
        if (GetField_Int(hTxnHeaderRec, "is_void", &iIsVoid)) {
DEBUGLOG(("IsPutTxnIdToBatch:: is_void = [%d]\n", iIsVoid));
        }

	if (iRet == PD_OK) {
		// Check txn_type -> status + ar_ind -> txn_code -> is_void -> action
		if (!strcmp(csTxnType, PD_TXN_TYPE_HOLD_DEPOSIT)) { 
			if ((cStatus == PD_COMPLETE) && (cArInd == PD_ACCEPT)) {
				if (!strcmp(csTxnCode, PD_BANK_DEPOSIT_TXN_CODE)) {
                                	iRet = PD_ERR;
                        	} else {
					if (iIsVoid == PD_TRUE) {
                                        	iRet = PD_ERR;
                                	}
				}
			} else {
				if (iAction == PD_BATCH_ACTION_CANCEL) {
                                        iRet = PD_ERR;
                                }
			}
		} else {
			if ((cStatus == PD_COMPLETE) && (cArInd == PD_ACCEPT)) {	
				if (iIsVoid == PD_TRUE) {
					iRet = PD_ERR;
				}
			} else {	
				if (iAction == PD_BATCH_ACTION_CANCEL) {
					iRet = PD_ERR;
				}
			}
		}
	}

DEBUGLOG(("IsPutTxnIdToBatch:: iRet = [%d]\n",iRet));
        return iRet;
}	

int 	CheckActionByTxnId(const char* csTxnId, hash_t* hTxnHeaderRec, hash_t* hContext)
{
	int 	iRet = PD_OK;

	int	iSkipCheckAction = PD_FALSE;

	int 	iIsOffset = PD_FALSE;
	int 	iIsVoid = PD_FALSE;
	
	char    *csBaidCategory = NULL;	
	char    *csTxnCode = NULL;	
        char    *csSubStatus = NULL;
        char    cStatus;
        char    cArInd;
        char    cReconStatus;
	char	cOrgBatchSubType;

	cStatus = ' ';
	cArInd = ' ';
	cReconStatus = ' ';	
	cOrgBatchSubType = ' ';
	
/* action */
DEBUGLOG(("CheckActionByTxnId:: action = [%d]\n", iAction));

/* txn_id */
DEBUGLOG(("CheckActionByTxnId:: txn_id = [%s]\n", csTxnId));

/* txn_type */
DEBUGLOG(("CheckActionByTxnId:: txn_type = [%s]\n", csTxnType));

/* org_batch_sub_type */
	if(GetField_Char(hContext, "org_batch_sub_type", &cOrgBatchSubType)){
DEBUGLOG(("CheckActionByTxnId:: org_batch_sub_type = [%c]\n",cOrgBatchSubType));
      	}

/* baid_category */	
	if (GetField_CString(hTxnHeaderRec, "baid_category", &csBaidCategory)) {
DEBUGLOG(("CheckActionByTxnId:: baid_category = [%s]\n", csBaidCategory));
        }

/* txn_code */
     	if (GetField_CString(hTxnHeaderRec, "txn_code", &csTxnCode)) {
DEBUGLOG(("CheckActionByTxnId:: txn_code = [%s]\n", csTxnCode));
      	}

/* status */
	if (GetField_Char(hTxnHeaderRec,"status",&cStatus)) {
DEBUGLOG(("CheckActionByTxnId:: status = [%c]\n",cStatus));
       	}

/* ar_ind */
       	if (GetField_Char(hTxnHeaderRec, "ar_ind", &cArInd)) {
DEBUGLOG(("CheckActionByTxnId:: ar_ind = [%c]\n", cArInd));
      	}

/* sub_status */
        if (GetField_CString(hTxnHeaderRec, "sub_status", &csSubStatus)) {
DEBUGLOG(("CheckActionByTxnId:: sub_status = [%s]\n", csSubStatus));
     	}

/* recon_status */
       	if (GetField_Char(hTxnHeaderRec, "recon_status", &cReconStatus)) {
DEBUGLOG(("CheckActionByTxnId:: recon_status = [%c]\n", cReconStatus));
        }

/* is_offset */
        if (GetField_Int(hTxnHeaderRec, "is_offset", &iIsOffset)) {
DEBUGLOG(("CheckActionByTxnId:: is_offset = [%d]\n", iIsOffset));
        }

/* is_void */
        if (GetField_Int(hTxnHeaderRec, "is_void", &iIsVoid)) {
DEBUGLOG(("CheckActionByTxnId:: is_void = [%d]\n", iIsVoid));
        }

	if (iRet == PD_OK) {
	
		// check is combine recon
		if (iSkipCheckAction == PD_FALSE) {
			if (cOrgBatchSubType == PD_COMBINE_RECON) {
				iAction = PD_BATCH_ACTION_VOID;
DEBUGLOG(("CheckActionByTxnId:: (check) org_batch_sub_type = [%c], change action to [%d]\n", PD_COMBINE_RECON, PD_BATCH_ACTION_VOID));
			}
		}		
	
		// Check is offset
		if (iSkipCheckAction == PD_FALSE) {
			if (iIsOffset == PD_TRUE) {
				iSkipCheckAction = PD_TRUE;
DEBUGLOG(("CheckActionByTxnId:: (check) is_offset = [TRUE], skip checking action\n"));
			}
		}

		// Check is void
		if (iSkipCheckAction == PD_FALSE) {
                        if (iIsVoid == PD_TRUE) {
                                iSkipCheckAction = PD_TRUE;
DEBUGLOG(("CheckActionByTxnId:: (check) is_void = [TRUE], skip checking action\n"));
                        }
                }		

		// Check recon_status is NOT_REQ
		if (iSkipCheckAction == PD_FALSE) {
			if (cReconStatus == PD_RECON_NOT_REQ) {
                                iSkipCheckAction = PD_TRUE;
DEBUGLOG(("CheckActionByTxnId:: (check) recon_status = [%c], skip checking action\n", PD_RECON_NOT_REQ));
                        }
		}
	
		// Check status + ar_ind
		if (iSkipCheckAction == PD_FALSE) {
			if ((cStatus == PD_COMPLETE) && (cArInd == PD_ACCEPT)) {
				iSkipCheckAction = PD_FALSE;
			} else {
				iSkipCheckAction = PD_TRUE;
DEBUGLOG(("CheckActionByTxnId:: (check) status[%c] != [%c] or ar_ind[%c] != [%c], skip checking action\n", cStatus, PD_COMPLETE, cArInd, PD_ACCEPT));
			}
		}

		// Check Cases for Cancel/Void/Not Allow
		if (iSkipCheckAction == PD_FALSE) {

			// Check Txn Type
			if (!strcmp(csTxnType, PD_TXN_TYPE_HOLD_DEPOSIT)) {
				iAction = PD_BATCH_ACTION_VOID;
	
			} else if ((!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) || (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTER))) {				

				// Check Baid Category
				if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {
                                
					// Check Recon Status
					if (cReconStatus == PD_UNRECONCILED) {
						
						// Check Sub Status
						if ((!strcmp(csSubStatus, PD_UNDO)) 
						    || (!strcmp(csSubStatus, PD_CANCELLED))
						) {
                                                	iAction = PD_FALSE;
                                        	}
					} else if (cReconStatus == PD_RECONCILED) {
						iAction = PD_FALSE;
					} else {
                                                iAction = PD_FALSE;
                                        }
				} else {

					// Check Recon Status
					if (cReconStatus == PD_UNRECONCILED) {
					
						// Check Sub Status
						if ((!strcmp(csSubStatus, PD_UNDO))
                                            	    || (!strcmp(csSubStatus, PD_CANCELLED))
                                        	) {
                                                	iAction = PD_FALSE;
                                        	}
					} else if (cReconStatus == PD_RECONCILED) {
                                        
						// Check Sub Status
						if ((!strcmp(csSubStatus, PD_UNDO))
                                            	    || (!strcmp(csSubStatus, PD_CANCELLED))
                                        	) {
                                                	iAction = PD_FALSE;
                                        	} else {
							iAction = PD_BATCH_ACTION_VOID;
						}
					} else {
                                                iAction = PD_FALSE;
                                        }
				}
			} else if (!strcmp(csTxnType, PD_TXN_TYPE_PSP_SETTLEMENT)) {

				// Check Baid Category
				if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {
		
					// Check Recon Status
					if (cReconStatus == PD_UNRECONCILED) {

						// Check Sub Status
						if ((!strcmp(csSubStatus, PD_UNDO))
						    || (!strcmp(csSubStatus, PD_CANCELLED))
                                            	    || (!strcmp(csSubStatus, PD_DELIVERING))
                                            	    || (!strcmp(csSubStatus, PD_DELIVERED))
                                                    || (!strcmp(csSubStatus, PD_MANUAL_DELIVERED))
                                        	) {
                                                	iAction = PD_FALSE;
                                        	} else {

							// Check Number of Batch and P1Void/P2Voided
                                                	if ((iNumOfBatchId > 0)
                                                    	    && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                	)
                                                	{
                                                        	iAction = PD_BATCH_ACTION_VOID;
                                                	}
						}
                                        } else if (cReconStatus == PD_RECONCILED) {
                                                iAction = PD_FALSE;
                                        } else {
                                                iAction = PD_FALSE;
                                        }
				} else {
					
					// Check Recon Status
					if (cReconStatus == PD_UNRECONCILED) {

						// Check Sub Status			
						if ((!strcmp(csSubStatus, PD_UNDO))
                                		    || (!strcmp(csSubStatus, PD_CANCELLED))
                                    		    || (!strcmp(csSubStatus, PD_DELIVERING))
                                    		    || (!strcmp(csSubStatus, PD_DELIVERED))
						) {
                                        		iAction = PD_FALSE;
                                		} else {
						
							// Check Number of Batch and P1Void/P2Voided
							if ((iNumOfBatchId > 0)
                                                            && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                        )
                                                        {
                                                                iAction = PD_BATCH_ACTION_VOID;
                                                        }
						}
					} else if (cReconStatus == PD_RECONCILED) {
						
						// Check Sub Status
						if ((!strcmp(csSubStatus, PD_UNDO))
                                                    || (!strcmp(csSubStatus, PD_CANCELLED))
                                                    || (!strcmp(csSubStatus, PD_DELIVERING))
                                                    || (!strcmp(csSubStatus, PD_DELIVERED))
                                                ) {
							iAction = PD_FALSE;
						} else {
							iAction = PD_BATCH_ACTION_VOID;
						}
					} else {
						iAction = PD_FALSE;
					}
				}
			} else if (!strcmp(csTxnType, PD_TXN_TYPE_PROVIDER_CHARGE)) {

				// Check Baid Category
                                if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {

					// Check Recon Status
					if (cReconStatus == PD_UNRECONCILED) {
			
						// Check Sub Status
						if ((!strcmp(csSubStatus, PD_UNDO))
                                            	    || (!strcmp(csSubStatus, PD_CANCELLED))
                                        	) {	
							iAction = PD_FALSE;
						} else {
		
							// Check Number of Batch, P1Void Batch, P2Voided Batch
                                                        if ((iNumOfBatchId > 0)
                                                            && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                        )
                                                        {
                                                                iAction = PD_BATCH_ACTION_VOID;
                                                        }
						}	
					} else if (cReconStatus == PD_RECONCILED) {
						iAction = PD_FALSE;
                                       	} else {
                                            	iAction = PD_FALSE;
                                       	}
				} else {
		
					// Check Recon Status
                                        if (cReconStatus == PD_UNRECONCILED) {
				
						// Check Sub Status
                                                if ((!strcmp(csSubStatus, PD_UNDO))
                                                    || (!strcmp(csSubStatus, PD_CANCELLED))
                                                ) {
                                                        iAction = PD_FALSE;
						} else {

							// Check Number of Batch, P1Void Batch, P2Voided Batch
                                                        if ((iNumOfBatchId > 0)
                                                            && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                        )
                                                        {
                                                                iAction = PD_BATCH_ACTION_VOID;
                                                        }
						}
					} else if (cReconStatus == PD_RECONCILED) {

						// Check Sub Status
						if ((!strcmp(csSubStatus, PD_UNDO))
                                                    || (!strcmp(csSubStatus, PD_CANCELLED))
                                                ) {
                                                        iAction = PD_FALSE;
                                                } else {
							iAction = PD_BATCH_ACTION_VOID;	
						}
					} else {
                                                iAction = PD_FALSE;
                                        }
				}
			} else if (!strcmp(csTxnType, PD_TXN_TYPE_SMS_BANK_DEPOSIT)) {
	
				// Check Baid Category
				if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {

                                     	// Check Recon Status
                                     	if (cReconStatus == PD_UNRECONCILED) {

                                           	// Check Sub Status
                                             	if (!strcmp(csSubStatus, PD_UNALLOCATED)) {
                                                     	//iAction = PD_BATCH_ACTION_VOID;
                                            	} else {
                                                   	iAction = PD_FALSE;
                                             	}
                                    	} else if (cReconStatus == PD_RECONCILED) {
                                            	iAction = PD_FALSE;
                                  	} else {
                                              	iAction = PD_FALSE;
                                    	}
                            	} else {

                                   	// Check Recon Status
                                     	if (cReconStatus == PD_UNRECONCILED) {

                                              	// Check Sub Status
                                              	if (!strcmp(csSubStatus, PD_UNALLOCATED)) {
                                                   	//iAction = PD_BATCH_ACTION_VOID;
                                             	} else {
                                                      	iAction = PD_FALSE;
                                             	}
                                   	} else if (cReconStatus == PD_RECONCILED) {

                                            	// Check Sub Status
                                               	if (!strcmp(csSubStatus, PD_UNALLOCATED)) {
                                                    	//iAction = PD_BATCH_ACTION_VOID;
                                             	} else {
                                                   	iAction = PD_FALSE;
                                              	}
                                     	} else {
                                              	iAction = PD_FALSE;
                                     	}
                          	}
			} else if (!strcmp(csTxnType, PD_TXN_TYPE_GENERAL)) {

				if (!strcmp(csTxnCode, PD_OL_PAYOUT_GENERATE)) {

					// Check Baid Category
                                	if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {

						// Check Recon Status
						if (cReconStatus == PD_UNRECONCILED) {

							// Check Sub Status
							if ((!strcmp(csSubStatus, PD_UNDO))
                                                    	    || (!strcmp(csSubStatus, PD_CANCELLED))
                                                	) {
                                                        	iAction = PD_FALSE;
                                                	} else {

                                                        	// Check Number of Batch, P1Void Batch, P2Voided Batch
                                                        	if ((iNumOfBatchId > 0)
                                                            	    && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                        	)
                                                        	{
                                                                	iAction = PD_BATCH_ACTION_VOID;
                                                        	}
							}
						} else if (cReconStatus == PD_RECONCILED) {
                                                        iAction = PD_FALSE;
						} else {
                                                        iAction = PD_FALSE;
                                                }
					} else if (!strcmp(csBaidCategory, PD_BAID_CAT_TEMP)) {

						// Check Recon Status
						if (cReconStatus == PD_UNRECONCILED) {
							iAction = PD_FALSE;
						} else if (cReconStatus == PD_RECONCILED) {
							
							// Check Sub Status
							if ((!strcmp(csSubStatus, PD_UNDO))
                                                            || (!strcmp(csSubStatus, PD_CANCELLED))
                                                        ) {
                                                                iAction = PD_FALSE;
                                                        } else {
                                                                iAction = PD_BATCH_ACTION_VOID;
                                                        }

						} else {
							iAction = PD_FALSE;
						}	
                                	} else {
						// Check Recon Status
						if (cReconStatus == PD_UNRECONCILED) {						

							// Check Sub Status
							if ((!strcmp(csSubStatus, PD_UNDO))
                                                            || (!strcmp(csSubStatus, PD_CANCELLED))
                                                        ) {
                                                                iAction = PD_FALSE;
                                                        } else {
		
								// Check Number of Batch, P1Void Batch, P2Voided Batch
								if ((iNumOfBatchId > 0)
                                                                    && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                                )
                                                                {
                                                                        iAction = PD_BATCH_ACTION_VOID;
                                                                }
							}
						} else if (cReconStatus == PD_RECONCILED) {

							// Check Sub Status
							if ((!strcmp(csSubStatus, PD_UNDO))
                                                            || (!strcmp(csSubStatus, PD_CANCELLED))
                                                        ) {
                                                                iAction = PD_FALSE;
                                                        } else {
                                                                iAction = PD_BATCH_ACTION_VOID;
                                                        }
                                                } else {
                                                        iAction = PD_FALSE;
                                                }
					}
				} else {

					// Check Baid Category
                                	if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {

						// Check Recon Status
						if (cReconStatus == PD_UNRECONCILED) {

							// Check Sub Status
							if ((!strcmp(csSubStatus, PD_UNDO))
                                                    	    || (!strcmp(csSubStatus, PD_CANCELLED))
                                                	) {
                                                        	iAction = PD_FALSE;
                                                	} else {

                                                        	// Check Number of Batch, P1Void Batch, P2Voided Batch
                                                        	if ((iNumOfBatchId > 0)
                                                            	    && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                        	)
                                                        	{
                                                                	iAction = PD_BATCH_ACTION_VOID;
                                                        	}
							}
						} else if (cReconStatus == PD_RECONCILED) {
                                                        iAction = PD_FALSE;
						} else {
                                                        iAction = PD_FALSE;
                                                }
                                	} else {
						// Check Recon Status
						if (cReconStatus == PD_UNRECONCILED) {						

							// Check Sub Status
							if ((!strcmp(csSubStatus, PD_UNDO))
                                                            || (!strcmp(csSubStatus, PD_CANCELLED))
                                                        ) {
                                                                iAction = PD_FALSE;
                                                        } else {
		
								// Check Number of Batch, P1Void Batch, P2Voided Batch
								if ((iNumOfBatchId > 0)
                                                                    && ((iIsOrgBatchIdP1Void == PD_FALSE) || (iIsOrgBatchIdP2Voided == PD_FALSE))
                                                                )
                                                                {
                                                                        iAction = PD_BATCH_ACTION_VOID;
                                                                }
							}
						} else if (cReconStatus == PD_RECONCILED) {

							// Check Sub Status
							if ((!strcmp(csSubStatus, PD_UNDO))
                                                            || (!strcmp(csSubStatus, PD_CANCELLED))
                                                        ) {
                                                                iAction = PD_FALSE;
                                                        } else {
                                                                iAction = PD_BATCH_ACTION_VOID;
                                                        }
                                                } else {
                                                        iAction = PD_FALSE;
                                                }
					}
				}
			}
DEBUGLOG(("CheckActionByTxnId:: (check) txn_type, txn_code, baid_category, recon_status, sub_status case by case, change action to [%d]\n",iAction));
		}
	}

	if (iRet == PD_OK) {
		if (iSkipCheckAction == PD_FALSE) {		
			if (iAction > PD_FALSE) {
                           	switch (iAction) {
                                    	case PD_BATCH_ACTION_VOID:
                                       		DBObjPtr = CreateObj(DBPtr,"DBTxnCode","OflIsVoidable");
                                             	if ((unsigned long)(*DBObjPtr)(csTxnCode) != PD_TRUE) {
DEBUGLOG(("CheckActionByTxnId:: (check) txn_code is_voidable = [FALSE], change action to [%d]\n", PD_FALSE));
                                                  	iAction = PD_FALSE;
                                             	}
                                              	break;
                                    	case PD_BATCH_ACTION_CANCEL:
                                            	DBObjPtr = CreateObj(DBPtr,"DBTxnCode","AllowCancel");
                                             	if ((unsigned long)(*DBObjPtr)(csTxnCode) != PD_TRUE) {
DEBUGLOG(("CheckActionByTxnId:: (check) txn_code allow_cancel = [FALSE], change action to [%d]\n", PD_FALSE));
                                                 	iAction = PD_FALSE;
                                             	}
                                             	break;
                                    	default:
                                           	break;
                            	}
                    	}
		}
	}
	
	// Result
	if (iRet == PD_OK) {
DEBUGLOG(("CheckActionByTxnId:: (result) action = [%d]\n",iAction));
		if (iAction > PD_FALSE) {
			iRet = PD_OK;
            	} else {
                 	iRet = INT_INVALID_TXN;
                   	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("CheckActionByTxnId:: not allow to void/cancel\n"));
ERRLOG("TxnOmtByUsRBT:: CheckActionByTxnId:: not allow to void/cancel\n");
          	}
	}

DEBUGLOG(("CheckActionByTxnId:: iRet = [%d]\n",iRet));
	return iRet;
}

int	GetBaidTxnInfo(const char* csStmtTxnId, hash_t* hBaidTxnRec)
{
	int     iRet = PD_OK;

        char    *csTmp = NULL;

        char    cTmp;

        cTmp = ' ';

        // Get Baid Txn
        if (iRet == PD_OK) {
//DEBUGLOG(("GetBaidTxnInfo:: Call DBOLBAIDTxn:: GetBaidTxn [%s]\n", csStmtTxnId));
             	DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "GetBaidTxn");
                iRet = (unsigned long)(*DBObjPtr)(csStmtTxnId,hBaidTxnRec);
               	if (iRet == PD_OK) {

/* txn_id */
                       	PutField_CString(hBaidTxnRec, "txn_id", csStmtTxnId);
//DEBUGLOG(("GetBaidTxnInfo:: Call DBOLBAIDTxn:: stmt_txn_id = [%s]\n",csStmtTxnId));

/* txn_code */
			if (GetField_CString(hBaidTxnRec, "txn_code", &csTmp)) {
//DEBUGLOG(("GetBaidTxnInfo:: Call DBOLBAIDTxn:: txn_code [%s]\n", csTmp));
                        }

/* status */
                   	if (GetField_Char(hBaidTxnRec, "status", &cTmp)) {
//DEBUGLOG(("GetBaidTxnInfo:: Call DBOLBAIDTxn:: status [%c]\n", cTmp));
                     	}

/* ar_ind */
                       	if (GetField_Char(hBaidTxnRec, "ar_ind", &cTmp)) {
//DEBUGLOG(("GetBaidTxnInfo:: Call DBOLBAIDTxn:: ar_ind [%c]\n", cTmp));
                    	}

           	} else {
                   	iRet = INT_ERR;
DEBUGLOG(("GetBaidTxnInfo:: Call DBOLBAIDTxn:: GetBaidTxn FAILED!!\n"));
ERRLOG("TxnOmtByUsRBT:: Call DBOLBAIDTxn:: GetBaidTxn FAILED!!\n");
             	}

	}

//DEBUGLOG(("GetBaidTxnInfo:: iRet = [%d]\n",iRet));
        return iRet;
}

int     IsPutStmtTxnIdToBatch(const char* csStmtTxnId, hash_t* hBaidTxnRec, hash_t* hStmtTxnHeaderRec, hash_t* hStmtTxnContext)
{
	int     iRet = PD_TRUE;
	int	iDtlRet = PD_FOUND; 

	int	iStmtTxnAction = PD_STMT_TXN_ACTION_GEN_NEW_ID;

        char    cStatus;
        char    cARInd;
	char    cReconStatus;

	char	*csTxnCode = NULL;
	char	*csBatchId = NULL;
	char	*csTmp = NULL;

	hash_t  *hTxnRec = NULL;
        recordset_t     *rTxnRecordSet;
        rTxnRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

	hash_t  *hBatchRec = NULL;
        recordset_t     *rBatchRecordSet;
        rBatchRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

        cStatus = ' ';
        cARInd = ' ';
	cReconStatus = ' ';

/* stmt_txn_id */
DEBUGLOG(("IsPutStmtTxnIdToBatch:: stmt_txn_id = [%s]\n", csStmtTxnId));
	PutField_CString(hStmtTxnHeaderRec, "txn_id", csStmtTxnId);

/* txn_type */
DEBUGLOG(("IsPutStmtTxnIdToBatch:: txn_type = [%s]\n", csTxnType));

/* batch_id */
	if (GetField_CString(hStmtTxnContext,"batch_id",&csBatchId)) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: batch_id = [%s]\n", csBatchId));
        }

/* txn_code */
        if (GetField_CString(hBaidTxnRec,"txn_code",&csTxnCode)) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: txn_code = [%s]\n", csTxnCode));
        }

/* status */
        if (GetField_Char(hBaidTxnRec,"status",&cStatus)) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: status = [%c]\n", cStatus));
        }

/* ar_ind */
        if (GetField_Char(hBaidTxnRec, "ar_ind", &cARInd)) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: ar_ind = [%c]\n", cARInd));
        }

/* recon_status */
        if (GetField_Char(hBaidTxnRec, "recon_status", &cReconStatus)) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: recon_status = [%c]\n", cReconStatus));
        }

	// Check stmt_txn_relation and batch_txn_relation
	if (iRet == PD_TRUE) {
		iRet = PD_FALSE;	
		
		// Check status + ar_ind
		if (cStatus == PD_COMPLETE && cARInd == PD_ACCEPT) {

        		recordset_init(rTxnRecordSet,0);

                        DBObjPtr = CreateObj(DBPtr, "DBOLStmtTxnRelation","GetMultiTxnIdByStmtTxnId");
                        iDtlRet = (unsigned long)(*DBObjPtr)(csStmtTxnId,rTxnRecordSet);
                        if (iDtlRet == PD_FOUND) {
				hTxnRec = RecordSet_GetFirst(rTxnRecordSet);	
				while (hTxnRec) {
					
					if (GetField_CString(hTxnRec,"txn_id",&csTmp)) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: Call DBOLStmtTxnRelation:: GetMultiTxnIdByStmtTxnId txn_id = [%s]\n",csTmp));
			
						iDtlRet = PD_OK;
	
        					recordset_init(rBatchRecordSet,0);

						PutField_Char(hStmtTxnContext,"txn_level",PD_TXN_LEVEL);
						PutField_CString(hStmtTxnContext,"txn_id",csTmp);

						DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","GetBatchId");
                      				iDtlRet = (unsigned long)(*DBObjPtr)(hStmtTxnContext,rBatchRecordSet);
                        			if (iDtlRet == PD_OK) {
                                			hBatchRec = RecordSet_GetFirst(rBatchRecordSet);
                                			while (hBatchRec) {
								if (GetField_CString(hBatchRec,"batch_id",&csTmp)) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: Call DBOLBatchTxnRelation:: GetBatchId batch_id = [%s]\n",csTmp));
	
									if (!strcmp(csBatchId, csTmp)) {		
DEBUGLOG(("IsPutStmtTxnIdToBatch:: Call DBOLBatchTxnRelation:: GetBatchId batch_id [MATCH]\n"));
										iRet= PD_TRUE;
										break;
									}						
                                                		}
                                        			hBatchRec = RecordSet_GetNext(rBatchRecordSet);
							}
						} else {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: Call DBOLBatchTxnRelation:: GetBatchId failed!!!\n",csTmp));
						}
						RecordSet_Destroy(rBatchRecordSet);
					}
					hTxnRec = RecordSet_GetNext(rTxnRecordSet);
				}
                        } else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: Call DBOLStmtTxnRelation:: GetMultiTxnIdByStmtTxnId not found!!!\n"));
                        } else {
                                iRet = INT_ERR;
DEBUGLOG(("IsPutStmtTxnIdToBatch:: Call DBOLStmtTxnRelation:: GetMultiTxnIdByStmtTxnId invalid!!!\n"));
ERRLOG("TxnOmtByUsRBT::IsPutStmtTxnIdToBatch::Call DBOLStmtTxnRelation::GetMultiTxnIdByStmtTxnId() Invalid Stmt Txn Id!!!\n");
                        }
			RecordSet_Destroy(rTxnRecordSet);
		}
	}

	// Check txn_type -> status + ar_ind -> txn_code -> recon_status
	if (iRet == PD_TRUE) {
                if (!strcmp(csTxnType, PD_TXN_TYPE_HOLD_DEPOSIT)) {
			if ((cStatus == PD_COMPLETE) && (cARInd == PD_ACCEPT)) {
				if (!strcmp(csTxnCode, PD_BANK_DEPOSIT_TXN_CODE)) {
					iStmtTxnAction = PD_STMT_TXN_ACTION_KEEP_ORG_ID;	
DEBUGLOG(("IsPutStmtTxnIdToBatch:: stmt_txn_action = [Keep Org Stmt Txn Id]\n"));
				} else if (!strcmp(csTxnCode, PD_TXN_CODE_UNKNOWN_DEBIT)) {
                        	        iRet = PD_FALSE;
                        	}
			} else {
				iRet = PD_FALSE;
			}
		} else if (!strcmp(csTxnType, PD_TXN_TYPE_SMS_BANK_DEPOSIT)) {
			if ((cStatus == PD_COMPLETE) && (cARInd == PD_ACCEPT)) {
                              	if (cReconStatus == PD_UNRECONCILED) {
DEBUGLOG(("IsPutStmtTxnIdToBatch:: stmt_txn_action = [Change Org Stmt Txn Status]\n"));
					iStmtTxnAction = PD_STMT_TXN_ACTION_CHANGE_ORG_STATUS;	
				}
			} else {
				iRet = PD_FALSE;
			}
                } else {
			if ((cStatus == PD_COMPLETE) && (cARInd == PD_ACCEPT)) {
                		// Do Nothing...
			} else {
                        	iRet = PD_FALSE;
                	}
		}
        }

	// Set keep org stmt txn flag
	PutField_Int(hStmtTxnHeaderRec, "stmt_txn_action", iStmtTxnAction);

        FREE_ME(rTxnRecordSet);
        FREE_ME(rBatchRecordSet);

DEBUGLOG(("IsPutStmtTxnIdToBatch:: iRet = [%d]\n",iRet));
        return iRet;		
}

int     UpdateOrgTxnHeaderInfo(const char* csOrgTxnSeq, hash_t *hContext)
{
        int     iRet = PD_OK;

        char    *csTmp = NULL;

        hash_t  *hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec, 0);

/* org_txn_seq */
        PutField_CString(hRec, "txn_seq", csOrgTxnSeq);
DEBUGLOG(("UpdateOrgTxnHeaderInfo:: txn_seq [%s]\n", csOrgTxnSeq));

/* update_user */
        if (GetField_CString(hContext, "update_user", &csTmp)) {
DEBUGLOG(("UpdateOrgTxnHeaderInfo:: upate_user [%s]\n", csTmp));
                PutField_CString(hRec, "update_user", csTmp);
        }

/* status, sub_status */
        PutField_Char(hRec, "status", PD_REVERSED);
DEBUGLOG(("UpdateOrgTxnHeaderInfo:: status [%c]\n", PD_REVERSED));

        if (iAction == PD_BATCH_ACTION_CANCEL) {
                PutField_CString(hRec, "sub_status", PD_CANCELLED);
DEBUGLOG(("UpdateOrgTxnHeaderInfo:: sub_status [%s]\n", PD_CANCELLED));
        } else if (iAction == PD_BATCH_ACTION_VOID) {
                PutField_CString(hRec, "sub_status", PD_UNDO);
DEBUGLOG(("UpdateOrgTxnHeaderInfo:: sub_status [%s]\n", PD_UNDO));
        }

DEBUGLOG(("UpdateOrgTxnHeaderInfo:: Call DBOLTransaction:: Update\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
        iRet = (unsigned long)(*DBObjPtr)(hRec);
        if (iRet != PD_OK) {
                iRet = INT_ERR;
DEBUGLOG(("UpdateOrgTxnHeaderInfo:: Call DBOLTransaction:: Update failed!!!\n"));
ERRLOG("TxnOmtByUsRBT:: UpdateOrgTxnHeaderInfo:: Call DBOLTransaction:: Update failed!!!\n");
        }

        hash_destroy(hRec);
        FREE_ME(hRec);

DEBUGLOG(("UpdateOrgTxnHeaderInfo:: iRet = [%d]\n",iRet));
        return iRet;
}

int     AddTxnRelation(hash_t* hRls)
{
        int     iRet = PD_OK;

        char    cTmp;
        char    *csTmp = NULL;

        hash_t  *hRelation = (hash_t *) malloc (sizeof(hash_t));
        hash_init(hRelation, 0);

/* org_txn_seq */
        if(GetField_CString(hRls,"p1_txn_id",&csTmp)){
DEBUGLOG(("AddTxnRelation:: p1_txn_id = [%s]\n",csTmp));
                PutField_CString(hRelation,"p1_txn_id",csTmp);
        } else {
                iRet=INT_INVALID_TXN;
DEBUGLOG(("AddTxnRelation:: txn_seq not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddTxnRelation:: txn_seq not found!!\n");
        }

/* txn_seq */
        if(GetField_CString(hRls,"p2_txn_id",&csTmp)){
DEBUGLOG(("AddTxnRelation:: p2_txn_id = [%s]\n",csTmp));
                PutField_CString(hRelation,"p2_txn_id",csTmp);
        } else {
                iRet=INT_INVALID_TXN;
DEBUGLOG(("AddTxnRelation:: txn_seq not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddTxnRelation:: txn_seq not found!!\n");
        }

/* party */
        if(GetField_Char(hRls,"party",&cTmp)){
DEBUGLOG(("AddTxnRelation:: party = [%c]\n",cTmp));
                PutField_Char(hRelation,"party",cTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddTxnRelation:: party not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddTxnRelation:: party not found!!\n");
        }

/* txn_level */
        if(GetField_Char(hRls,"txn_level",&cTmp)){
DEBUGLOG(("AddTxnRelation:: txn_level = [%c]\n",cTmp));
                PutField_Char(hRelation,"txn_level",cTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddTxnRelation:: txn_level not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddTxnRelation:: txn_level not found!!\n");
        }

/* relation_type */
        if(GetField_Char(hRls,"relation_type",&cTmp)){
DEBUGLOG(("AddTxnRelation:: relation_type = [%c]\n",cTmp));
                PutField_Char(hRelation,"relation_type",cTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddTxnRelation:: relation_type not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddTxnRelation:: relation_type not found!!\n");
        }

/* user */
        if(GetField_CString(hRls,"add_user",&csTmp)){
DEBUGLOG(("AddTxnRelation:: add_user= [%s]\n",csTmp));
                PutField_CString(hRelation,"add_user",csTmp);
                PutField_CString(hRelation,"create_user",csTmp);
                PutField_CString(hRelation,"update_user",csTmp);
        } else {
                iRet = INT_ERR;
DEBUGLOG(("AddTxnRelation:: add_user missing\n"));
ERRLOG("TxnOmtByUsRBT:: AddTxnRelation:: add_user missing\n");
        }

        if (iRet == PD_OK) {
DEBUGLOG(("AddTxnRelation:: Call DBOLTxnRelation:: Add\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation", "Add");
                iRet = (unsigned long)(*DBObjPtr)(hRelation);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("AddTxnRelation:: Call DBOLTxnRelation:: Add failed!!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddTxnRelation:: Call DBOLTxnRelation:: Add failed!!!\n");
                }
        }

        hash_destroy(hRelation);
        FREE_ME(hRelation);

DEBUGLOG(("AddTxnRelation:: iRet = [%d]\n", iRet));
        return iRet;
}

int     AddBatchTxnRelation(hash_t* hRls)
{
        int     iRet = PD_OK;
	
	int	iTmp = 0;

        char    cTmp;
        char    *csTmp = NULL;

        hash_t  *hRelation = (hash_t *) malloc (sizeof(hash_t));
        hash_init(hRelation, 0);

/* batch_txn_seq */
        if(GetField_CString(hRls,"batch_txn_seq",&csTmp)){
DEBUGLOG(("AddBatchTxnRelation:: batch_id = [%s]\n",csTmp));
                PutField_CString(hRelation,"batch_id",csTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddBatchTxnRelation:: batch_txn_seq not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddBatchTxnRelation:: batch_txn_seq not found!!\n");
        }

/* batch_type */
        if(GetField_Char(hRls,"batch_type",&cTmp)){
DEBUGLOG(("AddBatchTxnRelation:: batch_type = [%c]\n",cTmp));
                PutField_Char(hRelation,"batch_type",cTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddBatchTxnRelation:: batch_type not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddBatchTxnRelation:: batch_type not found!!\n");
        }

/* batch_sub_type */
        if(GetField_Char(hRls,"batch_sub_type",&cTmp)){
DEBUGLOG(("AddBatchTxnRelation:: batch_sub_type = [%c]\n",cTmp));
                PutField_Char(hRelation,"batch_sub_type",cTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddBatchTxnRelation:: batch_sub_type not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddBatchTxnRelation:: batch_sub_type not found!!\n");
        }

/* txn_seq */
        if(GetField_CString(hRls,"txn_seq",&csTmp)){
DEBUGLOG(("AddBatchTxnRelation:: txn_id = [%s]\n",csTmp));
                PutField_CString(hRelation,"txn_id",csTmp);
        } else {
                iRet=INT_INVALID_TXN;
DEBUGLOG(("AddBatchTxnRelation:: txn_seq not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddBatchTxnRelation:: txn_seq not found!!\n");
        }

/* txn_level */
        if(GetField_Char(hRls,"txn_level",&cTmp)){
DEBUGLOG(("AddBatchTxnRelation:: txn_level = [%c]\n",cTmp));
                PutField_Char(hRelation,"txn_level",cTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddBatchTxnRelation:: txn_level not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddBatchTxnRelation:: txn_level not found!!\n");
        }

/* is_input_txn */
        if(GetField_Int(hRls,"is_input_txn",&iTmp)){
DEBUGLOG(("AddBatchTxnRelation:: is_input_txn = [%d]\n",iTmp));
                PutField_Int(hRelation,"is_input_txn",iTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddBatchTxnRelation:: is_input_txn not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddBatchTxnRelation:: is_input_txn not found!!\n");
        }

/* is_regen_txn */
        if(GetField_Int(hRls,"is_regen_txn",&iTmp)){
DEBUGLOG(("AddBatchTxnRelation:: is_regen_txn = [%d]\n",iTmp));
                PutField_Int(hRelation,"is_regen_txn",iTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddBatchTxnRelation:: is_regen_txn not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddBatchTxnRelation:: is_regen_txn not found!!\n");
        }

/* user */
        if(GetField_CString(hRls,"add_user",&csTmp)){
DEBUGLOG(("AddBatchTxnRelation:: add_user= [%s]\n",csTmp));
                PutField_CString(hRelation,"add_user",csTmp);
                PutField_CString(hRelation,"create_user",csTmp);
                PutField_CString(hRelation,"update_user",csTmp);
        } else {
                iRet = INT_ERR;
DEBUGLOG(("AddBatchTxnRelation:: add_user missing\n"));
ERRLOG("TxnOmtByUsRBT:: AddBatchTxnRelation:: add_user missing\n");
        }

        if (iRet == PD_OK) {
DEBUGLOG(("AddBatchTxnRelation:: Call DBOLBatchTxnRelation:: Add\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation", "Add");
                iRet = (unsigned long)(*DBObjPtr)(hRelation);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("AddBatchTxnRelation:: Call DBOLBatchTxnRelation:: Add failed!!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddBatchTxnRelation:: Call DBOLBatchTxnRelation:: Add failed!!!\n");
                }
        }

        hash_destroy(hRelation);
        FREE_ME(hRelation);

DEBUGLOG(("AddBatchTxnRelation:: iRet = [%d]\n", iRet));
        return iRet;
}

int     AddBatchRelation(hash_t* hRls)
{
        int     iRet = PD_OK;

	char	cTmp;	

        char    *csTmp = NULL;

        hash_t  *hRelation = (hash_t *) malloc (sizeof(hash_t));
        hash_init(hRelation, 0);

/* org_batch_id */
        if(GetField_CString(hRls,"org_batch_id",&csTmp)){
DEBUGLOG(("AddBatchRelation:: org_batch_id = [%s]\n",csTmp));
                PutField_CString(hRelation,"org_batch_id",csTmp);
        } else {
                iRet=INT_INVALID_TXN;
DEBUGLOG(("AddBatchRelation:: org_batch_id not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddBatchRelation:: org_batch_id not found!!\n");
        }

/* batch_id */
        if(GetField_CString(hRls,"batch_id",&csTmp)){
DEBUGLOG(("AddBatchRelation:: batch_id = [%s]\n",csTmp));
                PutField_CString(hRelation,"batch_id",csTmp);
        } else {
                iRet=INT_INVALID_TXN;
DEBUGLOG(("AddBatchRelation:: batch_id not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddBatchRelation:: batch_id not found!!\n");
        }

/* batch_sub_type */
        if(GetField_Char(hRls,"batch_sub_type",&cTmp)){
DEBUGLOG(("AddBatchRelation:: batch_sub_type = [%c]\n",cTmp));
                PutField_Char(hRelation,"batch_sub_type",cTmp);
        } else {
                iRet=INT_ERR;
DEBUGLOG(("AddBatchRelation:: batch_sub_type not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddBatchRelation:: batch_sub_type not found!!\n");
        }

/* user */
        if(GetField_CString(hRls,"add_user",&csTmp)){
DEBUGLOG(("AddBatchRelation:: add_user= [%s]\n",csTmp));
                PutField_CString(hRelation,"add_user",csTmp);
                PutField_CString(hRelation,"create_user",csTmp);
                PutField_CString(hRelation,"update_user",csTmp);
        } else {
                iRet = INT_ERR;
DEBUGLOG(("AddBatchRelation:: add_user missing\n"));
ERRLOG("TxnOmtByUsRBT:: AddBatchRelation:: add_user missing\n");
        }

	if (iRet == PD_OK) {
DEBUGLOG(("AddBatchRelation:: Call DBOLBatchRelation:: Add\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLBatchRelation", "Add");
                iRet = (unsigned long)(*DBObjPtr)(hRelation);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("AddBatchRelation:: Call DBOLBatchRelation:: Add failed!!!\n"));
ERRLOG("TxnOmtByUsRBT:: AddBatchRelation:: Call DBOLBatchRelation:: Add failed!!!\n");
                }
        }

        hash_destroy(hRelation);
        FREE_ME(hRelation);

DEBUGLOG(("AddBatchRelation:: iRet = [%d]\n", iRet));
        return iRet;
}

int     AddNewTxnRelationLinkage(const char* csOrgBatchId, hash_t *hContext, hash_t *hTxnRelation)
{
      	int 	iRet = PD_OK;
        int 	iDtlRet = PD_FOUND;
	int	iTmpRet = PD_FALSE;
	int	iCnt = 0;

	char 	*csUser = NULL;
	char 	*csP1OrgTxnId = NULL;
	char 	*csP1NewTxnId = NULL;
	char 	*csP2OrgTxnId = NULL;
	char 	*csP2NewTxnId = NULL;
	char	csTag[PD_TMP_BUF_LEN+1];

        hash_t  *hRec = NULL;

	hash_t	*hRls = NULL;
        hRls = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRls,0);
        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t *)malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	PutField_CString(hRls,"batch_id",csOrgBatchId);
	if (GetField_CString(hContext,"update_user",&csUser)) {
		PutField_CString(hRls,"update_user",csUser);
		PutField_CString(hRls,"add_user",csUser);
		PutField_CString(hRls,"create_user",csUser);
	}

DEBUGLOG(("AddNewTxnRelationLinkage:: org_batch_id = [%s]\n",csOrgBatchId));
        DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","GetTxnRelationByBatchId");
        iDtlRet = (unsigned long)(*DBObjPtr)(hRls,rRecordSet);
	if (iDtlRet == PD_FOUND) {
        	hRec = RecordSet_GetFirst(rRecordSet);
                while ((hRec) && (iRet == PD_OK)) {
                	if (GetField_CString(hRec,"p1_txn_id",&csP1OrgTxnId)) {
				sprintf(csTag,"id_%s",csP1OrgTxnId);
				if (GetField_CString(hTxnRelation,csTag,&csP1NewTxnId)) {
					PutField_CString(hRls,"p1_txn_id",csP1NewTxnId);
					iTmpRet = PD_TRUE;
				} else {
					iTmpRet = PD_FALSE;
				}
                        }

			if (iTmpRet == PD_TRUE) {
                		if (GetField_CString(hRec,"p2_txn_id",&csP2OrgTxnId)) {
					sprintf(csTag,"id_%s",csP2OrgTxnId);
					if (GetField_CString(hTxnRelation,csTag,&csP2NewTxnId)) {
						PutField_CString(hRls,"p2_txn_id",csP2NewTxnId);
						iTmpRet = PD_TRUE;
					} else {
						iTmpRet = PD_FALSE;
					}
                        	}
			}

			PutField_Char(hRls, "party", PD_TYPE_PSP);
			PutField_Char(hRls, "txn_level", PD_TXN_LEVEL);
			PutField_Char(hRls, "relation_type", PD_REL_LINKAGE);			

			if (iTmpRet == PD_TRUE) {
DEBUGLOG(("AddNewTxnRelationLinkage:: [%d]p1_org_txn_id = [%s]\n",iCnt,csP1OrgTxnId));
DEBUGLOG(("AddNewTxnRelationLinkage:: [%d]p1_new_txn_id = [%s]\n",iCnt,csP1NewTxnId));
DEBUGLOG(("AddNewTxnRelationLinkage:: [%d]p2_org_txn_id = [%s]\n",iCnt,csP2OrgTxnId));
DEBUGLOG(("AddNewTxnRelationLinkage:: [%d]p2_new_txn_id = [%s]\n",iCnt,csP2NewTxnId));
DEBUGLOG(("AddNewTxnRelationLinkage:: [%d]Call AddTxnRelation() [Linkage]\n",iCnt));
                		iRet = AddTxnRelation(hRls);
			} else {
DEBUGLOG(("AddNewTxnRelationLinkage:: [%d]p1_txn_id/p2_txn_id void not found!!!\n",iCnt));
			}
	
			iCnt++;

                        hRec = RecordSet_GetNext(rRecordSet);
                }
        } else {
DEBUGLOG(("AddNewTxnRelationLinkage:: Call DBOLTxnRelation:: GetTxnRelationByBatchId:: No Record Found!!!\n"));
        }

        hash_destroy(hRls);
        FREE_ME(hRls);

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

DEBUGLOG(("AddNewTxnRelationLinkage:: iRet = [%d]\n", iRet));
        return iRet;
}

int	AddLastTxnRelationLinkage(hash_t *hRec)
{	
        int     iRet = PD_OK;

	char	cTmp;
        char    *csTmp = NULL;
	
	hash_t *hRelation;
        hRelation = (hash_t*) malloc(sizeof(hash_t));
	hash_init(hRelation, 0);
	
	if (GetField_CString(hRec, "p1_last_txn_seq", &csTmp)) {
DEBUGLOG(("AddLastTxnRelationLinkage:: p1_last_txn_seq = [%s]\n", csTmp));
		PutField_CString(hRelation, "p1_txn_id", csTmp);
	}

	if (GetField_CString(hRec, "p2_last_txn_seq", &csTmp)) {
DEBUGLOG(("AddLastTxnRelationLinkage:: p2_last_txn_seq = [%s]\n", csTmp));
		PutField_CString(hRelation, "p2_txn_id", csTmp);
        }

	if (GetField_Char(hRec,"relation_type",&cTmp)) {
DEBUGLOG(("AddLastTxnRelationLinkage:: relation_type = [%c]\n", cTmp));
                PutField_Char(hRelation, "relation_type", cTmp);
        }

	if (GetField_CString(hRec, "update_user", &csTmp)) {
DEBUGLOG(("AddLastTxnRelationLinkage:: update_user = [%s]\n", csTmp));
		PutField_CString(hRelation, "update_user", csTmp);
                PutField_CString(hRelation, "add_user", csTmp);
               	PutField_CString(hRelation, "create_user", csTmp);
	}

	PutField_Char(hRelation, "party", PD_TYPE_PSP);
	PutField_Char(hRelation, "txn_level", PD_TXN_LEVEL);	

DEBUGLOG(("AddLastTxnRelationLinkage:: Call AddTxnRelation() [BalTrsf]\n"));
	iRet = AddTxnRelation(hRelation);

       	hash_destroy(hRelation);
	FREE_ME(hRelation);

DEBUGLOG(("AddLastTxnRelationLinkage:: iRet = [%d]\n", iRet));
        return iRet;
}

int	ProcessOffsetTxn(const char* csOrgTxnSeq, hash_t* hOrgTxn, hash_t* hNewTxn, hash_t* hContext)
{
	int	iRet = PD_OK;

DEBUGLOG(("ProcessOffsetTxn:: txn_id [%s]\n", csOrgTxnSeq));

	// Lock Org Txn + Get Org Txn Info
	iRet = GetTxnInfo(csOrgTxnSeq, hContext, hOrgTxn);

	// Form Offset Txn (include reversal CR / DR sign)
	if (iRet == PD_OK) {
		iRet = FormNewTxn(PD_FALSE, hOrgTxn, hNewTxn, hContext);
	}

	// Create Txn (with add approval_date, approval_timestamp) + Update Balance
	if (iRet == PD_OK) {
		iRet = CreateNewTxn(PD_FALSE, hNewTxn, hContext);
	}

	// Update Org Txn Status
	if (iRet == PD_OK) {
		iRet = UpdateOrgTxn(hOrgTxn, hContext);
	}

DEBUGLOG(("ProcessOffsetTxn:: iRet = [%d]\n", iRet));
	return iRet;
}

int     GetTxnInfo(const char *csTxnSeq, hash_t *hContext, hash_t *hTxn)
{
        int     iRet = PD_OK;

        char    *csTmp = NULL;
        char    cTmp;
        double  dTmp = 0.0;
        int     iTmp = 0;

        char   	*csBaid = NULL;
	char    *csBaidCategory = (char*) malloc (64);

        int     iTotalElement = 0;

	char    csBaidCountry[PD_COUNTRY_LEN + 1];
        char    csTag[PD_TAG_LEN + 1];

        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

        hash_t  *hRec = NULL;

        hash_t  *hTxnPspDetail = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnPspDetail, 0);

        hash_t  *hBaidDetail = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBaidDetail, 0);

DEBUGLOG(("GetTxnInfo:: Call DBOLTransaction:: GetTxnIdForUpdateNoWait [%s]\n", csTxnSeq));
        DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnIdForUpdateNoWait");
        iRet = (unsigned long)(*DBObjPtr)(csTxnSeq);
        if (iRet == PD_OK) {
                PutField_CString(hTxn, "txn_seq", csTxnSeq);
        } else {
                iRet = INT_OTHER_VOID_PROCESSING;
		PutField_Int(hContext,"internal_error",iRet);
                TxnAbort();
DEBUGLOG(("GetTxnInfo:: Call DBOLTransaction:: GetTxnIdForUpdateNoWait:: Other Void Transaction is Processing!!!\n"));
ERRLOG("TxnOmtByUsRBT::GetTxnInfo:: Call DBOLTransaction:: GetTxnIdForUpdateNoWait:: Other Void Transaction is Processing!!!\n");
        }

	// Txn Header
	if (iRet == PD_OK) {
                recordset_init(rRecordSet,0);

                DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnHeader");
                iRet = (unsigned long)(*DBObjPtr)(csTxnSeq,rRecordSet);
                if (iRet == PD_OK) {
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* txn_code */
                                if (GetField_CString(hRec, "txn_code", &csTmp)) {
                                        PutField_CString(hTxn, "txn_code", csTmp);
DEBUGLOG(("GetTxnInfo (Header):: txn_code = [%s]\n", csTmp));
                                }

/* process_type */
                                if (GetField_CString(hRec, "process_type", &csTmp)) {
                                        PutField_CString(hTxn, "process_type", csTmp);
//DEBUGLOG(("GetTxnInfo (Header):: process_type = [%s]\n", csTmp));
                                }

/* process_code */
                                if (GetField_CString(hRec, "process_code", &csTmp)) {
                                        PutField_CString(hTxn, "process_code", csTmp);
//DEBUGLOG(("GetTxnInfo (Header):: process_code = [%s]\n", csTmp));
                                }

/* status */
                                if (GetField_Char(hRec, "status", &cTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: status = [%c]\n", cTmp));
                                }

/* ar_ind */
                                if (GetField_Char(hRec, "ar_ind", &cTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: ar_ind = [%c]\n", cTmp));
                                }

/* sub_status */
                                if (GetField_CString(hRec, "sub_status", &csTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: sub_status = [%s]\n", csTmp));
                                }

/* recon_status */
                                if (GetField_Char(hRec, "recon_status", &cTmp)) {
                                        PutField_Char(hTxn, "recon_status", cTmp);
DEBUGLOG(("GetTxnInfo (Header):: recon_status = [%c]\n", cTmp));
                                }

/* txn_amt */
                                if (GetField_Double(hRec, "txn_amt", &dTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: txn_amt = [%lf]\n", dTmp));
                                        PutField_Double(hTxn, "txn_amt", dTmp);
                                }

/* net_amt */
                                if (GetField_Double(hRec, "net_amt", &dTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: net_amt = [%lf]\n", dTmp));
                                        PutField_Double(hTxn, "net_amt", dTmp);
                                }

/* net_ccy */
                                if (GetField_CString(hRec, "net_ccy", &csTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: net_ccy = [%s]\n",csTmp));
                                        PutField_CString(hTxn,"net_ccy",csTmp);
                                }

/* deposit_amt */
                                if (GetField_Double(hRec, "deposit_amt", &dTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: deposit_amt = [%lf]\n",dTmp));
                                        PutField_Double(hTxn,"deposit_amt",dTmp);
                                }

/* display_amt */
                                if (GetField_Double(hRec, "display_amt", &dTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: display_amt= [%lf]\n",dTmp));
                                        PutField_Double(hTxn,"display_amt",dTmp);
                                }

/* ex_supplier */
                                if (GetField_Char(hRec, "ex_supplier", &cTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: ex_supplier = [%c]\n", cTmp));
                                        PutField_Char(hTxn,"ex_supplier",cTmp);
                                }

/* ex_rate */
                                if (GetField_Double(hRec, "ex_rate", &dTmp)) {
DEBUGLOG(("GetTxnInfo (Header):: ex_rate = [%lf]\n", dTmp));
                                        PutField_Double(hTxn,"ex_rate",dTmp);
                                }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                } else {
DEBUGLOG(("GetTxnInfo (Header):: not found record for [%s]\n",csTxnSeq));
                        iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
			TxnAbort();
                }

                RecordSet_Destroy(rRecordSet);
	}

	// TxnPspDetail
	if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBOLTxnPspDetail","GetTxnPspDetail");
                iRet = (unsigned long)(*DBObjPtr)(csTxnSeq,hTxnPspDetail);
                if (iRet == PD_OK) {

/* psp_id */
                        if (GetField_CString(hTxnPspDetail, "psp_id", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: psp_id = [%s]\n", csTmp));
                                PutField_CString(hTxn, "psp_id", csTmp);
                        }

/* baid */
			if (GetField_CString(hTxnPspDetail, "baid", &csBaid)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: baid = [%s]\n", csBaid));
                                PutField_CString(hTxn, "baid", csBaid);

				// check baid country				
                                DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetBankAcctIdCountry");
                                if ((unsigned long)(*DBObjPtr)(csBaid, csBaidCountry) == FOUND) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: txn_country = [%s]\n", csBaidCountry));
					PutField_CString(hTxn, "txn_country", csBaidCountry);
                                } else {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: Call DBOLBankAcctId:: GetBankAcctIdCountry:: baid_country NOT FOUND!!!\n"));
                                        iRet = INT_BAID_COUNTRY_NOT_FOUND;
					PutField_Int(hContext,"internal_error",iRet);
					TxnAbort();
                                }
                        }

/* txn_ccy */
                        if (GetField_CString(hTxnPspDetail, "txn_ccy", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: txn_ccy = [%s]\n", csTmp));
                                PutField_CString(hTxn, "txn_ccy", csTmp);
                        }

/* txn_amount */
                        if (GetField_Double(hTxnPspDetail, "txn_amount", &dTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: txn_amount = [%f]\n", dTmp));
                                PutField_Double(hTxn, "txn_amount", dTmp);
                        }

/* bank_code */
                        if (GetField_CString(hTxnPspDetail, "bank_code", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: bank_code = [%s]\n", csTmp));
                                PutField_CString(hTxn, "bank_code", csTmp);
                        }

/* bank_acct_num */
                        if (GetField_CString(hTxnPspDetail, "bank_acct_num", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: bank_acct_num = [%s]\n", csTmp));
                                PutField_CString(hTxn, "bank_acct_num", csTmp);
                        }

/* cost */
                        if (GetField_Double(hTxnPspDetail, "cost", &dTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: cost = [%lf]\n", dTmp));
                                PutField_Double(hTxn, "cost", dTmp);
                        }

/* txn_hold_ind */
                        if (GetField_Int(hTxnPspDetail, "txn_hold_ind", &iTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: txn_hold_ind = [%d]\n", iTmp));
                                PutField_Int(hTxn, "txn_hold_ind", iTmp);
                        }

/* sys_match_ind */
                        if (GetField_Int(hTxnPspDetail, "sys_match_ind", &iTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: sys_match_ind = [%d]\n", iTmp));
                                PutField_Int(hTxn, "sys_match_ind", iTmp);
                        }

/* customer_text */
                        if (GetField_CString(hTxnPspDetail, "customer_text", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: customer_text = [%s]\n", csTmp));
                                PutField_CString(hTxn, "customer_text", csTmp);
                        }

/* sender_name */
                        if (GetField_CString(hTxnPspDetail, "sender_name", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: sender_name = [%s]\n", csTmp));
                                PutField_CString(hTxn, "sender_name", csTmp);
                        }

/* txn_ref_num */
                        if (GetField_CString(hTxnPspDetail, "txn_ref_num", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: txn_ref_num = [%s]\n", csTmp));
                                PutField_CString(hTxn, "txn_ref_num", csTmp);
                        }

/* charge_rule_id */
/*
			if (GetField_Int(hTxnPspDetail, "charge_rule_id", &iTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: charge_rule_id = [%d]\n", iTmp));
				PutField_Int(hTxn, "charge_rule_id", iTmp);
			}
*/

/* charge_period_type */
/*
			if (GetField_Char(hTxnPspDetail, "charge_period_type", &cTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: charge_period_type = [%c]\n", cTmp));
				PutField_Char(hTxn, "charge_period_type", cTmp);
			}
*/

/* precal_charge */
/*
			if (GetField_Double(hTxnPspDetail, "precal_charge", &dTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: precal_charge = [%f]\n", dTmp));
				PutField_Double(hTxn, "precal_charge", dTmp);
			}
*/

/* grp_tracking_txn_id */
                        if (GetField_CString(hTxnPspDetail, "grp_tracking_txn_seq", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: grp_tracking_txn_seq = [%s]\n", csTmp));
                                PutField_CString(hTxn, "grp_tracking_txn_seq", csTmp);
                        }

/* tracking_txn_id */
                        if (GetField_CString(hTxnPspDetail, "tracking_txn_seq", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: tracking_txn_seq = [%s]\n", csTmp));
                                PutField_CString(hTxn, "tracking_txn_seq", csTmp);
                        }

/* report_date */
                        if (GetField_CString(hTxnPspDetail, "report_date", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: report_date = [%s]\n", csTmp));
                                PutField_CString(hTxn, "report_date", csTmp);
                        }

/* settlement_date */
                        if (GetField_CString(hTxnPspDetail, "settlement_date", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: settlement_date = [%s]\n", csTmp));
                                PutField_CString(hTxn, "settlement_date", csTmp);
                        }

/* manual_hold_recon  */
                     	if (GetField_Int(hTxnPspDetail, "manual_hold_recon", &iTmp)) {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: manual_hold_recon = [%d]\n", iTmp));
                       		PutField_Int(hTxn,"manual_hold_recon",iTmp);
                    	}

                } else {
DEBUGLOG(("GetTxnInfo (TxnPspDetail):: not found record for [%s]\n",csTxnSeq));
                        iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
			TxnAbort();
                }
        }

	// Txn Elements
	if (iRet == PD_OK) {
                DBObjPtr = CreateObj(DBPtr,"DBOLTxnElements","GetAllFeeChgDetail");
                iRet = (unsigned long)(*DBObjPtr)(csTxnSeq,rRecordSet);
                if (iRet == PD_OK) {
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec && (iRet == PD_OK)) {
                                iTotalElement++;

/* txn_element_type */
                                if (GetField_CString(hRec, "txn_element_type", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnElements):: [%d] element_type = [%s]\n", iTotalElement, csTmp));
                                        sprintf(csTag, "element_type_%d", iTotalElement);
                                        PutField_CString(hTxn, csTag, csTmp);
                                }

/* amount */
                                if (GetField_Double(hRec, "amount", &dTmp)) {
DEBUGLOG(("GetTxnInfo (TxnElements):: [%d] amt_type = [%f]\n", iTotalElement, dTmp));
                                        sprintf(csTag, "element_amount_%d", iTotalElement);
                                        PutField_Double(hTxn, csTag, dTmp);
                                }

/* ccy */
                                if (GetField_CString(hRec, "ccy", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnElements):: [%d] ccy = [%s]\n", iTotalElement, csTmp));
                                        sprintf(csTag, "element_ccy_%d", iTotalElement);
                                        PutField_CString(hTxn, csTag, csTmp);
                                }

/* amt_type */
                                if (GetField_CString(hRec, "amt_type", &csTmp)) {
DEBUGLOG(("GetTxnInfo (TxnElements):: [%d] amt_type = [%s]\n", iTotalElement, csTmp));
                                        sprintf(csTag, "element_amt_type_%d", iTotalElement);
                                        PutField_CString(hTxn, csTag, csTmp);
                                }

/* party_type */
                                if (GetField_Char(hRec, "party_type", &cTmp)) {
DEBUGLOG(("GetTxnInfo (TxnElements):: [%d] party_type = [%c]\n", iTotalElement, cTmp));
                                        sprintf(csTag, "element_party_type_%d", iTotalElement);
                                        PutField_Char(hTxn, csTag, cTmp);
                                }

/* rate */
                                if (GetField_Double(hRec, "rate", &dTmp)) {
DEBUGLOG(("GetTxnInfo (TxnElements):: Cnt[%d] rate = [%f]\n", iTotalElement, dTmp));
                                        sprintf(csTag, "element_rate_%d", iTotalElement);
                                        PutField_Double(hTxn, csTag, dTmp);
                                }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
			
			sprintf(csTag, "element_total_cnt");
                        PutField_Int(hTxn, csTag, iTotalElement);
DEBUGLOG(("GetTxnInfo (TxnElements):: total_element [%d]\n", iTotalElement));

                        RecordSet_Destroy(rRecordSet);
                } else {
DEBUGLOG(("GetTxnInfo (TxnElements):: not found record for [%s]\n",csTxnSeq));
                        iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
			TxnAbort();
                }
        }
	
	// Baid Category
        if (iRet == PD_OK) {
        	DBObjPtr = CreateObj(DBPtr, "DBOLBankAcctId", "GetCategoryByTxnId");
        	if ((*DBObjPtr)(csTxnSeq,csBaidCategory) == PD_OK) {
/* baid_category */
                	PutField_CString(hTxn, "baid_category", csBaidCategory);
DEBUGLOG(("GetTxnInfo (BaidCategory):: baid_category = [%s]\n",csBaidCategory));

        	} else {
DEBUGLOG(("GetTxnInfo (BaidCategory):: not found record for [%s]\n", csTxnSeq));
                	iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
        	}
	}

        hash_destroy(hTxnPspDetail);
        FREE_ME(hTxnPspDetail);

        hash_destroy(hBaidDetail);
        FREE_ME(hBaidDetail);

        FREE_ME(rRecordSet);

	FREE_ME(csBaidCategory);

DEBUGLOG(("GetTxnInfo:: iRet = [%d]\n",iRet));
        return iRet;
}	

int     FormNewTxn(int iIsLastTxn, hash_t *hOrgTxn, hash_t *hNewTxn, hash_t *hContext)
{
        int     iRet = PD_OK;

	char	csVoidTxnCode[PD_TXN_CODE_LEN + 1];
        char    csOfstTxnSeq[PD_TXN_SEQ_LEN + 1];
        char    csTxnDateTime[PD_DATETIME_LEN + 1];
        char    csTag[PD_TAG_LEN + 1];

        int     iElementCnt = 0;

        char    cPartyType;
        char    cTmpDCInd;
        char    *csOrgCcy = NULL;
        char    *csOrgElementCcy = NULL;
        char    *csOrgElementType = NULL;
        char    *csOrgElementAmtType = NULL;
        double  dOrgElementAmount = 0.0;
        double  dTotalAcctBal = 0.0;
        double  dTotalIntransitBal = 0.0;

        char    *csTmp = NULL;
        char    cTmp;
        double  dTmp = 0.0;
        int     iTmp = 0;

        int     i;

	cPartyType = ' ';
	cTmpDCInd = ' ';

/* txn_seq */
        DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextOmtTxnSeq");
        strcpy(csOfstTxnSeq, (*DBObjPtr)());
DEBUGLOG(("FormNewTxn:: Call DBOLTxnSeq: GetNextOmtTxnSeq [%s]\n", csOfstTxnSeq));
        PutField_CString(hNewTxn, "txn_seq", csOfstTxnSeq);

/* org_txn_id */
        if (GetField_CString(hOrgTxn, "txn_seq", &csTmp)) {
DEBUGLOG(("FormNewTxn:: org_txn_seq [%s]\n", csTmp));
                PutField_CString(hNewTxn, "org_txn_seq", csTmp);
        }

/* channel */
        if (GetField_CString(hContext, "channel_code", &csTmp)) {
DEBUGLOG(("FormNewTxn:: channel_code [%s]\n", csTmp));
                PutField_CString(hNewTxn, "channel_code", csTmp);
        }

	// Txn Header

/* status */
        PutField_Char(hNewTxn,"status",PD_PROCESSING);

/* txn_code and is_void*/
        if (GetField_CString(hOrgTxn, "txn_code", &csTmp)) {
DEBUGLOG(("FormNewTxn (Header):: txn_code [%s]\n", csTmp));
		if (iIsLastTxn) {
			PutField_CString(hNewTxn, "txn_code", csTmp);

                        DBObjPtr = CreateObj(DBPtr,"DBTxnCode","IsVoid");
                        iTmp = (unsigned long)(*DBObjPtr)(csTmp);
DEBUGLOG(("FormNewTxn (Header):: is_void [%d]\n",iTmp));
                        PutField_Int(hContext, "is_void", iTmp);

		} else {
			// Get void txn code from DBTxnCode
			DBObjPtr = CreateObj(DBPtr, "DBTxnCode", "FindVoidTxnCode");
			if ((unsigned long)(*DBObjPtr)(csTmp,csVoidTxnCode) == PD_FOUND) {
	           		PutField_CString(hNewTxn, "txn_code", csVoidTxnCode);
DEBUGLOG(("FormNewTxn (Header):: void_txn_code [%s]\n", csVoidTxnCode));
			} else {
DEBUGLOG(("FormNewTxn (Header):: Call DBTxnCode:: FindVoidTxnCode:: void_txn_code not found!!!\n"));
			}

	              	DBObjPtr = CreateObj(DBPtr,"DBTxnCode","IsVoid");
	              	iTmp = (unsigned long)(*DBObjPtr)(csVoidTxnCode);
DEBUGLOG(("FormNewTxn (Header):: is_void [%d]\n",iTmp));
	             	PutField_Int(hContext, "is_void", iTmp);		
		}
        }

/* amt_type */
	if (GetField_Char(hOrgTxn, "amt_type", &cTmp)) {
DEBUGLOG(("FormNewTxn (Header):: amt_type [%c]\n", cTmp));
              	PutField_Char(hNewTxn, "amt_type", cTmp);
	}

/* process_type */
        PutField_CString(hNewTxn,"process_code", PD_PROCESS_CODE_DEF);

/* process_code */
        PutField_CString(hNewTxn,"process_type", PD_PROCESS_TYPE_DEF);

/* host_posting_date */
        if (GetField_CString(hContext, "PHDATE", &csTmp)) {
DEBUGLOG(("FormNewTxn (Header):: host_posting_date [%s]\n", csTmp));
                PutField_CString(hNewTxn, "host_posting_date", csTmp);
        }

/* transmission_datetime */
        if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
DEBUGLOG(("FormNewTxn (Header):: transmission_time [%s]\n", csTmp));
                PutField_CString(hNewTxn, "local_tm_date", csTmp);
                PutField_CString(hNewTxn, "tm_date", csTmp);

                strcpy(csTxnDateTime, csTmp);
                PutField_CString(hNewTxn, "transmission_datetime", csTxnDateTime);

                if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
DEBUGLOG(("FormNewTxn (Header):: transmission_date [%s]\n", csTmp));
                        PutField_CString(hNewTxn, "local_tm_time", csTmp);

                        strcat(csTxnDateTime, csTmp);
                        PutField_CString(hNewTxn, "transmission_datetime", csTxnDateTime);
                }
        }

/* transaction_amount */
        if  (GetField_Double(hOrgTxn, "txn_amt", &dTmp)) {
DEBUGLOG(("FormNewTxn (Header):: transaction_amount [%f]\n", dTmp));
                PutField_Double(hNewTxn, "txn_amt", dTmp);
        }

/* net_amt */
        if (GetField_Double(hOrgTxn, "net_amt", &dTmp)) {
DEBUGLOG(("FormNewTxn (Header):: net_amt [%f]\n", dTmp));
                PutField_Double(hNewTxn,"net_amt",dTmp);
        }

/* net_ccy */
        if (GetField_CString(hOrgTxn, "net_ccy", &csTmp)) {
DEBUGLOG(("FormNewTxn (Header):: net_ccy [%s]\n", csTmp));
                PutField_CString(hNewTxn,"net_ccy",csTmp);
        }

/* deposit_amt */
        if (GetField_Double(hOrgTxn, "deposit_amt", &dTmp)) {
DEBUGLOG(("FormNewTxn (Header):: deposit_amt [%f]\n", dTmp));
                PutField_Double(hNewTxn,"deposit_amt",dTmp);
        }

/* display_amt */
        if (GetField_Double(hOrgTxn, "display_amt", &dTmp)) {
DEBUGLOG(("FormNewTxn (Header):: display_amt [%f]\n", dTmp));
                PutField_Double(hNewTxn,"display_amt",dTmp);
        }

/* ex_supplier */
        if (GetField_Char(hOrgTxn, "ex_supplier", &cTmp)) {
DEBUGLOG(("FormNewTxn (Header):: ex_supplier [%c]\n", cTmp));
                PutField_Char(hNewTxn,"ex_supplier",cTmp);
        }

/* ex_rate */
        if (GetField_Double(hOrgTxn, "ex_rate", &dTmp)) {
DEBUGLOG(("FormNewTxn (Header):: ex_rate [%f]\n", dTmp));
                PutField_Double(hNewTxn,"ex_rate",dTmp);
        }

/* response_code */
        PutField_CString(hNewTxn, "response_code", "0");

/* internal_code */
        PutField_Int(hNewTxn, "internal_code", 0);

	// Txn PSP Detail

/* psp_id */
        if (GetField_CString(hOrgTxn, "psp_id", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: psp_id [%s]\n", csTmp));
                PutField_CString(hNewTxn, "psp_id", csTmp);
        }

/* baid */
        if (GetField_CString(hOrgTxn, "baid", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: baid [%s]\n", csTmp));
                PutField_CString(hNewTxn, "baid", csTmp);
        }

/* txn_date */
        if (GetField_CString(hContext, "PHDATE", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: txn_date [%s]\n", csTmp));
                PutField_CString(hNewTxn, "txn_date", csTmp);
        }

/* txn_ccy */
        if (GetField_CString(hOrgTxn, "txn_country", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: txn_country [%s]\n", csTmp));
                PutField_CString(hNewTxn, "txn_country", csTmp);
        }

/* txn_ccy */
        if (GetField_CString(hOrgTxn, "txn_ccy", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: txn_ccy [%s]\n", csTmp));
                PutField_CString(hNewTxn, "txn_ccy", csTmp);
        }

/* txn_amount */
        if (GetField_Double(hOrgTxn, "txn_amount", &dTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: txn_amount [%f]\n", dTmp));
                PutField_Double(hNewTxn, "txn_amount", dTmp);
        }

/* bank_code */
        if (GetField_CString(hOrgTxn, "bank_code", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: bank_code [%s]\n", csTmp));
                PutField_CString(hNewTxn, "bank_code", csTmp);
        }

/* bank_acct_num */
        if (GetField_CString(hOrgTxn, "bank_acct_num", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: bank_acct_num [%s]\n", csTmp));
                PutField_CString(hNewTxn, "bank_acct_num", csTmp);
        }

/* cost */
        if (GetField_Double(hOrgTxn, "cost", &dTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: cost [%f]\n", dTmp));
                PutField_Double(hNewTxn, "cost", dTmp);
        }

/* txn_hold_ind */
        if (GetField_Int(hOrgTxn, "txn_hold_ind", &iTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: txn_hold_ind [%d]\n", iTmp));
                PutField_Int(hNewTxn, "txn_hold_int", iTmp);
        }

/* sys_match_ind */
        if (GetField_Int(hOrgTxn, "sys_match_ind", &iTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: sys_match_ind [%d]\n", iTmp));
                PutField_Int(hNewTxn, "sys_match_ind", iTmp);
        }

/* customer_text */
        if (GetField_CString(hOrgTxn, "customer_text", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: customer_text [%s]\n", csTmp));
                PutField_CString(hNewTxn, "customer_text", csTmp);
        }

/* sender_name */
        if (GetField_CString(hOrgTxn, "sender_name", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: sender_name [%s]\n", csTmp));
                PutField_CString(hNewTxn, "sender_name", csTmp);
        }

/* txn_ref_num */
        if (GetField_CString(hOrgTxn, "txn_ref_num", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: txn_ref_num [%s]\n", csTmp));
                PutField_CString(hNewTxn, "txn_ref_num", csTmp);
        }

/* charge_rule_id */
/*
	if (GetField_Int(hOrgTxn, "charge_rule_id", &iTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: charge_rule_id = [%d]\n", iTmp));
		PutField_Int(hNewTxn, "charge_rule_id", iTmp);
	}
*/

/* charge_period_type */
/*
	if (GetField_Char(hOrgTxn, "charge_period_type", &cTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: charge_period_type = [%c]\n", cTmp));
		PutField_Char(hNewTxn, "charge_period_type", cTmp);
	}
*/

/* precal_charge */
/*
	if (GetField_Double(hOrgTxn, "precal_charge", &dTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: precal_charge = [%f]\n", dTmp));
		PutField_Double(hNewTxn, "precal_charge", dTmp);
	}
*/

/* grp_tracking_txn_seq */
	if (GetField_CString(hOrgTxn, "grp_tracking_txn_seq", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: grp_tracking_txn_Seq = [%s]\n", csTmp));
		PutField_CString(hNewTxn, "grp_tracking_txn_seq", csTmp);
	}

/* tracking_txn_seq */
	if (GetField_CString(hOrgTxn, "tracking_txn_seq", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: tracking_txn_Seq = [%s]\n", csTmp));
		PutField_CString(hNewTxn, "tracking_txn_seq", csTmp);
	}

/* report_date */
	if (GetField_CString(hOrgTxn, "report_date", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: report_date = [%s]\n", csTmp));
		PutField_CString(hNewTxn, "report_date", csTmp);
	}

/* settlement_date */
	if (GetField_CString(hOrgTxn, "settlement_date", &csTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: settlement_date = [%s]\n", csTmp));
		PutField_CString(hNewTxn, "settlement_date", csTmp);
	}

/* manual_hold_recon */
        if (GetField_Int(hOrgTxn, "manual_hold_recon", &iTmp)) {
DEBUGLOG(("FormNewTxn (TxnPspDetail):: manual_hold_recon [%d]\n", iTmp));
                PutField_Int(hNewTxn,"manual_hold_recon",iTmp);
        }

	// Txn Elements

/* txn_ccy */
        if (GetField_CString(hOrgTxn, "txn_ccy", &csOrgCcy)) {
//DEBUGLOG(("FormNewTxn (TxnElements):: txn_ccy [%s]\n", csOrgCcy));
        }

/* element_total_cnt */
        if (GetField_Int(hOrgTxn, "element_total_cnt", &iElementCnt)) {
DEBUGLOG(("FormNewTxn (TxnElements):: element_total_cnt [%d]\n", iElementCnt));

                PutField_Int(hNewTxn, "element_total_cnt", iElementCnt);

                for (i = 1; i < iElementCnt + 1; i++) {
//DEBUGLOG(("FormNewTxn (TxnElements):: element_cnt = [%d]\n", i));

			// convert DR / CR
			// count diff_pool PD_ACCT_BAL_POOL / INTRANSIT_POOL

			sprintf(csTag, "element_party_type_%d", i);
                        if (GetField_Char(hOrgTxn, csTag, &cPartyType)) {
DEBUGLOG(("FormNewTxn (TxnElements):: [%d] party_type [%c]\n", i, cPartyType));
                                PutField_Char(hNewTxn, csTag, cPartyType);
                        }

                        sprintf(csTag, "element_ccy_%d", i);
                        if (GetField_CString(hOrgTxn, csTag, &csOrgElementCcy)) {
DEBUGLOG(("FormNewTxn (TxnElements):: [%d] ccy [%s]\n", i, csOrgElementCcy));
                                PutField_CString(hNewTxn, csTag, csOrgElementCcy);
                        }

                        sprintf(csTag, "element_amt_type_%d", i);
                        if (GetField_CString(hOrgTxn, csTag, &csOrgElementAmtType)) {
DEBUGLOG(("FormNewTxn (TxnElements):: [%d] amt_type [%s]\n", i, csOrgElementAmtType));
                                PutField_CString(hNewTxn, csTag, csOrgElementAmtType);

				if (iIsLastTxn) {
					if (!strcmp(csOrgElementAmtType, PD_CR)) {
                                                PutField_CString(hNewTxn, csTag, PD_CR);
                                                cTmpDCInd = PD_IND_CREDIT;

                                        } else if (!strcmp(csOrgElementAmtType, PD_DR)) {
                                                PutField_CString(hNewTxn, csTag, PD_DR);
                                                cTmpDCInd = PD_IND_DEBIT;
                                        }
				} else {
					// convert DR / CR
					if (!strcmp(csOrgElementAmtType, PD_CR)) {
	                                        PutField_CString(hNewTxn, csTag, PD_DR);
	                                        cTmpDCInd = PD_IND_DEBIT;
	
	                                } else if (!strcmp(csOrgElementAmtType, PD_DR)) {
	                                        PutField_CString(hNewTxn, csTag, PD_CR);
	                                        cTmpDCInd = PD_IND_CREDIT;
					}
				}
DEBUGLOG(("FormNewTxn (TxnElements):: [%d] DR / CR [%c]\n", i, cTmpDCInd));
                        }

                        sprintf(csTag, "element_amount_%d", i);
                        if (GetField_Double(hOrgTxn, csTag, &dOrgElementAmount)) {
DEBUGLOG(("FormNewTxn (TxnElements):: [%d] amount [%f]\n", i, dOrgElementAmount));
                                PutField_Double(hNewTxn, csTag, dOrgElementAmount);
                        }

                        sprintf(csTag, "element_type_%d", i);
                        if (GetField_CString(hOrgTxn, csTag, &csOrgElementType)) {
DEBUGLOG(("FormNewTxn (TxnElements):: [%d] type [%s]\n", i, csOrgElementType));
                                PutField_CString(hNewTxn, csTag, csOrgElementType);

//DEBUGLOG(("FormNewTxn (TxnElements):: [%d]csOrgElementCcy [%s] csOrgCcy [%s]\n", i, csOrgElementCcy, csOrgCcy));
//DEBUGLOG(("FormNewTxn (TxnElements):: [%d]cPartyType [%c] PD_TYPE_PSP [%c]\n", i, cPartyType, PD_TYPE_PSP));
                                if (!strcmp(csOrgElementCcy, csOrgCcy) &&
                                        (cPartyType == PD_TYPE_PSP) ) {

                                        if (!strcmp(csOrgElementType, PD_ELEMENT_TXN_AMT) ||
                                            !strcmp(csOrgElementType, PD_ELEMENT_TXN_FEE)) {

//DEBUGLOG(("FormNewTxn (TxnElements):: [%d]cTmpDCInd [%c]\n", i, cTmpDCInd));
                                                if (cTmpDCInd == PD_IND_DEBIT) {
                                                        dTotalAcctBal = dTotalAcctBal - dOrgElementAmount;
                                                } else if (cTmpDCInd == PD_IND_CREDIT) {
                                                        dTotalAcctBal = dTotalAcctBal + dOrgElementAmount;
                                                }
                                        }
                                        else {

//DEBUGLOG(("FormNewTxn (TxnElements):: [%d]cTmpDCInd [%c]\n", i, cTmpDCInd));
                                                if (cTmpDCInd == PD_IND_DEBIT) {
                                                        dTotalIntransitBal = dTotalIntransitBal - dOrgElementAmount;
                                                } else if (cTmpDCInd == PD_IND_CREDIT) {
                                                        dTotalIntransitBal = dTotalIntransitBal + dOrgElementAmount;
                                                }
                                        }
                                }
                        }

			sprintf(csTag, "element_rate_%d", i);
                        if (GetField_Double(hOrgTxn, csTag, &dTmp)) {
DEBUGLOG(("FormNewTxn (TxnElements):: [%d] rate [%f]\n", i, dTmp));
                                PutField_Double(hNewTxn, csTag, dTmp);
                        }
                }

                dTotalAcctBal = newround(dTotalAcctBal, PD_DECIMAL_LEN);
                dTotalIntransitBal= newround(dTotalIntransitBal, PD_DECIMAL_LEN);

DEBUGLOG(("FormNewTxn (TxnElements):: total_acct_bal [%lf]\n", dTotalAcctBal));
DEBUGLOG(("FormNewTxn (TxnElements):: total_intransit [%lf]\n", dTotalIntransitBal));

                PutField_Double(hContext, "element_acct_bal", dTotalAcctBal);
                PutField_Double(hContext, "element_intransit", dTotalIntransitBal);
        }

DEBUGLOG(("FormNewTxn:: iRet = [%d]\n",iRet));
        return iRet;
}

int     CreateNewTxn(int iIsLastTxn, hash_t *hNewTxn, hash_t *hContext)
{
        int     iRet = PD_OK;

        char    csTag[PD_TAG_LEN + 1];

        char    *csTmp = NULL;
        char    cTmp;
        double  dTmp = 0.0;

        int     i;

        double  dTotalAcctBal = 0.0;
        double  dTotalIntransitBal = 0.0;

        char    *csOrgTxnSeq = NULL;
        char    *csTxnSeq = NULL;
	char	*csTxnCode = NULL;
        char    *csBatchSeq = NULL;
	
        char    cBatchType;
        char    cBatchSubType;
        char    cAmtType;
        int	iIsVoid = PD_FALSE;
	int     iElementCnt = 0;
        int     iGetOpenBal = PD_FALSE;
	
	hash_t  *hTxnDetail = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnDetail, 0);

        hash_t  *hTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnRec, 0);

        hash_t *hTxnElement;
        hTxnElement = (hash_t*) malloc(sizeof(hash_t));

        hash_t *hRelation;
        hRelation = (hash_t*) malloc(sizeof(hash_t));

	cBatchType = ' ';
	cBatchSubType = ' ';
	cAmtType = ' ';

/* org_txn_seq */
        if (GetField_CString(hNewTxn, "org_txn_seq", &csOrgTxnSeq)) {
DEBUGLOG(("CreateNewTxn:: org_txn_seq [%s]\n", csOrgTxnSeq));
        }

/* txn_seq */
        if (GetField_CString(hNewTxn, "txn_seq", &csTxnSeq)) {
DEBUGLOG(("CreateNewTxn:: txn_seq [%s]\n", csTxnSeq));
		PutField_CString(hTxnDetail, "txn_seq", csTxnSeq);
        }

/* txn_code */
	if (GetField_CString(hNewTxn, "txn_code", &csTxnCode)) {
//DEBUGLOG(("CreateNewTxn:: txn_code [%s]\n", csTxnCode));
        }

/* is_void */
        if (GetField_Int(hContext, "is_void", &iIsVoid)) {
//DEBUGLOG(("CreateNewTxn:: is_void [%d]\n", iIsVoid));
        }

/* batch_txn_seq */
        if (GetField_CString(hContext, "batch_txn_seq", &csBatchSeq)) {
DEBUGLOG(("CreateNewTxn:: batch_txn_seq [%s]\n", csBatchSeq));
        }

/* batch_type */
        if (GetField_Char(hContext, "batch_type", &cBatchType)) {
DEBUGLOG(("CreateNewTxn:: batch_type [%c]\n", cBatchType));
	}

/* batch_sub_type */
        if (GetField_Char(hContext, "batch_sub_type", &cBatchSubType)) {
DEBUGLOG(("CreateNewTxn:: batch_sub_type [%c]\n", cBatchSubType));
        }

/* update_user */
        if (GetField_CString(hContext, "update_user", &csTmp)) {
DEBUGLOG(("CreateNewTxn:: update_user [%s]\n", csTmp));

		PutField_CString(hTxnDetail, "add_user", csTmp);
                PutField_CString(hTxnDetail, "update_user", csTmp);
                PutField_CString(hTxnDetail, "create_user", csTmp);

		PutField_CString(hTxnRec, "add_user", csTmp);
                PutField_CString(hTxnRec, "update_user", csTmp);
                PutField_CString(hTxnRec, "create_user", csTmp);

                PutField_CString(hNewTxn, "add_user", csTmp);
                PutField_CString(hNewTxn, "update_user", csTmp);
                PutField_CString(hNewTxn, "create_user", csTmp);
        }

/* db_commit */
        PutField_Int(hNewTxn, "db_commit", PD_FALSE);

DEBUGLOG(("CreateNewTxn:: Call DBOLTransaction:: Add\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Add");
        iRet = (unsigned long)(*DBObjPtr)(hNewTxn);
        if (iRet == PD_OK) {

/* baid */
                if (GetField_CString(hNewTxn, "baid", &csTmp)) {
//DEBUGLOG(("CreateNewTxn:: baid [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "baid", csTmp);
                }

/* txn_country */
                if (GetField_CString(hNewTxn, "txn_country", &csTmp)) {
//DEBUGLOG(("CreateNewTxn:: txn_country [%s]\n", csTmp));
                        PutField_CString(hTxnDetail, "txn_country", csTmp);
                        PutField_CString(hTxnRec, "txn_country", csTmp);
                }

/* txn_ccy */
                if (GetField_CString(hNewTxn, "txn_ccy", &csTmp)) {
//DEBUGLOG(("CreateNewTxn:: txn_ccy [%s]\n", csTmp));
                        PutField_CString(hTxnDetail, "txn_ccy", csTmp);
                        PutField_CString(hTxnRec, "txn_ccy", csTmp);
                }

/* element_acct_bal */
                if (GetField_Double(hContext, "element_acct_bal", &dTotalAcctBal)) {
//DEBUGLOG(("CreateNewTxn:: acct_bal [%lf]\n", dTotalAcctBal));
                }

/* element_intransit */
                if (GetField_Double(hContext, "element_intransit", &dTotalIntransitBal)) {
//DEBUGLOG(("CreateNewTxn:: intransit [%lf]\n", dTotalIntransitBal));
                }

		// Acct Bal
		if (dTotalAcctBal < 0.0) {
                        dTotalAcctBal = dTotalAcctBal * (-1.0);
                        cAmtType = PD_IND_DEBIT;
                } else if (dTotalAcctBal > 0.0) {
                        cAmtType = PD_IND_CREDIT;
                }

                if (dTotalAcctBal > 0.0) {

                        PutField_Char(hTxnRec, "amt_type", cAmtType);
                        PutField_Double(hTxnRec, "txn_amt", dTotalAcctBal);
                        PutField_CString(hTxnRec, "pool", PD_ACCT_BAL_POOL);

DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: UpdateAmount [acct_bal]\n"));
                        BOObjPtr = CreateObj(BOPtr, "BOOLBalance", "UpdateAmount");
                        iRet = (unsigned long)(*BOObjPtr)(hTxnRec);
                        if (iRet == PD_OK) {

                                iGetOpenBal = PD_TRUE;

/* approval_date */
                                if (GetField_CString(hTxnRec, "approval_date", &csTmp)) {
//DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: approval_date [%s]\n", csTmp));
                                        PutField_CString(hNewTxn, "approval_date", csTmp);
                                }

/* approval_timestamp */
                                if (GetField_CString(hTxnRec, "approval_timestamp", &csTmp))  {
//DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: approval_timestamp [%s]\n", csTmp));
                                        PutField_CString(hNewTxn, "approval_timestamp", csTmp);
                                }

/* open_bal */
                                if (GetField_Double(hTxnRec, "open_bal", &dTmp)) {
DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: open_bal [%f]\n", dTmp));
                                        PutField_Double(hNewTxn, "open_bal", dTmp);
                                }

/* open_in_transit */
                                if (GetField_Double(hTxnRec, "open_in_transit", &dTmp)) {
DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: open_in_transit [%f]\n", dTmp));
                                        PutField_Double(hNewTxn, "open_in_transit", dTmp);
                                }

/* bal */
                                if (GetField_Double(hTxnRec, "bal", &dTmp)) {
DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: balance = [%f]\n", dTmp));
                                        PutField_Double(hNewTxn, "bal", dTmp);
                                }

/* in_transit */
                                if (GetField_Double(hTxnRec, "in_transit", &dTmp)) {
DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: in_transit = [%f]\n", dTmp));
                                        PutField_Double(hNewTxn, "in_transit", dTmp);
                                }

/* total_hold */
                                if (GetField_Double(hTxnRec, "total_hold", &dTmp)) {
DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: total_hold = [%f]\n", dTmp));
                                        PutField_Double(hNewTxn, "total_hold", dTmp);
                                }

/* prepaid */
                                if (GetField_Double(hTxnRec, "prepaid", &dTmp)) {
DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: prepaid = [%f]\n", dTmp));
                                        PutField_Double(hNewTxn, "prepaid", dTmp);
                                }
                        }
                }

		// Intransit
		if (iRet == PD_OK) {

                        if (dTotalIntransitBal < 0.0) {
                                dTotalIntransitBal = dTotalIntransitBal * (-1.0);
                                cAmtType = PD_IND_DEBIT;
                        } else if (dTotalIntransitBal > 0.0) {
                                cAmtType = PD_IND_CREDIT;
                        }

                        if (dTotalIntransitBal > 0.0) {

                                PutField_Char(hTxnRec, "amt_type", cAmtType);
                                PutField_Double(hTxnRec, "txn_amt", dTotalIntransitBal);
                                PutField_CString(hTxnRec, "pool", PD_INTRANSIT_POOL);

DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: UpdateAmount [intransit]\n"));
                                BOObjPtr = CreateObj(BOPtr, "BOOLBalance", "UpdateAmount");
                                iRet = (unsigned long)(*BOObjPtr)(hTxnRec);
                                if (iRet == PD_OK) {

                                        if (iGetOpenBal == PD_FALSE) {

/* approval_date */
                                                if (GetField_CString(hTxnRec, "approval_date", &csTmp)) {
//DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: approval_date [%s]\n", csTmp));
                                                        PutField_CString(hNewTxn, "approval_date", csTmp);
                                                }

/* approval_timestamp */
                                                if (GetField_CString(hTxnRec, "approval_timestamp", &csTmp))  {
//DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: approval_timestamp [%s]\n", csTmp));
                                                        PutField_CString(hNewTxn, "approval_timestamp", csTmp);
                                                }

/* open_bal */
                                                if (GetField_Double(hTxnRec, "open_bal", &dTmp)) {
DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: open_bal [%f]\n", dTmp));
                                                        PutField_Double(hNewTxn, "open_bal", dTmp);
                                                }

/* open_in_transit */
                                                if (GetField_Double(hTxnRec, "open_in_transit", &dTmp)) {
DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: open_in_transit [%f]\n", dTmp));
                                                        PutField_Double(hNewTxn, "open_in_transit", dTmp);
                                                }
                                        }

/* bal */
                                        if (GetField_Double(hTxnRec, "bal", &dTmp)) {
DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: balance = [%f]\n", dTmp));
                                                PutField_Double(hNewTxn, "bal", dTmp);
                                        }

/* in_transit */
                                        if (GetField_Double(hTxnRec, "in_transit", &dTmp)) {
DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: in_transit = [%f]\n", dTmp));
                                                PutField_Double(hNewTxn, "in_transit", dTmp);
                                        }

/* total_hold */
                                        if (GetField_Double(hTxnRec, "total_hold", &dTmp)) {
DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: total_hold = [%f]\n", dTmp));
                                                PutField_Double(hNewTxn, "total_hold", dTmp);
                                        }

/* prepaid */
                                        if (GetField_Double(hTxnRec, "prepaid", &dTmp)) {
DEBUGLOG(("CreateNewTxn:: Call BOOLBalance:: prepaid = [%f]\n", dTmp));
                                                PutField_Double(hNewTxn, "prepaid", dTmp);
                                        }
                                }
                        }
                }
        }

	// Add Element
	if (iRet == PD_OK) {
                hash_init(hTxnElement, 0);

/* update_user */
                if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hTxnElement, "update_user", csTmp);
                        PutField_CString(hTxnElement, "add_user", csTmp);
                        PutField_CString(hTxnElement, "create_user", csTmp);
                }

/* element_total_cnt */
                if (GetField_Int(hNewTxn, "element_total_cnt", &iElementCnt)) {
DEBUGLOG(("CreateNewTxn:: element_total_cnt [%d]\n", iElementCnt));
                }

                for (i = 1 ; i < iElementCnt + 1; i++) {

/* txn_seq */
                        PutField_CString(hTxnElement, "txn_seq", csTxnSeq);

/* txn_ccy */
                        sprintf(csTag, "element_ccy_%d", i);
                        if (GetField_CString(hNewTxn, csTag, &csTmp)) {
//DEBUGLOG(("CreateNewTxn:: [%d] txn_ccy [%s]\n", i, csTmp));
                                PutField_CString(hTxnElement, "txn_ccy", csTmp);
                        }

/* txn_amt */
                        sprintf(csTag, "element_amount_%d", i);
                        if (GetField_Double(hNewTxn, csTag, &dTmp)) {
//DEBUGLOG(("CreateNewTxn:: [%d] txn_amt [%d]\n", i, dTmp));
                                PutField_Double(hTxnElement, "txn_amt", dTmp);
                        }

/* txn_element_type */
                        sprintf(csTag, "element_type_%d", i);
                        if (GetField_CString(hNewTxn, csTag, &csTmp)) {
//DEBUGLOG(("CreateNewTxn:: [%d] txn_element_type [%s]\n", i, csTmp));
                                PutField_CString(hTxnElement, "txn_element_type", csTmp);
                        }

/* party_type */
                        sprintf(csTag, "part_type_%d", i);
                        if (GetField_Char(hNewTxn, csTag, &cTmp)) {
//DEBUGLOG(("CreateNewTxn:: [%d] party_type [%c]\n", i, cTmp));
                                PutField_Char(hTxnElement, "party_type", cTmp);
                        }

/* amount_type */
                        sprintf(csTag, "element_amt_type_%d", i);
                        if (GetField_CString(hNewTxn, csTag, &csTmp)) {
//DEBUGLOG(("CreateNewTxn:: [%d] amount_type [%s]\n", i, csTmp));
                                PutField_CString(hTxnElement, "amount_type", csTmp);
                        }

DEBUGLOG(("CreateNewTxn:: [%d] Call BOOLTxnElements:: AddPspTxnElement\n",i ));
                        BOObjPtr = CreateObj(BOPtr, "BOOLTxnElements", "AddPspTxnElement");
                        iRet = (unsigned long)(*BOObjPtr)(hTxnElement);
                        if (iRet != PD_OK) {
DEBUGLOG(("CreateNewTxn:: [%d] Call BOOLTxnElements:: AddPspTxnElement error\n",i ));
                                break;
                        }
                }

                hash_destroy(hTxnElement);
        }

	// Add Txn Detail
        if (iRet == PD_OK) {

DEBUGLOG(("CreateNewTxn:: Call DBOLTransaction:: AddDetail\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "AddDetail");
                iRet = (unsigned long)(*DBObjPtr)(hTxnDetail);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("CreateNewTxn:: Call DBOLTransaction:: AddDetail Failure!!!\n"));
                }
        }

	// Update Txn Header
        if (iRet == PD_OK) {

/* status, ar_ind, sub_status, recon_status */
                PutField_Char(hNewTxn, "status", PD_COMPLETE);
DEBUGLOG(("CreateNewTxn:: status [%c]\n", PD_COMPLETE));

                PutField_Char(hNewTxn, "ar_ind", PD_ACCEPT);
DEBUGLOG(("CreateNewTxn:: ar_ind [%c]\n", PD_ACCEPT));

		if ((iIsLastTxn == PD_TRUE) 
		    && (!strcmp(csTxnCode, PD_OL_PAYOUT_VOID_PSP))
		) 
		{
			PutField_CString(hNewTxn, "sub_status", PD_REFUND_APPROVED);
DEBUGLOG(("CreateNewTxn:: sub_status [%s]\n", PD_REFUND_APPROVED));
		}
		else
		{
                	PutField_CString(hNewTxn, "sub_status", PD_APPROVED);		
DEBUGLOG(("CreateNewTxn:: sub_status [%s]\n", PD_APPROVED));
		}

		if (iIsLastTxn == PD_TRUE) {
			if (!strcmp(csTxnCode, PD_MI_TXN_CODE_BAID_BAL_TRF_IN_IN_TRAN)) {
				PutField_Char(hNewTxn, "recon_status", PD_RECON_NOT_REQ);
DEBUGLOG(("CreateNewTxn:: recon_status [%c]\n", PD_RECON_NOT_REQ));
			} else {
				PutField_Char(hNewTxn, "recon_status", PD_UNRECONCILED);
DEBUGLOG(("CreateNewTxn:: recon_status [%c]\n", PD_UNRECONCILED));	
			}

		} else {
			if ((iIsVoid == PD_TRUE)
			    || (!strcmp(csTxnCode, PD_MI_TXN_CODE_BAID_BAL_TRF_IN_IN_TRAN))
			)
			{
                		PutField_Char(hNewTxn, "recon_status", PD_RECON_NOT_REQ);
DEBUGLOG(("CreateNewTxn:: recon_status [%c]\n", PD_RECON_NOT_REQ));
			} else {
                		PutField_Char(hNewTxn, "recon_status", PD_UNRECONCILED);
DEBUGLOG(("CreateNewTxn:: recon_status [%c]\n", PD_UNRECONCILED));
			}
		}	

DEBUGLOG(("CreateNewTxn:: Call DBOLTransaction:: Update\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
                iRet = (unsigned long)(*DBObjPtr)(hNewTxn);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("CreateNewTxn:: Call DBOLTransaction:: Update Failure!!!\n"));
                }
        }

	// Add Txn PSP Detail
        if (iRet == PD_OK) {

DEBUGLOG(("CreateNewTxn:: Call DBOLTxnPspDetail:: Add\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Add");
                iRet = (unsigned long)(*DBObjPtr)(hNewTxn);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("CreateNewTxn:: Call DBOLTxnPspDetail:: Add Failure!!!\n"));
                }
        }

	// Update Txn PSP Detail
        if (iRet == PD_OK) {

DEBUGLOG(("CreateNewTxn:: Call DBOLTxnPspDetail:: Update\n"));
                DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Update");
                iRet = (unsigned long)(*DBObjPtr)(hNewTxn);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("CreateNewTxn:: Call DBOLTxnPspDetail:: Update Failure!!!\n"));
                }
        }

	// Add Txn Relation (Void)
	if ((iIsLastTxn == PD_FALSE) && (iRet == PD_OK)) {
DEBUGLOG(("CreateNewTxn:: Call AddTxnRelation() [Void]\n"));

                hash_init(hRelation, 0);

		// Org Txn Seq
		PutField_Char(hRelation, "party", PD_TYPE_PSP);
                PutField_CString(hRelation, "p1_txn_id", csTxnSeq);
                PutField_CString(hRelation, "p2_txn_id", csOrgTxnSeq);
                PutField_Char(hRelation, "txn_level", PD_TXN_LEVEL);
                PutField_Char(hRelation, "relation_type", PD_REL_VOID);
                if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hRelation, "update_user", csTmp);
                        PutField_CString(hRelation, "add_user", csTmp);
                        PutField_CString(hRelation, "create_user", csTmp);
                }

                iRet = AddTxnRelation(hRelation);

                hash_destroy(hRelation);
        }


	// Add Batch Txn Relation (Txn Id)
	if ((iNumOfBatchId > 0) && (iRet == PD_OK)) {
DEBUGLOG(("CreateNewTxn:: Call AddBatchTxnRelation()\n"));

                hash_init(hRelation, 0);

                PutField_Char(hRelation, "batch_type", cBatchType);
		if (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) {
			PutField_Char(hRelation, "batch_sub_type", PD_GENERAL_UNDO_BAL_TRF);
		} else {
                	PutField_Char(hRelation, "batch_sub_type", cBatchSubType);
		}
                PutField_CString(hRelation, "batch_txn_seq", csBatchSeq);
                PutField_Char(hRelation, "txn_level", PD_TXN_LEVEL);
                PutField_CString(hRelation, "txn_seq", csTxnSeq);
                PutField_Int(hRelation, "is_input_txn", 0);
		if (iIsLastTxn == PD_FALSE) {
                	PutField_Int(hRelation, "is_regen_txn", 0);
		} else {
                	PutField_Int(hRelation, "is_regen_txn", 1);
		}
		if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hRelation, "update_user", csTmp);
                        PutField_CString(hRelation, "add_user", csTmp);
                        PutField_CString(hRelation, "create_user", csTmp);
                }

                iRet = AddBatchTxnRelation(hRelation);

                hash_destroy(hRelation);
        }

	hash_destroy(hTxnDetail);
	hash_destroy(hTxnRec);
        hash_destroy(hTxnElement);

        FREE_ME(hTxnDetail);
        FREE_ME(hTxnRec);
        FREE_ME(hTxnElement);
        FREE_ME(hRelation);

DEBUGLOG(("CreateNewTxn:: iRet = [%d]\n",iRet));
        return iRet;	
}

int     UpdateOrgTxn(hash_t *hOrgTxn, hash_t *hContext)
{
        int     iRet = PD_OK;

	char 	cReconStatus;
	
        char    *csTmp = NULL;
        char    *csTxnSeq = NULL;
	char	*csBaidCategory = NULL;

        hash_t  *hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec, 0);

	cReconStatus = ' ';

/* txn_seq */
        if (GetField_CString(hOrgTxn, "txn_seq", &csTxnSeq)) {
DEBUGLOG(("UpdateOrgTxn:: txn_seq [%s]\n", csTxnSeq));
                PutField_CString(hRec, "txn_seq", csTxnSeq);
        }
	
/* baid_category */
	if (GetField_CString(hOrgTxn, "baid_category", &csBaidCategory)) {
DEBUGLOG(("UpdateOrgTxn:: baid_category [%s]\n", csBaidCategory));
        }	

/* update_user */
        if (GetField_CString(hContext, "update_user", &csTmp)) {
DEBUGLOG(("UpdateOrgTxn:: upate_user [%s]\n", csTmp));
                PutField_CString(hRec, "update_user", csTmp);
        }

/* recon_status */
	if (GetField_Char(hOrgTxn, "recon_status", &cReconStatus)) {
DEBUGLOG(("UpdateOrgTxn:: recon_status [%c]\n", cReconStatus));
	}

      	if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {
		if ((cReconStatus != PD_RECON_NOT_REQ)
                    && (cReconStatus != PD_UNRECONCILED)
            	)
		{
                        PutField_Char(hRec, "recon_status", PD_UNRECONCILED);
DEBUGLOG(("UpdateOrgTxn:: new recon_status [%c]\n", PD_UNRECONCILED));
		}
      	}

/* status */
        PutField_Char(hRec, "status", PD_REVERSED);
DEBUGLOG(("UpdateOrgTxn:: status [%c]\n", PD_REVERSED));

/* sub_status */
	if (!strcmp(csTxnType, PD_TXN_TYPE_SMS_BANK_DEPOSIT)) {
              	PutField_CString(hRec, "sub_status", PD_UNDO);
DEBUGLOG(("UpdateOrgTxn:: sub_status [%s]\n", PD_UNDO));
	} else {
		if (!strcmp(csBaidCategory, PD_BAID_CAT_INTERNAL_PENDFUND)) {
			if (cReconStatus == PD_UNRECONCILED) {
				PutField_CString(hRec, "sub_status", PD_CANCELLED);
DEBUGLOG(("UpdateOrgTxn:: sub_status [%s]\n", PD_CANCELLED));
			} else if (cReconStatus == PD_RECONCILED) { 
				PutField_CString(hRec, "sub_status", PD_UNDO);
DEBUGLOG(("UpdateOrgTxn:: sub_status [%s]\n", PD_UNDO));
			}
		} else {
			if (iAction == PD_BATCH_ACTION_CANCEL) {
        			PutField_CString(hRec, "sub_status", PD_CANCELLED);
DEBUGLOG(("UpdateOrgTxn:: sub_status [%s]\n", PD_CANCELLED));
			} else if (iAction == PD_BATCH_ACTION_VOID) {
				PutField_CString(hRec, "sub_status", PD_UNDO);
DEBUGLOG(("UpdateOrgTxn:: sub_status [%s]\n", PD_UNDO));
			}
		}
	}

DEBUGLOG(("UpdateOrgTxn:: Call DBOLTransaction:: Update\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
        iRet = (unsigned long)(*DBObjPtr)(hRec);
        if (iRet != PD_OK) {
                iRet = INT_ERR;
DEBUGLOG(("UpdateOrgTxn:: Call DBOLTransaction:: Update failed\n"));
ERRLOG("TxnOmtByUsRBT:: UpdateOrgTxn:: Call DBOLTransaction:: Update failed\n");
        }

        hash_destroy(hRec);
        FREE_ME(hRec);

DEBUGLOG(("UpdateOrgTxn:: iRet = [%d]\n",iRet));
        return iRet;
}

int	IsCreateLastTxn(const char* csOrgTxnSeq, hash_t* hOrgTxn, hash_t* hOrgBatchInfo, hash_t *hContext)
{
	int     iRet = PD_TRUE;

	char	cOrgBatchType;
	char	cOrgBatchSubType;

	char    *csOrgBatchId = NULL;
	char    *csTxnCode = NULL;

	hash_t  *hTmpRec;
        hTmpRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpRec,0);

	cOrgBatchType = ' ';
	cOrgBatchSubType = ' ';

/* org_batch_id */
	if(GetField_CString(hOrgBatchInfo, "org_batch_id", &csOrgBatchId)){
DEBUGLOG(("IsCreateLastTxn:: org_batch_id = [%s]\n",csOrgBatchId));
        }

/* org_batch_type */
	if(GetField_Char(hOrgBatchInfo, "org_batch_type", &cOrgBatchType)){
DEBUGLOG(("IsCreateLastTxn:: org_batch_type = [%c]\n",cOrgBatchType));
        }

/* org_batch_sub_type */
        if(GetField_Char(hOrgBatchInfo, "org_batch_sub_type", &cOrgBatchSubType)){
DEBUGLOG(("IsCreateLastTxn:: org_batch_sub_type = [%c]\n",cOrgBatchSubType));
        }

	// Check Action	
	if (iAction == PD_BATCH_ACTION_CANCEL) {
DEBUGLOG(("IsCreateLastTxn:: action = [CANCEL]\n"));
		iRet = PD_FALSE;
	}

	// Check TxnType
	if (iRet == PD_TRUE) {
        	if (!strcmp(csTxnType, PD_TXN_TYPE_HOLD_DEPOSIT)) {
DEBUGLOG(("IsCreateLastTxn:: txn_type = [%s]\n", PD_TXN_TYPE_HOLD_DEPOSIT));
			iRet = PD_FALSE;
		}
	}

	// Check Batch Sub Type and Check Fe Init
	if (iRet == PD_TRUE) {

		if (cOrgBatchSubType != PD_COMBINE_RECON) {

/* txn_code */
                	if (GetField_CString(hOrgTxn, "txn_code", &csTxnCode)) {
DEBUGLOG(("IsCreateLastTxn:: txn_code = [%s]\n", csTxnCode));
                	}

			DBObjPtr = CreateObj(DBPtr,"DBTxnCode","AllowFeInit");
                	iRet = (unsigned long)(*DBObjPtr)(csTxnCode);
                	if (iRet == PD_TRUE) {
DEBUGLOG(("IsCreateLastTxn:: Call DBTxnCode:: AllowFeInit:: fe_init = [TRUE]\n"));
                	} else if (iRet == PD_FALSE) {
DEBUGLOG(("IsCreateLastTxn:: Call DBTxnCode:: AllowFeInit:: fe_init = [FALSE]\n"));
                	} else {
                        	iRet = INT_ERR;
DEBUGLOG(("IsCreateLastTxn:: Call DBTxnCode:: AllowFeInit:: not found!!\n"));
ERRLOG("TxnOmtByUsRBT:: IsCreateLastTxn:: Call DBTxnCode:: AllowFeInit:: not found!!\n");
                	}
		}
	}

	// Check Input Txn Id
	if (iRet == PD_TRUE) {

		PutField_Char(hTmpRec,"batch_type",cOrgBatchType);
        	PutField_Char(hTmpRec,"batch_sub_type",cOrgBatchSubType);
        	PutField_CString(hTmpRec,"batch_id",csOrgBatchId);
        	PutField_CString(hTmpRec,"txn_id",csOrgTxnSeq);
        	PutField_Char(hTmpRec,"txn_level",PD_TXN_LEVEL);

		DBObjPtr = CreateObj(DBPtr, "DBOLBatchTxnRelation","CheckIsInputTxnId");
        	iRet = (unsigned long)(*DBObjPtr)(hTmpRec);
        	if (iRet == PD_TRUE) {
DEBUGLOG(("IsCreateLastTxn:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation:: input_txn_id = [TRUE]\n"));
        	} else if (iRet == PD_FALSE) {
DEBUGLOG(("IsCreateLastTxn:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation:: input_txn_id = [FALSE]\n"));
        	} else {
                	iRet = INT_ERR;
DEBUGLOG(("IsCreateLastTxn:: Call DBOLBatchTxnRelation:: Call DBOLBatchTxnRelation:: Input Txn Id Error!!!\n"));
ERRLOG("TxnOmtByUsRBT:: IsCreateLastTxn:: Call DBOLBatchTxnRelation:: Input Txn Id Error!!!\n");
	        }
	}

	hash_destroy(hTmpRec);
        FREE_ME(hTmpRec);

DEBUGLOG(("IsCreateLastTxn:: iRet = [%d]\n",iRet));
        return iRet;	
}	

int     ProcessLastTxn(const char* csTxnSeq, hash_t* hOrgTxn, hash_t* hNewTxn, hash_t *hContext)
{
	int     iRet = PD_OK;
	int     iDtlRet = PD_OK;

	char	*csTmp = NULL;

	char    *csOrgTxnId = NULL;
        char    *csNewTxnId = NULL;
	
	char	*csTxnCode = NULL;

	hash_t  *hRec;
        hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec, 0);

	hash_t *hRelation;
        hRelation = (hash_t*) malloc(sizeof(hash_t));

DEBUGLOG(("ProcessLastTxn:: txn_id [%s]\n", csTxnSeq));
	
/* txn_code */
      	if (GetField_CString(hOrgTxn, "txn_code", &csTxnCode)) {
DEBUGLOG(("ProcessLastTxn:: txn_code = [%s]\n", csTxnCode));
      	}

	// Form Offset Txn (NOT reversal CR / DR sign)
	iRet = FormNewTxn(PD_TRUE,hOrgTxn,hNewTxn,hContext);

	// Create Txn (with add approval_date, approval_timestamp)
	if (iRet == PD_OK) {
		iRet = CreateNewTxn(PD_TRUE,hNewTxn,hContext);
	}

	// Create Payout Gen File Detail Map (Payout Only)
	if (iRet == PD_OK) {
                if (!strcmp(csTxnCode, PD_OFFLINE_PAYOUT_TXN_CODE)) {

/* action_type */
                        PutField_Char(hRec, "action_type", PD_OL_ACTION_VOID);
DEBUGLOG(("ProcessLastTxn:: action_type [%s]\n", PD_OL_ACTION_VOID));

/* org_txn_id */
                        if (GetField_CString(hOrgTxn, "txn_seq", &csOrgTxnId)) {
DEBUGLOG(("ProcessLastTxn:: org_txn_id [%s]\n", csOrgTxnId));
                                PutField_CString(hRec, "org_txn_id", csOrgTxnId);
                        }

/* new_txn_id */
                        if (GetField_CString(hNewTxn, "txn_seq", &csNewTxnId)) {
DEBUGLOG(("ProcessLastTxn:: new_txn_id [%s]\n", csNewTxnId));
                                PutField_CString(hRec, "new_txn_id", csNewTxnId);
                        }

                        DBObjPtr = CreateObj(DBPtr,"DBOLPayoutGenFileDtMap","Add");
                        iDtlRet = (unsigned long)(*DBObjPtr)(hRec);
                        if (iDtlRet != PD_OK) {
                                iRet = INT_ERR;
DEBUGLOG(("ProcessLastTxn:: Call DBOLPayoutGenFileDtMap:: Add failed!!!\n"));
ERRLOG("TxnOmtByUsRBT:: ProcessLastTxn:: Call DBOLPayoutGenFileDtMap:: Add failed!!!\n");
                        }
                }
        }

	// Add Txn Relation (Linkage)
	if (iRet == PD_OK) {
DEBUGLOG(("ProcessLastTxn:: Call AddTxnRelation() [Linkage]\n"));
	
		hash_init(hRelation, 0);

		PutField_Char(hRelation, "party", PD_TYPE_PSP);
                PutField_CString(hRelation, "p1_txn_id", csTxnSeq);
              	if (GetField_CString(hNewTxn, "txn_seq", &csNewTxnId)) {
                  	PutField_CString(hRelation, "p2_txn_id", csNewTxnId);
               	}
                PutField_Char(hRelation, "txn_level", PD_TXN_LEVEL);
                PutField_Char(hRelation, "relation_type", PD_REL_LINKAGE);
                if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hRelation, "update_user", csTmp);
                        PutField_CString(hRelation, "add_user", csTmp);
                        PutField_CString(hRelation, "create_user", csTmp);
                }

                iRet = AddTxnRelation(hRelation);

                hash_destroy(hRelation);
	}

	// Add Txn Relation (Regen)
	if (iRet == PD_OK) {
DEBUGLOG(("ProcessLastTxn:: Call AddTxnRelation() [Regen]\n"));

                hash_init(hRelation, 0);

                PutField_Char(hRelation, "party", PD_TYPE_PSP);
                PutField_CString(hRelation, "p1_txn_id", csNewTxnId);
		if (GetField_CString(hOrgTxn, "txn_seq", &csOrgTxnId)) {	
                        PutField_CString(hRelation, "p2_txn_id", csOrgTxnId);
                }
                PutField_Char(hRelation, "txn_level", PD_TXN_LEVEL);
                PutField_Char(hRelation, "relation_type", PD_REL_REGEN);
                if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hRelation, "update_user", csTmp);
                        PutField_CString(hRelation, "add_user", csTmp);
                        PutField_CString(hRelation, "create_user", csTmp);
                }

                iRet = AddTxnRelation(hRelation);

                hash_destroy(hRelation);
        }

        hash_destroy(hRec);

        FREE_ME(hRec);

	FREE_ME(hRelation);
	
DEBUGLOG(("ProcessLastTxn:: iRet = [%d]\n",iRet));
        return iRet;
}

int	StoreP1LastTxnInfo(const char* csOrgTxnSeq, const char *csNewTxnSeq, const char *csLastTxnSeq, recordset_t *rTmpP1LastTxnRecordSet, hash_t *hTmpP1LastTxnRec, hash_t *hContext)
{
	int     iRet = PD_OK;
        int     iDtlRet = PD_TRUE;

	hash_t  *hRec = NULL;
        hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec,0);

	PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

	// Check Bal Trf Txn Id (P1)
        DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","CheckIsBalTransP1TxnId");
        iDtlRet = (unsigned long)(*DBObjPtr)(hRec);
        if (iDtlRet == PD_TRUE) {
DEBUGLOG(("StoreP1LastTxnInfo:: Call DBOLTxnRelation:: CheckIsBalTransP1TxnId:: is_p1_txn_id = [TRUE]\n"));

		PutField_CString(hTmpP1LastTxnRec, "p1_org_txn_seq" ,csOrgTxnSeq);
DEBUGLOG(("StoreP1LastTxnInfo:: Call DBOLTxnRelation:: p1_org_txn_seq = [%s]\n", csOrgTxnSeq));

		PutField_CString(hTmpP1LastTxnRec, "p1_new_txn_seq" ,csNewTxnSeq);
DEBUGLOG(("StoreP1LastTxnInfo:: Call DBOLTxnRelation:: p1_new_txn_seq = [%s]\n", csNewTxnSeq));

                PutField_CString(hTmpP1LastTxnRec, "p1_last_txn_seq" ,csLastTxnSeq);
DEBUGLOG(("StoreP1LastTxnInfo:: Call DBOLTxnRelation:: p1_last_txn_seq = [%s]\n", csLastTxnSeq));

		RecordSet_Add(rTmpP1LastTxnRecordSet, hTmpP1LastTxnRec);
	} else {
DEBUGLOG(("StoreP1LastTxnInfo:: Call DBOLTxnRelation:: CheckIsBalTransP1TxnId:: is_p1_txn_id = [FALSE]\n"));
	}

	hash_destroy(hRec);
        FREE_ME(hRec);

DEBUGLOG(("StoreP1LastTxnInfo:: iRet = [%d]\n",iRet));
        return iRet;
}

int     StoreP2LastTxnInfo(const char* csOrgTxnSeq, const char *csNewTxnSeq, const char *csLastTxnSeq, recordset_t *rTmpP2LastTxnRecordSet, hash_t *hTmpP2LastTxnRec, hash_t *hContext)
{
        int     iRet = PD_OK;
        int     iDtlRet = PD_TRUE;

        hash_t  *hRec = NULL;
        hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec,0);

        PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

	// Check Bal Trf Txn Id (P2)
      	DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","CheckIsBalTransP2TxnId");
      	iDtlRet = (unsigned long)(*DBObjPtr)(hRec);
       	if (iDtlRet == PD_TRUE) {
DEBUGLOG(("StoreP2LastTxnInfo:: Call DBOLTxnRelation:: CheckIsBalTransP2TxnId:: is_p2_txn_id = [TRUE]\n"));

            	PutField_CString(hTmpP2LastTxnRec, "p2_org_txn_seq" ,csOrgTxnSeq);
DEBUGLOG(("StoreP2LastTxnInfo:: Call DBOLTxnRelation:: p2_org_txn_seq = [%s]\n", csOrgTxnSeq));

              	PutField_CString(hTmpP2LastTxnRec, "p2_new_txn_seq" ,csNewTxnSeq);
DEBUGLOG(("StoreP2LastTxnInfo:: Call DBOLTxnRelation:: p2_new_txn_seq = [%s]\n", csNewTxnSeq));

             	PutField_CString(hTmpP2LastTxnRec, "p2_last_txn_seq" ,csLastTxnSeq);
DEBUGLOG(("StoreP2LastTxnInfo:: Call DBOLTxnRelation:: p2_last_txn_seq = [%s]\n", csLastTxnSeq));

             	RecordSet_Add(rTmpP2LastTxnRecordSet, hTmpP2LastTxnRec);
      	} else {
DEBUGLOG(("StoreP2LastTxnInfo:: Call DBOLTxnRelation:: CheckIsBalTransP2TxnId:: is_p2_txn_id = [FALSE]\n"));
	}

        hash_destroy(hRec);
        FREE_ME(hRec);

DEBUGLOG(("StoreP2LastTxnInfo:: iRet = [%d]\n",iRet));
        return iRet;
}	
	
int     ProcessLastTxnRelation(recordset_t *rTmpP1LastTxnRecordSet, recordset_t *rTmpP2LastTxnRecordSet, recordset_t *rLastTxnRecordSet, hash_t *hLastTxnRec, hash_t *hContext)
{
	int     iRet = PD_OK;
	int     iDtlRet = PD_FOUND;
	int	iP1Cnt = 0;
	int	iP2Cnt = 0;

	char 	*csP2TxnId = NULL;
	
	char    *csP1OrgTxnId = NULL;
	char    *csP1NewTxnId = NULL;
	char    *csP1LastTxnId = NULL;
	char    *csP2OrgTxnId = NULL;
        char    *csP2NewTxnId = NULL;
        char    *csP2LastTxnId = NULL;

	char	*csTmp = NULL;
	
	hash_t  *hTmpP1LastTxnRecGet = NULL;
	hash_t  *hTmpP2LastTxnRecGet = NULL;

	hash_t          *hTmpP1OrgRec;
        hTmpP1OrgRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTmpP1OrgRec,0);

        hash_t          *hP1OrgRec = NULL;
        recordset_t     *rP1OrgRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rP1OrgRecordSet,0);

	hTmpP1LastTxnRecGet = RecordSet_GetFirst(rTmpP1LastTxnRecordSet);
        while (hTmpP1LastTxnRecGet) {

/* p1_org_txn_seq */
             	if (GetField_CString(hTmpP1LastTxnRecGet, "p1_org_txn_seq", &csP1OrgTxnId)) {
DEBUGLOG(("ProcessLastTxnRelation:: p1_org_txn_seq = [%s]\n", csP1OrgTxnId));
             	}

/* p1_new_txn_seq */
            	if (GetField_CString(hTmpP1LastTxnRecGet, "p1_new_txn_seq", &csP1NewTxnId)) {
DEBUGLOG(("ProcessLastTxnRelation:: p1_new_txn_seq = [%s]\n", csP1NewTxnId));
             	}

/* p1_last_txn_seq */
              	if (GetField_CString(hTmpP1LastTxnRecGet, "p1_last_txn_seq", &csP1LastTxnId)) {
DEBUGLOG(("ProcessLastTxnRelation:: p1_last_txn_seq = [%s]\n", csP1LastTxnId));		
		}

		PutField_Char(hTmpP1OrgRec,"party_type",PD_TYPE_PSP);
               	PutField_CString(hTmpP1OrgRec,"p1_txn_id",csP1OrgTxnId);
               	PutField_Char(hTmpP1OrgRec,"txn_level",PD_TXN_LEVEL);
             	PutField_Char(hTmpP1OrgRec,"relation_type",PD_REL_BAL_TRF);

            	DBObjPtr = CreateObj(DBPtr, "DBOLTxnRelation","GetP2TxnId");
             	iDtlRet = (unsigned long)(*DBObjPtr)(hTmpP1OrgRec,rP1OrgRecordSet);
           	if (iDtlRet == PD_FOUND) {

                    	hP1OrgRec = RecordSet_GetFirst(rP1OrgRecordSet);
                     	while (hP1OrgRec) {
			
/* p2_txn_id */
                            	if (GetField_CString(hP1OrgRec, "p2_txn_id", &csP2TxnId)) {

					hTmpP2LastTxnRecGet = RecordSet_GetFirst(rTmpP2LastTxnRecordSet);
        				while (hTmpP2LastTxnRecGet) {

/* p2_org_txn_seq */
                                		if (GetField_CString(hTmpP2LastTxnRecGet, "p2_org_txn_seq", &csP2OrgTxnId)) {

							if (!strcmp(csP2TxnId, csP2OrgTxnId)) {		
DEBUGLOG(("ProcessLastTxnRelation:: p2_org_txn_seq = [%s]\n", csP2OrgTxnId));

/* p2_new_txn_seq */
                                				if (GetField_CString(hTmpP2LastTxnRecGet, "p2_new_txn_seq", &csP2NewTxnId)) {
DEBUGLOG(("ProcessLastTxnRelation:: p2_new_txn_seq = [%s]\n", csP2NewTxnId));
                                				}

/* p2_last_txn_seq */
                                				if (GetField_CString(hTmpP2LastTxnRecGet, "p2_last_txn_seq", &csP2LastTxnId)) {
DEBUGLOG(("ProcessLastTxnRelation:: p2_last_txn_seq = [%s]\n", csP2LastTxnId));
                                				}		

/* relation_type */
                                            			PutField_Char(hLastTxnRec,"relation_type",PD_REL_BAL_TRF);
DEBUGLOG(("ProcessLastTxnRelation:: relation_type = [%c]\n", PD_REL_BAL_TRF));

/* p1_last_txn_seq */	
                                            			PutField_CString(hLastTxnRec,"p1_last_txn_seq",csP1LastTxnId);
DEBUGLOG(("ProcessLastTxnRelation:: p1_last_txn_seq = [%s]\n", csP1LastTxnId));

/* p2_last_txn_seq */
                                            			PutField_CString(hLastTxnRec,"p2_last_txn_seq",csP2LastTxnId);
DEBUGLOG(("ProcessLastTxnRelation:: p2_last_txn_seq = [%s]\n", csP2LastTxnId));

/* update_user */
                                             			if (GetField_CString(hContext, "update_user", &csTmp)) {
                                                      			PutField_CString(hLastTxnRec,"update_user",csTmp);
DEBUGLOG(("ProcessLastTxnRelation:: update_user = [%s]\n", csTmp));
                                             		}

                                            			RecordSet_Add(rLastTxnRecordSet, hLastTxnRec);		
							}	
						}

						iP2Cnt++;

						hTmpP2LastTxnRecGet = RecordSet_GetNext(rTmpP2LastTxnRecordSet);
					}

				}

				hP1OrgRec = RecordSet_GetNext(rP1OrgRecordSet);
			}
		} else {
DEBUGLOG(("ProcessLastTxnRelation:: Call DBOLTxnRelation:: GetP2TxnId not found!!!\n"));
		}

		iP1Cnt++;

		hTmpP1LastTxnRecGet = RecordSet_GetNext(rTmpP1LastTxnRecordSet);
	}		

	if (iP1Cnt == 0) {
DEBUGLOG(("ProcessLastTxnRelation:: Get p1_last_txn_id No Record Found!!!\n"));
	}

	if (iP2Cnt == 0) {
DEBUGLOG(("ProcessLastTxnRelation:: Get p2_last_txn_id No Record Found!!!\n"));
        }

	hash_destroy(hTmpP1OrgRec);
        FREE_ME(hTmpP1OrgRec);

        RecordSet_Destroy(rP1OrgRecordSet);
        FREE_ME(rP1OrgRecordSet);

DEBUGLOG(("ProcessLastTxnRelation:: iRet = [%d]\n",iRet));
        return iRet;	
}

int     ProcessOffsetStmtTxn(const char* csOrgStmtTxnSeq, const int iStmtTxnAction, hash_t* hOrgStmtTxn, hash_t* hNewStmtTxn, hash_t* hContext)
{
        int     iRet = PD_OK;

DEBUGLOG(("ProcessOffsetStmtTxn:: stmt_txn_id [%s]\n", csOrgStmtTxnSeq));

	if (iStmtTxnAction == PD_STMT_TXN_ACTION_KEEP_ORG_ID) {
DEBUGLOG(("ProcessOffsetStmtTxn:: stmt_txn_action = [ADD ORG STMT TXN TO BATCH TXN RELATION]\n"));
	} else if (iStmtTxnAction == PD_STMT_TXN_ACTION_CHANGE_ORG_STATUS) {
DEBUGLOG(("ProcessOffsetStmtTxn:: stmt_txn_action = [UPDATE ORG STMT TXN STATUS]\n"));
	} else {
DEBUGLOG(("ProcessOffsetStmtTxn:: stmt_txn_action = [CREATE NEW STMT TXN AND UPDATE ORG STMT TXN STATUS]\n"));
	}

	// Lock Org Stmt Txn + Get Org Stmt Txn Info
	iRet = GetStmtTxnInfo(csOrgStmtTxnSeq, hContext, hOrgStmtTxn);

	// Check stmt txn action
	if (iStmtTxnAction == PD_STMT_TXN_ACTION_KEEP_ORG_ID) {

		// Add Org Stmt Txn to Batch Txn Relation
		if (iRet == PD_OK) {
                        iRet = AddOrgStmtTxnToBatchTxnRelation(hOrgStmtTxn, hContext);
                }
	} else if (iStmtTxnAction == PD_STMT_TXN_ACTION_CHANGE_ORG_STATUS) {

		// Update Org Stmt Txn Status
		if (iRet == PD_OK) {
			iRet = UpdateOrgStmtTxn(hOrgStmtTxn, hContext);
                }
	} else {

		// Form Offset Stmt Txn
		if (iRet == PD_OK) {
        		iRet = FormNewStmtTxn(hOrgStmtTxn, hNewStmtTxn, hContext);
		}

        	// Create Stmt Txn (with add approval_date, approval_timestamp)
        	if (iRet == PD_OK) {
        		iRet = CreateNewStmtTxn(hNewStmtTxn, hContext);
		}

		// Update Org Stmt Txn Status
		if (iRet == PD_OK) {
			iRet = UpdateOrgStmtTxn(hOrgStmtTxn, hContext);
		}
	}

DEBUGLOG(("ProcessOffsetStmtTxn:: iRet = [%d]\n", iRet));
        return iRet;
}

int     GetStmtTxnInfo(const char *csStmtTxnSeq, hash_t *hContext, hash_t *hStmtTxn)
{
        int     iRet = PD_OK;

        char    *csTmp = NULL;
        char    cTmp;
        double  dTmp = 0.0;
        int     iTmp = 0;

	// Get BAID Txn
        DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "GetBaidTxn");
        iRet = (unsigned long)(*DBObjPtr)(csStmtTxnSeq, hStmtTxn);
        if (iRet == PD_OK) {

/* txn_id */
		PutField_CString(hStmtTxn, "txn_seq", csStmtTxnSeq);

/* org_txn_id */
                if (GetField_CString(hStmtTxn, "org_txn_seq", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: org_txn_seq [%s]\n", csTmp));
                }

/* input_channel */
                if (GetField_CString(hStmtTxn, "input_channel", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: input_channel [%s]\n", csTmp));
                }

/* status */
                if (GetField_Char(hStmtTxn, "status", &cTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: status [%c]\n", cTmp));
                }

/* ar_ind */
                if (GetField_Char(hStmtTxn, "ar_ind", &cTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: ar_ind [%c]\n", cTmp));
                }

/* sub_status */
                if (GetField_CString(hStmtTxn, "sub_status", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: sub_status [%s]\n", csTmp));
                }

/* stat_txn_id */
                if (GetField_CString(hStmtTxn, "stat_txn_id", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: stat_txn_id [%s]\n", csTmp));
                }

/* txn_code */
                if (GetField_CString(hStmtTxn, "txn_code", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: txn_code [%s]\n", csTmp));
                }

/* pid */
                if (GetField_CString(hStmtTxn, "pid", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: pid [%s]\n", csTmp));
                }

/* baid */
                if (GetField_CString(hStmtTxn, "baid", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: baid [%s]\n", csTmp));
                }

/* posting_date */
                if (GetField_CString(hStmtTxn, "posting_date", &csTmp)) {
//DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: posting_date [%s]\n", csTmp));
                }

/* transmission_datetime */
                if (GetField_CString(hStmtTxn, "transmission_datetime", &csTmp)) {
//DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: transmission_datetime [%s]\n", csTmp));
                }

/* txn_ccy */
                if (GetField_CString(hStmtTxn, "txn_ccy", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: txn_ccy [%s]\n", csTmp));
                }

/* txn_amt */
                if (GetField_Double(hStmtTxn, "txn_amt", &dTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: txn_amt [%f]\n", dTmp));
                }

/* open_bal */
                if (GetField_Double(hStmtTxn, "open_bal", &dTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: open_bal [%f]\n", dTmp));
                }

/* curr_bal */
                if (GetField_Double(hStmtTxn, "curr_bal", &dTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: curr_bal [%f]\n", dTmp));
                }

/* dst_txn_id */
                if (GetField_CString(hStmtTxn, "dst_txn_id", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: dst_txn_id [%s]\n", csTmp));
                }

/* bank_code */
                if (GetField_CString(hStmtTxn, "bank_code", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: bank_code [%s]\n", csTmp));
                }

/* bank_acct_num */
                if (GetField_CString(hStmtTxn, "bank_acct_num", &csTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: bank_acct_num [%s]\n", csTmp));
                }

/* pid_txn_hold_ind */
                if (GetField_Int(hStmtTxn, "pid_txn_hold_ind", &iTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: pid_txn_hold_ind [%d]\n", iTmp));
                }

/* pid_sys_match_ind */
                if (GetField_Int(hStmtTxn, "pid_sys_match_ind", &iTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: pid_sys_match_ind [%d]\n", iTmp));
                }

/* posted_ind */
                if (GetField_Int(hStmtTxn, "posted_ind", &iTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: posted_ind [%d]\n", iTmp));
                }

/* recon_status */
                if (GetField_Char(hStmtTxn, "recon_status", &cTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: recon_status [%c]\n", cTmp));
                }

/* classified_status */
                if (GetField_Char(hStmtTxn, "classified_status", &cTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: classified_status [%c]\n", cTmp));
                }

/* hold_recon */
                if (GetField_Int(hStmtTxn, "hold_recon", &iTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: hold_recon [%d]\n", iTmp));
                }

/* manual_hold_recon */
                if (GetField_Int(hStmtTxn, "manual_hold_recon", &iTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: manual_hold_recon [%d]\n", iTmp));
                }

/* est_net_amount */
                if (GetField_Double(hStmtTxn, "est_net_amount", &dTmp)) {
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: est_net_amount [%f]\n", dTmp));
                }

	} else {
                iRet = INT_INVALID_TXN;
DEBUGLOG(("GetStmtTxnInfo (OLBAIDTxn):: not found record for [%s]\n", csStmtTxnSeq));
ERRLOG("TxnOmtByUsRBT:: GetStmtTxnInfo:: (OLBAIDTxn):: not found record for [%s]\n", csStmtTxnSeq);
        }

DEBUGLOG(("GetStmtTxnInfo:: iRet = [%d]\n", iRet));
        return iRet;
}

int     FormNewStmtTxn(hash_t *hOrgStmtTxn, hash_t *hNewStmtTxn, hash_t *hContext)
{
        int     iRet = PD_OK;

	char    csOfstStmtTxnSeq[PD_TXN_SEQ_LEN + 1];

	char	*csAmtType = NULL;
	char	*csDefaultBaidTxnCode = NULL;

        char    *csTmp = NULL;
        double  dTmp = 0.0;
        int     iTmp = 0;

/* db_commit */
        PutField_Int(hNewStmtTxn, "db_commit", PD_FALSE);

/* txn_seq */
        DBObjPtr = CreateObj(DBPtr, "DBOLTxnSeq", "GetNextBaidTxnSeq");
        strcpy(csOfstStmtTxnSeq, (*DBObjPtr)());
DEBUGLOG(("FormNewStmtTxn:: Call DBOLTxnSeq: GetNextBaidTxnSeq [%s]\n", csOfstStmtTxnSeq));
        PutField_CString(hNewStmtTxn, "txn_seq", csOfstStmtTxnSeq);

/* org_txn_id */
        if (GetField_CString(hOrgStmtTxn, "txn_seq", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn:: org_stmt_txn_seq [%s]\n", csTmp));
                PutField_CString(hOrgStmtTxn, "txn_id", csTmp);
                PutField_CString(hNewStmtTxn, "org_txn_seq", csTmp);
        }

/* input_channel */
        if (GetField_CString(hOrgStmtTxn, "input_channel", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn:: input_channel [%s]\n", csTmp));
                PutField_CString(hNewStmtTxn, "channel_code", csTmp);
        }

/* stat_txn_id */
        if (GetField_CString(hOrgStmtTxn, "stat_txn_id", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn:: stat_txn_id [%s]\n", csTmp));
                PutField_CString(hNewStmtTxn, "stat_txn_id", csTmp);
        }

/* txn_code */
        if (GetField_CString(hOrgStmtTxn, "txn_code", &csTmp)) {
//DEBUGLOG(("FormNewStmtTxn:: txn_code [%s]\n", csTmp));
                PutField_CString(hNewStmtTxn, "txn_code", csTmp);
        }

/* pid */
        if (GetField_CString(hOrgStmtTxn, "pid", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn:: pid [%s]\n", csTmp));
                PutField_CString(hNewStmtTxn, "pid", csTmp);
        }

/* baid */
        if (GetField_CString(hOrgStmtTxn, "baid", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn:: baid [%s]\n", csTmp));
                PutField_CString(hNewStmtTxn, "baid", csTmp);
        }

/* posting_date */
        if (GetField_CString(hOrgStmtTxn, "posting_date", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn:: posting_date [%s]\n", csTmp));
                PutField_CString(hNewStmtTxn, "posting_date", csTmp);
        }

/* transmission_datetime */
        if (GetField_CString(hOrgStmtTxn, "transmission_datetime", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn:: transmission_datetime [%s]\n", csTmp));
                PutField_CString(hNewStmtTxn, "transmission_datetime", csTmp);
        }

/* txn_ccy */
        if (GetField_CString(hOrgStmtTxn, "txn_ccy", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn:: txn_ccy [%s]\n", csTmp));
                PutField_CString(hNewStmtTxn, "txn_ccy", csTmp);
        }

/* txn_amt */
        if (GetField_Double(hOrgStmtTxn, "txn_amt", &dTmp)) {
DEBUGLOG(("FormNewStmtTxn:: txn_amt [%f]\n", dTmp));
                PutField_Double(hNewStmtTxn, "txn_amt", dTmp);
        }

/* open_bal */
        if (GetField_Double(hOrgStmtTxn, "open_bal", &dTmp)) {
DEBUGLOG(("FormNewStmtTxn:: open_bal [%f]\n", dTmp));
                PutField_Double(hNewStmtTxn, "open_bal", dTmp);
        }

/* curr_bal */
        if (GetField_Double(hOrgStmtTxn, "curr_bal", &dTmp)) {
DEBUGLOG(("FormNewStmtTxn:: curr_bal [%f]\n", dTmp));
                PutField_Double(hNewStmtTxn, "curr_bal", dTmp);
        }

/* dst_txn_id */
        if (GetField_CString(hOrgStmtTxn, "dst_txn_id", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn:: dst_txn_id [%s]\n", csTmp));
                PutField_CString(hNewStmtTxn, "dst_txn_id", csTmp);
        }

/* bank_code */
        if (GetField_CString(hOrgStmtTxn, "bank_code", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn:: bank_code [%s]\n", csTmp));
                PutField_CString(hNewStmtTxn, "bank_code", csTmp);
        }

/* bank_acct_num */
        if (GetField_CString(hOrgStmtTxn, "bank_acct_num", &csTmp)) {
DEBUGLOG(("FormNewStmtTxn:: bank_acct_num [%s]\n", csTmp));
                PutField_CString(hNewStmtTxn, "bank_acct_num", csTmp);
        }

/* pid_txn_hold_ind */
        if (GetField_Int(hOrgStmtTxn, "pid_txn_hold_ind", &iTmp)) {
DEBUGLOG(("FormNewStmtTxn:: pid_txn_hold_ind [%d]\n", iTmp));
                PutField_Int(hNewStmtTxn, "pid_txn_hold_ind", iTmp);
        }

/* pid_sys_match_ind */
        if (GetField_Int(hOrgStmtTxn, "pid_sys_match_ind", &iTmp)) {
DEBUGLOG(("FormNewStmtTxn:: pid_sys_match_ind [%d]\n", iTmp));
                PutField_Int(hNewStmtTxn, "pid_sys_match_ind", iTmp);
        }

/* posted_ind */
        if (GetField_Int(hOrgStmtTxn, "posted_ind", &iTmp)) {
DEBUGLOG(("FormNewStmtTxn:: posted_ind [%d]\n", iTmp));
                PutField_Int(hNewStmtTxn, "posted_ind", iTmp);
        }

/* hold_recon */
        PutField_Int(hNewStmtTxn, "hold_recon", PD_TRUE);
DEBUGLOG(("FormNewStmtTxn:: hold_recon [%d]\n", PD_TRUE));

/* manual_hold_recon */
	if (GetField_Int(hOrgStmtTxn, "manual_hold_recon", &iTmp)) {
DEBUGLOG(("FormNewStmtTxn:: manual_hold_recon [%d]\n", iTmp));
        	PutField_Int(hNewStmtTxn, "manual_hold_recon", iTmp);
	}

/* est_net_amount */
        if (GetField_Double(hOrgStmtTxn, "est_net_amount", &dTmp)) {
DEBUGLOG(("FormNewStmtTxn:: est_net_amount [%f]\n", dTmp));
                PutField_Double(hNewStmtTxn, "est_net_amount", dTmp);
        }

/* txn_code */
        DBObjPtr = CreateObj(DBPtr,"DBOLBAIDTxnCode","CheckDefaultBaidTxnCode");
        iRet = (unsigned long)(*DBObjPtr)(hOrgStmtTxn);
        if (iRet == PD_OK) {

/* amt_type */	
		if (GetField_CString(hOrgStmtTxn, "amt_type", &csAmtType)) {
//DEBUGLOG(("FormNewStmtTxn:: Call DBOLBAIDTxnCode:: amt_type [%s]\n", csAmtType));
		} else {
			iRet = INT_ERR;
DEBUGLOG(("FormNewStmtTxn:: Call DBOLBAIDTxnCode:: amt_type Not Found\n"));
ERRLOG("TxnOmtByUsRBT:: FormNewStmtTxn:: Call DBOLBAIDTxnCode:: amt_type Not Found!!!\n");
		}

/* default_code */
                if (GetField_CString(hOrgStmtTxn, "default_code", &csDefaultBaidTxnCode)) {
//DEBUGLOG(("FormNewStmtTxn:: Call DBOLBAIDTxnCode:: default_code [%s]\n", csDefaultBaidTxnCode));

                        if ((!strcmp(csDefaultBaidTxnCode, PD_TXN_CODE_UNKNOWN_SWEEP_IN)) ||
                            (!strcmp(csDefaultBaidTxnCode, PD_TXN_CODE_UNKNOWN_SWEEP_OUT))
                        )
                        {
                                PutField_CString(hNewStmtTxn, "txn_code", csDefaultBaidTxnCode);
DEBUGLOG(("FormNewStmtTxn:: txn_code [%s]\n", csDefaultBaidTxnCode));
                        }
                        else
                        {
                           	if (!strcmp(csAmtType, PD_CR)) {
                           		PutField_CString(hNewStmtTxn, "txn_code", PD_TXN_CODE_UNKNOWN_CREDIT);
DEBUGLOG(("FormNewStmtTxn:: txn_code [%s]\n", PD_TXN_CODE_UNKNOWN_CREDIT));
                            	} else if (!strcmp(csAmtType, PD_DR)) {
                                    	PutField_CString(hNewStmtTxn, "txn_code", PD_TXN_CODE_UNKNOWN_DEBIT);
DEBUGLOG(("FormNewStmtTxn:: txn_code [%s]\n", PD_TXN_CODE_UNKNOWN_DEBIT));
                             	}
                        }
                } else {
                        if (!strcmp(csAmtType, PD_CR)) {
                                PutField_CString(hNewStmtTxn, "txn_code", PD_TXN_CODE_UNKNOWN_CREDIT);
DEBUGLOG(("FormNewStmtTxn:: txn_code [%s]\n", PD_TXN_CODE_UNKNOWN_CREDIT));
                        } else if (!strcmp(csAmtType, PD_DR)) {
                                PutField_CString(hNewStmtTxn, "txn_code", PD_TXN_CODE_UNKNOWN_DEBIT);
DEBUGLOG(("FormNewStmtTxn:: txn_code [%s]\n", PD_TXN_CODE_UNKNOWN_DEBIT));
                        }
                }

        } else {
		iRet = INT_ERR;
DEBUGLOG(("FormNewStmtTxn:: Call DBOLBAIDTxnCode:: CheckDefaultBaidTxnCode Not Found\n"));
ERRLOG("TxnOmtByUsRBT:: FormNewStmtTxn:: Call DBOLBAIDTxnCode:: CheckDefaultBaidTxnCode Not Found!!!\n");
	}

DEBUGLOG(("FormNewStmtTxn:: iRet = [%d]\n", iRet));
        return iRet;
}
	
int     CreateNewStmtTxn(hash_t *hNewStmtTxn, hash_t *hContext)
{
	int     iRet = PD_OK;

        char    *csOrgStmtTxnSeq = NULL;
        char    *csStmtTxnSeq = NULL;
        char    *csBatchSeq = NULL;

	char	cBatchType;
	char	cBatchSubType;

        char    *csTmp = NULL;

        char    csDate[PD_DATE_LEN + 1] = "";
        char    csDateTime[PD_DATETIME_LEN + 1] = "";

        time_t  tNow = time(NULL);
        struct  tm tStruct = *localtime(&tNow);

        hash_t *hRelation;
        hRelation = (hash_t*) malloc(sizeof(hash_t));

	cBatchType = ' ';
	cBatchSubType = ' ';

/* org_txn_seq */
        if (GetField_CString(hNewStmtTxn, "org_txn_seq", &csOrgStmtTxnSeq)) {
DEBUGLOG(("CreateNewStmtTxn:: org_stmt_txn_seq [%s]\n", csOrgStmtTxnSeq));
        }

/* txn_seq */
        if (GetField_CString(hNewStmtTxn, "txn_seq", &csStmtTxnSeq)) {
DEBUGLOG(("CreateNewStmtTxn:: stmt_txn_seq [%s]\n", csStmtTxnSeq));
        }

/* batch_txn_seq */
        if (GetField_CString(hContext, "batch_txn_seq", &csBatchSeq)) {
DEBUGLOG(("CreateNewStmtTxn:: batch_txn_seq [%s]\n", csBatchSeq));
        }

/* batch_type */
        if (GetField_Char(hContext, "batch_type", &cBatchType)) {
DEBUGLOG(("CreateNewStmtTxn:: batch_type [%c]\n", cBatchType));
        }

/* batch_sub_type */
        if (GetField_Char(hContext, "batch_sub_type", &cBatchSubType)) {
DEBUGLOG(("CreateNewStmtTxn:: batch_sub_type [%c]\n", cBatchSubType));
        }

/* approval_date */
        strftime(csDate, sizeof(csDate), PD_DEFAULT_DATE_FORMAT, &tStruct);
        PutField_CString(hContext, "approval_date", csDate);
        PutField_CString(hNewStmtTxn, "approval_date", csDate);
//DEBUGLOG(("CreateNewStmtTxn:: approval_date [%s]\n", csDate));

/* approval_timestamp */
        strftime(csDateTime, sizeof(csDateTime), PD_DEFAULT_DATETIME_FORMAT, &tStruct);
        PutField_CString(hContext, "approval_timestamp", csDateTime);
        PutField_CString(hNewStmtTxn, "approval_timestamp", csDateTime);
//DEBUGLOG(("CreateNewStmtTxn:: approval_timestamp [%s]\n", csDateTime));

/* add user */
        if (GetField_CString(hContext, "update_user", &csTmp)) {
DEBUGLOG(("CreateNewStmtTxn:: update_user [%s]\n", csTmp));
                PutField_CString(hNewStmtTxn, "update_user", csTmp);
                PutField_CString(hNewStmtTxn, "add_user", csTmp);
                PutField_CString(hNewStmtTxn, "create_user", csTmp);
        }

/* db_commit */
        PutField_Int(hNewStmtTxn, "db_commit", PD_FALSE);
DEBUGLOG(("CreateNewStmtTxn:: db_commit [%d]\n", PD_FALSE));

/* status, ar_ind, sub_status, recon_status, classified_status */
       	PutField_Char(hNewStmtTxn, "status", PD_COMPLETE);
DEBUGLOG(("CreateNewStmtTxn:: status [%c]\n", PD_COMPLETE));

	PutField_Char(hNewStmtTxn, "ar_ind", PD_ACCEPT);
DEBUGLOG(("CreateNewStmtTxn:: ar_ind [%c]\n", PD_ACCEPT));

        PutField_CString(hNewStmtTxn, "sub_status", PD_APPROVED);
DEBUGLOG(("CreateNewStmtTxn:: sub_status [%s]\n", PD_APPROVED));

        PutField_Char(hNewStmtTxn, "recon_status", PD_UNRECONCILED);
DEBUGLOG(("CreateNewStmtTxn:: recon_status [%c]\n", PD_UNRECONCILED));

        PutField_Char(hNewStmtTxn, "classified_status", PD_UNCLASSIFIED);
DEBUGLOG(("CreateNewStmtTxn:: classified_status [%c]\n", PD_UNCLASSIFIED));

DEBUGLOG(("CreateNewStmtTxn:: Call DBOLBAIDTxn:: Add\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Add");
        iRet = (unsigned long)(*DBObjPtr)(hNewStmtTxn);
        if (iRet != PD_OK) {
                iRet = INT_ERR;
DEBUGLOG(("CreateNewStmtTxn:: Call DBOLBAIDTxn:: Add failed\n"));
ERRLOG("TxnOmtByUsRBT::CreateNewStmtTxn() Call DBOLBAIDTxn::Add() failed\n");
        }

	// Add Txn Relation (Linkage)
	if (iRet == PD_OK) {
DEBUGLOG(("CreateNewStmtTxn:: Call AddTxnRelation() [Linkage]\n"));
	
		hash_init(hRelation, 0);

		// Org Txn Seq
		PutField_Char(hRelation, "party", PD_TYPE_PSP);
                PutField_CString(hRelation, "p1_txn_id", csOrgStmtTxnSeq);
                PutField_CString(hRelation, "p2_txn_id", csStmtTxnSeq);
                PutField_Char(hRelation, "txn_level", PD_STMT_LEVEL);
                PutField_Char(hRelation, "relation_type", PD_REL_LINKAGE);
                if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hRelation, "update_user", csTmp);
                        PutField_CString(hRelation, "add_user", csTmp);
                        PutField_CString(hRelation, "create_user", csTmp);
                }

                iRet = AddTxnRelation(hRelation);

                hash_destroy(hRelation);
        }

	// Add Batch Txn Relation (Stmt Txn Id)
	if ((iNumOfBatchId > 0) && (iRet == PD_OK)) {
DEBUGLOG(("CreateNewStmtTxn:: Call AddBatchTxnRelation()\n"));

                hash_init(hRelation, 0);

                PutField_Char(hRelation, "batch_type", cBatchType);
		if (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) {
                        PutField_Char(hRelation, "batch_sub_type", PD_GENERAL_UNDO_BAL_TRF);
                } else {
                	PutField_Char(hRelation, "batch_sub_type", cBatchSubType);
		}
             	PutField_CString(hRelation, "batch_txn_seq", csBatchSeq);
                PutField_Char(hRelation, "txn_level", PD_STMT_LEVEL);
                PutField_CString(hRelation, "txn_seq", csStmtTxnSeq);
             	PutField_Int(hRelation, "is_input_txn", 0);
             	PutField_Int(hRelation, "is_regen_txn", 0);
		if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hRelation, "update_user", csTmp);
                        PutField_CString(hRelation, "add_user", csTmp);
                        PutField_CString(hRelation, "create_user", csTmp);
                }

                iRet = AddBatchTxnRelation(hRelation);

                hash_destroy(hRelation);
        }

	FREE_ME(hRelation);

DEBUGLOG(("CreateNewStmtTxn:: iRet = [%d]\n", iRet));
        return iRet;
}

int     UpdateOrgStmtTxn(hash_t *hOrgStmtTxn, hash_t *hContext)
{
        int     iRet = PD_OK;

        char    *csTmp = NULL;
        char    *csStmtTxnSeq = NULL;
	
        hash_t  *hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec, 0);

/* txn_seq */
        if (GetField_CString(hOrgStmtTxn, "txn_seq", &csStmtTxnSeq)) {
DEBUGLOG(("UpdateOrgStmtTxn:: stmt_txn_seq [%s]\n", csStmtTxnSeq));
                PutField_CString(hRec, "txn_seq", csStmtTxnSeq);
        }

/* remark */
	if (GetField_CString(hContext, "remark", &csTmp)) {
DEBUGLOG(("UpdateOrgStmtTxn:: remark [%s]\n", csTmp));
                PutField_CString(hRec, "remark", csTmp);
        }

/* update_user */
        if (GetField_CString(hContext, "update_user", &csTmp)) {
DEBUGLOG(("UpdateOrgStmtTxn:: upate_user [%s]\n", csTmp));
                PutField_CString(hRec, "update_user", csTmp);
        }

/* status, sub_status */
        PutField_Char(hRec, "status", PD_REVERSED);
DEBUGLOG(("UpdateOrgStmtTxn:: status [%c]\n", PD_REVERSED));

	if (!strcmp(csTxnType, PD_TXN_TYPE_SMS_BANK_DEPOSIT)) {
		PutField_CString(hRec, "sub_status", PD_UNDO);
DEBUGLOG(("UpdateOrgStmtTxn:: sub_status [%s]\n", PD_UNDO));
	} else {
		if (iAction == PD_BATCH_ACTION_CANCEL) {
        		PutField_CString(hRec, "sub_status", PD_CANCELLED);
DEBUGLOG(("UpdateOrgStmtTxn:: sub_status [%s]\n", PD_CANCELLED));
		} else if (iAction == PD_BATCH_ACTION_VOID) {
			PutField_CString(hRec, "sub_status", PD_UNDO);
DEBUGLOG(("UpdateOrgStmtTxn:: sub_status [%s]\n", PD_UNDO));
		}
	}

DEBUGLOG(("UpdateOrgStmtTxn:: Call DBOLBAIDTxn:: Update\n"));
        DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Update");
        iRet = (unsigned long)(*DBObjPtr)(hRec);
        if (iRet != PD_OK) {
        	iRet = INT_ERR;
DEBUGLOG(("UpdateOrgStmtTxn:: Call DBOLBAIDTxn:: Update failed\n"));
ERRLOG("TxnOmtByUsRBT:: UpdateOrgStmtTxn:: Call DBOLBAIDTxn:: Update failed\n");
        }

        hash_destroy(hRec);
        FREE_ME(hRec);

DEBUGLOG(("UpdateOrgStmtTxn:: iRet = [%d]\n", iRet));
        return iRet;
}

int     AddOrgStmtTxnToBatchTxnRelation(hash_t *hOrgStmtTxn, hash_t *hContext)
{
        int     iRet = PD_OK;

        char    *csTmp = NULL;
        char    *csStmtTxnSeq = NULL;
	char    *csBatchSeq = NULL;
	char    *csUser = NULL;

        char    cBatchType;
        char    cBatchSubType;
	
        hash_t  *hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec, 0);

	hash_t *hRelation;
        hRelation = (hash_t*) malloc(sizeof(hash_t));

	cBatchType = ' ';
	cBatchSubType = ' ';

/* txn_seq */
        if (GetField_CString(hOrgStmtTxn, "txn_seq", &csStmtTxnSeq)) {
DEBUGLOG(("AddOrgStmtTxnToBatchTxnRelation:: txn_seq [%s]\n", csStmtTxnSeq));
        }

/* batch_txn_seq */
        if (GetField_CString(hContext, "batch_txn_seq", &csBatchSeq)) {
DEBUGLOG(("AddOrgStmtTxnToBatchTxnRelation:: batch_txn_seq [%s]\n", csBatchSeq));
        }

/* batch_type */
        if (GetField_Char(hContext, "batch_type", &cBatchType)) {
DEBUGLOG(("AddOrgStmtTxnToBatchTxnRelation:: batch_type [%c]\n", cBatchType));
        }

/* batch_sub_type */
        if (GetField_Char(hContext, "batch_sub_type", &cBatchSubType)) {
DEBUGLOG(("AddOrgStmtTxnToBatchTxnRelation:: batch_sub_type [%c]\n", cBatchSubType));
        }

/* update_user */
        if (GetField_CString(hContext, "update_user", &csUser)) {
DEBUGLOG(("AddOrgStmtTxnToBatchTxnRelation:: upate_user [%s]\n", csUser));
        }

	// Add Batch Txn Relation (Stmt Txn Id)	
	if ((iNumOfBatchId > 0) && (iRet == PD_OK)) {
DEBUGLOG(("AddOrgStmtTxnToBatchTxnRelation:: Call BatchTxnRelation()\n"));

                hash_init(hRelation, 0);

                PutField_Char(hRelation, "batch_type", cBatchType);
		if (!strcmp(csTxnType, PD_TXN_TYPE_BAL_TRF_INTRA)) {
                        PutField_Char(hRelation, "batch_sub_type", PD_GENERAL_UNDO_BAL_TRF);
                } else {
                	PutField_Char(hRelation, "batch_sub_type", cBatchSubType);
                }
		PutField_CString(hRelation, "batch_txn_seq", csBatchSeq);
                PutField_Char(hRelation, "txn_level", PD_STMT_LEVEL);
                PutField_CString(hRelation, "txn_seq", csStmtTxnSeq);
                PutField_Int(hRelation, "is_input_txn", 0);
                PutField_Int(hRelation, "is_regen_txn", 0);
                if (GetField_CString(hContext, "update_user", &csTmp)) {
                        PutField_CString(hRelation, "update_user", csTmp);
                        PutField_CString(hRelation, "add_user", csTmp);
                        PutField_CString(hRelation, "create_user", csTmp);
                }

                iRet = AddBatchTxnRelation(hRelation);

                hash_destroy(hRelation);
        }
        
	hash_destroy(hRec);
        FREE_ME(hRec);

	FREE_ME(hRelation);

DEBUGLOG(("AddOrgStmtTxnToBatchTxnRelation:: iRet = [%d]\n", iRet));
        return iRet;
}
