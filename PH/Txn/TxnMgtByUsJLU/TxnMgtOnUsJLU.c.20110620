/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/05/18              Simon Fung
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtOnUsJLU.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);

void TxnMgtOnUsJLU(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
  int     iRet = PD_OK;
	char*	csTmp = NULL;
	int	iTmp;
	char	cTmp;
	double 	dTmp;
	hash_t	*hReq;
	char* csLineCnt = NULL;
	char* csBaseCcyCnt = NULL;
	int iLineCnt;
	int iBaseCcyCnt;
	int iLineTmp;
	int iBaseCcyTmp;
	char csName[PD_TMP_MSG_BUF_LEN];

	char*	csJnlNo = NULL;
	int iLineNo;
	char* csBaseCcy;	
	double dFxRate;
	double dConvertAmt;
	int iDisabled;
	char* csUpdateUser;

	hReq = (hash_t*) malloc (sizeof(hash_t));

	hash_init(hReq,0);

	DEBUGLOG(("TxnMgtOnUsJLU::Authorize()\n"));

		// jnl_id //
	if (GetField_CString(hRequest,"jnl_id",&csJnlNo)) {
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): jnl_id = [%s]\n",csJnlNo));
		PutField_CString(hReq,"jnl_id",csJnlNo);
	}
		// jnl_type_id //
	if (GetField_CString(hRequest,"jnl_type_id",&csTmp)) {
		iTmp = atoi(csTmp);
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): jnl_type_id = [%d]\n",iTmp));
		PutField_Int(hReq,"jnl_type_id",iTmp);
	}
		// description //
	if (GetField_CString(hRequest,"description",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): description = [%s]\n",csTmp));
		PutField_CString(hReq,"description",csTmp);
	}
		// txn_date //
	if (GetField_CString(hRequest,"txn_date",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): txn_date = [%s]\n",csTmp));
		PutField_CString(hReq,"txn_date",csTmp);
	}
		// bank_update_date //
	if (GetField_CString(hRequest,"bank_update_date",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): bank_update_date = [%s]\n",csTmp));
		PutField_CString(hReq,"bank_update_date",csTmp);
	}
		// acc_year //
	if (GetField_CString(hRequest,"acc_year",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): acc_year = [%s]\n",csTmp));
		PutField_CString(hReq,"acc_year",csTmp);
	}
		// acc_month //
	if (GetField_CString(hRequest,"acc_month",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): acc_month = [%s]\n",csTmp));
		PutField_CString(hReq,"acc_month",csTmp);
	}

		// country_code //
	if (GetField_CString(hRequest,"country_code",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): country_code = [%s]\n",csTmp));
		PutField_CString(hReq,"country_code",csTmp);
	}
	
		// product_id //
	if (GetField_CString(hRequest,"product_id",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): product_id = [%s]\n",csTmp));
		PutField_CString(hReq,"product_id",csTmp);
	}
	
		// ref_no //
	if (GetField_CString(hRequest,"ref_no",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): ref_no = [%s]\n",csTmp));
		PutField_CString(hReq,"ref_no",csTmp);
	}
		// remarks //
	if (GetField_CString(hRequest,"remarks",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): remarks = [%s]\n",csTmp));
		PutField_CString(hReq,"remarks",csTmp);
	}
		// status //
	if (GetField_CString(hRequest,"status",&csTmp)) {
		//cTmp = (char) csTmp;
		cTmp = csTmp[0];
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): status = [%c]\n",cTmp));
		PutField_Char(hReq,"status",cTmp);
	}
		// disabled //
	if (GetField_CString(hRequest,"disabled",&csTmp)) {
		iTmp = atoi(csTmp);
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): disabled = [%d]\n",iTmp));
		PutField_Int(hReq,"disabled",iTmp);
	}
		// create_user //
	if (GetField_CString(hRequest,"create_user",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): create_user = [%s]\n",csTmp));
		PutField_CString(hReq,"create_user",csTmp);
	}
		// update_user //
	if (GetField_CString(hRequest,"update_user",&csUpdateUser)) {
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): update_user = [%s]\n",csUpdateUser));
		PutField_CString(hReq,"update_user",csUpdateUser);
	}
		// approve_user //
	if (GetField_CString(hRequest,"approve_user",&csTmp)) {
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): approve_user = [%s]\n",csTmp));
		PutField_CString(hReq,"approve_user",csTmp);
	}

		// line_count //
	if (GetField_CString(hRequest,"line_count",&csLineCnt)) {
		iLineCnt = atoi(csLineCnt);
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): line_count = [%d]\n",iLineCnt));
		PutField_Int(hReq,"line_count",iLineCnt);
	}	else {
		DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): No Journal Detail\n"));
		iRet = PD_ERR;
	}
	

	
	if(iRet==PD_OK) {
		
		// Insert Journal Header
		DBObjPtr = CreateObj(DBPtr,"DBCrrJnlHeader","Update");
		iRet = (unsigned long) ((*DBObjPtr)(hReq));			

		if(iRet==PD_OK) {
			
			strcpy(csName,""); 
			
				// jnl_id //
			/*
			if (GetField_CString(hRequest,"jnl_id",&csTmp)) {
				DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): jnl_id = [%s]\n",csTmp));
				PutField_CString(hReq,"jnl_id",csTmp);
			}
			*/		
			
			// Get Journal Details (multiple) //		
			for (iLineTmp=1;iLineTmp<=iLineCnt;iLineTmp++) {
				//DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Inside Loop \n"));
				
				// Convert to string
				sprintf(csLineCnt,"%d",iLineTmp);
				
				// Concat the parameter name
				// line_no //
				strcpy(csName, "line_no");
				strcat(csName, csLineCnt);
				DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Getting %s \n",csName));
				if (GetField_CString(hRequest,csName,&csTmp)) {
					iLineNo = atoi(csTmp);
					DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): %s = [%d]\n",csName, iLineNo));
					PutField_Int(hReq,"line_no",iLineNo);
				}
				
				// gl_id //
				strcpy(csName, "gl_id");
				strcat(csName, csLineCnt);		
				DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Getting %s \n",csName));
				if (GetField_CString(hRequest,csName,&csTmp)) {
					iTmp = atoi(csTmp);
					DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): %s = [%d]\n",csName, iTmp));
					PutField_Int(hReq,"gl_id",iTmp);
				}
				
					// currency_id //
				strcpy(csName, "currency_id");
				strcat(csName, csLineCnt);		
				DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Getting %s \n",csName));
				if (GetField_CString(hRequest,csName,&csTmp)) {
					DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): %s = [%s]\n",csName, csTmp));
					PutField_CString(hReq,"currency_id",csTmp);
				}
					// txn_amt //
				strcpy(csName, "txn_amt");
				strcat(csName, csLineCnt);		
				DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Getting %s \n",csName));
				if (GetField_CString(hRequest,csName,&csTmp)) {
					dTmp = atof(csTmp);
					DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): %s = [%f]\n",csName, dTmp));
					PutField_Double(hReq,"txn_amt",dTmp);
				}
					// cr_ind //
				strcpy(csName, "cr_ind");
				strcat(csName, csLineCnt);		
				DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Getting %s \n",csName));
				if (GetField_CString(hRequest,csName,&csTmp)) {
					cTmp = csTmp[0];
					DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): %s = [%c]\n",csName, cTmp));
					PutField_Char(hReq,"cr_ind",cTmp);
				}

					// remarks //
				strcpy(csName, "remarks");
				strcat(csName, csLineCnt);		
				DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Getting %s \n",csName));
				if (GetField_CString(hRequest,csName,&csTmp)) {
					DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): %s = [%s]\n",csName, csTmp));
					PutField_CString(hReq,"remarks",csTmp);
				}

					// disabled //
				strcpy(csName, "disabled");
				strcat(csName, csLineCnt);		
				DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Getting %s \n",csName));
				if (GetField_CString(hRequest,csName,&csTmp)) {
					iDisabled = atoi(csTmp);
					DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): %s = [%d]\n",csName, iDisabled));
					PutField_Int(hReq,"disabled",iDisabled);
				}			

					// dbaction //
				strcpy(csName, "dbaction");
				strcat(csName, csLineCnt);		
				DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Getting %s \n",csName));					
				if (GetField_CString(hRequest,csName,&csTmp)) {
					//cTmp = (char) csTmp;
					cTmp = csTmp[0];
					DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): %s = [%c]\n",csName, cTmp));
					//PutField_Char(hReq,"dbaction",cTmp);
				}
				
				if (cTmp == PD_JNL_ADD) {				
					// Insert Journal Details
					DBObjPtr = CreateObj(DBPtr,"DBCrrJnlDetail","Add");
					iRet = (unsigned long) ((*DBObjPtr)(hReq));	
					
					if(iRet!=PD_OK) {
						DEBUGLOG(("TxnMgtOnUsJLU::CrrJnlDetail->Add Failed\n"));
						break;
					} else {
						DEBUGLOG(("TxnMgtOnUsJLU::CrrJnlDetail->Add Success\n"));
						
						DEBUGLOG(("TxnMgtOnUsJLU::CrrJnlDetailAmt->Add Start\n"));
		
						// Get Journal Details Converted (multiple) //		
						for (iBaseCcyTmp=1;iBaseCcyTmp<=iBaseCcyCnt;iBaseCcyTmp++) {
	
							// Convert to string
							sprintf(csBaseCcyCnt,"%d",iBaseCcyTmp);
		
								// base_ccy //
							strcpy(csName, "bccy");
							strcat(csName, csLineCnt);		
							strcat(csName, "_");	
							strcat(csName, csBaseCcyCnt);					
							DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Getting %s \n",csName));
							if (GetField_CString(hRequest,csName,&csTmp)) {
								csBaseCcy = csTmp;
								DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): %s = [%s]\n",csName, csBaseCcy));
							}
		
								// fx //
							strcpy(csName, "bfx");
							strcat(csName, csLineCnt);		
							strcat(csName, "_");	
							strcat(csName, csBaseCcyCnt);		
							DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Getting %s \n",csName));
							if (GetField_CString(hRequest,csName,&csTmp)) {
								dFxRate = atof(csTmp);
								DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): %s = [%f]\n",csName, dFxRate));
							}
								// amt //
							strcpy(csName, "bamt");
							strcat(csName, csLineCnt);		
							strcat(csName, "_");	
							strcat(csName, csBaseCcyCnt);		
							DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Getting %s \n",csName));
							if (GetField_CString(hRequest,csName,&csTmp)) {
								dConvertAmt = atof(csTmp);
								DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): %s = [%f]\n",csName, dConvertAmt));
							}
		
							// Add Converted Amt
							DBObjPtr = CreateObj(DBPtr,"DBCrrJnlDetailAmt","Add");
							iRet  = (unsigned long)((*DBObjPtr)(csJnlNo, iLineNo, csBaseCcy, dFxRate, dConvertAmt, iDisabled, csUpdateUser ));
							
							if (iRet!=PD_OK) {
								DEBUGLOG(("TxnMgtOnUsJLU::CrrJnlDetailAmt->Add Failed at detail [%s-%s]\n",csLineCnt,csBaseCcyCnt));
								break;
							} else {
								DEBUGLOG(("TxnMgtOnUsJLC::CrrJnlDetailAmt->Add Success at detail [%s-%s]\n",csLineCnt,csBaseCcyCnt));
							}
						} // for 
	
						// break for converted error
						if (iRet!=PD_OK) {
							break;
						}
					}
					
				} else if (cTmp == PD_JNL_UPDATE) {
					// Insert Journal Details
					DBObjPtr = CreateObj(DBPtr,"DBCrrJnlDetail","Update");					
					iRet = (unsigned long) ((*DBObjPtr)(hReq));	

					if(iRet!=PD_OK) {
						DEBUGLOG(("TxnMgtOnUsJLU::CrrJnlDetail->Update Failed\n"));
						break;
					} else {
						DEBUGLOG(("TxnMgtOnUsJLU::CrrJnlDetail->Update Success\n"));
						
						DEBUGLOG(("TxnMgtOnUsJLU::CrrJnlDetailAmt->Update Start\n"));
		
						// Get Journal Details Converted (multiple) //		
						for (iBaseCcyTmp=1;iBaseCcyTmp<=iBaseCcyCnt;iBaseCcyTmp++) {
	
							// Convert to string
							sprintf(csBaseCcyCnt,"%d",iBaseCcyTmp);
		
								// base_ccy //
							strcpy(csName, "bccy");
							strcat(csName, csLineCnt);		
							strcat(csName, "_");	
							strcat(csName, csBaseCcyCnt);					
							DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Getting %s \n",csName));
							if (GetField_CString(hRequest,csName,&csTmp)) {
								csBaseCcy = csTmp;
								DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): %s = [%s]\n",csName, csBaseCcy));
							}
		
								// fx //
							strcpy(csName, "bfx");
							strcat(csName, csLineCnt);		
							strcat(csName, "_");	
							strcat(csName, csBaseCcyCnt);		
							DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Getting %s \n",csName));
							if (GetField_CString(hRequest,csName,&csTmp)) {
								dFxRate = atof(csTmp);
								DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): %s = [%f]\n",csName, dFxRate));
							}
								// amt //
							strcpy(csName, "bamt");
							strcat(csName, csLineCnt);		
							strcat(csName, "_");	
							strcat(csName, csBaseCcyCnt);		
							DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): Getting %s \n",csName));
							if (GetField_CString(hRequest,csName,&csTmp)) {
								dConvertAmt = atof(csTmp);
								DEBUGLOG(("TxnMgtOnUsJLU::Authorize(): %s = [%f]\n",csName, dConvertAmt));
							}
		
							// Add Converted Amt
							DBObjPtr = CreateObj(DBPtr,"DBCrrJnlDetailAmt","Update");
							iRet  = (unsigned long)((*DBObjPtr)(csJnlNo, iLineNo, csBaseCcy, dFxRate, dConvertAmt, iDisabled, csUpdateUser ));
							
							if (iRet!=PD_OK) {
								DEBUGLOG(("TxnMgtOnUsJLU::CrrJnlDetailAmt->Update Failed at detail [%s-%s]\n",csLineCnt,csBaseCcyCnt));
								break;
							} else {
								DEBUGLOG(("TxnMgtOnUsJLC::CrrJnlDetailAmt->Update Success at detail [%s-%s]\n",csLineCnt,csBaseCcyCnt));
							}
						} // for 
	
						// break for converted error
						if (iRet!=PD_OK) {
							break;
						}

					}

				} else {
					iRet = PD_ERR;
				}
				
				if(iRet!=PD_OK) {
					DEBUGLOG(("TxnMgtOnUsJLU::CrrJnlDetail->Update Failed\n"));
					break;
				}
				
				DEBUGLOG(("TxnMgtOnUsJLU::CrrJnlDetail->Update Success\n"));
		
			} // for
				
			DEBUGLOG(("TxnMgtOnUsJLU::CrrJnlHeader->Update Success\n"));
		} else {
			DEBUGLOG(("TxnMgtOnUsJLU::CrrJnlHeader->Update Failed\n"));	
		}			 	
	}
	else{
		DEBUGLOG(("TxnMgtOnUsJLU::CrrJnlHeader->Update Failed\n"));	
	}

	hash_destroy(hReq);
	FREE_ME(hReq);
	DEBUGLOG(("TxnMgtOnUsJLU::Authorize() Normal exit iret = [%d]\n",iRet));	
	return iRet;
}
