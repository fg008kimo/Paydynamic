/*
Partnerdelight (c)2015. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/06/29              Dirk Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMmmByUsBCN.h"
#include "myrecordset.h"

char cDebug;

OBJPTR(DB);
OBJPTR(BO);

int ProcessToTxn(char *csFromTxnSeq,hash_t *hToTxn);

void TxnMmmByUsBCN(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                  hash_t* hResponse)
{
        int     iRet = PD_OK;
	int	i = 0;

	char*	csTmp = NULL;
	char*	csPtr;
	char    csTag[PD_TAG_LEN + 1];
	char	cTmp;
	int	iTmp = 0;
	double	dTmp = 0.0;

	char*	csTxnCodeOut, csTxnCodeIn;

	char*	csTxnCcy;
	double	dTxnAmt;

	char*	csTxnEntityId;
	char*	csTxnNatureId;
	int	iTxnBalCnt;

	char*	csDstEntityId;
	char*	csDstNatureId;
	int	iDstBalCnt;

	hash_t 	*hFromTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hFromTxn,0);

	hash_t *hToTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hToTxn,0);


DEBUGLOG(("Authorize()\n"));

// txn_ccy
	if (GetField_CString(hContext,"txn_ccy",&csTxnCcy)) {
		PutField_CString(hFromTxn,"from_ccy",csTxnCcy);
		PutField_CString(hFromTxn,"ccy",csTxnCcy);
		PutField_CString(hToTxn,"from_ccy",csTxnCcy);
		PutField_CString(hToTxn,"ccy",csTxnCcy);
DEBUGLOG(("Authorize: txn_ccy = [%s]\n",csTxnCcy));
	} else {
DEBUGLOG(("Authorize:: txn_ccy missing!!\n"));
ERRLOG("TxnMmsByUsBCN:: Authorize:: txn_ccy missing!!\n");
		iRet = INT_CURRENCY_CODE_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

// txn_amt
	if (GetField_Double(hContext,"txn_amt",&dTxnAmt)) {
		PutField_Double(hFromTxn,"txn_amt",dTxnAmt);
		PutField_Double(hToTxn,"txn_amt",dTxnAmt);
DEBUGLOG(("Authorize: txn_amt = [%f]\n",dTxnAmt));
	} else {
DEBUGLOG(("Authorize:: txn_amt missing!!\n"));
ERRLOG("TxnMmsByUsBCN:: Authorize:: txn_amt missing!!\n");
		iRet = INT_TXN_AMT_MISSING;
		PutField_Int(hContext,"internal_error",iRet);
	}

// create_user 
	if (GetField_CString(hRequest,"user",&csTmp)) {
		PutField_CString(hFromTxn,"user",csTmp);
		PutField_CString(hFromTxn,"add_user",csTmp);
		PutField_CString(hFromTxn,"update_user",csTmp);

		PutField_CString(hToTxn,"user",csTmp);
		PutField_CString(hToTxn,"add_user",csTmp);
		PutField_CString(hToTxn,"update_user",csTmp);

		PutField_CString(hContext,"update_user",csTmp);
DEBUGLOG(("Authorize: create_user = [%s]\n",csTmp));
	} else {
DEBUGLOG(("Authorize:: user missing!!\n"));
ERRLOG("TxnMmsByUsBCN:: Authorize:: user missing!!\n");
		iRet = INT_USER_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

// txn_data.eid (entity_id) 
	if (GetField_CString(hContext,"entity_id",&csTxnEntityId)) {
DEBUGLOG(("Authorize: txn_data.eid = [%s]\n",csTxnEntityId));
	} else {
DEBUGLOG(("Authorize:: txn_data.eid missing!!\n"));
ERRLOG("TxnMmsByUsBCN:: Authorize:: txn_data.eid missing!!\n");
		iRet = INT_MMS_ENTITY_ID_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

// txn_data.bal_cnt
        if (GetField_Int(hContext,"bal_cnt",&iTxnBalCnt)) {
DEBUGLOG(("Authorize: txn_data.bal_cnt = [%d]\n",iTxnBalCnt));
        } else {
DEBUGLOG(("Authorize:: txn_data.bal_cnt missing!!\n"));
ERRLOG("TxnMmsByUsBCN:: Authorize:: txn_data.bal_cnt missing!!\n");
                iRet = INT_MMS_BAL_CNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

// dst_data.eid (entity_id) 
	if (GetField_CString(hRequest,"dst_data.entity_id",&csDstEntityId)) {
DEBUGLOG(("Authorize: dst_data.eid = [%s]\n",csDstEntityId));
	} else {
DEBUGLOG(("Authorize:: dst_data.eid missing!!\n"));
ERRLOG("TxnMmsByUsBCN:: Authorize:: dst_data.eid missing!!\n");
		iRet = INT_MMS_ENTITY_ID_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
	}

// dst_data.bal_cnt 
        if (GetField_CString(hRequest,"dst_data.bal_cnt",&csTmp)) {
                iDstBalCnt = atoi(csTmp);
DEBUGLOG(("Authorize: dst_data.bal_cnt = [%d]\n",iDstBalCnt));
        } else {
DEBUGLOG(("Authorize:: dst_data.bal_cnt missing!!\n"));
ERRLOG("TxnMmsByUsBCN:: Authorize:: dst_data.bal_cnt missing!!\n");
                iRet = INT_MMS_BAL_CNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

	if (strcmp(csTxnEntityId,csDstEntityId) != 0) {
		iRet = INT_ERR;
		PutField_Int(hContext,"internal_error",iRet);
	}
	if (iTxnBalCnt != iDstBalCnt) {
		iRet = INT_ERR;
		PutField_Int(hContext,"internal_error",iRet);
	}

// get txn_data.nature_id
	if (iRet == PD_OK) {
                for (i=1; i<=iTxnBalCnt; i++) {
			sprintf(csTag,"bal.%d.nature_id",i);
                        if (GetField_CString(hContext,csTag,&csTxnNatureId)) {
DEBUGLOG(("Authorize: txn_data.nature_id = [%s]\n",csTxnNatureId));
			} else {
DEBUGLOG(("Authorize:: txn_data.nature_id missing!!\n"));
ERRLOG("TxnMmsByUsBCN:: Authorize:: txn_data.nature_id missing!!\n");
         		       	iRet = INT_MMS_NATURE_ID_NOT_FOUND;
                		PutField_Int(hContext,"internal_error",iRet);
        		}
		}
	}

// get dst_data.nature_id
	if (iRet == PD_OK) {
		hash_t  *hTmpData;
		hTmpData = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hTmpData,0);

		int j=0;

		PutField_Int(hTmpData,"bal_cnt",iDstBalCnt);

                for (i=1; i<=iDstBalCnt; i++) {
			sprintf(csTag,"dst_data.bal.%d.nat_cnt",i);
			if (GetField_CString(hRequest,csTag,&csTmp)) {
				iTmp = atoi(csTmp);

				sprintf(csTag,"bal.%d.nat_cnt",i);
				PutField_Int(hTmpData,csTag,iTmp);

				for (j=0; j<iTmp; j++) {
					sprintf(csTag,"dst_data.bal.%d.nat.%d.grp",i,j+1);
					if (GetField_CString(hRequest,csTag,&csPtr)) {
						sprintf(csTag,"bal.%d.nat.%d.grp",i,j+1);
DEBUGLOG(("GetSrcNatureId() [%s] = [%s]\n",csTag,csPtr));
						PutField_CString(hTmpData,csTag,csPtr);
					}

					sprintf(csTag,"dst_data.bal.%d.nat.%d.val",i,j+1);
					if (GetField_CString(hRequest,csTag,&csPtr)) {
						sprintf(csTag,"bal.%d.nat.%d.val",i,j+1);
DEBUGLOG(("GetSrcNatureId() [%s] = [%s]\n",csTag,csPtr));
						PutField_CString(hTmpData,csTag,csPtr);
					}
				}

/* this call will return an new nature id if not found */
				BOObjPtr = CreateObj(BOPtr,"BOMMSEntityNature","FindEntityNatureId");
				iRet =  (unsigned long)(*BOObjPtr)(hTmpData);
				if (iRet != PD_OK) {
DEBUGLOG(("GetSrcNatureId() return from BOMMSEntityNature iRet = [%d] \n",iRet));
					break;
				}
			}


			sprintf(csTag,"bal.%d.nature_id",i);
                        if (GetField_CString(hTmpData,csTag,&csDstNatureId)) {
DEBUGLOG(("Authorize: dst_data.nature_id = [%s]\n",csDstNatureId));
			} else {
DEBUGLOG(("Authorize:: dst_data.nature_id missing!!\n"));
ERRLOG("TxnMmsByUsBCN:: Authorize:: dst_data.nature_id missing!!\n");
         		       	iRet = INT_MMS_NATURE_ID_NOT_FOUND;
                		PutField_Int(hContext,"internal_error",iRet);
			}
		}

		hash_destroy(hTmpData);
		FREE_ME(hTmpData);
	}


//Debit txn_data natureID
	if (iRet == PD_OK) {
		PutField_CString(hFromTxn,"nature_id",csTxnNatureId);

DEBUGLOG(("Authorize:: Call BOMMSEntityBalance::DebitAcctBal\n"));
		BOObjPtr = CreateObj(BOPtr, "BOMMSEntityBalance","DebitAcctBal");
		iRet = (unsigned long)(*BOObjPtr)(hContext,hFromTxn);
DEBUGLOG(("Authroize:: iRet [%d] from Call BOMMSEntityBalance::DebitAcctBal\n",iRet))

	}



//Add new txn log
	char csNewTxnSeq[PD_TXN_SEQ_LEN +1];

	if (iRet == PD_OK) {
		PutField_Int(hToTxn,"do_logging",PD_ADD_LOG);

		//Get new txn_seq
DEBUGLOG(("Authorize() Call DBTxnSeq::GetNextMmmTxnSeq()\n"));
		DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextMmmTxnSeq");
		strcpy(csNewTxnSeq,(*DBObjPtr)());
		PutField_CString(hToTxn,"txn_seq",csNewTxnSeq);
DEBUGLOG(("Authorize() txn_seq = [%s]\n",csNewTxnSeq));

		//fill hToTxn
		if (GetField_CString(hContext,"txn_seq",&csTmp)) {
			PutField_CString(hToTxn,"related_txn_seq",csTmp);
		}
		if (GetField_CString(hContext,"channel_code",&csTmp)) {
			PutField_CString(hToTxn,"channel_code",csTmp);
		}
		if (GetField_CString(hContext,"txn_code",&csTmp)) {
			PutField_CString(hToTxn,"txn_code",csTmp);
		}
		if (GetField_CString(hContext,"PHDATE",&csTmp)) {
			PutField_CString(hToTxn,"PHDATE",csTmp);
		}
		if (GetField_CString(hContext,"local_tm_date",&csTmp)) {
			PutField_CString(hToTxn,"local_tm_date",csTmp);
		}
		if (GetField_CString(hContext,"local_tm_time",&csTmp)) {
			PutField_CString(hToTxn,"local_tm_time",csTmp);
		}
		if (GetField_CString(hContext,"process_type",&csTmp)) {
			PutField_CString(hToTxn,"process_type",csTmp);
		}
		if (GetField_CString(hContext,"process_code",&csTmp)) {
			PutField_CString(hToTxn,"process_code",csTmp);
		}
		if (GetField_CString(hContext,"req_node_id",&csTmp)) {
			PutField_CString(hToTxn,"req_node_id",csTmp);
		}
		if (GetField_CString(hRequest,"node_ref",&csTmp)) {
			PutField_CString(hToTxn,"node_ref",csTmp);
		}
		if (GetField_CString(hRequest,"transmission_datetime",&csTmp)) {
			PutField_CString(hToTxn,"transmission_datetime",csTmp);
		} else if (GetField_CString(hContext,"transmission_datetime",&csTmp )) {
			PutField_CString(hToTxn,"transmission_datetime",csTmp);
		}
		if (GetField_CString(hRequest,"tm_date",&csTmp)) {
			PutField_CString(hToTxn,"tm_date",csTmp);
		} else if (GetField_CString(hContext,"tm_date",&csTmp)) {
			PutField_CString(hToTxn,"tm_date",csTmp);
		}
		if (GetField_CString(hRequest,"tm_time",&csTmp)) {
			PutField_CString(hToTxn,"tm_time",csTmp);
		} else if (GetField_CString(hContext,"tm_time",&csTmp)) {
			PutField_CString(hToTxn,"tm_time",csTmp);
		}
		if (GetField_CString(hRequest,"txn_ccy",&csTmp)) {
			PutField_CString(hToTxn,"txn_ccy",csTmp);
		}
		if (GetField_CString(hRequest,"txn_country",&csTmp)) {
			PutField_CString(hToTxn,"txn_country",csTmp);
		}
		if (GetField_CString(hRequest,"ip_addr",&csTmp)) {
			PutField_CString(hToTxn,"ip_addr",csTmp);
		}
		if (GetField_CString(hRequest,"remark",&csTmp)) {
			PutField_CString(hToTxn,"remark",csTmp);
		}
		if (GetField_Char(hRequest,"action",&cTmp)) {
			PutField_Char(hToTxn,"action",cTmp);
		}
		if (GetField_CString(hContext,"entity_id",&csTmp)) {
			PutField_CString(hToTxn,"entity_id",csTmp);
		}
		if (GetField_Int(hContext,"bal_cnt",&iTmp)) {
			PutField_Int(hToTxn,"bal_cnt",iTmp);
		}
		for (i = 0 ; i < iTxnBalCnt; i++) {
			sprintf(csTag,"bal.%d.nature_id",i+1);
			PutField_CString(hToTxn,csTag,csDstNatureId);
			sprintf(csTag,"bal.%d.amt",i+1);
			PutField_Double(hToTxn,csTag,dTxnAmt);
		}
			

		//Call BOMMSTransaction::AddTxnLog
DEBUGLOG(("Authorize:: Call BOMMSTransaction::AddTxnLog\n"));
		BOObjPtr = CreateObj(BOPtr, "BOMMSTransaction","AddTxnLog");
		iRet = (unsigned long)(*BOObjPtr)(hToTxn,hToTxn);
DEBUGLOG(("Authroize:: iRet [%d] from Call BOMMSTransaction::AddTxnLog\n",iRet))
	}


	//Credit dst_data natureID
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize:: Call BOMMSEntityBalance::CreditAcctBal\n"));
		BOObjPtr = CreateObj(BOPtr, "BOMMSEntityBalance","CreditAcctBal");
		iRet = (unsigned long)(*BOObjPtr)(hToTxn,hToTxn);
DEBUGLOG(("Authroize:: iRet [%d] from Call BOMMSEntityBalance::CreditAcctBal\n",iRet))
	}


	//Call BOMMSTransaction::UpdateTxnLog
	if (iRet == PD_OK) {
		PutField_CString(hToTxn,"nature_id",csDstNatureId);

		PutField_CString(hToTxn,"txn_code","BCR");

		PutField_Char(hToTxn, "status", PD_COMPLETE);
		PutField_Char(hToTxn, "ar_ind", PD_ACCEPT);
		PutField_CString(hToTxn, "sub_status", PD_COMPLETED);

		if (GetField_Double(hContext,"txn_amt",&dTmp)) {
			PutField_Double(hToTxn,"txn_amt",dTmp);
		}
		if (GetField_Double(hContext,"remaining_amt",&dTmp)) {
			PutField_Double(hToTxn,"remaining_amt",dTmp);
		}
		if (GetField_Double(hContext,"net_amt",&dTmp)) {
			PutField_Double(hToTxn,"net_amt",dTmp);
		}
		if (GetField_CString(hContext,"net_ccy",&csTmp)) {
			PutField_CString(hToTxn,"net_ccy",csTmp);
		}
		if (GetField_CString(hContext,"related_txn_id",&csTmp)) {
			PutField_CString(hToTxn,"related_txn_id",csTmp);
		}
		if (GetField_Double(hContext,"cost_rate",&dTmp)) {
			PutField_Double(hToTxn,"cost_rate",dTmp);
		}
		if (GetField_Double(hContext,"cost_flat_rate",&dTmp)) {
			PutField_Double(hToTxn,"cost_flat_rate",dTmp);
		}
		if (GetField_Double(hContext,"cost_amt",&dTmp)) {
			PutField_Double(hToTxn,"cost_amt",dTmp);
		}
		sprintf(csTmp, "%d", PD_OK);
		PutField_CString(hToTxn,"response_code",csTmp);
		PutField_Int(hToTxn,"internal_error",PD_OK);

		//Call BOMMSTransaction::UpdateTxnLog
DEBUGLOG(("Authorize:: Call BOMMSTransaction::UpdateTxnLog\n"));
		BOObjPtr = CreateObj(BOPtr, "BOMMSTransaction","UpdateTxnLog");
		iRet = (unsigned long)(*BOObjPtr)(hToTxn,hToTxn);
DEBUGLOG(("Authroize:: iRet [%d] from Call BOMMSTransaction::UpdateTxnLog\n",iRet))
	}

	if (iRet == PD_OK) {
		PutField_CString(hContext,"txn_code",csTxnCodeOut);
		PutField_CString(hContext,"sub_status",PD_COMPLETED);
	}

	// Response
        PutField_Int(hResponse,"ret",iRet);
	if (GetField_CString(hContext,"txn_seq",&csTmp)) {
		PutField_CString(hResponse,"txn_seq",csTmp);
		PutField_CString(hResponse,"related_txn_seq",csNewTxnSeq);
	}

	hash_destroy(hFromTxn);
	FREE_ME(hFromTxn);

DEBUGLOG(("TxnMmsByUsBCN Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}

