/*
PDProTech (c)2018. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2018/11/22              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOiaByUsENB.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

static char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnOiaByUsENB(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{
	int	iRet = PD_OK;
	int     iDtlRet = PD_FOUND;
	int     iBAIDCnt = 0;
	char    *csBAID = NULL;
        char    *csBankNature = NULL;
	char    *csTmp = NULL;
	char    csTag[PD_TAG_LEN + 1];

	hash_t  *hNewBAIDDetails = NULL;
        recordset_t *rNewBAIDDetails;
        rNewBAIDDetails = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rNewBAIDDetails, 0);

DEBUGLOG(("TxnOiaByUsENB::Authorize\n"));

/* baid */
        if (GetField_CString(hRequest, "baid", &csBAID)) {
DEBUGLOG(("Get Details of baid [%s]\n", csBAID));
                PutField_CString(hResponse, "baid", csBAID);
        } else {
DEBUGLOG(("Authorize::baid not found!!\n"));
ERRLOG("TxnOiaByUsENB::Authorize::baid not found!!\n");
                iRet=INT_BANK_ACCT_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* bank_nature */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRequest,"bank_nature",&csBankNature)) {
DEBUGLOG(("Get Details of bank_nature [%s]\n",csBankNature));
                	PutField_CString(hResponse,"bank_nature",csBankNature);
        	} else {
DEBUGLOG(("Authorize::bank_nature not found!!\n"));
ERRLOG("TxnOiaByUsENB::Authorize::bank_nature not found!!\n");
                	iRet=INT_NATURE_NOT_FOUND;
                	PutField_Int(hContext,"internal_error",iRet);
        	}
	}

        // Get BAID Details
        if (iRet == PD_OK) {

		BOObjPtr = CreateObj(BOPtr,"BOOLBaid","GetNewBAIDDetails");
                iDtlRet = (unsigned long)(BOObjPtr)(csBAID,csBankNature,rNewBAIDDetails);
                if (iDtlRet == PD_FOUND) {
DEBUGLOG(("Authorize::BOOLBaid::GetNewBAIDDetails Found\n"));

                        hNewBAIDDetails = RecordSet_GetFirst(rNewBAIDDetails);
               	        while (hNewBAIDDetails) {

/* bank_nature */
                                sprintf(csTag, "r_list.%d.bank_nature", iBAIDCnt);
                                PutField_CString(hResponse,csTag,csBankNature);
DEBUGLOG((" [%d]Call BOOLBaid::GetNewBAIDDetails:: bank_nature = [%s]\n", iBAIDCnt, csBankNature));

/* baid */
                                if (GetField_CString(hNewBAIDDetails,"baid",&csTmp)) {
DEBUGLOG((" [%d]Call BOOLBaid::GetNewBAIDDetails:: baid = [%s]\n", iBAIDCnt, csTmp));
                                        sprintf(csTag, "r_list.%d.baid", iBAIDCnt);
                                        PutField_CString(hResponse,csTag,csTmp);
                                }

/* prov_name */
                                if (GetField_CString(hNewBAIDDetails,"provider_name",&csTmp)) {
DEBUGLOG((" [%d]Call BOOLBaid::GetNewBAIDDetails:: prov_name = [%s]\n", iBAIDCnt, csTmp));
                                        sprintf(csTag, "r_list.%d.prov_name", iBAIDCnt);
                                        PutField_CString(hResponse,csTag,csTmp);
                                }

/* baid_status */
                                if (GetField_CString(hNewBAIDDetails,"baid_status",&csTmp)) {
DEBUGLOG((" [%d]Call BOOLBaid::GetNewBAIDDetails:: baid_status = [%s]\n", iBAIDCnt, csTmp));
					sprintf(csTag, "r_list.%d.baid_status", iBAIDCnt);
                                        PutField_CString(hResponse,csTag,csTmp);
                                }

/* bank_nature */
                                if (GetField_CString(hNewBAIDDetails,"bank_nature",&csTmp)) {
DEBUGLOG((" [%d]Call BOOLBaid::GetNewBAIDDetails:: bank_nature = [%s]\n", iBAIDCnt, csTmp));
                                        sprintf(csTag, "r_list.%d.bank_nature", iBAIDCnt);
                                        PutField_CString(hResponse,csTag,csTmp);                                
				}

/* bank_name */
                                if (GetField_CString(hNewBAIDDetails,"bank_name",&csTmp)) {
DEBUGLOG((" [%d]Call BOOLBaid::GetNewBAIDDetails:: bank_name = [%s]\n", iBAIDCnt, csTmp));
                                        sprintf(csTag, "r_list.%d.bank_name", iBAIDCnt);
                                        PutField_CString(hResponse,csTag,csTmp);
                                }

/* owner_name */
                                if (GetField_CString(hNewBAIDDetails,"owner_name",&csTmp)) {
DEBUGLOG((" [%d]Call BOOLBaid::GetNewBAIDDetails:: owner_name = [%s]\n", iBAIDCnt, csTmp));
                                        sprintf(csTag, "r_list.%d.owner_name", iBAIDCnt);
                                        PutField_CString(hResponse,csTag,csTmp);
                                }

/* acct_num */
                                if (GetField_CString(hNewBAIDDetails,"bank_acct_num",&csTmp)) {
DEBUGLOG((" [%d]Call BOOLBaid::GetNewBAIDDetails:: acct_num = [%s]\n", iBAIDCnt, csTmp));
                                        sprintf(csTag, "r_list.%d.acct_num", iBAIDCnt);
                                        PutField_CString(hResponse,csTag,csTmp);
                                }

/* acct_status */
                                if (GetField_CString(hNewBAIDDetails,"bank_acct_status",&csTmp)) {
DEBUGLOG((" [%d]Call BOOLBaid::GetNewBAIDDetails:: acct_status = [%s]\n", iBAIDCnt, csTmp));
                                        sprintf(csTag, "r_list.%d.acct_status", iBAIDCnt);
                                        PutField_CString(hResponse,csTag,csTmp);
                                }

                                iBAIDCnt++;

                                hNewBAIDDetails = RecordSet_GetNext(rNewBAIDDetails);
			}
		} else if (iDtlRet == PD_NOT_FOUND) {
DEBUGLOG(("[%d]Authorize::Call BOOLBaid::GetNewBAIDDetails:: Record(s) not found!!\n", iBAIDCnt));
                    	iRet = INT_BANK_ACCT_ID_NOT_FOUND;
                    	PutField_Int(hContext,"internal_error",iRet);
           	} else {
DEBUGLOG(("[%d]Authorize::Call BOOLBaid::GetNewBAIDDetails Failure!!\n", iBAIDCnt));
ERRLOG("TxnOiaByUsENB::Authorize::Call BOOLBaid::GetNewBAIDDetails Failure!!\n");
                    	iRet = INT_ERR;
                     	PutField_Int(hContext,"internal_error",iRet);
            	}

/* r_list */
		if (iBAIDCnt > 0) {
			PutField_Int(hResponse,"r_list",iBAIDCnt);
		}
DEBUGLOG((" Number of BAID = [%d]\n", iBAIDCnt));
	}

	// Not Update TxnReqRef
        PutField_Int(hContext,"not_update_log",PD_TRUE);

	RecordSet_Destroy(rNewBAIDDetails);
        FREE_ME(rNewBAIDDetails);

DEBUGLOG(("TxnOiaByUsENB Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}

