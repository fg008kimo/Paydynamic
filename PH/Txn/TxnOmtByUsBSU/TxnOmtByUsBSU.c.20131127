/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/07/24              David Wong
Add error log					   2013/09/17		   Stan Poon
*/


#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsBSU.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);

void TxnOmtByUsBSU(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int iRet = PD_OK;
	char *csInFileName, *csInFilePath;
	char *csIntBankCode, *csAcctNum;
	char *csUser;
	char csFileName[PD_TMP_BUF_LEN];
	int iTmp;
	FILE *fin = NULL;

	recordset_t *rRecordFormat;
	rRecordFormat = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordFormat, 0);

	PutField_CString(hContext,"input_channel",PD_BANK_STATEMENT);

/* in_file_name */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "in_file_name", &csInFileName)) {
			PutField_CString(hContext,"in_file_name",csInFileName);
			PutField_CString(hContext,"filename",csInFileName);
DEBUGLOG(("Authorize() in_file_name = [%s]\n", csInFileName));
		} else {
			iRet = INT_FILE_NOT_FOUND;
DEBUGLOG(("Authorize() in_file_name is missing!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() in_file_name is missing!!!\n");
		}
	}
/* in_file_path */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "in_file_path", &csInFilePath)) {
			if (csInFilePath[strlen(csInFilePath)-1] == '/') csInFilePath[strlen(csInFilePath)-1] = '\0';
			PutField_CString(hContext,"in_file_path",csInFilePath);
DEBUGLOG(("Authorize() in_file_path = [%s]\n", csInFilePath));
		} else {
			iRet = INT_FILE_NOT_FOUND;
DEBUGLOG(("Authorize() in_file_path is missing!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() in_file_path is missing!!!\n");
		}
	}
/* file */
	if (iRet == PD_OK) {
		snprintf(csFileName,sizeof(csFileName),"%s/%s",csInFilePath,csInFileName);
		fin = fopen(csFileName, "r");
		if (fin == NULL) {
			iRet = INT_FILE_NOT_FOUND;
DEBUGLOG(("Authorize() cannot open file [%s]!!!\n", csInFileName));
ERRLOG("TxnOmtByUsBSU::Authorize() cannot open file [%s]!!!\n", csInFileName);
		} else {
			fclose(fin);
		}
	}
/* int_bank_code */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "int_bank_code", &csIntBankCode)) {
			PutField_CString(hContext,"int_bank_code",csIntBankCode);
DEBUGLOG(("Authorize() int_bank_code = [%s]\n", csIntBankCode));
		} else {
			iRet = INT_BANK_CODE_NOT_FOUND;
DEBUGLOG(("Authorize() int_bank_code is missing!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() int_bank_code is missing!!!\n");
		}
	}
/* bank_acct_num */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "bank_acct_num", &csAcctNum)) {
			PutField_CString(hContext,"bank_acct_num",csAcctNum);
DEBUGLOG(("Authorize() bank_acct_num = [%s]\n", csAcctNum));
		} else {
			iRet = INT_BANK_ID_NOT_FOUND;
DEBUGLOG(("Authorize() bank_acct_num is missing!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() bank_acct_num is missing!!!\n");
		}
	}
/* user */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "add_user", &csUser)) {
			PutField_CString(hContext,"create_user",csUser);
			PutField_CString(hContext,"update_user",csUser);
DEBUGLOG(("Authorize() user = [%s]\n", csUser));
		} else {
			iRet = INT_USER_NOT_FOUND;
DEBUGLOG(("Authorize() user is missing!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() user is missing!!!\n");
		}
	}

/* Add Statement Header*/
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLStatement:: CheckFileExist()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "CheckFileExist");
		if ((unsigned long)(*DBObjPtr)(csInFileName) == NOT_FOUND) {
DEBUGLOG(("Authorize() call DBOLStatement:: AddHeader()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "AddHeader");
			if ((unsigned long)(*DBObjPtr)(hContext) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement:: AddHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call DBOLStatement:: AddHeader() FAILURE!!!\n");
			}
		} else {
			iRet = INT_FILE_ALREADY_EXIST;
DEBUGLOG(("Authorize() call DBOLStatement::CheckFileExist() [%s] file DUPLICATED!!!\n", csInFileName));
		}
	}


/*
 * // Check Ava Bank Acct
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLMerchantBankAcct:: CheckAvaDepositBankAccts()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLMerchantBankAcct", "CheckAvaDepositBankAccts");
		if ((unsigned long)(*DBObjPtr)(hContext) != FOUND) {
			iRet = INT_BANK_ACCT_NOT_AVAILABLE;
			PutField_Int(hContext, "result_cnt", 1);
			PutField_CString(hContext, "msg_1", "Bank Acct Not Avaliable");
DEBUGLOG(("Authorize() call DBOLMerchantBankAcct::CheckAvaDepositBankAccts() FAILURE!!!\n"));
		}
*	}
*/

/* get acct ccy */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLBankAccts:: GetBankAccts()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLBankAccts", "GetBankAccts");
		if ((unsigned long)(*DBObjPtr)(csIntBankCode, csAcctNum, hContext) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLBankAccts::GetBankAccts() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call DBOLBankAccts::GetBankAccts() FAILURE!!!\n");
		}
	}

/* convert stmt file */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call BOOLBankStmt::ConvertStmtFile()\n"));
		BOObjPtr = CreateObj(BOPtr, "BOOLBankStmt", "ConvertStmtFile");
		iRet = (unsigned long)(*BOObjPtr)(hContext, csFileName);

		if (iRet == PD_OK) {
DEBUGLOG(("Authorize() out_file_name = [%s]\n", csFileName));
DEBUGLOG(("Authorize() call BOOLBankStmt::ConvertStmtFile() Success\n"));
		} else {
			iRet = INT_CONVERT_SCRIPT_ERROR;
			PutField_Int(hContext, "result_cnt", 1);
			PutField_CString(hContext, "msg_1", "File Type Not Supported");
DEBUGLOG(("Authorize() call BOOLBankStmt::ConvertStmtFile() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call BOOLBankStmt::ConvertStmtFile() FAILURE!!!\n");
		}
	}

/* get stmt file format */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLStmtFormat::GetFormat()\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLStmtFormat","GetFormat");
		iRet = (unsigned long)(*DBObjPtr)(csIntBankCode, rRecordFormat);

		if (iRet != PD_OK) {
			iRet = INT_FORMAT_TEMPLATE_ERROR;
			PutField_Int(hContext, "result_cnt", 1);
			PutField_CString(hContext, "msg_1", "File Format Not Avaliable");
DEBUGLOG(("Authorize() call DBOLStmtFormat::GetFormat() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call DBOLStmtFormat::GetFormat() FAILURE!!!\n");
		}
	}




/* process stmt file */

	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call BOOLBankStmt::ProcessStmtFile()\n"));
		BOObjPtr = CreateObj(BOPtr, "BOOLBankStmt", "ProcessStmtFile");
		iRet = (unsigned long)(*BOObjPtr)(hContext, csFileName, rRecordFormat);

		if (!GetField_Int(hContext,"total_count",&iTmp)) iTmp = 0;
		PutField_Int(hResponse,"total",iTmp);

		if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call BOOLBankStmt::ProcessStmtFile() Success\n"));
			if (!GetField_Int(hContext,"sms_count",&iTmp)) iTmp = 0;
			PutField_Int(hResponse,"sms",iTmp);
			if (!GetField_Int(hContext,"skip_count",&iTmp)) iTmp = 0;
			PutField_Int(hResponse,"skip",iTmp);
			if (!GetField_Int(hContext,"hold_count",&iTmp)) iTmp = 0;
			PutField_Int(hResponse,"hold",iTmp);
			if (!GetField_Int(hContext,"accept_count",&iTmp)) iTmp = 0;
			PutField_Int(hResponse,"accept",iTmp);

/* Update Statement Header */
DEBUGLOG(("Authorize() call DBOLStatement:: UpdateHeader()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "UpdateHeader");
			if ((unsigned long)(*DBObjPtr)(hContext) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement:: UpdateHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call DBOLStatement:: UpdateHeader() FAILURE!!!\n");
			}

		} else {
DEBUGLOG(("Authorize() call BOOLBankStmt::ProcessStmtFile() FAILURE!!!\n"));
DEBUGLOG(("Authorize() call TxnAbort()\n"));
			TxnAbort();
			RemoveField_Int(hContext,"sms_count");
			RemoveField_Int(hContext,"skip_count");
			RemoveField_Int(hContext,"hold_count");
			RemoveField_Int(hContext,"accept_count");

/* Add Statement Header */
DEBUGLOG(("Authorize() call DBOLStatement:: AddHeader()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBOLStatement", "AddHeader");
			if ((unsigned long)(*DBObjPtr)(hContext) != PD_OK) {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLStatement:: AddHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call DBOLStatement:: AddHeader() FAILURE!!!\n");
			}
		}
	}

/* add error log */
	if (iRet != PD_OK) {
DEBUGLOG(("Authorize() call DBOLUploadError::AddError()\n"));
		if (iRet != PD_ERR && iRet != INT_ERR && iRet != INT_FILE_ALREADY_EXIST) {
			BOObjPtr = CreateObj(BOPtr, "DBOLUploadError", "AddError");
			if ((unsigned long)(*BOObjPtr)(hContext) == PD_OK) {
DEBUGLOG(("Authorize() call DBOLUploadError::AddError() Success\n"));
			} else {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLUploadError::AddError() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call DBOLUploadError::AddError() FAILURE!!!\n");
			}
		}

		if (iRet == PD_ERR || iRet == INT_ERR) {
ERRLOG("TxnOmtByUsBSU::Authorize() Internal Error!!!\n");
DEBUGLOG(("Authorize() call TxnAbort()\n"));
			TxnAbort();
			RemoveField_CString(hContext, "desc_1");
			RemoveField_CString(hContext, "line_1");
			RemoveField_Int(hContext, "line_1");

			PutField_Int(hContext, "result_cnt", 1);
			PutField_CString(hContext, "msg_1", "Internal Error");
			BOObjPtr = CreateObj(BOPtr, "DBOLUploadError", "AddError");
			if ((unsigned long)(*BOObjPtr)(hContext) == PD_OK) {
DEBUGLOG(("Authorize() call DBOLUploadError::Addrror() Internal Error Called\n"));
			} else {
DEBUGLOG(("Authorize() call DBOLUploadError::AddError() Internal Error FAILURE!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call DBOLUploadError::AddError() Internal Error FAILURE!!!\n");
			}
		}
		PutField_Int(hContext, "internal_error", iRet);
	}


	RecordSet_Destroy(rRecordFormat);
	FREE_ME(rRecordFormat);

DEBUGLOG(("Authorize() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;
}

