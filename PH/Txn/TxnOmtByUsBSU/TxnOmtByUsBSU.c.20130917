/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/07/24              David Wong
*/


#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsBSU.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);

void TxnOmtByUsBSU(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int iRet = PD_OK;
	char *csIntBankCode;
	char *csInFileName;
	char csOutFileName[PD_MAX_BUFFER];
	char *csAcctNum;
	char *csUser;

	recordset_t *rRecordFormat;
	rRecordFormat = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordFormat, 0);

/* int_bank_code */
	if (GetField_CString(hRequest, "int_bank_code", &csIntBankCode)) {
DEBUGLOG(("Authorize() int_bank_code = [%s]\n", csIntBankCode));
	} else {
		iRet = INT_OL_BANK_CODE_NOT_FOUND;
		PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() int_bank_code is missing!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() int_bank_code is missing!!!\n");
	}

/* in_file_name */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "in_file_name", &csInFileName)) {
DEBUGLOG(("Authorize() in_file_name = [%s]\n", csInFileName));
		} else {
			iRet = INT_OL_FILE_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() in_file_name is missing!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() in_file_name is missing!!!\n");
		}
	}

/* bank_acct_num */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "bank_acct_num", &csAcctNum)) {
DEBUGLOG(("Authorize() bank_acct_num = [%s]\n", csAcctNum));
		} else {
			iRet = INT_OL_BANK_ACCT_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() bank_acct_num is missing!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() bank_acct_num is missing!!!\n");
		}
	}

/* user */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "add_user", &csUser)) {
DEBUGLOG(("Authorize() user = [%s]\n", csUser));
		} else {
			iRet = INT_OL_USER_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() user is missing!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() user is missing!!!\n");
		}
	}

/* convert stmt file */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call BOOLBankStmt::ConvertStmtFile()\n"));
		BOObjPtr = CreateObj(BOPtr, "BOOLBankStmt", "ConvertStmtFile");
		iRet = (unsigned long)(*BOObjPtr)(csIntBankCode, csInFileName, csOutFileName);

		if (iRet == PD_OK) {
DEBUGLOG(("Authorize() out_file_name = [%s]\n", csOutFileName));
DEBUGLOG(("Authorize() call BOOLBankStmt::ConvertStmtFile() success!!!\n"));
		} else {
			iRet = INT_OL_CONVERT_SCRIPT_ERROR;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call BOOLBankStmt::ConvertStmtFile() failed!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call BOOLBankStmt::ConvertStmtFile() failed!!!\n");
		}
	}

/* get stmt file format */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLStmtFormat::GetFormat()\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLStmtFormat","GetFormat");
		iRet = (unsigned long)(*DBObjPtr)(csIntBankCode, rRecordFormat);

		if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLStmtFormat::GetFormat() success!!!\n"));
		} else {
			iRet = INT_OL_FORMAT_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call DBOLStmtFormat::GetFormat() failed!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call DBOLStmtFormat::GetFormat() failed!!!\n");
		}
	}

/* process stmt file */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call BOOLBankStmt::ProcessStmtFile()\n"));
		BOObjPtr = CreateObj(BOPtr, "BOOLBankStmt", "ProcessStmtFile");
		iRet = (unsigned long)(*BOObjPtr)(csInFileName, csOutFileName, csIntBankCode, csAcctNum, csUser, rRecordFormat, hResponse);

		if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call BOOLBankStmt::ProcessStmtFile() success!!!\n"));
		} else {
			//iRet = PD_ERR;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call BOOLBankStmt::ProcessStmtFile() failed!!!\n"));
ERRLOG("TxnOmtByUsBSU::Authorize() call BOOLBankStmt::ProcessStmtFile() failed!!!\n");
		}
	}

	RecordSet_Destroy(rRecordFormat);
	FREE_ME(rRecordFormat);

DEBUGLOG(("Authorize() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;
}
