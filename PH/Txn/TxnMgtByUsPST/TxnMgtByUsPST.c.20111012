/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/10/10              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsPST.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnMgtByUsPST(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;

        char        *csPspId = NULL;
        char        *csTxnCountry = NULL;
        char        *csTxnCcy = NULL;
        char        *csUpdateUser = NULL;  
        char        *csTmp = NULL;
        double       dAmt=0;

        double       dBalance =0;
        //char        *csClientId;


        hash_t      *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

        if(GetField_CString(hContext,"txn_seq",&csTmp)){
DEBUGLOG(("Authorize::txn_seq= [%s]\n",csTmp));
        }
        else{
DEBUGLOG(("Authorize::txnid not found!!\n"));
ERRLOG("TxnMgtByUsPST::Authorize::txnid not found!!\n");
                iRet=INT_INVALID_TXN;
        }

        if(GetField_CString(hRequest,"add_user",&csUpdateUser)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csUpdateUser));
                PutField_CString(hContext,"add_user",csUpdateUser);
                PutField_CString(hContext,"update_user",csUpdateUser);
        }

        if(GetField_CString(hRequest,"psp_id",&csPspId)){
DEBUGLOG(("Authorize::psp_id = [%s]\n",csPspId));
                PutField_CString(hContext,"psp_id",csPspId);
        }
        else{
DEBUGLOG(("Authorize::psp_id not found!!\n"));
ERRLOG("TxnMgtByUsPST::Authorize::psp_id not found!!\n");
                iRet=INT_PSP_ID_NOT_FOUND;
        }

        if(GetField_CString(hRequest,"txn_country",&csTxnCountry)){
DEBUGLOG(("Authorize::txn_country= [%s]\n",csTxnCountry));
                PutField_CString(hContext,"txn_country",csTxnCountry);
        }
        else{
DEBUGLOG(("Authorize::country not found!!\n"));
ERRLOG("TxnMgtByUsPST::Authorize::country not found!!\n");
                iRet=INT_TXN_COUNTRY_NOT_FOUND;
        }

        if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTxnCcy));
                PutField_CString(hContext,"txn_ccy",csTxnCcy);
        }
        else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMgtByUsPST::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
        }


        if(GetField_Double(hContext,"txn_amt",&dAmt)){
                PutField_Double(hContext,"txn_amt",dAmt);
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dAmt));
        }
        else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMgtByUsPST::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
        }

/*
        PutField_CString(hContext,"process_code","000000");
        PutField_CString(hContext,"process_type","0000");
*/

        //Get ClientId and check status
/*
        if(iRet==PD_OK){

DEBUGLOG(("Authorize::Call DBPspDetail:GetPspDetail\n"));
                DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
                if ((*DBObjPtr)(csPspId, hTxn) == PD_OK) {

                        if (GetField_CString(hTxn,"client_id",&csClientId)) {
DEBUGLOG(("GetPspDetail::client_id = [%s]\n",csClientId));
                        }
                        if (GetField_CString(hTxn,"status",&csTmp)) {
DEBUGLOG(("GetPspDetail::status =[%s]\n", csTmp));
                                if(strcmp(csTmp,PD_ACC_OPEN)){
DEBUGLOG(("GetPspDetail::psp account [%s] not opened\n",csPspId));
                                        iRet = INT_ACCOUNT_DISABLED;
                                }
                        }
                }
                else{
ERRLOG("TxnMgtByUsPST::Authorize::GetPspDetail::psp account [%s] not found\n",csPspId);
DEBUGLOG(("GetPspDetail::psp account [%s] not found\n",csPspId));
                        iRet = INT_ERR;
                }
        }
*/

        // check client status
/*
        if(iRet==PD_OK){
                hash_init(hTxn,0);

DEBUGLOG(("Authorize::Call DBClients:GetClients\n"));
                DBObjPtr = CreateObj(DBPtr,"DBClients","GetClients");
                if ((*DBObjPtr)(csClientId,hTxn) == PD_OK){
                        if (GetField_CString(hTxn,"status",&csTmp)) {
DEBUGLOG(("GetClients::status = [%s]\n",csTmp));
                                        if(strcmp(csTmp,PD_ACC_OPEN)){
ERRLOG("TxnMgtByUsPST::Authorize::GetClients::Client Account [%s] not opened\n",csClientId);
                                                iRet = INT_ACCOUNT_DISABLED;
                                        }
                        }
                } 
                else { 
ERRLOG("TxnMgtByUsPST::Authorize::GetClients::Client ID for Account[%s] not found\n",csPspId);
DEBUGLOG(("GetClients::Cient ID Account[%s] not found\n",csPspId));
                        iRet = INT_ERR;
                }
        }
*/

        //get Psp balance
        if(iRet==PD_OK){
                hash_init(hTxn,0);
DEBUGLOG(("Authorize::Call DBPspBalance:GetBalance\n"));
                DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalance");
                if ((*DBObjPtr)(csPspId, csTxnCountry, csTxnCcy, hTxn) == PD_OK) {

                        if (GetField_Double(hTxn, "balance", &dBalance)) {
DEBUGLOG(("GetBalance::balance = [%f]\n",dBalance));

                                if ((dBalance < 0) || (dBalance < dAmt)) {
DEBUGLOG(("GetBalance::insufficient balance [%f] txn_amt [%f]\n",dBalance, dAmt));
                                        iRet=INT_INSUFFICIENT_FUND;
                                }
                                else {
                                        PutField_Double(hContext, "current_bal", dBalance);
                                }
                        }
                }
                else {
ERRLOG("TxnMgtByUsPST::Authorize::GetBalance::Balance for PspId[%s] not found\n",csPspId);
DEBUGLOG(("GetBalance::Balance for PspId[%s] not found\n", csPspId));
                        iRet = INT_ERR;
                }
        }
        FREE_ME(hTxn);


 
       //Update Psp Balance
        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBPspBalance:DebitBalance\n"));
                DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
                if ((*DBObjPtr)(csPspId,csTxnCountry, csTxnCcy, PD_PSP_BAL, dAmt, csUpdateUser) != PD_OK) {
DEBUGLOG(("Authorize::DBPspBalance:DebitBalance Failed\n"));
                        iRet = INT_ERR;
                } 
        } 


/*
        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:AddDetail\n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK)
                        iRet = INT_ERR;
        }
   

        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:UpdateDetail\n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK)
                        iRet = INT_ERR;
        }

*/

        if(iRet!=PD_OK){
                PutField_Int(hContext,"internal_error",iRet);
        }


DEBUGLOG(("TxnMgtByUsPST Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}
