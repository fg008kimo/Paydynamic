/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/10/10              Virginia Yun
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsPST.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);

void TxnMgtByUsPST(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;

        char        *csPspId = NULL;
        char        *csTxnCountry = NULL;
        char        *csTxnCcy = NULL;
        char        *csUpdateUser = NULL;  
        char        *csTmp = NULL;
	char        *csDate = NULL;
        double       dAmt=0.0;

        double       dBalance =0.0;
        double       dHold=0.0;
        //char        *csClientId;
        double       dTmp = 0.0;
        double       dTmpBal = 0.0;



        hash_t      *hRec,*hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);


        if(GetField_CString(hContext,"txn_seq",&csTmp)){
                PutField_CString(hResponse,"org_txn_seq",csTmp);
DEBUGLOG(("Authorize::txn_seq= [%s]\n",csTmp));
        }
        else{
DEBUGLOG(("Authorize::txnid not found!!\n"));
ERRLOG("TxnMgtByUsPST::Authorize::txnid not found!!\n");
                iRet=INT_INVALID_TXN;
        }

        if(GetField_CString(hRequest,"add_user",&csUpdateUser)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csUpdateUser));
                PutField_CString(hContext,"add_user",csUpdateUser);
                PutField_CString(hContext,"update_user",csUpdateUser);
        }

        if(GetField_CString(hRequest,"psp_id",&csPspId)){
DEBUGLOG(("Authorize::psp_id = [%s]\n",csPspId));
                PutField_CString(hContext,"psp_id",csPspId);
        }
        else{
DEBUGLOG(("Authorize::psp_id not found!!\n"));
ERRLOG("TxnMgtByUsPST::Authorize::psp_id not found!!\n");
                iRet=INT_PSP_ID_NOT_FOUND;
        }

	if(GetField_CString(hRequest,"txn_country",&csTxnCountry)){
                PutField_CString(hContext,"txn_country",csTxnCountry);
DEBUGLOG(("Authorize::txn_country= [%s]\n",csTxnCountry));
        }
        else{
                DBObjPtr = CreateObj(DBPtr,"DBPspCountry","GetPspCountry");
                if((unsigned long) ((*DBObjPtr)(csPspId,rRecordSet))==PD_OK){
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while(hRec){
                                if (GetField_CString(hRec,"country",&csTxnCountry)) {
                                        PutField_CString(hContext,"txn_country",csTxnCountry);
DEBUGLOG(("Authorize::txn_country= [%s]\n",csTxnCountry));
                                }
                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                }
                else{
DEBUGLOG(("Authorize::txn_country not found!!\n"));
ERRLOG("TxnMgtByUsPST::Authorize::txn_country not found!!\n");
                        iRet=INT_ERR;
                }
                RecordSet_Destroy(rRecordSet);
        }

        if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
DEBUGLOG(("Authorize::txn_ccy= [%s]\n",csTxnCcy));
                PutField_CString(hContext,"txn_ccy",csTxnCcy);
        }
        else{
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMgtByUsPST::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
        }


        if(GetField_Double(hContext,"txn_amt",&dAmt)){
                PutField_Double(hContext,"txn_amt",dAmt);
DEBUGLOG(("Authorize::txn_amt= [%f]\n",dAmt));
        }
        else{
DEBUGLOG(("Authorize::txn_amt not found!!\n"));
ERRLOG("TxnMgtByUsPST::Authorize::txn_amt not found!!\n");
                iRet=INT_PAY_AMOUNT_NOT_FOUND;
        }

/* approval_date */
        if(!GetField_CString(hRequest,"approval_date",&csDate)){
                if(!GetField_CString(hContext,"PHDATE",&csDate)){
DEBUGLOG(("Authorize::approval_date not found!!\n"));
ERRLOG("TxnMgtByUsMAD::Authorize::approval_date not found!!\n");
                        iRet=INT_INVALID_TXN;
                }
                else {
                        PutField_CString(hContext, "approval_date", csDate);
DEBUGLOG(("Authorize::approval_date(phdate) = [%s]\n", csDate));
                }
        }
        else {
DEBUGLOG(("Authorize::approval_date = [%s]\n", csDate));
                PutField_CString(hContext, "approval_date", csDate);
        }

               



        PutField_CString(hContext,"process_code","000000");
        PutField_CString(hContext,"process_type","0000");

        //get Psp balance
        if(iRet==PD_OK){
        	hTxn = (hash_t*) malloc (sizeof(hash_t));
                hash_init(hTxn,0);
DEBUGLOG(("Authorize::Call DBPspBalance:GetBalance\n"));
                DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalance");
                if ((*DBObjPtr)(csPspId, csTxnCountry, csTxnCcy, hTxn) == PD_OK) {

                        if (GetField_Double(hTxn, "balance", &dBalance)) {
DEBUGLOG(("GetBalance::balance = [%f]\n",dBalance));

                        	if (GetField_Double(hTxn, "total_hold", &dHold)) {
DEBUGLOG(("GetBalance::total_hold = [%f]\n",dHold));
				}
	
                                if (((dBalance-dHold) < 0) || ((dBalance-dHold) < dAmt)) {
DEBUGLOG(("GetBalance::insufficient balance [%f] txn_amt [%f]\n",dBalance-dHold, dAmt));
                                        iRet=INT_INSUFFICIENT_FUND;
                                }
                                else {
                                        //PutField_Double(hContext, "current_bal", dBalance);
                                }
                        }
                }
                else {
ERRLOG("TxnMgtByUsPST::Authorize::GetBalance::Balance for PspId[%s] not found\n",csPspId);
DEBUGLOG(("GetBalance::Balance for PspId[%s] not found\n", csPspId));
                        iRet = INT_ERR;
                }
        }



	// select for update, hold record
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBPspBalance:GetAvalPspBalance\n"));
		DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetAvalPspBalance");
                if ((*DBObjPtr)(csPspId,csTxnCcy, csTxnCountry, &dTmpBal) != PD_OK) {
DEBUGLOG(("Authorize::DBPspBalance:GetAvalPspBalance Failed\n"));
                        iRet = INT_ERR;
                }
	}

 
       //Update Psp Balance
        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBPspBalance:DebitBalance\n"));
                DBObjPtr = CreateObj(DBPtr,"DBPspBalance","DebitBalance");
                if ((*DBObjPtr)(csPspId,csTxnCountry, csTxnCcy, PD_PSP_BAL, dAmt, csUpdateUser) != PD_OK) {
DEBUGLOG(("Authorize::DBPspBalance:DebitBalance Failed\n"));
                        iRet = INT_ERR;
                } 
        } 

/*
        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:AddDetail\n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK)
                        iRet = INT_ERR;
        }

        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:UpdateDetail\n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK)
                        iRet = INT_ERR;
        }
*/


        // for handling TXNPSPDETAIL
        if(iRet==PD_OK){
                if (GetField_CString(hContext, "PHDATE", &csTmp)) {
DEBUGLOG(("Authorize::PHDATE = [%s]\n",csTmp));
                    PutField_CString(hContext, "txn_date", csTmp);
                }

DEBUGLOG(("Authorize::Call DBTxnPspDetail:Add\n"));
		PutField_CString(hContext, "desc", "Psp Settlement");

                DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Add");
                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK) {
                        iRet = INT_ERR;
                } 
        }

         
        if(iRet==PD_OK){
                // Get Balance again
                hTxn = (hash_t*) malloc (sizeof(hash_t));
                hash_init(hTxn,0);
DEBUGLOG(("Authorize::Call DBPspBalance:GetBalance(2)\n"));
                DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalance");
                if ((*DBObjPtr)(csPspId, csTxnCountry, csTxnCcy, hTxn) == PD_OK) {

                        if (GetField_Double(hTxn, "balance", &dTmp)) {
DEBUGLOG(("GetBalance(2)::balance = [%f]\n",dTmp));
                                PutField_Double(hContext, "bal", dTmp);
                        }

                        if (GetField_Double(hTxn, "total_float", &dTmp)) {
DEBUGLOG(("GetBalance(2)::total_float = [%f]\n",dTmp));
                                PutField_Double(hContext, "total_float", dTmp);
                        }

                        if (GetField_Double(hTxn, "total_hold", &dTmp)) {
DEBUGLOG(("GetBalance(2)::total_hold = [%f]\n",dTmp));
                                PutField_Double(hContext, "total_hold", dTmp);
                        }


DEBUGLOG(("Authorize::Call DBTxnPspDetail:Update\n"));
                        DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
                        if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK) {
                                iRet = INT_ERR;
                        } 
                }
                else {
ERRLOG("TxnMgtByUsPST::Authorize::GetBalance(2)::Balance for PspId[%s] not found\n",csPspId);
DEBUGLOG(("GetBalance(2)::Balance for PspId[%s] not found\n", csPspId));
                        iRet = INT_ERR;
                }

        }

	hash_destroy(hTxn);
	FREE_ME(hTxn);

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

        if(iRet!=PD_OK){
                PutField_Int(hContext,"internal_error",iRet);
        }

DEBUGLOG(("TxnMgtByUsPST Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}
