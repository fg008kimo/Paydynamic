/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/02/12              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsTMI.h"
#include "myrecordset.h"
#include "dbutility.h"

char cDebug;
OBJPTR(BO);
OBJPTR(DB);
OBJPTR(Txn);
OBJPTR(Msg);

void TxnMgtByUsTMI(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	char	csTxnSeq[PD_TXN_SEQ_LEN +1];
	char    csOrgDateTime[PD_DATETIME_LEN +1];
	char*	csEncTxnSeq;
	char	*csPayMethod;
	char	*csTxnCcy;
	char	*csOrgTxnCountry;
	char	*csOrgChannelCode;
	char	*csOrgServiceCode;
	char	*csOrgMerchantId;
	char	*csSelectedPID = NULL;
	char*	csPtr;
	char*   csIpAddr;
        char*   csUserAgent;
	double	dTmp;
	double	dTxnAmt;
	char* csTxnCode;
	char* csClientId;
	char* csDstCcy;
	char* csCustTag;
	char  csCustomerGroup[PD_CUSTOMER_GROUP_CODE_LEN +1];
	int   iCustGroupFound = PD_FALSE;
	int   iCustSegEnable = PD_FALSE;
	//int   iPhase = 0;

	recordset_t     *rRecordSet;   
	hash_t	*hRec,*hPsp, *hTxn/*, *hCon, *hElem*/;

	hTxn = (hash_t*) malloc(sizeof(hash_t));
	hash_init(hTxn, 0);

	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
DEBUGLOG(("Authorize()\n"));
	memset(csTxnSeq,0,PD_TXN_SEQ_LEN);

	if (GetField_CString(hRequest,"enc_txn_seq",&csEncTxnSeq)) {
DEBUGLOG(("Authorize() enc_txn_seq = [%s]\n",csEncTxnSeq));
		BOObjPtr = CreateObj(BOPtr,"BOSecurity","Decrypt3DESTxnSeq");
                (BOObjPtr)(csEncTxnSeq,csTxnSeq);
DEBUGLOG(("Authorize() txn_seq = [%s]\n",csTxnSeq));
		PutField_CString(hResponse,"org_txn_seq",csTxnSeq);
		PutField_CString(hContext,"org_txn_seq",csTxnSeq);
		PutField_CString(hTxn,"from_txn_seq",csTxnSeq);
	}
	else {
		iRet = INT_ENC_TXN_ID_MISSING;
DEBUGLOG(("Authorize() enc_txn_seq is missing\n"));
ERRLOG("TxnMgtByUsTMI::Authorize() enc_txn_seq is missing\n");
		PutField_Int(hContext,"internal_error",iRet);
	}

	if (iRet == PD_OK){
		if (GetField_CString(hRequest,"ip_addr",&csIpAddr)) {
DEBUGLOG(("Authorize() ip_addr = [%s]\n",csIpAddr));
		}
		if (GetField_CString(hRequest,"user_agent",&csUserAgent)) {
DEBUGLOG(("Authorize() user_agent = [%s]\n",csUserAgent));
		}
	}

	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","MatchRespTxn_ReadOnly");
                if ((unsigned long)(DBObjPtr)(csTxnSeq,PD_INIT) != PD_FOUND) {
	        	iRet = INT_TXN_ID_NOT_FOUND;    
DEBUGLOG(("Authorize() org txn id record [%s] not found for status = [%c]\n",csTxnSeq,PD_INIT));
//ERRLOG("Authorize() org txn id record [%s] not found for status = [%c]\n",csTxnSeq,PD_INIT);
			PutField_Int(hContext,"internal_error",iRet);
		}
	}



	if (iRet == PD_OK) {
                recordset_init(rRecordSet,0);
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
                if ((DBObjPtr)(csTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("Authorize::txn Header found record = [%s]\n",csTxnSeq));
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
                                 if (GetField_CString(hRec,"txn_code",&csTxnCode)) {
                                        PutField_CString(hTxn,"txn_code",csTxnCode);
				 }
                                 if (GetField_Double(hRec,"txn_amt",&dTxnAmt)) {
DEBUGLOG(("Authorize::GetTxnHeader - txn_amt = [%lf]\n",dTxnAmt));
                                        PutField_Double(hResponse,"txn_amt",dTxnAmt);
					PutField_Double(hTxn,"org_txn_amt",dTxnAmt);
					PutField_Double(hTxn,"txn_amt",dTxnAmt);
                                 }
                                 if (GetField_CString(hRec,"net_ccy",&csTxnCcy)) {
                                        PutField_CString(hResponse,"txn_ccy",csTxnCcy);
                                        PutField_CString(hTxn,"txn_ccy",csTxnCcy);
                                        PutField_CString(hTxn,"org_txn_ccy",csTxnCcy);
DEBUGLOG(("Authorize::GetTxnHeader - net_ccy = [%s]\n",csTxnCcy));
				 }
				 if (GetField_CString(hRec,"client_id",&csClientId)) {
DEBUGLOG(("Authorize::GetTxnHeader - org_client_id = [%s]\n",csClientId));
                                        PutField_CString(hTxn,"merchant_client_id",csClientId);
                                 }
                                 if (GetField_CString(hRec,"merchant_id",&csOrgMerchantId)) {
                                        PutField_CString(hResponse,"merchant_id",csOrgMerchantId);
                                        PutField_CString(hTxn,"merchant_id",csOrgMerchantId);
DEBUGLOG(("Authorize::GetTxnHeader - merchant_id = [%s]\n",csOrgMerchantId));

					DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupMerchant","FindMerchant");
					if((unsigned long)(DBObjPtr)(csOrgMerchantId) == FOUND){
						iCustSegEnable = PD_TRUE;
					}

                                 }
                                 if (GetField_CString(hRec,"merchant_ref",&csPtr)) {
                                        PutField_CString(hResponse,"merchant_ref",csPtr);
				 }
                                 if (GetField_CString(hRec,"channel_code",&csOrgChannelCode)) {
                                        PutField_CString(hTxn,"channel_code",csOrgChannelCode);
DEBUGLOG(("Authorize::GetTxnHeader - channel_code = [%s]\n",csOrgChannelCode));
                                 }
                                 if (GetField_CString(hRec,"service_code",&csOrgServiceCode)) {
                                        PutField_CString(hTxn,"service_code",csOrgServiceCode);
DEBUGLOG(("Authorize::GetTxnHeader - service code = [%s]\n",csOrgServiceCode));
                                 }
				 if (GetField_CString(hRec,"local_tm_date",&csPtr)) {
DEBUGLOG(("Authorize::GetTxnHeader - local_tm_date = [%s]\n",csPtr));
                                        strcpy(csOrgDateTime,csPtr);
                                 }
                                 if (GetField_CString(hRec,"local_tm_time",&csPtr)) {
DEBUGLOG(("Authorize::GetTxnHeader - local_tm_time = [%s]\n",csPtr));
                                        memcpy(&csOrgDateTime[PD_DATE_LEN],csPtr,PD_TIME_LEN);
                                        csOrgDateTime[PD_DATETIME_LEN] = '\0';
DEBUGLOG(("Authorize::GetTxnHeader - org_local_tm_datetime = [%s]\n",csOrgDateTime));
                                        PutField_CString(hContext,"org_local_tm_datetime",csOrgDateTime);
                                 }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                 }
        	RecordSet_Destroy(rRecordSet);
        }
	if (iRet == PD_OK) {
		recordset_init(rRecordSet,0);
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
                if ((DBObjPtr)(csTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("Authorize::txn detail found record = [%s]\n",csTxnSeq));
                        hRec = RecordSet_GetFirst(rRecordSet);
			int iTxn =0;
                        while (hRec) {
                                 if (GetField_CString(hRec,"pay_method",&csPayMethod)) {
					iTxn++;
DEBUGLOG(("Authorize::GetTxnDetail - org_pay_method = [%s]\n",csPayMethod));
                                        PutField_CString(hResponse,"pay_method",csPayMethod);
                                 }
                                 if (GetField_CString(hRec,"selected_pay_method",&csPayMethod)) {
					 PutField_CString(hTxn,"selected_pay_method",csPayMethod);
DEBUGLOG(("Authorize::GetTxnDetail - selected_method = [%s]\n",csPayMethod));
                                 }

                                 if (GetField_CString(hRec,"txn_country",&csOrgTxnCountry)) {
					PutField_CString(hTxn,"txn_country",csOrgTxnCountry);
DEBUGLOG(("Authorize::GetTxnDetail - txn country = [%s]\n",csOrgTxnCountry));
                                 }

				 if (GetField_CString(hRec,"selected_pid",&csSelectedPID)) {
DEBUGLOG(("Authorize::GetTxnDetail - selected_pid = [%s]\n",csSelectedPID));
                                 }
				 if (GetField_CString(hRec,"customer_tag",&csCustTag)) {
DEBUGLOG(("Authorize::GetTxnDetail - customer_tag = [%s]\n",csCustTag));
					DBObjPtr = CreateObj(DBPtr,"DBCustomerGroupDetail","FindGroup");
					if ((unsigned long)(DBObjPtr)(csOrgMerchantId,csCustTag,&csCustomerGroup) == FOUND) {
DEBUGLOG(("Authorize::GetTxnDetail - customer_group = [%s]\n",csCustomerGroup));
						iCustGroupFound = PD_TRUE;
						PutField_CString(hResponse,"customer_group",csCustomerGroup);
						PutField_CString(hResponse,"customer_tag",csCustTag);
					}
                                 }


                                hRec = RecordSet_GetNext(rRecordSet);
                        }
			if (iTxn == 1) {
                        	PutField_Int(hResponse,"single_pay_method",iTxn);
			}
DEBUGLOG(("Authorize: itxn = [%d]\n",iTxn));
                 }
        	RecordSet_Destroy(rRecordSet);
	}

	if (iRet == PD_OK) {
		if (csSelectedPID != NULL) {
/* filter by selected pid */
DEBUGLOG(("Authorize() Filter by selected PID\n"));
			int	iPspBankChannelCodeFound = PD_FALSE;
			char*	csPspBankChannelCode;
			hPsp = (hash_t*) malloc(sizeof(hash_t));
                	hash_init(hPsp, 0);

			DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
                	if ((unsigned long)(DBObjPtr)(csSelectedPID,hPsp) == PD_OK) {
			}
			if (hPsp) {
				if (GetField_CString(hPsp,"overrided_bank_code_channel",&csPspBankChannelCode)) {
DEBUGLOG(("Authorize () overrided psp bank channel code = [%s]\n",csPspBankChannelCode));
					iPspBankChannelCodeFound = PD_TRUE;
				}
				else if (GetField_CString(hPsp,"psp_channel_code",&csPspBankChannelCode)) {
DEBUGLOG(("Authorize () psp bank channel code = [%s]\n",csPspBankChannelCode));
					iPspBankChannelCodeFound = PD_TRUE;
				}
				if (iPspBankChannelCodeFound == PD_TRUE) {
					//get from mob_bank_select by csPspBankChannelCode 
					//if present return the PSP bank code (only TPM for phase 1)
					//else, return WAP bank code
					//------
					BOObjPtr = CreateObj(BOPtr,"BOBank","GetMobileBankByPsp");
                			(BOObjPtr)(csPspBankChannelCode,csOrgServiceCode,csOrgTxnCountry,hResponse);

					//BOObjPtr = CreateObj(BOPtr,"BOBank","GetAllBankByPsp");
                			//(BOObjPtr)(csPspBankChannelCode,csOrgServiceCode,csOrgTxnCountry,hResponse);
				}
			}
			
			recordset_init(rRecordSet,0);
			DBObjPtr = CreateObj(DBPtr,"DBPspCountry","GetPspCountry");
			if((unsigned long) ((*DBObjPtr)(csSelectedPID,rRecordSet))==PD_OK){
				hRec = RecordSet_GetFirst(rRecordSet);
				while(hRec){
					if (GetField_CString(hRec,"ccy_id",&csDstCcy)) {
						PutField_CString(hTxn,"dst_txn_ccy",csDstCcy);
DEBUGLOG(("Authorize() Get Psp ccy [%s]\n",csDstCcy));
					}
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
			FREE_ME(hPsp);

		}
		else {
			PutField_Int(hResponse,"customer_segment_enable",iCustSegEnable);
			PutField_Int(hResponse,"customer_group_found",iCustGroupFound);
			BOObjPtr = CreateObj(BOPtr,"BOBank","GetAvailableMobileBank");
			iRet=(unsigned long)(BOObjPtr)(csOrgChannelCode,csOrgServiceCode,csOrgTxnCountry,
						       csOrgMerchantId,csOrgDateTime,csTxnCcy,dTxnAmt,hResponse);

			if(iRet==PD_OK){
				DBObjPtr = CreateObj(DBPtr,"DBRuleLB","GetDstCcyWithoutRule");
				if((unsigned long)(DBObjPtr)(csOrgMerchantId,csOrgServiceCode,hTxn)==PD_OK){
					if (GetField_CString(hTxn,"psp_ccy",&csDstCcy)) {
						PutField_CString(hTxn,"dst_txn_ccy",csDstCcy);
DEBUGLOG(("Authorize() Get Psp ccy [%s]\n",csDstCcy));
					}
				}
			}
		}
	}
/***** ***/
/*
	if (iRet == INT_TXN_ID_NOT_FOUND) {
		char	cStatus;
		char	*csOrgTxnCode;
		char	*csOrgServiceCode;
		char	*csOrgPayMethod;
		char	*csOrgLanguage;
		char	*csUrl;
		recordset_init(rRecordSet,0);
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
                if ((DBObjPtr)(csTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("Authorize::txn Header found record = [%s]\n",csTxnSeq));
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
                                 if (GetField_Char(hRec,"status",&cStatus)) {
DEBUGLOG(("Authorize::GetTxnHeader - status = [%c]\n",cStatus));
                                 }
                                 if (GetField_CString(hRec,"service_code",&csOrgServiceCode)) {
DEBUGLOG(("Authorize::GetTxnHeader - service code = [%s]\n",csOrgServiceCode));
                                 }
                                 if (GetField_CString(hRec,"txn_code",&csOrgTxnCode)) {
DEBUGLOG(("Authorize::GetTxnHeader - txn code = [%s]\n",csOrgTxnCode));
                                 }


                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                }
                RecordSet_Destroy(rRecordSet);

		recordset_init(rRecordSet,0);
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
                if ((DBObjPtr)(csTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("Authorize::txn detail found record = [%s]\n",csTxnSeq));
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
                                 if (GetField_CString(hRec,"selected_pay_method",&csOrgPayMethod)) {
					 PutField_CString(hTxn,"selected_pay_method",csOrgPayMethod);
DEBUGLOG(("Authorize::GetTxnDetail - selected_method = [%s]\n",csOrgPayMethod));
                                 }
                                 if (GetField_CString(hRec,"txn_country",&csOrgTxnCountry)) {
DEBUGLOG(("Authorize::GetTxnDetail - txn country = [%s]\n",csOrgTxnCountry));
                                 }

                                 if (GetField_CString(hRec,"language",&csOrgLanguage)) {
DEBUGLOG(("Authorize::GetTxnDetail - language= [%s]\n",csOrgLanguage));
                                 }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                }
                RecordSet_Destroy(rRecordSet);


		if (cStatus == PD_TO_PSP && (!strcmp(csOrgPayMethod,PD_NET_BANKING) || !strcmp(csOrgPayMethod,PD_CONVENIENCE_STORE) || !strcmp(csOrgPayMethod,PD_ATM_PAYMENT))) {
			iRet = PD_OK;
ERRLOG("Authorize() org txn id record [%s] not found for status = [%c],but using previous record stored\n",csTxnSeq,PD_INIT);
			recordset_init(rRecordSet,0);
                	DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","GetTxnPspDetail");
                	if ((DBObjPtr)(csTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("Authorize::txn psp detail found record = [%s]\n",csTxnSeq));
                        	hRec = RecordSet_GetFirst(rRecordSet);
                        	while (hRec) {
                                	if (GetField_CString(hRec,"url",&csUrl)) {
DEBUGLOG(("Authorize::GetTxnPspDetail - url = [%s]\n",csUrl));
						PutField_CString(hResponse,"redirect_url",csUrl);
                               		}

                                	hRec = RecordSet_GetNext(rRecordSet);
                        	}
                	}
                	RecordSet_Destroy(rRecordSet);

DEBUGLOG(("Authorize: is redirect_url found?\n"));
			if (!GetField_CString(hResponse,"redirect_url",&csUrl)) {
DEBUGLOG(("Authorize: redirect_url not found\n"));
				recordset_init(rRecordSet,0);
DEBUGLOG(("call\n"));
				DBObjPtr = CreateObj(DBPtr,"DBTxnRptUrl","GetRptUrl");
DEBUGLOG(("call function ptr created\n"));
                        	if ((DBObjPtr)(csOrgTxnCode,csOrgServiceCode,csOrgLanguage,csOrgPayMethod,rRecordSet) == PD_OK) {
DEBUGLOG(("call and record found??\n"));
                                	hRec = RecordSet_GetFirst(rRecordSet);
                                	while(hRec){
                                        	if (GetField_CString(hRec,"rpt_url",&csPtr)) {
							char	*csBuf;
							csBuf = (char*)  malloc (PD_TMP_BUF_LEN + 1);
DEBUGLOG(("Authorize:: GetRptUrl - url only = [%s]\n",csPtr));
                                                	PutField_CString(hResponse,"rpt_url_only",csPtr);

                                                       	sprintf(csBuf,"%s?sessionid=%s",csPtr,csEncTxnSeq);
                                                       	PutField_CString(hResponse,"rpt_url",csBuf);

DEBUGLOG(("Authorize:: redirect_url = [%s]\n",csBuf));
							FREE_ME(csBuf);
                                        	}
                                        	hRec = RecordSet_GetNext(rRecordSet);
                                	}
                        	}
				else {
DEBUGLOG(("Authorize: not rpt record found\n"));
				}
                        	RecordSet_Destroy(rRecordSet);
			}
		}
		
		else if(cStatus == PD_TO_PSP){
			iRet = ResendToPsp(hContext,hRequest,hResponse);
		}
		else{
ERRLOG("Authorize() org txn id record [%s] not found for status = [%c]\n",csTxnSeq,PD_INIT);
		}

	}
*/
	//else 
	if(iRet==PD_OK){ //init record found 
		if(strcmp(csTxnCcy,csDstCcy)){
DEBUGLOG(("Authorize() Different currency flow...\n"));
			PutField_CString(hResponse,"dst_ccy",csDstCcy);
                	DBObjPtr = CreateObj(DBPtr,"DBTmpCalAmount","GetTmpCalAmount");
                	if ((unsigned long)(*DBObjPtr)(csTxnSeq,hTxn) == PD_FOUND) {
DEBUGLOG(("Authorize() GetTmpCalAmount Record Found\n"));
				if(GetField_Double(hTxn,"dst_net_amt",&dTmp)){
					PutField_Double(hResponse,"dst_amt",dTmp);
					PutField_Double(hResponse,"ex_rate",dTmp/dTxnAmt);
				}
			}
			else{
DEBUGLOG(("Authorize() GetTmpCalAmount Record Not Found\n"));
				PutField_Int(hTxn,"get_info_only",PD_TRUE);
				BOObjPtr = CreateObj(BOPtr,"BOExchange","GetExchangeInfo");
				iRet = (unsigned long)(*BOObjPtr)(hTxn,hTxn);
DEBUGLOG(("Authorize() BOExchange->GetExchangeInfo = [%d]\n",iRet));

				if(iRet == PD_OK){
					PutField_CString(hTxn,"txn_code",PD_INITIAL_TXN_CODE);
					BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
					iRet = (unsigned long)(*BOObjPtr)(hTxn,hTxn);
					RemoveField_CString(hTxn,"txn_code");
DEBUGLOG(("Authorize() GetTxnFee result = [%d]\n",iRet));
				
				}
				if(iRet == PD_OK){
					if(GetField_Double(hTxn,"dst_net_amt",&dTmp)){
						PutField_Double(hResponse,"dst_amt",dTmp);
						PutField_Double(hResponse,"ex_rate",dTmp/dTxnAmt);
					}
					if(GetField_Double(hTxn,"dst_txn_fee",&dTmp)){
						PutField_Double(hTxn,"dst_fee",dTmp);
					}
					if(GetField_Double(hTxn,"net_amt",&dTmp)){
						PutField_Double(hTxn,"src_net_amt",dTmp);
					}
					if(GetField_Double(hTxn,"src_txn_fee",&dTmp)){
						PutField_Double(hTxn,"src_fee",dTmp);
					}

					PutField_CString(hTxn,"txn_seq",csTxnSeq);
					PutField_CString(hTxn,"src_ccy",csTxnCcy);
					PutField_CString(hTxn,"dst_ccy",csDstCcy);
					DBObjPtr = CreateObj(DBPtr,"DBTmpCalAmount","Add");
					if((unsigned long)(DBObjPtr)(hTxn)==PD_OK){
DEBUGLOG(("Authorize() DBTmpCalAmount:Add success\n"));
					}
					else{
DEBUGLOG(("Authorize() DBTmpCalAmount:Add failed!!!\n"));
ERRLOG("TxnMgtByUsTMI: Authorize() DBTmpCalAmount:Add failed!!!\n");
					}

				}
			}
		}
		else{
DEBUGLOG(("Authorize() Normal flow...\n"));
			PutField_CString(hResponse,"dst_ccy",csTxnCcy);
			PutField_Double(hResponse,"dst_amt",dTxnAmt);
			PutField_Double(hResponse,"ex_rate",1);
		}

		if(iRet == PD_OK){
			hash_t *hCon;
			hCon = (hash_t*) malloc (sizeof(hash_t));
			hash_init(hCon,0);

			PutField_CString(hCon,"txn_seq",csTxnSeq);
			PutField_CString(hCon,"sub_status",PD_INITIATED);
			//PutField_CString(hCon,"ip_addr",csIpAddr);
			//PutField_CString(hCon,"user_agent",csUserAgent);

			DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
			if ((DBObjPtr)(hCon) != PD_OK) {
				iRet = INT_ERR;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() DBTransaction:Update Failed!!!!\n"));
ERRLOG("TxnMgtByUsTMI: Authorize() DBTransaction:Update Failed!!!!\n");
			}
			FREE_ME(hCon);
		}
	}
	
	else{
		PutField_Int(hContext,"internal_error",iRet);
	}

	FREE_ME(hTxn);
	FREE_ME(rRecordSet);
DEBUGLOG(("Authorize() normal exit = [%d]\n",iRet));
	return iRet;
}
