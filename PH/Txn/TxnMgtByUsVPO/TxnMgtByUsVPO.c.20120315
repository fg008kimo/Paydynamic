/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/07/18              LokMan Chow
Call BOTxnElements				   2012/02/08		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsVPO.h"
#include "myrecordset.h"
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnMgtByUsVPO(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
	int	iRet = PD_OK;
	char	*csOrgTxnSeq;
	char	*csTmp;
	char	cTmp;
	double	dTmp;
	int	iTmp;
	int	iReturnFee = PD_FALSE;
	double	dOrgSrcAmt;
	unsigned long lBatchId;
	int	iDayOfWeek=0;
	hash_t  *hRec, *hOrgTxn, *hIn;
	
	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

	hOrgTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hOrgTxn,0);

	hIn= (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hIn,0);

DEBUGLOG(("TxnMgtByUsVPO: Authroize()\n"));

	if(GetField_CString(hContext,"VPFEE",&csTmp)){
DEBUGLOG(("TxnMgtByUsVPO: Void Payout Fee Return [%s]\n",csTmp));
		if(!strcmp(csTmp,"Y")){
			iReturnFee = PD_TRUE;
		}
	}

	if (GetField_CString(hContext,"txn_seq",&csTmp)) {
DEBUGLOG(("txn seq = [%s]\n",csTmp));
		PutField_CString(hOrgTxn,"aux_txn_seq",csTmp);
	}

	if (GetField_CString(hContext,"org_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("org txn seq = [%s]\n",csOrgTxnSeq));
		PutField_CString(hOrgTxn,"txn_seq",csOrgTxnSeq);
		PutField_Int(hOrgTxn,"status",PAYOUT_MASTER_TRANSACTION_REVERSED);
	}

	if(GetField_CString(hContext,"update_user",&csTmp)){
                PutField_CString(hOrgTxn,"update_user",csTmp);
DEBUGLOG(("Authorize::update_user= [%s]\n",csTmp));
        }

	if(GetField_CString(hContext,"PHDATE",&csTmp)){
		iDayOfWeek=day_of_week((const unsigned char *)csTmp);
DEBUGLOG(("Authorize::day_of_week= [%d]\n",iDayOfWeek));
                PutField_Int(hContext,"day_of_week",iDayOfWeek);
	}

//MerchantUploadFileDetail
DEBUGLOG(("Authorize::Call DBMerchantUploadFileDetail:GetDetailByTxnId\n"));
        DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","GetDetailByTxnId");
        if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
                hRec = RecordSet_GetFirst(rRecordSet);
                while ((hRec) && (iRet==PD_OK)) {
/* batch_id */          
                        if (GetField_CString(hRec,"batch_id",&csTmp)) {
                                lBatchId = (unsigned long)ctol((const unsigned char *)csTmp,strlen(csTmp));
DEBUGLOG(("batch_id = [%ld]\n",lBatchId));
                        }
/*psp_id*/              
                        if (GetField_CString(hRec,"psp_id",&csTmp)) {
DEBUGLOG(("psp_id = [%s]\n",csTmp));
                                PutField_CString(hContext,"org_psp_id",csTmp);
                        }
/*merchant_ref*/
                        if (GetField_CString(hRec,"merchant_ref",&csTmp)) {
DEBUGLOG(("merchant_ref = [%s]\n",csTmp));
                                PutField_CString(hContext,"merchant_ref",csTmp);
                        }
/*country*/
                        if (GetField_CString(hRec,"txn_country",&csTmp)) {
DEBUGLOG(("txn_country = [%s]\n",csTmp));
                                PutField_CString(hIn,"txn_country",csTmp);
                                PutField_CString(hContext,"txn_country",csTmp);
                                PutField_CString(hContext,"org_txn_country",csTmp);
                        }       
/*payout_ccy*/          
                        if (GetField_CString(hRec,"payout_ccy",&csTmp)) {
DEBUGLOG(("payout_ccy = [%s]\n",csTmp));
                                PutField_CString(hIn,"txn_ccy",csTmp);
                                PutField_CString(hContext,"txn_ccy",csTmp);
                                PutField_CString(hContext,"org_txn_ccy",csTmp);
                        }
/*request_ccy*/
                        if (GetField_CString(hRec,"request_ccy",&csTmp)){
                                PutField_CString(hContext,"org_psp_txn_ccy",csTmp);
                                PutField_CString(hContext,"dst_txn_ccy",csTmp);
DEBUGLOG(("request_ccy= [%s]\n",csTmp));
                        }
/*payout_amount*/
                        if (GetField_Double(hRec,"payout_amount",&dTmp)) {
DEBUGLOG(("payout_amount = [%f]\n",dTmp));
                                dOrgSrcAmt = dTmp;
                        }
/*request_amount*/
                        if (GetField_Double(hRec,"request_amount",&dTmp)) {
DEBUGLOG(("request_amount = [%f]\n",dTmp));
                                PutField_Double(hContext,"org_dst_net_amt",dTmp);
                        }
/*member_fee*/
                        if (GetField_Double(hRec,"member_fee",&dTmp)) {
DEBUGLOG(("member_fee = [%f]\n",dTmp));

                        }

			if(iReturnFee==PD_TRUE){
/*merchant_fee*/
                        	if (GetField_Double(hRec,"merchant_fee",&dTmp)) {
DEBUGLOG(("merchant_fee = [%f]\n",dTmp));
                                	dOrgSrcAmt += dTmp;
                        	}
			}

                        PutField_Double(hContext,"txn_amt",dOrgSrcAmt);
/*service_fee
                        if (GetField_Double(hRec,"service_fee",&dTmp)) {
DEBUGLOG(("service_fee = [%f]\n",dTmp));
                                PutField_Double(hContext,"precal_fee",dTmp);
                        }
                        else{
DEBUGLOG(("Authorize::Call BOPsp CalPspFee\n"));
                                BOObjPtr = CreateObj(BOPtr,"BOPsp","CalPspFee");
                                iRet = (unsigned long)(*BOObjPtr)(hContext,hIn);
                        }
*/
                        if (GetField_Char(hRec,"batch_mode",&cTmp)) {
DEBUGLOG(("batch_mode = [%c]\n",cTmp));
			}
			else{
				iRet = INT_ERR;
DEBUGLOG(("batch_mode not found!!!\n"));
			}

/*status*/
                        if (GetField_Int(hRec,"status",&iTmp)) {
DEBUGLOG(("status = [%d]\n",iTmp));
				if(cTmp==PD_OFFLINE){
					if(!((iTmp==PAYOUT_MASTER_TRANSACTION_GENERATED)||
					(iTmp==PAYOUT_MASTER_TRANSACTION_APPROVED))){
                                        	iRet = INT_ERR;
DEBUGLOG(("Authorize::Invalid Status. Txn cannot be voided\n"));
					}
				}
				else if(cTmp==PD_ONLINE){
                                	if(iTmp!=PAYOUT_MASTER_TRANSACTION_ACCEPT){
                                        	iRet = INT_ERR;
DEBUGLOG(("Authorize::Invalid Status. Txn cannot be voided\n"));
					}
				}
			}


                        hRec = RecordSet_GetNext(rRecordSet);
                }
        }
        RecordSet_Destroy(rRecordSet);


	//MerchantUploadFileHeader
        if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMerchantUploadFileHeader:GetHeader\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileHeader","GetHeader");
                if ((*DBObjPtr)(lBatchId,rRecordSet) == PD_OK) {
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
/* merchant_id */
                                if (GetField_CString(hRec,"merchant_id",&csTmp)) {
DEBUGLOG(("merchant_id = [%s]\n",csTmp));
                                        PutField_CString(hIn,"merchant_id",csTmp);
                                        PutField_CString(hContext,"merchant_id",csTmp);
                                        PutField_CString(hRequest,"merchant_id",csTmp);
                                        PutField_CString(hContext,"org_merchant_id",csTmp);
                                }
/* service_code */
                                if (GetField_CString(hRec,"service_code",&csTmp)) {
DEBUGLOG(("service_code = [%s]\n",csTmp));
                                        PutField_CString(hIn,"service_code",csTmp);
                                        PutField_CString(hContext,"service_code",csTmp);
                                        PutField_CString(hContext,"org_service_code",csTmp);
                                }
                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                }

        }
        RecordSet_Destroy(rRecordSet);

	if(iRet==PD_OK){
//////get merchant_client_id
DEBUGLOG(("Authorize::Call BOMerchant:GetMerchantDetail\n"));
		BOObjPtr = CreateObj(BOPtr,"BOMerchant","GetMerchantDetail");
		if((unsigned long)(*BOObjPtr)(hContext,hRequest)!=PD_OK)
			iRet = INT_ERR;
	}

	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call BOExchange:GetExchangeInfo\n"));
                BOObjPtr = CreateObj(DBPtr,"BOExchange","GetExchangeInfo");
                if ((*BOObjPtr)(hContext,hIn) == PD_OK) {
                        if(GetField_Char(hContext,"ex_party",&cTmp)){
                                PutField_Char(hContext,"ex_supplier",cTmp);
                        }

                }
                else{
                        iRet = INT_ERR;
DEBUGLOG(("Authorize::GetExchangeInfo Error\n"));
ERRLOG("TxnMgtByUsWTV:Authorize::GetExchangeInfo Error\n");
                }
        }

        if (iRet == PD_OK) {
		PutField_CString(hContext,"sub_txn_code",PD_PAYOUT_VOID);
DEBUGLOG(("Authorize::Call BOFee:GetTxnFee\n"));
                BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
                if((unsigned long)(*BOObjPtr)(hContext,hIn)==PD_OK){
                        if(GetField_Double(hContext,"src_txn_fee",&dTmp)){
DEBUGLOG(("Authorize::void payout txn fee=[%f]\n",dTmp));
                        }
                        if(GetField_Double(hContext,"net_amt",&dTmp)){
DEBUGLOG(("Authorize::void payout net amt=[%f]\n",dTmp));
                                PutField_Double(hContext,"org_net_amt",dTmp);
                        }
//                        if(GetField_Double(hContext,"dst_txn_amt",&dTmp)){
//DEBUGLOG(("Authorize::void payout dest net amt=[%f]\n",dTmp));
//                              PutField_Double(hContext,"org_dst_net_amt",dTmp);
//                        }

			/*Add TxnFeeElements*/
			BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnFeeElements");
			iRet = (unsigned long)(*BOObjPtr)(hContext);

                }
                else{
                        iRet = INT_ERR;
DEBUGLOG(("Authorize::GetTxnFee Error\n"));
ERRLOG("TxnMgtByUsWTV:Authorize::GetTxnFee Error\n");
                }
        }



	if (iRet == PD_OK) {
DEBUGLOG(("Call BOBalance:UpdatePayoutAmount()\n"));
		PutField_Char(hContext,"response_mode",PD_REVERSED);

		BOObjPtr = CreateObj(BOPtr,"BOBalance","UpdatePayoutAmount");
		if((unsigned long)(*BOObjPtr)(hContext)!=PD_OK)
			iRet = INT_ERR;
DEBUGLOG(("TxnMgtByUsVPO: Authroize:: BOBalance:UpdatePayoutAmount() result = [%d]\n",iRet));
	}

	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call DBMerchantUploadFileDetail:UpdateDetailByTxnId\n"));
                DBObjPtr = CreateObj(DBPtr,"DBMerchantUploadFileDetail","UpdateDetailByTxnId");
                if ((*DBObjPtr)(csOrgTxnSeq,hOrgTxn) != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("Authorize::DBMerchantUploadFileDetail:UpdateDetailByBatchId Failed\n"));
                }
        }

	if(iRet == PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:AddDetail\n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK){
                        iRet = INT_ERR;
DEBUGLOG(("Authorize::DBTransaction:AddDetail Failed\n"));
                }
        }
        
        if(iRet==PD_OK){
DEBUGLOG(("Authorize::Call DBTransaction:UpdateDetail\n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                if((unsigned long) ((*DBObjPtr)(hContext))!=PD_OK){
                        iRet = INT_ERR;
DEBUGLOG(("Authorize::DBTransaction:UpdateDetail Failed\n"));
                }
        }

	if(iRet!=PD_OK){
                PutField_Int(hContext,"internal_error",iRet);
        }

	hash_destroy(hOrgTxn);
        FREE_ME(hOrgTxn);
	FREE_ME(rRecordSet);

DEBUGLOG(("Normal exit iRet = [%d]\n",iRet));	
	return iRet;
}
