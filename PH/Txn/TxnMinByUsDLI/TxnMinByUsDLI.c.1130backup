/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/11/19              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMinByUsDLI.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);
OBJPTR(Channel);


int     PrcoessRspDeliveryIn(hash_t* hContext, hash_t* hRequest, hash_t* hOrgTxnRec, hash_t* hTxnRec);
int	GetRspDeliveryOutTxnInfo(hash_t* hTxnRec);
int     FormRspDeliveryInTxn(hash_t* hContext, hash_t* hRequest, hash_t* hOrgTxnRec, hash_t* hTxnRec);
int	PrcoessRspDeliveryInTxn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec);
int     ProcessOpbFundIn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec);
int     ProcessOpbFundInTxn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec);
int     ProcessRspAmtDiff(hash_t* hContext, hash_t* hRequest, hash_t* hOrgTxnRec, hash_t* hTxnRec);
int     FormRspAmtDiffTxn(hash_t* hContext, hash_t* hRequest, hash_t* hOrgTxnRec, hash_t* hTxnRec);
int     ProcessRspAmtDiffTxn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec);
int     ProcessBatchInfo(hash_t* hBatchRec, hash_t* hRspDeliOutTxnRec, hash_t* hRspDeliInTxnRec, hash_t* hOpbFundInTxnRec, hash_t* hRspAmtDiffTxnRec);
int     AddBatchDetail(hash_t* hBatchRec, hash_t* hTxnRec);
int	ProcessBatchTxn(hash_t* hBatchRec, hash_t* hRspDeliOutTxnRec, hash_t* hRspDeliInTxnRec, hash_t* hOpbFundInTxnRec, hash_t* hRspAmtDiffTxnRec);
int	ProcessACR(hash_t* hContext, hash_t* hRequest, hash_t* hRspDeliOutTxnRec, hash_t* hOpbFundInTxnRec, hash_t* hBatchRec);

void TxnMinByUsDLI(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
		  hash_t* hRequest,
		  hash_t* hResponse)
{
        int	iRet = PD_OK;

	int     i = 0;
        int     iSebCnt = 0;
        int     iAmtDiffCnt = 0;
        int     iTotalCnt = 0;
	int	iTmp = 0;

        double  dTmp = 0.0;

        char    *csTmp = NULL;

	char    csTag[PD_TAG_LEN + 1];

        hash_t  *hRspDeliOutTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRspDeliOutTxnRec,0);

        hash_t  *hRspDeliInTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRspDeliInTxnRec,0);

        hash_t  *hOpbFundInTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hOpbFundInTxnRec,0);

        hash_t  *hRspAmtDiffTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRspAmtDiffTxnRec,0);

	hash_t *hBatchRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchRec, 0);

DEBUGLOG(("Authorize::TxnMinByUsDLI Begin\n"));

/* txn_seq */
        if (GetField_CString(hContext,"txn_seq",&csTmp)) {
DEBUGLOG(("Authorize::txn_seq = [%s]\n",csTmp));
		PutField_CString(hRspDeliInTxnRec,"txn_seq",csTmp);
        } else {
DEBUGLOG(("Authorize::txn_seq not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::txn_seq not found!!\n");
                iRet = INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* org_txn_seq */
        if (GetField_CString(hContext,"org_txn_seq",&csTmp)) {
DEBUGLOG(("Authorize::org_txn_id = [%s]\n",csTmp));
		PutField_CString(hRspDeliOutTxnRec,"txn_seq",csTmp);
		PutField_CString(hRspDeliInTxnRec,"org_txn_seq",csTmp);
        } else {
DEBUGLOG(("Authorize::org_txn_seq not found!!\n"));
ERRLOG("TxnMinByUsDLI:Authorize::org_txn_seq not found!!\n");
                iRet=INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* entity_id */
        if (GetField_CString(hContext,"entity_id",&csTmp)) {
DEBUGLOG(("Authorize::entity_id = [%s]\n",csTmp));
                PutField_CString(hOpbFundInTxnRec, "entity_id", csTmp);
        } else {
DEBUGLOG(("Authorize::entity_id not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::entity_id not found!!\n");
                iRet = INT_MI_ENTITY_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* product_code */
        if (GetField_CString(hContext,"product_code",&csTmp)) {
DEBUGLOG(("Authorize::product_code = [%s]\n",csTmp));
             	PutField_CString(hRspDeliInTxnRec,"product_code",csTmp);
                PutField_CString(hOpbFundInTxnRec,"product_code",csTmp);
               	PutField_CString(hRspAmtDiffTxnRec,"product_code",csTmp);
        } else {
DEBUGLOG(("Authorize::product_code not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::product_code not found!!\n");
                iRet = INT_MI_PRODUCT_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_ccy */
        if (GetField_CString(hContext,"txn_ccy",&csTmp)) {
DEBUGLOG(("Authorize::txn_ccy = [%s]\n",csTmp));
                PutField_CString(hOpbFundInTxnRec, "txn_ccy", csTmp);
                PutField_CString(hOpbFundInTxnRec, "ccy", csTmp);
                PutField_CString(hOpbFundInTxnRec,"net_ccy",csTmp);
                PutField_CString(hOpbFundInTxnRec, "org_txn_ccy", csTmp);
                PutField_CString(hOpbFundInTxnRec, "entity_ccy", csTmp);
        } else {
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* bank_base_ccy */
        if (GetField_CString(hContext,"bank_base_ccy",&csTmp)) {
DEBUGLOG(("Authorize::bank_base_ccy = [%s]\n",csTmp));
                PutField_CString(hOpbFundInTxnRec, "bank_base_ccy", csTmp);
        } else {
DEBUGLOG(("Authorize::bank_base_ccy not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::bank_base_ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* bank_base_country */
        if (GetField_CString(hContext,"bank_base_country",&csTmp)) {
DEBUGLOG(("Authorize::bank_base_country = [%s]\n",csTmp));
                PutField_CString(hOpbFundInTxnRec, "bank_base_country", csTmp);
                PutField_CString(hOpbFundInTxnRec, "txn_country", csTmp);
                PutField_CString(hOpbFundInTxnRec, "country", csTmp);
        } else {
DEBUGLOG(("Authorize::bank_base_country not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::bank_base_country not found!!\n");
                iRet=INT_TXN_COUNTRY_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* bank_id */
	if (GetField_CString(hContext,"bank_id",&csTmp)) {
DEBUGLOG(("Authorize::bank_id = [%s]\n",csTmp));
                PutField_CString(hOpbFundInTxnRec, "party_id", csTmp);
        }

/* is_acr_bank */
        if (GetField_Int(hContext,"is_acr_bank",&iTmp)) {
DEBUGLOG(("Authorize::is_acr_bank = [%d]\n",iTmp));
                PutField_Int(hOpbFundInTxnRec, "is_acr_bank", iTmp);
        }

/* entity_status */
        if (GetField_CString(hContext,"entity_status",&csTmp)) {
DEBUGLOG(("Authorize::entity_status = [%s]\n",csTmp));
                PutField_CString(hOpbFundInTxnRec, "entity_status", csTmp);
        }

/* remark */
        if (GetField_CString(hContext,"remark",&csTmp)){
DEBUGLOG(("Authorize::remark = [%s]\n",csTmp));
		PutField_CString(hRspDeliInTxnRec,"remark",csTmp);
		PutField_CString(hOpbFundInTxnRec,"remark",csTmp);
		PutField_CString(hRspAmtDiffTxnRec,"remark",csTmp);
        } else {
DEBUGLOG(("Authorize::remark not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::remark not found!!\n");
                iRet = INT_MI_REMARK_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* skip_tol_check */
        if (GetField_Int(hContext,"skip_tol_check",&iTmp)) {
DEBUGLOG(("Authorize::skip_tol_check = [%d]\n",iTmp));
                PutField_Int(hOpbFundInTxnRec, "skip_tol_check", iTmp);
        }

/* mini_txn_type */
        if (GetField_CString(hContext,"mini_txn_type",&csTmp)) {
DEBUGLOG(("Authorize::mini_txn_type = [%s]\n",csTmp));
                PutField_CString(hRspDeliInTxnRec,"mini_txn_type",csTmp);
                PutField_CString(hOpbFundInTxnRec,"mini_txn_type",csTmp);
                PutField_CString(hRspAmtDiffTxnRec,"mini_txn_type",csTmp);
        }

/* add_user */
        if (GetField_CString(hContext,"add_user",&csTmp)) {
DEBUGLOG(("Authorize::add_user = [%s]\n",csTmp));
                PutField_CString(hRspDeliInTxnRec,"add_user",csTmp);
                PutField_CString(hOpbFundInTxnRec,"add_user",csTmp);
                PutField_CString(hRspAmtDiffTxnRec,"add_user",csTmp);
                PutField_CString(hBatchRec,"add_user",csTmp);
                
		PutField_CString(hRspDeliInTxnRec,"update_user",csTmp);
                PutField_CString(hOpbFundInTxnRec,"update_user",csTmp);
                PutField_CString(hRspAmtDiffTxnRec,"update_user",csTmp);
                PutField_CString(hBatchRec,"update_user",csTmp);
        }

/* update_user */
        if (GetField_CString(hContext,"update_user",&csTmp)) {
DEBUGLOG(("Authorize::update_user = [%s]\n",csTmp));
        }

/* seb_cnt */
        if (GetField_Int(hContext,"seb_cnt",&iSebCnt)) {
DEBUGLOG(("Authorize::seb_cnt = [%d]\n",iSebCnt));
		PutField_Int(hOpbFundInTxnRec,"seb_cnt",iSebCnt);
        } else {
DEBUGLOG(("Authorize::seb_cnt not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::seb_cnt not found!!\n");
                iRet = INT_MI_SEB_CNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* amtdiff_cnt */
        if (GetField_Int(hContext,"amtdiff_cnt",&iAmtDiffCnt)) {
DEBUGLOG(("Authorize::amtdiff_cnt = [%d]\n",iAmtDiffCnt));
		PutField_Int(hRspAmtDiffTxnRec,"amtdiff_cnt",iAmtDiffCnt);
        }

/* total_cnt */
        if (GetField_Int(hContext,"total_cnt",&iTotalCnt)) {
DEBUGLOG(("Authorize::total_cnt = [%d]\n",iTotalCnt));
		PutField_Int(hOpbFundInTxnRec,"total_cnt",iTotalCnt);
		PutField_Int(hRspAmtDiffTxnRec,"total_cnt",iTotalCnt);
        } else {
DEBUGLOG(("Authorize::total_cnt not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::total_cnt not found!!\n");
                iRet = INT_MI_TOTAL_CNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }
	
	// total_cnt
        for (i=0; i<iTotalCnt; i++) {
		if (iRet == PD_OK) {

/* txnamt */
                        sprintf(csTag, "txnamt_%d", i+1);
                        if (GetField_Double(hContext, csTag, &dTmp)) {
DEBUGLOG(("Authorize::[%s] = [%f]\n",csTag, dTmp));
				PutField_Double(hOpbFundInTxnRec,csTag,dTmp);

				// Set Seb Exist
				sprintf(csTag, "seb_exist_%d", i+1);
				PutField_Int(hOpbFundInTxnRec,csTag,1);
/*
                        } else {
DEBUGLOG(("Authorize::[%s] not found!!\n",csTag));
ERRLOG("TxnMinByUsDLI::Authorize::[%s] not found!!\n",csTag);
                                iRet = INT_PAY_AMOUNT_NOT_FOUND;
                                PutField_Int(hContext,"internal_error",iRet);
*/
                        }

/* deliver_date */
                        sprintf(csTag, "deliver_date_%d", i+1);
                        if (GetField_CString(hContext, csTag, &csTmp)) {
DEBUGLOG(("Authorize::[%s] = [%s]\n",csTag, csTmp));
				PutField_CString(hOpbFundInTxnRec,csTag,csTmp);
                        }

/* amtdiff_reason */
                        sprintf(csTag, "amtdiff_reason_%d", i+1);
                        if (GetField_CString(hContext, csTag, &csTmp)) {
DEBUGLOG(("Authorize::[%s] = [%s]\n",csTag, csTmp));
				PutField_CString(hRspAmtDiffTxnRec,csTag,csTmp);
                        }

/* amtdiff_ccy */
                        sprintf(csTag, "amtdiff_ccy_%d", i+1);
                        if (GetField_CString(hContext, csTag, &csTmp)) {
DEBUGLOG(("Authorize::[%s] = [%s]\n",csTag, csTmp));
				PutField_CString(hRspAmtDiffTxnRec,csTag,csTmp);
                        }

/* amtdiff_amt */
                        sprintf(csTag, "amtdiff_amt_%d", i+1);
                        if (GetField_Double(hContext, csTag, &dTmp)) {
DEBUGLOG(("Authorize::[%s] = [%f]\n",csTag, dTmp));
				PutField_Double(hRspAmtDiffTxnRec,csTag,dTmp);

				// Set Amt Diff Exist
                                sprintf(csTag, "amtdiff_exist_%d", i+1);
                                PutField_Int(hRspAmtDiffTxnRec,csTag,1);
                        }
                }
        }

	// Generate Rsp Delivery Out Txn and Debit Rsp Available Balance 
	if (iRet == PD_OK) { 
		iRet = PrcoessRspDeliveryIn(hContext, hRequest, hRspDeliOutTxnRec, hRspDeliInTxnRec);
	}

	// Generate Op Bank Txn and Credit Op Bank Balance
	if (iRet == PD_OK) {
		iRet = ProcessOpbFundIn(hContext, hRequest, hOpbFundInTxnRec);
	}

	// Generate Amt Diff Txn and Credit/Debit AR Balance
        if (iRet == PD_OK) {
                iRet = ProcessRspAmtDiff(hContext, hRequest, hRspDeliInTxnRec, hRspAmtDiffTxnRec);
        }

	// Generate Batch Info
	if (iRet == PD_OK) {
		iRet = ProcessBatchInfo(hBatchRec, hRspDeliOutTxnRec, hRspDeliInTxnRec, hOpbFundInTxnRec, hRspAmtDiffTxnRec);
	}

	// Update Batch Txn
	if (iRet == PD_OK) {
		iRet = ProcessBatchTxn(hBatchRec, hRspDeliOutTxnRec, hRspDeliInTxnRec, hOpbFundInTxnRec, hRspAmtDiffTxnRec);
	}

	// Cal ACR
	if (iRet == PD_OK) {
                iRet = ProcessACR(hContext, hRequest, hRspDeliOutTxnRec, hOpbFundInTxnRec, hBatchRec);
        }

	hash_destroy(hRspDeliOutTxnRec);
	FREE_ME(hRspDeliOutTxnRec);

	hash_destroy(hRspDeliInTxnRec);
	FREE_ME(hRspDeliInTxnRec);

	hash_destroy(hOpbFundInTxnRec);
	FREE_ME(hOpbFundInTxnRec);

	hash_destroy(hRspAmtDiffTxnRec);
	FREE_ME(hRspAmtDiffTxnRec);

	hash_destroy(hBatchRec);
	FREE_ME(hBatchRec);

DEBUGLOG(("TxnMinByUsDLI Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     PrcoessRspDeliveryIn(hash_t* hContext, hash_t* hRequest, hash_t* hOrgTxnRec, hash_t* hTxnRec)
{
	int     iRet = PD_OK;

DEBUGLOG(("===== PrcoessRspDeliveryIn ===== START!!\n"));

	// Lock Org Txn + Get Org Txn
	iRet = GetRspDeliveryOutTxnInfo(hOrgTxnRec);
	if (iRet == INT_ERR) {
DEBUGLOG(("PrcoessRspDeliveryIn::GetRspDeliveryOutTxnInfo Failed\n"));
ERRLOG("TxnMinByUsDLI::PrcoessRspDeliveryIn::GetRspDeliveryOutTxnInfo Failed\n");
         	iRet = INT_INVALID_TXN;
            	PutField_Int(hContext,"internal_error",iRet);
       	}

	// Form New Txn
	if (iRet == PD_OK) {
		iRet = FormRspDeliveryInTxn(hContext, hRequest, hOrgTxnRec, hTxnRec);
	}	

	// Create Txn + Update Balance (with add approval_date, approval_timestamp)
	if (iRet == PD_OK) {
		iRet = PrcoessRspDeliveryInTxn(hContext, hRequest, hTxnRec);
	}

DEBUGLOG(("PrcoessRspDeliveryIn:: iRet [%d]\n", iRet));
DEBUGLOG(("===== PrcoessRspDeliveryIn ===== END !!\n"));	

        return iRet;
}

int	GetRspDeliveryOutTxnInfo(hash_t* hTxnRec)
{
	int     iRet = PD_OK;

	int	iTmp = 0;

	double	dTmp = 0.0;

	char    *csTxnId = (char*) malloc (PD_TXN_SEQ_LEN);
	char	*csTmp = NULL;

	hash_t  *hRec = NULL;	

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));

/* txn_seq */
        if (GetField_CString(hTxnRec,"txn_seq",&csTxnId)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::txn_id = [%s]\n",csTxnId));
        } else {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::txn_id not found!!\n"));
ERRLOG("TxnMinByUsDLI::GetRspDeliveryOutTxnInfo::txn_id not found!!\n");
                iRet = INT_INVALID_TXN;
        } 

	// Get Txn Header
      	if(iRet==PD_OK){
		recordset_init(rRecordSet,0);

DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call DBTransaction::GetTxnHeader:: txn_id [%s]\n",csTxnId));
            	DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
              	iRet = (unsigned long)(*DBObjPtr)(csTxnId,rRecordSet);
		if (iRet == PD_OK) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call DBTransaction::GetTxnHeader Success\n"));
                 	hRec = RecordSet_GetFirst(rRecordSet);
                     	while (hRec) {

/* channel_code */
				if(GetField_CString(hRec,"channel_code",&csTmp)){
DEBUGLOG(("GetRspDeliveryOutTxnInfo::channel_code = [%s]\n",csTmp));
                                        PutField_CString(hTxnRec,"channel_code",csTmp);
                                }

/* service_code */
                                if(GetField_CString(hRec,"service_code",&csTmp)){
DEBUGLOG(("GetRspDeliveryOutTxnInfo::service_code = [%s]\n",csTmp));
                                        PutField_CString(hTxnRec,"service_code",csTmp);
                                }

/* net_ccy */
				if(GetField_CString(hRec,"net_ccy",&csTmp)){
DEBUGLOG(("GetRspDeliveryOutTxnInfo::net_ccy = [%s]\n",csTmp));
					PutField_CString(hTxnRec,"net_ccy",csTmp);
                                }

/* net_amt */
                            	if(GetField_Double(hRec,"net_amt",&dTmp)){
DEBUGLOG(("GetRspDeliveryOutTxnInfo::net_amt = [%lf]\n",dTmp));
                                	PutField_Double(hTxnRec,"net_amt",dTmp);	   
				}

/* txn_amt */
                                if(GetField_Double(hRec,"txn_amt",&dTmp)){
DEBUGLOG(("GetRspDeliveryOutTxnInfo::txn_amt = [%lf]\n",dTmp));
                                        PutField_Double(hTxnRec,"txn_amt",dTmp);  
                                }

                              	hRec = RecordSet_GetNext(rRecordSet);
                      	}
             	} else {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call DBTransaction::GetTxnHeader Failed\n"));
                        iRet = INT_ERR;
                }

		RecordSet_Destroy(rRecordSet);
     	}

	// Get Txn Detail
	if(iRet==PD_OK){
		recordset_init(rRecordSet,0);

DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call DBTransaction::GetTxnDetail:: txn_id [%s]\n",csTxnId));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
                iRet = (unsigned long)(*DBObjPtr)(csTxnId,rRecordSet);
                if (iRet == PD_OK) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call DBTransaction::GetTxnDetail Success\n"));
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* txn_country */
                                if(GetField_CString(hRec,"txn_country",&csTmp)){
DEBUGLOG(("GetRspDeliveryOutTxnInfo::txn_country = [%s]\n",csTmp));
                                        PutField_CString(hTxnRec,"txn_amt",csTmp);
                                }

				hRec = RecordSet_GetNext(rRecordSet);
			}
                } else {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call DBTransaction::GetTxnDetail Failed\n"));
                        iRet = INT_ERR;
                }
			
		RecordSet_Destroy(rRecordSet);
	}

	// Get Txn Mi Detail
	if(iRet==PD_OK){
                recordset_init(rRecordSet,0);

DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: txn_id = [%s]\n", csTxnId));
                DBObjPtr = CreateObj(DBPtr, "DBTxnMiDetail", "GetTxnMiDetail");
                iRet = (unsigned long)(*DBObjPtr)(csTxnId, rRecordSet);
                if (iRet == PD_OK) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail:SUCCESS\n"));

			hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* entity_id */
                                if (GetField_CString(hRec,"entity_id",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: entity_id = [%s]\n", csTmp));
					PutField_CString(hTxnRec,"entity_id",csTmp);
				}
					
/* party_type */
				if (GetField_CString(hRec,"party_type",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: party_type = [%s]\n", csTmp));
					PutField_CString(hTxnRec,"party_type",csTmp);
				}

/* party_id */
                                if (GetField_CString(hRec,"party_id",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: party_id = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"party_id",csTmp);
				}

/* txn_ccy */
                                if (GetField_CString(hRec,"txn_ccy",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: txn_ccy = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"txn_ccy",csTmp);
				}

/* txn_country */
                                if (GetField_CString(hRec,"txn_country",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: txn_country = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"txn_country",csTmp);
				}

/* txn_product */
                                if (GetField_CString(hRec,"txn_product",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: txn_product = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"txn_product",csTmp);
                                }

/* open_acct_bal */
                                if (GetField_Double(hRec,"open_acct_bal",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: entity_id = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"open_acct_bal",dTmp);
                                }

/* acct_bal */
                                if (GetField_Double(hRec,"acct_bal",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: acct_bal = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"acct_bal",dTmp);
                                }

/* open_intransit */
                                if (GetField_Double(hRec,"open_intransit",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: open_intransit = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"open_intransit",dTmp);
                                }

/* intransit */
                                if (GetField_Double(hRec,"intransit",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: intransit = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"intransit",dTmp);
                                }

/* open_ar_bal */
                                if (GetField_Double(hRec,"open_ar_bal",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: open_ar_bal = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"open_ar_bal",dTmp);
                                }

/* ar_bal */
                                if (GetField_Double(hRec,"ar_bal",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: ar_bal = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"ar_bal",dTmp);
                                }

/* txn_date */
                                if (GetField_CString(hRec,"txn_date",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: txn_date = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"txn_date",csTmp);
                                }

/* report_date */
				if (GetField_CString(hRec,"report_date",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: report_date = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"report_date",csTmp);
                                }

/* cost_rate */
                                if (GetField_Double(hRec,"cost_rate",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: cost_rate = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"cost_rate",dTmp);
                                }

/* actual_cost */
                                if (GetField_Double(hRec,"actual_cost",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: actual_cost = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"actual_cost",dTmp);
                                }

/* remittance_slip_date */
                                if (GetField_CString(hRec,"remittance_slip_date",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: remittance_slip_date = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"remittance_slip_date",csTmp);
                                }

/* converted_ccy */
                                if (GetField_CString(hRec,"converted_ccy",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: converted_ccy = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"converted_ccy",csTmp);
                                }

/* converted_amount */
                                if (GetField_Double(hRec,"converted_amount",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: converted_amount = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"converted_amount",dTmp);
                                }

/* remark */
                                if (GetField_CString(hRec,"remark",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: remark = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"remark",csTmp);
                                }

/* prev_grp_txn_id */            
	                    	if (GetField_CString(hRec,"prev_grp_txn_id",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: prev_grp_txn_id = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"prev_grp_txn_id",csTmp);
                                }

/* next_grp_txn_id */
                                if (GetField_CString(hRec,"next_grp_txn_id",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: next_grp_txn_id = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"next_grp_txn_id",csTmp);
                                }

/* acr_prorata */
                                if (GetField_Int(hRec,"acr_prorata",&iTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: acr_prorata = [%d]\n", iTmp));
                                	PutField_Int(hTxnRec,"acr_prorata",iTmp);
                                }

/* entity_ccy */
                                if (GetField_CString(hRec,"entity_ccy",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: entity_ccy = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"entity_ccy",csTmp);
                                }

/* entity_txn_amount */
                                if (GetField_Double(hRec,"entity_txn_amount",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: entity_txn_amount = [%f]\n", dTmp));
                                        PutField_Double(hTxnRec,"entity_txn_amount",dTmp);
                                }

				hRec = RecordSet_GetNext(rRecordSet);
                        }
		} else {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail:Failed\n"));
                	iRet = INT_ERR;
		}

		RecordSet_Destroy(rRecordSet);
	}

	FREE_ME(csTxnId);
	FREE_ME(rRecordSet);

DEBUGLOG(("GetRspDeliveryOutTxnInfo Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     FormRspDeliveryInTxn(hash_t* hContext, hash_t* hRequest, hash_t* hOrgTxnRec, hash_t* hTxnRec)
{
	int     iRet = PD_OK;

	double	dTmp = 0.0;

	char	*csTmp = NULL;

	char    csTxnDateTime[PD_DATETIME_LEN + 1];

/* txn_seq */
	if (GetField_CString(hTxnRec, "txn_seq", &csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn:: txn_seq [%s]\n", csTmp));
        }

	// Txn Header
	if (iRet == PD_OK) {

/* channel_code */
		if (GetField_CString(hOrgTxnRec, "channel_code", &csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: channel_code [%s]\n", csTmp));
                	PutField_CString(hTxnRec, "channel_code", csTmp);
        	}		

/* service_code */
                if (GetField_CString(hOrgTxnRec, "service_code", &csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: service_code [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "service_code", csTmp);
                }

/* status */
                PutField_Char(hTxnRec,"status",PD_PROCESSING);
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: status [%c]\n", PD_PROCESSING));

/* txn_code */
                PutField_CString(hTxnRec, "txn_code", PD_MI_TXN_CODE_RSP_DELIVERY_OUT);
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: txn_code [%s]\n", PD_MI_TXN_CODE_RSP_DELIVERY_OUT));

/* process_type */
                PutField_CString(hTxnRec,"process_code", PD_PROCESS_CODE_DEF);
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: process_code [%s]\n", PD_PROCESS_CODE_DEF));

/* process_code */
                PutField_CString(hTxnRec,"process_type", PD_PROCESS_TYPE_DEF);
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: process_type [%s]\n", PD_PROCESS_TYPE_DEF));

/* response_code */
                PutField_CString(hTxnRec, "response_code", "0");
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: response_code [%s]\n", "0"));

/* internal_code */
                PutField_Int(hTxnRec, "internal_code", 0);
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: internal_code [%d]\n", 0));

/* host_posting_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: PHDATE [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"PHDATE",csTmp);
                }

/* transmission_datetime */
                if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: local_tm_date [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "local_tm_date", csTmp);
                        PutField_CString(hTxnRec, "tm_date", csTmp);

                        strcpy(csTxnDateTime, csTmp);
                        PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);

                        if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: local_tm_time [%s]\n", csTmp));
                                PutField_CString(hTxnRec, "local_tm_time", csTmp);
                                strcat(csTxnDateTime, csTmp);
                                PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);
                        }
                }

/* net_ccy */
             	if (GetField_CString(hOrgTxnRec,"net_ccy",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: net_ccy = [%s]\n",csTmp));
                  	PutField_CString(hTxnRec,"net_ccy",csTmp);
			PutField_CString(hContext,"net_ccy",csTmp);
             	}

/* net_amt */
              	if (GetField_Double(hOrgTxnRec,"net_amt",&dTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: net_amt = [%lf]\n",dTmp));
                      	PutField_Double(hTxnRec,"net_amt",dTmp);
               	}

/* txn_amt */
            	if (GetField_Double(hOrgTxnRec,"txn_amt",&dTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: txn_amt = [%lf]\n",dTmp));
                   	PutField_Double(hTxnRec,"txn_amt",dTmp);
             	}

/* ex_supplier */
		 PutField_Char(hTxnRec,"ex_supplier",PD_INT_EX);
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: ex_supplier [%c]\n", PD_INT_EX));

/* ex_rate */
		PutField_Double(hTxnRec,"ex_rate",1);
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: ex_rate = [%lf]\n",1));

	}

	// Txn Detail
	if (iRet == PD_OK) {

/* txn_country */
                if (GetField_CString(hOrgTxnRec, "txn_country", &csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: txn_country = [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "txn_country", csTmp);
                }
	}
	
	// Txn Mi Detail
	if (iRet == PD_OK) {

/* entity_id */
              	if (GetField_CString(hOrgTxnRec,"entity_id",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: entity_id = [%s]\n", csTmp));
                    	PutField_CString(hTxnRec,"entity_id",csTmp);
            	}

/* party_type */
             	if (GetField_CString(hOrgTxnRec,"party_type",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: party_type = [%s]\n", csTmp));
                      	PutField_CString(hTxnRec,"party_type",csTmp);
               	}

/* party_id */
                if (GetField_CString(hOrgTxnRec,"party_id",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: party_id = [%s]\n", csTmp));
                       	PutField_CString(hTxnRec,"party_id",csTmp);
             	}

/* txn_ccy */
            	if (GetField_CString(hOrgTxnRec,"txn_ccy",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: txn_ccy = [%s]\n", csTmp));
                     	PutField_CString(hTxnRec,"txn_ccy",csTmp);
                     	PutField_CString(hTxnRec,"ccy",csTmp);
              	}

/* txn_country */
            	if (GetField_CString(hOrgTxnRec,"txn_country",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: txn_country = [%s]\n", csTmp));
                      	PutField_CString(hTxnRec,"txn_country",csTmp);
                      	PutField_CString(hTxnRec,"country",csTmp);
              	}

/* txn_product */
           	if (GetField_CString(hTxnRec,"product_code",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: txn_product = [%s]\n", csTmp));
                      	PutField_CString(hTxnRec,"txn_product",csTmp);
             	}

/* txn_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn:: txn_date = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"txn_date",csTmp);
                }

/* report_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn:: report_date = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"report_date",csTmp);
                }

/* prev_grp_txn_id */
		if (GetField_CString(hOrgTxnRec,"txn_seq",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: prev_grp_txn_id = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"prev_grp_txn_id",csTmp);
                }

/* entity_ccy */
              	if (GetField_CString(hOrgTxnRec,"entity_ccy",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: entity_ccy = [%s]\n", csTmp));
                       	PutField_CString(hTxnRec,"entity_ccy",csTmp);
            	}

/* entity_txn_amount */
           	if (GetField_Double(hOrgTxnRec,"entity_txn_amount",&dTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: entity_txn_amount = [%f]\n", dTmp));
                 	PutField_Double(hTxnRec,"entity_txn_amount",dTmp);
             	}

/* acr_prorata */
               	PutField_Int(hTxnRec,"acr_prorata",PD_FALSE);
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: acr_prorata = [%d]\n", PD_FALSE));
	}

DEBUGLOG(("FormRspDeliveryInTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int	PrcoessRspDeliveryInTxn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec)
{
	int     iRet = PD_OK;

	int	iTmp = 0;

	double	dTmp = 0.0;

	char	*csTxnId = NULL;
	char    *csApprovalDate = NULL;
        char    *csApprovalTimestamp = NULL;

/* txn_seq */
        if (GetField_CString(hTxnRec, "txn_seq", &csTxnId)) {
DEBUGLOG(("PrcoessRspDeliveryInTxn:: txn_seq [%s]\n", csTxnId));
        }

	// Update Txn Header
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

				// Update TxnHeader
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call DBTransaction:: Update\n"));
              			DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
               			iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
             			if (iRet != PD_OK) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call DBTransaction:: Update Failed\n"));
                  			iRet = INT_ERR;
              			}
			}
		}
	}

	// Add and Update Txn Detail 
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add TxnDetail
                                if (iRet == PD_OK) {

DEBUGLOG(("PrcoessRspDeliveryInTxn::Call DBTransaction:: AddDetail\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call DBTransaction:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }

                                // Update TxnDetail
                                if (iRet == PD_OK) {

/*
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call DBTransaction:: Update\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call DBTransaction:: Update Failed\n"));
                                                iRet = INT_ERR;
                                        }
*/
                                }
                        }
                }
	}
	
	// Update Entity Balance
        if (iRet == PD_OK) {
	
		// batch_mode
                PutField_Char(hTxnRec, "batch_mode", PD_ONLINE);
DEBUGLOG(("PrcoessRspDeliveryInTxn::batch_mode = [%c]\n",PD_ONLINE));

                // amt_type
                PutField_CString(hTxnRec, "amt_type", PD_DR);
DEBUGLOG(("PrcoessRspDeliveryInTxn::amt_type = [%s]\n",PD_DR));

                // bal_type
                PutField_Char(hTxnRec, "bal_type", PD_MI_ENTITY_POOL_ACCT_BAL);
DEBUGLOG(("PrcoessRspDeliveryInTxn::bal_type = [%c]\n",PD_MI_ENTITY_POOL_ACCT_BAL));	
		
		// UpdateEntityBalance
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call BOMiEntityBalance:: UpdateEntityBalance\n"));
                BOObjPtr = CreateObj(BOPtr, "BOMiEntityBalance", "UpdateEntityBalance");
                iRet = (unsigned long)(*BOObjPtr)(hTxnRec,hTxnRec);
                if (iRet == PD_OK) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Success\n"));

                        if (GetField_CString(hTxnRec, "approval_date", &csApprovalDate)) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call BOMiEntityBalance:: approval_date [%s]\n", csApprovalDate));
                        }

                        if (GetField_CString(hTxnRec, "approval_timestamp", &csApprovalTimestamp))  {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call BOMiEntityBalance:: approval_timestamp [%s]\n", csApprovalTimestamp));
                        }

                        // Open Balance
                        if (GetField_Double(hTxnRec, "open_acct_bal", &dTmp)) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call BOMiEntityBalance:: open_acct_bal = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "open_intransit", &dTmp)) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call BOMiEntityBalance:: open_intransit = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "open_ar_bal", &dTmp)) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call BOMiEntityBalance:: open_ar_bal = [%f]\n", dTmp));
                        }

                        // Close Balance
                        if (GetField_Double(hTxnRec, "acct_bal", &dTmp)) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call BOMiEntityBalance:: closing acct_bal = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "intransit", &dTmp)) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call BOMiEntityBalance:: closing intransit = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "ar_bal", &dTmp)) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call BOMiEntityBalance:: closing ar_bal = [%f]\n", dTmp));
                        }

                } else {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n"));
ERRLOG("TxnMinByUsDLI::PrcoessRspDeliveryInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n");
                        iRet = INT_ERR;
                }	
	}

	// Add Txn Mi Detail
        if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add TxnMiDetail
                                if (iRet == PD_OK) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call DBTxnMiDetail:: Add\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Add");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call DBTxnMiDetail:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
	}

	// Add Mi Txn Log
        if (iRet == PD_OK) {

                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add MiTxnLog
                                if (iRet == PD_OK) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call DBTransaction:: AddMiTxnLog\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddMiTxnLog");
                                        iRet = (unsigned long)(*DBObjPtr)(csTxnId);
                                        if (iRet != PD_OK) {
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call DBTransaction:: AddMiTxnLog Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
        }

	// Update Status, Ar_Ind, Sub Status, Approval Date and Approval Timestamp
        if (iRet == PD_OK) {

/* status */
                PutField_Char(hTxnRec,"status",PD_COMPLETE);
DEBUGLOG(("PrcoessRspDeliveryInTxn::status [%c]\n", PD_COMPLETE));

/* ar_ind */
                PutField_Char(hTxnRec,"ar_ind",PD_ACCEPT);
DEBUGLOG(("PrcoessRspDeliveryInTxn::ar_ind [%c]\n", PD_ACCEPT));

/* sub_status */
                PutField_CString(hTxnRec,"sub_status",PD_APPROVED);
DEBUGLOG(("PrcoessRspDeliveryInTxn::sub_status [%s]\n", PD_APPROVED));

/* approval_date */
                PutField_CString(hTxnRec, "approval_date", csApprovalDate);
DEBUGLOG(("PrcoessRspDeliveryInTxn::approval_date [%s]\n", csApprovalDate));

/* approval_timestamp */
                PutField_CString(hTxnRec, "approval_timestamp", csApprovalTimestamp);
DEBUGLOG(("PrcoessRspDeliveryInTxn::approval_timestamp [%s]\n", csApprovalTimestamp));

DEBUGLOG(("PrcoessRspDeliveryInTxn::Call DBTransaction: Update \n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("PrcoessRspDeliveryInTxn::Call DBTransaction:: Update Failed\n"));
                }
        }

DEBUGLOG(("PrcoessRspDeliveryInTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessOpbFundIn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec)
{
        int     iRet = PD_OK;

	int	iTotalCnt = 0;
	int 	i = 0;
	int	iTmp = 0;

	double 	dTotalAmt = 0.0;
	double 	dTmp = 0.0;

	char	*csTmp = NULL;

	char    csTag[PD_TAG_LEN + 1];

DEBUGLOG(("===== ProcessOpbFundIn ===== START!!\n"));

/* total_cnt */
        if (GetField_Int(hTxnRec,"total_cnt",&iTotalCnt)) {
DEBUGLOG(("ProcessOpbFundIn::total_cnt = [%d]\n",iTotalCnt));
        } else {
DEBUGLOG(("ProcessOpbFundIn::total_cnt not found!!\n"));
ERRLOG("TxnMinByUsDLI::ProcessOpbFundIn::total_cnt not found!!\n");
                iRet = INT_MI_TOTAL_CNT_NOT_FOUND;
        }

        // Create Txn + Update Balance (with add approval_date, approval_timestamp)
        for (i=0; i<iTotalCnt; i++) {
		if (iRet == PD_OK) { 			
			sprintf(csTag, "seb_exist_%d", i+1);
			if (GetField_Int(hTxnRec, csTag, &iTmp)) {
DEBUGLOG(("ProcessOpbFundIn::[%s] = [%d]\n",csTag, iTmp));

/* seq */
				PutField_Int(hTxnRec,"seq",i+1);

/* txnamt */
				sprintf(csTag, "txnamt_%d", i+1);
                        	if (GetField_Double(hTxnRec, csTag, &dTmp)) {
DEBUGLOG(("ProcessOpbFundIn::[%s] = [%f]\n",csTag, dTmp));
					PutField_Double(hTxnRec,"txnamt",dTmp);
			
					// Set Total Amount
					dTotalAmt += dTmp;
/*
				} else {
DEBUGLOG(("ProcessOpbFundIn::[%s] not found!!\n",csTag));
ERRLOG("TxnMinByUsDLI::ProcessOpbFundIn::[%s] not found!!\n",csTag);
                                	iRet = INT_PAY_AMOUNT_NOT_FOUND;
*/
                        	}

/* deliver_date */
	                        sprintf(csTag, "deliver_date_%d", i+1);
	                        if (GetField_CString(hTxnRec, csTag, &csTmp)) {
DEBUGLOG(("ProcessOpbFundIn::[%s] = [%s]\n",csTag, csTmp));
					PutField_CString(hTxnRec,"deliver_date",csTmp);
	                        }

                		iRet = ProcessOpbFundInTxn(hContext, hRequest, hTxnRec);
			}
		}

/* total_txnamt */
		PutField_Double(hTxnRec,"total_txnamt",dTotalAmt);
        }

DEBUGLOG(("ProcessOpbFundIn:: iRet [%d]\n", iRet));
DEBUGLOG(("===== ProcessOpbFundIn ===== END !!\n"));

        return iRet;
}

int     ProcessOpbFundInTxn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec)
{
	int     iRet = PD_OK;

	int	iTmp = 0;

	double	dTmp = 0.0;

	char    *csApprovalDate = NULL;
        char    *csApprovalTimestamp = NULL;
	char    *csTmp = NULL;

	char    csTxnId[PD_TXN_SEQ_LEN + 1];
	char    csTxnDateTime[PD_DATETIME_LEN + 1];
	char    csTag[PD_TAG_LEN + 1];

	// Generate Next Txn Seq
        if (iRet == PD_OK) {
DEBUGLOG(("ProcessOpbFundInTxn:: Call DBTxnSeq: GetNextMgtTxnSeq\n"));
                DBObjPtr = CreateObj(DBPtr, "DBTxnSeq", "GetNextMgtTxnSeq");
                strcpy((char*)csTxnId, (*DBObjPtr)());

                PutField_CString(hTxnRec, "txn_seq", (const char *)csTxnId);
DEBUGLOG(("ProcessOpbFundInTxn:: Call DBTxnSeq: txn_seq = [%s]\n", csTxnId));
  		
		if (GetField_Int(hTxnRec,"seq",&iTmp)) {			
DEBUGLOG(("ProcessOpbFundInTxn:: seq [%d]\n", iTmp));

			sprintf(csTag, "txn_seq_%d", iTmp);
			PutField_CString(hTxnRec, csTag, (const char *)csTxnId);
DEBUGLOG(("ProcessOpbFundInTxn:: [%s] = [%s]\n", csTag, csTxnId));
		}
	}

	// Add Txn Log
	if (iRet == PD_OK) {

/* channel_code */
                PutField_CString(hTxnRec, "channel_code", PD_CHANNEL_MGT);

/* status */
                PutField_Char(hTxnRec,"status",PD_PROCESSING);
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: status [%c]\n", PD_PROCESSING));

/* txn_code */
                PutField_CString(hTxnRec, "txn_code", PD_MI_TXN_CODE_BANK_RECEIVE_FROM_RSP);
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: txn_code [%s]\n", PD_MI_TXN_CODE_BANK_RECEIVE_FROM_RSP));

/* process_type */
                PutField_CString(hTxnRec,"process_code", PD_PROCESS_CODE_DEF);
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: process_code [%s]\n", PD_PROCESS_CODE_DEF));

/* process_code */
                PutField_CString(hTxnRec,"process_type", PD_PROCESS_TYPE_DEF);
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: process_type [%s]\n", PD_PROCESS_TYPE_DEF));

/* response_code */
                PutField_CString(hTxnRec, "response_code", "0");
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: response_code [%s]\n", "0"));

/* internal_code */
                PutField_Int(hTxnRec, "internal_code", 0);
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: internal_code [%d]\n", 0));

/* host_posting_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: PHDATE [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"PHDATE",csTmp);
                }

/* transmission_datetime */
                if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: local_tm_date [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "local_tm_date", csTmp);
                        PutField_CString(hTxnRec, "tm_date", csTmp);

                        strcpy(csTxnDateTime, csTmp);
                        PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);

                        if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: local_tm_time [%s]\n", csTmp));
                                PutField_CString(hTxnRec, "local_tm_time", csTmp);
                                strcat(csTxnDateTime, csTmp);
                                PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);
                        }
                }

/* net_ccy */
                if (GetField_CString(hTxnRec,"ccy",&csTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: net_ccy = [%s]\n",csTmp));
                        PutField_CString(hTxnRec,"net_ccy",csTmp);
                }

/* net_amt */
                if (GetField_Double(hTxnRec,"txnamt",&dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: net_amt = [%lf]\n",dTmp));
                        PutField_Double(hTxnRec,"net_amt",dTmp);
                }

/* txn_amt */
                if (GetField_Double(hTxnRec,"txnamt",&dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: txn_amt = [%lf]\n",dTmp));
                        PutField_Double(hTxnRec,"txn_amt",dTmp);
                }

/* ex_supplier */
                 PutField_Char(hTxnRec,"ex_supplier",PD_INT_EX);
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: ex_supplier [%c]\n", PD_INT_EX));

/* ex_rate */
                PutField_Double(hTxnRec,"ex_rate",1);
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: ex_rate = [%lf]\n",1));

/* do_logging */
                PutField_Int(hTxnRec, "do_logging", PD_TRUE);
DEBUGLOG(("ProcessOpbFundInTxn:: do_logging [%d]\n", PD_TRUE));

/* db_commit */
                PutField_Int(hTxnRec, "db_commit", PD_FALSE);
DEBUGLOG(("ProcessOpbFundInTxn:: db_commit [%d]\n", PD_FALSE));

DEBUGLOG(("ProcessOpbFundInTxn:: Call MGTChannel: AddTxnLog\n"));
                ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnLog");
                iRet = (unsigned long)(*ChannelObjPtr)(hTxnRec,hRequest);
                if (iRet != PD_OK) {
DEBUGLOG(("ProcessOpbFundInTxn:: Call MGTChannel: AddTxnLog Failed\n"));
                        iRet = INT_ERR;
                }
	}

	// Update Txn Detail
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hTxnRec,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Update TxnDetail
                                if (iRet == PD_OK) {

DEBUGLOG(("ProcessOpbFundInTxn::Call DBTransaction:: Update\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessOpbFundInTxn::Call DBTransaction:: Update Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
        }

 	// Update Entity Balance
	if (iRet == PD_OK) {

/* entity_id */
           	if (GetField_CString(hTxnRec,"entity_id",&csTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::entity_id = [%s]\n", csTmp));
             	}

/* txn_ccy */
               	if (GetField_CString(hTxnRec,"txb_ccy",&csTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::txn_ccy = [%s]\n", csTmp));
             	}

/* txn_country */
             	if (GetField_CString(hTxnRec,"txn_country",&csTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::txn_country = [%s]\n", csTmp));
               	}

		// batch_mode
                PutField_Char(hTxnRec, "batch_mode", PD_ONLINE);
DEBUGLOG(("ProcessOpbFundInTxn::batch_mode = [%c]\n",PD_ONLINE));

                // amt_type
                PutField_CString(hTxnRec, "amt_type", PD_CR);
DEBUGLOG(("ProcessOpbFundInTxn::amt_type = [%s]\n",PD_CR));

                // bal_type
                PutField_Char(hTxnRec, "bal_type", PD_MI_ENTITY_POOL_ACCT_BAL);
DEBUGLOG(("ProcessOpbFundInTxn::bal_type = [%c]\n",PD_MI_ENTITY_POOL_ACCT_BAL));	
		
		// UpdateEntityBalance
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: UpdateEntityBalance\n"));
                BOObjPtr = CreateObj(BOPtr, "BOMiEntityBalance", "UpdateEntityBalance");
                iRet = (unsigned long)(*BOObjPtr)(hTxnRec,hTxnRec);
                if (iRet == PD_OK) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Success\n"));

                        if (GetField_CString(hTxnRec, "approval_date", &csApprovalDate)) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: approval_date [%s]\n", csApprovalDate));
                        }

                        if (GetField_CString(hTxnRec, "approval_timestamp", &csApprovalTimestamp))  {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: approval_timestamp [%s]\n", csApprovalTimestamp));
                        }

                        // Open Balance
                        if (GetField_Double(hTxnRec, "open_acct_bal", &dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: open_acct_bal = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "open_intransit", &dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: open_intransit = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "open_ar_bal", &dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: open_ar_bal = [%f]\n", dTmp));
                        }

                        // Close Balance
                        if (GetField_Double(hTxnRec, "acct_bal", &dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: closing acct_bal = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "intransit", &dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: closing intransit = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "ar_bal", &dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: closing ar_bal = [%f]\n", dTmp));
                        }

                } else {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n"));
ERRLOG("TxnMinByUsDLI::ProcessOpbFundInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n");
                        iRet = INT_ERR;
                }	
	}

	// Add Txn Mi Detail
	if (iRet == PD_OK) {

/* txnamt */
                if (GetField_Double(hTxnRec,"txnamt",&dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn:: txnamt = [%f]\n", dTmp));
                        PutField_Double(hTxnRec,"entity_txn_amount",dTmp);
                }

/* deliver_date */
		if (GetField_CString(hTxnRec, "deliver_date", &csTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::deliver_date = [%s]\n",csTmp));
                     	PutField_CString(hTxnRec,"report_date",csTmp);
                     	PutField_CString(hTxnRec,"txn_date",csTmp);
             	}

/* party_type */
		PutField_CString(hTxnRec,"party_type",PD_MI_ENTITY_OPBANK);
DEBUGLOG(("ProcessOpbFundInTxn::party_type [%s]\n", PD_MI_ENTITY_OPBANK));

/* txn_product */
                if (GetField_CString(hTxnRec,"product_code",&csTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::txn_product = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"txn_product",csTmp);
                }

/* acr_prorata */
                PutField_Int(hTxnRec,"acr_prorata",PD_FALSE);
DEBUGLOG(("ProcessOpbFundInTxn::acr_prorata = [%d]\n", PD_FALSE));

/* do_logging */
                if(GetField_Int(hTxnRec,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add TxnMiDetail
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessOpbFundInTxn::Call DBTxnMiDetail:: Add\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Add");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessOpbFundInTxn::Call DBTxnMiDetail:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
	}

	// Add Mi Txn Log
        if (iRet == PD_OK) {

                if(GetField_Int(hTxnRec,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add MiTxnLog
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessOpbFundInTxn::Call DBTransaction:: AddMiTxnLog\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddMiTxnLog");
                                        iRet = (unsigned long)(*DBObjPtr)((const char *)csTxnId);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessOpbFundInTxn::Call DBTransaction:: AddMiTxnLog Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
        }

	// Update Status, Ar_Ind, Sub Status, Approval Date and Approval Timestamp
	if (iRet == PD_OK) {

/* status */
                PutField_Char(hTxnRec,"status",PD_COMPLETE);
DEBUGLOG(("ProcessOpbFundInTxn::status [%c]\n", PD_COMPLETE));

/* ar_ind */
                PutField_Char(hTxnRec,"ar_ind",PD_ACCEPT);
DEBUGLOG(("ProcessOpbFundInTxn::ar_ind [%c]\n", PD_ACCEPT));

/* sub_status */
                PutField_CString(hTxnRec,"sub_status",PD_APPROVED);
DEBUGLOG(("ProcessOpbFundInTxn::sub_status [%s]\n", PD_APPROVED));

/* approval_date */
                PutField_CString(hTxnRec, "approval_date", csApprovalDate);
DEBUGLOG(("ProcessOpbFundInTxn::approval_date [%s]\n", csApprovalDate));

/* approval_timestamp */
                PutField_CString(hTxnRec, "approval_timestamp", csApprovalTimestamp);
DEBUGLOG(("ProcessOpbFundInTxn::approval_timestamp [%s]\n", csApprovalTimestamp));

/* do_logging */
                PutField_Int(hTxnRec, "do_logging", PD_FALSE);
DEBUGLOG(("ProcessOpbFundInTxn:: do_logging [%d]\n", PD_FALSE));

DEBUGLOG(("ProcessOpbFundInTxn::Call DBTransaction: Update \n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("ProcessOpbFundInTxn::Call DBTransaction:: Update Failed\n"));
                }
	}

DEBUGLOG(("ProcessOpbFundInTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessRspAmtDiff(hash_t* hContext, hash_t* hRequest, hash_t* hOrgTxnRec, hash_t* hTxnRec)
{
	int     iRet = PD_OK;

	int     iTotalCnt = 0;
        int 	i = 0;
	int     iTmp = 0;

	double	dTmp = 0.0;

	char	*csTmp = NULL;

        char    csTag[PD_TAG_LEN + 1];

DEBUGLOG(("===== ProcessRspAmtDiff ===== START!!\n"));

/* total_cnt */
        if (GetField_Int(hTxnRec,"total_cnt",&iTotalCnt)) {
DEBUGLOG(("ProcessRspAmtDiff::total_cnt = [%d]\n",iTotalCnt));
        } else {
DEBUGLOG(("ProcessRspAmtDiff::total_cnt not found!!\n"));
ERRLOG("TxnMinByUsDLI::ProcessRspAmtDiff::total_cnt not found!!\n");
                iRet = INT_MI_TOTAL_CNT_NOT_FOUND;
        }

	for (i=0; i<iTotalCnt; i++) {
        	if (iRet == PD_OK) {
                        sprintf(csTag, "amtdiff_exist_%d", i+1);
                        if (GetField_Int(hTxnRec, csTag, &iTmp)) {
DEBUGLOG(("ProcessRspAmtDiff::[%s] = [%d]\n",csTag, iTmp));

/* seq */
                                PutField_Int(hTxnRec,"seq",i+1);

/* amtdiff_reason */
	                        sprintf(csTag, "amtdiff_reason_%d", i+1);
	                        if (GetField_CString(hTxnRec, csTag, &csTmp)) {
DEBUGLOG(("ProcessRspAmtDiff::[%s] = [%s]\n",csTag, csTmp));
					PutField_CString(hTxnRec,"amtdiff_reason",csTmp);					
	                        }

/* amtdiff_ccy */
	                        sprintf(csTag, "amtdiff_ccy_%d", i+1);
	                        if (GetField_CString(hTxnRec, csTag, &csTmp)) {
DEBUGLOG(("ProcessRspAmtDiff::[%s] = [%s]\n",csTag, csTmp));
					PutField_CString(hTxnRec,"amtdiff_ccy",csTmp);					
	                        }

/* amtdiff_amt */
	                        sprintf(csTag, "amtdiff_amt_%d", i+1);
	                        if (GetField_Double(hTxnRec, csTag, &dTmp)) {
DEBUGLOG(("ProcessRspAmtDiff::[%s] = [%f]\n",csTag, dTmp));
					PutField_Double(hTxnRec,"amtdiff_amt",dTmp);					
				}

				// Form New Txn
                		iRet = FormRspAmtDiffTxn(hContext, hRequest, hOrgTxnRec, hTxnRec);
        		
				// Create Txn + Update Balance (with add approval_date, approval_timestamp)
				if (iRet == PD_OK) {
                                	iRet = ProcessRspAmtDiffTxn(hContext, hRequest, hTxnRec);
				}
                        }
                }
        }

DEBUGLOG(("ProcessRspAmtDiff:: iRet [%d]\n", iRet));
DEBUGLOG(("===== ProcessRspAmtDiff ===== END !!\n"));

        return iRet;
}

int     FormRspAmtDiffTxn(hash_t* hContext, hash_t* hRequest, hash_t* hOrgTxnRec, hash_t* hTxnRec)
{
	int     iRet = PD_OK;

        double  dTmp = 0.0;

        char    *csTmp = NULL;

	char    *csArCode = (char*) malloc (PD_MI_AR_CODE_LEN);

	char    csTxnId[PD_TXN_SEQ_LEN + 1];
        char    csTxnDateTime[PD_DATETIME_LEN + 1];

	hash_t  *hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec,0);

	// Generate Next Txn Seq
        if (iRet == PD_OK) {
DEBUGLOG(("FormRspAmtDiffTxn:: Call DBTxnSeq: GetNextMgtTxnSeq\n"));
                DBObjPtr = CreateObj(DBPtr, "DBTxnSeq", "GetNextMgtTxnSeq");
                strcpy((char*)csTxnId, (*DBObjPtr)());

                PutField_CString(hTxnRec, "txn_seq", (const char *)csTxnId);
DEBUGLOG(("FormRspAmtDiffTxn:: Call DBTxnSeq: txn_seq = [%s]\n", csTxnId));
        }

	// Txn Header
	if (iRet == PD_OK) {

/* channel_code */
                if (GetField_CString(hOrgTxnRec, "channel_code", &csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: channel_code [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "channel_code", csTmp);
                }

/* service_code */
                if (GetField_CString(hOrgTxnRec, "service_code", &csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: service_code [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "service_code", csTmp);
                }

/* status */
                PutField_Char(hTxnRec,"status",PD_PROCESSING);
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: status [%c]\n", PD_PROCESSING));

/* amtdiff_reason */
                if (GetField_CString(hTxnRec,"amtdiff_reason",&csArCode)) {

DEBUGLOG(("FormRspAmtDiffTxn::Call MiDefArBal:: GetArBalParameter\n"));
               		DBObjPtr = CreateObj(DBPtr,"DBMiDefArBal","GetArBalParameter");
                      	iRet = (unsigned long)(*DBObjPtr)(csArCode,hRec);
                     	if (iRet == PD_OK) {
						
/* txn_code */
				if (GetField_CString(hRec,"txn_code_map",&csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: txn_code [%s]\n", csTmp));
					PutField_CString(hTxnRec, "txn_code", csTmp);
				}

/* amt_type */
                           	if (GetField_CString(hRec,"amt_type",&csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: amt_type [%s]\n", csTmp));
                                      	PutField_CString(hTxnRec, "amt_type", csTmp);
                               	}  

			} else {
DEBUGLOG(("FormRspAmtDiffTxn::Call MiDefArBal:: GetArBalParameter Failed\n"));
                              	iRet = INT_ERR;
                    	}
                }

/* process_type */
                PutField_CString(hTxnRec,"process_code", PD_PROCESS_CODE_DEF);
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: process_code [%s]\n", PD_PROCESS_CODE_DEF));

/* process_code */
                PutField_CString(hTxnRec,"process_type", PD_PROCESS_TYPE_DEF);
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: process_type [%s]\n", PD_PROCESS_TYPE_DEF));

/* response_code */
                PutField_CString(hTxnRec, "response_code", "0");
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: response_code [%s]\n", "0"));

/* internal_code */
                PutField_Int(hTxnRec, "internal_code", 0);
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: internal_code [%d]\n", 0));

/* ip_addr */
                if (GetField_CString(hOrgTxnRec, "ip_addr", &csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: ip_addr [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "ip_addr", csTmp);
                }

/* host_posting_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: PHDATE [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"host_posting_date",csTmp);
                }

/* transmission_datetime */
                if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: local_tm_date [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "local_tm_date", csTmp);
                        PutField_CString(hTxnRec, "tm_date", csTmp);

                        strcpy(csTxnDateTime, csTmp);
                        PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);

                        if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: local_tm_time [%s]\n", csTmp));
                                PutField_CString(hTxnRec, "local_tm_time", csTmp);
                                strcat(csTxnDateTime, csTmp);
                                PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);
                        }
                }

/* net_ccy */
                if (GetField_CString(hTxnRec,"amtdiff_ccy",&csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: net_ccy = [%s]\n",csTmp));
                        PutField_CString(hTxnRec,"net_ccy",csTmp);
                }

/* net_amt */
                if (GetField_Double(hTxnRec,"amtdiff_amt",&dTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: net_amt = [%lf]\n",dTmp));
                        PutField_Double(hTxnRec,"net_amt",dTmp);
                }

/* txn_amt */
                if (GetField_Double(hTxnRec,"amtdiff_amt",&dTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: txn_amt = [%lf]\n",dTmp));
                        PutField_Double(hTxnRec,"txn_amt",dTmp);
                }

/* ex_supplier */
                 PutField_Char(hTxnRec,"ex_supplier",PD_INT_EX);
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: ex_supplier [%c]\n", PD_INT_EX));

/* ex_rate */
                PutField_Double(hTxnRec,"ex_rate",1);
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: ex_rate = [%lf]\n",1));

/* do_logging */
                PutField_Int(hTxnRec, "do_logging", PD_TRUE);
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: do_logging [%d]\n", PD_TRUE));

/* db_commit */
                PutField_Int(hTxnRec, "db_commit", PD_FALSE);
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: db_commit [%d]\n", PD_FALSE));

	}

	// Txn Detail
        if (iRet == PD_OK) {

/* txn_country */
                if (GetField_CString(hOrgTxnRec, "txn_country", &csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn (TxnLog):: txn_country = [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "txn_country", csTmp);
                }
        }

	// Txn Mi Detail
	if (iRet == PD_OK) {

/* entity_id */
                if (GetField_CString(hOrgTxnRec,"entity_id",&csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn::Call TxnMiDetail:GetTxnMiDetail: entity_id = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"entity_id",csTmp);
                }

/* party_type */
                if (GetField_CString(hOrgTxnRec,"party_type",&csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn::Call TxnMiDetail:GetTxnMiDetail: party_type = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"party_type",csTmp);
                }

/* party_id */
                if (GetField_CString(hOrgTxnRec,"party_id",&csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn::Call TxnMiDetail:GetTxnMiDetail: party_id = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"party_id",csTmp);
                }

/* txn_ccy */
		if (GetField_CString(hTxnRec,"amtdiff_ccy",&csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn::Call TxnMiDetail:GetTxnMiDetail: txn_ccy = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"txn_ccy",csTmp);
                        PutField_CString(hTxnRec,"ccy",csTmp);
                }

/* txn_country */
                if (GetField_CString(hOrgTxnRec,"txn_country",&csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn::Call TxnMiDetail:GetTxnMiDetail: txn_country = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"txn_country",csTmp);
                        PutField_CString(hTxnRec,"country",csTmp);
                }

/* txn_product */
                if (GetField_CString(hTxnRec,"product_code",&csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn::Call TxnMiDetail:GetTxnMiDetail: txn_product = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"txn_product",csTmp);
                }

/* txn_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn:: txn_date = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"txn_date",csTmp);
                }

/* report_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn:: report_date = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"report_date",csTmp);
                }

/* entity_ccy */
		if (GetField_CString(hTxnRec,"amtdiff_ccy",&csTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn::Call TxnMiDetail:GetTxnMiDetail: entity_ccy = [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"entity_ccy",csTmp);
                }

/* entity_txn_amount */
		if (GetField_Double(hTxnRec,"amtdiff_amt",&dTmp)) {
DEBUGLOG(("FormRspAmtDiffTxn::Call TxnMiDetail:GetTxnMiDetail: entity_txn_amount = [%f]\n", dTmp));
                        PutField_Double(hTxnRec,"entity_txn_amount",dTmp);
                }

/* acr_prorata */
                PutField_Int(hTxnRec,"acr_prorata",PD_FALSE);
DEBUGLOG(("ProcessOpbFundInTxn::acr_prorata = [%d]\n", PD_FALSE));
        }

	FREE_ME(csArCode);

	hash_destroy(hRec);
	FREE_ME(hRec);

DEBUGLOG(("FormRspAmtDiffTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;	
}

int     ProcessRspAmtDiffTxn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec)
{
        int     iRet = PD_OK;
	int     iDtlRet = PD_NOT_FOUND;

	int	iTmp = 0;

	double 	dTmp = 0.0;

	char	*csTxnId = NULL;
	char 	*csStatus = NULL;
	char    *csApprovalDate = NULL;
        char    *csApprovalTimestamp = NULL;
	char	*csTmp = NULL;

	char    csTag[PD_TAG_LEN + 1];

/* txn_seq */
        if (GetField_CString(hTxnRec, "txn_seq", &csTxnId)) {
DEBUGLOG(("ProcessRspAmtDiffTxn:: txn_seq [%s]\n", csTxnId));

		if (GetField_Int(hTxnRec,"seq",&iTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn:: seq [%d]\n", iTmp));

                        sprintf(csTag, "txn_seq_%d", iTmp);
                        PutField_CString(hTxnRec, csTag, csTxnId);
DEBUGLOG(("ProcessRspAmtDiffTxn:: [%s] = [%s]\n", csTag, csTxnId));
                }
	}
	
	// Add and Update Txn Header
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hTxnRec,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add TxnHeader
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTransaction:: Add\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","Add");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTransaction:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }

                                // Update TxnHeader
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTransaction:: Update\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTransaction:: Update Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
        }

	// Add and Update Txn Detail
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hTxnRec,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add TxnDetail
                                if (iRet == PD_OK) {

DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTransaction:: AddDetail\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTransaction:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }

                                // Update TxnDetail
                                if (iRet == PD_OK) {

/*
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTransaction:: Update\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTransaction:: Update Failed\n"));
                                                iRet = INT_ERR;
                                        }
*/
                                }
                        }
                }
	}

	// Update Entity Balance
	if (iRet == PD_OK) {

		// Check Entity Balance Acct Exist
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBMiEntityBalAcct:: GetEntityBalAcct\n"));
                DBObjPtr = CreateObj(DBPtr, "DBMiEntityBalAcct", "GetEntityBalAcct");
                iDtlRet = (unsigned long)(*DBObjPtr)(hTxnRec,hTxnRec);
                if (iDtlRet == PD_FOUND) {

/* status */
			if (GetField_CString(hTxnRec, "status", &csStatus)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBMiEntityBalAcct:: status = [%s]\n", csStatus));

				// Check Entity Bal Acct Status
				if (!strcmp(csStatus, PD_MI_ENTITY_BAL_ACCT_STATUS_CLOSE)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBMiEntityBalAcct:: GetEntityBalAcct Disabled\n"));
ERRLOG("TxnMinByUsDLI::ProcessRspAmtDiffTxn::Call DBMiEntityBalAcct:: GetEntityBalAcct Disabled\n");
                        		iRet = INT_MMS_ENTITY_BAL_ACCT_DISABLED;
				}
                        }	
	
		} else {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBMiEntityBalAcct:: GetEntityBalAcct Not Found\n"));
ERRLOG("TxnMinByUsDLI::ProcessRspAmtDiffTxn::Call DBMiEntityBalAcct:: GetEntityBalAcct Not Found\n");
                        iRet = INT_MMS_ENTITY_BAL_ACCT_NOT_FOUND;
		}
		
		if (iRet == PD_OK) {

/* entity_id */
                	if (GetField_CString(hTxnRec,"entity_id",&csTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::entity_id = [%s]\n", csTmp));
                	}

/* txn_ccy */
                	if (GetField_CString(hTxnRec,"txb_ccy",&csTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::txn_ccy = [%s]\n", csTmp));
                	}

/* txn_country */
                	if (GetField_CString(hTxnRec,"txn_country",&csTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::txn_country = [%s]\n", csTmp));
                	}

			// batch_mode
                	PutField_Char(hTxnRec, "batch_mode", PD_ONLINE);
DEBUGLOG(("ProcessRspAmtDiffTxn::batch_mode = [%c]\n",PD_ONLINE));

                	// amt_type
                	if (GetField_CString(hTxnRec,"amt_type",&csTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::amt_type = [%s]\n",csTmp));
				PutField_CString(hTxnRec, "amt_type", csTmp);
			}

                	// bal_type
                	PutField_Char(hTxnRec, "bal_type", PD_MI_ENTITY_POOL_AR_BAL);
DEBUGLOG(("ProcessRspAmtDiffTxn::bal_type = [%c]\n",PD_MI_ENTITY_POOL_AR_BAL));	
		
			// UpdateEntityBalance
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: UpdateEntityBalance\n"));
                	BOObjPtr = CreateObj(BOPtr, "BOMiEntityBalance", "UpdateEntityBalance");
                	iRet = (unsigned long)(*BOObjPtr)(hTxnRec,hTxnRec);
                	if (iRet == PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: UpdateEntityBalance Success\n"));

                        	if (GetField_CString(hTxnRec, "approval_date", &csApprovalDate)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: approval_date [%s]\n", csApprovalDate));
                        	}

                        	if (GetField_CString(hTxnRec, "approval_timestamp", &csApprovalTimestamp))  {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: approval_timestamp [%s]\n", csApprovalTimestamp));
                        	}

                        	// Open Balance
                        	if (GetField_Double(hTxnRec, "open_acct_bal", &dTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: open_acct_bal = [%f]\n", dTmp));
                        	}

                        	if (GetField_Double(hTxnRec, "open_intransit", &dTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: open_intransit = [%f]\n", dTmp));
                        	}

                        	if (GetField_Double(hTxnRec, "open_ar_bal", &dTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: open_ar_bal = [%f]\n", dTmp));
                        	}

                        	// Close Balance
                        	if (GetField_Double(hTxnRec, "acct_bal", &dTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: closing acct_bal = [%f]\n", dTmp));
                        	}

                        	if (GetField_Double(hTxnRec, "intransit", &dTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: closing intransit = [%f]\n", dTmp));
                        	}

                        	if (GetField_Double(hTxnRec, "ar_bal", &dTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: closing ar_bal = [%f]\n", dTmp));
                        	}

                	} else {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n"));
ERRLOG("TxnMinByUsDLI::ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n");
                        	iRet = INT_ERR;
                	}
		}	
	}

	// Add Txn Mi Detail
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hTxnRec,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add TxnMiDetail
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTxnMiDetail:: Add\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Add");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTxnMiDetail:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
	}

	// Add Mi Txn Log
        if (iRet == PD_OK) {

                if(GetField_Int(hTxnRec,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add MiTxnLog
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTransaction:: AddMiTxnLog\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddMiTxnLog");
                                        iRet = (unsigned long)(*DBObjPtr)(csTxnId);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTransaction:: AddMiTxnLog Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
        }

	// Update Status, Ar_Ind, Sub Status, Approval Date and Approval Timestamp
	if (iRet == PD_OK) {

/* status */
                PutField_Char(hTxnRec,"status",PD_COMPLETE);
DEBUGLOG(("ProcessRspAmtDiffTxn::status [%c]\n", PD_COMPLETE));

/* ar_ind */
                PutField_Char(hTxnRec,"ar_ind",PD_ACCEPT);
DEBUGLOG(("ProcessRspAmtDiffTxn::ar_ind [%c]\n", PD_ACCEPT));

/* sub_status */
                PutField_CString(hTxnRec,"sub_status",PD_APPROVED);
DEBUGLOG(("ProcessRspAmtDiffTxn::sub_status [%s]\n", PD_APPROVED));

/* approval_date */
                PutField_CString(hTxnRec, "approval_date", csApprovalDate);
DEBUGLOG(("ProcessRspAmtDiffTxn::approval_date [%s]\n", csApprovalDate));

/* approval_timestamp */
                PutField_CString(hTxnRec, "approval_timestamp", csApprovalTimestamp);
DEBUGLOG(("ProcessRspAmtDiffTxn::approval_timestamp [%s]\n", csApprovalTimestamp));

/* do_logging */
                PutField_Int(hTxnRec, "do_logging", PD_FALSE);
DEBUGLOG(("ProcessRspAmtDiffTxn:: do_logging [%d]\n", PD_FALSE));

DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTransaction: Update \n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTransaction:: Update Failed\n"));
                }
	}

DEBUGLOG(("ProcessRspAmtDiffTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessBatchInfo(hash_t* hBatchRec, hash_t* hRspDeliOutTxnRec, hash_t* hRspDeliInTxnRec, hash_t* hOpbFundInTxnRec, hash_t* hRspAmtDiffTxnRec)
{
	int     iRet = PD_OK;
	int     iDtlRet = PD_NOT_FOUND;

	int     iTotalCnt = 0;
	int	iSeq = 1;
	int     i = 0;
	int	iTmp = 0;
	
	char	*csTxnId = NULL;
	char	*csTmp = NULL;
		
	char    *csOrgBatchId = (char*) malloc (PD_MI_BATCH_ID_LEN);

	char    csBatchId[PD_TXN_SEQ_LEN + 1];
        char    csTag[PD_TAG_LEN + 1];

	hash_t *hOrgBatchRec;
	recordset_t *rOrgBatchRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rOrgBatchRecordSet,0);
	
/* txn_seq */
        if (GetField_CString(hRspDeliOutTxnRec,"txn_seq",&csTxnId)) {
DEBUGLOG(("ProcessBatchInfo::txn_id = [%s]\n",csTxnId));
        } else {
DEBUGLOG(("ProcessBatchInfo::txn_id not found!!\n"));
ERRLOG("TxnMinByUsDLI::ProcessBatchInfo::txn_id not found!!\n");
                iRet = INT_INVALID_TXN;
        }

	// Get Org Batch Id by Txn Id
	if (iRet == PD_OK) {

DEBUGLOG(("ProcessBatchInfo::Call DBMiBatchDetail::GetOrgBatchIdByTxnId:: txn_id [%s]\n",csTxnId));
       		DBObjPtr = CreateObj(DBPtr,"DBMiBatchDetail","GetOrgBatchIdByTxnId");
      		iDtlRet = (unsigned long)(*DBObjPtr)(csTxnId,PD_MI_BATCH_TXN_OPER_INSERT,hBatchRec);
       		if (iDtlRet == PD_FOUND) {
DEBUGLOG(("ProcessBatchInfo::Call DBMiBatchDetail::GetOrgBatchIdByTxnId Success\n"));

/* batch_id */
            		if (GetField_CString(hBatchRec,"batch_id",&csOrgBatchId)) {
DEBUGLOG(("ProcessBatchInfo::Call DBMiBatchDetail::GetOrgBatchIdByTxnId: batch_id = [%s]\n", csOrgBatchId));
     				PutField_CString(hBatchRec,"org_batch_id",csOrgBatchId);
           		}

    		} else {
DEBUGLOG(("ProcessBatchInfo::Call DBMiBatchDetail::GetOrgBatchIdByTxnId Failed\n"));
            		iRet = INT_ERR;
     		}
	}

	// Get Batch Detail by Batch Id
	if (iRet == PD_OK) {

DEBUGLOG(("ProcessBatchInfo::Call DBMiBatchDetail::GetAllDetailByBatchId:: org_batch_id [%s]\n",csOrgBatchId));
                DBObjPtr = CreateObj(DBPtr,"DBMiBatchDetail","GetAllDetailByBatchId");
                iDtlRet = (unsigned long)(*DBObjPtr)(csOrgBatchId,rOrgBatchRecordSet);
                if (iDtlRet == PD_FOUND) {
			hOrgBatchRec = RecordSet_GetFirst(rOrgBatchRecordSet);
                        while (hOrgBatchRec) {

/* txn_id */			
				if (GetField_CString(hOrgBatchRec, "txn_id", &csTmp)) {
DEBUGLOG(("ProcessBatchInfo::Call DBMiBatchDetail::GetAllDetailByBatchId:: txn_id = [%s]\n", csTmp));
                                }				
	
				hOrgBatchRec = RecordSet_GetNext(rOrgBatchRecordSet);
			}
		} else {
DEBUGLOG(("ProcessBatchInfo::Call DBMiBatchDetail::GetAllDetailByBatchId Failed\n"));
                        iRet = INT_ERR;
		}
	}

	// Generate Batch Id
	if (iRet == PD_OK) {
DEBUGLOG(("ProcessBatchInfo::Call TxnSeq:: GetNextMiActionBatchSeq\n"));
       		DBObjPtr = CreateObj(DBPtr, "DBTxnSeq", "GetNextMiActionBatchSeq");
    		strcpy(csBatchId, (*DBObjPtr)());

		PutField_CString(hBatchRec,"batch_id",csBatchId);
DEBUGLOG(("ProcessBatchInfo::Call TxnSeq:: GetNextMiActionBatchSeq: [%s]\n",csBatchId));
	}

	// Add Batch Header
       	if (iRet == PD_OK) {

           	// process_type
             	PutField_CString(hBatchRec,"process_type",PD_MI_TXN_TYPE_DELIV_IN);

              	// status
               	PutField_Char(hBatchRec,"status",PD_MI_BATCH_STATUS_NORMAL);

DEBUGLOG(("ProcessBatchInfo::Call MiBatchHeader:: Add\n"));
            	DBObjPtr = CreateObj(DBPtr, "DBMiBatchHeader", "Add");
             	iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
             	if (iRet != PD_OK) {
                     	iRet = INT_ERR;
DEBUGLOG(("ProcessBatchInfo::Call MiBatchHeader:: Add Failed\n"));
            	}
      	}

	// Add Batch Detail
       	if (iRet == PD_OK) {   

		// RSP Delivery In				
		if (iRet == PD_OK) {
DEBUGLOG(("ProcessBatchInfo::RSP Delivery In\n"));
	
			// txn_oper_ind
                	PutField_Char(hBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_INSERT);
DEBUGLOG(("ProcessBatchInfo::txn_oper_ind = [%c]\n", PD_MI_BATCH_TXN_OPER_INSERT));
	
                        // txn_id
                        if (GetField_CString(hRspDeliInTxnRec,"txn_seq",&csTmp)) { 
                       		PutField_CString(hBatchRec,"txn_id",csTmp);
DEBUGLOG(("ProcessBatchInfo::txn_id = [%d]\n", csTmp));
			}

                        // seq
                        PutField_Int(hBatchRec,"seq",iSeq++);
DEBUGLOG(("ProcessBatchInfo::seq = [%d]\n", iSeq));

			iRet = AddBatchDetail(hBatchRec, hRspDeliInTxnRec);
		}

		// OPB Fund In
                if (iRet == PD_OK) {
DEBUGLOG(("ProcessBatchInfo::OPB Fund In\n"));
		
			// total_cnt
			if (GetField_Int(hOpbFundInTxnRec,"total_cnt",&iTotalCnt)) {
				for (i=0; i<iTotalCnt; i++) {
                        		sprintf(csTag, "seb_exist_%d", i+1);
                        		if (GetField_Int(hOpbFundInTxnRec, csTag, &iTmp)) {
DEBUGLOG(("ProcessBatchInfo::[%s] = [%d]\n",csTag, iTmp));
		
						// txn_oper_ind
                				PutField_Char(hBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_INSERT);						
DEBUGLOG(("ProcessBatchInfo::txn_oper_ind = [%c]\n", PD_MI_BATCH_TXN_OPER_INSERT));

                        			// txn_id
                        			sprintf(csTag, "txn_seq_%d", i+1);
                        			if (GetField_CString(hOpbFundInTxnRec,csTag,&csTmp)) { 
                       					PutField_CString(hBatchRec,"txn_id",csTmp);
DEBUGLOG(("ProcessBatchInfo::txn_id = [%d]\n", csTmp));
						}

                        			// seq
                        			PutField_Int(hBatchRec,"seq",iSeq++);
DEBUGLOG(("ProcessBatchInfo::seq = [%d]\n", iSeq));

						iRet = AddBatchDetail(hBatchRec, hOpbFundInTxnRec);
					}	
				}
			}
		}

		// RSP Amt Diff
                if (iRet == PD_OK) {
DEBUGLOG(("ProcessBatchInfo::RSP Amt Diff\n"));
		
			// total_cnt
			if (GetField_Int(hRspAmtDiffTxnRec,"total_cnt",&iTotalCnt)) {
				for (i=0; i<iTotalCnt; i++) {
                        		sprintf(csTag, "amtdiff_exist_%d", i+1);
                        		if (GetField_Int(hRspAmtDiffTxnRec, csTag, &iTmp)) {
DEBUGLOG(("ProcessBatchInfo::[%s] = [%d]\n",csTag, iTmp));
					
						// txn_oper_ind
   		             			PutField_Char(hBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_INSERT);
DEBUGLOG(("ProcessBatchInfo::txn_oper_ind = [%c]\n", PD_MI_BATCH_TXN_OPER_INSERT));

                        			// txn_id
                        			sprintf(csTag, "txn_seq_%d", i+1);
                        			if (GetField_CString(hRspAmtDiffTxnRec,csTag,&csTmp)) { 
                       					PutField_CString(hBatchRec,"txn_id",csTmp);
DEBUGLOG(("ProcessBatchInfo::txn_id = [%d]\n", csTmp));
						}

                        			// seq
                        			PutField_Int(hBatchRec,"seq",iSeq++);
DEBUGLOG(("ProcessBatchInfo::seq = [%d]\n", iSeq));

						iRet = AddBatchDetail(hBatchRec, hRspAmtDiffTxnRec);
					}	
				}
			}
              	}
	
		// PSP Settlement, RSP Settlement and RSP Delivery Out
		if (iRet == PD_OK) {
DEBUGLOG(("ProcessBatchInfo::PSP Settlement, RSP Settlement and RSP Delivery Out\n"));

                        hOrgBatchRec = RecordSet_GetFirst(rOrgBatchRecordSet);
                        while (hOrgBatchRec) {

				if (iRet == PD_OK) {
				
					// txn_oper_ind
					PutField_Char(hBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_UPDATE);
DEBUGLOG(("ProcessBatchInfo::txn_oper_ind = [%c]\n", PD_MI_BATCH_TXN_OPER_UPDATE));

/* txn_id */
                              		if (GetField_CString(hOrgBatchRec, "txn_id", &csTmp)) {
DEBUGLOG(("ProcessBatchInfo::batch_txn_id = [%s]\n", csTmp));
						PutField_CString(hBatchRec,"txn_id",csTmp);
					}

                                	// seq
                               		PutField_Int(hBatchRec,"seq",iSeq++);
DEBUGLOG(("ProcessBatchInfo::seq = [%d]\n", iSeq));
	
        	                	iRet = AddBatchDetail(hBatchRec, hOrgBatchRec);
				}                              

                        	hOrgBatchRec = RecordSet_GetNext(rOrgBatchRecordSet);
			}
		}
      	}

	// Add Batch Relation
        if (iRet == PD_OK) {

		// relation_type
		PutField_Char(hBatchRec,"relation_type",PD_MI_BATCH_RELATION_TYPE_LINKAGE);	

DEBUGLOG(("ProcessBatchInfo::Call MiBatchRelation: Add \n"));
              	DBObjPtr = CreateObj(DBPtr, "DBMiBatchRelation", "Add");
              	iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
              	if (iRet != PD_OK) {
                    	iRet = INT_ERR;
DEBUGLOG(("ProcessBatchInfo::Call MiBatchRelation:: Add Failed\n"));
		}
	}	

	FREE_ME(csOrgBatchId);
	
	RecordSet_Destroy(rOrgBatchRecordSet);
        FREE_ME(rOrgBatchRecordSet);
	
DEBUGLOG(("ProcessBatchInfo Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     AddBatchDetail(hash_t* hBatchRec, hash_t* hTxnRec)
{
        int     iRet = PD_OK;

	char	*csTmp = NULL;
	
/* entity_id */
    	if (GetField_CString(hTxnRec,"entity_id",&csTmp)) {
DEBUGLOG(("AddBatchDetail::entity_id = [%s]\n", csTmp));
          	PutField_CString(hBatchRec,"entity_id",csTmp);
    	}

/* party_type */
       	if (GetField_CString(hTxnRec,"party_type",&csTmp)) {
DEBUGLOG(("AddBatchDetail::party_type = [%s]\n", csTmp));
               	PutField_CString(hBatchRec,"party_type",csTmp);
     	}

/* party_id */
    	if (GetField_CString(hTxnRec,"party_id",&csTmp)) {
DEBUGLOG(("AddBatchDetail::party_id = [%s]\n", csTmp));
              	PutField_CString(hBatchRec,"party_id",csTmp);
    	}

DEBUGLOG(("AddBatchDetail::Call MiBatchDetail: Add \n"));
     	DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
       	iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
       	if (iRet != PD_OK) {
           	iRet = INT_ERR;
DEBUGLOG(("AddBatchDetail::Call MiBatchDetail:: Add Failed\n"));
       	}

DEBUGLOG(("AddBatchDetail Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessBatchTxn(hash_t* hBatchRec, hash_t* hRspDeliOutTxnRec, hash_t* hRspDeliInTxnRec, hash_t* hOpbFundInTxnRec, hash_t* hRspAmtDiffTxnRec)
{
	int     iRet = PD_OK;
	int	iDtlRet  = PD_NOT_FOUND;

	char	cOperInd;

        char    *csBatchId = NULL;
        char    *csTxnId = NULL;
	char	*csTmp = NULL;

	hash_t  *hTxnHeader = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnHeader, 0);
	
	hash_t  *hTxnMiDetail = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnMiDetail, 0);

        hash_t *hRec;
        recordset_t *rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

/* update_user */
	if (GetField_CString(hBatchRec, "update_user", &csTmp)) {
DEBUGLOG(("ProcessBatchTxn:: upate_user [%s]\n", csTmp));
                PutField_CString(hTxnHeader, "update_user", csTmp);
        }

/* batch_id */
        if (GetField_CString(hBatchRec,"batch_id",&csBatchId)) {
DEBUGLOG(("ProcessBatchTxn::batch_id = [%s]\n",csBatchId));
        } else {
DEBUGLOG(("ProcessBatchTxn::batch_id not found!!\n"));
ERRLOG("TxnMinByUsDLI::ProcessBatchTxn::batch_id not found!!\n");
                iRet = INT_ERR;
        }

	// Get Batch Detail by Batch Id
        if (iRet == PD_OK) {

DEBUGLOG(("ProcessBatchTxn::Call DBMiBatchDetail::GetAllDetailByBatchId:: batch_id [%s]\n",csBatchId));
                DBObjPtr = CreateObj(DBPtr,"DBMiBatchDetail","GetAllDetailByBatchId");
                iDtlRet = (unsigned long)(*DBObjPtr)(csBatchId,rRecordSet);
                if (iDtlRet == PD_FOUND) {
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* txn_oper_ind */
                                if (GetField_Char(hRec, "oper_ind", &cOperInd)) {
		
					if (cOperInd == PD_MI_BATCH_TXN_OPER_UPDATE) {
DEBUGLOG(("ProcessBatchTxn::Call DBMiBatchDetail::GetAllDetailByBatchId:: oper_ind = [%c]\n", cOperInd));

/* txn_id */
                                                if (GetField_CString(hRec, "txn_id", &csTxnId)) {
DEBUGLOG(("ProcessBatchTxn:: txn_id [%s]\n", csTxnId));
							PutField_CString(hTxnHeader, "txn_seq", csTxnId);

/* sub_status */
        						PutField_CString(hTxnHeader, "sub_status", PD_DELIVERED);
DEBUGLOG(("ProcessBatchTxn:: sub_status [%s]\n", PD_DELIVERED));						

/* ex_supplier */
                 					//PutField_Char(hTxnHeader,"ex_supplier",PD_INT_EX);
DEBUGLOG(("ProcessBatchTxn:: ex_supplier [%c]\n", PD_INT_EX));

/* ex_rate */
                					//PutField_Double(hTxnHeader,"ex_rate",1);
DEBUGLOG(("ProcessBatchTxn:: ex_rate = [%lf]\n",1));

							// Update Txn Header	
DEBUGLOG(("ProcessBatchTxn::Call DBTransaction:: Update\n"));
                                        		DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                                        		iRet = (unsigned long)(*DBObjPtr)(hTxnHeader);
                                        		if (iRet != PD_OK) {
DEBUGLOG(("ProcessBatchTxn::Call DBTransaction:: Update Failed\n"));
                                                		iRet = INT_ERR;
                                        		}	
						}
					}
                                }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                } else {
DEBUGLOG(("ProcessBatchTxn::Call DBMiBatchDetail::GetAllDetailByBatchId Failed\n"));
                        iRet = INT_ERR;
                }
        }

	// RSP Delivery Out
	if (iRet == PD_OK) {
DEBUGLOG(("ProcessBatchTxn::RSP Delivery Out\n"));

/* txn_seq (delivery out) */
        	if (GetField_CString(hRspDeliOutTxnRec,"txn_seq",&csTmp)) {
DEBUGLOG(("ProcessBatchTxn:: txn_seq (delivery out) = [%s]\n", csTmp));
                	PutField_CString(hTxnMiDetail,"txn_seq",csTmp);
        	}

/* txn_seq (delivery in) */
        	if (GetField_CString(hRspDeliInTxnRec, "txn_seq", &csTmp)) {
DEBUGLOG(("ProcessBatchTxn:: next_grp_txn_id [%s]\n", csTmp));
                	PutField_CString(hTxnMiDetail,"next_grp_txn_id",csTmp);
        	}	

                // Update TxnMiDetail
DEBUGLOG(("ProcessBatchTxn::Call DBTxnMiDetail:: Update\n"));
               	DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Update");
            	iRet = (unsigned long)(*DBObjPtr)(hTxnMiDetail);
               	if (iRet != PD_OK) {
DEBUGLOG(("ProcessBatchTxn::Call DBTxnMiDetail:: Update Failed\n"));
                     	iRet = INT_ERR;
              	}
	}

	hash_destroy(hTxnHeader);
	FREE_ME(hTxnHeader);

	hash_destroy(hTxnMiDetail);
        FREE_ME(hTxnMiDetail);

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);	

DEBUGLOG(("ProcessBatchTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int	ProcessACR(hash_t* hContext, hash_t* hRequest, hash_t* hRspDeliOutTxnRec, hash_t* hOpbFundInTxnRec, hash_t* hBatchRec)
{
	int     iRet = PD_OK;

	int	iIsAcrBank = PD_FALSE;
	int	iSkipTolCheck = PD_FALSE;
	int	iSebCnt = 0;
	int	iTotalCnt = 0;
	int	i = 0;
	int	iTmp = 0;

	double  dThreshold = 0.0;
        double  dDiff = 0.0;
	double	dTmp = 0.0;

	char	*csFrCcy = NULL;
	char	*csBankCcy = NULL;
	char	*csUser = NULL;
	char	*csTmp = NULL;

	char    csTag[PD_TAG_LEN + 1];
	char    csTxnId[PD_TMP_BUF_LEN + 1];
        char    csCmd[PD_TMP_BUF_LEN*2 + 1];

	hash_t *hAcr;
        hAcr = (hash_t*) malloc (sizeof(hash_t));
       	hash_init(hAcr,0);	

	hash_t *hChk;
        hChk = (hash_t*) malloc (sizeof(hash_t));
      	hash_init(hChk,0);

/* is_acr_bank */
        if (GetField_Int(hOpbFundInTxnRec,"is_acr_bank",&iIsAcrBank)) {
DEBUGLOG(("ProcessACR::is_acr_bank = [%d]\n",iIsAcrBank));
		PutField_Int(hAcr,"is_acr_bank",iIsAcrBank);
        }

/* skip_tol_check */
        if (GetField_Int(hOpbFundInTxnRec,"skip_tol_check",&iSkipTolCheck)) {
DEBUGLOG(("ProcessACR::skip_tol_check = [%d]\n",iSkipTolCheck));
	}

        if (iIsAcrBank == PD_TRUE) {

/* net_ccy */
       		if(GetField_CString(hRspDeliOutTxnRec,"net_ccy",&csFrCcy)){
DEBUGLOG(("ProcessACR:: net_ccy = [%s]\n",csFrCcy));
			PutField_CString(hAcr, "from_ccy", csFrCcy);
			PutField_CString(hChk, "fr_ccy", csFrCcy);
   		}

/* net_amt */
       		if(GetField_Double(hRspDeliOutTxnRec,"net_amt",&dTmp)){
DEBUGLOG(("ProcessACR:: net_amt = [%lf]\n",dTmp)); 
			PutField_Double(hAcr, "from_amt", dTmp); 
			PutField_Double(hChk, "fr_txnamt", dTmp); 
      		}

/* entity_id */
        	if (GetField_CString(hOpbFundInTxnRec,"entity_id",&csTmp)) {
DEBUGLOG(("ProcessACR:: entity_id = [%s]\n",csTmp));
			PutField_CString(hAcr,"entity_id",csTmp);
			PutField_CString(hChk,"entity_id",csTmp);
        	}

/* entity_type */
		if (GetField_CString(hOpbFundInTxnRec,"entity_type",&csTmp)) {
DEBUGLOG(("ProcessACR:: entity_type = [%s]\n",csTmp));
			PutField_CString(hAcr,"entity_type",csTmp);
        	}

/* bank_id */
		if (GetField_CString(hOpbFundInTxnRec,"bank_id",&csTmp)) {
DEBUGLOG(("ProcessACR:: bank_id = [%s]\n",csTmp));
			PutField_CString(hAcr,"bank_id",csTmp);
        	}

/* txn_code */
		if (GetField_CString(hOpbFundInTxnRec,"txn_code",&csTmp)) {
DEBUGLOG(("ProcessACR:: txn_code = [%s]\n",csTmp));
			PutField_CString(hAcr, "txn_code", csTmp);
        	}

/* txn_ccy */
        	if (GetField_CString(hOpbFundInTxnRec,"txn_ccy",&csBankCcy)) {
DEBUGLOG(("ProcessACR:: txn_ccy = [%s]\n",csBankCcy));
			PutField_CString(hAcr, "bank_ccy", csBankCcy);
			PutField_CString(hChk, "txn_ccy", csBankCcy);
        	}

/* total_txnamt */
		if(GetField_Double(hOpbFundInTxnRec,"total_txnamt",&dTmp)){
DEBUGLOG(("ProcessACR:: total_txnamt = [%lf]\n",dTmp));
			PutField_Double(hAcr, "bank_amt", dTmp);
			PutField_Double(hChk, "txn_amt", dTmp);
        	}

/* bank_base_ccy */
        	if (GetField_CString(hOpbFundInTxnRec,"bank_base_ccy",&csTmp)) {
DEBUGLOG(("ProcessACR:: bank_base_ccy = [%s]\n",csTmp));
			PutField_CString(hAcr,"base_ccy",csTmp);
        	}

/* txn_date */
		if(GetField_CString(hOpbFundInTxnRec,"txn_date",&csTmp)){
DEBUGLOG(("ProcessACR:: txn_date = [%s]\n",csTmp));
			PutField_CString(hAcr,"txn_date",csTmp);
        	}

/* update_user */
                if(GetField_CString(hOpbFundInTxnRec,"add_user",&csUser)){
DEBUGLOG(("ProcessACR:: update_user = [%s]\n",csUser));
                        PutField_CString(hAcr,"add_user",csUser);
                        PutField_CString(hAcr,"update_user",csUser);
                }

/* seb_cnt */
		if (GetField_Int(hOpbFundInTxnRec,"seb_cnt",&iSebCnt)) {
DEBUGLOG(("ProcessACR:: seb_cnt = [%d]\n",iSebCnt));
			PutField_Int(hAcr,"txn_cnt",iSebCnt);
		}

/* total_cnt */
        	if (GetField_Int(hOpbFundInTxnRec,"total_cnt",&iTotalCnt)) {
DEBUGLOG(("ProcessACR:: total_cnt = [%d]\n",iTotalCnt));

			if (iSebCnt > 1) {

				for (i=0; i<iTotalCnt; i++) {
	
					sprintf(csTag, "seb_exist_%d", i+1);
        	                	if (GetField_Int(hOpbFundInTxnRec, csTag, &iTmp)) {
	
						sprintf(csTag, "txn_seq_%d", i+1);
                	                        if (GetField_CString(hOpbFundInTxnRec,csTag,&csTmp)) {
DEBUGLOG(("ProcessACR:: [%s] = [%s]\n",csTag,csTmp));

							sprintf(csTag, "txn_id_%d", i);
                        	       	              	PutField_CString(hAcr,csTag,csTmp);
	
							if (i == 0) {
								sprintf(csTxnId, "%s", csTmp);
							} else {
								sprintf(csTxnId, "%s,%s", csTxnId, csTmp);
							}
DEBUGLOG(("ProcessACR:: txn_id = [%s]\n",csTxnId));
                	                        }
					}
				}
			} else {
			
				for (i=0; i<iTotalCnt; i++) {

                                        sprintf(csTag, "seb_exist_%d", i+1);
                                        if (GetField_Int(hOpbFundInTxnRec, csTag, &iTmp)) {

                                                sprintf(csTag, "txn_seq_%d", i+1);
                                                if (GetField_CString(hOpbFundInTxnRec,csTag,&csTmp)) {
DEBUGLOG(("ProcessACR:: [%s] = [%s]\n",csTag,csTmp));

                                                        PutField_CString(hAcr,"txn_id",csTmp);
							sprintf(csTxnId, "%s", csTmp);
DEBUGLOG(("ProcessACR:: txn_id = [%s]\n",csTxnId));
                                                }
                                        }
                                }				
			}
		}

/* batch_id */
		if (GetField_CString(hBatchRec,"batch_id",&csTmp)) {
DEBUGLOG(("ProcessACR:: batch_id = [%s]\n", csTmp));
			PutField_CString(hAcr,"batch_id",csTmp);                  
        	}

/* is_void */
		PutField_Int(hAcr,"is_void",PD_FALSE);
DEBUGLOG(("ProcessACR:: is_void = [%d]\n", PD_FALSE));

/* fund_type */
 		PutField_Char(hAcr, "fund_type", PD_FUNDS_IN);	
DEBUGLOG(("ProcessACR:: fund_type = [%c]\n", PD_FUNDS_IN));

DEBUGLOG(("ProcessACR::Call BOMiAcr::CalculateACR \n"));
             	BOObjPtr = CreateObj(BOPtr,"BOMiAcr","CalculateACR");
             	iRet = (unsigned long) ((*BOObjPtr)(hAcr));
		if (iRet != PD_OK) {
DEBUGLOG(("ProcessACR::Call BOMiAcr::CalculateACR Failed\n"));
                    	iRet = INT_ERR;
		}  

		// ACR Tolerance Checking and send Email
		if (iRet == PD_OK) {
			if (iSkipTolCheck == PD_TRUE) {

DEBUGLOG(("ProcessACR::Call TxnMgtByUsCHK::Authorize\n"));
				TxnObjPtr = CreateObj(TxnPtr,"TxnMgtByUsCHK","Authorize");
                                iRet = (unsigned long) ((*TxnObjPtr)(hChk,hChk,hChk));

				if ((iRet==INT_LARGE_DIFF_NEW_RATE)
				   || (iRet==INT_LARGE_DIFF_OANDA_NEW_RATE)
				)
				{

/* acr_tol_threshold */
                                        if (GetField_Double(hChk,"acr_tol_threshold",&dThreshold)) {
DEBUGLOG(("ProcessACR:: acr_tol_threshold = [%f]\n",dThreshold));
					}

/* acr_input_diff */
                    	                if (GetField_Double(hChk,"acr_input_diff",&dDiff)) {
DEBUGLOG(("ProcessACR:: acr_input_diff = [%f]\n",dDiff));				
					}

DEBUGLOG(("ProcessACR:: send email\n"));
                                        sprintf(csCmd,"fundin_alert.sh %s %s %d %d %.2f %.2f %.2f %s %s",
                                                        csTxnId,csUser,iRet,iSkipTolCheck,
                                                        dDiff,dThreshold,dThreshold,
                                                        csFrCcy,csBankCcy);

                                        system(csCmd);
DEBUGLOG(("ProcessACR:: csCmd = [%s]\n",csCmd));

                                        iRet = PD_OK;
                                }
			}
		}
        }

	hash_destroy(hAcr);
	FREE_ME(hAcr);

	hash_destroy(hChk);
	FREE_ME(hChk);

DEBUGLOG(("ProcessACR Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

