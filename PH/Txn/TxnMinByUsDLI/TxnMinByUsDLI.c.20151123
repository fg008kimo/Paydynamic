/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/11/19              Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMinByUsDLI.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Channel);


int     PrcoessRspDeliveryIn(hash_t* hContext, hash_t* hRequest, hash_t* hOrgTxnRec, hash_t* hTxnRec);
int	GetRspDeliveryOutTxnInfo(hash_t* hTxnRec);
int     FormRspDeliveryInTxn(hash_t* hContext, hash_t* hRequest, hash_t* hOrgTxnRec, hash_t* hTxnRec);
int	ProcessRspDeliveryInTxn(hash_t* hContext, hash_t* hRequest,hash_t* hTxnRec);

//int     ProcessOpbFundIn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec);
//int     ProcessOpbFundInTxn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec);
//int     ProcessRspAmtDiff(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec);
//int     ProcessRspAmtDiffTxn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec);
//int     AddBatchInfo(hash_t* hBatchRec, hash_t* hRspDeliOutTxnRec, hash_t* hRspDeliInTxnRec, hash_t* hOpbFundInTxnRec, hash_t* hRspAmtDiffTxnRec);

void TxnMinByUsDLI(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
		  hash_t* hRequest,
		  hash_t* hResponse)
{
        int	iRet = PD_OK;
	int     iDtlRet = PD_OK;

	int     i = 0;
        int     iSebCnt = 0;
        int     iAmtDiffCnt = 0;
        int     iTotalCnt = 0;

        double  dTmp = 0.0;

        char    *csTmp = NULL;

	char    csTag[PD_TAG_LEN + 1];

        hash_t  *hRspDeliOutTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRspDeliOutTxnRec,0);

        hash_t  *hRspDeliInTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRspDeliInTxnRec,0);

        hash_t  *hOpbFundInTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hOpbFundInTxnRec,0);

        hash_t  *hRspAmtDiffTxnRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRspAmtDiffTxnRec,0);

	hash_t *hBatchRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBatchRec, 0);

DEBUGLOG(("Authorize::TxnMinByUsDLI Begin\n"));

/* txn_seq */
        if (GetField_CString(hContext,"txn_seq",&csTmp)) {
DEBUGLOG(("Authorize::txn_seq = [%s]\n",csTmp));
		PutField_CString(hRspDeliInTxnRec,"txn_seq",csTmp);
        } else {
DEBUGLOG(("Authorize::txn_seq not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::txn_seq not found!!\n");
                iRet = INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* org_txn_id */
        if (GetField_CString(hContext,"org_txn_id",&csTmp)) {
DEBUGLOG(("Authorize::org_txn_id = [%s]\n",csTmp));
		PutField_CString(hRspDeliOutTxnRec,"txn_seq",csTmp);
		PutField_CString(hRspDeliInTxnRec,"org_txn_seq",csTmp);
        } else {
DEBUGLOG(("Authorize::org_txn_id not found!!\n"));
ERRLOG("TxnMinByUsDLI:Authorize::org_txn_id not found!!\n");
                iRet=INT_INVALID_TXN;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* entity_id */
        if (GetField_CString(hContext,"entity_id",&csTmp)) {
DEBUGLOG(("Authorize::entity_id = [%s]\n",csTmp));
                PutField_CString(hOpbFundInTxnRec, "entity_id", csTmp);
        } else {
DEBUGLOG(("Authorize::entity_id not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::entity_id not found!!\n");
                iRet = INT_MI_ENTITY_ID_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* product_code */
        if (GetField_CString(hContext,"product_code",&csTmp)) {
DEBUGLOG(("Authorize::product_code = [%s]\n",csTmp));
                PutField_CString(hOpbFundInTxnRec,"product_code",csTmp);
        } else {
DEBUGLOG(("Authorize::product_code not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::product_code not found!!\n");
                iRet = INT_MI_PRODUCT_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* txn_ccy */
        if (GetField_CString(hContext,"txn_ccy",&csTmp)) {
DEBUGLOG(("Authorize::txn_ccy = [%s]\n",csTmp));
                PutField_CString(hOpbFundInTxnRec, "txn_ccy", csTmp);
                PutField_CString(hOpbFundInTxnRec, "ccy", csTmp);
                PutField_CString(hOpbFundInTxnRec,"net_ccy",csTmp);
                PutField_CString(hOpbFundInTxnRec, "org_txn_ccy", csTmp);
                PutField_CString(hOpbFundInTxnRec, "entity_ccy", csTmp);
        } else {
DEBUGLOG(("Authorize::ccy not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::ccy not found!!\n");
                iRet=INT_CURRENCY_CODE_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* remark */
        if (GetField_CString(hRequest,"remark",&csTmp)){
DEBUGLOG(("Authorize::remark = [%s]\n",csTmp));
		PutField_CString(hRspDeliInTxnRec,"remark",csTmp);
		PutField_CString(hOpbFundInTxnRec,"remark",csTmp);
		PutField_CString(hRspAmtDiffTxnRec,"remark",csTmp);
        }

/* mini_txn_type */
        if (GetField_CString(hContext,"mini_txn_type",&csTmp)) {
DEBUGLOG(("Authorize::mini_txn_type = [%s]\n",csTmp));
                PutField_CString(hRspDeliInTxnRec,"mini_txn_type",csTmp);
                PutField_CString(hOpbFundInTxnRec,"mini_txn_type",csTmp);
                PutField_CString(hRspAmtDiffTxnRec,"mini_txn_type",csTmp);
        }

/* add_user */
        if (GetField_CString(hContext,"add_user",&csTmp)) {
DEBUGLOG(("Authorize::add_user = [%s]\n",csTmp));
                PutField_CString(hRspDeliInTxnRec,"add_user",csTmp);
                PutField_CString(hOpbFundInTxnRec,"add_user",csTmp);
                PutField_CString(hRspAmtDiffTxnRec,"add_user",csTmp);
                
		PutField_CString(hRspDeliInTxnRec,"update_user",csTmp);
                PutField_CString(hOpbFundInTxnRec,"update_user",csTmp);
                PutField_CString(hRspAmtDiffTxnRec,"update_user",csTmp);
        }

/* update_user */
        if (GetField_CString(hContext,"update_user",&csTmp)) {
DEBUGLOG(("Authorize::update_user = [%s]\n",csTmp));
        }

/* seb_cnt */
        if (GetField_Int(hContext,"seb_cnt",&iSebCnt)) {
DEBUGLOG(("Authorize::seb_cnt = [%d]\n",iSebCnt));
		PutField_Int(hOpbFundInTxnRec,"seb_cnt",iSebCnt);
        } else {
DEBUGLOG(("Authorize::seb_cnt not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::seb_cnt not found!!\n");
                iRet = INT_MI_SEB_CNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

/* amtdiff_cnt */
        if (GetField_Int(hContext,"amtdiff_cnt",&iAmtDiffCnt)) {
DEBUGLOG(("Authorize::amtdiff_cnt = [%d]\n",iAmtDiffCnt));
		PutField_Int(hRspAmtDiffTxnRec,"amtdiff_cnt",iAmtDiffCnt);
        }

/* total_cnt */
        if (GetField_Int(hContext,"total_cnt",&iTotalCnt)) {
DEBUGLOG(("Authorize::total_cnt = [%d]\n",iTotalCnt));
		PutField_Int(hOpbFundInTxnRec,"total_cnt",iTotalCnt);
		PutField_Int(hRspAmtDiffTxnRec,"total_cnt",iTotalCnt);
        } else {
DEBUGLOG(("Authorize::total_cnt not found!!\n"));
ERRLOG("TxnMinByUsDLI::Authorize::total_cnt not found!!\n");
                iRet = INT_MI_TOTAL_CNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }
	
	// total_cnt
	if (iRet == PD_OK) {
                for (i=0; i<iTotalCnt; i++) {

/* txnamt */
                        sprintf(csTag, "txnamt_%d", i+1);
                        if (GetField_Double(hContext, csTag, &dTmp)) {
DEBUGLOG(("Authorize::[%s] = [%f]\n",csTag, dTmp));
				PutField_Double(hOpbFundInTxnRec,csTag,dTmp);

				// Set Seb Exist
				sprintf(csTag, "seb_exist_%d", i+1);
				PutField_Int(hOpbFundInTxnRec,csTag,1);
                        } else {
DEBUGLOG(("Authorize::[%s] not found!!\n",csTag));
ERRLOG("TxnMinByUsDLI::Authorize::[%s] not found!!\n",csTag);
                                iDtlRet = INT_PAY_AMOUNT_NOT_FOUND;
                                PutField_Int(hContext,"internal_error",iRet);
                        }

/* deliver_date */
                        sprintf(csTag, "deliver_date_%d", i+1);
                        if (GetField_CString(hContext, csTag, &csTmp)) {
DEBUGLOG(("Authorize::[%s] = [%s]\n",csTag, csTmp));
				PutField_CString(hOpbFundInTxnRec,csTag,csTmp);
                        }

/* amtdiff_reason */
                        sprintf(csTag, "amtdiff_reason_%d", i+1);
                        if (GetField_CString(hContext, csTag, &csTmp)) {
DEBUGLOG(("Authorize::[%s] = [%s]\n",csTag, csTmp));
				PutField_CString(hRspAmtDiffTxnRec,csTag,csTmp);
                        }

/* amtdiff_ccy */
                        sprintf(csTag, "amtdiff_ccy_%d", i+1);
                        if (GetField_CString(hContext, csTag, &csTmp)) {
DEBUGLOG(("Authorize::[%s] = [%s]\n",csTag, csTmp));
				PutField_CString(hRspAmtDiffTxnRec,csTag,csTmp);
                        }

/* amtdiff_amt */
                        sprintf(csTag, "amtdiff_amt_%d", i+1);
                        if (GetField_Double(hContext, csTag, &dTmp)) {
DEBUGLOG(("Authorize::[%s] = [%f]\n",csTag, dTmp));
				PutField_Double(hRspAmtDiffTxnRec,csTag,dTmp);

				// Set Amt Diff Exist
                                sprintf(csTag, "amt_diff_exist_%d", i+1);
                                PutField_Int(hRspAmtDiffTxnRec,csTag,1);
                        }
                }
        }

	// Generate Rsp Delivery In Txn and Debit Rsp Available Balance 
	if (iRet == PD_OK) { 
		iRet = PrcoessRspDeliveryIn(hContext, hRequest, hRspDeliOutTxnRec, hRspDeliInTxnRec);
	}

#if 0
	// Generate Op Bank Txn and Credit Op Bank Balance
	if (iRet == PD_OK) {
		iRet = ProcessOpbFundIn(hContext, hRequest, hOpbFundInTxnRec);
	}

	// Generate Amt Diff Txn
        if (iRet == PD_OK) {
                iRet = ProcessRspAmtDiff(hContext, hRequest, hRspAmtDiffTxnRec);
        }

	// Add Batch Info
	if (iRet == PD_OK) {
		iRet = AddBatchInfo(hBatchRec, hRspDeliOutTxnRec, hRspDeliInTxnRec, hOpbFundInTxnRec, hRspAmtDiffTxnRec);
	}
#endif

	FREE_ME(hRspDeliOutTxnRec);
	FREE_ME(hRspDeliInTxnRec);
	FREE_ME(hOpbFundInTxnRec);
	FREE_ME(hRspAmtDiffTxnRec);
	FREE_ME(hBatchRec);

DEBUGLOG(("TxnMinByUsDLI Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     PrcoessRspDeliveryIn(hash_t* hContext, hash_t* hRequest, hash_t* hOrgTxnRec, hash_t* hTxnRec)
{
	int     iRet = PD_OK;

DEBUGLOG(("===== PrcoessRspDeliveryIn ===== START!!\n"));

	// Lock Org Txn + Get Org Txn
	iRet = GetRspDeliveryOutTxnInfo(hOrgTxnRec);
	if (iRet == INT_ERR) {
DEBUGLOG(("PrcoessRspDeliveryIn::GetRspDeliveryOutTxnInfo Failed\n"));
ERRLOG("TxnMinByUsDLI::PrcoessRspDeliveryIn::GetRspDeliveryOutTxnInfo Failed\n");
         	iRet = INT_INVALID_TXN;
            	PutField_Int(hContext,"internal_error",iRet);
       	}

	// Form New Txn
	if (iRet == PD_OK) {
		iRet = FormRspDeliveryInTxn(hContext, hRequest, hOrgTxnRec, hTxnRec);
	}	

	// Create Txn + Update Balance (with add approval_date, approval_timestamp)
	if (iRet == PD_OK) {
		iRet = ProcessRspDeliveryInTxn(hContext, hRequest, hTxnRec);
	}

DEBUGLOG(("PrcoessRspDeliveryIn:: iRet [%d]\n", iRet));
DEBUGLOG(("===== PrcoessRspDeliveryIn ===== END !!\n"));	

        return iRet;
}

int	GetRspDeliveryOutTxnInfo(hash_t* hTxnRec)
{
	int     iRet = PD_OK;

	int	iTmp = 0;

	double	dTmp = 0.0;

	char    *csTxnId = (char*) malloc (PD_TXN_SEQ_LEN);
	char	*csTmp = NULL;

	hash_t  *hRec = NULL;	

	recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);

/* txn_seq */
        if (GetField_CString(hTxnRec,"txn_seq",&csTxnId)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::txn_id = [%s]\n",csTxnId));
        } else {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::txn_id not found!!\n"));
ERRLOG("TxnMinByUsDLI::GetRspDeliveryOutTxnInfo::txn_id not found!!\n");
                iRet = INT_INVALID_TXN;
        } 

	// Get Txn Header
      	if(iRet==PD_OK){
		recordset_init(rRecordSet,0);

DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call DBTransaction::GetTxnHeader:: txn_id [%s]\n",csTxnId));
            	DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
              	iRet = (unsigned long)(*DBObjPtr)(csTxnId,rRecordSet);
		if (iRet == PD_OK) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call DBTransaction::GetTxnHeader Success\n"));
                 	hRec = RecordSet_GetFirst(rRecordSet);
                     	while (hRec) {

/* channel_code */
				if(GetField_CString(hRec,"channel_code",&csTmp)){
DEBUGLOG(("GetRspDeliveryOutTxnInfo::channel_code = [%s]\n",csTmp));
                                        PutField_CString(hTxnRec,"channel_code",csTmp);
                                }

/* net_ccy */
				if(GetField_CString(hRec,"net_ccy",&csTmp)){
DEBUGLOG(("GetRspDeliveryOutTxnInfo::net_ccy = [%s]\n",csTmp));
					PutField_CString(hTxnRec,"net_ccy",csTmp);
                                }

/* net_amt */
                            	if(GetField_Double(hRec,"net_amt",&dTmp)){
DEBUGLOG(("GetRspDeliveryOutTxnInfo::net_amt = [%lf]\n",dTmp));
                                	PutField_Double(hTxnRec,"net_amt",dTmp);	   
				}

/* txn_amt */
                                if(GetField_Double(hRec,"txn_amt",&dTmp)){
DEBUGLOG(("GetRspDeliveryOutTxnInfo::txn_amt = [%lf]\n",dTmp));
                                        PutField_Double(hTxnRec,"txn_amt",dTmp);  
                                }

                              	hRec = RecordSet_GetNext(rRecordSet);
                      	}
             	} else {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call DBTransaction::GetTxnHeader Failed\n"));
                        iRet = INT_ERR;
                }

		RecordSet_Destroy(rRecordSet);
     	}

	// Get Txn Detail
	if(iRet==PD_OK){
		recordset_init(rRecordSet,0);

DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call DBTransaction::GetTxnDetail:: txn_id [%s]\n",csTxnId));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
                iRet = (unsigned long)(*DBObjPtr)(csTxnId,rRecordSet);
                if (iRet == PD_OK) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call DBTransaction::GetTxnDetail Success\n"));
                        hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* txn_country */
                                if(GetField_CString(hRec,"txn_country",&csTmp)){
DEBUGLOG(("GetRspDeliveryOutTxnInfo::txn_country = [%s]\n",csTmp));
                                        PutField_CString(hTxnRec,"txn_amt",csTmp);
                                }

				hRec = RecordSet_GetNext(rRecordSet);
			}
                } else {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call DBTransaction::GetTxnDetail Failed\n"));
                        iRet = INT_ERR;
                }
			
		RecordSet_Destroy(rRecordSet);
	}

	// Get Txn Mi Detail
	if(iRet==PD_OK){
                recordset_init(rRecordSet,0);

DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: txn_id = [%s]\n", csTxnId));
                DBObjPtr = CreateObj(DBPtr, "DBTxnMiDetail", "GetTxnMiDetail");
                iRet = (unsigned long)(*DBObjPtr)(csTxnId, rRecordSet);
                if (iRet == PD_OK) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail:SUCCESS\n"));

			hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {

/* entity_id */
                                if (GetField_CString(hRec,"entity_id",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: entity_id = [%s]\n", csTmp));
					PutField_CString(hTxnRec,"entity_id",csTmp);
				}
					
/* party_type */
				if (GetField_CString(hRec,"party_type",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: party_type = [%s]\n", csTmp));
					PutField_CString(hTxnRec,"party_type",csTmp);
				}

/* party_id */
                                if (GetField_CString(hRec,"party_id",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: party_id = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"party_id",csTmp);
				}

/* txn_ccy */
                                if (GetField_CString(hRec,"txn_ccy",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: txn_ccy = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"txn_ccy",csTmp);
				}

/* txn_country */
                                if (GetField_CString(hRec,"txn_country",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: txn_country = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"txn_country",csTmp);
				}

/* txn_product */
                                if (GetField_CString(hRec,"txn_product",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: txn_product = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"txn_product",csTmp);
                                }

/* open_acct_bal */
                                if (GetField_Double(hRec,"open_acct_bal",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: entity_id = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"open_acct_bal",dTmp);
                                }

/* acct_bal */
                                if (GetField_Double(hRec,"acct_bal",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: acct_bal = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"acct_bal",dTmp);
                                }

/* open_intransit */
                                if (GetField_Double(hRec,"open_intransit",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: open_intransit = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"open_intransit",dTmp);
                                }

/* intransit */
                                if (GetField_Double(hRec,"intransit",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: intransit = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"intransit",dTmp);
                                }

/* open_ar_bal */
                                if (GetField_Double(hRec,"open_ar_bal",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: open_ar_bal = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"open_ar_bal",dTmp);
                                }

/* ar_bal */
                                if (GetField_Double(hRec,"ar_bal",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: ar_bal = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"ar_bal",dTmp);
                                }

/* txn_date */
                                if (GetField_CString(hRec,"txn_date",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: txn_date = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"txn_date",csTmp);
                                }

/* report_date */
				if (GetField_CString(hRec,"report_date",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: report_date = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"report_date",csTmp);
                                }

/* cost_rate */
                                if (GetField_Double(hRec,"cost_rate",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: cost_rate = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"cost_rate",dTmp);
                                }

/* actual_cost */
                                if (GetField_Double(hRec,"actual_cost",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: actual_cost = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"actual_cost",dTmp);
                                }

/* remittance_slip_date */
                                if (GetField_CString(hRec,"remittance_slip_date",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: remittance_slip_date = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"remittance_slip_date",csTmp);
                                }

/* converted_ccy */
                                if (GetField_CString(hRec,"converted_ccy",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: converted_ccy = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"converted_ccy",csTmp);
                                }

/* converted_amount */
                                if (GetField_Double(hRec,"converted_amount",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: converted_amount = [%f]\n", dTmp));
                                	PutField_Double(hTxnRec,"converted_amount",dTmp);
                                }

/* remark */
                                if (GetField_CString(hRec,"remark",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: remark = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"remark",csTmp);
                                }

/* prev_grp_txn_id */            
	                    	if (GetField_CString(hRec,"prev_grp_txn_id",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: prev_grp_txn_id = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"prev_grp_txn_id",csTmp);
                                }

/* next_grp_txn_id */
                                if (GetField_CString(hRec,"next_grp_txn_id",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: next_grp_txn_id = [%s]\n", csTmp));
                                	PutField_CString(hTxnRec,"next_grp_txn_id",csTmp);
                                }

/* acr_prorata */
                                if (GetField_Int(hRec,"acr_prorata",&iTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: acr_prorata = [%d]\n", iTmp));
                                	PutField_Int(hTxnRec,"acr_prorata",iTmp);
                                }

/* entity_ccy */
                                if (GetField_CString(hRec,"entity_ccy",&csTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: entity_ccy = [%s]\n", csTmp));
                                        PutField_CString(hTxnRec,"entity_ccy",csTmp);
                                }

/* entity_txn_amount */
                                if (GetField_Double(hRec,"entity_txn_amount",&dTmp)) {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail: entity_txn_amount = [%f]\n", dTmp));
                                        PutField_Double(hTxnRec,"entity_txn_amount",dTmp);
                                }

				hRec = RecordSet_GetNext(rRecordSet);
                        }
		} else {
DEBUGLOG(("GetRspDeliveryOutTxnInfo::Call TxnMiDetail:GetTxnMiDetail:Failed\n"));
                	iRet = INT_ERR;
		}

		PutField_CString(hTxnRec,"entity_id","E000000001");
		PutField_CString(hTxnRec,"party_type","RSP");
		PutField_CString(hTxnRec,"party_id","RSP0000001");
		PutField_CString(hTxnRec,"txn_product","VHS");
		PutField_CString(hTxnRec,"txn_ccy","CNY");
		PutField_CString(hTxnRec,"txn_country","CN");
		PutField_CString(hTxnRec,"entity_ccy","CNY");

		RecordSet_Destroy(rRecordSet);
	}

	FREE_ME(csTxnId);
	FREE_ME(rRecordSet);

DEBUGLOG(("GetRspDeliveryOutTxnInfo Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     FormRspDeliveryInTxn(hash_t* hContext, hash_t* hRequest, hash_t* hOrgTxnRec, hash_t* hTxnRec)
{
	int     iRet = PD_OK;

	double	dTmp = 0.0;

	char	*csTmp = NULL;

	char    csTxnDateTime[PD_DATETIME_LEN + 1];

/* txn_seq */
	if (GetField_CString(hTxnRec, "txn_seq", &csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn:: txn_seq [%s]\n", csTmp));
        }

	// Txn Header
	if (iRet == PD_OK) {

/* channel_code */
		if (GetField_CString(hOrgTxnRec, "channel_code", &csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: channel_code [%s]\n", csTmp));
                	PutField_CString(hTxnRec, "channel_code", csTmp);
        	}		

/* status */
                PutField_Char(hTxnRec,"status",PD_PROCESSING);
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: status [%c]\n", PD_PROCESSING));

/* txn_code */
                PutField_CString(hTxnRec, "txn_code", PD_MI_TXN_CODE_RSP_DELIVERY_IN);
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: txn_code [%s]\n", PD_MI_TXN_CODE_RSP_DELIVERY_IN));

/* process_type */
                PutField_CString(hTxnRec,"process_code", PD_PROCESS_CODE_DEF);
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: process_code [%s]\n", PD_PROCESS_CODE_DEF));

/* process_code */
                PutField_CString(hTxnRec,"process_type", PD_PROCESS_TYPE_DEF);
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: process_type [%s]\n", PD_PROCESS_TYPE_DEF));

/* response_code */
                PutField_CString(hTxnRec, "response_code", "0");
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: response_code [%s]\n", "0"));

/* internal_code */
                PutField_Int(hTxnRec, "internal_code", 0);
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: internal_code [%d]\n", 0));

/* host_posting_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: PHDATE [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"PHDATE",csTmp);
                }

/* transmission_datetime */
                if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: local_tm_date [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "local_tm_date", csTmp);
                        PutField_CString(hTxnRec, "tm_date", csTmp);

                        strcpy(csTxnDateTime, csTmp);
                        PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);

                        if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: local_tm_time [%s]\n", csTmp));
                                PutField_CString(hTxnRec, "local_tm_time", csTmp);
                                strcat(csTxnDateTime, csTmp);
                                PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);
                        }
                }

/* net_ccy */
             	if (GetField_CString(hOrgTxnRec,"net_ccy",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: net_ccy = [%s]\n",csTmp));
                  	PutField_CString(hTxnRec,"net_ccy",csTmp);
             	}

/* net_amt */
              	if (GetField_Double(hOrgTxnRec,"net_amt",&dTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: net_amt = [%lf]\n",dTmp));
                      	PutField_Double(hTxnRec,"net_amt",dTmp);
               	}

/* txn_amt */
            	if (GetField_Double(hOrgTxnRec,"txn_amt",&dTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: txn_amt = [%lf]\n",dTmp));
                   	PutField_Double(hTxnRec,"txn_amt",dTmp);
             	}
	}

	// Txn Detail
	if (iRet == PD_OK) {

/* txn_country */
                if (GetField_CString(hOrgTxnRec, "txn_country", &csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn (TxnLog):: txn_country = [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "txn_country", csTmp);
                }
	}
	
	// Txn Mi Detail
	if (iRet == PD_OK) {

/* entity_id */
              	if (GetField_CString(hOrgTxnRec,"entity_id",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: entity_id = [%s]\n", csTmp));
                    	PutField_CString(hTxnRec,"entity_id",csTmp);
            	}

/* party_type */
             	if (GetField_CString(hOrgTxnRec,"party_type",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: party_type = [%s]\n", csTmp));
                      	PutField_CString(hTxnRec,"party_type",csTmp);
               	}

/* party_id */
                if (GetField_CString(hOrgTxnRec,"party_id",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: party_id = [%s]\n", csTmp));
                       	PutField_CString(hTxnRec,"party_id",csTmp);
             	}

/* txn_ccy */
            	if (GetField_CString(hOrgTxnRec,"txn_ccy",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: txn_ccy = [%s]\n", csTmp));
                     	PutField_CString(hTxnRec,"txn_ccy",csTmp);
                     	PutField_CString(hTxnRec,"ccy",csTmp);
              	}

/* txn_country */
            	if (GetField_CString(hOrgTxnRec,"txn_country",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: txn_country = [%s]\n", csTmp));
                      	PutField_CString(hTxnRec,"txn_country",csTmp);
                      	PutField_CString(hTxnRec,"country",csTmp);
              	}

/* txn_product */
           	if (GetField_CString(hOrgTxnRec,"txn_product",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: txn_product = [%s]\n", csTmp));
                      	PutField_CString(hTxnRec,"txn_product",csTmp);
                      	PutField_CString(hTxnRec,"product_code",csTmp);
             	}

/* entity_ccy */
              	if (GetField_CString(hOrgTxnRec,"entity_ccy",&csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: entity_ccy = [%s]\n", csTmp));
                       	PutField_CString(hTxnRec,"entity_ccy",csTmp);
            	}

/* entity_txn_amount */
           	if (GetField_Double(hOrgTxnRec,"entity_txn_amount",&dTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn::Call TxnMiDetail:GetTxnMiDetail: entity_txn_amount = [%f]\n", dTmp));
                 	PutField_Double(hTxnRec,"entity_txn_amount",dTmp);
             	}
	}

DEBUGLOG(("FormRspDeliveryInTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int	ProcessRspDeliveryInTxn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec)
{
	int     iRet = PD_OK;

	int	iTmp = 0;

	double	dTmp = 0.0;

	char    *csApprovalDate = NULL;
        char    *csApprovalTimestamp = NULL;
	char	*csTmp = NULL;

	//char    csTxnId[PD_TXN_SEQ_LEN + 1];

	//char    csTxnDateTime[PD_DATETIME_LEN + 1];

/* txn_seq */
        if (GetField_CString(hTxnRec, "txn_seq", &csTmp)) {
DEBUGLOG(("FormRspDeliveryInTxn:: txn_seq [%s]\n", csTmp));
        }

#if 0
	// Update MGT Channel Context
        if (iRet == PD_OK) {

/* local_tm_date */
                if (GetField_CString(hContext,"local_tm_date",&csTmp)) {
                        PutField_CString(hTxnRec,"local_tm_date",csTmp);
                }

/* local_tm_time */
                if (GetField_CString(hContext,"local_tm_time",&csTmp)) {
                        PutField_CString(hTxnRec,"local_tm_time",csTmp);
                }

/* host_posting_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
                        PutField_CString(hTxnRec,"PHDATE",csTmp);
                }

                PutField_CString(hTxnRec,"channel_code",PD_CHANNEL_MGT);
                PutField_CString(hTxnRec,"process_code",PD_PROCESS_CODE_DEF);
                PutField_CString(hTxnRec,"process_type",PD_PROCESS_TYPE_DEF);

		// Update Context
DEBUGLOG(("ProcessRspDeliveryInTxn:: Call MGTChannel: UpdateContext\n"));
                ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateContext");
                iRet = (unsigned long)(*ChannelObjPtr)(hTxnRec);
		if (iRet != PD_OK) {
DEBUGLOG(("ProcessRspDeliveryInTxn:: Call MGTChannel: UpdateContext Failed\n"));
			iRet = INT_ERR;
		}
        }
#endif

#if 0
	// Add Txn Log
        if (iRet == PD_OK) {

/* do_logging */
		PutField_Int(hTxnRec, "do_logging", PD_TRUE);
DEBUGLOG(("ProcessRspDeliveryInTxn:: do_logging [%d]\n", PD_TRUE));

/* db_commit */
        	PutField_Int(hTxnRec, "db_commit", PD_FALSE);
DEBUGLOG(("ProcessRspDeliveryInTxn:: db_commit [%d]\n", PD_FALSE));

DEBUGLOG(("ProcessRspDeliveryInTxn:: Call MGTChannel: AddTxnLog\n"));
                ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnLog");
                iRet = (unsigned long)(*ChannelObjPtr)(hTxnRec,hRequest);
       		if (iRet != PD_OK) {
DEBUGLOG(("ProcessRspDeliveryInTxn:: Call MGTChannel: AddTxnLog Failed\n"));
                        iRet = INT_ERR;
                }
	}
#endif

	// Update Txn Header
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("Authorize::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

				// Update TxnHeader
DEBUGLOG(("ProcessRspDeliveryInTxn::Call DBTransaction:: Update\n"));
              			DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
               			iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
             			if (iRet != PD_OK) {
DEBUGLOG(("ProcessRspDeliveryInTxn::Call DBTransaction:: Update Failed\n"));
                  			iRet = INT_ERR;
              			}
			}
		}
	}

	// Add and Update Txn Detail 
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("Authorize::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add TxnDetail
                                if (iRet == PD_OK) {

DEBUGLOG(("Authorize::Call DBTransaction:: AddDetail\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }

                                // Update TxnDetail
                                if (iRet == PD_OK) {

DEBUGLOG(("Authorize::Call DBTransaction:: Update\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("Authorize::Call DBTransaction:: Update Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
	}
	
	// Update Entity Balance
        if (iRet == PD_OK) {
	
		// batch_mode
                PutField_Char(hTxnRec, "batch_mode", PD_ONLINE);
DEBUGLOG(("ProcessRspDeliveryInTxn::batch_mode = [%c]\n",PD_ONLINE));

                // amt_type
                PutField_CString(hTxnRec, "amt_type", PD_DR);
DEBUGLOG(("ProcessRspDeliveryInTxn::amt_type = [%s]\n",PD_DR));

                // bal_type
                PutField_Char(hTxnRec, "bal_type", PD_MI_ENTITY_POOL_ACCT_BAL);
DEBUGLOG(("ProcessRspDeliveryInTxn::bal_type = [%c]\n",PD_MI_ENTITY_POOL_ACCT_BAL));	
		
		// UpdateEntityBalance
DEBUGLOG(("ProcessRspDeliveryInTxn::Call BOMiEntityBalance:: UpdateEntityBalance\n"));
                BOObjPtr = CreateObj(BOPtr, "BOMiEntityBalance", "UpdateEntityBalance");
                iRet = (unsigned long)(*BOObjPtr)(hTxnRec,hTxnRec);
                if (iRet == PD_OK) {
DEBUGLOG(("ProcessRspDeliveryInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Success\n"));

                        if (GetField_CString(hTxnRec, "approval_date", &csApprovalDate)) {
DEBUGLOG(("ProcessRspDeliveryInTxn::Call BOMiEntityBalance:: approval_date [%s]\n", csApprovalDate));
                        }

                        if (GetField_CString(hTxnRec, "approval_timestamp", &csApprovalTimestamp))  {
DEBUGLOG(("ProcessRspDeliveryInTxn::Call BOMiEntityBalance:: approval_timestamp [%s]\n", csApprovalTimestamp));
                        }

                        // Open Balance
                        if (GetField_Double(hTxnRec, "open_acct_bal", &dTmp)) {
DEBUGLOG(("ProcessRspDeliveryInTxn::Call BOMiEntityBalance:: open_acct_bal = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "open_intransit", &dTmp)) {
DEBUGLOG(("ProcessRspDeliveryInTxn::Call BOMiEntityBalance:: open_intransit = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "open_ar_bal", &dTmp)) {
DEBUGLOG(("ProcessRspDeliveryInTxn::Call BOMiEntityBalance:: open_ar_bal = [%f]\n", dTmp));
                        }

                        // Close Balance
                        if (GetField_Double(hTxnRec, "acct_bal", &dTmp)) {
DEBUGLOG(("ProcessRspDeliveryInTxn::Call BOMiEntityBalance:: closing acct_bal = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "intransit", &dTmp)) {
DEBUGLOG(("ProcessRspDeliveryInTxn::Call BOMiEntityBalance:: closing intransit = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "ar_bal", &dTmp)) {
DEBUGLOG(("ProcessRspDeliveryInTxn::Call BOMiEntityBalance:: closing ar_bal = [%f]\n", dTmp));
                        }

                } else {
DEBUGLOG(("ProcessRspDeliveryInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n"));
ERRLOG("TxnMinByUsDLI::ProcessRspDeliveryInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n");
                        iRet = INT_ERR;
                }	
	}

	// Add Txn Mi Detail
        if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessRspDeliveryInTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add TxnMiDetail
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessRspDeliveryInTxn::Call DBTxnMiDetail:: Add\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Add");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessRspDeliveryInTxn::Call DBTxnMiDetail:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
	}

#if 0
	// Update Txn Detail
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hContext,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessRspDeliveryInTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

				// Update TxnDetail
                                if (iRet == PD_OK) {

DEBUGLOG(("ProcessRspDeliveryInTxn::Call DBTransaction:: Update\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessRspDeliveryInTxn::Call DBTransaction:: Update Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
	}
#endif

	// Update Status, Ar_Ind, Sub Status, Approval Date and Approval Timestamp
        if (iRet == PD_OK) {

/* status */
                PutField_Char(hTxnRec,"status",PD_COMPLETE);
DEBUGLOG(("ProcessRspDeliveryInTxn::status [%c]\n", PD_COMPLETE));

/* ar_ind */
                PutField_Char(hTxnRec,"ar_ind",PD_ACCEPT);
DEBUGLOG(("ProcessRspDeliveryInTxn::ar_ind [%c]\n", PD_ACCEPT));

/* sub_status */
                PutField_CString(hTxnRec,"sub_status",PD_APPROVED);
DEBUGLOG(("ProcessRspDeliveryInTxn::sub_status [%s]\n", PD_APPROVED));

/* approval_date */
                PutField_CString(hTxnRec, "approval_date", csApprovalDate);
DEBUGLOG(("ProcessRspDeliveryInTxn::approval_date [%s]\n", csApprovalDate));

/* approval_timestamp */
                PutField_CString(hTxnRec, "approval_timestamp", csApprovalTimestamp);
DEBUGLOG(("ProcessRspDeliveryInTxn::approval_timestamp [%s]\n", csApprovalTimestamp));

/* do_logging */
                //PutField_Int(hTxnRec, "do_logging", PD_FALSE);
//DEBUGLOG(("ProcessRspDeliveryInTxn:: do_logging [%d]\n", PD_FALSE));

DEBUGLOG(("ProcessRspDeliveryInTxn::Call DBTransaction: Update \n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("ProcessRspDeliveryInTxn::Call DBTransaction:: Update Failed\n"));
                }
        }

DEBUGLOG(("ProcessRspDeliveryInTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

#if 0
int     ProcessOpbFundIn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec)
{
        int     iRet = PD_OK;

	int	iTotalCnt = 0;
	int 	i = 0;
	int	iTmp = 0;

	double 	dTmp = 0.0;

	char    csTag[PD_TAG_LEN + 1];

DEBUGLOG(("===== ProcessOpbFundIn ===== START!!\n"));

/* total_cnt */
        if (GetField_Int(hTxnRec,"total_cnt",&iTotalCnt)) {
DEBUGLOG(("ProcessOpbFundIn::total_cnt = [%d]\n",iTotalCnt));
        } else {
DEBUGLOG(("ProcessOpbFundIn::total_cnt not found!!\n"));
ERRLOG("TxnMinByUsDLI::ProcessOpbFundIn::total_cnt not found!!\n");
                iRet = INT_MI_TOTAL_CNT_NOT_FOUND;
        }

        // Create Txn + Update Balance (with add approval_date, approval_timestamp)
        if (iRet == PD_OK) 			
		for (i=0; i<iTotalCnt; i++) {		
			sprintf(csTag, "seb_exist_%d", i+1);
			if (GetField_Int(hTxnRec, csTag, &iTmp)) {
DEBUGLOG(("ProcessOpbFundIn::[%s] = [%d]\n",csTag, iTmp));

/* txnamt */
				sprintf(csTag, "txnamt_%d", i+1);
                        	if (GetField_Double(hTxnRec, csTag, &dTmp)) {
DEBUGLOG(("ProcessOpbFundIn::[%s] = [%f]\n",csTag, dTmp));
					PutField_Double(hTxnRec,"txnamt",dTmp);
				} else {
DEBUGLOG(("ProcessOpbFundIn::[%s] not found!!\n",csTag));
ERRLOG("TxnMgtByUsDLI::ProcessOpbFundIn::[%s] not found!!\n",csTag);
                                	iRet = INT_PAY_AMOUNT_NOT_FOUND;
                        	}

/* deliver_date */
	                        sprintf(csTag, "deliver_date_%d", i+1);
	                        if (GetField_CString(hTxnRec, csTag, &csTmp)) {
DEBUGLOG(("ProcessOpbFundIn::[%s] = [%s]\n",csTag, csTmp));
					PutField_CString(hTxnRec,"deliver_date",csTmp);
	                        }

                		iRet = ProcessOpbFundInTxn(hContext, hRequest, hTxnRec);
			}
		}
        }

DEBUGLOG(("ProcessOpbFundIn:: iRet [%d]\n", iRet));
DEBUGLOG(("===== ProcessOpbFundIn ===== END !!\n"));

        return iRet;
}

int     ProcessOpbFundInTxn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec)
{
	int     iRet = PD_OK;

	char    *csApprovalDate = NULL;
        char    *csApprovalTimestamp = NULL;
	char    *csTmp = NULL;

	char    csTxnId[PD_TXN_SEQ_LEN + 1];
	char    csTxnDateTime[PD_DATETIME_LEN + 1];

	// Generate Next Txn Seq
        if (iRet == PD_OK) {
DEBUGLOG(("ProcessOpbFundInTxn:: Call DBTxnSeq: GetNextMgtTxnSeq\n"));
                DBObjPtr = CreateObj(DBPtr, "DBTxnSeq", "GetNextMgtTxnSeq");
                strcpy((char*)csTxnId, (*DBObjPtr)());

                PutField_CString(hTxnRec, "txn_seq", (const char *)csTxnId);
DEBUGLOG(("ProcessOpbFundInTxn:: Call DBTxnSeq: txn_seq = [%s]\n", csTxnId));
        }

	// Add Txn Log
	if (iRet == PD_OK) {

/* channel_code */
                PutField_CString(hTxnRec, "channel_code", PD_CHANNEL_MGT);

/* status */
                PutField_Char(hTxnRec,"status",PD_PROCESSING);
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: status [%s]\n", PD_PROCESSING));

/* txn_code */
                PutField_CString(hTxnRec, "txn_code", PD_MI_TXN_CODE_OPBANK_RECEIVE_FROM_RSP);
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: txn_code [%s]\n", PD_MI_TXN_CODE_OPBANK_RECEIVE_FROM_RSP));

/* process_type */
                PutField_CString(hTxnRec,"process_code", PD_PROCESS_CODE_DEF);
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: process_code [%s]\n", PD_PROCESS_CODE_DEF));

/* process_code */
                PutField_CString(hTxnRec,"process_type", PD_PROCESS_TYPE_DEF);
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: process_type [%s]\n", PD_PROCESS_TYPE_DEF));

/* response_code */
                PutField_CString(hTxnRec, "response_code", "0");
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: response_code [%s]\n", "0"));

/* internal_code */
                PutField_Int(hTxnRec, "internal_code", 0);
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: internal_code [%d]\n", 0));

/* host_posting_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: PHDATE [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"PHDATE",csTmp);
                }

/* transmission_datetime */
                if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: local_tm_date [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "local_tm_date", csTmp);
                        PutField_CString(hTxnRec, "tm_date", csTmp);

                        strcpy(csTxnDateTime, csTmp);
                        PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);

                        if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: local_tm_time [%s]\n", csTmp));
                                PutField_CString(hTxnRec, "local_tm_time", csTmp);
                                strcat(csTxnDateTime, csTmp);
                                PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);
                        }
                }

/* net_ccy */
                if (GetField_CString(TxnRec,"ccy",&csTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: net_ccy = [%s]\n",csTmp));
                        PutField_CString(hTxnRec,"net_ccy",csTmp);
                }

/* net_amt */
                if (GetField_Double(hTxnRec,"txnamt",&dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: net_amt = [%lf]\n",dTmp));
                        PutField_Double(hTxnRec,"net_amt",dTmp);
                }

/* txn_amt */
                if (GetField_Double(hTxnRec,"txnamt",&dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn (TxnLog):: txn_amt = [%lf]\n",dTmp));
                        PutField_Double(hTxnRec,"txn_amt",dTmp);
                }

/* do_logging */
                PutField_Int(hTxnRec, "do_logging", PD_TRUE);
DEBUGLOG(("ProcessOpbFundInTxn:: do_logging [%d]\n", PD_TRUE));

/* db_commit */
                PutField_Int(hTxnRec, "db_commit", PD_FALSE);
DEBUGLOG(("ProcessOpbFundInTxn:: db_commit [%d]\n", PD_FALSE));

DEBUGLOG(("ProcessOpbFundInTxn:: Call MGTChannel: AddTxnLog\n"));
                ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnLog");
                iRet = (unsigned long)(*ChannelObjPtr)(hTxnRec,hRequest);
                if (iRet != PD_OK) {
DEBUGLOG(("ProcessOpbFundInTxn:: Call MGTChannel: AddTxnLog Failed\n"));
                        iRet = INT_ERR;
                }
	}

 	// Update Entity Balance
	if (iRet == PD_OK) {

		// batch_mode
                PutField_Char(hTxnRec, "batch_mode", PD_ONLINE);
DEBUGLOG(("ProcessOpbFundInTxn::batch_mode = [%c]\n",PD_ONLINE));

                // amt_type
                PutField_CString(hTxnRec, "amt_type", PD_CR);
DEBUGLOG(("ProcessOpbFundInTxn::amt_type = [%s]\n",PD_CR));

                // bal_type
                PutField_Char(hTxnRec, "bal_type", PD_MI_ENTITY_POOL_ACCT_BAL);
DEBUGLOG(("ProcessOpbFundInTxn::bal_type = [%c]\n",PD_MI_ENTITY_POOL_ACCT_BAL));	
		
		// UpdateEntityBalance
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: UpdateEntityBalance\n"));
                BOObjPtr = CreateObj(BOPtr, "BOMiEntityBalance", "UpdateEntityBalance");
                iRet = (unsigned long)(*BOObjPtr)(hTxnRec,hTxnRec);
                if (iRet == PD_OK) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Success\n"));

                        if (GetField_CString(hTxnRec, "approval_date", &csApprovalDate)) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: approval_date [%s]\n", csApprovalDate));
                        }

                        if (GetField_CString(hTxnRec, "approval_timestamp", &csApprovalTimestamp))  {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: approval_timestamp [%s]\n", csApprovalTimestamp));
                        }

                        // Open Balance
                        if (GetField_Double(hTxnRec, "open_acct_bal", &dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: open_acct_bal = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "open_intransit", &dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: open_intransit = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "open_ar_bal", &dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: open_ar_bal = [%f]\n", dTmp));
                        }

                        // Close Balance
                        if (GetField_Double(hTxnRec, "acct_bal", &dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: closing acct_bal = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "intransit", &dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: closing intransit = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "ar_bal", &dTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: closing ar_bal = [%f]\n", dTmp));
                        }

                } else {
DEBUGLOG(("ProcessOpbFundInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n"));
ERRLOG("TxnMinByUsDLI::ProcessOpbFundInTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n");
                        iRet = INT_ERR;
                }	
	}

	// ACR
	if (iRet == PD_OK) {

	}

	// Add TxnMiDetail
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hTxnRec,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessOpbFundInTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                // Add TxnMiDetail
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessOpbFundInTxn::Call DBTxnMiDetail:: Add\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Add");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessOpbFundInTxn::Call DBTxnMiDetail:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
	}

	// Update Status, Ar_Ind, Sub Status, Approval Date and Approval Timestamp
	if (iRet == PD_OK) {

/* status */
                PutField_Char(hTxnRec,"status",PD_COMPLETE);
DEBUGLOG(("ProcessOpbFundInTxn::status [%c]\n", PD_COMPLETE));

/* ar_ind */
                PutField_Char(hTxnRec,"ar_ind",PD_ACCEPT);
DEBUGLOG(("ProcessOpbFundInTxn::ar_ind [%c]\n", PD_ACCEPT));

/* sub_status */
                PutField_CString(hTxnRec,"sub_status",PD_APPROVED);
DEBUGLOG(("ProcessOpbFundInTxn::sub_status [%s]\n", PD_APPROVED));

/* approval_date */
                PutField_CString(hTxnRec, "approval_date", csApprovalDate);
DEBUGLOG(("ProcessOpbFundInTxn::approval_date [%s]\n", csApprovalDate));

/* approval_timestamp */
                PutField_CString(hTxnRec, "approval_timestamp", csApprovalTimestamp);
DEBUGLOG(("ProcessOpbFundInTxn::approval_timestamp [%s]\n", csApprovalTimestamp));

/* do_logging */
                PutField_Int(hTxnRec, "do_logging", PD_FALSE);
DEBUGLOG(("ProcessOpbFundInTxn:: do_logging [%d]\n", PD_FALSE));

DEBUGLOG(("ProcessOpbFundInTxn::Call DBTransaction: Update \n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("ProcessOpbFundInTxn::Call DBTransaction:: Update Failed\n"));
                }
	}

DEBUGLOG(("ProcessOpbFundInTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     ProcessRspAmtDiff(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec)
{
	int     iRet = PD_OK;

	int     iTotalCnt = 0;
        int 	i = 0;
	int     iTmp = 0;

        char    csTag[PD_TAG_LEN + 1];

DEBUGLOG(("===== ProcessRspAmtDiff ===== START!!\n"));

/* total_cnt */
        if (GetField_Int(hTxnRec,"total_cnt",&iTotalCnt)) {
DEBUGLOG(("ProcessRspAmtDiff::total_cnt = [%d]\n",iTotalCnt));
        } else {
DEBUGLOG(("ProcessRspAmtDiff::total_cnt not found!!\n"));
ERRLOG("TxnMinByUsDLI::ProcessRspAmtDiff::total_cnt not found!!\n");
                iRet = INT_MI_TOTAL_CNT_NOT_FOUND;
                PutField_Int(hContext,"internal_error",iRet);
        }

	// Create Txn + Update Balance (with add approval_date, approval_timestamp)
        if (iRet == PD_OK) {
		for (i=0; i<iTotalCnt; i++) {
                        sprintf(csTag, "seb_exist_%d", i+1);
                        if (GetField_Int(hTxnRec, csTag, &iTmp)) {
DEBUGLOG(("ProcessRspAmtDiff::[%s] = [%d]\n",csTag, iTmp));

/* amtdiff_reason */
	                        sprintf(csTag, "amtdiff_reason_%d", i+1);
	                        if (GetField_CString(hTxnRec, csTag, &csTmp)) {
DEBUGLOG(("ProcessRspAmtDiff::[%s] = [%s]\n",csTag, csTmp));
					PutField_CString(hTxnRec,"amtdiff_reason",csTmp);					
	                        }

/* amtdiff_ccy */
	                        sprintf(csTag, "amtdiff_ccy_%d", i+1);
	                        if (GetField_CString(hTxnRec, csTag, &csTmp)) {
DEBUGLOG(("ProcessRspAmtDiff::[%s] = [%s]\n",csTag, csTmp));
					PutField_CString(hTxnRec,"amtdiff_ccy",csTmp);					
	                        }

/* amtdiff_amt */
	                        sprintf(csTag, "amtdiff_amt_%d", i+1);
	                        if (GetField_Double(hTxnRec, csTag, &dTmp)) {
DEBUGLOG(("ProcessRspAmtDiff::[%s] = [%f]\n",csTag, dTmp));
					PutField_CString(hTxnRec,"amtdiff_amt",csTmp);					
				}

                                iRet = ProcessRspAmtDiffTxn(hTxnRec, hRequest, hTxnRec);
                        }
                }
        }

DEBUGLOG(("ProcessRspAmtDiff:: iRet [%d]\n", iRet));
DEBUGLOG(("===== ProcessRspAmtDiff ===== END !!\n"));

        return iRet;
}

int     ProcessRspAmtDiffTxn(hash_t* hContext, hash_t* hRequest, hash_t* hTxnRec)
{
        int     iRet = PD_OK;

	char    *csApprovalDate = NULL;
        char    *csApprovalTimestamp = NULL;
        char    *csTmp = NULL;

	char    csTxnId[PD_TXN_SEQ_LEN + 1];
	char    csTxnDateTime[PD_DATETIME_LEN + 1];

	// Generate Next Txn Seq
        if (iRet == PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn:: Call DBTxnSeq: GetNextMgtTxnSeq\n"));
                DBObjPtr = CreateObj(DBPtr, "DBTxnSeq", "GetNextMgtTxnSeq");
                strcpy((char*)csTxnId, (*DBObjPtr)());

                PutField_CString(hTxnRec, "txn_seq", (const char *)csTxnId);
DEBUGLOG(("ProcessRspAmtDiffTxn:: Call DBTxnSeq: txn_seq = [%s]\n", csTxnId));
        }

	// Add Txn Log
	if (iRet == PD_OK) {

/* channel_code */
                PutField_CString(hTxnRec, "channel_code", PD_CHANNEL_MGT);

/* status */
                PutField_Char(hTxnRec,"status",PD_PROCESSING);
DEBUGLOG(("ProcessRspAmtDiffTxn (TxnLog):: status [%s]\n", PD_PROCESSING));

/* txn_code */
		if (GetField_CString(hTxnRec,"amtdiff_reason",&csTmp)) {
                	PutField_CString(hTxnRec, "txn_code", csTmp);
DEBUGLOG(("ProcessRspAmtDiffTxn (TxnLog):: txn_code [%s]\n", csTmp));
		}

/* process_type */
                PutField_CString(hTxnRec,"process_code", PD_PROCESS_CODE_DEF);
DEBUGLOG(("ProcessRspAmtDiffTxn (TxnLog):: process_code [%s]\n", PD_PROCESS_CODE_DEF));

/* process_code */
                PutField_CString(hTxnRec,"process_type", PD_PROCESS_TYPE_DEF);
DEBUGLOG(("ProcessRspAmtDiffTxn (TxnLog):: process_type [%s]\n", PD_PROCESS_TYPE_DEF));

/* response_code */
                PutField_CString(hTxnRec, "response_code", "0");
DEBUGLOG(("ProcessRspAmtDiffTxn (TxnLog):: response_code [%s]\n", "0"));

/* internal_code */
                PutField_Int(hTxnRec, "internal_code", 0);
DEBUGLOG(("ProcessRspAmtDiffTxn (TxnLog):: internal_code [%d]\n", 0));

/* host_posting_date */
                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn (TxnLog):: PHDATE [%s]\n", csTmp));
                        PutField_CString(hTxnRec,"PHDATE",csTmp);
                }

/* transmission_datetime */
                if (GetField_CString(hContext, "local_tm_date", &csTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn (TxnLog):: local_tm_date [%s]\n", csTmp));
                        PutField_CString(hTxnRec, "local_tm_date", csTmp);
                        PutField_CString(hTxnRec, "tm_date", csTmp);

                        strcpy(csTxnDateTime, csTmp);
                        PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);

                        if (GetField_CString(hContext, "local_tm_time", &csTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn (TxnLog):: local_tm_time [%s]\n", csTmp));
                                PutField_CString(hTxnRec, "local_tm_time", csTmp);
                                strcat(csTxnDateTime, csTmp);
                                PutField_CString(hTxnRec, "transmission_datetime", csTxnDateTime);
                        }
                }

/* net_ccy */
                if (GetField_CString(TxnRec,"amtdiff_ccy",&csTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn (TxnLog):: net_ccy = [%s]\n",csTmp));
                        PutField_CString(hTxnRec,"net_ccy",csTmp);
                }

/* net_amt */
                if (GetField_Double(hTxnRec,"amtdiff_amt",&dTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn (TxnLog):: net_amt = [%lf]\n",dTmp));
                        PutField_Double(hTxnRec,"net_amt",dTmp);
                }

/* txn_amt */
                if (GetField_Double(hTxnRec,"amtdiff_amt",&dTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn (TxnLog):: txn_amt = [%lf]\n",dTmp));
                        PutField_Double(hTxnRec,"txn_amt",dTmp);
                }

/* do_logging */
                PutField_Int(hTxnRec, "do_logging", PD_TRUE);
DEBUGLOG(("ProcessRspAmtDiffTxn:: do_logging [%d]\n", PD_TRUE));

/* db_commit */
                PutField_Int(hTxnRec, "db_commit", PD_FALSE);
DEBUGLOG(("ProcessRspAmtDiffTxn:: db_commit [%d]\n", PD_FALSE));

DEBUGLOG(("ProcessRspAmtDiffTxn:: Call MGTChannel: AddTxnLog\n"));
                ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnLog");
                iRet = (unsigned long)(*ChannelObjPtr)(hTxnRec,hRequest);
                if (iRet != PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn:: Call MGTChannel: AddTxnLog Failed\n"));
                        iRet = INT_ERR;
                }
	}

	// Update Entity Balance
	if (iRet == PD_OK) {

		// batch_mode
                PutField_Char(hTxnRec, "batch_mode", PD_ONLINE);
DEBUGLOG(("ProcessRspAmtDiffTxn::batch_mode = [%c]\n",PD_ONLINE));

                // amt_type
                PutField_CString(hTxnRec, "amt_type", PD_CR);
DEBUGLOG(("ProcessRspAmtDiffTxn::amt_type = [%s]\n",PD_CR));

                // bal_type
                PutField_Char(hTxnRec, "bal_type", PD_MI_ENTITY_POOL_AR_BAL);
DEBUGLOG(("ProcessRspAmtDiffTxn::bal_type = [%c]\n",PD_MI_ENTITY_POOL_AR_BAL));	
		
		// UpdateEntityBalance
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: UpdateEntityBalance\n"));
                BOObjPtr = CreateObj(BOPtr, "BOMiEntityBalance", "UpdateEntityBalance");
                iRet = (unsigned long)(*BOObjPtr)(hTxnRec,hTxnRec);
                if (iRet == PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: UpdateEntityBalance Success\n"));

                        if (GetField_CString(hTxnRec, "approval_date", &csApprovalDate)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: approval_date [%s]\n", csApprovalDate));
                        }

                        if (GetField_CString(hTxnRec, "approval_timestamp", &csApprovalTimestamp))  {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: approval_timestamp [%s]\n", csApprovalTimestamp));
                        }

                        // Open Balance
                        if (GetField_Double(hTxnRec, "open_acct_bal", &dTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: open_acct_bal = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "open_intransit", &dTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: open_intransit = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "open_ar_bal", &dTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: open_ar_bal = [%f]\n", dTmp));
                        }

                        // Close Balance
                        if (GetField_Double(hTxnRec, "acct_bal", &dTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: closing acct_bal = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "intransit", &dTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: closing intransit = [%f]\n", dTmp));
                        }

                        if (GetField_Double(hTxnRec, "ar_bal", &dTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: closing ar_bal = [%f]\n", dTmp));
                        }

                } else {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n"));
ERRLOG("TxnMinByUsDLI::ProcessRspAmtDiffTxn::Call BOMiEntityBalance:: UpdateEntityBalance Failed\n");
                        iRet = INT_ERR;
                }	
	}

	// Add TxnMiDetail
	if (iRet == PD_OK) {

/* do_logging */
                if(GetField_Int(hTxnRec,"do_logging",&iTmp)) {
DEBUGLOG(("ProcessRspAmtDiffTxn::do_logging [%d]\n", iTmp));

                        if (iTmp != PD_ADD_LOG) {
                                /* nothing */
                        } else {

                                 Add TxnMiDetail
                                if (iRet == PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTxnMiDetail:: Add\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBTxnMiDetail","Add");
                                        iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                                        if (iRet != PD_OK) {
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTxnMiDetail:: Add Failed\n"));
                                                iRet = INT_ERR;
                                        }
                                }
                        }
                }
	}

	// Update Status, Ar_Ind, Sub Status, Approval Date and Approval Timestamp
	if (iRet == PD_OK) {

/* status */
                PutField_Char(hTxnRec,"status",PD_COMPLETE);
DEBUGLOG(("ProcessRspAmtDiffTxn::status [%c]\n", PD_COMPLETE));

/* ar_ind */
                PutField_Char(hTxnRec,"ar_ind",PD_ACCEPT);
DEBUGLOG(("ProcessRspAmtDiffTxn::ar_ind [%c]\n", PD_ACCEPT));

/* sub_status */
                PutField_CString(hTxnRec,"sub_status",PD_APPROVED);
DEBUGLOG(("ProcessRspAmtDiffTxn::sub_status [%s]\n", PD_APPROVED));

/* approval_date */
                PutField_CString(hTxnRec, "approval_date", csApprovalDate);
DEBUGLOG(("ProcessRspAmtDiffTxn::approval_date [%s]\n", csApprovalDate));

/* approval_timestamp */
                PutField_CString(hTxnRec, "approval_timestamp", csApprovalTimestamp);
DEBUGLOG(("ProcessRspAmtDiffTxn::approval_timestamp [%s]\n", csApprovalTimestamp));

/* do_logging */
                PutField_Int(hTxnRec, "do_logging", PD_FALSE);
DEBUGLOG(("ProcessRspAmtDiffTxn:: do_logging [%d]\n", PD_FALSE));

DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTransaction: Update \n"));
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxnRec);
                if (iRet != PD_OK) {
                        iRet = INT_ERR;
DEBUGLOG(("ProcessRspAmtDiffTxn::Call DBTransaction:: Update Failed\n"));
                }
	}

DEBUGLOG(("ProcessRspAmtDiffTxn Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}

int     AddBatchInfo(hash_t* hBatchRec, hash_t* hRspDeliOutTxnRec, hash_t* hRspDeliInTxnRec, hash_t* hOpbFundInTxnRec, hash_t* hRspAmtDiffTxnRec)
{
	int     iRet = PD_OK;

	int     iTotalCnt = 0;
	int     i = 0;

	char	*csTmp = NULL;
		
	char    csBatchId[PD_TXN_SEQ_LEN + 1];

	// Generate Batch Id
DEBUGLOG(("AddBatchInfo::Call TxnSeq:: GetNextMiActionBatchSeq\n"));
       	DBObjPtr = CreateObj(DBPtr, "DBTxnSeq", "GetNextMiActionBatchSeq");
    	strcpy(csBatchId, (*DBObjPtr)());
DEBUGLOG(("AddBatchInfo::Call TxnSeq:: GetNextMiActionBatchSeq: [%s]\n",csBatchId));

	// Add Batch Header
       	if (iRet == PD_OK) {

        	// batch_id
              	PutField_CString(hBatchRec,"batch_id",csBatchId);

           	// process_type
             	PutField_CString(hBatchRec,"process_type",PD_MI_TXN_TYPE_DELIV_IN);

              	// status
               	PutField_Char(hBatchRec,"status",PD_MI_BATCH_STATUS_NORMAL);

DEBUGLOG(("AddBatchInfo::Call MiBatchHeader:: Add\n"));
            	DBObjPtr = CreateObj(DBPtr, "DBMiBatchHeader", "Add");
             	iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
             	if (iRet != PD_OK) {
                     	iRet = INT_ERR;
DEBUGLOG(("AddBatchInfo::Call MiBatchHeader:: Add Failed\n"));
            	}
      	}

	// Add Batch Detail
       	if (iRet == PD_OK) {   

		// RSP Delivery Out
		if (iRet == PD_OK) {
DEBUGLOG(("AddBatchInfo::RSP Delivery Out\n"));
		
			// entity_id
			if (GetField_CString(hRspDeliOutTxnRec,"entity_id",&csTmp)) {
				PutField_CString(hBatchRec,"entity_id",csTmp);
			}

                     	// party_type
                     	if (GetField_CString(hRspDeliOutTxnRec,"party_type",&csTmp)) {
                        	PutField_CString(hBatchRec,"party_type",csTmp);
			}

                    	// party_id
			if (GetField_CString(hRspDeliOutTxnRec,"entity_id",&csTmp)) {
                        	PutField_CString(hBatchRec,"party_id",csTmp);
			}

                        // txn_id
                        if (GetField_CString(hRspDeliOutTxnRec,"txn_seq",&csTmp)) { 
                       		PutField_CString(hBatchRec,"txn_id",csTmp);
			}

			// txn_oper_ind
                        PutField_Char(hBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_INSERT);
		
			// batch_id
                        PutField_CString(hBatchRec,"batch_id",csBatchId);

                        // seq
                        PutField_Int(hBatchRec,"seq",i++);
DEBUGLOG(("AddBatchInfo::seq = [%d]\n", i));

DEBUGLOG(("AddBatchInfo::Call MiBatchDetail: Add \n"));
                        DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
                        iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
                        if (iRet != PD_OK) {
                                iRet = INT_ERR;
DEBUGLOG(("AddBatchInfo::Call MiBatchDetail:: Add Failed\n"));
                        }	
		}

		// RSP Delivery In				
		if (iRet == PD_OK) {
DEBUGLOG(("AddBatchInfo::RSP Delivery In\n"));
		
			// entity_id
			if (GetField_CString(hRspDeliInTxnRec,"entity_id",&csTmp)) {
				PutField_CString(hBatchRec,"entity_id",csTmp);
			}

                     	// party_type
                     	if (GetField_CString(hRspDeliInTxnRec,"party_type",&csTmp)) {
                        	PutField_CString(hBatchRec,"party_type",csTmp);
			}

                    	// party_id
			if (GetField_CString(hRspDeliInTxnRec,"entity_id",&csTmp)) {
                        	PutField_CString(hBatchRec,"party_id",csTmp);
			}

                        // txn_id
                        if (GetField_CString(hRspDeliInTxnRec,"txn_seq",&csTmp)) { 
                       		PutField_CString(hBatchRec,"txn_id",csTmp);
			}

			// txn_oper_ind
                        PutField_Char(hBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_INSERT);
		
			// batch_id
                        PutField_CString(hBatchRec,"batch_id",csBatchId);

                        // seq
                        PutField_Int(hBatchRec,"seq",i++);
DEBUGLOG(("AddBatchInfo::seq = [%d]\n", i));

DEBUGLOG(("AddBatchInfo::Call MiBatchDetail: Add \n"));
                        DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
                        iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
                        if (iRet != PD_OK) {
                                iRet = INT_ERR;
DEBUGLOG(("AddBatchInfo::Call MiBatchDetail:: Add Failed\n"));
                        }	
		}

		// OPB Fund In
                if (iRet == PD_OK) {
DEBUGLOG(("AddBatchInfo::OPB Fund In\n"));
		
			// total_cnt
			if (GetField_CString(hOpbFundInTxnRec,"total_cnt",&iTotalCnt)) {
			{
				for (i=0; i<iTotalCnt; i++) {
                        		sprintf(csTag, "seb_exist_%d", i+1);
                        		if (GetField_Int(hTxnRec, csTag, &iTmp)) {
DEBUGLOG(("AddBatchInfo::[%s] = [%d]\n",csTag, iTmp));
					
						// entity_id
						if (GetField_CString(hOpbFundInTxnRec,"entity_id",&csTmp)) {
							PutField_CString(hBatchRec,"entity_id",csTmp);
						}
	
                     				// party_type
                     				if (GetField_CString(hOpbFundInTxnRec,"party_type",&csTmp)) {
                        				PutField_CString(hBatchRec,"party_type",csTmp);
						}

                    				// party_id
						if (GetField_CString(hOpbFundInTxnRec,"entity_id",&csTmp)) {
                        				PutField_CString(hBatchRec,"party_id",csTmp);
						}

                        			// txn_id
                        			if (GetField_CString(hOpbFundInTxnRec,"txn_seq",&csTmp)) { 
                       					PutField_CString(hBatchRec,"txn_id",csTmp);
						}

						// txn_oper_ind
                        			PutField_Char(hBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_INSERT);
			
						// batch_id
                        			PutField_CString(hBatchRec,"batch_id",csBatchId);

                        			// seq
                        			PutField_Int(hBatchRec,"seq",i++);
DEBUGLOG(("AddBatchInfo::seq = [%d]\n", i));

DEBUGLOG(("AddBatchInfo::Call MiBatchDetail: Add \n"));
                        			DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
                        			iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
                        			if (iRet != PD_OK) {
                                			iRet = INT_ERR;
DEBUGLOG(("AddBatchInfo::Call MiBatchDetail:: Add Failed\n"));
                        			}
					}	
				}
			}
		}

		// RSP Amt Diff
                if (iRet == PD_OK) {
DEBUGLOG(("AddBatchInfo::RSP Amt Diff\n"));
		
			// total_cnt
			if (GetField_CString(hRspAmtDiffTxnRec,"total_cnt",&iTotalCnt)) {
			{
				for (i=0; i<iTotalCnt; i++) {
                        		sprintf(csTag, "amtdiff_exist_%d", i+1);
                        		if (GetField_Int(hTxnRec, csTag, &iTmp)) {
DEBUGLOG(("AddBatchInfo::[%s] = [%d]\n",csTag, iTmp));
					
						// entity_id
						if (GetField_CString(hRspAmtDiffTxnRec,"entity_id",&csTmp)) {
							PutField_CString(hBatchRec,"entity_id",csTmp);
						}
	
                     				// party_type
                     				if (GetField_CString(hRspAmtDiffTxnRec,"party_type",&csTmp)) {
                        				PutField_CString(hBatchRec,"party_type",csTmp);
						}

                    				// party_id
						if (GetField_CString(hRspAmtDiffTxnRec,"entity_id",&csTmp)) {
                        				PutField_CString(hBatchRec,"party_id",csTmp);
						}

                        			// txn_id
                        			if (GetField_CString(hRspAmtDiffTxnRec,"txn_seq",&csTmp)) { 
                       					PutField_CString(hBatchRec,"txn_id",csTmp);
						}

						// txn_oper_ind
                        			PutField_Char(hBatchRec,"txn_oper_ind",PD_MI_BATCH_TXN_OPER_INSERT);
			
						// batch_id
                        			PutField_CString(hBatchRec,"batch_id",csBatchId);

                        			// seq
                        			PutField_Int(hBatchRec,"seq",i++);
DEBUGLOG(("AddBatchInfo::seq = [%d]\n", i));

DEBUGLOG(("AddBatchInfo::Call MiBatchDetail: Add \n"));
                        			DBObjPtr = CreateObj(DBPtr, "DBMiBatchDetail", "Add");
                        			iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
                        			if (iRet != PD_OK) {
                                			iRet = INT_ERR;
DEBUGLOG(("AddBatchInfo::Call MiBatchDetail:: Add Failed\n"));
                        			}
					}	
				}
			}
              	}
      	}

	// Add Batch Relation
        if (iRet == PD_OK) {

		// batch_id 
		PutField_CString(hBatchRec,"batch_id",csBatchId);

		// org_batch_id
		if (GetField_CString(hRspDeliOutTxnRec,"batch_id",&csTmp)) {	
			PutField_CString(hBatchRec,"org_batch_id",csTmp);
		}
	
		// relation_type
		PutField_Char(hBatchRec,"relation_type",PD_MI_BATCH_RELATION_TYPE_LINKAGE);	

DEBUGLOG(("AddBatchInfo::Call MiBatchRelation: Add \n"));
              	DBObjPtr = CreateObj(DBPtr, "DBMiBatchRelation", "Add");
              	iRet = (unsigned long)(*DBObjPtr)(hBatchRec);
              	if (iRet != PD_OK) {
                    	iRet = INT_ERR;
DEBUGLOG(("AddBatchInfo::Call MiBatchRelation:: Add Failed\n"));
		}
	}	

DEBUGLOG(("AddBatchInfo Normal Exit() iRet = [%d]\n",iRet));
        return iRet;
}
#endif
