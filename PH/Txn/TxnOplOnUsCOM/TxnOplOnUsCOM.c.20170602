/*
PDProTech (c)2017. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version (Clone from OLN)                      2017/03/13              Virginia Yun

*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOplOnUsCOM.h"
#include "myrecordset.h"
#include <math.h>
#include <ctype.h>

#define PD_MAX_NON_ASCII_CHAR 5

char cDebug;

void TxnOplOnUsCOM(char    cdebug)
{
        cDebug = cdebug;
}

OBJPTR(BO);
OBJPTR(DB);
int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	char	*csTmp;
	//char	*csPtr;
	//char	*csBuf;
	char	*csTxnCode;
	char	*csOrgTxnCode;
	char	*csTxnCcy;
	char	*csDstCcy;
	char	*csChannelCode;
	char	*csTxnCountry;
	char*	csServiceCodeForURL=strdup("");
	char*	csServiceCode;
	char*	csLanguage;
	char*	csMerchantId;
	double	dTxnAmt = 0.0;
	long	lTmp;
	int	iTmp = 0;

	char*	csPayoutGroup = NULL;
	char	csTrimPayoutGroup[PD_OFL_PAYOUT_GROUP_LEN + 1];
	

DEBUGLOG(("TxnOplOnUsCOM: Authroize()\n"));	
	if(GetField_CString(hRequest,"merchant_id",&csMerchantId)){
DEBUGLOG(("Authorize::merchant id[%s]\n",csMerchantId));
	}

/* field checking */

	GetField_CString(hContext,"txn_code",&csTxnCode);
DEBUGLOG(("Authorize::txn_code Context[%s]\n",csTxnCode));

	if (GetField_CString(hResponse,"org_txn_code",&csOrgTxnCode)) {
DEBUGLOG(("Authorize::org_txn_code [%s]\n",csOrgTxnCode));
	}


	GetField_CString(hContext,"channel_code",&csChannelCode);
DEBUGLOG(("Authorize::channel_code Context[%s]\n",csChannelCode));

	
	if (GetField_CString(hRequest,"txn_country",&csTxnCountry)) {
DEBUGLOG(("Authorize:: txn_country = [%s]\n",csTxnCountry));
	}
	else  {
		iRet =	INT_TXN_COUNTRY_NOT_FOUND;
		PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() txn_country is missing\n"));
ERRLOG("Authorize() txn_country is missing\n");
	}

/* check service code */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest,"service_code",&csServiceCode)) {
        		PutField_CString(hContext,"service_code",csServiceCode);
			csServiceCodeForURL = strdup(csServiceCode);
DEBUGLOG(("Authorize() service_code = [%s]\n",csServiceCode));
		}
		else {
DEBUGLOG(("Authorize() service code not found!!!\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() service code not found!!!\n");
			iRet = INT_SERVICE_CODE_MISSING;
			PutField_Int(hContext,"internal_error",iRet);
		}
	}

/*check currency code*/
	if(iRet == PD_OK){
		if(GetField_CString(hRequest,"txn_ccy",&csTxnCcy)){
			DBObjPtr = CreateObj(DBPtr,"DBCurrency","FindCurrency");
			if ((unsigned long)(DBObjPtr)(csTxnCcy) == FOUND) {
DEBUGLOG(("Authorize() DBCurrency->FindCurrency [%s]success\n",csTxnCcy));
/* net ccy */
				PutField_CString(hContext,"net_ccy",csTxnCcy);
				PutField_CString(hContext,"org_txn_ccy",csTxnCcy);
			}
			else{
				iRet = INT_INVALID_CURRENCY_CODE;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Currency code invalid [%s]\n",csTxnCcy));
ERRLOG("TxnOplOnUsCOM:Authorize() Currency code invalid\n");
			}
		}
		else{
			iRet = INT_CURRENCY_CODE_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Currency code not found\n"));
ERRLOG("TxnOplOnUsCOM:Authorize() Currency code not found\n");
		}
	}


/*check dest currency code*/
	if(iRet == PD_OK){
		if(GetField_CString(hRequest,"dest_txn_ccy",&csDstCcy)){
			DBObjPtr = CreateObj(DBPtr,"DBCurrency","FindCurrency");
			if ((unsigned long)(DBObjPtr)(csDstCcy) == FOUND) {
DEBUGLOG(("Authorize() (Dest) DBCurrency->FindCurrency [%s]success\n",csDstCcy));

				PutField_CString(hContext,"dest_txn_ccy",csDstCcy);
                                        
			}
			else{
				iRet = INT_INVALID_CURRENCY_CODE;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() (Dest) Currency code invalid [%s]\n",csDstCcy));
ERRLOG("TxnOplOnUsCOM:Authorize() Dest Currency code invalid\n");
			}
		}
		else{
			iRet = INT_CURRENCY_CODE_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Dest Currency code not found\n"));
ERRLOG("TxnOplOnUsCOM:Authorize() Dest Currency code not found\n");
		}
	}

/*check pay amount*/
	if (iRet == PD_OK) {
		if(GetField_CString(hRequest,"txn_amt",&csTmp)) {
			int iCheck = PD_FALSE;
DEBUGLOG(("Authorize() txn_amt from request[%s]\n",csTmp));

			iCheck = is_numeric(csTmp);
			if(iCheck==PD_FALSE){
				iRet =	INT_INVALID_PAY_AMOUNT;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() txn_amt Invalid[%s]\n",csTmp));
ERRLOG("TxnOplOnUsCOM::Authorize() txn_amt Invalid\n");
			}	
			else {
				if(strlen(csTmp)>(PD_DIGIT_LEN+PD_DECIMAL_LEN)){
					iRet =	INT_INVALID_PAY_AMOUNT;
					PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()txn_amt length too long[%s]\n",csTmp));
ERRLOG("TxnOplOnUsCOM::Authorize() txn_amt length too long\n");
				}
				else{
					dTxnAmt = myctod((const unsigned char *)csTmp,strlen(csTmp) - PD_DECIMAL_LEN,PD_DECIMAL_LEN);
					PutField_Double(hContext,"txn_amt",dTxnAmt);
					PutField_Double(hContext,"org_txn_amt",dTxnAmt);
DEBUGLOG(("Authorize() txn_amt = [%f]\n",dTxnAmt));

					if (dTxnAmt <= 0) {
						iRet = INT_INVALID_PAY_AMOUNT;
						PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() txn_amt cannot be zero\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() txn_amt cannot be zero\n");
					}
				}
			}

/* if TWD */
			if (iRet==PD_OK) {
DEBUGLOG(("Authorize() check is support decimal\n"));
				DBObjPtr = CreateObj(DBPtr,"DBCurrency","IsSupportDecimal");
				if ((unsigned long)((DBObjPtr)(csTxnCcy))!=PD_TRUE){
DEBUGLOG(("Authorize() [%s] doesn't support decimal\n",csTxnCcy));
					lTmp = (long) dTxnAmt;
					if (dTxnAmt > lTmp) {
						iRet = INT_UNSUPPORTED_PAY_AMOUNT;
						PutField_Int(hContext,"internal_error",iRet);
ERRLOG("TxnOplOnUsCOM::Authorize() unsupported transaction amount [%f]\n",dTxnAmt);
					}
				}
			}

/* if TW */
			if(iRet==PD_OK){
				if(!strcmp(csTxnCountry,PD_TAIWAN)){
DEBUGLOG(("Authorize() [%s] doesn't support decimal\n",csTxnCountry));
					lTmp = (long) dTxnAmt;
					if (dTxnAmt > lTmp) {
						iRet = INT_UNSUPPORTED_PAY_AMOUNT;
						PutField_Int(hContext,"internal_error",iRet);
ERRLOG("TxnOplOnUsCOM::Authorize() unsupported transaction amount [%f]\n",dTxnAmt);
					}
				}
			}
		}
		else {
			iRet = INT_PAY_AMOUNT_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() txn_amt not found\n"));
ERRLOG("TxnOplOnUsCOM:Authorize() txn_amt not found\n");
		}	
	}


/*check reference*/
	if(iRet == PD_OK){
		if(GetField_CString(hRequest,"merchant_ref",&csTmp)){
DEBUGLOG(("Authorize() merchant_ref = [%s]\n",csTmp));
		}
		else{
			iRet = INT_REFERENCE_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()reference not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() reference not found\n");
		}
	}

/*check time*/
	if(iRet == PD_OK){
		if(GetField_CString(hRequest,"transmission_datetime",&csTmp)){
DEBUGLOG(("Authorize() transmission_datetime = [%s]\n",csTmp));
			if(check_valid_datetime(csTmp)!=PD_OK){
				iRet = INT_TRASMISSION_TIME_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() transmission_datetime invalid\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() transmission_datetime invalid\n");
			}
		}
		else{
			iRet = INT_TRASMISSION_TIME_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize()transmission_datetime not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() transmission_datetime not found\n");
		}
	}



/* TW Mandatory */
	if(!strcmp(csTxnCountry,PD_TAIWAN)){
/* identity id */
		if(iRet == PD_OK){
			if(GetField_CString(hRequest,"identity_id",&csTmp)){
DEBUGLOG(("Authorize() identity_id = [%s]\n",csTmp));
			}
			else{
                        	iRet = INT_IDENTITY_ID_NOT_FOUND;
	                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() identity_id not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() identity_id not found\n");
			}
		}

/* bcode : Bank Code of Beneficiary Bank Account */ 
		if(iRet == PD_OK){
			if(GetField_CString(hRequest,"bcode",&csTmp)){
DEBUGLOG(("Authorize() bcode = [%s]\n",csTmp));
			}
			else{
				iRet = INT_BANK_CODE_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() bcode not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() bcode not found\n");
			}
		}
	}

/* bban: Beneficiary Bank Account Number */
	if(iRet == PD_OK){
		if(GetField_CString(hRequest,"bban",&csTmp)){
DEBUGLOG(("Authorize() bban = [%s]\n",csTmp));
		}
		else{
			iRet = INT_BANK_ACCT_NUM;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() bban not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() bban not found\n");
		}
	}


/* bbaname: Beneficiary Bank Account Name */
	if(iRet == PD_OK){
		if(GetField_CString(hRequest,"bbaname",&csTmp)){
DEBUGLOG(("Authorize() bbaname = [%s]\n",csTmp));
		}
		else{
			iRet = INT_BANK_AC_NAME_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() bbaname not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() bbaname not found\n");
		}

		if (iRet == PD_OK) {
			int iCheckName = PD_TRUE;
			char *p;
			char *csValueTmp;
			csValueTmp = (char*) malloc (PD_SP_LONG_VALUE_LEN);

			DBObjPtr = CreateObj(DBPtr, "DBSystemParameter", "FindCode");
			if ((unsigned long)(DBObjPtr)("SKIP_CHECK_ACCT_NAME", csValueTmp) == FOUND) {
DEBUGLOG(("Authorize() merchants not check bank account name = [%s]\n", csValueTmp));
				p = strtok(csValueTmp, ",");
				while (p != NULL) {
					if (strcmp(csMerchantId, p)) {
						p = strtok(NULL, ",");
					} else {
						iCheckName = PD_FALSE;
						break;
					}
				}
			}
			FREE_ME(csValueTmp);

			if (iCheckName) {
				int iCnt = 0;
				int j = 0;
				for (j = 0; j < strlen(csTmp); j++) {
					if (!isascii(csTmp[j])) {
						iCnt++;
					}
				}
				if (iCnt >= (3 * PD_MAX_NON_ASCII_CHAR)) {
					DBObjPtr = CreateObj(DBPtr, "DBOLRulePayoutWhiteList", "InWhiteList");
					if ((unsigned long)(DBObjPtr)(csMerchantId, csTmp) == PD_TRUE) {
DEBUGLOG(("Authorize() bank account name in white list = [%s]\n", csTmp));
					} else {
						iRet = INT_INVALID_BANK_AC_NAME;
						PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() Beneficiary Bank Account Name not in white list\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() Beneficiary Bank Account Name not in white list\n");
					}
				}
			}
		}
	}

/* bname: Bank Name of Beneficiary Bank Account */
	if(iRet == PD_OK){
		if(GetField_CString(hRequest,"bname",&csTmp)){
DEBUGLOG(("Authorize() bname = [%s]\n",csTmp));
		}
		else{
			iRet = INT_BANK_NAME_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() bname not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() bname not found\n");
		}
	}


/* branch : Branch Name of Beneficiary Bank Account */
	if(iRet == PD_OK){
		if(GetField_CString(hRequest,"branch",&csTmp)){
DEBUGLOG(("Authorize() branch_name = [%s]\n",csTmp));
		}
		else{
			iRet = INT_BRANCH_NAME_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() branch not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() branch not found\n");
		}
	}


/* China Mandatory */
	if(!strcmp(csTxnCountry,PD_CHINA)){
/* bank_prov  */
		if(iRet == PD_OK){
			if(GetField_CString(hRequest,"bank_prov",&csTmp)){
DEBUGLOG(("Authorize() bank_prov = [%s]\n",csTmp));
			}
			else{
				iRet = INT_BANK_PROV_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() bank_prov not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() bank_prov not found\n");
			}
		}

/* bank_city  */
		if(iRet == PD_OK){
			if(GetField_CString(hRequest,"bank_city",&csTmp)){
DEBUGLOG(("Authorize() bank_city =[%s]\n",csTmp));
			}
			else{
				iRet = INT_BANK_CITY_NOT_FOUND;
				PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() bank_city not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() bank_city not found\n");
			}
		}
	}

/*check language*/
	if(GetField_CString(hResponse,"org_language",&csTmp)){
DEBUGLOG(("Authorize() language =[%s]\n",csTmp));
		csLanguage = strdup(csTmp);
		PutField_CString(hResponse,"language",csLanguage);
	}
	else if(GetField_CString(hRequest,"language",&csTmp)){
DEBUGLOG(("Authorize() language =[%s]\n",csTmp));
		csLanguage = strdup(csTmp);
		PutField_CString(hResponse,"language",csLanguage);
	}
	else{
		PutField_CString(hResponse,"language",PD_DEF_LANGUAGE);
		csLanguage = strdup(PD_DEF_LANGUAGE);
DEBUGLOG(("Authorize() DEF language =[%s]\n",csLanguage));
	}


/*check success url*/
	if(iRet == PD_OK){
		if(GetField_CString(hRequest,"success_callback_url",&csTmp)){
DEBUGLOG(("Authorize() success_callback_url =[%s]\n",csTmp));
		}
		else{
			iRet = INT_SUCC_CB_URL_NOT_FOUND;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() success_callback_url not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() success_callback_url not found\n");
		}
	}

/*check failure url*/
        if(iRet == PD_OK){
                if(GetField_CString(hRequest,"failure_callback_url",&csTmp)){
DEBUGLOG(("Authorize() failure_callback_url =[%s]\n",csTmp));
                }
                else{
                        iRet = INT_FAIL_CB_URL_NOT_FOUND;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() failure_callback_url not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() failure_callback_url not found\n");
                }
        }

/* check version */
	if (iRet == PD_OK) {
                if(GetField_Int(hRequest,"version_no",&iTmp)){
DEBUGLOG(("Authorize() version_no =[%d]\n",iTmp));
		}
                else{
                        iRet = INT_INVALID_TXN;
                        PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() version_no not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() version_no not found\n");
                }

	}


/*******************/

	if ( iRet == PD_OK) {
/* Check Merchant */
DEBUGLOG(("Authorize() call BOOLMerchant->GetMerchantTxnInfo\n"));
		BOObjPtr = CreateObj(BOPtr,"BOOLMerchant","GetMerchantTxnInfo");
		iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("Authorize() BOOLMerchant->GetMerchantTxnInfo = [%d]\n",iRet));

	}

	if ( iRet == PD_OK) {
/*check config*/
DEBUGLOG(("Authorize() call OLMerchConfig->CheckConfig\n"));
		DBObjPtr = CreateObj(DBPtr,"DBOLMerchConfig","CheckConfig");
		if ((unsigned long)((*DBObjPtr)(csMerchantId,
						csTxnCountry,
						csTxnCcy,
						csServiceCode)) != PD_FOUND) {
			iRet = INT_INVALID_TXN;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() Merchant Config Not Found!! [%d]\n",iRet));
ERRLOG("TxnOplOnUsCOM:Authorize() Merchant Config Not Found!!\n");
		}
	}



	if(iRet == PD_OK){
/* Check Support Payout Group Flag */

		hash_t  *hMerchRec;
		recordset_t     *rMerchRecordSet;
		rMerchRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
		recordset_init(rMerchRecordSet,0);
		int	iPayoutGrp = PD_TRUE;

		DBObjPtr = CreateObj(DBPtr,"DBOLMerchDetail","GetMerchant");
		if ((*DBObjPtr)(csMerchantId, rMerchRecordSet) != PD_OK) {
			iRet = INT_MERCHANT_ID_NOT_FOUND;
DEBUGLOG(("Authorize() merchant_id not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() merchant_id not found\n");
		} else {
	        	hMerchRec = RecordSet_GetFirst(rMerchRecordSet);
	                while (hMerchRec) {
                        	if (GetField_Int(hMerchRec,"support_payout_grp",&iPayoutGrp)) {
DEBUGLOG(("Authorize() GetMerchantDetail - support_payout_grp = [%d]\n",iPayoutGrp));
				}

				hMerchRec = RecordSet_GetNext(rMerchRecordSet);
			}
		}

		if (iRet == PD_OK) {

			if(GetField_CString(hRequest,"payout_group",&csPayoutGroup)){
DEBUGLOG(("Authorize() payout_group =[%s]\n", csPayoutGroup));
			} else {
				// No Payout_group in Request
				if (iPayoutGrp == PD_TRUE) {
					iRet = INT_PAYOUT_GRP_NOT_FOUND;
                                	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() payout_group not found\n"));
ERRLOG("TxnOplOnUsCOM::Authorize() payout_group not found\n");
		                }						
			}
		}

		if (iRet == PD_OK) {
			if (csPayoutGroup != NULL) {
DEBUGLOG(("Authorize() Validate PayoutGroup\n"));

				/* Valid Pattern */
				if (strlen(csPayoutGroup) != PD_OFL_PAYOUT_GROUP_LEN) {
					iRet = INT_INVALID_PAYOUT_GRP;
                                	PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() payout_group invalid \n"));
ERRLOG("TxnOplOnUsCOM::Authorize() payout_group invalid\n");
				} else {
					if (((csPayoutGroup[0] >= 'A') && (csPayoutGroup[0] <= 'Z')) ||
                                            ((csPayoutGroup[0] >= '0') && (csPayoutGroup[0] <= '9')))  {

						if (((csPayoutGroup[1] >= 'A') && (csPayoutGroup[1] <= 'Z')) ||
						    ((csPayoutGroup[1] >= '0') && (csPayoutGroup[1] <= '9')) ||
						     (csPayoutGroup[1] == ' ')) {
DEBUGLOG(("Authorize() payout_group validation success\n"));
						} else {
							iRet = INT_INVALID_PAYOUT_GRP;
							PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() payout_group (validation 1) invalid \n"));
ERRLOG("TxnOplOnUsCOM::Authorize() payout_group (validation 1) invalid\n");
						}
					} else {
						iRet = INT_INVALID_PAYOUT_GRP;
						PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("Authorize() payout_group (validation 0) invalid \n"));
ERRLOG("TxnOplOnUsCOM::Authorize() payout_group (validation 0) invalid\n");
					}
				}

				if (iRet == PD_OK) {
					strcpy(csTrimPayoutGroup,TrimRight((const unsigned char*)csPayoutGroup,strlen(csPayoutGroup)));
DEBUGLOG(("Authorize() Trim payout_group [%s]\n", csTrimPayoutGroup));
					PutField_CString(hContext,"payout_group",csTrimPayoutGroup);
				}
			}

			

		}
			
		RecordSet_Destroy(rMerchRecordSet);
		FREE_ME(rMerchRecordSet);
	}

	FREE_ME(csServiceCodeForURL);
	FREE_ME(csLanguage);
DEBUGLOG(("TxnOplOnUsCOM:: exit = [%d]\n",iRet));
	return iRet;
}
