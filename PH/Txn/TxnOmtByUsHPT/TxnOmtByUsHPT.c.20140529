/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/01/21              Stan Poon
*/


#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "dbutility.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsHPT.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);

void TxnOmtByUsHPT(char cdebug)
{
	cDebug = cdebug;
}

int Authorize(hash_t* hContext,
		hash_t* hRequest,
		hash_t* hResponse)
{
	int	iRet = PD_OK;
	char	*csTmp=NULL;
	char	*csTxnSeq=NULL, *csHoldType=NULL, *csUser=NULL;
	char	cStatus, cArInd, *csSubStatus=NULL;

	hash_t *hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn,0);

	recordset_t* myRec;
	hash_t *hRec;

/* txn_seq */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "org_txn_seq", &csTxnSeq)) {
			PutField_CString(hTxn,"txn_seq",csTxnSeq);
DEBUGLOG(("Authorize() txn_seq = [%s]\n", csTxnSeq));
		} else {
			iRet = INT_TXN_ID_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() txn_seq is missing!!!\n"));
ERRLOG("TxnOmtByUsHPT::Authorize() txn_seq is missing!!!\n");
		}
	}
/* hold_type */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "hold_type", &csHoldType)) {
DEBUGLOG(("Authorize() hold_type = [%c]\n", csHoldType[0]));
			if (csHoldType[0] == PD_HOLD_TYPE) {
				PutField_Int(hTxn,"txn_hold_ind",1);
			} else if (csHoldType[0] == PD_UNHOLD_TYPE){
				PutField_Int(hTxn,"txn_hold_ind",0);
			} else {
				iRet = INT_INVALID_TXN;
				PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() hold_type error!!!\n"));
ERRLOG("TxnOmtByUsHPT::Authorize() hold_type error!!!\n");
			}
		} else {
			iRet = INT_INVALID_TXN;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() hold_type is missing!!!\n"));
ERRLOG("TxnOmtByUsHPT::Authorize() hold_type is missing!!!\n");
		}
	}
/* remark */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "remark", &csTmp)) {
			PutField_CString(hTxn,"remark",csTmp);
DEBUGLOG(("Authorize() remark = [%s]\n", csTmp));
		}
	}
/* user */
	if (iRet == PD_OK) {
		if (GetField_CString(hRequest, "add_user", &csUser)) {
DEBUGLOG(("Authorize() user = [%s]\n", csUser));
		} else {
			iRet = INT_USER_NOT_FOUND;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() user is missing!!!\n"));
ERRLOG("TxnOmtByUsHPT::Authorize() user is missing!!!\n");
		}
	}

/* Get Ol Txn Psp Detail */
	if (iRet == PD_OK) {
		hRec = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hRec,0);
DEBUGLOG(("Authorize() call DBOLTxnPspDetail:: GetTxnPspDetail()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "GetTxnPspDetail");
		if ((unsigned long)(*DBObjPtr)(csTxnSeq,hRec) != PD_OK) {
			iRet = INT_INVALID_TXN;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call DBOLTxnPspDetail:: GetTxnPspDetail() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsHPT::Authorize() call DBOLTxnPspDetail:: GetTxnPspDetail() FAILURE!!!\n");
		}
		hash_destroy(hRec);
		FREE_ME(hRec);
	}

/* MatchRespTxn */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLTransaction:: MatchRespTxn()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "MatchRespTxn");
		if ((unsigned long)(*DBObjPtr)(csTxnSeq,PD_COMPLETE) != PD_FOUND) {
			iRet = INT_INVALID_TXN;
			PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() call DBOLTransaction:: MatchRespTxn() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsHPT::Authorize() call DBOLTransaction:: MatchRespTxn() FAILURE!!!\n");
		}
	}

/* Get Ol Txn Header */
	if (iRet == PD_OK) {
		myRec = (recordset_t*) malloc (sizeof(recordset_t));
		recordset_init(myRec,0);

DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "GetTxnHeader");
		if ((unsigned long)(*DBObjPtr)(csTxnSeq,myRec) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsHPT::Authorize() call DBOLTransaction:: GetTxnHeader() FAILURE!!!\n");
		} else {
			hRec = RecordSet_GetFirst(myRec);
			if (hRec) {
				if (GetField_Char(hRec,"status",&cStatus)) {
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() status = [%c]\n",cStatus));
				}
				if (GetField_Char(hRec,"ar_ind",&cArInd)) {
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() ar_ind = [%c]\n",cArInd));
				}
				if (GetField_CString(hRec,"sub_status",&csSubStatus)) {
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() sub_status = [%s]\n",csSubStatus));
				}

			/* status, ar_ind, sub_status */
				if (cStatus != PD_COMPLETE) {
					iRet = INT_INVALID_TXN;
					PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() Invalid status = [%c]\n",cStatus));
ERRLOG("TxnOmtByUsCTT::Authorize() Invalid status!!!\n");
				}
				if (cArInd != PD_ACCEPT) {
					iRet = INT_INVALID_TXN;
					PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() Invalid ar_ind = [%c]\n",cArInd));
ERRLOG("TxnOmtByUsCTT::Authorize() Invalid ar_ind!!!\n");
				}
				if (strcmp(csSubStatus,PD_UNALLOCATED)) {
					iRet = INT_INVALID_TXN;
					PutField_Int(hContext, "internal_error", iRet);
DEBUGLOG(("Authorize() Invalid sub_status = [%s]\n",csSubStatus));
ERRLOG("TxnOmtByUsCTT::Authorize() Invalid sub_status!!!\n");
				}
			} else {
				iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction:: GetTxnHeader() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsHPT::Authorize() call DBOLTransaction:: GetTxnHeader() FAILURE\n");
			}
		}

		RecordSet_Destroy(myRec);
		FREE_ME(myRec);
	}

/* Update Ol Txn Header */
	if (iRet == PD_OK) {
		//PutField_Char(hTxn,"status",PD_COMPLETE);
		//PutField_Char(hTxn,"ar_ind",PD_ACCEPT);
		//PutField_CString(hTxn,"sub_status",csSubStatus);
		PutField_CString(hTxn,"update_user",csUser);
DEBUGLOG(("Authorize() call DBOLTransaction:: Update()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
		if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTransaction:: Update() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsHPT::Authorize() call DBOLTransaction:: Update() FAILURE!!!\n");
		}
	}

/* Update Ol Txn Psp Detail */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize() call DBOLTxnPspDetail:: Update()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnPspDetail", "Update");
		if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTxnPspDetail:: Update() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsHPT::Authorize() call DBOLTxnPspDetail:: Update() FAILURE!!!\n");
		}
	}

/* Add Ol Txn Remarks */
	if (iRet == PD_OK) {
		PutField_CString(hTxn,"add_user",csUser);
DEBUGLOG(("Authorize() call DBOLTxnDepositHoldLog:: Add()\n"));
		DBObjPtr = CreateObj(DBPtr, "DBOLTxnDepositHoldLog", "Add");
		if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
			iRet = INT_ERR;
DEBUGLOG(("Authorize() call DBOLTxnDepositHoldLog:: Add() FAILURE!!!\n"));
ERRLOG("TxnOmtByUsHPT::Authorize() call DBOLTxnDepositHoldLog:: Add() FAILURE!!!\n");
		}
	}

	hash_destroy(hTxn);
	FREE_ME(hTxn);

DEBUGLOG(("Authorize() Normal Exit! iRet = [%d]\n", iRet));
	return iRet;
}

