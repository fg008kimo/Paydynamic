/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Initial Version					   2011/10/24		   LokMan Chow
don't do cancel approve here			   2013/01/10		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnMgtByUsPON.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

#define       PD_DETAIL_TAG   "dt"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);


void TxnMgtByUsPON(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
        int     i = 0;
        int     iCnt = 0;
        int     iDtlRet = 0;
        int     iStatus = 0;
        char    *csTmp;
	char	cParty;
	char	cInputInd;
	char	csTag[PD_TAG_LEN+1];

	hash_t  *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

DEBUGLOG(("Authorize\n"));
	if(GetField_CString(hRequest,"input_ind",&csTmp)){
		cInputInd = csTmp[0];
		PutField_Char(hContext,"input_ind",cInputInd);
DEBUGLOG(("Authorize::input_ind= [%c]\n",cInputInd));
	}

	if(GetField_CString(hRequest,"party",&csTmp)){
		cParty = csTmp[0];
DEBUGLOG(("Authorize::party= [%c]\n",cParty));
	}

        if(GetField_CString(hRequest,"remark",&csTmp)){
		PutField_CString(hContext,"remark",csTmp);
DEBUGLOG(("Authorize::remark= [%s]\n",csTmp));
        }

	if(GetField_CString(hRequest,"psp_date",&csTmp)){
DEBUGLOG(("Authorize::psp_date= [%s]\n",csTmp));
	}

        if(GetField_CString(hRequest,"add_user",&csTmp)){
		PutField_CString(hContext,"update_user",csTmp);
DEBUGLOG(("Authorize::add_user= [%s]\n",csTmp));
        }


/* file_id */
	if(cInputInd == PD_BY_FILE){
		if(GetField_CString(hRequest,"file_id",&csTmp)){
			PutField_CString(hContext,"file_id",csTmp);
			PutField_Int(hContext,"status",PAYOUT_MASTER_TRANSACTION_GENERATED);
			PutField_Int(hContext,"upload_status",PAYOUT_MASTER_TRANSACTION_GENERATED);
DEBUGLOG(("Authorize::file_id= [%s]\n",csTmp));
		}
		else{
DEBUGLOG(("Authorize::file_id not found!!\n"));
ERRLOG("TxnMgtByUsPON:Authorize::file_id not found!!\n");
                        iRet=INT_ERR;
                }
	}

/* batch_id */
	else if(cInputInd == PD_BY_BATCH){
		if(GetField_CString(hRequest,"batch_id",&csTmp)){
			PutField_CString(hContext,"batch_id",csTmp);
DEBUGLOG(("Authorize::batch_id= [%s]\n",csTmp));
		}
		else{
DEBUGLOG(("Authorize::batch_id not found!!\n"));
ERRLOG("TxnMgtByUsPON:Authorize::batch_id not found!!\n");
                        iRet=INT_ERR;
                }
	}

/* specified records */
	else if(cInputInd == PD_BY_TXN){
		if (GetField_Int(hContext, "total_cnt", &iCnt)) {
DEBUGLOG(("Authorize::total_cnt = [%d]\n", iCnt));
			//PutField_Int(hResponse, "total_cnt", iCnt);
		}
		else {
DEBUGLOG(("Authorize::total_cnt not found\n"));
ERRLOG("TxnMgtByUsPON::Authorize::total_cnt not found\n");
			iRet = INT_ERR;
		}

		if (iRet == PD_OK) {
			for (i = 0; i < iCnt; i++) {
				hash_init(hTxn, 0);
/* batch_id */
				sprintf(csTag, "%s_batchid_%d", PD_DETAIL_TAG, i+1);
				if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("Authorize::() [%s] = [%s]\n", csTag, csTmp));
					sprintf(csTag, "batch_id_%d",i);
					PutField_CString(hContext,csTag,csTmp);
				}
				else {
DEBUGLOG(("Authorize::[%s] not found\n", csTag));
ERRLOG("TxnMgtByUsPON::Authorize::[%s] not found\n", csTag);
                                	iDtlRet = INT_ERR;
				}

/* seq_num */
				sprintf(csTag, "%s_seq_num_%d", PD_DETAIL_TAG, i+1);
				if (GetField_CString(hRequest, csTag, &csTmp)) {
DEBUGLOG(("Authorize::() [%s] = [%s]\n", csTag, csTmp));
					sprintf(csTag, "seq_num_%d",i);
					PutField_CString(hContext,csTag,csTmp);
				}
				else {
DEBUGLOG(("Authorize::[%s] not found\n", csTag));
ERRLOG("TxnMgtByUsPON::Authorize::[%s] not found\n", csTag);
                                	iDtlRet = INT_ERR;
				}
			}
			if(iDtlRet!=PD_OK){
				iRet = INT_ERR;
			}
		}
	}


	if(iRet==PD_OK){
		if(cInputInd != PD_BY_FILE){
DEBUGLOG(("Authorize::call BOPayout->GetPayoutRecordsByMode\n"));
			BOObjPtr = CreateObj(BOPtr,"BOPayout","GetPayoutRecordsByMode");
			iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest,hResponse);
		}
		else{
DEBUGLOG(("Authorize::call BOPayout->HandleCancelGenerate\n"));
			BOObjPtr = CreateObj(BOPtr,"BOPayout","HandleCancelGenerate");
			iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest,hResponse);
		}
	}

	if((iRet==PD_OK) && (cInputInd != PD_BY_FILE)){
		iCnt = 0;
		if(GetField_Int(hContext,"total_cnt",&iCnt)){
DEBUGLOG(("Authorize::GetPayoutRecords total_cnt = [%d]\n", iCnt));
		}
		for(i=0; i<iCnt; i++){
			PutField_Int(hContext,"position",i);
			sprintf(csTag,"status_%d",i);
			if(GetField_Int(hRequest,csTag,&iStatus)){
				if(iStatus == PAYOUT_MASTER_TRANSACTION_UPLOADED){
DEBUGLOG(("Authorize::call BOPayout->HandleCancelUpload\n"));
					BOObjPtr = CreateObj(BOPtr,"BOPayout","HandleCancelUpload");
					iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest,hResponse);
				}
				else if(iStatus == PAYOUT_MASTER_TRANSACTION_CONFIRMED){
					if(cParty==PD_TYPE_MERCHANT){
DEBUGLOG(("Authorize::BOPayout:HandleCancelConfirm Merchant cannot cancel confirmed\n"));
					}
					else{
						BOObjPtr = CreateObj(BOPtr,"BOPayout","HandleCancelConfirm");
						iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest,hResponse);
					}
				}
//				else if(iStatus == PAYOUT_MASTER_TRANSACTION_APPROVED){
//DEBUGLOG(("Authorize::call BOPayout->HandleCancelApprove\n"));
//					BOObjPtr = CreateObj(BOPtr,"BOPayout","HandleCancelApprove");
//					iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest,hResponse);
//				}
				else{
					/////////DO NOTHING
				}
			}
		}
	}


DEBUGLOG(("TxnMgtByUsPON Normal Exit() iRet = [%d]\n",iRet));
	FREE_ME(hTxn);
        return iRet;
}
