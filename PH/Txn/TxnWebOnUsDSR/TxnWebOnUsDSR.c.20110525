/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/05/16              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnWebOnUsDSR.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(Txn);
OBJPTR(DB);
OBJPTR(BO);

void TxnWebOnUsDSR(char    cdebug)
{
        cDebug = cdebug;
}
int     AddFeeChgLog(hash_t* hContext,hash_t* hResponse);

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	char*	csOrgTxnSeq;
	char*	csOrgTxnCountry;
	char*   csPspId;
	char*   csPspChannel;
	char*	csPtr;
	char	cPtr;
	double	dTmp;

	hash_t	*hRec,*hReq, *hRsp;


	recordset_t     *rRecordSet;   

	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);


DEBUGLOG(("TxnWebOnUsDSR::Authroize()\n"));
	if (GetField_CString(hRequest,"org_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("TxnWebOnUsDSR::from txn seq  = [%s]\n",csOrgTxnSeq));
		PutField_CString(hContext,"from_txn_seq",csOrgTxnSeq);
		PutField_CString(hResponse,"txn_seq",csOrgTxnSeq);
	}
	else {
DEBUGLOG(("TxnWebOnUsDSR::org txn seq not found\n"));
	}

	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
                if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("TxnWebOnUsDSR::found record = [%s]\n",csOrgTxnSeq));
                	hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
                        	if (GetField_Char(hRec,"status",&cPtr)){
DEBUGLOG(("TxnWebOnUsDSR::status = [%c]\n",cPtr));
                                }
                                 if (GetField_CString(hRec,"service_code",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - service_code = [%s]\n",csPtr));
                                 	PutField_CString(hResponse,"service_code",csPtr);
                                 	PutField_CString(hContext,"org_service_code",csPtr);
                                 }
                                 if (GetField_CString(hRec,"local_tm_date",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - local_tm_date = [%s]\n",csPtr));
                                 	PutField_CString(hResponse,"local_tm_date",csPtr);
                                 }
                                 if (GetField_CString(hRec,"txn_code",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - org_txn_code = [%s]\n",csPtr));
                                 	PutField_CString(hResponse,"org_txn_code",csPtr);
                                 	PutField_CString(hContext,"org_txn_code",csPtr);
                                 }
                                 if (GetField_CString(hRec,"client_id",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - org_client_id = [%s]\n",csPtr));
                                 	PutField_CString(hContext,"merchant_client_id",csPtr);
                                 }
                                 if (GetField_CString(hRec,"merchant_id",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - org_merchant_id = [%s]\n",csPtr));
                                 	PutField_CString(hContext,"merchant_id",csPtr);
                                 	PutField_CString(hContext,"org_merchant_id",csPtr);
                                 }
                                 if (GetField_CString(hRec,"channel_code",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - org_channel_code = [%s]\n",csPtr));
                                 	PutField_CString(hContext,"org_channel_code",csPtr);
                                 }

                                 if (GetField_CString(hRec,"client_id",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - org_client_id = [%s]\n",csPtr));
                                 	PutField_CString(hContext,"org_client_id",csPtr);
                                 }
                                 if (GetField_Double(hRec,"txn_amt",&dTmp)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - org_txn_amt = [%lf]\n",dTmp));
                                 	PutField_Double(hContext,"org_txn_amt",dTmp);
                                 }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                 }
	}
 	RecordSet_Destroy(rRecordSet);

	if (iRet == PD_OK) {
        	recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
                if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("TxnWebOnUsDSR::txn detail found record = [%s]\n",csOrgTxnSeq));
                	hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
                                 if (GetField_CString(hRec,"txn_country",&csOrgTxnCountry)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnDetail - org_txn_country = [%s]\n",csOrgTxnCountry));
					PutField_CString(hContext,"org_txn_country",csOrgTxnCountry);
                                 }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                 }
	}
 	RecordSet_Destroy(rRecordSet);


	if (iRet == PD_OK) {
        	recordset_init(rRecordSet,0);
                DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","GetTxnPspDetail");
                if (!(*DBObjPtr)(csOrgTxnSeq,rRecordSet)) {
                	hRec = RecordSet_GetFirst(rRecordSet);
                        while(hRec){

                                 if (GetField_CString(hRec,"txn_ccy",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnPsp - psp_txn_ccy = [%s]\n",csPtr));
                                 	PutField_CString(hResponse,"txn_ccy",csPtr);
                                 	PutField_CString(hContext,"org_txn_ccy",csPtr);
                                 }

/*
                                 if (GetField_Double(hRec,"txn_amt",&dTmp)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnPsp - txn amt = [%lf]\n",dTmp));
                                 	PutField_Double(hResponse,"psp_txn_amt",dTmp);
                                 }
*/

                                 hRec = RecordSet_GetNext(rRecordSet);
                     	}
     		}
                else{
ERRLOG("TxnWebOnUsDSR:: PSP NOT FOUND\n");
              	}
	}


	if (iRet == PD_OK) {
		TxnObjPtr = CreateObj(TxnPtr,"TxnWebOnUsCOM","Authorize");
                iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
	}
 	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

        if (GetField_CString(hContext,"psp_id",&csPspId)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnPsp - psp_id = [%s]\n",csPspId));
        	PutField_CString(hResponse,"psp_id",csPspId);
        }
	if (GetField_CString(hContext,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR:: psp_merchant_id = [%s]\n",csPtr));
		PutField_CString(hResponse,"psp_merchant_id",csPtr);
	}

/* fee */
	if (iRet == PD_OK) {
DEBUGLOG(("TxnWebOnUsDSR:: Call BOFee\n"));
        	BOObjPtr = CreateObj(BOPtr,"BOFee","GetTxnFee");
        	iRet = (unsigned long)(*BOObjPtr)(hContext,hRequest);
DEBUGLOG(("TxnWebOnUsDSR:: GetTxnFee result = [%d]\n",iRet));
		if (iRet == PD_OK) 
			iRet = AddFeeChgLog(hContext,hResponse);
	}
	

	if (iRet == PD_OK) {
		/* return_url_only */

        	if (GetField_CString(hContext,"return_url_only",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): return_url_only= [%s]\n",csPtr));
                	PutField_CString(hResponse,"return_url_only",csPtr);
        	}       

/* request_function */
        	if (GetField_CString(hContext,"request_function",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): request_function = [%s]\n",csPtr));
               		PutField_CString(hResponse,"request_function",csPtr);
        	}

/* action */
        	if (GetField_CString(hContext,"action",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): action = [%s]\n",csPtr));
                	PutField_CString(hResponse,"action",csPtr);
        	}

/* url_method */
        	if (GetField_CString(hContext,"url_method",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): url_method = [%s]\n",csPtr));
                	PutField_CString(hResponse,"url_method",csPtr);
        	}

/* bank_code */
        	if (GetField_CString(hRequest,"bank_code",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): bank_code = [%s]\n",csPtr));
                	PutField_CString(hContext,"internal_bank_code",csPtr);
			char	csOutBankCode[PD_BANK_CODE_LEN + 1];

			hash_t *hPsp;
			hPsp = (hash_t*) malloc (sizeof(hash_t));
        		hash_init(hPsp,0);
        		if (iRet == PD_OK) {
               			DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
                		if (!(*DBObjPtr)(csPspId, hPsp)) {
                        		if (GetField_CString(hPsp,"psp_channel_code",&csPspChannel)) {
                                		PutField_CString(hContext,"psp_channel_code",csPspChannel);
                                		PutField_CString(hResponse,"psp_channel_code",csPspChannel);
DEBUGLOG(("TxnWebOnUsDSR: Get psp channel code = [%s]\n",csPspChannel));
                        		}
					else {
						iRet = PD_ERR;
DEBUGLOG(("TxnWebOnUsDSR: Get psp channel code for [%s] not found!!!\n",csPspId));
ERRLOG("TxnWebOnUsDSR: Get psp channel code for [%s] not found!!!\n",csPspId);
					}	
                		}
			
        		}
			hash_destroy(hPsp);
                	FREE_ME(hPsp);

			if (strcmp(csPspChannel,PD_CHANNEL_TWV) &&
                    		strcmp(csPspChannel,PD_CHANNEL_PGEN)) {
				DBObjPtr = CreateObj(DBPtr,"DBBankMapping","i2eBankCodeMapping");
                		if ((DBObjPtr)(csPtr,csPspChannel,csOrgTxnCountry,csOutBankCode)) {
DEBUGLOG(("TxnWebOnUsDSR:: Authorize() channek bank code = [%s]\n",csOutBankCode));
					PutField_CString(hResponse,"bank_code",csOutBankCode);
				}
				else {
DEBUGLOG(("TxnWebOnUsDSR:: Authorize() can't find channek bank code [%s] for channel [%s]\n",csPtr,csPspChannel));
ERRLOG("TxnWebOnUsDSR:: Authorize() can't find channek bank code [%s] for channel [%s]\n",csPtr,csPspChannel);
					iRet = INT_BANK_CODE_NOT_FOUND;	
				}
			}
        	}

	}

	if (iRet == PD_OK && (!strcmp(csPspChannel,PD_CHANNEL_TWV) || !strcmp(csPspChannel,PD_CHANNEL_PGEN))) {
		hReq = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hReq,0);
		hRsp = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hRsp,0);

        
/* txn_code */
	        if (GetField_CString(hContext,"txn_code",&csPtr)) {
			if (!strcmp(csPtr,PD_INITIAL_REQ_TXN_CODE)) {	
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): txn_code = [%s]\n",csPtr));
                		PutField_CString(hReq,"txn_code",PD_DEPOSIT_TXN_CODE);
			}
        	}

/* txn_seq */
        	if (GetField_CString(hContext,"from_txn_seq",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): from_txn_seq = [%s]\n",csPtr));
                	PutField_CString(hReq,"order_num",csPtr);
        	}

/* psp Url */
        	if (GetField_CString(hContext,"psp_url",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): psp_url = [%s]\n",csPtr));
               		PutField_CString(hReq,"psp_url",csPtr);
        	}

/* psp merchant id */
	        if (GetField_CString(hContext,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): psp_merchant_id = [%s]\n",csPtr));
                	PutField_CString(hResponse,"psp_merchant_id",csPtr);
        	}

/* request_function */
        	if (GetField_CString(hContext,"request_function",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): request_function = [%s]\n",csPtr));
                	PutField_CString(hReq,"request_function",csPtr);
        	}

/* access_key */
        	if (GetField_CString(hContext,"psp_key",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): access_key = [%s]\n",csPtr));
                	PutField_CString(hReq,"access_key",csPtr);
        	}

/* txn_ccy */
        	if (GetField_CString(hRequest,"txn_ccy",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): txn_ccy = [%s]\n",csPtr));
                	PutField_CString(hReq,"txn_ccy",csPtr);
        	}


/* psp_txn_amt */
        	if (GetField_Double(hResponse,"psp_txn_amt",&dTmp)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): psp_txn_amt = [%f]\n",dTmp));
                	PutField_Double(hReq,"txn_amt",dTmp);
        	}

/* txn desc */
        	if (GetField_CString(hContext,"txn_desc",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): txn_desc = [%s]\n",csPtr));
                	PutField_CString(hReq,"txn_desc",csPtr);
        	}

/* fe_url */
        	if (GetField_CString(hResponse,"fe_url",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): fe_url = [%s]\n",csPtr));
                	PutField_CString(hReq,"fe_url",csPtr);
        	}

/* return_url */

        	if (GetField_CString(hContext,"return_url",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): return_url = [%s]\n",csPtr));
               		PutField_CString(hReq,"return_url",csPtr);
        	}

/* return_url_only */

	        if (GetField_CString(hContext,"return_url_only",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): return_url_only= [%s]\n",csPtr));
                	PutField_CString(hResponse,"return_url_only",csPtr);
		}
		
/* request_function */
        	if (GetField_CString(hContext,"request_function",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): request_function = [%s]\n",csPtr));
                	PutField_CString(hReq,"request_function",csPtr);
        	}

/* action */
        	if (GetField_CString(hContext,"action",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): action = [%s]\n",csPtr));
                	PutField_CString(hReq,"action",csPtr);
        	}

/* url_method */
        	if (GetField_CString(hContext,"url_method",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): url_method = [%s]\n",csPtr));
                	PutField_CString(hReq,"url_method",csPtr);
        	}

		char*	csHandler;
		csHandler = (char*) malloc (20);
                sprintf(csHandler,"TxnWebOnUs2%s",csPspChannel);
DEBUGLOG(("TxnWebOnUsDSR::Authorize() Txn Object [%s]\n",csHandler));
                TxnObjPtr = CreateObj(TxnPtr,csHandler,"Authorize");
                FREE_ME(csHandler);
                iRet = (unsigned long)(*TxnObjPtr)(hContext,hReq,hRsp);

DEBUGLOG(("TxnWebOnUsDSR::Authorize() iRet = [%d]\n",iRet));
		if (iRet == PD_OK) {
			if (GetField_CString(hContext,"redirect_url",&csPtr)) {
                        	PutField_CString(hResponse,"redirect_url",csPtr);
DEBUGLOG(("TxnWebOnUsDSR::Authorize() Format redirect_url = [%s]\n",csPtr));
                	}
		}

		hash_destroy(hReq);
        	FREE_ME(hReq);
		hash_destroy(hRsp);
        	FREE_ME(hRsp);
	}


DEBUGLOG(("Normal exit iret = [%d]\n",iRet));	
	return iRet;
}
int     AddFeeChgLog(hash_t* hContext,hash_t* hResponse)
{
	int	iRet = PD_OK;

	char	*csOrgTxnSeq;
	char	*csOrgTxnCcy;
	double	dTmp;

	hash_t  *hRec;
	hRec = (hash_t*)  malloc (sizeof(hash_t));

	if (GetField_CString(hContext,"from_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("AddFeeChgLog:: org_txn_seq = [%s]\n",csOrgTxnSeq));
	}

	if (GetField_CString(hContext,"org_txn_ccy",&csOrgTxnCcy)) {
DEBUGLOG(("AddFeeChgLog:: org_txn_ccy= [%s]\n",csOrgTxnCcy));
	}
	else {
DEBUGLOG(("AddFeeChgLog:: org_txn_ccy is missing!!!\n"));
	}

/* merchant fee */
	if (GetField_Double(hContext,"merchant_txn_fee",&dTmp) && iRet == PD_OK) {
DEBUGLOG(("AddFeeChgLog:: merchant fee = [%lf]\n",dTmp));
        	hash_init(hRec,0); 
		DBObjPtr = CreateObj(DBPtr,"DBTxnFeeChg","Add");

/* txn seq */
		PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
		PutField_CString(hRec,"chg_type",PD_TXN_CHG_TYPE_FEE);

/* party type */
		PutField_Char(hRec,"party_type",PD_CHG_PARTY_MERCHANT);

/* txn_ccy */
		PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* fee */
		PutField_Double(hRec,"fee",dTmp);

/* user */	PutField_CString(hRec,"add_user",PD_UPDATE_USER);
		iRet = (unsigned long)(*DBObjPtr)(hRec);
		hash_destroy(hRec);
	}


/* customer fee */
        if (GetField_Double(hContext,"customer_txn_fee",&dTmp) && iRet == PD_OK) {
DEBUGLOG(("AddFeeChgLog:: merchant fee = [%lf]\n",dTmp));
                hash_init(hRec,0); 
                DBObjPtr = CreateObj(DBPtr,"DBTxnFeeChg","Add");

/* txn seq */
                PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                PutField_CString(hRec,"chg_type",PD_TXN_CHG_TYPE_FEE);

/* party type */
                PutField_Char(hRec,"party_type",PD_CHG_PARTY_CUSTOMER);

/* txn_ccy */
                PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* fee */
                PutField_Double(hRec,"fee",dTmp);
/* user */	PutField_CString(hRec,"add_user",PD_UPDATE_USER);

                iRet = (unsigned long)(*DBObjPtr)(hRec);
                hash_destroy(hRec);
        }

/* merchant markup fee */
        if (GetField_Double(hContext,"merchant_mu_fee",&dTmp) && iRet == PD_OK) {
DEBUGLOG(("AddFeeChgLog:: merchant mu fee = [%lf]\n",dTmp));
                hash_init(hRec,0);
                DBObjPtr = CreateObj(DBPtr,"DBTxnFeeChg","Add");

/* txn seq */
                PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                PutField_CString(hRec,"chg_type",PD_TXN_CHG_TYPE_MARKUP);

/* party type */
                PutField_Char(hRec,"party_type",PD_CHG_PARTY_MERCHANT);

/* txn_ccy */
                PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* fee */
                PutField_Double(hRec,"fee",dTmp);
/* user */	PutField_CString(hRec,"add_user",PD_UPDATE_USER);

                iRet = (unsigned long)(*DBObjPtr)(hRec);
                hash_destroy(hRec);
        }


/* customer markup fee */
        if (GetField_Double(hContext,"customer_mu_fee",&dTmp) && iRet == PD_OK) {
DEBUGLOG(("AddFeeChgLog:: merchant fee = [%lf]\n",dTmp));
                hash_init(hRec,0);
                DBObjPtr = CreateObj(DBPtr,"DBTxnFeeChg","Add");

/* txn seq */
                PutField_CString(hRec,"txn_seq",csOrgTxnSeq);

/* chg type */
                PutField_CString(hRec,"chg_type",PD_TXN_CHG_TYPE_MARKUP);

/* party type */
                PutField_Char(hRec,"party_type",PD_CHG_PARTY_CUSTOMER);

/* txn_ccy */
                PutField_CString(hRec,"ccy",csOrgTxnCcy);

/* fee */
                PutField_Double(hRec,"fee",dTmp);
/* user */	PutField_CString(hRec,"add_user",PD_UPDATE_USER);

                iRet = (unsigned long)(*DBObjPtr)(hRec);
                hash_destroy(hRec);
        }

	if (GetField_Double(hContext,"psp_txn_amt",&dTmp) && iRet == PD_OK) {
DEBUGLOG(("AddFeeChgLog:: update new psp_txn_amt = [%f]\n",dTmp));
                hash_init(hRec,0);
                hash_init(hRec,0);
/* txn seq */
                PutField_CString(hRec,"txn_seq",csOrgTxnSeq);
                PutField_Double(hRec,"txn_amount",dTmp);
/* put into response to psp */
                PutField_Double(hResponse,"psp_txn_amt",dTmp);

                DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
                iRet = (unsigned long)(*DBObjPtr)(hRec);
DEBUGLOG(("AddFeeChgLog:: update txn psp detail = [%d]\n",iRet));
                hash_destroy(hRec);
	}
       	FREE_ME(hRec);
DEBUGLOG(("AddFeeChgLog:: iRet = [%d]\n",iRet));
	return	iRet;
}
