/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/05/16              Cody Chan
Return to Select 
Add Get Merchant Type				   2012/01/09		   Cody Chan
Add customer_tag				   2013/02/19		   Cody Chan
Add 51EPAY					   2013/03/27		   Cody Chan
Add Put SelectedPayMethod to response		   2013/05/20		   Cody Chan
use overrided_bank_code_channel for bank mapping   2013/06/14		   Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnWebOnUsDSR.h"
#include "myrecordset.h"

char cDebug;
OBJPTR(Txn);
OBJPTR(DB);
OBJPTR(BO);

void TxnWebOnUsDSR(char    cdebug)
{
        cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                        const hash_t* hRequest,
                        hash_t* hResponse)
{
        int     iRet = PD_OK;
	int	iPayMethodFound = PD_FALSE;
	char*	csOrgTxnSeq;
	char*	csOrgTxnCountry;
	char*   csPspId;
	char*   csPspChannel;
	char   csBankCodeChannel[PD_PSP_ID_LEN +1];
	char*   csServiceCode;
	char*	csPtr;
	char*	csReturnUrlOnly;
	char*	csClientId;
	char	cPtr;
	char*	csSelectedPayMethod;
	char*	csOrgMerchantId;
	double	dTmp;
	char*	csInternalBankCode;
	char	csOrgDateTime[PD_DATETIME_LEN +1];
	char	csOutBankCode[PD_EXT_BANK_CODE_LEN + 1];

	hash_t	*hRec,*hReq, *hRsp;

	recordset_t     *rRecordSet;   



DEBUGLOG(("TxnWebOnUsDSR::Authroize()\n"));


	if (GetField_CString(hRequest,"org_txn_seq",&csOrgTxnSeq)) {
DEBUGLOG(("TxnWebOnUsDSR::from txn seq  = [%s]\n",csOrgTxnSeq));
		PutField_CString(hContext,"from_txn_seq",csOrgTxnSeq);
		PutField_CString(hResponse,"txn_seq",csOrgTxnSeq);
	}
	else if (GetField_CString(hRequest,"org_encrypted_txn_seq",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::org encrypted txn seq  = [%s]\n",csPtr));
		BOObjPtr = CreateObj(BOPtr,"BOSecurity","Decrypt3DESTxnSeq");
		char* csTmpBuf;
		csTmpBuf = (char*) malloc (PD_EN_TXN_SEQ_LEN +1);
                (BOObjPtr)(csPtr,csTmpBuf);
		csOrgTxnSeq = strdup(csTmpBuf);
DEBUGLOG(("TxnWebOnUsDSR:org txn seq = [%s]\n",csOrgTxnSeq));
		PutField_CString(hContext,"from_txn_seq",csOrgTxnSeq);
		PutField_CString(hResponse,"txn_seq",csOrgTxnSeq);
		FREE_ME(csTmpBuf);
	}
	else {
DEBUGLOG(("TxnWebOnUsDSR::org txn seq not found\n"));
	}

	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);
	if (iRet == PD_OK) {
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnHeader");
                if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("TxnWebOnUsDSR::found record = [%s]\n",csOrgTxnSeq));
                	hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
                        	if (GetField_Char(hRec,"status",&cPtr)){
DEBUGLOG(("TxnWebOnUsDSR::status = [%c]\n",cPtr));
                                }
                                 if (GetField_CString(hRec,"service_code",&csServiceCode)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - service_code = [%s]\n",csServiceCode));
                                 	PutField_CString(hResponse,"service_code",csServiceCode);
                                 	PutField_CString(hContext,"org_service_code",csServiceCode);
                                 }
                                 if (GetField_CString(hRec,"local_tm_date",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - local_tm_date = [%s]\n",csPtr));
                                 	PutField_CString(hResponse,"local_tm_date",csPtr);
                                 }
				 if (GetField_CString(hRec,"local_tm_time",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - local_tm_time = [%s]\n",csPtr));
                                        PutField_CString(hResponse,"local_tm_time",csPtr);
                                 }
                                 if (GetField_CString(hRec,"txn_code",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - org_txn_code = [%s]\n",csPtr));
                                 	PutField_CString(hResponse,"org_txn_code",csPtr);
                                 	PutField_CString(hContext,"org_txn_code",csPtr);
                                 }
                                 if (GetField_CString(hRec,"client_id",&csClientId)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - org_client_id = [%s]\n",csClientId));
                                 	PutField_CString(hContext,"merchant_client_id",csClientId);
                                 	PutField_CString(hContext,"org_client_id",csClientId);
                                 }
                                 if (GetField_CString(hRec,"merchant_id",&csOrgMerchantId)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - org_merchant_id = [%s]\n",csOrgMerchantId));
                                 	PutField_CString(hContext,"merchant_id",csOrgMerchantId);
                                 	PutField_CString(hContext,"org_merchant_id",csOrgMerchantId);
                                 }
                                 if (GetField_CString(hRec,"channel_code",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - org_channel_code = [%s]\n",csPtr));
                                 	PutField_CString(hContext,"org_channel_code",csPtr);
                                 }
                                 if (GetField_Double(hRec,"txn_amt",&dTmp)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - org_txn_amt = [%lf]\n",dTmp));
                                 	PutField_Double(hContext,"org_txn_amt",dTmp);
                                 }
                                 if (GetField_CString(hRec,"local_tm_date",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - local_tm_date = [%s]\n",csPtr));
					strcpy(csOrgDateTime,csPtr);
                                 }
                                 if (GetField_CString(hRec,"local_tm_time",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - local_tm_time = [%s]\n",csPtr));
					memcpy(&csOrgDateTime[PD_DATE_LEN],csPtr,PD_TIME_LEN);
					csOrgDateTime[PD_DATETIME_LEN] = '\0';
DEBUGLOG(("TxnWebOnUsDSR::GetTxnHeader - org_local_tm_datetime = [%s]\n",csOrgDateTime));
                                 	PutField_CString(hContext,"org_local_tm_datetime",csOrgDateTime);
                                 }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                 }
	}
 	RecordSet_Destroy(rRecordSet);

	if (iRet == PD_OK) {
        	recordset_init(rRecordSet,0);
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetTxnDetail");
                if ((*DBObjPtr)(csOrgTxnSeq,rRecordSet) == PD_OK) {
DEBUGLOG(("TxnWebOnUsDSR::txn detail found record = [%s]\n",csOrgTxnSeq));
                	hRec = RecordSet_GetFirst(rRecordSet);
                        while (hRec) {
                                 if (GetField_CString(hRec,"selected_pay_method",&csSelectedPayMethod)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnDetail - org_pay_method = [%s]\n",csSelectedPayMethod));
                                 	PutField_CString(hContext,"selected_pay_method",csSelectedPayMethod);
					iPayMethodFound = PD_TRUE;
                                 }

                                 if (GetField_CString(hRec,"txn_country",&csOrgTxnCountry)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnDetail - org_txn_country = [%s]\n",csOrgTxnCountry));
					PutField_CString(hContext,"org_txn_country",csOrgTxnCountry);
                                 }

                                 if (GetField_CString(hRec,"txn_ccy",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnDetail - org_txn_ccy = [%s]\n",csPtr));
                                 	PutField_CString(hContext,"txn_ccy",csPtr);
                                 	PutField_CString(hContext,"org_txn_ccy",csPtr);
                                 }
                                 if (GetField_CString(hRec,"failure_url",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnDetail - org_failure_url = [%s]\n",csPtr));
                                 	PutField_CString(hResponse,"failure_url",csPtr);
				 }
                                 if (GetField_CString(hRec,"success_url",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnDetail - org_success_url = [%s]\n",csPtr));
                                 	PutField_CString(hResponse,"success_url",csPtr);
				 }
                                 if (GetField_CString(hRec,"language",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnDetail - org_language = [%s]\n",csPtr));
                                 	PutField_CString(hResponse,"org_language",csPtr);
				 }
                                 if (GetField_CString(hRec,"customer_tag",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnDetail - customer_tag = [%s]\n",csPtr));
                                 	PutField_CString(hContext,"customer_tag",csPtr);
				 }
                                 if (GetField_CString(hRec,"selected_pid",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnDetail - selected_pid = [%s]\n",csPtr));
                                 	PutField_CString(hContext,"selected_pid",csPtr);
				 }
                                 if (GetField_CString(hRec,"bank_code",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnDetail - per-selected bank_code = [%s]\n",csPtr));
                                 	PutField_CString(hContext,"bank_code",csPtr);
				 }

                                hRec = RecordSet_GetNext(rRecordSet);
                        }
                 }
	}
 	RecordSet_Destroy(rRecordSet);

/* check paymethod */
	if (iRet == PD_OK) {
DEBUGLOG(("iPayMethodFound = [%d]\n",iPayMethodFound));
		if (!iPayMethodFound) {
			if(GetField_CString(hRequest,"selected_pay_method",&csSelectedPayMethod)){
				DBObjPtr = CreateObj(DBPtr,"DBServicePayMethod","IsServicePayMethodSupported");
				if ((unsigned long)(DBObjPtr)(csServiceCode,csSelectedPayMethod) == PD_TRUE) {
					PutField_CString(hContext,"selected_pay_method",csSelectedPayMethod);
				}
				else{
					iRet = INT_INVALID_PAY_AMOUNT;
DEBUGLOG(("TxnWebOnUsDSR: pay_method invalid\n"));
ERRLOG(("TxnWebOnUsDSR::Authorize() pay_method invalid\n"));
				}
			}
			else if (GetField_CString(hRequest,"selected_pay_method",&csSelectedPayMethod)) {
DEBUGLOG(("TxnWebOnUsDSR: selected_pay_method from Selection Page = [%s]\n",csSelectedPayMethod));
				PutField_CString(hContext,"selected_pay_method",csSelectedPayMethod);
			}
			else{
				iRet = INT_PAYMETHOD_NOT_FOUND;
				PutField_Int(hContext,"internal_error",INT_PAYMETHOD_NOT_FOUND);
DEBUGLOG(("TxnWebOnUsDSR: pay_method not found\n"));
ERRLOG(("TxnWebOnUsDSR::Authorize() pay_method not found\n"));
			}
		}
	}

/*
	if (iRet == PD_OK) {
        	recordset_init(rRecordSet,0);
                DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","GetTxnPspDetail");
                if (!(*DBObjPtr)(csOrgTxnSeq,rRecordSet)) {
                	hRec = RecordSet_GetFirst(rRecordSet);
                        while(hRec){

                                 if (GetField_CString(hRec,"txn_ccy",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnPsp - psp_txn_ccy = [%s]\n",csPtr));
                                 	PutField_CString(hResponse,"txn_ccy",csPtr);
                                 	PutField_CString(hContext,"org_txn_ccy",csPtr);
                                 }

                                 if (GetField_Double(hRec,"txn_amt",&dTmp)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnPsp - txn amt = [%lf]\n",dTmp));
                                 	PutField_Double(hResponse,"psp_txn_amt",dTmp);
                                 }

                                 hRec = RecordSet_GetNext(rRecordSet);
                     	}
     		}
                else{
ERRLOG("TxnWebOnUsDSR:: PSP NOT FOUND\n");
              	}
	}
*/

	if (iRet == PD_OK) {
		hash_t * hClient;
		hClient  = (hash_t*) malloc (sizeof(hash_t));
                hash_init(hClient,0);
		DBObjPtr = CreateObj(DBPtr,"DBClients","GetClients");
                if ((*DBObjPtr)(csClientId,hClient) == PD_OK) {
			if (GetField_Char(hClient,"business_type",&cPtr)) {
DEBUGLOG(("TxnWebOnUsDSR:: business_type [%c]\n",cPtr));
                               	PutField_Char(hContext,"org_merchant_type",cPtr);
			}
		}
		FREE_ME(hClient);
	}
/* Add Txn Amt Element */
	if (iRet == PD_OK) {
DEBUGLOG(("TxnWebOnUsDSR:: Try to Add\n"));
DEBUGLOG(("TxnWebOnUsDSR:: Exectue\n"));
		 BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTxnAmtElement");
                 iRet = (unsigned long)(*BOObjPtr)(hContext);
DEBUGLOG(("TxnWebOnUsDSR:: ret from AddTxnAmtElements = [%d]\n",iRet));
	}

	if (iRet == PD_OK) {
		if (GetField_CString(hContext,"bank_code",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR: using select page's bank code [%s]\n",csPtr));
		}
		else {
DEBUGLOG(("TxnWebOnUsDSR: can't get pre selected bank_code\n"));
			if (GetField_CString(hRequest,"bank_code",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR: bank_code = [%s]\n", csPtr));
				PutField_CString(hContext,"bank_code",csPtr);
			}
		}
		TxnObjPtr = CreateObj(TxnPtr,"TxnWebOnUsCOM","Authorize");
                iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
	}
 	RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);
/* selected payment method */
       	PutField_CString(hResponse,"selected_pay_method",csSelectedPayMethod);

        if (GetField_CString(hContext,"psp_id",&csPspId)) {
DEBUGLOG(("TxnWebOnUsDSR::GetTxnPsp - psp_id = [%s]\n",csPspId));
        	PutField_CString(hResponse,"psp_id",csPspId);
        }
	if (GetField_CString(hContext,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR:: psp_merchant_id = [%s]\n",csPtr));
		PutField_CString(hResponse,"psp_merchant_id",csPtr);
	}

/* dst_net_amt */
	if (GetField_Double(hContext,"dst_net_amt",&dTmp)) {
DEBUGLOG(("TxnWebOnUsDSR:: dst_net_amt [%lf]\n",dTmp));
		PutField_Double(hResponse,"psp_txn_amt",dTmp);
	}
	else {
DEBUGLOG(("TxnWebOnUsDSR:: dst_net_amt is missing!!!\n"));
	}

	if (GetField_CString(hContext,"dst_txn_ccy",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR:: psp_txn_ccy = [%s]\n",csPtr));
		PutField_CString(hResponse,"psp_txn_ccy",csPtr);
	}

/* customer_name */
       	if (GetField_CString(hRequest,"customer_name",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): customer_name = [%s]\n",csPtr));
               	PutField_CString(hResponse,"customer_name",csPtr);
       	}
	
/* customer_family_name */
       	if (GetField_CString(hRequest,"customer_family_name",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): customer_family_name = [%s]\n",csPtr));
               	PutField_CString(hResponse,"customer_family_name",csPtr);
       	}
/* customer_tel */
       	if (GetField_CString(hRequest,"customer_tel",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): customer_tel = [%s]\n",csPtr));
               	PutField_CString(hResponse,"customer_tel",csPtr);
       	}

/* customer_email */
       	if (GetField_CString(hRequest,"customer_email",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): customer_email = [%s]\n",csPtr));
               	PutField_CString(hResponse,"customer_email",csPtr);
       	}
/*txn_desc */
       	if (GetField_CString(hContext,"txn_desc",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): txn_desc = [%s]\n",csPtr));
               	PutField_CString(hResponse,"txn_desc",csPtr);
       	}
	if (iRet == PD_OK) {
		/* return_url_only */

        	if (GetField_CString(hContext,"return_url_only",&csReturnUrlOnly)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): return_url_only= [%s]\n",csReturnUrlOnly));
                	PutField_CString(hResponse,"return_url_only",csReturnUrlOnly);
        	}       

/* request_function */
        	if (GetField_CString(hContext,"request_function",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): request_function = [%s]\n",csPtr));
               		PutField_CString(hResponse,"request_function",csPtr);
        	}

/* action */
        	if (GetField_CString(hContext,"action",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): action = [%s]\n",csPtr));
                	PutField_CString(hResponse,"action",csPtr);
        	}

/* url_method */
        	if (GetField_CString(hContext,"url_method",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): url_method = [%s]\n",csPtr));
                	PutField_CString(hResponse,"url_method",csPtr);
        	}


		hash_t *hPsp;
		hPsp = (hash_t*) malloc (sizeof(hash_t));
       		hash_init(hPsp,0);
       		if (iRet == PD_OK) {
         		DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
               		if (!(*DBObjPtr)(csPspId, hPsp)) {
                       		if (GetField_CString(hPsp,"psp_channel_code",&csPspChannel)) {
                               		PutField_CString(hContext,"psp_channel_code",csPspChannel);
                               		PutField_CString(hResponse,"psp_channel_code",csPspChannel);
					strcpy(csBankCodeChannel,csPspChannel);
DEBUGLOG(("TxnWebOnUsDSR:GetPspDetail psp channel code = [%s]\n",csPspChannel));
                       		}
/* overrided bank code channel */
                       		if (GetField_CString(hPsp,"overrided_bank_code_channel",&csPtr)) {
					strcpy(csBankCodeChannel,csPtr);
DEBUGLOG(("TxnWebOnUsDSR:GetPspDetail overrided_bank_code_channel = [%s]\n",csBankCodeChannel));
				}
				if (GetField_CString(hPsp,"status",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR:GetPspDetail Status = [%s]\n",csPtr));
                                	if(strcmp(csPtr,PD_ACC_OPEN)){
DEBUGLOG(("TxnWebOnUsDSR:GetPspDetail psp account [%s] not opened\n",csPspId));
                                        	iRet = INT_ACCOUNT_DISABLED;
                                	}
                        	}
				else {
					iRet = INT_ERR;
					PutField_Int(hContext,"internal_error",INT_ERR);
DEBUGLOG(("TxnWebOnUsDSR: Get psp channel code for [%s] not found!!!\n",csPspId));
ERRLOG("TxnWebOnUsDSR: Get psp channel code for [%s] not found!!!\n",csPspId);
				}	
               		}
			
        	}
		hash_destroy(hPsp);
               	FREE_ME(hPsp);

		int iChk = 0;
		DBObjPtr = CreateObj(DBPtr,"DBService","IsSelectBank");
		iChk= (unsigned long)(DBObjPtr)(csServiceCode);
		if(iChk == PD_ERR){
			iRet = INT_ERR;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("TxnWebOnUsDSR: check IsSelectBank Error!!!\n"));
ERRLOG("TxnWebOnUsDSR::Authorize() check IsSelectBank Error!!!\n");
		}
		else if(iChk == PD_TRUE) {
/* bank_code */
        		//if (GetField_CString(hRequest,"bank_code",&csInternalBankCode)) {
        		if (GetField_CString(hContext,"bank_code",&csInternalBankCode)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): bank_code = [%s]\n",csInternalBankCode));
                		PutField_CString(hContext,"internal_bank_code",csInternalBankCode);
				if (strcmp(csBankCodeChannel,PD_CHANNEL_TWV) &&
                    			strcmp(csBankCodeChannel,PD_CHANNEL_PGEN)) {
					DBObjPtr = CreateObj(DBPtr,"DBBankMapping","i2eBankCodeMapping");
                			if ((DBObjPtr)(csInternalBankCode,csBankCodeChannel,csOrgTxnCountry,csOutBankCode)) {
DEBUGLOG(("TxnWebOnUsDSR:: Authorize() channel bank code = [%s]\n",csOutBankCode));
						PutField_CString(hResponse,"bank_code",csOutBankCode);
					}
					else {
DEBUGLOG(("TxnWebOnUsDSR:: Authorize() can't find channel bank code [%s] for channel [%s]\n",csInternalBankCode,csBankCodeChannel));
ERRLOG("TxnWebOnUsDSR:: Authorize() can't find channel bank code [%s] for channel [%s]\n",csInternalBankCode,csBankCodeChannel);
						iRet = INT_BANK_CODE_NOT_FOUND;	
						PutField_Int(hContext,"internal_error",INT_BANK_CODE_NOT_FOUND);
					}
				}
        		}
		}

	}
	if (iRet == PD_OK && (!strcmp(csPspChannel,PD_CHANNEL_TWV) || 
                              !strcmp(csPspChannel,PD_CHANNEL_51EPAY)||
                              !strcmp(csPspChannel,PD_CHANNEL_PGEN))) {
		hReq = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hReq,0);
		hRsp = (hash_t*) malloc (sizeof(hash_t));
		hash_init(hRsp,0);

        
		if (!strcmp(csPspChannel,PD_CHANNEL_51EPAY)) {
/* tr_at */
        		PutField_CString(hReq,"tr_at","PAY");
/* fcode */
        		PutField_CString(hReq,"fcode","TRANSACTION");
		}
		
/* txn_code */
	        if (GetField_CString(hContext,"txn_code",&csPtr)) {
			if (!strcmp(csPtr,PD_INITIAL_REQ_TXN_CODE)) {	
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): txn_code = [%s]\n",csPtr));
                		PutField_CString(hReq,"txn_code",PD_DEPOSIT_TXN_CODE);
			}
        	}

/* txn_seq */
        	if (GetField_CString(hContext,"from_txn_seq",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): from_txn_seq = [%s]\n",csPtr));
                	PutField_CString(hReq,"order_num",csPtr);
        	}

/* psp Url */
        	if (GetField_CString(hContext,"psp_url",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): psp_url = [%s]\n",csPtr));
               		PutField_CString(hReq,"psp_url",csPtr);
        	}

/* psp merchant id */
	        if (GetField_CString(hContext,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): psp_merchant_id = [%s]\n",csPtr));
                	PutField_CString(hReq,"psp_merchant_id",csPtr);
        	}

/* request_function */
        	if (GetField_CString(hContext,"request_function",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): request_function = [%s]\n",csPtr));
                	PutField_CString(hReq,"request_function",csPtr);
        	}

/* psp_key */
        	if (GetField_CString(hContext,"psp_key",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): psp_key = [%s]\n",csPtr));
                	PutField_CString(hReq,"psp_key",csPtr);
        	}

/* psp_id */
        	if (GetField_CString(hContext,"psp_key_id",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): psp_key_id = [%s]\n",csPtr));
                	PutField_CString(hReq,"psp_key_id",csPtr);
        	}

/* psp_key_uid */
        	if (GetField_CString(hContext,"psp_key_uid",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): psp_key_uid = [%s]\n",csPtr));
                	PutField_CString(hReq,"psp_key_uid",csPtr);
        	}

/* txn_ccy */
        	if (GetField_CString(hRequest,"txn_ccy",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): txn_ccy = [%s]\n",csPtr));
                	PutField_CString(hReq,"txn_ccy",csPtr);
        	}


/* psp_txn_amt */
        	if (GetField_Double(hResponse,"psp_txn_amt",&dTmp)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): psp_txn_amt = [%f]\n",dTmp));
                	PutField_Double(hReq,"psp_txn_amt",dTmp);
        	}

/* txn desc */
        	if (GetField_CString(hContext,"txn_desc",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): txn_desc = [%s]\n",csPtr));
                	PutField_CString(hReq,"txn_desc",csPtr);
        	}

/* fe_url */
        	if (GetField_CString(hResponse,"fe_url",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): fe_url = [%s]\n",csPtr));
                	PutField_CString(hReq,"fe_url",csPtr);
        	}

/* return_url */

        	if (GetField_CString(hContext,"return_url",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): return_url = [%s]\n",csPtr));
               		PutField_CString(hReq,"return_url",csPtr);
        	}

/* return_url_only */

	        if (GetField_CString(hContext,"return_url_only",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): return_url_only= [%s]\n",csPtr));
                	PutField_CString(hResponse,"return_url_only",csPtr);
		}
		
/* request_function */
        	if (GetField_CString(hContext,"request_function",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): request_function = [%s]\n",csPtr));
                	PutField_CString(hReq,"request_function",csPtr);
        	}

/* action */
        	if (GetField_CString(hContext,"action",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): action = [%s]\n",csPtr));
                	PutField_CString(hReq,"action",csPtr);
        	}

/* url_method */
        	if (GetField_CString(hContext,"url_method",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): url_method = [%s]\n",csPtr));
                	PutField_CString(hReq,"url_method",csPtr);
        	}
/* channel_code */
        	if (GetField_CString(hContext,"channel_code",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): channel_code = [%s]\n",csPtr));
                	PutField_CString(hReq,"channel_code",csPtr);
        	}

/* conv_store */
        	if (GetField_CString(hRequest,"conv_store",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): conv_store = [%s]\n",csPtr));
                	PutField_CString(hReq,"conv_store",csPtr);
        	}
/* customer_name */
        	if (GetField_CString(hRequest,"customer_name",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): customer_name = [%s]\n",csPtr));
                	PutField_CString(hReq,"customer_name",csPtr);
        	}
/* customer_fmaily_name */
        	if (GetField_CString(hRequest,"customer_family_name",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): customer_family_name = [%s]\n",csPtr));
                	PutField_CString(hReq,"customer_family_name",csPtr);
        	}
/* customer_tel */
        	if (GetField_CString(hRequest,"customer_tel",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize(): customer_tel = [%s]\n",csPtr));
                	PutField_CString(hReq,"customer_tel",csPtr);
        	}

		if (GetField_CString(hContext,"local_tm_date",&csPtr)) {
                	PutField_CString(hReq,"local_tm_date",csPtr);
DEBUGLOG(("TxnWebOnUsDSR::Authorize() Format local_tm_date = [%s]\n",csPtr));
        	}
        	if (GetField_CString(hContext,"local_tm_time",&csPtr)) {
                	PutField_CString(hReq,"local_tm_time",csPtr);
DEBUGLOG(("TxnWebOnUsDSR::Authorize() Format local_tm_time = [%s]\n",csPtr));
        	}
/* bank code */
		PutField_CString(hReq,"bank_code",csOutBankCode);

/* be url */
                PutField_CString(hReq,"return_url_only",csReturnUrlOnly);


		char*	csHandler;
		csHandler = (char*) malloc (20);
                sprintf(csHandler,"TxnWebOnUs2%s",csPspChannel);
DEBUGLOG(("TxnWebOnUsDSR::Authorize() Txn Object [%s]\n",csHandler));
                TxnObjPtr = CreateObj(TxnPtr,csHandler,"Authorize");
                FREE_ME(csHandler);
                iRet = (unsigned long)(*TxnObjPtr)(hContext,hReq,hRsp);

DEBUGLOG(("TxnWebOnUsDSR::Authorize() iRet = [%d]\n",iRet));
		if (iRet == PD_OK) {
			if (GetField_CString(hContext,"redirect_url",&csPtr)) {
                        	PutField_CString(hResponse,"redirect_url",csPtr);
DEBUGLOG(("TxnWebOnUsDSR::Authorize() Format redirect_url = [%s]\n",csPtr));
                	}
			else if (!strcmp(csSelectedPayMethod,PD_ATM_PAYMENT)){
				if (GetField_CString(hResponse,"rpt_url",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize() Format redirect_url for [%s]= [%s]\n",csSelectedPayMethod,csPtr));
                        		PutField_CString(hResponse,"redirect_url",csPtr);
				}
			}
			else if (!strcmp(csSelectedPayMethod,PD_CONVENIENCE_STORE)){
				if (GetField_CString(hContext,"redirect_url",&csPtr)) {
                        		PutField_CString(hResponse,"redirect_url",csPtr);
DEBUGLOG(("TxnWebOnUsDSR::Authorize() Format redirect_url = [%s]\n",csPtr));
				}
				else if (GetField_CString(hResponse,"rpt_url",&csPtr)) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize() Format redirect_url for [%s]= [%s]\n",csSelectedPayMethod,csPtr));
                        		PutField_CString(hResponse,"redirect_url",csPtr);
				}
			}
		}
		if ((iRet == PD_OK) && (!strcmp(csPspChannel,PD_CHANNEL_51EPAY))) {
			if (iRet == PD_OK) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize() Format Sucess Resp\n"));
                		char    csPspURL[PD_TMP_BUF_LEN + 1];
				char    csPostMethod[PD_URL_METHOD_LEN +1];

				DBObjPtr = CreateObj(DBPtr,"DBMobileBankUrl","GetBankUrl");
				if ((DBObjPtr)(csInternalBankCode,csPspURL,csPostMethod) == PD_OK) {
DEBUGLOG(("TxnWebOnUsDSR::Authorize() PSP_URL = [%s]\n",csPspURL));
DEBUGLOG(("TxnWebOnUsDSR::Authorize() post_method = [%s]\n",csPostMethod));
					PutField_CString(hResponse,"redirect_url",csPspURL);
					PutField_CString(hResponse,"post_method",csPostMethod);
				}
				else {
DEBUGLOG(("TxnWebOnUsDSR::Authorize() PSP_URL not define\n"));
					iRet = PD_ERR;
				}
				if (GetField_CString(hContext,"psp_merchant_id",&csPtr)) {
					PutField_CString(hResponse,"psp_merchant_id",csPtr);
				}
				if (GetField_CString(hContext,"sc",&csPtr)) {
					PutField_CString(hResponse,"sc",csPtr);
DEBUGLOG(("TxnWebOnUsDSR::Authorize() sc = [%s]\n",csPtr));
				}

			}
		}

		hash_destroy(hReq);
        	FREE_ME(hReq);
		hash_destroy(hRsp);
        	FREE_ME(hRsp);
	}


DEBUGLOG(("Normal exit iret = [%d]\n",iRet));	
	return iRet;
}
