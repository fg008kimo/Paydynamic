/*
Partnerdelight (c)2013. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/11/13              Virginia Yun
Add Adjustment nature type			   2014/07/02		   Dirk Wong
*/	

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "TxnOmtByUsATD.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"

char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void TxnOmtByUsATD(char    cdebug)
{
	cDebug = cdebug;
}

int     Authorize(hash_t* hContext,
                  const hash_t* hRequest,
                        hash_t* hResponse)
{

	int	iRet = PD_OK;
	int	iTmpRet = PD_OK;
	char	*csTmp = NULL;	
	char	*csUser = NULL;
	int	iTmp;
	char	*csTxnCode;

	int	iCurrentCode = -1;

	char	csRtnTxnCode[PD_TXN_CODE_LEN + 1];
	char	csTagAction[PD_TAG_LEN + 1];

	char	csDesc[PD_DESC_LEN + 1];

	char	csPrefix[PD_SP_VALUE_LEN + 1];

	char	cPartyType;
	char	cDCInd;
	char	cAction;
	char 	cNature;

	int	iTmpCnt;

	hash_t  *hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hTxn, 0);

	hash_t  *hStatusMap;
	hStatusMap = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hStatusMap, 0);

	hash_t  *hSubStatusMap;
	hSubStatusMap = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hSubStatusMap, 0);


DEBUGLOG(("TxnOmtByUsATD::Authorize\n"));

/* party_type */
	if(GetField_CString(hRequest,"party_type",&csTmp)){
		cPartyType = csTmp[0];
DEBUGLOG(("Authorize::party_type = [%c]\n",cPartyType));

		PutField_Char(hTxn, "party_type", cPartyType);
	}
	else {
DEBUGLOG(("Authorize::party_type not found!!\n"));
ERRLOG("TxnOmtByUsATD::Authorize::party_type not found!!\n");
		iRet=INT_PARTY_TYPE_NOT_FOUND;

		PutField_Int(hContext,"internal_error",iRet);
	}

/* dc_ind */
	if(GetField_CString(hRequest,"dc_ind",&csTmp)){
		cDCInd = csTmp[0];
DEBUGLOG(("Authorize::dc_ind = [%c]\n",cDCInd));
		PutField_Char(hTxn, "dc_ind", cDCInd);
	}
	else {
DEBUGLOG(("Authorize::dc_ind not found!!\n"));
ERRLOG("TxnOmtByUsATD::Authorize::dc_ind not found!!\n");
		iRet=INT_DC_IND_NOT_FOUND;

		PutField_Int(hContext,"internal_error",iRet);
	}

/* desc */
	if (GetField_CString(hRequest, "desc", &csTmp)) {
DEBUGLOG(("Authorize::desc = [%s]\n",csTmp));
		PutField_CString(hTxn, "desc", csTmp);
	}
	else {
DEBUGLOG(("Authorize::desc not found!!\n"));
ERRLOG("TxnOmtByUsATD::Authorize::desc not found!!\n");
		iRet=INT_DESC_NOT_FOUND;

		PutField_Int(hContext,"internal_error",iRet);
	}

/* disabled */
	if (GetField_CString(hRequest, "disabled", &csTmp)) {
		iTmp = atoi(csTmp);
DEBUGLOG(("Authorize::disabled = [%d]\n",iTmp));
		PutField_Int(hTxn, "disabled", iTmp);
	}
	else {
DEBUGLOG(("Authorize::disabled not found!!\n"));
	}



/* add_user */
        if(GetField_CString(hRequest,"add_user",&csUser)){
DEBUGLOG(("Authorize::add_user= [%s]\n",csUser));
                PutField_CString(hTxn,"create_user",csUser);
                PutField_CString(hTxn,"update_user",csUser);
        }


/* action - A or U or D */
	if(GetField_CString(hRequest,"action",&csTmp)){
		cAction = csTmp[0];
DEBUGLOG(("Authorize::action = [%c]\n",cAction));
		PutField_Char(hTxn, "action", cAction);
	}
	else {
DEBUGLOG(("Authorize::action not found!!\n"));
ERRLOG("TxnOmtByUsATD::Authorize::action not found!!\n");
		iRet=INT_ACTION_NOT_FOUND;

		PutField_Int(hContext,"internal_error",iRet);
	}

	if (cPartyType == PD_TYPE_MERCHANT) {
		if (GetField_CString(hRequest, "apply_fee", &csTmp)) {
			iTmp = atoi(csTmp);
			PutField_Int(hTxn, "apply_fee", iTmp);
DEBUGLOG(("Authorize:: [%c] apply_fee [%d]\n", cPartyType, iTmp));
		}
		else {
			PutField_Int(hTxn, "apply_fee", PD_TRUE);
DEBUGLOG(("Authorize:: [%c] (default) apply_fee [%d]\n", cPartyType, iTmp));
		}
	} else {
		PutField_Int(hTxn, "apply_fee", PD_FALSE);
DEBUGLOG(("Authorize:: [%c] (default) apply_fee [%d]\n", cPartyType, iTmp));
	}
		


	if (cAction == PD_ACTION_ADD) {
		PutField_Int(hTxn, "voidable", PD_FALSE);
DEBUGLOG(("Authorize:: (default) voidable [%d]\n", PD_FALSE));

		// for online
		PutField_Int(hTxn,"fe_display",PD_FALSE);
		PutField_Int(hTxn,"merchant_fe_display",PD_FALSE);
		PutField_Int(hTxn,"merchant_txn_display",PD_FALSE);
		PutField_Int(hTxn,"psp_txn_display", PD_FALSE);

		if (cPartyType == PD_TYPE_MERCHANT) {
			PutField_Int(hTxn,"ofl_fe_display", PD_TRUE);
			PutField_Int(hTxn,"ofl_merchant_fe_display", PD_TRUE);
			PutField_Int(hTxn,"ofl_merchant_txn_display", PD_TRUE);
			PutField_Int(hTxn,"ofl_provider_txn_idsplay", PD_TRUE);
		}
		else {
			PutField_Int(hTxn,"ofl_fe_display", PD_TRUE);
			PutField_Int(hTxn,"ofl_merchant_fe_display", PD_FALSE);
			PutField_Int(hTxn,"ofl_merchant_txn_display", PD_FALSE);
			PutField_Int(hTxn,"ofl_provider_txn_idsplay", PD_FALSE);
		}
	}


/* code */
	if (GetField_CString(hRequest, "code", &csTmp)) {
DEBUGLOG(("Authorize::code = [%s]\n",csTmp));
		PutField_CString(hTxn, "code", csTmp);

		iCurrentCode = atoi(csTmp + 1);
		PutField_Int(hTxn, "code_in_num", iCurrentCode);

DEBUGLOG(("Authorize::CodeInNum = [%d]\n",iCurrentCode));
	}
	else {
DEBUGLOG(("Authorize::Call BOOLAdjustment:GetCurrentCode\n"));
		BOObjPtr = CreateObj(BOPtr,"BOOLAdjustment","GetCurrentCode");
		if((unsigned long)((*BOObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::GetCurrentCode Failed\n"));
ERRLOG("TxnOmtByUsATD::Authorize::GetCurrentCode Failed\n");
                        iRet=INT_CODE_ERROR;

			PutField_Int(hContext,"internal_error",iRet);
                }

		if (iRet == PD_OK) {

DEBUGLOG(("Authorize:: call DBSystemParameter::FindCode()\n"));
			DBObjPtr = CreateObj(DBPtr, "DBSystemParameter", "FindCode");

			if (cPartyType == PD_TYPE_MERCHANT) {
				iTmpRet = (unsigned long)(*DBObjPtr)(PD_OFL_MERCH_ADJ_CODE_PREFIX, csPrefix);
			} else {
		                iTmpRet = (unsigned long)(*DBObjPtr)(PD_OFL_PROVIDER_ADJ_CODE_PREFIX, csPrefix);
			}

			if (iTmpRet == FOUND) {
				if (GetField_Int(hTxn, "code_in_num", &iCurrentCode)) {
DEBUGLOG(("Authorize::CurrentCodeInNum [%d]\n", iCurrentCode));

					sprintf(csRtnTxnCode, "%s%02d", csPrefix, iCurrentCode);
DEBUGLOG(("Authorize::CurrentCode [%s]\n", csRtnTxnCode));
					PutField_CString(hTxn, "code", csRtnTxnCode);
				}
			}
		}
	}


/* Validate to process while update or delete */
	if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Call BOOLAdjustment:ValidateProcess\n"));
                BOObjPtr = CreateObj(BOPtr,"BOOLAdjustment","ValidateProcess");	
                if((unsigned long)((*BOObjPtr)(hTxn) != PD_OK)){
DEBUGLOG(("Authorize::validateProcess Failed\n"));
/*ERRLOG("TxnOmtByUsATD::Authorize::ValidateProcess Failed\n");*/
			iRet = INT_PROCESS_VALIDATE_ERROR;

			PutField_Int(hContext,"internal_error",iRet);
		}
	}

/* desc prefix */
	if(cAction == PD_ACTION_ADD){
		if (GetField_CString(hRequest, "desc", &csTmp)) {
			if (strlen(PD_ADJ_DESC_PREFIX) + strlen(csTmp) > PD_DESC_LEN){
				iRet = INT_ADJUSTMENT_PROCESS_ERROR;
				PutField_Int(hContext,"internal_error",iRet);
			}else{
				memset(csDesc, 0, sizeof(csDesc));
				strcpy(csDesc, PD_ADJ_DESC_PREFIX); // "Adjustment - " 
				strncpy(&csDesc[strlen(PD_ADJ_DESC_PREFIX)], csTmp, PD_DESC_LEN - strlen(PD_ADJ_DESC_PREFIX));
				PutField_CString(hTxn, "desc", csDesc);
			}
		}

/* Adjustment Nature */
                if(GetField_CString(hRequest,"nature",&csTmp)){
                        cNature = csTmp[0];
DEBUGLOG(("Authorize::nature = [%c]\n",cNature));
                        PutField_Char(hTxn, "nature", cNature);
                }
                else {
DEBUGLOG(("Authorize::nature not found!!\n"));
ERRLOG("TxnOmtByUsATD::Authorize::nature not found!!\n");
                        iRet=INT_NATURE_NOT_FOUND;

                        PutField_Int(hContext,"internal_error",iRet);
                }

	}


/* call Add or Update or Delete*/
	if (iRet == PD_OK) {
		memset(csTagAction, 0, sizeof(csTagAction));
		switch (cAction) {
			case PD_ACTION_ADD:
				sprintf(csTagAction, "%s", "Add");
				break;
			case PD_ACTION_UPDATE:
				sprintf(csTagAction, "%s", "Update");
				break;
			case PD_ACTION_DELETE:
				sprintf(csTagAction, "%s", "Delete");
				break;
			default:
				iRet = INT_ERR;
				break;
		}

		if (iRet == PD_OK) {
DEBUGLOG(("Authorize::TagAction = [%s]\n", csTagAction));
	                DBObjPtr = CreateObj(DBPtr,"DBOLAdjustmentType", csTagAction);
			if((unsigned long)((*DBObjPtr)(hTxn)) != PD_OK) {
DEBUGLOG(("Authorize:: FAIL to [%s]\n", csTagAction));
				iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                	} else {
DEBUGLOG(("Authorize:: SUCC to [%s]\n", csTagAction));
			}
		}
	}

	/********************************************/
	/* Include TxnCode, ChannelTxnMap - Normal*/
	if (iRet == PD_OK) {

		/* txn_code */
		if (GetField_CString(hTxn, "code", &csTmp)) {
DEBUGLOG(("Authorize::TxnCode: Txn code = [%s]\n",csTmp));
			PutField_CString(hTxn, "txn_code", csTmp);
		}

		/* desc */
		if (GetField_CString(hTxn, "desc", &csTmp)) {
DEBUGLOG(("Authorize::TxnCode: Desc = [%s]\n",csTmp));
		}

		if (cAction == PD_ACTION_ADD) {
			PutField_CString(hTxn, "process_type", "0000");
			PutField_CString(hTxn, "process_code", "000000");

			PutField_Int(hTxn, "apply_limit", PD_FALSE);
                        PutField_Int(hTxn, "apply_ex_markup", PD_FALSE);
		}

		// because of foreign key, add and delete is on diff. seq.
                if (iRet == PD_OK) {
			if (cAction == PD_ACTION_ADD || cAction == PD_ACTION_UPDATE)  {
DEBUGLOG(("Authorize::TxnCode: TagAction = [%s]\n", csTagAction));
				DBObjPtr = CreateObj(DBPtr,"DBTxnCode", csTagAction);
				if((unsigned long)((*DBObjPtr)(hTxn)) != PD_OK) {
DEBUGLOG(("Authorize::TxnCode FAIL to [%s]\n", csTagAction));
					iRet = INT_ADJUSTMENT_PROCESS_ERROR;
				} else {
DEBUGLOG(("Authorize::TxnCode SUCC to [%s]\n", csTagAction));
                		}
			}
		}

                if (iRet == PD_OK) {
                        /* channel_code */
                        PutField_CString(hTxn, "channel_code", PD_CHANNEL_OMT);

                        /* apply_reserved */
                        PutField_Int(hTxn, "apply_reserve", PD_FALSE);

DEBUGLOG(("Authorize::ChannelTxnMap [%s]\n", csTagAction));

                        DBObjPtr = CreateObj(DBPtr,"DBChannelTxnMap", csTagAction);
                        if((unsigned long)((*DBObjPtr)(hTxn)) != PD_OK) {
DEBUGLOG(("Authorize::ChannelTxnMap FAILED to [%s]\n", csTagAction));
                                iRet = INT_ADJUSTMENT_PROCESS_ERROR;
                        } else {
DEBUGLOG(("Authorize::ChannelTxnMap SUCC to [%s]\n", csTagAction));
                        }

                }
		
		if (iRet == PD_OK) {
			if (cAction == PD_ACTION_DELETE) {
DEBUGLOG(("Authorize::TxnCode: TagAction = [%s]\n", csTagAction));
				DBObjPtr = CreateObj(DBPtr,"DBTxnCode", csTagAction);
				if((unsigned long)((*DBObjPtr)(hTxn)) != PD_OK) {
DEBUGLOG(("Authorize::TxnCode FAIL to [%s]\n", csTagAction));
					iRet = INT_ADJUSTMENT_PROCESS_ERROR;
				} else {
DEBUGLOG(("Authorize::TxnCode SUCC to [%s]\n", csTagAction));
                		}
			}
		}

	}


	if (iRet == PD_OK) {
		// def_txn_status_map

		// Admin / Merchant : txn_code, status, ar_ind, status_desc
		// 1,2) (m/p/y/x)99, C, A, Approved
		// 3,4) (m/p/y/x)99, C, R, Declined
		// 5) (m/p)99, R, A, Approved
		  
		if (cAction == PD_ACTION_ADD) {
			if (GetField_CString(hTxn, "code", &csTxnCode)) {
DEBUGLOG(("Authorize::Prepare TxnStatusMap txn_code [%s]\n", csTxnCode));
			}

			for (iTmpCnt = 0; iTmpCnt < 2; iTmpCnt++) { 
				if (iTmpCnt == 0) {
					PutField_Char(hStatusMap, "type", PD_STATUS_MAP_TYPE_ADMIN);
				} else {
					PutField_Char(hStatusMap, "type", PD_STATUS_MAP_TYPE_MERCH);
				}

				PutField_CString(hStatusMap, "txn_code", csTxnCode);
				PutField_Char(hStatusMap, "status", PD_COMPLETE);
				PutField_Char(hStatusMap, "ar_ind", PD_ACCEPT);


				PutField_CString(hStatusMap, "status_desc", PD_STATUS_MAP_DESC_ACCEPT);
       		         	PutField_CString(hStatusMap,"create_user",csUser);

DEBUGLOG(("Authorize::TxnStatusMap [%d] (1) call Add\n", iTmpCnt));
	                	DBObjPtr = CreateObj(DBPtr,"DBDefTxnStatusMap", "Add");
		                if((unsigned long)((*DBObjPtr)(hStatusMap)) != PD_OK) {
DEBUGLOG(("Authorize::TxnStatusMap [%d] (1) FAIL to Add\n", iTmpCnt)); 
		                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
					break;
		                } 

				//PutField_CString(hStatusMap, "txn_code", csTxnCode);
				PutField_Char(hStatusMap, "ar_ind", PD_REJECT);
				PutField_CString(hStatusMap, "status_desc", PD_STATUS_MAP_DESC_DECLINED);

DEBUGLOG(("Authorize::TxnStatusMap [%d] (3) call Add\n", iTmpCnt));
                		DBObjPtr = CreateObj(DBPtr,"DBDefTxnStatusMap", "Add");
		                if((unsigned long)((*DBObjPtr)(hStatusMap)) != PD_OK) {
DEBUGLOG(("Authorize::TxnStatusMap [%d] (3) FAIL to Add\n", iTmpCnt));
		                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
					break;
		                } 

				//PutField_CString(hStatusMap, "txn_code", csTxnCode);
				PutField_Char(hStatusMap, "status", PD_REVERSED);
				PutField_Char(hStatusMap, "ar_ind", PD_ACCEPT);
				PutField_CString(hStatusMap, "status_desc", PD_STATUS_MAP_DESC_ACCEPT);

DEBUGLOG(("Authorize::TxnStatusMap [%d] (5) call Add\n", iTmpCnt));
                		DBObjPtr = CreateObj(DBPtr,"DBDefTxnStatusMap", "Add");
		                if((unsigned long)((*DBObjPtr)(hStatusMap)) != PD_OK) {
DEBUGLOG(("Authorize::TxnStatusMap [%d] (5) FAIL to Add\n", iTmpCnt)); 
		                        iRet = INT_ADJUSTMENT_PROCESS_ERROR;
					break;
		                } 
				
			}


			// Def_Txn_Sub_Status_Map
			if (iRet == PD_OK) {
DEBUGLOG(("Authorize::Prepare TxnSubStatusMap txn_code [%s]\n", csTxnCode));
				PutField_CString(hSubStatusMap, "txn_code", csTxnCode);
				PutField_CString(hSubStatusMap, "sub_status", PD_APPROVED);
       		         	PutField_CString(hSubStatusMap,"create_user",csUser);

				DBObjPtr = CreateObj(DBPtr,"DBDefTxnSubStatusMap", "Add");
				if((unsigned long)((*DBObjPtr)(hSubStatusMap)) != PD_OK) {
DEBUGLOG(("Authorize::TxnSubStatusMap FAIL to Add\n")); 
					iRet = INT_ADJUSTMENT_PROCESS_ERROR;
				}
			}
			
		}
		else if (cAction == PD_ACTION_DELETE) {

			if (GetField_CString(hTxn, "code", &csTxnCode)) {
DEBUGLOG(("Authorize::Prepare TxnStatusMap (delete) txn_code [%s]\n", csTxnCode));
				PutField_CString(hStatusMap, "txn_code", csTxnCode);
				PutField_CString(hSubStatusMap, "txn_code", csTxnCode);
			}

DEBUGLOG(("Authorize::TxnStatusMap call Delete txn_code [%s]\n", csTxnCode));
			DBObjPtr = CreateObj(DBPtr,"DBDefTxnStatusMap", "Delete");
			if((unsigned long)((*DBObjPtr)(hStatusMap)) != PD_OK) {
DEBUGLOG(("Authorize::TxnStatusMap FAIL to Delete txn_code[%s]\n", csTxnCode)); 
				iRet = INT_ADJUSTMENT_PROCESS_ERROR;
			} 

			if (iRet == PD_OK) {
DEBUGLOG(("Authorize::TxnSubStatusMap call Delete txn_code [%s]\n", csTxnCode));
				DBObjPtr = CreateObj(DBPtr,"DBDefTxnSubStatusMap", "Delete");
				if((unsigned long)((*DBObjPtr)(hSubStatusMap)) != PD_OK) {
DEBUGLOG(("Authorize::TxnSubStatusMap FAIL to Delete txn_code[%s]\n", csTxnCode)); 
					iRet = INT_ADJUSTMENT_PROCESS_ERROR;
				} 
			}
		}	
	}

	/********************************************/

/* rtn code */
	if (iRet == PD_OK) {
		if (GetField_CString(hTxn, "code", &csTmp)) {
DEBUGLOG(("Authorize::Rtn Txn code = [%s]\n",csTmp));
			PutField_CString(hResponse, "rtn_code", csTmp);
		}
	}




	hash_destroy(hTxn);
	FREE_ME(hTxn);

	hash_destroy(hStatusMap);
	FREE_ME(hStatusMap);

	hash_destroy(hSubStatusMap);
	FREE_ME(hSubStatusMap);

DEBUGLOG(("TxnOmtByUsATD Normal Exit() iRet = [%d]\n",iRet));
	return iRet;
}

