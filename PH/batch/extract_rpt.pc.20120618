/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/02/03              Cody Chan
*/


#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sys/stat.h>
#include <oraca.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "common.h"
#include "utilitys.h"
#include "extract_rptcommon.h"
#include "batchcommon.h"


char	cDebug;
#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

int batch_init(int argc, char* argv[])
{
	return SUCCESS;
}	



int batch_proc(int argc, char* argv[])
{
	int	iRet = SUCCESS;
	char	cs_eod_date[PD_DATE_LEN +1];
	char	cs_file_name[128];


	EXEC SQL WHENEVER SQLERROR GOTO sql_error;
    	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar		hv_host_posting_date[PD_DATE_LEN];

		varchar		v_merchant_id[PD_MERCHANT_ID_LEN +1];
		varchar		v_service_code[PD_SERVICE_CODE_LEN +1];
		varchar		v_country[PD_COUNTRY_LEN +1];
		varchar		v_ccy[PD_CCY_ID_LEN +1];

		SQL_CURSOR	c_cursor_rpt001;

		short		ind_merchant_id = -1;
		short		ind_service_code = -1;
		short		ind_country = -1;
		short		ind_ccy = -1;
    	EXEC SQL END DECLARE SECTION;

	iRet = GetCurrEODDate((unsigned char*)cs_eod_date);
	if (iRet != SUCCESS)
		return iRet;

	hv_host_posting_date.len = strlen(cs_eod_date);
	memcpy(hv_host_posting_date.arr,cs_eod_date,hv_host_posting_date.len);
DEBUGLOG(("batch_proc:hv_host_posting_date = [%.*s]\n",hv_host_posting_date.len,hv_host_posting_date.arr));

	EXEC SQL ALLOCATE :c_cursor_rpt001;
	EXEC SQL ALLOCATE :c_cursor_rpt002;

	EXEC SQL DECLARE c_cursor_getmerchant_bal CURSOR FOR
		 SELECT	merchant_id,
         		mb_service_code,
         		mb_country,
         		mb_ccy_id
                  FROM merchant_bal_acct ,
        	       (SELECT merchant_id,
                   	       name
                          FROM merch_detail a,
                   	       clients b
                         WHERE a.status = 'O'
                           AND a.disabled  = 0
                           AND a.client_id = b.client_id
                           AND A.DISABLED = 0
                           AND B.TYPE = 'M')
                 WHERE mb_status = 'O' 
                   AND mb_disabled = 0
                   AND merchant_id = mb_merchant_id;


	EXEC SQL OPEN c_cursor_getmerchant_bal;
        do {
		EXEC SQL FETCH c_cursor_getmerchant_bal
		INTO 
			:v_merchant_id:ind_merchant_id,
			:v_service_code:ind_service_code,
			:v_country:ind_country,
			:v_ccy:ind_ccy;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}
		v_merchant_id.arr[v_merchant_id.len] = '\0';
		v_service_code.arr[v_service_code.len] = '\0';
		v_country.arr[v_country.len] = '\0';
		v_ccy.arr[v_ccy.len] = '\0';
DEBUGLOG(("batch_proc: merchant_id = [%s]\n",v_merchant_id.arr));
DEBUGLOG(("batch_proc: service_code = [%s]\n",v_service_code.arr));
DEBUGLOG(("batch_proc: country = [%s]\n",v_country.arr));
DEBUGLOG(("batch_proc: ccy = [%s]\n",v_ccy.arr));
		EXEC SQL EXECUTE
			BEGIN
				REPORT_PKG.open_cur_rpt001(:hv_host_posting_date,:v_merchant_id,:v_country,:v_service_code,:v_ccy,:c_cursor_rpt001);
			END;
		END-EXEC;

		iRet = Extract_RPT001(cs_file_name,c_cursor_rpt001);
		if (iRet != SUCCESS)
			break;

/* must close it */
		EXEC SQL CLOSE :c_cursor_rpt001;
	} while (PD_TRUE);
	
	if (iRet == SUCCESS) {
	}

	if (iRet == SUCCESS) {
		EXEC SQL EXECUTE
			BEGIN
			/* others */
				REPORT_PKG.open_cur_rpt001(:hv_host_posting_date,:v_merchant_id,:v_country,:v_service_code,:v_ccy,:c_cursor_rpt001);
				//REPORT_PKG.open_cur_rpt002(:hv_host_posting_date,:v_merchant_id,:v_country,:v_service_code,:v_ccy,:c_cursor_rpt001);
			END;
		END-EXEC;
	}
	
	if (iRet == SUCCESS) {
/* other extract functions */
		//iRet = Extract_RPT002(cs_file_name,c_cursor_rpt002);
	}
	
	EXEC SQL CLOSE :c_cursor_rpt001;
	EXEC SQL CLOSE :c_cursor_rpt002;
	EXEC SQL CLOSE c_cursor_getmerchant_bal;

	return iRet;
sql_error:
DEBUGLOG(("get_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE :c_cursor_rpt001;
	EXEC SQL CLOSE :c_cursor_rpt002;
	EXEC SQL CLOSE c_cursor_getmerchant_bal;
	EXEC SQL ROLLBACK RELEASE;
	return FAILURE;
}


int batch_terminate(int argc, char* argv[])
{
    return SUCCESS;
}

