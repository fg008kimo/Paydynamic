#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "common.h"
#include "utilitys.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode
char    cDebug = 'Y';

void SystemControl(char    cdebug)
{
        cDebug = cdebug;
}


int batch_init(int argc, char* argv[])
{
/*    if (argc < 2)
        return FAILURE;
      else
*/
        return SUCCESS;
}

int batch_proc(int argc, char* argv[])
{
	int i = 0;
	
	EXEC SQL WHENEVER SQLERROR GOTO sql_error;
    	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar sCode[PD_CODE_LEN+1];
		varchar sVal[PD_VALUE_LEN+1];
		varchar sName[PD_VALUE_LEN+1];

		short ind_code = -1;
		short ind_val = -1;
		short ind_name = -1;
		
		unsigned int nCount = 0;


	EXEC SQL END DECLARE SECTION;
	
	EXEC SQL SELECT COUNT (*) INTO :nCount FROM SYSTEM_CONTROL;
	
	DEBUGLOG(("Num of record in table[SYSTEM_CONTROL] = %d\n", nCount));
	if(nCount<=0)
		return FAILURE;

	EXEC SQL DECLARE cursor CURSOR FOR
		SELECT SYS_CODE, SYS_VAL
		FROM    SYSTEM_CONTROL ORDER BY SYS_CODE DESC;

	EXEC SQL OPEN  cursor;

	for(i=0; i<nCount;i++)
	{

		EXEC SQL FETCH cursor
			INTO	:sCode:ind_code,
				:sVal:ind_val;


		if(ind_code>=0)
		{
			sCode.arr[sCode.len]= '\0';
			sVal.arr[sVal.len]= '\0';
		}
		else
		{
			DEBUGLOG(("Invalid Code\n"));
			break;
		}

		EXEC SQL SELECT SYS_NAME
			INTO :sName:ind_name
			FROM TESTING
			WHERE SYS_ID = :sCode;


		if(ind_name>=0)
		{
			sName.arr[sName.len]='\0';

			if(strcmp((char*)sVal.arr, (char*)sName.arr)==0)
			{
				DEBUGLOG(("Record matched in table[TESTING]: ID[%s] NAME[%s]\n", sCode.arr, sName.arr));
				EXEC SQL DELETE FROM TESTING
					WHERE SYS_ID = :sCode;
				DEBUGLOG(("Record deleted\n"));
			}
			else
			{
				EXEC SQL UPDATE TESTING
					SET SYS_NAME = :sVal , SYS_UPDATE_TIMESTAMP = sysdate
					WHERE SYS_ID = :sCode;
				DEBUGLOG(("Record updated: ID[%s] NAME[%s]->[%s]\n",sCode.arr,sName.arr,sVal.arr));
				//printf("Record not matched in table[TESTING]: ID[%s] NAME[%s] VALUE[%s]\n", sCode.arr, sName.arr, sVal.arr);
			}
		}
		else
		{
			DEBUGLOG(("No record in table[TESTING]: Code[%s] Value[%s]\n", sCode.arr, sVal.arr));
			EXEC SQL INSERT INTO TESTING
				VALUES(:sCode, :sVal, SYSDATE, SYSDATE);
			DEBUGLOG(("Record Insert into table[TESTING]\n"));
		}

		ind_name=-1;
	}

	
	EXEC SQL CLOSE cursor;
	EXEC SQL COMMIT WORK RELEASE;

	return SUCCESS;


sql_error:
    DEBUGLOG(("SQL ERROR!\n"));
    DEBUGLOG(("get_error code %d\n", sqlca.sqlcode));
    DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL ROLLBACK RELEASE;  
    return FAILURE;    
}

int batch_terminate(int argc, char* argv[])
{
    return SUCCESS;
}

