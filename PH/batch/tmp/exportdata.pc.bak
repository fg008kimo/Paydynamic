#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
//#include "common.h"
#include "utilitys.h"
#include "expat.h"
#include <curl/curl.h>
#include "myhash.h"
#include "ObjPtr.h"
#include "numutility.h"
#include "myrecordset.h"

#include "exportdata.h"
#include "TxnSeq.h"


OBJPTR(DB);
char    cDebug;

int batch_init(int argc, char* argv[])
{
	return SUCCESS;
}



int formatString(const char* csDate, hash_t* hRec, char* csFormattedString)
{
	char *csTxnId = strdup("");
	char *csTxnCode = strdup("");
	char *csChannel = strdup("");
	char *csClientId = strdup("");
	char *csMerchId = strdup("");
	char *csMerchRef = strdup("");
	char *csLocalDate = strdup("");
	char *csLocalTime = strdup("");
	char *csTid = strdup("");
	char *csBank = strdup("");
	char *csErrCode = strdup("");
	char *csCcy = strdup("");
	char *csCountry = strdup("");
	char *csPayMethod = strdup("");
	char *csTxnAmt = strdup("");
	char *csNetAmt = strdup("");
	char cStatus=' ';
	char cArInd=' ';

	if(GetField_CString(hRec,"tid",&csTid)){
DEBUGLOG(("formatString:: tid = [%s]\n",csTid));
	}
	
	if(GetField_CString(hRec,"txn_id",&csTxnId)){
DEBUGLOG(("formatString:: txn_id = [%s]\n",csTxnId));
	}
	
	if(GetField_CString(hRec,"txn_code",&csTxnCode)){
DEBUGLOG(("formatString:: txn_code= [%s]\n",csTxnCode));
	}
	
	if (GetField_CString(hRec,"channel_code", &csChannel)){
DEBUGLOG(("formatString:: channel_code = [%s]\n",csChannel));
	}

	if(GetField_CString(hRec,"client_id",&csClientId)){
DEBUGLOG(("formatString:: client_id = [%s]\n",csClientId));
	}
	
	if(GetField_Char(hRec,"status",&cStatus)){
DEBUGLOG(("formatString:: status= [%c]\n",cStatus));
	}
	
	if(GetField_Char(hRec,"ar_ind",&cArInd)){
DEBUGLOG(("formatString:: ar_ind= [%c]\n",cArInd));
	}
	
	if(GetField_CString(hRec,"merchant_id",&csMerchId)){
DEBUGLOG(("formatString:: merchant_id= [%s]\n",csMerchId));
	}
	
	if(GetField_CString(hRec,"merchant_ref",&csMerchRef)){
DEBUGLOG(("formatString:: merchant_ref= [%s]\n",csMerchRef));
	}
	
	if (GetField_CString(hRec,"txn_amount",&csTxnAmt)){
DEBUGLOG(("formatString:: amount =[%s]\n",csTxnAmt));
	}

	if (GetField_CString(hRec,"net_amount",&csNetAmt)){
DEBUGLOG(("formatString:: net_amt =[%s]\n",csNetAmt));
	}
	
	if (GetField_CString(hRec,"bank_code", &csBank)){
DEBUGLOG(("formatString:: bank_code = [%s]\n",csBank));
	}

	if (GetField_CString(hRec,"txn_ccy", &csCcy)){
DEBUGLOG(("formatString:: txn_ccy = [%s]\n",csCcy));
	}

	if (GetField_CString(hRec,"txn_country", &csCountry)){
DEBUGLOG(("formatString:: txn_country = [%s]\n",csCountry));
	}

	if (GetField_CString(hRec,"pay_method", &csPayMethod)){
DEBUGLOG(("formatString:: pay_method = [%s]\n",csPayMethod));
	}

	if (GetField_CString(hRec,"error_code", &csErrCode)){
DEBUGLOG(("formatString:: error_code = [%s]\n",csErrCode));
	}

	if (GetField_CString(hRec,"local_tm_date", &csLocalDate )){
DEBUGLOG(("formatString:: local_tm_date= [%s]\n",csLocalDate ));
	}

	if (GetField_CString(hRec,"local_tm_time", &csLocalTime)){
DEBUGLOG(("formatString:: local_tm_time= [%s]\n",csLocalTime));
	}

//TXN_ID,DATE,CHANNEL,STATUS,AR_IND,TXN_CODE,CLIENT_ID,MERCH_ID,MERCH_REF,LOCAL_TM_DATE,LOCAL_TM_TIME,CCY_ID,COUNTRY,PAY_METHOD,BANK_CODE,TXN_AMT,NET_AMT,TID,ERROR_CODE

	snprintf(csFormattedString,BUFFER_LEN,"%s,%s,%s,%c,%c,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s\n",csTxnId,csDate,csChannel,cStatus,cArInd,csTxnCode,csClientId,csMerchId,csMerchRef,csLocalDate,csLocalTime,csCcy,csCountry,csPayMethod,csBank,csTxnAmt,csNetAmt,csTid,csErrCode);
DEBUGLOG(("formatString:: [%s]\n",csFormattedString));


	FREE_ME(csTxnId);
	FREE_ME(csTxnCode);
	FREE_ME(csChannel);
	FREE_ME(csClientId);
	FREE_ME(csMerchId);
	FREE_ME(csMerchRef);
	FREE_ME(csLocalDate);
	FREE_ME(csLocalTime);
	FREE_ME(csTid);
	FREE_ME(csBank);
	FREE_ME(csErrCode);
	FREE_ME(csCcy);
	FREE_ME(csCountry);
	FREE_ME(csPayMethod);
	FREE_ME(csTxnAmt);
	FREE_ME(csNetAmt);

	return SUCCESS;		
	
DEBUGLOG(("formatString::Failed\n"));
	return FAILURE;
}

void insertDataToFile(const char* csFormattedString)
{
	FILE* pFile;
	pFile = fopen(EXPORT_FILE, "at");
	if(!pFile){
DEBUGLOG(("Cannot insert Data To File[%s]\n",EXPORT_FILE));
			return;
	}
	else{
		fputs(csFormattedString,pFile);
	}

	fclose(pFile);
		
}

int getDetailsFromDB(const char* csDate)
{
	recordset_t	*rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);


	hash_t  *hRec;
	char	*csOutput = strdup("");


	DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetDetailByTxnDate");

	if ((unsigned long int)(*DBObjPtr)(csDate,rRecordSet) == PD_OK) {
		hRec = RecordSet_GetFirst(rRecordSet);
		while(hRec){
			if(formatString(csDate, hRec,csOutput)==SUCCESS){
				insertDataToFile(csOutput);
			}
			
			hRec = RecordSet_GetNext(rRecordSet);
		}
	}


	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	FREE_ME(csOutput);
	return SUCCESS;
}


void clearFiles()
{
	FILE *pFile;

	pFile = fopen(EXPORT_FILE,"w");
	fclose(pFile);

}

int batch_proc(int argc, char* argv[])
{
	clearFiles();
	insertDataToFile(DATA_FORMAT);

	char *csDate  = strdup("");
	strcpy(csDate,argv[1]);
	csDate[strlen("yyyymmdd")]='\0';

DEBUGLOG(("Start reading DB\n"));	
	if(getDetailsFromDB(csDate)!=SUCCESS){
		FREE_ME(csDate);
		return FAILURE;
	}

	FREE_ME(csDate);

DEBUGLOG(("process end\n"));
	return SUCCESS;

}


int batch_terminate(int argc, char* argv[])
{
	return SUCCESS;
}
