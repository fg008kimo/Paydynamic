#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "utilitys.h"
#include "expat.h"
#include <curl/curl.h>
#include "myhash.h"
#include "ObjPtr.h"
#include "numutility.h"
#include "myrecordset.h"
#include "batchcommon.h"
#include "TxnSeq.h"
#include "import_merchantfile.h"

char    cDebug;
char    cs_inputfile[PD_MAX_FILE_LEN + 1];
char 	csKey[PD_SHA_KEY_LEN+1];

int 	parse_arg(int argc,char **argv);
int	parse_file(FILE *fin);
int	Verify_header(char (*s)[IMPORT_FIELD_LEN]);
int	Verify_detail(char (*csList)[IMPORT_FIELD_LEN]);
int 	checkMerchId(const char* csMerchId);
int VerifyMac(const char* csCheckSum,const char* csData, int iLen);

OBJPTR(BO);
OBJPTR(DB);

int batch_init(int argc, char* argv[])
{
	return SUCCESS;
}



int batch_proc(int argc, char* argv[])
{
        FILE    *fin;
        int     iRet;
        
        iRet = parse_arg(argc,argv);

        if (iRet != SUCCESS)
                return (iRet);

        fin = fopen(cs_inputfile,"r");
        
        if (fin == NULL) {
DEBUGLOG(("Error Opening file = [%s]\n",cs_inputfile));
                return FAILURE;
        }

        iRet = parse_file(fin);
        fclose(fin);

        return iRet;

}


int batch_terminate(int argc, char* argv[])
{
	return SUCCESS;
}

/* step 1 */
int	parse_file(FILE *fin) 
{
	int	iRet = SUCCESS;
	char	csList[IMPORT_MAX_FILE][IMPORT_FIELD_LEN];
	char    cs_input_buf[PD_MAX_BUFFER +1];;
	char* p;
	//int	iCount = 0,i;
	int	iCount = 0;
	int	iRecord = 0;


/* Header */
        iCount = 0;
        fgets(cs_input_buf,PD_MAX_BUFFER,fin);
        if (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A)
                cs_input_buf[strlen(cs_input_buf) - 1] = '\0';

        p = mystrtok(cs_input_buf,",");
        if (p == NULL)
                return FAILURE;

        strcpy(csList[iCount],p);
        iCount++;
        
        while ( (p = mystrtok(NULL,",")) != NULL) {
                strcpy(csList[iCount],p);
                iCount++;
        }       
//       	for (i=0; i < iCount; i++)
//DEBUGLOG(("header [%d] = [%s]\n",i,csList[i]));

	iRet = (Verify_header(csList));


	if ( iRet == PD_OK) {
		while( fgets(cs_input_buf, PD_MAX_BUFFER, fin) != NULL ){

			if (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A)
               	         	cs_input_buf[strlen(cs_input_buf) - 1] = '\0';
			iCount = 0;

       			p = mystrtok(cs_input_buf,",");
        		if (p == NULL) {
                		return FAILURE;
       			}
			iRecord++;

        		strcpy(csList[iCount],p);
        		iCount++;

        		while ( (p = mystrtok(NULL,",")) != NULL) {
                		strcpy(csList[iCount],p);
                		iCount++;
        		}

			iRet = (Verify_detail(csList));

//        	for (i=0; i < iCount; i++)
//DEBUGLOG(("Record [%d][%d] = [%s]\n",iRecord,i,csList[i]));

/*
DEBUGLOG(("Record [%d] seq_num = [%s]\n",iRecord,csList[IDX_DETAIL_SEQ_NUM]));
DEBUGLOG(("Record [%d] merchant_ref = [%s]\n",iRecord,csList[IDX_DETAIL_MERCHANT_REF]));
DEBUGLOG(("Record [%d] country = [%s]\n",iRecord,csList[IDX_DETAIL_COUNTRY]));
DEBUGLOG(("Record [%d] ID = [%s]\n",iRecord,csList[IDX_DETAIL_ID]));
DEBUGLOG(("Record [%d] acc no = [%s]\n",iRecord,csList[IDX_DETAIL_ACC_NO]));
DEBUGLOG(("Record [%d] acc name = [%s]\n",iRecord,csList[IDX_DETAIL_ACC_NAME]));
DEBUGLOG(("Record [%d] bank code = [%s]\n",iRecord,csList[IDX_DETAIL_BANK_CODE]));
DEBUGLOG(("Record [%d] bank name = [%s]\n",iRecord,csList[IDX_DETAIL_BANK_NAME]));
DEBUGLOG(("Record [%d] branch name = [%s]\n",iRecord,csList[IDX_DETAIL_BRANCH_NAME]));
DEBUGLOG(("Record [%d] PHONE_NOe = [%s]\n",iRecord,csList[IDX_DETAIL_PHONE_NO]));
DEBUGLOG(("Record [%d] Province = [%s]\n",iRecord,csList[IDX_DETAIL_PROVINCE]));
DEBUGLOG(("Record [%d] city = [%s]\n",iRecord,csList[IDX_DETAIL_CITY]));
DEBUGLOG(("Record [%d] amount = [%s]\n",iRecord,csList[IDX_DETAIL_AMOUNT]));
DEBUGLOG(("Record [%d] PAYOUT_CCy = [%s]\n",iRecord,csList[IDX_DETAIL_PAYOUT_CCY]));
DEBUGLOG(("Record [%d] DST_CCY = [%s]\n",iRecord,csList[IDX_DETAIL_DST_CCY]));
DEBUGLOG(("Record [%d] MAC = [%s]\n",iRecord,csList[IDX_DETAIL_MAC]));
*/

	
		}
	}
	return iRet;
}

/* step 1.1 */
int	Verify_header(char (*csList)[IMPORT_FIELD_LEN])
{
	int	iRet = SUCCESS;
	char	csBuf[PD_MAX_BUFFER +1];
// get merchant key

	iRet  = checkMerchId(csList[IDX_HEADER_MERCHANT_ID]);
	if (iRet == PD_OK)  {
		sprintf(csBuf,"%s|%s",csList[IDX_HEADER_MERCHANT_ID],csList[IDX_HEADER_NUMBER_OF_RECORD]);
		iRet =  VerifyMac(csList[IDX_HEADER_MAC],csBuf,strlen(csBuf));
	}
	return iRet;
}

/* step 1.2 */
int	Verify_detail(char (*csList)[IMPORT_FIELD_LEN])
{
	int iRet = SUCCESS;
	char	csBuf[PD_MAX_BUFFER +1];

	sprintf(csBuf,"%s|%s|%s|%s|%s",csList[IDX_DETAIL_SEQ_NUM],csList[IDX_DETAIL_MERCHANT_REF],csList[IDX_DETAIL_ID],csList[IDX_DETAIL_COUNTRY],csList[IDX_DETAIL_AMOUNT]);
	iRet =  VerifyMac(csList[IDX_DETAIL_MAC],csBuf,strlen(csBuf));

	return iRet;
}

int parse_arg(int argc,char **argv)
{
        char    c;
        strcpy(cs_inputfile,"");

        //while ((c = getopt(argc,argv,"f:")) != EOF && c != 0xff) {
        while ((c = getopt(argc,argv,"f:")) != EOF) {
                switch (c) {
                        case 'f':
                                strcpy(cs_inputfile, optarg);
                                break;
                        default:
                                return FAILURE;
                }
        }

        if (!strcmp(cs_inputfile,""))
                return FAILURE;

        return SUCCESS;
}


int checkMerchId(const char* csMerchId)
{
        char *csTmp = NULL;
        recordset_t     *rRecordSet;
        rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rRecordSet,0);
        DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GetMerchant");
        if ((*DBObjPtr)(csMerchId,rRecordSet) != PD_OK) {
DEBUGLOG(("checkMerchId: Merchant Id[%s] not found\n",csMerchId));
                return FAILURE;
        }
        else{
                hash_t  *hRec;
                hRec = RecordSet_GetFirst(rRecordSet);
                while (hRec) {
                        if (GetField_CString(hRec,"sha_key",&csTmp)){
                                strncpy(csKey,csTmp,PD_SHA_KEY_LEN);
                                csKey[PD_SHA_KEY_LEN]='\0';
DEBUGLOG(("checkMerchId: Key found [%s]\n",csKey));
                        }

                        hRec = RecordSet_GetNext(rRecordSet);
                }
        }

        RecordSet_Destroy(rRecordSet);
        FREE_ME(rRecordSet);

        return SUCCESS;
}

int VerifyMac(const char* csCheckSum,const char* csData, int iLen)
{
	int iRet = PD_OK;

	BOObjPtr = CreateObj(BOPtr,"BOSecurity","VerifyMac");

	iRet = (unsigned long int)(*BOObjPtr)(csCheckSum,csKey,csData,strlen(csData));
	
	return iRet;
}
