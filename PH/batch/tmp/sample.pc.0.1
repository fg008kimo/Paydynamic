#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "common.h"
#include "utilitys.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

int batch_init(int argc, char* argv[])
{
/*    if (argc < 2)
        return FAILURE;
      else
*/
        return SUCCESS;
}

int batch_proc(int argc, char* argv[])
{
	
	EXEC SQL WHENEVER SQLERROR GOTO sql_error;
    	EXEC SQL WHENEVER NOTFOUND CONTINUE;
/*
    	EXEC SQL BEGIN DECLARE SECTION;
                varchar v_sysdate[PD_DATE_LEN + 1];
		short	ind_sysdate =-1;
    	EXEC SQL END DECLARE SECTION;

	EXEC SQL SELECT to_char(sysdate,'yyyymmdd')
                INTO :v_sysdate:ind_sysdate
                FROM dual;

	if (ind_sysdate >= 0)  {
		printf("Sysdate = [%.*s]\n",v_sysdate.len,v_sysdate.arr);
		return SUCCESS;
	}
*/
	EXEC SQL BEGIN DECLARE SECTION;
		varchar v_id[PD_CODE_LEN+1];
		varchar v_name[PD_VALUE_LEN+1];
		short ind_id = -1;
		short ind_name = -1;

		varchar v_val[PD_VALUE_LEN+1];
		short ind_val = -1;
	EXEC SQL END DECLARE SECTION;

	EXEC SQL DECLARE test_cursor CURSOR FOR
		SELECT	sys_id, sys_name
		FROM	testing;

	EXEC SQL OPEN test_cursor;
	
	do{
		EXEC SQL FETCH test_cursor
		into 	:v_id:ind_id,
			:v_name:ind_name;
		
		if (SQLCODE == SQL_NOT_FOUND) {
			printf("End of Record\n");
                        break;
                }
		
		if((ind_id>=0) && (ind_name>=0))
		{
			v_id.arr[v_id.len]='\0';
			v_name.arr[v_name.len]='\0';

			printf("Record: ID[%s], NAME[%s]\n", (char*)v_id.arr, (char*)v_name.arr);


			EXEC SQL SELECT SYS_VAL INTO :v_val:ind_val
				FROM SYSTEM_CONTROL
				WHERE SYS_CODE=:v_id;
				
			if(SQLCODE == SQL_NOT_FOUND)
			{
				EXEC SQL INSERT INTO SYSTEM_CONTROL(SYS_CODE, SYS_VAL)
					VALUES(:v_id, :v_name);
				printf("Record Inserted: CODE[%s] VALUE[%s]\n", (char*)v_id.arr, (char*)v_name.arr);
			}
			else
			{
				v_val.arr[v_val.len]='\0';
				if(strncmp((char*)v_name.arr, (char*)v_val.arr, (short)v_name.len)!=0)
				{
					EXEC SQL UPDATE SYSTEM_CONTROL SET SYS_VAL=:v_name
						WHERE SYS_CODE=:v_id;
					printf("Record Updated: CODE[%s] VALUE[%s]->[%s]\n", (char*)v_id.arr, (char*)v_val.arr, (char*)v_name.arr);
				}
				else
				{
					EXEC SQL DELETE FROM SYSTEM_CONTROL
						WHERE SYS_CODE=:v_id;
					printf("Record deleted: CODE[%s] VALUE[%s]\n",(char*)v_id.arr,(char*)v_val.arr);
					//printf("No Record Updated\n");
				}
			}
		}
		else
			printf("Invalid Record\n");
		
	}while(PD_TRUE);
	
	EXEC SQL CLOSE test_cursor;
	EXEC SQL COMMIT WORK RELEASE;

	return SUCCESS;


sql_error:
    DEBUGLOG(("get_error code %d\n", sqlca.sqlcode));
    DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL ROLLBACK RELEASE;  
    return FAILURE;    
}

int batch_terminate(int argc, char* argv[])
{
    return SUCCESS;
}

