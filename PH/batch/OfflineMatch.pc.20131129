#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "common.h"
#include "utilitys.h"
#include "curl/curl.h"
#include "ObjPtr.h"
#include "myrecordset.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

OBJPTR(DB);
OBJPTR(BO);

char	cDebug='Y';

int batch_init(int argc, char* argv[])
{
/*    if (argc < 2)
        return FAILURE;
      else
*/
        return SUCCESS;
}


int batch_proc(int argc, char* argv[])
{
	int iRet = PD_OK;
        EXEC SQL WHENEVER SQLERROR GOTO sql_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar v_merchant_id[PD_MERCHANT_ID_LEN + 1];
                short   ind_merchant_id =-1;
        EXEC SQL END DECLARE SECTION;

	EXEC SQL DECLARE c_cursor_mids CURSOR FOR
		SELECT md_merchant_id
                  FROM ol_merch_detail, clients
                 WHERE md_disabled = 0
                   AND md_status = 'O'
                   AND md_client_id = client_id
                   AND status = 'O';

	EXEC SQL OPEN c_cursor_mids;
        do {
                EXEC SQL FETCH c_cursor_mids
                INTO
                        :v_merchant_id:ind_merchant_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

		if (ind_merchant_id >= 0) {
                        v_merchant_id.arr[v_merchant_id.len] = '\0';
                }
                else
                        v_merchant_id.arr[0] = '\0';

DEBUGLOG(("Merchant ID = [%s]\n",v_merchant_id.arr));
        }
        while(PD_TRUE && iRet == SUCCESS);
        EXEC SQL CLOSE c_cursor_mids;


        return FAILURE;
sql_error:
    DEBUGLOG(("get_error code %d\n", sqlca.sqlcode));
    DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_mids;
    EXEC SQL ROLLBACK RELEASE;
    return FAILURE;
}


int batch_terminate(int argc, char* argv[])
{
    return SUCCESS;
}

