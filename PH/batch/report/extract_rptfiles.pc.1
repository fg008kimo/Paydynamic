/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/02/03              Cody Chan
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sqlca.h>
#include <sqlcpr.h>
#include "common.h"
#include "utilitys.h"
#include "batchcommon.h"

char	cDebug;
#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


int Extract_RPT001(FILE* fp, SQL_CURSOR c_input_cursor)
{
	int	iRet = SUCCESS;
DEBUGLOG(("Extract_RPT001\n"));
	EXEC SQL WHENEVER SQLERROR GOTO extract_rpt001_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar v_txn_id[PD_TXN_ID_LEN +1];
		varchar	v_merchant_ref[PD_MERCHANT_REF_LEN +1];
                varchar v_txn_code[PD_TXN_CODE_LEN +1];
                varchar v_txn_code_desc[PD_DESC_LEN +1];
                double  v_open_bal;
                double  v_current_bal;
                varchar v_txn_element_type[PD_TXN_ELEMENT_TYPE_LEN +1];
                varchar v_txn_element_type_desc[PD_DESC_LEN +1];
                int     v_exec_seq;
		double	v_amount;
                varchar v_ccy[PD_CCY_ID_LEN +1];
                varchar v_amt_type[PD_AMT_TYPE_LEN +1];
                double  v_bal;
		varchar	v_approval_date[PD_DATE_LEN +1];

                short   ind_txn_id = -1;
		short	ind_merchant_ref = -1;
                short   ind_txn_code = -1;
                short   ind_txn_code_desc = -1;
                short   ind_open_bal = -1;
                short   ind_current_bal = -1;
                short   ind_txn_element_type = -1;
                short   ind_txn_element_type_desc = -1;
                short   ind_exec_seq = -1;
		short	ind_amount = -1;
                short   ind_ccy = -1;
                short   ind_amt_type = -1;
                short   ind_bal = -1;
		short	ind_approval_date = -1;

	EXEC SQL END DECLARE SECTION;

/* hd */	
	fprintf(fp,XLS_HD);
	fprintf(fp,XLS_NC);
	fprintf(fp,XLS_FL,"Txn ID");
/*
	fprintf(fp,XLS_FL,"Merchant Ref");
	fprintf(fp,XLS_FL,"Txn Desc");
	fprintf(fp,XLS_FL,"Opening Bal");
	fprintf(fp,XLS_FL,"Current Bal");
	fprintf(fp,XLS_FL,"Txn Element");
	fprintf(fp,XLS_FL,"Amount");
	fprintf(fp,XLS_FL,"Currency");
	fprintf(fp,XLS_FL,"Amount Type");
	fprintf(fp,XLS_FL,"Bal");
	fprintf(fp,XLS_FL,"Approval Date");
*/
	fprintf(fp,XLS_EC);
/* style */	
	fprintf(fp,XLS_SY);
	for (;;) {
		fprintf(fp,XLS_NC);
		EXEC SQL WHENEVER NOTFOUND DO break;
                EXEC SQL FETCH :c_input_cursor
                INTO
                        :v_txn_id:ind_txn_id,
			:v_merchant_ref:ind_merchant_ref,
                        :v_txn_code:ind_txn_code,
                        :v_txn_code_desc:ind_txn_code_desc,
                        :v_open_bal:ind_open_bal,
                        :v_current_bal:ind_current_bal,
                        :v_txn_element_type:ind_txn_element_type,
                        :v_txn_element_type_desc:ind_txn_element_type_desc,
                        :v_exec_seq:ind_exec_seq,
			:v_amount:ind_amount,
                        :v_ccy:ind_ccy,
                        :v_amt_type:ind_amt_type,
                        :v_bal:ind_bal,
			:v_approval_date:ind_approval_date;
/* txn id */
		v_txn_id.arr[v_txn_id.len] = '\0';
//		fprintf(fp,XLS_FL,v_txn_id.arr);
/* merchant ref */
		v_merchant_ref.arr[v_merchant_ref.len] = '\0';
/* txn code */
		v_txn_code.arr[v_txn_code.len] = '\0';
/* txn code desc */
		v_txn_code_desc.arr[v_txn_desc.len] = '\0';
/*open bal */
		if (ind_open_bal < 0) 
			v_open_bal = 0.0;

/*current bal */
		if (ind_current_bal < 0) 
			v_current_bal = 0.0;
/*txn element */
		v_txn_element_type.arr[v_txn_element_type.len] = '\0';
/*txn element desc */
		v_txn_element_type_desc.arr[v_txn_element_type_desc.len] = '\0';

/*exec seq */
		if (ind_exec_seq < 0) 
			v_exec_seq = 0;
/* amount */
		if (ind_amount < 0)
			v_amount = 0.0;

/*ccy */
		v_ccy.arr[v_ccy.len] = '\0';
/*amt_type */
		v_amt_type.arr[v_amt_type.len] = '\0';
/*bal */
		if (ind_bal < 0) 
			v_bal = 0.0;
/* approval date */
		v_approval_date.arr[v_approval_date.len] = '\0';
		
		fprintf(fp,XLS_EC);
	}

/* tailer */
	fprintf(fp,XLS_TR);

	return iRet;
extract_rpt001_error:
DEBUGLOG(("extract_rpt001 code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return FAILURE;
}




