/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/02/03              Cody Chan
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sqlca.h>
#include <sqlcpr.h>
#include "common.h"
#include "utilitys.h"
#include "batchcommon.h"

char	cDebug;
#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode


int Extract_RPT001(FILE* fp, SQL_CURSOR c_input_cursor)
{
	int	iRet = SUCCESS;
DEBUGLOG(("Extract_RPT001\n"));
	EXEC SQL WHENEVER SQLERROR GOTO extract_rpt001_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar v_txn_id[PD_TXN_ID_LEN +1];
		varchar	v_merchant_ref[PD_MERCHANT_REF_LEN +1];
                varchar v_txn_code[PD_TXN_CODE_LEN +1];
                varchar v_txn_code_desc[PD_DESC_LEN +1];
                double  v_open_bal;
                double  v_current_bal;
                varchar v_txn_element_type[PD_TXN_ELEMENT_TYPE_LEN +1];
                varchar v_txn_element_type_desc[PD_DESC_LEN +1];
                int     v_exec_seq;
		double	v_amount;
                varchar v_ccy[PD_CCY_ID_LEN +1];
                varchar v_amt_type[PD_AMT_TYPE_LEN +1];
                double  v_bal;
		varchar	v_approval_date[PD_DATE_LEN +1];

                short   ind_txn_id = -1;
		short	ind_merchant_ref = -1;
                short   ind_txn_code = -1;
                short   ind_txn_code_desc = -1;
                short   ind_open_bal = -1;
                short   ind_current_bal = -1;
                short   ind_txn_element_type = -1;
                short   ind_txn_element_type_desc = -1;
                short   ind_exec_seq = -1;
		short	ind_amount = -1;
                short   ind_ccy = -1;
                short   ind_amt_type = -1;
                short   ind_bal = -1;
		short	ind_approval_date = -1;

	EXEC SQL END DECLARE SECTION;

/* hd */	
	fprintf(fp,XLS_HD);
	fprintf(fp,XLS_NC);
	fprintf(fp,XLS_FL,"Txn ID");
	fprintf(fp,XLS_FL,"Merchant Ref");
	fprintf(fp,XLS_FL,"Txn Desc");
	fprintf(fp,XLS_FL,"Opening Bal");
	fprintf(fp,XLS_FL,"Current Bal");
	fprintf(fp,XLS_FL,"Txn Element");
	fprintf(fp,XLS_FL,"Amount");
	fprintf(fp,XLS_FL,"Currency");
	fprintf(fp,XLS_FL,"Amount Type");
	fprintf(fp,XLS_FL,"Bal");
	fprintf(fp,XLS_FL,"Approval Date");
	fprintf(fp,XLS_EC);

/* style */	
	fprintf(fp,XLS_SY);
	for (;;) {
		fprintf(fp,XLS_NC);
		EXEC SQL WHENEVER NOTFOUND DO break;
                EXEC SQL FETCH :c_input_cursor
                INTO
                        :v_txn_id:ind_txn_id,
			:v_merchant_ref:ind_merchant_ref,
                        :v_txn_code:ind_txn_code,
                        :v_txn_code_desc:ind_txn_code_desc,
                        :v_open_bal:ind_open_bal,
                        :v_current_bal:ind_current_bal,
                        :v_txn_element_type:ind_txn_element_type,
                        :v_txn_element_type_desc:ind_txn_element_type_desc,
                        :v_exec_seq:ind_exec_seq,
			:v_amount:ind_amount,
                        :v_ccy:ind_ccy,
                        :v_amt_type:ind_amt_type,
                        :v_bal:ind_bal,
			:v_approval_date:ind_approval_date;
/* txn id */
		v_txn_id.arr[v_txn_id.len] = '\0';
		fprintf(fp,XLS_FL_TEXT,v_txn_id.arr);

/* merchant ref */
		v_merchant_ref.arr[v_merchant_ref.len] = '\0';
		fprintf(fp,XLS_FL_TEXT,v_merchant_ref.arr);

/* txn code */
		v_txn_code.arr[v_txn_code.len] = '\0';
/* txn code desc */
		v_txn_code_desc.arr[v_txn_code_desc.len] = '\0';
		fprintf(fp,XLS_FL,v_txn_code_desc.arr);
/*open bal */
		if (ind_open_bal < 0) 
			v_open_bal = 0.0;
		fprintf(fp,XLS_FL_DOUBLE,v_open_bal);

/*current bal */
		if (ind_current_bal < 0) 
			v_current_bal = 0.0;
		fprintf(fp,XLS_FL_DOUBLE,v_current_bal);
/*txn element */
		v_txn_element_type.arr[v_txn_element_type.len] = '\0';

/*txn element desc */
		v_txn_element_type_desc.arr[v_txn_element_type_desc.len] = '\0';
		fprintf(fp,XLS_FL,v_txn_element_type_desc.arr);

/*exec seq */
		if (ind_exec_seq < 0) 
			v_exec_seq = 0;
/* amount */
		if (ind_amount < 0)
			v_amount = 0.0;
		fprintf(fp,XLS_FL_DOUBLE,v_amount);

/*ccy */
		v_ccy.arr[v_ccy.len] = '\0';
		fprintf(fp,XLS_FL,v_ccy.arr);

/*amt_type */
		v_amt_type.arr[v_amt_type.len] = '\0';
		fprintf(fp,XLS_FL,v_amt_type.arr);

/*bal */
		if (ind_bal < 0) 
			v_bal = 0.0;
		fprintf(fp,XLS_FL_DOUBLE,v_bal);
/* approval date */
		v_approval_date.arr[v_approval_date.len] = '\0';
		fprintf(fp,XLS_FL,v_approval_date.arr);
		
		fprintf(fp,XLS_EC);
	}

/* tailer */
	fprintf(fp,XLS_TR);

DEBUGLOG(("iRet = [%d]\n",iRet));
	return iRet;
extract_rpt001_error:
DEBUGLOG(("extract_rpt001 code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return FAILURE;
}



int Extract_RPT002(FILE* fp, SQL_CURSOR c_input_cursor)
{
	int	iRet = SUCCESS;
DEBUGLOG(("Extract_RPT002\n"));
	EXEC SQL WHENEVER SQLERROR GOTO extract_rpt002_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar v_txn_id[PD_TXN_ID_LEN +1];
		varchar	v_txn_desc[PD_DESC_LEN +1];
		varchar	v_client_id[PD_CLIENT_ID_LEN +1];
		varchar	v_client_name[PD_CLIENT_NAME_LEN +1];
		varchar	v_merchant_id[PD_MERCHANT_ID_LEN +1];
		varchar	v_merchant_name[PD_NAME_LEN +1];
		varchar	v_merchant_ref[PD_MERCHANT_REF_LEN +1];
		varchar	v_host_posting_date[PD_DATE_LEN +1];
		varchar v_transmission_datetime[PD_DATETIME_LEN +1];
		varchar	v_txn_country[PD_COUNTRY_LEN +1];
		varchar	v_txn_ccy[PD_CCY_ID_LEN +1];
		double	v_txn_amount;
		double  v_net_amount;
		double	v_reserve_amount;
		double	v_ex_rate;
		varchar	v_sub_status[PD_DESC_LEN +1];
		varchar	v_status[PD_NAME_LEN +1];
		varchar v_create_date[PD_DATETIME_LEN +1];
		varchar	v_update_date[PD_DATETIME_LEN +1];
		varchar	v_service_name[PD_NAME_LEN +1];
		varchar	v_approval_date[PD_DATE_LEN +1]; 


                short   ind_txn_id = -1;
		short	ind_txn_desc = -1;
		short	ind_client_id = -1;
		short	ind_client_name = -1;
		short	ind_merchant_id = -1;
		short	ind_merchant_name = -1;
		short	ind_merchant_ref = -1;
		short	ind_host_posting_date = -1;
		short   ind_transmission_datetime = -1;
		short	ind_txn_country = -1;
		short	ind_txn_ccy = -1;
		short	ind_txn_amount = -1;
		short   ind_net_amount = -1;
		short	ind_reserve_amount = -1;
		short	ind_ex_rate = -1;
		short	ind_sub_status = -1;
		short	ind_status = -1;
		short   ind_create_date = -1;
		short	ind_update_date = -1;
		short	ind_service_name =-1;
		short	ind_approval_date = -1;

	EXEC SQL END DECLARE SECTION;

/* hd */	
	fprintf(fp,XLS_HD);
	fprintf(fp,XLS_NC);
	fprintf(fp,XLS_FL,"Txn ID");
	fprintf(fp,XLS_FL,"Txn Desc");
	fprintf(fp,XLS_FL,"Client ID");
	fprintf(fp,XLS_FL,"Client Name");
	fprintf(fp,XLS_FL,"Merchant ID");
	fprintf(fp,XLS_FL,"Merchant Name");
	fprintf(fp,XLS_FL,"Merchant Ref #");
	fprintf(fp,XLS_FL,"Host Posting Date");
	fprintf(fp,XLS_FL,"Transmission DateTime");
	fprintf(fp,XLS_FL,"Txn Country");
	fprintf(fp,XLS_FL,"Txn Currency");
	fprintf(fp,XLS_FL,"Transaction Amount");
	fprintf(fp,XLS_FL,"Net Amount");
	fprintf(fp,XLS_FL,"Reserve Amount");
	fprintf(fp,XLS_FL,"EX Rate");
	fprintf(fp,XLS_FL,"Sub Status");
	fprintf(fp,XLS_FL,"Status");
	fprintf(fp,XLS_FL,"Create DateTime");
	fprintf(fp,XLS_FL,"Update DateTime");
	fprintf(fp,XLS_FL,"Service Name");
	fprintf(fp,XLS_FL,"Approval Date");

	fprintf(fp,XLS_EC);

/* style */	
	fprintf(fp,XLS_SY);
	for (;;) {
		EXEC SQL WHENEVER NOTFOUND DO break;
                EXEC SQL FETCH :c_input_cursor
                INTO
                        :v_txn_id:ind_txn_id,
			:v_txn_desc:ind_txn_desc,
			:v_client_id:ind_client_id,
			:v_client_name:ind_client_name,
			:v_merchant_id:ind_merchant_id,
			:v_merchant_name:ind_merchant_name,
			:v_merchant_ref:ind_merchant_ref,
			:v_host_posting_date:ind_host_posting_date,
			:v_transmission_datetime:ind_transmission_datetime,
			:v_txn_country:ind_txn_country,
			:v_txn_ccy:ind_txn_ccy,
			:v_txn_amount:ind_txn_amount,
			:v_net_amount:ind_net_amount,
			:v_reserve_amount:ind_reserve_amount,
			:v_ex_rate:ind_ex_rate,
			:v_sub_status:ind_sub_status,
			:v_status:ind_status,
			:v_create_date:ind_create_date,
			:v_update_date:ind_update_date,
			:v_service_name:ind_service_name,
                        :v_approval_date:ind_approval_date;
		fprintf(fp,XLS_NC);
/* txn ID */
		v_txn_id.arr[v_txn_id.len] = '\0';
		fprintf(fp,XLS_FL_TEXT,v_txn_id.arr);

/* txn desc */
		v_txn_desc.arr[v_txn_desc.len] = '\0';
		fprintf(fp,XLS_FL,v_txn_desc.arr);
		
/* client id */
		v_client_id.arr[v_client_id.len] = '\0';
		fprintf(fp,XLS_FL_TEXT,v_client_id.arr);

/* client name */
		v_client_name.arr[v_client_name.len] = '\0';
		fprintf(fp,XLS_FL,v_client_name.arr);

/* merchant id */
		v_merchant_id.arr[v_merchant_id.len] = '\0';
		fprintf(fp,XLS_FL_TEXT,v_merchant_id.arr);

/* merchant name */
		v_merchant_name.arr[v_merchant_name.len] = '\0';
		fprintf(fp,XLS_FL,v_merchant_name.arr);

/* merchant ref */
		v_merchant_ref.arr[v_merchant_ref.len] = '\0';
		fprintf(fp,XLS_FL_TEXT,v_merchant_ref.arr);

/* host posting date */
		v_host_posting_date.arr[v_host_posting_date.len] = '\0';
		fprintf(fp,XLS_FL_DATE,PD_YYYY_LEN,v_host_posting_date.arr,PD_MM_LEN,&v_host_posting_date.arr[PD_YYYY_LEN],PD_DD_LEN,&v_host_posting_date.arr[PD_YYYY_LEN + PD_MM_LEN]);

/* transmission datetime */
		v_transmission_datetime.arr[v_transmission_datetime.len] = '\0';
		if (v_transmission_datetime.len > PD_DATE_LEN) {
			fprintf(fp,XLS_FL_DATETIME,4,v_transmission_datetime.arr,2,&v_transmission_datetime.arr[4],2,&v_transmission_datetime.arr[6],2,&v_transmission_datetime.arr[8],2,&v_transmission_datetime.arr[10],2,&v_transmission_datetime.arr[12]);
		}
		else {
			fprintf(fp,XLS_FL_DATE,4,v_transmission_datetime.arr,2,&v_transmission_datetime.arr[4],2,&v_transmission_datetime.arr[6]);
		}

/* txn country */
		v_txn_country.arr[v_txn_country.len] = '\0';
		fprintf(fp,XLS_FL,v_txn_country.arr);

/* txn ccy */
		v_txn_ccy.arr[v_txn_ccy.len] = '\0';
		fprintf(fp,XLS_FL,v_txn_ccy.arr);

/* transaction amount */
		if (ind_txn_amount < 0 )
			v_txn_amount = 0.0;
		fprintf(fp,XLS_FL_DOUBLE,v_txn_amount);

/* net amount */
		if (ind_net_amount < 0 )
			v_net_amount = 0.0;
		fprintf(fp,XLS_FL_DOUBLE,v_net_amount);

/* reserve amount */
		if (ind_reserve_amount < 0 )
			v_reserve_amount = 0.0;
		fprintf(fp,XLS_FL_DOUBLE,v_reserve_amount);

/* ex rate */
		if (ind_ex_rate < 0 )
			v_ex_rate = 0.0;
		fprintf(fp,XLS_FL_DOUBLE,v_ex_rate);

/* sub status */
		v_sub_status.arr[v_sub_status.len] = '\0';
		fprintf(fp,XLS_FL,v_sub_status.arr);

/* status */
		v_status.arr[v_status.len] = '\0';
		fprintf(fp,XLS_FL,v_status.arr);

/* create_date */
		v_create_date.arr[v_create_date.len] = '\0';
		fprintf(fp,XLS_FL_DATE,PD_YYYY_LEN,v_create_date.arr,PD_MM_LEN,&v_create_date.arr[PD_YYYY_LEN],PD_DD_LEN,&v_create_date.arr[PD_YYYY_LEN + PD_MM_LEN]);

/* update_date */
		v_update_date.arr[v_update_date.len] = '\0';
		fprintf(fp,XLS_FL_DATE,PD_YYYY_LEN,v_update_date.arr,PD_MM_LEN,&v_update_date.arr[PD_YYYY_LEN],PD_DD_LEN,&v_update_date.arr[PD_YYYY_LEN + PD_MM_LEN]);

/* service_name */
		v_service_name.arr[v_service_name.len] = '\0';
		fprintf(fp,XLS_FL,v_service_name.arr);

/* approval date */
		v_approval_date.arr[v_approval_date.len] = '\0';
		if (ind_approval_date >= 0 ) {
			fprintf(fp,XLS_FL_DATE,PD_YYYY_LEN,v_approval_date.arr,PD_MM_LEN,&v_approval_date.arr[PD_YYYY_LEN],PD_DD_LEN,&v_approval_date.arr[PD_YYYY_LEN + PD_MM_LEN]);
		}
		else {
			fprintf(fp,XLS_FL," ");
		}

		fprintf(fp,XLS_EC);
	}

/* tailer */
	fprintf(fp,XLS_TR);

DEBUGLOG(("iRet = [%d]\n",iRet));
	return iRet;
extract_rpt002_error:
DEBUGLOG(("extract_rpt002 code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return FAILURE;
}




