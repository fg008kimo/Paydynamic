/*
PDProTech (c)2020. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.
 
Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2020/03/19              [WMC]
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "batchcommon.h"
#include "common.h"
#include "utilitys.h"
#include "myhash.h"
#include "numutility.h"
#include "myrecordset.h"
#include "ObjPtr.h"
#include "internal.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"
#include "dbutility.h"
#include "run_txn_balance_update.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char cs_last_phdate[PD_DATE_LEN+1];

static char    cDebug='Y';

OBJPTR(DB);
OBJPTR(BO);

int process_txn_balance(hash_t *hData, recordset_t *rErrRec);
int update_txn_balance(hash_t *hData, recordset_t *rUpdErrRec);
int validate_txn_balance(hash_t *hData, recordset_t *rValidErrRec);
int send_alert_email(recordset_t *rErrRec);

int parse_arg(int argc,char **argv);

int batch_init(int argc, char* argv[])
{
        return SUCCESS;
}


int batch_proc(int argc, char* argv[])
{
	int     iRet = SUCCESS;
	int	iDtlRet = PD_OK;

	char    csFrDatetime[PD_DATETIME_LEN + 1];
        char    csToDatetime[PD_DATETIME_LEN + 1];

	hash_t  *hData;
        hData = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hData,0);

	recordset_t *rErrRec;
        rErrRec = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rErrRec, 0);

DEBUGLOG(("batch_proc: Start!\n"));

	memset(csFrDatetime, 0, sizeof(csFrDatetime));
        memset(csToDatetime, 0, sizeof(csToDatetime));

	iRet = parse_arg(argc,argv);
        if (iRet != SUCCESS) {
                printf("*usage: -d last_phdate\n");
                return FAILURE;
        }

	// Process Datetime
	if (iRet == SUCCESS) {

		strcpy(csFrDatetime, cs_last_phdate);
		strcat(csFrDatetime, PD_FR_TIME);
		strcpy(csToDatetime, cs_last_phdate);
	        strcat(csToDatetime, PD_TO_TIME);

		PutField_CString(hData, "txn_aprv_date", cs_last_phdate);
		PutField_CString(hData, "fr_datetime", csFrDatetime);
		PutField_CString(hData, "to_datetime", csToDatetime);	

DEBUGLOG(("txn_aprv_date = [%s]\n",cs_last_phdate));
DEBUGLOG(("fr_datetime = [%s]\n",csFrDatetime));
DEBUGLOG(("to_datetime = [%s]\n",csToDatetime));
	}

	// Process Txn Balance
	if (iRet == SUCCESS) { 

		iDtlRet = process_txn_balance(hData, rErrRec);
		if (iDtlRet != PD_OK) {

			// Send Alert Email	
			iDtlRet = send_alert_email(rErrRec);
		
			iRet = FAILURE;
		}
	}

	hash_destroy(hData);
        FREE_ME(hData);

	RecordSet_Destroy(rErrRec);
        FREE_ME(rErrRec);	

DEBUGLOG(("batch_proc: iRet = [%d]\n", iRet));
	return iRet;
}


int batch_terminate(int argc, char* argv[])
{
        return SUCCESS;
}


int parse_arg(int argc, char **argv)
{
	char	c;
	strcpy(cs_last_phdate,"");

	if (argc < 2) {
DEBUGLOG(("argc = [%d]\n",argc));
		return FAILURE;
	}

	while ((c = getopt(argc,argv,"d:")) != EOF) {
		switch (c) {
			case 'd':
                                strcpy(cs_last_phdate, optarg);
                                break;
			default:
				return FAILURE;
		}
	}

	if (!strcmp(cs_last_phdate,""))
		return FAILURE;

        return SUCCESS;
}

int process_txn_balance(hash_t *hData, recordset_t *rErrRec)
{
	int	iRet = PD_OK;		
	int	iDtlRet = PD_TRUE;

	int	i = 0;
	int	iPartyTypeCnt = 2;
	int     iErrCnt = 0;
	int	iPtr = 0;

	char	cPartyType = ' ';
	
	char    *csTxnAprvDate = NULL;
	char	*csPtr = NULL;

	hash_t  *hUpdErrRec = NULL;
	hash_t  *hValidErrRec = NULL;

	hash_t  *hTxnBalLog;
        hTxnBalLog = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnBalLog,0);

	recordset_t *rUpdErrRec;
        rUpdErrRec = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rUpdErrRec, 0);

	recordset_t *rValidErrRec;
        rValidErrRec = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rValidErrRec, 0);

DEBUGLOG(("process_txn_balance: Start!\n"));

/* txn_aprv_date */
	if (GetField_CString(hData,"txn_aprv_date",&csTxnAprvDate)) {
//DEBUGLOG(("txn_aprv_date = [%s]\n", csTxnAprvDate));
       	} else {
DEBUGLOG(("txn_aprv_date not found!!\n"));
ERRLOG("run_txn_balance_update: process_txn_balance: txn_aprv_date not found!!\n");
          	iRet = INT_ERR;
      	}

	// Check Txn Balance Log
	for (i=0;i<iPartyTypeCnt;i++) {	

		if (iRet == PD_OK) {
	
			if (i == 0) {
				cPartyType = PD_TYPE_MERCHANT;
			} else if (i == 1) {
				cPartyType = PD_TYPE_PSP;
			}	
			PutField_Char(hTxnBalLog, "party_type", cPartyType);	
			PutField_CString(hTxnBalLog, "txn_aprv_date", csTxnAprvDate);
		
			// Check if Previous Txn Balance Log [Merchant] and [Psp] Completed
			DBObjPtr = CreateObj(DBPtr,"DBTxnBalanceLog","IsPrevCompleted");
	                iDtlRet = (unsigned long)(DBObjPtr)(hTxnBalLog);
			if (iDtlRet == PD_TRUE) {
DEBUGLOG(("Call DBTxnBalanceLog: IsPrevCompleted[%c]: True!!\n", cPartyType));

				// Check if Txn Balance Log [Merchant] and [Psp] Existed
				DBObjPtr = CreateObj(DBPtr,"DBTxnBalanceLog","IsExisted");
                        	iDtlRet = (unsigned long)(DBObjPtr)(hTxnBalLog);
				if (iDtlRet == PD_FALSE) {
DEBUGLOG(("Call DBTxnBalanceLog: IsExisted[%c]: False!!\n", cPartyType));

					// Update Txn Balance Log [Merchant] and [Psp] to "Processing"
					PutField_Int(hTxnBalLog, "is_completed", PD_FALSE);
					PutField_CString(hTxnBalLog, "update_user", PD_UPDATE_USER);

					DBObjPtr = CreateObj(DBPtr,"DBTxnBalanceLog","UpdateBalLog");
		                	if ((unsigned long)(DBObjPtr)(hTxnBalLog) == PD_OK) {
DEBUGLOG(("Call DBTxnBalanceLog: UpdateBalLog[%c]: [is_completed] = [0]: Success!!\n", cPartyType));
DEBUGLOG(("Call DBTxnBalanceLog: UpdateBalLog[%c]: [is_completed] = [0]: TxnCommit!!\n", cPartyType));
		                               	TxnCommit();
					} else {
DEBUGLOG(("Call DBTxnBalanceLog: UpdateBalLog[%c]: [is_completed] = [0]: Failure!!\n", cPartyType));
ERRLOG("run_txn_balance_update: process_txn_balance: Call DBTxnBalanceLog: UpdateBalLog Failure!!\n");
						iRet = INT_ERR;
					}
				} else if (iDtlRet == PD_TRUE) {
DEBUGLOG(("Call DBTxnBalanceLog: IsExisted[%c]: True!!\n", cPartyType));
                                	if (cPartyType == PD_TYPE_MERCHANT) {
                                	        iRet = INT_MERCH_TXN_BAL_LOG_EXISTS;
                                	} else if (cPartyType == PD_TYPE_PSP) {
                                	        iRet = INT_PSP_TXN_BAL_LOG_EXISTS;
                                	}
                        	} else {
DEBUGLOG(("Call DBTxnBalanceLog: IsExisted[%c]: Failure!!\n", cPartyType));
ERRLOG("run_txn_balance_update: process_txn_balance: Call DBTxnBalanceLog: IsExisted Failure!!\n");
                                	iRet = INT_ERR;
				}

			} else if (iDtlRet == PD_FALSE) {
DEBUGLOG(("Call DBTxnBalanceLog: IsPrevCompleted[%c]: False!!\n", cPartyType));
				if (cPartyType == PD_TYPE_MERCHANT) {
					iRet = INT_PREV_MERCH_TXN_BAL_UPD_NOT_CPL;
				} else if (cPartyType == PD_TYPE_PSP) {
					iRet = INT_PREV_PSP_TXN_BAL_UPD_NOT_CPL;
				}
			} else {
DEBUGLOG(("Call DBTxnBalanceLog: IsPrevCompleted[%c]: Failure!!\n", cPartyType));
ERRLOG("run_txn_balance_update: process_txn_balance: Call DBTxnBalanceLog: IsPrevCompleted Failure!!\n");
	               		iRet = INT_ERR;
			}
		}
	}

	// Update Txn Balance
	if (iRet == PD_OK) {
		iRet = update_txn_balance(hData, rUpdErrRec);
	}

	// Validate Txn Balance
	if (iRet == PD_OK) {
                iRet = validate_txn_balance(hData, rValidErrRec);
        }

	// Update Txn Balance Log [Merchant] and [Psp] to "Completed"
	for (i=0;i<iPartyTypeCnt;i++) {

                if (iRet == PD_OK) {

			if (i == 0) {
                                cPartyType = PD_TYPE_MERCHANT;
                        } else if (i == 1) {
                                cPartyType = PD_TYPE_PSP;
                        }
                        PutField_Char(hTxnBalLog, "party_type", cPartyType);
			PutField_Int(hTxnBalLog, "is_completed", PD_TRUE);

            		DBObjPtr = CreateObj(DBPtr,"DBTxnBalanceLog","UpdateBalLog");
            		if ((unsigned long)(DBObjPtr)(hTxnBalLog) == PD_OK) {
DEBUGLOG(("Call DBTxnBalanceLog: UpdateBalLog[%c]: [is_completed] = [1]: Success!!\n", cPartyType));
DEBUGLOG(("Call DBTxnBalanceLog: UpdateBalLog[%c]: [is_completed] = [1]: TxnCommit!!\n", cPartyType));
                	      	TxnCommit();
			} else {
DEBUGLOG(("Call DBTxnBalanceLog: UpdateBalLog[%c]: Failure!!\n", cPartyType));
ERRLOG("run_txn_balance_update: process_txn_balance: Call DBTxnBalanceLog: UpdateBalLog Failure!!\n");
				iRet = INT_ERR;
            		}
		}
	}

	// Add Error Record(s) into the Result
	if (iRet != PD_OK) {

		hUpdErrRec = RecordSet_GetFirst(rUpdErrRec);
                while (hUpdErrRec) {	

			hash_t  *hErrRec;
        		hErrRec = (hash_t*) malloc (sizeof(hash_t));
		        hash_init(hErrRec,0);
	
			PutField_CString(hErrRec, "approval_date", csTxnAprvDate);

/* txn_seq */
                      	if (GetField_CString(hUpdErrRec,"txn_seq",&csPtr)) {
//DEBUGLOG(("[%d] txn_seq = [%s]\n", iErrCnt, csPtr));
                              	PutField_CString(hErrRec, "txn_seq", csPtr);
                      	} else {
DEBUGLOG(("[%d] txn_seq not found!!\n", iErrCnt));
ERRLOG("run_txn_balance_update: process_txn_balance: txn_seq not found!!\n");
                              	iRet = INT_ERR;
                      	}	

/* err_code */
                        if (GetField_Int(hUpdErrRec,"err_code",&iPtr)) {
//DEBUGLOG(("[%d] err_code = [%d]\n", iErrCnt, iPtr));
                                PutField_Int(hErrRec, "err_code", iPtr);
                        } else {
DEBUGLOG(("[%d] err_code not found!!\n", iErrCnt));
ERRLOG("run_txn_balance_update: process_txn_balance: err_code not found!!\n");
				PutField_Int(hErrRec, "err_code", INT_ERR);
                                iRet = INT_ERR;
                        }

			RecordSet_Add(rErrRec, hErrRec);

			iErrCnt++;

			hUpdErrRec = RecordSet_GetNext(rUpdErrRec);
		}

		if (iErrCnt == 0) {

			hValidErrRec = RecordSet_GetFirst(rValidErrRec);
                	while (hValidErrRec) {

				hash_t  *hErrRec;
        			hErrRec = (hash_t*) malloc (sizeof(hash_t));
        			hash_init(hErrRec,0);

				PutField_CString(hErrRec, "approval_date", csTxnAprvDate);

/* txn_seq */
                        	if (GetField_CString(hValidErrRec,"txn_seq",&csPtr)) {
//DEBUGLOG(("[%d] txn_seq = [%s]\n", iErrCnt, csPtr));
                        	        PutField_CString(hErrRec, "txn_seq", csPtr);
                        	} else {
DEBUGLOG(("[%d] txn_seq not found!!\n", iErrCnt));
ERRLOG("run_txn_balance_update: process_txn_balance: txn_seq not found!!\n");
                        	        iRet = INT_ERR;
                        	}

/* err_code */
                        	if (GetField_Int(hValidErrRec,"err_code",&iPtr)) {
//DEBUGLOG(("[%d] err_code = [%d]\n", iErrCnt, iPtr));
                        	        PutField_Int(hErrRec, "err_code", iPtr);
                        	} else {
DEBUGLOG(("[%d] err_code not found!!\n", iErrCnt));
ERRLOG("run_txn_balance_update: process_txn_balance: err_code not found!!\n");
					PutField_Int(hErrRec, "err_code", INT_ERR);
                        	        iRet = INT_ERR;
                        	}

                        	RecordSet_Add(rErrRec, hErrRec);

                        	iErrCnt++;

                        	hValidErrRec = RecordSet_GetNext(rValidErrRec);
                	}
		}

		if (iErrCnt == 0) {

			hash_t  *hErrRec;
        		hErrRec = (hash_t*) malloc (sizeof(hash_t));
        		hash_init(hErrRec,0);

			PutField_CString(hErrRec, "approval_date", csTxnAprvDate);
			PutField_Int(hErrRec, "err_code", iRet);
DEBUGLOG(("[%d] err_code = [%d]\n", iErrCnt, iPtr));

			RecordSet_Add(rErrRec, hErrRec);
			
			iErrCnt++;
                }
	}

	hash_destroy(hTxnBalLog);
        FREE_ME(hTxnBalLog);
	
	RecordSet_Destroy(rUpdErrRec);
        FREE_ME(rUpdErrRec);

	RecordSet_Destroy(rValidErrRec);
        FREE_ME(rValidErrRec);

DEBUGLOG(("process_txn_balance: iRet = [%d]\n", iRet));
        return iRet;
}

int update_txn_balance(hash_t *hData, recordset_t *rUpdErrRec)
{
	int     iRet = PD_OK;
	int	iDtlRet = PD_FOUND;

	int	iCnt = 0;

	hash_t  *hTxnBalDetail = NULL;

	recordset_t *rTxnBalDetail;
        rTxnBalDetail = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rTxnBalDetail, 0);

DEBUGLOG(("update_txn_balance: Start!\n"));

	// Get All Record(s) where Status = [P] in Txn Balance Detail
	PutField_Char(hData,"upd_status",PD_PROCESSING);

	DBObjPtr = CreateObj(DBPtr,"DBTxnBalanceDetail","GetBalDetails");
	iDtlRet = (unsigned long)(DBObjPtr)(hData, rTxnBalDetail);
	if (iDtlRet == PD_FOUND) {
DEBUGLOG(("Call DBTxnBalanceDetail: GetBalDetails: Record(s) Found!!\n"));
	} else if (iDtlRet == PD_NOT_FOUND) {
//DEBUGLOG(("Call DBTxnBalanceDetail: GetBalDetails: No Record(s) Found!!\n"));
	} else {
DEBUGLOG(("Call DBTxnBalanceDetail: GetBalDetails: Failure!!\n"));
ERRLOG("run_txn_balance_update: update_txn_balance: Call DBTxnBalanceDetail: GetBalDetails: Failure!!\n");
	    	iRet = INT_ERR;
	}
	
	// Loop All Record(s)
	if ((iRet == PD_OK) && (iDtlRet == PD_FOUND)) {

              	hTxnBalDetail = RecordSet_GetFirst(rTxnBalDetail);
              	while ((iRet == PD_OK) && (hTxnBalDetail)) {

			double  dPtr = 0.0;

			char    *csTxnSeq = NULL;
			char    *csPtr = NULL;

			hash_t  *hMerchTxnBal;
        		hMerchTxnBal = (hash_t*) malloc (sizeof(hash_t));
        		hash_init(hMerchTxnBal,0);
	
        		hash_t  *hPspTxnBal;
        		hPspTxnBal = (hash_t*) malloc (sizeof(hash_t));
        		hash_init(hPspTxnBal,0);
	
			hash_t  *hUpdErrRec;
		        hUpdErrRec = (hash_t*) malloc (sizeof(hash_t));
        		hash_init(hUpdErrRec,0);

			PutField_CString(hMerchTxnBal,"update_user",PD_UPDATE_USER);
        		PutField_CString(hPspTxnBal,"update_user",PD_UPDATE_USER);

/* txn_seq */
                       	if (GetField_CString(hTxnBalDetail,"txn_id",&csTxnSeq)) {
DEBUGLOG(("[%d] txn_seq = [%s]\n", iCnt, csTxnSeq));
                               	PutField_CString(hMerchTxnBal, "txn_seq", csTxnSeq);
                               	PutField_CString(hPspTxnBal, "txn_seq", csTxnSeq);
				PutField_CString(hUpdErrRec,"txn_seq",csTxnSeq); 
                      	} else {
DEBUGLOG(("[%d] txn_seq not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: txn_seq not found!!\n");
                             	iRet = INT_ERR;
                   	}

/* txn_code */
                     	if (iRet == PD_OK) {
                             	if (GetField_CString(hTxnBalDetail,"txn_code",&csPtr)) {
DEBUGLOG(("[%d] txn_code = [%s]\n", iCnt, csPtr));
                                     	PutField_CString(hMerchTxnBal, "txn_code", csPtr);
                                     	PutField_CString(hPspTxnBal, "txn_code", csPtr);
                             	} else {
DEBUGLOG(("[%d] txn_code not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: txn_code not found!!\n");
                                      	iRet = INT_ERR;
                              	}
                     	}

/* merchant_id */
			if (iRet == PD_OK) {
                        	if (GetField_CString(hTxnBalDetail, "merchant_id", &csPtr)) {
DEBUGLOG(("[%d] merchant_id = [%s]\n", iCnt, csPtr));
					PutField_CString(hMerchTxnBal, "merchant_id", csPtr);
				} else {
DEBUGLOG(("[%d] merchant_id not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: merchant_id not found!!\n");
                                	iRet = INT_ERR;
                        	}
			}

/* service_code */
			if (iRet == PD_OK) {
                                if (GetField_CString(hTxnBalDetail, "service_code", &csPtr)) {
DEBUGLOG(("[%d] service_code = [%s]\n", iCnt, csPtr));
                                        PutField_CString(hMerchTxnBal, "service_code", csPtr);
                                } else {
DEBUGLOG(("[%d] service_code not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: service_code not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }			

/* country_id */
			if (iRet == PD_OK) {
                                if (GetField_CString(hTxnBalDetail, "country_id", &csPtr)) {
DEBUGLOG(("[%d] country_id = [%s]\n", iCnt, csPtr));
                                       	PutField_CString(hMerchTxnBal, "txn_country", csPtr);
                                } else {
DEBUGLOG(("[%d] country_id not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: country_id not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }
	
/* net_ccy */
			if (iRet == PD_OK) {
                                if (GetField_CString(hTxnBalDetail, "net_ccy", &csPtr)) {
DEBUGLOG(("[%d] net_ccy = [%s]\n", iCnt, csPtr));
                                        PutField_CString(hMerchTxnBal, "net_ccy", csPtr);
                                } else {
DEBUGLOG(("[%d] net_ccy not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: net_ccy not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* open_bal */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "open_bal", &dPtr)) {
DEBUGLOG(("[%d] open_bal = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hMerchTxnBal, "open_bal", dPtr);
                                } else {
DEBUGLOG(("[%d] open_bal not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: open_bal not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* current_bal */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "current_bal", &dPtr)) {
DEBUGLOG(("[%d] current_bal = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hMerchTxnBal, "current_bal", dPtr);
                                } else {
DEBUGLOG(("[%d] current_bal not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: current_bal not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* total_float */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "total_float", &dPtr)) {
DEBUGLOG(("[%d] total_float = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hMerchTxnBal, "total_float", dPtr);
                                } else {
DEBUGLOG(("[%d] total_float not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: total_float not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* total_reserved_amount */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "total_reserved_amt", &dPtr)) {
DEBUGLOG(("[%d] total_reserved_amount = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hMerchTxnBal, "total_reserved_amount", dPtr);
                                } else {
DEBUGLOG(("[%d] total_reserved_amount not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: total_reserved_amount not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* total_hold */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "total_hold", &dPtr)) {
DEBUGLOG(("[%d] total_hold = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hMerchTxnBal, "total_hold", dPtr);
                                } else {
DEBUGLOG(("[%d] total_hold not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: total_hold not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* fundin_payout */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "fundin_payout", &dPtr)) {
DEBUGLOG(("[%d] fundin_payout = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hMerchTxnBal, "fundin_payout", dPtr);
                                } else {
DEBUGLOG(("[%d] fundin_payout not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: fundin_payout not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* reserved_payout */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "reserved_payout", &dPtr)) {
DEBUGLOG(("[%d] reserved_payout = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hMerchTxnBal, "reserved_payout", dPtr);
                                } else {
DEBUGLOG(("[%d] reserved_payout not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: reserved_payout not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* total_float_after_payout */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "total_float_after_payout", &dPtr)) {
DEBUGLOG(("[%d] total_float_after_payout = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hMerchTxnBal, "total_float_after_payout", dPtr);
                                } else {
DEBUGLOG(("[%d] total_float_after_payout not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: total_float_after_payout not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* open_bal_settlement */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "open_bal_settlement", &dPtr)) {
DEBUGLOG(("[%d] open_bal_settlement = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hMerchTxnBal, "open_bal_settlement", dPtr);
                                } else {
DEBUGLOG(("[%d] open_bal_settlement not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: open_bal_settlement not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* current_bal_settlement */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "current_bal_settlement", &dPtr)) {
DEBUGLOG(("[%d] current_bal_settlement = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hMerchTxnBal, "current_bal_settlement", dPtr);
                                } else {
DEBUGLOG(("[%d] current_bal_settlement not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: current_bal_settlement not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }
		
/* total_float_settlement */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "total_float_settlement", &dPtr)) {
DEBUGLOG(("[%d] total_float_settlement = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hMerchTxnBal, "total_float_settlement", dPtr);
                                } else {
DEBUGLOG(("[%d] total_float_settlement not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: total_float_settlement not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* total_hold_settlement */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "total_hold_settlement", &dPtr)) {
DEBUGLOG(("[%d] total_hold_settlement = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hMerchTxnBal, "total_hold_settlement", dPtr);
                                } else {
DEBUGLOG(("[%d] total_hold_settlement not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: total_hold_settlement not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* psp_id */
			if (iRet == PD_OK) {
                                if (GetField_CString(hTxnBalDetail, "psp_id", &csPtr)) {
DEBUGLOG(("[%d] psp_id = [%s]\n", iCnt, csPtr));
                                        PutField_CString(hPspTxnBal, "psp_id", csPtr);
                                } else {
DEBUGLOG(("[%d] psp_id not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: psp_id not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }
	
/* psp_ccy */
			if (iRet == PD_OK) {
                                if (GetField_CString(hTxnBalDetail, "psp_ccy", &csPtr)) {
DEBUGLOG(("[%d] psp_ccy = [%s]\n", iCnt, csPtr));
                                        PutField_CString(hPspTxnBal, "txn_ccy", csPtr);
                                } else {
DEBUGLOG(("[%d] psp_ccy not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: psp_ccy not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* psp_bal */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "psp_bal", &dPtr)) {
DEBUGLOG(("[%d] psp_bal = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hPspTxnBal, "bal", dPtr);
                                } else {
DEBUGLOG(("[%d] psp_bal not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: psp_bal not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* psp_total_float */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "psp_total_float", &dPtr)) {
DEBUGLOG(("[%d] psp_total_float = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hPspTxnBal, "total_float", dPtr);
                                } else {
DEBUGLOG(("[%d] psp_total_float not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: psp_total_float not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

/* psp_hold */
			if (iRet == PD_OK) {
                                if (GetField_Double(hTxnBalDetail, "psp_hold", &dPtr)) {
DEBUGLOG(("[%d] psp_hold = [%lf]\n", iCnt, dPtr));
                                        PutField_Double(hPspTxnBal, "total_hold", dPtr);
                                } else {
DEBUGLOG(("[%d] psp_hold not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: psp_hold not found!!\n");
                                        iRet = INT_ERR;
                                }
                        }

			// Update Merchant Txn Balance and Psp Txn Balance
			if (iRet == PD_OK) {

				// Lock Txn Header, Status = [C]
				DBObjPtr = CreateObj(DBPtr, "DBTransaction", "MatchRespTxn");
                		if ((unsigned long)(DBObjPtr)(csTxnSeq, PD_COMPLETE) != PD_FOUND) {
DEBUGLOG(("[%d] Transaction status is not [%c]\n", iCnt, PD_COMPLETE));
ERRLOG("run_txn_balance_update: update_txn_balance: Transaction status is not [%c]\n", PD_COMPLETE);
                        		iRet = INT_INVALID_TXN;
                		}

				// Update Merchant Balance Information in Txn Detail if not exist
				if (iRet == PD_OK) {

                			DBObjPtr = CreateObj(DBPtr, "DBTransaction", "MerchBalInTxnDetail");
                			if ((unsigned long)(DBObjPtr)(csTxnSeq) == PD_TRUE) {
DEBUGLOG(("[%d] Merchant Balance Information already exists in Txn Detail, Skip Update!!\n", iCnt));
                			} else {

						// Update Txn Detail
                        			DBObjPtr = CreateObj(DBPtr, "DBTransaction", "UpdateDetail");
                        			iRet = (unsigned long)(*DBObjPtr)(hMerchTxnBal);
                        			if (iRet == PD_OK) {
DEBUGLOG(("[%d] Call DBTransaction: UpdateDetail: Success!!\n", iCnt));
						} else {
DEBUGLOG(("[%d] Call DBTransaction: UpdateDetail: Failure!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: Call DBTransaction: UpdateDetail: Failure!!\n");
                                			iRet = INT_ERR;
                       	 			}
                			}
				}

				// Update Psp Balance Information in Txn Psp Detail if not exist
                                if (iRet == PD_OK) {
	
                			DBObjPtr = CreateObj(DBPtr, "DBTxnPspDetail", "PspBalInTxnPspDetail");
                			if ((unsigned long)(DBObjPtr)(csTxnSeq) == PD_TRUE) {
DEBUGLOG(("[%d] Psp Balance Information already exists in Txn Psp Detail, Skip Update!!\n", iCnt));
			                } else {
 
			                       // Update Txn Psp Detail
                			        DBObjPtr = CreateObj(DBPtr, "DBTxnPspDetail", "Update");
                        			iRet = (unsigned long)(*DBObjPtr)(hPspTxnBal);
                        			if (iRet == PD_OK) {
DEBUGLOG(("[%d] Call DBTxnPspDetail: Update: Success!!\n", iCnt));
						} else {
DEBUGLOG(("[%d] Call DBTxnPspDetail: Update: Failure!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: Call DBTxnPspDetail: Update: Failure!!\n");
                                			iRet = INT_ERR;
                        			}
                			}
                                }
			}
	
			// Update Status to [C] in Txn Balance Detail 
			if (iRet == PD_OK) {

                		DBObjPtr = CreateObj(DBPtr, "DBTxnBalanceDetail", "UpdateStatus");
                		if ((unsigned long)(DBObjPtr)(csTxnSeq, PD_COMPLETE) == PD_OK) {
DEBUGLOG(("[%d] Call DBTxnBalanceDetail: UpdateStatus: Success!!\n", iCnt));
                		} else {
DEBUGLOG(("[%d] Call DBTxnBalanceDetail: UpdateStatus: Failure!!\n", iCnt));
ERRLOG("run_txn_balance_update: update_txn_balance: Call DBTxnBalanceDetail: UpdateStatus: Failure!!\n");
				}
			}

			hash_destroy(hMerchTxnBal);
                        FREE_ME(hMerchTxnBal);

                        hash_destroy(hPspTxnBal);
                        FREE_ME(hPspTxnBal);

			// Call Txn Commit/Txn Abort
			if (iRet == PD_OK) {
DEBUGLOG(("[%d] Call TxnCommit()!!\n", iCnt));
				TxnCommit();
			} else {
DEBUGLOG(("[%d] Call TxnAbort()!!\n", iCnt));

				// Add Error Record into the Result
				PutField_Int(hUpdErrRec,"err_code",iRet);

				RecordSet_Add(rUpdErrRec, hUpdErrRec);

				TxnAbort();
				break;
			}

			iCnt++;

                    	hTxnBalDetail = RecordSet_GetNext(rTxnBalDetail);
             	}
       	}

	RecordSet_Destroy(rTxnBalDetail);
        FREE_ME(rTxnBalDetail);

DEBUGLOG(("update_txn_balance: iRet = [%d]\n", iRet));
        return iRet;
}

int validate_txn_balance(hash_t *hData, recordset_t *rValidErrRec)
{
	int     iRet = PD_OK;
	int	iDtlRet = FOUND;

	int	iCnt = 0;
	
	char	*csPtr = NULL;

	hash_t	*hMerchTxnBal = NULL;
	hash_t	*hPspTxnBal = NULL;

	recordset_t *rMerchTxnBal;
        rMerchTxnBal = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rMerchTxnBal, 0);
	
	recordset_t *rPspTxnBal;
        rPspTxnBal = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rPspTxnBal, 0);

DEBUGLOG(("validate_txn_balance: Start!\n"));

	// Check Merchant Balance Information exists in Txn Detail By Approval Timestamp
	if (iRet == PD_OK) {

		DBObjPtr = CreateObj(DBPtr,"DBTransaction","GetMerchBalNullInTxnDetail");
	      	iDtlRet = (unsigned long)(DBObjPtr)(hData, rMerchTxnBal);
	      	if (iDtlRet == FOUND) {
DEBUGLOG(("Call DBTransaction: GetMerchBalNullInTxnDetail: Record(s) Found!!\n"));
			iRet = INT_MERCH_TXN_BAL_NULL_EXISTS;

			// Add Error Record(S) into the Result 
			hMerchTxnBal = RecordSet_GetFirst(rMerchTxnBal);
                        while (hMerchTxnBal) {

                                hash_t  *hValidErrRec;
                                hValidErrRec = (hash_t*) malloc (sizeof(hash_t));
                                hash_init(hValidErrRec,0);

                                PutField_Int(hValidErrRec,"err_code",iRet);

/* txn_seq */
                                if (GetField_CString(hMerchTxnBal,"txn_seq",&csPtr)) {
DEBUGLOG(("[%d] txn_seq = [%s]\n", iCnt, csPtr));
                                        PutField_CString(hValidErrRec, "txn_seq", csPtr);
                                } else {
DEBUGLOG(("[%d] txn_seq not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: validate_txn_balance: txn_seq not found!!\n");
                                        iRet = INT_ERR;
                                }

                                RecordSet_Add(rValidErrRec, hValidErrRec);

                                iCnt++;

                                hMerchTxnBal = RecordSet_GetNext(rMerchTxnBal);
                        }

	      	} else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("Call DBTransaction: GetMerchBalNullInTxnDetail: No Record(s) Found!!\n"));
	     	} else {
DEBUGLOG(("Call DBTransaction: GetMerchBalNullInTxnDetail: Failure!!\n"));
ERRLOG("run_txn_balance_update: validate_txn_balance: Call DBTransaction: GetMerchBalNullInTxnDetail: Failure!!\n");
	              	iRet = INT_ERR;
	      	}
	}
	
	// Check Psp Balance Information exists in Txn Psp Detail By Approval Timestamp
	if (iRet == PD_OK) {

		DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","GetPspBalNullInTxnPspDetail");
        	iDtlRet = (unsigned long)(DBObjPtr)(hData, rPspTxnBal);
        	if (iDtlRet == FOUND) {
DEBUGLOG(("Call DBTxnPspDetail: GetPspBalNullInTxnPspDetail: Record(s) Found!!\n"));
                	iRet = INT_PSP_TXN_BAL_NULL_EXISTS;

			// Add Error Record(S) into the Result
			hPspTxnBal = RecordSet_GetFirst(rPspTxnBal);
                        while (hPspTxnBal) {

                                hash_t  *hValidErrRec;
                                hValidErrRec = (hash_t*) malloc (sizeof(hash_t));
                                hash_init(hValidErrRec,0);

                                PutField_Int(hValidErrRec,"err_code",iRet);

/* txn_seq */
                                if (GetField_CString(hPspTxnBal,"txn_seq",&csPtr)) {
DEBUGLOG(("[%d] txn_seq = [%s]\n", iCnt, csPtr));
                                        PutField_CString(hValidErrRec, "txn_seq", csPtr);
                                } else {
DEBUGLOG(("[%d] txn_seq not found!!\n", iCnt));
ERRLOG("run_txn_balance_update: validate_txn_balance: txn_seq not found!!\n");
                                        iRet = INT_ERR;
                                }

                                RecordSet_Add(rValidErrRec, hValidErrRec);

                                iCnt++;

                                hPspTxnBal = RecordSet_GetNext(rPspTxnBal);
                        }

        	} else if (iDtlRet == NOT_FOUND) {
DEBUGLOG(("Call DBTxnPspDetail: GetPspBalNullInTxnPspDetail: No Record(s) Found!!\n"));
        	} else {
DEBUGLOG(("Call DBTxnPspDetail: GetPspBalNullInTxnPspDetail: Failure!!\n"));
ERRLOG("run_txn_balance_update: validate_txn_balance: Call DBTxnPspDetail: GetPspBalNullInTxnPspDetail: Failure!!\n");
        	        iRet = INT_ERR;
        	}
	}

	// Add Error Record(S) into the Result
        if (iRet != PD_OK) {

		if ((iRet != INT_MERCH_TXN_BAL_NULL_EXISTS)
		    && (iRet != INT_PSP_TXN_BAL_NULL_EXISTS)
		)
		{
			hash_t  *hValidErrRec;
                      	hValidErrRec = (hash_t*) malloc (sizeof(hash_t));
                      	hash_init(hValidErrRec,0);

			PutField_Int(hValidErrRec,"err_code",iRet);			

			RecordSet_Add(rValidErrRec, hValidErrRec);
		}
        }

     	RecordSet_Destroy(rMerchTxnBal);
     	FREE_ME(rMerchTxnBal);
	
	RecordSet_Destroy(rPspTxnBal);
        FREE_ME(rPspTxnBal);

DEBUGLOG(("validate_txn_balance: iRet = [%d]\n", iRet));
        return iRet;
}

int send_alert_email(recordset_t *rErrRec)
{
	int	iRet = PD_OK;

	int	iCnt = 0;
	int	iTxnSeqCnt = 0;
	int     iDynCnt = 0;

        char    *csApprovalDate = NULL;

	char    csErrMsg[PD_TMP_BUF_LEN+1];
    	char    csPtr[PD_TMP_BUF_LEN+1];
      	char    csTag[PD_TAG_LEN+1];

	hash_t  *hErrRec;

     	hash_t *hTemplate;
     	hTemplate = (hash_t*) malloc (sizeof(hash_t));
      	hash_init(hTemplate,0);

DEBUGLOG(("send_alert_email: Start\n"));

	memset(csPtr, 0, sizeof(csPtr));
	memset(csTag, 0, sizeof(csTag));
	
	// Loop All Error Record(s)
DEBUGLOG(("send_alert_email: Loop All Error Record(s)\n"));

	hErrRec = RecordSet_GetFirst(rErrRec);
        while ((iRet == PD_OK) && (hErrRec)) {

		int     iErrCode = PD_OK;

        	char    *csTxnSeq = NULL;

		memset(csErrMsg, 0, sizeof(csErrMsg));

/* approval_date */
                if (GetField_CString(hErrRec,"approval_date",&csApprovalDate)) {
DEBUGLOG(("send_alert_email: [%d] approval_date = [%s]\n",iCnt,csApprovalDate));
                } else {
DEBUGLOG(("send_alert_email: [%d] approval_date not found!!\n",iCnt));
ERRLOG("run_txn_balance_update: send_alert_email: approval_date not found!!\n");
			iRet = INT_ERR;
                }

/* err_code */
		if (iRet == PD_OK) {
			if (GetField_Int(hErrRec,"err_code",&iErrCode)) {
DEBUGLOG(("send_alert_email: [%d] err_code = [%d]\n",iCnt,iErrCode));

				// Get Internal Messages
                		DBObjPtr = CreateObj(DBPtr,"DBInternalMessages","GetMsg");
                   		if ((unsigned long)(*DBObjPtr)(iErrCode,csErrMsg) == FOUND) {
					sprintf(csPtr, csErrMsg);
DEBUGLOG(("send_alert_email: [%d] err_msg = [%s]\n",iCnt,csPtr));
	                     	} else {
DEBUGLOG(("send_alert_email: Call DBInternalMessages: GetMsg: Failure!!\n"));
ERRLOG("run_txn_balance_update: send_alert_email: Call DBInternalMessages: GetMsg: Failure!!\n");
        	                     	iRet = INT_CODE_ERROR;
        	              	}

			} else {
DEBUGLOG(("send_alert_email: [%d] err_code not found!!\n",iCnt));
ERRLOG("run_txn_balance_update: send_alert_email: err_code not found!!\n");
				iRet = INT_ERR;
			}
		}

/* txn_seq */
		if (iRet == PD_OK) {
			sprintf(csTag, "ftxn_id-%d", iCnt);
                	if (GetField_CString(hErrRec,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("send_alert_email: [%d] txn_seq = [%s]\n",iCnt,csTxnSeq));
                	        sprintf(csPtr, csTxnSeq);
				iTxnSeqCnt++;
               		} else {
DEBUGLOG(("send_alert_email: [%d] txn_seq = [ ]\n",iCnt));
                        	sprintf(csPtr, " ");
                	}
                	iDynCnt = set_tpl_dyn_cstring(hTemplate, iDynCnt, csTag, "STR", "stxn_id-0", csPtr);
		}

		iCnt++;
					
               	hErrRec = RecordSet_GetNext(rErrRec);
	}

	 if (iRet == PD_OK) {

              	// Record Exists
            	if (iCnt > 0) {

                     	// Alert Time
                    	iDynCnt = set_tpl_dyn_int(hTemplate, iDynCnt, "stimestamp-0", "SEC", "stimestamp-0", 0);
                    	iDynCnt = set_tpl_dyn_cstring(hTemplate, iDynCnt, "ftimestamp-0", "STR", "stimestamp-0", write_tpl_timestamp());

			// Approval Date
			iDynCnt = set_tpl_dyn_int(hTemplate, iDynCnt, "sapproval_date-0", "SEC", "sapproval_date-0", 0);
                    	iDynCnt = set_tpl_dyn_cstring(hTemplate, iDynCnt, "fapproval_date-0", "STR", "sapproval_date-0",  csApprovalDate);

			// Error Message
			iDynCnt = set_tpl_dyn_int(hTemplate, iDynCnt, "serror_message-0", "SEC", "serror_message-0", 0);
			iDynCnt = set_tpl_dyn_cstring(hTemplate, iDynCnt, "ferror_message-0", "STR", "serror_message-0", csErrMsg);		

			// Error Txn Seq
			if (iTxnSeqCnt > 0) {
				iDynCnt = set_tpl_dyn_int(hTemplate, iDynCnt, "stxn_id-0", "SEC", "stxn_id-0", iTxnSeqCnt);
			}		

			// Function
                        PutField_CString(hTemplate, "funct", PD_EML_FUNCT_TXN_BAL_UPD_ERR);
                 	PutField_CString(hTemplate, "source", PD_EML_SOURCE_BATCH);
                   	PutField_Char(hTemplate, "party_type", PD_TYPE_GLOBAL);
                   	PutField_CString(hTemplate, "party_id", PD_EML_PARTY_ID_BATCH);

                    	PutField_Int(hTemplate, "total_dyn", iDynCnt);

                    	// Process Alert Email Template
                      	BOObjPtr = CreateObj(BOPtr, "BOAlertEmail", "ProcessTpl");
                     	if ((unsigned long)((*BOObjPtr)(hTemplate) == PD_OK)) {
DEBUGLOG(("send_alert_email: Call BOAlertEmail: ProcessTpl Success\n"));
			} else {
DEBUGLOG(("send_alert_email: Call BOAlertEmail: ProcessTpl Failure\n"));
ERRLOG("run_txn_balance_update: send_alert_email: Call BOAlertEmail: ProcessTpl Failure\n");
                            	iRet = INT_ERR;
                       	}
                } else {
DEBUGLOG(("send_alert_email: No Error Record(s)\n"));
		}
        }

	hash_destroy(hTemplate);
        FREE_ME(hTemplate);

DEBUGLOG(("send_alert_email: iRet = [%d]\n", iRet));
        return iRet;
}

