/*
PDProTech (c)2020. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2020/07/15              [WMC]
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "batchcommon.h"
#include "common.h"
#include "utilitys.h"
#include "myhash.h"
#include "numutility.h"
#include "myrecordset.h"
#include "ObjPtr.h"
#include "internal.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char cs_action[PD_TMP_BUF_LEN+1];
char cs_bank_stmt_type[PD_TMP_BUF_LEN+1];
char cs_recon_type[PD_ENGINE_RECON_TYPE_LEN+1];
char cs_new_txn_code[PD_TXN_CODE_LEN+1];
char cs_txn_id[PD_TXN_ID_LEN+1];
char cs_stmt_id[PD_TXN_ID_LEN+1];

static char cDebug = 'Y';

OBJPTR(DB);
OBJPTR(Txn);

int parse_arg(int argc, char **argv);
int process_main();
int process_classify(hash_t *hRec);
int process_recon(hash_t *hRec);
int process_update_txn(hash_t *hRec);

int batch_init(int argc, char* argv[])
{
	return SUCCESS;
}

int batch_proc(int argc, char* argv[])
{
	int iRet = SUCCESS;
	int iDtlRet = PD_OK;

//DEBUGLOG(("batch_proc()\n"));

	iRet = parse_arg(argc, argv);
	if (iRet != SUCCESS) {
		printf("*usage: -a action -b bank_stmt_type -r recon_type -c new_txn_code -t txn_id -s stmt_id\n");
                return FAILURE;
	}

	iDtlRet = process_main();
	if (iDtlRet != PD_OK) {
		iRet = FAILURE;
	}

//DEBUGLOG(("batch_proc() iRet = [%d]\n", iRet));
	return iRet;
}

int batch_terminate(int argc, char* argv[])
{
	return SUCCESS;
}

int parse_arg(int argc, char **argv)
{
	char    c;
        strcpy(cs_action,"");
        strcpy(cs_bank_stmt_type,"");
        strcpy(cs_recon_type,"");
        strcpy(cs_new_txn_code,"");
        strcpy(cs_txn_id,"");
        strcpy(cs_stmt_id,"");

        if (argc < 12) {
DEBUGLOG(("argc = [%d]\n",argc));
                return FAILURE;
        }

        while ((c = getopt(argc,argv,"a:b:r:c:t:s:")) != EOF) {
                switch (c) {
                        case 'a':
                                strcpy(cs_action, optarg);
                                break;
			case 'b':
                                strcpy(cs_bank_stmt_type, optarg);
                                break;
			case 'r':
                                strcpy(cs_recon_type, optarg);
                                break;
			case 'c':
                                strcpy(cs_new_txn_code, optarg);
                                break;
			case 't':
                                strcpy(cs_txn_id, optarg);
                                break;
			case 's':
                                strcpy(cs_stmt_id, optarg);
                                break;
                        default:
                                return FAILURE;
                }
        }

        if ((!strcmp(cs_action,"")) || (!strcmp(cs_bank_stmt_type,"")) || (!strcmp(cs_recon_type,"")) || (!strcmp(cs_new_txn_code,"")) || (!strcmp(cs_txn_id,"")) || (!strcmp(cs_stmt_id,"")))
                return FAILURE;

        return SUCCESS;
}

int process_main()
{
	int iRet = PD_OK;
		
	hash_t *hRec;
        hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec, 0);

DEBUGLOG(("process_main()\n"));

       	PutField_CString(hRec, "activity", PD_TXN_ENGING_ACTIVITIY_RECON);
        PutField_CString(hRec, "input_channel", PD_CHANNEL_OMT);
       	PutField_CString(hRec, "trigger_type", PD_TRIGGER_SYSTEM);
        //PutField_CString(hRec, "use_pf", "0");
       	//PutField_CString(hRec, "have_charge", "0");
        //PutField_CString(hRec, "have_interest", "0");
        PutField_CString(hRec, "add_user", PD_UPDATE_USER);
      	PutField_CString(hRec, "update_user", PD_UPDATE_USER);

       	PutField_CString(hRec, "bank_stmt_type", cs_bank_stmt_type);
        PutField_CString(hRec, "recon_type", cs_recon_type);
        PutField_CString(hRec, "new_txn_code_1", cs_new_txn_code);
        PutField_CString(hRec, "txn_cnt", "1");
        PutField_CString(hRec, "txnid_1", cs_txn_id);
        PutField_CString(hRec, "stmt_cnt", "1");
      	PutField_CString(hRec, "stmt_txnid_1", cs_stmt_id);

DEBUGLOG(("action = [%s]\n", cs_action));
DEBUGLOG(("activity = [%s]\n", PD_TXN_ENGING_ACTIVITIY_RECON));
DEBUGLOG(("bank_stmt_type = [%s]\n", cs_bank_stmt_type));
DEBUGLOG(("input_channel = [%s]\n", PD_CHANNEL_OMT));
DEBUGLOG(("trigger_type = [%s]\n", PD_TRIGGER_SYSTEM));
DEBUGLOG(("recon_type = [%s]\n", cs_recon_type));
//DEBUGLOG(("use_pf = [%s]\n", "0"));
//DEBUGLOG(("have_charge = [%s]\n", "0"));
//DEBUGLOG(("have_interest = [%s]\n", "0"));
DEBUGLOG(("txn_cnt = [%s]\n", "1"));
DEBUGLOG(("txnid_1 = [%s]\n", cs_txn_id));
DEBUGLOG(("stmt_cnt = [%s]\n", "1"));
DEBUGLOG(("stmt_txnid_1 = [%s]\n", cs_stmt_id));
DEBUGLOG(("new_txn_code_1 = [%s]\n", cs_new_txn_code));
DEBUGLOG(("add_user = [%s]\n", PD_UPDATE_USER));
DEBUGLOG(("update_user = [%s]\n", PD_UPDATE_USER));

	// Classify BAID Txn 
	if (iRet == PD_OK) {
		if ((!strcmp(cs_action, "CLASSIFY_RECON_BAID_TXN")) 
		    || (!strcmp(cs_action, "CLASSIFY_BAID_TXN"))
		) 
		{
			iRet = process_classify(hRec);
			if (iRet == PD_OK) {
DEBUGLOG(("classify baid txn success!!\n"));
			} else {
DEBUGLOG(("classify baid txn failure!!\n"));
			}
		}
	}

	// Recon BAID Txn
	if (iRet == PD_OK) {
		if ((!strcmp(cs_action, "CLASSIFY_RECON_BAID_TXN"))
		    || (!strcmp(cs_action, "RECON_BAID_TXN"))
		)
		{
			iRet = process_recon(hRec);
			if (iRet == PD_OK) {
DEBUGLOG(("recon baid txn success!!\n"));
                       	} else {
DEBUGLOG(("recon baid txn failure!!\n"));
                       	}
		}
        }

	// Update Txn (Recon Status)
	if (iRet == PD_OK) {
		if (!strcmp(cs_action, "UPDATE_TXN")) 
		{
			iRet = process_update_txn(hRec);
			if (iRet == PD_OK) {
DEBUGLOG(("update txn (recon status) success!!\n"));
                       	} else {
DEBUGLOG(("update txn (recon status) failure!!\n"));
			}		
		}
	}

	hash_destroy(hRec);

	FREE_ME(hRec);

DEBUGLOG(("process_main() iRet = [%d]\n", iRet));
	return iRet;
}

int process_classify(hash_t *hRec)
{
	int iRet = PD_OK;
	
	int i = 0;
        int iTxnStmtCnt = 0;

	char *csTmp = NULL;

	char csTag[PD_TAG_LEN+1];

	hash_t *hBAIDTxn;
        hBAIDTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hBAIDTxn, 0);

/* update_user */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRec,"update_user",&csTmp)) {
//DEBUGLOG(("process_classify:: update_user = [%s]\n",csTmp));
                	PutField_CString(hBAIDTxn, "update_user", csTmp);
        	} else {
DEBUGLOG(("process_classify:: update_user not found!!\n"));
                	iRet = PD_ERR;
        	}
	}	

/* stmt_cnt */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRec,"stmt_cnt",&csTmp)) {
//DEBUGLOG(("process_classify:: stmt_cnt = [%s]\n",csTmp));
        	        iTxnStmtCnt = atoi(csTmp);
        	} else {
DEBUGLOG(("process_classify:: stmt_cnt not found!!\n"));
        	        iRet = PD_ERR;
        	}
	}

	for (i=1;i<=iTxnStmtCnt;i++) {
		
		if (iRet == PD_OK) {

/* txn_seq */
                        sprintf(csTag,"stmt_txnid_%d",i);
                        if(GetField_CString(hRec,csTag,&csTmp)){
                                PutField_CString(hBAIDTxn,"txn_seq",csTmp);
//DEBUGLOG(("process_classify:: stmt_txnid_%d = [%s]\n",i,csTmp));
                        } else {
DEBUGLOG(("process_classify:: stmt_txnid not found!!\n"));
                                iRet = PD_ERR;
                        }

/* new_txn_code */
			if (iRet == PD_OK) {
                        	sprintf(csTag,"new_txn_code_%d",i);
                        	if(GetField_CString(hRec,csTag,&csTmp)){
                        	        PutField_CString(hBAIDTxn,"new_txn_code",csTmp);
//DEBUGLOG(("process_classify:: new_txn_code_%d = [%s]\n",i,csTmp));
                        	} else {
DEBUGLOG(("process_classify:: new_txn_code not found!!\n"));
                        	        iRet = PD_ERR;
                        	}
			}

			// classified_status
                        PutField_Char(hBAIDTxn, "classified_status", PD_CLASSIFIED);

// Classify BAID Txn
			if (iRet == PD_OK) {
              			DBObjPtr = CreateObj(DBPtr, "DBOLBAIDTxn", "Update");
              			if ((unsigned long)(*DBObjPtr)(hBAIDTxn) != PD_OK) {
                		     	iRet = PD_ERR;
DEBUGLOG(("process_classify:: Call DBOLBAIDTxn:: Update() FAILURE!!!\n"));
ERRLOG("recon_baid_unknown_bank_stmt:: process_classify:: Call DBOLBAIDTxn:: Update() FAILURE!!!\n");
              			}
			}
		}
        }

	hash_destroy(hBAIDTxn);

	FREE_ME(hBAIDTxn);

//DEBUGLOG(("process_classify:: iRet = [%d]\n", iRet));
        return iRet;
}

int process_recon(hash_t *hRec)
{
        int iRet = PD_OK;

	int i = 0;
	int iTxnCnt = 0;
	int iTxnStmtCnt = 0;

	char *csTmp = NULL;

	char csTag[PD_TAG_LEN+1];

	hash_t *hContext;
        hContext = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hContext, 0);

        hash_t *hRequest;
        hRequest = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRequest, 0);

        hash_t *hResponse;
        hResponse = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hResponse, 0);

/* activity */
        if (GetField_CString(hRec,"activity",&csTmp)) {
//DEBUGLOG(("process_recon:: activity = [%s]\n",csTmp));
                PutField_CString(hRequest, "activity", csTmp);
        } else {
DEBUGLOG(("process_recon:: activity not found!!\n"));
                iRet = PD_ERR;
        }

/* bank_stmt_type */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRec,"bank_stmt_type",&csTmp)) {
//DEBUGLOG(("process_recon:: bank_stmt_type = [%s]\n",csTmp));
        	        PutField_CString(hRequest, "bank_stmt_type", csTmp);
        	} else {
DEBUGLOG(("process_recon:: bank_stmt_type not found!!\n"));
        	        iRet = PD_ERR;
        	}
	}

/* trigger_type */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRec,"trigger_type",&csTmp)) {
//DEBUGLOG(("process_recon:: trigger_type = [%s]\n",csTmp));
        	        PutField_CString(hRequest, "trigger_type", csTmp);
        	} else {
DEBUGLOG(("process_recon:: trigger_type not found!!\n"));
        	        iRet = PD_ERR;
        	}
	}

/* input_channel */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRec,"input_channel",&csTmp)) {
//DEBUGLOG(("process_recon:: input_channel = [%s]\n",csTmp));
       		        PutField_CString(hRequest, "input_channel", csTmp);
       	 	} else {
DEBUGLOG(("process_recon:: input_channel not found!!\n"));
         	       iRet = PD_ERR;
        	}
	}

/* recon_type */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRec,"recon_type",&csTmp)) {
//DEBUGLOG(("process_recon:: recon_type = [%s]\n",csTmp));
        	        PutField_CString(hRequest, "recon_type", csTmp);
        	} else {
DEBUGLOG(("process_recon::  not found!!\n"));
        	        iRet = PD_ERR;
        	}
	}

/* use_pf */
	if (iRet == PD_OK) {
       	 	if (GetField_CString(hRec,"use_pf",&csTmp)) {
//DEBUGLOG(("process_recon:: use_pf = [%s]\n",csTmp));
        	        PutField_CString(hRequest, "use_pf", csTmp);
        	} else {
//DEBUGLOG(("process_recon:: use_pf not found!!\n"));
        	}
	}

/* have_charge */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRec,"have_charge",&csTmp)) {
//DEBUGLOG(("process_recon:: have_charge = [%s]\n",csTmp));
       		        PutField_CString(hRequest, "have_charge", csTmp);
        	} else {
//DEBUGLOG(("process_recon:: have_charge not found!!\n"));
        	}
	}

/* have_interest */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRec,"have_interest",&csTmp)) {
//DEBUGLOG(("process_recon:: have_interest = [%s]\n",csTmp));
        	        PutField_CString(hRequest, "have_interest", csTmp);
        	} else {
//DEBUGLOG(("process_recon:: have_interest not found!!\n"));
        	}
	}

/* txn_cnt */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRec,"txn_cnt",&csTmp)) {
//DEBUGLOG(("process_recon:: txn_cnt = [%s]\n",csTmp));
                	PutField_CString(hRequest, "txn_cnt", csTmp);

			iTxnCnt = atoi(csTmp);
			for (i=1;i<=iTxnCnt;i++) {
				if (iRet == PD_OK) {
					sprintf(csTag,"txnid_%d",i);
                        		if(GetField_CString(hRec,csTag,&csTmp)){
                        		        PutField_CString(hRequest,csTag,csTmp);
//DEBUGLOG(("process_recon:: txnid_%d = [%s]\n",i,csTmp));
					} else {
DEBUGLOG(("process_recon:: txnid not found!!\n"));
						iRet = PD_ERR;
					}
				}
			}
        	} else {
DEBUGLOG(("process_recon:: txn_cnt not found!!\n"));
                	iRet = PD_ERR;
        	}
	}

/* stmt_cnt */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRec,"stmt_cnt",&csTmp)) {
//DEBUGLOG(("process_recon:: stmt_cnt = [%s]\n",csTmp));
                	PutField_CString(hRequest, "stmt_cnt", csTmp);

			iTxnStmtCnt = atoi(csTmp);
			for (i=1;i<=iTxnStmtCnt;i++) {
				if (iRet == PD_OK) {
                	        	sprintf(csTag,"stmt_txnid_%d",i);
                	        	if(GetField_CString(hRec,csTag,&csTmp)){
                	                	PutField_CString(hRequest,csTag,csTmp);
//DEBUGLOG(("process_recon:: stmt_txnid_%d = [%s]\n",i,csTmp));
                	        	} else {
DEBUGLOG(("process_recon:: stmt_txnid not found!!\n"));
                	                	iRet = PD_ERR;
                	        	}
				}
                	}
        	} else {
DEBUGLOG(("process_recon:: stmt_cnt not found!!\n"));
                	iRet = PD_ERR;
        	}
	}

/* add_user */
	if (iRet == PD_OK) {
        	if (GetField_CString(hRec,"add_user",&csTmp)) {
//DEBUGLOG(("process_recon:: add_user = [%s]\n",csTmp));
        	        PutField_CString(hRequest, "add_user", csTmp);
        	} else {
DEBUGLOG(("process_recon:: add_user not found!!\n"));
        	        iRet = PD_ERR;
        	}
	}

// Recon BAID Txn and Txn Id
        if (iRet == PD_OK) {
		TxnObjPtr = CreateObj(TxnPtr,"TxnOmtByUsREC","Authorize");
                if ((unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse) != PD_OK) {
                        iRet = PD_ERR;
DEBUGLOG(("process_recon:: Call TxnOmtByUsREC:: Authorize() FAILURE!!!\n"));
ERRLOG("recon_baid_unknown_bank_stmt:: process_main:: Call TxnOmtByUsREC:: Authorize() FAILURE!!!\n");
                }
	}

        hash_destroy(hContext);
        hash_destroy(hRequest);
        hash_destroy(hResponse);

        FREE_ME(hContext);
        FREE_ME(hRequest);
        FREE_ME(hResponse);

//DEBUGLOG(("process_recon:: iRet = [%d]\n", iRet));
	return iRet;
}

int process_update_txn(hash_t *hRec)
{
        int iRet = PD_OK;

	int i = 0;		
	
	int iTxnCnt = 0;

	char *csTmp = NULL;

	char csTag[PD_TAG_LEN+1];

	hash_t *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn, 0);

/* txn_cnt */
      	if (GetField_CString(hRec,"txn_cnt",&csTmp)) {
//DEBUGLOG(("process_update_txn:: txn_cnt = [%s]\n",csTmp));

             	iTxnCnt = atoi(csTmp);
             	for (i=1;i<=iTxnCnt;i++) {
                     	if (iRet == PD_OK) {
                           	sprintf(csTag,"txnid_%d",i);
                              	if(GetField_CString(hRec,csTag,&csTmp)){
                                     	PutField_CString(hTxn,"txn_seq",csTmp);
//DEBUGLOG(("process_update_txn:: txnid_%d = [%s]\n",i,csTmp));

					// recon_status
                			PutField_Char(hTxn, "recon_status", PD_RECON_NOT_REQ);

					// Update Txn Id
                			DBObjPtr = CreateObj(DBPtr, "DBOLTransaction", "Update");
                			if ((unsigned long)(*DBObjPtr)(hTxn) != PD_OK) {
                        			iRet = PD_ERR;
DEBUGLOG(("process_update_txn:: Call DBOLTransaction:: Update() FAILURE!!!\n"));
ERRLOG("recon_baid_unknown_bank_stmt:: process_update_txn:: Call DBOLTransaction:: Update() FAILURE!!!\n");
                			}

                            	} else {
DEBUGLOG(("process_update_txn:: txnid not found!!\n"));
                                       	iRet = PD_ERR;
                             	}
                    	}
              	}
     	} else {
DEBUGLOG(("process_update_txn:: txn_cnt not found!!\n"));
         	iRet = PD_ERR;
     	}

	hash_destroy(hTxn);

        FREE_ME(hTxn);		

//DEBUGLOG(("process_update_txn:: iRet = [%d]\n", iRet));
        return iRet;
}

