#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "common.h"
#include "utilitys.h"
#include "expat.h"
#include <curl/curl.h>
#include "myhash.h"
#include "ObjPtr.h"
#include "numutility.h"
#include "myrecordset.h"
#include "dates.h"

#include "TxnSeq.h"
#include "BOSecurity.h"

#include "sha1.h"
#define TESTA   "abc"

OBJPTR(BO);
char    cDebug;

int genNextYearMonth(const char *csYearMonth, char *csNext);
int genWeekEnd(char *csYearMonth);

int addmonth2(const char* csCurrentDate,int numofmonth,char* csNewDate);

static int vday[] = {
-1, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31, 29
};


int batch_init(int argc, char* argv[])
{
	return SUCCESS;
}


int batch_proc(int argc, char* argv[])
{
	int 	iRet = PD_OK;

	char	csBuf[1024];
	char	csNext[1024];

	memset(csBuf, 0, sizeof(csBuf));
	memset(csNext, 0, sizeof(csNext));

	sprintf(csBuf, "20150101");
	iRet = genNextYearMonth(csBuf, csNext);
	iRet = genWeekEnd(csNext);

	sprintf(csBuf, "20150201");
	iRet = genNextYearMonth(csBuf, csNext);
	iRet = genWeekEnd(csNext);

	sprintf(csBuf, "20150301");
	iRet = genNextYearMonth(csBuf, csNext);
	iRet = genWeekEnd(csNext);

	sprintf(csBuf, "20150401");
	iRet = genNextYearMonth(csBuf, csNext);
	iRet = genWeekEnd(csNext);

	sprintf(csBuf, "20150501");
	iRet = genNextYearMonth(csBuf, csNext);
	iRet = genWeekEnd(csNext);

	sprintf(csBuf, "20150601");
	iRet = genNextYearMonth(csBuf, csNext);
	iRet = genWeekEnd(csNext);

	sprintf(csBuf, "20150701");
	iRet = genNextYearMonth(csBuf, csNext);
	iRet = genWeekEnd(csNext);

	sprintf(csBuf, "20150801");
	iRet = genNextYearMonth(csBuf, csNext);
	iRet = genWeekEnd(csNext);

	sprintf(csBuf, "20150901");
	iRet = genNextYearMonth(csBuf, csNext);
	iRet = genWeekEnd(csNext);

	sprintf(csBuf, "20151001");
	iRet = genNextYearMonth(csBuf, csNext);
	iRet = genWeekEnd(csNext);

	sprintf(csBuf, "20151101");
	iRet = genNextYearMonth(csBuf, csNext);
	iRet = genWeekEnd(csNext);

	sprintf(csBuf, "20151201");
	iRet = genNextYearMonth(csBuf, csNext);
	iRet = genWeekEnd(csNext);


/*

printf("x YearMonth = [%s]\n", csBuf);
printf("x EndDate = [%s]\n", csEndDate);
*/

	return iRet;
}

int genWeekEnd(char *csYearMonth)
{
	int	iRet = PD_OK;
	char	csEndDate [20];
	int	i;

	int	iStart;
	int	iEnd;

	int	iTmpRtn = -1;
	char	csTmp[20];
	
	memset(csEndDate, 0, sizeof(csEndDate));	

printf("genWeekEnd YearMonth [%s]\n", csYearMonth);

	iRet = monthenddate(csYearMonth, csEndDate);

	iStart = atoi(csYearMonth);
	iEnd = atoi(csEndDate);

//printf("iStart = [%d]\n", iStart);
//printf("iEnd = [%d]\n", iEnd);

	for (i = iStart; i <= iEnd; i++)
	{
		iTmpRtn = -1;
		memset(csTmp, 0, sizeof(csTmp));

		sprintf(csTmp, "%d", i);
		iTmpRtn = day_of_week((const unsigned char *)csTmp);

		if (iTmpRtn == 6 || iTmpRtn == 0) {
printf("i = [%d] iTmpRtn = [%d]\n", i, iTmpRtn);
		}

	}

	return iRet;
}

int genNextYearMonth(const char *csYearMonth, char *csNext)
{
	int	iRet = PD_OK;

	char	csYMD[20];

printf("YearMonth = [%s]\n", csYearMonth);
	
	memset(csYMD, 0, sizeof(csYMD));
	iRet = addmonth2(csYearMonth, 12, csYMD);

printf("csYMD = [%s]\n", csYMD);

	memset(csNext, 0, sizeof(csNext));
	strncpy(csNext, csYMD, 6);
	strcat(csNext, "01");
printf("csNext = [%s]\n", csNext);
	return iRet;
	

}

int batch_terminate(int argc, char* argv[])
{
	return SUCCESS;
}

int addmonth2(const char* csCurrentDate,int numofmonth,char* csNewDate)
{   
        int i_year, i_dd, i_mm;
        char buf[40];
    
        if (check_valid_date(csCurrentDate) != PD_OK)
                return(PD_ERR);
    
        sprintf(buf,"%c%c%c%c", csCurrentDate[0], csCurrentDate[1], csCurrentDate[2], csCurrentDate[3]);
        i_year = atoi(buf);
        sprintf(buf, "%c%c", csCurrentDate[4], csCurrentDate[5]);
        i_mm = atoi(buf);
        sprintf(buf, "%c%c", csCurrentDate[6], csCurrentDate[7]);
   
        i_mm = i_mm + numofmonth;

        if (i_mm > 12 )
        {
                i_year = i_year + (int)(i_mm / 12);
                i_mm = i_mm % 12;

		if (i_mm == 0) {
			i_year--;
			i_mm=12;
		}
        }


        if (isleap(i_year) && i_mm == 2)
                i_dd = vday[13];
        else
                i_dd = vday[i_mm];

        sprintf(csNewDate, "%04d%02d%02d", i_year, i_mm, i_dd);
        return(PD_OK);
}   
