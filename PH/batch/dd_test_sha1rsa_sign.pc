#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <stdint.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "common.h"
#include "utilitys.h"
#include "curl/curl.h"
#include "ObjPtr.h"
#include "myrecordset.h"
#include "myhash.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode
#define MAX_MSG_SIZE 4096
#define RSA_PKCS1_PADDING       1
#define RSA_SSLV23_PADDING      2
#define RSA_NO_PADDING          3
#define RSA_PKCS1_OAEP_PADDING  4
#define RSA_X931_PADDING        5
/* EVP_PKEY_ only */
#define RSA_PKCS1_PSS_PADDING   6

OBJPTR(BO);

char	cDebug='Y';

int batch_init(int argc, char* argv[])
{
        return SUCCESS;
}


int batch_proc(int argc, char* argv[])
{
	int iRet;

	char *csOutput;
	csOutput = (char*) malloc (MAX_MSG_SIZE + 1 );
	memset(csOutput, 0, sizeof(csOutput));

	char *csPriKeyFile = "ouq_ylpu019_pri.pem";
	char *csInput = "order_id=0000000007125865&order_amount=66.66&order_time=";

	hash_t *hContext;
	hContext = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hContext, 0);

	hash_t *hOut;
	hOut = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hOut, 0);

printf("Start\n");

printf("csInput [%s]\n",csInput);

	PutField_CString(hOut, "auth_data", csInput);
	PutField_CString(hContext, "rsa_key", csPriKeyFile);

	BOObjPtr = CreateObj(BOPtr,"BOSecurity","GenerateHXPaySign");

	iRet = (unsigned long)(*BOObjPtr)(hContext, hOut);

	if (iRet == PD_OK) {
		if (GetField_CString(hOut, "sign", &csOutput)) {
printf("csOutput [%s]\n",csOutput);
		} else {
printf("no csOutput\n");
		}
	}

printf("\n==========\n\n");

	hash_t *hRequest;
	hRequest = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRequest, 0);

/*
	//char *csInput2 = "curCode=CNY&cxOrderNo=test0000000001&dealCode=10000&dealMsg=成功&dealTime=20180212184801&fee=111&merchantNo=CX0003001&orderAmount=1234&orderNo=0000000002809978&orderTime=20180212184340&payChannelCode=ABC&signType=2&version=V2.0";
	char *csInput2 = "codeUrl=https://qpay.qq.com/qr/50200d7a&dealCode=10000&dealMsg=交易成功&merchantNo=CX0003001";
	//char *csSign = "Rmj0nPGDvP1ofxTIl7JRrB2r9C3sSmwYctwls4exWzpJgtyQa4P7OANxHEqQ9WtvSf1H3V/vRT1Se7RteAKaDJnadqN2IKy56PCdDewJR3R0EAGwRV3qnSAChKEMQE1PWgbxf4Cjdvb5JxoNjDR1ZpZjglLfF1LFi+P/6k5DQvY=";
	char *csSign = "MfYmslUd8eqn%2BzluzuNfQ%2BskGweSn8dTJwCIbSEVItkY9plAWD6dsuebhSd1JIMzpXUxMANI7aPfWAIzz%2FJaSUPqC50xIxrqgPS949DEIFp6h48ejpETkFIkqQ0kKxQJBms7IbajnuW0lNTX6KaLecw09j78CerysnVHBdAiXEI%3D";
	char *csPubKeyFile = "lm_test_pub.pem";

printf("csInput2 = [%s]\n",csInput2);
*/

	int iLen = 0;
	char csDeSign[PD_TMP_MSG_BUF_LEN];
	//urldecode((const unsigned char*)csSign, strlen(csSign), (unsigned char*)csDeSign, &iLen);
	urldecode((const unsigned char*)"~%21%40%23%24%25%5e%26%2a%28%29_%2b%60-%3d%5b%5d%5c%3b%27%2c.%2f%7b%7d%7c%3a%22%3c%3e%3f", strlen("~%21%40%23%24%25%5e%26%2a%28%29_%2b%60-%3d%5b%5d%5c%3b%27%2c.%2f%7b%7d%7c%3a%22%3c%3e%3f"), (unsigned char*)csDeSign, &iLen);
	csDeSign[iLen] = '\0';
printf("urldecode(csSign) = [%s]\n",csDeSign);

/*
	PutField_CString(hRequest, "auth_data", csInput2);
	PutField_CString(hRequest, "sign", csDeSign);
	PutField_CString(hContext, "rsa_privatepem", csPubKeyFile);

	BOObjPtr = CreateObj(BOPtr,"BOSecurity","VerifyHXPaySign");

	iRet = (unsigned long)(*BOObjPtr)(hContext, hRequest);
printf("iRet = [%d]\n", iRet);
*/

	hash_destroy(hContext);
	hash_destroy(hOut);
	hash_destroy(hRequest);
	FREE_ME(hContext);
	FREE_ME(hOut);
	FREE_ME(hRequest);
	FREE_ME(csOutput);

printf("End\n");
	return 0;
}


int batch_terminate(int argc, char* argv[])
{
    return SUCCESS;
}

