CREATE OR REPLACE FUNCTION sp_check_duplicate_fee_charge(
	out_cursor            out     sys_refcursor)
RETURN NUMBER Is
	iCnt    integer := 0;
Begin

  select count(1)
  into iCnt
    FROM (SELECT *
            FROM (  SELECT te_txn_id,
                           te_txn_element_type,
                           te_amount,
                           te_ccy,
                           te_amt_type,
                           te_party_type,
                           COUNT (1) AS ele_cnt
                      FROM txn_elements
                     WHERE     te_create_timestamp > SYSDATE - 1
                           AND te_party_type = 'M'
                           AND te_txn_element_type IN ('TFEE')
                  GROUP BY te_txn_id,
                           te_txn_element_type,
                           te_amount,
                           te_ccy,
                           te_amt_type,
                           te_party_type)
           WHERE ele_cnt > 1) a,
         (SELECT th_txn_id,
                 th_merchant_id,
                 th_merchant_ref,
                 th_transaction_amount,
                 th_net_ccy,
                 TO_CHAR (th_create_timestamp, 'YYYY-MM-DD HH24:MI:SS')
                    create_time,
                 TO_CHAR (th_approval_timestamp, 'YYYY-MM-DD HH24:MI:SS')
                    approve_time
            FROM txn_header
           WHERE     th_txn_code = 'DSI'
                 AND th_ar_ind = 'A'
                 AND th_create_timestamp > SYSDATE - 1) b
   WHERE a.te_txn_id = b.th_txn_id
  
  if iCnt > 0 THEN
  OPEN out_cursor for
  SELECT te_txn_id,
         th_merchant_id,
         th_merchant_ref,
         th_transaction_amount,
         th_net_ccy,
         create_time,
         approve_time,
         te_txn_element_type,
         te_amount,
         ele_cnt
    FROM (SELECT *
            FROM (  SELECT te_txn_id,
                           te_txn_element_type,
                           te_amount,
                           te_ccy,
                           te_amt_type,
                           te_party_type,
                           COUNT (1) AS ele_cnt
                      FROM txn_elements
                     WHERE     te_create_timestamp > SYSDATE - 1
                           AND te_party_type = 'M'
                           AND te_txn_element_type IN ('TFEE')
                  GROUP BY te_txn_id,
                           te_txn_element_type,
                           te_amount,
                           te_ccy,
                           te_amt_type,
                           te_party_type)
           WHERE ele_cnt > 1) a,
         (SELECT th_txn_id,
                 th_merchant_id,
                 th_merchant_ref,
                 th_transaction_amount,
                 th_net_ccy,
                 TO_CHAR (th_create_timestamp, 'YYYY-MM-DD HH24:MI:SS')
                    create_time,
                 TO_CHAR (th_approval_timestamp, 'YYYY-MM-DD HH24:MI:SS')
                    approve_time
            FROM txn_header
           WHERE     th_txn_code = 'DSI'
                 AND th_ar_ind = 'A'
                 AND th_create_timestamp > SYSDATE - 1) b
   WHERE a.te_txn_id = b.th_txn_id
ORDER BY te_txn_id;
 
 return 1;

else
	return 0;
end if;

exception
   WHEN OTHERS THEN
     RETURN 0;
END sp_check_duplicate_fee_charge;
/
