/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/05/25              Virginia Yun
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "../batchcommon.h"
#include "common.h"
#include "utilitys.h"
#include "myhash.h"
#include "numutility.h"
#include "myrecordset.h"
#include "par_merchant_detail.h"
#include "ObjPtr.h"


#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

#define	PD_MY_DELIMITOR	","
#define	PD_MY_TOKEN	'"'

/*
#define	PD_MY_QS_TOEKN	'	'
#define	PD_MY_QE_TOEKN	'	'
#define	PD_MY_DAY_TOKEN	"-"
*/

#define	PD_CHAR		0x0D

OBJPTR(DB);
OBJPTR(Txn);
OBJPTR(Channel);

char    cDebug='Y';


char    cs_inputfile[PD_MAX_FILE_LEN + 1];

int parse_arg(int argc,char **argv);
int verify_file(FILE *fin, hash_t *hContext, hash_t *hRequest, hash_t *hResponse);
int process_txn(char csInList[][IMPORT_FIELD_LEN], hash_t *hContext, hash_t *hRequest, hash_t *hResponse);

int batch_init(int argc, char* argv[])
{

    if (argc < 1) {
    	printf("usage: -f input file\n");
        return FAILURE;
    }
    else
        return SUCCESS;
}


int batch_proc(int argc, char* argv[])
{
	FILE	*fin;
	int	iRet;

        hash_t          *hContext, *hRequest, *hResponse;

        hContext = (hash_t *)malloc(sizeof(hash_t));
        hRequest = (hash_t *)malloc(sizeof(hash_t));
        hResponse= (hash_t *)malloc(sizeof(hash_t));

        hash_init(hContext,   0);
        hash_init(hRequest,  0);
        hash_init(hResponse, 0);

	
	iRet = parse_arg(argc,argv);

	if (iRet != SUCCESS) {
    		printf("*usage: -f input file\n");
		return (iRet);
	}

	fin = fopen(cs_inputfile,"r");
	if (fin == NULL) {
DEBUGLOG(("Error Opening file = [%s]\n",cs_inputfile));
		return FAILURE;
	}

	ChannelObjPtr = CreateObj(ChannelPtr, "MGTChannel","UpdateContext");
	iRet = (unsigned long)((*ChannelObjPtr)(hContext));

	if (iRet == PD_OK) {
		iRet = verify_file(fin, hContext, hRequest, hResponse);	
	} else {
DEBUGLOG(("Error UpdateContext\n"));
	}


	fclose(fin);

	hash_destroy(hContext);
	hash_destroy(hRequest);
	hash_destroy(hResponse);

	FREE_ME(hContext);
	FREE_ME(hRequest);
	FREE_ME(hResponse);

	return iRet;

}


int batch_terminate(int argc, char* argv[])
{
	return SUCCESS;
}


                        
int parse_arg(int argc,char **argv)
{               
        char    c;
        strcpy(cs_inputfile,"");
                        
        while ((c = getopt(argc,argv,"f:")) != EOF) {
                switch (c) {
                        case 'f':
                                strcpy(cs_inputfile, optarg);
                                break;
                        default:
                                return FAILURE;
                }
        }       
        
DEBUGLOG(("[%s]\n",cs_inputfile));
        if (!strcmp(cs_inputfile,""))
                return FAILURE;
                
        return SUCCESS; 
}               


int verify_file(FILE *fin, hash_t *hContext, hash_t *hRequest, hash_t *hResponse)
{
        int     iRet = FAILURE;

	int	iCount;
        char    cs_input_buf[PD_MAX_BUFFER +1]; /*read buffer*/
	char	*p;
	char    csList[IMPORT_MAX_FIELD][IMPORT_FIELD_LEN];

	int	iRowCnt = 0;

/*
        char    csDate[3][PD_YYYY_LEN+1];
	char	csTmp[PD_MAX_BUFFER +1];

	double	dTmp;
*/

	memset(csList, 0, sizeof(csList));


/* Header */    
        iCount = 0;
	iRowCnt = 0;

/*
        fgets(cs_input_buf,PD_MAX_BUFFER,fin);
        if (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A || cs_input_buf[strlen(cs_input_buf) - 1] == 0x10)
               cs_input_buf[strlen(cs_input_buf) - 1] = '\0';
	strcpy(cs_input_buf,TrimAllChar((const unsigned char*)cs_input_buf,strlen(cs_input_buf),PD_CHAR));
	iRowCnt++;
*/
/* End of Header */

        while (fgets(cs_input_buf,PD_MAX_BUFFER, fin) != NULL) {
		iRowCnt++;

        	if (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A)
                        cs_input_buf[strlen(cs_input_buf) - 1] = '\0';
		strcpy(cs_input_buf,TrimAllChar((const unsigned char*)cs_input_buf,strlen(cs_input_buf),PD_CHAR));

//DEBUGLOG((">>[%s]\n",cs_input_buf));

                iCount = 0;

                p = mystrtok(cs_input_buf,PD_MY_DELIMITOR);
                if (p == NULL)
                        return FAILURE;

//DEBUGLOG((">>xxx[%s]\n", p));

		strcpy(csList[iCount],TrimAllChar((const unsigned char*)p, strlen(p), '"'));

//DEBUGLOG((">>yyy[%s]\n", csList[iCount]));

                iCount++;

                while ( (p = mystrtok(NULL,PD_MY_DELIMITOR)) != NULL) {
			strcpy(csList[iCount],TrimAllChar((const unsigned char*)p, strlen(p), PD_MY_TOKEN));
                        iCount++;
                }

DEBUGLOG((">>>>>>>>>>>>>>> File Line[%d] <<<<<<<<<<<<<<< \n",iRowCnt));

		iRet=process_txn(csList, hContext, hRequest, hResponse);

		if (iRet == FAILURE) {
			break;
		}
        }


	return iRet;
}

int process_txn(char csInList[][IMPORT_FIELD_LEN], hash_t *hContext, hash_t *hRequest, hash_t *hResponse)
{
	int iRet = SUCCESS;

DEBUGLOG(("MERCHANT_ACCOUNT_NMB=[%s]\n",csInList[IDX_PAR_MERCHANT_ACCOUNT_NMB]));
DEBUGLOG(("USERNAME[%s]\n",csInList[IDX_PAR_USERNAME]));
DEBUGLOG(("COMPANY_NAME=[%s]\n",csInList[IDX_PAR_COMPANY_NAME]));
DEBUGLOG(("PAYOUT=[%s]\n", csInList[IDX_PAR_PAYOUT_ENABLE]));

	int		iTmpRet = PD_OK;

	recordset_t 	*rRecordSet;
	hash_t		*hRec;

	char		*csTmp;
	
	int		iGenClient = PD_TRUE;
	char		*csClientID = strdup("");	

	int		iGenMerch = PD_TRUE;
	char		*csMID = strdup("");
	int		iVNCMerchType;

	hash_t          *hClient;

	int 		iIntError;
	hash_t          *hMerchProfile;

	char 		csClientPrefix[PD_CLIENT_ID_LEN + 1];
	int		iPayoutEnable;
	char		*csClientGroup;




        hClient = (hash_t *)malloc(sizeof(hash_t));
        hash_init(hClient, 0);
	
        hMerchProfile = (hash_t *)malloc(sizeof(hash_t));
        hash_init(hMerchProfile, 0);


	// ******************** Client ************************ //

	// Chk exists in par_client_map
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet, 0);


DEBUGLOG(("DBParClientMap.GetClientGroup [%d]\n", strlen(csInList[IDX_PAR_MERCHANT_ACCOUNT_NMB])));

DEBUGLOG(("DBParClientMap.GetClientGroup\n"));
	DBObjPtr = CreateObj(DBPtr, "DBParClientMap","GetClientGroup");
	iTmpRet = (unsigned long)(*DBObjPtr)(csInList[IDX_PAR_MERCHANT_ACCOUNT_NMB], csInList[IDX_PAR_USERNAME], rRecordSet);

	if (iTmpRet != PD_OK) {
DEBUGLOG(("FAIL on DBParClientMap.GetClientGroup\n"));
		iRet = FAILURE;
	}

	if (iRet == SUCCESS) {
DEBUGLOG(("Fetch ParClientMap Record\n"));
		hRec = RecordSet_GetFirst(rRecordSet);
		while (hRec) {
			if (GetField_CString(hRec, "client_group", &csTmp)) {
DEBUGLOG(("Found ParClientMap: client_group = [%s]\n", csTmp));
				PutField_CString(hClient, "client_group", csTmp);
			}

			if (GetField_CString(hRec, "client_name", &csTmp)) {
DEBUGLOG(("Found ParClientMap: client_name = [%s]\n", csTmp));
				PutField_CString(hClient, "client_name", csTmp);
			}

			if (GetField_CString(hRec, "prefer_client_id", &csTmp)) {
DEBUGLOG(("Found ParClientMap: prefer_client_id = [%s]\n", csTmp));
				PutField_CString(hClient, "prefer_client_id", csTmp);
			}

			if (GetField_CString(hRec, "prefer_mid", &csTmp)) {
DEBUGLOG(("Found ParClientMap: prefer_mid = [%s]\n", csTmp));
				PutField_CString(hClient, "prefer_mid", csTmp);
			}

			if (GetField_CString(hRec, "mid_name", &csTmp)) {
DEBUGLOG(("Found ParClientMap: mid_name = [%s]\n", csTmp));
				PutField_CString(hClient, "mid_name", csTmp);
			}

			if (GetField_CString(hRec, "client_id", &csTmp)) {
DEBUGLOG(("Found ParClientMap: client_id = [%s]\n", csTmp));
				PutField_CString(hClient, "client_id", csTmp);
			}

			hRec = RecordSet_GetNext(rRecordSet);
		}
	}
	RecordSet_Destroy(rRecordSet);


	if (iRet == SUCCESS) {
		if (GetField_CString(hClient, "client_id", &csTmp)) {
DEBUGLOG(("Client [%s] is already exists, no need to gen!\n", csTmp));
			iGenClient = PD_FALSE;
		}

		if (iGenClient == PD_TRUE) {

			rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
			recordset_init(rRecordSet, 0);

			GetField_CString(hClient, "client_group", &csClientGroup);

			DBObjPtr = CreateObj(DBPtr, "DBParClients","GetClientIDByClientGroup");
			iTmpRet = (unsigned long)(*DBObjPtr)(csClientGroup, rRecordSet);

			if (iTmpRet == PD_OK) {
				iGenClient = PD_FALSE;

				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if (GetField_CString(hRec, "client_id", &csClientID)) {
						PutField_CString(hClient, "client_id", csClientID);
					}
					hRec = RecordSet_GetNext(rRecordSet);
				}
			} else {
				//Chk any prefer Clinet ID
				if (GetField_CString(hClient, "prefer_client_id", &csTmp)) {
					PutField_CString(hClient, "client_id", csTmp);
				}
				else {
					// Gen a new Client ID 
DEBUGLOG(("DBParClients.Gen a New Client ID!\n"));

					memset(csClientPrefix, 0, sizeof(csClientPrefix));
					sprintf(csClientPrefix, "%s%c", PD_PAR_CLI_PREFIX, PD_TYPE_MERCHANT);

					DBObjPtr = CreateObj(DBPtr, "DBParClients","GenClientID");
					iTmpRet = (unsigned long)(*DBObjPtr)(csClientPrefix, PD_TYPE_MERCHANT, csClientID);

					if (iTmpRet != PD_OK) {
						iRet = FAILURE;
					} else {
DEBUGLOG(("DBParClients.GetClientID Gen New ClientID [%s]\n", csClientID));
						PutField_CString(hClient, "client_id", csClientID);
					}
				}
				RecordSet_Destroy(rRecordSet);

			}
		}
	}

	// ******************** MID ************************ //
	if (iRet == SUCCESS) {
DEBUGLOG(("DBParMerchProfile.GetMerchant\n"));
		DBObjPtr = CreateObj(DBPtr,"DBParMerchProfile","GetMerchant");

		iTmpRet = (unsigned long)(*DBObjPtr)(csInList[IDX_PAR_MERCHANT_ACCOUNT_NMB], rRecordSet);

		if (iTmpRet != PD_OK && iTmpRet != SQL_NOT_FOUND) {
DEBUGLOG(("FAIL on DBParMerchProfile.GetMerchant\n"));
			iRet = FAILURE;
		}

		if (iRet == SUCCESS) {
			if (iTmpRet == SQL_NOT_FOUND) {
DEBUGLOG(("DBParMerchProfile.GetMerchant No Record FOUND!\n"));
			}
			else {
DEBUGLOG(("Merchant is already exists, no need to gen!\n"));
				iGenMerch = PD_FALSE;
			}

			if (iGenMerch == PD_TRUE) {

				// mid
				if (GetField_CString(hClient, "prefer_mid", &csTmp)) {
					PutField_CString(hRequest, "newmid", csTmp);
				} else {
					// Gen a new MID
DEBUGLOG(("DBMerchDetail.GenMerchantId\n"));
					DBObjPtr = CreateObj(DBPtr,"DBMerchDetail","GenMerchantId");
					iTmpRet = (unsigned long)(*DBObjPtr)(csMID);

					if (iTmpRet != PD_OK) {
						iRet = FAILURE;
					} else {
DEBUGLOG(("DBMerchDetail.GenMerchantId [%s]\n", csMID));
						PutField_CString(hRequest, "newmid", csMID);
					}
				}

				// action
				PutField_CString(hRequest, "action", PD_PAR_ACTION_ADD);

				// name
				if (GetField_CString(hClient, "mid_name", &csTmp)) {
DEBUGLOG(("mid_name = [%s]\n", csTmp));
					PutField_CString(hRequest, "name", csTmp);
				}
				else {
DEBUGLOG(("MID Name not defined!\n"));
					iRet = FAILURE;
				}

				// fee_rate
				PutField_CString(hRequest, "fee_rate", "0");

				// business_type
				if (!strcmp(csInList[IDX_PAR_MERCHANT_TYPE_ID], "")) {
DEBUGLOG(("VNC_MerchType_ID IS NULL"));
					iRet = FAILURE;
				}

				iVNCMerchType = atoi(csInList[IDX_PAR_MERCHANT_TYPE_ID]);
DEBUGLOG(("VNC_MerchType_ID = [%d]\n", iVNCMerchType));

				if (iVNCMerchType == PD_PAR_MERCHANT_TYPE_NORMAL || iVNCMerchType == PD_PAR_MERCHANT_TYPE_NEW_GAME) {
					PutField_CString(hRequest, "type", PD_MERCH_TYPE_GAME);
				}	
				else if (iVNCMerchType == PD_PAR_MERCHANT_TYPE_NON_GAME) {
					PutField_CString(hRequest, "type", PD_MERCH_TYPE_NONGAME);
				}
				else if (iVNCMerchType == PD_PAR_MERCHANT_TYPE_OFFLINE) {
DEBUGLOG(("VNC_MerchType_ID Offline Ignore\n"));
					iGenMerch = PD_FALSE;
				}
				else {
DEBUGLOG(("VNC_MerchType_ID = [%d] Invalid \n"));
					iRet = FAILURE;
				}

				//client_id			
				GetField_CString(hClient, "client_id", &csTmp);
DEBUGLOG(("Client_ID = [%s]\n", csTmp));
				PutField_CString(hRequest, "client_id", csTmp);
			
				// effect_date	
				if (GetField_CString(hContext, "PHDATE", &csTmp)) {
					PutField_CString(hRequest, "effect_date", csTmp);
				} else {
DEBUGLOG(("PHDATE not found for effect_date\n"));
					iRet = FAILURE;
				}

				PutField_CString(hRequest, "key_type", PD_PTK_KEY_NAME);
				PutField_CString(hRequest, "add_user", PD_UPDATE_USER);
				
				sleep(1); // to prevent same key_value as time will affect the random_gen

			}
		}
	}


	// insert into DB
	if (iRet == SUCCESS) {
		// Clients
		if (iGenClient == PD_TRUE) {

DEBUGLOG(("Prepare insert Client!\n"));
			// insert into clients and ParClients
			PutField_CString(hClient, "party_type", PD_PAR_TYPE_MERCH);
			PutField_CString(hClient, "status", PD_ACC_OPEN);
			PutField_CString(hClient, "add_user", PD_UPDATE_USER);

DEBUGLOG(("Calling TxnMgtByUsCRC::Authorize\n"));
			TxnObjPtr = CreateObj(TxnPtr,"TxnMgtByUsCRC","Authorize");
			iRet = (unsigned long)(*TxnObjPtr)(hContext,hClient,hResponse);
	
			if (iRet == PD_OK) {
				if (GetField_Int(hContext, "internal_error", &iIntError)) {
DEBUGLOG(("Calling TxnMgtByUsCRC::Authorize Return internal_error [%d]\n", iIntError));
					iRet = FAILURE;
				}
			}

			GetField_CString(hClient, "client_name", &csTmp);
			PutField_CString(hClient, "company", csTmp);


			PutField_Char(hClient, "type", PD_TYPE_MERCHANT);
			PutField_CString(hClient, "create_user", PD_UPDATE_USER);
		
DEBUGLOG(("DBParClients.Add\n"));
			DBObjPtr = CreateObj(DBPtr,"DBParClients","Add");
			iTmpRet = (unsigned long)(*DBObjPtr)(hClient);
			if (iTmpRet != PD_OK) {
				iRet = FAILURE;
			}
		}
		else {
DEBUGLOG(("Client is already exists, no need to gen!\n"));
		}
	}

	if (iRet == SUCCESS) {
		// Merchant
		if (iGenMerch == PD_TRUE) {

DEBUGLOG(("Calling TxnMgtByUsMCR::Authorize\n"));
			TxnObjPtr = CreateObj(TxnPtr,"TxnMgtByUsMCR","Authorize");
			iRet = (unsigned long)(*TxnObjPtr)(hContext,hRequest,hResponse);
	
			if (iRet == PD_OK) {
				if (GetField_Int(hContext, "internal_error", &iIntError)) {
DEBUGLOG(("Calling TxnMgtByUsMCR::Authorize Return internal_error [%d]\n", iIntError));
					iRet = FAILURE;
				}
			}

			if (iRet == SUCCESS) {

				GetField_CString(hRequest, "type", &csTmp);
				if (!strcmp(csTmp, PD_MERCH_TYPE_NONGAME)) {
					PutField_CString(hMerchProfile, "service", PD_PAR_SERVICE_NBX);
DEBUGLOG(("Merch Profile Service = [%s]\n", PD_PAR_SERVICE_NBX));

				} 	
				else {
					// Chk if exists in EX2 email list
				
DEBUGLOG(("DBParDefMisc.ChkExist - EC2_TW_EMAIL\n"));

					DBObjPtr = CreateObj(DBPtr,"DBParDefMisc", "ChkExist");
					iTmpRet = (unsigned long)(*DBObjPtr)("EC2_TW_EMAIL", csInList[IDX_PAR_USERNAME]);

DEBUGLOG(("DBParDefMisc.ChkExist return [%d]\n", iTmpRet));

					if (iTmpRet == PD_NOT_FOUND) {
						PutField_CString(hMerchProfile, "service", PD_PAR_SERVICE_VNC);
DEBUGLOG(("Merch Profile Service = [%s]\n", PD_PAR_SERVICE_VNC));
					} else if (iTmpRet == PD_FOUND) {
					 	PutField_CString(hMerchProfile, "service", PD_PAR_SERVICE_EC2);
DEBUGLOG(("Merch Profile Service = [%s]\n", PD_PAR_SERVICE_EC2));
					} else {
						iRet = FAILURE;
					}
				}

				if (iRet == SUCCESS) {

					PutField_CString(hMerchProfile, "merch_account_nmb", csInList[IDX_PAR_MERCHANT_ACCOUNT_NMB]);
					PutField_CString(hMerchProfile, "company", csInList[IDX_PAR_COMPANY_NAME]);
					PutField_CString(hMerchProfile, "username", csInList[IDX_PAR_USERNAME]);

					PutField_CString(hMerchProfile, "api_merch_id", csInList[IDX_PAR_API_MERCHANT_ID]);
					PutField_CString(hMerchProfile, "ack_url", csInList[IDX_PAR_BACK_ACK_URL]);

					iPayoutEnable = atoi(csInList[IDX_PAR_PAYOUT_ENABLE]);
DEBUGLOG(("Payout Enable [%d] \n", iPayoutEnable));
					PutField_Int(hMerchProfile, "payout_enable", iPayoutEnable);


					GetField_CString(hRequest, "newmid", &csTmp);
					PutField_CString(hMerchProfile, "merchant_id", csTmp);

					PutField_CString(hMerchProfile, "create_user", PD_UPDATE_USER);
	
DEBUGLOG(("Call DBParMerchProfile.Add\n"));
	
					DBObjPtr = CreateObj(DBPtr,"DBParMerchProfile","Add");
					iRet = (unsigned long)(*DBObjPtr)(hMerchProfile);
				}
			}
		}
	}

	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);

	hash_destroy(hClient);
	FREE_ME(hClient);

	hash_destroy(hMerchProfile);
	FREE_ME(hMerchProfile);

	FREE_ME(csClientID);	
	FREE_ME(csMID);

DEBUGLOG(("par_merchant_detail iRet [%d]\n", iRet));
DEBUGLOG((">>>>>>>>>>>>>>> <<<<<<<<<<<<<<<\n"));

	return iRet;
}
