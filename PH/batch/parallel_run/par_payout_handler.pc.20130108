/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/07/04              LokMan Chow

*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sqlca.h>
#include <sqlcpr.h>
#include "common.h"
#include "internal.h"
#include "utilitys.h"
#include "dbutility.h"
#include "../batchcommon.h"
#include "par_payout_handler.h"
#include "pr_bo_funct.h"
#include "pr_par_funct.h"
#include "ObjPtr.h"
#include "dbutility.h"

char	cDebug;

OBJPTR(DB);

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

//int	GetPayoutDetailByVncRefNum(const char *csVNCRefNum,recordset_t* myRec);
//int	format_data(hash_t *hMyHash, hash_t *hTxnHeader, hash_t *hContext, hash_t *hRequest);
//int	handle_payout_balance(hash_t *hMyHash);
//int     PayoutAddTxnLog(const hash_t *hContext,
//                const hash_t* hRequest);
//int     UpdateTxnLog(const hash_t *hContext,
//                const hash_t* hRequest,
//                const hash_t* hResponse);
//int	add_txn_element(hash_t *hMyHash);  
int	UpdateMerchantUploadFileHeader(const hash_t *hRls);

int payout_handler(hash_t *hMyHash)
{
	int iRet = SUCCESS;
	int iTmpRet;

	hash_t          *hTxnHeader;

	recordset_t     *rRecordSet;
	hash_t          *hRec;

	char    *csTmp = NULL;
	double  dTmp = 0.0;
	double  dReqAmt = 0.0;
	double  dMerchantFee = 0.0;
	double  dMarkup = 0.0;
	int     iTmp = 0;

	char    *csMerchNmb = NULL;
	char    *csVNCRefNum = NULL;

	int     iRecExists = PD_FALSE;
	char    *csTxnSeq;

	hash_t  *hContext, *hRequest, *hResponse;

	hTxnHeader = (hash_t *)malloc(sizeof(hash_t));
	hash_init (hTxnHeader, 0);

	hContext = (hash_t *)malloc(sizeof(hash_t));
	hRequest = (hash_t *)malloc(sizeof(hRequest));
	hResponse = (hash_t *)malloc(sizeof(hResponse));

        hash_init (hContext, 0);
        hash_init (hRequest, 0);
        hash_init (hResponse, 0);

	// Chk PH MID
	if (GetField_CString(hMyHash, "txn_merch_nmb", &csMerchNmb)) {
DEBUGLOG(("payout_handler: txn_merch_nmb [%s]\n", csMerchNmb));
	}
	else {
DEBUGLOG(("payout_handler: txn_merch_nmb missing!\n"));
		iRet = FAILURE;
	}

	rRecordSet = (recordset_t *)malloc(sizeof(recordset_t));

	recordset_init(rRecordSet, 0);
	if (iRet == SUCCESS) {

		if (ParMerchProfile_GetMerchant(csMerchNmb, rRecordSet) != PD_OK) {
DEBUGLOG(("payout_handler: ParMerchProfile.GetMerchant FAILED!\n"));
		} else {
DEBUGLOG(("payout_handler: ParMerchProfile.GetMerchant SUCC!\n"));

			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {

				if (GetField_CString(hRec, "service", &csTmp)) {
DEBUGLOG(("payout_handler: ParMerchProfile.GetMerchant service [%s]!\n", csTmp));
					PutField_CString(hMyHash, "service", csTmp);
				}

				if (GetField_CString(hRec, "merchant_id", &csTmp)) {
DEBUGLOG(("payout_handler: ParMerchProfile.GetMerchant merchant_id [%s]!\n", csTmp));
					PutField_CString(hMyHash, "merchant_id", csTmp);
				}

				if (GetField_CString(hRec, "client_id", &csTmp)) {
DEBUGLOG(("payout_handler: ParMerchProfile.GetMerchant client_id [%s]!\n", csTmp));
					PutField_CString(hMyHash, "merchant_client_id", csTmp);
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}
	RecordSet_Destroy(rRecordSet);



	// Chk if exists in txn_header
	if (iRet == SUCCESS) {
		if (GetField_CString(hMyHash, "txn_nmb", &csVNCRefNum)) {
DEBUGLOG(("payout_handler: txn_nmb [%s]\n", csVNCRefNum));
		}
		else {
DEBUGLOG(("payout_handler: txn_nmb not found!\n"));
			iRet = FAILURE;
		}
	}

	if (iRet == SUCCESS) {
		iTmpRet = ParTxnData_ChkExist(csVNCRefNum);

		if (iTmpRet == PD_FOUND) {
			iRecExists = PD_TRUE;

		} else if (iTmpRet == PD_NOT_FOUND) {
			iRecExists = PD_FALSE;

		} else {
DEBUGLOG(("payout_handler: ParTxnData_ChkExist FAILED!\n"));
			iRet = FAILURE;
		}
	}

////////if txn exist before, do nothing and return iRet
////////else add new txn

	if(iRet == SUCCESS &&
	   iRecExists != PD_TRUE){
		csTxnSeq = strdup((char* )GetNextMgtTxnSeq());
		PutField_CString(hMyHash,"txn_seq",csTxnSeq);
DEBUGLOG(("payout_handler: Generate (MGT) Txn Seq [%s]\n", csTxnSeq));

		PutField_CString(hTxnHeader, "txn_id", csTxnSeq);

		PutField_CString(hMyHash, "channel_code", "MGT");
		PutField_CString(hMyHash, "process_type", "0000");
		PutField_CString(hMyHash, "process_code", "000000");
		PutField_CString(hMyHash, "vnc_ref_num", csVNCRefNum);
		PutField_Int(hMyHash, "internal_code", 0);
		PutField_CString(hMyHash, "response_code", "0");

		iRet = format_data(hMyHash, hTxnHeader, hContext, hRequest);

		if (iRet == SUCCESS) {
			if (PayoutAddTxnLog(hContext, hRequest) == PD_OK) {
DEBUGLOG(("payout_handler:PayoutAddTxnLog  SUCC!\n"));

				//DBObjPtr = CreateObj(DBPtr,"DBParTxnData","UpdateHeaderVNCRef");
				if (UpdateHeaderVNCRef(hContext) == PD_OK) {
DEBUGLOG(("payout_handler:Deposit init record updated vnc_ref_num succ!\n"));
				}
				else {
DEBUGLOG(("payout_handler:Deposit init record updated vnc_ref_num fail!\n"));
					iRet = FAILURE;
				}

			}
			else {
DEBUGLOG(("payout_handler:PayoutAddTxnLog FAIL!\n"));
				iRet = FAILURE;
			}
		}

//////check merchant_upload_file_detail
		if(iRet == SUCCESS){
			recordset_init(rRecordSet, 0);
			if(GetPayoutDetailByVncRefNum(csVNCRefNum,rRecordSet)==PD_OK){
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if(GetField_CString(hRec,"batch_id",&csTmp)){
						PutField_CString(hMyHash, "batch_id", csTmp);
DEBUGLOG(("GetPayoutDetailByVncRefNum batch_id = [%s]\n",csTmp));
					}
					if(GetField_Int(hRec,"seq_num",&iTmp)){
DEBUGLOG(("GetPayoutDetailByVncRefNum seq_num = [%d]\n",iTmp));
					}
					if(GetField_CString(hRec,"country",&csTmp)){
						PutField_CString(hMyHash, "country", csTmp);
DEBUGLOG(("GetPayoutDetailByVncRefNum country = [%s]\n",csTmp));
					}
					if(GetField_CString(hRec,"payout_ccy",&csTmp)){
						PutField_CString(hContext, "net_ccy", csTmp);
DEBUGLOG(("GetPayoutDetailByVncRefNum payout_ccy = [%s]\n",csTmp));
					}
					if(GetField_CString(hRec,"request_ccy",&csTmp)){
						PutField_CString(hMyHash, "ccy", csTmp);
DEBUGLOG(("GetPayoutDetailByVncRefNum request_ccy = [%s]\n",csTmp));
					}
					if(GetField_Double(hRec,"request_amount",&dTmp)){
DEBUGLOG(("GetPayoutDetailByVncRefNum request_amount = [%lf]\n",dTmp));

						dReqAmt += dTmp;
						PutField_Double(hMyHash,"amount",dReqAmt);
DEBUGLOG(("GetPayoutDetailByVncRefNum total_request_amount = [%lf]\n",dReqAmt));
					}
					if(GetField_CString(hRec,"merchant_fee_ccy",&csTmp)){
DEBUGLOG(("GetPayoutDetailByVncRefNum merchant_fee_ccy = [%s]\n",csTmp));
					}
					if(GetField_Double(hRec,"merchant_fee",&dTmp)){
DEBUGLOG(("GetPayoutDetailByVncRefNum merchant_fee = [%lf]\n",dTmp));

						dMerchantFee += dTmp;
						PutField_Double(hMyHash,"fee",dMerchantFee);
DEBUGLOG(("GetPayoutDetailByVncRefNum total_merchant_fee = [%lf]\n",dMerchantFee));
					}
	
					if(GetField_CString(hRec,"markup_ccy",&csTmp)){
						PutField_CString(hMyHash, "markup_ccy", csTmp);
DEBUGLOG(("GetPayoutDetailByVncRefNum markup_ccy = [%s]\n",csTmp));
					}
					if(GetField_Double(hRec,"markup_amt",&dTmp)){
DEBUGLOG(("GetPayoutDetailByVncRefNum markup_amt = [%lf]\n",dTmp));

						dMarkup += dTmp;
						PutField_Double(hMyHash,"markup_amt",dMarkup);
DEBUGLOG(("GetPayoutDetailByVncRefNum total_markup_amt = [%lf]\n",dMarkup));
					}
	
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
			else{
DEBUGLOG(("payout_handler:GetPayoutDetailByVncRefNum FAIL!\n"));
				iRet = FAILURE;
			}

			RecordSet_Destroy(rRecordSet);
		}

		//////handle balance
		if (iRet == SUCCESS) {
			PutField_Char(hMyHash,"response_mode",PD_ACCEPT);
			iRet = handle_payout_balance(hMyHash);
		}

		if (iRet == SUCCESS)
			PutField_Int(hMyHash, "approved", PD_TRUE);
			iRet = format_data(hMyHash, hTxnHeader, hContext, hRequest);

		/////txn element
		if (iRet == SUCCESS) {
			PutField_Int(hMyHash, "payout_bal_transfer_flag", PD_TRUE);
			PutField_Int(hMyHash, "payout_void_flag", PD_FALSE);

			iRet = add_txn_element(hMyHash);
		}

		/////update txn_seq to MerchantUploadFileHeader
		if (iRet == SUCCESS) {
			iRet = UpdateMerchantUploadFileHeader(hMyHash);
		}

		if (iRet == SUCCESS) {
			PutField_Char(hContext,"status",PD_COMPLETE);
			PutField_Char(hContext,"ar_ind",PD_ACCEPT);
			PutField_CString(hContext,"sub_status",PD_APPROVED_FOR_GENERATED);

			if (UpdateTxnLog(hContext, hRequest, hResponse) == PD_OK) {
DEBUGLOG(("payout_handler:UpdateTxnLog SUCC\n"));
			} else {
DEBUGLOG(("payout_handler:UpdateTxnLog FAIL\n"));
				iRet = FAILURE;
			}
		}

		if (iRet == SUCCESS) {
			//DBObjPtr = CreateObj(DBPtr, "DBParTxnData", "UpdateApprovalTimestamp");
			iRet = UpdateApprovalTimestamp(hContext);
		}

		FREE_ME(csTxnSeq);

	}
	else{
		//////do nothing
	}

	if (iRet == SUCCESS) {
DEBUGLOG(("payout_handler:UpdateProcessResult\n"));
		if(iRecExists == PD_TRUE)
			iRet = UpdateProcessResult(hMyHash, "SKIP");
		else
			iRet = UpdateProcessResult(hMyHash, "COMPLETE");
	}

	hash_destroy(hTxnHeader);
        FREE_ME(hTxnHeader);

        hash_destroy(hContext);
        hash_destroy(hRequest);
        hash_destroy(hResponse);

        FREE_ME(hContext);
        FREE_ME(hRequest);
        FREE_ME(hResponse);

        FREE_ME(rRecordSet);

DEBUGLOG(("payout_handler: iRet = [%d]\n",iRet));
	return iRet;
}


int UpdateMerchantUploadFileHeader(const hash_t *hRls)
{
	int	iRet = SUCCESS;
	char*   csBuf;
        char*   csBatchId;

        EXEC SQL WHENEVER SQLERROR GOTO updatehd_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                varchar         hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateMerchantUploadFileHeader: Begin\n"));
        csBuf = (char*) malloc (128);
        strcpy((char*)hv_dynstmt.arr,"update merchant_upload_file_header set uh_update_timestamp = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        if(GetField_CString(hRls,"batch_id",&csBatchId)){
DEBUGLOG(("UpdateMerchantUploadFileHeader:batch_id = [%s]\n",csBatchId));
        }
        else{
                FREE_ME(csBuf);
DEBUGLOG(("UpdateMerchantUploadFileHeader batch_id not found\n"));
                return INT_ERR;
        }

	if(GetField_CString(hRls,"txn_seq",&csBuf)){
DEBUGLOG(("UpdateMerchantUploadFileHeader:txn_id = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",uh_txn_id = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }


	strcat((char*)hv_dynstmt.arr, " WHERE uh_batch_id = ");
        strcat((char*)hv_dynstmt.arr, csBatchId);
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));


        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

        FREE_ME(csBuf);

DEBUGLOG(("UpdateMerchantUploadFileHeader Normal Exit\n"));
        return iRet;

updatehd_error:
DEBUGLOG(("updatehd_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("par_payout_handler_UpdateMerchantUploadFileHeader: SP_INTERNAL_ERR\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return FAILURE;
}
