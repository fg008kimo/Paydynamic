/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/12/04              Virginia Yun

*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sqlca.h>
#include <sqlcpr.h>
#include "common.h"
#include "internal.h"
#include "utilitys.h"
#include "dbutility.h"
#include "../batchcommon.h"
#include "pr_par_funct_2.h"
#include "pr_par_funct.h"
#include "pr_bo_funct.h"
#include "ObjPtr.h"

char	cDebug;
#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

OBJPTR(DB);


int     AssignTxnRecordDetail(hash_t *hMyHash) 
{
	int		iRet = SUCCESS;

	int		iTmpRet =PD_NOT_FOUND;

	char		*csMerchNmb = NULL;
	char		*csVNCRefNum = NULL;
	char    	csCountry [PD_COUNTRY_LEN + 1];
	int		iRecExists = PD_FALSE;
	char		*csService = NULL;

	char		*csTmp;
	char		cTmp;

	recordset_t     *rRecordSet;
	hash_t		*hRec;

	hash_t		*hTxn;

DEBUGLOG(("pr_par_funct_2::AsssignTxnRecordDetal: START!\n"));

	rRecordSet = (recordset_t *)malloc(sizeof(recordset_t));
	hTxn = (hash_t *)malloc(sizeof(hash_t));


	if (GetField_CString(hMyHash, "txn_merch_nmb", &csMerchNmb)) {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail:txn_merch_nmb [%s]\n", csMerchNmb));
	}
	else {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail:txn_merch_nmb missing\n"));
		iRet = FAILURE;
	}

	// Chk PH MID
	recordset_init(rRecordSet, 0);
	if (iRet == SUCCESS) {
		if (ParMerchProfile_GetMerchant(csMerchNmb, rRecordSet) != PD_OK) {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail:call ParMerchProfile_GetMerchant FAILED!\n"));

                } else {

			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
                                if (GetField_CString(hRec, "service", &csTmp)) {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail: service [%s]!\n", csTmp));
					PutField_CString(hMyHash, "service", csTmp);
				}

                                if (GetField_CString(hRec, "merchant_id", &csTmp)) {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail: merchant_id [%s]!\n", csTmp));
					PutField_CString(hMyHash, "merchant_id", csTmp);
				}

				if (GetField_CString(hRec, "client_id", &csTmp)) {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail: client_id [%s]!\n", csTmp));
					PutField_CString(hMyHash, "merchant_client_id", csTmp);
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
                }
	}
	RecordSet_Destroy(rRecordSet);

	// Country
	if (iRet == SUCCESS) {
		if (GetField_CString(hMyHash, "service", &csService)) {
			csCountry[0] = '\0';

			if (Service_FindCountryByService((const unsigned char*) csService, csCountry) != FOUND) {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail:Call Service_FindCountryByService FAILED!\n"));
				iRet = FAILURE;
			} else {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail: country [%s]!\n", csCountry));
                                PutField_CString(hMyHash, "country", csCountry);
                        }
		}
	}

	
	// Payment method
	recordset_init(rRecordSet, 0);
	if (iRet == SUCCESS) {

		if (ServicePayMethod_FindPayMethod(csService, rRecordSet) != PD_OK) {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail:Call ServicePayMethod_FindPayMethod FAILED!\n")); 
		} else {
			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {
				if (GetField_CString(hRec, "pay_method", &csTmp)) {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail: pay_method [%s]!\n", csTmp)); 
					PutField_CString(hMyHash, "pay_method", csTmp);
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}
	RecordSet_Destroy(rRecordSet);

	
	// Chk if exists in txn_header
	if (iRet == SUCCESS) {
		if (GetField_CString(hMyHash, "txn_nmb", &csVNCRefNum)) {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail: txn_nmb [%s]\n", csVNCRefNum));
		}
		else {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail: txn_nmb not found!\n"));
			iRet = FAILURE;
		}	
	}

	if (iRet == SUCCESS) {

		iTmpRet = ParTxnData_ChkExist(csVNCRefNum);

		if (iTmpRet == PD_FOUND) {
			iRecExists = PD_TRUE;

DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail: call ParTxnData_ChkExist (record_exists)!\n"));
                        PutField_Int(hMyHash, "record_exists", PD_TRUE);

		} else if (iTmpRet == PD_NOT_FOUND) {
			iRecExists = PD_FALSE;

DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail:call ParTxnData_ChkExist (record not exists)!\n"));

                        PutField_Int(hMyHash, "record_exists", PD_FALSE);

                } else {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail:ParTxnData_ChkExist FAILED!\n")); 
                        iRet = FAILURE;
                }

	}

	if (iRet == SUCCESS) {
		hash_init(hTxn, 0);
		
		GetField_Int(hMyHash, "record_exists", &iRecExists);
		if (iRecExists == PD_TRUE) {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail: Call GetOrgTxnID!\n")); 
			iRet = GetOrgTxnID(hMyHash, hTxn);

			if (iRet == SUCCESS) {

				if (GetField_CString(hTxn, "txn_id", &csTmp)) {
DEBUGLOG(("pr_par_funct_2::AssignTxnRecordDetail: org_txn_id [%s]!\n", csTmp)); 
					PutField_CString(hMyHash, "org_txn_id", csTmp);
				}

				if (GetField_Char(hTxn, "status", &cTmp)) {
					PutField_Char(hMyHash, "org_status", cTmp);	
				}

				if (GetField_Char(hTxn, "ar_ind", &cTmp)) {
					PutField_Char(hMyHash, "org_ar_ind", cTmp);	
				}

				if (GetField_CString(hTxn, "sub_status", &csTmp)) {
					PutField_CString(hMyHash, "org_sub_status", csTmp);	
				}

				if (GetField_CString(hTxn, "txn_code", &csTmp)) {
					PutField_CString(hMyHash, "org_txn_code", csTmp);	
				}
			}
		}

		hash_destroy(hTxn);
	}

	FREE_ME(hTxn);
	FREE_ME(rRecordSet);

DEBUGLOG(("pr_par_funct_2::AsssignTxnRecordDetal: Return [%d]\n", iRet));

	return iRet;

}

int     GetPSPRelatedInfo(hash_t *hMyHash)
{
        int     iRet = SUCCESS;

        char    *csPspTypeCode;
        char    *csTmp;
        char    *csGateID;

        if (GetField_CString(hMyHash, "psp_type_code", &csPspTypeCode)) {
DEBUGLOG(("pr_par_funct_2::GetPSPRelatedInfo: GetPSPRelatedInfo [%s]\n", csPspTypeCode));

                if (ParPspClientMap_GetPspID(hMyHash) == FOUND) {
                        if (GetField_CString(hMyHash, "psp_id", &csTmp)) {
DEBUGLOG(("pr_par_funct_2::GetPSPRelatedInfo: psp_id [%s]\n", csTmp));
                        }

                        if (GetField_CString(hMyHash, "psp_country", &csTmp)) {
//DEBUGLOG(("pr_par_funct_2::GetPSPRelatedInfo: psp_country [%s]\n", csTmp));
                        }

			if (GetField_CString(hMyHash, "psp_channel_code", &csTmp)) {
DEBUGLOG(("pr_par_funct_2::GetPSPRelatedInfo: psp_channel_code [%s]\n", csTmp));
			}
                }
                else {
DEBUGLOG(("pr_par_funct_2::GetPSPRelatedInfo: DBParPspClientMap.GetPspID FAIL!\n"));
                        iRet = FAILURE;
                }

        }

        // Get Bank Code
        if ((GetField_CString(hMyHash, "psp_type_code", &csPspTypeCode)) &&
            (GetField_CString(hMyHash, "gate_id", &csGateID))) {

                if (ParPspClientMap_GetBankCode(hMyHash) == FOUND) {
                        if (GetField_CString(hMyHash, "int_bank_code", &csTmp)) {
DEBUGLOG(("GetPSPRelatedInfo: DBParPspClientMap.GetBankCode [%s]\n", csTmp));
                        }
                }
        }

        return iRet;
}

int	prpar2_GetPOGTxnIDByVOATxnID(const char *csVOATxnID, hash_t *hTxn)
{
	int	iRet = SUCCESS;
	int	iCnt = 0;

	EXEC SQL WHENEVER SQLERROR GOTO get_pog_txn_id_by_voa;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_voa_txn_id [PD_TXN_SEQ_LEN];

                varchar		v_pog_txn_id[PD_TXN_SEQ_LEN + 1];
                short           ind_pog_txn_id = -1;

        EXEC SQL END DECLARE SECTION;

	hv_voa_txn_id.len = strlen(csVOATxnID);
	memcpy(hv_voa_txn_id.arr, csVOATxnID, hv_voa_txn_id.len);
DEBUGLOG(("prpar2_GetPOGTxnIDByVOATxnID voa_txn_id = [%s]\n", hv_voa_txn_id.arr));

	EXEC SQL DECLARE c_cursor_get_pog_txn_id CURSOR FOR
		select fd_txn_id
		from payout_generated_file_dt, merchant_upload_file_detail 
		where ud_aux_txn_id = :hv_voa_txn_id 
		and fd_upload_txn_id = ud_txn_id;

	EXEC SQL OPEN c_cursor_get_pog_txn_id;
	do {
		EXEC SQL FETCH c_cursor_get_pog_txn_id
		INTO
			:v_pog_txn_id:ind_pog_txn_id;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		iCnt++;

		if (ind_pog_txn_id >= 0) {
                        v_pog_txn_id.arr[v_pog_txn_id.len]='\0';
			PutField_CString(hTxn, "pog_txn_id", (const char*) v_pog_txn_id.arr);
		}
		break;
	} while (PD_TRUE);
	
	EXEC SQL CLOSE c_cursor_get_pog_txn_id;

	if (iCnt == 0) {
		iRet = PD_NOT_FOUND;
	}

DEBUGLOG(("prpar2_GetPOGTxnIDByVOATxnID Exit Ret [%d]\n", iRet));
	return iRet;

get_pog_txn_id_by_voa:
DEBUGLOG(("get_pog_txn_id_by_voa code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("prpar2_GetPOGTxnIDByVOATxnID : SP_ERR\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_get_pog_txn_id;
        return PD_ERR;
}

int	prpar2_GetReversedFileDetail(const hash_t *hTxn, recordset_t *myRec)
{

        hash_t  *myHash;
        char	*csTmp;
	int	iTmp;

        EXEC SQL WHENEVER SQLERROR GOTO getreversedfiledetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar         hv_batch_id[PD_TXN_SEQ_LEN];
		int		hv_seq_num;

                varchar         v_merchant_ref[PD_MERCHANT_REF_LEN+1];
                varchar         v_country[PD_COUNTRY_LEN+1];
                varchar         v_identity_id[PD_IDENTITY_ID_LEN+1];
                varchar         v_account_num[PD_AC_NO_LEN+1];
                varchar         v_account_name[PD_ACC_NAME_LEN+1];
                varchar         v_bank_name[PD_BANK_NAME_LEN+1];
                varchar         v_bank_code[PD_BANK_CODE_LEN+1];
                varchar         v_branch[PD_BANK_BRANCH_LEN+1];
                varchar         v_phone_num[PD_MOBILE_NO_LEN+1];
                varchar         v_province[PD_PROVINCE_LEN+1];
                varchar         v_city[PD_CITY_LEN+1];
                varchar         v_payout_ccy[PD_CCY_ID_LEN+1];
                varchar         v_request_ccy[PD_CCY_ID_LEN+1];
                double          v_payout_amount;
                double          v_request_amount;
                varchar         v_psp_id[PD_PSP_ID_LEN+1];
                varchar         v_merchant_id[PD_MERCHANT_ID_LEN+1];
                varchar         v_service_code[PD_SERVICE_CODE_LEN+1];

                short           ind_merchant_ref = -1;
                short           ind_country = -1;
                short           ind_identity_id = -1;
                short           ind_account_num = -1;
                short           ind_account_name = -1;
                short           ind_bank_name = -1;
                short           ind_bank_code = -1;
                short           ind_branch = -1;
                short           ind_phone_num = -1;
                short           ind_province = -1;
                short           ind_city = -1;
                short           ind_payout_ccy = -1;
                short           ind_request_ccy = -1;
                short           ind_payout_amount = -1;
                short           ind_request_amount = -1;
                short           ind_psp_id= -1;
                short           ind_merchant_id= -1;
                short           ind_service_code= -1;

	EXEC SQL END DECLARE SECTION;

	if (GetField_CString(hTxn, "batch_id", &csTmp)) {
		hv_batch_id.len = strlen(csTmp);
		memcpy(hv_batch_id.arr, csTmp, hv_batch_id.len);
DEBUGLOG(("prpar2_GetReversedFileDetail batch_id [%.*s]\n", hv_batch_id.len, hv_batch_id.arr));
	}

	if (GetField_Int(hTxn, "seq_num", &iTmp)) {
		hv_seq_num = iTmp;
DEBUGLOG(("prpar2_GetReversedFileDetail seq_num [%d]\n", hv_seq_num));
	}

	EXEC SQL DECLARE c_cursor_getreversedrec CURSOR FOR
		select  prd_merch_ref_nmb,     
		        prd_country,
			prd_id_nmb,
			prd_bank_account_nmb,
			prd_bank_account_name,
			prd_bank_name,
			prd_bank_code,
			prd_branch_name,
			prd_phone_nmb,  
			prd_bank_province,
			prd_bank_city,
			ud_payout_amount, 
			ud_request_amount,
                        prd_dest_ccy,
                        prd_amount_ccy,
                        prh_file_psp,
			uh_merchant_id,
			uh_service_code
		from  	merchant_upload_file_header,
			merchant_upload_file_detail,
			par_po_reversed_hd, 
			par_po_reversed_dt, 
			par_payout_upload
		where 	pu_batch_id = :hv_batch_id
		and 	prd_po_file_id = pu_file_id
		and 	prd_seq_nmb = :hv_seq_num
		and 	prd_psp_file_id = prh_file_id
		and	pu_batch_id = ud_batch_id
		and	prd_seq_nmb = ud_seq_num;
	
	EXEC SQL OPEN c_cursor_getreversedrec;
	do {
		EXEC SQL FETCH c_cursor_getreversedrec
		INTO    :v_merchant_ref:ind_merchant_ref,
			:v_country:ind_country,
			:v_identity_id:ind_identity_id,
			:v_account_num:ind_account_num,
			:v_account_name:ind_account_name,
			:v_bank_name:ind_bank_name,
			:v_bank_code:ind_bank_code,
			:v_branch:ind_branch,
			:v_phone_num:ind_phone_num,
			:v_province:ind_province,
			:v_city:ind_city,
			:v_payout_ccy:ind_payout_ccy,
			:v_request_ccy:ind_request_ccy,
			:v_payout_amount:ind_payout_amount,
			:v_request_amount:ind_request_amount,
			:v_psp_id:ind_psp_id,
			:v_merchant_id:ind_merchant_id,
			:v_service_code:ind_service_code;


		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/*merchant_ref*/
                if(ind_merchant_ref>=0){
                        v_merchant_ref.arr[v_merchant_ref.len]='\0';
                        PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail merchant_ref= [%s]\n",v_merchant_ref.arr));
                }

/*country*/
                if(ind_country>=0){
                        v_country.arr[v_country.len]='\0';
                        PutField_CString(myHash,"txn_country",(const char*)v_country.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail country= [%s]\n",v_country.arr));
                }

/*identity_id*/
                if(ind_identity_id>=0){
                        v_identity_id.arr[v_identity_id.len]='\0';
                        PutField_CString(myHash,"identity_id",(const char*)v_identity_id.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail identity_id= [%s]\n",v_identity_id.arr));
                }

/*account_num*/
                if(ind_account_num>=0){
                        v_account_num.arr[v_account_num.len]='\0';
                        PutField_CString(myHash,"account_num",(const char*)v_account_num.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail account_num= [%s]\n",v_account_num.arr));
                }

/*account_name*/
                if(ind_account_name>=0){
                        v_account_name.arr[v_account_name.len]='\0';
                        PutField_CString(myHash,"account_name",(const char*)v_account_name.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail account_name= [%s]\n",v_account_name.arr));
                }

/*bank_name*/
                if(ind_bank_name>=0){
                        v_bank_name.arr[v_bank_name.len]='\0';
                        PutField_CString(myHash,"bank_name",(const char*)v_bank_name.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail bank_name= [%s]\n",v_bank_name.arr));
		}

/*bank_code*/
                if(ind_bank_code>=0){
                        v_bank_code.arr[v_bank_code.len]='\0';
                        PutField_CString(myHash,"bank_code",(const char*)v_bank_code.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail bank_code= [%s]\n",v_bank_code.arr));
                }

/*branch*/
                if(ind_branch>=0){
                        v_branch.arr[v_branch.len]='\0';
                        PutField_CString(myHash,"branch",(const char*)v_branch.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail branch= [%s]\n",v_branch.arr));
                }

/*phone_num*/
                if(ind_phone_num>=0){
                        v_phone_num.arr[v_phone_num.len]='\0';
                        PutField_CString(myHash,"phone_num",(const char*)v_phone_num.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail phone_num= [%s]\n",v_phone_num.arr));
                }

/*province*/
                if(ind_province>=0){
                        v_province.arr[v_province.len]='\0';
                        PutField_CString(myHash,"province",(const char*)v_province.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail province= [%s]\n",v_province.arr));
                }

/*city*/
                if(ind_city>=0){
                        v_city.arr[v_city.len]='\0';
                        PutField_CString(myHash,"city",(const char*)v_city.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail city= [%s]\n",v_city.arr));
                }

/*payout_currency*/
                if(ind_payout_ccy>=0){
                        v_payout_ccy.arr[v_payout_ccy.len]='\0';
                        PutField_CString(myHash,"payout_ccy",(const char*)v_payout_ccy.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail payout_ccy= [%s]\n",v_payout_ccy.arr));
                }

/*request_currency*/
                if(ind_request_ccy>=0){
                        v_request_ccy.arr[v_request_ccy.len]='\0';
                        PutField_CString(myHash,"request_ccy",(const char*)v_request_ccy.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail request_ccy= [%s]\n",v_request_ccy.arr));
                }

/*payout_amount*/
                if(ind_payout_amount>=0){
                        PutField_Double(myHash,"payout_amount",v_payout_amount);
DEBUGLOG(("prpar2_GetReversedFileDetail payout_amount = [%lf]\n",v_payout_amount));
                }

/*request_amount*/
                if(ind_request_amount>=0){
                        PutField_Double(myHash,"request_amount",v_request_amount);
DEBUGLOG(("prpar2_GetReversedFileDetail request_amount = [%lf]\n",v_request_amount));
                }

/*psp_id*/
                if(ind_psp_id>=0){
                        v_psp_id.arr[v_psp_id.len]='\0';
                        PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail psp_id = [%s]\n",v_psp_id.arr));
                }

/*merchant_id*/
                if(ind_merchant_id>=0){
                        v_merchant_id.arr[v_merchant_id.len]='\0';
                        PutField_CString(myHash,"merchant_id",(const char*)v_merchant_id.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail merchant_id = [%s]\n",v_merchant_id.arr));
                }

/*service_code*/
                if(ind_service_code>=0){
                        v_service_code.arr[v_service_code.len]='\0';
                        PutField_CString(myHash,"service_code",(const char*)v_service_code.arr);
DEBUGLOG(("prpar2_GetReversedFileDetail service_code = [%s]\n",v_service_code.arr));
                }
                RecordSet_Add(myRec,myHash);

        }while(PD_TRUE);

	EXEC SQL CLOSE c_cursor_getreversedrec;

DEBUGLOG(("prpar_GetReversedFileDetail Normal Exist \n"));
	return PD_OK;

getreversedfiledetail_error:
DEBUGLOG(("getreversedfiledeatil_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("PayoutGeneratedFileDT_Get: SP_INTERNAL_ERR\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getreversedrec;
        return PD_ERR;

}


