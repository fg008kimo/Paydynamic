/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/07/06              Virginia Yun

*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sqlca.h>
#include <sqlcpr.h>
#include "common.h"
#include "internal.h"
#include "utilitys.h"
#include "dbutility.h"
#include "../batchcommon.h"
#include "pr_par_funct.h"
#include "pr_bo_funct.h"
#include "ObjPtr.h"

char	cDebug;
#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

OBJPTR(DB);

///////////////////////////////////////////////
//////////////////Service//////////////////////
int Service_FindCountryByService(const unsigned char* ServiceCode, char* TxnCountry)
{

        int iRet = NOT_FOUND;

        EXEC SQL WHENEVER SQLERROR GOTO find_country_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_service_code[PD_SERVICE_CODE_LEN];
                int     hv_disabled;

                varchar v_country[PD_COUNTRY_LEN+1];

                short   ind_country=-1;

        EXEC SQL END DECLARE SECTION;

        hv_service_code.len = strlen((const char*)ServiceCode);
        memcpy(hv_service_code.arr,ServiceCode,hv_service_code.len);
DEBUGLOG(("FindCountryByService: ServiceCode = [%.*s]\n",hv_service_code.len,hv_service_code.arr));

        hv_disabled=0;

        EXEC SQL DECLARE c_cursor_find_country CURSOR FOR
                select sc_txn_country
                 from def_service_code
                where sc_code = :hv_service_code;

        EXEC SQL OPEN c_cursor_find_country;
        do{
                EXEC SQL FETCH c_cursor_find_country
                INTO
                        :v_country:ind_country;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                if(ind_country>=0){
                        v_country.arr[v_country.len]='\0';
                        strcpy(TxnCountry, (const char*)v_country.arr);
DEBUGLOG(("FindCountryByService: country = [%s]\n",TxnCountry));

                        iRet = FOUND;
                }

        }while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_find_country;

DEBUGLOG(("FindCountryByService iRet = [%d]\n",iRet));
        return iRet;

find_country_error:
DEBUGLOG(("find_country_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_find_country;
    return NOT_FOUND;
}


/////////////////////////////////////////////////////
//////////////////ServicePayMethod///////////////////
int ServicePayMethod_FindPayMethod(const char* csServiceCode,
                  recordset_t* myRec)
{
        hash_t *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO find_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_service_code[PD_SERVICE_CODE_LEN];

                varchar v_pay_method[PD_PAY_METHOD_LEN+1];

                short   ind_pay_method = -1;
        EXEC SQL END DECLARE SECTION;

        hv_service_code.len = strlen(csServiceCode);
        memcpy(hv_service_code.arr,csServiceCode,hv_service_code.len);
DEBUGLOG(("FindPayMethod: service_code = [%.*s][%d]\n",hv_service_code.len,hv_service_code.arr,hv_service_code.len));

        EXEC SQL DECLARE c_cursor_find CURSOR FOR
                select  sp_pay_method
                from    service_pay_method
                Where   sp_service_code = :hv_service_code
                and     sp_disabled = '0';

        EXEC SQL OPEN c_cursor_find;
        do {
                EXEC SQL FETCH c_cursor_find
                INTO
                        :v_pay_method:ind_pay_method;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

                if (ind_pay_method >= 0) {
                        v_pay_method.arr[v_pay_method.len] ='\0';
                        PutField_CString(myHash,"pay_method",(const char*)v_pay_method.arr);
DEBUGLOG(("FindPayMethod: pay_method = [%s]\n",v_pay_method.arr));
                }
                RecordSet_Add(myRec,myHash);

        }while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_find;

DEBUGLOG(("FindPayMethod Normal Exit\n"));
        return PD_OK;

find_error:
DEBUGLOG(("find_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_find;
    return PD_ERR;
}



///////////////////////////////////////////////
//////////////////ParDefMisc///////////////////
int ParDefMisc_GetValue(const char *csCode,
      		          char *csValue)
{
        EXEC SQL WHENEVER SQLERROR GOTO find_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_code[PD_SP_CODE_LEN];

                varchar v_value[PD_SP_VALUE_LEN +1 ];
                short   ind_value = -1;

        EXEC SQL END DECLARE SECTION;

        hv_code.len = strlen((const char*)csCode);
        memcpy(hv_code.arr, csCode, hv_code.len);
DEBUGLOG(("GetValue: code = [%.*s]\n",hv_code.len,hv_code.arr));

        EXEC SQL SELECT pdm_value
                   INTO :v_value:ind_value
                FROM par_def_misc
                WHERE pdm_code = :hv_code;

        if (ind_value >= 0) {
//DEBUGLOG(("Get Value OK \n"));
                v_value.arr[v_value.len] = '\0';
                strcpy((char*)csValue,(const char*)v_value.arr);
DEBUGLOG(("value = [%s]\n",csValue));
                return FOUND;
        }
DEBUGLOG(("Value NOT FOUND\n"));
        return NOT_FOUND;

find_error:
DEBUGLOG(("find_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return NOT_FOUND;
}


////////////////////////////////////////////////
//////////////////ParCategory///////////////////
int ParCategory_GetCategory(const char* csSeqTypeName,
                hash_t * hRec)
{
        int iCnt = 0;

        EXEC SQL WHENEVER SQLERROR GOTO getcategory_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_sequence_type_name[PAR_PD_SEQUENCE_TYPE_NAME];

                varchar         v_category[PAR_PD_CATEGORY + 1];
                varchar         v_txn_code[PD_TXN_CODE_LEN + 1];
                varchar         v_reversal_txn_code[PD_TXN_CODE_LEN + 1];

                short           ind_category = -1;
                short           ind_txn_code = -1;
                short           ind_reversal_txn_code = -1;


        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("GetCategory: Begin [%s]\n", csSeqTypeName));

        hv_sequence_type_name.len = strlen(csSeqTypeName);
        memcpy(hv_sequence_type_name.arr, csSeqTypeName, hv_sequence_type_name.len);
//DEBUGLOG(("GetCategory: sequence_type_name = [%.*s]\n",hv_sequence_type_name.len,hv_sequence_type_name.arr));


        EXEC SQL DECLARE c_cursor_getcategory CURSOR FOR
                SELECT pc_category, pc_txn_code, pc_reversal_txn_code
                  FROM par_category
                 WHERE pc_sequence_type_name = :hv_sequence_type_name;

        EXEC SQL OPEN c_cursor_getcategory;
        do {
                EXEC SQL FETCH c_cursor_getcategory
                INTO :v_category:ind_category,
                     :v_txn_code:ind_txn_code,
                     :v_reversal_txn_code:ind_reversal_txn_code;


                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
                iCnt++;

// category
                if (ind_category >= 0) {
                        v_category.arr[v_category.len] = '\0';
                        PutField_CString(hRec, "category", (const char*)v_category.arr);
DEBUGLOG(("GetCategory category = [%s]\n",v_category.arr));
                }

// txn_code
                if (ind_txn_code >= 0) {
                        v_txn_code.arr[v_txn_code.len] = '\0';
                        PutField_CString(hRec, "txn_code", (const char*)v_txn_code.arr);
//DEBUGLOG(("GetCategory txn_code = [%s]\n",v_txn_code.arr));
                }

// reversal_txn_code
                if (ind_reversal_txn_code >= 0) {
                        v_reversal_txn_code.arr[v_reversal_txn_code.len] = '\0';
                        PutField_CString(hRec, "reversal_txn_code", (const char*)v_reversal_txn_code.arr);
//DEBUGLOG(("GetCategory reversal_txn_code = [%s]\n",v_reversal_txn_code.arr));
                }


        }
        while (PD_TRUE);
        EXEC SQL CLOSE c_cursor_getcategory;


        if (iCnt > 0) {
DEBUGLOG(("GetCategory Normal Exit\n"));
                return PD_OK;
        } else {
                return PD_ERR;
        }


getcategory_error:
DEBUGLOG(("getcategory_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getcategory;
        return PD_ERR;
}

////////////////////////////////////////////////////
//////////////////ParMerchProfile///////////////////
int ParMerchProfile_GetMerchant(const char* csMerchAccNmb,
                recordset_t* myRec)
{
        int iRet = PD_OK;

        hash_t *myHash;
        EXEC SQL WHENEVER SQLERROR GOTO getmerchant_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_merch_account_nmb[PAR_PD_MERCH_ACCOUNT_NMB_LEN];

                varchar         v_service[PD_SERVICE_CODE_LEN + 1];
                varchar         v_ph_merch_id[PD_MERCHANT_ID_LEN + 1];
                varchar         v_client_id[PD_CLIENT_ID_LEN + 1];

                short           ind_service = -1;
                short           ind_ph_merch_id = -1;
                short           ind_client_id = -1;

        EXEC SQL END DECLARE SECTION;

        hv_merch_account_nmb.len = strlen(csMerchAccNmb);
        memcpy(hv_merch_account_nmb.arr,csMerchAccNmb,hv_merch_account_nmb.len);
DEBUGLOG(("GetMerchant merch_account_nmb = [%.*s]\n",hv_merch_account_nmb.len,hv_merch_account_nmb.arr));

        EXEC SQL DECLARE c_cursor_getmerchant CURSOR FOR
                select  mn_service_code,
                        merchant_id,
                        client_id 
                  from merch_detail, par_def_merch_nmb_map
                 where mn_merchant_acct_nmb = :hv_merch_account_nmb
                   and mn_merchant_id = merchant_id;


        EXEC SQL OPEN c_cursor_getmerchant;
        do {
                EXEC SQL FETCH c_cursor_getmerchant
                INTO
                        :v_service:ind_service,
                        :v_ph_merch_id:ind_ph_merch_id,
                        :v_client_id:ind_client_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        iRet = SQL_NOT_FOUND;
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

// service
                if (ind_service >= 0) {
                        v_service.arr[v_service.len] = '\0';
                        PutField_CString(myHash,"service",(const char*)v_service.arr);
DEBUGLOG(("GetMerchant service = [%s]\n",v_service.arr));
                }

// merchant_id
                if (ind_ph_merch_id >= 0) {
                        v_ph_merch_id.arr[v_ph_merch_id.len] = '\0';
                        PutField_CString(myHash,"merchant_id",(const char*)v_ph_merch_id.arr);
DEBUGLOG(("GetMerchant ph_merch_id = [%s]\n",v_ph_merch_id.arr));
                }

// client_id
                if (ind_client_id >= 0) {
                        v_client_id.arr[v_client_id.len] = '\0';
                        PutField_CString(myHash,"client_id",(const char*)v_client_id.arr);
DEBUGLOG(("GetMerchant client_id = [%s]\n",v_client_id.arr));
                }

                RecordSet_Add(myRec,myHash);
                break; //**************** only one now
        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getmerchant;



DEBUGLOG(("GetMerchant Normal Exit\n"));
        if(iRet==0) return  PD_OK;
        else    return iRet;

getmerchant_error:
DEBUGLOG(("getmerchant_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getmerchant;
        return PD_ERR;
}


////////////////////////////////////////////////////
//////////////////ParTxnData////////////////////////
int     ParTxnData_ChkExist(const char *csVNCRefNum)
{
        int     iRet = PD_NOT_FOUND;

        EXEC SQL WHENEVER SQLERROR GOTO chkexist_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_vnc_ref_num[PD_TXN_SEQ_LEN];

                int             v_no_of_record;
                short           ind_no_of_record = -1;

        EXEC SQL END DECLARE SECTION;

        hv_vnc_ref_num.len = strlen(csVNCRefNum);
        memcpy(hv_vnc_ref_num.arr, csVNCRefNum, hv_vnc_ref_num.len);
DEBUGLOG(("ChkExist vnc_ref_num = [%.*s]\n",hv_vnc_ref_num.len,hv_vnc_ref_num.arr));


        EXEC SQL
                SELECT count(1)
                   INTO :v_no_of_record:ind_no_of_record
                   FROM txn_header
                  WHERE th_vnc_ref_num = :hv_vnc_ref_num
                    and rownum = 1;

        if (ind_no_of_record >= 0) {
                if (v_no_of_record > 0) {
DEBUGLOG(("ChkExist FOUND\n"));
                        iRet = PD_FOUND;
                }
        }

        if (iRet!= PD_FOUND) {
DEBUGLOG(("ChkExist NOT FOUND\n"));
        }

        return iRet;

chkexist_error:
DEBUGLOG(("ChkExist_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;

}


int UpdateProcessResult(hash_t *hMyHash, const char *csStatus)
{
        int     iRet = SUCCESS;
        int     iTmp;

        if (GetField_Int(hMyHash, "sort_txn_seq", &iTmp)) {
//DEBUGLOG(("UpdateProcessTxnResult sort_txn_seq [%d]\n", iTmp));
        }

//DEBUGLOG(("UpdateProcessTxnResult status [%s]\n", csStatus));
        PutField_CString(hMyHash, "proc_status", csStatus);

        if (UpdateTxnDataStatus(hMyHash) == PD_OK) {
DEBUGLOG(("UpdateProcessTxnResult : txn_data.seq [%d] status [%s]\n", iTmp, csStatus));
        }
        else {
                iRet = FAILURE;
        }

        return iRet;
}

int UpdateTxnDataStatus(const hash_t *hRls)
{
        char    *csTmp;
        char*   csBuf;


        int     iSortTxnSeq;

        EXEC SQL WHENEVER SQLERROR GOTO updatestatus_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        varchar         hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

//DEBUGLOG(("UpdateStatus: Begin\n"));
        csBuf = (char*) malloc (128);
        strcpy((char*)hv_dynstmt.arr,"update par_txn_data set ptd_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_Int(hRls,"sort_txn_seq",&iSortTxnSeq);
DEBUGLOG(("UpdateStatus:sort_txn_id = [%d]\n",iSortTxnSeq));

        if (GetField_CString(hRls, "proc_status", &csTmp)) {
DEBUGLOG(("UpdateStatus:proc_status= [%s]\n",csTmp));

                strcat((char*)hv_dynstmt.arr, ",ptd_proc_status = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        sprintf(csBuf, "%d", iSortTxnSeq);

        strcat((char *)hv_dynstmt.arr, " WHERE ptd_txn_seq = ");
        strcat((char *)hv_dynstmt.arr, csBuf);
        //strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

        FREE_ME(csBuf);
DEBUGLOG(("Update Status Normal Exit\n"));
        return PD_OK;

updatestatus_error:
DEBUGLOG(("updatestatus_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
        return PD_INTERNAL_ERR;
}

int UpdateApprovalTimestamp(const hash_t *hRls)
{
        //char    *csTmp;
        char*   csBuf;
        char*   csTxnId;

        EXEC SQL WHENEVER SQLERROR GOTO update_approvetime_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        varchar         hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("UpdateApprovalTimestamp: Begin\n"));
        csBuf = (char*) malloc (128);
        strcpy((char*)hv_dynstmt.arr,"update txn_header set th_update_timestamp  = sysdate, ");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"txn_seq",&csTxnId);
DEBUGLOG(("UpdateApprovalTimestamp:txn_id = [%s]\n",csTxnId));

        strcat((char *)hv_dynstmt.arr, "th_approval_timestamp = to_timestamp(th_approval_date || to_char(th_approval_timestamp, 'HH24MISSFF6') , 'YYYYMMDDHH24MISSFF')");
        hv_dynstmt.len=strlen((const char*) hv_dynstmt.arr);


        strcat((char *)hv_dynstmt.arr, " WHERE th_txn_id = '");
        strcat((char *)hv_dynstmt.arr, csTxnId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

        FREE_ME(csBuf);
// update txn sub status
//        AddTxnStatusLog(hRls);

DEBUGLOG(("Update Normal Exit\n"));
        return PD_OK;

update_approvetime_error:
DEBUGLOG(("update_approvetime_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_Update_approvetime: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
//        TxnAbort();
        return PD_INTERNAL_ERR;
}




int  GetOrgTxnID(hash_t * hMyHash, hash_t *hTxnHeader)
{
        int     iRet = SUCCESS;

        char    *csVNCRefNum;

        char    cTmp;
        char    *csTmp;

        if (GetField_CString(hMyHash, "txn_nmb", &csVNCRefNum)) {
DEBUGLOG(("GetOrgTxnID vnc_ref_num [%s]\n", csVNCRefNum));
        }

        if (GetTxnHeaderByVNCRefNum(csVNCRefNum, hTxnHeader) == PD_OK) {
                if (GetField_CString(hTxnHeader, "txn_id", &csTmp)) {
DEBUGLOG(("GetOrgTxnID: ParTxnData:GetTxnHeaderByVNCRefNum txn_id [%s]\n", csTmp));
                }

                if (GetField_Char(hTxnHeader, "status", &cTmp)) {
//DEBUGLOG(("GetOrgTxnID: ParTxnData:GetTxnHeaderByVNCRefNum status [%c]\n", cTmp));
                }

                if (GetField_Char(hTxnHeader, "ar_ind", &cTmp)) {
//DEBUGLOG(("GetOrgTxnID: ParTxnData:GetTxnHeaderByVNCRefNum ar_ind [%c]\n", cTmp));
                }

                if (GetField_CString(hTxnHeader, "sub_status", &csTmp)) {
//DEBUGLOG(("GetOrgTxnID: ParTxnData:GetTxnHeaderByVNCRefNum sub_status[%s]\n", csTmp));
                }

                if (GetField_CString(hTxnHeader, "txn_code", &csTmp)) {
//DEBUGLOG(("GetOrgTxnID: ParTxnData:GetTxnHeaderByVNCRefNum txn_code [%s]\n", csTmp));
                }
        }
        else {
DEBUGLOG(("GetOrgTxnID: : ParTxnData:GetTxnHeaderByVNCRefNum FAIL!\n"));
                iRet = FAILURE;
        }

        return iRet;
}

int GetTxnHeaderByVNCRefNum(const char*csVNCRefNum, hash_t *hRec)
{
        int     iRet = PD_OK;

        EXEC SQL WHENEVER SQLERROR GOTO getheader_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_vnc_ref_num[PD_TXN_SEQ_LEN];

                varchar v_txn_id[PD_TXN_SEQ_LEN + 1];
                char    v_status;
                char    v_ar_ind;
                varchar v_sub_status[PD_SUB_STATUS_LEN + 1];
                varchar v_txn_code[PD_TXN_CODE_LEN + 1];

                short   ind_txn_id = -1;
                short   ind_status = -1;
                short   ind_ar_ind = -1;
                short   ind_sub_status = -1;
                short   ind_txn_code = -1;

        EXEC SQL END DECLARE SECTION;

        hv_vnc_ref_num.len = strlen(csVNCRefNum);
        memcpy(hv_vnc_ref_num.arr, csVNCRefNum, hv_vnc_ref_num.len);
DEBUGLOG(("GetDepositTxnHeaderByVNCRefNum vnc_ref_num = [%.*s]\n",hv_vnc_ref_num.len,hv_vnc_ref_num.arr));

        EXEC SQL SELECT th_txn_id,
                        th_status,
                        th_ar_ind,
                        th_sub_status,
                        th_txn_code
                   INTO :v_txn_id:ind_txn_id,
                        :v_status:ind_status,
                        :v_ar_ind:ind_ar_ind,
                        :v_sub_status:ind_sub_status,
                        :v_txn_code:ind_txn_code
                   from (select th_txn_id,
                                th_status,
                                th_ar_ind,
                                th_sub_status,
                                th_txn_code
                         FROM txn_header
                         WHERE th_vnc_ref_num = :hv_vnc_ref_num
                         order by decode(th_txn_code, 'VDS', 1, 'VST', 1, 'VMT', 1, 'VTM', 1, decode(substr(th_txn_code, 1, 1), 'y', 1, 2))
                        )
                   where rownum = 1;

        if (SQLCODE == SQL_NOT_FOUND) {
DEBUGLOG(("GetDepositTxnHeaderByVNCRefNum SQL_NOT_FOUND!\n"));
                iRet = NOT_FOUND;
        }
        if (ind_txn_id >= 0) {
                iRet = PD_OK;

                v_txn_id.arr[v_txn_id.len] = '\0';
DEBUGLOG(("GetDepositTxnHeaderByVNCRefNum txn_id [%.*s]\n", v_txn_id.len, v_txn_id.arr));
                PutField_CString(hRec, "txn_id", (const char*)v_txn_id.arr);
        }

        if (ind_status >= 0) {
DEBUGLOG(("GetDepositTxnHeaderByVNCRefNum status [%c]\n", v_status));
                PutField_Char(hRec, "status", v_status);
        }

        if (ind_ar_ind >= 0) {
DEBUGLOG(("GetDepositTxnHeaderByVNCRefNum ar_ind [%.*s]\n", v_ar_ind));
                PutField_Char(hRec, "ar_ind", v_ar_ind);
        }

        if (ind_sub_status >= 0) {
                v_sub_status.arr[v_sub_status.len] = '\0';
DEBUGLOG(("GetDepositTxnHeaderByVNCRefNum sub_status [%.*s]\n", v_sub_status.len, v_sub_status.arr));
                PutField_CString(hRec, "sub_status", (const char*)v_sub_status.arr);
        }

        if (ind_txn_code >= 0) {
                v_txn_code.arr[v_txn_code.len] = '\0';
DEBUGLOG(("GetDepositTxnHeaderByVNCRefNum txn_code [%.*s]\n", v_txn_code.len, v_txn_code.arr));
                PutField_CString(hRec, "txn_code", (const char*)v_txn_code.arr);

        }

        return iRet;

getheader_error:
DEBUGLOG(("getheader_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    return NOT_FOUND;
}


int UpdateHeaderVNCRef(const hash_t *hRls)
{
        char    *csTmp;
        char*   csBuf;
        char*   csTxnId;

        EXEC SQL WHENEVER SQLERROR GOTO update_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        varchar         hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("Update: Begin\n"));
        csBuf = (char*) malloc (128);
        strcpy((char*)hv_dynstmt.arr,"update txn_header set th_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_CString(hRls,"txn_seq",&csTxnId);
DEBUGLOG(("Update:txn_id = [%s]\n",csTxnId));

        if (GetField_CString(hRls, "vnc_ref_num", &csTmp)) {
//DEBUGLOG(("Update:vnc_ref_num = [%s]\n",csTmp));
                strcat((char*)hv_dynstmt.arr, ",th_vnc_ref_num = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }
        strcat((char *)hv_dynstmt.arr, " WHERE th_txn_id = '");
        strcat((char *)hv_dynstmt.arr, csTxnId);
        strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

        FREE_ME(csBuf);

// update txn sub status
//        AddTxnStatusLog(hRls);

DEBUGLOG(("Update Normal Exit\n"));
        return PD_OK;

update_error:
DEBUGLOG(("update_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("Transaction_Update: SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("Update: SP_INTERNAL_ERR TxnAbort\n"));
        return PD_INTERNAL_ERR;
}








////////////////////////

int ParPspClientMap_GetPspID(hash_t *hRec)
{
        int iRet = NOT_FOUND;
        char    *csTmp;

        EXEC SQL WHENEVER SQLERROR GOTO get_psp_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar hv_psp_type_cd[PAR_PD_PSP_TYPE_CD];

                varchar v_psp_id [PD_PSP_ID_LEN + 1];
                varchar v_psp_country[PD_COUNTRY_LEN + 1];
		varchar v_psp_channel_code[PD_PSP_ID_LEN + 1];

                short   ind_psp_id = -1;
                short   ind_psp_country = -1; 
		short	ind_psp_channel_code = -1;

        EXEC SQL END DECLARE SECTION;

        if (GetField_CString(hRec, "psp_type_code", &csTmp)) {
                hv_psp_type_cd.len = strlen(csTmp);
                memcpy(hv_psp_type_cd.arr, csTmp, hv_psp_type_cd.len);
DEBUGLOG(("GetPspID: psp_type_code [%.*s]\n", hv_psp_type_cd.len, hv_psp_type_cd.arr));
        }


        EXEC SQL DECLARE c_cursor_get_pid CURSOR FOR
                select psp_detail.psp_id, psp_country.country, psp_channel_code
                  from psp_country, psp_detail, par_client_psp_map
                 where cp_psp_type_code = :hv_psp_type_cd
                   and cp_preset_ph_pid = psp_detail.psp_id
                   and psp_detail.psp_id = psp_country.psp_id;

        EXEC SQL OPEN c_cursor_get_pid;
        do {
                EXEc SQL FETCH c_cursor_get_pid
                INTO    :v_psp_id:ind_psp_id,
                        :v_psp_country:ind_psp_country,
			:v_psp_channel_code:ind_psp_channel_code;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                if (ind_psp_id >= 0) {
                        v_psp_id.arr[v_psp_id.len]='\0';
                        PutField_CString(hRec, "psp_id", (const char *)v_psp_id.arr);
DEBUGLOG(("GetPspID: psp_id= [%s]\n", v_psp_id.arr));

                        iRet = FOUND;
                }

                if (ind_psp_country >= 0) {
                        v_psp_country.arr[v_psp_country.len]='\0';
                        PutField_CString(hRec, "psp_country", (const char *)v_psp_country.arr);
//DEBUGLOG(("GetPspID: psp_country= [%s]\n", v_psp_country.arr));
                }

		if (ind_psp_channel_code >=0) {
			v_psp_channel_code.arr[v_psp_channel_code.len] = '\0';
                        PutField_CString(hRec, "psp_channel_code", (const char *)v_psp_channel_code.arr);

		}

        }while (PD_TRUE);

        EXEC SQL CLOSE c_cursor_get_pid;

DEBUGLOG(("GetPspID iRet = [%d]\n",iRet));
        return iRet;

get_psp_error:
DEBUGLOG(("get_psp_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_get_pid;
    return NOT_FOUND;

}

int ParPspClientMap_GetBankCode(hash_t *hRec)
{
        int iRet = NOT_FOUND;
        char    *csTmp;

        EXEC SQL WHENEVER SQLERROR GOTO get_bankcode_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                //varchar hv_psp_type_cd[PAR_PD_PSP_TYPE_CD];
                varchar hv_ext_bank_code[PD_EXT_BANK_CODE_LEN];

                varchar v_int_bank_code[PD_BANK_CODE_LEN + 1];
                short   ind_int_bank_code = -1;


        EXEC SQL END DECLARE SECTION;

        if (GetField_CString(hRec, "gate_id", &csTmp)) {
                hv_ext_bank_code.len = strlen(csTmp);
                memcpy(hv_ext_bank_code.arr, csTmp, hv_ext_bank_code.len);
DEBUGLOG(("GetBankCode: ext_bank_code [%.*s]\n", hv_ext_bank_code.len, hv_ext_bank_code.arr));
        }

        EXEC SQL DECLARE c_cursor_get_bank_code CURSOR FOR
                select bc_int_bank_code
                  from par_int_bank_code_map
                 where bc_bank_name = :hv_ext_bank_code;

        EXEC SQL OPEN c_cursor_get_bank_code;
        do {
                EXEc SQL FETCH c_cursor_get_bank_code
                INTO    :v_int_bank_code:ind_int_bank_code;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                if (ind_int_bank_code >= 0) {
                        v_int_bank_code.arr[v_int_bank_code.len]='\0';
                        PutField_CString(hRec, "int_bank_code", (const char *)v_int_bank_code.arr);
DEBUGLOG(("GetBankCode: int_bank_code = [%s]\n", v_int_bank_code.arr));

                        iRet = FOUND;
                }
        }while (PD_TRUE);

        EXEC SQL CLOSE c_cursor_get_bank_code;

DEBUGLOG(("GetBankCode iRet = [%d]\n",iRet));
        return iRet;

get_bankcode_error:
DEBUGLOG(("get_bankcode_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_get_bank_code;
    return NOT_FOUND;

}

int     GetAdjustmentTypeRec(const char cPartyType,
                                const char *csCode ,
                                recordset_t *myRec)
{
        int     iCnt = 0;
        hash_t *myHash;

        EXEC SQL WHENEVER SQLERROR GOTO getadjustmenttype_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                char            hv_party_type;
                varchar         hv_code[PD_ADJ_TYPE_CODE_LEN];
                /*int           hv_disabled;*/

                char            v_dc_ind;
                varchar         v_desc[PD_ADJ_TYPE_DESC_LEN + 1];
                int             v_disabled;

                short           ind_dc_ind = -1;
                short           ind_desc = -1;
                short           ind_disabled = -1;


        EXEC SQL END DECLARE SECTION;        

	hv_party_type = cPartyType;
DEBUGLOG(("GetAdjustmentTypeRec party_type = [%.c]\n", hv_party_type));

        hv_code.len = strlen(csCode);
        memcpy(hv_code.arr,csCode,hv_code.len);
DEBUGLOG(("GetAdjustmentTypeRec code = [%.*s]\n",hv_code.len,hv_code.arr));


        /*hv_disabled = 0;*/


        EXEC SQL DECLARE c_cursor_getadjtype CURSOR FOR
                select at_dc_ind,
                       at_desc,
                       at_disabled
                  from adjustment_type
                 where at_party_type = :hv_party_type
                   and at_code = :hv_code;
                   /*and at_disabled = :hv_disabled;*/

        EXEC SQL OPEN c_cursor_getadjtype;
        do {
                EXEC SQL FETCH c_cursor_getadjtype
                INTO    :v_dc_ind:ind_dc_ind,
                        :v_desc:ind_desc,
                        :v_disabled:ind_disabled;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }      


                iCnt++;

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/* dc_ind */
                if (ind_dc_ind >= 0) {
                        PutField_Char(myHash, "dc_ind", v_dc_ind);
DEBUGLOG(("GetAdjustmentTypeRec dc_ind = [%c]\n",v_dc_ind));
                }

/* desc */     
                if (ind_desc >= 0) {
                        v_desc.arr[v_desc.len] = '\0';
                        PutField_CString(myHash, "desc", (const char *)v_desc.arr);
DEBUGLOG(("GetAdjustmentTypeRec desc = [%s]\n",v_desc.arr));

                }

/* disabled */
                if (ind_disabled >= 0) {
                        PutField_Int(myHash, "disabled", v_disabled);
DEBUGLOG(("GetAdjustmentTypeRec disabled = [%d]\n", v_disabled));

                }


                RecordSet_Add(myRec, myHash);
        }
        while (PD_TRUE);
        EXEC SQL CLOSE c_cursor_getadjtype;

        if (iCnt > 0 ) {
DEBUGLOG(("GetAdjustmentTypeRec Normal Exit\n"));
                return  PD_OK;
        }
        else {
DEBUGLOG(("GetAdjustmentTypeRec Normal Exit, Not Found\n"));
                return PD_ERR;
        }

getadjustmenttype_error:
DEBUGLOG(("getadjustmenttype_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getadjtype;
        return PD_ERR;

}


////////// Payout /////////////////////
int     AddParPayoutUploadHD(const hash_t *hRls)
{
	char	*csTmp;

        EXEC SQL WHENEVER SQLERROR GOTO add_par_payout_upload_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_file_id[PD_TXN_SEQ_LEN];
		varchar         hv_batch_id[PD_TXN_SEQ_LEN];
		varchar		hv_create_user[PD_CREATE_USER_LEN];

		short		ind_file_id;
		short		ind_batch_id;
		short		ind_create_user;

		short		hv_return_value;
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("AddParPayoutUpload: Begin\n"));

/* batch_id */
        if(GetField_CString(hRls,"batch_id",&csTmp)){
                hv_batch_id.len = strlen(csTmp);
                memcpy(hv_batch_id.arr, csTmp, hv_batch_id.len);
                ind_batch_id= 0;
DEBUGLOG(("AddParPayoutUpload:batch_id= [%.*s]\n",hv_batch_id.len,hv_batch_id.arr));
        }

/* file_id */
	if (GetField_CString(hRls, "file_id", &csTmp)) {
                hv_file_id.len = strlen(csTmp);
                memcpy(hv_file_id.arr, csTmp, hv_file_id.len);
                ind_file_id= 0;
DEBUGLOG(("AddParPayoutUpload:file_id= [%.*s]\n",hv_file_id.len,hv_file_id.arr));
	}

/* create_user */
	if (GetField_CString(hRls, "create_user", &csTmp)) {
                hv_create_user.len = strlen(csTmp);
                memcpy(hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
DEBUGLOG(("AddParPayoutUpload: create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));
	}

	EXEC SQL EXECUTE
		BEGIN
			:hv_return_value := sp_par_payout_upload_insert(
						:hv_file_id:ind_file_id,
						:hv_batch_id:ind_batch_id,
						:hv_create_user:ind_create_user);
		END;
	END-EXEC;

DEBUGLOG(("AddParPayoutUpload:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("AddParPayoutUpload:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("AddParPayoutUpload : SP_OTHER_ERR \n");
DEBUGLOG(("AddParPayoutUpload: SP_OTHER_ERR \n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("AddParPayoutUpload : SP_ERR \n");
DEBUGLOG(("AddParPayoutUpload : SP_ERR \n"));
                return PD_ERR;
        }

add_par_payout_upload_error:
DEBUGLOG(("add_par_payout_upload_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("AddParPayoutUpload: SP_INTERNAL_ERR \n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;

}



int     PayoutUpload_Header_ChkExist(hash_t *hRls) {

	int     iRet = PD_NOT_FOUND;
	char	*csTmp;

        EXEC SQL WHENEVER SQLERROR GOTO payout_hd_chkexist_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

		varchar		hv_file_id[PD_TXN_SEQ_LEN];
		short		ind_file_id;

		varchar         v_batch_id[PD_TXN_SEQ_LEN + 1];
		short		ind_batch_id;


        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("PayoutUpload_Header_ChkExist BEGIN\n"));

/* file_id */
        if (GetField_CString(hRls, "file_id", &csTmp)) {
                hv_file_id.len = strlen(csTmp);
                memcpy(hv_file_id.arr, csTmp, hv_file_id.len);
                ind_file_id= 0;
DEBUGLOG(("Payout_hd_chkexist:file_id= [%.*s]\n",hv_file_id.len,hv_file_id.arr));
        }

	EXEC SQL DECLARE c_cursor_get_batch_id CURSOR FOR
		SELECT	pu_batch_id
		FROM	par_payout_upload
		WHERE	pu_file_id = :hv_file_id;

	EXEC SQL OPEN c_cursor_get_batch_id;
	do {
		EXEC SQL FETCH c_cursor_get_batch_id
		INTO	
			:v_batch_id:ind_batch_id;

		if (SQLCODE == SQL_NOT_FOUND) {
DEBUGLOG(("Payout_hd_chkexist: record not found!\n"));
			break;
		}
DEBUGLOG(("Payout_hd_chkexist: found record!\n"));

/* batch_id */
		if (ind_batch_id >= 0) {
                        v_batch_id.arr[v_batch_id.len] = '\0';
                        PutField_CString(hRls,"hd_batch_id",(const char*)v_batch_id.arr);
DEBUGLOG(("Payout_hd_chkexist: batch_id = [%s]\n",v_batch_id.arr));
		}

		iRet = PD_FOUND;

		break; // expect only 1 record!

	} while (PD_TRUE);
	
	EXEC SQL CLOSE c_cursor_get_batch_id;

DEBUGLOG(("Payout_hd_chkexist Normal Exit\n"));
	return iRet;

payout_hd_chkexist_error:

DEBUGLOG(("payout_hd_chkexist_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("Payout_hd_chkexist: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_get_batch_id;
        return PD_ERR;

}

int     PayoutUpload_Detail_ChkExist(hash_t *hRls) 
{
        int     iRet = PD_NOT_FOUND;

	char	*csTmp;
	int	iTmp;

        EXEC SQL WHENEVER SQLERROR GOTO payout_dtl_chkexist_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                varchar         hv_file_id[PD_TXN_SEQ_LEN];
		int		hv_seq_num;

                short           ind_file_id;
		short		ind_seq_num;

                varchar         v_batch_id[PD_TXN_SEQ_LEN + 1];
                short           ind_batch_id;


        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("PayoutUpload_Detail_ChkExist BEGIN\n"));

/* file_id */
        if (GetField_CString(hRls, "file_id", &csTmp)) {
                hv_file_id.len = strlen(csTmp);
                memcpy(hv_file_id.arr, csTmp, hv_file_id.len);
                ind_file_id= 0;
DEBUGLOG(("Payout_dtl_chkexist:file_id= [%.*s]\n",hv_file_id.len,hv_file_id.arr));
        }

/* seq_num */
	if(GetField_Int(hRls,"seq_num",&iTmp)){
		hv_seq_num = iTmp;
                ind_seq_num = 0;
DEBUGLOG(("Payout_dtl_chkexist:seq_num = [%d]\n",hv_seq_num));
	}

/*
        EXEC SQL DECLARE c_cursor_get_batch_id_dt CURSOR FOR
		select pu_batch_id
		from par_payout_upload_dtl
		where pu_file_id = :hv_file_id
		and pu_seq_num = :hv_seq_num;
*/

        EXEC SQL DECLARE c_cursor_get_batch_id_dt CURSOR FOR
		select pu_batch_id
		from   merchant_upload_file_detail, par_payout_upload
		where pu_file_id = :hv_file_id
		and   ud_batch_id = pu_batch_id
		and   ud_seq_num = :hv_seq_num;

        EXEC SQL OPEN c_cursor_get_batch_id_dt;
        do {
                EXEC SQL FETCH c_cursor_get_batch_id_dt
                INTO
                        :v_batch_id:ind_batch_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
DEBUGLOG(("Payout_dtl_chkexist: found record!\n"));

/* batch_id */
                if (ind_batch_id >= 0) {
                        v_batch_id.arr[v_batch_id.len] = '\0';
                        PutField_CString(hRls,"dt_batch_id",(const char*)v_batch_id.arr);
DEBUGLOG(("Payout_dtl_chkexist: batch_id = [%s]\n",v_batch_id.arr));
                }

                iRet = PD_FOUND;

                break; // expect only 1 record!

        } while (PD_TRUE);

        EXEC SQL CLOSE c_cursor_get_batch_id_dt;

DEBUGLOG(("Payout_dtl_chkexist Normal Exit\n"));
        return iRet;

payout_dtl_chkexist_error:

DEBUGLOG(("payout_dtl_chkexist_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("Payout_dtl_chkexist: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_get_batch_id_dt;
        return PD_ERR;

}



int GetPayoutDetailByVncRefNum(const char *csVNCRefNum,recordset_t* myRec)
{
        hash_t *myHash;
        char    csBatchId[PD_TXN_SEQ_LEN+1];

        EXEC SQL WHENEVER SQLERROR GOTO getdetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_vnc_ref_num[PD_TXN_SEQ_LEN];

                unsigned long   v_batch_id;
                int             v_seq_num;
                varchar         v_txn_id[PD_TXN_SEQ_LEN+1];
                varchar         v_aux_txn_seq[PD_TXN_SEQ_LEN+1];
                varchar         v_merchant_ref[PD_MERCHANT_REF_LEN+1];
                varchar         v_country[PD_COUNTRY_LEN+1];
                varchar         v_request_ccy[PD_CCY_ID_LEN+1];
                varchar         v_payout_ccy[PD_CCY_ID_LEN+1];
                varchar         v_merchant_fee_ccy[PD_CCY_ID_LEN+1];
                varchar         v_markup_ccy[PD_CCY_ID_LEN+1];
                double          v_request_amount;
                double          v_merchant_fee;
                double          v_markup_amt;
                double          v_ex_rate;
		varchar		v_bank_name[PD_BANK_NAME_LEN + 1];
		varchar		v_bank_code[PD_BANK_CODE_LEN + 1];
		varchar		v_branch[PD_BANK_BRANCH_LEN + 1];
		varchar		v_account_id[PD_AC_NO_LEN + 1];
		varchar		v_account_name[PD_ACC_NAME_LEN + 1];


                short           ind_batch_id = -1;
                short           ind_seq_num = -1;
                short           ind_txn_id = -1;
                short           ind_aux_txn_seq = -1;
                short           ind_merchant_ref = -1;
                short           ind_country = -1;
                short           ind_request_ccy = -1;
                short           ind_payout_ccy = -1;
                short           ind_merchant_fee_ccy = -1;
                short           ind_markup_ccy = -1;
                short           ind_request_amount = -1;
                short           ind_merchant_fee = -1;
                short           ind_markup_amt = -1;
                short           ind_ex_rate = -1;
		short		ind_bank_name = -1;
		short		ind_bank_code = -1;
		short		ind_branch = -1;
		short		ind_account_id = -1;
		short		ind_account_name = -1;

        EXEC SQL END DECLARE SECTION;


        hv_vnc_ref_num.len = strlen(csVNCRefNum);
        memcpy(hv_vnc_ref_num.arr,csVNCRefNum,hv_vnc_ref_num.len);
DEBUGLOG(("GetPayoutDetailByVncRefNum vnc_ref_num = [%.*s]\n",hv_vnc_ref_num.len,hv_vnc_ref_num.arr));

        EXEC SQL DECLARE c_cursor_getdetail CURSOR FOR
                select  ud_batch_id,
                        ud_seq_num,
                        ud_txn_id,
                        ud_aux_txn_id,
                        ud_merchant_ref,
                        ud_country,
                        ud_request_amount,
                        ud_request_currency,
                        ud_payout_currency,
                        ud_merchant_fee_ccy,
                        ud_merchant_fee,
                        ud_markup_ccy,
                        ud_markup_amt,
                        ud_exchange_rate,
			ud_bank_name,
			ud_bank_code,
			ud_branch,
			ud_account_num,
			ud_account_name
                from    merchant_upload_file_detail
                where   ud_vnc_ref_num=:hv_vnc_ref_num
                order by ud_batch_id, ud_seq_num;

        EXEC SQL OPEN  c_cursor_getdetail;
        do{
                EXEC SQL FETCH c_cursor_getdetail
                INTO
                        :v_batch_id:ind_batch_id,
                        :v_seq_num:ind_seq_num,
                        :v_txn_id:ind_txn_id,
                        :v_aux_txn_seq:ind_aux_txn_seq,
                        :v_merchant_ref:ind_merchant_ref,
                        :v_country:ind_country,
                        :v_request_amount:ind_request_amount,
                        :v_request_ccy:ind_request_ccy,
                        :v_payout_ccy:ind_payout_ccy,
                        :v_merchant_fee_ccy:ind_merchant_fee_ccy,
                        :v_merchant_fee:ind_merchant_fee,
                        :v_markup_ccy:ind_markup_ccy,
                        :v_markup_amt:ind_markup_amt,
                        :v_ex_rate:ind_ex_rate,
			:v_bank_name:ind_bank_name,
			:v_bank_code:ind_bank_code,
			:v_branch:ind_branch,
			:v_account_id:ind_account_id,
			:v_account_name:ind_account_name;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/*batch_id*/
                if(ind_batch_id>=0){
                        sprintf(csBatchId,"%ld",v_batch_id);
DEBUGLOG(("GetPayoutDetailByVncRefNum batch_id=[%ld]\n",v_batch_id));
                        PutField_CString(myHash,"batch_id",csBatchId);
                }

/*seq_num*/
                if(ind_seq_num>=0){
                        PutField_Int(myHash,"seq_num",v_seq_num);
DEBUGLOG(("GetPayoutDetailByVncRefNum seq_num=[%d]\n",v_seq_num));
                }

/* txn_id */
		if (ind_txn_id>=0) {
			v_txn_id.arr[v_txn_id.len]='\0';
			PutField_CString(myHash, "merchant_upload_txn_seq", (const char*)v_txn_id.arr);
DEBUGLOG(("GetPayoutDetailByVncRefNum txn_id =[%s]\n",v_txn_id.arr));
		}

/*aux_txn_seq*/
                if(ind_aux_txn_seq>=0){
                        v_aux_txn_seq.arr[v_aux_txn_seq.len]='\0';
                        PutField_CString(myHash,"aux_txn_seq",(const char*)v_aux_txn_seq.arr);
DEBUGLOG(("GetPayoutDetailByVncRefNum aux_txn_seq=[%s]\n",v_aux_txn_seq.arr));
                }


/*merchant_ref*/
                if(ind_merchant_ref>=0){
                        v_merchant_ref.arr[v_merchant_ref.len]='\0';
                        PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetPayoutDetailByVncRefNum merchant_ref= [%s]\n",v_merchant_ref.arr));
                }

/*country*/
                if(ind_country>=0){
                        v_country.arr[v_country.len]='\0';
                        PutField_CString(myHash,"country",(const char*)v_country.arr);
DEBUGLOG(("GetPayoutDetailByVncRefNum country= [%s]\n",v_country.arr));
                }

/*payout_currency*/
                if(ind_payout_ccy>=0){
                        v_payout_ccy.arr[v_payout_ccy.len]='\0';
                        PutField_CString(myHash,"payout_ccy",(const char*)v_payout_ccy.arr);
DEBUGLOG(("GetPayoutDetailByVncRefNum payout_ccy= [%s]\n",v_payout_ccy.arr));
                }

/*request_currency*/
                if(ind_request_ccy>=0){
                        v_request_ccy.arr[v_request_ccy.len]='\0';
                        PutField_CString(myHash,"request_ccy",(const char*)v_request_ccy.arr);
DEBUGLOG(("GetPayoutDetailByVncRefNum request_ccy= [%s]\n",v_request_ccy.arr));
                }
/*request_amount*/
                if(ind_request_amount>=0){
                        PutField_Double(myHash,"request_amount",v_request_amount);
DEBUGLOG(("GetPayoutDetailByVncRefNum request_amount = [%lf]\n",v_request_amount));
        }

/*merchant_fee_ccy*/
                if(ind_merchant_fee_ccy>=0){
                        v_merchant_fee_ccy.arr[v_merchant_fee_ccy.len]='\0';
                        PutField_CString(myHash,"merchant_fee_ccy",(const char*)v_merchant_fee_ccy.arr);
DEBUGLOG(("GetPayoutDetailByVncRefNum merchant_fee_ccy= [%s]\n",v_merchant_fee_ccy.arr));
                }

/*merchant_fee*/
                if(ind_merchant_fee>=0){
                        PutField_Double(myHash,"merchant_fee",v_merchant_fee);
DEBUGLOG(("GetPayoutDetailByVncRefNum merchant_fee = [%lf]\n",v_merchant_fee));
                }

/*markup_ccy*/
                if(ind_markup_ccy>=0){
                        v_markup_ccy.arr[v_markup_ccy.len]='\0';
                        PutField_CString(myHash,"markup_ccy",(const char*)v_markup_ccy.arr);
DEBUGLOG(("GetPayoutDetailByVncRefNum markup_ccy= [%s]\n",v_markup_ccy.arr));
                }

/*markup_amt*/
                if(ind_markup_amt>=0){
                        PutField_Double(myHash,"markup_amt",v_markup_amt);
DEBUGLOG(("GetPayoutDetailByVncRefNum markup_amt = [%lf]\n",v_markup_amt));
                }

/*ex_rate*/
                if(ind_ex_rate>=0){
                        PutField_Double(myHash,"ex_rate",v_ex_rate);
DEBUGLOG(("GetPayoutDetailByVncRefNum ex_rate = [%lf]\n",v_ex_rate));
                }


/* bank_name */
		if (ind_bank_name >= 0) {
			v_bank_name.arr[v_bank_name.len]='\0';
                        PutField_CString(myHash,"stl_txn_bank_name",(const char*)v_bank_name.arr);
DEBUGLOG(("GetPayoutDetailByVncRefNum bank_name = [%s]\n",v_bank_name.arr));
		}

/* bank_code */
		if (ind_bank_code >= 0) {
			v_bank_code.arr[v_bank_code.len]='\0';
                        PutField_CString(myHash,"stl_txn_bank_code",(const char*)v_bank_code.arr);
DEBUGLOG(("GetPayoutDetailByVncRefNum bank_code = [%s]\n",v_bank_code.arr));
		}

/* branch */
		if (ind_branch >= 0) {
			v_branch.arr[v_branch.len]='\0';
                        PutField_CString(myHash,"stl_txn_branch",(const char*)v_branch.arr);
DEBUGLOG(("GetPayoutDetailByVncRefNum branch= [%s]\n",v_branch.arr));
		}


/* account_id */
		if (ind_account_id >= 0) {
			v_account_id.arr[v_account_id.len]='\0';
                        PutField_CString(myHash,"stl_txn_account_id",(const char*)v_account_id.arr);
DEBUGLOG(("GetPayoutDetailByVncRefNum account_id = [%s]\n",v_account_id.arr));
		}

/* account_name */
		if (ind_account_name >= 0) {
			v_account_name.arr[v_account_name.len]='\0';
                        PutField_CString(myHash,"stl_txn_account_name",(const char*)v_account_name.arr);
DEBUGLOG(("GetPayoutDetailByVncRefNum account_name = [%s]\n",v_account_name.arr));
		}

                RecordSet_Add(myRec,myHash);

        }while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getdetail;

DEBUGLOG(("GetPayoutDetailByVncRefNum Normal Exit\n"));
        return  PD_OK;

getdetail_error:
DEBUGLOG(("getdetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("GetPayoutDetailByVncRefNum: SP_ERR\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getdetail;
        return PD_ERR;

}

int GetPayoutDetailByAuxVncRefNum(const char *csVNCRefNum,recordset_t* myRec)
{
        hash_t *myHash;
        char    csBatchId[PD_TXN_SEQ_LEN+1];

        EXEC SQL WHENEVER SQLERROR GOTO getdetaila_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_vnc_ref_num[PD_TXN_SEQ_LEN];

                unsigned long   v_batch_id;
                int             v_seq_num;
                varchar         v_txn_id[PD_TXN_SEQ_LEN+1];
                //varchar         v_aux_txn_seq[PD_TXN_SEQ_LEN+1];
                varchar         v_merchant_ref[PD_MERCHANT_REF_LEN+1];
                varchar         v_country[PD_COUNTRY_LEN+1];
                varchar         v_request_ccy[PD_CCY_ID_LEN+1];
                varchar         v_payout_ccy[PD_CCY_ID_LEN+1];
                varchar         v_merchant_fee_ccy[PD_CCY_ID_LEN+1];
                varchar         v_markup_ccy[PD_CCY_ID_LEN+1];
                double          v_request_amount;
                double          v_merchant_fee;
                double          v_markup_amt;
                double          v_ex_rate;
                int		v_status;

                short           ind_batch_id = -1;
                short           ind_seq_num = -1;
                short           ind_txn_id = -1;
                //short           ind_aux_txn_seq = -1;
                short           ind_merchant_ref = -1;
                short           ind_country = -1;
                short           ind_request_ccy = -1;
                short           ind_payout_ccy = -1;
                short           ind_merchant_fee_ccy = -1;
                short           ind_markup_ccy = -1;
                short           ind_request_amount = -1;
                short           ind_merchant_fee = -1;
                short           ind_markup_amt = -1;
                short           ind_ex_rate = -1;
                short           ind_status = -1;

        EXEC SQL END DECLARE SECTION;


        hv_vnc_ref_num.len = strlen(csVNCRefNum);
        memcpy(hv_vnc_ref_num.arr,csVNCRefNum,hv_vnc_ref_num.len);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum vnc_ref_num = [%.*s]\n",hv_vnc_ref_num.len,hv_vnc_ref_num.arr));

        EXEC SQL DECLARE c_cursor_getdetaila CURSOR FOR
                select  ud_batch_id,
                        ud_seq_num,
                        ud_txn_id,
                        //ud_aux_txn_id,
                        ud_merchant_ref,
                        ud_country,
                        ud_request_amount,
                        ud_request_currency,
                        ud_payout_currency,
                        ud_merchant_fee_ccy,
                        ud_merchant_fee,
                        ud_markup_ccy,
                        ud_markup_amt,
                        ud_exchange_rate,
			ud_status
                from    merchant_upload_file_detail
                where   ud_aux_txn_id=:hv_vnc_ref_num
                order by ud_batch_id, ud_seq_num;

        EXEC SQL OPEN  c_cursor_getdetaila;
        do{
                EXEC SQL FETCH c_cursor_getdetaila
                INTO
                        :v_batch_id:ind_batch_id,
                        :v_seq_num:ind_seq_num,
                        :v_txn_id:ind_txn_id,
                        //:v_aux_txn_seq:ind_aux_txn_seq,
                        :v_merchant_ref:ind_merchant_ref,
                        :v_country:ind_country,
                        :v_request_amount:ind_request_amount,
                        :v_request_ccy:ind_request_ccy,
                        :v_payout_ccy:ind_payout_ccy,
                        :v_merchant_fee_ccy:ind_merchant_fee_ccy,
                        :v_merchant_fee:ind_merchant_fee,
                        :v_markup_ccy:ind_markup_ccy,
                        :v_markup_amt:ind_markup_amt,
                        :v_ex_rate:ind_ex_rate,
                        :v_status:ind_status;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/*batch_id*/
                if(ind_batch_id>=0){
                        sprintf(csBatchId,"%ld",v_batch_id);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum batch_id=[%ld]\n",v_batch_id));
                        PutField_CString(myHash,"batch_id",csBatchId);
                }

/*seq_num*/
                if(ind_seq_num>=0){
                        PutField_Int(myHash,"seq_num",v_seq_num);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum seq_num=[%d]\n",v_seq_num));
                }

/*txn_id*/
                if(ind_txn_id>=0){
                        v_txn_id.arr[v_txn_id.len]='\0';
                        PutField_CString(myHash,"txn_id",(const char*)v_txn_id.arr);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum txn_id=[%s]\n",v_txn_id.arr));
                }


/*merchant_ref*/
                if(ind_merchant_ref>=0){
                        v_merchant_ref.arr[v_merchant_ref.len]='\0';
                        PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum merchant_ref= [%s]\n",v_merchant_ref.arr));
                }

/*country*/
                if(ind_country>=0){
                        v_country.arr[v_country.len]='\0';
                        PutField_CString(myHash,"country",(const char*)v_country.arr);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum country= [%s]\n",v_country.arr));
                }

/*payout_currency*/
                if(ind_payout_ccy>=0){
                        v_payout_ccy.arr[v_payout_ccy.len]='\0';
                        PutField_CString(myHash,"payout_ccy",(const char*)v_payout_ccy.arr);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum payout_ccy= [%s]\n",v_payout_ccy.arr));
                }

/*request_currency*/
                if(ind_request_ccy>=0){
                        v_request_ccy.arr[v_request_ccy.len]='\0';
                        PutField_CString(myHash,"request_ccy",(const char*)v_request_ccy.arr);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum request_ccy= [%s]\n",v_request_ccy.arr));
                }
/*request_amount*/
                if(ind_request_amount>=0){
                        PutField_Double(myHash,"request_amount",v_request_amount);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum request_amount = [%lf]\n",v_request_amount));
        }

/*merchant_fee_ccy*/
                if(ind_merchant_fee_ccy>=0){
                        v_merchant_fee_ccy.arr[v_merchant_fee_ccy.len]='\0';
                        PutField_CString(myHash,"merchant_fee_ccy",(const char*)v_merchant_fee_ccy.arr);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum merchant_fee_ccy= [%s]\n",v_merchant_fee_ccy.arr));
                }

/*merchant_fee*/
                if(ind_merchant_fee>=0){
                        PutField_Double(myHash,"merchant_fee",v_merchant_fee);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum merchant_fee = [%lf]\n",v_merchant_fee));
                }

/*markup_ccy*/
                if(ind_markup_ccy>=0){
                        v_markup_ccy.arr[v_markup_ccy.len]='\0';
                        PutField_CString(myHash,"markup_ccy",(const char*)v_markup_ccy.arr);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum markup_ccy= [%s]\n",v_markup_ccy.arr));
                }

/*markup_amt*/
                if(ind_markup_amt>=0){
                        PutField_Double(myHash,"markup_amt",v_markup_amt);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum markup_amt = [%lf]\n",v_markup_amt));
                }

/*ex_rate*/
                if(ind_ex_rate>=0){
                        PutField_Double(myHash,"ex_rate",v_ex_rate);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum ex_rate = [%lf]\n",v_ex_rate));
                }

/*status*/
                if(ind_status>=0){
                        PutField_Int(myHash,"status",v_status);
DEBUGLOG(("GetPayoutDetailByAuxVncRefNum status = [%d]\n",v_status));
                }

                RecordSet_Add(myRec,myHash);
		break;/////should be one record only

        }while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getdetaila;

DEBUGLOG(("GetPayoutDetailByAuxVncRefNum Normal Exit\n"));
        return  PD_OK;

getdetaila_error:
DEBUGLOG(("getdetaila_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("GetPayoutDetailByAuxVncRefNum: SP_ERR\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getdetaila;
        return PD_ERR;

}

int format_data(hash_t *hMyHash, hash_t *hTxnHeader, hash_t *hContext, hash_t *hRequest)
{
        int     iRet = SUCCESS;
        char*   csTmp;

        char    *csTxnDateTime;
        char    csDate[PD_DATE_LEN + 1];
        char    csTime[PD_TIME_LEN + 1];
        double  dTxnAmount = 0.0;
        double  dTmp = 0.0;
        double  dFee = 0.0;
        double  dNetAmount = 0.0;
        int     iTmp;

        if (GetField_CString(hTxnHeader, "txn_id", &csTmp)) {
DEBUGLOG(("format_data txn_id [%s]\n", csTmp));
                PutField_CString(hContext, "txn_seq", csTmp);
        }

        if (GetField_CString(hTxnHeader, "org_txn_id", &csTmp)) {
DEBUGLOG(("format_data org_txn_id [%s]\n", csTmp));
                PutField_CString(hContext, "org_txn_seq", csTmp);
        }

        if (GetField_CString(hMyHash, "channel_code", &csTmp)) {
DEBUGLOG(("format_data channel_code [%s]\n", csTmp));
                PutField_CString(hContext, "channel_code", csTmp);
        }

        if (GetField_CString(hMyHash, "txn_code", &csTmp)) {
DEBUGLOG(("format_data txn_code [%s]\n", csTmp));
                PutField_CString(hContext, "txn_code", csTmp);
        }

        if (GetField_CString(hMyHash, "post_date", &csTmp)) {
DEBUGLOG(("format_data post_date [%s]\n", csTmp));
                PutField_CString(hContext, "PHDATE", csTmp);
        }

        if (GetField_CString(hMyHash, "local_tm_date", &csTmp)) {
DEBUGLOG(("format_data local_tm_date [%s]\n", csTmp));
                PutField_CString(hContext, "local_tm_date", csTmp);
        }
        if (GetField_CString(hMyHash, "local_tm_time", &csTmp)) {
DEBUGLOG(("format_data local_tm_time [%s]\n", csTmp));
                PutField_CString(hContext, "local_tm_time", csTmp);
        }

        if (GetField_CString(hMyHash, "process_type", &csTmp)) {
DEBUGLOG(("format_data process_type [%s]\n", csTmp));
                PutField_CString(hRequest, "process_type", csTmp);
        }

        if (GetField_CString(hMyHash, "process_code", &csTmp)) {
DEBUGLOG(("format_data process_code [%s]\n", csTmp));
                PutField_CString(hRequest, "process_code", csTmp);
        }

        if (GetField_CString(hMyHash, "merchant_id", &csTmp)) {
DEBUGLOG(("format_data merchant_id [%s]\n", csTmp));
                PutField_CString(hRequest, "merchant_id", csTmp);
        }

        if (GetField_Int(hMyHash, "internal_code", &iTmp)) {
DEBUGLOG(("format_data internal_code [%d]\n", iTmp));
                PutField_Int(hContext, "internal_code", iTmp);
        }

        if (GetField_CString(hMyHash, "response_code", &csTmp)) {
DEBUGLOG(("format_data response_code [%s]\n", csTmp));
                PutField_CString(hContext, "response_code", csTmp);
        }

        if (GetField_CString(hMyHash, "txn_date", &csTxnDateTime)) {
DEBUGLOG(("format_data txn_date [%s]\n", csTxnDateTime));
                PutField_CString(hRequest, "transmission_datetime", csTxnDateTime);

                csDate[0] = '\0';
                csTime[0] = '\0';

                strncpy(csDate, csTxnDateTime, PD_DATE_LEN);
                strncpy(csTime, csTxnDateTime + PD_DATE_LEN, PD_TIME_LEN);

                csDate[PD_DATE_LEN] = '\0';
                csTime[PD_TIME_LEN] = '\0';
DEBUGLOG(("format_data tm_date [%s]\n", csDate));
DEBUGLOG(("format_data tm_time [%s]\n", csTime));

                PutField_CString(hRequest, "tm_date", csDate);
                PutField_CString(hRequest, "tm_time", csTime);

                //PutField_CString(hMyHash, "merchant_txn_date", csDate);
                //PutField_CString(hMyHash, "merchant_txn_time", csTime);
        }

        if (GetField_Int(hMyHash, "approved", &iTmp)) {
                if(iTmp==PD_TRUE){
DEBUGLOG(("format_data approval_date [%s]\n", csDate));
                        PutField_CString(hContext, "approval_date", csDate);
                }
        }

        if (GetField_CString(hMyHash, "service", &csTmp)) {
DEBUGLOG(("format_data service [%s]\n", csTmp));
                PutField_CString(hRequest, "service_code", csTmp);
        }

        if (GetField_CString(hMyHash, "client_ip", &csTmp)) {
DEBUGLOG(("format_data client_ip [%s]\n", csTmp));
                PutField_CString(hRequest, "ip_addr", csTmp);
        }
        if (GetField_CString(hMyHash, "ccy", &csTmp)) {
DEBUGLOG(("format_data ccy [%s]\n", csTmp));
                PutField_CString(hRequest, "txn_ccy", csTmp);
        }

        if (GetField_CString(hMyHash, "country", &csTmp)) {
DEBUGLOG(("format_data country [%s]\n", csTmp));
                PutField_CString(hRequest, "txn_country", csTmp);
        }
/*
        if (GetField_CString(hMyHash, "pay_method", &csTmp)) {
DEBUGLOG(("format_data pay_method [%s]\n", csTmp));
                PutField_CString(hRequest, "pay_method", csTmp);
                PutField_CString(hContext, "selected_pay_method", csTmp);
        }
*/
        if (GetField_CString(hMyHash, "vnc_ref_num", &csTmp)) {
DEBUGLOG(("format_data vnc_ref_num [%s]\n", csTmp));
                PutField_CString(hContext, "vnc_ref_num", csTmp);
        }

        if (GetField_Double(hMyHash, "amount", &dTxnAmount)) {
DEBUGLOG(("format_data txn_amount [%lf]\n", dTxnAmount));
                PutField_Double(hContext, "txn_amt", dTxnAmount);
        }

        if (GetField_Double(hMyHash, "ex_rate", &dTmp)) {
DEBUGLOG(("format_data ex_rate [%lf]\n", dTmp));
                PutField_Double(hContext, "ex_rate", dTmp);
        }

        if (GetField_Double(hMyHash, "fee", &dFee)) {
DEBUGLOG(("format_data fee [%lf]\n", dFee));

        }
        if (GetField_CString(hMyHash, "markup_ccy", &csTmp)) {
DEBUGLOG(("format_data markup_ccy [%s]\n", csTmp));
                PutField_CString(hContext, "markup_ccy", csTmp);
        }

        if (GetField_Double(hMyHash, "markup_amt", &dTmp)) {
DEBUGLOG(("format_data markup_amt [%lf]\n", dTmp));
                PutField_Double(hContext, "markup_amt", dTmp);
        }

        if (dTxnAmount > 0.0) {
                dNetAmount = dTxnAmount + dFee;
DEBUGLOG(("format_data net_amount [%lf]\n", dNetAmount));
                PutField_Double(hContext, "net_amt", dNetAmount);
                PutField_Double(hMyHash, "net_amt", dNetAmount);
        }


        if (GetField_CString(hMyHash, "merchant_client_id", &csTmp)) {
DEBUGLOG(("format_data merchant_client_id [%s]\n", csTmp));
                PutField_CString(hContext, "client_id", csTmp);
        }

        if (GetField_CString(hMyHash, "psp_client_id", &csTmp)) {
DEBUGLOG(("format_data psp_client_id [%s]\n", csTmp));
                PutField_CString(hContext, "client_id", csTmp);
        }

        if (GetField_Double(hMyHash, "merchant_open_bal", &dTmp)) {
DEBUGLOG(("format_data merchant_open_bal [%lf]\n", dTmp));
                PutField_Double(hContext, "merchant_open_bal", dTmp);
        }

        if (GetField_Double(hMyHash, "merchant_open_bal_settlement", &dTmp)) {
DEBUGLOG(("format_data merchant_open_bal_settlement [%lf]\n", dTmp));
                PutField_Double(hContext, "merchant_open_bal_settlement", dTmp);
        }

        if (GetField_Double(hMyHash, "total_float", &dTmp)) {
DEBUGLOG(("format_data total_float [%lf]\n", dTmp));
                PutField_Double(hContext, "total_float", dTmp);
        }

        if (GetField_Double(hMyHash, "current_bal", &dTmp)) {
DEBUGLOG(("format_data current_bal [%lf]\n", dTmp));
                PutField_Double(hContext, "current_bal", dTmp);
        }

        if (GetField_Double(hMyHash, "total_reserved_amount", &dTmp)) {
DEBUGLOG(("format_data total_reserved_amount [%lf]\n", dTmp));
                PutField_Double(hContext, "total_reserved_amount", dTmp);
        }

        if (GetField_Double(hMyHash, "total_hold", &dTmp)) {
DEBUGLOG(("format_data total_hold [%lf]\n", dTmp));
                PutField_Double(hContext, "total_hold", dTmp);
        }

        if (GetField_Double(hMyHash, "total_float_after_payout", &dTmp)) {
DEBUGLOG(("format_data total_float_after_payout [%lf]\n", dTmp));
                PutField_Double(hContext, "total_float_after_payout", dTmp);
        }

        if (GetField_Double(hMyHash, "current_bal_settlement", &dTmp)) {
DEBUGLOG(("format_data current_bal_settlement [%lf]\n", dTmp));
                PutField_Double(hContext, "current_bal_settlement", dTmp);
        }

        if (GetField_Double(hMyHash, "total_float_settlement", &dTmp)) {
DEBUGLOG(("format_data total_float_settlement [%lf]\n", dTmp));
                PutField_Double(hContext, "total_float_settlement", dTmp);
        }

        if (GetField_Double(hMyHash, "total_hold_settlement", &dTmp)) {
DEBUGLOG(("format_data total_hold_settlement [%lf]\n", dTmp));
                PutField_Double(hContext, "total_hold_settlement", dTmp);
        }
        if (GetField_Double(hMyHash, "fundin_payout", &dTmp)) {
DEBUGLOG(("format_data fundin_payout [%lf]\n", dTmp));
                PutField_Double(hContext, "fundin_payout", dTmp);
        }

        if (GetField_Double(hMyHash, "reserved_payout", &dTmp)) {
DEBUGLOG(("format_data reserved_payout [%lf]\n", dTmp));
                PutField_Double(hContext, "reserved_payout", dTmp);
        }

        return iRet;
}

int     PayoutAddTxnLog(const hash_t *hContext,
                const hash_t* hRequest)
{
        hash_t  *hTxn;
        char    *csTmp;
        char    *csTxnSeq;
        int     iTmp;
        int iRet = PD_OK;

        hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);
        if (GetField_CString(hContext,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("PayoutAddTxnLog:: txn_seq = [%s]\n",csTxnSeq));
                PutField_CString(hTxn,"txn_seq",csTxnSeq);

                if (GetField_CString(hContext,"add_user",&csTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: add_user = [%s]\n",csTmp));
                        PutField_CString(hTxn,"add_user",csTmp);
                }
                else{
                        PutField_CString(hTxn,"add_user",PD_UPDATE_USER);
                }

                if (GetField_CString(hRequest,"process_code",&csTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: process_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"process_code",csTmp);
                }
                if (GetField_CString(hRequest,"process_type",&csTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: process_type = [%s]\n",csTmp));
                        PutField_CString(hTxn,"process_type",csTmp);
                }
                if (GetField_CString(hContext,"channel_code",&csTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: channel_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"channel_code",csTmp);
                }
                if (GetField_CString(hRequest,"merchant_id",&csTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: merchant_id = [%s]\n",csTmp));
                        PutField_CString(hTxn,"merchant_id",csTmp);
                }
                if (GetField_CString(hRequest,"service_code",&csTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: service_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"service_code",csTmp);
                }
                if (GetField_CString(hContext,"txn_code",&csTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: txn_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"txn_code",csTmp);
                }

                if (GetField_CString(hContext,"response_code",&csTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: response_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"response_code",csTmp);
                }

                if (GetField_Int(hContext,"internal_code",&iTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: internal_code = [%d]\n",iTmp));
                        PutField_Int(hTxn,"internal_code",iTmp);
                }

                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: host_posting_date = [%s]\n",csTmp));
                        PutField_CString(hTxn,"host_posting_date",csTmp);
                }
                if (GetField_CString(hRequest,"transmission_datetime",&csTmp)){
DEBUGLOG(("PayoutAddTxnLog:: transmission_datetime = [%s]\n",csTmp));
                        PutField_CString(hTxn,"transmission_datetime",csTmp);
                }
                if (GetField_CString(hRequest,"tm_date",&csTmp)){
DEBUGLOG(("PayoutAddTxnLog:: tm_date = [%s]\n",csTmp));
                        PutField_CString(hTxn,"tm_date",csTmp);
                }
                if (GetField_CString(hRequest,"tm_time",&csTmp)){
DEBUGLOG(("PayoutAddTxnLog:: tm_time = [%s]\n",csTmp));
                        PutField_CString(hTxn,"tm_time",csTmp);
                }
                if (GetField_CString(hContext,"local_tm_date",&csTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: local_tm_date = [%s]\n",csTmp));
                        PutField_CString(hTxn,"local_tm_date",csTmp);
                }
                if (GetField_CString(hContext,"local_tm_time",&csTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: local_tm_time = [%s]\n",csTmp));
                        PutField_CString(hTxn,"local_tm_time",csTmp);
                }

/* request */
                /* client ip */
                if (GetField_CString(hRequest,"ip_addr",&csTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: client_ip = [%s]\n",csTmp));
                        PutField_CString(hTxn,"ip_addr",csTmp);
                }

                PutField_Char(hTxn,"status",PD_PROCESSING);

                PutField_Int(hTxn,"db_commit",PD_FALSE);
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Add");
                iRet = (unsigned long) ((*DBObjPtr)(hTxn));

                char *csTxnCcy, *csTxnCountry;
                if (GetField_CString(hRequest,"txn_ccy",&csTxnCcy) && iRet == PD_OK) {
DEBUGLOG(("PayoutAddTxnLog:: txn_ccy = [%s]\n",csTxnCcy));
                        hash_t* hDetail;
                        hDetail = (hash_t*)  malloc (sizeof(hash_t));
                        hash_init(hDetail,0);
                        PutField_CString(hDetail,"txn_seq",csTxnSeq);
                        PutField_CString(hDetail,"txn_ccy",csTxnCcy);

                        if (GetField_CString(hTxn, "add_user", &csTmp)) {
                                PutField_CString(hDetail,"add_user",csTmp);
                        }

                        if (GetField_CString(hRequest,"txn_country",&csTxnCountry))
                                PutField_CString(hDetail,"txn_country",csTxnCountry);
                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                        iRet = (unsigned long) ((*DBObjPtr)(hDetail));

                        hash_destroy(hDetail);
                        FREE_ME(hDetail);
                }

        }
        else
                iRet = PD_ERR;

        hash_destroy(hTxn);
        FREE_ME(hTxn);
        FREE_ME(csTmp);
DEBUGLOG(("PayoutAddTxnLog RET = [%d]\n",iRet));
        return  iRet;
}

int handle_payout_balance(hash_t *hMyHash)
{
        int     iRet = SUCCESS;

        char    *csMID = NULL;
        char    *csCcy = NULL;
        char    *csCountry = NULL;
        char    *csService = NULL;
        char    *csTmp= NULL;
        double  dAmount = 0.0;
        double  dTmp = 0.0;
        int     iDayOfWeek= 0;
        double  dFee = 0.0;
        double  dNetAmt = 0.0;

        if (GetField_CString(hMyHash, "merchant_id", &csMID)) {
DEBUGLOG(("handle_payout_balance: merchant_id [%s]\n", csMID));
        }
        else {
DEBUGLOG(("handle_payout_balance: merchant_id missing\n"));
                iRet = FAILURE;
        }

        if (GetField_CString(hMyHash, "ccy", &csCcy)) {
DEBUGLOG(("handle_payout_balance: ccy [%s]\n", csCcy));
        }
        else {
DEBUGLOG(("handle_payout_balance: ccy missing\n"));
                iRet = FAILURE;
        }
        if (GetField_CString(hMyHash, "country", &csCountry)) {
DEBUGLOG(("handle_payout_balance: country [%s]\n", csCountry));
        }
        else {
DEBUGLOG(("handle_payout_balance: country missing\n"));
                iRet = FAILURE;
        }
        if (GetField_CString(hMyHash, "service", &csService)) {
DEBUGLOG(("handle_payout_balance: service [%s]\n", csService));
        }
        else {
DEBUGLOG(("handle_payout_balance: service missing\n"));
                iRet = FAILURE;
        }

        if (GetField_Double(hMyHash, "amount", &dAmount)) {
DEBUGLOG(("handle_payout_balance: amount [%lf]\n", dAmount));
                dNetAmt += dAmount;
        }
        else {
DEBUGLOG(("handle_payout_balance: amount missing\n"));
                iRet = FAILURE;
        }

        if (GetField_Double(hMyHash, "fee", &dFee)) {
DEBUGLOG(("handle_payout_balance: fee[%lf]\n", dFee));
                dNetAmt += dFee;
        }
        else {
DEBUGLOG(("handle_payout_balance: fee missing\n"));
                iRet = FAILURE;
        }

        if (GetField_CString(hMyHash, "post_date", &csTmp)) {
                iDayOfWeek = day_of_week((const unsigned char*)csTmp);
                PutField_Int(hMyHash,"day_of_week",iDayOfWeek);
        }

        PutField_Double(hMyHash,"net_amt",dNetAmt);
        PutField_Char(hMyHash,"party_type",PD_TYPE_MERCHANT);

        if (iRet == SUCCESS) {
                if (prbo_UpdatePayoutAmount(hMyHash) == PD_OK) {
                        if (GetField_Double(hMyHash, "merchant_open_bal", &dTmp)) {
DEBUGLOG(("handle_payout_balance: merchant_open_bal [%lf]\n", dTmp));
                        }
                        if (GetField_Double(hMyHash, "merchant_open_bal_settlement", &dTmp)) {
DEBUGLOG(("handle_payout_balance: merchant_open_bal_settlement [%lf]\n", dTmp));
                        }
                        if (GetField_Double(hMyHash, "total_float", &dTmp)) {
DEBUGLOG(("handle_payout_balance:total_float [%lf]!\n", dTmp));
                        }

                        if (GetField_Double(hMyHash, "current_bal", &dTmp)) {
DEBUGLOG(("handle_payout_balance:current_bal [%lf]!\n", dTmp));
                        }

                        if (GetField_Double(hMyHash, "total_reserved_amount" , &dTmp)) {
DEBUGLOG(("handle_payout_balance:total_reserved_amount [%lf]!\n", dTmp));
                        }

                        if (GetField_Double(hMyHash, "total_hold", &dTmp)) {
DEBUGLOG(("handle_payout_balance:total_hold [%lf]!\n", dTmp));
                        }

                        if (GetField_Double(hMyHash, "total_float_after_payout", &dTmp)) {
DEBUGLOG(("handle_payout_balance:total_float_after_payout [%lf]!\n", dTmp));
                        }

                        if (GetField_Double(hMyHash, "current_bal_settlement", &dTmp)) {
DEBUGLOG(("handle_payout_balance:current_bal_settlement [%lf]!\n", dTmp));
                        }

                        if (GetField_Double(hMyHash, "total_float_settlement", &dTmp)) {
DEBUGLOG(("handle_payout_balance:total_float_settlement [%lf]!\n", dTmp));
                        }
                        if (GetField_Double(hMyHash, "total_hold_settlement", &dTmp)) {
DEBUGLOG(("handle_payout_balance:total_hold_settlement [%lf]!\n", dTmp));
                        }

                        if (GetField_Double(hMyHash, "fundin_payout", &dTmp)) {
DEBUGLOG(("handle_payout_balance:fundin_payout [%lf]!\n", dTmp));
                        }

                        if (GetField_Double(hMyHash, "reserved_payout", &dTmp)) {
DEBUGLOG(("handle_payout_balance:reserved_payout [%lf]!\n", dTmp));
                        }

                }
                else {
DEBUGLOG(("handle_payout_balance: UpdatePayoutAmount FAIL!\n"));
                        iRet = FAILURE;
                }

        }
        return iRet;
}

int     prpar_UpdateTxnLog(const hash_t *hContext,
                const hash_t* hRequest,
                const hash_t* hResponse)
{
        hash_t  *hTxn;
        char    *csTxnSeq;

        int     iRet = PD_OK;
        int     iTmp;
        char    cTmp;
        double  dTmp;
        char*   csPtr;

        hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);

        if (GetField_CString(hContext,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("UpdateTxnLog:: txn_seq = [%s]\n",csTxnSeq));
                PutField_CString(hTxn,"txn_seq",csTxnSeq);

                if (GetField_CString(hContext,"update_user",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: add_user = [%s]\n",csPtr));
                        PutField_CString(hTxn,"update_user",csPtr);
                }
                else{
                        PutField_CString(hTxn,"update_user",PD_UPDATE_USER);
                }

                if (GetField_CString(hContext,"org_txn_seq",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: org_txn_seq = [%s]\n",csPtr));
                        PutField_CString(hTxn,"org_txn_seq",csPtr);
                }
                if (GetField_Char(hContext,"status",&cTmp)) {
DEBUGLOG(("UpdateTxnLog:: status = [%c]\n",cTmp));
                        PutField_Char(hTxn,"status",cTmp);
                }
                if (GetField_CString(hContext,"sub_status",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: sub_status = [%s]\n",csPtr));
                        PutField_CString(hTxn,"sub_status",csPtr);
                }

                if (GetField_Char(hContext,"ar_ind",&cTmp)) {
DEBUGLOG(("UpdateTxnLog:: ar_ind = [%c]\n",cTmp));
                        PutField_Char(hTxn,"ar_ind",cTmp);
                }

                if (GetField_Int(hContext,"internal_code",&iTmp)) {
DEBUGLOG(("UpdateTxnLog:: internal_code = [%d]\n",iTmp));
                        PutField_Int(hTxn,"internal_code",iTmp);
                }

                if (GetField_CString(hResponse,"response_code",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: response_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"response_code",csPtr);
                }
                else if (GetField_CString(hContext,"response_code",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: response_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"response_code",csPtr);
                }

                if (GetField_CString(hContext,"client_id",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: client_id = [%s]\n",csPtr));
                        PutField_CString(hTxn,"client_id",csPtr);
                }

                if (GetField_Double(hContext,"txn_amt",&dTmp)) {
DEBUGLOG(("UpdateTxnLog:: txn_amt = [%f]\n",dTmp));
                        PutField_Double(hTxn,"txn_amt",dTmp);
                }
                if (GetField_Double(hContext,"net_amt",&dTmp)) {
DEBUGLOG(("UpdateTxnLog:: net_amt = [%f]\n",dTmp));
                        PutField_Double(hTxn,"net_amt",dTmp);
                }

/* net ccy */
                if (GetField_CString(hContext,"net_ccy",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: net_ccy = [%s]\n",csPtr));
                        PutField_CString(hTxn,"net_ccy",csPtr);
                }

                if (GetField_Double(hContext,"ex_rate",&dTmp)) {
DEBUGLOG(("UpdateTxnLog:: ex_rate = [%f]\n",dTmp));
                        PutField_Double(hTxn,"ex_rate",dTmp);
                }

                if (GetField_Char(hContext,"ex_party",&cTmp)) {
DEBUGLOG(("UpdateTxnLog:: ex_supplier = [%f]\n",cTmp));
                        PutField_Char(hTxn,"ex_supplier",cTmp);
                }

/* markup ccy */
                if(GetField_CString(hContext,"markup_ccy",&csPtr)){
DEBUGLOG(("UpdateTxnLog:: markup_ccy = [%s]\n",csPtr));
                        PutField_CString(hTxn,"markup_ccy",csPtr);
                }
/* markup rate */
                if(GetField_Double(hContext,"markup_rate",&dTmp)){
DEBUGLOG(("UpdateTxnLog:: markup_rate = [%f]\n",dTmp));
                        PutField_Double(hTxn,"markup_rate",dTmp);
                }
/* markup amount */
                if(GetField_Double(hContext,"markup_amt",&dTmp)){
DEBUGLOG(("UpdateTxnLog:: markup_amount = [%f]\n",dTmp));
                        PutField_Double(hTxn,"markup_amt",dTmp);
                }
/* dst_txn_amt */
                if(GetField_Double(hContext,"dst_txn_amt",&dTmp)){
DEBUGLOG(("UpdateTxnLog:: dst_txn_amt = [%f]\n",dTmp));
                        PutField_Double(hTxn,"dst_txn_amt",dTmp);
                }

/* settlement_txn_amt */
                if(GetField_Double(hContext,"settlement_txn_amt",&dTmp)){
DEBUGLOG(("UpdateTxnLog:: settlement_txn_amt = [%f]\n",dTmp));
                        PutField_Double(hTxn,"settlement_txn_amt",dTmp);
                }

                if (GetField_CString(hContext,"merchant_id",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: merchant_id = [%s]\n",csPtr));
                        PutField_CString(hTxn,"merchant_id",csPtr);
                }

                if (GetField_CString(hContext,"merchant_ref",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: merchant_ref = [%s]\n",csPtr));
                        PutField_CString(hTxn,"merchant_ref",csPtr);
                }

                if (GetField_CString(hContext,"service_code",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: service_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"service_code",csPtr);
                }

                if (GetField_CString(hContext,"approval_date",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: approval_date = [%s]\n",csPtr));
                        PutField_CString(hTxn,"approval_date",csPtr);
                }

                if (GetField_CString(hContext,"new_txn_code",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: new_txn_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"txn_code",csPtr);
                }
/* update txn header */
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxn);
        }
        else
                iRet = PD_ERR;

        if(iRet == PD_OK){
                if (GetField_CString(hRequest,"txn_country",&csPtr)) {
DEBUGLOG(("UpdateTxnLog:: country = [%s]\n",csPtr));
                        PutField_CString(hTxn,"txn_country",csPtr);
                }
/* open_bal */
                if (GetField_Double(hContext,"merchant_open_bal",&dTmp)) {
                        PutField_Double(hTxn,"open_bal",dTmp);
DEBUGLOG(("UpdateTxnLog:: open_bal= [%f]\n",dTmp));
                }

/* open_bal_settlement */
                if (GetField_Double(hContext,"merchant_open_bal_settlement",&dTmp)) {
                        PutField_Double(hTxn,"open_bal_settlement",dTmp);
DEBUGLOG(("UpdateTxnLog:: open_bal_settlement= [%f]\n",dTmp));
                }

/* current_bal */
                if (GetField_Double(hContext,"current_bal",&dTmp)) {
                        PutField_Double(hTxn,"current_bal",dTmp);
DEBUGLOG(("UpdateTxnLog:: current_bal= [%f]\n",dTmp));
                }

/* total_float*/
                if (GetField_Double(hContext,"total_float",&dTmp)) {
                        PutField_Double(hTxn,"total_float",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_float= [%f]\n",dTmp));
                }
/* total_reserved_amount*/
                if (GetField_Double(hContext,"total_reserved_amount",&dTmp)) {
                        PutField_Double(hTxn,"total_reserved_amount",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_reserved_amount= [%f]\n",dTmp));
                }

/* total_hold*/
                if (GetField_Double(hContext,"total_hold",&dTmp)) {
                        PutField_Double(hTxn,"total_hold",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_hold= [%f]\n",dTmp));
                }

/* total_float_after_payout*/
                if (GetField_Double(hContext,"total_float_after_payout",&dTmp)) {
                        PutField_Double(hTxn,"total_float_after_payout",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_float_after_payout= [%f]\n",dTmp));
                }

/* current_bal_settlement*/
                if (GetField_Double(hContext,"current_bal_settlement",&dTmp)) {
                        PutField_Double(hTxn,"current_bal_settlement",dTmp);
DEBUGLOG(("UpdateTxnLog:: current_bal_settlement= [%f]\n",dTmp));
                }

/* total_float_settlement*/
                if (GetField_Double(hContext,"total_float_settlement",&dTmp)) {
                        PutField_Double(hTxn,"total_float_settlement",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_float_settlement= [%f]\n",dTmp));
                }

/* total_hold_settlement*/
                if (GetField_Double(hContext,"total_hold_settlement",&dTmp)) {
                        PutField_Double(hTxn,"total_hold_settlement",dTmp);
DEBUGLOG(("UpdateTxnLog:: total_hold_settlement= [%f]\n",dTmp));
                }
/* fundin_payout*/
                if (GetField_Double(hContext,"fundin_payout",&dTmp)) {
                        PutField_Double(hTxn,"fundin_payout",dTmp);
DEBUGLOG(("UpdateTxnLog:: fundin_payout= [%f]\n",dTmp));
                }

/* reserved_payout*/
                if (GetField_Double(hContext,"reserved_payout",&dTmp)) {
                        PutField_Double(hTxn,"reserved_payout",dTmp);
DEBUGLOG(("UpdateTxnLog:: reserved_payout= [%f]\n",dTmp));
                }

                DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                iRet = (unsigned long)(*DBObjPtr)(hTxn);
        }


DEBUGLOG(("UpdateTxnLog iRet = [%d]\n",iRet));
        hash_destroy(hTxn);
        FREE_ME(hTxn);

        return  iRet;
}

int add_txn_element(hash_t *hMyHash)
{
        int     iRet = SUCCESS;
        char    *csTmp;
        char    cTmp;
        double  dTmp;
	int	iPayoutBalTransfer = PD_FALSE;
	int	iPayoutVoidFlag = PD_FALSE;
        hash_t *hTxn;
	hash_t *hPayoutTxn;

        hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	double	dTxnAmt = 0.0;
	double	dTxnFee = 0.0;

        hPayoutTxn= (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hPayoutTxn,0);

        if(GetField_CString(hMyHash,"txn_seq",&csTmp)){
                PutField_CString(hTxn,"from_txn_seq",csTmp);
        }
        if(GetField_CString(hMyHash,"ccy",&csTmp)){
                PutField_CString(hTxn,"org_txn_ccy",csTmp);
                PutField_CString(hTxn,"src_txn_fee_ccy",csTmp);
        }
        if(GetField_Double(hMyHash,"amount",&dTmp)){
                PutField_Double(hTxn,"org_txn_amt",dTmp);
        }
        if(GetField_CString(hMyHash,"amount_type",&csTmp)){
                PutField_CString(hTxn,"amount_type",csTmp);
        }
        else{
                PutField_CString(hTxn,"amount_type",PD_DR);
        }
	if(GetField_Char(hMyHash,"party_type",&cTmp)){
		PutField_Char(hTxn,"party_type",cTmp);
	}
	else{
		PutField_Char(hTxn,"party_type",PD_TYPE_MERCHANT);
	}

	if (GetField_Int(hMyHash, "payout_bal_transfer_flag", &iPayoutBalTransfer)) {
		if (iPayoutBalTransfer == PD_TRUE) {
			if(GetField_CString(hMyHash,"txn_seq",&csTmp)){
				PutField_CString(hPayoutTxn, "from_txn_seq", csTmp);
			}

        		if(GetField_CString(hMyHash,"ccy",&csTmp)){
		                PutField_CString(hPayoutTxn,"org_txn_ccy",csTmp);
			}

        		if(GetField_Double(hMyHash,"amount",&dTxnAmt)){
        			if(GetField_Double(hMyHash,"fee",&dTxnFee)){
					dTmp = dTxnAmt + dTxnFee;
				} else {
					dTmp = dTxnAmt;
				}

                		PutField_Double(hPayoutTxn,"org_txn_amt",dTmp);
        		}
			
                	GetField_CString(hTxn,"amount_type",&csTmp);
			if (!strcmp(csTmp, PD_CR)) {
				PutField_CString(hPayoutTxn, "amount_type", PD_DR);
			} else  {
				PutField_CString(hPayoutTxn, "amount_type", PD_CR);
			}

			GetField_Char(hTxn,"party_type",&cTmp);
			PutField_Char(hPayoutTxn,"party_type",cTmp);


			if (GetField_Int(hMyHash, "payout_void_flag", &iPayoutVoidFlag)) {
				if (iPayoutVoidFlag == PD_FALSE) {
					if (prbo_AddPayoutBalTransferElement(hPayoutTxn) != PD_OK) {
						iRet = FAILURE;
					}
				}
			}
		}
	}

	if (iRet == SUCCESS) {
DEBUGLOG(("AddTxnAmtElement\n"));
	        if(prbo_AddTxnAmtElement(hTxn)!=PD_OK){
			iRet = FAILURE;
DEBUGLOG(("AddTxnAmtElement Failed\n"));
        	}
	}

        if(iRet==SUCCESS){
                if(GetField_Double(hMyHash,"fee",&dTmp)){
                        PutField_Double(hTxn,"src_txn_fee",dTmp);
                }

DEBUGLOG(("AddTxnFeeElements\n"));
                if(prbo_AddTxnFeeElements(hTxn)!=PD_OK){
                        iRet = FAILURE;
DEBUGLOG(("AddTxnFeeElements Failed\n"));
                }
        }

        if(iRet==SUCCESS){
                if(GetField_CString(hMyHash,"markup_ccy",&csTmp)){
                        PutField_CString(hTxn,"org_txn_ccy",csTmp);
                }
                if(GetField_Double(hMyHash,"markup_amt",&dTmp)){
                        PutField_Double(hTxn,"markup_amt",dTmp);
                }

                if(dTmp>0.0){
DEBUGLOG(("AddMarkupAmtElement\n"));
                        if(prbo_AddMarkupAmtElement(hTxn)!=PD_OK){
                                iRet = FAILURE;
DEBUGLOG(("AddMarkupAmtElement Failed\n"));
                        }
                }
        }

	if (iRet == SUCCESS) {
		if (iPayoutBalTransfer == PD_TRUE) {
			if (iPayoutVoidFlag == PD_TRUE) {
				if (prbo_AddPayoutBalTransferElement(hPayoutTxn) != PD_OK) {
					iRet = FAILURE;
				}
			}
		}
	}


        FREE_ME(hTxn);
	FREE_ME(hPayoutTxn);

        return iRet;
}


int UpdateVoidPOTxnStatus(const hash_t *hRls)
{
        char    *csTmp;
        char*   csBuf;

        int     iSortTxnSeq;

        EXEC SQL WHENEVER SQLERROR GOTO update_void_po_status_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

        varchar         hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("UpdateVoidPOTxnStatus: Begin\n"));
        csBuf = (char*) malloc (128);
        strcpy((char*)hv_dynstmt.arr,"update par_txn_data set ptd_update_timestamp  = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        GetField_Int(hRls,"sort_txn_seq",&iSortTxnSeq);
DEBUGLOG(("UpdateVoidPOTxnStatus:sort_txn_id = [%d]\n",iSortTxnSeq));


        if (GetField_CString(hRls, "void_po_status", &csTmp)) {
DEBUGLOG(("UpdateVoidPOTxnStatus: void_po_status = [%s]\n",csTmp));

                strcat((char*)hv_dynstmt.arr, ",ptd_po_psp_status = '");
                strcat((char*)hv_dynstmt.arr, csTmp);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }        sprintf(csBuf, "%d", iSortTxnSeq);

        strcat((char *)hv_dynstmt.arr, " WHERE ptd_txn_seq = ");
        strcat((char *)hv_dynstmt.arr, csBuf);
        //strcat((char *)hv_dynstmt.arr, "'");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
DEBUGLOG(("void po SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));

        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

        FREE_ME(csBuf);
DEBUGLOG(("UpdateVoidPOTxnStatsu Normal Exit\n"));
        return PD_OK;

update_void_po_status_error:
DEBUGLOG(("update_void_po_status_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
ERRLOG("update_void_po_status_error : SP_INTERNAL_ERR TxnAbort\n");
DEBUGLOG(("update_void_po_status_error : SP_INTERNAL_ERR TxnAbort\n"));
        return PD_INTERNAL_ERR;
}

int par_GetPspDetail(const char* csPspId,
                hash_t* hRec)
{

        EXEC SQL WHENEVER SQLERROR GOTO getpspdetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_psp_id[PD_PSP_ID_LEN];
                int             hv_disabled;

                varchar         v_status[PD_ACCOUNT_STATUS_LEN+1];
                varchar         v_name[PD_NAME_LEN + 1];
                varchar         v_psp_merchant_id[PD_MERCHANT_ID_LEN+1];
                varchar         v_psp_channel_code[PD_PSP_ID_LEN+1];
                varchar         v_client_id[PD_CLIENT_ID_LEN+1];
                char            v_txn_type;
                varchar         v_ccy[PD_CCY_ID_LEN +1];
                double          v_payout_split_limit;

                short           ind_status = -1;
                short           ind_name = -1;
                short           ind_psp_merchant_id = -1;
                short           ind_psp_channel_code = -1;
                short           ind_client_id = -1;
                short           ind_txn_type = -1;
                short           ind_ccy = -1;
                short           ind_payout_split_limit = -1;

        EXEC SQL END DECLARE SECTION;

        hv_psp_id.len = strlen(csPspId);
        memcpy(hv_psp_id.arr,csPspId,hv_psp_id.len);
DEBUGLOG(("GetPspDetail psp_id = [%d][%.*s]\n",hv_psp_id.len,hv_psp_id.len,hv_psp_id.arr));

        hv_disabled = 0;

        EXEC SQL DECLARE c_cursor_getpspdetail CURSOR FOR
                select psp_name,
                       psp_merchant_id,
                       psp_channel_code,
                       client_id,
                       txn_type,
                       currency_id,
                       status,
                       payout_split_limit
                  from psp_detail
                 where psp_id = :hv_psp_id
                 and   disabled = :hv_disabled;

        EXEC SQL OPEN c_cursor_getpspdetail;
        do {
                EXEC SQL FETCH c_cursor_getpspdetail
                INTO
                        :v_name:ind_name,
                        :v_psp_merchant_id:ind_psp_merchant_id,
                        :v_psp_channel_code:ind_psp_channel_code,
                        :v_client_id:ind_client_id,
                        :v_txn_type:ind_txn_type,
                        :v_ccy:ind_ccy,
                        :v_status:ind_status,
                        :v_payout_split_limit:ind_payout_split_limit;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }


DEBUGLOG(("GetPspDetail found record\n"));

/* psp name */
                if (ind_name >= 0) {
                        v_name.arr[v_name.len] = '\0';
                        PutField_CString(hRec,"psp_name",(const char*)v_name.arr);
DEBUGLOG(("GetPspDetail psp_name = [%s]\n",v_name.arr));
                }


/* psp merchant id */
                if (ind_psp_merchant_id >= 0) {
                        v_psp_merchant_id.arr[v_psp_merchant_id.len] = '\0';
                        PutField_CString(hRec,"psp_merchant_id",(const char*)v_psp_merchant_id.arr);
DEBUGLOG(("GetPspDetail psp_merchant_id = [%s]\n",v_psp_merchant_id.arr));
                }

/* psp channel code */
                if (ind_psp_channel_code >= 0) {
                        v_psp_channel_code.arr[v_psp_channel_code.len] = '\0';
                        PutField_CString(hRec,"psp_channel_code",(const char*)v_psp_channel_code.arr);
DEBUGLOG(("GetPspDetail psp_channel_code = [%s]\n",v_psp_channel_code.arr));
                }

/* client_id*/
                if (ind_client_id>= 0) {
                        v_client_id.arr[v_client_id.len] = '\0';
                        PutField_CString(hRec,"client_id",(const char*)v_client_id.arr);
DEBUGLOG(("GetPspDetail client_id = [%s]\n",v_client_id.arr));
                }

/* txn_type */
                if (ind_txn_type>= 0) {
                        PutField_Char(hRec,"txn_type",v_txn_type);
DEBUGLOG(("GetPspDetail txn_type = [%c]\n",v_txn_type));
                }
/* ccy*/
                if (ind_ccy>= 0) {
                        v_ccy.arr[v_ccy.len] = '\0';
                        PutField_CString(hRec,"ccy",(const char*)v_ccy.arr);
DEBUGLOG(("GetPspDetail ccy = [%s]\n",v_ccy.arr));
                }

/* status */
                if (ind_status >= 0) {
                        v_status.arr[v_status.len] = '\0';
                        PutField_CString(hRec,"status",(const char*)v_status.arr);
DEBUGLOG(("GetPspDetail status = [%s]\n",v_status.arr));
                }

/* payout_split_limit */
                if (ind_payout_split_limit < 0)
                        v_payout_split_limit = 0.0;
                PutField_Double(hRec,"payout_split_limit",v_payout_split_limit);
DEBUGLOG(("GetPspDetail payout_split_limit = [%lf]\n",v_payout_split_limit));


        }
        while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getpspdetail;


DEBUGLOG(("GetPspDetail Normal Exit\n"));
        return  PD_OK;

getpspdetail_error:
DEBUGLOG(("getpspdetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("PspDetail_Get: SP_INTERNAL_ERR TxnAbort\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getpspdetail;
        return PD_ERR;
}


int	AddTxnSeqMap(const hash_t *hRls)
{
	char	*csTmp;

        EXEC SQL WHENEVER SQLERROR GOTO add_txn_seq_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                varchar         hv_order_id[PAR_ORDER_ID_LEN];
                varchar         hv_conv_txn_seq[PD_TXN_SEQ_LEN];
                varchar         hv_create_user[PD_CREATE_USER_LEN];

                short           ind_order_id;
                short           ind_conv_txn_seq;
                short           ind_create_user;

                short           hv_return_value;
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("AddTxnSeqMap: Begin\n"));

/* order_id */
        if(GetField_CString(hRls,"order_id",&csTmp)){
                hv_order_id.len = strlen(csTmp);
                memcpy(hv_order_id.arr, csTmp, hv_order_id.len);
                ind_order_id = 0;
DEBUGLOG(("AddTxnSeqMap:order_id = [%.*s]\n",hv_order_id.len,hv_order_id.arr));
        }

/* conv_txn_seq */
        if (GetField_CString(hRls, "conv_txn_seq", &csTmp)) {
                hv_conv_txn_seq.len = strlen(csTmp);
                memcpy(hv_conv_txn_seq.arr, csTmp, hv_conv_txn_seq.len);
                ind_conv_txn_seq= 0;
DEBUGLOG(("AddTxnSeqMap:conv_txn_seq = [%.*s]\n",hv_conv_txn_seq.len,hv_conv_txn_seq.arr));
        }

/* create_user */
        if (GetField_CString(hRls, "create_user", &csTmp)) {
                hv_create_user.len = strlen(csTmp);
                memcpy(hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
DEBUGLOG(("AddTxnSeqMap: create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));
        }
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_par_txn_seq_map_insert(
                                                :hv_order_id:ind_order_id,
                                                :hv_conv_txn_seq:ind_conv_txn_seq,
                                                :hv_create_user:ind_create_user);
                END;
        END-EXEC;

DEBUGLOG(("AddTxnSeqMap:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("AddTxnSeqMap:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("AddTxnSeqMap: SP_OTHER_ERR \n");
DEBUGLOG(("AddTxnSeqMap: SP_OTHER_ERR \n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("AddTxnSeqMap: SP_ERR \n");
DEBUGLOG(("AddTxnSeqMap: SP_ERR \n"));
                return PD_ERR;
        }

add_txn_seq_error:
DEBUGLOG(("add_txn_seq_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("AddTxnSeqMap: SP_INTERNAL_ERR \n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;

}


int     TxnSeqMap_Exists(const char *csOrderId)
{
        int     iRet = PD_NOT_FOUND;

        EXEC SQL WHENEVER SQLERROR GOTO chk_txn_seq_exist_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_order_id[PAR_ORDER_ID_LEN];

                int             v_no_of_record;
                short           ind_no_of_record = -1;

        EXEC SQL END DECLARE SECTION;

        hv_order_id.len = strlen(csOrderId);
        memcpy(hv_order_id.arr, csOrderId, hv_order_id.len);
DEBUGLOG(("TxnSeqMap ChkExist order_id = [%.*s]\n",hv_order_id.len,hv_order_id.arr));


        EXEC SQL
                SELECT count(1)
                   INTO :v_no_of_record:ind_no_of_record
                   FROM par_txn_seq_map
                  WHERE ts_order_id = :hv_order_id
                    and rownum = 1;

        if (ind_no_of_record >= 0) {
                if (v_no_of_record > 0) {
DEBUGLOG(("TxnSeqMap ChkExist FOUND\n"));
                        iRet = PD_FOUND;
                }
        }

        if (iRet!= PD_FOUND) {
DEBUGLOG(("TxnSeqMap ChkExist NOT FOUND\n"));
        }

        return iRet;

chk_txn_seq_exist_error:
DEBUGLOG(("Chk_txn_seq_exist error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;

}

int     AddPORevTxnSeqMap(const hash_t *hRls)
{
        char    *csTmp;

        EXEC SQL WHENEVER SQLERROR GOTO add_po_rev_txn_seq_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                varchar         hv_vnc_ref_num[PD_TXN_SEQ_LEN];
                varchar         hv_voa_txn_seq[PD_TXN_SEQ_LEN];
                varchar         hv_create_user[PD_CREATE_USER_LEN];

                short           ind_vnc_ref_num;
                short           ind_voa_txn_seq;
                short           ind_create_user;

                short           hv_return_value;
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("AddPORevTxnSeqMap: Begin\n"));

/* vnc_ref_num */
        if(GetField_CString(hRls,"vnc_ref_num",&csTmp)){
                hv_vnc_ref_num.len = strlen(csTmp);
                memcpy(hv_vnc_ref_num.arr, csTmp, hv_vnc_ref_num.len);
                ind_vnc_ref_num= 0;
DEBUGLOG(("AddPORevTxnSeqMap:vnc_ref_num = [%.*s]\n",hv_vnc_ref_num.len,hv_vnc_ref_num.arr));
        }

/* voa_txn_seq */
        if (GetField_CString(hRls, "voa_txn_seq", &csTmp)) {
                hv_voa_txn_seq.len = strlen(csTmp);
                memcpy(hv_voa_txn_seq.arr, csTmp, hv_voa_txn_seq.len);
                ind_voa_txn_seq= 0;
DEBUGLOG(("AddPORevTxnSeqMap:voa_txn_seq = [%.*s]\n",hv_voa_txn_seq.len,hv_voa_txn_seq.arr));
        }

/* create_user */
        if (GetField_CString(hRls, "add_user", &csTmp)) {
                hv_create_user.len = strlen(csTmp);
                memcpy(hv_create_user.arr, csTmp, hv_create_user.len);
                ind_create_user = 0;
DEBUGLOG(("AddPORevTxnSeqMap: create_user = [%.*s]\n",hv_create_user.len,hv_create_user.arr));
        }
        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_par_po_rev_txn_seq_map_ins(
                                                :hv_vnc_ref_num:ind_vnc_ref_num,
                                                :hv_voa_txn_seq:ind_voa_txn_seq,
                                                :hv_create_user:ind_create_user);
                END;
        END-EXEC;

DEBUGLOG(("AddPORevTxnSeqMap:Ret = [%d]\n",hv_return_value));
        if (hv_return_value == SP_OK)
        {
DEBUGLOG(("AddPORevTxnSeqMap:Normal Exit\n"));
                return PD_OK;
        }

        if (hv_return_value == SP_OTHER_ERR)  {
ERRLOG("AddPORevTxnSeqMap: SP_OTHER_ERR \n");
DEBUGLOG(("AddPORevTxnSeqMap: SP_OTHER_ERR \n"));
                return PD_OTHER_ERR;
        }

        if (hv_return_value == SP_ERR)  {
ERRLOG("AddPORevTxnSeqMap: SP_ERR \n");
DEBUGLOG(("AddPORevTxnSeqMap: SP_ERR \n"));
                return PD_ERR;
        }


add_po_rev_txn_seq_error:
DEBUGLOG(("add_po_rev_txn_seq_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("AddPORevTxnSeqMap: SP_INTERNAL_ERR \n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return PD_ERR;

}

int     GetPORevTxnSeqByVNCRefNum(const char *csVNCRefNum, char *csVOATxnSeq)
{
        int     iRet = PD_NOT_FOUND;

        EXEC SQL WHENEVER SQLERROR GOTO get_porevtxnseqbyvncrefnum_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_vnc_ref_num[PD_TXN_SEQ_LEN];

                varchar         v_voa_txn_seq[PD_TXN_SEQ_LEN];
                short           ind_voa_txn_seq = -1;

        EXEC SQL END DECLARE SECTION;

        hv_vnc_ref_num.len = strlen(csVNCRefNum);
        memcpy(hv_vnc_ref_num.arr, csVNCRefNum, hv_vnc_ref_num.len);
DEBUGLOG(("GetPORevTxnSeqByVNCRefNum vnc_ref_num = [%.*s]\n",hv_vnc_ref_num.len,hv_vnc_ref_num.arr));

	EXEC SQL DECLARE c_cursor_getporevtxnseq CURSOR FOR
                SELECT pr_voa_txn_code
                   FROM par_po_rev_txn_seq_map
                  WHERE pr_vnc_ref_num = :hv_vnc_ref_num;


	EXEC SQL OPEN c_cursor_getporevtxnseq;

	EXEC SQL FETCH c_cursor_getporevtxnseq
	INTO
		:v_voa_txn_seq:ind_voa_txn_seq;

	if (SQLCODE == SQL_NOT_FOUND) {
DEBUGLOG(("GetPORevTxnSeqByVNCRefNum not found\n"));
		iRet = PD_NOT_FOUND;
	}

        if (ind_voa_txn_seq >= 0) {
		v_voa_txn_seq.arr[v_voa_txn_seq.len] = '\0';
		strcpy(csVOATxnSeq, (const char *) v_voa_txn_seq.arr);
DEBUGLOG(("GetPORevTxnSeqByVNCRefNum csVOATxnSeq = [%s]\n", csVOATxnSeq));

		iRet = PD_OK;
        }

	EXEC SQL CLOSE c_cursor_getporevtxnseq;

        return iRet;

get_porevtxnseqbyvncrefnum_error:
DEBUGLOG(("get_porevtxnseqbyvncrefnum error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
	EXEC SQL CLOSE c_cursor_getporevtxnseq;
        return PD_ERR;

}
