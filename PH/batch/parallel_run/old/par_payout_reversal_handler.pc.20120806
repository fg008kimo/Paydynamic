/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/07/05              LokMan Chow

*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sqlca.h>
#include <sqlcpr.h>
#include "common.h"
#include "internal.h"
#include "utilitys.h"
#include "dbutility.h"
#include "../batchcommon.h"
#include "par_payout_reversal_handler.h"
#include "pr_bo_funct.h"
#include "pr_par_funct.h"
#include "ObjPtr.h"
#include "dbutility.h"

char	cDebug;

OBJPTR(DB);

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

int	GetOrgPayoutDetailByVncRefNum(const char *csVNCRefNum,recordset_t* myRec);
int	format_rev_data(hash_t *hMyHash, hash_t *hTxnHeader, hash_t *hContext, hash_t *hRequest);
int	handle_payout_rev_balance(hash_t *hMyHash);
int     AddRevTxnLog(const hash_t *hContext,
                const hash_t* hRequest);
int     UpdateRevTxnLog(const hash_t *hContext,
                const hash_t* hRequest,
                const hash_t* hResponse);
int	add_rev_txn_element(hash_t *hMyHash);  
int	UpdateMerchantUploadFileDetail(const hash_t *hRls);
int	GetOrgPayoutGenerateId(const hash_t* hRec,recordset_t* myRec);

int payout_reversal_handler(hash_t *hMyHash)
{
	int iRet = SUCCESS;
	int iTmpRet;
	int iTmp;
	int iToPsp = PD_FALSE;
	double	dTmp;

	hash_t          *hTxnHeader;

	recordset_t     *rRecordSet;
	hash_t          *hRec;

	char    *csTmp = NULL;

	char    *csMerchNmb = NULL;
	char    *csVNCRefNum = NULL;

	int     iRecExists = PD_FALSE;
	char    *csTxnSeq;

	hash_t  *hContext, *hRequest, *hResponse;

	hTxnHeader = (hash_t *)malloc(sizeof(hash_t));
	hash_init (hTxnHeader, 0);

	hContext = (hash_t *)malloc(sizeof(hash_t));
	hRequest = (hash_t *)malloc(sizeof(hRequest));
	hResponse = (hash_t *)malloc(sizeof(hResponse));

        hash_init (hContext, 0);
        hash_init (hRequest, 0);
        hash_init (hResponse, 0);

	// Chk PH MID
	if (GetField_CString(hMyHash, "txn_merch_nmb", &csMerchNmb)) {
DEBUGLOG(("payout_reversal_handler: txn_merch_nmb [%s]\n", csMerchNmb));
	}
	else {
DEBUGLOG(("payout_reversal_handler: txn_merch_nmb missing!\n"));
		iRet = FAILURE;
	}

	rRecordSet = (recordset_t *)malloc(sizeof(recordset_t));

	recordset_init(rRecordSet, 0);
	if (iRet == SUCCESS) {

		DBObjPtr = CreateObj(DBPtr, "DBParMerchProfile", "GetMerchant");
		if ((unsigned long) (*DBObjPtr)(csMerchNmb, rRecordSet) != PD_OK) {
DEBUGLOG(("Calling ParMerchProfile.GetMerchant FAILED!\n"));
		} else {
DEBUGLOG(("Calling ParMerchProfile.GetMerchant SUCC!\n"));

			hRec = RecordSet_GetFirst(rRecordSet);
			while (hRec) {

				if (GetField_CString(hRec, "service", &csTmp)) {
DEBUGLOG(("payout_reversal_handler: ParMerchProfile.GetMerchant service [%s]!\n", csTmp));
					PutField_CString(hMyHash, "service", csTmp);
				}

				if (GetField_CString(hRec, "merchant_id", &csTmp)) {
DEBUGLOG(("payout_reversal_handler: ParMerchProfile.GetMerchant merchant_id [%s]!\n", csTmp));
					PutField_CString(hMyHash, "merchant_id", csTmp);
				}

				if (GetField_CString(hRec, "client_id", &csTmp)) {
DEBUGLOG(("payout_reversal_handler: ParMerchProfile.GetMerchant client_id [%s]!\n", csTmp));
					PutField_CString(hMyHash, "merchant_client_id", csTmp);
				}
				hRec = RecordSet_GetNext(rRecordSet);
			}
		}
	}
	RecordSet_Destroy(rRecordSet);



	// Chk if exists in txn_header
	if (iRet == SUCCESS) {
		if (GetField_CString(hMyHash, "txn_nmb", &csVNCRefNum)) {
DEBUGLOG(("payout_reversal_handler: txn_nmb [%s]\n", csVNCRefNum));
		}
		else {
DEBUGLOG(("payout_reversal_handler: txn_nmb not found!\n"));
			iRet = FAILURE;
		}
	}

	if (iRet == SUCCESS) {
		DBObjPtr = CreateObj(DBPtr,"DBParTxnData","ChkExist");
		iTmpRet = ((unsigned long)(*DBObjPtr)(csVNCRefNum));

		if (iTmpRet == PD_FOUND) {
			iRecExists = PD_TRUE;

		} else if (iTmpRet == PD_NOT_FOUND) {
			iRecExists = PD_FALSE;

		} else {
DEBUGLOG(("payout_reversal_handler: DBParTxnData:ChkExist FAILED!\n"));
			iRet = FAILURE;
		}
	}
/*
	if(iRet == SUCCESS){
		if (GetField_CString(hMyHash, "psp_type_code", &csTmp)) {
DEBUGLOG(("payout_reversal_handler: psp_id mapping\n"));

			DBObjPtr = CreateObj(DBPtr,"DBParPspClientMap","GetPspID");
			if ((unsigned long)(*DBObjPtr)(hMyHash) == FOUND) {
				if (GetField_CString(hMyHash, "psp_id", &csTmp)) {
DEBUGLOG(("payout_reversal_handler: psp_id [%s]\n", csTmp));
					PutField_CString(hMyHash, "psp_id", csTmp);
				}
			}
			else {
DEBUGLOG(("payout_reversal_handler: DBParPspClientMap.GetPspID FAIL!\n"));

				iRet = FAILURE;
			}
		}
	}
*/

////////if txn exist before, do nothing and return iRet
////////else add new txn

	if(iRet == SUCCESS &&
	   iRecExists != PD_TRUE){
		csTxnSeq = strdup((char* )GetNextMgtTxnSeq());
		PutField_CString(hMyHash,"txn_seq",csTxnSeq);
DEBUGLOG(("payout_reversal_handler: Generate (MGT) Txn Seq [%s]\n", csTxnSeq));

		PutField_CString(hTxnHeader, "txn_id", csTxnSeq);

		PutField_CString(hMyHash, "channel_code", "MGT");
		PutField_CString(hMyHash, "process_type", "0000");
		PutField_CString(hMyHash, "process_code", "000000");
		PutField_CString(hMyHash, "vnc_ref_num", csVNCRefNum);
		PutField_Int(hMyHash, "internal_code", 0);
                PutField_CString(hMyHash, "response_code", "0");

		iRet = format_rev_data(hMyHash, hTxnHeader, hContext, hRequest);

		if (iRet == SUCCESS) {
			if (AddRevTxnLog(hContext, hRequest) == PD_OK) {
DEBUGLOG(("payout_reversal_handler:AddRevTxnLog  SUCC!\n"));

				DBObjPtr = CreateObj(DBPtr,"DBParTxnData","UpdateHeaderVNCRef");
				if ((unsigned long)(*DBObjPtr)(hContext) == PD_OK) {
DEBUGLOG(("payout_reversal_handler:Deposit init record updated vnc_ref_num succ!\n"));
				}
				else {
DEBUGLOG(("payout_reversal_handler:Deposit init record updated vnc_ref_num fail!\n"));
					iRet = FAILURE;
				}

			}
			else {
DEBUGLOG(("payout_reversal_handler:AddRevTxnLog FAIL!\n"));
				iRet = FAILURE;
			}
		}

//////check merchant_upload_file_detail
		if(iRet == SUCCESS){
			recordset_init(rRecordSet, 0);
			if(GetOrgPayoutDetailByVncRefNum(csVNCRefNum,rRecordSet)==PD_OK){
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if(GetField_CString(hRec,"batch_id",&csTmp)){
						PutField_CString(hMyHash, "batch_id", csTmp);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum batch_id = [%s]\n",csTmp));
					}
					if(GetField_Int(hRec,"seq_num",&iTmp)){
						PutField_Int(hMyHash, "seq_num", iTmp);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum seq_num = [%d]\n",iTmp));
					}
					if(GetField_CString(hRec,"psp_id",&csTmp)){
						PutField_CString(hMyHash, "psp_id", csTmp);
						iToPsp = PD_TRUE;
						PutField_Int(hMyHash, "to_psp", iToPsp);
						PutField_Int(hContext, "to_psp", iToPsp);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum psp_id = [%s]\n",csTmp));
					}
					if(GetField_CString(hRec,"txn_id",&csTmp)){
						PutField_CString(hContext, "payout_txn_id", csTmp);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum txn_id = [%s]\n",csTmp));
					}
					if(GetField_CString(hRec,"file_id",&csTmp)){
						PutField_CString(hMyHash, "file_id", csTmp);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum file_id = [%s]\n",csTmp));
					}
					if(GetField_CString(hRec,"country",&csTmp)){
						PutField_CString(hMyHash, "country", csTmp);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum country = [%s]\n",csTmp));
					}
					if(GetField_CString(hRec,"request_ccy",&csTmp)){
						PutField_CString(hMyHash, "ccy", csTmp);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum request_ccy = [%s]\n",csTmp));
					}
					if(GetField_Double(hRec,"request_amount",&dTmp)){
						PutField_Double(hMyHash,"request_amount",dTmp);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum request_amount = [%lf]\n",dTmp));
					}
					if(GetField_CString(hRec,"payout_ccy",&csTmp)){
						PutField_CString(hMyHash, "to_ccy", csTmp);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum payout_ccy = [%s]\n",csTmp));
					}
					if(GetField_Double(hRec,"payout_amount",&dTmp)){
						PutField_Double(hMyHash,"payout_amount",dTmp);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum payout_amount = [%lf]\n",dTmp));
					}
					if(GetField_CString(hRec,"merchant_fee_ccy",&csTmp)){
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum merchant_fee_ccy = [%s]\n",csTmp));
					}
					if(GetField_Double(hRec,"merchant_fee",&dTmp)){
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum merchant_fee = [%lf]\n",dTmp));
						PutField_Double(hMyHash,"merchant_fee",dTmp);
					}
					if(GetField_CString(hRec,"member_fee_ccy",&csTmp)){
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum member_fee_ccy = [%s]\n",csTmp));
					}
					if(GetField_Double(hRec,"member_fee",&dTmp)){
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum member_fee = [%lf]\n",dTmp));
						PutField_Double(hMyHash,"member_fee",dTmp);
					}
					if(GetField_CString(hRec,"markup_ccy",&csTmp)){
						PutField_CString(hMyHash, "markup_ccy", csTmp);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum markup_ccy = [%s]\n",csTmp));
					}
					if(GetField_Double(hRec,"markup_amt",&dTmp)){
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum markup_amt = [%lf]\n",dTmp));
						PutField_Double(hMyHash,"markup_amt",dTmp);
					}
	
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
			else{
DEBUGLOG(("payout_reversal_handler:GetOrgPayoutDetailByVncRefNum FAIL!\n"));
				iRet = FAILURE;
			}

			RecordSet_Destroy(rRecordSet);
		}

///Get Org Payout Detail
		if(iRet == SUCCESS && iToPsp == PD_TRUE){
			recordset_init(rRecordSet, 0);
			if(GetOrgPayoutGenerateId(hMyHash,rRecordSet)==PD_OK){
				hRec = RecordSet_GetFirst(rRecordSet);
				while (hRec) {
					if(GetField_CString(hRec,"gen_txn_id",&csTmp)){
						PutField_CString(hContext, "gen_txn_id", csTmp);
DEBUGLOG(("GetOrgPayoutGenerateId gen_txn_id = [%s]\n",csTmp));
					}
					hRec = RecordSet_GetNext(rRecordSet);
				}
			}
			else{
DEBUGLOG(("payout_reversal_handler:GetOrgPayoutGenerateId FAIL!\n"));
				iRet = FAILURE;
			}
			RecordSet_Destroy(rRecordSet);
		}

		//////handle balance
		if (iRet == SUCCESS) {
			iRet = handle_payout_rev_balance(hMyHash);
		}

		if (iRet == SUCCESS)
			PutField_Int(hMyHash, "approved", PD_TRUE);
			iRet = format_rev_data(hMyHash, hTxnHeader, hContext, hRequest);

		/////txn element
		if (iRet == SUCCESS) {
			iRet = add_rev_txn_element(hMyHash);
		}

		if (iRet == SUCCESS) {
			iRet = UpdateMerchantUploadFileDetail(hMyHash);
		}

		if (iRet == SUCCESS) {
			PutField_Char(hContext,"status",PD_COMPLETE);
			PutField_Char(hContext,"ar_ind",PD_ACCEPT);

			if (UpdateRevTxnLog(hContext, hRequest, hResponse) == PD_OK) {
DEBUGLOG(("payout_reversal_handler:UpdateRevTxnLog SUCC\n"));
			} else {
DEBUGLOG(("payout_reversal_handler:UpdateRevTxnLog FAIL\n"));
				iRet = FAILURE;
			}
		}

		FREE_ME(csTxnSeq);

	}
	else{
		//////do nothing
	}

DEBUGLOG(("payout_reversal_handler:UpdateProcessResult\n"));
	if (iRet == SUCCESS) {
		if(iRecExists == PD_TRUE)
			iRet = UpdateProcessResult(hMyHash, "SKIP");
		else
			iRet = UpdateProcessResult(hMyHash, "COMPLETE");
        }
	else{
                iRet = UpdateProcessResult(hMyHash, "FAILURE");
	}

	hash_destroy(hTxnHeader);
        FREE_ME(hTxnHeader);

        hash_destroy(hContext);
        hash_destroy(hRequest);
        hash_destroy(hResponse);

        FREE_ME(hContext);
        FREE_ME(hRequest);
        FREE_ME(hResponse);

        FREE_ME(rRecordSet);

DEBUGLOG(("payout_reversal_handler:iRet = [%d]\n",iRet));
	return iRet;
}


int GetOrgPayoutDetailByVncRefNum(const char *csVNCRefNum,recordset_t* myRec)
{
	hash_t *myHash;
	char    csBatchId[PD_TXN_SEQ_LEN+1];

        EXEC SQL WHENEVER SQLERROR GOTO getdetail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_aux_txn_seq[PD_TXN_SEQ_LEN];

		unsigned long   v_batch_id;
                int             v_seq_num;
                varchar         v_org_vnc_ref_num[PD_TXN_SEQ_LEN+1];
                varchar         v_txn_id[PD_TXN_SEQ_LEN+1];
                varchar         v_file_id[PD_TXN_SEQ_LEN+1];
                varchar         v_merchant_ref[PD_MERCHANT_REF_LEN+1];
                varchar         v_country[PD_COUNTRY_LEN+1];
                varchar         v_request_ccy[PD_CCY_ID_LEN+1];
                varchar         v_payout_ccy[PD_CCY_ID_LEN+1];
                varchar         v_member_fee_ccy[PD_CCY_ID_LEN+1];
                varchar         v_merchant_fee_ccy[PD_CCY_ID_LEN+1];
                varchar         v_markup_ccy[PD_CCY_ID_LEN+1];
                varchar         v_psp_id[PD_PSP_ID_LEN+1];
                double          v_request_amount;
                double          v_payout_amount;
                double          v_member_fee;
                double          v_merchant_fee;
                double          v_markup_amt;
                double          v_ex_rate;

                short           ind_batch_id = -1;
		short           ind_seq_num = -1;
                short           ind_txn_id = -1;
                short           ind_file_id = -1;
                short           ind_org_vnc_ref_num = -1;
                short           ind_merchant_ref = -1;
                short           ind_country = -1;
                short           ind_request_ccy = -1;
                short           ind_payout_ccy = -1;
                short           ind_member_fee_ccy = -1;
                short           ind_merchant_fee_ccy = -1;
                short           ind_markup_ccy = -1;
                short           ind_psp_id = -1;
                short           ind_request_amount = -1;
                short           ind_payout_amount = -1;
                short           ind_member_fee = -1;
                short           ind_merchant_fee = -1;
                short           ind_markup_amt = -1;
                short           ind_ex_rate = -1;

	EXEC SQL END DECLARE SECTION;


        hv_aux_txn_seq.len = strlen(csVNCRefNum);
        memcpy(hv_aux_txn_seq.arr,csVNCRefNum,hv_aux_txn_seq.len);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum aux_txn_seq = [%.*s]\n",hv_aux_txn_seq.len,hv_aux_txn_seq.arr));

	EXEC SQL DECLARE c_cursor_getdetail CURSOR FOR
                select  ud_batch_id,
                        ud_seq_num,
			ud_txn_id,
			ud_generated_file_id,
                        ud_vnc_ref_num,
                        ud_merchant_ref,
                        ud_country,
                        ud_psp_id,
                        ud_request_amount,
                        ud_request_currency,
                        ud_payout_amount,
                        ud_payout_currency,
                        ud_member_fee_ccy,
                        ud_member_fee,
                        ud_merchant_fee_ccy,
                        ud_merchant_fee,
                        ud_markup_ccy,
                        ud_markup_amt,
                        ud_exchange_rate
                from    merchant_upload_file_detail
                where   ud_aux_txn_id = :hv_aux_txn_seq
		order by ud_batch_id, ud_seq_num;

	EXEC SQL OPEN  c_cursor_getdetail;

        do{
                EXEC SQL FETCH c_cursor_getdetail
                INTO
                        :v_batch_id:ind_batch_id,
                        :v_seq_num:ind_seq_num,
                        :v_txn_id:ind_txn_id,
                        :v_file_id:ind_file_id,
                        :v_org_vnc_ref_num:ind_org_vnc_ref_num,
                        :v_merchant_ref:ind_merchant_ref,
                        :v_country:ind_country,
                        :v_psp_id:ind_psp_id,
                        :v_request_amount:ind_request_amount,
                        :v_request_ccy:ind_request_ccy,
                        :v_payout_amount:ind_payout_amount,
                        :v_payout_ccy:ind_payout_ccy,
                        :v_member_fee_ccy:ind_member_fee_ccy,
                        :v_member_fee:ind_member_fee,
                        :v_merchant_fee_ccy:ind_merchant_fee_ccy,
                        :v_merchant_fee:ind_merchant_fee,
                        :v_markup_ccy:ind_markup_ccy,
                        :v_markup_amt:ind_markup_amt,
                        :v_ex_rate:ind_ex_rate;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

		myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

                if(ind_batch_id>=0){
                        sprintf(csBatchId,"%ld",v_batch_id);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum batch_id=[%ld]\n",v_batch_id));
                        PutField_CString(myHash,"batch_id",csBatchId);
                }

                if(ind_seq_num>=0){
                        PutField_Int(myHash,"seq_num",v_seq_num);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum seq_num=[%d]\n",v_seq_num));
                }

                if(ind_txn_id>=0){
                        v_txn_id.arr[v_txn_id.len]='\0';
                        PutField_CString(myHash,"txn_id",(const char*)v_txn_id.arr);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum txn_id=[%s]\n",v_txn_id.arr));
                }

                if(ind_file_id>=0){
                        v_file_id.arr[v_file_id.len]='\0';
                        PutField_CString(myHash,"file_id",(const char*)v_file_id.arr);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum file_id=[%s]\n",v_file_id.arr));
                }

                if(ind_org_vnc_ref_num>=0){
                        v_org_vnc_ref_num.arr[v_org_vnc_ref_num.len]='\0';
                        PutField_CString(myHash,"org_vnc_ref_num",(const char*)v_org_vnc_ref_num.arr);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum org_vnc_ref_num=[%s]\n",v_org_vnc_ref_num.arr));
                }


                if(ind_merchant_ref>=0){
                        v_merchant_ref.arr[v_merchant_ref.len]='\0';
                        PutField_CString(myHash,"merchant_ref",(const char*)v_merchant_ref.arr);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum merchant_ref= [%s]\n",v_merchant_ref.arr));
                }

                if(ind_country>=0){
                        v_country.arr[v_country.len]='\0';
                        PutField_CString(myHash,"country",(const char*)v_country.arr);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum country= [%s]\n",v_country.arr));
                }

                if(ind_request_ccy>=0){
                        v_request_ccy.arr[v_request_ccy.len]='\0';
                        PutField_CString(myHash,"request_ccy",(const char*)v_request_ccy.arr);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum request_ccy= [%s]\n",v_request_ccy.arr));
                }

                if(ind_request_amount>=0){
                        PutField_Double(myHash,"request_amount",v_request_amount);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum request_amount = [%lf]\n",v_request_amount));
        }

                if(ind_payout_ccy>=0){
                        v_payout_ccy.arr[v_payout_ccy.len]='\0';
                        PutField_CString(myHash,"payout_ccy",(const char*)v_payout_ccy.arr);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum payout_ccy= [%s]\n",v_payout_ccy.arr));
                }

                if(ind_payout_amount>=0){
                        PutField_Double(myHash,"payout_amount",v_payout_amount);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum payout_amount = [%lf]\n",v_payout_amount));
        }

                if(ind_member_fee_ccy>=0){
                        v_member_fee_ccy.arr[v_member_fee_ccy.len]='\0';
                        PutField_CString(myHash,"member_fee_ccy",(const char*)v_member_fee_ccy.arr);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum member_fee_ccy= [%s]\n",v_member_fee_ccy.arr));
                }

                if(ind_member_fee>=0){
                        PutField_Double(myHash,"member_fee",v_member_fee);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum member_fee = [%lf]\n",v_member_fee));
                }

                if(ind_merchant_fee_ccy>=0){
                        v_merchant_fee_ccy.arr[v_merchant_fee_ccy.len]='\0';
                        PutField_CString(myHash,"merchant_fee_ccy",(const char*)v_merchant_fee_ccy.arr);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum merchant_fee_ccy= [%s]\n",v_merchant_fee_ccy.arr));
                }

                if(ind_merchant_fee>=0){
                        PutField_Double(myHash,"merchant_fee",v_merchant_fee);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum merchant_fee = [%lf]\n",v_merchant_fee));
                }

                if(ind_markup_ccy>=0){
                        v_markup_ccy.arr[v_markup_ccy.len]='\0';
                        PutField_CString(myHash,"markup_ccy",(const char*)v_markup_ccy.arr);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum markup_ccy= [%s]\n",v_markup_ccy.arr));
                }

                if(ind_markup_amt>=0){
                        PutField_Double(myHash,"markup_amt",v_markup_amt);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum markup_amt = [%lf]\n",v_markup_amt));
                }

                if(ind_ex_rate>=0){
                        PutField_Double(myHash,"ex_rate",v_ex_rate);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum ex_rate = [%lf]\n",v_ex_rate));
                }

                if(ind_psp_id>=0){
                        v_psp_id.arr[v_psp_id.len]='\0';
                        PutField_CString(myHash,"psp_id",(const char*)v_psp_id.arr);
DEBUGLOG(("GetOrgPayoutDetailByVncRefNum psp_id = [%s]\n",v_psp_id.arr));
                }

		RecordSet_Add(myRec,myHash);

        }while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getdetail;

DEBUGLOG(("GetOrgPayoutDetailByVncRefNum Normal Exit\n"));
        return  PD_OK;

getdetail_error:
DEBUGLOG(("getdetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("par_payout_reversal_handler_GetOrgPayoutDetailByVncRefNum: SP_ERR\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getdetail;
        return PD_ERR;
	
}


int GetOrgPayoutGenerateId(const hash_t* hRec,recordset_t* myRec)
{
	hash_t *myHash;
        char*   csTmp;
    
        EXEC SQL WHENEVER SQLERROR GOTO getid_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar		hv_txn_id[PD_TXN_SEQ_LEN];
                varchar		hv_file_id[PD_TXN_SEQ_LEN];
    
                varchar         v_gen_txn_id[PD_TXN_SEQ_LEN+1];

		short		ind_gen_txn_id=-1;

	EXEC SQL END DECLARE SECTION;

        if(GetField_CString(hRec,"file_id",&csTmp)){
		hv_file_id.len = strlen(csTmp);
		memcpy(hv_file_id.arr, csTmp, hv_file_id.len);
DEBUGLOG(("GetOrgPayoutGenerateId file_id = [%.*s]\n",hv_file_id.len,hv_file_id.arr));
	}

        if(GetField_CString(hRec,"txn_id",&csTmp)){
		hv_txn_id.len = strlen(csTmp);
		memcpy(hv_txn_id.arr, csTmp, hv_txn_id.len);
DEBUGLOG(("GetOrgPayoutGenerateId txn_id = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));
	}

	EXEC SQL DECLARE c_cursor_getid CURSOR FOR
                select
			fd_gen_txn_id
                from    payout_generated_file_dt
                where   fd_file_id =:hv_file_id
                and     fd_txn_id = :hv_txn_id;

	EXEC SQL OPEN  c_cursor_getid;
        do{
                EXEC SQL FETCH c_cursor_getid
                INTO
			:v_gen_txn_id:ind_gen_txn_id;

		if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

                myHash = (hash_t*) malloc (sizeof(hash_t));
                hash_init(myHash,0);

/*gen_txn_id*/
                if(ind_gen_txn_id>=0){
                        v_gen_txn_id.arr[v_gen_txn_id.len]='\0';
                        PutField_CString(myHash,"gen_txn_id",(const char*)v_gen_txn_id.arr);
DEBUGLOG(("GetOrgPayoutGenerateId gen_txn_id= [%s]\n",v_gen_txn_id.arr));
                }

		RecordSet_Add(myRec,myHash);

        }while(PD_TRUE);

        EXEC SQL CLOSE c_cursor_getid;

DEBUGLOG(("GetOrgPayoutGenerateId Normal Exit\n"));
        return  PD_OK;

getid_error:
DEBUGLOG(("getid_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("par_payout_reversal_handler_GetOrgPayoutGenerateId: SP_INTERNAL_ERR\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        EXEC SQL CLOSE c_cursor_getid;
        return PD_ERR;
}



int format_rev_data(hash_t *hMyHash, hash_t *hTxnHeader, hash_t *hContext, hash_t *hRequest)
{
	int     iRet = SUCCESS;
        char*   csTmp;

        char    *csTxnDateTime;
        char    csDate[PD_DATE_LEN + 1];
        char    csTime[PD_TIME_LEN + 1];
	char    csCcy[PD_CCY_ID_LEN+1];;
        double  dTxnAmount = 0.0;
        double  dTmp = 0.0;
        double  dFee = 0.0;
        double  dNetAmount = 0.0;
	int	iTmp;

        if (GetField_CString(hTxnHeader, "txn_id", &csTmp)) {
DEBUGLOG(("format_rev_data txn_id [%s]\n", csTmp));
                PutField_CString(hContext, "txn_seq", csTmp);
        }

        if (GetField_CString(hMyHash, "channel_code", &csTmp)) {
DEBUGLOG(("format_rev_data channel_code [%s]\n", csTmp));
                PutField_CString(hContext, "channel_code", csTmp);
        }

        if (GetField_CString(hMyHash, "txn_code", &csTmp)) {
DEBUGLOG(("format_rev_data txn_code [%s]\n", csTmp));
                PutField_CString(hContext, "txn_code", csTmp);
        }

        if (GetField_CString(hMyHash, "post_date", &csTmp)) {
DEBUGLOG(("format_rev_data post_date [%s]\n", csTmp));
                PutField_CString(hContext, "PHDATE", csTmp);
        }

        if (GetField_CString(hMyHash, "local_tm_date", &csTmp)) {
DEBUGLOG(("format_rev_data local_tm_date [%s]\n", csTmp));
                PutField_CString(hContext, "local_tm_date", csTmp);
        }

	if (GetField_CString(hMyHash, "local_tm_time", &csTmp)) {
DEBUGLOG(("format_rev_data local_tm_time [%s]\n", csTmp));
                PutField_CString(hContext, "local_tm_time", csTmp);
        }

        if (GetField_CString(hMyHash, "process_type", &csTmp)) {
DEBUGLOG(("format_rev_data process_type [%s]\n", csTmp));
                PutField_CString(hRequest, "process_type", csTmp);
        }

        if (GetField_CString(hMyHash, "process_code", &csTmp)) {
DEBUGLOG(("format_rev_data process_code [%s]\n", csTmp));
                PutField_CString(hRequest, "process_code", csTmp);
        }

        if (GetField_CString(hMyHash, "merchant_id", &csTmp)) {
DEBUGLOG(("format_rev_data merchant_id [%s]\n", csTmp));
                PutField_CString(hRequest, "merchant_id", csTmp);
        }
	if (GetField_Int(hMyHash, "internal_code", &iTmp)) {
DEBUGLOG(("format_rev_data internal_code [%d]\n", iTmp));
                PutField_Int(hContext, "internal_code", iTmp);
        }

        if (GetField_CString(hMyHash, "response_code", &csTmp)) {
DEBUGLOG(("format_rev_data response_code [%s]\n", csTmp));
                PutField_CString(hContext, "response_code", csTmp);
        }

	if (GetField_CString(hMyHash, "txn_date", &csTxnDateTime)) {
DEBUGLOG(("format_rev_data txn_date [%s]\n", csTxnDateTime));
                PutField_CString(hRequest, "transmission_datetime", csTxnDateTime);

                csDate[0] = '\0';
                csTime[0] = '\0';

                strncpy(csDate, csTxnDateTime, PD_DATE_LEN);
                strncpy(csTime, csTxnDateTime + PD_DATE_LEN, PD_TIME_LEN);
		
		csDate[PD_DATE_LEN] = '\0';
                csTime[PD_TIME_LEN] = '\0';
DEBUGLOG(("format_rev_data tm_date [%s]\n", csDate));
DEBUGLOG(("format_rev_data tm_time [%s]\n", csTime));

                PutField_CString(hRequest, "tm_date", csDate);
                PutField_CString(hRequest, "tm_time", csTime);

                PutField_CString(hMyHash, "psp_txn_date", csDate);
                PutField_CString(hMyHash, "psp_txn_time", csTime);
        }
	if (GetField_Int(hMyHash, "approved", &iTmp)) {
		if(iTmp==PD_TRUE){
DEBUGLOG(("format_data approval_date [%s]\n", csDate));
                	PutField_CString(hContext, "approval_date", csDate);
		}
        }

        if (GetField_CString(hMyHash, "service", &csTmp)) {
DEBUGLOG(("format_rev_data service [%s]\n", csTmp));
                PutField_CString(hRequest, "service_code", csTmp);
        }

        if (GetField_CString(hMyHash, "client_ip", &csTmp)) {
DEBUGLOG(("format_rev_data client_ip [%s]\n", csTmp));
                PutField_CString(hRequest, "ip_addr", csTmp);
        }

        if (GetField_CString(hMyHash, "ccy", &csTmp)) {
		if(!strcmp(csTmp,PD_CCY_ISO_RMB)){
			sprintf(csCcy,"%s",PD_CCY_ISO_CNY);
		}
		else{
			sprintf(csCcy,"%s",csTmp);
		}
DEBUGLOG(("format_rev_data ccy [%s]\n", csCcy));
                PutField_CString(hRequest, "txn_ccy", csCcy);
        }

        if (GetField_CString(hMyHash, "country", &csTmp)) {
DEBUGLOG(("format_rev_data country [%s]\n", csTmp));
                PutField_CString(hRequest, "txn_country", csTmp);
        }
        if (GetField_CString(hMyHash, "psp_id", &csTmp)) {
DEBUGLOG(("format_rev_data psp_id [%s]\n", csTmp));
                PutField_CString(hRequest, "psp_id", csTmp);
        }
        if (GetField_CString(hMyHash, "to_ccy", &csTmp)) {
		if(!strcmp(csTmp,PD_CCY_ISO_RMB)){
			sprintf(csCcy,"%s",PD_CCY_ISO_CNY);
		}
		else{
			sprintf(csCcy,"%s",csTmp);
		}
DEBUGLOG(("format_rev_data to_ccy [%s]\n", csCcy));
                PutField_CString(hRequest, "psp_ccy", csCcy);
        }
        if (GetField_Double(hMyHash, "to_amount", &dTmp)) {
DEBUGLOG(("format_rev_data psp_amount [%lf]\n", dTmp));
                PutField_Double(hRequest, "to_amount", dTmp);
        }

/*
	if (GetField_CString(hMyHash, "pay_method", &csTmp)) {
DEBUGLOG(("format_rev_data pay_method [%s]\n", csTmp));
                PutField_CString(hRequest, "pay_method", csTmp);
                PutField_CString(hContext, "selected_pay_method", csTmp);
        }
*/
        if (GetField_CString(hMyHash, "vnc_ref_num", &csTmp)) {
DEBUGLOG(("format_rev_data vnc_ref_num [%s]\n", csTmp));
                PutField_CString(hContext, "vnc_ref_num", csTmp);
        }

        if (GetField_Double(hMyHash, "amount", &dTxnAmount)) {
DEBUGLOG(("format_rev_data txn_amount [%lf]\n", dTxnAmount));
                PutField_Double(hContext, "txn_amt", dTxnAmount);
        }

        if (GetField_Double(hMyHash, "ex_rate", &dTmp)) {
DEBUGLOG(("format_rev_data ex_rate [%lf]\n", dTmp));
                PutField_Double(hContext, "ex_rate", dTmp);
        }

        if (GetField_Double(hMyHash, "fee", &dFee)) {
DEBUGLOG(("format_rev_data fee [%lf]\n", dFee));

        }

        if (dTxnAmount > 0.0) {
                dNetAmount = dTxnAmount - dFee;
DEBUGLOG(("format_rev_data net_amount [%lf]\n", dNetAmount));
                PutField_Double(hContext, "net_amt", dNetAmount);
                PutField_Double(hMyHash, "net_amt", dNetAmount);
        }


        if (GetField_CString(hMyHash, "merchant_client_id", &csTmp)) {
DEBUGLOG(("format_rev_data merchant_client_id [%s]\n", csTmp));
                PutField_CString(hContext, "merchant_client_id", csTmp);
        }

	if (GetField_Double(hMyHash, "merchant_open_bal", &dTmp)) {
DEBUGLOG(("format_rev_data merchant_open_bal [%lf]\n", dTmp));
                PutField_Double(hContext, "merchant_open_bal", dTmp);
	}

        if (GetField_Double(hMyHash, "total_float", &dTmp)) {
DEBUGLOG(("format_rev_data total_float [%lf]\n", dTmp));
                PutField_Double(hContext, "total_float", dTmp);
        }

        if (GetField_Double(hMyHash, "current_bal", &dTmp)) {
DEBUGLOG(("format_rev_data current_bal [%lf]\n", dTmp));
                PutField_Double(hContext, "current_bal", dTmp);
        }

        if (GetField_Double(hMyHash, "total_reserved_amount", &dTmp)) {
DEBUGLOG(("format_rev_data total_reserved_amount [%lf]\n", dTmp));
                PutField_Double(hContext, "total_reserved_amount", dTmp);
        }

        if (GetField_Double(hMyHash, "total_hold", &dTmp)) {
DEBUGLOG(("format_rev_data total_hold [%lf]\n", dTmp));
                PutField_Double(hContext, "total_hold", dTmp);
        }

        if (GetField_Double(hMyHash, "settlement_in_transit", &dTmp)) {
DEBUGLOG(("format_rev_data settlement_in_transit [%lf]\n", dTmp));
                PutField_Double(hContext, "settlement_in_transit", dTmp);
        }

        if (GetField_Double(hMyHash, "psp_total_float", &dTmp)) {
DEBUGLOG(("format_rev_data psp_total_float [%lf]\n", dTmp));
                PutField_Double(hContext, "psp_total_float", dTmp);
        }

        if (GetField_Double(hMyHash, "psp_bal", &dTmp)) {
DEBUGLOG(("format_rev_data psp_bal [%lf]\n", dTmp));
                PutField_Double(hContext, "psp_bal", dTmp);
        }

        if (GetField_Double(hMyHash, "psp_total_hold", &dTmp)) {
DEBUGLOG(("format_rev_data psp_total_hold [%lf]\n", dTmp));
                PutField_Double(hContext, "psp_total_hold", dTmp);
        }



        return iRet;
}



int handle_payout_rev_balance(hash_t *hMyHash)
{
        int     iRet = SUCCESS;

        char    *csMID = NULL;
        char    csCcy[PD_CCY_ID_LEN+1];
        char    csToCcy[PD_CCY_ID_LEN+1];
        char    *csCountry = NULL;
        char    *csService = NULL;
        char    *csTmp= NULL;
        double  dAmount = 0.0;
        double  dTmp = 0.0;
        int     iDayOfWeek= 0;
        double  dFee = 0.0;
        double  dNetAmt = 0.0;
	int	iToPsp = PD_FALSE;

        if (GetField_CString(hMyHash, "merchant_id", &csMID)) {
DEBUGLOG(("handle_payout_rev_balance: merchant_id [%s]\n", csMID));
        }
        else {
DEBUGLOG(("handle_payout_rev_balance: merchant_id missing\n"));
                iRet = FAILURE;
        }

        if (GetField_CString(hMyHash, "ccy", &csTmp)) {
DEBUGLOG(("handle_payout_rev_balance: ccy [%s]\n", csTmp));
		if(!strcmp(csTmp,PD_CCY_ISO_RMB)){
			sprintf(csCcy,"%s",PD_CCY_ISO_CNY);
		}
		else{
			sprintf(csCcy,"%s",csTmp);
		}
		PutField_CString(hMyHash, "ccy", csCcy);
DEBUGLOG(("handle_payout_rev_balance: ccy [%s]\n", csCcy));
        }
        else {
DEBUGLOG(("handle_payout_rev_balance: ccy missing\n"));
                iRet = FAILURE;
        }
        if (GetField_CString(hMyHash, "country", &csCountry)) {
DEBUGLOG(("handle_payout_rev_balance: country [%s]\n", csCountry));
        }
        else {
DEBUGLOG(("handle_payout_rev_balance: country missing\n"));
                iRet = FAILURE;
        }

        if (GetField_CString(hMyHash, "service", &csService)) {
DEBUGLOG(("handle_payout_rev_balance: service [%s]\n", csService));
        }
        else {
DEBUGLOG(("handle_payout_rev_balance: service missing\n"));
                iRet = FAILURE;
        }

        if (GetField_Double(hMyHash, "amount", &dAmount)) {
DEBUGLOG(("handle_payout_rev_balance: amount [%lf]\n", dAmount));
		dNetAmt += dAmount;
        }
        else {
DEBUGLOG(("handle_payout_rev_balance: amount missing\n"));
                iRet = FAILURE;
        }

        if (GetField_Double(hMyHash, "fee", &dFee)) {
DEBUGLOG(("handle_payout_rev_balance: fee[%lf]\n", dFee));
		dNetAmt -= dFee;
        }
        else {
DEBUGLOG(("handle_payout_rev_balance: fee missing\n"));
                iRet = FAILURE;
        }

	if(GetField_Int(hMyHash,"to_psp",&iToPsp)){
DEBUGLOG(("handle_payout_rev_balance: to_psp [%d]\n", iToPsp));
	}

	if(iToPsp == PD_TRUE){
        	if (GetField_CString(hMyHash, "psp_id", &csTmp)) {
DEBUGLOG(("handle_payout_rev_balance: psp_id [%s]\n", csTmp));
        	}
        	else {
DEBUGLOG(("handle_payout_rev_balance: psp_id missing\n"));
        	        iRet = FAILURE;
        	}

        	if (GetField_CString(hMyHash, "to_ccy", &csTmp)) {
DEBUGLOG(("handle_payout_rev_balance: to_ccy [%s]\n", csTmp));
			if(!strcmp(csTmp,PD_CCY_ISO_RMB)){
				sprintf(csToCcy,"%s",PD_CCY_ISO_CNY);
			}
			else{
				sprintf(csToCcy,"%s",csTmp);
			}
			PutField_CString(hMyHash, "to_ccy", csToCcy);
DEBUGLOG(("handle_payout_rev_balance: to_ccy [%s]\n", csToCcy));
        	}
        	else {
DEBUGLOG(("handle_payout_rev_balance: to_ccy missing\n"));
        	        iRet = FAILURE;
        	}
        	if (GetField_Double(hMyHash, "to_amount", &dTmp)) {
DEBUGLOG(("handle_payout_rev_balance: to_amount [%lf]\n", dTmp));
			PutField_Double(hMyHash,"dst_net_amt",dTmp);
        	}
        	else {
DEBUGLOG(("handle_payout_rev_balance: to_amount missing\n"));
        	        iRet = FAILURE;
        	}

		PutField_Char(hMyHash,"party_type",PD_TYPE_GLOBAL);
	}
	else{
		PutField_Char(hMyHash,"party_type",PD_TYPE_MERCHANT);
	}

	if (GetField_CString(hMyHash, "post_date", &csTmp)) {
		iDayOfWeek = day_of_week((const unsigned char*)csTmp);
		PutField_Int(hMyHash,"day_of_week",iDayOfWeek);
	}

	PutField_Double(hMyHash,"net_amt",dNetAmt);
	PutField_Char(hMyHash,"response_mode",PD_REVERSED);

	if (iRet == SUCCESS) {
                if (GetOpenBalanceForUpdate(hMyHash, csMID, csCcy, csCountry, csService) == PD_OK) {
                        if (GetField_Double(hMyHash, "merchant_open_bal", &dTmp)) {
DEBUGLOG(("handle_payout_rev_balance: merchant_open_bal [%lf]\n", dTmp));
                        }
                }
                else {
DEBUGLOG(("handle_payout_rev_balance: GetOpenBalanceForUpdate FAIL!\n"));
                        iRet = FAILURE;
                }
        }

        if (iRet == SUCCESS) {
		if (UpdatePayoutAmount(hMyHash) == PD_OK) {
			if (GetField_Double(hMyHash, "total_float", &dTmp)) {
DEBUGLOG(("handle_payout_rev_balance:total_float [%lf]!\n", dTmp));
			}

                        if (GetField_Double(hMyHash, "current_bal", &dTmp)) {
DEBUGLOG(("handle_payout_rev_balance:current_bal [%lf]!\n", dTmp));
			}

			if (GetField_Double(hMyHash, "total_reserved_amount" , &dTmp)) {
DEBUGLOG(("handle_payout_rev_balance:total_reserved_amount [%lf]!\n", dTmp));
			}

			if (GetField_Double(hMyHash, "total_hold", &dTmp)) {
DEBUGLOG(("handle_payout_rev_balance:total_hold [%lf]!\n", dTmp));
			}

			if (GetField_Double(hMyHash, "settlement_in_transit", &dTmp)) {
DEBUGLOG(("handle_payout_rev_balance:settlment_in_transit [%lf]!\n", dTmp));
			}

			if (GetField_Double(hMyHash, "psp_total_float", &dTmp)) {
DEBUGLOG(("handle_payout_rev_balance:psp_total_float [%lf]!\n", dTmp));
			}

                        if (GetField_Double(hMyHash, "psp_bal", &dTmp)) {
DEBUGLOG(("handle_payout_rev_balance:psp_bal [%lf]!\n", dTmp));
			}

			if (GetField_Double(hMyHash, "psp_total_hold", &dTmp)) {
DEBUGLOG(("handle_payout_rev_balance:psp_total_hold [%lf]!\n", dTmp));
			}

		}
		else {
DEBUGLOG(("handle_payout_rev_balance: UpdatePayoutAmount FAIL!\n"));
                        iRet = FAILURE;
                }

        }
        return iRet;
}


int     AddRevTxnLog(const hash_t *hContext,
                const hash_t* hRequest)
{
        hash_t  *hTxn;
        //hash_t  *hPspDetail;
        char    *csTmp;
        char    *csTxnSeq;
	//double	dTmp;
        int iRet = PD_OK;
	int	iTmp;

        hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);
        //hPspDetail = (hash_t*)  malloc (sizeof(hash_t));
        //hash_init(hPspDetail,0);

        if (GetField_CString(hContext,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("AddRevTxnLog:: txn_seq = [%s]\n",csTxnSeq));
                PutField_CString(hTxn,"txn_seq",csTxnSeq);
                //PutField_CString(hPspDetail,"txn_seq",csTxnSeq);

                if (GetField_CString(hContext,"add_user",&csTmp)) {
DEBUGLOG(("AddRevTxnLog:: add_user = [%s]\n",csTmp));
                        PutField_CString(hTxn,"add_user",csTmp);
                        //PutField_CString(hPspDetail,"add_user",csTmp);
                }
                else{
                        PutField_CString(hTxn,"add_user",PD_UPDATE_USER);
                        //PutField_CString(hPspDetail,"add_user",PD_UPDATE_USER);
                }
		if (GetField_CString(hRequest,"process_code",&csTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: process_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"process_code",csTmp);
                }
                if (GetField_CString(hRequest,"process_type",&csTmp)) {
DEBUGLOG(("PayoutAddTxnLog:: process_type = [%s]\n",csTmp));
                        PutField_CString(hTxn,"process_type",csTmp);
                }

                if (GetField_CString(hContext,"channel_code",&csTmp)) {
DEBUGLOG(("AddRevTxnLog:: channel_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"channel_code",csTmp);
                }
                if (GetField_CString(hRequest,"merchant_id",&csTmp)) {
DEBUGLOG(("AddRevTxnLog:: merchant_id = [%s]\n",csTmp));
                        PutField_CString(hTxn,"merchant_id",csTmp);
                }
                if (GetField_CString(hRequest,"service_code",&csTmp)) {
DEBUGLOG(("AddRevTxnLog:: service_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"service_code",csTmp);
                }
                if (GetField_CString(hContext,"txn_code",&csTmp)) {
DEBUGLOG(("AddRevTxnLog:: txn_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"txn_code",csTmp);
                }
		if (GetField_CString(hContext,"response_code",&csTmp)) {
DEBUGLOG(("AddRevTxnLog:: response_code = [%s]\n",csTmp));
                        PutField_CString(hTxn,"response_code",csTmp);
                }

                if (GetField_Int(hContext,"internal_code",&iTmp)) {
DEBUGLOG(("AddRevTxnLog:: internal_code = [%d]\n",iTmp));
                        PutField_Int(hTxn,"internal_code",iTmp);
                }

                if (GetField_CString(hContext,"PHDATE",&csTmp)) {
DEBUGLOG(("AddRevTxnLog:: host_posting_date = [%s]\n",csTmp));
                        PutField_CString(hTxn,"host_posting_date",csTmp);
                        PutField_CString(hTxn,"transmission_datetime",csTmp);
                        PutField_CString(hTxn,"tm_date",csTmp);
                        //PutField_CString(hPspDetail,"txn_date",csTmp);
                }
                if (GetField_CString(hContext,"local_tm_date",&csTmp)) {
DEBUGLOG(("AddRevTxnLog:: local_tm_date = [%s]\n",csTmp));
                        PutField_CString(hTxn,"local_tm_date",csTmp);
                }
                if (GetField_CString(hContext,"local_tm_time",&csTmp)) {
DEBUGLOG(("AddRevTxnLog:: local_tm_time = [%s]\n",csTmp));
                        PutField_CString(hTxn,"local_tm_time",csTmp);
                }

/* request */
                /* client ip */
                if (GetField_CString(hRequest,"ip_addr",&csTmp)) {
DEBUGLOG(("AddRevTxnLog:: client_ip = [%s]\n",csTmp));
                        PutField_CString(hTxn,"ip_addr",csTmp);
                }

                PutField_Char(hTxn,"status",PD_PROCESSING);

		PutField_Int(hTxn,"db_commit",PD_FALSE);
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Add");
                iRet = (unsigned long) ((*DBObjPtr)(hTxn));

                char *csTxnCcy, *csTxnCountry;
                if (GetField_CString(hRequest,"txn_ccy",&csTxnCcy) && iRet == PD_OK) {
DEBUGLOG(("AddRevTxnLog:: txn_ccy = [%s]\n",csTxnCcy));
                        hash_t* hDetail;
                        hDetail = (hash_t*)  malloc (sizeof(hash_t));
                        hash_init(hDetail,0);

                        PutField_CString(hDetail,"txn_seq",csTxnSeq);
                        PutField_CString(hDetail,"txn_ccy",csTxnCcy);

                        if (GetField_CString(hTxn, "add_user", &csTmp)) {
                                PutField_CString(hDetail,"add_user",csTmp);
                        }

                        if (GetField_CString(hRequest,"txn_country",&csTxnCountry))
                                PutField_CString(hDetail,"txn_country",csTxnCountry);
                        DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
                        iRet = (unsigned long) ((*DBObjPtr)(hDetail));

                        hash_destroy(hDetail);
                        FREE_ME(hDetail);
                }
/*
		if(iRet == PD_OK){
			if (GetField_CString(hRequest,"psp_id",&csTmp)) {
DEBUGLOG(("AddRevTxnLog:: psp_id = [%s]\n",csTmp));
				PutField_CString(hPspDetail,"psp_id",csTmp);
			}
			if (GetField_CString(hRequest,"psp_ccy",&csTmp)) {
DEBUGLOG(("AddRevTxnLog:: psp_ccy = [%s]\n",csTmp));
				PutField_CString(hPspDetail,"txn_ccy",csTmp);
			}
			if (GetField_Double(hRequest,"to_amount",&dTmp)) {
DEBUGLOG(("AddRevTxnLog:: psp_amount = [%lf]\n",dTmp));
				PutField_Double(hPspDetail,"txn_amt",dTmp);
			}
			PutField_CString(hPspDetail,"desc","Void Payout");
	
                        DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Add");
                        iRet = (unsigned long) ((*DBObjPtr)(hPspDetail));
		}

*/
        }
        else
                iRet = PD_ERR;

        hash_destroy(hTxn);
        FREE_ME(hTxn);
	//hash_destroy(hPspDetail);
	//FREE_ME(hPspDetail);
        FREE_ME(csTmp);
DEBUGLOG(("AddRevTxnLog RET = [%d]\n",iRet));
        return  iRet;
}

int     UpdateRevTxnLog(const hash_t *hContext,
                const hash_t* hRequest,
                const hash_t* hResponse)
{
        hash_t  *hTxn;
        hash_t  *hPspDetail;
        char    *csTxnSeq;

        int     iRet = PD_OK;
        int     iToPsp = PD_FALSE;
        char    cTmp;
        double  dTmp;
        char*   csPtr;

        hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);
        hPspDetail= (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hPspDetail,0);


        if (GetField_CString(hContext,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("UpdateRevTxnLog:: txn_seq = [%s]\n",csTxnSeq));
                PutField_CString(hTxn,"txn_seq",csTxnSeq);
                PutField_CString(hPspDetail,"txn_seq",csTxnSeq);

                if (GetField_CString(hContext,"update_user",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: add_user = [%s]\n",csPtr));
                        PutField_CString(hTxn,"update_user",csPtr);
                        PutField_CString(hPspDetail,"update_user",csPtr);
                }
                else{
                        PutField_CString(hTxn,"update_user",PD_UPDATE_USER);
                        PutField_CString(hPspDetail,"update_user",PD_UPDATE_USER);
                }

                if (GetField_CString(hContext,"gen_txn_id",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: org_txn_seq = [%s]\n",csPtr));
                        PutField_CString(hTxn,"org_txn_seq",csPtr);
                }
		else if(GetField_CString(hContext,"payout_txn_id",&csPtr)){
DEBUGLOG(("UpdateRevTxnLog:: org_txn_seq = [%s]\n",csPtr));
                        PutField_CString(hTxn,"org_txn_seq",csPtr);
		}

                if (GetField_CString(hContext,"process_code",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: process_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"process_code",csPtr);
                }
                if (GetField_CString(hContext,"process_type",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: process_type = [%s]\n",csPtr));
                        PutField_CString(hTxn,"process_type",csPtr);
                }
                if (GetField_Char(hContext,"status",&cTmp)) {
DEBUGLOG(("UpdateRevTxnLog:: status = [%c]\n",cTmp));
                        PutField_Char(hTxn,"status",cTmp);
                }
                if (GetField_CString(hContext,"sub_status",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: sub_status = [%s]\n",csPtr));
                        PutField_CString(hTxn,"sub_status",csPtr);
                }

                if (GetField_Char(hContext,"ar_ind",&cTmp)) {
DEBUGLOG(("UpdateRevTxnLog:: ar_ind = [%c]\n",cTmp));
                        PutField_Char(hTxn,"ar_ind",cTmp);
                }

                if (GetField_CString(hContext,"merchant_client_id",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: client_id = [%s]\n",csPtr));
                        PutField_CString(hTxn,"client_id",csPtr);
                }

                if (GetField_Double(hContext,"txn_amt",&dTmp)) {
DEBUGLOG(("UpdateRevTxnLog:: txn_amt = [%f]\n",dTmp));
                        PutField_Double(hTxn,"txn_amt",dTmp);
                }

                if (GetField_Double(hContext,"net_amt",&dTmp)) {
DEBUGLOG(("UpdateRevTxnLog:: net_amt = [%f]\n",dTmp));
                        PutField_Double(hTxn,"net_amt",dTmp);
                }

/* net ccy */
                if (GetField_CString(hContext,"net_ccy",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: net_ccy = [%s]\n",csPtr));
                        PutField_CString(hTxn,"net_ccy",csPtr);
                }

                if (GetField_Double(hContext,"ex_rate",&dTmp)) {
DEBUGLOG(("UpdateRevTxnLog:: ex_rate = [%f]\n",dTmp));
                        PutField_Double(hTxn,"ex_rate",dTmp);
                }

                if (GetField_Char(hContext,"ex_party",&cTmp)) {
DEBUGLOG(("UpdateRevTxnLog:: ex_supplier = [%f]\n",cTmp));
                        PutField_Char(hTxn,"ex_supplier",cTmp);
                }

/* markup ccy */
                if(GetField_CString(hContext,"markup_ccy",&csPtr)){
DEBUGLOG(("UpdateRevTxnLog:: markup_ccy = [%s]\n",csPtr));
                        PutField_CString(hTxn,"markup_ccy",csPtr);
                }
/* markup rate */
                if(GetField_Double(hContext,"markup_rate",&dTmp)){
DEBUGLOG(("UpdateRevTxnLog:: markup_rate = [%f]\n",dTmp));
                        PutField_Double(hTxn,"markup_rate",dTmp);
                }
/* markup amount */
                if(GetField_Double(hContext,"markup_amt",&dTmp)){
DEBUGLOG(("UpdateRevTxnLog:: markup_amount = [%f]\n",dTmp));
                        PutField_Double(hTxn,"markup_amt",dTmp);
                }
/* dst_txn_amt */
                if(GetField_Double(hContext,"dst_txn_amt",&dTmp)){
DEBUGLOG(("UpdateRevTxnLog:: dst_txn_amt = [%f]\n",dTmp));
                        PutField_Double(hTxn,"dst_txn_amt",dTmp);
                }

/* settlement_txn_amt */
                if(GetField_Double(hContext,"settlement_txn_amt",&dTmp)){
DEBUGLOG(("UpdateRevTxnLog:: settlement_txn_amt = [%f]\n",dTmp));
                        PutField_Double(hTxn,"settlement_txn_amt",dTmp);
                }

                if (GetField_CString(hContext,"merchant_id",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: merchant_id = [%s]\n",csPtr));
                        PutField_CString(hTxn,"merchant_id",csPtr);
                }

                if (GetField_CString(hContext,"merchant_ref",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: merchant_ref = [%s]\n",csPtr));
                        PutField_CString(hTxn,"merchant_ref",csPtr);
                }

                if (GetField_CString(hContext,"service_code",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: service_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"service_code",csPtr);
                }

                if (GetField_CString(hContext,"approval_date",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: approval_date = [%s]\n",csPtr));
                        PutField_CString(hTxn,"approval_date",csPtr);
                }

                if (GetField_CString(hContext,"new_txn_code",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: new_txn_code = [%s]\n",csPtr));
                        PutField_CString(hTxn,"txn_code",csPtr);
                }
/* update txn header */
                DBObjPtr = CreateObj(DBPtr,"DBTransaction","Update");
                iRet = (unsigned long)(*DBObjPtr)(hTxn);
        }
        else
                iRet = PD_ERR;

	if(iRet == PD_OK){
                if (GetField_CString(hRequest,"txn_country",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: txn_country = [%s]\n",csPtr));
                        PutField_CString(hTxn,"txn_country",csPtr);
                }
/* open_bal */
                if (GetField_Double(hContext,"merchant_open_bal",&dTmp)) {
                        PutField_Double(hTxn,"open_bal",dTmp);
DEBUGLOG(("UpdateRevTxnLog:: open_bal= [%f]\n",dTmp));
                }

/* current_bal */
                if (GetField_Double(hContext,"current_bal",&dTmp)) {
                        PutField_Double(hTxn,"current_bal",dTmp);
DEBUGLOG(("UpdateRevTxnLog:: current_bal= [%f]\n",dTmp));
                }

/* total_float*/
                if (GetField_Double(hContext,"total_float",&dTmp)) {
                        PutField_Double(hTxn,"total_float",dTmp);
DEBUGLOG(("UpdateRevTxnLog:: total_float= [%f]\n",dTmp));
                }

/* total_reserved_amount*/
                if (GetField_Double(hContext,"total_reserved_amount",&dTmp)) {
                        PutField_Double(hTxn,"total_reserved_amount",dTmp);
DEBUGLOG(("UpdateRevTxnLog:: total_reserved_amount= [%f]\n",dTmp));
                }

/* total_hold*/
                if (GetField_Double(hContext,"total_hold",&dTmp)) {
                        PutField_Double(hTxn,"total_hold",dTmp);
DEBUGLOG(("UpdateRevTxnLog:: total_hold= [%f]\n",dTmp));
                }

/* settlement_in_transit*/
                if (GetField_Double(hContext,"settlement_in_transit",&dTmp)) {
                        PutField_Double(hTxn,"settlement_in_transit",dTmp);
DEBUGLOG(("UpdateRevTxnLog:: settlement_in_transit= [%f]\n",dTmp));
                }

                DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                iRet = (unsigned long)(*DBObjPtr)(hTxn);
	}

	
	if(GetField_Int(hContext,"to_psp",&iToPsp)){
DEBUGLOG(("UpdateRevTxnLog: to_psp [%d]\n", iToPsp));
	}
	
	if(iRet == PD_OK && iToPsp == PD_TRUE){
		if (GetField_CString(hContext,"PHDATE",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: txn_date = [%s]\n",csPtr));
			PutField_CString(hPspDetail,"txn_date",csPtr);
		}

		if (GetField_CString(hRequest,"psp_id",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: psp_id = [%s]\n",csPtr));
			PutField_CString(hPspDetail,"psp_id",csPtr);
		}
		if (GetField_CString(hRequest,"psp_ccy",&csPtr)) {
DEBUGLOG(("UpdateRevTxnLog:: psp_ccy = [%s]\n",csPtr));
			PutField_CString(hPspDetail,"txn_ccy",csPtr);
		}
		if (GetField_Double(hRequest,"to_amount",&dTmp)) {
DEBUGLOG(("UpdateRevTxnLog:: psp_amount = [%lf]\n",dTmp));
			PutField_Double(hPspDetail,"txn_amt",dTmp);
		}
		PutField_CString(hPspDetail,"desc","Void Payout");

		DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Add");
		iRet = (unsigned long) ((*DBObjPtr)(hPspDetail));

		if(iRet == PD_OK){
/* psp_bal */
                	if (GetField_Double(hContext,"psp_bal",&dTmp)) {
                	        PutField_Double(hPspDetail,"bal",dTmp);
DEBUGLOG(("UpdateRevTxnLog:: psp_bal= [%f]\n",dTmp));
                	}

/* total_float*/
                	if (GetField_Double(hContext,"psp_total_float",&dTmp)) {
                        	PutField_Double(hPspDetail,"total_float",dTmp);
DEBUGLOG(("UpdateRevTxnLog:: psp_total_float= [%f]\n",dTmp));
                	}

/* total_hold*/
                	if (GetField_Double(hContext,"psp_total_hold",&dTmp)) {
                        	PutField_Double(hPspDetail,"total_hold",dTmp);
DEBUGLOG(("UpdateRevTxnLog:: psp_total_hold= [%f]\n",dTmp));
                	}

                	DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
                	iRet = (unsigned long)(*DBObjPtr)(hPspDetail);
		}
	}


DEBUGLOG(("UpdateRevTxnLog iRet = [%d]\n",iRet));
        hash_destroy(hTxn);
        FREE_ME(hTxn);
        hash_destroy(hPspDetail);
        FREE_ME(hPspDetail);

        return  iRet;
}


int add_rev_txn_element(hash_t *hMyHash)
{
        int     iRet = SUCCESS;
	char	*csTmp;
	double	dTmp;
	hash_t *hTxn;
	
        hTxn = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hTxn,0);

	if(GetField_CString(hMyHash,"txn_seq",&csTmp)){
		PutField_CString(hTxn,"from_txn_seq",csTmp);
	}
	if(GetField_CString(hMyHash,"ccy",&csTmp)){
		PutField_CString(hTxn,"org_txn_ccy",csTmp);
		PutField_CString(hTxn,"src_txn_fee_ccy",csTmp);
	}
	if(GetField_Double(hMyHash,"amount",&dTmp)){
		PutField_Double(hTxn,"org_txn_amt",dTmp);
	}
	PutField_CString(hTxn,"amount_type",PD_CR);
	PutField_Char(hTxn,"party_type",PD_TYPE_MERCHANT);
	
DEBUGLOG(("AddTxnAmtElement\n"));
	if(AddTxnAmtElement(hTxn)!=PD_OK){
		iRet = FAILURE;
DEBUGLOG(("AddTxnAmtElement Failed\n"));
	}

	if(iRet==SUCCESS){
		if(GetField_Double(hMyHash,"fee",&dTmp)){
			PutField_Double(hTxn,"src_txn_fee",dTmp);
		}

DEBUGLOG(("AddTxnFeeElements\n"));
		PutField_CString(hTxn,"amount_type",PD_DR);
		if(AddTxnFeeElements(hTxn)!=PD_OK){
			iRet = FAILURE;
DEBUGLOG(("AddTxnFeeElements Failed\n"));
		}
	}

	if(iRet==SUCCESS){
		if(GetField_CString(hMyHash,"markup_ccy",&csTmp)){
			PutField_CString(hTxn,"org_txn_ccy",csTmp);
		}
		if(GetField_Double(hMyHash,"markup_amt",&dTmp)){
			PutField_Double(hTxn,"markup_amt",dTmp);
		}

		if(dTmp>0.0){
DEBUGLOG(("AddMarkupAmtElement\n"));
			if(AddMarkupAmtElement(hTxn)!=PD_OK){
				iRet = FAILURE;
DEBUGLOG(("AddMarkupAmtElement Failed\n"));
			}
		}
	}

	FREE_ME(hTxn);
	return iRet;
}

int UpdateMerchantUploadFileDetail(const hash_t *hRls)
{
        int     iRet = SUCCESS;
        char*   csBuf;
        char*   csBatchId;
        char*   csSeqNum;
	int	iSeqNum;

        EXEC SQL WHENEVER SQLERROR GOTO updatedt_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;

                varchar         hv_dynstmt[1024];

        EXEC SQL END DECLARE SECTION;


DEBUGLOG(("UpdateMerchantUploadFileDetail: Begin\n"));
        csBuf = (char*) malloc (128);
	csSeqNum = (char*) malloc (128);
        strcpy((char*)hv_dynstmt.arr,"update merchant_upload_file_detail set ud_update_timestamp = sysdate");
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

        if(GetField_CString(hRls,"batch_id",&csBatchId)){
DEBUGLOG(("UpdateMerchantUploadFileDetail:batch_id = [%s]\n",csBatchId));
        }
        else{
                FREE_ME(csBuf);
DEBUGLOG(("UpdateMerchantUploadFileDetail batch_id not found\n"));
                return FAILURE;
        }

	if(GetField_Int(hRls,"seq_num",&iSeqNum)){
        	sprintf(csSeqNum,"%d",iSeqNum);
DEBUGLOG(("UpdateMerchantUploadFileDetail:seq_num = [%s]\n",csSeqNum));
	}
        else{
                FREE_ME(csSeqNum);
DEBUGLOG(("UpdateMerchantUploadFileDetail seq_num not found\n"));
                return FAILURE;
        }

        if(GetField_CString(hRls,"txn_seq",&csBuf)){
DEBUGLOG(("UpdateMerchantUploadFileDetail:aux_txn_id = [%s]\n",csBuf));
                strcat((char*)hv_dynstmt.arr, ",ud_aux_txn_id = '");
                strcat((char*)hv_dynstmt.arr, csBuf);
                strcat((char*)hv_dynstmt.arr, "'");
                hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);
        }

        strcat((char*)hv_dynstmt.arr, " WHERE ud_batch_id = ");
        strcat((char*)hv_dynstmt.arr, csBatchId);
	strcat((char*)hv_dynstmt.arr, " AND ud_seq_num = ");
        strcat((char*)hv_dynstmt.arr, csSeqNum);
        hv_dynstmt.len = strlen((const char*)hv_dynstmt.arr);

DEBUGLOG(("SQL = [%.*s]\n",hv_dynstmt.len,hv_dynstmt.arr));


        EXEC SQL PREPARE PS FROM :hv_dynstmt;
        EXEC SQL EXECUTE PS;

        FREE_ME(csBuf);
	FREE_ME(csSeqNum);

DEBUGLOG(("UpdateMerchantUploadFileDetail Normal Exit\n"));
        return iRet;

updatedt_error:
DEBUGLOG(("updatedt_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("par_payout_handler_UpdateMerchantUploadFileDetail: SP_INTERNAL_ERR\n");
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return FAILURE;
}
