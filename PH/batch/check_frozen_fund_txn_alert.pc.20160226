/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2016/01/18              Dirk Wong 
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "batchcommon.h"
#include "common.h"
#include "utilitys.h"
#include "myhash.h"
#include "numutility.h"
#include "myrecordset.h"
#include "ObjPtr.h"
#include "internal.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char csDate[PD_DATE_LEN+1];

char csTag[PD_TAG_LEN+1];
char csTmp[PD_TMP_BUF_LEN+1];
char cDebug;
int iCnt=0;

int iDynCnt=0;

OBJPTR(BO);

int parse_arg(int argc,char **argv);

int batch_init(int argc, char* argv[])
{
        return SUCCESS;
}


int batch_proc(int argc, char* argv[])
{
	int     iRet = parse_arg(argc,argv);

	hash_t *hContext;

	if (iRet != SUCCESS) {
		return FAILURE;
	}

	hContext = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hContext,0);

	EXEC SQL WHENEVER SQLERROR GOTO sql_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

DEBUGLOG(("check_frozen_fund_txn_alert Start!\n"));

	EXEC SQL BEGIN DECLARE SECTION;

		varchar hv_date[PD_DATE_LEN];
		char	hv_ar_ind;

		varchar	v_txn_id[PD_TXN_SEQ_LEN+1];
		varchar	v_bank_stmt_id[PD_TXN_SEQ_LEN+1];
		varchar	v_txn_type[PD_DESC_LEN+1];
		varchar	v_pid[PD_DESC_LEN+1];
		varchar	v_baid[PD_BAID_NAME_LEN+1];
		varchar	v_txn_ccy[PD_CCY_ID_LEN+1];
		double	v_txn_amt;
		varchar	v_cr_dr[2+1];
		varchar v_approval_ts[PD_TIMESTAMP_LEN+1];
		varchar v_create_user[PD_USER_LEN+1];
		varchar	v_approval_date[PD_DESC_LEN+1];

		short	ind_txn_id = -1;
		short	ind_bank_stmt_id = -1;
		short	ind_txn_type = -1;
		short	ind_pid = -1;
		short	ind_baid = -1;
		short	ind_txn_ccy = -1;
		short	ind_txn_amt = -1;
		short	ind_cr_dr = -1;
		short	ind_approval_ts = -1;
		short	ind_create_user = -1;
		short	ind_approval_date = -1;

	EXEC SQL END DECLARE SECTION;

	hv_date.len = strlen(csDate);
	memcpy(hv_date.arr,csDate,hv_date.len);

	hv_ar_ind = PD_ACCEPT;

	EXEC SQL DECLARE c_cursor_getinfo CURSOR FOR


		SELECT  oth_txn_id,
			olsd_statement_ref,
			tc_desc,
			opd_psp_name,
			obai_baid_name,
			oth_net_ccy,
			oth_transaction_amount,
			ote_amt_type,
			to_char(oth_approval_timestamp,'MM/DD/YYYY HH24:MI') approval_ts,
			oth_create_user,
			to_char(oth_approval_timestamp,'YYYY/MM/DD') approval_date
		FROM	OL_TXN_HEADER,
			OL_TXN_PSP_DETAIL,
			OL_PSP_DETAIL,
			OL_TXN_ELEMENTS,
			OL_BANK_ACCT_ID,
			DEF_VIEW_TXNCODE_MAP,
			(SELECT OSTP_TXN_ID,
				OSTP_STMT_TXN_ID,
				OBT_STAT_TXN_ID,
				OLSD_STATEMENT_REF
			   FROM OL_STMT_TXN_RELATION, OL_BAID_TXN, OL_STATEMENT_DETAIL
			  WHERE OSTP_STMT_TXN_ID = OBT_TXN_ID
			    AND OBT_STAT_TXN_ID = OLSD_STAT_TXN_ID) t_stmt,
			TXN_CODE
		WHERE	OTH_TXN_CODE = VTM_TXN_CODE
		  AND	OTH_STATUS = OTH_STATUS
		  AND	OTH_AR_IND = :hv_ar_ind
		  AND	OTH_APPROVAL_DATE = :hv_date
		  AND	VTM_VIEW_TYPE = 'FROZEN_FUND_TXN'
		  AND	OTH_TXN_ID = t_stmt.ostp_txn_id(+)
		  AND	OTH_TXN_ID = OTP_TXN_ID
		  AND	OTP_PSP_ID = OPD_PSP_ID
		  AND	OTH_TXN_ID = OTE_TXN_ID
		  AND	OTP_BAID = OBAI_BAID
		  AND	OTH_TXN_CODE = TC_CODE
		ORDER BY
			oth_approval_timestamp;
		
	EXEC SQL OPEN c_cursor_getinfo;
	do {
		EXEC SQL FETCH c_cursor_getinfo
		INTO
			:v_txn_id:ind_txn_id,
			:v_bank_stmt_id:ind_bank_stmt_id,
			:v_txn_type:ind_txn_type,
			:v_pid:ind_pid,
			:v_baid:ind_baid,
			:v_txn_ccy:ind_txn_ccy,
			:v_txn_amt:ind_txn_amt,
			:v_cr_dr:ind_cr_dr,
			:v_approval_ts:ind_approval_ts,
			:v_create_user:ind_create_user,
			:v_approval_date:ind_approval_date;

		if (SQLCODE == SQL_NOT_FOUND) {
			if (iCnt == 0) {
DEBUGLOG(("No data found!\n"));
			}
			break;
		}

		if (ind_approval_date >= 0) {
			sprintf(csTmp,"%.*s",v_approval_date.len,v_approval_date.arr);
			iDynCnt = set_tpl_dyn_cstring(hContext,iDynCnt,"G_APPROVAL_DATE","GLO","STR",csTmp);
		}

		if (ind_txn_id >= 0) {
			sprintf(csTag,"ftxn_id-%d",iCnt);
			sprintf(csTmp,"%.*s",v_txn_id.len,v_txn_id.arr);
			iDynCnt = set_tpl_dyn_cstring(hContext,iDynCnt,csTag,"STR","stbl_body-0",csTmp);
		}

		if (ind_bank_stmt_id >= 0) {
			sprintf(csTag,"fbank_stmt_id-%d",iCnt);
			sprintf(csTmp,"%.*s",v_bank_stmt_id.len,v_bank_stmt_id.arr);
			iDynCnt = set_tpl_dyn_cstring(hContext,iDynCnt,csTag,"STR","stbl_body-0",csTmp);
		} else {
			sprintf(csTag,"fbank_stmt_id-%d",iCnt);
			sprintf(csTmp," ");
			iDynCnt = set_tpl_dyn_cstring(hContext,iDynCnt,csTag,"STR","stbl_body-0",csTmp);
		}

		if (ind_txn_type >= 0) {
			sprintf(csTag,"ftxn_type-%d",iCnt);
			sprintf(csTmp,"%.*s",v_txn_type.len,v_txn_type.arr);
			iDynCnt = set_tpl_dyn_cstring(hContext,iDynCnt,csTag,"STR","stbl_body-0",csTmp);
		}

		if (ind_pid >= 0) {
			sprintf(csTag,"fpid-%d",iCnt);
			sprintf(csTmp,"%.*s",v_pid.len,v_pid.arr);
			iDynCnt = set_tpl_dyn_cstring(hContext,iDynCnt,csTag,"STR","stbl_body-0",csTmp);
		}

		if (ind_baid >= 0) {
			sprintf(csTag,"fbaid-%d",iCnt);
			sprintf(csTmp,"%.*s",v_baid.len,v_baid.arr);
			iDynCnt = set_tpl_dyn_cstring(hContext,iDynCnt,csTag,"STR","stbl_body-0",csTmp);
		}

		if (ind_txn_ccy >= 0) {
			sprintf(csTag,"ftxn_ccy-%d",iCnt);
			sprintf(csTmp,"%.*s",v_txn_ccy.len,v_txn_ccy.arr);
			iDynCnt = set_tpl_dyn_cstring(hContext,iDynCnt,csTag,"STR","stbl_body-0",csTmp);
		}

		if (ind_txn_amt >= 0) {
			sprintf(csTag,"ftxn_amt-%d",iCnt);
			iDynCnt = set_tpl_dyn_double(hContext,iDynCnt,csTag,"DOU","stbl_body-0",v_txn_amt);
		}

		if (ind_cr_dr >= 0) {
			sprintf(csTag,"fcr_dr-%d",iCnt);
			sprintf(csTmp,"%.*s",v_cr_dr.len,v_cr_dr.arr);
			if (!strcmp(csTmp,PD_CR))
				sprintf(csTmp,"%s","Credit");
			else if (!strcmp(csTmp,PD_DR))
				sprintf(csTmp,"%s","Debit");
			iDynCnt = set_tpl_dyn_cstring(hContext,iDynCnt,csTag,"STR","stbl_body-0",csTmp);
		}

		if (ind_approval_ts >= 0) {
			sprintf(csTag,"fapproval_ts-%d",iCnt);
			sprintf(csTmp,"%.*s",v_approval_ts.len,v_approval_ts.arr);
			iDynCnt = set_tpl_dyn_cstring(hContext,iDynCnt,csTag,"STR","stbl_body-0",csTmp);
		}

		if (ind_create_user >= 0) {
			sprintf(csTag,"fcreate_user-%d",iCnt);
			sprintf(csTmp,"%.*s",v_create_user.len,v_create_user.arr);
			iDynCnt = set_tpl_dyn_cstring(hContext,iDynCnt,csTag,"STR","stbl_body-0",csTmp);
		}

		iCnt++;
	}
	while(PD_TRUE && iRet == SUCCESS);
	EXEC SQL CLOSE c_cursor_getinfo;

	if (iCnt > 0) {
		iDynCnt = set_tpl_dyn_int(hContext, iDynCnt, "stbl_head-0", "SEC", "stbl_head-0", 0);
		iDynCnt = set_tpl_dyn_int(hContext, iDynCnt, "stbl_body-0", "SEC", "stbl_body-0", iCnt);

		/*
		sprintf(csTmp, "Frozen Fund Arrangement Email Notification");
		iDynCnt = set_tpl_dyn_cstring(hContext,iDynCnt,"MAIL_SUBJECT","GLO","STR",csTmp);
		*/

		PutField_CString(hContext,"source","BATCH");
		PutField_CString(hContext,"funct","FROZEN_FUND_TXN");
		PutField_Char(hContext,"party_type",'G');
		PutField_CString(hContext,"party_id","000");

		PutField_Int(hContext,"total_dyn",iDynCnt);

		BOObjPtr = CreateObj(BOPtr,"BOAlertEmail","ProcessTpl");
		if((unsigned long)((*BOObjPtr)(hContext) != PD_OK)){
			iRet=INT_CODE_ERROR;
			PutField_Int(hContext,"internal_error",iRet);
DEBUGLOG(("BOAlertEmail:ProcessTpl Failed\n"));
ERRLOG("check_frozen_fund_txn_alert BOAlertEmail::ProcessTpl Failed, iRet=%d\n", iRet);
		}
		else
		{
DEBUGLOG(("BOAlertEmail:ProcessTpl Success\n"));
		}
	}

DEBUGLOG(("check_frozen_fund_txn_alert normal exit!\n"));

	FREE_ME(hContext);

	return iRet;

sql_error:
DEBUGLOG(("check_frozen_fund_txn_alert error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_getinfo;
    EXEC SQL ROLLBACK RELEASE;
    return PD_ERR;
}


int batch_terminate(int argc, char* argv[])
{
        return SUCCESS;
}


int parse_arg(int argc,char **argv)
{

        char    c;
	strcpy(csDate,"");

        if (argc < 2) {
                return PD_ERR;
        }
        while ((c = getopt(argc,argv,"d:")) != EOF) {
                switch (c) {
                        case 'd':
                                strcpy(csDate,optarg);
                                break;
                        default:
                                return PD_ERR;
                }
        }

	if (!strcmp(csDate,""))
		return FAILURE;

        return SUCCESS;
}
