#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "common.h"
#include "utilitys.h"
#include "expat.h"
#include <curl/curl.h>
#include "myhash.h"
#include "ObjPtr.h"
#include "numutility.h"
#include "myrecordset.h"
#include "dbutility.h"

#include "SystemParameter.h"

OBJPTR(DB);
OBJPTR(BO);
char    cDebug = 'Y';

char    cs_merchant_id[PD_MERCHANT_ID_LEN + 1];
char    cs_txn_ccy[PD_CCY_ID_LEN+ 1];
char    cs_amount[PD_AMOUNT_LEN+ 1];

int     parse_arg(int argc,char **argv);

int batch_init(int argc, char* argv[])
{
	return SUCCESS;
}


int batch_proc(int argc, char* argv[])
{

	int     iRet = SUCCESS;

	double	dAmount = 0.0;
	double	dTxnAmt = 0.0;

	iRet = parse_arg(argc,argv);
        if(iRet != SUCCESS){
                printf("usage: -m merchant_id -c txn_ccy -a Amount\n");
                return (iRet);
        }

        hash_t  *hContext;
        hContext = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hContext,0);

	PutField_CString(hContext,"org_merchant_id",cs_merchant_id);
	PutField_CString(hContext,"org_txn_ccy",cs_txn_ccy);

	sscanf(cs_amount,"%lf",&dTxnAmt);	
	PutField_Double(hContext,"org_txn_amt",dTxnAmt);

DEBUGLOG(("batch_proc Call BOUniqueNumber:GetUniqueAmt[%s][%s][%lf]\n",cs_merchant_id,cs_txn_ccy,dTxnAmt));
        BOObjPtr = CreateObj(BOPtr,"BOUniqueNumber","GetUniqueAmt");
        if ((*BOObjPtr)(hContext,&dAmount) == PD_OK) {
printf("batch_proc Return Unique Amount = [%lf]\n",dAmount);
DEBUGLOG(("batch_proc Return Unique Amount = [%lf]\n",dAmount));
	}
	else{
DEBUGLOG(("batch_proc Return Unique Amount Failed!!!\n"));
	}

	hash_destroy(hContext);
        FREE_ME(hContext);

DEBUGLOG(("batch_proc Normal Exit() iRet = [%d]\n",iRet));
        return iRet;

}

int batch_terminate(int argc, char* argv[])
{
    return SUCCESS;
}

int parse_arg(int argc,char **argv)
{
        char    c;
        strcpy(cs_merchant_id,"");
        strcpy(cs_txn_ccy,"");
        strcpy(cs_amount,"");

        while ((c = getopt(argc,argv,"m:c:a:")) != EOF) {
                switch (c) {
			case 'm':
				strcpy(cs_merchant_id, optarg);
				cs_merchant_id[strlen(cs_merchant_id)]='\0';
				break;
			case 'c':
				strcpy(cs_txn_ccy, optarg);
				cs_txn_ccy[strlen(cs_txn_ccy)]='\0';
				break;
			case 'a':
				strcpy(cs_amount, optarg);
				cs_amount[strlen(cs_amount)]='\0';
				break;
			default:
                                return FAILURE;
                }
        }

        if (!strcmp(cs_merchant_id,"") || !strcmp(cs_txn_ccy,"") || !strcmp(cs_amount,""))
                return FAILURE;

        return SUCCESS;
}
