/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/08/29              Virginia Yun
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "batchcommon.h"
#include "common.h"
#include "utilitys.h"
#include "myhash.h"
#include "numutility.h"
#include "myrecordset.h"
#include "ObjPtr.h"
#include "dates.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char	cs_txn_seq[PD_TXN_SEQ_LEN + 1];
char    cs_merchant_id[PD_MERCHANT_ID_LEN + 1];
char    cs_funct[PD_CODE_LEN +1];

char    cDebug = 'Y';

OBJPTR(DB);
OBJPTR(Txn);

int parse_arg(int argc,char **argv);
int process_get_template(const char *csTxnSeq, const char *csMerchantId, const char *csFunction);

int batch_init(int argc, char* argv[])
{
	return SUCCESS;
}




int batch_proc(int argc, char* argv[])
{
        int     iRet;

	iRet = parse_arg(argc,argv);
               
        if (iRet != SUCCESS) {
		printf("usage:  -t txn_id -m merchant_id -f function\n");
                return (iRet);
        }

	if(iRet==PD_OK){
		iRet = process_get_template(cs_txn_seq, cs_merchant_id,cs_funct);
	}

	if (iRet != PD_OK) {
		iRet = FAILURE;
	}
	return iRet;


}


int batch_terminate(int argc, char* argv[])
{
	return SUCCESS;
}

int parse_arg(int argc,char **argv)
{
	char    c;

	strcpy(cs_txn_seq,"");
	strcpy(cs_merchant_id,"");
	strcpy(cs_funct,"");

	while ((c = getopt(argc,argv,"t:m:f:")) != EOF) {
		switch (c) {
			case 't':
				strcpy(cs_txn_seq, optarg);
				break;
			case 'm':
				strcpy(cs_merchant_id, optarg);
				break;
			case 'f':
				strcpy(cs_funct, optarg);
				break;
			default:
				return FAILURE;
		}
	}

	if (!strcmp(cs_txn_seq, "") || !strcmp(cs_merchant_id,"") || !strcmp(cs_funct,""))
		return FAILURE;

	return SUCCESS;
}


int process_get_template(const char *csTxnSeq, const char *csMerchantId, const char *csFunction)
{
        int     iRet = PD_OK;

DEBUGLOG(("--------------process_get_template--------------\n"));
	EXEC SQL WHENEVER SQLERROR GOTO sql_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		varchar	hv_txn_id[PD_TXN_SEQ_LEN];
		varchar	hv_merchant_id[PD_MERCHANT_ID_LEN];
		varchar	hv_funct[PD_CODE_LEN];

		short	ind_txn_id = -1;
		short	ind_merchant_id = -1;
		short	ind_funct = -1;

		varchar	v_template[PD_NOTE_LEN +1];
		short	ind_template = -1;

		short   hv_return_value;
	EXEC SQL END DECLARE SECTION;

	hv_txn_id.len = strlen(csTxnSeq);
	memcpy(hv_txn_id.arr,csTxnSeq,hv_txn_id.len);
	ind_txn_id = 0;
DEBUGLOG(("process_get_template txn_seq = [%.*s]\n",hv_txn_id.len,hv_txn_id.arr));

	hv_merchant_id.len = strlen(csMerchantId);
	memcpy(hv_merchant_id.arr,csMerchantId,hv_merchant_id.len);
	ind_merchant_id = 0;
DEBUGLOG(("process_get_template merchant_id = [%.*s]\n",hv_merchant_id.len,hv_merchant_id.arr));

	hv_funct.len = strlen(csFunction);
	memcpy(hv_funct.arr,csFunction,hv_funct.len);
	ind_funct= 0;
DEBUGLOG(("process_get_template function = [%.*s]\n",hv_funct.len,hv_funct.arr));

        EXEC SQL EXECUTE
                BEGIN
                        :hv_return_value := sp_get_email_notify_template (:hv_txn_id:ind_txn_id,
									  :hv_merchant_id:ind_merchant_id,
									  :hv_funct:ind_funct,
									  :v_template:ind_template);
                END;
        END-EXEC;


	if (hv_return_value == SP_OK) {
DEBUGLOG(("process_get_template: Found!\n"));
			
		if(ind_template >=0){
			v_template.arr[v_template.len] = '\0';
			printf("%s\n",v_template.arr);
DEBUGLOG(("process_get_template: template = [%s]\n",v_template.arr));

		}
		else {
			iRet = PD_ERR;
		}
	} else if (hv_return_value == SP_OTHER_ERR) {
DEBUGLOG(("process_get_template other error\n"));
ERRLOG("get_auto_sett_email_body::process_get_template:other error\n");
		iRet = PD_ERR;
	} else if (hv_return_value == SP_ERR) {
DEBUGLOG(("process_get_template error\n"));
ERRLOG("get_auto_sett_email_body::process_get_template:error\n");
		iRet = PD_ERR;
	}

	return	iRet;

sql_error:
DEBUGLOG(("process_get_template error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("get_auto_sett_email_body::process_get_template sql error %d\n", sqlca.sqlcode);
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL ROLLBACK RELEASE;
    return PD_ERR;
}
