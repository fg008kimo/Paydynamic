/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2013/06/10              Stan Poon
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "common.h"
#include "utilitys.h"
#include "batchcommon.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char	cDebug;

int batch_init(int argc, char* argv[])
{
        return SUCCESS;
}


int batch_terminate(int argc, char* argv[])
{
    return SUCCESS;
}


int batch_proc(int argc, char* argv[])
{

        EXEC SQL WHENEVER SQLERROR GOTO sql_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar         v_psp_id[PD_PSP_ID_LEN+1];
		varchar         v_bank_code[PD_BANK_CODE_LEN+1];
		short           ind_psp_id = -1;
		short           ind_bank_code = -1;

        EXEC SQL END DECLARE SECTION;

        EXEC SQL DECLARE c_cursor_getpspbank CURSOR FOR
		SELECT	PD.PSP_ID,
			BC.BC_BANK_CODE
		FROM	PSP_MASTER,
			PSP_DETAIL PD,
			PSP_COUNTRY PC,
			(SELECT	BC1.BC_PARTY_ID, BC1.BC_BANK_CODE
			FROM	BANK_TXN_CHECK BC1
			WHERE	BC1.BC_DISABLED = 0
			AND	(BC1.BC_PARTY_ID = '000'
				OR (BC1.BC_PARTY_ID <> '000' 
				AND NOT EXISTS (SELECT * FROM BANK_TXN_CHECK BC2
				WHERE BC2.BC_DISABLED = 0 AND BC2.BC_PARTY_ID = '000'
				AND BC2.BC_BANK_CODE = BC1.BC_BANK_CODE)))) BC
		WHERE	PM_CLIENT_ID = PD.CLIENT_ID
		AND	PM_STATUS = 'O'
		AND	PD.ONLINE_MODE = 'Y'
		AND	PD.STATUS = 'O'
		AND	PD.DISABLED = 0
		AND	PD.PSP_ID = PC.PSP_ID
		AND	(PD.PSP_ID = BC.BC_PARTY_ID OR BC.BC_PARTY_ID = '000')
		AND	EXISTS (SELECT *
			FROM	BANK_MAPPING
			WHERE	BM_PSP_CHANNEL_ID = NVL(PD.OVERRIDED_BANK_CODE_CHANNEL, PD.PSP_CHANNEL_CODE)
			AND	BM_INT_BANK_CODE = BC.BC_BANK_CODE
			AND	BM_COUNTRY = PC.COUNTRY
			AND	BM_DISABLED = 0)
		AND	EXISTS (SELECT *
			FROM	PSP_PAY_METHOD, SERVICE_PAY_METHOD, BANK_SERVICE_MAPPING
			WHERE	PP_COUNTRY = PC.COUNTRY
			AND	PP_PSP_ID = PD.PSP_ID
			AND	PP_DISABLED = 0
			AND	PP_PAY_METHOD = SP_PAY_METHOD
			AND	SP_DISABLED = 0
			AND	BS_SERVICE_CODE = SP_SERVICE_CODE
			AND	BS_INT_BANK_CODE = BC.BC_BANK_CODE
			AND	BS_DISABLED = 0)
		ORDER BY BC.BC_BANK_CODE, PD.PSP_ID ASC;

        EXEC SQL OPEN c_cursor_getpspbank;
        do{
                EXEC SQL FETCH c_cursor_getpspbank
                INTO    :v_psp_id:ind_psp_id,
			:v_bank_code:ind_bank_code;


                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

		printf("%.*s;",v_psp_id.len,v_psp_id.arr);
		printf("%.*s;\n",v_bank_code.len,v_bank_code.arr);

	}while(PD_TRUE);


        EXEC SQL CLOSE c_cursor_getpspbank;

        return SUCCESS;
sql_error:
    DEBUGLOG(("sql_error code %d\n", sqlca.sqlcode));
    DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_getpspbank;
    EXEC SQL ROLLBACK RELEASE;
    return FAILURE;
}
