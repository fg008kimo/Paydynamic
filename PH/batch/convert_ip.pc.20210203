#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <stdint.h>
#include <unistd.h>
#include <ctype.h>
#include <sys/types.h>
#include <time.h>
#include "common.h"
#include "internal.h"
#include "utilitys.h"
#include "tpllib.h"
#include "IP2Location.h"


int main(int argc, char * argv[])
{
	int iRet = SUCCESS;
	char csFileLocation[PD_TMP_BUF_LEN];
	char csLocation[PD_COUNTRY_LEN + 1];
	char csLocationName[PD_COUNTRY_NAME_LEN + 1];
	char csIP[PD_IP_LEN + 1];

	if(argc < 2){
printf("Usage: convert_ip.exec <IP addr>\n");
		return FAILURE;
	}

	sprintf((char *)csIP, argv[1]);
	sprintf((char *)csFileLocation, "%s/ip2location/IP-COUNTRY.BIN", getenv("DATA_PATH"));

	IP2Location *IP2LocationObj = IP2Location_open(csFileLocation);

	//IP2LocationRecord *record = IP2Location_get_country_short(IP2LocationObj, csIP);
	IP2LocationRecord *record = IP2Location_get_all(IP2LocationObj, csIP);
	if(strlen(record->country_short) == PD_COUNTRY_LEN){
		strcpy(csLocation, record->country_short);
                strcpy(csLocationName, record->country_long);
printf("IP[%s] is converted to [%s][%s]\n", csIP, csLocation, csLocationName);
	}
	else{
printf("IP[%s] cannot be converted, country[%s][%s] is invalid\n", csIP, record->country_short, record->country_long);
		iRet = FAILURE;
	}

	IP2Location_free_record(record);
	IP2Location_close(IP2LocationObj);

	return iRet;
}
