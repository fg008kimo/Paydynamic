/*
PDProTech (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2018/01/18              [WWK]
Empty Provider when err [5040,5042,5062]	   2018/04/03		   [WWK]
Update						   2018/07/09	      	   [WMC]
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "batchcommon.h"
#include "common.h"
#include "utilitys.h"
#include "myhash.h"
#include "numutility.h"
#include "myrecordset.h"
#include "ObjPtr.h"
#include "internal.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char cs_nature_path[PD_TMP_BUF_LEN+1];
char cs_provider_path[PD_TMP_BUF_LEN+1];
char cs_bank_short_name[PD_TMP_BUF_LEN+1];
int iBankExclude;
int iJobSeq;

char csTag[PD_TAG_LEN+1];
char csTmp[PD_TMP_BUF_LEN+1];
int iCnt=0;
int iDynCnt=0;

char cDebug;

OBJPTR(DB);
OBJPTR(BO);

int parse_arg(int argc,char **argv);
int UpdateJobStatus(int iJobSeq, int iBankExclude, char *csNaturePath, char *csProviderPath, char *csBankShortName);
int CreateErrorAlertTpl(int iJobSeq, char *csNature, char *csProviderId);

int batch_init(int argc, char* argv[])
{
        return SUCCESS;
}


int batch_proc(int argc, char* argv[])
{
	int     iRet = SUCCESS;
	int	iTmpRet = PD_OK;	

        char    csProviderName[PD_CLIENT_NAME_LEN + 1];
        char    csProviderId[PD_CLIENT_ID_LEN + 1];
	char    csNature[PD_ACCT_TYPE_LEN + 1];

DEBUGLOG(("batch_proc: check_auto_upload_error Start!\n"));

	iRet = parse_arg(argc,argv);

	if (iRet != SUCCESS) {
		return FAILURE;
	}

	// Check All Job Completed
/*
	if (iRet == SUCCESS) {
	
		DBObjPtr = CreateObj(DBPtr, "DBOLAutoUploadJobStatus", "CheckAllJobFinish");
                if ((unsigned long)(*DBObjPtr)(iJobSeq) != PD_TRUE) {
DEBUGLOG(("batch_proc: DBOLAutoUploadJobStatus: CheckAllJobFinish: Other job is processing, quit program!!\n")); 
		
			// Other job is processing, quit program
			return SUCCESS;
		}
	}
*/

	// Check Job Tmp Record Exists 
/*
	if (iRet == SUCCESS) {

		// Lock Job Tmp Status
		DBObjPtr = CreateObj(DBPtr, "DBOLAutoUploadJobTmp", "LockJobTmpStatus");
                iTmpRet = (unsigned long)(*DBObjPtr)(iJobSeq);
		if (iTmpRet != PD_OK) {
DEBUGLOG(("batch_proc: DBOLAutoUploadJobTmp: LockJobTmpStatus: Email alert sent already, quit program!!\n"));

			// Email alert sent already, quit program
			return SUCCESS;
		}
	}
*/

	// Get Provider Name
        if (iRet == SUCCESS) {
		memset(csProviderName, 0, sizeof(csProviderName));
		memset(csProviderId, 0, sizeof(csProviderId));
		memset(csNature, 0, sizeof(csNature));        

	        DBObjPtr = CreateObj(DBPtr,"DBOLAutoUploadStmtSetting","GetDetailByPathName");
                if ((unsigned long)(DBObjPtr)(cs_provider_path,cs_nature_path,csProviderName,csProviderId,csNature) == PD_FOUND) {
DEBUGLOG(("batch_proc: DBOLAutoUploadStmtSetting: GetDetailByPathName: provider_name = [%s], provider_id = [%s], nature = [%s]\n", csProviderName, csProviderId, csNature));
                } else {
DEBUGLOG(("batch_proc: DBOLAutoUploadStmtSetting: GetDetailByPathName Failed!!\n"));
ERRLOG("check_auto_upload_error: batch_proc: DBOLAutoUploadStmtSetting: GetDetailByPathName Failed!!\n");
                        iRet = FAILURE;
                }
        }

	// Create Error Email Alert Tpl
	if (iRet == SUCCESS) {
		iTmpRet = CreateErrorAlertTpl(iJobSeq, csNature, csProviderId);
		if (iTmpRet != PD_OK) {
			
			iRet = FAILURE;
		}			
	}
	
	// Update job status and delete job tmp
	if (iRet == SUCCESS) {

/*
		iTmpRet = UpdateJobStatus(iJobSeq, iBankExclude, cs_nature_path, cs_provider_path, cs_bank_short_name);
        	if (iTmpRet != PD_OK) {
        	    	iRet = FAILURE;
     		}

		if (iRet == SUCCESS) {
     	
			DBObjPtr = CreateObj(DBPtr, "DBOLAutoUploadJobTmp", "Delete");
                	iTmpRet = (unsigned long)(*DBObjPtr)(iSeq);
      			if (iTmpRet != PD_OK) {
DEBUGLOG(("batch_proc: DBOLAutoUploadJobTmp: Delete Failed!!\n"));
ERRLOG("check_auto_upload_error: batch_proc: DBOLAutoUploadJobTmp: Delete Failed!!\n");
        		    	iRet = FAILURE;
      			}
		}
*/
	}

DEBUGLOG(("batch_proc: CheckAutoUploadError normal exit!\n"));

	return iRet;
}


int batch_terminate(int argc, char* argv[])
{
        return SUCCESS;
}


int parse_arg(int argc, char **argv)
{
	char	c;
	strcpy(cs_nature_path,"");
        strcpy(cs_provider_path,"");
        strcpy(cs_bank_short_name,"");
	iBankExclude = 0;
	iJobSeq = 0;

	if (argc < 6) {
DEBUGLOG(("argc = [%d]\n",argc));
		return FAILURE;
	}

	while ((c = getopt(argc,argv,"s:n:p:b:d:")) != EOF) {
		switch (c) {
			case 's':
				iJobSeq = atoi(optarg);
				break;
			case 'n':
				strcpy(cs_nature_path,optarg);
				break;
                        case 'p':
                                strcpy(cs_provider_path, optarg);
                                break;
                        case 'b':
                                strcpy(cs_bank_short_name, optarg);
                                break;
                        case 'd':
                                iBankExclude = atoi(optarg);
                                break;
			default:
				return FAILURE;
		}
	}

	if (!strcmp(cs_nature_path,"") || !strcmp(cs_provider_path,"") || !strcmp(cs_bank_short_name,""))
		return FAILURE;

        return SUCCESS;
}

int UpdateJobStatus(int iJobSeq, int iBankExclude, char *csNaturePath, char *csProviderPath, char *csBankShortName)
{        
        int     iRet = PD_OK;
        
	hash_t  *hUpdateJob = NULL;
        hUpdateJob = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hUpdateJob,0);

        PutField_Int(hUpdateJob, "job_seq", iJobSeq);
        PutField_CString(hUpdateJob, "nature_path", csNaturePath);
        PutField_CString(hUpdateJob, "provider_path", csProviderPath);
        PutField_CString(hUpdateJob, "process_bank", csBankShortName);
        PutField_Int(hUpdateJob, "exclude_mode", iBankExclude);
        PutField_Char(hUpdateJob, "status", PD_AUTO_UPL_JOB_STATUS_ALERT_SENT);
        PutField_CString(hUpdateJob, "update_user", PD_UPDATE_USER);

        DBObjPtr = CreateObj(DBPtr,"DBOLAutoUploadJobStatus","UpdateStatus");
        if ((unsigned long)(DBObjPtr)(hUpdateJob) == PD_OK) {
DEBUGLOG(("UpdateJobStatus: DBOLAutoUploadJobStatus: UpdateStatus to [%c] Success!!\n", PD_AUTO_UPL_JOB_STATUS_ALERT_SENT));
        } else {
DEBUGLOG(("UpdateJobStatus: DBOLAutoUploadJobStatus: UpdateStatus Failed!!\n"));
ERRLOG("check_auto_upload_error: UpdateJobStatus: DBOLAutoUploadJobStatus: UpdateStatus Failed!!\n");
                iRet = FAILURE;
        }

        hash_destroy(hUpdateJob);
        FREE_ME(hUpdateJob);

DEBUGLOG(("UpdateJobStatus: iRet = [%d]\n", iRet));
        return iRet;

}

int CreateErrorAlertTpl(int iJobSeq, char *csNature, char *csProviderId)
{
	int iRet = PD_OK;

	char csNatureName[PD_TMP_BUF_LEN+1];

	hash_t *hContext;
	hContext = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hContext,0);

        EXEC SQL WHENEVER SQLERROR GOTO geterrorlog_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                int     hv_job_seq;
                varchar hv_nature[PD_ACCT_TYPE_LEN+1];
		varchar hv_provider_id[PD_CLIENT_ID_LEN+1];

                varchar v_provider[PD_CLIENT_NAME_LEN+1];
                varchar v_bank_name[PD_BANK_NAME_LEN+1];
                varchar v_bank_acct_short_name[PD_BANK_ACCT_SHORT_NAME_LEN+1];
                varchar v_bank_acct_num[PD_BANK_ACCT_NUM_LEN+1];
                varchar v_stmt_filename[PD_UPLOAD_FILENAME_LEN+1];
                char    v_status;
                int     v_err_code;

                short   ind_provider = -1;
                short   ind_bank_name = -1;
                short   ind_bank_acct_short_name = -1;
                short   ind_bank_acct_num = -1;
                short   ind_stmt_filename = -1;
                short   ind_status = -1;
                short   ind_err_code = -1;
        EXEC SQL END DECLARE SECTION;

DEBUGLOG(("CreateErrorAlertTpl: Get records from Error Log\n"));

        hv_job_seq = iJobSeq;
DEBUGLOG(("CreateErrorAlertTpl: hv_job_seq = [%d]\n", iJobSeq));

	hv_nature.len = strlen(csNature);
        memcpy(hv_nature.arr, csNature, hv_nature.len);
DEBUGLOG(("CreateErrorAlertTpl: hv_nature [%s]\n",csNature));

        hv_provider_id.len = strlen(csProviderId);
        memcpy(hv_provider_id.arr, csProviderId, hv_provider_id.len);
DEBUGLOG(("CreateErrorAlertTpl: hv_provider_id [%s]\n",csProviderId));

	EXEC SQL DECLARE c_cursor_getinfo CURSOR FOR
                SELECT  OAUEL_PROVIDER,
                        OAUEL_BANK_NAME,
                        OAUEL_ACCT_SHORT_NAME,
                        OAUEL_ACCT_NUM,
                        OAUEL_STMT_FILENAME,
                        OAUEL_STATUS,
                        OAUEL_ERR_CODE
                FROM    OL_AUTO_UPLOAD_ERR_LOG
                WHERE   OAUEL_JOB_SEQ = :hv_job_seq
		AND     OAUEL_NATURE = :hv_nature
		AND	OAUEL_PROVIDER_ID = :hv_provider_id	
                ORDER BY
                        OAUEL_PROVIDER,
                        OAUEL_BANK_NAME,
                        OAUEL_ACCT_SHORT_NAME,
                        OAUEL_ACCT_NUM,
                        OAUEL_STMT_FILENAME;

        EXEC SQL OPEN c_cursor_getinfo;
	do {
                EXEC SQL FETCH c_cursor_getinfo
                INTO
                        :v_provider:ind_provider,
                        :v_bank_name:ind_bank_name,
                        :v_bank_acct_short_name:ind_bank_acct_short_name,
                        :v_bank_acct_num:ind_bank_acct_num,
                        :v_stmt_filename:ind_stmt_filename,
                        :v_status:ind_status,
                        :v_err_code:ind_err_code;

                if (SQLCODE == SQL_NOT_FOUND) {
                        if (iCnt == 0) {
DEBUGLOG(("CreateErrorAlertTpl: No record found!\n"));
                        }
                        break;
                }

                if (ind_provider >= 0 && ind_err_code >= 0) {
                        sprintf(csTag, "fprovider-%d", iCnt);
                        sprintf(csTmp, "%.*s", v_provider.len, v_provider.arr);
                        iDynCnt = set_tpl_dyn_cstring(hContext, iDynCnt, csTag, "STR", "stbl_body-0", csTmp);
DEBUGLOG(("CreateErrorAlertTpl: provider = [%s]\n", csTmp));
                }

                sprintf(csTag, "fbank_name-%d", iCnt);
                if (ind_bank_name >= 0) {
                        sprintf(csTmp, "%.*s", v_bank_name.len, v_bank_name.arr);
                } else  sprintf(csTmp, " ");
                iDynCnt = set_tpl_dyn_cstring(hContext, iDynCnt, csTag, "STR", "stbl_body-0", csTmp);
DEBUGLOG(("CreateErrorAlertTpl: bank_name = [%s]\n", csTmp));

                sprintf(csTag, "fbank_acct_num-%d", iCnt);
                if (ind_bank_acct_short_name >= 0 && ind_bank_acct_num >= 0) {
                        sprintf(csTmp, "%.*s (%.*s)", v_bank_acct_short_name.len, v_bank_acct_short_name.arr, v_bank_acct_num.len, v_bank_acct_num.arr);
                } else  sprintf(csTmp, " ");
                iDynCnt = set_tpl_dyn_cstring(hContext, iDynCnt, csTag, "STR", "stbl_body-0", csTmp);
DEBUGLOG(("CreateErrorAlertTpl: bank_acct_num = [%s]\n", csTmp));

                if (ind_stmt_filename >= 0) {
                        sprintf(csTag, "fstmt_file_name-%d", iCnt);
                        sprintf(csTmp, "%.*s", v_stmt_filename.len, v_stmt_filename.arr);
                        iDynCnt = set_tpl_dyn_cstring(hContext, iDynCnt, csTag, "STR", "stbl_body-0", csTmp);
DEBUGLOG(("CreateErrorAlertTpl: last_stmt_filename = [%s]\n", csTmp));
                }

		if (ind_status >= 0) {
                        sprintf(csTag, "fstatus-%d", iCnt);

                        if (v_status == PD_DEPOSIT_FILE_DECLINED) {
                                sprintf(csTmp,"%s",PD_DEPOSIT_FILE_DECLINED_DESC);
                        } else if (v_status == PD_DEPOSIT_FILE_CANCEL) {
                                sprintf(csTmp,"%s",PD_DEPOSIT_FILE_CANCEL_DESC);
                        } else if (v_status == PD_DEPOSIT_FILE_PENDING) {
                                sprintf(csTmp,"%s",PD_DEPOSIT_FILE_PENDING_DESC);
                        }

                        iDynCnt = set_tpl_dyn_cstring(hContext, iDynCnt, csTag, "STR", "stbl_body-0", csTmp);
DEBUGLOG(("CreateErrorAlertTpl: status = [%s]\n", csTmp));
                }

                if (ind_err_code >= 0) {
                        sprintf(csTag, "ferr_msg-%d", iCnt);

                        DBObjPtr = CreateObj(DBPtr,"DBInternalMessages","GetMsg");
                        if ((unsigned long)((*DBObjPtr)(v_err_code,csTmp) == NOT_FOUND)) {
                                iRet = INT_CODE_ERROR;
                        }

                        iDynCnt = set_tpl_dyn_cstring(hContext, iDynCnt, csTag, "STR", "stbl_body-0", csTmp);
DEBUGLOG(("CreateErrorAlertTpl: err_msg = [%s]\n", csTmp));
                }

                iCnt++;
        }
        while(PD_TRUE && iRet == PD_OK);

        EXEC SQL CLOSE c_cursor_getinfo;

	if (iCnt > 0) {
                //alert time
                iDynCnt = set_tpl_dyn_int(hContext, iDynCnt, "stimestamp-0", "SEC", "stimestamp-0", 0);
                iDynCnt = set_tpl_dyn_cstring(hContext, iDynCnt, "ftimestamp-0", "STR", "stimestamp-0", write_tpl_timestamp());

                iDynCnt = set_tpl_dyn_int(hContext, iDynCnt, "stbl_head-0", "SEC", "stbl_head-0", 0);
                iDynCnt = set_tpl_dyn_int(hContext, iDynCnt, "stbl_body-0", "SEC", "stbl_body-0", iCnt);

                //email title
                if (!strcmp(cs_nature_path,PD_AUTO_UPLOAD_NATURE_DSI)) {
                        strcpy(csNatureName,PD_NATURE_DEPOSIT_NAME);
                } else if (!strcmp(cs_nature_path,PD_AUTO_UPLOAD_NATURE_POA)) {
                        strcpy(csNatureName,PD_NATURE_PAYOUT_NAME);
                } else if (!strcmp(cs_nature_path,PD_AUTO_UPLOAD_NATURE_ITM)) {
                        strcpy(csNatureName,PD_NATURE_INTERMEDIATE_NAME);
                } else {
                        iRet = PD_ERR;
                }
                sprintf(csTmp, "Auto Upload %s Bank Statement - Error Occurs", csNatureName);
                iDynCnt = set_tpl_dyn_cstring(hContext,iDynCnt,"MAIL_SUBJECT","GLO","STR",csTmp);

                PutField_CString(hContext, "source", PD_EML_SOURCE_BATCH);
                PutField_CString(hContext, "funct", PD_EML_FUNCT_CHK_AUTO_UPL_ERR);
                PutField_Char(hContext, "party_type", PD_TYPE_GLOBAL);
                PutField_CString(hContext, "party_id", PD_EML_PARTY_ID_BATCH);

                PutField_Int(hContext, "total_dyn", iDynCnt);

                BOObjPtr = CreateObj(BOPtr, "BOAlertEmail", "ProcessTpl");
                if ((unsigned long)((*BOObjPtr)(hContext) != PD_OK)){
                        PutField_Int(hContext, "internal_error", iRet);
                        iRet=INT_CODE_ERROR;
DEBUGLOG(("CreateErrorAlertTpl: BOAlertEmail:ProcessTpl Failed\n"));
ERRLOG("check_auto_upload_error: CreateErrorAlertTpl: BOAlertEmail::ProcessTpl Failed, iRet=%d\n", iRet);
                }
                else
                {
DEBUGLOG(("CreateErrorAlertTpl: BOAlertEmail:ProcessTpl Success\n"));
                }
        }	

	hash_destroy(hContext);
	FREE_ME(hContext);
		
	return iRet;

geterrorlog_error:
DEBUGLOG(("geterrorlog_error error_code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    /*EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_getinfo;
    EXEC SQL ROLLBACK RELEASE;*/
    return PD_ERR;			
}
