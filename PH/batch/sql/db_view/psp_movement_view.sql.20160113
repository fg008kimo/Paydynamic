CREATE OR REPLACE FORCE VIEW PSP_MOVEMENT_VIEW
(
   TP_TXN_DATE,
   TP_PSP_ID,
   TH_TXN_CODE,
   TC_DESC,
   DT_DESC,
   TE_CCY,
   TE_AMOUNT,
   TE_AMT_TYPE,
   TP_REPORT_DATE,
   TH_APPROVAL_TIMESTAMP,
   TH_APPROVAL_DATE
)
AS
     SELECT /*+ NO_CPU_COSTING */
           tp_txn_date,
            tp_psp_id,
            th_txn_code,
            tc_desc,
            dt_desc,
            te_ccy,
            te_amount,
            te_amt_type,
            tp_report_date,
            th_approval_timestamp,
            th_approval_date
       FROM txn_psp_detail,
            (SELECT /*+ INDEX (txn_elements TXN_ELEMENTS_IDX04) */
                   te_txn_id,
                    te_txn_element_type,
                    te_amount,
                    te_ccy,
                    te_amt_type,
                    tc_desc,
                    dt_desc,
                    TXN_HEADER1.th_txn_code,
                    TXN_HEADER1.th_approval_timestamp,
                    TXN_HEADER1.th_approval_date
               FROM txn_elements,
                    (SELECT th_txn_id,
                            th_txn_code,
                            th_reserve_amount,
                            th_approval_timestamp,
                            th_approval_date,
                            tc_desc
                       FROM txn_header, txn_code
                      WHERE     th_ar_ind = 'A'
                            AND txn_code.tc_code = txn_header.th_txn_code
                            AND (   tc_code IN ('DSI',
                                                'DSP',
                                                'POG',
                                                'COG',
                                                'PBU',
                                                'VOG',
                                                'VDS',
                                                'VDR',
                                                'PST',
                                                'HDP',
                                                'UDP',
                                                'FPP',
                                                'OTP',
                                                'PTO',
                                                'PTF',
                                                'PTT',
                                                'TDC')
                                 OR tc_code LIKE 'p%')) TXN_HEADER1,
                    def_element_type /*,
                                    (SELECT th_txn_id,
                                            th_org_txn_id
                                       FROM txn_header TXN_HEADER3
                                      WHERE th_merchant_id IS NOT NULL
                                        AND th_ar_ind = 'A'
                                        AND th_org_txn_id IN (SELECT th_txn_id
                                                                FROM txn_header TXN_HEADER4
                                                               WHERE th_ar_ind = 'A')) void_th */
              WHERE     te_txn_element_type IN ('TAMT',
                                                'TFEE',
                                                'TRNF',
                                                'RAMT',
                                                'UAMT',
                                                'HAMT')
                    AND te_party_type = 'P'
                    AND te_txn_id = TXN_HEADER1.th_txn_id
                    AND te_txn_element_type = dt_type)
      --ND TXN_HEADER1.th_txn_id = void_th.th_org_txn_id (+))
      WHERE tp_txn_id = te_txn_id AND tp_txn_date IS NOT NULL
   ORDER BY tp_txn_date, tp_txn_id;

