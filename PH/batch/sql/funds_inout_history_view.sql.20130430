DROP VIEW FUNDS_INOUT_HISTORY_VIEW;

/* Formatted on 4/2/2013 9:31:01 PM (QP5 v5.240.12305.39476) */
CREATE OR REPLACE FORCE VIEW FUNDS_INOUT_HISTORY_VIEW
(
   TXN_DATE,
   FROM_CCY,
   FROM_AMT,
   BANK_CCY,
   BANK_AMT,
   OLD_RATE,
   NEW_RATE,
   BANK_BAL,
   TRANSACTION_TYPE,
   --CNT,
   TYPE,
   TRANSACTION_ID,
   TIME
)
AS
     SELECT txndate,
            fromccy,
            fromamt,
            bankccy,
            bankamt,
            oldrate,
            newrate,
            bankbal,
            transactionType,
            --COUNT (th_txn_id) cnt,
            CASE txncode
               WHEN 'STR' THEN 'Fund Out'
               WHEN 'FPP' THEN 'Fund Out'
               ELSE 'Fund In'
            END
               AS TYPE,
            CASE COUNT (th_txn_id)
               WHEN 1 THEN MAX (th_txn_id)
               ELSE MAX (th_txn_id)
            END
               AS TransactionID,
            MAX (time) AS time
       FROM (SELECT th_txn_id,
                    th_txn_code TxnCode,
                    tc_desc transactionType,
                    NVL (f_fundin_date, fo_fundout_date) AS TxnDate,
                    f_fundin_ccy AS FromCCY,
                    f_fundin_amount AS FromAmt,
                    NVL (f_bank_ccy, fo_fundout_ccy) AS BankCCY,
                    NVL (f_bank_amount, fo_fundout_amount) AS BankAmt,
                    fi_old_rate AS oldrate,
                    fi_new_rate AS newrate,
                    NVL (fi_bank_bal, fo_bank_bal) AS bankbal,
                    th_transaction_amount,
                    NVL (f_id, fo_id) FundsId,
                    NVL (f_update_timestamp, fo_update_timestamp) time
               FROM (SELECT th_txn_id,
                            tc_desc,
                            th_txn_code,
                            th_transaction_amount,
                            td_batch_id,
                            th_update_timestamp
                       FROM txn_header, txn_detail, txn_code
                      WHERE     th_txn_code IN
                                   ('PST', 'PSD', 'STR', 'FPM', 'FPP', 'OSD')
                            AND th_txn_id = td_txn_id
                            AND th_ar_ind = 'A'
                            AND th_status = 'C'
                            AND tc_code = th_txn_code
                            AND td_batch_id IS NOT NULL)
                    LEFT JOIN
                    (SELECT f_id,
                            f_fundin_date,
                            f_fundin_ccy,
                            f_fundin_amount,
                            f_bank_ccy,
                            f_bank_amount,
                            fi_old_rate,
                            fi_new_rate,
                            fi_bank_bal,
                            f_update_timestamp
                       FROM funds_in, funds_in_history
                      WHERE     fi_funds_in_date = f_fundin_date
                            AND fi_funds_in_ccy = f_fundin_ccy
                            AND fi_funds_in_amt = f_fundin_amount
                            AND fi_bank_ccy = f_bank_ccy
                            AND fi_bank_amt = f_bank_amount)
                       ON     f_id = td_batch_id
                          AND th_txn_code IN ('PST', 'PSD', 'FPM', 'OSD')
                    LEFT JOIN (SELECT fo_id,
                                      fo_fundout_date,
                                      fo_fundout_ccy,
                                      fo_fundout_amount,
                                      fo_bank_bal,
                                      fo_update_timestamp
                                 FROM funds_out)
                       ON fo_id = td_batch_id AND th_txn_code IN ('STR', 'FPP'))
   GROUP BY transactionType,
            txncode,
            txndate,
            fromccy,
            fromamt,
            bankccy,
            bankamt,
            oldrate,
            newrate,
            bankbal,
            fundsid
   ORDER BY txndate desc, time desc;

