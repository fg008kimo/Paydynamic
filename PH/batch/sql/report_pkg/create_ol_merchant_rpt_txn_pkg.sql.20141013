CREATE OR REPLACE PACKAGE OL_MERCHANT_RPT_PKG
IS
   FUNCTION F_MERCHANT_TXN_HISTORY (
      in_client_id                  ol_txn_header.oth_client_id%TYPE,
      in_merchant_id_list           VARCHAR2,
      in_create_timestamp_from      ol_txn_header.oth_create_timestamp%TYPE,
      in_create_timestamp_to        ol_txn_header.oth_create_timestamp%TYPE,
      in_approval_timestamp_from    ol_txn_header.oth_approval_timestamp%TYPE,
      in_approval_timestamp_to      ol_txn_header.oth_approval_timestamp%TYPE,
      in_country                    ol_txn_detail.otd_txn_country%TYPE,
      in_service_code               ol_txn_header.oth_service_code%TYPE,
      in_merchant_ref               ol_txn_header.oth_merchant_ref%TYPE,
      in_txn_id                     ol_txn_header.oth_txn_id%TYPE,
      in_txn_code_list              VARCHAR2,
      in_bank_code                  bank_desc.internal_bank_code%TYPE,
      in_min_amount                 ol_txn_header.oth_transaction_amount%TYPE,
      in_max_amount                 ol_txn_header.oth_transaction_amount%TYPE,
      in_status                     def_txn_status_map.dm_status_desc%TYPE,
      in_txn_ccy                    currency.currency_id%TYPE)
      RETURN ol_merchant_rpt_txn_tab;
END OL_MERCHANT_RPT_PKG;
/
CREATE OR REPLACE PACKAGE BODY OL_MERCHANT_RPT_PKG
IS
   FUNCTION F_MERCHANT_TXN_HISTORY (
      in_client_id                  ol_txn_header.oth_client_id%TYPE,
      in_merchant_id_list           VARCHAR2,
      in_create_timestamp_from      ol_txn_header.oth_create_timestamp%TYPE,
      in_create_timestamp_to        ol_txn_header.oth_create_timestamp%TYPE,
      in_approval_timestamp_from    ol_txn_header.oth_approval_timestamp%TYPE,
      in_approval_timestamp_to      ol_txn_header.oth_approval_timestamp%TYPE,
      in_country                    ol_txn_detail.otd_txn_country%TYPE,
      in_service_code               ol_txn_header.oth_service_code%TYPE,
      in_merchant_ref               ol_txn_header.oth_merchant_ref%TYPE,
      in_txn_id                     ol_txn_header.oth_txn_id%TYPE,
      in_txn_code_list              VARCHAR2,
      in_bank_code                  bank_desc.internal_bank_code%TYPE,
      in_min_amount                 ol_txn_header.oth_transaction_amount%TYPE,
      in_max_amount                 ol_txn_header.oth_transaction_amount%TYPE,
      in_status                     def_txn_status_map.dm_status_desc%TYPE,
      in_txn_ccy                    currency.currency_id%TYPE)
      RETURN ol_merchant_rpt_txn_tab
   IS
      result                         ol_merchant_rpt_txn_tab := ol_merchant_rpt_txn_tab ();
      n                              INTEGER := 0;
      v_txn_id                       ol_txn_header.oth_txn_id%TYPE;
      v_txn_country                  ol_txn_detail.otd_txn_country%TYPE;
      v_service_code                 ol_txn_header.oth_service_code%TYPE;
      v_mer_short_name               ol_merch_detail.md_short_name%TYPE;
      v_txn_type                     txn_code.tc_desc%TYPE;
      v_mer_ref                      ol_txn_header.oth_merchant_ref%TYPE;
      v_holdback_ccy                 currency.currency_id%TYPE;
      v_holdback_amt                 ol_txn_header.oth_transaction_amount%TYPE;
      v_status                       def_txn_status_map.dm_status_desc%TYPE;
      v_create_timestamp             ol_txn_header.oth_create_timestamp%TYPE;
      v_approval_timestamp           ol_txn_header.oth_approval_timestamp%TYPE;
      v_remark                       ol_txn_remarks.otr_remark%TYPE;
      v_mer_req_amt                  ol_txn_header.oth_transaction_amount%TYPE;
      v_mer_req_ccy                  currency.currency_id%TYPE;
      v_consumer_payable_amt         ol_txn_header.oth_transaction_amount%TYPE;
      v_consumer_payable_ccy         currency.currency_id%TYPE;
      v_unique_amt_markup            ol_txn_header.oth_transaction_amount%TYPE;
      v_consumer_paid_amt            ol_txn_header.oth_transaction_amount%TYPE;
      v_consumer_paid_ccy            currency.currency_id%TYPE;
      v_mer_received_amt             ol_txn_header.oth_transaction_amount%TYPE;
      v_mer_received_ccy             currency.currency_id%TYPE;
      v_txn_fee                      ol_txn_header.oth_transaction_amount%TYPE;
      v_txn_fee_ccy                  currency.currency_id%TYPE;
      v_mer_received_net_amt         ol_txn_header.oth_transaction_amount%TYPE;
      v_mer_received_net_ccy         currency.currency_id%TYPE;
      v_mer_payable_amt              ol_txn_header.oth_transaction_amount%TYPE;
      v_mer_payable_ccy              currency.currency_id%TYPE;
      v_consumer_received_amt        ol_txn_header.oth_transaction_amount%TYPE;
      v_consumer_received_ccy        currency.currency_id%TYPE;
      v_consumer_receivable_amt      ol_txn_header.oth_transaction_amount%TYPE;
      v_consumer_receivable_ccy      currency.currency_id%TYPE;
      v_mer_paid_amt                 ol_txn_header.oth_transaction_amount%TYPE;
      v_mer_paid_ccy                 currency.currency_id%TYPE;
      v_mer_paid_total_amt           ol_txn_header.oth_transaction_amount%TYPE;
      v_mer_paid_total_ccy           currency.currency_id%TYPE;
      v_mer_receivable_amt           ol_txn_header.oth_transaction_amount%TYPE;
      v_mer_receivable_ccy           currency.currency_id%TYPE;
      v_mer_receivable_net_amt       ol_txn_header.oth_transaction_amount%TYPE;
      v_mer_receivable_net_ccy       currency.currency_id%TYPE;
      v_final_mer_received_net_amt   ol_merchant_settlement_detail.osd_receive_net_amt%TYPE;
      v_final_mer_received_net_ccy   ol_merchant_settlement_detail.osd_receive_net_ccy%TYPE;
      v_transaction_amount           ol_txn_header.oth_transaction_amount%TYPE;
      v_transaction_ccy              currency.currency_id%TYPE;
      v_net_amount                   ol_txn_header.oth_net_amount%TYPE;
      v_net_ccy                      currency.currency_id%TYPE;
      v_merchant_id                  ol_txn_header.oth_merchant_id%TYPE;
      v_client_id                    ol_txn_header.oth_client_id%TYPE;
      v_oth_txn_code                 ol_txn_header.oth_txn_code%TYPE;
      v_oth_status                   ol_txn_header.oth_status%TYPE;
      v_ar_ind                       ol_txn_header.oth_ar_ind%TYPE;
      v_ack_status                   ol_txn_header.oth_ack_status%TYPE;
      v_cust_id                      client_magic.cm_cust_id%TYPE;
      v_txn_gp_id                    client_magic.cm_txn_gp_id%TYPE;
      v_psp_cost_amt                 ol_txn_elements.ote_amount%TYPE;
      v_psp_cost_amt_ccy             ol_txn_elements.ote_ccy%TYPE;
      v_ex_rate                      ol_txn_header.oth_ex_rate%TYPE;
      v_upload_channel               ol_txn_header.oth_upload_channel%TYPE;

      CURSOR ol_merchant_rpt_txn_cur
      IS
         SELECT transaction_id,
                country,
                service,
                mer_short_name,
                transaction_type,
                mer_reference,
                holdback_ccy,
                holdback_amount,
                status,
                create_timestamp,
                approval_timestamp,
                remark,
                mer_request_amt,
                mer_request_ccy,
                consumer_payable_amt,
                consumer_payable_ccy,
                unique_amt_markup,
                consumer_paid_amt,
                consumer_paid_ccy,
                mer_received_amt,
                mer_received_ccy,
                transaction_fee,
                transaction_fee_ccy,
                mer_received_net_amt,
                mer_received_net_amt_ccy,
                mer_payable_amount,
                mer_payable_ccy,
                consumer_received_amt,
                consumer_received_ccy,
                consumer_receivable_amt,
                consumer_receivable_ccy,
                mer_paid_amount,
                mer_paid_ccy,
                mer_paid_total_amt,
                mer_paid_total_amt_ccy,
                mer_receivable_amt,
                mer_receivable_ccy,
                mer_receivable_net_amt,
                mer_receivable_net_amt_ccy,
                final_mer_received_net_amt,
                final_mer_received_net_amt_ccy,
                transaction_amount,
                transaction_ccy,
                net_amount,
                net_ccy,
                merchant_id,
                client_id,
                oth_txn_code,
                oth_status,
                ar_ind,
                ack_status,
                cust_id,
                txn_gp_id,
                psp_cost_amt,
                psp_cost_amt_ccy,
                ex_rate,
                upload_channel
           FROM (                                                   -- deposit
                 SELECT oth_txn_id AS transaction_id,
                        otd_txn_country AS country,
                        oth_service_code AS service,
                        md_short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        oth_txn_code,
                        oth_merchant_ref AS mer_reference,
                        DECODE (
                           oth_txn_code,
                           'ODI', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          holdback.ote_ccy),
                           'MRN', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          holdback.ote_ccy),
                           'OAE', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          holdback.ote_ccy),
                           'VDS', holdback.ote_ccy,
                           'VDR', holdback.ote_ccy,
                           '')
                           AS holdback_ccy,
                        DECODE (
                           oth_txn_code,
                           'ODI', DECODE (oth_status,
                                          'I', 0,
                                          'W', 0,
                                          holdback.ote_amount),
                           'MRN', DECODE (oth_status,
                                          'I', 0,
                                          'W', 0,
                                          holdback.ote_amount),
                           'OAE', DECODE (oth_status,
                                          'I', 0,
                                          'W', 0,
                                          holdback.ote_amount),
                           'VDS', holdback.ote_amount,
                           'VDR', holdback.ote_amount,
                           0)
                           AS holdback_amount,
                        dm_status_desc AS status,
                        oth_create_timestamp AS create_timestamp,
                        oth_approval_timestamp AS approval_timestamp,
                        otd_remark AS remark,
                        oth_transaction_amount AS mer_request_amt,
                        otd_txn_ccy AS mer_request_ccy,
                        DECODE (oth_txn_code,
                                'ODI', oth_deposit_amount,
                                0)
                           AS consumer_payable_amt,
                        DECODE (oth_txn_code,
                                'ODI', otd_txn_ccy,
                                '')
                           AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        DECODE (oth_txn_code,
                                'ODI', otp_txn_amount,
                                'MRN', otp_txn_amount,
                                'OAE', otp_txn_amount,
                                0)
                           AS consumer_paid_amt,
                        DECODE (oth_txn_code,
                                'ODI', otp_txn_ccy,
                                'MRN', otp_txn_ccy,
                                'OAE', otp_txn_ccy,
                                '')
                           AS consumer_paid_ccy,
                        DECODE (
                           oth_txn_code,
                           'ODI', DECODE (
                                     oth_status,
                                     'I', 0,
                                     'W', 0,
                                       oth_net_amount
                                     + NVL (tfee.ote_amount, 0)),
                           'MRN', DECODE (
                                     oth_status,
                                     'I', 0,
                                     'W', 0,
                                       oth_net_amount
                                     + NVL (tfee.ote_amount, 0)),
                           'OAE', DECODE (
                                     oth_status,
                                     'I', 0,
                                     'W', 0,
                                       oth_net_amount
                                     + NVL (tfee.ote_amount, 0)),
                           0)
                           AS mer_received_amt,
                        DECODE (
                           oth_txn_code,
                           'ODI', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          oth_net_ccy),
                           'MRN', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          oth_net_ccy),
                           'OAE', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          oth_net_ccy),
                           '')
                           AS mer_received_ccy,
                        DECODE (
                           oth_txn_code,
                           'ODI', DECODE (oth_status,
                                          'I', 0,
                                          'W', 0,
                                          tfee.ote_amount),
                           'MRN', DECODE (oth_status,
                                          'I', 0,
                                          'W', 0,
                                          tfee.ote_amount),
                           'OAE', DECODE (oth_status,
                                          'I', 0,
                                          'W', 0,
                                          tfee.ote_amount),
                           'VDS', tfee.ote_amount,
                           'VDR', tfee.ote_amount,
                           0)
                           AS transaction_fee,
                        DECODE (
                           oth_txn_code,
                           'ODI', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          tfee.ote_ccy),
                           'MRN', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          tfee.ote_ccy),
                           'OAE', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          tfee.ote_ccy),
                           'VDS', tfee.ote_ccy,
                           'VDR', tfee.ote_ccy,
                           '')
                           AS transaction_fee_ccy,
                        DECODE (
                           oth_txn_code,
                           'ODI', DECODE (oth_status,
                                          'I', 0,
                                          'W', 0,
                                          oth_net_amount),
                           'MRN', DECODE (oth_status,
                                          'I', 0,
                                          'W', 0,
                                          oth_net_amount),
                           'OAE', DECODE (oth_status,
                                          'I', 0,
                                          'W', 0,
                                          oth_net_amount),
                           0)
                           AS mer_received_net_amt,
                        DECODE (
                           oth_txn_code,
                           'ODI', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          oth_net_ccy),
                           'MRN', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          oth_net_ccy),
                           'OAE', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          oth_net_ccy),
                           '')
                           AS mer_received_net_amt_ccy,
                        0 AS mer_payable_amount,
                        '' AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        0 AS consumer_receivable_amt,
                        '' AS consumer_receivable_ccy,
                        DECODE (
                           oth_txn_code,
                           'VDS', oth_net_amount + NVL (tfee.ote_amount, 0),
                           'VDR', oth_net_amount + NVL (tfee.ote_amount, 0),
                           0)
                           AS mer_paid_amount,
                        DECODE (oth_txn_code,
                                'VDS', oth_net_ccy,
                                'VDR', oth_net_ccy,
                                '')
                           AS mer_paid_ccy,
                        DECODE (oth_txn_code,
                                'VDS', oth_net_amount,
                                'VDR', oth_net_amount,
                                0)
                           AS mer_paid_total_amt,
                        DECODE (oth_txn_code,
                                'VDS', oth_net_ccy,
                                'VDR', oth_net_ccy,
                                '')
                           AS mer_paid_total_amt_ccy,
                        0 mer_receivable_amt,
                        '' AS mer_receivable_ccy,
                        0 mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        otp_bank_code,
                        oth_transaction_amount AS transaction_amount,
                        otd_txn_ccy AS transaction_ccy,
                        DECODE (
                           oth_txn_code,
                           'ODI', DECODE (oth_status,
                                          'I', 0,
                                          'W', 0,
                                          oth_net_amount),
                           'MRN', DECODE (oth_status,
                                          'I', 0,
                                          'W', 0,
                                          oth_net_amount),
                           'OAE', DECODE (oth_status,
                                          'I', 0,
                                          'W', 0,
                                          oth_net_amount),
                           'VDS', oth_net_amount,
                           'VDR', oth_net_amount,
                           0)
                           AS net_amount,
                        DECODE (
                           oth_txn_code,
                           'ODI', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          oth_net_ccy),
                           'MRN', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          oth_net_ccy),
                           'OAE', DECODE (oth_status,
                                          'I', '',
                                          'W', '',
                                          oth_net_ccy),
                           'VDS', oth_net_ccy,
                           'VDR', oth_net_ccy,
                           '')
                           AS net_ccy,
                        oth_merchant_id AS merchant_id,
                        oth_client_id AS client_id,
                        oth_status,
                        oth_ar_ind AS ar_ind,
                        oth_ack_status AS ack_status,
                        NULL AS cust_id,
                        NULL AS txn_gp_id,
                        DECODE (oth_txn_code,
                                'ODI', psp_cost.ote_amount,
                                'MRN', psp_cost.ote_amount,
                                'OAE', psp_cost.ote_amount,
                                'VDS', psp_cost.ote_amount,
                                0)
                           AS psp_cost_amt,
                        DECODE (oth_txn_code,
                                'ODI', psp_cost.ote_ccy,
                                'MRN', psp_cost.ote_ccy,
                                'OAE', psp_cost.ote_ccy,
                                'VDS', psp_cost.ote_ccy,
                                '')
                           AS psp_cost_amt_ccy,
                        0 AS final_mer_received_net_amt,
                        '' AS final_mer_received_net_amt_ccy,
                        oth_ex_rate AS ex_rate,
                        oth_upload_channel AS upload_channel
                   FROM (SELECT oth_txn_id,
                                oth_service_code,
                                oth_merchant_id,
                                oth_txn_code,
                                oth_merchant_ref,
                                dm_status_desc,
                                oth_create_timestamp,
                                oth_approval_timestamp,
                                oth_transaction_amount,
                                oth_net_amount,
                                oth_net_ccy,
                                oth_client_id,
                                oth_status,
                                oth_ar_ind,
                                oth_ack_status,
                                oth_dst_txn_id,
                                oth_deposit_amount,
                                oth_ex_rate,
                                oth_upload_channel
                           FROM ol_txn_header, def_txn_status_map
                          WHERE     (    oth_status = dm_status
                                     AND (   oth_ar_ind = dm_ar_ind
                                          OR oth_ar_ind IS NULL)
                                     AND oth_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND oth_create_timestamp >=
                                       NVL (in_create_timestamp_from,
                                            oth_create_timestamp)
                                AND oth_create_timestamp <=
                                       NVL (in_create_timestamp_to,
                                            oth_create_timestamp)
                                AND (   (oth_approval_timestamp >=
                                            in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND (   (oth_approval_timestamp <
                                            in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   oth_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   oth_merchant_ref like '%'||in_merchant_ref||'%'
                                     OR in_merchant_ref IS NULL)
                                AND oth_txn_id = NVL (in_txn_id, oth_txn_id)
                                AND (   in_min_amount <=
                                           oth_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   oth_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   oth_merchant_id IN (    SELECT REGEXP_SUBSTR (
                                                                          in_merchant_id_list,
                                                                          '[^,]+',
                                                                          1,
                                                                          LEVEL)
                                                                          token
                                                                  FROM DUAL
                                                            CONNECT BY LEVEL <=
                                                                            LENGTH (
                                                                               in_merchant_id_list)
                                                                          - LENGTH (
                                                                               REPLACE (
                                                                                  in_merchant_id_list,
                                                                                  ',',
                                                                                  ''))
                                                                          + 1)
                                     OR in_merchant_id_list IS NULL)
                                AND (   oth_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                --                                AND (    oth_txn_code IN ('ODI', 'VDS', 'VDR')
                                AND (    oth_txn_code IN ('ODI', 'MRN', 'OAE')
                                     AND (   oth_txn_code IN (    SELECT REGEXP_SUBSTR (
                                                                            in_txn_code_list,
                                                                            '[^,]+',
                                                                            1,
                                                                            LEVEL)
                                                                            token
                                                                    FROM DUAL
                                                              CONNECT BY LEVEL <=
                                                                              LENGTH (
                                                                                 in_txn_code_list)
                                                                            - LENGTH (
                                                                                 REPLACE (
                                                                                    in_txn_code_list,
                                                                                    ',',
                                                                                    ''))
                                                                            + 1)
                                          OR in_txn_code_list IS NULL
                                          OR in_txn_code_list = 'TRAN')))
                        ol_txn_header
                        LEFT JOIN ol_txn_elements tfee
                           ON     oth_txn_id = tfee.ote_txn_id
                              AND tfee.ote_txn_element_type = 'TFEE'
                              AND tfee.ote_party_type = 'M'
                        LEFT JOIN ol_txn_elements holdback
                           ON     oth_txn_id = holdback.ote_txn_id
                              AND holdback.ote_txn_element_type = 'RAMT'
                              AND holdback.ote_party_type = 'M'
                        LEFT JOIN ol_txn_elements psp_cost
                           ON     oth_txn_id = psp_cost.ote_txn_id
                              AND psp_cost.ote_txn_element_type = 'TFEE'
                              AND psp_cost.ote_party_type = 'P'
                        LEFT JOIN ol_txn_psp_detail
                           ON oth_dst_txn_id = otp_txn_id,
                        ol_txn_detail,
                        ol_merch_detail,
                        txn_code
                  WHERE     oth_txn_id = otd_txn_id
                        AND oth_merchant_id = md_merchant_id
                        AND oth_txn_code = tc_code
                        AND (   otd_txn_country = in_country
                             OR in_country IS NULL)
                        AND (otd_txn_ccy = in_txn_ccy OR in_txn_ccy IS NULL)
                        AND oth_txn_code = txn_code.tc_code
                        AND txn_code.tc_ofl_merchant_fe_display = 1
                        AND (   ol_txn_psp_detail.otp_bank_code =
                                   in_bank_code
                             OR in_bank_code IS NULL)
                 UNION
                 -- Merch Sett
                 SELECT oth_txn_id AS transaction_id,
                        otd_txn_country AS country,
                        oth_service_code AS service,
                        md_short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        oth_txn_code,
                        oth_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        oth_create_timestamp AS create_timestamp,
                        oth_approval_timestamp AS approval_timestamp,
                        NVL (cancel_remarks.otr_remark,
                             req_remarks.otr_remark)
                           AS remark,
                        oth_transaction_amount AS mer_request_amt,
                        otd_txn_ccy AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        0 AS mer_received_amt,
                        '' AS mer_received_ccy,
                        tfee.ote_amount AS transaction_fee,
                        tfee.ote_ccy AS transaction_fee_ccy,
                        NVL (osd_deliver_amt, 0) AS mer_received_net_amt,
                        osd_deliver_ccy AS mer_received_net_amt_ccy,
                        0 AS mer_payable_amount,
                        '' AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        0 AS consumer_receivable_amt,
                        '' AS consumer_receivable_ccy,
                        0 AS mer_paid_amount,
                        '' AS mer_paid_ccy,
                        0 AS mer_paid_total_amt,
                        '' AS mer_paid_total_amt_ccy,
                        0 AS mer_receivable_amt,
                        '' AS mer_receivable_ccy,
                        DECODE (
                           dm_status_desc,
                           'Approved',   oth_transaction_amount
                                       - NVL (tfee.ote_amount, 0),
                           NULL)
                           AS mer_receivable_net_amt,
                        DECODE (dm_status_desc,
                                'Approved', otd_txn_ccy,
                                NULL)
                           AS mer_receivable_net_amt_ccy,
                        NULL AS otp_bank_code,
                        oth_transaction_amount AS transaction_amount,
                        otd_txn_ccy AS transaction_ccy,
                        oth_net_amount AS net_amount,
                        oth_net_ccy AS net_ccy,
                        oth_merchant_id AS merchant_id,
                        oth_client_id AS client_id,
                        oth_status,
                        oth_ar_ind AS ar_ind,
                        oth_ack_status AS ack_status,
                        '' AS cust_id,
                        NULL AS txn_gp_id,
                        psp_cost.ote_amount AS psp_cost_amt,
                        psp_cost.ote_ccy AS psp_cost_amt_ccy,
                        NVL (osd_receive_net_amt, 0)
                           AS final_mer_received_net_amt,
                        osd_receive_net_ccy AS final_mer_received_net_amt_ccy,
                        oth_ex_rate AS ex_rate,
                        oth_upload_channel AS upload_channel
                   FROM (SELECT oth_txn_id,
                                oth_service_code,
                                oth_merchant_id,
                                oth_txn_code,
                                oth_merchant_ref,
                                dm_status_desc,
                                oth_create_timestamp,
                                oth_approval_timestamp,
                                oth_transaction_amount,
                                oth_net_amount,
                                oth_net_ccy,
                                oth_client_id,
                                oth_status,
                                oth_ar_ind,
                                oth_ack_status,
                                oth_ex_rate,
                                oth_upload_channel
                           FROM ol_txn_header, def_txn_status_map
                          WHERE     (    oth_status = dm_status
                                     AND (   oth_ar_ind = dm_ar_ind
                                          OR oth_ar_ind IS NULL)
                                     AND oth_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND oth_create_timestamp >=
                                       NVL (in_create_timestamp_from,
                                            oth_create_timestamp)
                                AND oth_create_timestamp <=
                                       NVL (in_create_timestamp_to,
                                            oth_create_timestamp)
                                AND (   (oth_approval_timestamp >=
                                            in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND (   (oth_approval_timestamp <
                                            in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   oth_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   oth_merchant_ref like '%'||in_merchant_ref||'%'
                                     OR in_merchant_ref IS NULL)
                                AND oth_txn_id = NVL (in_txn_id, oth_txn_id)
                                AND (   in_min_amount <=
                                           oth_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   oth_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   oth_merchant_id IN (    SELECT REGEXP_SUBSTR (
                                                                          in_merchant_id_list,
                                                                          '[^,]+',
                                                                          1,
                                                                          LEVEL)
                                                                          token
                                                                  FROM DUAL
                                                            CONNECT BY LEVEL <=
                                                                            LENGTH (
                                                                               in_merchant_id_list)
                                                                          - LENGTH (
                                                                               REPLACE (
                                                                                  in_merchant_id_list,
                                                                                  ',',
                                                                                  ''))
                                                                          + 1)
                                     OR in_merchant_id_list IS NULL)
                                AND (   oth_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                AND (    oth_txn_code = 'OSR'
                                     AND (   oth_txn_code IN (    SELECT REGEXP_SUBSTR (
                                                                            in_txn_code_list,
                                                                            '[^,]+',
                                                                            1,
                                                                            LEVEL)
                                                                            token
                                                                    FROM DUAL
                                                              CONNECT BY LEVEL <=
                                                                              LENGTH (
                                                                                 in_txn_code_list)
                                                                            - LENGTH (
                                                                                 REPLACE (
                                                                                    in_txn_code_list,
                                                                                    ',',
                                                                                    ''))
                                                                            + 1)
                                          OR in_txn_code_list IS NULL
                                          OR in_txn_code_list = 'TRAN')))
                        ol_txn_header
                        LEFT JOIN ol_txn_elements tfee
                           ON     oth_txn_id = tfee.ote_txn_id
                              AND tfee.ote_txn_element_type = 'TFEE'
                              AND tfee.ote_party_type = 'M'
                        LEFT JOIN ol_txn_elements psp_cost
                           ON     oth_txn_id = psp_cost.ote_txn_id
                              AND psp_cost.ote_txn_element_type = 'TFEE'
                              AND psp_cost.ote_party_type = 'P'
                        LEFT JOIN ol_merchant_settlement_detail
                           ON oth_txn_id = osd_txn_id
                        LEFT JOIN ol_txn_remarks req_remarks
                           ON     osd_txn_id = req_remarks.otr_txn_id
                              AND req_remarks.otr_sub_status IN ('124', '125')
                        LEFT JOIN ol_txn_remarks cancel_remarks
                           ON     osd_txn_id = cancel_remarks.otr_txn_id
                              AND cancel_remarks.otr_sub_status IN ('110',
                                                                    '111',
                                                                    '139'),
                        ol_txn_detail,
                        ol_merch_detail,
                        txn_code
                  WHERE     oth_txn_id = otd_txn_id
                        AND oth_merchant_id = md_merchant_id
                        AND oth_txn_code = tc_code
                        AND in_bank_code IS NULL
                        AND (   otd_txn_country = in_country
                             OR in_country IS NULL)
                        AND (otd_txn_ccy = in_txn_ccy OR in_txn_ccy IS NULL)
                        AND oth_txn_code = txn_code.tc_code
                        AND txn_code.tc_ofl_merchant_fe_display = 1
                 UNION
                 -- payout
                 SELECT oth_txn_id AS transaction_id,
                        otd_txn_country AS country,
                        oth_service_code AS service,
                        md_short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        oth_txn_code,
                        oth_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        oth_create_timestamp AS create_timestamp,
                        oth_approval_timestamp AS approval_timestamp,
                        otd_remark AS remark,
                        oth_transaction_amount AS mer_request_amt,
                        otd_txn_ccy AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        DECODE (oth_txn_code,
                                'OVA', oth_transaction_amount,
                                'OVR', oth_transaction_amount,
                                0)
                           AS mer_received_amt,
                        DECODE (oth_txn_code,
                                'OVA', otd_txn_ccy,
                                'OVR', otd_txn_ccy,
                                '')
                           AS mer_received_ccy,
                        DECODE (oth_txn_code,
                                'OPA', tfee.ote_amount,
                                'OVA', org_tfee.ote_amount,
                                'OVR', org_tfee.ote_amount,
                                0)
                           AS transaction_fee,
                        DECODE (oth_txn_code,
                                'OPA', tfee.ote_ccy,
                                'OVA', org_tfee.ote_ccy,
                                'OVR', org_tfee.ote_ccy,
                                '')
                           AS transaction_fee_ccy,
                        DECODE (oth_txn_code,
                                'OVA', oth_net_amount,
                                'OVR', oth_net_amount,
                                0)
                           AS mer_received_net_amt,
                        DECODE (oth_txn_code,
                                'OVA', oth_net_ccy,
                                'OVR', oth_net_ccy,
                                '')
                           AS mer_received_net_amt_ccy,
                        DECODE (
                           oth_txn_code,
                           'OPA', oth_net_amount - NVL (tfee.ote_amount, 0),
                           0)
                           AS mer_payable_amount,
                        DECODE (oth_txn_code, 'OPA', oth_net_ccy, '')
                           AS mer_payable_ccy,
                        NVL (oud_payout_amount, 0) AS consumer_received_amt,
                        oud_payout_currency AS consumer_received_ccy,
                        DECODE (oth_txn_code,
                                'OVA', oth_transaction_amount,
                                'OVR', oth_transaction_amount,
                                0)
                           AS consumer_receivable_amt,
                        DECODE (oth_txn_code,
                                'OVA', otd_txn_ccy,
                                'OVR', otd_txn_ccy,
                                '')
                           AS consumer_receivable_ccy,
                        DECODE (
                           oth_txn_code,
                           'OPA', oth_net_amount - NVL (tfee.ote_amount, 0),
                           0)
                           AS mer_paid_amount,
                        DECODE (oth_txn_code, 'OPA', oth_net_ccy, '')
                           AS mer_paid_ccy,
                        DECODE (oth_txn_code, 'OPA', oth_net_amount, 0)
                           AS mer_paid_total_amt,
                        DECODE (oth_txn_code, 'OPA', oth_net_ccy, '')
                           AS mer_paid_total_amt_ccy,
                        0 AS mer_receivable_amt,
                        '' AS mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        bd.internal_bank_code AS otp_bank_code,
                        oth_transaction_amount AS transaction_amount,
                        otd_txn_ccy AS transaction_ccy,
                        oth_net_amount AS net_amount,
                        oth_net_ccy AS net_ccy,
                        oth_merchant_id AS merchant_id,
                        oth_client_id AS client_id,
                        oth_status,
                        oth_ar_ind AS ar_ind,
                        oth_ack_status AS ack_status,
                        '' AS cust_id,
                        NULL AS txn_gp_id,
                        DECODE (oth_txn_code,
                                'OPA', psp_cost.ote_amount,
                                'OVA', psp_cost.ote_amount,
                                0)
                           AS psp_cost_amt,
                        DECODE (oth_txn_code,
                                'OPA', psp_cost.ote_ccy,
                                'OVA', psp_cost.ote_ccy,
                                '')
                           AS psp_cost_amt_ccy,
                        0 AS final_mer_received_net_amt,
                        '' AS final_mer_received_net_amt_ccy,
                        oth_ex_rate AS ex_rate,
                        oth_upload_channel AS upload_channel
                   FROM (SELECT oth_txn_id,
                                oth_service_code,
                                oth_merchant_id,
                                oth_txn_code,
                                oth_merchant_ref,
                                dm_status_desc,
                                oth_create_timestamp,
                                oth_approval_timestamp,
                                oth_transaction_amount,
                                oth_net_amount,
                                oth_net_ccy,
                                oth_client_id,
                                oth_status,
                                oth_ar_ind,
                                oth_ack_status,
                                oth_org_txn_id,
                                oth_ex_rate,
                                oth_upload_channel
                           FROM ol_txn_header, def_txn_status_map
                          WHERE     (    oth_status = dm_status
                                     AND (   oth_ar_ind = dm_ar_ind
                                          OR oth_ar_ind IS NULL)
                                     AND oth_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND oth_create_timestamp >=
                                       NVL (in_create_timestamp_from,
                                            oth_create_timestamp)
                                AND oth_create_timestamp <=
                                       NVL (in_create_timestamp_to,
                                            oth_create_timestamp)
                                AND (   (oth_approval_timestamp >=
                                            in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND (   (oth_approval_timestamp <
                                            in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   oth_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   oth_merchant_ref like '%'||in_merchant_ref||'%'
                                     OR in_merchant_ref IS NULL)
                                AND oth_txn_id = NVL (in_txn_id, oth_txn_id)
                                AND (   in_min_amount <=
                                           oth_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   oth_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   oth_merchant_id IN (    SELECT REGEXP_SUBSTR (
                                                                          in_merchant_id_list,
                                                                          '[^,]+',
                                                                          1,
                                                                          LEVEL)
                                                                          token
                                                                  FROM DUAL
                                                            CONNECT BY LEVEL <=
                                                                            LENGTH (
                                                                               in_merchant_id_list)
                                                                          - LENGTH (
                                                                               REPLACE (
                                                                                  in_merchant_id_list,
                                                                                  ',',
                                                                                  ''))
                                                                          + 1)
                                     OR in_merchant_id_list IS NULL)
                                AND (   oth_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                AND (    oth_txn_code IN ('OPA', 'OVA', 'OVR')
                                     AND (   oth_txn_code IN (    SELECT REGEXP_SUBSTR (
                                                                            in_txn_code_list,
                                                                            '[^,]+',
                                                                            1,
                                                                            LEVEL)
                                                                            token
                                                                    FROM DUAL
                                                              CONNECT BY LEVEL <=
                                                                              LENGTH (
                                                                                 in_txn_code_list)
                                                                            - LENGTH (
                                                                                 REPLACE (
                                                                                    in_txn_code_list,
                                                                                    ',',
                                                                                    ''))
                                                                            + 1)
                                          OR in_txn_code_list IS NULL
                                          OR in_txn_code_list = 'TRAN')))
                        ol_txn_header
                        LEFT JOIN ol_txn_elements tfee
                           ON     oth_txn_id = tfee.ote_txn_id
                              AND tfee.ote_txn_element_type = 'TFEE'
                              AND tfee.ote_party_type = 'M'
                        LEFT JOIN ol_txn_elements org_tfee
                           ON     oth_org_txn_id = org_tfee.ote_txn_id
                              AND org_tfee.ote_txn_element_type = 'TFEE'
                              AND org_tfee.ote_party_type = 'M'
                        LEFT JOIN ol_txn_elements psp_cost
                           ON     oth_txn_id = psp_cost.ote_txn_id
                              AND psp_cost.ote_txn_element_type = 'TFEE'
                              AND psp_cost.ote_party_type = 'P'
                        LEFT JOIN ol_merchant_upload_file_detail
                           ON DECODE (oth_txn_code, 'OPA', oth_txn_id, oth_org_txn_id) =
                                 oud_txn_id,
                        ol_txn_detail
                        LEFT JOIN bank_desc bd
                           ON     otd_bank_name = bd.bank_name
                              AND otd_txn_country = bd.country,
                        ol_merch_detail,
                        txn_code
                  WHERE     oth_txn_id = otd_txn_id
                        AND oth_merchant_id = md_merchant_id
                        AND oth_txn_code = tc_code
                        AND (   bd.internal_bank_code = in_bank_code
                             OR in_bank_code IS NULL)
                        AND (   otd_txn_country = in_country
                             OR in_country IS NULL)
                        AND (otd_txn_ccy = in_txn_ccy OR in_txn_ccy IS NULL)
                        AND oth_txn_code = txn_code.tc_code
                        AND txn_code.tc_ofl_merchant_fe_display = 1
                 UNION
                 -- lien and release lien
                 SELECT oth_txn_id AS transaction_id,
                        otd_txn_country AS country,
                        oth_service_code AS service,
                        md_short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        oth_txn_code,
                        oth_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        oth_create_timestamp AS create_timestamp,
                        oth_approval_timestamp AS approval_timestamp,
                        otd_remark AS remark,
                        0 AS mer_request_amt,
                        '' AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        DECODE (oth_txn_code,
                                'UHD', oth_transaction_amount,
                                '')
                           AS mer_received_amt,
                        DECODE (oth_txn_code, 'UHD', otd_txn_ccy, '')
                           AS mer_received_ccy,
                        0 AS transaction_fee,
                        '' AS transaction_fee_ccy,
                        0 AS mer_received_net_amt,
                        '' AS mer_received_net_amt_ccy,
                        DECODE (oth_txn_code,
                                'OHD', oth_transaction_amount,
                                '')
                           AS mer_payable_amount,
                        DECODE (oth_txn_code, 'OHD', otd_txn_ccy, '')
                           AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        0 AS consumer_receivable_amt,
                        '' AS consumer_receivable_ccy,
                        DECODE (oth_txn_code,
                                'OHD', oth_transaction_amount,
                                '')
                           AS mer_paid_amount,
                        DECODE (oth_txn_code, 'OHD', otd_txn_ccy, '')
                           AS mer_paid_ccy,
                        0 AS mer_paid_total_amt,
                        '' AS mer_paid_total_amt_ccy,
                        DECODE (oth_txn_code,
                                'UHD', oth_transaction_amount,
                                '')
                           AS mer_receivable_amt,
                        DECODE (oth_txn_code, 'UHD', otd_txn_ccy, '')
                           AS mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        NULL AS otp_bank_code,
                        oth_transaction_amount AS transaction_amount,
                        otd_txn_ccy AS transaction_ccy,
                        NVL (oth_net_amount, oth_transaction_amount)
                           AS net_amount,
                        NVL (oth_net_ccy, otd_txn_ccy) AS net_ccy,
                        oth_merchant_id AS merchant_id,
                        oth_client_id AS client_id,
                        oth_status,
                        oth_ar_ind AS ar_ind,
                        oth_ack_status AS ack_status,
                        '' AS cust_id,
                        NULL AS txn_gp_id,
                        0 AS psp_cost_amt,
                        '' AS psp_cost_amt_ccy,
                        0 AS final_mer_received_net_amt,
                        '' AS final_mer_received_net_amt_ccy,
                        oth_ex_rate AS ex_rate,
                        oth_upload_channel AS upload_channel
                   FROM (SELECT oth_txn_id,
                                oth_service_code,
                                oth_merchant_id,
                                oth_txn_code,
                                oth_merchant_ref,
                                dm_status_desc,
                                oth_create_timestamp,
                                oth_approval_timestamp,
                                oth_transaction_amount,
                                oth_net_amount,
                                oth_net_ccy,
                                oth_client_id,
                                oth_status,
                                oth_ar_ind,
                                oth_ack_status,
                                oth_ex_rate,
                                oth_upload_channel
                           FROM ol_txn_header, def_txn_status_map
                          WHERE     (    oth_status = dm_status
                                     AND (   oth_ar_ind = dm_ar_ind
                                          OR oth_ar_ind IS NULL)
                                     AND oth_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND oth_create_timestamp >=
                                       NVL (in_create_timestamp_from,
                                            oth_create_timestamp)
                                AND oth_create_timestamp <=
                                       NVL (in_create_timestamp_to,
                                            oth_create_timestamp)
                                AND (   (oth_approval_timestamp >=
                                            in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND (   (oth_approval_timestamp <
                                            in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   oth_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   oth_merchant_ref like '%'||in_merchant_ref||'%'
                                     OR in_merchant_ref IS NULL)
                                AND oth_txn_id = NVL (in_txn_id, oth_txn_id)
                                AND (   in_min_amount <=
                                           oth_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   oth_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   oth_merchant_id IN (    SELECT REGEXP_SUBSTR (
                                                                          in_merchant_id_list,
                                                                          '[^,]+',
                                                                          1,
                                                                          LEVEL)
                                                                          token
                                                                  FROM DUAL
                                                            CONNECT BY LEVEL <=
                                                                            LENGTH (
                                                                               in_merchant_id_list)
                                                                          - LENGTH (
                                                                               REPLACE (
                                                                                  in_merchant_id_list,
                                                                                  ',',
                                                                                  ''))
                                                                          + 1)
                                     OR in_merchant_id_list IS NULL)
                                AND (   oth_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                AND (    oth_txn_code IN ('OHD', 'UHD')
                                     AND (   oth_txn_code IN (    SELECT REGEXP_SUBSTR (
                                                                            in_txn_code_list,
                                                                            '[^,]+',
                                                                            1,
                                                                            LEVEL)
                                                                            token
                                                                    FROM DUAL
                                                              CONNECT BY LEVEL <=
                                                                              LENGTH (
                                                                                 in_txn_code_list)
                                                                            - LENGTH (
                                                                                 REPLACE (
                                                                                    in_txn_code_list,
                                                                                    ',',
                                                                                    ''))
                                                                            + 1)
                                          OR in_txn_code_list IS NULL
                                          OR in_txn_code_list = 'TRAN')))
                        ol_txn_header,
                        ol_txn_detail,
                        ol_merch_detail,
                        txn_code
                  WHERE     oth_txn_id = otd_txn_id
                        AND oth_merchant_id = md_merchant_id
                        AND oth_txn_code = tc_code
                        AND in_bank_code IS NULL
                        AND (   otd_txn_country = in_country
                             OR in_country IS NULL)
                        AND (otd_txn_ccy = in_txn_ccy OR in_txn_ccy IS NULL)
                        AND oth_txn_code = txn_code.tc_code
                        AND txn_code.tc_ofl_merchant_fe_display = 1
                 UNION
                 -- release expired holdback
                 --                 SELECT oth_txn_id AS transaction_id,
                 --                        otd_txn_country AS country,
                 --                        oth_service_code AS service,
                 --                        md_short_name AS mer_short_name,
                 --                        tc_desc AS transaction_type,
                 --                        oth_txn_code,
                 --                        oth_merchant_ref AS mer_reference,
                 --                        '' AS holdback_ccy,
                 --                        0 AS holdback_amount,
                 --                        dm_status_desc AS status,
                 --                        oth_create_timestamp AS create_timestamp,
                 --                        oth_approval_timestamp AS approval_timestamp,
                 --                        otd_remark AS remark,
                 --                        0 AS mer_request_amt,
                 --                        '' AS mer_request_ccy,
                 --                        0 AS consumer_payable_amt,
                 --                        '' AS consumer_payable_ccy,
                 --                        0 AS unique_amt_markup,
                 --                        0 AS consumer_paid_amt,
                 --                        '' AS consumer_paid_ccy,
                 --                        NULL AS mer_received_amt,
                 --                        otd_txn_ccy AS mer_received_ccy,
                 --                        0 AS transaction_fee,
                 --                        '' AS transaction_fee_ccy,
                 --                        0 AS mer_received_net_amt,
                 --                        '' AS mer_received_net_amt_ccy,
                 --                        0 AS mer_payable_amount,
                 --                        '' AS mer_payable_ccy,
                 --                        0 AS consumer_received_amt,
                 --                        '' AS consumer_received_ccy,
                 --                        0 AS consumer_receivable_amt,
                 --                        '' AS consumer_receivable_ccy,
                 --                        0 AS mer_paid_amount,
                 --                        '' AS mer_paid_ccy,
                 --                        0 AS mer_paid_total_amt,
                 --                        '' AS mer_paid_total_amt_ccy,
                 --                        0 AS mer_receivable_amt,
                 --                        '' AS mer_receivable_ccy,
                 --                        0 AS mer_receivable_net_amt,
                 --                        '' AS mer_receivable_net_amt_ccy,
                 --                        NULL AS otp_bank_code,
                 --                        NULL AS transaction_amount,
                 --                        otd_txn_ccy AS transaction_ccy,
                 --                        NULL AS net_amount,
                 --                        oth_net_ccy AS net_ccy,
                 --                        oth_merchant_id AS merchant_id,
                 --                        oth_client_id AS client_id,
                 --                        oth_status,
                 --                        oth_ar_ind AS ar_ind,
                 --                        oth_ack_status AS ack_status,
                 --                        '' AS cust_id,
                 --                        NULL AS txn_gp_id,
                 --                        0 AS psp_cost_amt,
                 --                        '' AS psp_cost_amt_ccy,
                 --                        0 AS final_mer_received_net_amt,
                 --                        '' AS final_mer_received_net_amt_ccy,
                 --                        oth_ex_rate AS ex_rate,
                 --                        oth_upload_channel AS upload_channel
                 --                   FROM (SELECT oth_txn_id,
                 --                                oth_service_code,
                 --                                oth_merchant_id,
                 --                                oth_txn_code,
                 --                                oth_merchant_ref,
                 --                                dm_status_desc,
                 --                                oth_create_timestamp,
                 --                                oth_approval_timestamp,
                 --                                oth_transaction_amount,
                 --                                oth_net_amount,
                 --                                oth_net_ccy,
                 --                                oth_client_id,
                 --                                oth_status,
                 --                                oth_ar_ind,
                 --                                oth_ack_status,
                 --                                oth_ex_rate,
                 --                                oth_upload_channel
                 --                           FROM ol_txn_header, def_txn_status_map
                 --                          WHERE     (    oth_status = dm_status
                 --                                     AND (   oth_ar_ind = dm_ar_ind
                 --                                          OR oth_ar_ind IS NULL)
                 --                                     AND oth_txn_code = dm_txn_code
                 --                                     AND dm_type = 'M')
                 --                                AND (   dm_status_desc = in_status
                 --                                     OR in_status IS NULL)
                 --                                AND oth_create_timestamp >=
                 --                                       NVL (in_create_timestamp_from,
                 --                                            oth_create_timestamp)
                 --                                AND oth_create_timestamp <=
                 --                                       NVL (in_create_timestamp_to,
                 --                                            oth_create_timestamp)
                 --                                AND (   (oth_approval_timestamp >=
                 --                                            in_approval_timestamp_from)
                 --                                     OR in_approval_timestamp_from IS NULL)
                 --                                AND (   (oth_approval_timestamp <
                 --                                            in_approval_timestamp_to)
                 --                                     OR in_approval_timestamp_to IS NULL)
                 --                                AND (   oth_service_code = in_service_code
                 --                                     OR in_service_code IS NULL)
                 --                                AND (   oth_merchant_ref like '%'||in_merchant_ref||'%'
                 --                                     OR in_merchant_ref IS NULL)
                 --                                AND oth_txn_id = NVL (in_txn_id, oth_txn_id)
                 --                                AND (   in_min_amount <=
                 --                                           oth_transaction_amount
                 --                                     OR in_min_amount IS NULL)
                 --                                AND (   oth_transaction_amount <=
                 --                                           in_max_amount
                 --                                     OR in_max_amount IS NULL)
                 --                                AND (   oth_merchant_id IN (    SELECT REGEXP_SUBSTR (
                 --                                                                          in_merchant_id_list,
                 --                                                                          '[^,]+',
                 --                                                                          1,
                 --                                                                          LEVEL)
                 --                                                                          token
                 --                                                                  FROM DUAL
                 --                                                            CONNECT BY LEVEL <=
                 --                                                                            LENGTH (
                 --                                                                               in_merchant_id_list)
                 --                                                                          - LENGTH (
                 --                                                                               REPLACE (
                 --                                                                                  in_merchant_id_list,
                 --                                                                                  ',',
                 --                                                                                  ''))
                 --                                                                          + 1)
                 --                                     OR in_merchant_id_list IS NULL)
                 --                                AND (   oth_client_id = in_client_id
                 --                                     OR in_client_id IS NULL)
                 --                                AND (    oth_txn_code IN ('RLR', 'HBR', 'VHB')
                 --                                     AND (   oth_txn_code IN (    SELECT REGEXP_SUBSTR (
                 --                                                                            in_txn_code_list,
                 --                                                                            '[^,]+',
                 --                                                                            1,
                 --                                                                            LEVEL)
                 --                                                                            token
                 --                                                                    FROM DUAL
                 --                                                              CONNECT BY LEVEL <=
                 --                                                                              LENGTH (
                 --                                                                                 in_txn_code_list)
                 --                                                                            - LENGTH (
                 --                                                                                 REPLACE (
                 --                                                                                    in_txn_code_list,
                 --                                                                                    ',',
                 --                                                                                    ''))
                 --                                                                            + 1)
                 --                                          OR in_txn_code_list IS NULL
                 --                                          OR in_txn_code_list = 'TRAN')))
                 --                        ol_txn_header,
                 --                        ol_txn_detail,
                 --                        ol_merch_detail,
                 --                        txn_code
                 --                  WHERE     oth_txn_id = otd_txn_id
                 --                        AND oth_merchant_id = md_merchant_id
                 --                        AND oth_txn_code = tc_code
                 --                        AND in_bank_code IS NULL
                 --                        AND (   otd_txn_country = in_country
                 --                            OR in_country IS NULL)
                 --                        AND (   otd_txn_ccy = in_txn_ccy
                 --                            OR in_txn_ccy IS NULL)
                 --                        AND oth_txn_code = txn_code.tc_code
                 --                        AND txn_code.tc_ofl_merchant_fe_display = 1
                 --                 UNION
                 -- balance transfer
                 SELECT th.oth_txn_id AS transaction_id,
                        otd_txn_country AS country,
                        oth_service_code AS service,
                        md_short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        oth_txn_code,
                        oth_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        oth_create_timestamp AS create_timestamp,
                        oth_approval_timestamp AS approval_timestamp,
                        otd_remark AS remark,
                        DECODE (oth_txn_code,
                                'OMI', th.oth_transaction_amount,
                                'OTT', oth.oth_transaction_amount,
                                'ORT', oth.oth_transaction_amount,
                                'OMO', th.oth_transaction_amount,
                                'OTF', th.oth_transaction_amount,
                                'ORF', th.oth_transaction_amount,
                                'OMP', th.oth_transaction_amount,
                                0)
                           AS mer_request_amt,
                        DECODE (oth_txn_code,
                                'OMI', td.otd_txn_ccy,
                                'OTT', otd.otd_txn_ccy,
                                'ORT', otd.otd_txn_ccy,
                                'OMO', td.otd_txn_ccy,
                                'OTF', td.otd_txn_ccy,
                                'ORF', td.otd_txn_ccy,
                                'OMP', td.otd_txn_ccy,
                                '')
                           AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        DECODE (
                           oth_txn_code,
                           'OMI', oth_net_amount + NVL (tfee.ote_amount, 0),
                           'OTT', oth_net_amount + NVL (tfee.ote_amount, 0),
                           'ORT', oth_net_amount + NVL (tfee.ote_amount, 0),
                           'OMP', oth_net_amount + NVL (tfee.ote_amount, 0),
                           0)
                           AS mer_received_amt,
                        DECODE (oth_txn_code,
                                'OMI', oth_net_ccy,
                                'OTT', oth_net_ccy,
                                'ORT', oth_net_ccy,
                                'OMP', oth_net_ccy,
                                '')
                           AS mer_received_ccy,
                        tfee.ote_amount AS transaction_fee,
                        tfee.ote_ccy AS transaction_fee_ccy,
                        DECODE (oth_txn_code,
                                'OMI', oth_net_amount,
                                'OTT', oth_net_amount,
                                'ORT', oth_net_amount,
                                'OMP', oth_net_amount,
                                0)
                           AS mer_received_net_amt,
                        DECODE (oth_txn_code,
                                'OMI', oth_net_ccy,
                                'OTT', oth_net_ccy,
                                'ORT', oth_net_ccy,
                                'OMP', oth_net_ccy,
                                '')
                           AS mer_received_net_amt_ccy,
                        0 AS mer_payable_amount,
                        '' AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        0 AS consumer_receivable_amt,
                        '' AS consumer_receivable_ccy,
                        0 AS mer_paid_amount,
                        '' AS mer_paid_ccy,
                        DECODE (oth_txn_code,
                                'OMO', oth_net_amount,
                                'OTF', oth_net_amount,
                                'ORF', oth_net_amount,
                                0)
                           AS mer_paid_total_amt,
                        DECODE (oth_txn_code,
                                'OMO', oth_net_ccy,
                                'OTF', oth_net_ccy,
                                'ORF', oth_net_ccy,
                                '')
                           AS mer_paid_total_amt_ccy,
                        0 AS mer_receivable_amt,
                        '' mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        NULL AS otp_bank_code,
                        DECODE (oth_txn_code,
                                'OMI', th.oth_transaction_amount,
                                'OTT', oth.oth_transaction_amount,
                                'ORT', oth.oth_transaction_amount,
                                'OMO', th.oth_transaction_amount,
                                'OTF', th.oth_transaction_amount,
                                'ORF', th.oth_transaction_amount,
                                'OMP', th.oth_transaction_amount,
                                0)
                           AS transaction_amount,
                        DECODE (oth_txn_code,
                                'OMI', td.otd_txn_ccy,
                                'OTT', otd.otd_txn_ccy,
                                'ORT', otd.otd_txn_ccy,
                                'OMO', td.otd_txn_ccy,
                                'OTF', td.otd_txn_ccy,
                                'ORF', td.otd_txn_ccy,
                                'OMP', td.otd_txn_ccy,
                                '')
                           AS transaction_ccy,
                        oth_net_amount AS net_amount,
                        oth_net_ccy AS net_ccy,
                        oth_merchant_id AS merchant_id,
                        oth_client_id AS client_id,
                        oth_status,
                        oth_ar_ind AS ar_ind,
                        oth_ack_status AS ack_status,
                        '' AS cust_id,
                        NULL AS txn_gp_id,
                        DECODE (oth_txn_code,
                                'OMI', psp_cost.ote_amount,
                                'OMO', psp_cost.ote_amount,
                                0)
                           AS psp_cost_amt,
                        DECODE (oth_txn_code,
                                'OMI', psp_cost.ote_ccy,
                                'OMO', psp_cost.ote_ccy,
                                '')
                           AS psp_cost_amt_ccy,
                        0 AS final_mer_received_net_amt,
                        '' AS final_mer_received_net_amt_ccy,
                        oth_ex_rate AS ex_rate,
                        oth_upload_channel AS upload_channel
                   FROM (SELECT oth_txn_id,
                                oth_org_txn_id,
                                oth_service_code,
                                oth_merchant_id,
                                oth_txn_code,
                                oth_merchant_ref,
                                dm_status_desc,
                                oth_create_timestamp,
                                oth_approval_timestamp,
                                oth_transaction_amount,
                                oth_net_amount,
                                oth_net_ccy,
                                oth_client_id,
                                oth_status,
                                oth_ar_ind,
                                oth_ack_status,
                                oth_ex_rate,
                                oth_upload_channel
                           FROM ol_txn_header, def_txn_status_map
                          WHERE     (    oth_status = dm_status
                                     AND (   oth_ar_ind = dm_ar_ind
                                          OR oth_ar_ind IS NULL)
                                     AND oth_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND oth_create_timestamp >=
                                       NVL (in_create_timestamp_from,
                                            oth_create_timestamp)
                                AND oth_create_timestamp <=
                                       NVL (in_create_timestamp_to,
                                            oth_create_timestamp)
                                AND (   (oth_approval_timestamp >=
                                            in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND (   (oth_approval_timestamp <
                                            in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   oth_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   oth_merchant_ref like '%'||in_merchant_ref||'%'
                                     OR in_merchant_ref IS NULL)
                                AND oth_txn_id = NVL (in_txn_id, oth_txn_id)
                                AND (   in_min_amount <=
                                           oth_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   oth_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   oth_merchant_id IN (    SELECT REGEXP_SUBSTR (
                                                                          in_merchant_id_list,
                                                                          '[^,]+',
                                                                          1,
                                                                          LEVEL)
                                                                          token
                                                                  FROM DUAL
                                                            CONNECT BY LEVEL <=
                                                                            LENGTH (
                                                                               in_merchant_id_list)
                                                                          - LENGTH (
                                                                               REPLACE (
                                                                                  in_merchant_id_list,
                                                                                  ',',
                                                                                  ''))
                                                                          + 1)
                                     OR in_merchant_id_list IS NULL)
                                AND (   oth_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                AND (    oth_txn_code IN ('OMI',
                                                          'OTT',
                                                          'ORT',
                                                          'OMO',
                                                          'OTF',
                                                          'ORF',
                                                          'OMP')
                                     AND (   oth_txn_code IN (    SELECT REGEXP_SUBSTR (
                                                                            in_txn_code_list,
                                                                            '[^,]+',
                                                                            1,
                                                                            LEVEL)
                                                                            token
                                                                    FROM DUAL
                                                              CONNECT BY LEVEL <=
                                                                              LENGTH (
                                                                                 in_txn_code_list)
                                                                            - LENGTH (
                                                                                 REPLACE (
                                                                                    in_txn_code_list,
                                                                                    ',',
                                                                                    ''))
                                                                            + 1)
                                          OR in_txn_code_list IS NULL
                                          OR in_txn_code_list = 'TRAN'))) th
                        LEFT JOIN
                        (SELECT oth_txn_id, oth_transaction_amount
                           FROM ol_txn_header) oth
                           ON th.oth_org_txn_id = oth.oth_txn_id
                        LEFT JOIN
                        (SELECT otd_txn_id, otd_txn_ccy FROM ol_txn_detail)
                        otd
                           ON th.oth_org_txn_id = otd.otd_txn_id
                        LEFT JOIN ol_txn_elements tfee
                           ON     th.oth_txn_id = tfee.ote_txn_id
                              AND tfee.ote_txn_element_type = 'TFEE'
                              AND tfee.ote_party_type = 'M'
                        LEFT JOIN ol_txn_elements psp_cost
                           ON     th.oth_txn_id = psp_cost.ote_txn_id
                              AND psp_cost.ote_txn_element_type = 'TFEE'
                              AND psp_cost.ote_party_type = 'P',
                        ol_txn_detail td,
                        ol_merch_detail,
                        txn_code
                  WHERE     th.oth_txn_id = td.otd_txn_id
                        AND oth_merchant_id = md_merchant_id
                        AND oth_txn_code = tc_code
                        AND in_bank_code IS NULL
                        AND (   otd_txn_country = in_country
                             OR in_country IS NULL)
                        AND (   DECODE (oth_txn_code,
                                        'OMI', td.otd_txn_ccy,
                                        'OTT', otd.otd_txn_ccy,
                                        'ORT', otd.otd_txn_ccy,
                                        'OMO', td.otd_txn_ccy,
                                        'OTF', td.otd_txn_ccy,
                                        'ORF', td.otd_txn_ccy,
                                        'OMP', td.otd_txn_ccy,
                                        '') = in_txn_ccy
                             OR in_txn_ccy IS NULL)
                        AND oth_txn_code = txn_code.tc_code
                        AND DECODE (
                               txn_code.tc_code,
                               'OMP', txn_code.tc_ofl_merchant_fe_display,
                               'OMO', txn_code.tc_ofl_merchant_fe_display,
                               1) = 1
                 UNION
                 -- merchant fund in for payout
                 SELECT oth_txn_id AS transaction_id,
                        otd_txn_country AS country,
                        oth_service_code AS service,
                        md_short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        oth_txn_code,
                        oth_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        oth_create_timestamp AS create_timestamp,
                        oth_approval_timestamp AS approval_timestamp,
                        otd_remark AS remark,
                        oth_transaction_amount AS mer_request_amt,
                        otd_txn_ccy AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        0 AS mer_received_amt,
                        '' AS mer_received_ccy,
                        tfee.ote_amount AS transaction_fee,
                        tfee.ote_ccy AS transaction_fee_ccy,
                        oth_net_amount AS mer_received_net_amt,
                        oth_net_ccy AS mer_received_net_amt_ccy,
                        0 AS mer_payable_amount,
                        '' AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        0 AS consumer_receivable_amt,
                        '' AS consumer_receivable_ccy,
                        0 AS mer_paid_amount,
                        '' AS mer_paid_ccy,
                        0 AS mer_paid_total_amt,
                        '' AS mer_paid_total_amt_ccy,
                        0 AS mer_receivable_amt,
                        '' AS mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        NULL AS otp_bank_code,
                        oth_transaction_amount AS transaction_amount,
                        otd_txn_ccy AS transaction_ccy,
                        oth_net_amount AS net_amount,
                        oth_net_ccy AS net_ccy,
                        oth_merchant_id AS merchant_id,
                        oth_client_id AS client_id,
                        oth_status,
                        oth_ar_ind AS ar_ind,
                        oth_ack_status AS ack_status,
                        '' AS cust_id,
                        NULL AS txn_gp_id,
                        0 AS psp_cost_amt,
                        '' AS psp_cost_amt_ccy,
                        0 AS final_mer_received_net_amt,
                        '' AS final_mer_received_net_amt_ccy,
                        oth_ex_rate AS ex_rate,
                        oth_upload_channel AS upload_channel
                   FROM (SELECT oth_txn_id,
                                oth_service_code,
                                oth_merchant_id,
                                oth_txn_code,
                                oth_merchant_ref,
                                dm_status_desc,
                                oth_create_timestamp,
                                oth_approval_timestamp,
                                oth_transaction_amount,
                                oth_net_amount,
                                oth_net_ccy,
                                oth_client_id,
                                oth_status,
                                oth_ar_ind,
                                oth_ack_status,
                                oth_ex_rate,
                                oth_upload_channel
                           FROM ol_txn_header, def_txn_status_map
                          WHERE     (    oth_status = dm_status
                                     AND (   oth_ar_ind = dm_ar_ind
                                          OR oth_ar_ind IS NULL)
                                     AND oth_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND oth_create_timestamp >=
                                       NVL (in_create_timestamp_from,
                                            oth_create_timestamp)
                                AND oth_create_timestamp <=
                                       NVL (in_create_timestamp_to,
                                            oth_create_timestamp)
                                AND (   (oth_approval_timestamp >=
                                            in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND (   (oth_approval_timestamp <
                                            in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   oth_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   oth_merchant_ref like '%'||in_merchant_ref||'%'
                                     OR in_merchant_ref IS NULL)
                                AND oth_txn_id = NVL (in_txn_id, oth_txn_id)
                                AND (   in_min_amount <=
                                           oth_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   oth_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   oth_merchant_id IN (    SELECT REGEXP_SUBSTR (
                                                                          in_merchant_id_list,
                                                                          '[^,]+',
                                                                          1,
                                                                          LEVEL)
                                                                          token
                                                                  FROM DUAL
                                                            CONNECT BY LEVEL <=
                                                                            LENGTH (
                                                                               in_merchant_id_list)
                                                                          - LENGTH (
                                                                               REPLACE (
                                                                                  in_merchant_id_list,
                                                                                  ',',
                                                                                  ''))
                                                                          + 1)
                                     OR in_merchant_id_list IS NULL)
                                AND (   oth_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                AND (    oth_txn_code = 'FIM'
                                     AND (   oth_txn_code IN (    SELECT REGEXP_SUBSTR (
                                                                            in_txn_code_list,
                                                                            '[^,]+',
                                                                            1,
                                                                            LEVEL)
                                                                            token
                                                                    FROM DUAL
                                                              CONNECT BY LEVEL <=
                                                                              LENGTH (
                                                                                 in_txn_code_list)
                                                                            - LENGTH (
                                                                                 REPLACE (
                                                                                    in_txn_code_list,
                                                                                    ',',
                                                                                    ''))
                                                                            + 1)
                                          OR in_txn_code_list IS NULL
                                          OR in_txn_code_list = 'TRAN')))
                        ol_txn_header
                        LEFT JOIN ol_txn_elements tfee
                           ON     oth_txn_id = tfee.ote_txn_id
                              AND tfee.ote_txn_element_type = 'TFEE'
                              AND tfee.ote_party_type = 'M',
                        ol_txn_detail,
                        ol_merch_detail,
                        txn_code
                  WHERE     oth_txn_id = otd_txn_id
                        AND oth_merchant_id = md_merchant_id
                        AND oth_txn_code = tc_code
                        AND in_bank_code IS NULL
                        AND (   otd_txn_country = in_country
                             OR in_country IS NULL)
                        AND (otd_txn_ccy = in_txn_ccy OR in_txn_ccy IS NULL)
                        AND oth_txn_code = txn_code.tc_code
                        AND txn_code.tc_ofl_merchant_fe_display = 1
                 UNION
                 -- adjustment
                 SELECT oth_txn_id AS transaction_id,
                        otd_txn_country AS country,
                        oth_service_code AS service,
                        md_short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        oth_txn_code,
                        oth_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        oth_create_timestamp AS create_timestamp,
                        oth_approval_timestamp AS approval_timestamp,
                        otd_remark AS remark,
                        0 AS mer_request_amt,
                        '' AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        DECODE (
                           OAT_DC_IND,
                           'C', oth_net_amount + NVL (tfee.ote_amount, 0),
                           0)
                           AS mer_received_amt,
                        DECODE (OAT_DC_IND, 'C', oth_net_ccy, '')
                           AS mer_received_ccy,
                        0 AS transaction_fee,
                        '' AS transaction_fee_ccy,
                        DECODE (OAT_DC_IND, 'C', oth_net_amount, 0)
                           AS mer_received_net_amt,
                        DECODE (OAT_DC_IND, 'C', oth_net_ccy, '')
                           AS mer_received_net_amt_ccy,
                        0 AS mer_payable_amount,
                        '' AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        0 AS consumer_receivable_amt,
                        '' AS consumer_receivable_ccy,
                        DECODE (OAT_DC_IND, 'D', oth_net_amount, 0)
                           AS mer_paid_amount,
                        DECODE (OAT_DC_IND, 'D', oth_net_ccy, '')
                           AS mer_paid_ccy,
                        0 AS mer_paid_total_amt,
                        '' AS mer_paid_total_amt_ccy,
                        0 AS mer_receivable_amt,
                        '' AS mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        NULL AS otp_bank_code,
                        oth_transaction_amount AS transaction_amount,
                        otd_txn_ccy AS transaction_ccy,
                        oth_net_amount AS net_amount,
                        oth_net_ccy AS net_ccy,
                        oth_merchant_id AS merchant_id,
                        oth_client_id AS client_id,
                        oth_status,
                        oth_ar_ind AS ar_ind,
                        oth_ack_status AS ack_status,
                        '' AS cust_id,
                        NULL AS txn_gp_id,
                        0 AS psp_cost_amt,
                        '' AS psp_cost_amt_ccy,
                        0 AS final_mer_received_net_amt,
                        '' AS final_mer_received_net_amt_ccy,
                        oth_ex_rate AS ex_rate,
                        oth_upload_channel AS upload_channel
                   FROM (SELECT oth_txn_id,
                                oth_service_code,
                                oth_merchant_id,
                                oth_txn_code,
                                oth_merchant_ref,
                                dm_status_desc,
                                oth_create_timestamp,
                                oth_approval_timestamp,
                                oth_transaction_amount,
                                oth_net_amount,
                                oth_net_ccy,
                                oth_client_id,
                                oth_status,
                                oth_ar_ind,
                                oth_ack_status,
                                oth_ex_rate,
                                oth_upload_channel
                           FROM ol_txn_header, def_txn_status_map
                          WHERE     (    oth_status = dm_status
                                     AND (   oth_ar_ind = dm_ar_ind
                                          OR oth_ar_ind IS NULL)
                                     AND oth_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND oth_create_timestamp >=
                                       NVL (in_create_timestamp_from,
                                            oth_create_timestamp)
                                AND oth_create_timestamp <=
                                       NVL (in_create_timestamp_to,
                                            oth_create_timestamp)
                                AND (   (oth_approval_timestamp >=
                                            in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND (   (oth_approval_timestamp <
                                            in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   oth_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   oth_merchant_ref like '%'||in_merchant_ref||'%'
                                     OR in_merchant_ref IS NULL)
                                AND oth_txn_id = NVL (in_txn_id, oth_txn_id)
                                AND (   in_min_amount <=
                                           oth_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   oth_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   oth_merchant_id IN (    SELECT REGEXP_SUBSTR (
                                                                          in_merchant_id_list,
                                                                          '[^,]+',
                                                                          1,
                                                                          LEVEL)
                                                                          token
                                                                  FROM DUAL
                                                            CONNECT BY LEVEL <=
                                                                            LENGTH (
                                                                               in_merchant_id_list)
                                                                          - LENGTH (
                                                                               REPLACE (
                                                                                  in_merchant_id_list,
                                                                                  ',',
                                                                                  ''))
                                                                          + 1)
                                     OR in_merchant_id_list IS NULL)
                                AND (   oth_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                AND (    oth_txn_code LIKE 'a%'
                                     AND (   oth_txn_code IN (    SELECT REGEXP_SUBSTR (
                                                                            in_txn_code_list,
                                                                            '[^,]+',
                                                                            1,
                                                                            LEVEL)
                                                                            token
                                                                    FROM DUAL
                                                              CONNECT BY LEVEL <=
                                                                              LENGTH (
                                                                                 in_txn_code_list)
                                                                            - LENGTH (
                                                                                 REPLACE (
                                                                                    in_txn_code_list,
                                                                                    ',',
                                                                                    ''))
                                                                            + 1)
                                          OR in_txn_code_list IS NULL
                                          OR in_txn_code_list = 'NONT')))
                        ol_txn_header
                        LEFT JOIN ol_txn_elements tfee
                           ON     oth_txn_id = tfee.ote_txn_id
                              AND tfee.ote_txn_element_type = 'TFEE'
                              AND tfee.ote_party_type = 'M',
                        (SELECT oat_code, oat_dc_ind FROM ol_adjustment_type),
                        ol_txn_detail,
                        ol_merch_detail,
                        txn_code
                  WHERE     oth_txn_id = otd_txn_id
                        AND oth_merchant_id = md_merchant_id
                        AND oth_txn_code = tc_code
                        AND oth_txn_code = oat_code
                        AND in_bank_code IS NULL
                        AND (   otd_txn_country = in_country
                             OR in_country IS NULL)
                        AND (otd_txn_ccy = in_txn_ccy OR in_txn_ccy IS NULL)
                        AND oth_txn_code = txn_code.tc_code
                        AND txn_code.tc_ofl_merchant_fe_display = 1)
          WHERE     (   oth_txn_code IN (    SELECT REGEXP_SUBSTR (
                                                       in_txn_code_list,
                                                       '[^,]+',
                                                       1,
                                                       LEVEL)
                                                       token
                                               FROM DUAL
                                         CONNECT BY LEVEL <=
                                                         LENGTH (
                                                            in_txn_code_list)
                                                       - LENGTH (
                                                            REPLACE (
                                                               in_txn_code_list,
                                                               ',',
                                                               ''))
                                                       + 1)
                     OR in_txn_code_list IS NULL
                     OR in_txn_code_list = 'NONT'
                     OR in_txn_code_list = 'TRAN')
                AND (otp_bank_code = in_bank_code OR in_bank_code IS NULL);
   BEGIN
      OPEN ol_merchant_rpt_txn_cur;

      LOOP
         FETCH ol_merchant_rpt_txn_cur
            INTO v_txn_id,
                 v_txn_country,
                 v_service_code,
                 v_mer_short_name,
                 v_txn_type,
                 v_mer_ref,
                 v_holdback_ccy,
                 v_holdback_amt,
                 v_status,
                 v_create_timestamp,
                 v_approval_timestamp,
                 v_remark,
                 v_mer_req_amt,
                 v_mer_req_ccy,
                 v_consumer_payable_amt,
                 v_consumer_payable_ccy,
                 v_unique_amt_markup,
                 v_consumer_paid_amt,
                 v_consumer_paid_ccy,
                 v_mer_received_amt,
                 v_mer_received_ccy,
                 v_txn_fee,
                 v_txn_fee_ccy,
                 v_mer_received_net_amt,
                 v_mer_received_net_ccy,
                 v_mer_payable_amt,
                 v_mer_payable_ccy,
                 v_consumer_received_amt,
                 v_consumer_received_ccy,
                 v_consumer_receivable_amt,
                 v_consumer_receivable_ccy,
                 v_mer_paid_amt,
                 v_mer_paid_ccy,
                 v_mer_paid_total_amt,
                 v_mer_paid_total_ccy,
                 v_mer_receivable_amt,
                 v_mer_receivable_ccy,
                 v_mer_receivable_net_amt,
                 v_mer_receivable_net_ccy,
                 v_final_mer_received_net_amt,
                 v_final_mer_received_net_ccy,
                 v_transaction_amount,
                 v_transaction_ccy,
                 v_net_amount,
                 v_net_ccy,
                 v_merchant_id,
                 v_client_id,
                 v_oth_txn_code,
                 v_oth_status,
                 v_ar_ind,
                 v_ack_status,
                 v_cust_id,
                 v_txn_gp_id,
                 v_psp_cost_amt,
                 v_psp_cost_amt_ccy,
                 v_ex_rate,
                 v_upload_channel;

         EXIT WHEN ol_merchant_rpt_txn_cur%NOTFOUND;

         result.EXTEND;
         n := n + 1;
         result (n) :=
            ol_merchant_rpt_txn_obj (v_txn_id,
                                     v_txn_country,
                                     v_service_code,
                                     v_mer_short_name,
                                     v_txn_type,
                                     v_mer_ref,
                                     v_holdback_ccy,
                                     v_holdback_amt,
                                     v_status,
                                     v_create_timestamp,
                                     v_approval_timestamp,
                                     v_remark,
                                     v_mer_req_amt,
                                     v_mer_req_ccy,
                                     v_consumer_payable_amt,
                                     v_consumer_payable_ccy,
                                     v_unique_amt_markup,
                                     v_consumer_paid_amt,
                                     v_consumer_paid_ccy,
                                     v_mer_received_amt,
                                     v_mer_received_ccy,
                                     v_txn_fee,
                                     v_txn_fee_ccy,
                                     v_mer_received_net_amt,
                                     v_mer_received_net_ccy,
                                     v_mer_payable_amt,
                                     v_mer_payable_ccy,
                                     v_consumer_received_amt,
                                     v_consumer_received_ccy,
                                     v_consumer_receivable_amt,
                                     v_consumer_receivable_ccy,
                                     v_mer_paid_amt,
                                     v_mer_paid_ccy,
                                     v_mer_paid_total_amt,
                                     v_mer_paid_total_ccy,
                                     v_mer_receivable_amt,
                                     v_mer_receivable_ccy,
                                     v_mer_receivable_net_amt,
                                     v_mer_receivable_net_ccy,
                                     v_final_mer_received_net_amt,
                                     v_final_mer_received_net_ccy,
                                     v_transaction_amount,
                                     v_transaction_ccy,
                                     v_net_amount,
                                     v_net_ccy,
                                     v_merchant_id,
                                     v_client_id,
                                     v_oth_txn_code,
                                     v_oth_status,
                                     v_ar_ind,
                                     v_ack_status,
                                     v_cust_id,
                                     v_txn_gp_id,
                                     v_psp_cost_amt,
                                     v_psp_cost_amt_ccy,
                                     v_ex_rate,
                                     v_upload_channel);
      END LOOP;

      CLOSE ol_merchant_rpt_txn_cur;

      RETURN (result);
   EXCEPTION
      WHEN OTHERS
      THEN
         CLOSE ol_merchant_rpt_txn_cur;

         RETURN NULL;
   END F_MERCHANT_TXN_HISTORY;
END OL_MERCHANT_RPT_PKG;
/
