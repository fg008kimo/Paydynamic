CREATE OR REPLACE PACKAGE MERCHANT_RPT_PKG
IS
   FUNCTION F_MERCHANT_TXN_HISTORY (
      in_client_id                  TXN_HEADER.TH_CLIENT_ID%TYPE,
      in_merchant_id                TXN_HEADER.TH_MERCHANT_ID%TYPE,
      in_create_timestamp_from      txn_header.th_create_timestamp%TYPE,
      in_create_timestamp_to        txn_header.th_create_timestamp%TYPE,
      in_approval_timestamp_from    txn_header.th_approval_timestamp%TYPE,
      in_approval_timestamp_to      txn_header.th_approval_timestamp%TYPE,
      in_country                    txn_detail.td_txn_country%TYPE,
      in_service_code               txn_header.th_service_code%TYPE,
      in_merchant_ref               txn_header.th_merchant_ref%TYPE,
      in_txn_id                     txn_header.th_txn_id%TYPE,
      in_txn_code                   TXN_CODE.TC_CODE%TYPE,
      in_bank_code                BANK_DESC.INTERNAL_BANK_CODE%TYPE,
      in_min_amount               TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE,
      in_max_amount               TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE,
      in_status                   def_txn_status_map.dm_status_desc%TYPE)
      RETURN merchant_rpt_txn_tab;
END MERCHANT_RPT_PKG;
/
CREATE OR REPLACE PACKAGE BODY MERCHANT_RPT_PKG
IS
   FUNCTION F_MERCHANT_TXN_HISTORY (
      in_client_id                  TXN_HEADER.TH_CLIENT_ID%TYPE,
      in_merchant_id                TXN_HEADER.TH_MERCHANT_ID%TYPE,
      in_create_timestamp_from      TXN_HEADER.th_create_timestamp%TYPE,
      in_create_timestamp_to        TXN_HEADER.th_create_timestamp%TYPE,
      in_approval_timestamp_from    TXN_HEADER.th_approval_timestamp%TYPE,
      in_approval_timestamp_to      TXN_HEADER.th_approval_timestamp%TYPE,
      in_country                    txn_detail.td_txn_country%TYPE,
      in_service_code               TXN_HEADER.th_service_code%TYPE,
      in_merchant_ref               TXN_HEADER.th_merchant_ref%TYPE,
      in_txn_id                     TXN_HEADER.th_txn_id%TYPE,
      in_txn_code                   TXN_CODE.TC_CODE%TYPE,
      in_bank_code                  BANK_DESC.INTERNAL_BANK_CODE%TYPE,
      in_min_amount                 TXN_HEADER.th_transaction_amount%TYPE,
      in_max_amount                 TXN_HEADER.th_transaction_amount%TYPE,
      in_status                     def_txn_status_map.dm_status_desc%TYPE)
      RETURN merchant_rpt_txn_tab
   IS
      Result                     merchant_rpt_txn_tab := merchant_rpt_txn_tab ();
      n                          INTEGER := 0;
      v_txn_id                   TXN_HEADER.th_txn_id%TYPE;
      v_txn_country              TXN_DETAIL.TD_TXN_COUNTRY%TYPE;
      v_service_code             TXN_HEADER.th_service_code%TYPE;
      v_mer_short_name           MERCH_DETAIL.SHORT_NAME%TYPE;
      v_txn_type                 TXN_CODE.TC_DESC%TYPE;
      v_mer_ref                  TXN_HEADER.th_merchant_ref%TYPE;
      v_holdback_ccy             CURRENCY.CURRENCY_ID%TYPE;
      v_holdback_amt             TXN_HEADER.th_transaction_amount%TYPE;
      v_status                   DEF_TXN_STATUS_MAP.dm_status_desc%TYPE;
      v_create_timestamp         TXN_HEADER.th_create_timestamp%TYPE;
      v_approval_timestamp       TXN_HEADER.th_approval_timestamp%TYPE;
      v_remark                   TXN_DETAIL.TD_REMARK%TYPE;
      v_mer_req_amt              TXN_HEADER.th_transaction_amount%TYPE;
      v_mer_req_ccy              currency.currency_id%TYPE;
      v_consumer_payable_amt     TXN_HEADER.th_transaction_amount%TYPE;
      v_consumer_payable_ccy     currency.currency_id%TYPE;
      v_unique_amt_markup        TXN_HEADER.th_transaction_amount%TYPE;
      v_consumer_paid_amt        TXN_HEADER.th_transaction_amount%TYPE;
      v_consumer_paid_ccy        currency.currency_id%TYPE;
      v_mer_received_amt         TXN_HEADER.th_transaction_amount%TYPE;
      v_mer_received_ccy         currency.currency_id%TYPE;
      v_txn_fee                  TXN_HEADER.th_transaction_amount%TYPE;
      v_txn_fee_ccy              currency.currency_id%TYPE;
      v_mer_received_net_amt     TXN_HEADER.th_transaction_amount%TYPE;
      v_mer_received_net_ccy     currency.currency_id%TYPE;
      v_mer_payable_amt          TXN_HEADER.th_transaction_amount%TYPE;
      v_mer_payable_ccy          currency.currency_id%TYPE;
      v_consumer_received_amt    TXN_HEADER.th_transaction_amount%TYPE;
      v_consumer_received_ccy    currency.currency_id%TYPE;
      v_mer_paid_amt             TXN_HEADER.th_transaction_amount%TYPE;
      v_mer_paid_ccy             currency.currency_id%TYPE;
      v_mer_paid_total_amt       TXN_HEADER.th_transaction_amount%TYPE;
      v_mer_paid_total_ccy       currency.currency_id%TYPE;
      v_mer_receivable_amt       TXN_HEADER.th_transaction_amount%TYPE;
      v_mer_receivable_ccy       currency.currency_id%TYPE;
      v_mer_receivable_net_amt   TXN_HEADER.th_transaction_amount%TYPE;
      v_mer_receivable_net_ccy   currency.currency_id%TYPE;
      v_transaction_amount       TXN_HEADER.th_transaction_amount%TYPE;
      v_transaction_ccy          currency.currency_id%TYPE;
      v_net_amount               TXN_HEADER.th_net_amount%TYPE;
      v_net_ccy                  currency.currency_id%TYPE;
      v_merchant_id              TXN_HEADER.th_merchant_id%TYPE;
      v_client_id                TXN_HEADER.th_client_id%TYPE;
      v_th_txn_code              TXN_HEADER.th_txn_code%TYPE;
      v_th_status                TXN_HEADER.th_status%TYPE;
      v_ar_ind                   TXN_HEADER.th_ar_ind%TYPE;
      v_ack_status               TXN_HEADER.th_ack_status%TYPE;

      CURSOR merchant_rpt_txn_cur
      IS
         SELECT transaction_id,
                country,
                service,
                mer_short_name,
                transaction_type,
                mer_reference,
                holdback_ccy,
                holdback_amount,
                status,
                create_timestamp,
                approval_timestamp,
                remark,
                mer_request_amt,
                mer_request_ccy,
                consumer_payable_amt,
                consumer_payable_ccy,
                unique_amt_markup,
                consumer_paid_amt,
                consumer_paid_ccy,
                mer_received_amt,
                mer_received_ccy,
                transaction_fee,
                transaction_fee_ccy,
                mer_received_net_amt,
                mer_received_net_amt_ccy,
                mer_payable_amount,
                mer_payable_ccy,
                consumer_received_amt,
                consumer_received_ccy,
                mer_paid_amount,
                mer_paid_ccy,
                mer_paid_total_amt,
                mer_paid_total_amt_ccy,
                mer_receivable_amt,
                mer_receivable_ccy,
                mer_receivable_net_amt,
                mer_receivable_net_amt_ccy,
                transaction_amount,
                transaction_ccy,
                net_amount,
                net_ccy,
                merchant_id,
                client_id,
                th_txn_code,
                th_status,
                ar_ind,
                ack_status
           FROM (                                                   -- deposit
                 SELECT th_txn_id AS transaction_id,
                        td_txn_country AS country,
                        th_service_code AS service,
                        short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        th_txn_code,
                        th_merchant_ref AS mer_reference,
                        DECODE(th_txn_code,
                               'DSI', DECODE(TH_STATUS,'I','','W','',holdback.te_ccy),
                               'VDS', holdback.te_ccy,
                               'VDR', holdback.te_ccy,
                               '')
                            AS holdback_ccy,
                        DECODE(th_txn_code,
                               'DSI', DECODE(TH_STATUS,'I',0,'W',0,holdback.te_amount),
                               'VDS', holdback.te_amount,
                               'VDR', holdback.te_amount,
                               0)
                            AS holdback_amount,
                        dm_status_desc AS status,
                        th_create_timestamp AS create_timestamp,
                        th_approval_timestamp AS approval_timestamp,
                        td_remark AS remark,
                        th_transaction_amount AS mer_request_amt,
                        td_txn_ccy AS mer_request_ccy,
                        DECODE (th_txn_code, 'DSI', tp_txn_amount, 0)
                           AS consumer_payable_amt,
                        DECODE (th_txn_code, 'DSI', tp_txn_ccy, '')
                           AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        DECODE (th_txn_code, 'DSI', tp_txn_amount, 0)
                           AS consumer_paid_amt,
                        DECODE (th_txn_code, 'DSI', tp_txn_ccy, '')
                           AS consumer_paid_ccy,
                        DECODE (th_txn_code, 'DSI', DECODE(TH_STATUS,'I',0,'W',0,th_net_amount + NVL(tfee.te_amount,0)), 0)
                           AS mer_received_amt,
                        DECODE (th_txn_code, 'DSI', DECODE(TH_STATUS,'I','','W','',th_net_ccy), '')
                           AS mer_received_ccy,
                        DECODE(th_txn_code,
                               'DSI', DECODE(TH_STATUS,'I',0,'W',0,tfee.te_amount),
                               'VDS', tfee.te_amount,
                               'VDR', tfee.te_amount,
                               0)
                           AS transaction_fee,
                        DECODE(th_txn_code,
                               'DSI', DECODE(TH_STATUS,'I','','W','',tfee.te_ccy),
                               'VDS', tfee.te_ccy,
                               'VDR', tfee.te_ccy,
                               '')
                           AS transaction_fee_ccy,
                        DECODE (th_txn_code, 'DSI', DECODE(TH_STATUS,'I',0,'W',0,th_net_amount), 0)
                           AS mer_received_net_amt,
                        DECODE (th_txn_code, 'DSI', DECODE(TH_STATUS,'I','','W','',th_net_ccy), '')
                           AS mer_received_net_amt_ccy,
                        0 AS mer_payable_amount,
                        '' AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        DECODE (th_txn_code,
                                'VDS', th_net_amount + NVL(tfee.te_amount,0),
                                'VDR', th_net_amount + NVL(tfee.te_amount,0),
                                0)
                           AS mer_paid_amount,
                        DECODE (th_txn_code,
                                'VDS', th_net_ccy,
                                'VDR', th_net_ccy,
                                '')
                           AS mer_paid_ccy,
                        DECODE (th_txn_code,
                                'VDS', th_net_amount,
                                'VDR', th_net_amount,
                                0)
                           AS mer_paid_total_amt,
                        DECODE (th_txn_code,
                                'VDS', th_net_ccy,
                                'VDR', th_net_ccy,
                                '')
                           AS mer_paid_total_amt_ccy,
                        0 mer_receivable_amt,
                        '' AS mer_receivable_ccy,
                        0 mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        tp_bank_code,
                        th_transaction_amount AS transaction_amount,
                        td_txn_ccy AS transaction_ccy,
                        DECODE(th_txn_code,
                               'DSI', DECODE(TH_STATUS,'I',0,'W',0,th_net_amount),
                               'VDS', th_net_amount,
                               'VDR', th_net_amount,
                               0)
                           AS net_amount,
                        DECODE(th_txn_code,
                               'DSI', DECODE(TH_STATUS,'I','','W','',th_net_ccy),
                               'VDS', th_net_ccy,
                               'VDR', th_net_ccy,
                               '')
                           AS net_ccy,
                        th_merchant_id AS merchant_id,
                        th_client_id AS client_id,
                        th_status,
                        th_ar_ind AS ar_ind,
                        th_ack_status AS ack_status
                   FROM (SELECT th_txn_id,
                                th_service_code,
                                th_merchant_id,
                                th_txn_code,
                                th_merchant_ref,
                                dm_status_desc,
                                th_create_timestamp,
                                th_approval_timestamp,
                                th_transaction_amount,
                                th_net_amount,
                                th_net_ccy,
                                th_client_id,
                                th_status,
                                th_ar_ind,
                                th_ack_status
                           FROM TXN_HEADER, DEF_TXN_STATUS_MAP
                          WHERE     (    th_status = dm_status
                                     AND (   th_ar_ind = dm_ar_ind
                                          OR th_ar_ind IS NULL)
                                     AND th_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND ((th_create_timestamp >=
                                       in_create_timestamp_from)
                                     OR in_create_timestamp_from IS NULL)
                                AND ((th_create_timestamp <=
                                       in_create_timestamp_to)
                                     OR in_create_timestamp_to IS NULL)
                                AND ((th_approval_timestamp >=
                                       in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND ((th_approval_timestamp <
                                       in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   th_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   th_merchant_ref = in_merchant_ref
                                     OR in_merchant_ref IS NULL)
                                AND (   th_txn_id = in_txn_id
                                     OR in_txn_id IS NULL)
                                AND (   in_min_amount <=
                                           th_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   th_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   th_merchant_id = in_merchant_id
                                     OR in_merchant_id IS NULL)
                                AND (   th_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                AND (    th_txn_code IN ('DSI', 'VDS', 'VDR')
                                     AND (   th_txn_code = in_txn_code
                                          OR in_txn_code IS NULL
                                          OR in_txn_code = 'TRAN'))) TXN_HEADER
                        LEFT JOIN
                        txn_elements tfee
                           ON     th_txn_id = tfee.te_txn_id
                              AND tfee.te_txn_element_type = 'TFEE'
                              AND tfee.te_party_type = 'M'
                        LEFT JOIN
                        txn_elements holdback
                           ON     th_txn_id = holdback.te_txn_id
                              AND holdback.te_txn_element_type = 'RAMT'
                              AND holdback.te_party_type = 'M',
                        txn_detail,
                        merch_detail,
                        txn_code,
                        txn_psp_detail
                  WHERE     th_txn_id = td_txn_id
                        AND th_merchant_id = merchant_id
                        AND th_txn_code = tc_code
                        AND th_txn_id = tp_txn_id
                        AND (   TXN_PSP_DETAIL.TP_BANK_CODE = in_bank_code
                             OR in_bank_code IS NULL)
                        AND (   td_txn_country = in_country
                             OR in_country IS NULL)
                 UNION
                 -- Merch Sett
                 SELECT th_txn_id AS transaction_id,
                        td_txn_country AS country,
                        th_service_code AS service,
                        short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        th_txn_code,
                        th_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        th_create_timestamp AS create_timestamp,
                        th_approval_timestamp AS approval_timestamp,
                        td_remark AS remark,
                        th_transaction_amount AS mer_request_amt,
                        td_txn_ccy AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        0 AS mer_received_amt,
                        '' AS mer_received_ccy,
                        tfee.te_amount AS transaction_fee,
                        tfee.te_ccy AS transaction_fee_ccy,
                        NVL(sd_deliver_amt,0) AS mer_received_net_amt,
                        sd_deliver_ccy AS mer_received_net_amt_ccy,
                        0 AS mer_payable_amount,
                        '' AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        0 AS mer_paid_amount,
                        '' AS mer_paid_ccy,
                        0 AS mer_paid_total_amt,
                        '' AS mer_paid_total_amt_ccy,
                        0 AS mer_receivable_amt,
                        '' AS mer_receivable_ccy,
                        NVL(sd_deliver_amt,0) AS mer_receivable_net_amt,
                        sd_deliver_ccy AS mer_receivable_net_amt_ccy,
                        NULL AS tp_bank_code,
                        th_transaction_amount AS transaction_amount,
                        td_txn_ccy AS transaction_ccy,
                        th_net_amount AS net_amount,
                        th_net_ccy AS net_ccy,
                        th_merchant_id AS merchant_id,
                        th_client_id AS client_id,
                        th_status,
                        th_ar_ind AS ar_ind,
                        th_ack_status AS ack_status
                   FROM (SELECT th_txn_id,
                                th_service_code,
                                th_merchant_id,
                                th_txn_code,
                                th_merchant_ref,
                                dm_status_desc,
                                th_create_timestamp,
                                th_approval_timestamp,
                                th_transaction_amount,
                                th_net_amount,
                                th_net_ccy,
                                th_client_id,
                                th_status,
                                th_ar_ind,
                                th_ack_status
                           FROM TXN_HEADER, DEF_TXN_STATUS_MAP
                          WHERE     (    th_status = dm_status
                                     AND (   th_ar_ind = dm_ar_ind
                                          OR th_ar_ind IS NULL)
                                     AND th_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND ((th_create_timestamp >=
                                       in_create_timestamp_from)
                                     OR in_create_timestamp_from IS NULL)
                                AND ((th_create_timestamp <=
                                       in_create_timestamp_to)
                                     OR in_create_timestamp_to IS NULL)
                                AND ((th_approval_timestamp >=
                                       in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND ((th_approval_timestamp <
                                       in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   th_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   th_merchant_ref = in_merchant_ref
                                     OR in_merchant_ref IS NULL)
                                AND (   th_txn_id = in_txn_id
                                     OR in_txn_id IS NULL)
                                AND (   in_min_amount <=
                                           th_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   th_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   th_merchant_id = in_merchant_id
                                     OR in_merchant_id IS NULL)
                                AND (   th_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                AND (    th_txn_code = 'STR'
                                     AND (   th_txn_code = in_txn_code
                                          OR in_txn_code IS NULL
                                          OR in_txn_code = 'TRAN'))) TXN_HEADER
                        LEFT JOIN
                        txn_elements tfee
                           ON     th_txn_id = tfee.te_txn_id
                              AND tfee.te_txn_element_type = 'TFEE'
                              AND tfee.te_party_type = 'M'
                        LEFT JOIN merchant_settlement_detail
                           ON th_txn_id = sd_txn_id,
                        txn_detail,
                        merch_detail,
                        txn_code
                  WHERE     th_txn_id = td_txn_id
                        AND th_merchant_id = merchant_id
                        AND th_txn_code = tc_code
                        AND in_bank_code IS NULL
                        AND (   td_txn_country = in_country
                             OR in_country IS NULL)
                 UNION
                 -- payout
                 SELECT th_txn_id AS transaction_id,
                        td_txn_country AS country,
                        th_service_code AS service,
                        short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        th_txn_code,
                        th_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        th_create_timestamp AS create_timestamp,
                        th_approval_timestamp AS approval_timestamp,
                        td_remark AS remark,
                        DECODE (th_txn_code, 'POA', th_transaction_amount, 0)
                           AS mer_request_amt,
                        DECODE (th_txn_code, 'POA', td_txn_ccy, '')
                           AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        DECODE (th_txn_code,
                                'VOA', th_net_amount - NVL(tfee.te_amount,0),
                                'VRA', th_net_amount - NVL(tfee.te_amount,0),
                                0)
                           AS mer_received_amt,
                        DECODE (th_txn_code, 'VOA', th_net_ccy, 'VRA', th_net_ccy, '')
                           AS mer_received_ccy,
                        tfee.te_amount AS transaction_fee,
                        tfee.te_ccy AS transaction_fee_ccy,
                        DECODE (th_txn_code, 'VOA', th_net_amount, 'VRA', th_net_amount, 0)
                           AS mer_received_net_amt,
                        DECODE (th_txn_code, 'VOA', th_net_ccy, 'VRA', th_net_ccy, '')
                           AS mer_received_net_amt_ccy,
                        DECODE (th_txn_code, 'POA', th_net_amount - NVL(tfee.te_amount,0), 0)
                           AS mer_payable_amount,
                        DECODE (th_txn_code, 'POA', th_net_ccy, '')
                           AS mer_payable_ccy,
                        DECODE (th_txn_code, 'POA', NVL(ud_payout_amount,0), 0)
                           AS consumer_received_amt,
                        DECODE (th_txn_code, 'POA', ud_payout_currency, '')
                           AS consumer_received_ccy,
                        DECODE (th_txn_code, 'POA', th_net_amount - NVL(tfee.te_amount,0), 0)
                           AS mer_paid_amount,
                        DECODE (th_txn_code, 'POA', th_net_ccy, '')
                           AS mer_paid_ccy,
                        DECODE (th_txn_code, 'POA', th_net_amount, 0)
                           AS mer_paid_total_amt,
                        DECODE (th_txn_code, 'POA', th_net_ccy, '')
                           AS mer_paid_total_amt_ccy,
                        0 AS mer_receivable_amt,
                        '' AS mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        bd.internal_bank_code AS tp_bank_code,
                        th_transaction_amount AS transaction_amount,
                        td_txn_ccy AS transaction_ccy,
                        th_net_amount AS net_amount,
                        th_net_ccy AS net_ccy,
                        th_merchant_id AS merchant_id,
                        th_client_id AS client_id,
                        th_status,
                        th_ar_ind AS ar_ind,
                        th_ack_status AS ack_status
                   FROM (SELECT th_txn_id,
                                th_service_code,
                                th_merchant_id,
                                th_txn_code,
                                th_merchant_ref,
                                dm_status_desc,
                                th_create_timestamp,
                                th_approval_timestamp,
                                th_transaction_amount,
                                th_net_amount,
                                th_net_ccy,
                                th_client_id,
                                th_status,
                                th_ar_ind,
                                th_ack_status
                           FROM TXN_HEADER, DEF_TXN_STATUS_MAP
                          WHERE     (    th_status = dm_status
                                     AND (   th_ar_ind = dm_ar_ind
                                          OR th_ar_ind IS NULL)
                                     AND th_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND ((th_create_timestamp >=
                                       in_create_timestamp_from)
                                     OR in_create_timestamp_from IS NULL)
                                AND ((th_create_timestamp <=
                                       in_create_timestamp_to)
                                     OR in_create_timestamp_to IS NULL)
                                AND ((th_approval_timestamp >=
                                       in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND ((th_approval_timestamp <
                                       in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   th_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   th_merchant_ref = in_merchant_ref
                                     OR in_merchant_ref IS NULL)
                                AND (   th_txn_id = in_txn_id
                                     OR in_txn_id IS NULL)
                                AND (   in_min_amount <=
                                           th_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   th_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   th_merchant_id = in_merchant_id
                                     OR in_merchant_id IS NULL)
                                AND (   th_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                AND (    th_txn_code IN ('POA', 'VOA', 'VRA')
                                     AND (   th_txn_code = in_txn_code
                                          OR in_txn_code IS NULL
                                          OR in_txn_code = 'TRAN'))) TXN_HEADER
                        LEFT JOIN
                        txn_elements tfee
                           ON     th_txn_id = tfee.te_txn_id
                              AND tfee.te_txn_element_type = 'TFEE'
                              AND tfee.te_party_type = 'M'
                        LEFT JOIN
                        merchant_upload_file_detail
                           ON     th_txn_id = ud_txn_id,
                        txn_detail
                        LEFT JOIN
                        bank_desc bd
                           ON     td_bank_name = bd.bank_name
                              AND td_txn_country = bd.country,
                        merch_detail,
                        txn_code
                  WHERE     th_txn_id = td_txn_id
                        AND th_merchant_id = merchant_id
                        AND th_txn_code = tc_code
                        AND (   bd.internal_bank_code = in_bank_code
                             OR in_bank_code IS NULL)
                        AND (   td_txn_country = in_country
                             OR in_country IS NULL)
                 UNION
                 -- lien and release lien
                 SELECT th_txn_id AS transaction_id,
                        td_txn_country AS country,
                        th_service_code AS service,
                        short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        th_txn_code,
                        th_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        th_create_timestamp AS create_timestamp,
                        th_approval_timestamp AS approval_timestamp,
                        td_remark AS remark,
                        0 AS mer_request_amt,
                        '' AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        DECODE(th_txn_code, 'UOD', th_transaction_amount, '') AS mer_received_amt,
                        DECODE(th_txn_code, 'UOD', td_txn_ccy, '') AS mer_received_ccy,
                        0 AS transaction_fee,
                        '' AS transaction_fee_ccy,
                        0 AS mer_received_net_amt,
                        '' AS mer_received_net_amt_ccy,
                        DECODE(th_txn_code, 'HOD', th_transaction_amount, '') AS mer_payable_amount,
                        DECODE(th_txn_code, 'HOD', td_txn_ccy, '') AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        DECODE(th_txn_code, 'HOD', th_transaction_amount, '') AS mer_paid_amount,
                        DECODE(th_txn_code, 'HOD', td_txn_ccy, '') AS mer_paid_ccy,
                        0 AS mer_paid_total_amt,
                        '' AS mer_paid_total_amt_ccy,
                        DECODE(th_txn_code, 'UOD', th_transaction_amount, '') AS mer_receivable_amt,
                        DECODE(th_txn_code, 'UOD', td_txn_ccy, '') AS mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        NULL AS tp_bank_code,
                        th_transaction_amount AS transaction_amount,
                        td_txn_ccy AS transaction_ccy,
                        th_net_amount AS net_amount,
                        th_net_ccy AS net_ccy,
                        th_merchant_id AS merchant_id,
                        th_client_id AS client_id,
                        th_status,
                        th_ar_ind AS ar_ind,
                        th_ack_status AS ack_status
                   FROM (SELECT th_txn_id,
                                th_service_code,
                                th_merchant_id,
                                th_txn_code,
                                th_merchant_ref,
                                dm_status_desc,
                                th_create_timestamp,
                                th_approval_timestamp,
                                th_transaction_amount,
                                th_net_amount,
                                th_net_ccy,
                                th_client_id,
                                th_status,
                                th_ar_ind,
                                th_ack_status
                           FROM TXN_HEADER, DEF_TXN_STATUS_MAP
                          WHERE     (    th_status = dm_status
                                     AND (   th_ar_ind = dm_ar_ind
                                          OR th_ar_ind IS NULL)
                                     AND th_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND ((th_create_timestamp >=
                                       in_create_timestamp_from)
                                     OR in_create_timestamp_from IS NULL)
                                AND ((th_create_timestamp <=
                                       in_create_timestamp_to)
                                     OR in_create_timestamp_to IS NULL)
                                AND ((th_approval_timestamp >=
                                       in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND ((th_approval_timestamp <
                                       in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   th_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   th_merchant_ref = in_merchant_ref
                                     OR in_merchant_ref IS NULL)
                                AND (   th_txn_id = in_txn_id
                                     OR in_txn_id IS NULL)
                                AND (   in_min_amount <=
                                           th_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   th_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   th_merchant_id = in_merchant_id
                                     OR in_merchant_id IS NULL)
                                AND (   th_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                AND (    th_txn_code IN ('HOD', 'UOD')
                                     AND (   th_txn_code = in_txn_code
                                          OR in_txn_code IS NULL
                                          OR in_txn_code = 'TRAN'))) TXN_HEADER,
                        txn_detail,
                        merch_detail,
                        txn_code
                  WHERE     th_txn_id = td_txn_id
                        AND th_merchant_id = merchant_id
                        AND th_txn_code = tc_code
                        AND in_bank_code IS NULL
                        AND (   td_txn_country = in_country
                             OR in_country IS NULL)
                 UNION
                 -- release expired holdback
                 SELECT th_txn_id AS transaction_id,
                        td_txn_country AS country,
                        th_service_code AS service,
                        short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        th_txn_code,
                        th_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        th_create_timestamp AS create_timestamp,
                        th_approval_timestamp AS approval_timestamp,
                        td_remark AS remark,
                        0 AS mer_request_amt,
                        '' AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        th_reserve_amount AS mer_received_amt,
                        td_txn_ccy AS mer_received_ccy,
                        0 AS transaction_fee,
                        '' AS transaction_fee_ccy,
                        0 AS mer_received_net_amt,
                        '' AS mer_received_net_amt_ccy,
                        0 AS mer_payable_amount,
                        '' AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        0 AS mer_paid_amount,
                        '' AS mer_paid_ccy,
                        0 AS mer_paid_total_amt,
                        '' AS mer_paid_total_amt_ccy,
                        0 AS mer_receivable_amt,
                        '' AS mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        NULL AS tp_bank_code,
                        th_transaction_amount AS transaction_amount,
                        td_txn_ccy AS transaction_ccy,
                        th_net_amount AS net_amount,
                        th_net_ccy AS net_ccy,
                        th_merchant_id AS merchant_id,
                        th_client_id AS client_id,
                        th_status,
                        th_ar_ind AS ar_ind,
                        th_ack_status AS ack_status
                   FROM (SELECT th_txn_id,
                                th_service_code,
                                th_merchant_id,
                                th_txn_code,
                                th_merchant_ref,
                                dm_status_desc,
                                th_create_timestamp,
                                th_approval_timestamp,
                                th_transaction_amount,
                                th_net_amount,
                                th_net_ccy,
                                th_reserve_amount,
                                th_client_id,
                                th_status,
                                th_ar_ind,
                                th_ack_status
                           FROM TXN_HEADER, DEF_TXN_STATUS_MAP
                          WHERE     (    th_status = dm_status
                                     AND (   th_ar_ind = dm_ar_ind
                                          OR th_ar_ind IS NULL)
                                     AND th_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND ((th_create_timestamp >=
                                       in_create_timestamp_from)
                                     OR in_create_timestamp_from IS NULL)
                                AND ((th_create_timestamp <=
                                       in_create_timestamp_to)
                                     OR in_create_timestamp_to IS NULL)
                                AND ((th_approval_timestamp >=
                                       in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND ((th_approval_timestamp <
                                       in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   th_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   th_merchant_ref = in_merchant_ref
                                     OR in_merchant_ref IS NULL)
                                AND (   th_txn_id = in_txn_id
                                     OR in_txn_id IS NULL)
                                AND (   in_min_amount <=
                                           th_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   th_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   th_merchant_id = in_merchant_id
                                     OR in_merchant_id IS NULL)
                                AND (   th_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                AND (    th_txn_code = 'RLR'
                                     AND (   th_txn_code = in_txn_code
                                          OR in_txn_code IS NULL
                                          OR in_txn_code = 'TRAN'))) TXN_HEADER,
                        txn_detail,
                        merch_detail,
                        txn_code
                  WHERE     th_txn_id = td_txn_id
                        AND th_merchant_id = merchant_id
                        AND th_txn_code = tc_code
                        AND in_bank_code IS NULL
                        AND (   td_txn_country = in_country
                             OR in_country IS NULL)
                 UNION
                 -- balance transfer
                 SELECT th.th_txn_id AS transaction_id,
                        td_txn_country AS country,
                        th_service_code AS service,
                        short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        th_txn_code,
                        th_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        th_create_timestamp AS create_timestamp,
                        th_approval_timestamp AS approval_timestamp,
                        td_remark AS remark,
                        DECODE (th_txn_code,
                                'OTM', th.th_transaction_amount,
                                'TFT', oth.th_transaction_amount,
                                'RTT', oth.th_transaction_amount,
                                'MTO', th.th_transaction_amount,
                                'TFF', th.th_transaction_amount,
                                'RTF', th.th_transaction_amount,
                                0)
                           AS mer_request_amt,
                        DECODE (th_txn_code,
                                'OTM', td.td_txn_ccy,
                                'TFT', otd.td_txn_ccy,
                                'RTT', otd.td_txn_ccy,
                                'MTO', td.td_txn_ccy,
                                'TFF', td.td_txn_ccy,
                                'RTF', td.td_txn_ccy,
                                '')
                           AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        DECODE (th_txn_code,
                                'OTM', th_net_amount + NVL(tfee.te_amount,0),
                                'TFT', th_net_amount + NVL(tfee.te_amount,0),
                                'RTT', th_net_amount + NVL(tfee.te_amount,0),
                                0)
                           AS mer_received_amt,
                        DECODE (th_txn_code,
                                'OTM', th_net_ccy,
                                'TFT', th_net_ccy,
                                'RTT', th_net_ccy,
                                '')
                           AS mer_received_ccy,
                        tfee.te_amount AS transaction_fee,
                        tfee.te_ccy AS transaction_fee_ccy,
                        DECODE (th_txn_code,
                                'OTM', th_net_amount,
                                'TFT', th_net_amount,
                                'RTT', th_net_amount,
                                0)
                           AS mer_received_net_amt,
                        DECODE (th_txn_code,
                                'OTM', th_net_ccy,
                                'TFT', th_net_ccy,
                                'RTT', th_net_ccy,
                                '')
                           AS mer_received_net_amt_ccy,
                        0 AS mer_payable_amount,
                        '' AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        0 AS mer_paid_amount,
                        '' AS mer_paid_ccy,
                        DECODE (th_txn_code,
                                'MTO', th_net_amount,
                                'TFF', th_net_amount,
                                'RTF', th_net_amount,
                                0)
                           AS mer_paid_total_amt,
                        DECODE (th_txn_code,
                                'MTO', th_net_ccy,
                                'TFF', th_net_ccy,
                                'RTF', th_net_ccy,
                                '')
                           AS mer_paid_total_amt_ccy,
                        0 AS mer_receivable_amt,
                        '' mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        NULL AS tp_bank_code,
                        DECODE (th_txn_code,
                                'OTM', th.th_transaction_amount,
                                'TFT', oth.th_transaction_amount,
                                'RTT', oth.th_transaction_amount,
                                'MTO', th.th_transaction_amount,
                                'TFF', th.th_transaction_amount,
                                'RTF', th.th_transaction_amount,
                                0)
                           AS transaction_amount,
                        DECODE (th_txn_code,
                                'OTM', td.td_txn_ccy,
                                'TFT', otd.td_txn_ccy,
                                'RTT', otd.td_txn_ccy,
                                'MTO', td.td_txn_ccy,
                                'TFF', td.td_txn_ccy,
                                'RTF', td.td_txn_ccy,
                                '')
                           AS transaction_ccy,
                        th_net_amount AS net_amount,
                        th_net_ccy AS net_ccy,
                        th_merchant_id AS merchant_id,
                        th_client_id AS client_id,
                        th_status,
                        th_ar_ind AS ar_ind,
                        th_ack_status AS ack_status
                   FROM (SELECT th_txn_id,
                                th_org_txn_id,
                                th_service_code,
                                th_merchant_id,
                                th_txn_code,
                                th_merchant_ref,
                                dm_status_desc,
                                th_create_timestamp,
                                th_approval_timestamp,
                                th_transaction_amount,
                                th_net_amount,
                                th_net_ccy,
                                th_client_id,
                                th_status,
                                th_ar_ind,
                                th_ack_status
                           FROM TXN_HEADER, DEF_TXN_STATUS_MAP
                          WHERE     (    th_status = dm_status
                                     AND (   th_ar_ind = dm_ar_ind
                                          OR th_ar_ind IS NULL)
                                     AND th_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND ((th_create_timestamp >=
                                       in_create_timestamp_from)
                                     OR in_create_timestamp_from IS NULL)
                                AND ((th_create_timestamp <=
                                       in_create_timestamp_to)
                                     OR in_create_timestamp_to IS NULL)
                                AND ((th_approval_timestamp >=
                                       in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND ((th_approval_timestamp <
                                       in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   th_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   th_merchant_ref = in_merchant_ref
                                     OR in_merchant_ref IS NULL)
                                AND (   th_txn_id = in_txn_id
                                     OR in_txn_id IS NULL)
                                AND (   in_min_amount <=
                                           th_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   th_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   th_merchant_id = in_merchant_id
                                     OR in_merchant_id IS NULL)
                                AND (   th_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                AND (    th_txn_code IN
                                            ('OTM',
                                             'TFT',
                                             'RTT',
                                             'MTO',
                                             'TFF',
                                             'RTF')
                                     AND (   th_txn_code = in_txn_code
                                          OR in_txn_code IS NULL
                                          OR in_txn_code = 'TRAN'))) th
                        LEFT JOIN
                        (SELECT th_txn_id, th_transaction_amount FROM txn_header) oth
                           ON     th.th_org_txn_id = oth.th_txn_id
                        LEFT JOIN
                        (SELECT td_txn_id, td_txn_ccy FROM txn_detail) otd
                           ON     th.th_org_txn_id = otd.td_txn_id
                        LEFT JOIN
                        txn_elements tfee
                           ON     th.th_txn_id = tfee.te_txn_id
                              AND tfee.te_txn_element_type = 'TFEE'
                              AND tfee.te_party_type = 'M',
                        txn_detail td,
                        merch_detail,
                        txn_code
                  WHERE     th.th_txn_id = td.td_txn_id
                        AND th_merchant_id = merchant_id
                        AND th_txn_code = tc_code
                        AND in_bank_code IS NULL
                        AND (   td_txn_country = in_country
                             OR in_country IS NULL)
                 UNION
                 -- merchant fund in for payout
                 SELECT th_txn_id AS transaction_id,
                        td_txn_country AS country,
                        th_service_code AS service,
                        short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        th_txn_code,
                        th_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        th_create_timestamp AS create_timestamp,
                        th_approval_timestamp AS approval_timestamp,
                        td_remark AS remark,
                        th_transaction_amount AS mer_request_amt,
                        td_txn_ccy AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        0 AS mer_received_amt,
                        '' AS mer_received_ccy,
                        tfee.te_amount AS transaction_fee,
                        tfee.te_ccy AS transaction_fee_ccy,
                        th_net_amount AS mer_received_net_amt,
                        th_net_ccy AS mer_received_net_amt_ccy,
                        0 AS mer_payable_amount,
                        '' AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        0 AS mer_paid_amount,
                        '' AS mer_paid_ccy,
                        0 AS mer_paid_total_amt,
                        '' AS mer_paid_total_amt_ccy,
                        0 AS mer_receivable_amt,
                        '' AS mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        NULL AS tp_bank_code,
                        th_transaction_amount AS transaction_amount,
                        td_txn_ccy AS transaction_ccy,
                        th_net_amount AS net_amount,
                        th_net_ccy AS net_ccy,
                        th_merchant_id AS merchant_id,
                        th_client_id AS client_id,
                        th_status,
                        th_ar_ind AS ar_ind,
                        th_ack_status AS ack_status
                   FROM (SELECT th_txn_id,
                                th_service_code,
                                th_merchant_id,
                                th_txn_code,
                                th_merchant_ref,
                                dm_status_desc,
                                th_create_timestamp,
                                th_approval_timestamp,
                                th_transaction_amount,
                                th_net_amount,
                                th_net_ccy,
                                th_client_id,
                                th_status,
                                th_ar_ind,
                                th_ack_status
                           FROM TXN_HEADER, DEF_TXN_STATUS_MAP
                          WHERE     (    th_status = dm_status
                                     AND (   th_ar_ind = dm_ar_ind
                                          OR th_ar_ind IS NULL)
                                     AND th_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND ((th_create_timestamp >=
                                       in_create_timestamp_from)
                                     OR in_create_timestamp_from IS NULL)
                                AND ((th_create_timestamp <=
                                       in_create_timestamp_to)
                                     OR in_create_timestamp_to IS NULL)
                                AND ((th_approval_timestamp >=
                                       in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND ((th_approval_timestamp <
                                       in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   th_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   th_merchant_ref = in_merchant_ref
                                     OR in_merchant_ref IS NULL)
                                AND (   th_txn_id = in_txn_id
                                     OR in_txn_id IS NULL)
                                AND (   in_min_amount <=
                                           th_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   th_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   th_merchant_id = in_merchant_id
                                     OR in_merchant_id IS NULL)
                                AND (   th_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                AND (    th_txn_code = 'FPM'
                                     AND (   th_txn_code = in_txn_code
                                          OR in_txn_code IS NULL
                                          OR in_txn_code = 'TRAN'))) TXN_HEADER
                        LEFT JOIN
                        txn_elements tfee
                           ON     th_txn_id = tfee.te_txn_id
                              AND tfee.te_txn_element_type = 'TFEE'
                              AND tfee.te_party_type = 'M',
                        txn_detail,
                        merch_detail,
                        txn_code
                  WHERE     th_txn_id = td_txn_id
                        AND th_merchant_id = merchant_id
                        AND th_txn_code = tc_code
                        AND in_bank_code IS NULL
                        AND (   td_txn_country = in_country
                             OR in_country IS NULL)
                 UNION
                 -- adjustment
                 SELECT th_txn_id AS transaction_id,
                        td_txn_country AS country,
                        th_service_code AS service,
                        short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        th_txn_code,
                        th_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        th_create_timestamp AS create_timestamp,
                        th_approval_timestamp AS approval_timestamp,
                        td_remark AS remark,
                        0 AS mer_request_amt,
                        '' AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        DECODE (AT_DC_IND,
                                'C', th_net_amount + NVL(tfee.te_amount,0),
                                0)
                           AS mer_received_amt,
                        DECODE (AT_DC_IND, 'C', th_net_ccy, '')
                           AS mer_received_ccy,
                        0 AS transaction_fee,
                        '' AS transaction_fee_ccy,
                        DECODE (AT_DC_IND, 'C', th_net_amount, 0)
                           AS mer_received_net_amt,
                        DECODE (AT_DC_IND, 'C', th_net_ccy, '')
                           AS mer_received_net_amt_ccy,
                        0 AS mer_payable_amount,
                        '' AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        DECODE (AT_DC_IND, 'D', th_net_amount, 0)
                           AS mer_paid_amount,
                        DECODE (AT_DC_IND, 'D', th_net_ccy, '')
                           AS mer_paid_ccy,
                        0 AS mer_paid_total_amt,
                        '' AS mer_paid_total_amt_ccy,
                        0 AS mer_receivable_amt,
                        '' AS mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        NULL AS tp_bank_code,
                        th_transaction_amount AS transaction_amount,
                        td_txn_ccy AS transaction_ccy,
                        th_net_amount AS net_amount,
                        th_net_ccy AS net_ccy,
                        th_merchant_id AS merchant_id,
                        th_client_id AS client_id,
                        th_status,
                        th_ar_ind AS ar_ind,
                        th_ack_status AS ack_status
                   FROM (SELECT th_txn_id,
                                th_service_code,
                                th_merchant_id,
                                th_txn_code,
                                th_merchant_ref,
                                dm_status_desc,
                                th_create_timestamp,
                                th_approval_timestamp,
                                th_transaction_amount,
                                th_net_amount,
                                th_net_ccy,
                                th_client_id,
                                th_status,
                                th_ar_ind,
                                th_ack_status
                           FROM TXN_HEADER, DEF_TXN_STATUS_MAP
                          WHERE     (    th_status = dm_status
                                     AND (   th_ar_ind = dm_ar_ind
                                          OR th_ar_ind IS NULL)
                                     AND th_txn_code = dm_txn_code
                                     AND dm_type = 'M')
                                AND (   dm_status_desc = in_status
                                     OR in_status IS NULL)
                                AND ((th_create_timestamp >=
                                       in_create_timestamp_from)
                                     OR in_create_timestamp_from IS NULL)
                                AND ((th_create_timestamp <=
                                       in_create_timestamp_to)
                                     OR in_create_timestamp_to IS NULL)
                                AND ((th_approval_timestamp >=
                                       in_approval_timestamp_from)
                                     OR in_approval_timestamp_from IS NULL)
                                AND ((th_approval_timestamp <
                                       in_approval_timestamp_to)
                                     OR in_approval_timestamp_to IS NULL)
                                AND (   th_service_code = in_service_code
                                     OR in_service_code IS NULL)
                                AND (   th_merchant_ref = in_merchant_ref
                                     OR in_merchant_ref IS NULL)
                                AND (   th_txn_id = in_txn_id
                                     OR in_txn_id IS NULL)
                                AND (   in_min_amount <=
                                           th_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   th_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND (   th_merchant_id = in_merchant_id
                                     OR in_merchant_id IS NULL)
                                AND (   th_client_id = in_client_id
                                     OR in_client_id IS NULL)
                                AND (    th_txn_code LIKE 'm%'
                                     AND (   th_txn_code = in_txn_code
                                          OR in_txn_code IS NULL
                                          OR in_txn_code = 'NONT'))) TXN_HEADER
                        LEFT JOIN
                        txn_elements tfee
                           ON     th_txn_id = tfee.te_txn_id
                              AND tfee.te_txn_element_type = 'TFEE'
                              AND tfee.te_party_type = 'M',
                        (SELECT at_code, at_dc_ind FROM adjustment_type),
                        txn_detail,
                        merch_detail,
                        txn_code
                  WHERE     th_txn_id = td_txn_id
                        AND th_merchant_id = merchant_id
                        AND th_txn_code = tc_code
                        AND th_txn_code = at_code
                        AND in_bank_code IS NULL
                        AND (   td_txn_country = in_country
                             OR in_country IS NULL))
          WHERE     (th_txn_code = in_txn_code OR in_txn_code IS NULL OR in_txn_code = 'NONT' OR in_txn_code = 'TRAN')
                AND (tp_bank_code = in_bank_code OR in_bank_code IS NULL);

   BEGIN
      OPEN merchant_rpt_txn_cur;

      LOOP
         FETCH merchant_rpt_txn_cur
            INTO v_txn_id,
                 v_txn_country,
                 v_service_code,
                 v_mer_short_name,
                 v_txn_type,
                 v_mer_ref,
                 v_holdback_ccy,
                 v_holdback_amt,
                 v_status,
                 v_create_timestamp,
                 v_approval_timestamp,
                 v_remark,
                 v_mer_req_amt,
                 v_mer_req_ccy,
                 v_consumer_payable_amt,
                 v_consumer_payable_ccy,
                 v_unique_amt_markup,
                 v_consumer_paid_amt,
                 v_consumer_paid_ccy,
                 v_mer_received_amt,
                 v_mer_received_ccy,
                 v_txn_fee,
                 v_txn_fee_ccy,
                 v_mer_received_net_amt,
                 v_mer_received_net_ccy,
                 v_mer_payable_amt,
                 v_mer_payable_ccy,
                 v_consumer_received_amt,
                 v_consumer_received_ccy,
                 v_mer_paid_amt,
                 v_mer_paid_ccy,
                 v_mer_paid_total_amt,
                 v_mer_paid_total_ccy,
                 v_mer_receivable_amt,
                 v_mer_receivable_ccy,
                 v_mer_receivable_net_amt,
                 v_mer_receivable_net_ccy,
                 v_transaction_amount,
                 v_transaction_ccy,
                 v_net_amount,
                 v_net_ccy,
                 v_merchant_id,
                 v_client_id,
                 v_th_txn_code,
                 v_th_status,
                 v_ar_ind,
                 v_ack_status;


         EXIT WHEN merchant_rpt_txn_cur%NOTFOUND;

         Result.EXTEND;
         n := n + 1;
         result (n) :=
            merchant_rpt_txn_OBJ (v_txn_id,
                                  v_txn_country,
                                  v_service_code,
                                  v_mer_short_name,
                                  v_txn_type,
                                  v_mer_ref,
                                  v_holdback_ccy,
                                  v_holdback_amt,
                                  v_status,
                                  v_create_timestamp,
                                  v_approval_timestamp,
                                  v_remark,
                                  v_mer_req_amt,
                                  v_mer_req_ccy,
                                  v_consumer_payable_amt,
                                  v_consumer_payable_ccy,
                                  v_unique_amt_markup,
                                  v_consumer_paid_amt,
                                  v_consumer_paid_ccy,
                                  v_mer_received_amt,
                                  v_mer_received_ccy,
                                  v_txn_fee,
                                  v_txn_fee_ccy,
                                  v_mer_received_net_amt,
                                  v_mer_received_net_ccy,
                                  v_mer_payable_amt,
                                  v_mer_payable_ccy,
                                  v_consumer_received_amt,
                                  v_consumer_received_ccy,
                                  v_mer_paid_amt,
                                  v_mer_paid_ccy,
                                  v_mer_paid_total_amt,
                                  v_mer_paid_total_ccy,
                                  v_mer_receivable_amt,
                                  v_mer_receivable_ccy,
                                  v_mer_receivable_net_amt,
                                  v_mer_receivable_net_ccy,
                                  v_transaction_amount,
                                  v_transaction_ccy,
                                  v_net_amount,
                                  v_net_ccy,
                                  v_merchant_id,
                                  v_client_id,
                                  v_th_txn_code,
                                  v_th_status,
                                  v_ar_ind,
                                  v_ack_status);
      END LOOP;

      CLOSE merchant_rpt_txn_cur;

      RETURN (Result);
   END F_MERCHANT_TXN_HISTORY;
END MERCHANT_RPT_PKG;
/

