CREATE OR REPLACE PACKAGE BODY MERCHANT_RPT_PKG
IS
   FUNCTION F_MERCHANT_TXN_HISTORY (
      in_client_id                  TXN_HEADER.TH_CLIENT_ID%TYPE,
      in_merchant_id                TXN_HEADER.TH_MERCHANT_ID%TYPE,
      in_create_timestamp_from      txn_header.th_create_timestamp%TYPE,
      in_create_timestamp_to        txn_header.th_create_timestamp%TYPE,
      in_approval_timestamp_from    txn_header.th_approval_timestamp%TYPE,
      in_approval_timestamp_to      txn_header.th_approval_timestamp%TYPE,
      in_country                    txn_detail.td_txn_country%TYPE,
      in_service_code               txn_header.th_service_code%TYPE,
      in_merchant_ref               txn_header.th_merchant_ref%TYPE,
      in_txn_id                     txn_header.th_txn_id%TYPE,
      in_txn_code                   TXN_CODE.TC_CODE%TYPE,
      in_bank_code                  BANK_DESC.INTERNAL_BANK_CODE%TYPE,
      in_min_amount                 TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE,
      in_max_amount                 TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE,
      in_status                     def_txn_status_map.dm_status_desc%TYPE)
      RETURN merchant_rpt_txn_tab
   IS
      Result                     merchant_rpt_txn_tab := merchant_rpt_txn_tab ();
      n                          INTEGER := 0;
      v_txn_id                   TXN_HEADER.TH_TXN_ID%TYPE;
      v_txn_country              TXN_DETAIL.TD_TXN_COUNTRY%TYPE;
      v_service_code             TXN_HEADER.TH_SERVICE_CODE%TYPE;
      v_mer_short_name           MERCH_DETAIL.SHORT_NAME%TYPE;
      v_txn_type                 TXN_CODE.TC_DESC%TYPE;
      v_mer_ref                  TXN_HEADER.TH_MERCHANT_REF%TYPE;
      v_holdback_ccy             CURRENCY.CURRENCY_ID%TYPE;
      v_holdback_amt             TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE;
      v_status                   DEF_TXN_STATUS_MAP.DM_STATUS_DESC%TYPE;
      v_create_timestamp         TXN_HEADER.TH_CREATE_TIMESTAMP%TYPE;
      v_approval_timestamp       TXN_HEADER.TH_APPROVAL_TIMESTAMP%TYPE;
      v_remark                   TXN_DETAIL.TD_REMARK%TYPE;
      v_mer_req_amt              TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE;
      v_mer_req_ccy              currency.currency_id%TYPE;
      v_consumer_payable_amt     TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE;
      v_consumer_payable_ccy     currency.currency_id%TYPE;
      v_unique_amt_markup        TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE;
      v_consumer_paid_amt        TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE;
      v_consumer_paid_ccy        currency.currency_id%TYPE;
      v_mer_received_amt         TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE;
      v_mer_received_ccy         currency.currency_id%TYPE;
      v_txn_fee                  TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE;
      v_txn_fee_ccy              currency.currency_id%TYPE;
      v_mer_received_net_amt     TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE;
      v_mer_received_net_ccy     currency.currency_id%TYPE;
      v_mer_payable_amt          TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE;
      v_mer_payable_ccy          currency.currency_id%TYPE;
      v_consumer_received_amt    TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE;
      v_consumer_received_ccy    currency.currency_id%TYPE;
      v_mer_paid_amt             TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE;
      v_mer_paid_ccy             currency.currency_id%TYPE;
      v_mer_paid_total_amt       TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE;
      v_mer_paid_total_ccy       currency.currency_id%TYPE;
      v_mer_receivable_amt       TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE;
      v_mer_receivable_ccy       currency.currency_id%TYPE;
      v_mer_receivable_net_amt   TXN_HEADER.TH_TRANSACTION_AMOUNT%TYPE;
      v_mer_receivable_net_ccy   currency.currency_id%TYPE;

      CURSOR merchant_rpt_txn_cur
      IS
         SELECT Transactin_ID,
                country,
                service,
                mer_short_name,
                transaction_type,
                mer_reference,
                holdback_ccy,
                holdback_amount,
                status,
                create_timestamp,
                approval_timestamp,
                remark,
                mer_requrest_amt,
                mer_request_ccy,
                consumer_payable_amt,
                consumer_payable_ccy,
                unique_amt_markup,
                cosumer_paid_amt,
                consumer_paid_ccy,
                mer_received_amt,
                mer_received_ccy,
                transaction_fee,
                transaction_fee_ccy,
                mer_received_net_amt,
                mer_received_net_amt_ccy,
                mer_payable_amount,
                mer_payable_ccy,
                consumer_received_amt,
                consumer_received_ccy,
                mer_paid_amount,
                mer_paid_ccy,
                mer_paid_total_amt,
                mer_paid_total_amt_ccy,
                mer_receivable_amt,
                mer_receivable_ccy,
                mer_receivable_net_amt,
                mer_receivable_net_amt_ccy
           FROM (
                 -- deposit
                 SELECT th_txn_id AS Transactin_ID,
                        td_txn_country AS country,
                        th_service_code AS service,
                        short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        th_txn_code,
                        th_merchant_ref AS mer_reference,
                        holdback.te_ccy AS holdback_ccy,
                        holdback.te_amount AS holdback_amount,
                        dm_status_desc AS status,
                        th_create_timestamp AS create_timestamp,
                        th_approval_timestamp AS approval_timestamp,
                        td_remark AS remark,
                        th_transaction_amount AS mer_requrest_amt,
                        td_txn_ccy AS mer_request_ccy,
                        DECODE (th_txn_code, 'DSI', tp_txn_amount, 0)
                           AS consumer_payable_amt,
                        DECODE (th_txn_code, 'DSI', tp_txn_ccy, '')
                           AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        DECODE (th_txn_code, 'DSI', tp_txn_amount, 0)
                           AS cosumer_paid_amt,
                        DECODE (th_txn_code, 'DSI', tp_txn_ccy, '')
                           AS consumer_paid_ccy,
                        DECODE (th_txn_code, 'DSI', th_net_amount, 0)
                           AS mer_received_amt,
                        DECODE (th_txn_code, 'DSI', th_net_ccy, '')
                           AS mer_received_ccy,
                        tfee.te_amount AS transaction_fee,
                        tfee.te_ccy AS transaction_fee_ccy,
                        DECODE (th_txn_code, 'DSI', th_net_amount, 0)
                           AS mer_received_net_amt,
                        DECODE (th_txn_code, 'DSI', th_net_ccy, '')
                           AS mer_received_net_amt_ccy,
                        DECODE (th_txn_code,
                                'VDS', th_net_amount,
                                'VRS', th_net_amount,
                                0)
                           AS mer_payable_amount,
                        DECODE (th_txn_code,
                                'VDS', th_net_ccy,
                                'VDR', th_net_ccy,
                                '')
                           AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        DECODE (th_txn_code,
                                'VDS', th_net_amount,
                                'VRS', th_net_amount,
                                0)
                           AS mer_paid_amount,
                        DECODE (th_txn_code,
                                'VDS', th_net_ccy,
                                'VDR', th_net_ccy,
                                '')
                           AS mer_paid_ccy,
                        DECODE (th_txn_code,
                                'VDS', th_net_amount,
                                'VRS', th_net_amount,
                                0)
                           AS mer_paid_total_amt,
                        DECODE (th_txn_code,
                                'VDS', th_net_ccy,
                                'VDR', th_net_ccy,
                                '')
                           AS mer_paid_total_amt_ccy,
                        DECODE (th_txn_code, 'DSI', th_net_amount, 0)
                           AS mer_receivable_amt,
                        DECODE (th_txn_code, 'DSI', th_net_ccy, '')
                           AS mer_receivable_ccy,
                        DECODE (th_txn_code, 'DSI', th_net_amount, 0)
                           AS mer_receivable_net_amt,
                        DECODE (th_txn_code, 'DSI', th_net_ccy, '')
                           AS mer_receivable_net_amt_ccy,
                        tp_bank_code
                   FROM (SELECT th_txn_id,
                                th_service_code,
                                th_merchant_id,
                                th_txn_code,
                                th_merchant_ref,
                                dm_status_desc,
                                th_create_timestamp,
                                th_approval_timestamp,
                                th_transaction_amount,
                                th_net_amount,
                                th_net_ccy
                           FROM Txn_header, DEF_TXN_STATUS_MAP
                          WHERE     (    TH_STATUS = DM_STATUS
                                     AND (   TH_AR_IND = DM_AR_IND
                                          OR TH_AR_IND IS NULL)
                                     AND TH_TXN_CODE = DM_TXN_CODE
                                     AND DM_TYPE = 'M')
                                AND (   DM_STATUS_desc = in_status
                                     OR in_status IS NULL)
                                AND TH_CREATE_TIMESTAMP >=
                                       in_create_timestamp_from
                                AND TH_CREATE_TIMESTAMP <=
                                       in_create_timestamp_to
                                AND TH_approval_TIMESTAMP >=
                                       in_approval_timestamp_from
                                AND TH_approval_TIMESTAMP <=
                                       in_approval_timestamp_to
                                AND th_service_code = in_service_code
                                AND (   th_merchant_ref = in_merchant_ref
                                     OR in_merchant_ref IS NULL)
                                AND (   th_txn_id = in_txn_id
                                     OR in_txn_id IS NULL)
                                AND (   in_min_amount <=
                                           th_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   th_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND th_txn_code IN ('DSI', 'VDS', 'VDR')) txn_header
                        LEFT JOIN
                        txn_elements tfee
                           ON     th_txn_id = tfee.te_txn_id
                              AND tfee.te_txn_element_type = 'TFEE'
                              AND tfee.te_party_type = 'M'
                        LEFT JOIN
                        txn_elements holdback
                           ON     th_txn_id = holdback.te_txn_id
                              AND holdback.te_txn_element_type = 'RAMT'
                              AND holdback.te_party_type = 'M',
                        txn_detail,
                        merch_detail,
                        txn_code,
                        txn_psp_detail
                  WHERE     th_txn_id = td_txn_id
                        AND th_merchant_id = merchant_id
                        AND th_txn_code = tc_code
                        AND th_txn_id = tp_txn_id
                        AND (   TXN_PSP_DETAIL.TP_BANK_CODE = in_bank_code
                             OR in_bank_code IS NULL)
                 UNION
                 -- lien
                 SELECT th_txn_id AS Transactin_ID,
                        td_txn_country AS country,
                        th_service_code AS service,
                        short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        th_txn_code,
                        th_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        th_create_timestamp AS create_timestamp,
                        th_approval_timestamp AS approval_timestamp,
                        td_remark AS remark,
                        0 AS mer_requrest_amt,
                        '' AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS cosumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        DECODE (th_txn_code, 'UOD', uamt.te_amount, 0)
                           AS mer_received_amt,
                        DECODE (th_txn_code, 'UOD', uamt.te_ccy, '')
                           AS mer_received_ccy,
                        0 AS transaction_fee,
                        '' AS transaction_fee_ccy,
                        0 AS mer_received_net_amt,
                        '' AS mer_received_net_amt_ccy,
                        DECODE (th_txn_code, 'HOD', hamt.te_amount, 0)
                           AS mer_payable_amount,
                        DECODE (th_txn_code, 'HOD', hamt.te_ccy, '')
                           AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        DECODE (th_txn_code, 'HOD', hamt.te_amount, 0)
                           AS mer_paid_amount,
                        DECODE (th_txn_code, 'HOD', hamt.te_ccy, '')
                           AS mer_paid_ccy,
                        0 AS mer_paid_total_amt,
                        '' AS mer_paid_total_amt_ccy,
                        DECODE (th_txn_code, 'UOD', uamt.te_amount, 0)
                           AS mer_receivable_amt,
                        DECODE (th_txn_code, 'UOD', uamt.te_ccy, '')
                           AS mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        '' AS tp_bank_code
                   FROM (SELECT th_txn_id,
                                th_service_code,
                                th_merchant_id,
                                th_txn_code,
                                th_merchant_ref,
                                dm_status_desc,
                                th_create_timestamp,
                                th_approval_timestamp,
                                th_transaction_amount,
                                th_net_amount,
                                th_net_ccy
                           FROM Txn_header, DEF_TXN_STATUS_MAP
                          WHERE     (    TH_STATUS = DM_STATUS
                                     AND (   TH_AR_IND = DM_AR_IND
                                          OR TH_AR_IND IS NULL)
                                     AND TH_TXN_CODE = DM_TXN_CODE
                                     AND DM_TYPE = 'M')
                                AND (   DM_STATUS_desc = in_status
                                     OR in_status IS NULL)
                                AND TH_CREATE_TIMESTAMP >=
                                       in_create_timestamp_from
                                AND TH_CREATE_TIMESTAMP <=
                                       in_create_timestamp_to
                                AND TH_approval_TIMESTAMP >=
                                       in_approval_timestamp_from
                                AND TH_approval_TIMESTAMP <=
                                       in_approval_timestamp_to
                                AND th_service_code = in_service_code
                                AND (   th_merchant_ref = in_merchant_ref
                                     OR in_merchant_ref IS NULL)
                                AND (   th_txn_id = in_txn_id
                                     OR in_txn_id IS NULL)
                                AND (   in_min_amount <=
                                           th_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   th_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND th_txn_code IN ('HOD', 'UOD')) txn_header
                        LEFT JOIN
                        txn_elements hamt
                           ON     th_txn_id = hamt.te_txn_id
                              AND hamt.te_txn_element_type in ('HAMT','HOPO')
                              AND hamt.te_party_type = 'M'
                        LEFT JOIN
                        txn_elements uamt
                           ON     th_txn_id = uamt.te_txn_id
                              AND uamt.te_txn_element_type in ('UAMT', 'UOPO')
                              AND uamt.te_party_type = 'M',
                        txn_detail,
                        merch_detail,
                        txn_code
                  WHERE     th_txn_id = td_txn_id
                        AND th_merchant_id = merchant_id
                        AND th_txn_code = tc_code
                 UNION
                 -- balance transfer
                 SELECT th_txn_id AS Transactin_ID,
                        td_txn_country AS country,
                        th_service_code AS service,
                        short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        th_txn_code,
                        th_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        th_create_timestamp AS create_timestamp,
                        th_approval_timestamp AS approval_timestamp,
                        td_remark AS remark,
                        th_transaction_amount AS mer_request_amt,
                        td_txn_ccy AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        DECODE (th_txn_code, 'OTM', th_net_amount+tfee.te_amount, 'TFT', th_net_amount+tfee.te_amount, 'RTT', th_net_amount+tfee.te_amount, 0)
                           AS mer_received_amt,
                        DECODE (th_txn_code, 'OTM', th_net_ccy, 'TFT', th_net_ccy, 'RTT', th_net_ccy, '')
                           AS mer_received_ccy,
                        tfee.te_amount AS transaction_fee,
                        tfee.te_ccy AS transaction_fee_ccy,
                        DECODE (th_txn_code, 'OTM', th_net_amount, 'TFT', th_net_amount, 'RTT', th_net_amount, 0)
                          AS mer_received_net_amt,
                        DECODE (th_txn_code, 'OTM', th_net_ccy, 'TFT', th_net_ccy, 'RTT', th_net_ccy, '')
                          AS mer_received_net_amt_ccy,
                        0 AS mer_payable_amount,
                        '' AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        0 AS mer_paid_amount,
                        '' AS mer_paid_ccy,
                        DECODE (th_txn_code, 'MTO', th_net_amount, 'TFF', th_net_amount, 'RTF', th_net_amount, 0)
                           AS mer_paid_total_amt,
                        DECODE (th_txn_code, 'MTO', th_net_ccy, 'TFF', th_net_ccy, 'RTF', th_net_ccy, '')
                           AS mer_paid_total_amt_ccy,
                        0 AS mer_receivable_amt,
                        '' AS mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        NULL
                   FROM (SELECT th_txn_id,
                                th_service_code,
                                th_merchant_id,
                                th_txn_code,
                                th_merchant_ref,
                                dm_status_desc,
                                th_create_timestamp,
                                th_approval_timestamp,
                                th_transaction_amount,
                                th_net_amount,
                                th_net_ccy
                           FROM Txn_header, DEF_TXN_STATUS_MAP
                          WHERE     (    TH_STATUS = DM_STATUS
                                     AND (   TH_AR_IND = DM_AR_IND
                                          OR TH_AR_IND IS NULL)
                                     AND TH_TXN_CODE = DM_TXN_CODE
                                     AND DM_TYPE = 'M')
                                AND (   DM_STATUS_desc = in_status
                                     OR in_status IS NULL)
                                AND TH_CREATE_TIMESTAMP >=
                                       in_create_timestamp_from
                                AND TH_CREATE_TIMESTAMP <=
                                       in_create_timestamp_to
                                AND TH_approval_TIMESTAMP >=
                                       in_approval_timestamp_from
                                AND TH_approval_TIMESTAMP <=
                                       in_approval_timestamp_to
                                AND th_service_code = in_service_code
                                AND (   th_merchant_ref = in_merchant_ref
                                     OR in_merchant_ref IS NULL)
                                AND (   th_txn_id = in_txn_id
                                     OR in_txn_id IS NULL)
                                AND (   in_min_amount <=
                                           th_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   th_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND th_txn_code in ('OTM', 'TFT', 'RTT', 'MTO', 'TFF', 'RTF')) txn_header
                        LEFT JOIN
                        (select te_txn_id, te_txn_element_type, te_party_type, te_ccy, NVL(te_amount, 0) te_amount from txn_elements) tfee
                           ON     th_txn_id = tfee.te_txn_id
                              AND tfee.te_txn_element_type = 'TFEE'
                              AND tfee.te_party_type = 'M',
                        txn_detail,
                        merch_detail,
                        txn_code
                  WHERE     th_txn_id = td_txn_id
                        AND th_merchant_id = merchant_id
                        AND th_txn_code = tc_code
                        AND in_bank_code IS NULL
                 UNION
                 -- merch fundIn PO
                 SELECT th_txn_id AS Transactin_ID,
                        td_txn_country AS country,
                        th_service_code AS service,
                        short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        th_txn_code,
                        th_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        th_create_timestamp AS create_timestamp,
                        th_approval_timestamp AS approval_timestamp,
                        td_remark AS remark,
                        th_transaction_amount AS mer_request_amt,
                        td_txn_ccy AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        0 AS mer_received_amt,
                        '' AS mer_received_ccy,
                        tfee.te_amount AS transaction_fee,
                        tfee.te_ccy AS transaction_fee_ccy,
                        th_net_amount AS mer_received_net_amt,
                        th_net_ccy AS mer_received_net_amt_ccy,
                        0 AS mer_payable_amount,
                        '' AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        0 AS mer_paid_amount,
                        '' AS mer_paid_ccy,
                        0 AS mer_paid_total_amt,
                        '' AS mer_paid_total_amt_ccy,
                        0 AS mer_receivable_amt,
                        '' AS mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        NULL
                   FROM (SELECT th_txn_id,
                                th_service_code,
                                th_merchant_id,
                                th_txn_code,
                                th_merchant_ref,
                                dm_status_desc,
                                th_create_timestamp,
                                th_approval_timestamp,
                                th_transaction_amount,
                                th_net_amount,
                                th_net_ccy
                           FROM Txn_header, DEF_TXN_STATUS_MAP
                          WHERE     (    TH_STATUS = DM_STATUS
                                     AND (   TH_AR_IND = DM_AR_IND
                                          OR TH_AR_IND IS NULL)
                                     AND TH_TXN_CODE = DM_TXN_CODE
                                     AND DM_TYPE = 'M')
                                AND (   DM_STATUS_desc = in_status
                                     OR in_status IS NULL)
                                AND TH_CREATE_TIMESTAMP >=
                                       in_create_timestamp_from
                                AND TH_CREATE_TIMESTAMP <=
                                       in_create_timestamp_to
                                AND TH_approval_TIMESTAMP >=
                                       in_approval_timestamp_from
                                AND TH_approval_TIMESTAMP <=
                                       in_approval_timestamp_to
                                AND th_service_code = in_service_code
                                AND (   th_merchant_ref = in_merchant_ref
                                     OR in_merchant_ref IS NULL)
                                AND (   th_txn_id = in_txn_id
                                     OR in_txn_id IS NULL)
                                AND (   in_min_amount <=
                                           th_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   th_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND th_txn_code LIKE 'FPM') txn_header
                        LEFT JOIN
                        txn_elements tfee
                           ON     th_txn_id = tfee.te_txn_id
                              AND tfee.te_txn_element_type = 'TFEE'
                              AND tfee.te_party_type = 'M',
                        txn_detail,
                        merch_detail,
                        txn_code
                  WHERE     th_txn_id = td_txn_id
                        AND th_merchant_id = merchant_id
                        AND th_txn_code = tc_code
                        AND in_bank_code IS NULL
                 UNION
                 -- adjustment
                 SELECT th_txn_id AS Transactin_ID,
                        td_txn_country AS country,
                        th_service_code AS service,
                        short_name AS mer_short_name,
                        tc_desc AS transaction_type,
                        th_txn_code,
                        th_merchant_ref AS mer_reference,
                        '' AS holdback_ccy,
                        0 AS holdback_amount,
                        dm_status_desc AS status,
                        th_create_timestamp AS create_timestamp,
                        th_approval_timestamp AS approval_timestamp,
                        td_remark AS remark,
                        0 AS mer_request_amt,
                        '' AS mer_request_ccy,
                        0 AS consumer_payable_amt,
                        '' AS consumer_payable_ccy,
                        0 AS unique_amt_markup,
                        0 AS consumer_paid_amt,
                        '' AS consumer_paid_ccy,
                        DECODE (AT_DC_IND, 'C', th_transaction_amount, 0)
                           AS mer_received_amt,
                        DECODE (AT_DC_IND, 'C', td_txn_ccy, '')
                           AS mer_received_ccy,
                        0 AS transaction_fee,
                        '' AS transaction_fee_ccy,
                        DECODE (AT_DC_IND, 'C', th_net_amount, 0)
                           AS mer_received_net_amt,
                        DECODE (AT_DC_IND, 'C', th_net_ccy, '')
                           AS mer_received_net_amt_ccy,
                        0 AS mer_payable_amount,
                        '' AS mer_payable_ccy,
                        0 AS consumer_received_amt,
                        '' AS consumer_received_ccy,
                        DECODE (AT_DC_IND, 'D', th_net_amount, 0)
                           AS mer_paid_amount,
                        DECODE (AT_DC_IND, 'D', th_net_ccy, '')
                           AS mer_paid_ccy,
                        0 AS mer_paid_total_amt,
                        '' AS mer_paid_total_amt_ccy,
                        0 AS mer_receivable_amt,
                        '' AS mer_receivable_ccy,
                        0 AS mer_receivable_net_amt,
                        '' AS mer_receivable_net_amt_ccy,
                        NULL
                   FROM (SELECT th_txn_id,
                                th_service_code,
                                th_merchant_id,
                                th_txn_code,
                                th_merchant_ref,
                                dm_status_desc,
                                th_create_timestamp,
                                th_approval_timestamp,
                                th_transaction_amount,
                                th_net_amount,
                                th_net_ccy
                           FROM Txn_header, DEF_TXN_STATUS_MAP
                          WHERE     (    TH_STATUS = DM_STATUS
                                     AND (   TH_AR_IND = DM_AR_IND
                                          OR TH_AR_IND IS NULL)
                                     AND TH_TXN_CODE = DM_TXN_CODE
                                     AND DM_TYPE = 'M')
                                AND (   DM_STATUS_desc = in_status
                                     OR in_status IS NULL)
                                AND TH_CREATE_TIMESTAMP >=
                                       in_create_timestamp_from
                                AND TH_CREATE_TIMESTAMP <=
                                       in_create_timestamp_to
                                AND TH_approval_TIMESTAMP >=
                                       in_approval_timestamp_from
                                AND TH_approval_TIMESTAMP <=
                                       in_approval_timestamp_to
                                AND th_service_code = in_service_code
                                AND (   th_merchant_ref = in_merchant_ref
                                     OR in_merchant_ref IS NULL)
                                AND (   th_txn_id = in_txn_id
                                     OR in_txn_id IS NULL)
                                AND (   in_min_amount <=
                                           th_transaction_amount
                                     OR in_min_amount IS NULL)
                                AND (   th_transaction_amount <=
                                           in_max_amount
                                     OR in_max_amount IS NULL)
                                AND th_txn_code LIKE 'm%') txn_header,
                        (SELECT AT_CODE, AT_DC_IND FROM Adjustment_type),
                        txn_detail,
                        merch_detail,
                        txn_code
                  WHERE     th_txn_id = td_txn_id
                        AND th_merchant_id = merchant_id
                        AND th_txn_code = tc_code
                        AND th_txn_code = at_code
                        AND in_bank_code IS NULL)
          WHERE     (th_txn_code = in_txn_code OR in_txn_code IS NULL)
                AND (tp_bank_code = in_bank_code OR in_bank_code IS NULL);

   BEGIN
      OPEN merchant_rpt_txn_cur;

      LOOP
         FETCH merchant_rpt_txn_cur
            INTO v_txn_id,
                 v_txn_country,
                 v_service_code,
                 v_mer_short_name,
                 v_txn_type,
                 v_mer_ref,
                 v_holdback_ccy,
                 v_holdback_amt,
                 v_status,
                 v_create_timestamp,
                 v_approval_timestamp,
                 v_remark,
                 v_mer_req_amt,
                 v_mer_req_ccy,
                 v_consumer_payable_amt,
                 v_consumer_payable_ccy,
                 v_unique_amt_markup,
                 v_consumer_paid_amt,
                 v_consumer_paid_ccy,
                 v_mer_received_amt,
                 v_mer_received_ccy,
                 v_txn_fee,
                 v_txn_fee_ccy,
                 v_mer_received_net_amt,
                 v_mer_received_net_ccy,
                 v_mer_payable_amt,
                 v_mer_payable_ccy,
                 v_consumer_received_amt,
                 v_consumer_received_ccy,
                 v_mer_paid_amt,
                 v_mer_paid_ccy,
                 v_mer_paid_total_amt,
                 v_mer_paid_total_ccy,
                 v_mer_receivable_amt,
                 v_mer_receivable_ccy,
                 v_mer_receivable_net_amt,
                 v_mer_receivable_net_ccy;


         EXIT WHEN merchant_rpt_txn_cur%NOTFOUND;

         Result.EXTEND;
         n := n + 1;
         result (n) :=
            merchant_rpt_txn_OBJ (v_txn_id,
                                  v_txn_country,
                                  v_service_code,
                                  v_mer_short_name,
                                  v_txn_type,
                                  v_mer_ref,
                                  v_holdback_ccy,
                                  v_holdback_amt,
                                  v_status,
                                  v_create_timestamp,
                                  v_approval_timestamp,
                                  v_remark,
                                  v_mer_req_amt,
                                  v_mer_req_ccy,
                                  v_consumer_payable_amt,
                                  v_consumer_payable_ccy,
                                  v_unique_amt_markup,
                                  v_consumer_paid_amt,
                                  v_consumer_paid_ccy,
                                  v_mer_received_amt,
                                  v_mer_received_ccy,
                                  v_txn_fee,
                                  v_txn_fee_ccy,
                                  v_mer_received_net_amt,
                                  v_mer_received_net_ccy,
                                  v_mer_payable_amt,
                                  v_mer_payable_ccy,
                                  v_consumer_received_amt,
                                  v_consumer_received_ccy,
                                  v_mer_paid_amt,
                                  v_mer_paid_ccy,
                                  v_mer_paid_total_amt,
                                  v_mer_paid_total_ccy,
                                  v_mer_receivable_amt,
                                  v_mer_receivable_ccy,
                                  v_mer_receivable_net_amt,
                                  v_mer_receivable_net_ccy);
      END LOOP;

      CLOSE merchant_rpt_txn_cur;

      RETURN (Result);
   END F_MERCHANT_TXN_HISTORY;
END MERCHANT_RPT_PKG;
/

