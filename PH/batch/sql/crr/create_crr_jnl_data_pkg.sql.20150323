CREATE OR REPLACE PACKAGE CRR_JNL_DATA_PKG
AS
   /*TYPE CRR_JNL_DATA_REC IS RECORD
   (
      TXN_DATE               VARCHAR2 (8 BYTE),
      CR_COUNTRY_ID          CHAR (2 BYTE),
      CR_PRODUCT_CODE        CHAR (3 BYTE),
      CR_JNL_TYPE_ID         INTEGER,
      CR_JNL_ENTRY_TYPE_ID   VARCHAR2 (20 BYTE),
      CR_PARTY_TYPE          CHAR (1 BYTE),
      CR_PARTY_ID            VARCHAR (15 BYTE),
      CR_CURRENCY_ID         CHAR (3 BYTE),
      GL_ID                  INTEGER,
      CR_IND                 CHAR (1 BYTE),
      TXN_AMT                NUMBER (14, 2),
      TXN_COUNT              INTEGER,
      TXN_ID                 VARCHAR (16 BYTE)
   );

   TYPE CRR_JNL_DATA_TAB IS TABLE OF CRR_JNL_DATA_REC;
   */

   FUNCTION GET_JNL (in_jnl_type_id    crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
                     in_group_id       crr_jnl_entry_type_mapping.group_id%TYPE,
                     in_fr_txn_date    txn_header.th_approval_date%TYPE,
                     in_to_txn_date    txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_TABLE (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_MERCH_TXN_AMT_MULTI (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_MERCH_TXN_ELEMENTS_MULTI (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_PSP_TXN_ELEMENTS_MULTI (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_MERCH_TXN_ELEMENTS_SINGLE (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_PSP_TXN_ELEMENTS_SINGLE (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;
END CRR_JNL_DATA_PKG;
/


CREATE OR REPLACE PACKAGE BODY CRR_JNL_DATA_PKG
AS
   FUNCTION GET_JNL (in_jnl_type_id    crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
                     in_group_id       crr_jnl_entry_type_mapping.group_id%TYPE,
                     in_fr_txn_date    txn_header.th_approval_date%TYPE,
                     in_to_txn_date    txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN

      FOR ENTRY IN (SELECT ENTRY_TYPE_ID
                      FROM CRR_JNL_ENTRY_TYPE_MAPPING
                     WHERE JNL_TYPE_ID = in_jnl_type_id
                       AND GROUP_ID = in_group_id
                  GROUP BY ENTRY_TYPE_ID)
      LOOP
         FOR RESULT IN (SELECT *
                          FROM TABLE (GET_TABLE (in_jnl_type_id,
                                                 ENTRY.ENTRY_TYPE_ID,
                                                 in_group_id,
                                                 in_fr_txn_date,
                                                 in_to_txn_date)))
         LOOP
            PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                        RESULT.CR_COUNTRY_ID,
                                        RESULT.CR_PRODUCT_CODE,
                                        RESULT.CR_JNL_TYPE_ID,
                                        RESULT.CR_JNL_ENTRY_TYPE_ID,
                                        RESULT.CR_PARTY_TYPE,
                                        RESULT.CR_PARTY_ID,
                                        RESULT.CR_CURRENCY_ID,
                                        RESULT.GL_ID,
                                        RESULT.CR_IND,
                                        RESULT.TXN_AMT,
                                        RESULT.TXN_COUNT,
                                        RESULT.TXN_ID));
         END LOOP;
      END LOOP;

      RETURN;
   END GET_JNL;


   FUNCTION GET_TABLE (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
      txn_table   crr_jnl_entry_type_mapping.TXN_TABLE%TYPE;
      txn_side    crr_jnl_entry_type_mapping.TXN_SIDE%TYPE;
      txn_type    crr_jnl_entry_type_mapping.TXN_ELEMENT_TYPE%TYPE;
      single      crr_jnl_entry_type_mapping.SINGLE%TYPE;
   BEGIN
      SELECT TXN_TABLE, TXN_SIDE, TXN_ELEMENT_TYPE, SINGLE
        INTO txn_table, txn_side, txn_type, single
        FROM (SELECT TXN_TABLE, TXN_SIDE, TXN_ELEMENT_TYPE, SINGLE
                FROM CRR_JNL_ENTRY_TYPE_MAPPING
               WHERE     JNL_TYPE_id = in_jnl_type_id
                     AND ENTRY_TYPE_ID = in_entry_type_id
                     AND GROUP_ID = in_group_id)
       WHERE ROWNUM = 1;

      IF txn_table = 'TXN_HEADER'
      THEN
         IF single <> 1
         THEN
            IF txn_side = 'M'
            THEN
               IF txn_type = 'TAMT'
               THEN
                  FOR RESULT
                     IN (SELECT *
                           FROM TABLE (
                                   GET_MERCH_TXN_AMT_MULTI (
                                      in_jnl_type_id,
                                      in_entry_type_id,
                                      in_group_id,
                                      in_fr_txn_date,
                                      in_to_txn_date)))
                  LOOP
                     PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                                 RESULT.CR_COUNTRY_ID,
                                                 RESULT.CR_PRODUCT_CODE,
                                                 RESULT.CR_JNL_TYPE_ID,
                                                 RESULT.CR_JNL_ENTRY_TYPE_ID,
                                                 RESULT.CR_PARTY_TYPE,
                                                 RESULT.CR_PARTY_ID,
                                                 RESULT.CR_CURRENCY_ID,
                                                 RESULT.GL_ID,
                                                 RESULT.CR_IND,
                                                 RESULT.TXN_AMT,
                                                 RESULT.TXN_COUNT,
                                                 RESULT.TXN_ID));
                  END LOOP;
               END IF;
            END IF;
         END IF;
      ELSIF txn_table = 'TXN_ELEMENTS'
      THEN
         IF single = 1
         THEN
            IF txn_side = 'M'
            THEN
               FOR RESULT
                  IN (SELECT *
                        FROM TABLE (
                                GET_MERCH_TXN_ELEMENTS_SINGLE (
                                   in_jnl_type_id,
                                   in_entry_type_id,
                                   in_group_id,
                                   in_fr_txn_date,
                                   in_to_txn_date)))
               LOOP
                  PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                              RESULT.CR_COUNTRY_ID,
                                              RESULT.CR_PRODUCT_CODE,
                                              RESULT.CR_JNL_TYPE_ID,
                                              RESULT.CR_JNL_ENTRY_TYPE_ID,
                                              RESULT.CR_PARTY_TYPE,
                                              RESULT.CR_PARTY_ID,
                                              RESULT.CR_CURRENCY_ID,
                                              RESULT.GL_ID,
                                              RESULT.CR_IND,
                                              RESULT.TXN_AMT,
                                              RESULT.TXN_COUNT,
                                              RESULT.TXN_ID));
               END LOOP;
            ELSIF txn_side = 'P'
            THEN
               FOR RESULT
                  IN (SELECT *
                        FROM TABLE (
                                GET_PSP_TXN_ELEMENTS_SINGLE (
                                   in_jnl_type_id,
                                   in_entry_type_id,
                                   in_group_id,
                                   in_fr_txn_date,
                                   in_to_txn_date)))
               LOOP
                  PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                              RESULT.CR_COUNTRY_ID,
                                              RESULT.CR_PRODUCT_CODE,
                                              RESULT.CR_JNL_TYPE_ID,
                                              RESULT.CR_JNL_ENTRY_TYPE_ID,
                                              RESULT.CR_PARTY_TYPE,
                                              RESULT.CR_PARTY_ID,
                                              RESULT.CR_CURRENCY_ID,
                                              RESULT.GL_ID,
                                              RESULT.CR_IND,
                                              RESULT.TXN_AMT,
                                              RESULT.TXN_COUNT,
                                              RESULT.TXN_ID));
               END LOOP;
            END IF;
         ELSE
            IF txn_side = 'M'
            THEN
               FOR RESULT
                  IN (SELECT *
                        FROM TABLE (
                                GET_MERCH_TXN_ELEMENTS_MULTI (
                                   in_jnl_type_id,
                                   in_entry_type_id,
                                   in_group_id,
                                   in_fr_txn_date,
                                   in_to_txn_date)))
               LOOP
                  PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                              RESULT.CR_COUNTRY_ID,
                                              RESULT.CR_PRODUCT_CODE,
                                              RESULT.CR_JNL_TYPE_ID,
                                              RESULT.CR_JNL_ENTRY_TYPE_ID,
                                              RESULT.CR_PARTY_TYPE,
                                              RESULT.CR_PARTY_ID,
                                              RESULT.CR_CURRENCY_ID,
                                              RESULT.GL_ID,
                                              RESULT.CR_IND,
                                              RESULT.TXN_AMT,
                                              RESULT.TXN_COUNT,
                                              RESULT.TXN_ID));
               END LOOP;
            ELSIF txn_side = 'P'
            THEN
               FOR RESULT
                  IN (SELECT *
                        FROM TABLE (
                                GET_PSP_TXN_ELEMENTS_MULTI (in_jnl_type_id,
                                                            in_entry_type_id,
                                                            in_group_id,
                                                            in_fr_txn_date,
                                                            in_to_txn_date)))
               LOOP
                  PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                              RESULT.CR_COUNTRY_ID,
                                              RESULT.CR_PRODUCT_CODE,
                                              RESULT.CR_JNL_TYPE_ID,
                                              RESULT.CR_JNL_ENTRY_TYPE_ID,
                                              RESULT.CR_PARTY_TYPE,
                                              RESULT.CR_PARTY_ID,
                                              RESULT.CR_CURRENCY_ID,
                                              RESULT.GL_ID,
                                              RESULT.CR_IND,
                                              RESULT.TXN_AMT,
                                              RESULT.TXN_COUNT,
                                              RESULT.TXN_ID));
               END LOOP;
            END IF;
         END IF;
      END IF;

      RETURN;
   END GET_TABLE;



   FUNCTION GET_MERCH_TXN_AMT_MULTI (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (  SELECT TH_APPROVAL_DATE TXN_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CASE
                         WHEN CR_PARTY_TYPE <> 'G' THEN CR_PARTY_ID
                         ELSE ''
                      END
                         CR_PARTY_ID,
                      TD_TXN_CCY CR_CURRENCY_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN CR_CREDIT_GL_ID
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN CR_DEBIT_GL_ID
                         ELSE 0
                      END
                         GL_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN 'D'
                         ELSE ''
                      END
                         CR_IND,
                      SUM (TH_TRANSACTION_AMOUNT) TXN_AMT,
                      1 TXN_COUNT,
                      TH_TXN_ID TXN_ID
                 FROM (SELECT TH_TXN_ID,
                              TH_TXN_CODE,
                              TH_APPROVAL_DATE,
                              TH_TRANSACTION_AMOUNT,
                              TH_NET_CCY,
                              TH_NET_AMOUNT,
                              TH_MERCHANT_ID,
                              TH_SERVICE_CODE
                         FROM TXN_HEADER
                        WHERE     TH_APPROVAL_DATE >= in_fr_txn_date
                              AND TH_APPROVAL_DATE <= in_to_txn_date
                              AND TH_STATUS IN ('C', 'R')
                              AND TH_AR_IND = 'A'),
                      (SELECT TD_TXN_ID, TD_TXN_COUNTRY, TD_TXN_CCY
                         FROM TXN_DETAIL),
                      (SELECT CR_COUNTRY_ID,
                              CR_PARTY_TYPE,
                              CR_PARTY_ID,
                              CR_JNL_TYPE_ID,
                              CR_JNL_ENTRY_TYPE_ID,
                              CR_TXN_CODE,
                              CR_PRODUCT_CODE,
                              CR_CURRENCY_ID,
                              CR_CREDIT_GL_ID,
                              CR_DEBIT_GL_ID
                         FROM CRR_RULE_POSTING
                        WHERE     CR_JNL_TYPE_ID = in_jnl_type_id
                              AND CR_JNL_ENTRY_TYPE_ID = in_entry_type_id
                              AND CR_DISABLED = 0),
                      (SELECT TXN_CODE,
                              PARTY_TYPE,
                              TXN_ELEMENT_TYPE,
                              SIGN
                         FROM CRR_JNL_ENTRY_TYPE_MAPPING
                        WHERE     JNL_TYPE_ID = in_jnl_type_id
                              AND ENTRY_TYPE_ID = in_entry_type_id
                              AND GROUP_ID = in_group_id
                              AND DISABLED = 0)
                WHERE     TH_TXN_ID = TD_TXN_ID
                      AND TH_TXN_CODE = TXN_CODE
                      AND (CR_COUNTRY_ID = TD_TXN_COUNTRY)
                      AND EXISTS
                             (SELECT *
                                FROM CRR_PRODUCT_CODE_MAP
                               WHERE     TH_MERCHANT_ID = PM_MERCHANT_ID
                                     AND TH_SERVICE_CODE = PM_SERVICE_CODE
                                     AND TD_TXN_COUNTRY = PM_COUNTRY
                                     AND CR_PRODUCT_CODE = PM_PRODUCT_CODE
                                     AND PM_DISABLED = 0)
                      AND (CR_PARTY_ID = TH_MERCHANT_ID OR CR_PARTY_TYPE = 'G')
                      AND (   CR_CURRENCY_ID = TD_TXN_CCY
                           OR CR_CURRENCY_ID = 'ALL')
             GROUP BY TH_APPROVAL_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CR_PARTY_ID,
                      TD_TXN_CCY,
                      CR_CREDIT_GL_ID,
                      CR_DEBIT_GL_ID,
                      TH_TXN_ID)
      LOOP
         PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                     RESULT.CR_COUNTRY_ID,
                                     RESULT.CR_PRODUCT_CODE,
                                     RESULT.CR_JNL_TYPE_ID,
                                     RESULT.CR_JNL_ENTRY_TYPE_ID,
                                     RESULT.CR_PARTY_TYPE,
                                     RESULT.CR_PARTY_ID,
                                     RESULT.CR_CURRENCY_ID,
                                     RESULT.GL_ID,
                                     RESULT.CR_IND,
                                     RESULT.TXN_AMT,
                                     RESULT.TXN_COUNT,
                                     RESULT.TXN_ID));
      END LOOP;

      RETURN;
   END GET_MERCH_TXN_AMT_MULTI;



   FUNCTION GET_MERCH_TXN_ELEMENTS_MULTI (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (  SELECT TH_APPROVAL_DATE TXN_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CASE
                         WHEN CR_PARTY_TYPE <> 'G' THEN CR_PARTY_ID
                         ELSE ''
                      END
                         CR_PARTY_ID,
                      TE_CCY CR_CURRENCY_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN CR_CREDIT_GL_ID
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN CR_DEBIT_GL_ID
                         ELSE 0
                      END
                         GL_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN 'D'
                         ELSE ''
                      END
                         CR_IND,
                      SUM (TE_AMOUNT * SIGN) TXN_AMT,
                      1 TXN_COUNT,
                      TH_TXN_ID TXN_ID
                 FROM (SELECT TH_TXN_ID,
                              TH_TXN_CODE,
                              TH_APPROVAL_DATE,
                              TH_TRANSACTION_AMOUNT,
                              TH_NET_CCY,
                              TH_NET_AMOUNT,
                              TH_MERCHANT_ID,
                              TH_SERVICE_CODE
                         FROM TXN_HEADER
                        WHERE     TH_APPROVAL_DATE >= in_fr_txn_date
                              AND TH_APPROVAL_DATE <= in_to_txn_date
                              AND TH_STATUS IN ('C', 'R')
                              AND TH_AR_IND = 'A'),
                      (SELECT TD_TXN_ID, TD_TXN_COUNTRY, TD_TXN_CCY
                         FROM TXN_DETAIL),
                      (SELECT TE_TXN_ID,
                              TE_PARTY_TYPE,
                              TE_TXN_ELEMENT_TYPE,
                              TE_CCY,
                              TE_AMOUNT
                         FROM TXN_ELEMENTS),
                      (SELECT CR_COUNTRY_ID,
                              CR_PARTY_TYPE,
                              CR_PARTY_ID,
                              CR_JNL_TYPE_ID,
                              CR_JNL_ENTRY_TYPE_ID,
                              CR_TXN_CODE,
                              CR_PRODUCT_CODE,
                              CR_CURRENCY_ID,
                              CR_CREDIT_GL_ID,
                              CR_DEBIT_GL_ID
                         FROM CRR_RULE_POSTING
                        WHERE     CR_JNL_TYPE_ID = in_jnl_type_id
                              AND CR_JNL_ENTRY_TYPE_ID = in_entry_type_id
                              AND CR_DISABLED = 0),
                      (SELECT TXN_CODE,
                              PARTY_TYPE,
                              TXN_ELEMENT_TYPE,
                              SIGN
                         FROM CRR_JNL_ENTRY_TYPE_MAPPING
                        WHERE     JNL_TYPE_ID = in_jnl_type_id
                              AND ENTRY_TYPE_ID = in_entry_type_id
                              AND GROUP_ID = in_group_id
                              AND DISABLED = 0)
                WHERE     TH_TXN_ID = TD_TXN_ID
                      AND TH_TXN_ID = TE_TXN_ID
                      AND TH_TXN_CODE = TXN_CODE
                      AND TE_PARTY_TYPE = PARTY_TYPE
                      AND TE_TXN_ELEMENT_TYPE = TXN_ELEMENT_TYPE
                      AND (CR_COUNTRY_ID = TD_TXN_COUNTRY)
                      AND EXISTS
                             (SELECT *
                                FROM CRR_PRODUCT_CODE_MAP
                               WHERE     TH_MERCHANT_ID = PM_MERCHANT_ID
                                     AND TH_SERVICE_CODE = PM_SERVICE_CODE
                                     AND TD_TXN_COUNTRY = PM_COUNTRY
                                     AND CR_PRODUCT_CODE = PM_PRODUCT_CODE
                                     AND PM_DISABLED = 0)
                      AND (CR_PARTY_ID = TH_MERCHANT_ID OR CR_PARTY_TYPE = 'G')
                      AND (CR_CURRENCY_ID = TE_CCY OR CR_CURRENCY_ID = 'ALL')
             GROUP BY TH_APPROVAL_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CR_PARTY_ID,
                      TE_CCY,
                      CR_CREDIT_GL_ID,
                      CR_DEBIT_GL_ID,
                      TH_TXN_ID)
      LOOP
         PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                     RESULT.CR_COUNTRY_ID,
                                     RESULT.CR_PRODUCT_CODE,
                                     RESULT.CR_JNL_TYPE_ID,
                                     RESULT.CR_JNL_ENTRY_TYPE_ID,
                                     RESULT.CR_PARTY_TYPE,
                                     RESULT.CR_PARTY_ID,
                                     RESULT.CR_CURRENCY_ID,
                                     RESULT.GL_ID,
                                     RESULT.CR_IND,
                                     RESULT.TXN_AMT,
                                     RESULT.TXN_COUNT,
                                     RESULT.TXN_ID));
      END LOOP;

      RETURN;
   END GET_MERCH_TXN_ELEMENTS_MULTI;


   FUNCTION GET_PSP_TXN_ELEMENTS_MULTI (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (  SELECT TH_APPROVAL_DATE TXN_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CASE
                         WHEN CR_PARTY_TYPE <> 'G' THEN CR_PARTY_ID
                         ELSE ''
                      END
                         CR_PARTY_ID,
                      TE_CCY CR_CURRENCY_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN CR_CREDIT_GL_ID
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN CR_DEBIT_GL_ID
                         ELSE 0
                      END
                         GL_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN 'D'
                         ELSE ''
                      END
                         CR_IND,
                      SUM (TE_AMOUNT * SIGN) TXN_AMT,
                      1 TXN_COUNT,
                      TH_TXN_ID TXN_ID
                 FROM (SELECT TH_TXN_ID,
                              TH_TXN_CODE,
                              TH_APPROVAL_DATE,
                              TH_TRANSACTION_AMOUNT,
                              TH_NET_CCY,
                              TH_NET_AMOUNT,
                              TH_MERCHANT_ID,
                              TH_SERVICE_CODE
                         FROM TXN_HEADER
                        WHERE     TH_APPROVAL_DATE >= in_fr_txn_date
                              AND TH_APPROVAL_DATE <= in_to_txn_date
                              AND TH_STATUS IN ('C', 'R')
                              AND TH_AR_IND = 'A'),
                      (SELECT TD_TXN_ID, TD_TXN_COUNTRY, TD_TXN_CCY
                         FROM TXN_DETAIL),
                      (SELECT TP_TXN_ID, TP_PSP_ID FROM TXN_PSP_DETAIL),
                      (SELECT TE_TXN_ID,
                              TE_PARTY_TYPE,
                              TE_TXN_ELEMENT_TYPE,
                              TE_CCY,
                              TE_AMOUNT
                         FROM TXN_ELEMENTS),
                      (SELECT CR_COUNTRY_ID,
                              CR_PARTY_TYPE,
                              CR_PARTY_ID,
                              CR_JNL_TYPE_ID,
                              CR_JNL_ENTRY_TYPE_ID,
                              CR_TXN_CODE,
                              CR_PRODUCT_CODE,
                              CR_CURRENCY_ID,
                              CR_CREDIT_GL_ID,
                              CR_DEBIT_GL_ID
                         FROM CRR_RULE_POSTING
                        WHERE     CR_JNL_TYPE_ID = in_jnl_type_id
                              AND CR_JNL_ENTRY_TYPE_ID = in_entry_type_id
                              AND CR_DISABLED = 0),
                      (SELECT TXN_CODE,
                              PARTY_TYPE,
                              TXN_ELEMENT_TYPE,
                              SIGN
                         FROM CRR_JNL_ENTRY_TYPE_MAPPING
                        WHERE     JNL_TYPE_ID = in_jnl_type_id
                              AND ENTRY_TYPE_ID = in_entry_type_id
                              AND GROUP_ID = in_group_id
                              AND DISABLED = 0)
                WHERE     TH_TXN_ID = TD_TXN_ID
                      AND TH_TXN_ID = TP_TXN_ID
                      AND TH_TXN_ID = TE_TXN_ID
                      AND TH_TXN_CODE = TXN_CODE
                      AND TE_PARTY_TYPE = PARTY_TYPE
                      AND TE_TXN_ELEMENT_TYPE = TXN_ELEMENT_TYPE
                      AND (CR_COUNTRY_ID = TD_TXN_COUNTRY)
                      AND EXISTS
                             (SELECT *
                                FROM PSP_DETAIL, CRR_PSP_PRODUCT_CODE_MAP
                               WHERE     PSP_ID = TP_PSP_ID
                                     AND PSP_ID = PM_PSP_ID
                                     AND PSP_TYPE = PM_BUSINESS_TYPE
                                     AND CR_PRODUCT_CODE = PM_PRODUCT_CODE
                                     AND PM_DISABLED = 0)
                      AND (CR_PARTY_ID = TP_PSP_ID OR CR_PARTY_TYPE = 'G')
                      AND (CR_CURRENCY_ID = TE_CCY OR CR_CURRENCY_ID = 'ALL')
             GROUP BY TH_APPROVAL_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CR_PARTY_ID,
                      TE_CCY,
                      CR_CREDIT_GL_ID,
                      CR_DEBIT_GL_ID,
                      TH_TXN_ID)
      LOOP
         PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                     RESULT.CR_COUNTRY_ID,
                                     RESULT.CR_PRODUCT_CODE,
                                     RESULT.CR_JNL_TYPE_ID,
                                     RESULT.CR_JNL_ENTRY_TYPE_ID,
                                     RESULT.CR_PARTY_TYPE,
                                     RESULT.CR_PARTY_ID,
                                     RESULT.CR_CURRENCY_ID,
                                     RESULT.GL_ID,
                                     RESULT.CR_IND,
                                     RESULT.TXN_AMT,
                                     RESULT.TXN_COUNT,
                                     RESULT.TXN_ID));
      END LOOP;

      RETURN;
   END GET_PSP_TXN_ELEMENTS_MULTI;



   FUNCTION GET_MERCH_TXN_ELEMENTS_SINGLE (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (  SELECT TH_APPROVAL_DATE TXN_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CASE
                         WHEN CR_PARTY_TYPE <> 'G' THEN CR_PARTY_ID
                         ELSE ''
                      END
                         CR_PARTY_ID,
                      TE_CCY CR_CURRENCY_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN CR_CREDIT_GL_ID
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN CR_DEBIT_GL_ID
                         ELSE 0
                      END
                         GL_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN 'D'
                         ELSE ''
                      END
                         CR_IND,
                      SUM (TE_AMOUNT * SIGN) TXN_AMT,
                      COUNT (DISTINCT TH_TXN_ID) TXN_COUNT,
                      '' TXN_ID
                 FROM (SELECT TH_TXN_ID,
                              TH_TXN_CODE,
                              TH_APPROVAL_DATE,
                              TH_TRANSACTION_AMOUNT,
                              TH_NET_CCY,
                              TH_NET_AMOUNT,
                              TH_MERCHANT_ID,
                              TH_SERVICE_CODE
                         FROM TXN_HEADER
                        WHERE     TH_APPROVAL_DATE >= in_fr_txn_date
                              AND TH_APPROVAL_DATE <= in_to_txn_date
                              AND TH_STATUS IN ('C', 'R')
                              AND TH_AR_IND = 'A'),
                      (SELECT TD_TXN_ID, TD_TXN_COUNTRY, TD_TXN_CCY
                         FROM TXN_DETAIL),
                      (SELECT TE_TXN_ID,
                              TE_PARTY_TYPE,
                              TE_TXN_ELEMENT_TYPE,
                              TE_CCY,
                              TE_AMOUNT
                         FROM TXN_ELEMENTS),
                      (SELECT CR_COUNTRY_ID,
                              CR_PARTY_TYPE,
                              CR_PARTY_ID,
                              CR_JNL_TYPE_ID,
                              CR_JNL_ENTRY_TYPE_ID,
                              CR_TXN_CODE,
                              CR_PRODUCT_CODE,
                              CR_CURRENCY_ID,
                              CR_CREDIT_GL_ID,
                              CR_DEBIT_GL_ID
                         FROM CRR_RULE_POSTING
                        WHERE     CR_JNL_TYPE_ID = in_jnl_type_id
                              AND CR_JNL_ENTRY_TYPE_ID = in_entry_type_id
                              AND CR_DISABLED = 0),
                      (SELECT TXN_CODE,
                              PARTY_TYPE,
                              TXN_ELEMENT_TYPE,
                              SIGN
                         FROM CRR_JNL_ENTRY_TYPE_MAPPING
                        WHERE     JNL_TYPE_ID = in_jnl_type_id
                              AND ENTRY_TYPE_ID = in_entry_type_id
                              AND GROUP_ID = in_group_id
                              AND DISABLED = 0)
                WHERE     TH_TXN_ID = TD_TXN_ID
                      AND TH_TXN_ID = TE_TXN_ID
                      AND TH_TXN_CODE = TXN_CODE
                      AND TE_PARTY_TYPE = PARTY_TYPE
                      AND TE_TXN_ELEMENT_TYPE = TXN_ELEMENT_TYPE
                      AND (CR_COUNTRY_ID = TD_TXN_COUNTRY)
                      AND EXISTS
                             (SELECT *
                                FROM CRR_PRODUCT_CODE_MAP
                               WHERE     TH_MERCHANT_ID = PM_MERCHANT_ID
                                     AND TH_SERVICE_CODE = PM_SERVICE_CODE
                                     AND TD_TXN_COUNTRY = PM_COUNTRY
                                     AND CR_PRODUCT_CODE = PM_PRODUCT_CODE
                                     AND PM_DISABLED = 0)
                      AND (CR_PARTY_ID = TH_MERCHANT_ID OR CR_PARTY_TYPE = 'G')
                      AND (CR_CURRENCY_ID = TE_CCY OR CR_CURRENCY_ID = 'ALL')
             GROUP BY TH_APPROVAL_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CR_PARTY_ID,
                      TE_CCY,
                      CR_CREDIT_GL_ID,
                      CR_DEBIT_GL_ID)
      LOOP
         PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                     RESULT.CR_COUNTRY_ID,
                                     RESULT.CR_PRODUCT_CODE,
                                     RESULT.CR_JNL_TYPE_ID,
                                     RESULT.CR_JNL_ENTRY_TYPE_ID,
                                     RESULT.CR_PARTY_TYPE,
                                     RESULT.CR_PARTY_ID,
                                     RESULT.CR_CURRENCY_ID,
                                     RESULT.GL_ID,
                                     RESULT.CR_IND,
                                     RESULT.TXN_AMT,
                                     RESULT.TXN_COUNT,
                                     RESULT.TXN_ID));
      END LOOP;

      RETURN;
   END GET_MERCH_TXN_ELEMENTS_SINGLE;


   FUNCTION GET_PSP_TXN_ELEMENTS_SINGLE (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (  SELECT TH_APPROVAL_DATE TXN_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CASE
                         WHEN CR_PARTY_TYPE <> 'G' THEN CR_PARTY_ID
                         ELSE ''
                      END
                         CR_PARTY_ID,
                      TE_CCY CR_CURRENCY_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN CR_CREDIT_GL_ID
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN CR_DEBIT_GL_ID
                         ELSE 0
                      END
                         GL_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN 'D'
                         ELSE ''
                      END
                         CR_IND,
                      SUM (TE_AMOUNT * SIGN) TXN_AMT,
                      COUNT (DISTINCT TH_TXN_ID) TXN_COUNT,
                      '' TXN_ID
                 FROM (SELECT TH_TXN_ID,
                              TH_TXN_CODE,
                              TH_APPROVAL_DATE,
                              TH_TRANSACTION_AMOUNT,
                              TH_NET_CCY,
                              TH_NET_AMOUNT,
                              TH_MERCHANT_ID,
                              TH_SERVICE_CODE
                         FROM TXN_HEADER
                        WHERE     TH_APPROVAL_DATE >= in_fr_txn_date
                              AND TH_APPROVAL_DATE <= in_to_txn_date
                              AND TH_STATUS IN ('C', 'R')
                              AND TH_AR_IND = 'A'),
                      (SELECT TD_TXN_ID, TD_TXN_COUNTRY, TD_TXN_CCY
                         FROM TXN_DETAIL),
                      (SELECT TP_TXN_ID, TP_PSP_ID FROM TXN_PSP_DETAIL),
                      (SELECT TE_TXN_ID,
                              TE_PARTY_TYPE,
                              TE_TXN_ELEMENT_TYPE,
                              TE_CCY,
                              TE_AMOUNT
                         FROM TXN_ELEMENTS),
                      (SELECT CR_COUNTRY_ID,
                              CR_PARTY_TYPE,
                              CR_PARTY_ID,
                              CR_JNL_TYPE_ID,
                              CR_JNL_ENTRY_TYPE_ID,
                              CR_TXN_CODE,
                              CR_PRODUCT_CODE,
                              CR_CURRENCY_ID,
                              CR_CREDIT_GL_ID,
                              CR_DEBIT_GL_ID
                         FROM CRR_RULE_POSTING
                        WHERE     CR_JNL_TYPE_ID = in_jnl_type_id
                              AND CR_JNL_ENTRY_TYPE_ID = in_entry_type_id
                              AND CR_DISABLED = 0),
                      (SELECT TXN_CODE,
                              PARTY_TYPE,
                              TXN_ELEMENT_TYPE,
                              SIGN
                         FROM CRR_JNL_ENTRY_TYPE_MAPPING
                        WHERE     JNL_TYPE_ID = in_jnl_type_id
                              AND ENTRY_TYPE_ID = in_entry_type_id
                              AND GROUP_ID = in_group_id
                              AND DISABLED = 0)
                WHERE     TH_TXN_ID = TD_TXN_ID
                      AND TH_TXN_ID = TP_TXN_ID
                      AND TH_TXN_ID = TE_TXN_ID
                      AND TH_TXN_CODE = TXN_CODE
                      AND TE_PARTY_TYPE = PARTY_TYPE
                      AND TE_TXN_ELEMENT_TYPE = TXN_ELEMENT_TYPE
                      AND (CR_COUNTRY_ID = TD_TXN_COUNTRY)
                      AND EXISTS
                             (SELECT *
                                FROM PSP_DETAIL, CRR_PSP_PRODUCT_CODE_MAP
                               WHERE     PSP_ID = TP_PSP_ID
                                     AND PSP_ID = PM_PSP_ID
                                     AND PSP_TYPE = PM_BUSINESS_TYPE
                                     AND CR_PRODUCT_CODE = PM_PRODUCT_CODE
                                     AND PM_DISABLED = 0)
                      AND (CR_PARTY_ID = TP_PSP_ID OR CR_PARTY_TYPE = 'G')
                      AND (CR_CURRENCY_ID = TE_CCY OR CR_CURRENCY_ID = 'ALL')
             GROUP BY TH_APPROVAL_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CR_PARTY_ID,
                      TE_CCY,
                      CR_CREDIT_GL_ID,
                      CR_DEBIT_GL_ID)
      LOOP
         PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                     RESULT.CR_COUNTRY_ID,
                                     RESULT.CR_PRODUCT_CODE,
                                     RESULT.CR_JNL_TYPE_ID,
                                     RESULT.CR_JNL_ENTRY_TYPE_ID,
                                     RESULT.CR_PARTY_TYPE,
                                     RESULT.CR_PARTY_ID,
                                     RESULT.CR_CURRENCY_ID,
                                     RESULT.GL_ID,
                                     RESULT.CR_IND,
                                     RESULT.TXN_AMT,
                                     RESULT.TXN_COUNT,
                                     RESULT.TXN_ID));
      END LOOP;

      RETURN;
   END GET_PSP_TXN_ELEMENTS_SINGLE;
END CRR_JNL_DATA_PKG;
/

