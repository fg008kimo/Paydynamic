CREATE OR REPLACE PACKAGE CRR_JNL_DATA_PKG
AS
   /*TYPE CRR_JNL_DATA_REC IS RECORD
   (
      TXN_DATE               VARCHAR2 (8 BYTE),
      CR_COUNTRY_ID          CHAR (2 BYTE),
      CR_PRODUCT_CODE        CHAR (3 BYTE),
      CR_JNL_TYPE_ID         INTEGER,
      CR_JNL_ENTRY_TYPE_ID   VARCHAR2 (20 BYTE),
      CR_PARTY_TYPE          CHAR (1 BYTE),
      CR_PARTY_ID            VARCHAR (15 BYTE),
      CR_CURRENCY_ID         CHAR (3 BYTE),
      GL_ID                  INTEGER,
      CR_IND                 CHAR (1 BYTE),
      TXN_AMT                NUMBER (14, 2),
      TXN_COUNT              INTEGER,
      TXN_ID                 VARCHAR (16 BYTE)
   );

   TYPE CRR_JNL_DATA_TAB IS TABLE OF CRR_JNL_DATA_REC;
   */

   FUNCTION GET_JNL (in_jnl_type_id    crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
                     in_group_id       crr_jnl_entry_type_mapping.group_id%TYPE,
                     in_fr_txn_date    txn_header.th_approval_date%TYPE,
                     in_to_txn_date    txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_OFL_JNL (in_jnl_type_id    crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%TYPE,
                         in_group_id       crr_ofl_jnl_entry_type_mapping.com_group_id%TYPE,
                         in_fr_txn_date    txn_header.th_approval_date%TYPE,
                         in_to_txn_date    txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_TABLE (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_OFL_TABLE (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%TYPE,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%TYPE,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_MERCH_TXN_AMT_MULTI (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_MERCH_TXN_ELEMENTS_MULTI (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_PSP_TXN_ELEMENTS_MULTI (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_MERCH_TXN_ELEMENTS_SINGLE (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_PSP_TXN_ELEMENTS_SINGLE (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_OFL_PSP_MULTI (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%TYPE,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%TYPE,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%TYPE,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED;

   FUNCTION GET_OFL_MERCH_MULTI (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%type,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%type,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%type,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%type,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%type,
      in_amt_type         varchar)
      return crr_jnl_data_tab
      pipelined;

   FUNCTION GET_OFL_PSP_GLOBAL (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%type,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%type,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%type,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%type,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%type)
      return crr_jnl_data_tab
      pipelined;

   FUNCTION GET_OFL_PSP_BAID_GLOBAL (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%type,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%type,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%type,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%type,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%type)
      return crr_jnl_data_tab
      pipelined;

   FUNCTION GET_OFL_MERCH_TXN_AMT_GLOBAL (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%type,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%type,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%type,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%type,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%type)
      return crr_jnl_data_tab
      pipelined;

  FUNCTION GET_OFL_MERCH_FEE_GLOBAL (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%type,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%type,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%type,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%type,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%type)
      return crr_jnl_data_tab
      pipelined;

   FUNCTION GET_OFL_PSP_MARKUP_GLOBAL (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%type,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%type,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%type,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%type,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%type)
      return crr_jnl_data_tab
      pipelined;

   FUNCTION GET_OFL_PSP_DELI_GLOBAL (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%type,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%type,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%type,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%type,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%type)
      return crr_jnl_data_tab
      pipelined;


END CRR_JNL_DATA_PKG;
/


CREATE OR REPLACE PACKAGE BODY CRR_JNL_DATA_PKG
AS
   FUNCTION GET_JNL (in_jnl_type_id    crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
                     in_group_id       crr_jnl_entry_type_mapping.group_id%TYPE,
                     in_fr_txn_date    txn_header.th_approval_date%TYPE,
                     in_to_txn_date    txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN

      FOR ENTRY IN (SELECT ENTRY_TYPE_ID
                      FROM CRR_JNL_ENTRY_TYPE_MAPPING
                     WHERE JNL_TYPE_ID = in_jnl_type_id
                       AND GROUP_ID = in_group_id
                  GROUP BY ENTRY_TYPE_ID)
      LOOP
         FOR RESULT IN (SELECT *
                          FROM TABLE (GET_TABLE (in_jnl_type_id,
                                                 ENTRY.ENTRY_TYPE_ID,
                                                 in_group_id,
                                                 in_fr_txn_date,
                                                 in_to_txn_date)))
         LOOP
            PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                        RESULT.CR_COUNTRY_ID,
                                        RESULT.CR_PRODUCT_CODE,
                                        RESULT.CR_JNL_TYPE_ID,
                                        RESULT.CR_JNL_ENTRY_TYPE_ID,
                                        RESULT.CR_PARTY_TYPE,
                                        RESULT.CR_PARTY_ID,
                                        RESULT.CR_CURRENCY_ID,
                                        RESULT.GL_ID,
                                        RESULT.CR_IND,
                                        RESULT.TXN_AMT,
                                        RESULT.TXN_COUNT,
                                        RESULT.TXN_ID));
         END LOOP;
      END LOOP;

      RETURN;
   END GET_JNL;


   FUNCTION GET_OFL_JNL (in_jnl_type_id    crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%TYPE,
                         in_group_id       crr_ofl_jnl_entry_type_mapping.com_group_id%TYPE,
                         in_fr_txn_date    txn_header.th_approval_date%TYPE,
                         in_to_txn_date    txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN

      FOR ENTRY IN (SELECT COM_ENTRY_TYPE_ID
                      FROM CRR_OFL_JNL_ENTRY_TYPE_MAPPING
                     WHERE COM_JNL_TYPE_ID = in_jnl_type_id
                       AND COM_GROUP_ID = in_group_id
                  GROUP BY COM_ENTRY_TYPE_ID)
      LOOP
         FOR RESULT IN (SELECT *
                          FROM TABLE (GET_OFL_TABLE (in_jnl_type_id,
                                                     ENTRY.COM_ENTRY_TYPE_ID,
                                                     in_group_id,
                                                     in_fr_txn_date,
                                                     in_to_txn_date)))
         LOOP
            PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                        RESULT.CR_COUNTRY_ID,
                                        RESULT.CR_PRODUCT_CODE,
                                        RESULT.CR_JNL_TYPE_ID,
                                        RESULT.CR_JNL_ENTRY_TYPE_ID,
                                        RESULT.CR_PARTY_TYPE,
                                        RESULT.CR_PARTY_ID,
                                        RESULT.CR_CURRENCY_ID,
                                        RESULT.GL_ID,
                                        RESULT.CR_IND,
                                        RESULT.TXN_AMT,
                                        RESULT.TXN_COUNT,
                                        RESULT.TXN_ID));
         END LOOP;
      END LOOP;

      RETURN;
   END GET_OFL_JNL;


   FUNCTION GET_TABLE (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
      txn_table   crr_jnl_entry_type_mapping.TXN_TABLE%TYPE;
      txn_side    crr_jnl_entry_type_mapping.TXN_SIDE%TYPE;
      txn_type    crr_jnl_entry_type_mapping.TXN_ELEMENT_TYPE%TYPE;
      single      crr_jnl_entry_type_mapping.SINGLE%TYPE;
   BEGIN
      SELECT TXN_TABLE, TXN_SIDE, TXN_ELEMENT_TYPE, SINGLE
        INTO txn_table, txn_side, txn_type, single
        FROM (SELECT TXN_TABLE, TXN_SIDE, TXN_ELEMENT_TYPE, SINGLE
                FROM CRR_JNL_ENTRY_TYPE_MAPPING
               WHERE     JNL_TYPE_id = in_jnl_type_id
                     AND ENTRY_TYPE_ID = in_entry_type_id
                     AND GROUP_ID = in_group_id)
       WHERE ROWNUM = 1;

      IF txn_table = 'TXN_HEADER'
      THEN
         IF single <> 1
         THEN
            IF txn_side = 'M'
            THEN
               IF txn_type = 'TAMT'
               THEN
                  FOR RESULT
                     IN (SELECT *
                           FROM TABLE (
                                   GET_MERCH_TXN_AMT_MULTI (
                                      in_jnl_type_id,
                                      in_entry_type_id,
                                      in_group_id,
                                      in_fr_txn_date,
                                      in_to_txn_date)))
                  LOOP
                     PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                                 RESULT.CR_COUNTRY_ID,
                                                 RESULT.CR_PRODUCT_CODE,
                                                 RESULT.CR_JNL_TYPE_ID,
                                                 RESULT.CR_JNL_ENTRY_TYPE_ID,
                                                 RESULT.CR_PARTY_TYPE,
                                                 RESULT.CR_PARTY_ID,
                                                 RESULT.CR_CURRENCY_ID,
                                                 RESULT.GL_ID,
                                                 RESULT.CR_IND,
                                                 RESULT.TXN_AMT,
                                                 RESULT.TXN_COUNT,
                                                 RESULT.TXN_ID));
                  END LOOP;
               END IF;
            END IF;
         END IF;
      ELSIF txn_table = 'TXN_ELEMENTS'
      THEN
         IF single = 1
         THEN
            IF txn_side = 'M'
            THEN
               FOR RESULT
                  IN (SELECT *
                        FROM TABLE (
                                GET_MERCH_TXN_ELEMENTS_SINGLE (
                                   in_jnl_type_id,
                                   in_entry_type_id,
                                   in_group_id,
                                   in_fr_txn_date,
                                   in_to_txn_date)))
               LOOP
                  PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                              RESULT.CR_COUNTRY_ID,
                                              RESULT.CR_PRODUCT_CODE,
                                              RESULT.CR_JNL_TYPE_ID,
                                              RESULT.CR_JNL_ENTRY_TYPE_ID,
                                              RESULT.CR_PARTY_TYPE,
                                              RESULT.CR_PARTY_ID,
                                              RESULT.CR_CURRENCY_ID,
                                              RESULT.GL_ID,
                                              RESULT.CR_IND,
                                              RESULT.TXN_AMT,
                                              RESULT.TXN_COUNT,
                                              RESULT.TXN_ID));
               END LOOP;
            ELSIF txn_side = 'P'
            THEN
               FOR RESULT
                  IN (SELECT *
                        FROM TABLE (
                                GET_PSP_TXN_ELEMENTS_SINGLE (
                                   in_jnl_type_id,
                                   in_entry_type_id,
                                   in_group_id,
                                   in_fr_txn_date,
                                   in_to_txn_date)))
               LOOP
                  PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                              RESULT.CR_COUNTRY_ID,
                                              RESULT.CR_PRODUCT_CODE,
                                              RESULT.CR_JNL_TYPE_ID,
                                              RESULT.CR_JNL_ENTRY_TYPE_ID,
                                              RESULT.CR_PARTY_TYPE,
                                              RESULT.CR_PARTY_ID,
                                              RESULT.CR_CURRENCY_ID,
                                              RESULT.GL_ID,
                                              RESULT.CR_IND,
                                              RESULT.TXN_AMT,
                                              RESULT.TXN_COUNT,
                                              RESULT.TXN_ID));
               END LOOP;
            END IF;
         ELSE
            IF txn_side = 'M'
            THEN
               FOR RESULT
                  IN (SELECT *
                        FROM TABLE (
                                GET_MERCH_TXN_ELEMENTS_MULTI (
                                   in_jnl_type_id,
                                   in_entry_type_id,
                                   in_group_id,
                                   in_fr_txn_date,
                                   in_to_txn_date)))
               LOOP
                  PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                              RESULT.CR_COUNTRY_ID,
                                              RESULT.CR_PRODUCT_CODE,
                                              RESULT.CR_JNL_TYPE_ID,
                                              RESULT.CR_JNL_ENTRY_TYPE_ID,
                                              RESULT.CR_PARTY_TYPE,
                                              RESULT.CR_PARTY_ID,
                                              RESULT.CR_CURRENCY_ID,
                                              RESULT.GL_ID,
                                              RESULT.CR_IND,
                                              RESULT.TXN_AMT,
                                              RESULT.TXN_COUNT,
                                              RESULT.TXN_ID));
               END LOOP;
            ELSIF txn_side = 'P'
            THEN
               FOR RESULT
                  IN (SELECT *
                        FROM TABLE (
                                GET_PSP_TXN_ELEMENTS_MULTI (in_jnl_type_id,
                                                            in_entry_type_id,
                                                            in_group_id,
                                                            in_fr_txn_date,
                                                            in_to_txn_date)))
               LOOP
                  PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                              RESULT.CR_COUNTRY_ID,
                                              RESULT.CR_PRODUCT_CODE,
                                              RESULT.CR_JNL_TYPE_ID,
                                              RESULT.CR_JNL_ENTRY_TYPE_ID,
                                              RESULT.CR_PARTY_TYPE,
                                              RESULT.CR_PARTY_ID,
                                              RESULT.CR_CURRENCY_ID,
                                              RESULT.GL_ID,
                                              RESULT.CR_IND,
                                              RESULT.TXN_AMT,
                                              RESULT.TXN_COUNT,
                                              RESULT.TXN_ID));
               END LOOP;
            END IF;
         END IF;
      END IF;

      RETURN;
   END GET_TABLE;


   FUNCTION GET_OFL_TABLE (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%TYPE,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%TYPE,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
      txn_side    crr_ofl_jnl_entry_type_mapping.COM_TXN_SIDE%TYPE;
      txn_type    crr_ofl_jnl_entry_type_mapping.COM_AMT_FIELD%TYPE;
      single      crr_ofl_jnl_entry_type_mapping.COM_IS_SINGLE%TYPE;
      txn_code    crr_ofl_jnl_entry_type_mapping.COM_TXN_CODE%TYPE;
   BEGIN
      SELECT COM_AMT_FIELD
        INTO txn_type
        FROM (SELECT COM_TXN_SIDE, COM_AMT_FIELD, COM_IS_SINGLE, COM_TXN_CODE
                FROM CRR_OFL_JNL_ENTRY_TYPE_MAPPING
               WHERE     COM_JNL_TYPE_id = in_jnl_type_id
                     AND COM_ENTRY_TYPE_ID = in_entry_type_id
                     AND COM_GROUP_ID = in_group_id)
       WHERE ROWNUM = 1;

      IF txn_type in ('TXN_AMT')
      THEN		
        FOR RESULT
          IN (SELECT *
              FROM   TABLE (GET_OFL_PSP_MULTI (in_jnl_type_id,
                                               in_entry_type_id,
                                               in_group_id,
                                               in_fr_txn_date,
                                               in_to_txn_date)
		           )
             )
             LOOP
               PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                  	                   RESULT.CR_COUNTRY_ID,
	                                   RESULT.CR_PRODUCT_CODE,
	                                   RESULT.CR_JNL_TYPE_ID,
	                                   RESULT.CR_JNL_ENTRY_TYPE_ID,
	                                   RESULT.CR_PARTY_TYPE,
        	                           RESULT.CR_PARTY_ID,
        	                           RESULT.CR_CURRENCY_ID,
        	                           RESULT.GL_ID,
        	                           RESULT.CR_IND,
        	                           RESULT.TXN_AMT,
        	                           RESULT.TXN_COUNT,
        	                           RESULT.TXN_ID));
             END LOOP;
       RETURN;
     ELSIF txn_type = 'FEE'
     THEN
       FOR RESULT
          IN (SELECT *
              FROM   TABLE (GET_OFL_MERCH_MULTI (in_jnl_type_id,
                                                 in_entry_type_id,
                                                 in_group_id,
                                                 in_fr_txn_date,
                                                 in_to_txn_date,
						 'FEE')
                           )
             )
             LOOP
               PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                           RESULT.CR_COUNTRY_ID,
                                           RESULT.CR_PRODUCT_CODE,
                                           RESULT.CR_JNL_TYPE_ID,
                                           RESULT.CR_JNL_ENTRY_TYPE_ID,
                                           RESULT.CR_PARTY_TYPE,
                                           RESULT.CR_PARTY_ID,
                                           RESULT.CR_CURRENCY_ID,
                                           RESULT.GL_ID,
                                           RESULT.CR_IND,
                                           RESULT.TXN_AMT,
                                           RESULT.TXN_COUNT,
                                           RESULT.TXN_ID));
             END LOOP;
       RETURN;
     ELSIF txn_type = 'G_TXN_AMT'
     THEN
       FOR RESULT
          IN (SELECT *
              FROM   TABLE (GET_OFL_PSP_GLOBAL (in_jnl_type_id,
                                                in_entry_type_id,
                                                in_group_id,
                                                in_fr_txn_date,
                                                in_to_txn_date)
                           )
             )
             LOOP
               PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                           RESULT.CR_COUNTRY_ID,
                                           RESULT.CR_PRODUCT_CODE,
                                           RESULT.CR_JNL_TYPE_ID,
                                           RESULT.CR_JNL_ENTRY_TYPE_ID,
                                           RESULT.CR_PARTY_TYPE,
                                           RESULT.CR_PARTY_ID,
                                           RESULT.CR_CURRENCY_ID,
                                           RESULT.GL_ID,
                                           RESULT.CR_IND,
                                           RESULT.TXN_AMT,
                                           RESULT.TXN_COUNT,
                                           RESULT.TXN_ID));
             END LOOP;
       RETURN;
     ELSIF txn_type = 'G_TXN_AMT_BAID'
     THEN
       FOR RESULT
          IN (SELECT *
              FROM   TABLE (GET_OFL_PSP_BAID_GLOBAL (in_jnl_type_id,
                                                     in_entry_type_id,
                                                     in_group_id,
                                                     in_fr_txn_date,
                                                     in_to_txn_date)
                           )
             )
             LOOP
               PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                           RESULT.CR_COUNTRY_ID,
                                           RESULT.CR_PRODUCT_CODE,
                                           RESULT.CR_JNL_TYPE_ID,
                                           RESULT.CR_JNL_ENTRY_TYPE_ID,
                                           RESULT.CR_PARTY_TYPE,
                                           RESULT.CR_PARTY_ID,
                                           RESULT.CR_CURRENCY_ID,
                                           RESULT.GL_ID,
                                           RESULT.CR_IND,
                                           RESULT.TXN_AMT,
                                           RESULT.TXN_COUNT,
                                           RESULT.TXN_ID));
             END LOOP;
       RETURN;
     ELSIF txn_type = 'M_TXN_AMT'
     THEN
       FOR RESULT
          IN (SELECT *
              FROM   TABLE (GET_OFL_MERCH_MULTI (in_jnl_type_id,
                                                 in_entry_type_id,
                                                 in_group_id,
                                                 in_fr_txn_date,
                                                 in_to_txn_date,
						 'TXN')
                           )
             )
             LOOP
               PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                           RESULT.CR_COUNTRY_ID,
                                           RESULT.CR_PRODUCT_CODE,
                                           RESULT.CR_JNL_TYPE_ID,
                                           RESULT.CR_JNL_ENTRY_TYPE_ID,
                                           RESULT.CR_PARTY_TYPE,
                                           RESULT.CR_PARTY_ID,
                                           RESULT.CR_CURRENCY_ID,
                                           RESULT.GL_ID,
                                           RESULT.CR_IND,
                                           RESULT.TXN_AMT,
                                           RESULT.TXN_COUNT,
                                           RESULT.TXN_ID));
             END LOOP;
       RETURN;
     ELSIF txn_type = 'G_M_TXN_AMT'
     THEN
       FOR RESULT
          IN (SELECT *
              FROM   TABLE (GET_OFL_MERCH_TXN_AMT_GLOBAL (in_jnl_type_id,
                                                          in_entry_type_id,
                                                          in_group_id,
                                                          in_fr_txn_date,
                                                          in_to_txn_date)
                           )
             )
             LOOP
               PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                           RESULT.CR_COUNTRY_ID,
                                           RESULT.CR_PRODUCT_CODE,
                                           RESULT.CR_JNL_TYPE_ID,
                                           RESULT.CR_JNL_ENTRY_TYPE_ID,
                                           RESULT.CR_PARTY_TYPE,
                                           RESULT.CR_PARTY_ID,
                                           RESULT.CR_CURRENCY_ID,
                                           RESULT.GL_ID,
                                           RESULT.CR_IND,
                                           RESULT.TXN_AMT,
                                           RESULT.TXN_COUNT,
                                           RESULT.TXN_ID));
             END LOOP;
       RETURN;
     ELSIF txn_type = 'G_FEE'
     THEN
       FOR RESULT
          IN (SELECT *
              FROM   TABLE (GET_OFL_MERCH_FEE_GLOBAL (in_jnl_type_id,
                                                      in_entry_type_id,
                                                      in_group_id,
                                                      in_fr_txn_date,
                                                      in_to_txn_date)
                           )
             )
             LOOP
               PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                           RESULT.CR_COUNTRY_ID,
                                           RESULT.CR_PRODUCT_CODE,
                                           RESULT.CR_JNL_TYPE_ID,
                                           RESULT.CR_JNL_ENTRY_TYPE_ID,
                                           RESULT.CR_PARTY_TYPE,
                                           RESULT.CR_PARTY_ID,
                                           RESULT.CR_CURRENCY_ID,
                                           RESULT.GL_ID,
                                           RESULT.CR_IND,
                                           RESULT.TXN_AMT,
                                           RESULT.TXN_COUNT,
                                           RESULT.TXN_ID));
             END LOOP;
       RETURN;
     ELSIF txn_type = 'MARKUP_AMT'
     THEN
       FOR RESULT
          IN (SELECT *
              FROM   TABLE (GET_OFL_PSP_MARKUP_GLOBAL (in_jnl_type_id,
                                                       in_entry_type_id,
                                                       in_group_id,
                                                       in_fr_txn_date,
                                                       in_to_txn_date)
                           )
             )
             LOOP
               PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                           RESULT.CR_COUNTRY_ID,
                                           RESULT.CR_PRODUCT_CODE,
                                           RESULT.CR_JNL_TYPE_ID,
                                           RESULT.CR_JNL_ENTRY_TYPE_ID,
                                           RESULT.CR_PARTY_TYPE,
                                           RESULT.CR_PARTY_ID,
                                           RESULT.CR_CURRENCY_ID,
                                           RESULT.GL_ID,
                                           RESULT.CR_IND,
                                           RESULT.TXN_AMT,
                                           RESULT.TXN_COUNT,
                                           RESULT.TXN_ID));
             END LOOP;
       RETURN;
     ELSIF txn_type = 'DELI_AMT'
     THEN
       FOR RESULT
          IN (SELECT *
              FROM   TABLE (GET_OFL_PSP_DELI_GLOBAL (in_jnl_type_id,
                                                       in_entry_type_id,
                                                       in_group_id,
                                                       in_fr_txn_date,
                                                       in_to_txn_date)
                           )
             )
             LOOP
               PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                           RESULT.CR_COUNTRY_ID,
                                           RESULT.CR_PRODUCT_CODE,
                                           RESULT.CR_JNL_TYPE_ID,
                                           RESULT.CR_JNL_ENTRY_TYPE_ID,
                                           RESULT.CR_PARTY_TYPE,
                                           RESULT.CR_PARTY_ID,
                                           RESULT.CR_CURRENCY_ID,
                                           RESULT.GL_ID,
                                           RESULT.CR_IND,
                                           RESULT.TXN_AMT,
                                           RESULT.TXN_COUNT,
                                           RESULT.TXN_ID));
             END LOOP;
       RETURN;
     END IF;
   END GET_OFL_TABLE;



   FUNCTION GET_MERCH_TXN_AMT_MULTI (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (  SELECT TH_APPROVAL_DATE TXN_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CASE
                         WHEN CR_PARTY_TYPE <> 'G' THEN CR_PARTY_ID
                         ELSE ''
                      END
                         CR_PARTY_ID,
                      TD_TXN_CCY CR_CURRENCY_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN CR_CREDIT_GL_ID
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN CR_DEBIT_GL_ID
                         ELSE 0
                      END
                         GL_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN 'D'
                         ELSE ''
                      END
                         CR_IND,
                      SUM (TH_TRANSACTION_AMOUNT) TXN_AMT,
                      1 TXN_COUNT,
                      TH_TXN_ID TXN_ID
                 FROM (SELECT TH_TXN_ID,
                              TH_TXN_CODE,
                              TH_APPROVAL_DATE,
                              TH_TRANSACTION_AMOUNT,
                              TH_NET_CCY,
                              TH_NET_AMOUNT,
                              TH_MERCHANT_ID,
                              TH_SERVICE_CODE
                         FROM TXN_HEADER
                        WHERE     TH_APPROVAL_DATE >= in_fr_txn_date
                              AND TH_APPROVAL_DATE <= in_to_txn_date
                              AND TH_STATUS IN ('C', 'R')
                              AND TH_AR_IND = 'A'),
                      (SELECT TD_TXN_ID, TD_TXN_COUNTRY, TD_TXN_CCY
                         FROM TXN_DETAIL),
                      (SELECT CR_COUNTRY_ID,
                              CR_PARTY_TYPE,
                              CR_PARTY_ID,
                              CR_JNL_TYPE_ID,
                              CR_JNL_ENTRY_TYPE_ID,
                              CR_TXN_CODE,
                              CR_PRODUCT_CODE,
                              CR_CURRENCY_ID,
                              CR_CREDIT_GL_ID,
                              CR_DEBIT_GL_ID
                         FROM CRR_RULE_POSTING
                        WHERE     CR_JNL_TYPE_ID = in_jnl_type_id
                              AND CR_JNL_ENTRY_TYPE_ID = in_entry_type_id
                              AND CR_DISABLED = 0),
                      (SELECT TXN_CODE,
                              PARTY_TYPE,
                              TXN_ELEMENT_TYPE,
                              SIGN
                         FROM CRR_JNL_ENTRY_TYPE_MAPPING
                        WHERE     JNL_TYPE_ID = in_jnl_type_id
                              AND ENTRY_TYPE_ID = in_entry_type_id
                              AND GROUP_ID = in_group_id
                              AND DISABLED = 0)
                WHERE     TH_TXN_ID = TD_TXN_ID
                      AND TH_TXN_CODE = TXN_CODE
                      AND (CR_COUNTRY_ID = TD_TXN_COUNTRY)
                      AND EXISTS
                             (SELECT *
                                FROM CRR_PRODUCT_CODE_MAP
                               WHERE     TH_MERCHANT_ID = PM_MERCHANT_ID
                                     AND TH_SERVICE_CODE = PM_SERVICE_CODE
                                     AND TD_TXN_COUNTRY = PM_COUNTRY
                                     AND CR_PRODUCT_CODE = PM_PRODUCT_CODE
                                     AND PM_DISABLED = 0)
                      AND (CR_PARTY_ID = TH_MERCHANT_ID OR CR_PARTY_TYPE = 'G')
                      AND (   CR_CURRENCY_ID = TD_TXN_CCY
                           OR CR_CURRENCY_ID = 'ALL')
             GROUP BY TH_APPROVAL_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CR_PARTY_ID,
                      TD_TXN_CCY,
                      CR_CREDIT_GL_ID,
                      CR_DEBIT_GL_ID,
                      TH_TXN_ID)
      LOOP
         PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                     RESULT.CR_COUNTRY_ID,
                                     RESULT.CR_PRODUCT_CODE,
                                     RESULT.CR_JNL_TYPE_ID,
                                     RESULT.CR_JNL_ENTRY_TYPE_ID,
                                     RESULT.CR_PARTY_TYPE,
                                     RESULT.CR_PARTY_ID,
                                     RESULT.CR_CURRENCY_ID,
                                     RESULT.GL_ID,
                                     RESULT.CR_IND,
                                     RESULT.TXN_AMT,
                                     RESULT.TXN_COUNT,
                                     RESULT.TXN_ID));
      END LOOP;

      RETURN;
   END GET_MERCH_TXN_AMT_MULTI;



   FUNCTION GET_MERCH_TXN_ELEMENTS_MULTI (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (  SELECT TH_APPROVAL_DATE TXN_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CASE
                         WHEN CR_PARTY_TYPE <> 'G' THEN CR_PARTY_ID
                         ELSE ''
                      END
                         CR_PARTY_ID,
                      TE_CCY CR_CURRENCY_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN CR_CREDIT_GL_ID
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN CR_DEBIT_GL_ID
                         ELSE 0
                      END
                         GL_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN 'D'
                         ELSE ''
                      END
                         CR_IND,
                      SUM (TE_AMOUNT * SIGN) TXN_AMT,
                      1 TXN_COUNT,
                      TH_TXN_ID TXN_ID
                 FROM (SELECT TH_TXN_ID,
                              TH_TXN_CODE,
                              TH_APPROVAL_DATE,
                              TH_TRANSACTION_AMOUNT,
                              TH_NET_CCY,
                              TH_NET_AMOUNT,
                              TH_MERCHANT_ID,
                              TH_SERVICE_CODE
                         FROM TXN_HEADER
                        WHERE     TH_APPROVAL_DATE >= in_fr_txn_date
                              AND TH_APPROVAL_DATE <= in_to_txn_date
                              AND TH_STATUS IN ('C', 'R')
                              AND TH_AR_IND = 'A'),
                      (SELECT TD_TXN_ID, TD_TXN_COUNTRY, TD_TXN_CCY
                         FROM TXN_DETAIL),
                      (SELECT TE_TXN_ID,
                              TE_PARTY_TYPE,
                              TE_TXN_ELEMENT_TYPE,
                              TE_CCY,
                              TE_AMOUNT
                         FROM TXN_ELEMENTS),
                      (SELECT CR_COUNTRY_ID,
                              CR_PARTY_TYPE,
                              CR_PARTY_ID,
                              CR_JNL_TYPE_ID,
                              CR_JNL_ENTRY_TYPE_ID,
                              CR_TXN_CODE,
                              CR_PRODUCT_CODE,
                              CR_CURRENCY_ID,
                              CR_CREDIT_GL_ID,
                              CR_DEBIT_GL_ID
                         FROM CRR_RULE_POSTING
                        WHERE     CR_JNL_TYPE_ID = in_jnl_type_id
                              AND CR_JNL_ENTRY_TYPE_ID = in_entry_type_id
                              AND CR_DISABLED = 0),
                      (SELECT TXN_CODE,
                              PARTY_TYPE,
                              TXN_ELEMENT_TYPE,
                              SIGN
                         FROM CRR_JNL_ENTRY_TYPE_MAPPING
                        WHERE     JNL_TYPE_ID = in_jnl_type_id
                              AND ENTRY_TYPE_ID = in_entry_type_id
                              AND GROUP_ID = in_group_id
                              AND DISABLED = 0)
                WHERE     TH_TXN_ID = TD_TXN_ID
                      AND TH_TXN_ID = TE_TXN_ID
                      AND TH_TXN_CODE = TXN_CODE
                      AND TE_PARTY_TYPE = PARTY_TYPE
                      AND TE_TXN_ELEMENT_TYPE = TXN_ELEMENT_TYPE
                      AND (CR_COUNTRY_ID = TD_TXN_COUNTRY)
                      AND EXISTS
                             (SELECT *
                                FROM CRR_PRODUCT_CODE_MAP
                               WHERE     TH_MERCHANT_ID = PM_MERCHANT_ID
                                     AND TH_SERVICE_CODE = PM_SERVICE_CODE
                                     AND TD_TXN_COUNTRY = PM_COUNTRY
                                     AND CR_PRODUCT_CODE = PM_PRODUCT_CODE
                                     AND PM_DISABLED = 0)
                      AND (CR_PARTY_ID = TH_MERCHANT_ID OR CR_PARTY_TYPE = 'G')
                      AND (CR_CURRENCY_ID = TE_CCY OR CR_CURRENCY_ID = 'ALL')
             GROUP BY TH_APPROVAL_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CR_PARTY_ID,
                      TE_CCY,
                      CR_CREDIT_GL_ID,
                      CR_DEBIT_GL_ID,
                      TH_TXN_ID)
      LOOP
         PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                     RESULT.CR_COUNTRY_ID,
                                     RESULT.CR_PRODUCT_CODE,
                                     RESULT.CR_JNL_TYPE_ID,
                                     RESULT.CR_JNL_ENTRY_TYPE_ID,
                                     RESULT.CR_PARTY_TYPE,
                                     RESULT.CR_PARTY_ID,
                                     RESULT.CR_CURRENCY_ID,
                                     RESULT.GL_ID,
                                     RESULT.CR_IND,
                                     RESULT.TXN_AMT,
                                     RESULT.TXN_COUNT,
                                     RESULT.TXN_ID));
      END LOOP;

      RETURN;
   END GET_MERCH_TXN_ELEMENTS_MULTI;


   FUNCTION GET_PSP_TXN_ELEMENTS_MULTI (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (  SELECT TH_APPROVAL_DATE TXN_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CASE
                         WHEN CR_PARTY_TYPE <> 'G' THEN CR_PARTY_ID
                         ELSE ''
                      END
                         CR_PARTY_ID,
                      TE_CCY CR_CURRENCY_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN CR_CREDIT_GL_ID
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN CR_DEBIT_GL_ID
                         ELSE 0
                      END
                         GL_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN 'D'
                         ELSE ''
                      END
                         CR_IND,
                      SUM (TE_AMOUNT * SIGN) TXN_AMT,
                      1 TXN_COUNT,
                      TH_TXN_ID TXN_ID
                 FROM (SELECT TH_TXN_ID,
                              TH_TXN_CODE,
                              TH_APPROVAL_DATE,
                              TH_TRANSACTION_AMOUNT,
                              TH_NET_CCY,
                              TH_NET_AMOUNT,
                              TH_MERCHANT_ID,
                              TH_SERVICE_CODE
                         FROM TXN_HEADER
                        WHERE     TH_APPROVAL_DATE >= in_fr_txn_date
                              AND TH_APPROVAL_DATE <= in_to_txn_date
                              AND TH_STATUS IN ('C', 'R')
                              AND TH_AR_IND = 'A'),
                      (SELECT TD_TXN_ID, TD_TXN_COUNTRY, TD_TXN_CCY
                         FROM TXN_DETAIL),
                      (SELECT TP_TXN_ID, TP_PSP_ID FROM TXN_PSP_DETAIL),
                      (SELECT TE_TXN_ID,
                              TE_PARTY_TYPE,
                              TE_TXN_ELEMENT_TYPE,
                              TE_CCY,
                              TE_AMOUNT
                         FROM TXN_ELEMENTS),
                      (SELECT CR_COUNTRY_ID,
                              CR_PARTY_TYPE,
                              CR_PARTY_ID,
                              CR_JNL_TYPE_ID,
                              CR_JNL_ENTRY_TYPE_ID,
                              CR_TXN_CODE,
                              CR_PRODUCT_CODE,
                              CR_CURRENCY_ID,
                              CR_CREDIT_GL_ID,
                              CR_DEBIT_GL_ID
                         FROM CRR_RULE_POSTING
                        WHERE     CR_JNL_TYPE_ID = in_jnl_type_id
                              AND CR_JNL_ENTRY_TYPE_ID = in_entry_type_id
                              AND CR_DISABLED = 0),
                      (SELECT TXN_CODE,
                              PARTY_TYPE,
                              TXN_ELEMENT_TYPE,
                              SIGN
                         FROM CRR_JNL_ENTRY_TYPE_MAPPING
                        WHERE     JNL_TYPE_ID = in_jnl_type_id
                              AND ENTRY_TYPE_ID = in_entry_type_id
                              AND GROUP_ID = in_group_id
                              AND DISABLED = 0)
                WHERE     TH_TXN_ID = TD_TXN_ID
                      AND TH_TXN_ID = TP_TXN_ID
                      AND TH_TXN_ID = TE_TXN_ID
                      AND TH_TXN_CODE = TXN_CODE
                      AND TE_PARTY_TYPE = PARTY_TYPE
                      AND TE_TXN_ELEMENT_TYPE = TXN_ELEMENT_TYPE
                      AND (CR_COUNTRY_ID = TD_TXN_COUNTRY)
                      AND EXISTS
                             (SELECT *
                                FROM PSP_DETAIL, CRR_PSP_PRODUCT_CODE_MAP
                               WHERE     PSP_ID = TP_PSP_ID
                                     AND PSP_ID = PM_PSP_ID
                                     AND PSP_TYPE = PM_BUSINESS_TYPE
                                     AND CR_PRODUCT_CODE = PM_PRODUCT_CODE
                                     AND PM_DISABLED = 0)
                      AND (CR_PARTY_ID = TP_PSP_ID OR CR_PARTY_TYPE = 'G')
                      AND (CR_CURRENCY_ID = TE_CCY OR CR_CURRENCY_ID = 'ALL')
             GROUP BY TH_APPROVAL_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CR_PARTY_ID,
                      TE_CCY,
                      CR_CREDIT_GL_ID,
                      CR_DEBIT_GL_ID,
                      TH_TXN_ID)
      LOOP
         PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                     RESULT.CR_COUNTRY_ID,
                                     RESULT.CR_PRODUCT_CODE,
                                     RESULT.CR_JNL_TYPE_ID,
                                     RESULT.CR_JNL_ENTRY_TYPE_ID,
                                     RESULT.CR_PARTY_TYPE,
                                     RESULT.CR_PARTY_ID,
                                     RESULT.CR_CURRENCY_ID,
                                     RESULT.GL_ID,
                                     RESULT.CR_IND,
                                     RESULT.TXN_AMT,
                                     RESULT.TXN_COUNT,
                                     RESULT.TXN_ID));
      END LOOP;

      RETURN;
   END GET_PSP_TXN_ELEMENTS_MULTI;



   FUNCTION GET_MERCH_TXN_ELEMENTS_SINGLE (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (  SELECT TH_APPROVAL_DATE TXN_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CASE
                         WHEN CR_PARTY_TYPE <> 'G' THEN CR_PARTY_ID
                         ELSE ''
                      END
                         CR_PARTY_ID,
                      TE_CCY CR_CURRENCY_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN CR_CREDIT_GL_ID
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN CR_DEBIT_GL_ID
                         ELSE 0
                      END
                         GL_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN 'D'
                         ELSE ''
                      END
                         CR_IND,
                      SUM (TE_AMOUNT * SIGN) TXN_AMT,
                      COUNT (DISTINCT TH_TXN_ID) TXN_COUNT,
                      '' TXN_ID
                 FROM (SELECT TH_TXN_ID,
                              TH_TXN_CODE,
                              TH_APPROVAL_DATE,
                              TH_TRANSACTION_AMOUNT,
                              TH_NET_CCY,
                              TH_NET_AMOUNT,
                              TH_MERCHANT_ID,
                              TH_SERVICE_CODE
                         FROM TXN_HEADER
                        WHERE     TH_APPROVAL_DATE >= in_fr_txn_date
                              AND TH_APPROVAL_DATE <= in_to_txn_date
                              AND TH_STATUS IN ('C', 'R')
                              AND TH_AR_IND = 'A'),
                      (SELECT TD_TXN_ID, TD_TXN_COUNTRY, TD_TXN_CCY
                         FROM TXN_DETAIL),
                      (SELECT TE_TXN_ID,
                              TE_PARTY_TYPE,
                              TE_TXN_ELEMENT_TYPE,
                              TE_CCY,
                              TE_AMOUNT
                         FROM TXN_ELEMENTS),
                      (SELECT CR_COUNTRY_ID,
                              CR_PARTY_TYPE,
                              CR_PARTY_ID,
                              CR_JNL_TYPE_ID,
                              CR_JNL_ENTRY_TYPE_ID,
                              CR_TXN_CODE,
                              CR_PRODUCT_CODE,
                              CR_CURRENCY_ID,
                              CR_CREDIT_GL_ID,
                              CR_DEBIT_GL_ID
                         FROM CRR_RULE_POSTING
                        WHERE     CR_JNL_TYPE_ID = in_jnl_type_id
                              AND CR_JNL_ENTRY_TYPE_ID = in_entry_type_id
                              AND CR_DISABLED = 0),
                      (SELECT TXN_CODE,
                              PARTY_TYPE,
                              TXN_ELEMENT_TYPE,
                              SIGN
                         FROM CRR_JNL_ENTRY_TYPE_MAPPING
                        WHERE     JNL_TYPE_ID = in_jnl_type_id
                              AND ENTRY_TYPE_ID = in_entry_type_id
                              AND GROUP_ID = in_group_id
                              AND DISABLED = 0)
                WHERE     TH_TXN_ID = TD_TXN_ID
                      AND TH_TXN_ID = TE_TXN_ID
                      AND TH_TXN_CODE = TXN_CODE
                      AND TE_PARTY_TYPE = PARTY_TYPE
                      AND TE_TXN_ELEMENT_TYPE = TXN_ELEMENT_TYPE
                      AND (CR_COUNTRY_ID = TD_TXN_COUNTRY)
                      AND EXISTS
                             (SELECT *
                                FROM CRR_PRODUCT_CODE_MAP
                               WHERE     TH_MERCHANT_ID = PM_MERCHANT_ID
                                     AND TH_SERVICE_CODE = PM_SERVICE_CODE
                                     AND TD_TXN_COUNTRY = PM_COUNTRY
                                     AND CR_PRODUCT_CODE = PM_PRODUCT_CODE
                                     AND PM_DISABLED = 0)
                      AND (CR_PARTY_ID = TH_MERCHANT_ID OR CR_PARTY_TYPE = 'G')
                      AND (CR_CURRENCY_ID = TE_CCY OR CR_CURRENCY_ID = 'ALL')
             GROUP BY TH_APPROVAL_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CR_PARTY_ID,
                      TE_CCY,
                      CR_CREDIT_GL_ID,
                      CR_DEBIT_GL_ID)
      LOOP
         PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                     RESULT.CR_COUNTRY_ID,
                                     RESULT.CR_PRODUCT_CODE,
                                     RESULT.CR_JNL_TYPE_ID,
                                     RESULT.CR_JNL_ENTRY_TYPE_ID,
                                     RESULT.CR_PARTY_TYPE,
                                     RESULT.CR_PARTY_ID,
                                     RESULT.CR_CURRENCY_ID,
                                     RESULT.GL_ID,
                                     RESULT.CR_IND,
                                     RESULT.TXN_AMT,
                                     RESULT.TXN_COUNT,
                                     RESULT.TXN_ID));
      END LOOP;

      RETURN;
   END GET_MERCH_TXN_ELEMENTS_SINGLE;


   FUNCTION GET_PSP_TXN_ELEMENTS_SINGLE (
      in_jnl_type_id      crr_jnl_entry_type_mapping.jnl_type_id%TYPE,
      in_entry_type_id    crr_jnl_entry_type_mapping.entry_type_id%TYPE,
      in_group_id         crr_jnl_entry_type_mapping.group_id%TYPE,
      in_fr_txn_date      txn_header.th_approval_date%TYPE,
      in_to_txn_date      txn_header.th_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (  SELECT TH_APPROVAL_DATE TXN_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CASE
                         WHEN CR_PARTY_TYPE <> 'G' THEN CR_PARTY_ID
                         ELSE ''
                      END
                         CR_PARTY_ID,
                      TE_CCY CR_CURRENCY_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN CR_CREDIT_GL_ID
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN CR_DEBIT_GL_ID
                         ELSE 0
                      END
                         GL_ID,
                      CASE
                         WHEN CR_CREDIT_GL_ID <> 0 THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL THEN 'D'
                         ELSE ''
                      END
                         CR_IND,
                      SUM (TE_AMOUNT * SIGN) TXN_AMT,
                      COUNT (DISTINCT TH_TXN_ID) TXN_COUNT,
                      '' TXN_ID
                 FROM (SELECT TH_TXN_ID,
                              TH_TXN_CODE,
                              TH_APPROVAL_DATE,
                              TH_TRANSACTION_AMOUNT,
                              TH_NET_CCY,
                              TH_NET_AMOUNT,
                              TH_MERCHANT_ID,
                              TH_SERVICE_CODE
                         FROM TXN_HEADER
                        WHERE     TH_APPROVAL_DATE >= in_fr_txn_date
                              AND TH_APPROVAL_DATE <= in_to_txn_date
                              AND TH_STATUS IN ('C', 'R')
                              AND TH_AR_IND = 'A'),
                      (SELECT TD_TXN_ID, TD_TXN_COUNTRY, TD_TXN_CCY
                         FROM TXN_DETAIL),
                      (SELECT TP_TXN_ID, TP_PSP_ID FROM TXN_PSP_DETAIL),
                      (SELECT TE_TXN_ID,
                              TE_PARTY_TYPE,
                              TE_TXN_ELEMENT_TYPE,
                              TE_CCY,
                              TE_AMOUNT
                         FROM TXN_ELEMENTS),
                      (SELECT CR_COUNTRY_ID,
                              CR_PARTY_TYPE,
                              CR_PARTY_ID,
                              CR_JNL_TYPE_ID,
                              CR_JNL_ENTRY_TYPE_ID,
                              CR_TXN_CODE,
                              CR_PRODUCT_CODE,
                              CR_CURRENCY_ID,
                              CR_CREDIT_GL_ID,
                              CR_DEBIT_GL_ID
                         FROM CRR_RULE_POSTING
                        WHERE     CR_JNL_TYPE_ID = in_jnl_type_id
                              AND CR_JNL_ENTRY_TYPE_ID = in_entry_type_id
                              AND CR_DISABLED = 0),
                      (SELECT TXN_CODE,
                              PARTY_TYPE,
                              TXN_ELEMENT_TYPE,
                              SIGN
                         FROM CRR_JNL_ENTRY_TYPE_MAPPING
                        WHERE     JNL_TYPE_ID = in_jnl_type_id
                              AND ENTRY_TYPE_ID = in_entry_type_id
                              AND GROUP_ID = in_group_id
                              AND DISABLED = 0)
                WHERE     TH_TXN_ID = TD_TXN_ID
                      AND TH_TXN_ID = TP_TXN_ID
                      AND TH_TXN_ID = TE_TXN_ID
                      AND TH_TXN_CODE = TXN_CODE
                      AND TE_PARTY_TYPE = PARTY_TYPE
                      AND TE_TXN_ELEMENT_TYPE = TXN_ELEMENT_TYPE
                      AND (CR_COUNTRY_ID = TD_TXN_COUNTRY)
                      AND EXISTS
                             (SELECT *
                                FROM PSP_DETAIL, CRR_PSP_PRODUCT_CODE_MAP
                               WHERE     PSP_ID = TP_PSP_ID
                                     AND PSP_ID = PM_PSP_ID
                                     AND PSP_TYPE = PM_BUSINESS_TYPE
                                     AND CR_PRODUCT_CODE = PM_PRODUCT_CODE
                                     AND PM_DISABLED = 0)
                      AND (CR_PARTY_ID = TP_PSP_ID OR CR_PARTY_TYPE = 'G')
                      AND (CR_CURRENCY_ID = TE_CCY OR CR_CURRENCY_ID = 'ALL')
             GROUP BY TH_APPROVAL_DATE,
                      CR_COUNTRY_ID,
                      CR_PRODUCT_CODE,
                      CR_JNL_TYPE_ID,
                      CR_JNL_ENTRY_TYPE_ID,
                      CR_PARTY_TYPE,
                      CR_PARTY_ID,
                      TE_CCY,
                      CR_CREDIT_GL_ID,
                      CR_DEBIT_GL_ID)
      LOOP
         PIPE ROW (CRR_JNL_DATA_REC (RESULT.TXN_DATE,
                                     RESULT.CR_COUNTRY_ID,
                                     RESULT.CR_PRODUCT_CODE,
                                     RESULT.CR_JNL_TYPE_ID,
                                     RESULT.CR_JNL_ENTRY_TYPE_ID,
                                     RESULT.CR_PARTY_TYPE,
                                     RESULT.CR_PARTY_ID,
                                     RESULT.CR_CURRENCY_ID,
                                     RESULT.GL_ID,
                                     RESULT.CR_IND,
                                     RESULT.TXN_AMT,
                                     RESULT.TXN_COUNT,
                                     RESULT.TXN_ID));
      END LOOP;

      RETURN;
   END GET_PSP_TXN_ELEMENTS_SINGLE;

   FUNCTION GET_OFL_PSP_MULTI (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%TYPE,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%TYPE,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%TYPE,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (SELECT COTH_APPROVAL_DATE,
                    CR_COUNTRY_ID,
                    OPPM_PRODUCT_CODE CR_PRODUCT_CODE,
                    CR_JNL_TYPE_ID,
                    CR_JNL_ENTRY_TYPE_ID,
                    CR_PARTY_TYPE,
                    CASE WHEN   CR_PARTY_TYPE <> 'G' 
                           THEN CR_PARTY_ID 
                           ELSE ''
                         END CR_PARTY_ID,
                    CASE WHEN   CR_CREDIT_GL_ID <> 0
                           THEN CR_CREDIT_GL_ID
                         WHEN   CR_DEBIT_GL_ID IS NOT NULL
                           THEN CR_DEBIT_GL_ID
                           ELSE 0
                         END GL_ID,
                    CASE WHEN   CR_CREDIT_GL_ID <> 0
                           THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL
                           THEN 'D'
                           ELSE ''
                         END CR_IND,
                    COTH_CCY CR_CURRENCY_ID,
                    NVL (COTH_TXN_AMT, 0) TXN_AMT,
                    COTH_FEE_CCY FEE_CCY,
                    NVL (COTH_FEE, 0) FEE_AMT,
                    COTH_NET_CCY NET_CCY,
                    COTH_NET_AMT NET_AMT,
                    COTH_MARKUP_CCY,
                    NVL (COTH_MARKUP_AMT, 0) MARKUP_AMT,
                    COTP_PSP_CCY PSP_CCY,
                    NVL (COTP_PSP_AMT, 0) PSP_AMT,
                    1 TXN_COUNT,
                    COTH_TXN_ID TXN_ID
             FROM   (SELECT B.cr_jnl_type_id,
                            B.cr_jnl_entry_type_id,
                            A.com_group_id,
                            A.com_txn_side,
                            A.com_is_single,
                            A.com_txn_code,
                            A.com_baid_category,
                            B.cr_party_type,
                            B.cr_product_code,
                            B.cr_credit_gl_id,
                            B.cr_debit_gl_id,
                            B.cr_country_id,
                            B.cr_party_id,
                            B.cr_currency_id
                     FROM   crr_ofl_jnl_entry_type_mapping A,
                            crr_rule_posting B
                     WHERE  A.com_entry_type_id = b.cr_jnl_entry_type_id
                       AND  A.com_jnl_type_id = b.cr_jnl_type_id
                       AND  A.com_disabled = 0
                       AND  B.cr_disabled = 0
                       AND  A.com_group_id = in_group_id
                       and  A.com_jnl_type_id = in_jnl_type_id
                       and  A.com_entry_type_id = in_entry_type_id) L,
                    (SELECT coth_txn_id,
                            coth_txn_code,
                            cotp_client_id,
                            cotp_psp_id,
                            cotp_baid,
                            cotp_baid_category,
                            coth_ccy,
                            coth_txn_amt,
                            coth_fee,
                            nvl(coth_fee_ccy,coth_net_ccy) coth_fee_ccy,
                            coth_net_amt,
                            coth_net_ccy,
                            coth_markup_amt,
                            coth_markup_ccy,
                            coth_approval_date,
                            cotp_psp_ccy,
                            cotp_psp_amt,
                            oppm_product_code
                     FROM   crr_ofl_txn_data_header,
                            crr_ofl_txn_data_psp_detail,
                            (SELECT oppm_psp_id,
                                    oppm_product_code,
                                    MAX (oppm_effective_date)
                             FROM   crr_ofl_psp_product_code_map
                             GROUP BY oppm_psp_id, 
                                      oppm_product_code) C
                     WHERE  coth_approval_date = in_fr_txn_date
                       AND  coth_txn_id = cotp_txn_id
                       AND  cotp_psp_id = oppm_psp_id) R
             WHERE  L.com_txn_code = coth_txn_code
               AND  L.cr_party_id = DECODE (L.cr_PARTY_TYPE,  'B', cotp_baid,  'P', cotp_psp_id)
               AND  L.cr_product_code = R.oppm_product_code
               AND  DECODE(L.CR_PARTY_TYPE,  'B', L.com_baid_category, 
                                             'P', DECODE(L.com_baid_category, 'ALL', NVL(R.cotp_baid_category,'~'),
                                                                                     L.com_baid_category), 
                                             NVL(R.cotp_baid_category,'~')) = NVL(R.cotp_baid_category,'~')
         )
         LOOP
           PIPE ROW (CRR_JNL_DATA_REC (RESULT.COTH_APPROVAL_DATE,
                                       RESULT.CR_COUNTRY_ID,
                                       RESULT.CR_PRODUCT_CODE,
                                       RESULT.CR_JNL_TYPE_ID,
                                       RESULT.CR_JNL_ENTRY_TYPE_ID,
                                       RESULT.CR_PARTY_TYPE,
                                       RESULT.CR_PARTY_ID,
                                       RESULT.CR_CURRENCY_ID,
                                       RESULT.GL_ID,
                                       RESULT.CR_IND,
                                       RESULT.TXN_AMT,
                                       RESULT.TXN_COUNT,
                                       RESULT.TXN_ID));
         END LOOP;
      RETURN;
   END GET_OFL_PSP_MULTI;

   FUNCTION GET_OFL_MERCH_MULTI (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%TYPE,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%TYPE,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%TYPE,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE,
      in_amt_type         varchar)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (SELECT COTH_APPROVAL_DATE,
                    CR_COUNTRY_ID,
                    OMPM_PRODUCT_CODE CR_PRODUCT_CODE,
                    CR_JNL_TYPE_ID,
                    CR_JNL_ENTRY_TYPE_ID,
                    CR_PARTY_TYPE,
                    CASE WHEN CR_PARTY_TYPE <> 'G'
                           THEN CR_PARTY_ID
                           ELSE '' 
                         END CR_PARTY_ID,
                    CASE WHEN CR_CREDIT_GL_ID <> 0 
                           THEN CR_CREDIT_GL_ID
                         WHEN CR_DEBIT_GL_ID IS NOT NULL
                           THEN CR_DEBIT_GL_ID
                           ELSE 0
                         END GL_ID,
                    CASE WHEN CR_CREDIT_GL_ID <> 0 
                           THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL 
                           THEN 'D'
                           ELSE ''
                           END CR_IND,
                    COTH_CCY CR_CURRENCY_ID,
                    NVL (COTh_TXN_AMT, 0) TXN_AMT,
                    COTH_FEE_CCY FEE_CCY,
                    NVL (COTH_FEE, 0) FEE_AMT,
                    COTH_NET_CCY NET_CCY,
                    COTH_NET_AMT NET_AMT,
                    COTH_MARKUP_CCY,
                    NVL (COTH_MARKUP_AMT, 0) MARKUP_AMT,
                    1 TXN_COUNT,
                    COTH_TXN_ID TXN_ID
             FROM   (SELECT B.cr_jnl_type_id,
                            B.CR_jnl_entry_type_id,
                            A.com_group_id,
                            A.com_txn_side,
                            A.com_is_single,
                            A.com_txn_code,
                            B.cr_party_type,
                            B.cr_product_code,
                            B.cr_credit_gl_id,
                            B.cr_debit_gl_id,
                            B.cr_country_id,
                            B.cr_party_id,
                            B.cr_currency_id
                     FROM   crr_ofl_jnl_entry_type_mapping A,
                            crr_rule_posting B
                     WHERE  A.com_entry_type_id = B.cr_jnl_entry_type_id
                       AND  A.com_jnl_type_id = B.cr_jnl_type_id
                       AND  A.com_disabled = 0
                       AND  B.cr_disabled = 0
                       AND  A.com_group_id = in_group_id
                       and  A.com_jnl_type_id = in_jnl_type_id
                       and  A.com_entry_type_id = in_entry_type_id) L,
                    (SELECT coth_txn_id,
                            coth_txn_code,
                            coth_ccy,
                            coth_txn_amt,
                            coth_fee,
                            nvl(coth_fee_ccy,coth_net_ccy) coth_fee_ccy,
                            coth_net_amt,
                            coth_net_ccy,
                            coth_markup_amt,
                            coth_markup_ccy,
                            coth_approval_date,
                            cotd_merchant_id,
                            ompm_product_code 
                     FROM   crr_ofl_txn_data_header,
                            crr_ofl_txn_data_detail,
                            (SELECT ompm_merch_id,
                                    ompm_product_code,
                                    MAX (ompm_effective_date)
                             FROM   crr_ofl_merch_product_code_map
                             GROUP BY ompm_merch_id, 
                                      ompm_product_code) C
                     WHERE  coth_approval_date = in_fr_txn_date
                       AND  coth_txn_id = cotd_txn_id
                       AND  cotd_merchant_id = ompm_merch_id) R
             WHERE  L.com_txn_code = coth_txn_code
               AND  L.cr_product_code = R.ompm_product_code
               AND  L.cr_party_id = R.cotd_merchant_id
             order by coth_txn_id
         )
         LOOP
           IF (in_amt_type = 'TXN')
           THEN
               PIPE ROW (CRR_JNL_DATA_REC (RESULT.COTH_APPROVAL_DATE,
                                           RESULT.CR_COUNTRY_ID,
                                           RESULT.CR_PRODUCT_CODE,
                                           RESULT.CR_JNL_TYPE_ID,
                                           RESULT.CR_JNL_ENTRY_TYPE_ID,
                                           RESULT.CR_PARTY_TYPE,
                                           RESULT.CR_PARTY_ID,
                                           RESULT.CR_CURRENCY_ID,
                                           RESULT.GL_ID,
                                           RESULT.CR_IND,
                                           RESULT.TXN_AMT,
                                           RESULT.TXN_COUNT,
                                           RESULT.TXN_ID));
           ELSIF (in_amt_type = 'FEE')
           THEN
               PIPE ROW (CRR_JNL_DATA_REC (RESULT.COTH_APPROVAL_DATE,
                                           RESULT.CR_COUNTRY_ID,
                                           RESULT.CR_PRODUCT_CODE,
                                           RESULT.CR_JNL_TYPE_ID,
                                           RESULT.CR_JNL_ENTRY_TYPE_ID,
                                           RESULT.CR_PARTY_TYPE,
                                           RESULT.CR_PARTY_ID,
                                           RESULT.CR_CURRENCY_ID,
                                           RESULT.GL_ID,
                                           RESULT.CR_IND,
                                           RESULT.FEE_AMT,
                                           RESULT.TXN_COUNT,
                                           RESULT.TXN_ID));
           END IF;
         END LOOP;
      RETURN;
   END GET_OFL_MERCH_MULTI;

   FUNCTION GET_OFL_PSP_GLOBAL (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%TYPE,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%TYPE,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%TYPE,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (SELECT COTH_APPROVAL_DATE,
                    CR_COUNTRY_ID,
                    OPPM_PRODUCT_CODE CR_PRODUCT_CODE,
                    CR_JNL_TYPE_ID,
                    CR_JNL_ENTRY_TYPE_ID,
                    CR_PARTY_TYPE,
                    CASE WHEN   CR_PARTY_TYPE <> 'G' 
                           THEN CR_PARTY_ID 
                           ELSE ''
                         END CR_PARTY_ID,
                    CASE WHEN   CR_CREDIT_GL_ID <> 0
                           THEN CR_CREDIT_GL_ID
                         WHEN   CR_DEBIT_GL_ID IS NOT NULL
                           THEN CR_DEBIT_GL_ID
                           ELSE 0
                         END GL_ID,
                    CASE WHEN   CR_CREDIT_GL_ID <> 0
                           THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL
                           THEN 'D'
                           ELSE ''
                         END CR_IND,
                    COTH_CCY CR_CURRENCY_ID,
                    SUM(NVL (COTH_TXN_AMT, 0)) TXN_AMT,
                    COUNT(COTH_TXN_ID) TXN_COUNT,
                    '' TXN_ID
             FROM   (SELECT B.cr_jnl_type_id,
                            B.cr_jnl_entry_type_id,
                            A.com_group_id,
                            A.com_txn_side,
                            A.com_is_single,
                            A.com_txn_code,
                            A.com_baid_category,
                            B.cr_party_type,
                            B.cr_product_code,
                            B.cr_credit_gl_id,
                            B.cr_debit_gl_id,
                            B.cr_country_id,
                            B.cr_party_id,
                            B.cr_currency_id
                     FROM   crr_ofl_jnl_entry_type_mapping A,
                            crr_rule_posting B
                     WHERE  A.com_entry_type_id = b.cr_jnl_entry_type_id
                       AND  A.com_jnl_type_id = b.cr_jnl_type_id
                       AND  A.com_disabled = 0
                       AND  B.cr_disabled = 0
                       AND  A.com_group_id = in_group_id
                       and  A.com_jnl_type_id = in_jnl_type_id
                       and  A.com_entry_type_id = in_entry_type_id) L,
                    (SELECT coth_txn_id,
                            coth_txn_code,
                            cotp_client_id,
                            cotp_psp_id,
                            cotp_baid,
                            cotp_baid_category,
                            coth_ccy,
                            coth_txn_amt,
                            coth_fee,
                            nvl(coth_fee_ccy,coth_net_ccy) coth_fee_ccy,
                            coth_net_amt,
                            coth_net_ccy,
                            coth_markup_amt,
                            coth_markup_ccy,
                            coth_approval_date,
                            cotp_psp_ccy,
                            cotp_psp_amt,
                            oppm_product_code
                     FROM   crr_ofl_txn_data_header,
                            crr_ofl_txn_data_psp_detail,
                            (SELECT oppm_psp_id,
                                    oppm_product_code,
                                    MAX (oppm_effective_date)
                             FROM   crr_ofl_psp_product_code_map
                             GROUP BY oppm_psp_id, 
                                      oppm_product_code) C
                     WHERE  coth_approval_date = in_fr_txn_date
                       AND  coth_txn_id = cotp_txn_id
                       AND  cotp_psp_id = oppm_psp_id) R
             WHERE  L.com_txn_code = coth_txn_code
               AND  L.cr_product_code = R.oppm_product_code
             GROUP BY
                    COTH_APPROVAL_DATE,
                    CR_COUNTRY_ID,
                    OPPM_PRODUCT_CODE,
                    CR_JNL_TYPE_ID,
                    CR_JNL_ENTRY_TYPE_ID,
                    CR_PARTY_TYPE,
                    CR_PARTY_ID,
                    COTH_CCY,
                    CR_CREDIT_GL_ID,
                    CR_DEBIT_GL_ID
         )
         LOOP
           PIPE ROW (CRR_JNL_DATA_REC (RESULT.COTH_APPROVAL_DATE,
                                       RESULT.CR_COUNTRY_ID,
                                       RESULT.CR_PRODUCT_CODE,
                                       RESULT.CR_JNL_TYPE_ID,
                                       RESULT.CR_JNL_ENTRY_TYPE_ID,
                                       RESULT.CR_PARTY_TYPE,
                                       RESULT.CR_PARTY_ID,
                                       RESULT.CR_CURRENCY_ID,
                                       RESULT.GL_ID,
                                       RESULT.CR_IND,
                                       RESULT.TXN_AMT,
                                       RESULT.TXN_COUNT,
                                       RESULT.TXN_ID));
         END LOOP;
      RETURN;
   END GET_OFL_PSP_GLOBAL;

   FUNCTION GET_OFL_PSP_BAID_GLOBAL (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%TYPE,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%TYPE,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%TYPE,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (SELECT COTH_APPROVAL_DATE,
                    CR_COUNTRY_ID,
                    OPPM_PRODUCT_CODE CR_PRODUCT_CODE,
                    CR_JNL_TYPE_ID,
                    CR_JNL_ENTRY_TYPE_ID,
                    CR_PARTY_TYPE,
                    CASE WHEN   CR_PARTY_TYPE <> 'G' 
                           THEN CR_PARTY_ID 
                           ELSE ''
                         END CR_PARTY_ID,
                    CASE WHEN   CR_CREDIT_GL_ID <> 0
                           THEN CR_CREDIT_GL_ID
                         WHEN   CR_DEBIT_GL_ID IS NOT NULL
                           THEN CR_DEBIT_GL_ID
                           ELSE 0
                         END GL_ID,
                    CASE WHEN   CR_CREDIT_GL_ID <> 0
                           THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL
                           THEN 'D'
                           ELSE ''
                         END CR_IND,
                    COTH_CCY CR_CURRENCY_ID,
                    SUM(NVL (COTH_TXN_AMT, 0)) TXN_AMT,
                    COUNT(COTH_TXN_ID) TXN_COUNT,
                    '' TXN_ID
             FROM   (SELECT B.cr_jnl_type_id,
                            B.cr_jnl_entry_type_id,
                            A.com_group_id,
                            A.com_txn_side,
                            A.com_is_single,
                            A.com_txn_code,
                            A.com_baid_category,
                            B.cr_party_type,
                            B.cr_product_code,
                            B.cr_credit_gl_id,
                            B.cr_debit_gl_id,
                            B.cr_country_id,
                            B.cr_party_id,
                            B.cr_currency_id
                     FROM   crr_ofl_jnl_entry_type_mapping A,
                            crr_rule_posting B
                     WHERE  A.com_entry_type_id = b.cr_jnl_entry_type_id
                       AND  A.com_jnl_type_id = b.cr_jnl_type_id
                       AND  A.com_disabled = 0
                       AND  B.cr_disabled = 0
                       AND  A.com_group_id = in_group_id
                       and  A.com_jnl_type_id = in_jnl_type_id
                       and  A.com_entry_type_id = in_entry_type_id) L,
                    (SELECT coth_txn_id,
                            coth_txn_code,
                            cotp_client_id,
                            cotp_psp_id,
                            cotp_baid,
                            cotp_baid_category,
                            coth_ccy,
                            coth_txn_amt,
                            coth_fee,
                            nvl(coth_fee_ccy,coth_net_ccy) coth_fee_ccy,
                            coth_net_amt,
                            coth_net_ccy,
                            coth_markup_amt,
                            coth_markup_ccy,
                            coth_approval_date,
                            cotp_psp_ccy,
                            cotp_psp_amt,
                            oppm_product_code
                     FROM   crr_ofl_txn_data_header,
                            crr_ofl_txn_data_psp_detail,
                            (SELECT oppm_psp_id,
                                    oppm_product_code,
                                    MAX (oppm_effective_date)
                             FROM   crr_ofl_psp_product_code_map
                             GROUP BY oppm_psp_id, 
                                      oppm_product_code) C
                     WHERE  coth_approval_date = in_fr_txn_date
                       AND  coth_txn_id = cotp_txn_id
                       AND  cotp_psp_id = oppm_psp_id) R
             WHERE  L.com_txn_code = coth_txn_code
               AND  L.cr_product_code = R.oppm_product_code
               AND  L.com_baid_category = R.cotp_baid_category
             GROUP BY
                    COTH_APPROVAL_DATE,
                    CR_COUNTRY_ID,
                    OPPM_PRODUCT_CODE,
                    CR_JNL_TYPE_ID,
                    CR_JNL_ENTRY_TYPE_ID,
                    CR_PARTY_TYPE,
                    CR_PARTY_ID,
                    COTH_CCY,
                    CR_CREDIT_GL_ID,
                    CR_DEBIT_GL_ID
         )
         LOOP
           PIPE ROW (CRR_JNL_DATA_REC (RESULT.COTH_APPROVAL_DATE,
                                       RESULT.CR_COUNTRY_ID,
                                       RESULT.CR_PRODUCT_CODE,
                                       RESULT.CR_JNL_TYPE_ID,
                                       RESULT.CR_JNL_ENTRY_TYPE_ID,
                                       RESULT.CR_PARTY_TYPE,
                                       RESULT.CR_PARTY_ID,
                                       RESULT.CR_CURRENCY_ID,
                                       RESULT.GL_ID,
                                       RESULT.CR_IND,
                                       RESULT.TXN_AMT,
                                       RESULT.TXN_COUNT,
                                       RESULT.TXN_ID));
         END LOOP;
      RETURN;
   END GET_OFL_PSP_BAID_GLOBAL;

   FUNCTION GET_OFL_MERCH_TXN_AMT_GLOBAL (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%TYPE,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%TYPE,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%TYPE,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (SELECT COTH_APPROVAL_DATE,
                    CR_COUNTRY_ID,
                    OMPM_PRODUCT_CODE CR_PRODUCT_CODE,
                    CR_JNL_TYPE_ID,
                    CR_JNL_ENTRY_TYPE_ID,
                    CR_PARTY_TYPE,
                    CASE WHEN CR_PARTY_TYPE <> 'G'
                           THEN CR_PARTY_ID
                           ELSE '' 
                         END CR_PARTY_ID,
                    CASE WHEN CR_CREDIT_GL_ID <> 0 
                           THEN CR_CREDIT_GL_ID
                         WHEN CR_DEBIT_GL_ID IS NOT NULL
                           THEN CR_DEBIT_GL_ID
                           ELSE 0
                         END GL_ID,
                    CASE WHEN CR_CREDIT_GL_ID <> 0 
                           THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL 
                           THEN 'D'
                           ELSE ''
                           END CR_IND,
                    COTH_CCY CR_CURRENCY_ID,
                    SUM(NVL (COTH_TXN_AMT, 0)) TXN_AMT,
                    COUNT(COTH_TXN_ID) TXN_COUNT,
                    '' TXN_ID
             FROM   (SELECT B.cr_jnl_type_id,
                            B.CR_jnl_entry_type_id,
                            A.com_group_id,
                            A.com_txn_side,
                            A.com_is_single,
                            A.com_txn_code,
                            B.cr_party_type,
                            B.cr_product_code,
                            B.cr_credit_gl_id,
                            B.cr_debit_gl_id,
                            B.cr_country_id,
                            B.cr_party_id,
                            B.cr_currency_id
                     FROM   crr_ofl_jnl_entry_type_mapping A,
                            crr_rule_posting B
                     WHERE  A.com_entry_type_id = B.cr_jnl_entry_type_id
                       AND  A.com_jnl_type_id = B.cr_jnl_type_id
                       AND  A.com_disabled = 0
                       AND  B.cr_disabled = 0
                       AND  A.com_group_id = in_group_id
                       and  A.com_jnl_type_id = in_jnl_type_id
                       and  A.com_entry_type_id = in_entry_type_id) L,
                    (SELECT coth_txn_id,
                            coth_txn_code,
                            coth_ccy,
                            coth_txn_amt,
                            coth_fee,
                            nvl(coth_fee_ccy,coth_net_ccy) coth_fee_ccy,
                            coth_net_amt,
                            coth_net_ccy,
                            coth_markup_amt,
                            coth_markup_ccy,
                            coth_approval_date,
                            cotd_merchant_id,
                            ompm_product_code 
                     FROM   crr_ofl_txn_data_header,
                            crr_ofl_txn_data_detail,
                            (SELECT ompm_merch_id,
                                    ompm_product_code,
                                    MAX (ompm_effective_date)
                             FROM   crr_ofl_merch_product_code_map
                             GROUP BY ompm_merch_id, 
                                      ompm_product_code) C
                     WHERE  coth_approval_date = in_fr_txn_date
                       AND  coth_txn_id = cotd_txn_id
                       AND  cotd_merchant_id = ompm_merch_id) R
             WHERE  L.com_txn_code = coth_txn_code
               AND  L.cr_product_code = R.ompm_product_code
             GROUP BY
                    COTH_APPROVAL_DATE,
                    CR_COUNTRY_ID,
                    OMPM_PRODUCT_CODE,
                    CR_JNL_TYPE_ID,
                    CR_JNL_ENTRY_TYPE_ID,
                    CR_PARTY_TYPE,
                    CR_PARTY_ID,
                    COTH_CCY,
                    CR_CREDIT_GL_ID,
                    CR_DEBIT_GL_ID
         )
         LOOP
           PIPE ROW (CRR_JNL_DATA_REC (RESULT.COTH_APPROVAL_DATE,
                                       RESULT.CR_COUNTRY_ID,
                                       RESULT.CR_PRODUCT_CODE,
                                       RESULT.CR_JNL_TYPE_ID,
                                       RESULT.CR_JNL_ENTRY_TYPE_ID,
                                       RESULT.CR_PARTY_TYPE,
                                       RESULT.CR_PARTY_ID,
                                       RESULT.CR_CURRENCY_ID,
                                       RESULT.GL_ID,
                                       RESULT.CR_IND,
                                       RESULT.TXN_AMT,
                                       RESULT.TXN_COUNT,
                                       RESULT.TXN_ID));
         END LOOP;
      RETURN;
   END GET_OFL_MERCH_TXN_AMT_GLOBAL;

   FUNCTION GET_OFL_MERCH_FEE_GLOBAL (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%TYPE,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%TYPE,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%TYPE,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (SELECT COTH_APPROVAL_DATE,
                    CR_COUNTRY_ID,
                    OMPM_PRODUCT_CODE CR_PRODUCT_CODE,
                    CR_JNL_TYPE_ID,
                    CR_JNL_ENTRY_TYPE_ID,
                    CR_PARTY_TYPE,
                    CASE WHEN CR_PARTY_TYPE <> 'G'
                           THEN CR_PARTY_ID
                           ELSE '' 
                         END CR_PARTY_ID,
                    CASE WHEN CR_CREDIT_GL_ID <> 0 
                           THEN CR_CREDIT_GL_ID
                         WHEN CR_DEBIT_GL_ID IS NOT NULL
                           THEN CR_DEBIT_GL_ID
                           ELSE 0
                         END GL_ID,
                    CASE WHEN CR_CREDIT_GL_ID <> 0 
                           THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL 
                           THEN 'D'
                           ELSE ''
                           END CR_IND,
                    COTH_FEE_CCY FEE_CCY,
                    SUM(NVL (COTH_FEE, 0)) FEE_AMT,
                    COUNT(COTH_TXN_ID) TXN_COUNT,
                    '' TXN_ID
             FROM   (SELECT B.cr_jnl_type_id,
                            B.CR_jnl_entry_type_id,
                            A.com_group_id,
                            A.com_txn_side,
                            A.com_is_single,
                            A.com_txn_code,
                            B.cr_party_type,
                            B.cr_product_code,
                            B.cr_credit_gl_id,
                            B.cr_debit_gl_id,
                            B.cr_country_id,
                            B.cr_party_id,
                            B.cr_currency_id
                     FROM   crr_ofl_jnl_entry_type_mapping A,
                            crr_rule_posting B
                     WHERE  A.com_entry_type_id = B.cr_jnl_entry_type_id
                       AND  A.com_jnl_type_id = B.cr_jnl_type_id
                       AND  A.com_disabled = 0
                       AND  B.cr_disabled = 0
                       AND  A.com_group_id = in_group_id
                       and  A.com_jnl_type_id = in_jnl_type_id
                       and  A.com_entry_type_id = in_entry_type_id) L,
                    (SELECT coth_txn_id,
                            coth_txn_code,
                            coth_ccy,
                            coth_txn_amt,
                            coth_fee,
                            nvl(coth_fee_ccy,coth_net_ccy) coth_fee_ccy,
                            coth_net_amt,
                            coth_net_ccy,
                            coth_markup_amt,
                            coth_markup_ccy,
                            coth_approval_date,
                            cotd_merchant_id,
                            ompm_product_code 
                     FROM   crr_ofl_txn_data_header,
                            crr_ofl_txn_data_detail,
                            (SELECT ompm_merch_id,
                                    ompm_product_code,
                                    MAX (ompm_effective_date)
                             FROM   crr_ofl_merch_product_code_map
                             GROUP BY ompm_merch_id, 
                                      ompm_product_code) C
                     WHERE  coth_approval_date = in_fr_txn_date
                       AND  coth_txn_id = cotd_txn_id
                       AND  cotd_merchant_id = ompm_merch_id) R
             WHERE  L.com_txn_code = coth_txn_code
               AND  L.cr_product_code = R.ompm_product_code
             GROUP BY
                    COTH_APPROVAL_DATE,
                    CR_COUNTRY_ID,
                    OMPM_PRODUCT_CODE,
                    CR_JNL_TYPE_ID,
                    CR_JNL_ENTRY_TYPE_ID,
                    CR_PARTY_TYPE,
                    CR_PARTY_ID,
                    COTH_FEE_CCY,
                    CR_CREDIT_GL_ID,
                    CR_DEBIT_GL_ID
         )
         LOOP
           PIPE ROW (CRR_JNL_DATA_REC (RESULT.COTH_APPROVAL_DATE,
                                       RESULT.CR_COUNTRY_ID,
                                       RESULT.CR_PRODUCT_CODE,
                                       RESULT.CR_JNL_TYPE_ID,
                                       RESULT.CR_JNL_ENTRY_TYPE_ID,
                                       RESULT.CR_PARTY_TYPE,
                                       RESULT.CR_PARTY_ID,
                                       RESULT.FEE_CCY,
                                       RESULT.GL_ID,
                                       RESULT.CR_IND,
                                       RESULT.FEE_AMT,
                                       RESULT.TXN_COUNT,
                                       RESULT.TXN_ID));
         END LOOP;
      RETURN;
   END GET_OFL_MERCH_FEE_GLOBAL;

   FUNCTION GET_OFL_PSP_MARKUP_GLOBAL (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%TYPE,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%TYPE,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%TYPE,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (SELECT COTH_APPROVAL_DATE,
                    CR_COUNTRY_ID,
                    OMPM_PRODUCT_CODE CR_PRODUCT_CODE,
                    CR_JNL_TYPE_ID,
                    CR_JNL_ENTRY_TYPE_ID,
                    CR_PARTY_TYPE,
                    CASE WHEN   CR_PARTY_TYPE <> 'G' 
                           THEN CR_PARTY_ID 
                           ELSE ''
                         END CR_PARTY_ID,
                    CASE WHEN   CR_CREDIT_GL_ID <> 0
                           THEN CR_CREDIT_GL_ID
                         WHEN   CR_DEBIT_GL_ID IS NOT NULL
                           THEN CR_DEBIT_GL_ID
                           ELSE 0
                         END GL_ID,
                    CASE WHEN   CR_CREDIT_GL_ID <> 0
                           THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL
                           THEN 'D'
                           ELSE ''
                         END CR_IND,
                    COTH_MARKUP_CCY CR_CURRENCY_ID,
                    SUM(NVL (COTH_MARKUP_AMT, 0)) MARKUP_AMT,
                    COUNT(COTH_TXN_ID) TXN_COUNT,
                    '' TXN_ID
             FROM   (SELECT B.cr_jnl_type_id,
                            B.cr_jnl_entry_type_id,
                            A.com_group_id,
                            A.com_txn_side,
                            A.com_is_single,
                            A.com_txn_code,
                            A.com_baid_category,
                            B.cr_party_type,
                            B.cr_product_code,
                            B.cr_credit_gl_id,
                            B.cr_debit_gl_id,
                            B.cr_country_id,
                            B.cr_party_id,
                            B.cr_currency_id
                     FROM   crr_ofl_jnl_entry_type_mapping A,
                            crr_rule_posting B
                     WHERE  A.com_entry_type_id = b.cr_jnl_entry_type_id
                       AND  A.com_jnl_type_id = b.cr_jnl_type_id
                       AND  A.com_disabled = 0
                       AND  B.cr_disabled = 0
                       AND  A.com_group_id = in_group_id
                       and  A.com_jnl_type_id = in_jnl_type_id
                       and  A.com_entry_type_id = in_entry_type_id) L,
                    (SELECT coth_txn_id,
                            coth_txn_code,
                            coth_deli_ccy,
                            coth_deli_amt,
                            coth_fee,
                            nvl(coth_fee_ccy,coth_net_ccy) coth_fee_ccy,
                            coth_net_amt,
                            coth_net_ccy,
                            coth_markup_amt,
                            coth_markup_ccy,
                            coth_approval_date,
                            cotd_merchant_id,
                            ompm_product_code
                     FROM   crr_ofl_txn_data_header,
                            crr_ofl_txn_data_detail,
                            (SELECT ompm_merch_id,
                                    ompm_product_code,
                                    MAX (ompm_effective_date)
                             FROM   crr_ofl_merch_product_code_map
                             GROUP BY ompm_merch_id,
                                      ompm_product_code) C
                             WHERE  coth_approval_date = in_fr_txn_date
                               AND  coth_txn_id = cotd_txn_id
                               AND  cotd_merchant_id = ompm_merch_id) R
             WHERE  L.com_txn_code = coth_txn_code
               AND  L.cr_product_code = R.ompm_product_code
             GROUP BY
                    COTH_APPROVAL_DATE,
                    CR_COUNTRY_ID,
                    OMPM_PRODUCT_CODE,
                    CR_JNL_TYPE_ID,
                    CR_JNL_ENTRY_TYPE_ID,
                    CR_PARTY_TYPE,
                    CR_PARTY_ID,
                    COTH_MARKUP_CCY,
                    CR_CREDIT_GL_ID,
                    CR_DEBIT_GL_ID
         )
         LOOP
           PIPE ROW (CRR_JNL_DATA_REC (RESULT.COTH_APPROVAL_DATE,
                                       RESULT.CR_COUNTRY_ID,
                                       RESULT.CR_PRODUCT_CODE,
                                       RESULT.CR_JNL_TYPE_ID,
                                       RESULT.CR_JNL_ENTRY_TYPE_ID,
                                       RESULT.CR_PARTY_TYPE,
                                       RESULT.CR_PARTY_ID,
                                       RESULT.CR_CURRENCY_ID,
                                       RESULT.GL_ID,
                                       RESULT.CR_IND,
                                       RESULT.MARKUP_AMT,
                                       RESULT.TXN_COUNT,
                                       RESULT.TXN_ID));
         END LOOP;
      RETURN;
   END GET_OFL_PSP_MARKUP_GLOBAL;

   FUNCTION GET_OFL_PSP_DELI_GLOBAL (
      in_jnl_type_id      crr_ofl_jnl_entry_type_mapping.com_jnl_type_id%TYPE,
      in_entry_type_id    crr_ofl_jnl_entry_type_mapping.com_entry_type_id%TYPE,
      in_group_id         crr_ofl_jnl_entry_type_mapping.com_group_id%TYPE,
      in_fr_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE,
      in_to_txn_date      crr_ofl_txn_data_header.coth_approval_date%TYPE)
      RETURN CRR_JNL_DATA_TAB
      PIPELINED
   AS
   BEGIN
      FOR RESULT
         IN (SELECT COTH_APPROVAL_DATE,
                    CR_COUNTRY_ID,
                    OMPM_PRODUCT_CODE CR_PRODUCT_CODE,
                    CR_JNL_TYPE_ID,
                    CR_JNL_ENTRY_TYPE_ID,
                    CR_PARTY_TYPE,
                    CASE WHEN   CR_PARTY_TYPE <> 'G' 
                           THEN CR_PARTY_ID 
                           ELSE ''
                         END CR_PARTY_ID,
                    CASE WHEN   CR_CREDIT_GL_ID <> 0
                           THEN CR_CREDIT_GL_ID
                         WHEN   CR_DEBIT_GL_ID IS NOT NULL
                           THEN CR_DEBIT_GL_ID
                           ELSE 0
                         END GL_ID,
                    CASE WHEN   CR_CREDIT_GL_ID <> 0
                           THEN 'C'
                         WHEN CR_DEBIT_GL_ID IS NOT NULL
                           THEN 'D'
                           ELSE ''
                         END CR_IND,
                    COTH_DELI_CCY CR_CURRENCY_ID,
                    SUM(NVL (COTH_DELI_AMT, 0)) DELI_AMT,
                    COUNT(COTH_TXN_ID) TXN_COUNT,
                    '' TXN_ID
             FROM   (SELECT B.cr_jnl_type_id,
                            B.cr_jnl_entry_type_id,
                            A.com_group_id,
                            A.com_txn_side,
                            A.com_is_single,
                            A.com_txn_code,
                            A.com_baid_category,
                            B.cr_party_type,
                            B.cr_product_code,
                            B.cr_credit_gl_id,
                            B.cr_debit_gl_id,
                            B.cr_country_id,
                            B.cr_party_id,
                            B.cr_currency_id
                     FROM   crr_ofl_jnl_entry_type_mapping A,
                            crr_rule_posting B
                     WHERE  A.com_entry_type_id = b.cr_jnl_entry_type_id
                       AND  A.com_jnl_type_id = b.cr_jnl_type_id
                       AND  A.com_disabled = 0
                       AND  B.cr_disabled = 0
                       AND  A.com_group_id = in_group_id
                       and  A.com_jnl_type_id = in_jnl_type_id
                       and  A.com_entry_type_id = in_entry_type_id) L,
                    (SELECT coth_txn_id,
                            coth_txn_code,
                            coth_deli_ccy,
                            coth_deli_amt,
                            coth_fee,
                            nvl(coth_fee_ccy,coth_net_ccy) coth_fee_ccy,
                            coth_net_amt,
                            coth_net_ccy,
                            coth_markup_amt,
                            coth_markup_ccy,
                            coth_approval_date,
                            cotd_merchant_id,
                            ompm_product_code
                     FROM   crr_ofl_txn_data_header,
                            crr_ofl_txn_data_detail,
                            (SELECT ompm_merch_id,
                                    ompm_product_code,
                                    MAX (ompm_effective_date)
                             FROM   crr_ofl_merch_product_code_map
                             GROUP BY ompm_merch_id,
                                      ompm_product_code) C 
                             WHERE  coth_approval_date = in_fr_txn_date
                               AND  coth_txn_id = cotd_txn_id
                               AND  cotd_merchant_id = ompm_merch_id) R
             WHERE  L.com_txn_code = coth_txn_code
               AND  L.cr_product_code = R.ompm_product_code
             GROUP BY
                    COTH_APPROVAL_DATE,
                    CR_COUNTRY_ID,
                    OMPM_PRODUCT_CODE,
                    CR_JNL_TYPE_ID,
                    CR_JNL_ENTRY_TYPE_ID,
                    CR_PARTY_TYPE,
                    CR_PARTY_ID,
                    COTH_DELI_CCY,
                    CR_CREDIT_GL_ID,
                    CR_DEBIT_GL_ID
         )
         LOOP
           PIPE ROW (CRR_JNL_DATA_REC (RESULT.COTH_APPROVAL_DATE,
                                       RESULT.CR_COUNTRY_ID,
                                       RESULT.CR_PRODUCT_CODE,
                                       RESULT.CR_JNL_TYPE_ID,
                                       RESULT.CR_JNL_ENTRY_TYPE_ID,
                                       RESULT.CR_PARTY_TYPE,
                                       RESULT.CR_PARTY_ID,
                                       RESULT.CR_CURRENCY_ID,
                                       RESULT.GL_ID,
                                       RESULT.CR_IND,
                                       RESULT.DELI_AMT,
                                       RESULT.TXN_COUNT,
                                       RESULT.TXN_ID));
         END LOOP;
      RETURN;
   END GET_OFL_PSP_DELI_GLOBAL;


END CRR_JNL_DATA_PKG;
/

