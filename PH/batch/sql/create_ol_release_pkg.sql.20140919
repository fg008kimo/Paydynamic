CREATE OR REPLACE PACKAGE ol_release_pkg
IS
   PROCEDURE open_reserve (
      in_merchant_id   IN     ol_txn_header.oth_merchant_id%TYPE,
      in_period        IN     ol_merch_detail.md_release_reserved_period%TYPE,
      cursor_reserve      OUT SYS_REFCURSOR);

END ol_release_pkg;
/

CREATE OR REPLACE PACKAGE BODY ol_release_pkg
IS
   PROCEDURE open_reserve (
      in_merchant_id   IN     ol_txn_header.oth_merchant_id%TYPE,
      in_period        IN     ol_merch_detail.md_release_reserved_period%TYPE,
      cursor_reserve      OUT SYS_REFCURSOR)
   IS
      v_ph_posting_date   system_control.sys_val%TYPE;
   BEGIN
      SELECT sys_val
        INTO v_ph_posting_date
        FROM system_control
       WHERE sys_code = 'CTPHDATE';

      OPEN cursor_reserve FOR
         SELECT oth_txn_id
           FROM ol_txn_header
          WHERE     oth_status = 'C'
                AND oth_ar_ind = 'A'
                AND oth_merchant_id = in_merchant_id
                AND oth_txn_code IN ('ODI', 'ODP')
                AND oth_reserve_amount > 0
                AND oth_approval_date <=
                       TO_CHAR (
                          (  TO_DATE (v_ph_posting_date, 'YYYYMMDD')
                           - in_period),
                          'YYYYMMDD')
                AND oth_reserved_release_date IS NULL;
   END open_reserve;


END ol_release_pkg;
/
