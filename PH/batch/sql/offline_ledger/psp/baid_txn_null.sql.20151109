CREATE OR REPLACE FUNCTION baid_txn_null (
     in_approval_date_from    ol_txn_header.oth_approval_timestamp%TYPE,
     in_approval_date_to      ol_txn_header.oth_approval_timestamp%TYPE,
     in_psp_id                ol_txn_psp_detail.otp_psp_id%TYPE,
     in_baid                  OL_BANK_ACCT_ID.OBAI_BAID%type,
     in_ccy                   ol_txn_elements.ote_ccy%TYPE,
     in_ele                   varchar2)
     RETURN sys_refcursor
  IS
  sql_stmt varchar2(4000);
  open_bal_str varchar2(100);
  open_bal_chk varchar2(100);
  sql_cur sys_refcursor;

  begin
  if in_ele='A' then
     open_bal_str := 'nvl(otp_bal,0) - nvl(otp_total_hold,0) dbal';
     open_bal_chk := ' and otp_bal is not null';
  elsif in_ele='P' then
     open_bal_str := 'nvl(otp_prepaid,0) dbal';
     open_bal_chk := ' and otp_prepaid is not null';
  elsif in_ele='T' then
     open_bal_str := 'nvl(otp_in_transit,0) dbal';
     open_bal_chk := ' and otp_in_transit is not null';
  elsif in_ele='L' then
     open_bal_str := 'nvl(otp_total_hold,0) dbal';
     open_bal_chk := ' and otp_total_hold is not null';
  end if;

  if in_baid is null  then

   sql_stmt := 'select
                obai_baid,
		OBAI_BAID_NAME ,
		OTP_PSP_ID,
		oth_txn_id,
		null otp_tid,
		oth_txn_code,
		null tc_desc,
		nvl(dbal,0),
		null ote_amt_type,
		null ote_amount,
		nvl(dbal,0) bal,
		null ote_txn_element_type,
		null TXN_ELEMENT_TYPE_DESC,
		null ote_exec_seq,
		OTP_TXN_CCY ote_ccy,
		oth_approval_timestamp,
		oth_approval_date,
		otp_txn_date || OTP_TXN_TIME otp_report_date,
		null void_txn_id,
		null ote_party_type
                from (SELECT obai_baid,
                             OBAI_BAID_NAME ,
                             OTP_PSP_ID,
                             oth_txn_id,
                             oth_txn_code,
                             oth_approval_timestamp,
                             oth_approval_date,
                             otp_txn_date,
                             OTP_TXN_TIME, OTP_TXN_CCY,'
                             || open_bal_str || '
                  FROM ol_txn_psp_detail,ol_txn_header,OL_BANK_ACCT_ID
                 where oth_txn_id = otp_txn_id
                   AND oth_ar_ind = ''A''
                   and oth_approval_timestamp < :in_approval_date_from
                   and oth_version_no >= 2
                   and NVL(oth_txn_code, ''~'') not in (''PDO'')
                   AND otp_txn_ccy = :in_ccy
                   and OTP_BAID   = OBAI_BAID
                   and otp_psp_id = OBAI_PSP_ID
                   AND otp_psp_id = :in_psp_id ' || open_bal_chk || '
                 order by oth_approval_timestamp desc)
                 where rownum=1';
--     dbms_output.put_line(sql_stmt);
     open sql_cur for sql_stmt using IN_APPROVAL_DATE_from,in_ccy,in_psp_id;
else

   sql_stmt := 'select
                obai_baid,
		OBAI_BAID_NAME ,
		OTP_PSP_ID,
		oth_txn_id,
		null otp_tid,
		oth_txn_code,
		null tc_desc,
		nvl(dbal,0),
		null ote_amt_type,
		null ote_amount,
		nvl(dbal,0) bal,
		null ote_txn_element_type,
		null TXN_ELEMENT_TYPE_DESC,
		null ote_exec_seq,
		OTP_TXN_CCY ote_ccy,
		oth_approval_timestamp,
		oth_approval_date,
		otp_txn_date || OTP_TXN_TIME otp_report_date,
		null void_txn_id,
		null ote_party_type
                from (SELECT obai_baid,
                             OBAI_BAID_NAME ,
                             OTP_PSP_ID,
                             oth_txn_id,
                             oth_txn_code,
                             oth_approval_timestamp,
                             oth_approval_date,
                             otp_txn_date,
                             OTP_TXN_TIME, OTP_TXN_CCY,'
                            || open_bal_str || '
                  FROM ol_txn_psp_detail,ol_txn_header,OL_BANK_ACCT_ID
                 where oth_txn_id = otp_txn_id
                   AND oth_ar_ind = ''A''
                   and oth_approval_timestamp < :in_approval_date_from
                   and oth_version_no >= 2
                   and NVL(oth_txn_code, ''~'') not in (''PDO'')
                   AND otp_txn_ccy = :in_ccy
                   and OTP_BAID   = OBAI_BAID
                   and otp_psp_id = OBAI_PSP_ID
                   and OBAI_BAID  = :in_baid ' || open_bal_chk || '
                 order by oth_approval_timestamp desc)
                 where rownum=1';
--       dbms_output.put_line(sql_stmt);
       open sql_cur for sql_stmt using IN_APPROVAL_DATE_from,in_ccy,in_baid;
end if;

  return(sql_cur);
  end baid_txn_null;
/

