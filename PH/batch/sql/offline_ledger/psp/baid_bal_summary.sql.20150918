CREATE OR REPLACE FUNCTION baid_bal_summary(
   in_approval_date_from    ol_txn_header.oth_approval_timestamp%TYPE,
   in_approval_date_to      ol_txn_header.oth_approval_timestamp%TYPE,
   in_psp_id                   ol_txn_psp_detail.otp_psp_id%type,
   in_baid                  OL_BANK_ACCT_ID.OBAI_BAID%type,
   in_ccy                   ol_txn_elements.ote_ccy%TYPE,
   in_ele                   varchar2)
RETURN baid_bal_summary_tab pipelined
IS

out_rec baid_bal_summary_obj;

OBAI_BAID             VARCHAR2(20);
OBAI_BAID_NAME        VARCHAR2(50);
psp_id                varchar(10);
TXN_CODE              CHAR(3);
TXN_CODE_DESC         VARCHAR2(50);
TXN_ELEMENT_TYPE      CHAR(4);
TXN_ELEMENT_TYPE_DESC VARCHAR2(50);
AMOUNT                NUMBER;
TXN_CCY               CHAR(3);
AMT_TYPE              CHAR(2);
PARTY_TYPE            CHAR(1);
TXN_CNT		      INTEGER;

sql_stmt varchar2(4000);
baid_bal_summary_cur sys_refcursor;
in_ele_type varchar2(1000);

begin
  if in_ele='A' then
     in_ele_type :='''TAMT'',''TFEE'',''TRNF'',''RAMT'',''UAMT'',''HAMT''';
  elsif in_ele='P' then
     in_ele_type :='''PREP''';
  elsif in_ele='T' then
     in_ele_type :='''INTR''';
  elsif in_ele='L' then
     in_ele_type :='''UAMT'',''HAMT''';
  else
     in_ele_type := null;
  end if;

if in_baid is null
then
sql_stmt :=
'select NULL,
       NULL,
       OTP_PSP_ID,
       oth_txn_code,
       tc_desc,
       ote_txn_element_type,
       dt_desc,
       sum(ote_amount) amount,
       ote_ccy,
       ote_amt_type,
       ote_party_type,
       count(*) cnt
  FROM ol_txn_header Oth,ol_txn_elements,ol_txn_psp_detail,OL_BANK_ACCT_ID,def_element_type,txn_code
WHERE oth_approval_timestamp >= :in_approval_date_from
   AND oth_approval_timestamp <  :in_approval_date_to
   AND oth_version_no >= 2
   AND ote_ccy = :in_ccy
   AND otp_psp_id = :in_psp_id
   and OTP_BAID   = OBAI_BAID
   and otp_psp_id = OBAI_PSP_ID
   AND oth_ar_ind = ''A''
   AND oth_txn_code = tc_code
   AND oth_txn_id=otp_txn_id
   AND oth_txn_id = ote_txn_id
   and ote_txn_element_type IN ( ' || in_ele_type ||')
   AND ote_party_type = ''P''
   AND ote_txn_element_type = dt_type
   group by
   OTP_PSP_ID,
   oth_txn_code,
   tc_desc,
   dt_desc,
   ote_txn_element_type,
   ote_ccy,
   ote_amt_type,
   ote_party_type
union all
select null,null,psp_id,null,null,null,null,decode(rn,1,open_bal,bal),txn_ccy,null,decode(rn,1,''0'',''1''),null
from
(select lg.*, row_number() over (order by approval_timestamp) as rn, count(*) over () as total_count
 from
(select * from table(baid_txn_ledger(:in_approval_date_from,:in_approval_date_to,:in_psp_id,NULL,:in_ccy,:in_ele))
)lg
)where rn = 1 or rn = total_count
union all
select null,null,psp_id,null,null,null,null,bal,txn_ccy,null,''1'',null
from
(select lg.*, row_number() over (order by approval_timestamp) as rn, count(*) over () as total_count
 from
(select * from table(baid_txn_ledger(:in_approval_date_from,:in_approval_date_to,:in_psp_id,NULL,:in_ccy,:in_ele))
)lg
)where rn = 1 and total_count = 1';
open baid_bal_summary_cur for sql_stmt using IN_APPROVAL_DATE_FROM,IN_APPROVAL_DATE_to,in_ccy,in_psp_id,in_approval_date_from,IN_APPROVAL_DATE_to,in_psp_id,in_ccy,in_ele,in_approval_date_from,IN_APPROVAL_DATE_to,in_psp_id,in_ccy,in_ele;
else
sql_stmt :=
'select obai_baid,
       OBAI_BAID_NAME,
       OTP_PSP_ID,
       oth_txn_code,
       tc_desc,
       ote_txn_element_type,
       dt_desc,
       sum(ote_amount) amount,
       ote_ccy,
       ote_amt_type,
       ote_party_type,
       count(*) cnt
  FROM ol_txn_header Oth,ol_txn_elements,ol_txn_psp_detail,OL_BANK_ACCT_ID,def_element_type,txn_code
WHERE oth_approval_timestamp >= :in_approval_date_from
   AND oth_approval_timestamp <  :in_approval_date_to
   AND oth_version_no >= 2
   AND ote_ccy = :in_ccy
   and OBAI_BAID = :in_baid
   and OTP_BAID   = OBAI_BAID
   and otp_psp_id = OBAI_PSP_ID
   AND oth_ar_ind = ''A''
   AND oth_txn_code = tc_code
   AND oth_txn_id=otp_txn_id
   AND oth_txn_id = ote_txn_id
   and ote_txn_element_type IN ( ' || in_ele_type ||')
   AND ote_party_type = ''P''
   AND ote_txn_element_type = dt_type
   group by
   obai_baid,
   OBAI_BAID_NAME,
   OTP_PSP_ID,
   oth_txn_code,
   tc_desc,
   dt_desc,
   ote_txn_element_type,
   ote_ccy,
   ote_amt_type,
   ote_party_type
union all
select obai_baid,null,psp_id,null,null,null,null,decode(rn,1,open_bal,bal),txn_ccy,null,decode(rn,1,''0'',''1''),null
from
(select lg.*, row_number() over (order by approval_timestamp) as rn, count(*) over () as total_count
 from
(select * from table(baid_txn_ledger(:in_approval_date_from,:in_approval_date_to,:in_psp_id,:in_baid,:in_ccy,:in_ele))
)lg
)where rn = 1 or rn = total_count
union all
select obai_baid,null,psp_id,null,null,null,null,bal,txn_ccy,null,''1'',null
from
(select lg.*, row_number() over (order by approval_timestamp) as rn, count(*) over () as total_count
 from
(select * from table(baid_txn_ledger(:in_approval_date_from,:in_approval_date_to,:in_psp_id,:in_baid,:in_ccy,:in_ele))
)lg
)where rn = 1 and total_count = 1';
open baid_bal_summary_cur for sql_stmt using IN_APPROVAL_DATE_FROM,IN_APPROVAL_DATE_to,in_ccy,in_baid,in_approval_date_from,IN_APPROVAL_DATE_to,in_psp_id,in_baid,in_ccy,in_ele,in_approval_date_from,IN_APPROVAL_DATE_to,in_psp_id,in_baid,in_ccy,in_ele;
end if;

  LOOP
	FETCH baid_bal_summary_cur
	INTO
	    OBAI_BAID,
            OBAI_BAID_NAME,
            psp_id,
            TXN_CODE,
            TXN_CODE_DESC,
            TXN_ELEMENT_TYPE,
            TXN_ELEMENT_TYPE_DESC,
            AMOUNT,
            TXN_CCY,
            AMT_TYPE,
            PARTY_TYPE,
	    TXN_CNT;

	EXIT WHEN baid_bal_summary_cur%NOTFOUND;


	pipe row (baid_bal_summary_obj(OBAI_BAID,
                  OBAI_BAID_NAME,
                  psp_id,
                  TXN_CODE,
                  TXN_CODE_DESC,
                  TXN_ELEMENT_TYPE,
                  TXN_ELEMENT_TYPE_DESC,
                  AMOUNT,
                  TXN_CCY,
                  AMT_TYPE,
                  PARTY_TYPE,
		  TXN_CNT));


  END LOOP;

  CLOSE baid_bal_summary_cur;

  RETURN;

end baid_bal_summary;
/

