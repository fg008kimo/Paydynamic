CREATE OR REPLACE PACKAGE OL_LEDGER_PKG
IS
   FUNCTION F_CB_LEDGER (
      in_approval_date_from    ol_txn_header.oth_approval_timestamp%TYPE,
      in_approval_date_to      ol_txn_header.oth_approval_timestamp%TYPE,
      in_merchant_id           ol_txn_header.oth_merchant_id%TYPE,
      in_country               ol_txn_detail.otd_txn_country%TYPE,
      in_service_code          ol_txn_header.oth_service_code%TYPE,
      in_ccy                   ol_txn_detail.otd_txn_ccy%TYPE)
      RETURN ol_cb_ledger_tab;

   PROCEDURE open_cur_cb_ledger (
      in_host_posting_date   IN     ol_txn_header.oth_host_posting_date%TYPE,
      in_merchant_id         IN     ol_txn_header.oth_merchant_id%TYPE,
      in_country             IN     ol_txn_detail.otd_txn_country%TYPE,
      in_service_code        IN     ol_txn_header.oth_service_code%TYPE,
      in_ccy                 IN     ol_txn_detail.otd_txn_ccy%TYPE,
      cursor_cb_ledger       IN OUT SYS_REFCURSOR);


   FUNCTION F_SB_LEDGER (
      in_approval_date_from    ol_txn_header.oth_approval_timestamp%TYPE,
      in_approval_date_to      ol_txn_header.oth_approval_timestamp%TYPE,
      in_merchant_id           ol_txn_header.oth_merchant_id%TYPE,
      in_country               ol_txn_detail.otd_txn_country%TYPE,
      in_service_code          ol_txn_header.oth_service_code%TYPE,
      in_ccy                   ol_txn_detail.otd_txn_ccy%TYPE)
      RETURN ol_sb_ledger_tab;


   PROCEDURE open_cur_sb_ledger (
      in_host_posting_date   IN     ol_txn_header.oth_host_posting_date%TYPE,
      in_merchant_id         IN     ol_txn_header.oth_merchant_id%TYPE,
      in_country             IN     ol_txn_detail.otd_txn_country%TYPE,
      in_service_code        IN     ol_txn_header.oth_service_code%TYPE,
      in_ccy                 IN     ol_txn_detail.otd_txn_ccy%TYPE,
      cursor_sb_ledger       IN OUT SYS_REFCURSOR);


   FUNCTION F_RB_LEDGER (
      in_approval_date_from    ol_txn_header.oth_approval_timestamp%TYPE,
      in_approval_date_to      ol_txn_header.oth_approval_timestamp%TYPE,
      in_merchant_id           ol_txn_header.oth_merchant_id%TYPE,
      in_country               ol_txn_detail.otd_txn_country%TYPE,
      in_service_code          ol_txn_header.oth_service_code%TYPE,
      in_ccy                   ol_txn_detail.otd_txn_ccy%TYPE)
      RETURN ol_rb_ledger_tab;

   PROCEDURE open_cur_rb_ledger (
      in_host_posting_date   IN     ol_txn_header.oth_host_posting_date%TYPE,
      in_merchant_id         IN     ol_txn_header.oth_merchant_id%TYPE,
      in_country             IN     ol_txn_detail.otd_txn_country%TYPE,
      in_service_code        IN     ol_txn_header.oth_service_code%TYPE,
      in_ccy                 IN     ol_txn_detail.otd_txn_ccy%TYPE,
      cursor_rb_ledger       IN OUT SYS_REFCURSOR);

   FUNCTION F_APO_LEDGER (
      in_approval_date_from    ol_txn_header.oth_approval_timestamp%TYPE,
      in_approval_date_to      ol_txn_header.oth_approval_timestamp%TYPE,
      in_merchant_id           ol_txn_header.oth_merchant_id%TYPE,
      in_country               ol_txn_detail.otd_txn_country%TYPE,
      in_service_code          ol_txn_header.oth_service_code%TYPE,
      in_ccy                   ol_txn_detail.otd_txn_ccy%TYPE)
      RETURN ol_apo_ledger_tab;

   PROCEDURE open_cur_apo_ledger (
      in_host_posting_date   IN     ol_txn_header.oth_host_posting_date%TYPE,
      in_merchant_id         IN     ol_txn_header.oth_merchant_id%TYPE,
      in_country             IN     ol_txn_detail.otd_txn_country%TYPE,
      in_service_code        IN     ol_txn_header.oth_service_code%TYPE,
      in_ccy                 IN     ol_txn_detail.otd_txn_ccy%TYPE,
      cursor_apo_ledger      IN OUT SYS_REFCURSOR);

END OL_LEDGER_PKG;
/

CREATE OR REPLACE PACKAGE BODY OL_LEDGER_PKG
IS
   FUNCTION F_CB_LEDGER (
      in_approval_date_from    ol_txn_header.oth_approval_timestamp%TYPE,
      in_approval_date_to      ol_txn_header.oth_approval_timestamp%TYPE,
      in_merchant_id           ol_txn_header.oth_merchant_id%TYPE,
      in_country               ol_txn_detail.otd_txn_country%TYPE,
      in_service_code          ol_txn_header.oth_service_code%TYPE,
      in_ccy                   ol_txn_detail.otd_txn_ccy%TYPE)
      RETURN ol_cb_ledger_tab
   IS
      Result                       ol_cb_ledger_tab := ol_cb_ledger_tab ();
      n                            INTEGER := 0;
      dBal                         NUMBER := 0.0;
      dOpeningBal                  NUMBER := 0.0;
      lTxnId                       ol_txn_header.oth_txn_id%TYPE;

      v_txn_id                     VARCHAR (16);
      v_merchant_ref               ol_txn_header.oth_merchant_ref%TYPE;
      v_txn_code                   ol_txn_header.oth_txn_code%TYPE;
      v_txn_code_desc              txn_code.tc_desc%TYPE;
      v_txn_element_type           ol_txn_elements.ote_txn_element_type%TYPE;
      v_txn_element_type_desc      def_element_type.dt_desc%TYPE;
      v_exec_seq                   ol_txn_elements.ote_exec_seq%TYPE;
      v_amount                     ol_txn_elements.ote_amount%TYPE;
      v_ccy                        ol_txn_elements.ote_ccy%TYPE;
      v_amt_type                   ol_txn_elements.ote_amt_type%TYPE;
      v_approval_timestamp         ol_txn_header.oth_approval_timestamp%TYPE;
      v_approval_date              ol_txn_header.oth_approval_date%TYPE;
      v_void_txn_id                ol_txn_header.oth_org_txn_id%TYPE;
      v_party_type                 ol_txn_elements.ote_party_type%TYPE;

      p_reserve_amount             ol_txn_header.oth_transaction_amount%TYPE;
      p_closing_amount             ol_txn_detail.otd_current_bal%TYPE;
      iCnt                         INTEGER := 0;

      last_open_bal                ol_txn_detail.otd_current_bal%TYPE;
      last_open_bal_settlement     ol_txn_detail.otd_current_bal_settlement%TYPE;
      last_total_reserve_amount    OL_TXN_DETAIL.OTD_TOTAL_RESERVED_AMOUNT%TYPE;
      last_total_hold              ol_txn_detail.otd_total_hold%TYPE;
      last_total_hold_settlement   ol_txn_detail.otd_total_hold_settlement%TYPE;

      CURSOR cb_ledger_cur
      IS
           SELECT ote_txn_id,
                  oth_merchant_ref,
                  oth_txn_code,
                  tc_desc,
                  ote_txn_element_type,
                  --dt_desc,
                  nvl(mt_desc,dt_desc),
                  ote_exec_seq,
                  ote_amount,
                  ote_ccy,
                  ote_amt_type,
                  oth_approval_timestamp,
                  oth_approval_date,
                  void_txn_id,
          ote_party_type
             FROM ol_txn_detail,
                  (SELECT --/*+ LEADING (TXN_ELEMENTS) */
                         ote_txn_id,
                          ol_txn_header.oth_merchant_ref,
                          ote_txn_element_type,
                          dt_desc,
                          ote_exec_seq,
                          ote_amount,
                          ote_ccy,
                          ote_amt_type,
                          ol_txn_header.oth_txn_code,
                          tc_desc,
                          ol_txn_header.oth_approval_timestamp,
                          oth_approval_date,
                          oth_reserve_amount,
                          void_th.oth_txn_id void_txn_id,
              ote_party_type
                     FROM ol_txn_elements,
                          (SELECT oth_txn_id,
                                  oth_txn_code,
                                  oth_approval_timestamp,
                                  oth_approval_date,
                                  oth_merchant_ref,
                                  oth_reserve_amount
                             FROM ol_txn_header
                            WHERE     oth_approval_timestamp >=
                                         in_approval_date_from
                                  AND oth_approval_timestamp <
                                         in_approval_date_to
                                  AND oth_merchant_id = in_merchant_id
                                  AND oth_ar_ind = 'A'
                                  and oth_txn_code not in ('MFM')
                                  AND oth_service_code = in_service_code) ol_txn_header,
                          def_element_type,
                          txn_code,
                          (SELECT oth_txn_id, oth_org_txn_id
                             FROM ol_txn_header
                            WHERE     oth_merchant_id IS NOT NULL
                                  AND oth_ar_ind = 'A'
                                  AND oth_org_txn_id IN
                                         (SELECT oth_txn_id
                                            FROM ol_txn_header
                                           WHERE     oth_approval_timestamp >=
                                                        in_approval_date_from
                                                 AND oth_approval_timestamp <
                                                        in_approval_date_to
                                                 AND oth_merchant_id =
                                                        in_merchant_id
                                                 AND oth_ar_ind = 'A'
                                                 AND oth_service_code =
                                                        in_service_code)
                                                 AND oth_txn_code not in ('RLR','ORT','OTT')) void_th
                    WHERE     ote_txn_element_type IN
                                 ('TAMT',
                                  'TFEE',
                                  'TRNF',
                                  --'MAMT',
                                  'RAMT',
                                  'UAMT',
                                  'HAMT',
                                  'MFIN',
                                  'MPOR',
                                  'MAPO',
                                  'MAPF',
                                  'MFLT',
                                  'HOPO',
                                  'UOPO')
                          AND ote_party_type = 'M'
                          AND ote_ccy = in_ccy
                          AND ote_txn_id = ol_txn_header.oth_txn_id
                          AND ote_txn_element_type = dt_type
                          AND ol_txn_header.oth_txn_code = tc_code
                          AND ol_txn_header.oth_txn_id = void_th.oth_org_txn_id(+))
                          left join map_txn_element on
                          ote_txn_element_type = mt_element      and   oth_txn_code = mt_txn_code
            WHERE otd_txn_id = ote_txn_id AND otd_txn_country = in_country
         ORDER BY oth_approval_timestamp, ote_exec_seq;
   BEGIN
      /*
      SELECT COUNT (*)
        INTO icnt
        FROM ol_txn_header,
             ol_txn_detail
       WHERE     oth_approval_timestamp < in_approval_date_from
             AND oth_merchant_id = in_merchant_id
             AND oth_ar_ind = 'A'
             AND oth_service_code = in_service_code
             AND oth_net_ccy = in_ccy
             AND oth_txn_id = otd_txn_id
             AND otd_txn_country = in_country;
      */

      SELECT CASE WHEN EXISTS(
            SELECT 1
            FROM ol_txn_header, ol_txn_detail
             WHERE oth_approval_timestamp < in_approval_date_from
             AND oth_merchant_id = in_merchant_id
             AND oth_ar_ind = 'A'
             AND oth_service_code = in_service_code
             AND oth_net_ccy = in_ccy
             AND oth_txn_id = otd_txn_id
             AND otd_txn_country = in_country)
             THEN 1
            ELSE 0 END AS Cnt
      INTO  icnt
      FROM DUAL;

      IF icnt = 0
      THEN
         dBal := 0;
      ELSE
         SELECT NVL (otd_current_bal, 0),
                NVL (otd_current_bal_settlement, 0),
                NVL (otd_total_reserved_amount, 0),
                NVL (otd_total_hold, 0),
                NVL (otd_total_hold_settlement, 0)
           INTO last_open_bal,
                last_open_bal_settlement,
                last_total_reserve_amount,
                last_total_hold,
                last_total_hold_settlement
           FROM ol_txn_detail,
                (SELECT max(oth_txn_id) as oth_txn_id
                   FROM ol_txn_header
                  WHERE     oth_approval_timestamp =
                               (SELECT MAX (oth_approval_timestamp)
                                  FROM ol_txn_header,
                                       ol_txn_detail
                                 WHERE     oth_approval_timestamp <
                                              in_approval_date_from
                                       AND oth_merchant_id = in_merchant_id
                                       AND oth_ar_ind = 'A'
                                       AND oth_service_code = in_service_code
                                       AND oth_net_ccy = in_ccy
                                       AND oth_txn_id = otd_txn_id
                                       and otd_txn_country = in_country)
                        AND oth_approval_timestamp < in_approval_date_from
                        AND oth_merchant_id = in_merchant_id
                        AND oth_ar_ind = 'A'
                        AND oth_service_code = in_service_code
                        AND oth_net_ccy = in_ccy) ol_txn_header
          WHERE otd_txn_id = oth_txn_id;

         dBal :=
              last_open_bal
            + last_open_bal_settlement
            - last_total_reserve_amount
            - last_total_hold
            - last_total_hold_settlement;
      END IF;

      OPEN cb_ledger_cur;

      p_reserve_amount := 0;
      p_closing_amount := 0;

      LOOP
         FETCH cb_ledger_cur
            INTO v_txn_id,
                 v_merchant_ref,
                 v_txn_code,
                 v_txn_code_desc,
                 v_txn_element_type,
                 v_txn_element_type_desc,
                 v_exec_seq,
                 v_amount,
                 v_ccy,
                 v_amt_type,
                 v_approval_timestamp,
                 v_approval_date,
                 v_void_txn_id,
         v_party_type;

         EXIT WHEN cb_ledger_cur%NOTFOUND;

         IF (n = 0)
         THEN
            lTxnId := v_txn_id;
            p_closing_amount := 0;
         ELSE
            dBal := p_closing_amount;
         END IF;

         dOpeningBal := dBal;

         IF (v_amt_type = 'DR')
         THEN
            IF (v_txn_code = 'ODI' or v_txn_code = 'MRN')
            THEN
               IF (v_txn_element_type != 'RAMT')
               THEN
                  --dBal := dBal - v_amount - p_reserve_amount;
                  dBal := dBal - v_amount;
               ELSE
                  dBal := dBal - v_amount;
               END IF;
            ELSE
               dBal := dBal - v_amount;
            END IF;
         ELSE
            IF (v_txn_code = 'ODI' or v_txn_code = 'MRN')
            THEN
               IF (v_txn_element_type = 'RAMT')
               THEN
                  --dBal := dBal + v_amount - p_reserve_amount;
                  dBal := dBal + v_amount;
               ELSE
                  dBal := dBal + v_amount;
               END IF;
            ELSE
               dBal := dBal + v_amount;
            END IF;
         END IF;

         Result.EXTEND;
         n := n + 1;


         result (n) :=
            ol_cb_ledger_OBJ (v_txn_id,
                           v_merchant_ref,
                           v_txn_code,
                           v_txn_code_desc,
                           dOpeningBal,
                           v_amt_type,
                           v_amount,
                           dBal,
                           v_txn_element_type,
                           v_txn_element_type_desc,
                           v_exec_seq,
                           v_ccy,
                           v_approval_timestamp,
                           v_approval_date,
                           v_void_txn_id,
               v_party_type);

         lTxnId := v_txn_id;

         IF (v_txn_element_type = 'RAMT')
         THEN
            p_reserve_amount := v_amount;
         ELSE
            p_reserve_amount := 0;
         END IF;

         p_closing_amount := dBal;
      END LOOP;

      CLOSE cb_ledger_cur;

      RETURN (Result);
   END;

   PROCEDURE open_cur_cb_ledger (
      in_host_posting_date   IN     ol_txn_header.oth_host_posting_date%TYPE,
      in_merchant_id         IN     ol_txn_header.oth_merchant_id%TYPE,
      in_country             IN     ol_txn_detail.otd_txn_country%TYPE,
      in_service_code        IN     ol_txn_header.oth_service_code%TYPE,
      in_ccy                 IN     ol_txn_detail.otd_txn_ccy%TYPE,
      cursor_cb_ledger       IN OUT SYS_REFCURSOR)
   IS
   BEGIN
      OPEN cursor_cb_ledger FOR
         SELECT *
           FROM TABLE (ol_ledger_pkg.F_cb_ledger (
                          TO_DATE (in_host_posting_date, 'YYYYMMDD'),
                          TO_DATE (in_host_posting_date, 'yyyymmdd') + 1,
                          in_merchant_id,
                          in_country,
                          in_service_code,
                          in_ccy));
   END open_cur_cb_ledger;

   FUNCTION F_SB_LEDGER (
      in_approval_date_from    ol_txn_header.oth_approval_timestamp%TYPE,
      in_approval_date_to      ol_txn_header.oth_approval_timestamp%TYPE,
      in_merchant_id           ol_txn_header.oth_merchant_id%TYPE,
      in_country               ol_txn_detail.otd_txn_country%TYPE,
      in_service_code          ol_txn_header.oth_service_code%TYPE,
      in_ccy                   ol_txn_detail.otd_txn_ccy%TYPE)
      RETURN ol_sb_ledger_tab
   IS
      Result                       ol_sb_ledger_tab := ol_sb_ledger_tab ();
      n                            INTEGER := 0;
      dBal                         NUMBER := 0.0;
      dOpeningBal                  NUMBER := 0.0;
      lTxnId                       ol_txn_header.oth_txn_id%TYPE;

      v_txn_id                     VARCHAR (16);
      v_merchant_ref               ol_txn_header.oth_merchant_ref%TYPE;
      v_txn_code                   ol_txn_header.oth_txn_code%TYPE;
      v_txn_code_desc              txn_code.tc_desc%TYPE;
      v_txn_element_type           ol_txn_elements.ote_txn_element_type%TYPE;
      v_txn_element_type_desc      def_element_type.dt_desc%TYPE;
      v_exec_seq                   ol_txn_elements.ote_exec_seq%TYPE;
      v_amount                     ol_txn_elements.ote_amount%TYPE;
      v_ccy                        ol_txn_elements.ote_ccy%TYPE;
      v_amt_type                   ol_txn_elements.ote_amt_type%TYPE;
      v_approval_timestamp         ol_txn_header.oth_approval_timestamp%TYPE;
      v_approval_date              ol_txn_header.oth_approval_date%TYPE;
      v_party_type                 ol_txn_elements.ote_party_type%TYPE;

      p_reserve_amount             ol_txn_header.oth_transaction_amount%TYPE;
      p_closing_amount             ol_txn_detail.otd_current_bal%TYPE;
      iCnt                         INTEGER := 0;

      last_total_hold              ol_txn_detail.otd_total_hold%TYPE;
      last_total_hold_settlement   ol_txn_detail.otd_total_hold_settlement%TYPE;

      CURSOR sb_ledger_cur
      IS
           SELECT ote_txn_id,
                  oth_merchant_ref,
                  oth_txn_code,
                  tc_desc,
                  ote_txn_element_type,
                  dt_desc,
                  ote_exec_seq,
                  ote_amount,
                  ote_ccy,
                  DECODE (ote_amt_type,  'DR', 'CR',  'CR', 'DR'),
                  oth_approval_timestamp,
                  oth_approval_date,
          ote_party_type
             FROM ol_txn_detail,
                  (SELECT --/*+ LEADING (TXN_ELEMENTS) */
                         ote_txn_id,
                          ol_txn_header.oth_merchant_ref,
                          ote_txn_element_type,
                          dt_desc,
                          ote_exec_seq,
                          ote_amount,
                          ote_ccy,
                          ote_amt_type,
                          ol_txn_header.oth_txn_code,
                          tc_desc,
                          ol_txn_header.oth_approval_timestamp,
                          ol_txn_header.oth_approval_date,
                          oth_reserve_amount,
              ote_party_type
                     FROM ol_txn_elements,
                          (SELECT oth_txn_id,
                                  oth_txn_code,
                                  oth_approval_timestamp,
                                  oth_approval_date,
                                  oth_merchant_ref,
                                  oth_reserve_amount
                             FROM ol_txn_header
                            WHERE     oth_approval_timestamp >=
                                         in_approval_date_from
                                  AND oth_approval_timestamp <
                                         in_approval_date_to
                                  AND oth_merchant_id = in_merchant_id
                                  AND oth_ar_ind = 'A'
                                  AND oth_service_code = in_service_code) ol_txn_header,
                          def_element_type,
                          txn_code
                    WHERE     ote_txn_element_type IN ('UAMT', 'HAMT','HOPO','UOPO')
                          AND ote_party_type = 'M'
                          AND ote_ccy = in_ccy
                          AND ote_txn_id = ol_txn_header.oth_txn_id
                          AND ote_txn_element_type = dt_type
                          AND ol_txn_header.oth_txn_code = tc_code)
            WHERE otd_txn_id = ote_txn_id AND otd_txn_country = in_country
         ORDER BY oth_approval_timestamp, ote_exec_seq;
   BEGIN
      /*
      SELECT COUNT (*)
        INTO icnt
        FROM ol_txn_header,
             ol_txn_detail
       WHERE     oth_approval_timestamp < in_approval_date_from
             AND oth_merchant_id = in_merchant_id
             AND oth_ar_ind = 'A'
             AND oth_service_code = in_service_code
             AND oth_net_ccy = in_ccy
             AND oth_txn_id = otd_txn_id
             AND otd_txn_country = in_country;
      */

      SELECT CASE WHEN EXISTS(
            SELECT 1
            FROM ol_txn_header, ol_txn_detail
             WHERE oth_approval_timestamp < in_approval_date_from
             AND oth_merchant_id = in_merchant_id
             AND oth_ar_ind = 'A'
             AND oth_service_code = in_service_code
             AND oth_net_ccy = in_ccy
             AND oth_txn_id = otd_txn_id
             AND otd_txn_country = in_country)
             THEN 1
            ELSE 0 END AS Cnt
      INTO  icnt
      FROM DUAL;



      IF icnt = 0
      THEN
         dBal := 0;
      ELSE
         SELECT NVL (otd_total_hold, 0), NVL (otd_total_hold_settlement, 0)
           INTO last_total_hold, last_total_hold_settlement
           FROM ol_txn_detail,
                (SELECT max(oth_txn_id) as oth_txn_id
                   FROM ol_txn_header
                  WHERE     oth_approval_timestamp =
                               (SELECT MAX (oth_approval_timestamp)
                                  FROM ol_txn_header,
                                       ol_txn_detail
                                 WHERE     oth_approval_timestamp <
                                              in_approval_date_from
                                       AND oth_merchant_id = in_merchant_id
                                       AND oth_ar_ind = 'A'
                                       AND oth_service_code = in_service_code
                                       AND oth_net_ccy = in_ccy
                                       AND oth_txn_id = otd_txn_id
                                       AND otd_txn_country = in_country)
                        AND oth_approval_timestamp < in_approval_date_from
                        AND oth_merchant_id = in_merchant_id
                        AND oth_ar_ind = 'A'
                        AND oth_service_code = in_service_code
                        AND oth_net_ccy = in_ccy) ol_txn_header
          WHERE otd_txn_id = oth_txn_id;

         dBal := last_total_hold + last_total_hold_settlement;
      END IF;


      OPEN sb_ledger_cur;

      p_reserve_amount := 0;
      p_closing_amount := 0;

      LOOP
         FETCH sb_ledger_cur
            INTO v_txn_id,
                 v_merchant_ref,
                 v_txn_code,
                 v_txn_code_desc,
                 v_txn_element_type,
                 v_txn_element_type_desc,
                 v_exec_seq,
                 v_amount,
                 v_ccy,
                 v_amt_type,
                 v_approval_timestamp,
                 v_approval_date,
         v_party_type;

         EXIT WHEN sb_ledger_cur%NOTFOUND;

         IF (n = 0)
         THEN
            lTxnId := v_txn_id;
            p_closing_amount := 0;
         ELSE
            dBal := p_closing_amount;
         END IF;

         dOpeningBal := dBal;

         IF (v_amt_type = 'DR')
         THEN
            dBal := dBal - v_amount;
         ELSE
            dBal := dBal + v_amount;
         END IF;

         Result.EXTEND;
         n := n + 1;


         result (n) :=
            ol_sb_ledger_OBJ (v_txn_id,
                           v_merchant_ref,
                           v_txn_code,
                           v_txn_code_desc,
                           dOpeningBal,
                           v_amt_type,
                           v_amount,
                           dBal,
                           v_txn_element_type,
                           v_txn_element_type_desc,
                           v_exec_seq,
                           v_ccy,
                           v_approval_timestamp,
                           v_approval_date,
               v_party_type);

         lTxnId := v_txn_id;

         IF (v_txn_element_type = 'RAMT')
         THEN
            p_reserve_amount := v_amount;
         ELSE
            p_reserve_amount := 0;
         END IF;

         p_closing_amount := dBal;
      END LOOP;

      CLOSE sb_ledger_cur;

      RETURN (Result);
   END;

   PROCEDURE open_cur_sb_ledger (
      in_host_posting_date   IN     ol_txn_header.oth_host_posting_date%TYPE,
      in_merchant_id         IN     ol_txn_header.oth_merchant_id%TYPE,
      in_country             IN     ol_txn_detail.otd_txn_country%TYPE,
      in_service_code        IN     ol_txn_header.oth_service_code%TYPE,
      in_ccy                 IN     ol_txn_detail.otd_txn_ccy%TYPE,
      cursor_sb_ledger       IN OUT SYS_REFCURSOR)
   IS
   BEGIN
      OPEN cursor_sb_ledger FOR
         SELECT *
           FROM TABLE (ol_ledger_pkg.F_sb_ledger (
                          TO_DATE (in_host_posting_date, 'YYYYMMDD'),
                          TO_DATE (in_host_posting_date, 'yyyymmdd') + 1,
                          in_merchant_id,
                          in_country,
                          in_service_code,
                          in_ccy));
   END open_cur_sb_ledger;

   FUNCTION F_RB_LEDGER (
      in_approval_date_from    ol_txn_header.oth_approval_timestamp%TYPE,
      in_approval_date_to      ol_txn_header.oth_approval_timestamp%TYPE,
      in_merchant_id           ol_txn_header.oth_merchant_id%TYPE,
      in_country               ol_txn_detail.otd_txn_country%TYPE,
      in_service_code          ol_txn_header.oth_service_code%TYPE,
      in_ccy                   ol_txn_detail.otd_txn_ccy%TYPE)
      RETURN ol_rb_ledger_tab
   IS
      Result                      ol_rb_ledger_tab := ol_rb_ledger_tab ();
      n                           INTEGER := 0;
      dBal                        NUMBER := 0.0;
      dOpeningBal                 NUMBER := 0.0;
      lTxnId                      ol_txn_header.oth_txn_id%TYPE;

      v_txn_id                    VARCHAR (16);
      v_merchant_ref              ol_txn_header.oth_merchant_ref%TYPE;
      v_txn_code                  ol_txn_header.oth_txn_code%TYPE;
      v_txn_code_desc             txn_code.tc_desc%TYPE;
      v_txn_element_type          ol_txn_elements.ote_txn_element_type%TYPE;
      v_txn_element_type_desc     def_element_type.dt_desc%TYPE;
      v_exec_seq                  ol_txn_elements.ote_exec_seq%TYPE;
      v_amount                    ol_txn_elements.ote_amount%TYPE;
      v_ccy                       ol_txn_elements.ote_ccy%TYPE;
      v_amt_type                  ol_txn_elements.ote_amt_type%TYPE;
      v_approval_timestamp        ol_txn_header.oth_approval_timestamp%TYPE;
      v_approval_date             ol_txn_header.oth_approval_date%TYPE;
      v_void_txn_id               ol_txn_header.oth_org_txn_id%TYPE;
      v_party_type                 ol_txn_elements.ote_party_type%TYPE;

      p_reserve_amount            ol_txn_header.oth_transaction_amount%TYPE;
      p_closing_amount            ol_txn_detail.otd_current_bal%TYPE;
      iCnt                        INTEGER := 0;


      last_total_reserve_amount   OL_TXN_DETAIL.OTD_TOTAL_RESERVED_AMOUNT%TYPE;

      CURSOR rb_ledger_cur
      IS
           SELECT ote_txn_id,
                  oth_merchant_ref,
                  oth_txn_code,
                  tc_desc,
                  ote_txn_element_type,
                  --dt_desc,
                  nvl(mt_desc,dt_desc),
                  ote_exec_seq,
                  ote_amount,
                  ote_ccy,
                  DECODE (ote_amt_type,  'DR', 'CR',  'CR', 'DR'),
                  oth_approval_timestamp,
                  oth_approval_date,
                  void_txn_id,
          ote_party_type
             FROM ol_txn_detail,
                  (SELECT --/*+ LEADING (TXN_ELEMENTS) */
                         ote_txn_id,
                          ol_txn_header.oth_merchant_ref,
                          ote_txn_element_type,
                          dt_desc,
                          ote_exec_seq,
                          ote_amount,
                          ote_ccy,
                          ote_amt_type,
                          ol_txn_header.oth_txn_code,
                          tc_desc,
                          ol_txn_header.oth_approval_timestamp,
                          ol_txn_header.oth_approval_date,
                          oth_reserve_amount,
                          void_th.oth_txn_id void_txn_id,
              ote_party_type
                     FROM ol_txn_elements,
                          (SELECT oth_txn_id,
                                  oth_txn_code,
                                  oth_approval_timestamp,
                                  oth_approval_date,
                                  oth_merchant_ref,
                                  oth_reserve_amount
                             FROM ol_txn_header
                            WHERE     oth_approval_timestamp >=
                                         in_approval_date_from
                                  AND oth_approval_timestamp <
                                         in_approval_date_to
                                  AND oth_merchant_id = in_merchant_id
                                  AND oth_ar_ind = 'A'
                                  AND oth_service_code = in_service_code
                                  ) ol_txn_header,
                          def_element_type,
                          txn_code,
                          (SELECT oth_txn_id, oth_org_txn_id
                             FROM ol_txn_header
                            WHERE     oth_merchant_id IS NOT NULL
                                  AND oth_ar_ind = 'A'
                                  AND oth_org_txn_id IN
                                         (SELECT oth_txn_id
                                            FROM ol_txn_header
                                           WHERE     oth_approval_timestamp >=
                                                        in_approval_date_from
                                                 AND oth_approval_timestamp <
                                                        in_approval_date_to
                                                 AND oth_merchant_id =
                                                        in_merchant_id
                                                 AND oth_ar_ind = 'A'
                                                 AND oth_service_code =
                                                        in_service_code)
                                    AND oth_txn_code not in ('RLR')
                    ) void_th
                    WHERE     ote_txn_element_type IN ('RAMT')
                          AND ote_party_type = 'M'
                          AND ote_ccy = in_ccy
                          AND ote_txn_id = ol_txn_header.oth_txn_id
                          AND ote_txn_element_type = dt_type
                          AND ol_txn_header.oth_txn_code = tc_code
                          AND ol_txn_header.oth_txn_id = void_th.oth_org_txn_id(+))
                          left join map_txn_element on
                          ote_txn_element_type = mt_element      and   oth_txn_code = mt_txn_code
            WHERE otd_txn_id = ote_txn_id AND otd_txn_country = in_country
         ORDER BY oth_approval_timestamp, ote_exec_seq;
   BEGIN
      /*
      SELECT COUNT (*)
        INTO icnt
        FROM ol_txn_header,
             ol_txn_detail
       WHERE     oth_approval_timestamp < in_approval_date_from
             AND oth_merchant_id = in_merchant_id
             AND oth_ar_ind = 'A'
             AND oth_service_code = in_service_code
             AND oth_net_ccy = in_ccy
             AND oth_txn_id = otd_txn_id
             AND otd_txn_country = in_country;
      */

      SELECT CASE WHEN EXISTS(
            SELECT 1
            FROM ol_txn_header, ol_txn_detail
             WHERE oth_approval_timestamp < in_approval_date_from
             AND oth_merchant_id = in_merchant_id
             AND oth_ar_ind = 'A'
             AND oth_service_code = in_service_code
             AND oth_net_ccy = in_ccy
             AND oth_txn_id = otd_txn_id
             AND otd_txn_country = in_country)
             THEN 1
            ELSE 0 END AS Cnt
      INTO  icnt
      FROM DUAL;


      IF icnt = 0
      THEN
         dBal := 0;
      ELSE
         SELECT NVL (otd_total_reserved_amount, 0)
           INTO last_total_reserve_amount
           FROM ol_txn_detail,
                (SELECT max(oth_txn_id) as oth_txn_id
                   FROM ol_txn_header
                  WHERE     oth_approval_timestamp =
                               (SELECT MAX (oth_approval_timestamp)
                                  FROM ol_txn_header,
                                       ol_txn_detail
                                 WHERE     oth_approval_timestamp <
                                              in_approval_date_from
                                       AND oth_merchant_id = in_merchant_id
                                       AND oth_ar_ind = 'A'
                                       AND oth_service_code = in_service_code
                                       AND oth_net_ccy = in_ccy
                                       AND oth_txn_id = otd_txn_id
                                       AND otd_txn_country = in_country)
                        AND oth_approval_timestamp < in_approval_date_from
                        AND oth_merchant_id = in_merchant_id
                        AND oth_ar_ind = 'A'
                        AND oth_service_code = in_service_code
                        AND oth_net_ccy = in_ccy) ol_txn_header
          WHERE otd_txn_id = oth_txn_id;

         dBal := last_total_reserve_amount;
      END IF;

      OPEN rb_ledger_cur;

      p_reserve_amount := 0;
      p_closing_amount := 0;

      LOOP
         FETCH rb_ledger_cur
            INTO v_txn_id,
                 v_merchant_ref,
                 v_txn_code,
                 v_txn_code_desc,
                 v_txn_element_type,
                 v_txn_element_type_desc,
                 v_exec_seq,
                 v_amount,
                 v_ccy,
                 v_amt_type,
                 v_approval_timestamp,
                 v_approval_date,
                 v_void_txn_id,
         v_party_type;

         EXIT WHEN rb_ledger_cur%NOTFOUND;

         IF (n = 0)
         THEN
            lTxnId := v_txn_id;
            p_closing_amount := 0;
         ELSE
            dBal := p_closing_amount;
         END IF;

         dOpeningBal := dBal;

         IF (v_amt_type = 'DR')
         THEN
            dBal := dBal - v_amount;
         ELSE
            dBal := dBal + v_amount;
         END IF;

         Result.EXTEND;
         n := n + 1;


         result (n) :=
            ol_rb_ledger_OBJ (v_txn_id,
                           v_merchant_ref,
                           v_txn_code,
                           v_txn_code_desc,
                           dOpeningBal,
                           v_amt_type,
                           v_amount,
                           dBal,
                           v_txn_element_type,
                           v_txn_element_type_desc,
                           v_exec_seq,
                           v_ccy,
                           v_approval_timestamp,
                           v_approval_date,
                           v_void_txn_id,
               v_party_type);

         lTxnId := v_txn_id;

         IF (v_txn_element_type = 'RAMT')
         THEN
            p_reserve_amount := v_amount;
         ELSE
            p_reserve_amount := 0;
         END IF;

         p_closing_amount := dBal;
      END LOOP;

      CLOSE rb_ledger_cur;

      RETURN (Result);
   END;

   PROCEDURE open_cur_rb_ledger (
      in_host_posting_date   IN     ol_txn_header.oth_host_posting_date%TYPE,
      in_merchant_id         IN     ol_txn_header.oth_merchant_id%TYPE,
      in_country             IN     ol_txn_detail.otd_txn_country%TYPE,
      in_service_code        IN     ol_txn_header.oth_service_code%TYPE,
      in_ccy                 IN     ol_txn_detail.otd_txn_ccy%TYPE,
      cursor_rb_ledger       IN OUT SYS_REFCURSOR)
   IS
   BEGIN
      OPEN cursor_rb_ledger FOR
         SELECT *
           FROM TABLE (ol_ledger_pkg.F_rb_ledger (
                          TO_DATE (in_host_posting_date, 'YYYYMMDD'),
                          TO_DATE (in_host_posting_date, 'yyyymmdd') + 1,
                          in_merchant_id,
                          in_country,
                          in_service_code,
                          in_ccy));
   END open_cur_rb_ledger;


   FUNCTION F_APO_LEDGER (
      in_approval_date_from    ol_txn_header.oth_approval_timestamp%TYPE,
      in_approval_date_to      ol_txn_header.oth_approval_timestamp%TYPE,
      in_merchant_id           ol_txn_header.oth_merchant_id%TYPE,
      in_country               ol_txn_detail.otd_txn_country%TYPE,
      in_service_code          ol_txn_header.oth_service_code%TYPE,
      in_ccy                   ol_txn_detail.otd_txn_ccy%TYPE)
      RETURN ol_apo_ledger_tab
   IS
      Result                      ol_apo_ledger_tab := ol_apo_ledger_tab ();
      n                           INTEGER := 0;
      dBal                        NUMBER := 0.0;
      dOpeningBal                 NUMBER := 0.0;
      lTxnId                      ol_txn_header.oth_txn_id%TYPE;

      v_txn_id                    VARCHAR (16);
      v_merchant_ref              ol_txn_header.oth_merchant_ref%TYPE;
      v_txn_code                  ol_txn_header.oth_txn_code%TYPE;
      v_txn_code_desc             txn_code.tc_desc%TYPE;
      v_txn_element_type          ol_txn_elements.ote_txn_element_type%TYPE;
      v_txn_element_type_desc     def_element_type.dt_desc%TYPE;
      v_exec_seq                  ol_txn_elements.ote_exec_seq%TYPE;
      v_amount                    ol_txn_elements.ote_amount%TYPE;
      v_ccy                       ol_txn_elements.ote_ccy%TYPE;
      v_amt_type                  ol_txn_elements.ote_amt_type%TYPE;
      v_approval_timestamp        ol_txn_header.oth_approval_timestamp%TYPE;
      v_approval_date             ol_txn_header.oth_approval_date%TYPE;
      v_void_txn_id               ol_txn_header.oth_org_txn_id%TYPE;
      v_party_type                 ol_txn_elements.ote_party_type%TYPE;

      p_reserve_amount            ol_txn_header.oth_transaction_amount%TYPE;
      p_closing_amount            ol_txn_detail.otd_current_bal%TYPE;
      iCnt                        INTEGER := 0;


      last_total_reserve_amount   OL_TXN_DETAIL.OTD_TOTAL_RESERVED_AMOUNT%TYPE;

      CURSOR apo_ledger_cur
      IS
           SELECT ote_txn_id,
                  oth_merchant_ref,
                  oth_txn_code,
                  tc_desc,
                  ote_txn_element_type,
                  nvl(mt_desc,dt_desc),
                  ote_exec_seq,
                  ote_amount,
                  ote_ccy,
                  ote_amt_type,
                  oth_approval_timestamp,
                  oth_approval_date,
          ote_party_type
             FROM ol_txn_detail,
                  (SELECT --/*+ LEADING (TXN_ELEMENTS) */
                         ote_txn_id,
                          ol_txn_header.oth_merchant_ref,
                          ote_txn_element_type,
                          dt_desc,
                          ote_exec_seq,
                          ote_amount,
                          ote_ccy,
                          ote_amt_type,
                          ol_txn_header.oth_txn_code,
                          tc_desc,
                          ol_txn_header.oth_approval_timestamp,
                          ol_txn_header.oth_approval_date,
                          oth_reserve_amount,
              ote_party_type
                     FROM ol_txn_elements,
                          (SELECT oth_txn_id,
                                  oth_txn_code,
                                  oth_approval_timestamp,
                                  oth_approval_date,
                                  oth_merchant_ref,
                                  oth_reserve_amount
                             FROM ol_txn_header
                            WHERE     oth_approval_timestamp >=
                                         in_approval_date_from
                                  AND oth_approval_timestamp <
                                         in_approval_date_to
                                  AND oth_merchant_id = in_merchant_id
                                  AND oth_ar_ind = 'A'
                                  AND oth_service_code = in_service_code) ol_txn_header,
                          def_element_type,
                          txn_code
                    WHERE     ote_txn_element_type IN
                                 ('MAPO',
                                  'MAPF',
                                  'TAMT',
                                  'TFEE',
                                  'MFIN',
                                  'MPOR',
                                  'MFLT',
                                  --'MAMT',
                                  'HOPO',
                                  'UOPO')
                          AND ote_party_type = 'M'
                          AND ote_ccy = in_ccy
                          AND ote_txn_id = ol_txn_header.oth_txn_id
                          AND ote_txn_element_type = dt_type
                          AND ol_txn_header.oth_txn_code = tc_code
                          AND ol_txn_header.oth_txn_code IN
                                 ('OPA',
                                  'MFM',
                                  'OLF',
                                  'OVA',
                                  'OVR',
                                  'FIM',
                                  'ORF',
                                  'ORT',
                                  'OHD',
                                  'UHD'))
                   left join map_txn_element on
                          ote_txn_element_type = mt_element      and   oth_txn_code = mt_txn_code
            WHERE otd_txn_id = ote_txn_id AND otd_txn_country = in_country

         ORDER BY oth_approval_timestamp, ote_exec_seq;
   BEGIN
      /*
      SELECT COUNT (*)
        INTO icnt
        FROM ol_txn_header,
             ol_txn_detail
       WHERE     oth_approval_timestamp < in_approval_date_from
             AND oth_merchant_id = in_merchant_id
             AND oth_ar_ind = 'A'
             AND oth_service_code = in_service_code
             AND oth_net_ccy = in_ccy
             AND oth_txn_id = otd_txn_id
             AND otd_txn_country = in_country;
      */

      SELECT CASE WHEN EXISTS(
            SELECT 1
            FROM ol_txn_header, ol_txn_detail
             WHERE oth_approval_timestamp < in_approval_date_from
             AND oth_merchant_id = in_merchant_id
             AND oth_ar_ind = 'A'
             AND oth_service_code = in_service_code
             AND oth_net_ccy = in_ccy
             AND oth_txn_id = otd_txn_id
             AND otd_txn_country = in_country)
             THEN 1
            ELSE 0 END AS Cnt
      INTO  icnt
      FROM DUAL;

      IF icnt = 0
      THEN
         dBal := 0;
      ELSE
         SELECT   otd_current_bal
                - otd_total_hold
                - otd_total_float_after_payout
                   AS last_total_apo
           INTO last_total_reserve_amount
           FROM ol_txn_detail,
                (SELECT max(oth_txn_id) as oth_txn_id
                   FROM ol_txn_header
                  WHERE     oth_approval_timestamp =
                               (SELECT MAX (oth_approval_timestamp)
                                  FROM ol_txn_header,
                                       ol_txn_detail
                                 WHERE     oth_approval_timestamp <
                                              in_approval_date_from
                                       AND oth_merchant_id = in_merchant_id
                                       AND oth_ar_ind = 'A'
                                       AND oth_service_code = in_service_code
                                       AND oth_net_ccy = in_ccy
                                       AND oth_txn_id = otd_txn_id
                                       AND otd_txn_country = in_country)
                        AND oth_approval_timestamp < in_approval_date_from
                        AND oth_merchant_id = in_merchant_id
                        AND oth_ar_ind = 'A'
                        AND oth_service_code = in_service_code
                        AND oth_net_ccy = in_ccy) ol_txn_header
          WHERE otd_txn_id = oth_txn_id;

         dBal := last_total_reserve_amount;
      END IF;

      OPEN apo_ledger_cur;

      p_reserve_amount := 0;
      p_closing_amount := 0;

      LOOP
         FETCH apo_ledger_cur
            INTO v_txn_id,
                 v_merchant_ref,
                 v_txn_code,
                 v_txn_code_desc,
                 v_txn_element_type,
                 v_txn_element_type_desc,
                 v_exec_seq,
                 v_amount,
                 v_ccy,
                 v_amt_type,
                 v_approval_timestamp,
                 v_approval_date,
         v_party_type;

         EXIT WHEN apo_ledger_cur%NOTFOUND;

         IF v_txn_code in ('OVA','OVR')
         THEN
            IF (v_txn_element_type = 'TAMT' OR v_txn_element_type = 'TFEE')
            THEN
               CONTINUE;
            END IF;
         END IF;

         IF (n = 0)
         THEN
            lTxnId := v_txn_id;
            p_closing_amount := 0;
         ELSE
            dBal := p_closing_amount;
         END IF;

         dOpeningBal := dBal;

         IF (v_amt_type = 'DR')
         THEN
            dBal := dBal - v_amount;
         ELSE
            dBal := dBal + v_amount;
         END IF;

         Result.EXTEND;
         n := n + 1;


         result (n) :=
            ol_apo_ledger_OBJ (v_txn_id,
                            v_merchant_ref,
                            v_txn_code,
                            v_txn_code_desc,
                            dOpeningBal,
                            v_amt_type,
                            v_amount,
                            dBal,
                            v_txn_element_type,
                            v_txn_element_type_desc,
                            v_exec_seq,
                            v_ccy,
                            v_approval_timestamp,
                            v_approval_date,
                v_party_type);

         lTxnId := v_txn_id;

         IF (v_txn_element_type = 'RAMT')
         THEN
            p_reserve_amount := v_amount;
         ELSE
            p_reserve_amount := 0;
         END IF;

         p_closing_amount := dBal;
      END LOOP;

      CLOSE apo_ledger_cur;

      RETURN (Result);
   END;

   PROCEDURE open_cur_apo_ledger (
      in_host_posting_date   IN     ol_txn_header.oth_host_posting_date%TYPE,
      in_merchant_id         IN     ol_txn_header.oth_merchant_id%TYPE,
      in_country             IN     ol_txn_detail.otd_txn_country%TYPE,
      in_service_code        IN     ol_txn_header.oth_service_code%TYPE,
      in_ccy                 IN     ol_txn_detail.otd_txn_ccy%TYPE,
      cursor_apo_ledger      IN OUT SYS_REFCURSOR)
   IS
   BEGIN
      OPEN cursor_apo_ledger FOR
         SELECT *
           FROM TABLE (ol_ledger_pkg.F_apo_ledger (
                          TO_DATE (in_host_posting_date, 'YYYYMMDD'),
                          TO_DATE (in_host_posting_date, 'yyyymmdd') + 1,
                          in_merchant_id,
                          in_country,
                          in_service_code,
                          in_ccy));
   END open_cur_apo_ledger;

END OL_LEDGER_PKG;
/

