/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/01/12              LokMan Chow
check amount, >45000, split record		   2011/04/13		   LokMan Chow
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "batchcommon.h"
#include "common.h"
#include "utilitys.h"
#include "myhash.h"
#include "numutility.h"
#include "myrecordset.h"
#include "convert_esky_payout.h"
#include "langconvert.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

//#define	PD_TAB_DELIMITOR 0x09
#define	PD_TAB_DELIMITOR "	"
#define	PD_MY_DELIMITOR	 ","
#define	PD_MY_FL_TOEKN	 '"'
#define PD_DEFAULT_INPUTCODING  "UTF-8"
#define PD_DEFAULT_OUTPUTCODING  "UTF-8"
#define PD_CODING_LEN	10
#define	PD_CHAR		0x0D
#define PD_ESKY_LIMIT	45000
#define PD_ESKY_SPLIT	40000

char    cDebug;

char    cs_inputfile[PD_MAX_FILE_LEN + 1];
char    cs_outputfile[PD_MAX_FILE_LEN + 1];
char    cs_inputcoding[PD_CODING_LEN + 1];
char    cs_outputcoding[PD_CODING_LEN + 1];
int parse_arg(int argc,char **argv);
int verify_file(FILE *fin,FILE *fout);
int process_file(FILE *fin);
int OutputLine(FILE *fout,char (*csList)[IMPORT_FIELD_LEN]);

int batch_init(int argc, char* argv[])
{

    if (argc < 4) {
    	printf("usage: -f input file -o ouputfile -i input coding -c output coding\n");
        return FAILURE;
    }
    else
        return SUCCESS;
}


int batch_proc(int argc, char* argv[])
{
	FILE	*fin,*fout;
	int	iRet;
	
	iRet = parse_arg(argc,argv);

	if (iRet != SUCCESS) {
    		printf("*usage: -f input file -o ouputfile -i input coding -c output coding\n");
		return (iRet);
	}

	fin = fopen(cs_inputfile,"r");
	if (fin == NULL) {
DEBUGLOG(("Error Opening file = [%s]\n",cs_inputfile));
		return FAILURE;
	}

	fout = fopen(cs_outputfile,"w");
	if (fout == NULL) {
DEBUGLOG(("Error Opefing file = [%s] for write\n",cs_outputfile));
		fclose(fin);
		return FAILURE;
	}

DEBUGLOG(("Opened file = [%s] for write\n",cs_outputfile));

	iRet = verify_file(fin,fout);
	fclose(fin);
	fclose(fout);

	return iRet;

}


int batch_terminate(int argc, char* argv[])
{
	return SUCCESS;
}


                        
int parse_arg(int argc,char **argv)
{               
        char    c;
        strcpy(cs_inputfile,"");
        strcpy(cs_outputfile,"");
        strcpy(cs_outputcoding,"");
        strcpy(cs_inputcoding,"");
                        
        while ((c = getopt(argc,argv,"f:o:i:c:")) != EOF) {
                switch (c) {
                        case 'f':
                                strcpy(cs_inputfile, optarg);
                                break;
                        case 'o':
                                strcpy(cs_outputfile, optarg);
                                break;
                        case 'i':
                                strcpy(cs_inputcoding, optarg);
                                break;
                        case 'c':
                                strcpy(cs_outputcoding, optarg);
                                break;
                        default:
                                return FAILURE;
                }
        }       
        
        if (!strcmp(cs_inputfile,"") ||!strcmp(cs_outputfile,""))
                return FAILURE;

	if (!strcmp(cs_inputcoding,""))
		strcpy(cs_inputcoding,PD_DEFAULT_INPUTCODING);

	if (!strcmp(cs_outputcoding,""))
		strcpy(cs_outputcoding,PD_DEFAULT_OUTPUTCODING);
                
DEBUGLOG(("[%s][%s][%s->%s]\n",cs_inputfile,cs_outputfile,cs_inputcoding,cs_outputcoding));
        return SUCCESS; 
}               


int verify_file(FILE *fin,FILE *fout)
{
        int     iRet = FAILURE;
	int	iCount;
	int	iRec, a, iAppend;
	char    csList[IMPORT_MAX_FIELD][IMPORT_FIELD_LEN];
        char    cs_input_buf[PD_MAX_BUFFER +1];;
	char	*p;
	char	*csBuf;
	double dAmt;
	double dSplit;

	csBuf = (char*) malloc (128);

/* Header */    
        iCount = 0;
	for(a=0;a<2;a++){
        	fgets(cs_input_buf,PD_MAX_BUFFER,fin);
        	if (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A || cs_input_buf[strlen(cs_input_buf) - 1] == 0x10)
               		cs_input_buf[strlen(cs_input_buf) - 1] = '\0';
//		strcpy(cs_input_buf,TrimAllChar(cs_input_buf,strlen(cs_input_buf),PD_CHAR));
DEBUGLOG(("%s\n",cs_input_buf));
	}


	iRec=1;	
        while (fgets(cs_input_buf,PD_MAX_BUFFER, fin) != NULL) {

        	if (cs_input_buf[strlen(cs_input_buf) - 1] == 0x0A)
                        cs_input_buf[strlen(cs_input_buf) - 1] = '\0';
		strcpy(cs_input_buf,TrimAllChar(cs_input_buf,strlen(cs_input_buf),PD_CHAR));
DEBUGLOG(("%s\n",cs_input_buf));
                iCount = 0;

                p = mystrtok(cs_input_buf,PD_TAB_DELIMITOR);
                if (p == NULL)
                        return FAILURE;
                strcpy(csList[iCount],TrimAllChar(p,strlen(p),PD_MY_FL_TOEKN));
                iCount++;

                while ( (p = mystrtok(NULL,PD_TAB_DELIMITOR)) != NULL) {
                        strcpy(csList[iCount],TrimAllChar(p,strlen(p),PD_MY_FL_TOEKN));
                        iCount++;
                }
/*
DEBUGLOG(("TXN_NUM=[%s]\n",csList[IDX_TXN_NUM]));
DEBUGLOG(("NAME=[%s]\n",csList[IDX_NAME]));
DEBUGLOG(("ID_NUM=[%s]\n",csList[IDX_ID_NUM]));
DEBUGLOG(("MOBILE=[%s]\n",csList[IDX_MOBILE]));
DEBUGLOG(("ACC_NUM=[%s]\n",csList[IDX_ACC_NUM]));
DEBUGLOG(("BANK_NAME=[%s]\n",csList[IDX_BANK_NAME]));
DEBUGLOG(("BRANCH=[%s]\n",csList[IDX_BRANCH]));
DEBUGLOG(("TXN_AMOUNT=[%s]\n",csList[IDX_TXN_AMOUNT]));
*/	

		sscanf(csList[IDX_TXN_AMOUNT],"%lf",&dAmt);

		if((dAmt - PD_ESKY_LIMIT)>0){
			iAppend = 1;
			dSplit = PD_ESKY_SPLIT;
			do{
				sprintf(csBuf,"%d",iAppend);
				strcat(csList[IDX_TXN_NUM],csBuf);

				memset(csList[IDX_TXN_AMOUNT],0,sizeof(csList[IDX_TXN_AMOUNT]));
				sprintf(csList[IDX_TXN_AMOUNT],"%lf",dSplit);

				OutputLine(fout,csList);

				iAppend++;
				csList[IDX_TXN_NUM][strlen(csList[IDX_TXN_NUM])-1]='\0';
				dAmt = dAmt - dSplit;
				if(dAmt<PD_ESKY_SPLIT){
					dSplit = dAmt;
				}
				
			}while(dAmt>0);
		}
		else{
			iRet = OutputLine(fout,csList);
		}


		memset(cs_input_buf,0,sizeof(cs_input_buf));
		iRec ++;
        }

	FREE_ME(csBuf);
	return iRet;
}


int OutputLine(FILE *fout, char (*csList)[IMPORT_FIELD_LEN])
{
	int iRet = SUCCESS;
	double dAmt;

/* Field #1 txn_num */
		fprintf(fout,"%.*s%s",(int)strlen(csList[IDX_TXN_NUM]),csList[IDX_TXN_NUM],PD_MY_DELIMITOR);

/* Field #2 name */
                fprintf(fout,"%.*s%s",(int)strlen(csList[IDX_NAME]),code_convert(cs_inputcoding,cs_outputcoding,csList[IDX_NAME]),PD_MY_DELIMITOR);

/* Field #3 id_num */
	  	fprintf(fout,"%.*s%s",(int)strlen(csList[IDX_ID_NUM]),csList[IDX_ID_NUM],PD_MY_DELIMITOR);

/* Field #4 mobile */
                fprintf(fout,"%.*s%s",(int)strlen(csList[IDX_MOBILE]),csList[IDX_MOBILE],PD_MY_DELIMITOR);

/* Field #5 bank_name */
                fprintf(fout,"%.*s%s",(int)strlen(csList[IDX_BANK_NAME]),code_convert(cs_inputcoding,cs_outputcoding,csList[IDX_BANK_NAME]),PD_MY_DELIMITOR);

/* Field #6 province */
		fprintf(fout,"%.*s",(int)strlen(csList[IDX_PROVINCE]),code_convert(cs_inputcoding,cs_outputcoding,csList[IDX_PROVINCE]));

/* Field #7 city */
		fprintf(fout,"%.*s",(int)strlen(csList[IDX_CITY]),code_convert(cs_inputcoding,cs_outputcoding,csList[IDX_CITY]));

/* Field #8 branch */
                fprintf(fout,"%.*s%s",(int)strlen(csList[IDX_BRANCH]),code_convert(cs_inputcoding,cs_outputcoding,csList[IDX_BRANCH]),PD_MY_DELIMITOR);

/* Field #9 acc_num */
                fprintf(fout,"%.*s%s",(int)strlen(csList[IDX_ACC_NUM]),csList[IDX_ACC_NUM],PD_MY_DELIMITOR);

/* Field #8 txn_amount */
		if(is_numeric(csList[IDX_TXN_AMOUNT])==PD_TRUE)
			fprintf(fout,"%.*s",(int)strlen(csList[IDX_TXN_AMOUNT]),csList[IDX_TXN_AMOUNT]);

		else{
			sscanf(csList[IDX_TXN_AMOUNT],"%lf",&dAmt);
			fprintf(fout,"%.2f",dAmt);
		}

                fprintf(fout,"\n");


	return iRet;
}
