#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "batchcommon.h"
#include "common.h"
#include "utilitys.h"
#include "myhash.h"
#include "numutility.h"
#include "myrecordset.h"


#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

#define	PD_MY_DELIMITOR		','
//#define MERCH_REF_HEAD_LEN	4
//#define MERCH_REF_TAIL_LEN	6
#define MAX_MERCHANT_NUM        100

char    cs_outfile[PD_MAX_FILE_LEN + 1];
char    cs_psp_id[PD_PSP_ID_LEN + 1];
char    cs_txn_code[PD_TXN_CODE_LEN + 1];
char    cs_date[PD_DATE_LEN + 1];
char    cDebug;

int process_txn(const unsigned char* csPspId,const unsigned char* csTxnCode,const unsigned char* csMerchId,
                FILE *fp);
int getAllMerchId(char (*csMerchIdList)[PD_MERCHANT_ID_LEN+1]);

int batch_init(int argc, char* argv[])
{

	if (argc < 4) {
        	printf("usage:  -o ouputfile -d Date -p PSP ID -t Txn Code\n");
        	return FAILURE;
	}

	return SUCCESS;
}

int parse_arg(int argc,char **argv)
{
        char    c;
        strcpy(cs_outfile,"");
        strcpy(cs_psp_id,"");
        strcpy(cs_txn_code,"");
        strcpy(cs_date,"");

        while ((c = getopt(argc,argv,"o:p:t:d:")) != EOF) {
                switch (c) {
                        case 'o':
                                strcpy(cs_outfile, optarg);
                                break;
                        case 'p':
                                strcpy(cs_psp_id, optarg);
                                break;
                        case 't':
                                strcpy(cs_txn_code, optarg);
                                break;
                        case 'd':
                                strcpy(cs_date, optarg);
                                break;
                        default:
                                return FAILURE;
                }
        }

        if (!strcmp(cs_outfile,"") || !strcmp(cs_psp_id,"") || !strcmp(cs_txn_code,"") || !strcmp(cs_date,""))
                return FAILURE;

        return SUCCESS;
}


int batch_proc(int argc, char* argv[])
{
        int     iRet = SUCCESS;
        char    cs_outfile_name[PD_MAX_FILE_LEN + 1];
        FILE    *fp;
	int	iNumOfRecord = 0;
	char    csMerchIdList[MAX_MERCHANT_NUM][PD_MERCHANT_ID_LEN+1];
        
	iRet = parse_arg(argc,argv);

        if (iRet != SUCCESS){
        	printf("usage:  -o ouputfile -d Date -p PSP ID -t Txn Code\n");
                return (iRet);
        }
 
       
	if(iRet==SUCCESS){
                iNumOfRecord = getAllMerchId(csMerchIdList);
        }

	if(iNumOfRecord>0){
		int i;
                for(i=0;i<iNumOfRecord;i++){
        		sprintf(cs_outfile_name, "%s/%s-%s-%s.dat", getenv("REPORT_DATA"),cs_outfile,csMerchIdList[i],cs_date);
        
        		fp = fopen(cs_outfile_name,"w");
        		if (fp == NULL) {
DEBUGLOG(("batch_proc:unable to open [%s]\n",cs_outfile_name));
        		}
			else{
				iRet = process_txn(cs_psp_id,cs_txn_code,csMerchIdList[i],fp);
DEBUGLOG(("process_txn: iRet [%d]\n",iRet));
			}
        
        		fclose(fp);
		}
	}
	else{
DEBUGLOG(("batch_proc: Merchant ID not found\n"));
	}
	return iRet;


}


int batch_terminate(int argc, char* argv[])
{
	return SUCCESS;
}




int process_txn(const unsigned char* csPspId,const unsigned char* csTxnCode,const unsigned char* csMerchId,
                FILE *fp)
{               
 
        int     iRet = SUCCESS;
        
        EXEC SQL WHENEVER SQLERROR GOTO sql_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
        
        EXEC SQL BEGIN DECLARE SECTION;
		
		varchar	hv_txn_code[PD_TXN_CODE_LEN];
		varchar hv_psp_id[PD_PSP_ID_LEN];
		varchar	hv_host_date[PD_DATE_LEN];
		varchar hv_merch_id[PD_MERCHANT_ID_LEN];
		char	hv_status;
		char	hv_ar_ind;

		varchar	v_txn_ccy[PD_CCY_ID_LEN +1];
		varchar	v_txn_id[PD_TXN_SEQ_LEN +1];
		varchar	v_merch_ref[PD_MERCHANT_REF_LEN +1];
		varchar	v_txn_date[PD_DATE_LEN +1];
		double	v_txn_amount;

		short	ind_txn_ccy = -1;
		short	ind_txn_id = -1;
		short	ind_merch_ref = -1;
		short	ind_txn_date = -1;
		short	ind_txn_amount = -1;


	EXEC SQL END DECLARE SECTION;

	hv_host_date.len = strlen(cs_date);
        memcpy(hv_host_date.arr,cs_date,hv_host_date.len);
DEBUGLOG(("process_txn::host_date = [%.*s]\n",hv_host_date.len,hv_host_date.arr));

        hv_txn_code.len = strlen(csTxnCode);
        memcpy(hv_txn_code.arr,csTxnCode,hv_txn_code.len);
DEBUGLOG(("process_txn::txn_code = [%.*s]\n",hv_txn_code.len,hv_txn_code.arr));

        hv_psp_id.len = strlen(csPspId);
        memcpy(hv_psp_id.arr,csPspId,hv_psp_id.len);
DEBUGLOG(("process_txn::psp_id= [%.*s]\n",hv_psp_id.len,hv_psp_id.arr));

        hv_merch_id.len = strlen(csMerchId);
        memcpy(hv_merch_id.arr,csMerchId,hv_merch_id.len);
DEBUGLOG(("process_txn::merch_id= [%.*s]\n",hv_merch_id.len,hv_merch_id.arr));

        hv_status = 'C';
        hv_ar_ind = 'A';

        EXEC SQL DECLARE c_cursor_gettxn CURSOR FOR
		select 	a.th_merchant_ref,
         		a.th_transmission_datetime,
         		b.tp_txn_amount,
			b.tp_txn_ccy,
			b.tp_txn_id
  		   from txn_header a,
			txn_psp_detail b
		  where th_status = :hv_status
                    and th_ar_ind = :hv_ar_ind
                    and th_transmission_datetime = :hv_host_date
		    and th_txn_code = :hv_txn_code
		    and tp_txn_id = th_txn_id
		    and tp_psp_id = :hv_psp_id
		    and th_merchant_id = :hv_merch_id
		   order by th_merchant_ref;
                
        EXEC SQL OPEN c_cursor_gettxn;
        do {    
                EXEC SQL FETCH c_cursor_gettxn
                INTO
			:v_merch_ref:ind_merch_ref,
			:v_txn_date:ind_txn_date,
			:v_txn_amount:ind_txn_amount,
			:v_txn_ccy:ind_txn_ccy,
			:v_txn_id:ind_txn_id;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

/* Field #0 merch_ref */
                if (ind_merch_ref < 0 )
                        v_merch_ref.arr[0] = '\0';
		fprintf(fp,"%.*s%c",v_merch_ref.len,v_merch_ref.arr,PD_MY_DELIMITOR);

/* Field #1 txn_date */
                if (ind_txn_date < 0 )
                        v_txn_date.arr[0] = '\0';
                fprintf(fp,"%.*s/%.*s/%.*s%c",PD_MONTH_LEN,&v_txn_date.arr[PD_MONTH_OS],PD_DAY_LEN,&v_txn_date.arr[PD_DATE_OS],PD_YEAR_LEN,v_txn_date.arr,PD_MY_DELIMITOR);

/* Field #2 ccy_id & txn_amount */
		if (ind_txn_ccy < 0 )
			v_txn_ccy.arr[0] = '\0';
		fprintf(fp,"%.*s",v_txn_ccy.len,v_txn_ccy.arr);

                if (ind_txn_amount < 0 )
			v_txn_amount = 0.0;
                fprintf(fp,"%ld.00%c",(long)v_txn_amount,PD_MY_DELIMITOR);

/* Field #3 merch_id */
		fprintf(fp,"%.*s",v_txn_id.len,v_txn_id.arr);

		fprintf(fp,"\n");

 	}
        while(PD_TRUE && iRet == SUCCESS);

        EXEC SQL CLOSE c_cursor_gettxn;
        return iRet;
sql_error:
    DEBUGLOG(("process_txn error code %d\n", sqlca.sqlcode));
    DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_gettxn;
    EXEC SQL ROLLBACK RELEASE;
    return FAILURE;
}



int getAllMerchId(char (*csMerchIdList)[PD_MERCHANT_ID_LEN+1])
{
        int iRet = 0;
        EXEC SQL WHENEVER SQLERROR GOTO get_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                char            hv_type;
                int             hv_disabled;

                varchar         v_merch_id[PD_MERCHANT_ID_LEN+1];

                short           ind_merch_id = -1;
        EXEC SQL END DECLARE SECTION;

        hv_type = 'M';
        hv_disabled = 0;

        EXEC SQL DECLARE c_cursor_getmerchantid CURSOR FOR
                select  b.merchant_id
                from    clients a,
                        merch_detail b
                where   a.type = :hv_type
                and     b.client_id = a.client_id
                and     b.disabled = :hv_disabled;

        EXEC SQL OPEN c_cursor_getmerchantid;
        do{
                EXEC SQL FETCH c_cursor_getmerchantid
                INTO    :v_merch_id:ind_merch_id;


                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }

/*merch_id*/
                if(ind_merch_id >= 0){
                        /*//hardcode
                        strcpy(csMerchIdList[iRet],"888000130");
                        csMerchIdList[iRet][strlen("888000130")]='\0';
			*/
                        strcpy(csMerchIdList[iRet],v_merch_id.arr);
                        csMerchIdList[iRet][v_merch_id.len]='\0';
DEBUGLOG(("Client type[%c]  Valid MerchId[%s]\n",hv_type,csMerchIdList[iRet]));
                        iRet++;
                }

        }while(PD_TRUE);


        EXEC SQL CLOSE c_cursor_getmerchantid;
	return iRet;

get_error:
    DEBUGLOG(("get merchant id: error code %d\n", sqlca.sqlcode));
    DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_getmerchantid;
    EXEC SQL ROLLBACK RELEASE;
    return 0;
}

