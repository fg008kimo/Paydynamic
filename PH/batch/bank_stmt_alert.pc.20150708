/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2014/07/07		   Stan Poon
Handle Currency and Payout                         2014/07/23		   Stan Poon
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sqlca.h>
#include <unistd.h>
#include "batchcommon.h"
#include "common.h"
#include "utilitys.h"
#include "myrecordset.h"
#include "ObjPtr.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

#define PD_FULL_MATCH	0

int	i_file_id;
char	cs_int_bank_code[PD_BANK_CODE_LEN + 1];
char	cs_bank_name[PD_BANK_NAME_LEN + 1];
char	cs_owner_name[PD_NAME_LEN + 1];
char	cs_bank_acct_type[PD_ACCT_TYPE_LEN + 1];
recordset_t	*myRecDb;

#define PD_OPEN_TAG	"<tr><td>"
#define PD_NEXT_TAG	"</td><td>"
#define PD_END_TAG	"</td></tr>"

char cDebug = 'Y';

int parse_arg(int argc, char **argv);
int process_txn_statement_detail();
int find_bank_info();
int find_alert_keywords();
int MultiKeywordsSearch(const char *csLine, char *csTemplate, int iFullMatch);

int batch_init(int argc, char* argv[])
{
	return SUCCESS;
}

int batch_proc(int argc, char* argv[])
{
	int iRet = SUCCESS;

	i_file_id = 0;
	//strcpy(cs_format_id,"");
	strcpy(cs_bank_name,"");
	strcpy(cs_owner_name,"");
	strcpy(cs_bank_acct_type,"");
	myRecDb = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(myRecDb,0);

	iRet = parse_arg(argc, argv);

	if (iRet != SUCCESS) {
printf("usage: -f file_id\n");

	} else {
		if (iRet == SUCCESS) {
			//cs_int_bank_code, cs_bank_name, cs_ower_name, cs_bank_acct_type
			iRet = find_bank_info();
		}
		if (iRet == SUCCESS) {
			//myRecDb
			iRet = find_alert_keywords();
		}
		if (iRet == SUCCESS) {
			iRet = process_txn_statement_detail();
		}

		if (iRet != SUCCESS &&
		    iRet != FAILURE) {
printf("<tr><td colspan='3'> fail </td></tr>\n");
		}
	}

	RecordSet_Destroy(myRecDb);
	FREE_ME(myRecDb);

	return iRet;
}

int process_txn_statement_detail()
{
	int	iRet = SUCCESS;
	int	iAltCnt = 0;
	int	iTmp;
	double	dTmp;
	char	*csTmp=NULL;
	hash_t	*hDtl = (hash_t*) malloc (sizeof(hash_t));
	hash_t	*hRecDb;

	int	iMatchCount=0, iToMatchCount=0, iMatchNow=0;
	int	iDisplayOrder=0;
	char	*csDesc=NULL, *csTemplate=NULL, *csField=NULL; 

 DEBUGLOG(("process_txn_statement_detail() begin\n"));

	EXEC SQL WHENEVER SQLERROR GOTO stmtdetail_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		int	hv_file_id;

		varchar	v_stat_txn_id[PD_STMT_REF_LEN + 1];
		varchar	v_statement_ref[PD_STMT_REF_LEN + 1];
		int	v_statement_seq;
		varchar	v_tfr_bank_name[PD_TFR_BANK_NAME_LEN + 1];
		varchar	v_tfr_bank_acct_num[PD_TFR_BANK_ACCT_NUM_LEN + 1];
		varchar	v_tfr_type[PD_TFR_TYPE_LEN + 1];
		varchar	v_tfr_channel[PD_TFR_CHANNEL_LEN + 1];
		varchar	v_tfr_text[PD_TFR_TEXT_LEN + 1];
		varchar	v_tfr_customer_text[PD_TFR_TEXT_LEN + 1];
		varchar	v_sender_name[PD_SENDER_NAME_LEN + 1];
		varchar	v_txn_ref_num[PD_TXN_REF_NUM_LEN + 1];
		varchar	v_amt_type[PD_AMT_TYPE_LEN + 1];
		double	v_txn_amount;
		varchar	v_txn_ccy[PD_CCY_ID_LEN + 1];
		double	v_balance;

		short	ind_stat_txn_id = -1;
		short	ind_statement_ref = -1;
		short	ind_statement_seq = -1;
		short	ind_tfr_bank_name = -1;
		short	ind_tfr_bank_acct_num = -1;
		short	ind_tfr_type = -1;
		short	ind_tfr_channel = -1;
		short	ind_tfr_text = -1;
		short	ind_tfr_customer_text = -1;
		short	ind_sender_name = -1;
		short	ind_txn_ref_num = -1;
		short	ind_amt_type = -1;
		short	ind_txn_amount = -1;
		short	ind_txn_ccy = -1;
		short	ind_balance = -1;
	EXEC SQL END DECLARE SECTION;

	hv_file_id = i_file_id;

	EXEC SQL DECLARE c_cursor_stmtdetail CURSOR FOR
		SELECT	OLSD_STAT_TXN_ID,
                        OLSD_STATEMENT_REF,
			OLSD_STATEMENT_SEQ,
			OLSD_TFR_BANK_NAME,
			OLSD_TFR_BANK_ACCT_NUM,
			OLSD_TFR_TYPE,
			OLSD_TFR_CHANNEL,
			OLSD_TFR_TEXT,
			OLSD_TFR_CUSTOMER_TEXT,
			OLSD_SENDER_NAME,
			OLSD_TXN_REF_NUM,
			OLSD_AMT_TYPE,
			OLSD_TXN_AMOUNT,
			OLSD_TXN_CCY,
			OLSD_BALANCE
		FROM	OL_STATEMENT_DETAIL
		WHERE	OLSD_FILE_ID = :hv_file_id
		AND	OLSD_AMT_TYPE = 'DR'
		ORDER BY OLSD_STATEMENT_SEQ ASC;

	EXEC SQL OPEN c_cursor_stmtdetail;

	for (;;) {
		EXEC SQL FETCH c_cursor_stmtdetail
		INTO	:v_stat_txn_id:ind_stat_txn_id,
			:v_statement_ref:ind_statement_ref,
			:v_statement_seq:ind_statement_seq,
			:v_tfr_bank_name:ind_tfr_bank_name,
			:v_tfr_bank_acct_num:ind_tfr_bank_acct_num,
			:v_tfr_type:ind_tfr_type,
			:v_tfr_channel:ind_tfr_channel,
			:v_tfr_text:ind_tfr_text,
			:v_tfr_customer_text:ind_tfr_customer_text,
			:v_sender_name:ind_sender_name,
			:v_txn_ref_num:ind_txn_ref_num,
			:v_amt_type:ind_amt_type,
			:v_txn_amount:ind_txn_amount,
			:v_txn_ccy:ind_txn_ccy,
			:v_balance:ind_balance;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		hash_init(hDtl,0);

		// stat_txn_id
		if (ind_stat_txn_id >= 0) {
			v_stat_txn_id.arr[v_stat_txn_id.len] = '\0';
			PutField_CString(hDtl, "stat_txn_id", (const char*)v_stat_txn_id.arr);
 DEBUGLOG(("process_txn_statement_detail() stat_txn_id = [%s]\n", (const char*)v_stat_txn_id.arr));
		}

		// statement_ref
		if (ind_statement_ref >= 0) {
			v_statement_ref.arr[v_statement_ref.len] = '\0';
			PutField_CString(hDtl, "stmt_ref", (const char*)v_statement_ref.arr);
 DEBUGLOG(("process_txn_statement_detail() stmt_ref = [%s]\n", (const char*)v_statement_ref.arr));
		}

		// statement_seq
		if (ind_statement_seq >= 0) {
			PutField_Int(hDtl, "statement_seq", v_statement_seq);
 DEBUGLOG(("process_txn_statement_detail() statement_seq = [%d]\n", v_statement_seq));
		}

		// tfr_bank_name
		if (ind_tfr_bank_name >= 0) {
			v_tfr_bank_name.arr[v_tfr_bank_name.len] = '\0';
			PutField_CString(hDtl, "tfr_bank_name", (const char*)v_tfr_bank_name.arr);
 DEBUGLOG(("process_txn_statement_detail() tfr_bank_name = [%s]\n", (const char*)v_tfr_bank_name.arr));
		}

		// tfr_bank_acct_num
		if (ind_tfr_bank_acct_num >= 0) {
			v_tfr_bank_acct_num.arr[v_tfr_bank_acct_num.len] = '\0';
			PutField_CString(hDtl, "tfr_bank_acct_num", (const char*)v_tfr_bank_acct_num.arr);
 DEBUGLOG(("process_txn_statement_detail() tfr_bank_acct_num = [%s]\n", (const char*)v_tfr_bank_acct_num.arr));
		}

		// tfr_type
		if (ind_tfr_type >= 0) {
			v_tfr_type.arr[v_tfr_type.len] = '\0';
			PutField_CString(hDtl, "tfr_type", (const char*)v_tfr_type.arr);
 DEBUGLOG(("process_txn_statement_detail() tfr_type = [%s]\n", (const char*)v_tfr_type.arr));
		}

		// tfr_channel
		if (ind_tfr_channel >= 0) {
			v_tfr_channel.arr[v_tfr_channel.len] = '\0';
			PutField_CString(hDtl, "tfr_channel", (const char*)v_tfr_channel.arr);
 DEBUGLOG(("process_txn_statement_detail() tfr_channel = [%s]\n", (const char*)v_tfr_channel.arr));
		}

		// tfr_text
		if (ind_tfr_text >= 0) {
			v_tfr_text.arr[v_tfr_text.len] = '\0';
			PutField_CString(hDtl, "tfr_text", (const char*)v_tfr_text.arr);
 DEBUGLOG(("process_txn_statement_detail() tfr_text = [%s]\n", (const char*)v_tfr_text.arr));
		}

		// tfr_customer_text
		if (ind_tfr_customer_text >= 0) {
			v_tfr_customer_text.arr[v_tfr_customer_text.len] = '\0';
			PutField_CString(hDtl, "tfr_customer_text", (const char*)v_tfr_customer_text.arr);
 DEBUGLOG(("process_txn_statement_detail() tfr_customer_text = [%s]\n", (const char*)v_tfr_customer_text.arr));
		}

		// sender_name
		if (ind_sender_name >= 0) {
			v_sender_name.arr[v_sender_name.len] = '\0';
			PutField_CString(hDtl, "sender_name", (const char*)v_sender_name.arr);
 DEBUGLOG(("process_txn_statement_detail() sender_name = [%s]\n", (const char*)v_sender_name.arr));
		}

		// txn_ref_num
		if (ind_txn_ref_num >= 0) {
			v_txn_ref_num.arr[v_txn_ref_num.len] = '\0';
			PutField_CString(hDtl, "txn_ref_num", (const char*)v_txn_ref_num.arr);
 DEBUGLOG(("process_txn_statement_detail() txn_ref_num = [%s]\n", (const char*)v_txn_ref_num.arr));
		}

		// amt_type
		if (ind_amt_type >= 0) {
			v_amt_type.arr[v_amt_type.len] = '\0';
			PutField_CString(hDtl, "amt_type", (const char*)v_amt_type.arr);
 DEBUGLOG(("process_txn_statement_detail() amt_type = [%s]\n", (const char*)v_amt_type.arr));
		}

		// txn_amount
		if (ind_txn_amount >= 0) {
			PutField_Double(hDtl, "txn_amount", v_txn_amount);
 DEBUGLOG(("process_txn_statement_detail() txn_amount = [%.2lf]\n", v_txn_amount));
		}

		// txn_ccy
		if (ind_txn_ccy >= 0) {
			v_txn_ccy.arr[v_txn_ccy.len] = '\0';
			PutField_CString(hDtl, "txn_ccy", (const char*)v_txn_ccy.arr);
 DEBUGLOG(("process_txn_statement_detail() txn_ccy = [%s]\n", (const char*)v_txn_ccy.arr));
		}

		// balance
		if (ind_balance >= 0) {
			PutField_Double(hDtl, "balance", v_balance);
 DEBUGLOG(("process_txn_statement_detail() balance = [%.2lf]\n", v_balance));
		}

		GetField_Double(hDtl,"txn_amount",&dTmp);
		GetField_CString(hDtl,"txn_ccy",&csTmp);

		if (dTmp + 1E-9 >= 100.0 && (long)dTmp + 1E-9 >= dTmp &&
		    !strcmp(csTmp,PD_CCY_ISO_CNY) &&
		    !strcmp(cs_bank_acct_type,"DSI")) {
			iAltCnt++;
printf("<tr><td>%s</td><td>%s</td><td>%.2lf</td></tr>\n",cs_bank_name,cs_owner_name,dTmp);
 DEBUGLOG(("process_txn_statement_detail() Amount Matched ***\n"));
		} else {
			iMatchCount = 0;
			iToMatchCount = 0;
			hRecDb = RecordSet_GetFirst(myRecDb); // Format Keywords
			while (hRecDb) {
					GetField_Int(hRecDb,"display_order",&iDisplayOrder);

					GetField_CString(hRecDb,"cont_desc",&csDesc);
					GetField_CString(hRecDb,"format_template",&csTemplate);
					if (GetField_CString(hDtl,csDesc,&csField)) {
 DEBUGLOG(("process_txn_statement_detail() (%s)[%s] / [%s]\n",csDesc,csField,csTemplate));
						if (MultiKeywordsSearch(csField,csTemplate,PD_FULL_MATCH) == FOUND) {
							iMatchCount++;
 DEBUGLOG(("process_txn_statement_detail() MultiKeywordsSearch() Matched\n"));
						}
					}

					iToMatchCount++;

					hRecDb = RecordSet_GetNext(myRecDb);
					if (hRecDb != NULL) {
						GetField_Int(hRecDb,"display_order",&iTmp);
						if (iTmp != iDisplayOrder) {
							iMatchNow = 1;
						} else {
							iMatchNow = 0;
						}
					}
			/* Keywords Matched */
				if (iMatchCount == iToMatchCount && iMatchNow == 1) {
					iAltCnt++;
printf("<tr><td>%s</td><td>%s</td><td>%.2lf</td></tr>\n",cs_bank_name,cs_owner_name,dTmp);
 DEBUGLOG(("process_txn_statement_detail() Keywords Matched ***\n"));
					break;
				}

				//Reset Count
				if (iMatchNow == 1) {
					iMatchCount = 0;
					iToMatchCount = 0;
				}
			} // while (hRecDb)

		}

		hash_destroy(hDtl);
	}
	EXEC SQL CLOSE c_cursor_stmtdetail;

	if (iAltCnt > 0) {
		iRet = FAILURE; //FOUND 1
 DEBUGLOG(("process_txn_statement_detail() FOUND\n"));
	} else {
		iRet = SUCCESS; //NOT_FOUND 0
 DEBUGLOG(("process_txn_statement_detail() NOT FOUND\n"));
	}

	FREE_ME(hDtl);

 DEBUGLOG(("process_txn_statement_detail() Ret = [%d]\n",iRet));
	return iRet;

stmtdetail_error:
DEBUGLOG(("stmtdetail_error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLStatement stmtdetail_error code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL CLOSE c_cursor_stmtdetail;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}


int find_alert_keywords()
{
	int iRet = SUCCESS;
	int iCnt = 0;

	hash_t *myHash;

 DEBUGLOG(("find_alert_keywords() begin\n"));

	EXEC SQL WHENEVER SQLERROR GOTO getkeywordserror;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;
		int	hv_file_id;
/*
		varchar	hv_int_bank_code[PD_BANK_CODE_LEN];
		varchar	hv_bank_acct_type[PD_ACCT_TYPE_LEN];
*/
		int	v_display_order;
		varchar	v_cont_desc[PD_CONT_DESC_LEN + 1];
		varchar	v_format_template[PD_FORMAT_TEMPLATE_LEN + 1];

		short	ind_display_order = -1;
		short	ind_cont_desc = -1;
		short	ind_format_template = -1;
	EXEC SQL END DECLARE SECTION;

	hv_file_id = i_file_id;
/*
	hv_int_bank_code.len = strlen(cs_int_bank_code);
	memcpy(hv_int_bank_code.arr,cs_int_bank_code,hv_int_bank_code.len);

	hv_bank_acct_type.len = strlen(cs_bank_acct_type);
	memcpy(hv_bank_acct_type.arr,cs_bank_acct_type,hv_bank_acct_type.len);
*/

	EXEC SQL DECLARE getkeywordscursor CURSOR FOR
		SELECT	OLFK_DISPLAY_ORDER,
			OLFT_CONT_DESC,
			OLFK_FORMAT_TEMPLATE
		FROM	OL_STATEMENT_HEADER,
			OL_BANK_ACCT_ID,
			OL_PSP_DETAIL,
			OL_STMT_FORMAT_TEMPLATE,
			OL_STMT_FORMAT_KEYWORDS
		WHERE	OLSH_FILE_ID = :hv_file_id
		AND	OLSH_BAID = OBAI_BAID
		AND	OPD_PSP_ID = OBAI_PSP_ID
		AND	OLFT_FORMAT_ID like OLSH_FORMAT_ID || '%'
		AND	OLSH_FORMAT_ID is not NULL --in case format_id not updated
		AND	OLFT_FORMAT_TYPE = 'CONTENT'
		AND	OLFK_INT_BANK_CODE = OLSH_INT_BANK_CODE
		AND	OLFK_FORMAT_TYPE = 'ALERT_DR_'||OPD_BANK_ACCT_TYPE
		AND	OLFK_DISABLED = 0
		AND	OLFK_FORMAT_COL_NAME = OLFT_CONT_COL_NAME;
/*
		SELECT	TK.OLFK_DISPLAY_ORDER,
			TP.OLFT_CONT_DESC,
			TK.OLFK_FORMAT_TEMPLATE
		FROM	(SELECT	OLFT_CONT_DESC,
				OLFT_CONT_COL_NAME
			FROM	OL_STMT_FORMAT,
				OL_STMT_FORMAT_TEMPLATE
			WHERE	OLSF_INT_BANK_CODE = :hv_int_bank_code
			AND	OLSF_DISABLED = 0
			AND	OLSF_EFFECT_TIMESTAMP <= sysdate
			AND	(OLFT_FORMAT_ID = OLSF_FORMAT_ID or OLFT_FORMAT_ID like OLSF_FORMAT_ID||'.%')
			AND	OLFT_FORMAT_TYPE = 'CONTENT'
			group by OLFT_CONT_DESC,OLFT_CONT_COL_NAME) TP,
			OL_STMT_FORMAT_KEYWORDS TK
		WHERE	TK.OLFK_INT_BANK_CODE = :hv_int_bank_code
		AND	TK.OLFK_FORMAT_TYPE = 'ALERT_DR_'||:hv_bank_acct_type
		AND	TK.OLFK_DISABLED = 0
		AND	TK.OLFK_FORMAT_COL_NAME = TP.OLFT_CONT_COL_NAME
		ORDER BY TK.OLFK_DISPLAY_ORDER ASC;
*/

	EXEC SQL OPEN getkeywordscursor;
	for (;;) {
		EXEC SQL FETCH getkeywordscursor
		INTO	:v_display_order:ind_display_order,
			:v_cont_desc:ind_cont_desc,
			:v_format_template:ind_format_template;

		if (SQLCODE == SQL_NOT_FOUND) {
			break;
		}

		iCnt++;

		myHash = (hash_t*) malloc (sizeof(hash_t));
		hash_init(myHash, 0);


/* display_order */
		if (ind_display_order >= 0) {
			PutField_Int(myHash, "display_order", v_display_order);
 DEBUGLOG(("find_alert_keywords() display_order = [%d]\n",v_display_order));
		} else {
			iRet = PD_ERR;
		}

/* cont_desc */
		if (ind_cont_desc >= 0) {
			v_cont_desc.arr[v_cont_desc.len] = '\0';
			PutField_CString(myHash, "cont_desc", (char*)v_cont_desc.arr);
 DEBUGLOG(("find_alert_keywords() cont_desc = [%s]\n",v_cont_desc.arr));
		} else {
			iRet = PD_ERR;
		}

/* format_template */
		if (ind_format_template >= 0) {
			v_format_template.arr[v_format_template.len] = '\0';
			PutField_CString(myHash, "format_template", (char*)v_format_template.arr);
 DEBUGLOG(("find_alert_keywords() format_template = [%s]\n",v_format_template.arr));
		} else {
			iRet = PD_ERR;
		}

		RecordSet_Add(myRecDb,myHash);
	}
	EXEC SQL CLOSE getkeywordscursor;

 DEBUGLOG(("find_alert_keywords() Ret = [%d]\n",iRet));
	return iRet;

getkeywordserror:
DEBUGLOG(("getkeywordserror code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
ERRLOG("OLStmtFormat getkeywordserror code %d\n", sqlca.sqlcode);
ERRLOG("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc);
	EXEC SQL CLOSE getkeywordscursor;
	EXEC SQL WHENEVER SQLERROR CONTINUE;
	return PD_ERR;
}


int find_bank_info()
{
	int     iRet = SUCCESS;

 DEBUGLOG(("find_bank_info() begin\n"));

	EXEC SQL WHENEVER SQLERROR GOTO find_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		int	hv_file_id;

		varchar	v_int_bank_code[PD_BANK_CODE_LEN + 1];
		varchar	v_bank_name[PD_BANK_NAME_LEN + 1];
		varchar	v_owner_name[PD_NAME_LEN + 1];
		varchar v_bank_acct_type[PD_ACCT_TYPE_LEN + 1];

		short	ind_int_bank_code = -1;
		short	ind_bank_name = -1;
		short	ind_owner_name = -1;
		short	ind_bank_acct_type = -1;

	EXEC SQL END DECLARE SECTION;

	hv_file_id = i_file_id;

	EXEC SQL
		SELECT	OLSH_INT_BANK_CODE,
			BANK_NAME,
			OB_OWNER_NAME,
			OPD_BANK_ACCT_TYPE
		INTO	:v_int_bank_code:ind_int_bank_code,
			:v_bank_name:ind_bank_name,
			:v_owner_name:ind_owner_name,
			:v_bank_acct_type:ind_bank_acct_type
		FROM	OL_STATEMENT_HEADER,
			OL_BANK_ACCTS,
			OL_BANK_ACCT_ID,
			BANK_DESC,
			OL_PSP_DETAIL
		WHERE	OLSH_FILE_ID = :hv_file_id
		AND	OLSH_INT_BANK_CODE = OB_INT_BANK_CODE
		AND	OLSH_BANK_ACCT_NUM = OB_BANK_ACCT_NUM
		AND	OLSH_BAID = OBAI_BAID
		AND	OLSH_INT_BANK_CODE = INTERNAL_BANK_CODE
		AND	OPD_PSP_ID = OBAI_PSP_ID;

	if (ind_int_bank_code >= 0) {
		v_int_bank_code.arr[v_int_bank_code.len]='\0';
		strcpy(cs_int_bank_code,(char*)v_int_bank_code.arr);
 DEBUGLOG(("find_bank_info() int_bank_code = [%s]\n",v_int_bank_code.arr));
	} else {
		iRet = PD_ERR;
	}

	if (ind_bank_name >= 0) {
		v_bank_name.arr[v_bank_name.len]='\0';
		strcpy(cs_bank_name,(char*)v_bank_name.arr);
 DEBUGLOG(("find_bank_info() bank_name = [%s]\n",v_bank_name.arr));
	} else {
		iRet = PD_ERR;
	}

	if (ind_owner_name >= 0) {
		v_owner_name.arr[v_owner_name.len]='\0';
		strcpy(cs_owner_name,(char*)v_owner_name.arr);
 DEBUGLOG(("find_bank_info() owner_name = [%s]\n",v_owner_name.arr));
	} else {
		iRet = PD_ERR;
	}

	if (ind_bank_acct_type >= 0) {
		v_bank_acct_type.arr[v_bank_acct_type.len]='\0';
		strcpy(cs_bank_acct_type,(char*)v_bank_acct_type.arr);
 DEBUGLOG(("find_bank_info() bank_acct_type = [%s]\n",v_bank_acct_type.arr));
	} else {
		iRet = PD_ERR;
	}

 DEBUGLOG(("find_bank_info() Ret = [%d]\n",iRet));
	return iRet;

find_error:
DEBUGLOG(("find_bank_info() error code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL ROLLBACK RELEASE;
    return PD_ERR;
}


int batch_terminate(int argc, char* argv[])
{
	return SUCCESS;
}

int parse_arg(int argc, char **argv)
{
	if (argc < 3) {
		return PD_ERR;
	}

	char    c;

	while ((c = getopt(argc,argv,"f:")) != EOF) {
		switch (c) {
			case 'f':
				i_file_id = atoi(optarg);
 DEBUGLOG(("parse_arg() file_id = [%s] \n",optarg));
				break;
			default:
				return PD_ERR;
		}
	}

	return SUCCESS;
}

int MultiKeywordsSearch(const char *csLine, char *csTemplate, int iFullMatch)
{
	char *csTemplateField;
	csTemplateField = mystrtok(csTemplate, ",");
	while (csTemplateField != NULL) {

		if (!strcmp(csTemplateField,"")) continue;

		if (iFullMatch == 0 && strstr(csLine, csTemplateField) != NULL) {
// DEBUGLOG(("MultiKeywordsSearch() Contains\n"));
			return FOUND;

		} else if (iFullMatch == 1 && !strcmp(csLine, csTemplateField)) {
// DEBUGLOG(("MultiKeywordsSearch() Full Match\n"));
			return FOUND;

		} else if (!strcmp(csTemplateField,"NOTNULL") && strcmp(csLine,"")) {
// DEBUGLOG(("MultiKeywordsSearch() NOTNULL Match\n"));
			return FOUND;

		} else if (!strcmp(csTemplateField,"NULL") && !strcmp(csLine,"")) {
// DEBUGLOG(("MultiKeywordsSearch() NULL Match\n"));
			return FOUND;
		}
		csTemplateField = mystrtok(NULL, ",");
	}
	return NOT_FOUND;
}

