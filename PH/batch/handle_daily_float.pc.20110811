/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/04/18              LokMan Chow
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "batchcommon.h"
#include "common.h"
#include "utilitys.h"
#include "myhash.h"
#include "numutility.h"
#include "myrecordset.h"
#include "ObjPtr.h"
#include "dates.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char    cs_cutoff_date[PD_DATE_LEN + 1];
char    cDebug = 'Y';

#define PD_T1_STATE	1
#define PD_T2_STATE	2

OBJPTR(DB);

int parse_arg(int argc,char **argv);
int process_bucket(const char *csCutoffDate);
int find_t1t2_date(const int iIndex, hash_t *myHash);
int find_t1t2_amount(const int iIndex, hash_t *myHash);
int process_t1t2_release(const int iIndex,hash_t *myHash);
int update_bucket(const hash_t *myHash);
int is_holidays(const char* csCountry, const char* csDate);
int is_weekend(const char* csDate);
int AddTxnLog(const hash_t* hVal);

int batch_init(int argc, char* argv[])
{

    if (argc < 2) {
        printf("usage:  -d cutoff_date\n");
        return FAILURE;
    }
    else

        return SUCCESS;
}




int batch_proc(int argc, char* argv[])
{
        int     iRet;

	iRet = parse_arg(argc,argv);
               
        if (iRet != SUCCESS) {
        	printf("usage:  -d cutoff_date\n");
                return (iRet);
        }

        iRet = process_bucket(cs_cutoff_date);


DEBUGLOG(("iRet = [%d]\n",iRet));

	return iRet;


}


int batch_terminate(int argc, char* argv[])
{
	return SUCCESS;
}




int process_bucket(const char *csCutoffDate)
{               
        int     iRet = SUCCESS;
        int     iUpdate;
	char	*csTmp;
	hash_t *myHash;

DEBUGLOG(("*****Process Bucket Start*****\n"));

	EXEC SQL WHENEVER SQLERROR GOTO sql_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar	hv_cutoff_date[PD_DATE_LEN];

		varchar	v_posting_date[PD_DATE_LEN + 1];
		varchar	v_merchant_id[PD_MERCHANT_ID_LEN + 1];
		varchar	v_country_id[PD_COUNTRY_LEN + 1];
		varchar	v_currency_id[PD_CCY_ID_LEN + 1];
		varchar	v_psp_id[PD_PSP_ID_LEN + 1];
		varchar	v_bucket_type[PD_BUCKET_TYPE_LEN + 1];
		varchar	v_service_code[PD_SERVICE_CODE_LEN + 1];
		double	v_bal;
		varchar	v_t1_date[PD_DATE_LEN + 1];
		varchar v_t2_date[PD_DATE_LEN + 1];
		double	v_t1_amount;
		double	v_t2_amount;

		short	ind_posting_date = -1;
		short	ind_merchant_id = -1;
		short	ind_t1_amount = -1;
		short	ind_t2_amount = -1;
		short	ind_t1_date = -1;
		short	ind_t2_date = -1;
		short	ind_bal= -1;
		short	ind_psp_id= -1;
		short	ind_currency_id= -1;
		short	ind_country_id= -1;
		short	ind_bucket_type= -1;
		short	ind_service_code= -1;


	EXEC SQL END DECLARE SECTION;

	hv_cutoff_date.len = strlen(csCutoffDate);
        memcpy(hv_cutoff_date.arr,csCutoffDate,hv_cutoff_date.len);
DEBUGLOG(("process_bucket cutoff_date = [%.*s]\n",hv_cutoff_date.len,hv_cutoff_date.arr));


        EXEC SQL DECLARE c_cursor_get_bucket CURSOR FOR
		select 	mb_posting_date,
         		mb_merchant_id,
         		mb_country_id,
         		mb_currency_id,
         		mb_psp_id,
         		mb_bucket_type,
         		mb_service_code,
         		mb_bal,
         		mb_t1_released_date,
         		mb_t1_released_amt,
         		mb_t2_released_date,
         		mb_t2_released_amt
		  from 	merchant_bucket
		  where mb_bucket_type = 'FT'
		  and	mb_posting_date < :hv_cutoff_date
		  order by mb_posting_date;
		
                
        EXEC SQL OPEN c_cursor_get_bucket;
        do {    
                EXEC SQL FETCH c_cursor_get_bucket
                INTO
         		v_posting_date:ind_posting_date,
         		v_merchant_id:ind_merchant_id,
         		v_country_id:ind_country_id,
         		v_currency_id:ind_currency_id,
         		v_psp_id:ind_psp_id,
         		v_bucket_type:ind_bucket_type,
         		v_service_code:ind_service_code,
         		v_bal:ind_bal,
         		v_t1_date:ind_t1_date,
         		v_t1_amount:ind_t1_amount,
			v_t2_date:ind_t2_date,
         		v_t2_amount:ind_t2_amount;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }


		if((ind_t1_date<0)||(ind_t2_date<0)){
			iUpdate=PD_FALSE;

			myHash = (hash_t*) malloc (sizeof(hash_t));
			hash_init(myHash,0);

			PutField_CString(myHash,"cutoff_date",csCutoffDate);

/* posting_date */
			if (ind_posting_date >= 0){
				v_posting_date.arr[v_posting_date.len]='\0';
				PutField_CString(myHash,"posting_date",v_posting_date.arr);
DEBUGLOG(("Process Bucket: posting_date =[%.*s]\n",v_posting_date.len,v_posting_date.arr));
			}

/* merchant_id */
			if (ind_merchant_id >= 0 ){
				v_merchant_id.arr[v_merchant_id.len]='\0';
				PutField_CString(myHash,"merchant_id",v_merchant_id.arr);
DEBUGLOG(("Process Bucket: merchant_id =[%.*s]\n",v_merchant_id.len,v_merchant_id.arr));
			}

/* country_id */
			if (ind_country_id >= 0 ){
				v_country_id.arr[v_country_id.len]='\0';
				PutField_CString(myHash,"country_id",v_country_id.arr);
DEBUGLOG(("Process Bucket: country_id =[%.*s]\n",v_country_id.len,v_country_id.arr));
			}

/* currency_id */
			if (ind_currency_id >= 0 ){
				v_currency_id.arr[v_currency_id.len]='\0';
				PutField_CString(myHash,"currency_id",v_currency_id.arr);
DEBUGLOG(("Process Bucket: currency_id =[%.*s]\n",v_currency_id.len,v_currency_id.arr));
			}

/* psp_id */
			if (ind_psp_id >= 0 ){
				v_psp_id.arr[v_psp_id.len]='\0';
				PutField_CString(myHash,"psp_id",v_psp_id.arr);
DEBUGLOG(("Process Bucket: psp_id =[%.*s]\n",v_psp_id.len,v_psp_id.arr));
			}

/* bucket_type */
			if (ind_bucket_type >= 0 ){
				v_bucket_type.arr[v_bucket_type.len]='\0';
				PutField_CString(myHash,"bucket_type",v_bucket_type.arr);
DEBUGLOG(("Process Bucket: bucket_type =[%.*s]\n",v_bucket_type.len,v_bucket_type.arr));
			}

/* service_code */
			if (ind_service_code >= 0 ){
				v_service_code.arr[v_service_code.len]='\0';
				PutField_CString(myHash,"service_code",v_service_code.arr);
DEBUGLOG(("Process Bucket: service_code =[%.*s]\n",v_service_code.len,v_service_code.arr));
			}

/* bal */
			if (ind_bal >= 0 ){
				PutField_Double(myHash,"bal",v_bal);
DEBUGLOG(("Process Bucket: bal =[%f]\n",v_bal));
			}

/* t1_amount */
			if (ind_t1_amount >= 0 ){
				PutField_Double(myHash,"t1_amt",v_t1_amount);
DEBUGLOG(("Process Bucket: t1_amount =[%f]\n",v_t1_amount));
			}

/* t2_amount */
			if (ind_t2_amount >= 0 ){
				PutField_Double(myHash,"t2_amt",v_t2_amount);
DEBUGLOG(("Process Bucket: t2_amount =[%f]\n",v_t2_amount));
			}

/* t1_date */
			if (ind_t1_date >= 0 ){
				v_t1_date.arr[v_t1_date.len]='\0';
				PutField_CString(myHash,"t1_date",v_t1_date.arr);
DEBUGLOG(("Process Bucket: t1_date =[%.*s]\n",v_t1_date.len,v_t1_date.arr));

				if(strncmp(v_t1_date.arr,hv_cutoff_date.arr,hv_cutoff_date.len)<0){

					iRet = find_t1t2_date(PD_T2_STATE,myHash);
					if(iRet==PD_NOT_FOUND){
						iRet = PD_OK;
						continue;
					}
					if(GetField_CString(myHash,"t2_date",&csTmp)){
						if(strncmp(csTmp,hv_cutoff_date.arr,hv_cutoff_date.len)==0){
							iRet = find_t1t2_amount(PD_T2_STATE,myHash);
							if(iRet==PD_OK){
								iRet = process_t1t2_release(PD_T2_STATE,myHash);
								iUpdate=PD_TRUE;
							}
						}
					}
				}

			}
			else{
				iRet = find_t1t2_date(PD_T1_STATE,myHash);
				if(iRet==PD_NOT_FOUND){
					iRet = PD_OK;
					continue;
				}
				if(GetField_CString(myHash,"t1_date",&csTmp)){
					if(strncmp(csTmp,hv_cutoff_date.arr,hv_cutoff_date.len)==0){
						iRet = find_t1t2_amount(PD_T1_STATE,myHash);
						if(iRet==PD_OK){
							iRet = process_t1t2_release(PD_T1_STATE,myHash);
							iUpdate=PD_TRUE;
						}
					}
				}
			}


			if((iRet==SUCCESS) && (iUpdate==PD_TRUE)){

				DBObjPtr = CreateObj(DBPtr,"DBMerchantBucket","UpdateReleaseDetails");
				iRet = (unsigned long)(DBObjPtr)(myHash);
				if(iRet!=PD_OK){
DEBUGLOG(("Process Bucket: UpdateReleaseDetails Failed\n"));
ERRLOG("handle_daily_float::Process Bucket: UpdateReleaseDetails Failed\n");
				}
				else{
DEBUGLOG(("Process Bucket: UpdateReleaseDetails Success\n"));
				}
			}


			FREE_ME(myHash);
		}
 	}
	while(PD_TRUE && (iRet ==SUCCESS));

        EXEC SQL CLOSE c_cursor_get_bucket;

	if(iRet==SUCCESS){
DEBUGLOG(("Process Bucket Normal Exit\n"));
	}
	else{
DEBUGLOG(("Process Bucket Error[%d]\n",iRet));
	}
        return iRet;

sql_error:
    DEBUGLOG(("process_bucket error code %d\n", sqlca.sqlcode));
    DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    ERRLOG("handle_daily_float::process_bucket sql error %d\n", sqlca.sqlcode);
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_get_bucket;
    EXEC SQL ROLLBACK RELEASE;
    return FAILURE;
}






int find_t1t2_date(const int iIndex, hash_t *myHash)
{
	int iRet = SUCCESS;
	char *csDate;
	char csNewDate[PD_DATE_LEN + 1];
	char *csPsp;
	char *csCountry;
	int iT1Period=0;
	int iT2Period=0;
	int i;

DEBUGLOG(("*****find_t1t2_date start*****\n"));
	
	GetField_CString(myHash,"posting_date",&csDate);
	GetField_CString(myHash,"psp_id",&csPsp);
	GetField_CString(myHash,"country_id",&csCountry);

	//iT1Period = get_psp_release_period(csCountry,csPsp);
	//if(iT1Period==0){

	DBObjPtr = CreateObj(DBPtr,"DBRulePspReleasePeriod","Find");
	if((unsigned long)(*DBObjPtr)(csCountry,csPsp,&iT1Period)==PD_ERR){
		return FAILURE;
	}
	//else if(iT1Period==PD_NOT_FOUND){
	//	return PD_NOT_FOUND;
	//}
	else{
		iT2Period = iT1Period+1;
	}
	

	if(iIndex==PD_T1_STATE){

		i = iT1Period;
		do{		
			addday(csDate,i,csNewDate);

			i ++;
		}while((is_holidays(csCountry,csNewDate)==PD_TRUE)||(is_weekend(csNewDate)==PD_TRUE));

		PutField_CString(myHash,"t1_date",csNewDate);
DEBUGLOG(("Psp[%s]: T1 release date is [%s]\n",csPsp,csNewDate));
	}
	else{
		if(GetField_CString(myHash,"t1_date",&csDate)){

			i = iT2Period-iT1Period;
			do{
				addday(csDate,i,csNewDate);

				i ++;
			}while(is_holidays(csCountry,csNewDate)==PD_TRUE);

			PutField_CString(myHash,"t2_date",csNewDate);
DEBUGLOG(("Psp[%s]: T2 release date is [%s]\n",csPsp,csNewDate));
		}
		else{
			iRet = FAILURE;
DEBUGLOG(("Failed to find T2 release date\n"));
		}
	}

	return iRet;
}





int find_t1t2_amount(const int iIndex, hash_t *myHash)
{

	int iRet = SUCCESS;
	int i=0;
	char *csTmp;
	char *csMerchantId;
	char *csCcy;
	char *csCountry;
	char *csServiceCode;
	char csTag[PD_TAG_LEN +1];
	double dTmp;
	double dAmt=0;
	double dBal;
	double dHold=0;
	double dHoldRemain=0;
	double dRemainPayout=0;
	double dReservedPayout=0;
	double dPayoutBal=0;
	double dMinPayoutBal=0;
	hash_t  *hRec;

	recordset_t     *rRecordSet;
	rRecordSet = (recordset_t*) malloc (sizeof(recordset_t));
	recordset_init(rRecordSet,0);

DEBUGLOG(("*****find_t1t2_amount start*****\n"));


	GetField_CString(myHash,"merchant_id",&csMerchantId);
	GetField_CString(myHash,"country_id",&csCountry);
	GetField_CString(myHash,"currency_id",&csCcy);
	GetField_CString(myHash,"service_code",&csServiceCode);

	if(iIndex==PD_T1_STATE){
		GetField_Double(myHash,"bal",&dBal);
DEBUGLOG(("bal=[%f]\n",dBal));
	}
	else if(iIndex==PD_T2_STATE){
		GetField_Double(myHash,"t2_amt",&dBal);
DEBUGLOG(("t2_amt=[%f]\n",dBal));
						
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetAviBalanceForPayout");
		if((unsigned long)(*DBObjPtr)(csMerchantId,csCcy,csCountry,csServiceCode,&dPayoutBal)==PD_ERR){
			iRet = FAILURE;
		}
DEBUGLOG(("GetAviBalanceForPayout=[%f]\n",dPayoutBal));
		if(dPayoutBal>dMinPayoutBal){
			dRemainPayout = dPayoutBal - dMinPayoutBal;
			dReservedPayout = dMinPayoutBal;
DEBUGLOG(("RemainPayout=[%f]  ReservedPayout=[%f]\n",dRemainPayout,dReservedPayout));
		}
		else{
			dRemainPayout = 0;
			dReservedPayout = dPayoutBal;
DEBUGLOG(("RemainPayout=[%f]  ReservedPayout=[%f]\n",dRemainPayout,dReservedPayout));
		}
	}

	if(iRet == SUCCESS){
////check hold amount
		DBObjPtr = CreateObj(DBPtr,"DBHoldAmount","GetAllHold");
DEBUGLOG(("Call HoldAmount:GetAllHold\n"));
		if ((unsigned long)(*DBObjPtr)(csMerchantId,csCountry,csCcy,csServiceCode,rRecordSet) == PD_OK) {
			hRec = RecordSet_GetFirst(rRecordSet);
			while(hRec){
				if(GetField_CString(hRec,"hold_type",&csTmp)){
DEBUGLOG(("HoldAmount:GetAllHold hold_type = [%s]\n",csTmp));
					sprintf(csTag,"hold_type_%d",i);
					PutField_CString(myHash,csTag,csTmp);
				}
				if(GetField_Double(hRec,"total_hold",&dTmp)){
DEBUGLOG(("HoldAmount:GetAllHold total_hold = [%f]\n",dTmp));
				}
				if(GetField_Double(hRec,"holded_amt",&dTmp)){
					sprintf(csTag,"org_holded_amt_%d",i);
					PutField_Double(myHash,csTag,dTmp);
DEBUGLOG(("HoldAmount:GetAllHold holded_amt = [%f]\n",dTmp));
				}
				if(GetField_Double(hRec,"hold_remain",&dHoldRemain)){
DEBUGLOG(("HoldAmount:GetAllHold hold_remain = [%f]\n",dHoldRemain));
					sprintf(csTag,"holded_amt_%d",i);
					if(dBal>=dHoldRemain){
						PutField_Double(myHash,csTag,dHoldRemain);
						dBal -= dHoldRemain;
						dHold += dHoldRemain;
DEBUGLOG(("Bal>=HoldRemain, Bal[%f] Hold[%f]\n",dBal,dHold));
					}
					else{
						dHold += dBal;
						dHoldRemain -= dBal;
DEBUGLOG(("Bal<HoldRemain, Hold[%f] Hold Remain\n",dHold,dHoldRemain));

						if(dRemainPayout>=dHoldRemain){
							PutField_Double(myHash,csTag,dHoldRemain+dBal);
							dRemainPayout -= dHoldRemain;
							dHold += dHoldRemain;
DEBUGLOG(("RemainPayout>=HoldRemain, RemainPayout[%f] Hold[%f]\n",dRemainPayout,dHold));
						}
						else{
							dHold += dRemainPayout;
							dHoldRemain -= dRemainPayout;
							PutField_Double(myHash,csTag,dRemainPayout+dBal);
							dRemainPayout = 0;
DEBUGLOG(("RemainPayout<HoldRemain, HoldRemain[%f] Hold[%f]\n",dHoldRemain,dHold));
						}
						dBal = 0;
					}
				}
				i++;
				hRec = RecordSet_GetNext(rRecordSet);
			}
			PutField_Int(myHash,"hold_count",i);
		}

	}

////////////

	if(iIndex==PD_T1_STATE){
		GetField_CString(myHash,"psp_id",&csTmp);
///hard code
		dAmt=1000;

DEBUGLOG(("Psp[%s]: Max. Release Amount[%f]\n",csTmp,dAmt));

		if((dBal<dAmt) || (dAmt==0))
			dTmp = dBal;
		else
			dTmp = dAmt;

		PutField_Double(myHash,"t1_amt",dTmp);
DEBUGLOG(("T1 Release Amount[%f]\n",dTmp));
		
		PutField_Double(myHash,"t2_amt",(dBal-dTmp));
DEBUGLOG(("T2 Release Amount[%f] (temp)\n",dBal-dTmp));
	}

	if(iIndex==PD_T2_STATE){
		PutField_Double(myHash,"t2_amt",dBal);
DEBUGLOG(("T2 Release Amount (f->s)[%f]\n",dBal));

		PutField_Double(myHash,"remain_payout",dRemainPayout);
DEBUGLOG(("T2 Release Amount (p->s)[%f]\n",dRemainPayout));

		PutField_Double(myHash,"reserved_payout",dReservedPayout);
DEBUGLOG(("T2 Reserved Payout Amount[%f]\n",dReservedPayout));
	}



	RecordSet_Destroy(rRecordSet);
	FREE_ME(rRecordSet);
	return iRet;

}




int process_t1t2_release(const int iIndex,hash_t *myHash)
{
	int iRet = PD_OK;
	char	*csMerchantId;
	char	*csCcyId;
	char	*csCountry;
	char	*csServiceCode;
	char	*csTmp;
	hash_t	*hTxn;
	hash_t	*hUpd;
	double	dPayoutBal=0;
	double	dPayoutReserved=0;
	double	dSettleBal;
	double	dOrgHolded;
	double	dHolded;
	int	iTmp,i;
	char csTag[PD_TAG_LEN +1];

	hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);

DEBUGLOG(("*****process_t1t2_release start*****\n"));

	if(GetField_CString(myHash,"merchant_id",&csMerchantId)){
		PutField_CString(hTxn,"merchant_id",csMerchantId);
	}
	if(GetField_CString(myHash,"currency_id",&csCcyId)){
		PutField_CString(hTxn,"currency_id",csCcyId);
	}
	if(GetField_CString(myHash,"country_id",&csCountry)){
		PutField_CString(hTxn,"country_id",csCountry);
	}
	if(GetField_CString(myHash,"service_code",&csServiceCode)){
		PutField_CString(hTxn,"service_code",csServiceCode);
	}
	if(GetField_CString(myHash,"cutoff_date",&csTmp)){
		PutField_CString(hTxn,"cutoff_date",csTmp);
	}


	PutField_Int(hTxn,"state",iIndex);

	if(iIndex==PD_T1_STATE){
		if(GetField_Double(myHash,"t1_amt",&dPayoutBal)){
			PutField_Double(hTxn,"txn_amt",dPayoutBal);
		}
DEBUGLOG(("process_t1t2_release DBMerchantBalance->ReleasePayoutBal\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","ReleasePayoutBal");
		iRet = (unsigned long)(DBObjPtr)(csMerchantId,csCountry,csCcyId,csServiceCode,dPayoutBal,PD_UPDATE_USER);
	}
	else{
		GetField_Double(myHash,"t2_amt",&dSettleBal);
DEBUGLOG(("t2_amt = [%f]\n",dSettleBal));
		GetField_Double(myHash,"remain_payout",&dPayoutBal);
DEBUGLOG(("remain_payout = [%f]\n",dPayoutBal));
		GetField_Double(myHash,"reserved_payout",&dPayoutReserved);
DEBUGLOG(("reserved_payout = [%f]\n",dPayoutReserved));

		PutField_Double(hTxn,"txn_amt",dSettleBal+dPayoutBal);

DEBUGLOG(("process_t1t2_release DBMerchantBalance->ReleaseSettlementBal\n"));
		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","ReleaseSettlementBal");
		iRet = (unsigned long)(DBObjPtr)(csMerchantId,csCountry,csCcyId,csServiceCode,
						dSettleBal,dPayoutBal,dPayoutReserved,PD_UPDATE_USER);
	}

	if(iRet==PD_OK){
		hUpd = (hash_t*) malloc (sizeof(hash_t));
                hash_init(hUpd,0);

		PutField_CString(hUpd,"merchant_id",csMerchantId);
                PutField_CString(hUpd,"country_id",csCountry);
                PutField_CString(hUpd,"ccy_id",csCcyId);
                PutField_CString(hUpd,"service_code",csServiceCode);

		if(GetField_Int(myHash,"hold_count",&iTmp)){
			for(i=0;i<iTmp;i++){
				sprintf(csTag,"hold_type_%d",i);
				GetField_CString(myHash,csTag,&csTmp);

				sprintf(csTag,"org_holded_amt_%d",i);
				GetField_Double(myHash,csTag,&dOrgHolded);

				sprintf(csTag,"holded_amt_%d",i);
				GetField_Double(myHash,csTag,&dHolded);

//////udpate HoldAmount table
				DBObjPtr = CreateObj(DBPtr,"DBHoldAmount","UpdateHoldAmount");
				iRet = (unsigned long)(DBObjPtr)(csMerchantId,csCountry,
								csCcyId,csServiceCode,
								csTmp,dHolded,PD_UPDATE_USER);
				if(iRet==PD_OK){
DEBUGLOG(("DBHoldAmount::UpdateHoldAmount[%s] Success\n",csTmp));
				}	
/////update MerchantBalance table
				if(!strncmp(csTmp,PD_HOLD_PAYOUT,PD_HOLD_TYPE_LEN)){
					PutField_Double(hUpd,"payout_hold",dOrgHolded+dHolded);
DEBUGLOG(("hold_type[%s] org_holded_amt[%f] holded_amt[%f]\n",csTmp,dOrgHolded,dHolded));
				}
				else if(!strncmp(csTmp,PD_HOLD_SETTLEMENT,PD_HOLD_TYPE_LEN)){
					PutField_Double(hUpd,"settlement_hold",dOrgHolded+dHolded);
DEBUGLOG(("hold_type[%s] org_holded_amt[%f] holded_amt[%f]\n",csTmp,dOrgHolded,dHolded));
				}

				DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateBalanceAndHold");
				if((unsigned long)(*DBObjPtr)(hUpd)!=PD_OK){
DEBUGLOG(("process_t1t2_release : DBMerchantBalance::UpdateBalanceAndHold Failed\n"));
					iRet = PD_ERR;
				}

				DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","UpdateFloat");
				if ((*DBObjPtr)(csMerchantId,
                                		csCountry,
                                		csCcyId,
						csServiceCode,
						-dHolded,
						PD_UPDATE_USER) != PD_OK) {
					iRet = PD_ERR;
DEBUGLOG(("process_t1t2_release : DBMerchantBalance::UpdateFloat Failed\n"));
                		}
			}
		}

		FREE_ME(hUpd);
	}

	
	if(iRet==PD_OK){
		PutField_Char(hTxn,"status",PD_COMPLETE);
		PutField_Char(hTxn,"ar_ind",PD_ACCEPT);

		DBObjPtr = CreateObj(DBPtr,"DBMerchantBalance","GetCurrentValues");
		if ((*DBObjPtr)(csMerchantId,csCcyId,csCountry,csServiceCode,hTxn)!=PD_OK){
DEBUGLOG(("DBMerchantBalance::GetCurrentValues Failed\n"));
		}

		iRet = AddTxnLog(hTxn);
	}

	if(iRet==PD_OK){
DEBUGLOG(("process_t1t2_release Normal Exit\n"));
	}	
	else{
DEBUGLOG(("process_t1t2_release Error[%d]\n",iRet));
ERRLOG("handle_daily_float::process_t1t2_release Error[%d]\n",iRet);
	}

	FREE_ME(hTxn);
	return iRet;
}


int is_weekend(const char* csDate)
{
	int iRet = PD_FALSE;
	int iDow;

	iDow = day_of_week(csDate);
DEBUGLOG(("is_weekend: date[%s] day of week [%d]\n",csDate,iDow));
	if((iDow==0)||(iDow==6)){
		iRet = PD_TRUE;
	}

	return iRet;
}

int is_holidays(const char* csCountry, const char* csDate)
{
	int iRet = PD_FALSE;

	EXEC SQL WHENEVER SQLERROR GOTO is_error;
	EXEC SQL WHENEVER NOTFOUND CONTINUE;

	EXEC SQL BEGIN DECLARE SECTION;

		varchar	hv_country[PD_COUNTRY_LEN];
		varchar	hv_date[PD_DATE_LEN];

		varchar	v_desc[PD_DESC_LEN + 1];

		short	ind_desc = -1;

	EXEC SQL END DECLARE SECTION;

	hv_date.len = strlen(csDate);
        memcpy(hv_date.arr,csDate,hv_date.len);
DEBUGLOG(("is_holidays date = [%.*s]\n",hv_date.len,hv_date.arr));

	hv_country.len = strlen(csCountry);
        memcpy(hv_country.arr,csCountry,hv_country.len);
DEBUGLOG(("is_holidays country = [%.*s]\n",hv_country.len,hv_country.arr));

	EXEC SQL EXECUTE
	BEGIN
		select	h_desc
		into	:v_desc:ind_desc
		from	holiday
		where	h_date=:hv_date
		and	h_country=:hv_country;

	END;
	END-EXEC;

	if(ind_desc>=0){
DEBUGLOG(("Holiday!! [%.*s]\n",v_desc.len,v_desc.arr));
		iRet = PD_TRUE;
	}
	else{
DEBUGLOG(("Not a holiday\n"));
	}

	return iRet;

is_error:
    DEBUGLOG(("is_holidays error code %d\n", sqlca.sqlcode));
    DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    ERRLOG("handle_daily_float::is_holidays error code %d\n", sqlca.sqlcode);
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL ROLLBACK RELEASE;
    return FAILURE;
}


int parse_arg(int argc,char **argv)
{
        char    c;
	strcpy(cs_cutoff_date,"");

        while ((c = getopt(argc,argv,"d:")) != EOF) {
                switch (c) {
                        case 'd':
                                strcpy(cs_cutoff_date, optarg);
                                break;
                        default:
                                return FAILURE;
                }
        }

        if (!strcmp(cs_cutoff_date,"")) 
                return FAILURE;

        return SUCCESS;
}


int AddTxnLog(const hash_t* hVal)
{
	int 	iRet = PD_OK;
	char	csTxnSeq[PD_TXN_SEQ_LEN+1];
	char	*csTmp;
	char	cTmp;
	double	dTmp;
	int	iTmp;

	hash_t	*hTxn;
	hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn,0);


	DBObjPtr = CreateObj(DBPtr,"DBTxnSeq","GetNextTxnSeq");
        strcpy(csTxnSeq,(*DBObjPtr)());
        csTxnSeq[strlen(csTxnSeq)]='\0';
	PutField_CString(hTxn,"txn_seq",csTxnSeq);
DEBUGLOG(("AddTxnLog:: txn_id = [%s]\n",csTxnSeq));
	
	if(GetField_CString(hVal,"cutoff_date",&csTmp)){
		PutField_CString(hTxn,"host_posting_date",csTmp);
DEBUGLOG(("AddTxnLog:: host_posting_date = [%s]\n",csTmp));
	}

	if(GetField_CString(hVal,"merchant_id",&csTmp)){
		PutField_CString(hTxn,"merchant_id",csTmp);
DEBUGLOG(("AddTxnLog:: merchant_id = [%s]\n",csTmp));
	}

	if(GetField_Int(hVal,"state",&iTmp)){
		if(iTmp==PD_T1_STATE){
			PutField_CString(hTxn,"txn_code","T1R");
DEBUGLOG(("AddTxnLog:: txn_code = [T1S]\n"));
		}
		else if(iTmp==PD_T2_STATE){
			PutField_CString(hTxn,"txn_code","T2R");
DEBUGLOG(("AddTxnLog:: txn_code = [T2S]\n"));
		}
	}

	PutField_CString(hTxn,"add_user",PD_UPDATE_USER);
	PutField_CString(hTxn,"process_type","0000");
	PutField_CString(hTxn,"process_code","000000");
	PutField_CString(hTxn,"channel_code","WEB");

	if(GetField_CString(hVal,"currency_id",&csTmp)){
		PutField_CString(hTxn,"txn_ccy",csTmp);
DEBUGLOG(("AddTxnLog:: txn_ccy = [%s]\n",csTmp));
	}

	if(GetField_CString(hVal,"country_id",&csTmp)){
		PutField_CString(hTxn,"txn_country",csTmp);
DEBUGLOG(("AddTxnLog:: txn_country = [%s]\n",csTmp));
	}

	if(GetField_CString(hVal,"service_code",&csTmp)){
		PutField_CString(hTxn,"service_code",csTmp);
DEBUGLOG(("AddTxnLog:: service_code = [%s]\n",csTmp));
	}

	if(GetField_Char(hVal,"status",&cTmp)){
		PutField_Char(hTxn,"status",cTmp);
DEBUGLOG(("AddTxnLog:: status = [%c]\n",cTmp));
	}

	if(GetField_Char(hVal,"ar_ind",&cTmp)){
		PutField_Char(hTxn,"ar_ind",cTmp);
DEBUGLOG(("AddTxnLog:: ar_ind = [%c]\n",cTmp));
	}

	if(GetField_Double(hVal,"txn_amt",&dTmp)){
		PutField_Double(hTxn,"txn_amt",dTmp);
DEBUGLOG(("AddTxnLog:: txn_amt = [%f]\n",dTmp));
	}

	if(GetField_Double(hVal,"payout_bal",&dTmp)){
		PutField_Double(hTxn,"payout_bal",dTmp);
DEBUGLOG(("AddTxnLog:: payout_bal = [%f]\n",dTmp));
	}

	if(GetField_Double(hVal,"settlement_bal",&dTmp)){
		PutField_Double(hTxn,"settlement_bal",dTmp);
DEBUGLOG(("AddTxnLog:: settlement_bal = [%f]\n",dTmp));
	}

	if(GetField_Double(hVal,"total_float",&dTmp)){
		PutField_Double(hTxn,"total_float",dTmp);
DEBUGLOG(("AddTxnLog:: total_float = [%f]\n",dTmp));
	}

	if(GetField_Double(hVal,"total_reserved_amount",&dTmp)){
		PutField_Double(hTxn,"total_reserved_amount",dTmp);
DEBUGLOG(("AddTxnLog:: total_reserved_amount = [%f]\n",dTmp));
	}

	if(GetField_Double(hVal,"total_tfr_hold",&dTmp)){
		PutField_Double(hTxn,"total_tfr_hold",dTmp);
DEBUGLOG(("AddTxnLog:: total_tfr_hold = [%f]\n",dTmp));
	}

	if(GetField_Double(hVal,"total_payout_hold",&dTmp)){
		PutField_Double(hTxn,"total_payout_hold",dTmp);
DEBUGLOG(("AddTxnLog:: total_payout_hold = [%f]\n",dTmp));
	}

	if(GetField_Double(hVal,"total_settlement_hold",&dTmp)){
		PutField_Double(hTxn,"total_settlement_hold",dTmp);
DEBUGLOG(("AddTxnLog:: total_settlement_hold = [%f]\n",dTmp));
	}

	if(GetField_Double(hVal,"payout_in_transit",&dTmp)){
		PutField_Double(hTxn,"payout_in_transit",dTmp);
DEBUGLOG(("AddTxnLog:: payout_in_transit = [%f]\n",dTmp));
	}

	if(GetField_Double(hVal,"settlement_in_transit",&dTmp)){
		PutField_Double(hTxn,"settlement_in_transit",dTmp);
DEBUGLOG(("AddTxnLog:: settlement_in_transit = [%f]\n",dTmp));
	}


	DBObjPtr = CreateObj(DBPtr,"DBTransaction","Add");
	iRet = (unsigned long) ((*DBObjPtr)(hTxn));
	
	if(iRet==PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","AddDetail");
		iRet = (unsigned long) ((*DBObjPtr)(hTxn));
	}

	if(iRet==PD_OK){
		DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
		iRet = (unsigned long) ((*DBObjPtr)(hTxn));
	}

DEBUGLOG(("AddTxnLog:: iRet = [%d]\n",iRet));

	FREE_ME(hTxn);
	return iRet;
}

