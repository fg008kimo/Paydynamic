/*
PDProTech (c)2021. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2021/03/01              [WMC]
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "batchcommon.h"
#include "common.h"
#include "utilitys.h"
#include "myhash.h"
#include "numutility.h"
#include "myrecordset.h"
#include "ObjPtr.h"
#include "internal.h"
#include "dbutility.h"

#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

#define PD_DATA_DELIMITOR              	","
#define PD_MAX_FIELD			9

#define IDX_PSP_ID                   	0
#define IDX_TXN_COUNTRY              	1	
#define IDX_TXN_CCY              	2
#define IDX_TXN_COUNT              	3	
#define IDX_TXN_AMOUNT               	4
#define IDX_PAID_AMOUNT               	5
#define IDX_SERVICE_FEE               	6
#define IDX_PSP_TXN_DATE		7
#define IDX_REPORT_DATE			8

char cs_input_file[PD_TMP_BUF_LEN + 1];

static char cDebug = 'Y';

OBJPTR(DB);
OBJPTR(BO);
OBJPTR(Txn);
OBJPTR(Channel);

int parse_arg(int argc, char **argv);
int process_main();

int batch_init(int argc, char* argv[])
{
	return SUCCESS;
}

int batch_proc(int argc, char* argv[])
{
	int iRet = SUCCESS;
	int iDtlRet = PD_OK;

//DEBUGLOG(("batch_proc()\n"));

	iRet = parse_arg(argc, argv);
	if (iRet != SUCCESS) {
		printf("*usage: -f input_file\n");
                return FAILURE;
	}

	iDtlRet = process_main();
	if (iDtlRet != PD_OK) {
		iRet = FAILURE;
	}

//DEBUGLOG(("batch_proc() iRet = [%d]\n", iRet));
	return iRet;
}

int batch_terminate(int argc, char* argv[])
{
	return SUCCESS;
}

int parse_arg(int argc, char **argv)
{
	char    c;
	strcpy(cs_input_file, "");

        if (argc < 2) {
DEBUGLOG(("argc = [%d]\n",argc));
                return FAILURE;
        }

        while ((c = getopt(argc,argv,"f:")) != EOF) {
                switch (c) {
                        case 'f':
                                strcpy(cs_input_file, optarg);
                                break;
                        default:
                                return FAILURE;
                }
        }

	if (!strcmp(cs_input_file, ""))
                return FAILURE;

        return SUCCESS;
}

int process_main()
{
	int iRet = PD_OK;
	int iPspCnt = 0;
        FILE *fproc;
	char csPHDate[PD_DATETIME_LEN +1];
        char cs_input_buf[PD_MAX_BUFFER + 1];

	hash_t *hPspDetail;
        hPspDetail = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hPspDetail, 0);

	hash_t *hPspBal;
        hPspBal = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hPspBal, 0);

	hash_t *hTxn;
        hTxn = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxn, 0);

	hash_t *hTxnElem;
        hTxnElem = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hTxnElem, 0);
	
	hash_t *hPspReconHist;
        hPspReconHist = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hPspReconHist, 0);

	recordset_t *rPspReconHist;
        rPspReconHist = (recordset_t*) malloc (sizeof(recordset_t));
        recordset_init(rPspReconHist, 0);

DEBUGLOG(("process_main()\n"));

	memset(csPHDate, 0, sizeof(csPHDate));
	memset(cs_input_buf, 0, sizeof(cs_input_buf));

	// Get System Control PHDate
        DBObjPtr = CreateObj(DBPtr,"DBSystemControl","FindCode");
        if ((unsigned long)(*DBObjPtr)("CTPHDATE",csPHDate) != FOUND) {
DEBUGLOG(("batch_proc: Call DBSystemControl: FindCode() No Record Found!!\n"));
ERRLOG("Internalte_psp_bal_trf_adhoc: batch_proc: Call DBSystemControl: FindCode() No Record Found!!\n");
                return PD_ERR;
        }

	fproc = fopen(cs_input_file, "r");
        if (fproc == NULL) {
DEBUGLOG(("batch_proc: Error opening file = [%s]\n", cs_input_file));
ERRLOG("void_recon: batch_proc: Error opening file = [%s]\n", cs_input_file);
                return PD_ERR;
        }

        while ((iRet == PD_OK) && (fgets(cs_input_buf, PD_MAX_BUFFER, fproc) != NULL)) {
DEBUGLOG(("++++++++++++++++++++++++++++++++++++++++++++++++++\n"));

		int	iFieldCnt = 0;
		int	iCnt = 0;
		int	iTxnCnt = 0;

		double	dTxnAmt = 0.0;
		double	dPaidAmt = 0.0;
		double	dNetAmt = 0.0;
		double	dFee = 0.0;
		double	dPtr = 0.0;

		char    *p;
		char    csList[PD_MAX_FIELD][PD_TMP_BUF_LEN];
		char    csTxnSeq[PD_TXN_SEQ_LEN + 1];

		char 	*csPspId = (char*) malloc (PD_PSP_ID_LEN+1);
		char 	*csTxnCountry = (char*) malloc (PD_COUNTRY_LEN+1);
		char 	*csTxnCcy = (char*) malloc (PD_CCY_ID_LEN+1);
		char 	*csPspTxnDate = (char*) malloc (PD_DATE_LEN+1);
		char 	*csReportDate = (char*) malloc (PD_DATE_LEN+1);

		char    csTxnDateTime[PD_DATETIME_LEN+1];
		char    csTmDate[PD_DATE_LEN+1];
        	char    csTmTime[PD_TIME_LEN+1];

		memset(csTxnDateTime, 0, sizeof(csTxnDateTime));
		memset(csTmDate, 0, sizeof(csTmDate));
		memset(csTmTime, 0, sizeof(csTmTime));
	
		cs_input_buf[strlen(cs_input_buf) - 1] = '\0';

		// Breakdown the data
              	p = mystrtok(cs_input_buf,PD_DATA_DELIMITOR);
             	if (p == NULL) {
                   	iRet = PD_ERR;
               	} else {
                    	strcpy(csList[iFieldCnt],p);
                    	iFieldCnt++;

                      	while ((p = mystrtok(NULL,PD_DATA_DELIMITOR)) != NULL) {
                       		if (iFieldCnt < PD_MAX_FIELD) {
                                    	strcpy(csList[iFieldCnt],p);
                                       	iFieldCnt++;
                    		} else {
                                      	iFieldCnt = PD_MAX_FIELD;
                              	}
                     	}
           	}

		for (iCnt=0;iCnt<iFieldCnt;iCnt++) {
//DEBUGLOG(("process_main: [%d]csList[%d] = [%s]\n", iPspCnt, iCnt, csList[iCnt]));		

			if (iCnt == IDX_PSP_ID) {
				strcpy(csPspId,csList[IDX_PSP_ID]);
DEBUGLOG(("process_main: [%d]psp_id = [%s]\n", iPspCnt, csPspId));
			} else if (iCnt == IDX_TXN_COUNTRY) {
                               strcpy(csTxnCountry,csList[IDX_TXN_COUNTRY]);
DEBUGLOG(("process_main: [%d]txn_country = [%s]\n", iPspCnt, csTxnCountry));
			} else if (iCnt == IDX_TXN_CCY) {
                               strcpy(csTxnCcy,csList[IDX_TXN_CCY]);
DEBUGLOG(("process_main: [%d]txn_ccy = [%s]\n", iPspCnt, csTxnCcy));
			} else if (iCnt == IDX_TXN_COUNT) {
                                iTxnCnt = atoi(csList[IDX_TXN_COUNT]);
DEBUGLOG(("process_main: [%d]txn_count = [%d]\n", iPspCnt, iTxnCnt));
			} else if (iCnt == IDX_TXN_AMOUNT) {
				dTxnAmt = string2double((const unsigned char *)csList[IDX_TXN_AMOUNT]);
DEBUGLOG(("process_main: [%d]txn_amt = [%lf]\n", iPspCnt, dTxnAmt));				
			} else if (iCnt == IDX_PAID_AMOUNT) {
				dPaidAmt = string2double((const unsigned char *)csList[IDX_PAID_AMOUNT]);
DEBUGLOG(("process_main: [%d]paid_amt = [%lf]\n", iPspCnt, dPaidAmt));
			} else if (iCnt == IDX_SERVICE_FEE) {
                                dFee = string2double((const unsigned char *)csList[IDX_SERVICE_FEE]);
DEBUGLOG(("process_main: [%d]service_fee = [%lf]\n", iPspCnt, dFee));
			} else if (iCnt == IDX_PSP_TXN_DATE) {
				strcpy(csPspTxnDate,csList[IDX_PSP_TXN_DATE]);
DEBUGLOG(("process_main: [%d]psp_txn_date = [%s]\n", iPspCnt, csPspTxnDate));
			} else if (iCnt == IDX_REPORT_DATE) {
			       strcpy(csReportDate,csList[IDX_REPORT_DATE]);
DEBUGLOG(("process_main: [%d]report_date = [%s]\n", iPspCnt, csReportDate));
			}

			dNetAmt = dPaidAmt - dFee;
		}

		// Get PspDetail
		if (iRet == PD_OK) {
DEBUGLOG(("process_main: [%d]Call DBPspDetail: GetPspDetail()\n", iPspCnt));
                        DBObjPtr = CreateObj(DBPtr,"DBPspDetail","GetPspDetail");
                       	if ((unsigned long)(*DBObjPtr)(csPspId, hPspDetail) != PD_OK) {
DEBUGLOG(("process_main: [%d]Call DBPspDetail: GetPspDetail Failure!!\n", iPspCnt));
                                iRet = PD_ERR;
                        }
		}

		// Generate Next Txn Seq
		if (iRet == PD_OK) {
                	DBObjPtr = CreateObj(DBPtr, "DBTxnSeq", "GetNextMgtTxnSeq");
                	strcpy((char*)csTxnSeq, (*DBObjPtr)());
DEBUGLOG(("process_main: [%d]Call DBTxnSeq: GetNextMgtTxnSeq() txn_seq = [%s]\n", iPspCnt, csTxnSeq));
		}

		// Add Txn Log
		if (iRet == PD_OK) {

			PutField_CString(hTxn, "txn_seq", csTxnSeq);
			PutField_CString(hTxn, "channel_code", PD_CHANNEL_MGT);
			PutField_Char(hTxn,"status",PD_PROCESSING);
			PutField_CString(hTxn, "txn_code", PD_PSP_BAL_TRANSFER);
			PutField_CString(hTxn,"process_code", PD_PROCESS_CODE_DEF);
			PutField_CString(hTxn,"process_type", PD_PROCESS_TYPE_DEF);
        	        PutField_CString(hTxn, "PHDATE", csPHDate);
			
			strcpy(csTxnDateTime,getdatetime());
        	        PutField_CString(hTxn, "transmission_datetime", csTxnDateTime);
			
			sprintf(csTmDate,"%.*s",PD_DATE_LEN,csTxnDateTime);
	                PutField_CString(hTxn,"local_tm_date",csTmDate);
	                PutField_CString(hTxn,"tm_date",csTmDate);
			PutField_CString(hTxn,"PHDATE",csPHDate);

                	sprintf(csTmTime,"%.*s",PD_TIME_LEN,&csTxnDateTime[PD_DATE_LEN]);
                	PutField_CString(hTxn,"local_tm_time",csTmTime);

			PutField_CString(hTxn,"txn_country",csTxnCountry);	
			PutField_CString(hTxn,"txn_ccy",csTxnCcy);
			PutField_CString(hTxn,"net_ccy",csTxnCcy);
			PutField_Double(hTxn, "txn_amt", dTxnAmt);
			PutField_Double(hTxn, "net_amt", dNetAmt);	

			PutField_CString(hTxn,"add_user",PD_UPDATE_USER);
			PutField_CString(hTxn,"update_user",PD_UPDATE_USER);
	
			PutField_Int(hTxn,"do_logging",PD_TRUE);

DEBUGLOG(("process_main: [%d]Call MGTChannel: AddTxnLog()\n", iPspCnt));
	                ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","AddTxnLog");
        	        iRet = (unsigned long)(*ChannelObjPtr)(hTxn,hTxn);
                	if (iRet != PD_OK) {
DEBUGLOG(("process_main: [%d]Call MGTChannel: AddTxnLog Failure!!\n", iPspCnt));
                        	iRet = PD_ERR;
                	}
		}	

		// Get Psp Recon History
/*
		if(iRet == PD_OK){
DEBUGLOG(("process_main: [%d]Call DBPspReconHistory: GetReconHistoryByDate()\n", iPspCnt));
                	BOObjPtr = CreateObj(BOPtr,"DBPspReconHistory","GetReconHistoryByDate");
               		if ((unsigned long)(*BOObjPtr)(csPspId,csTxnCcy,csTxnCountry,csPspTxnDate,rPspReconHist) == PD_FOUND) {
DEBUGLOG(("process_main: [%d]Call DBPspReconHistory: GetReconHistoryByDate() Already Done!!\n", iPspCnt));
                        	iRet = PD_ERR;
                	}
        	}
*/

		// Update Psp Balance "TransferPspBalance"
		if (iRet == PD_OK) {

			PutField_CString(hPspBal, "psp_id", csPspId);			
			PutField_CString(hPspBal, "txn_country", csTxnCountry);			
			PutField_CString(hPspBal, "txn_ccy", csTxnCcy);			
			PutField_Double(hPspBal, "txn_amt", dPaidAmt);			
			PutField_Double(hPspBal, "service_fee", dFee);			
			PutField_Char(hPspBal,"transfer_from",PD_PSP_FLOAT);

DEBUGLOG(("process_main: [%d]Call DBPspBalance: GetBalance()\n", iPspCnt));
			DBObjPtr = CreateObj(DBPtr,"DBPspBalance","GetBalance");
                	if ((unsigned long)(*DBObjPtr)(csPspId,csTxnCountry,csTxnCcy,hPspBal) != PD_OK){
DEBUGLOG(("process_main: [%d]Call DBPspBalance: GetBalance() Failure!!\n", iPspCnt));
                                iRet = PD_ERR;			
			} else {
				if (GetField_Double(hPspBal,"balance",&dPtr)) {
DEBUGLOG(("process_main: [%d]Call DBPspBalance: TransferPspBalance() psp_balance = [%lf]\n",iPspCnt,dPtr));
                                }
                                if (GetField_Double(hPspBal,"total_float",&dPtr)) {
DEBUGLOG(("process_main: [%d]Call DBPspBalance: TransferPspBalance() psp_total_float = [%lf]\n",iPspCnt,dPtr));
                                }
                                if (GetField_Double(hPspBal,"total_hold",&dPtr)) {
DEBUGLOG(("process_main: [%d]Call DBPspBalance: TransferPspBalance() psp_total_hold = [%lf]\n",iPspCnt,dPtr));
                                }
                	}
			
			if (iRet == PD_OK) {
DEBUGLOG(("process_main: [%d]Call BOBalance: TransferPspBalance()\n", iPspCnt));
				BOObjPtr = CreateObj(BOPtr,"BOBalance","TransferPspBalance");
                        	if ((unsigned long) ((*BOObjPtr)(hPspBal,hPspBal)) != PD_OK) {
DEBUGLOG(("process_main: [%d]Call BOBalance: TransferPspBalance() Failure!!\n", iPspCnt));
                        	        iRet = PD_ERR;
                        	} else {
					if (GetField_Double(hPspBal,"psp_balance",&dPtr)) {
                                	        PutField_Double(hTxn,"bal",dPtr);
DEBUGLOG(("process_main: [%d]Call BOBalance: TransferPspBalance() psp_balance = [%lf]\n",iPspCnt,dPtr));
                                	}
                                	if (GetField_Double(hPspBal,"psp_total_float",&dPtr)) {
                                	        PutField_Double(hTxn,"total_float",dPtr);
DEBUGLOG(("process_main: [%d]Call BOBalance: TransferPspBalance() psp_total_float = [%lf]\n",iPspCnt,dPtr));
                                	}
                                	if (GetField_Double(hPspBal,"psp_total_hold",&dPtr)) {
                                	        PutField_Double(hTxn,"total_hold",dPtr);
DEBUGLOG(("process_main: [%d]Call BOBalance: TransferPspBalance() psp_total_hold = [%lf]\n",iPspCnt,dPtr));
                                	}
				}
			}
		}

		// Add Txn Psp Detail
		if (iRet == PD_OK) {
	
			PutField_CString(hTxn, "psp_id", csPspId);	
			PutField_CString(hTxn, "txn_ccy", csTxnCcy);
			PutField_CString(hTxn, "txn_date", csPHDate);
			PutField_CString(hTxn, "desc", "Psp Balance Transfer");

DEBUGLOG(("process_main: [%d]Call DBTxnPspDetail: Add()\n", iPspCnt));
                        DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Add");
                        iRet = (unsigned long)(*DBObjPtr)(hTxn);
                        if (iRet != PD_OK) {
DEBUGLOG(("process_main: [%d]Call DBTransaction: Add() Failure!!\n", iPspCnt));
                                iRet = PD_ERR;
                        }			
		}
		
		// Update Txn Psp Detail
		if (iRet == PD_OK) {

			PutField_Double(hTxn, "paid_amount", dPaidAmt);
			PutField_Double(hTxn, "service_fee", dFee);

DEBUGLOG(("process_main: [%d]Call DBTxnPspDetail: Update()\n", iPspCnt));
                  	DBObjPtr = CreateObj(DBPtr,"DBTxnPspDetail","Update");
                    	iRet = (unsigned long)(*DBObjPtr)(hTxn);
                     	if (iRet != PD_OK) {
DEBUGLOG(("process_main: [%d]Call DBTransaction: Update() Failure!!\n", iPspCnt));
                            	iRet = PD_ERR;
                    	}
		}

		// Update Transaction Detail
		if (iRet == PD_OK) {
DEBUGLOG(("process_main: [%d]Call DBTransaction: UpdateDetail()\n", iPspCnt));
                	DBObjPtr = CreateObj(DBPtr,"DBTransaction","UpdateDetail");
                	iRet = (unsigned long)(*DBObjPtr)(hTxn);
                	if (iRet != PD_OK) {
DEBUGLOG(("process_main: [%d]Call DBTransaction: Update() Failure!!\n", iPspCnt));
                        	iRet = PD_ERR;
               	 	}
		}

		// Add Psp Recon History
		if (iRet == PD_OK) {
	
			PutField_CString(hPspReconHist,"txn_seq",csTxnSeq);
			PutField_CString(hPspReconHist,"psp_id",csPspId);
			PutField_CString(hPspReconHist,"txn_ccy",csTxnCcy);
			PutField_CString(hPspReconHist,"txn_country",csTxnCountry);
			PutField_CString(hPspReconHist,"psp_txn_date",csPspTxnDate);
			PutField_CString(hPspReconHist,"report_date",csReportDate);
			PutField_Int(hPspReconHist,"input_count",iTxnCnt);
			PutField_Double(hPspReconHist,"input_amt",dPaidAmt);
			PutField_Double(hPspReconHist,"input_fee",dFee);
			PutField_Int(hPspReconHist,"txn_count",iTxnCnt);
			PutField_Double(hPspReconHist,"txn_amt",dTxnAmt);
			PutField_Double(hPspReconHist,"paid_amt",dPaidAmt);
			PutField_Double(hPspReconHist,"txn_fee",dFee);
			PutField_CString(hPspReconHist,"recon_date",csPHDate);
			PutField_CString(hPspReconHist,"add_user",PD_UPDATE_USER);	
	
DEBUGLOG(("process_main: [%d]Call DBPspReconHistory: Add()\n", iPspCnt));
                	DBObjPtr = CreateObj(DBPtr,"DBPspReconHistory","Add");
                	if ((unsigned long) ((*DBObjPtr)(hPspReconHist)) != PD_OK) {
                        	iRet = PD_ERR;
DEBUGLOG(("process_main: [%d]Call DBPspReconHistory: Add() Failure!!\n", iPspCnt));
                	}
        	}

		// Add TxnElements
		if (iRet == PD_OK) {
			PutField_CString(hTxnElem,"from_txn_seq",csTxnSeq);
			PutField_CString(hTxnElem,"org_txn_ccy",csTxnCcy);
			PutField_Double(hTxnElem,"transfer_amt",dNetAmt);	
			PutField_Char(hTxnElem,"transfer_amt",PD_TYPE_PSP);	

DEBUGLOG(("process_main: [%d]Call BOTxnElements: Add()\n", iPspCnt));
			BOObjPtr = CreateObj(BOPtr,"BOTxnElements","AddTransferAmtElement");
                	if ((unsigned long)(*BOObjPtr)(hTxnElem) != PD_OK) {
DEBUGLOG(("process_main: [%d]Call BOTxnElements: Add() Failure!!\n", iPspCnt));
                        	iRet = PD_ERR;
                	}
		}

		// Update Txn Log
		if (iRet == PD_OK) {
                        PutField_Char(hTxn,"status",PD_COMPLETE);
			PutField_Char(hTxn,"ar_ind",PD_ACCEPT);
			PutField_Int(hTxn,"internal_code",PD_OK);
			PutField_CString(hTxn,"response_code","0");

DEBUGLOG(("process_main: [%d]Call MGTChannel: UpdateTxnLog()\n", iPspCnt));
                        ChannelObjPtr = CreateObj(ChannelPtr,"MGTChannel","UpdateTxnLog");
                        iRet = (unsigned long)(*ChannelObjPtr)(hTxn,hTxn);
                        if (iRet != PD_OK) {
DEBUGLOG(("process_main: [%d]Call MGTChannel: AddTxnLog Failure!!\n", iPspCnt));
                                iRet = PD_ERR;
                        }

			PutField_Int(hTxn,"do_logging",PD_FALSE);
		}

		RemoveField_Char(hTxn,"status");
        	RemoveField_Char(hTxn,"ar_ind");
		RemoveField_Int(hTxn,"internal_code");
		RemoveField_Int(hTxn,"response_code");

		FREE_ME(csPspId);
		FREE_ME(csPspTxnDate);
		FREE_ME(csReportDate);
		
		iPspCnt++;
DEBUGLOG(("--------------------------------------------------\n"));
	}

	hash_destroy(hPspDetail);
        FREE_ME(hPspDetail);

	hash_destroy(hPspBal);
        FREE_ME(hPspBal);

	hash_destroy(hTxn);
        FREE_ME(hTxn);

	hash_destroy(hTxnElem);
        FREE_ME(hTxnElem);

	hash_destroy(hPspReconHist);
        FREE_ME(hPspReconHist);

	RecordSet_Destroy(rPspReconHist);
        FREE_ME(rPspReconHist);

        fclose(fproc);

DEBUGLOG(("process_main() iRet = [%d]\n", iRet));
	return iRet;
}

