/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2012/02/03              Cody Chan
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sqlca.h>
#include <sqlcpr.h>
#include "common.h"
#include "utilitys.h"
#include "batchcommon.h"

char	cDebug;
#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

#define PD_MY_DELIMITOR ','
#define PD_TR           "<tr>"
#define PD_TD           "<td>"
#define PD_TD_STYLE     "<td class=\"format\">"
#define PD_TR_END       "</tr>"
#define PD_TD_END       "</td>"
#define START_POS       3
#define CONTENT_POS     9

int Extract_RPT001(const char* csFileName, SQL_CURSOR c_input_cursor)
{
	int	iRet = SUCCESS;
DEBUGLOG(("Extract_RPT001\n"));
	EXEC SQL WHENEVER SQLERROR GOTO extract_rpt001_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar v_txn_id[PD_TXN_ID_LEN +1];
		varchar v_merchant_ref[PD_MERCHANT_REF_LEN +1];
                varchar v_txn_code[PD_TXN_CODE_LEN +1];
                varchar v_txn_code_desc[PD_DESC_LEN +1];
                double  v_open_bal;
                double  v_current_bal;
                varchar v_txn_element_type[PD_TXN_ELEMENT_TYPE_LEN +1];
                varchar v_txn_element_type_desc[PD_DESC_LEN +1];
                int     v_exec_seq;
                varchar v_ccy[PD_CCY_ID_LEN +1];
                varchar v_amt_type[PD_AMT_TYPE_LEN +1];
                double  v_bal;

                short   ind_txn_id = -1;
		short	ind_merchant_ref = -1;
                short   ind_txn_code = -1;
                short   ind_txn_code_desc = -1;
                short   ind_open_bal = -1;
                short   ind_current_bal = -1;
                short   ind_txn_element_type = -1;
                short   ind_txn_element_type_desc = -1;
                short   ind_exec_seq = -1;
                short   ind_ccy = -1;
                short   ind_amt_type = -1;
                short   ind_bal = -1;

	EXEC SQL END DECLARE SECTION;

	for (;;) {
		EXEC SQL WHENEVER NOTFOUND DO break;
                EXEC SQL FETCH :c_input_cursor
                INTO
                        :v_txn_id:ind_txn_id,
                        :v_merchant_ref:ind_merchant_ref,
                        :v_txn_code:ind_txn_code,
                        :v_txn_code_desc:ind_txn_code_desc,
                        :v_open_bal:ind_open_bal,
                        :v_current_bal:ind_current_bal,
                        :v_txn_element_type:ind_txn_element_type,
                        :v_txn_element_type_desc:ind_txn_element_type_desc,
                        :v_exec_seq:ind_exec_seq,
                        :v_ccy:ind_ccy,
                        :v_amt_type:ind_amt_type,
                        :v_bal:ind_bal;
/* txn id */
		v_txn_id.arr[v_txn_id.len] = '\0';
/* merchant ref */
		v_merchant_ref.arr[v_merchant_ref.len] = '\0';
/* txn code */
		v_txn_code.arr[v_txn_code.len] = '\0';
/* txn code desc */
		v_txn_code_desc.arr[v_txn_code.len] = '\0';
/*open bal */
		if (ind_open_bal < 0) 
			v_open_bal = 0.0;

/*current bal */
		if (ind_current_bal < 0) 
			v_current_bal = 0.0;
/*txn element */
		v_txn_element_type.arr[v_txn_element_type.len] = '\0';
/*txn element desc */
		v_txn_element_type_desc.arr[v_txn_element_type_desc.len] = '\0';

/*exec seq */
		if (ind_exec_seq < 0) 
			v_exec_seq = 0;

/*ccy */
		v_ccy.arr[v_ccy.len] = '\0';
/*amt_type */
		v_amt_type.arr[v_amt_type.len] = '\0';
/*bal */
		if (ind_bal < 0) 
			v_bal = 0.0;
	}


	return iRet;
extract_rpt001_error:
DEBUGLOG(("extract_rpt001 code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
        return FAILURE;
}




int Extract_RPT_ESKY(const char* csFileName, SQL_CURSOR c_input_cursor)
{
DEBUGLOG(("Extract_RPT_ESKY\n"));
	int	iRet = SUCCESS;
	double	dAmt;
	char	csDate[PD_DATETIME_LEN+1];
	char	csLine[PD_TMP_BUF_LEN*2+1];

	FILE *fp;
	fp = fopen(csFileName,"w");
	if (fp == NULL) {
DEBUGLOG(("Extract_RPT_ESKY:unable to open [%s]\n",csFileName));
                return FAILURE;
	}

	EXEC SQL WHENEVER SQLERROR GOTO extract_rpt_esky_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar v_txn_id[PD_TXN_ID_LEN +1];
                varchar v_tid[PD_PSP_TID_LEN +1];
                varchar v_txn_date[PD_DATE_LEN +1];
                varchar v_fundin_date[PD_DATETIME_LEN +1];
                varchar v_bank_bill_no[PD_BANK_BILL_NO_LEN +1];
                varchar v_amt[PD_AMOUNT_LEN +1];
                double  v_fee;

                short   ind_txn_id = -1;
                short   ind_tid = -1;
                short   ind_txn_date = -1;
                short   ind_fundin_date = -1;
                short   ind_bank_bill_no = -1;
                short   ind_amt = -1;
                short   ind_fee = -1;

	EXEC SQL END DECLARE SECTION;

	for (;;) {
		EXEC SQL WHENEVER NOTFOUND DO break;
                EXEC SQL FETCH :c_input_cursor
                INTO
                        :v_tid:ind_tid,
                        :v_txn_id:ind_txn_id,
                        :v_txn_date:ind_txn_date,
                        :v_fundin_date:ind_fundin_date,
                        :v_bank_bill_no:ind_bank_bill_no,
                        :v_amt:ind_amt,
                        :v_fee:ind_fee;
/* txn id */
		v_txn_id.arr[v_txn_id.len] = '\0';
/* tid */
		v_tid.arr[v_tid.len] = '\0';
/*fundin date */
		v_fundin_date.arr[v_fundin_date.len] = '\0';
		if(strlen((const char*)v_fundin_date.arr)==PD_DATETIME_LEN)
                	sprintf(csDate,"%.*s00",(int)strlen((const char*)v_fundin_date.arr)-2,v_fundin_date.arr);
		else if(strlen((const char*)v_fundin_date.arr)==PD_DATE_LEN)
			sprintf(csDate,"%.*s000000",(int)strlen((const char*)v_fundin_date.arr),v_fundin_date.arr);
		else
			sprintf(csDate,"%.*s",(int)strlen((const char*)v_fundin_date.arr),v_fundin_date.arr);
/*amt */
		v_amt.arr[v_amt.len] = '\0';
		sscanf((const char*)v_amt.arr,"%lf",&dAmt);
/*fee */
		if (ind_fee < 0) 
			v_fee = 0.0;

		sprintf(csLine,"%s,%s,%.2lf,%.2lf,Success,%s",v_txn_id.arr,v_tid.arr,dAmt,v_fee,csDate);
		fprintf(fp,"%s\n",csLine);
	}

	fclose(fp);
DEBUGLOG(("Extract_RPT_ESKY iRet = [%d]\n",iRet));
	return iRet;

extract_rpt_esky_error:
DEBUGLOG(("extract_rpt_esky code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
	fclose(fp);
        return FAILURE;
}

int Extract_RPT_YPY(const char* csFileName, SQL_CURSOR c_input_cursor)
{
DEBUGLOG(("Extract_RPT_YPY\n"));
	int	iRet = SUCCESS;
	double	dAmt;
	char	csDate[PD_DATETIME_LEN+1];
	char	csLine[PD_TMP_BUF_LEN*2+1];

	FILE *fp;
	fp = fopen(csFileName,"w");
	if (fp == NULL) {
DEBUGLOG(("Extract_RPT_YPY:unable to open [%s]\n",csFileName));
                return FAILURE;
	}

	EXEC SQL WHENEVER SQLERROR GOTO extract_rpt_ypy_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar v_txn_id[PD_TXN_ID_LEN +1];
                varchar v_tid[PD_PSP_TID_LEN +1];
                varchar v_txn_date[PD_DATE_LEN +1];
                varchar v_fundin_date[PD_DATETIME_LEN +1];
                varchar v_bank_bill_no[PD_BANK_BILL_NO_LEN +1];
                varchar v_amt[PD_AMOUNT_LEN +1];
                double  v_fee;

                short   ind_txn_id = -1;
                short   ind_tid = -1;
                short   ind_txn_date = -1;
                short   ind_fundin_date = -1;
                short   ind_bank_bill_no = -1;
                short   ind_amt = -1;
                short   ind_fee = -1;

	EXEC SQL END DECLARE SECTION;

	for (;;) {
		EXEC SQL WHENEVER NOTFOUND DO break;
                EXEC SQL FETCH :c_input_cursor
                INTO
                        :v_tid:ind_tid,
                        :v_txn_id:ind_txn_id,
                        :v_txn_date:ind_txn_date,
                        :v_fundin_date:ind_fundin_date,
                        :v_bank_bill_no:ind_bank_bill_no,
                        :v_amt:ind_amt,
                        :v_fee:ind_fee;
/* txn id */
		v_txn_id.arr[v_txn_id.len] = '\0';
/* tid */
		v_tid.arr[v_tid.len] = '\0';
/*fundin date */
		v_fundin_date.arr[v_fundin_date.len] = '\0';
		if(strlen((const char*)v_fundin_date.arr)==PD_DATETIME_LEN)
                	sprintf(csDate,"%.*s00",(int)strlen((const char*)v_fundin_date.arr)-2,v_fundin_date.arr);
		else if(strlen((const char*)v_fundin_date.arr)==PD_DATE_LEN)
			sprintf(csDate,"%.*s000000",(int)strlen((const char*)v_fundin_date.arr),v_fundin_date.arr);
		else
			sprintf(csDate,"%.*s",(int)strlen((const char*)v_fundin_date.arr),v_fundin_date.arr);
/*amt */
		v_amt.arr[v_amt.len] = '\0';
		sscanf((const char*)v_amt.arr,"%lf",&dAmt);
/*fee */
		if (ind_fee < 0) 
			v_fee = 0.0;

		sprintf(csLine,"%s,%s,%.2lf,%.2lf,Success,%s",v_txn_id.arr,v_tid.arr,dAmt,v_fee,csDate);
		fprintf(fp,"%s\n",csLine);
	}

	fclose(fp);
DEBUGLOG(("Extract_RPT_YPY iRet = [%d]\n",iRet));
	return iRet;

extract_rpt_ypy_error:
DEBUGLOG(("extract_rpt_ypy code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
	fclose(fp);
        return FAILURE;
}


int Extract_RPT_HCP(const char* csFileName, SQL_CURSOR c_input_cursor)
{
DEBUGLOG(("Extract_RPT_HCP\n"));
	int	iRet = SUCCESS;
	double	dAmt;
	char	csDate[PD_DATETIME_LEN+1];
	char	csLine[PD_TMP_BUF_LEN*2+1];

	FILE *fp;
	fp = fopen(csFileName,"w");
	if (fp == NULL) {
DEBUGLOG(("Extract_RPT_HCP:unable to open [%s]\n",csFileName));
                return FAILURE;
	}

	EXEC SQL WHENEVER SQLERROR GOTO extract_rpt_hcp_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar v_txn_id[PD_TXN_ID_LEN +1];
                varchar v_tid[PD_PSP_TID_LEN +1];
                varchar v_txn_date[PD_DATE_LEN +1];
                varchar v_fundin_date[PD_DATETIME_LEN +1];
                varchar v_bank_bill_no[PD_BANK_BILL_NO_LEN +1];
                varchar v_amt[PD_AMOUNT_LEN +1];
                double  v_fee;

                short   ind_txn_id = -1;
                short   ind_tid = -1;
                short   ind_txn_date = -1;
                short   ind_fundin_date = -1;
                short   ind_bank_bill_no = -1;
                short   ind_amt = -1;
                short   ind_fee = -1;

	EXEC SQL END DECLARE SECTION;

	for (;;) {
		EXEC SQL WHENEVER NOTFOUND DO break;
                EXEC SQL FETCH :c_input_cursor
                INTO
                        :v_tid:ind_tid,
                        :v_txn_id:ind_txn_id,
                        :v_txn_date:ind_txn_date,
                        :v_fundin_date:ind_fundin_date,
                        :v_bank_bill_no:ind_bank_bill_no,
                        :v_amt:ind_amt,
                        :v_fee:ind_fee;
/* txn id */
		v_txn_id.arr[v_txn_id.len] = '\0';
/* tid */
		v_tid.arr[v_tid.len] = '\0';
/* bank bill no*/
		v_bank_bill_no.arr[v_bank_bill_no.len] = '\0';
/*fundin date */
		v_fundin_date.arr[v_fundin_date.len] = '\0';
		if(strlen((const char*)v_fundin_date.arr)==PD_DATETIME_LEN)
                	sprintf(csDate,"%.*s00",(int)strlen((const char*)v_fundin_date.arr)-2,v_fundin_date.arr);
		else if(strlen((const char*)v_fundin_date.arr)==PD_DATE_LEN)
			sprintf(csDate,"%.*s000000",(int)strlen((const char*)v_fundin_date.arr),v_fundin_date.arr);
		else
			sprintf(csDate,"%.*s",(int)strlen((const char*)v_fundin_date.arr),v_fundin_date.arr);
/*amt */
		v_amt.arr[v_amt.len] = '\0';
		sscanf((const char*)v_amt.arr,"%lf",&dAmt);
/*fee */
		if (ind_fee < 0) 
			v_fee = 0.0;

		sprintf(csLine,"%s,%s,%s,%.2lf,Success",v_txn_id.arr,v_tid.arr,v_bank_bill_no.arr,dAmt);
		fprintf(fp,"%s\n",csLine);
	}

	fclose(fp);
DEBUGLOG(("Extract_RPT_HCP iRet = [%d]\n",iRet));
	return iRet;

extract_rpt_hcp_error:
DEBUGLOG(("extract_rpt_hcp code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
	fclose(fp);
        return FAILURE;
}



int Extract_RPT_TWV(const char* csFileName, SQL_CURSOR c_input_cursor)
{
DEBUGLOG(("Extract_RPT_TWV\n"));
	int	iRet = SUCCESS;
	char	csDate[PD_DATETIME_LEN+1];
	char	csLine[PD_TMP_BUF_LEN*2+1];

	FILE *fp;
	fp = fopen(csFileName,"w");
	if (fp == NULL) {
DEBUGLOG(("Extract_RPT_TWV:unable to open [%s]\n",csFileName));
                return FAILURE;
	}

	EXEC SQL WHENEVER SQLERROR GOTO extract_rpt_twv_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar v_txn_id[PD_TXN_ID_LEN +1];
                varchar v_tid[PD_PSP_TID_LEN +1];
                varchar v_txn_date[PD_DATE_LEN +1];
                varchar v_fundin_date[PD_DATETIME_LEN +1];
                varchar v_bank_bill_no[PD_BANK_BILL_NO_LEN +1];
                varchar v_amt[PD_AMOUNT_LEN +1];
                double  v_fee;

                short   ind_txn_id = -1;
                short   ind_tid = -1;
                short   ind_txn_date = -1;
                short   ind_fundin_date = -1;
                short   ind_bank_bill_no = -1;
                short   ind_amt = -1;
                short   ind_fee = -1;

	EXEC SQL END DECLARE SECTION;

	for (;;) {
		EXEC SQL WHENEVER NOTFOUND DO break;
                EXEC SQL FETCH :c_input_cursor
                INTO
                        :v_tid:ind_tid,
                        :v_txn_id:ind_txn_id,
                        :v_txn_date:ind_txn_date,
                        :v_fundin_date:ind_fundin_date,
                        :v_bank_bill_no:ind_bank_bill_no,
                        :v_amt:ind_amt,
                        :v_fee:ind_fee;
/* txn id */
		v_txn_id.arr[v_txn_id.len] = '\0';
/* tid */
		v_tid.arr[v_tid.len] = '\0';
/*txn date */
		v_txn_date.arr[v_txn_date.len] = '\0';
/*fundin date */
		v_fundin_date.arr[v_fundin_date.len] = '\0';
		sprintf(csDate,"%.*s",PD_DATE_LEN,v_fundin_date.arr);
/*amt */
		v_amt.arr[v_amt.len] = '\0';
/*fee */
		if (ind_fee < 0) 
			v_fee = 0.0;

		sprintf(csLine,"%s,%s,%s,,WebATM,%s,%s,%ld",v_txn_id.arr,v_tid.arr,v_txn_date.arr,v_amt.arr,csDate,(long)v_fee);
		fprintf(fp,"%s\n",csLine);
	}

	fclose(fp);
DEBUGLOG(("Extract_RPT_TWV iRet = [%d]\n",iRet));
	return iRet;

extract_rpt_twv_error:
DEBUGLOG(("extract_rpt_twv code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
	fclose(fp);
        return FAILURE;
}


int Extract_RPT_ALP(const char* csFileName, SQL_CURSOR c_input_cursor)
{
DEBUGLOG(("Extract_RPT_ALP\n"));
	int	iRet = SUCCESS;
	char	csDate[PD_DATETIME_LEN+1];
	char	csLine[PD_TMP_BUF_LEN*2+1];

	FILE *fp;
	fp = fopen(csFileName,"w");
	if (fp == NULL) {
DEBUGLOG(("Extract_RPT_ALP:unable to open [%s]\n",csFileName));
                return FAILURE;
	}

	EXEC SQL WHENEVER SQLERROR GOTO extract_rpt_alp_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar v_txn_id[PD_TXN_ID_LEN +1];
                varchar v_tid[PD_PSP_TID_LEN +1];
                varchar v_txn_date[PD_DATE_LEN +1];
                varchar v_fundin_date[PD_DATETIME_LEN +1];
                varchar v_bank_bill_no[PD_BANK_BILL_NO_LEN +1];
                varchar v_amt[PD_AMOUNT_LEN +1];
                double  v_fee;

                short   ind_txn_id = -1;
                short   ind_tid = -1;
                short   ind_txn_date = -1;
                short   ind_fundin_date = -1;
                short   ind_bank_bill_no = -1;
                short   ind_amt = -1;
                short   ind_fee = -1;

	EXEC SQL END DECLARE SECTION;

	for (;;) {
		EXEC SQL WHENEVER NOTFOUND DO break;
                EXEC SQL FETCH :c_input_cursor
                INTO
                        :v_tid:ind_tid,
                        :v_txn_id:ind_txn_id,
                        :v_txn_date:ind_txn_date,
                        :v_fundin_date:ind_fundin_date,
                        :v_bank_bill_no:ind_bank_bill_no,
                        :v_amt:ind_amt,
                        :v_fee:ind_fee;
/* txn id */
		v_txn_id.arr[v_txn_id.len] = '\0';
/* tid */
		v_tid.arr[v_tid.len] = '\0';
/*amt */
		v_amt.arr[v_amt.len] = '\0';
/*fee */
		if (ind_fee < 0) 
			v_fee = 0.0;
/*fundin date */
		v_fundin_date.arr[v_fundin_date.len] = '\0';
		sprintf(csDate,"%.*s",PD_DATE_LEN,v_fundin_date.arr);

		sprintf(csLine,"%s|%s|%s|%ld|%s",v_txn_id.arr,v_tid.arr,v_amt.arr,(long)v_fee,csDate);
		fprintf(fp,"%s\n",csLine);
	}

	fclose(fp);
DEBUGLOG(("Extract_RPT_ALP iRet = [%d]\n",iRet));
	return iRet;

extract_rpt_alp_error:
DEBUGLOG(("extract_rpt_alp code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
	fclose(fp);
        return FAILURE;
}


int Extract_RPT_DETAIL(const char* csFileName, SQL_CURSOR c_input_cursor)
{
DEBUGLOG(("Extract_RPT_DETAIL\n"));
	int	iRet = SUCCESS;
	//double	dAmt;
	//char	csDate[PD_DATETIME_LEN+1];
	//char	csLine[PD_TMP_BUF_LEN*2+1];
	char	*csEcRef;

	FILE *fp;
	fp = fopen(csFileName,"w");
	if (fp == NULL) {
DEBUGLOG(("Extract_RPT_DETAIL:unable to open [%s]\n",csFileName));
                return FAILURE;
	}

	fprintf(fp,"<html><body><table>\n");
        fprintf(fp,"%s%sPH Txn ID%s%sPH Txn Code%s%sPH Status%s%sAR_IND%s%sPH Response Code%s%sClient Name%s%sMerchant ID%s%sMerchant Refernece%s%sEC2 Refernece%s%sPSP Name%s%sPSP Txn ID%s%sBank Bill No.%s%sTxn Ccy%s%sTxn Amount%s%sPSP Service Fee%s%sPH Posting Date%s%sMerchant Txn Date%s%sPH Txn Date%s%sPSP Txn Date%s%sLast Update Date%s%s\n",PD_TR,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TR_END);
        fprintf(fp,"<style type=\"text/css\"> .format{ mso-number-format:'\\@';} </style>\n");



	EXEC SQL WHENEVER SQLERROR GOTO extract_rpt_detail_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar v_txn_id[PD_TXN_SEQ_LEN + 1];
		char    v_status;
		char    v_ar_ind;
		int     v_internal_code;
		varchar v_response_code[PD_RESPONSE_CODE_LEN + 1];
		varchar v_merchant_id[PD_MERCHANT_ID_LEN + 1];
		varchar v_merchant_ref[PD_MERCHANT_REF_LEN + 1];
		varchar v_psp_name[PD_PSP_NAME_LEN + 1];
		varchar v_tid[PD_MERCHANT_REF_LEN +1];
		varchar v_txn_ccy[PD_CCY_ID_LEN + 1];
		double  v_txn_amount;
		double  v_service_fee;
		varchar v_merchant_txn_date[PD_DATETIME_LEN +1];
		varchar v_local_txn_date[PD_DATE_LEN +1];
		varchar v_local_txn_time[PD_DATE_LEN +1];
		varchar v_psp_txn_date[PD_DATE_LEN + 1];
		varchar v_host_posting_date[PD_DATE_LEN + 1];
		varchar v_txn_code_desc[PD_DESC_LEN +1];
		varchar v_txn_code[PD_TXN_CODE_LEN +1];
		varchar v_client_name[PD_CLIENT_NAME_LEN +1];
		varchar v_last_updatetime[PD_DATETIME_LEN +1];
		varchar v_bill_no[PD_BANK_BILL_NO_LEN +1];

		short   ind_txn_id = -1;
		short   ind_status = -1;
		short   ind_ar_ind = -1;
		short   ind_internal_code = -1;
		short   ind_response_code = -1;
		short   ind_merchant_id = -1;
		short   ind_merchant_ref = -1;
		short   ind_psp_name = -1;
		short   ind_tid = -1;
		short   ind_txn_ccy = -1;
		short   ind_txn_amount = -1;
		short   ind_service_fee = -1;
		short   ind_merchant_txn_date = -1;
		short   ind_local_txn_date = -1;
		short   ind_local_txn_time = -1;
		short   ind_psp_txn_date = -1;
		short   ind_host_posting_date = -1;
		short   ind_txn_code_desc = -1;
		short   ind_txn_code = -1;
		short   ind_client_name = -1;
		short   ind_last_updatetime = -1;
		short   ind_bill_no = -1;

	EXEC SQL END DECLARE SECTION;

	for (;;) {
		EXEC SQL WHENEVER NOTFOUND DO break;
                EXEC SQL FETCH :c_input_cursor
                INTO
			v_txn_id:ind_txn_id,
			v_status:ind_status,
			v_ar_ind:ind_ar_ind,
			v_internal_code:ind_internal_code,
			v_response_code:ind_response_code,
			v_merchant_id:ind_merchant_id,
			v_merchant_ref:ind_merchant_ref,
			v_psp_name:ind_psp_name,
			v_tid:ind_tid,
			v_txn_ccy:ind_txn_ccy,
			v_txn_amount:ind_txn_amount,
			v_service_fee:ind_service_fee,
			v_merchant_txn_date:ind_merchant_txn_date,
			v_local_txn_date:ind_local_txn_date,
			v_local_txn_time:ind_local_txn_time,
			v_psp_txn_date:ind_psp_txn_date,
			v_host_posting_date:ind_host_posting_date,
			v_txn_code_desc:ind_txn_code_desc,
			v_txn_code:ind_txn_code,
			v_last_updatetime:ind_last_updatetime,
			v_client_name:ind_client_name,
			v_bill_no:ind_bill_no;


		fprintf(fp,"%s",PD_TR);
/* txn id */
		v_txn_id.arr[v_txn_id.len] = '\0';
		fprintf(fp,"%s%.*s%s",PD_TD_STYLE,v_txn_id.len,v_txn_id.arr,PD_TD_END);

/* txn_desc  */
		v_txn_code_desc.arr[v_txn_code_desc.len] = '\0';
		fprintf(fp,"%s%.*s%s",PD_TD,v_txn_code_desc.len,v_txn_code_desc.arr,PD_TD_END);
/* status */
		if (ind_status < 0 )
			fprintf(fp,"%s%s",PD_TD,PD_TD_END);
		else {
			if (v_status == 'C')
				fprintf(fp,"%sCompleted%s",PD_TD,PD_TD_END);
			else if(v_status == 'W')
				fprintf(fp,"%sPending%s",PD_TD,PD_TD_END);
			else
				fprintf(fp,"%sProcessing%s",PD_TD,PD_TD_END);
		}
/* ar ind */
		if (ind_ar_ind < 0 )
			fprintf(fp,"%s%s",PD_TD,PD_TD_END);
		else {
			if (v_ar_ind == 'A')
				fprintf(fp,"%sAccept%s",PD_TD,PD_TD_END);
			else
				fprintf(fp,"%sReject%s",PD_TD,PD_TD_END);
		}

/* response_code */
                v_response_code.arr[v_response_code.len] = '\0';
		fprintf(fp,"%s%.*s%s",PD_TD,v_response_code.len,v_response_code.arr,PD_TD_END);

/* client_name */
                v_client_name.arr[v_client_name.len] = '\0';
		fprintf(fp,"%s%.*s%s",PD_TD,v_client_name.len,v_client_name.arr,PD_TD_END);

/* merchant_id */
                v_merchant_id.arr[v_merchant_id.len] = '\0';
		fprintf(fp,"%s%.*s%s",PD_TD_STYLE,v_merchant_id.len,v_merchant_id.arr,PD_TD_END);

/* merchant_ref */
		v_merchant_ref.arr[v_merchant_ref.len] = '\0';
		fprintf(fp,"%s%.*s%s",PD_TD_STYLE,v_merchant_ref.len,v_merchant_ref.arr,PD_TD_END);

/* EC2_ref */
		v_txn_code.arr[v_txn_code.len] = '\0';

		if(strncmp((const char*)v_txn_code.arr,PD_DEPOSIT_TXN_CODE,PD_TXN_CODE_LEN)==0){
			csEcRef = strdup("");
			strcpy(csEcRef,(const char*)v_merchant_ref.arr);
			csEcRef[v_merchant_ref.len]='\0';
			fprintf(fp,"%s%c%s%s",PD_TD_STYLE,csEcRef[START_POS],&csEcRef[CONTENT_POS],PD_TD_END);
			FREE_ME(csEcRef);
		}
		else
			fprintf(fp,"%s%s",PD_TD_STYLE,PD_TD_END);

/* psp_name */
		v_psp_name.arr[v_psp_name.len] = '\0';
		fprintf(fp,"%s%.*s%s",PD_TD,v_psp_name.len,v_psp_name.arr,PD_TD_END);

/* tid */
		v_tid.arr[v_tid.len] = '\0';
		fprintf(fp,"%s%.*s%s",PD_TD_STYLE,v_tid.len,v_tid.arr,PD_TD_END);

/* bank_bill_no */
                if (ind_bill_no< 0 ){
			strcpy((char*)v_bill_no.arr,"N/A");
			v_bill_no.len=strlen("N/A");
		}
		v_bill_no.arr[v_bill_no.len] = '\0';
		fprintf(fp,"%s%.*s%s",PD_TD_STYLE,v_bill_no.len,v_bill_no.arr,PD_TD_END);

/* txn_ccy */
		v_txn_ccy.arr[v_txn_ccy.len] = '\0';
		fprintf(fp,"%s%.*s%s",PD_TD,v_txn_ccy.len,v_txn_ccy.arr,PD_TD_END);

/* txn_amount */
		v_txn_amount = 0;
		fprintf(fp,"%s%f%s",PD_TD,v_txn_amount,PD_TD_END);

/* service_fee */
		v_service_fee = 0;
		fprintf(fp,"%s%f%s",PD_TD,v_service_fee,PD_TD_END);

/* host posting date */
		v_host_posting_date.arr[v_host_posting_date.len] = '\0';
		fprintf(fp,"%s%.*s%s",PD_TD_STYLE,v_host_posting_date.len,v_host_posting_date.arr,PD_TD_END);

/* merchant_txn_date */
		v_merchant_txn_date.arr[v_merchant_txn_date.len] = '\0';
		fprintf(fp,"%s%.*s%s",PD_TD_STYLE,v_merchant_txn_date.len,v_merchant_txn_date.arr,PD_TD_END);

/* local_txn_date */
		v_local_txn_date.arr[v_local_txn_date.len] = '\0';
		v_local_txn_time.arr[v_local_txn_time.len] = '\0';
		fprintf(fp,"%s%.*s %.*s%s",PD_TD_STYLE,v_local_txn_date.len,v_local_txn_date.arr,v_local_txn_time.len,v_local_txn_time.arr,PD_TD_END);

/* psp_txn_date */
		v_psp_txn_date.arr[v_psp_txn_date.len] = '\0';
		fprintf(fp,"%s%.*s%s",PD_TD_STYLE,v_psp_txn_date.len,v_psp_txn_date.arr,PD_TD_END);

/* last_updatetime */
		v_last_updatetime.arr[v_last_updatetime.len] = '\0';
		fprintf(fp,"%s%.*s%s",PD_TD_STYLE,v_last_updatetime.len,v_last_updatetime.arr,PD_TD_END);

		fprintf(fp,"%s\n",PD_TR_END);

	}

	fprintf(fp,"</table></body></html>\n");
	fclose(fp);
DEBUGLOG(("Extract_RPT_DETAIL iRet = [%d]\n",iRet));
	return iRet;

extract_rpt_detail_error:
DEBUGLOG(("extract_rpt_detail code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
	fclose(fp);
        return FAILURE;
}


int Extract_RPT_SUMMARY(const char* csFileName, SQL_CURSOR c_input_cursor)
{
DEBUGLOG(("Extract_RPT_SUMMARY\n"));
	int	iRet = SUCCESS;
	char	*csStatus=strdup(" ");

	FILE *fp;
	fp = fopen(csFileName,"w");
	if (fp == NULL) {
DEBUGLOG(("Extract_RPT_SUMMARY:unable to open [%s]\n",csFileName));
                return FAILURE;
	}

	fprintf(fp,"<html><body><table>\n");
        fprintf(fp,"<tr><td>Txn Deail Summary</td></tr>\n");
        fprintf(fp,"<tr><td></td></tr>\n");
	fprintf(fp,"<tr><td>Txn Type</td><td>Status</td><td>Count</td><td>Amount</td></tr>\n");

	EXEC SQL WHENEVER SQLERROR GOTO extract_rpt_summary_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
		varchar v_txn_type[PD_DESC_LEN +1];
		char	v_status;
		char	v_ar_ind;
		double	v_amount;
		int	v_count;

                short   ind_txn_type= -1;
                short   ind_status= -1;
                short   ind_ar_ind= -1;
                short   ind_amount= -1;
                short   ind_count= -1;

	EXEC SQL END DECLARE SECTION;

	for (;;) {
		EXEC SQL WHENEVER NOTFOUND DO break;
                EXEC SQL FETCH :c_input_cursor
                INTO
                        :v_amount:ind_amount,
                        :v_count:ind_count,
                        :v_status:ind_status,
                        :v_ar_ind:ind_ar_ind,
                        :v_txn_type:ind_txn_type;

/* txn type */
		v_txn_type.arr[v_txn_type.len] = '\0';

/*status*/
		if(ind_ar_ind>=0){
			if(v_ar_ind==PD_ACCEPT)
				csStatus=strdup("Accepted");
			else if(v_ar_ind==PD_REJECT)
				csStatus=strdup("Rejected");
		}
		else{
			if(v_status==PD_TO_PSP)
				csStatus=strdup("Pending");
			else
				csStatus=strdup("Other");
		}

/*count*/
		if (ind_count < 0) 
			v_count = 0;
/*amount*/
		if (ind_amount < 0) 
			v_amount = 0.0;

		fprintf(fp,"<tr><td>[%s]</td><td>%s</td><td>%d</td><td>%f</td></tr>\n",v_txn_type.arr,csStatus,v_count,v_amount);
	}

	fprintf(fp,"</table></body></html>\n");
	FREE_ME(csStatus);
	fclose(fp);
DEBUGLOG(("Extract_RPT_SUMMARY iRet = [%d]\n",iRet));
	return iRet;

extract_rpt_summary_error:
DEBUGLOG(("extract_rpt_summary code %d\n", sqlca.sqlcode));
DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
        EXEC SQL WHENEVER SQLERROR CONTINUE;
	FREE_ME(csStatus);
	fclose(fp);
        return FAILURE;
}



char *GetFileName(const unsigned char* csPspName, const char* cs_eod_date)
{
	static  char cs_filename[PD_TMP_BUF_LEN + 1];

	sprintf(cs_filename, "%s/%s_DSP_%s.dat", getenv("REPORT_DATA"),csPspName,cs_eod_date);

	return cs_filename;
}

char *GetTxnDetailFileName(const unsigned char* csPspName, const unsigned char* csCountry, const char* cs_eod_date, const char* csType)
{
	static  char cs_detailfilename[PD_MAX_FILE_LEN + 1];
	char	cs_tmp[PD_MAX_FILE_LEN+1];

/* create report path */
        sprintf(cs_detailfilename, "%s", getenv("REPORT_HOME"));
        sprintf(cs_tmp, "mkdir %s >/dev/null 2>&1", cs_detailfilename);
        system(cs_tmp);

        sprintf(cs_detailfilename, "%s/%.*s", getenv("REPORT_HOME"),PD_YYYY_LEN,cs_eod_date);
        sprintf(cs_tmp, "mkdir %s >/dev/null 2>&1", cs_detailfilename);
        system(cs_tmp);

        sprintf(cs_detailfilename, "%s/%.*s/%.*s", getenv("REPORT_HOME"),PD_YYYY_LEN,cs_eod_date,PD_YYYYMM_LEN,cs_eod_date);
        sprintf(cs_tmp, "mkdir %s >/dev/null 2>&1", cs_detailfilename);
        system(cs_tmp);

        sprintf(cs_detailfilename, "%s/%.*s/%.*s/%s", getenv("REPORT_HOME"),PD_YYYY_LEN,cs_eod_date,PD_YYYYMM_LEN,cs_eod_date,cs_eod_date);
        sprintf(cs_tmp, "mkdir %s >/dev/null 2>&1", cs_detailfilename);
        system(cs_tmp);

        sprintf(cs_detailfilename, "%s/%.*s/%.*s/%s/%s", getenv("REPORT_HOME"),PD_YYYY_LEN,cs_eod_date,PD_YYYYMM_LEN,cs_eod_date,cs_eod_date,csCountry);
        sprintf(cs_tmp, "mkdir %s >/dev/null 2>&1", cs_detailfilename);
        system(cs_tmp);

        sprintf(cs_detailfilename, "%s/%.*s/%.*s/%s/%s/%s", getenv("REPORT_HOME"),PD_YYYY_LEN,cs_eod_date,PD_YYYYMM_LEN,cs_eod_date,cs_eod_date,csCountry,csPspName);
        sprintf(cs_tmp, "mkdir %s >/dev/null 2>&1", cs_detailfilename);
        system(cs_tmp);

	if(!strcmp(csType,"daily"))
		sprintf(cs_detailfilename, "%s/%.*s/%.*s/%s/%s/%s/TXN_DETAIL.xls",getenv("REPORT_HOME"),PD_YYYY_LEN,cs_eod_date,PD_YYYYMM_LEN,cs_eod_date,cs_eod_date,csCountry,csPspName);

	else if(!strcmp(csType,"summary"))
		sprintf(cs_detailfilename, "%s/%.*s/%.*s/%s/%s/%s/TXN_DETAIL_SUMMARY.xls",getenv("REPORT_HOME"),PD_YYYY_LEN,cs_eod_date,PD_YYYYMM_LEN,cs_eod_date,cs_eod_date,csCountry,csPspName);

	else if(!strcmp(csType,"live"))
		sprintf(cs_detailfilename, "%s/%.*s/%.*s/%s/%s/%s/TXN_DETAIL_LIVE.xls",getenv("REPORT_HOME"),PD_YYYY_LEN,cs_eod_date,PD_YYYYMM_LEN,cs_eod_date,cs_eod_date,csCountry,csPspName);

	else if(!strcmp(csType,"livesummary"))
		sprintf(cs_detailfilename, "%s/%.*s/%.*s/%s/%s/%s/TXN_DETAIL_LIVE_SUMMARY.xls",getenv("REPORT_HOME"),PD_YYYY_LEN,cs_eod_date,PD_YYYYMM_LEN,cs_eod_date,cs_eod_date,csCountry,csPspName);


	return cs_detailfilename;
}
