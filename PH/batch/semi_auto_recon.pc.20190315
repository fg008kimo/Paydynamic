/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2015/02/13              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "batchcommon.h"
#include "common.h"
#include "utilitys.h"
#include "ObjPtr.h"
#include "internal.h"
#include "myhash.h"
#include "numutility.h"
#include "myrecordset.h"
#include <curl/curl.h>
#include "queue_utility.h"
#include "mq_db.h"


#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

char cs_create_stmt_ts_ind[10 + 1];
char cs_s_ts_from[PD_DATE_LEN + PD_TIME_LEN + 1];
char cs_s_ts_to[PD_DATE_LEN + PD_TIME_LEN + 1];
char cs_s_provider_id[PD_CLIENT_ID_LEN + 1];
char cs_s_pid[PD_PSP_ID_LEN + 1];
char cs_s_txn_amt[20 + 1];
char cs_r_ts_from[PD_DATE_LEN + PD_TIME_LEN + 1];
char cs_r_ts_to[PD_DATE_LEN + PD_TIME_LEN + 1];
char cs_r_provider_id[PD_CLIENT_ID_LEN + 1];
char cs_r_pid[PD_PSP_ID_LEN + 1];
char cs_r_txn_amt[20 + 1];
char cs_add_user[PD_USER_LEN + 1];

char cDebug = 'Y';
OBJPTR(Txn);
OBJPTR(BO);
OBJPTR(DB);

int parse_arg(int argc, char **argv);

int batch_init(int argc, char* argv[])
{
	if (argc < 8) {
		printf("not enough input\n");
		return FAILURE;
	}
	else
		return SUCCESS;
}


int batch_proc(int argc, char* argv[])
{
	int iRet = PD_OK;

	hash_t *hRequest;
	hRequest = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRequest, 0);

	hash_t *hContext;
	hContext = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hContext, 0);

	hash_t *hResponse;
	hResponse = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hResponse, 0);

	iRet = parse_arg(argc, argv);

	if (iRet != SUCCESS) {
		printf("invalid input\n");
		return (iRet);
	}

DEBUGLOG(("Authorize\n"));

DEBUGLOG(("Authorize:: cs_create_stmt_ts_ind = [%s]\n", cs_create_stmt_ts_ind));
DEBUGLOG(("Authorize:: cs_s_ts_from = [%s]\n", cs_s_ts_from));
DEBUGLOG(("Authorize:: cs_s_ts_to = [%s]\n", cs_s_ts_to));
	if (!strcmp(cs_create_stmt_ts_ind, "create")) {
		PutField_CString(hRequest, "s_create_ts_from", cs_s_ts_from);
		PutField_CString(hRequest, "s_create_ts_to", cs_s_ts_to);
	} else if (!strcmp(cs_create_stmt_ts_ind, "stmt")) {
		PutField_CString(hRequest, "s_stmt_ts_from", cs_s_ts_from);
		PutField_CString(hRequest, "s_stmt_ts_to", cs_s_ts_to);
	} else {
		printf("invalid input\n");
		return (iRet);
	}

DEBUGLOG(("Authorize:: cs_s_provider_id = [%s]\n", cs_s_provider_id));
	if (strcmp(cs_s_provider_id, "")) {
		PutField_CString(hRequest, "s_provider_id", cs_s_provider_id);
	}

DEBUGLOG(("Authorize:: cs_s_pid = [%s]\n", cs_s_pid));
	if (strcmp(cs_s_pid, "")) {
		PutField_CString(hRequest, "s_pid", cs_s_pid);
	}

DEBUGLOG(("Authorize:: cs_s_txn_amt = [%s]\n", cs_s_txn_amt));
	if (strcmp(cs_s_txn_amt, "")) {
		PutField_CString(hRequest, "s_txn_amt", cs_s_txn_amt);
	}

DEBUGLOG(("Authorize:: cs_create_stmt_ts_ind = [%s]\n", cs_create_stmt_ts_ind));
DEBUGLOG(("Authorize:: cs_r_ts_from = [%s]\n", cs_r_ts_from));
DEBUGLOG(("Authorize:: cs_r_ts_to = [%s]\n", cs_r_ts_to));
	if (!strcmp(cs_create_stmt_ts_ind, "create")) {
		PutField_CString(hRequest, "r_create_ts_from", cs_r_ts_from);
		PutField_CString(hRequest, "r_create_ts_to", cs_r_ts_to);
	} else if (!strcmp(cs_create_stmt_ts_ind, "stmt")) {
		PutField_CString(hRequest, "r_stmt_ts_from", cs_r_ts_from);
		PutField_CString(hRequest, "r_stmt_ts_to", cs_r_ts_to);
	} else {
		printf("invalid input\n");
		return (iRet);
	}

DEBUGLOG(("Authorize:: cs_r_provider_id = [%s]\n", cs_r_provider_id));
	if (strcmp(cs_r_provider_id, "")) {
		PutField_CString(hRequest, "r_provider_id", cs_r_provider_id);
	}

DEBUGLOG(("Authorize:: cs_r_pid = [%s]\n", cs_r_pid));
	if (strcmp(cs_r_pid, "")) {
		PutField_CString(hRequest, "r_pid", cs_r_pid);
	}

DEBUGLOG(("Authorize:: cs_r_txn_amt = [%s]\n", cs_r_txn_amt));
	if (strcmp(cs_r_txn_amt, "")) {
		PutField_CString(hRequest, "r_txn_amt", cs_r_txn_amt);
	}

DEBUGLOG(("Authorize:: cs_add_user = [%s]\n", cs_add_user));
	PutField_CString(hRequest, "add_user", cs_add_user);

	PutField_Int(hRequest, "execute", PD_TRUE);

	if (iRet == PD_OK){
DEBUGLOG(("Authorize:: Call TxnOmtByUsSAR:Authorize()\n"));
		TxnObjPtr = CreateObj(TxnPtr, "TxnOmtByUsSAR", "Authorize");
		iRet = (unsigned long)(*TxnObjPtr)(hContext, hRequest, hResponse);
	}

DEBUGLOG(("semi_auto_recon Normal Exit() iRet = [%d]\n", iRet));
	FREE_ME(hRequest);
	FREE_ME(hContext);
	FREE_ME(hResponse);
	return iRet;
}

int batch_terminate(int argc, char* argv[])
{
	return SUCCESS;
}


int parse_arg(int argc, char **argv)
{
	char c;
	strcpy(cs_create_stmt_ts_ind, "");
	strcpy(cs_s_ts_from, "");
	strcpy(cs_s_ts_to, "");
	strcpy(cs_s_provider_id, "");
	strcpy(cs_s_pid, "");
	strcpy(cs_s_txn_amt, "");
	strcpy(cs_r_ts_from, "");
	strcpy(cs_r_ts_to, "");
	strcpy(cs_r_provider_id, "");
	strcpy(cs_r_pid, "");
	strcpy(cs_r_txn_amt, "");
	strcpy(cs_add_user, "");

	while ((c = getopt(argc, argv, "a:b:c:d:e:f:g:h:i:j:k:l:")) != EOF) {
		switch (c) {
			case 'a':
				strcpy(cs_create_stmt_ts_ind, optarg);
				break;
			case 'b':
				strcpy(cs_s_ts_from, optarg);
				break;
			case 'c':
				strcpy(cs_s_ts_to, optarg);
				break;
			case 'd':
				strcpy(cs_s_provider_id, optarg);
				break;
			case 'e':
				strcpy(cs_s_pid, optarg);
				break;
			case 'f':
				strcpy(cs_s_txn_amt, optarg);
				break;
			case 'g':
				strcpy(cs_r_ts_from, optarg);
				break;
			case 'h':
				strcpy(cs_r_ts_to, optarg);
				break;
			case 'i':
				strcpy(cs_r_provider_id, optarg);
				break;
			case 'j':
				strcpy(cs_r_pid, optarg);
				break;
			case 'k':
				strcpy(cs_r_txn_amt, optarg);
				break;
			case 'l':
				strcpy(cs_add_user, optarg);
				break;
			default:
				return FAILURE;
		}
	}

	if (!strcmp(cs_create_stmt_ts_ind, "") ||
		!strcmp(cs_s_ts_from, "") || !strcmp(cs_s_ts_to, "") ||
		!strcmp(cs_s_pid, "") ||
		!strcmp(cs_r_ts_from, "") || !strcmp(cs_r_ts_to, "") ||
		!strcmp(cs_r_pid, "") ||
		!strcmp(cs_add_user, ""))
		return FAILURE;

	return SUCCESS;
}
