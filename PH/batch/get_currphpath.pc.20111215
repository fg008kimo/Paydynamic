#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "batchcommon.h"
#include "common.h"
#include "utilitys.h"
#include "myhash.h"
#include "numutility.h"
#include "myrecordset.h"


#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode

int CreateCurrReportPath(unsigned char* csDate, unsigned char* csPspId, unsigned char* csCountry, unsigned char* csCurrentPath);
int GetCountry(unsigned char* csPspId, unsigned char* csCountry);

int batch_init(int argc, char* argv[])
{
	return SUCCESS;
}

int batch_proc(int argc, char* argv[])
{
        char    cs_outfile_name[PD_MAX_FILE_LEN + 1];
        char    cs_country[PD_COUNTRY_LEN + 1];

	if(argc==3){
		if(GetCountry((unsigned char*)argv[2],(unsigned char*)cs_country) != SUCCESS)
			return FAILURE;

		if (CreateCurrReportPath((unsigned char*)argv[1],
					(unsigned char*)argv[2],
					(unsigned char*)cs_country,
					(unsigned char*)cs_outfile_name) != SUCCESS)
			return FAILURE;
	}

	else{
		//if (CreateCurrReportPath(NULL,cs_outfile_name) != SUCCESS) 
                	return FAILURE;
	}
	
	printf("%s",cs_outfile_name);

	return SUCCESS;


}


int batch_terminate(int argc, char* argv[])
{
	return SUCCESS;
}


int GetCountry(unsigned char* csPspId, unsigned char* csCountry)
{
	EXEC SQL WHENEVER SQLERROR GOTO getcountry_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;

        EXEC SQL BEGIN DECLARE SECTION;
                varchar         hv_psp_id[PD_PSP_ID_LEN];

                varchar         v_country[PD_COUNTRY_LEN+1];
                short           ind_country= -1;

        EXEC SQL END DECLARE SECTION;

	hv_psp_id.len = strlen((const char*)csPspId);
        memcpy(hv_psp_id.arr,csPspId,hv_psp_id.len);

	EXEC SQL SELECT country 
		INTO :v_country:ind_country
		FROM psp_country
		WHERE psp_id = :hv_psp_id;

	if (ind_country >= 0) {
		v_country.arr[v_country.len] = '\0';
                strcpy((char*)csCountry,(const char*)v_country.arr);
		return SUCCESS;
	}
	else
	{
		return FAILURE;
	}

getcountry_error:
	return FAILURE;

}


int CreateCurrReportPath(unsigned char* csDate, unsigned char* csPspId, unsigned char* csCountry, unsigned char* csCurrentPath)
{
        char    csHostDate[PD_DATE_LEN + 1];
        char    cs_outfile_name[PD_MAX_FILE_LEN + 1];

	if(strcmp((const char *)csDate,"N")){
		strcpy(csHostDate,(const char *)csDate);
		csHostDate[PD_DATE_LEN]='\0';
	}
	else{
        	if (GetCurrHostPostingDate((unsigned char *)csHostDate) != SUCCESS)
                	return FAILURE;
	}

/* create report path */
        sprintf((char *)csCurrentPath, "%s", getenv("REPORT_HOME"));
        sprintf(cs_outfile_name, "mkdir %s >/dev/null 2>&1", csCurrentPath);
        system(cs_outfile_name);

        sprintf((char *)csCurrentPath, "%s/%.*s", getenv("REPORT_HOME"),PD_YYYY_LEN,csHostDate);
        sprintf(cs_outfile_name, "mkdir %s >/dev/null 2>&1", csCurrentPath);
        system(cs_outfile_name);

        sprintf((char *)csCurrentPath, "%s/%.*s/%.*s", getenv("REPORT_HOME"),PD_YYYY_LEN,csHostDate,PD_YYYYMM_LEN,csHostDate);
        sprintf(cs_outfile_name, "mkdir %s >/dev/null 2>&1", csCurrentPath);
        system(cs_outfile_name);

        sprintf((char *)csCurrentPath, "%s/%.*s/%.*s/%s", getenv("REPORT_HOME"),PD_YYYY_LEN,csHostDate,PD_YYYYMM_LEN,csHostDate,csHostDate);
        sprintf(cs_outfile_name, "mkdir %s >/dev/null 2>&1", csCurrentPath);
        system(cs_outfile_name);

        sprintf((char *)csCurrentPath, "%s/%.*s/%.*s/%s/%s", getenv("REPORT_HOME"),PD_YYYY_LEN,csHostDate,PD_YYYYMM_LEN,csHostDate,csHostDate,csCountry);
        sprintf(cs_outfile_name, "mkdir %s >/dev/null 2>&1", csCurrentPath);
        system(cs_outfile_name);

        sprintf((char *)csCurrentPath, "%s/%.*s/%.*s/%s/%s/%s", getenv("REPORT_HOME"),PD_YYYY_LEN,csHostDate,PD_YYYYMM_LEN,csHostDate,csHostDate,csCountry,csPspId);
        sprintf(cs_outfile_name, "mkdir %s >/dev/null 2>&1", csCurrentPath);
        system(cs_outfile_name);

/* create report data folder if not created */
        sprintf(cs_outfile_name, "mkdir %s >/dev/null 2>&1", getenv("REPORT_DATA"));
       system(cs_outfile_name);

        return SUCCESS;
}
