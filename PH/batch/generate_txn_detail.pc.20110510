/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010/10/26              LokMan Chow
add summary					   2010/11/22		   LokMan Chow
add field: EC2 ref no.
*/
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <sqlca.h>
#include <sys/types.h>
#include <time.h>
#include "batchcommon.h"
#include "common.h"
#include "utilitys.h"
#include "myhash.h"
#include "numutility.h"
#include "myrecordset.h"


#define SQLCA_STORAGE_CLASS extern
#define SQLCODE sqlca.sqlcode
#define	PD_MY_DELIMITOR	','
#define	PD_TR		"<tr>"
#define	PD_TD		"<td>"
#define	PD_TD_STYLE	"<td class=\"format\">"
#define	PD_TR_END	"</tr>"
#define	PD_TD_END	"</td>"
#define START_POS	3
#define CONTENT_POS	9

char    cs_txn_date[PD_DATE_LEN + 1];
char    cs_summary[PD_MAX_FILE_LEN + 1];
char    cs_psp_id[PD_PSP_ID_LEN + 1];
char    cDebug;

int parse_arg(int argc,char **argv);
int process_txn(unsigned char* csTxnDate, unsigned char* csPspId);
int create_summary(FILE *fp, unsigned char* csTxnDate, unsigned char* csPspId);
int batch_init(int argc, char* argv[])
{

    if (argc < 2) {
        printf("usage:  -d txn_date -p psp_id -o summary file\n");
        return FAILURE;
    }
    else
        return SUCCESS;
}




int batch_proc(int argc, char* argv[])
{
        int     iRet;

	iRet = parse_arg(argc,argv);
               
        if (iRet != SUCCESS) {
        	printf("usage:  -d txn_date -p psp_id -o summary file\n");
                return (iRet);
        }


	printf("<html><body><table>\n");
	printf("%s%sPH Txn ID%s%sPH Txn Code%s%sPH Status%s%sAR_IND%s%sPH Response Code%s%sClient Name%s%sMerchant ID%s%sMerchant Refernece%s%sEC2 Refernece%s%sPSP Name%s%sPSP Txn ID%s%sBank Bill No.%s%sTxn Ccy%s%sTxn Amount%s%sPSP Service Fee%s%sPH Posting Date%s%sMerchant Txn Date%s%sPH Txn Date%s%sPSP Txn Date%s%sLast Update Date%s%s\n",PD_TR,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TD,PD_TD_END,PD_TR_END);
	printf("<style type=\"text/css\"> .format{ mso-number-format:'\\@';} </style>\n");


        iRet = process_txn(cs_txn_date, cs_psp_id);

	printf("</table></body></html>\n");


	if(iRet==SUCCESS){
		FILE *fp;
		fp = fopen(cs_summary,"w");
		if (fp != NULL){
			iRet = create_summary(fp, cs_txn_date, cs_psp_id);
		}
		else
DEBUGLOG(("batch_proc:unable to open [%s]\n",cs_summary));

		fclose(fp);
	}
	return iRet;


}


int batch_terminate(int argc, char* argv[])
{
	return SUCCESS;
}




int process_txn(unsigned char* csTxnDate, unsigned char* csPspId)
{               
 
        int     iRet = SUCCESS;
	char	*csTmp;
	char	*csEcRef;
        
        EXEC SQL WHENEVER SQLERROR GOTO sql_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
        
        EXEC SQL BEGIN DECLARE SECTION;
		
		varchar	hv_txn_date[PD_DATE_LEN];
		varchar	hv_psp_id[PD_PSP_ID_LEN];

		varchar	v_txn_id[PD_TXN_SEQ_LEN + 1];
		char	v_status;
		char	v_ar_ind;
		int	v_internal_code;
		varchar	v_response_code[PD_RESPONSE_CODE_LEN + 1];
		varchar	v_merchant_id[PD_MERCHANT_ID_LEN + 1];
		varchar	v_merchant_ref[PD_MERCHANT_REF_LEN + 1];
		varchar	v_psp_name[PD_PSP_NAME_LEN + 1];
		varchar	v_tid[PD_MERCHANT_REF_LEN +1];
		varchar	v_txn_ccy[PD_CCY_ID_LEN + 1];
		double	v_txn_amount;
		double	v_service_fee;
		varchar	v_merchant_txn_date[PD_DATE_LEN + PD_TIME_LEN +1];
		varchar	v_local_txn_date[PD_DATE_LEN +1];
		varchar	v_local_txn_time[PD_DATE_LEN +1];
		varchar	v_psp_txn_date[PD_DATE_LEN + 1];
		varchar	v_host_posting_date[PD_DATE_LEN + 1];
		varchar v_txn_code_desc[PD_DESC_LEN +1];
		varchar v_txn_code[PD_TXN_CODE_LEN +1];
		varchar v_client_name[PD_CLIENT_NAME_LEN +1];
		varchar v_last_updatetime[PD_DATE_LEN + PD_TIME_LEN +1];
		varchar v_bill_no[PD_BANK_BILL_NO_LEN +1];

		short	ind_txn_id = -1;
		short	ind_status = -1;
		short	ind_ar_ind = -1;
		short	ind_internal_code = -1;
		short	ind_response_code = -1;
		short	ind_merchant_id = -1;
		short	ind_merchant_ref = -1;
		short	ind_psp_name = -1;
		short	ind_tid = -1;
		short	ind_txn_ccy = -1;
		short	ind_txn_amount = -1;
		short	ind_service_fee = -1;
		short	ind_merchant_txn_date = -1;
		short	ind_local_txn_date = -1;
		short	ind_local_txn_time = -1;
		short	ind_psp_txn_date = -1;
		short	ind_host_posting_date = -1;
		short	ind_txn_code_desc = -1;
		short	ind_txn_code = -1;
		short	ind_client_name = -1;
		short	ind_last_updatetime = -1;
		short	ind_bill_no = -1;


	EXEC SQL END DECLARE SECTION;

	hv_txn_date.len = strlen(csTxnDate);
        memcpy(hv_txn_date.arr,csTxnDate,hv_txn_date.len);

	hv_psp_id.len = strlen(csPspId);
        memcpy(hv_psp_id.arr,csPspId,hv_psp_id.len);


        EXEC SQL DECLARE c_cursor_gettxn CURSOR FOR
		select 	th_txn_id,
         		th_status,
         		th_ar_ind,
         		th_internal_code,
         		th_response_code,
         		th_merchant_id,
         		th_merchant_ref,
         		psp_name,
         		tp_tid,
         		tp_txn_ccy,
         		th_transaction_amount,
         		tp_service_fee,
			th_transmission_datetime,
         		th_local_tm_date,
         		th_local_tm_time,
         		tp_txn_date,
			th_host_posting_date,
			tc_desc,
			th_txn_code,
			to_char(th_update_timestamp,'yyyymmddhh24miss'),
			client_name,
			tp_bank_bill_no
		  from 	txn_header,
        		txn_detail,
        		txn_psp_detail,
			txn_code,
			psp_detail,
			clients
		where	txn_header.th_txn_id = txn_detail.td_txn_id
    		and txn_header.th_txn_id = txn_psp_detail.tp_txn_id
    		and txn_header.th_host_posting_date = :hv_txn_date
		and txn_header.th_txn_code = txn_code.tc_code
		and psp_detail.psp_id = :hv_psp_id 
		and txn_psp_detail.tp_psp_id  = :hv_psp_id
		and txn_header.th_client_id = clients.client_id
		
		order by th_txn_id;
                
        EXEC SQL OPEN c_cursor_gettxn;
        do {    
                EXEC SQL FETCH c_cursor_gettxn
                INTO
		 	v_txn_id:ind_txn_id,
         		v_status:ind_status,
         		v_ar_ind:ind_ar_ind,
         		v_internal_code:ind_internal_code,
         		v_response_code:ind_response_code,
         		v_merchant_id:ind_merchant_id,
         		v_merchant_ref:ind_merchant_ref,
         		v_psp_name:ind_psp_name,
         		v_tid:ind_tid,
         		v_txn_ccy:ind_txn_ccy,
         		v_txn_amount:ind_txn_amount,
         		v_service_fee:ind_service_fee,
         		v_merchant_txn_date:ind_merchant_txn_date,
         		v_local_txn_date:ind_local_txn_date,
         		v_local_txn_time:ind_local_txn_time,
         		v_psp_txn_date:ind_psp_txn_date,
			v_host_posting_date:ind_host_posting_date,
			v_txn_code_desc:ind_txn_code_desc,
			v_txn_code:ind_txn_code,
			v_last_updatetime:ind_last_updatetime,
			v_client_name:ind_client_name,
			v_bill_no:ind_bill_no;

                if (SQLCODE == SQL_NOT_FOUND) {
                        break;
                }
		printf("%s",PD_TR);
/* txn id */
		if (ind_txn_id < 0 )
			v_txn_id.arr[0] = '\0';
		printf("%s%.*s%s",PD_TD_STYLE,v_txn_id.len,v_txn_id.arr,PD_TD_END);

/* txn_desc  */
		if (ind_txn_code_desc < 0 )
			v_txn_code_desc.arr[0] = '\0';
		printf("%s%.*s%s",PD_TD,v_txn_code_desc.len,v_txn_code_desc.arr,PD_TD_END);
/* status */
		if (ind_status < 0 )
			csTmp = strdup("");
		else {
			if (v_status == 'C')
				csTmp = strdup("Completed");
			else if(v_status == 'W') 
				csTmp = strdup("Pending");
			else
				csTmp = strdup("Processing");
		}
	 	printf("%s%s%s",PD_TD,csTmp,PD_TD_END);
		FREE_ME(csTmp);
/* ar ind */
		if (ind_ar_ind < 0 )
			csTmp = strdup("");
		else {
			if (v_ar_ind == 'A')
				csTmp = strdup("Accept");
			else 
				csTmp = strdup("Reject");
		}
	 	printf("%s%s%s",PD_TD,csTmp,PD_TD_END);
		FREE_ME(csTmp);

/* internal_code */
//		if (ind_internal_code < 0)
//			v_internal_code = 0;
//	 	printf("%s%d%s",PD_TD,v_internal_code,PD_TD_END);

/* response_code */
		if (ind_response_code < 0 )
			v_response_code.arr[0] = '\0';
		printf("%s%.*s%s",PD_TD,v_response_code.len,v_response_code.arr,PD_TD_END);

/* client_name */
		if (ind_client_name < 0 )
			v_client_name.arr[0] = '\0';
		printf("%s%.*s%s",PD_TD,v_client_name.len,v_client_name.arr,PD_TD_END);

/* merchant_id */
		if (ind_merchant_id < 0 )
			v_merchant_id.arr[0] = '\0';
		printf("%s%.*s%s",PD_TD_STYLE,v_merchant_id.len,v_merchant_id.arr,PD_TD_END);

/* merchant_ref */
		if (ind_merchant_ref < 0 )
			v_merchant_ref.arr[0] = '\0';
		printf("%s%.*s%s",PD_TD_STYLE,v_merchant_ref.len,v_merchant_ref.arr,PD_TD_END);

/* EC2_ref */
		if(ind_txn_code<0)
			v_txn_code.arr[0] = '\0';
	
		if(strncmp(v_txn_code.arr,PD_DEPOSIT_TXN_CODE,PD_TXN_CODE_LEN)==0){
			csEcRef = strdup("");
			strcpy(csEcRef,v_merchant_ref.arr);
			csEcRef[v_merchant_ref.len]='\0';
			printf("%s%c%s%s",PD_TD_STYLE,csEcRef[START_POS],&csEcRef[CONTENT_POS],PD_TD_END);
			FREE_ME(csEcRef);
		}
		else
			printf("%s%s",PD_TD_STYLE,PD_TD_END);

/* psp_name */
		if (ind_psp_name < 0 )
			v_psp_name.arr[0] = '\0';
		printf("%s%.*s%s",PD_TD,v_psp_name.len,v_psp_name.arr,PD_TD_END);

/* tid */
		if (ind_tid < 0 )
			v_tid.arr[0] = '\0';
		printf("%s%.*s%s",PD_TD_STYLE,v_tid.len,v_tid.arr,PD_TD_END);

/* bank_bill_no */
		if (ind_bill_no< 0 ){
			strcpy(v_bill_no.arr,"N/A");
			v_bill_no.len=strlen("N/A");
		}
		printf("%s%.*s%s",PD_TD_STYLE,v_bill_no.len,v_bill_no.arr,PD_TD_END);

/* txn_ccy */
		if (ind_txn_ccy < 0 )
			v_txn_ccy.arr[0] = '\0';
		printf("%s%.*s%s",PD_TD,v_txn_ccy.len,v_txn_ccy.arr,PD_TD_END);

/* txn_amount */
		if (ind_txn_amount < 0 )
			v_txn_amount = 0;	
		printf("%s%f%s",PD_TD,v_txn_amount,PD_TD_END);

/* service_fee */
		if (ind_service_fee < 0 )
			v_service_fee = 0;	
		printf("%s%f%s",PD_TD,v_service_fee,PD_TD_END);

/* host posting date */
		if (ind_host_posting_date < 0 )
			v_host_posting_date.arr[0] = '\0';
		printf("%s%.*s%s",PD_TD_STYLE,v_host_posting_date.len,v_host_posting_date.arr,PD_TD_END);

/* merchant_txn_date */
		if (ind_merchant_txn_date < 0 )
			v_merchant_txn_date.arr[0] = '\0';
		printf("%s%.*s%s",PD_TD_STYLE,v_merchant_txn_date.len,v_merchant_txn_date.arr,PD_TD_END);

/* local_txn_date */
		if (ind_local_txn_date < 0 )
			v_local_txn_date.arr[0] = '\0';

		if (ind_local_txn_time < 0 )
			v_local_txn_time.arr[0] = '\0';
		printf("%s%.*s %.*s%s",PD_TD_STYLE,v_local_txn_date.len,v_local_txn_date.arr,v_local_txn_time.len,v_local_txn_time.arr,PD_TD_END);

/* psp_txn_date */
		if (ind_psp_txn_date < 0 )
			v_psp_txn_date.arr[0] = '\0';
		printf("%s%.*s%s",PD_TD_STYLE,v_psp_txn_date.len,v_psp_txn_date.arr,PD_TD_END);

/* last_updatetime */
		if (ind_last_updatetime < 0 )
			v_last_updatetime.arr[0] = '\0';
		printf("%s%.*s%s",PD_TD_STYLE,v_last_updatetime.len,v_last_updatetime.arr,PD_TD_END);

		printf("%s\n",PD_TR_END);
 	}
        while(PD_TRUE && iRet == SUCCESS);

        EXEC SQL CLOSE c_cursor_gettxn;
        return iRet;
sql_error:
    DEBUGLOG(("process_txn error code %d\n", sqlca.sqlcode));
    DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL CLOSE c_cursor_gettxn;
    EXEC SQL ROLLBACK RELEASE;
    return FAILURE;
}


int parse_arg(int argc,char **argv)
{
        char    c;
	strcpy(cs_txn_date,"");
	strcpy(cs_summary,"");
	strcpy(cs_psp_id,"");

        while ((c = getopt(argc,argv,"d:p:o:")) != EOF) {
                switch (c) {
                        case 'd':
                                strcpy(cs_txn_date, optarg);
                                break;
                        case 'p':
                                strcpy(cs_psp_id, optarg);
                                break;
                        case 'o':
                                strcpy(cs_summary, optarg);
                                break;
                        default:
                                return FAILURE;
                }
        }

        if (!strcmp(cs_txn_date,"") || !strcmp(cs_summary,"") || !strcmp(cs_psp_id,""))
                return FAILURE;

        return SUCCESS;
}


int create_summary(FILE *fp, unsigned char* csTxnDate, unsigned char* csPspId)
{
	int iRet = SUCCESS;

	EXEC SQL WHENEVER SQLERROR GOTO sum_error;
        EXEC SQL WHENEVER NOTFOUND CONTINUE;
                        
        EXEC SQL BEGIN DECLARE SECTION;
	
		varchar hv_txn_date[PD_DATE_LEN];
		varchar hv_psp_id[PD_PSP_ID_LEN];

		int	vAccepted;
		double	vAcceptAmt;
		int	vRejected;
		double	vRejectAmt;
		int	vPending;
		double	vPendingAmt;
	
		short	indAccepted=-1;
		short	indAcceptAmt=-1;
		short	indRejectAmt=-1;
		short	indRejected=-1;
		short	indPending=-1;
		short	indPendingAmt=-1;
	EXEC SQL END DECLARE SECTION;

        hv_txn_date.len = strlen(csTxnDate);
        memcpy(hv_txn_date.arr,csTxnDate,hv_txn_date.len);

        hv_psp_id.len = strlen(csPspId);
        memcpy(hv_psp_id.arr,csPspId,hv_psp_id.len);

	fprintf(fp,"<html><body><table>\n");
	fprintf(fp,"<tr><td>Txn Deail Summary</td></tr>\n");
	fprintf(fp,"<tr><td></td></tr>\n");
        fprintf(fp,"<tr><td>Deposit:</td><td>Count</td><td>Amount</td></tr>\n");


	EXEC SQL EXECUTE
		BEGIN

		select sum(th_transaction_amount) , count(th_txn_id)
		into :vAcceptAmt:indAcceptAmt, :vAccepted:indAccepted
		from txn_header, txn_psp_detail
		where th_host_posting_date = :hv_txn_date
		and   th_ar_ind='A'
		and   th_txn_code='DSP'
		and   th_txn_id=tp_txn_id
		and   tp_psp_id=:hv_psp_id;

		END;
	END-EXEC;

	EXEC SQL EXECUTE
		BEGIN

		select sum(th_transaction_amount) , count(th_txn_id)
		into :vRejectAmt:indRejectAmt, :vRejected:indRejected
		from txn_header, txn_psp_detail
		where th_host_posting_date = :hv_txn_date
		and   th_ar_ind='R'
		and   th_txn_code='DSP'
		and   th_txn_id=tp_txn_id
                and   tp_psp_id=:hv_psp_id;


		END;
	END-EXEC;

	EXEC SQL EXECUTE
		BEGIN

		select sum(th_transaction_amount) , count(th_txn_id)
		into :vPendingAmt:indPendingAmt, :vPending:indPending
		from txn_header, txn_psp_detail
		where th_host_posting_date = :hv_txn_date
		and   th_status='W'
		and   th_txn_code='DSP'
		and   th_txn_id=tp_txn_id
                and   tp_psp_id=:hv_psp_id;

		END;
	END-EXEC;

	if(indAcceptAmt<0)	vAcceptAmt=0;
	if(indAccepted<0)	vAccepted=0;
	fprintf(fp,"<tr><td>[ Accepted ]</td><td>%d</td><td>%f</td></tr>\n",vAccepted,vAcceptAmt);

	if(indRejectAmt<0)	vRejectAmt=0;
	if(indRejected<0)	vRejected=0;
	fprintf(fp,"<tr><td>[ Rejected ]</td><td>%d</td><td>%f</td></tr>\n",vRejected,vRejectAmt);

	if(indPendingAmt<0)	vPendingAmt=0;
	if(indPending<0)	vPending=0;
	fprintf(fp,"<tr><td>[ Pending ]</td><td>%d</td><td>%f</td></tr>\n",vPending,vPendingAmt);

	fprintf(fp,"<tr><td>Total:</td><td>%d</td><td>%f</td></tr>\n",vAccepted+vRejected+vPending,vAcceptAmt+vRejectAmt+vPendingAmt);

	fprintf(fp,"<tr><td></td></tr>\n");
	fprintf(fp,"<tr><td>Withdrawal:</td><td>Count</td><td>Amount</td></tr>\n");
	
	EXEC SQL EXECUTE
		BEGIN

		select sum(th_transaction_amount) , count(th_txn_id)
		into :vAcceptAmt:indAcceptAmt, :vAccepted:indAccepted
		from txn_header, txn_psp_detail
		where th_host_posting_date = :hv_txn_date
		and   th_ar_ind='A'
		and   th_txn_code in('WTB','WTD')
		and   th_txn_id=tp_txn_id
                and   tp_psp_id=:hv_psp_id;

		END;
	END-EXEC;

	EXEC SQL EXECUTE
		BEGIN

		select sum(th_transaction_amount) , count(th_txn_id)
		into :vRejectAmt:indRejectAmt, :vRejected:indRejected
		from txn_header, txn_psp_detail
		where th_host_posting_date = :hv_txn_date
		and   th_ar_ind='R'
		and   th_txn_code in('WTB','WTD')
		and   th_txn_id=tp_txn_id
                and   tp_psp_id=:hv_psp_id;

		END;
	END-EXEC;

	EXEC SQL EXECUTE
		BEGIN

		select sum(th_transaction_amount) , count(th_txn_id)
		into :vPendingAmt:indPendingAmt, :vPending:indPending
		from txn_header, txn_psp_detail
		where th_host_posting_date = :hv_txn_date
		and   th_status='W'
		and   th_txn_code in('WTB','WTD')
		and   th_txn_id=tp_txn_id
                and   tp_psp_id=:hv_psp_id;

		END;
	END-EXEC;

	if(indAcceptAmt<0)	vAcceptAmt=0;
	if(indAccepted<0)	vAccepted=0;
	fprintf(fp,"<tr><td>[ Accepted ]</td><td>%d</td><td>%f</td></tr>\n",vAccepted,vAcceptAmt);

	if(indRejectAmt<0)	vRejectAmt=0;
	if(indRejected<0)	vRejected=0;
	fprintf(fp,"<tr><td>[ Rejected ]</td><td>%d</td><td>%f</td></tr>\n",vRejected,vRejectAmt);

	if(indPendingAmt<0)	vPendingAmt=0;
	if(indPending<0)	vPending=0;
	fprintf(fp,"<tr><td>[ Pending ]</td><td>%d</td><td>%f</td></tr>\n",vPending,vPendingAmt);

	fprintf(fp,"<tr><td>Total:</td><td>%d</td><td>%f</td></tr>\n",vAccepted+vRejected+vPending,vAcceptAmt+vRejectAmt+vPendingAmt);

	fprintf(fp,"</table></body></html>\n");
	return iRet;

sum_error:
    DEBUGLOG(("create summary error code %d\n", sqlca.sqlcode));
    DEBUGLOG(("\n%.*s\n", sqlca.sqlerrm.sqlerrml, sqlca.sqlerrm.sqlerrmc));
    EXEC SQL WHENEVER SQLERROR CONTINUE;
    EXEC SQL ROLLBACK RELEASE;
    return FAILURE;
}
