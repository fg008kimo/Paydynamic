#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "FepMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"

char	cDebug;

void	FepMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;

	char*	csTxnCode = NULL;
	char*	csPtr = NULL;
	char*	csURL = NULL;
	char* 	csBuf;
	double	dTmp;


	//double	dTmp;
DEBUGLOG(("FormatMsg()\n"));

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );
//txn code
	if (GetField_CString(hIn,"txn_code",&csTxnCode)) {
DEBUGLOG(("FormatMsg:: txn_code = [%s]\n",csTxnCode));
	}

	outMsg[0]= '\0';
//psp_url
	if (GetField_CString(hIn,"psp_url",&csURL)) {
//request_function
		strcpy((char*)csBuf,"TC");
		strcat((char*)csBuf,MY_FEP_FIELD_TOKEN);
		strcat((char*)csBuf,csTxnCode);
		strcat((char*)csBuf,MY_FEP_TOKEN);

		if (GetField_CString(hIn,"request_function",&csPtr)) {
			strcat((char*)csBuf,"url");
DEBUGLOG(("FormatMsg:: psp_url = [%s]\n",csURL));
			strcat((char*)csBuf,MY_FEP_FIELD_TOKEN);
			strcat((char*)csBuf,csURL);
			strcat((char*)csBuf,"/");
			strcat((char*)csBuf,csPtr);
			strcat((char*)csBuf,MY_FEP_TOKEN);
		}	
	

//action
		if (GetField_CString(hIn,"action",&csPtr)) {
			strcat((char*)csBuf,"action");
DEBUGLOG(("FormatMsg:: action = [%s]\n",csPtr));
			strcat((char*)csBuf,MY_FEP_FIELD_TOKEN);
			strcat((char*)csBuf,csPtr);
//***
                        strcat((char*)csBuf, MY_FEP_TOKEN);
		}	
		sprintf((char*)outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));
		strcat((char*)outMsg,csBuf);
	}
	FREE_ME(csBuf);
//mor
	if (GetField_CString(hIn,"txn_seq",&csPtr)) {
DEBUGLOG(("FormatMsg:: mor = [%s]\n",csPtr));
		strcat((char*)outMsg,"mor");
		strcat((char*)outMsg,MY_FEP_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_FEP_TOKEN);
//rmak1
		strcat((char*)outMsg,"rmak1");
		strcat((char*)outMsg,MY_FEP_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_FEP_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: mor is missing\n"));
	}
//tr_at
	if (GetField_CString(hIn,"tr_at",&csPtr)) {
DEBUGLOG(("FormatMsg:: tr_at = [%s]\n",csPtr));
		strcat((char*)outMsg,"tr_at");

		strcat((char*)outMsg,MY_FEP_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_FEP_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: tr_at is missing\n"));
	}
//mno
	if (GetField_CString(hIn,"customer_tel",&csPtr)) {

DEBUGLOG(("FormatMsg:: mno = [%s]\n",csPtr));
		strcat((char*)outMsg,"mno");

		strcat((char*)outMsg,MY_FEP_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_FEP_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: mno is missing\n"));
	}
//tramt
	if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {
		char    csTmpAmt[PD_TMP_BUF_LEN +1];
                sprintf(csTmpAmt,"%.2f",dTmp);
DEBUGLOG(("FormatMsg:: tramt = [%s]\n",csTmpAmt));
                strcat((char*)outMsg,"tramt");
                strcat((char*)outMsg,MY_FEP_FIELD_TOKEN);
                strcat((char*)outMsg,csTmpAmt);
                strcat((char*)outMsg,MY_FEP_TOKEN);
	}
	else{
DEBUGLOG(("FormatMsg:: tramt is missing\n"));
	}

// trdt
        if (GetField_CString(hIn,"local_tm_date",&csPtr)) {
DEBUGLOG(("FormatMsg:: local_tm_date = [%s]\n",csPtr));
		char* 	csPtr2;
		char	csDateTime[PD_DATETIME_LEN * 2];
        	if (GetField_CString(hIn,"local_tm_time",&csPtr2)) {
DEBUGLOG(("FormatMsg:: local_tm_time = [%s]\n",csPtr2));
			sprintf(csDateTime,"%s-%.*s:%.*s:%.*s",csPtr,2,csPtr2,2,&csPtr2[2],2,&csPtr[4]);
DEBUGLOG(("FormatMsg:: trdt = [%s]\n",csDateTime));
			strcat((char*)outMsg,"trdt");
			strcat((char*)outMsg,MY_FEP_FIELD_TOKEN);
			strcat((char*)outMsg,csDateTime);
			strcat((char*)outMsg,MY_FEP_TOKEN);
		}
		else {
DEBUGLOG(("FormatMsg:: local_tm_time is missing!!!\n"));
		}
        }
        else {
DEBUGLOG(("FormatMsg:: local_tm_date is missing!!!\n"));
        }

//bcd
	if (GetField_CString(hIn,"bank_code",&csPtr)) {
DEBUGLOG(("FormatMsg:: bcd = [%s]\n",csPtr));
		strcat((char*)outMsg,"bcd");
		strcat((char*)outMsg,MY_FEP_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_FEP_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: bcd not found!!!\n"));
	}
//fcode
	if (GetField_CString(hIn,"fcode",&csPtr)) {
DEBUGLOG(("FormatMsg:: fcode = [%s]\n",csPtr));
		strcat((char*)outMsg,"fcode");
		strcat((char*)outMsg,MY_FEP_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_FEP_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: fcode not found!!!\n"));
	}
//murl
	if (GetField_CString(hIn,"be_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: be_url = [%s]\n",csPtr));
		strcat((char*)outMsg,"murl");

		strcat((char*)outMsg,MY_FEP_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_FEP_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: be_url not found!!!\n"));
	}

//ersv1

	if (GetField_CString(hIn,"sign",&csPtr)) {
DEBUGLOG(("FormatMsg:: ersv1 = [%s]\n",csPtr));
		strcat((char*)outMsg,"ersv1");

		strcat((char*)outMsg,MY_FEP_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_FEP_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: ersv1 not found!!!\n"));
	}

//psp_merchant_id
	if (GetField_CString(hIn,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("FormatMsg:: mid = [%s]\n",csPtr));
		strcat((char*)outMsg,"mid");

		strcat((char*)outMsg,MY_FEP_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_FEP_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: mid not found!!!\n"));
	}
//psp_key_uid
	if (GetField_CString(hIn,"psp_key_uid",&csPtr)) {
DEBUGLOG(("FormatMsg:: uid = [%s]\n",csPtr));
		strcat((char*)outMsg,"uid");

		strcat((char*)outMsg,MY_FEP_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_FEP_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: kid not found!!!\n"));
	}

//psp_key_id
	if (GetField_CString(hIn,"psp_key_id",&csPtr)) {
DEBUGLOG(("FormatMsg:: kid = [%s]\n",csPtr));
		strcat((char*)outMsg,"kid");

		strcat((char*)outMsg,MY_FEP_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_FEP_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: kid not found!!!\n"));
	}

DEBUGLOG(("outmsg = [%s]\n",outMsg));

	*outLen = strlen((const char*)outMsg);
DEBUGLOG(("FormatMsg() [%s][%d]\n",outMsg,*outLen));
DEBUGLOG(("FormatMsg() Exit\n"));
	FREE_ME(csTxnCode);
	FREE_ME(csPtr);
	FREE_ME(csURL);
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csPtr;
	hash_t  *hRec;

        hRec = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hRec,0);
                
DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));
                                
        if (Str2Cls(hRec,(char*)inMsg,MY_FEP_TOKEN, MY_FEP_FIELD_TOKEN) == PD_OK) {

/* txn_seq */
		if (GetField_CString(hRec,"mor",&csPtr)) {
			PutField_CString(hOut,"txn_seq",csPtr);
DEBUGLOG(("BreakDownMsg:: txn_seq[mor] = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: mor not found\n"));
		}

/* status */
		if (GetField_CString(hRec,"notice_status",&csPtr)) {
			PutField_CString(hOut,"notice_status",csPtr);
DEBUGLOG(("BreakDownMsg:: notice_status = [%s]\n",csPtr));
		}

/* error_code */
		if (GetField_CString(hRec,"error_code",&csPtr)) {
			PutField_CString(hOut,"error_code",csPtr);
DEBUGLOG(("BreakDownMsg:: error_code = [%s]\n",csPtr));
		}
/* fcode */
		if (GetField_CString(hRec,"fcode",&csPtr)) {
			PutField_CString(hOut,"fcode",csPtr);
DEBUGLOG(("BreakDownMsg:: fcode = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: fcode not found\n"));
		}

/* odn */
		if (GetField_CString(hRec,"odn",&csPtr)) {
			PutField_CString(hOut,"odn",csPtr);
DEBUGLOG(("BreakDownMsg:: odn = [%s]\n",csPtr));
		}
/* pdt */
		if (GetField_CString(hRec,"pdt",&csPtr)) {
			PutField_CString(hOut,"pdt",csPtr);
DEBUGLOG(("BreakDownMsg:: pdt = [%s]\n",csPtr));
		}
/* tr_at */
		if (GetField_CString(hRec,"tr_at",&csPtr)) {
			PutField_CString(hOut,"tr_at",csPtr);
DEBUGLOG(("BreakDownMsg:: tr_at = [%s]\n",csPtr));
		}
/* tr_fl */
		if (GetField_CString(hRec,"tr_fl",&csPtr)) {
			PutField_CString(hOut,"tr_fl",csPtr);
DEBUGLOG(("BreakDownMsg:: tr_fl = [%s]\n",csPtr));
		}
/* sc */
		if (GetField_CString(hRec,"sc",&csPtr)) {
			PutField_CString(hOut,"sc",csPtr);
DEBUGLOG(("BreakDownMsg:: sc = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: sc not found\n"));
		}
/* sr */
		if (GetField_CString(hRec,"sr",&csPtr)) {
			PutField_CString(hOut,"sr",csPtr);
DEBUGLOG(("BreakDownMsg:: sr = [%s]\n",csPtr));
		}
/* tr_sta */
		if (GetField_CString(hRec,"tr_sta",&csPtr)) {
			PutField_CString(hOut,"status",csPtr);
DEBUGLOG(("BreakDownMsg:: tr_sta = [%s]\n",csPtr));
		}
/* rmak1 */
		if (GetField_CString(hRec,"rmak1",&csPtr)) {
			PutField_CString(hOut,"rmak1",csPtr);
DEBUGLOG(("BreakDownMsg:: rmak1 = [%s]\n",csPtr));
		}
/* rmak2 */
		if (GetField_CString(hRec,"rmak2",&csPtr)) {
			PutField_CString(hOut,"rmak2",csPtr);
DEBUGLOG(("BreakDownMsg:: rmak2 = [%s]\n",csPtr));
		}
/* ersv1 */
		if (GetField_CString(hRec,"ersv1",&csPtr)) {
			PutField_CString(hOut,"sign",csPtr);
DEBUGLOG(("BreakDownMsg:: ersv1 = [%s]\n",csPtr));
		}
/* ersv2 */
		if (GetField_CString(hRec,"ersv2",&csPtr)) {
			PutField_CString(hOut,"ersv2",csPtr);
DEBUGLOG(("BreakDownMsg:: ersv2 = [%s]\n",csPtr));
		}
/* kid */
		if (GetField_CString(hRec,"kid",&csPtr)) {
			PutField_CString(hOut,"kid",csPtr);
DEBUGLOG(("BreakDownMsg:: kid = [%s]\n",csPtr));
		}
/* mid */
		if (GetField_CString(hRec,"mid",&csPtr)) {
			PutField_CString(hOut,"mid",csPtr);
DEBUGLOG(("BreakDownMsg:: mid = [%s]\n",csPtr));
		}
/* uid */
		if (GetField_CString(hRec,"uid",&csPtr)) {
			PutField_CString(hOut,"uid",csPtr);
DEBUGLOG(("BreakDownMsg:: uid = [%s]\n",csPtr));
		}
/* tramt */
		if (GetField_CString(hRec,"tramt",&csPtr)) {
			PutField_CString(hOut,"tramt",csPtr);
DEBUGLOG(("BreakDownMsg:: tramt = [%s]\n",csPtr));
		}

	}
	else{
DEBUGLOG(("BreakDownMsg() Error\n"));
                iRet = PD_ERR;
        }

        hash_destroy(hRec);
        FREE_ME(hRec);
DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	char	*csTmp = NULL;
DEBUGLOG(("initReplyFromRequest()\n"));
	

/* order_num */
        if (GetField_CString(hRequest,"merchant_ref",&csTmp)) {
DEBUGLOG(("initReplyFromRequest: order_num = [%s]\n",csTmp));
                PutField_CString(hResponse,"order_num",csTmp);
        }


DEBUGLOG(("initReplyFromRequest() Exit\n"));
	FREE_ME(csTmp);
	return iRet;
}

int BuildAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr,*csDATA;
        char*   csBuf;
        double  dTmp;
        csDATA = (char*) malloc (PD_TMP_MSG_BUF_LEN  +1);
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildAuthData()\n"));
        memset(csDATA,0,sizeof(csDATA));

//mor
        if (GetField_CString(hIn,"txn_seq",&csPtr)) {
DEBUGLOG(("BuildAuthData:: mor = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildAuthData:: mor is missing\n"));
	}

//tr_at
        if (GetField_CString(hIn,"tr_at",&csPtr)) {
DEBUGLOG(("BuildAuthData:: tr_at = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildAuthData:: tr_at missing\n"));
	}
//mno
        if (GetField_CString(hIn,"customer_tel",&csPtr)) {
DEBUGLOG(("BuildAuthData:: mno = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildAuthData:: mno missing\n"));
	}

//tramt
	if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {
		char    csTmpAmt[PD_TMP_BUF_LEN +1];
                sprintf(csTmpAmt,"%.2f",dTmp);
DEBUGLOG(("BuildAuthData:: tramt = [%s]\n",csTmpAmt));
		strcat(csDATA,csTmpAmt);
	}
	else{
DEBUGLOG(("BuildAuthData:: tramt is missing\n"));
	}

//trdt
        if (GetField_CString(hIn,"local_tm_date",&csPtr)) {
DEBUGLOG(("BuildAuthData:: local_tm_date = [%s]\n",csPtr));
                char*   csPtr2;
                char    csDateTime[PD_DATETIME_LEN * 2];
                if (GetField_CString(hIn,"local_tm_time",&csPtr2)) {
DEBUGLOG(("BuildAuthData:: local_tm_time = [%s]\n",csPtr2));
                        sprintf(csDateTime,"%s-%.*s:%.*s:%.*s",csPtr,2,csPtr2,2,&csPtr2[2],2,&csPtr[4]);
DEBUGLOG(("FormatMsg:: trdt = [%s]\n",csDateTime));
                        strcat(csDATA,csDateTime);
                }
                else {
DEBUGLOG(("BuildAuthData:: local_tm_time is missing!!!\n"));
                }
        }
        else {
DEBUGLOG(("BuildAuthData:: local_tm_date is missing!!!\n"));
	}


//bcd
        if (GetField_CString(hIn,"bank_code",&csPtr)) {
DEBUGLOG(("BuildAuthData:: bcd = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildAuthData:: bcd missing\n"));
	}
//fcode
        if (GetField_CString(hIn,"fcode",&csPtr)) {
DEBUGLOG(("BuildAuthData:: fcode = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildAuthData:: fcode missing\n"));
	}
//murl
        if (GetField_CString(hIn,"be_url",&csPtr)) {
DEBUGLOG(("BuildAuthData:: murl = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildAuthData:: murl missing\n"));
	}

	PutField_CString(hIn,"auth_data",csDATA);
DEBUGLOG(("BuildAuthData:: auth_data = [%s]\n",csDATA));
        FREE_ME(csDATA);
DEBUGLOG(("BuildAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}
int BuildRspAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr,*csDATA;
        char*   csBuf;
        csDATA = (char*) malloc (PD_TMP_MSG_BUF_LEN  +1);
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildRspAuthData()\n"));
        memset(csDATA,0,sizeof(csDATA));

//sr
        if (GetField_CString(hIn,"status",&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: sr = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildRspAuthData:: sr is missing\n"));
	}
//mor
        if (GetField_CString(hIn,"txn_seq",&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: mor = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildRspAuthData:: mor is missing\n"));
	}
//odn
        if (GetField_CString(hIn,"odn",&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: odn = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildRspAuthData:: odn is missing\n"));
	}

//tr_at
        if (GetField_CString(hIn,"tr_at",&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: tr_at = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildRspAuthData:: tr_at missing\n"));
	}
//tr_sta
        if (GetField_CString(hIn,"status",&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: tr_sta = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildRspAuthData:: tr_sta missing\n"));
	}
//tr_fl
        if (GetField_CString(hIn,"tr_fl",&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: tr_fl = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildRspAuthData:: tr_fl missing\n"));
	}
//pdt
        if (GetField_CString(hIn,"pdt",&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: pdt = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildRspAuthData:: pdt missing\n"));
	}


//tramt
        if (GetField_CString(hIn,"tramt",&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: tramt = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildRspAuthData:: tramt missing\n"));
	}
//fcode
        if (GetField_CString(hIn,"fcode",&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: fcode = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildRspAuthData:: fcode missing\n"));
	}
//sc
        if (GetField_CString(hIn,"sc",&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: sc = [%s]\n",csPtr));
		strcat(csDATA,csPtr);
	}
	else {
DEBUGLOG(("BuildRspAuthData:: sc missing\n"));
	}

	PutField_CString(hIn,"auth_data",csDATA);
DEBUGLOG(("BuildRspAuthData:: auth_data = [%s]\n",csDATA));
        FREE_ME(csDATA);
DEBUGLOG(("BuildRspAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

