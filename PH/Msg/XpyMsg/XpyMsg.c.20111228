/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010	              	   Cody Chan
handle new psp: ESKY				   20110110		   LokMan Chow
identify currency code				   20110127		   LokMan Chow
bank code mapping				   20110223		   LokMan Chow
Add txn id to msg				   2011/11/14		   Cody Chan
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "XpyMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include "internal.h"
#include "ObjPtr.h"
#include "myrecordset.h"

#include "b64.h"
char	cDebug;

OBJPTR(Msg);
OBJPTR(DB);

void	XpyMsg(char cdebug)
{
	cDebug = cdebug;
}
int DEBlockXpayData(hash_t *hOut,const unsigned char *inMsg,int inLen);

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;

	char*	csPtr = NULL;
	char* 	csTmp;
	char	cStatus;
	char*	csBuf;
	char*	csPspChannel;

DEBUGLOG(("FormatMsg()\n"));
	outMsg[0]= '\0';
        *outLen = 0;
        if (GetField_Char(hIn,"status",&cStatus)) {
DEBUGLOG(("FormatMsg:: status = [%c]\n",cStatus));
                if (cStatus == PD_TO_PSP) {
			if (!GetField_CString(hIn,"psp_channel_code",&csPspChannel)) {
DEBUGLOG(("FormatMsg:: Psp Id Not Found!\n"));
			}
			else{
DEBUGLOG(("FormatMsg:: Psp Id = [%s]\n",csPspChannel));
				if(!strcmp(csPspChannel,PD_CHANNEL_TWV) ||
				!strcmp(csPspChannel,PD_CHANNEL_PGEN)) {
                        		if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: redirect_url = [%s]\n",csPtr));
                                		strcat((char*)outMsg,"redirect_url");
                                		strcat((char*)outMsg,"=");
                                		csBuf = (char*) malloc (PD_MAX_BUFFER +1);
                                		base64_encode((unsigned char*)csPtr,strlen(csPtr),csBuf,PD_MAX_BUFFER);
                                		strcat((char*)outMsg,csBuf);
						strcat((char*)outMsg,"?ret_status=0");
                                		*outLen = strlen((const char*)outMsg);
                                		FREE_ME(csBuf);
                        		}
                        		else {
DEBUGLOG(("FormatMsg redirect_url not found\n"));
ERRLOG("FormatMsg redirect_url not found\n");
                        		}
				}
				else if(!strcmp(csPspChannel,PD_CHANNEL_ESKY)){
//call ESkyMsg//
					MsgObjPtr = CreateObj(MsgPtr,"ESkyMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format ESkyMsg error\n"));
ERRLOG("FormatMsg format ESkyMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));

				}
				else if(!strcmp(csPspChannel,PD_CHANNEL_EEP)){
//call EepMsg//
					MsgObjPtr = CreateObj(MsgPtr,"EepMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format EepMsg error\n"));
ERRLOG("FormatMsg format EepMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));

				}
//call HpyMsg//
				else if(!strcmp(csPspChannel,PD_CHANNEL_HPAY)){
					MsgObjPtr = CreateObj(MsgPtr,"HpyMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format HpyMsg error\n"));
ERRLOG("FormatMsg format HpyMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
				}
//call HcpMsg//
				else if(!strcmp(csPspChannel,PD_CHANNEL_HPAY_CNP)){
					MsgObjPtr = CreateObj(MsgPtr,"HcpMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format HcpMsg error\n"));
ERRLOG("FormatMsg format HcpMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
				}
				else if(!strcmp(csPspChannel,PD_CHANNEL_LKPAY)){
//call LkpMsg//
					MsgObjPtr = CreateObj(MsgPtr,"LkpMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format LkpMsg error\n"));
ERRLOG("FormatMsg format LkpMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
				}
				else if(!strcmp(csPspChannel,PD_CHANNEL_HHPAY)){
//call HhpMsg//
					MsgObjPtr = CreateObj(MsgPtr,"HhpMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format HhpMsg error\n"));
ERRLOG("FormatMsg format HhpMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
				}
				 else if(!strcmp(csPspChannel,PD_CHANNEL_YEEPAY)){
//call YpyMsg//
                                        MsgObjPtr = CreateObj(MsgPtr,"YpyMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format YpyMsg error\n"));
ERRLOG("FormatMsg format YpyMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
				else {
DEBUGLOG(("XPyMsg:FormatMsg format error !!! undefine\n"));
ERRLOG("XpyMsg::FormatMsg format error !!! undefine\n");
				}

			}
                       	return iRet;
                }
		//else if(cStatus==PD_INIT || cStatus == PD_COMPLETE){
		else if(cStatus==PD_INIT){
                        if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: redirect_url = [%s]\n",csPtr));
                        	strcat((char*)outMsg,"redirect_url");
                                strcat((char*)outMsg,"=");
                                csBuf = (char*) malloc (PD_MAX_BUFFER +1);
                                base64_encode((unsigned char*)csPtr,strlen(csPtr),csBuf,PD_MAX_BUFFER);
                                strcat((char*)outMsg,csBuf);
				strcat((char*)outMsg,"&ret_status=1");
                                *outLen = strlen((const char*)outMsg);
                                FREE_ME(csBuf);
DEBUGLOG(("FormatMsg:: redirect_url = [%s]\n",outMsg));
                        }
			return iRet;
                }
        }

	int iSuccess = PD_FALSE;
        /* response code */
        if (GetField_CString(hIn,"response_code",&csPtr)) {
                if (!strcmp(csPtr,"0")) {
                        if (GetField_CString(hIn,"success_url",&csTmp)) {
                                strcat((char*)outMsg,csTmp);
				iSuccess = PD_TRUE;
                        }
                }
                else {
                        if (GetField_CString(hIn,"failure_url",&csTmp)) {
                                strcat((char*)outMsg,csTmp);
                        }
                }
                strcat((char*)outMsg,"?");
DEBUGLOG(("FormatMsg:: redirect_url = [%s]\n",outMsg));
DEBUGLOG(("FormatMsg:: response_code = [%s]\n",csPtr));
        }
	/* Mode */
        if (GetField_CString(hIn,"txn_mode",&csPtr)) {
DEBUGLOG(("FormatMsg:: txn_mode = [%s]\n",csPtr));
		if (!strcmp(csPtr,PD_FE_TXN)) {
/* Merchant ID */
                        if (GetField_CString(hIn,"merchant_id",&csTmp)) {
DEBUGLOG(("FormatMsg:: MERID = [%s]\n",csTmp));
				strcat((char*)outMsg,"MERID");
                		strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
                		strcat((char*)outMsg,csTmp);
                		strcat((char*)outMsg,MY_XPAY_TOKEN);	
			}
/* Merchant Ref */
                        if (GetField_CString(hIn,"merchant_ref",&csTmp)) {
DEBUGLOG(("FormatMsg:: MERORDERID = [%s]\n",csTmp));
				strcat((char*)outMsg,"MERORDERID");
                		strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
                		strcat((char*)outMsg,csTmp);
                		strcat((char*)outMsg,MY_XPAY_TOKEN);	
			}
		}
		else if(cStatus==PD_INIT || cStatus == PD_COMPLETE){
			 if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: url = [%s]\n",csPtr));
                                strcat((char*)outMsg,"url");
                                strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
                                char* csBuf;
                                csBuf = (char*) malloc (PD_MAX_BUFFER +1);
                                base64_encode((unsigned char*)csPtr,strlen(csPtr),csBuf,PD_MAX_BUFFER);
                                strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatMsg (INI):: url = [%s] base64\n",csBuf));
                                strcat((char*)outMsg,MY_XPAY_TOKEN);
                                FREE_ME(csBuf);
                        }               
                        else {          
                                strcat((char*)outMsg,"url");
                                strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
                                strcat((char*)outMsg,MY_XPAY_TOKEN);
                        }
		}
	}
	csBuf = (char*) malloc (PD_MAX_BUFFER +1);
DEBUGLOG(("FormatMsg outmsg = [%s]\n",outMsg));
        base64_encode(outMsg,strlen((char*)outMsg),csBuf,PD_MAX_BUFFER);
        outMsg[0] = '\0';
        strcat((char*)outMsg,"redirect_url");
        strcat((char*)outMsg,"=");
        strcat((char*)outMsg,csBuf);

        strcat((char*)outMsg,MY_XPAY_TOKEN);
        strcat((char*)outMsg,"ret_status");
        strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
	if (iSuccess == PD_TRUE) {
		strcat((char*) outMsg, "0");
	}
	else {
		strcat((char*) outMsg, "1");
	}
DEBUGLOG(("FormatMsg outmsg = [%s]\n",outMsg));
        FREE_ME(csBuf);


	*outLen = strlen((const char*)outMsg);


DEBUGLOG(("FormatMsg() Exit\n"));
	return 	iRet;
}


int FormatAckMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;
	char*	csBuf;
	char*	csPtr;
	char	cStatus;
	char*	csTxnSeq;
	char	csTxnSeqVal[PD_TXN_SEQ_LEN * 2 +1];
	double	dTmp;
	char	csTmp[PD_MAX_BUFFER + 1];

DEBUGLOG(("FormatAckMsg()\n"));
	csTxnSeqVal[0]='\0';
	outMsg[0]= '\0';
        *outLen = 0;
	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );
	

	memset(csBuf,0,sizeof(csBuf));
        strcat((char*)csBuf,"url");
        strcat((char*)csBuf,MY_XPAY_FIELD_TOKEN);

        if (GetField_CString(hIn,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("FormatAckMsg txn_seq = [%s]\n",csTxnSeq));
		sprintf(csTxnSeqVal,"txn_id=%s",csTxnSeq);
	}
	else {
DEBUGLOG(("FormatAckMsg txn_seq is missing!!!\n"));
		sprintf(csTxnSeqVal,"txn_id=");
	}

        if (GetField_Char(hIn,"ar_ind",&cStatus)) {
DEBUGLOG(("FormatAckMsg txn_status = [%c]\n",cStatus));
	}
	if (cStatus == PD_ACCEPT) {
                if (GetField_CString(hIn,"success_callback_url",&csPtr)) {
        		strcat((char*)csBuf,csPtr);
DEBUGLOG(("FormatAckMsg success_callback_url = [%s]\n",csPtr));
                }

	}
	else {
                if (GetField_CString(hIn,"failure_callback_url",&csPtr)) {
        		strcat((char*)csBuf,csPtr);
DEBUGLOG(("FormatAckMsg failure_callback_url = [%s]\n",csPtr));
                }
	}
        strcat((char*)csBuf,MY_XPAY_TOKEN);
        strcat((char*)csBuf,csTxnSeqVal);
        strcat((char*)csBuf,MY_XPAY_TOKEN);

	sprintf((char*)outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
        strcat((char*)outMsg,csBuf);

/*merchant_id*/
	if (GetField_CString(hIn,"merchant_id",&csPtr)){
DEBUGLOG(("FormatAckMsg:: MERID = [%s]\n",csPtr));
		strcat((char*)outMsg,"MERID");
        	strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
               	strcat((char*)outMsg,csPtr);
               	strcat((char*)outMsg,MY_XPAY_TOKEN);	
	}
/*encrypt_type*/
	if (GetField_CString(hIn,"encrypt_type",&csPtr)){
DEBUGLOG(("FormatAckMsg:: ENCTYPE = [%s]\n",csPtr));
		strcat((char*)outMsg,"ENCTYPE");
        	strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
               	strcat((char*)outMsg,csPtr);
               	strcat((char*)outMsg,MY_XPAY_TOKEN);	
	}
/*plainttext_data*/
	if (GetField_CString(hIn,"plainttext_data",&csPtr)){
DEBUGLOG(("FormatAckMsg:: plainttext_data = [%s]\n",csPtr));
		csBuf[0]='\0';
		base64_encode((unsigned char*)csPtr,strlen(csPtr),csBuf,PD_MAX_BUFFER);
DEBUGLOG(("FormatAckMsg:: DATA = [%s]\n",csBuf));

		strcat((char*)outMsg,"DATA");
        	strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
               	strcat((char*)outMsg,csBuf);
               	strcat((char*)outMsg,MY_XPAY_TOKEN);	
	}
/*sign*/
	if (GetField_CString(hIn,"sign",&csPtr)){
DEBUGLOG(("FormatAckMsg:: SIGN = [%s]\n",csPtr));
		strcat((char*)outMsg,"SIGN");
        	strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
               	strcat((char*)outMsg,csPtr);
               	strcat((char*)outMsg,MY_XPAY_TOKEN);	
	}
/*pay_method*/
	if (GetField_CString(hIn,"pay_method",&csPtr)){
DEBUGLOG(("FormatAckMsg:: PAYMETHOD = [%s]\n",csPtr));
		strcat((char*)outMsg,"PAYMETHOD");
        	strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
               	strcat((char*)outMsg,csPtr);
               	strcat((char*)outMsg,MY_XPAY_TOKEN);	
	}
/* service_fee */
	if (GetField_Double(hIn,"service_fee",&dTmp)) {
DEBUGLOG(("FormatAckMsg:: service_fee = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
		strcat((char*)outMsg,"SERVICEFEE");
        	strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
               	strcat((char*)outMsg,csTmp);
               	strcat((char*)outMsg,MY_XPAY_TOKEN);	
        }

	*outLen = strlen((const char*)outMsg);


	FREE_ME(csBuf);
DEBUGLOG(("FormatAckMsg:: outMsg = [%s]\n",outMsg));
DEBUGLOG(("FormatAckMsg() Exit iRet = [%d]\n",iRet));
	return 	iRet;
}

int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csBuf;
	char	*p;

	csBuf = (char*) malloc (1024 * 2 +1);

DEBUGLOG(("BreakDownMsg msg=[%s][%d]\n",inMsg,inLen));
	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';
DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("BreakDownMsg msg=[%s]\n",csBuf));

/*merchant id */
	p = GetField((const unsigned char*)csBuf,"MERID",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"merchant_id",p);
DEBUGLOG(("BreakDownMsg merchant_id = [%s]\n",p));
	}
/*encrypt_type */
	p = GetField((const unsigned char*)csBuf,"ENCTYPE",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"encrypt_type",p);
DEBUGLOG(("BreakDownMsg encrypt_type = [%s]\n",p));
	}

/* data */
	p = GetField((const unsigned char*)csBuf,"DATA",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {
		iRet = DEBlockXpayData(hOut,(unsigned char*)p,strlen(p));
	}

/* SIGN */
	p = GetField((const unsigned char*)csBuf,"SIGN",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"sign",p);
DEBUGLOG(("BreakDownMsg sign = [%s]\n",p));
	}
/* process_type */
	p = GetField((const unsigned char*)csBuf,"process_type",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"process_type",p);
DEBUGLOG(("BreakDownMsg process_type = [%s]\n",p));
	}
/* process_code */
	p = GetField((const unsigned char*)csBuf,"process_code",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"process_code",p);
DEBUGLOG(("BreakDownMsg process_code = [%s]\n",p));
	}
/* ip_addr */
	p = GetField((const unsigned char*)csBuf,"ip_addr",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"ip_addr",p);
DEBUGLOG(("BreakDownMsg ip_addr = [%s]\n",p));
	}
	p = GetField((const unsigned char*)csBuf,"REMOTE_ADDR",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"ip_addr",p);
DEBUGLOG(("BreakDownMsg REMOTE_ADDR = [%s]\n",p));
	}
	
/* service_code*/
	p = GetField((const unsigned char*)csBuf,"service_code",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"service_code",p);
DEBUGLOG(("BreakDownMsg service_code = [%s]\n",p));
	}
	else{
		PutField_CString(hOut,"service_code",PD_DEFAULT_SERVICE);
DEBUGLOG(("BreakDownMsg default service_code = [%s]\n",PD_DEFAULT_SERVICE));
	}
	
/* bank_code */
	p = GetField((const unsigned char*)csBuf,"BankID",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {

		PutField_CString(hOut,"bank_code",p);
DEBUGLOG(("BreakDownMsg bank_code = [%s]\n",p));

	}
/* pay_method */
	p = GetField((const unsigned char*)csBuf,"pay_method",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {

		PutField_CString(hOut,"pay_method",p);
		PutField_CString(hOut,"selected_pay_method",p);
DEBUGLOG(("BreakDownMsg pay_method = [%s]\n",p));

	}
/* Remark */
	p = GetField((const unsigned char*)csBuf,"REMARK",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {

		char*	csPayMethod;
		csPayMethod = (char*) malloc (PD_PAY_METHOD_LIST_LEN +1);
		PutField_CString(hOut,"remark",p);
DEBUGLOG(("BreakDownMsg remark = [%s]\n",p));
		DBObjPtr = CreateObj(DBPtr,"DBCctTxn","FindPayMethodByMerchantRef");
                if ((unsigned long)(DBObjPtr)(p,csPayMethod) == FOUND) {
                 	PutField_CString(hOut,"pay_method",(char*)csPayMethod);
DEBUGLOG(("BreakDownMsg(): PayMethod=[%s]\n",csPayMethod));
                }
		FREE_ME(csPayMethod);

	}
	
	

DEBUGLOG(("try to free\n"));
	FREE_ME(csBuf);
DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	char	*csPtr = NULL;
DEBUGLOG(("initReplyFromRequest()\n"));
	
/* merchant_id */
	if (GetField_CString(hRequest,"merchant_id",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: merchant_id = [%s]\n",csPtr));
		PutField_CString(hResponse,"merchant_id",csPtr);
	}
/* merchant_ref */

	if (GetField_CString(hRequest,"merchant_ref",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: merchant_ref = [%s]\n",csPtr));
		PutField_CString(hResponse,"merchant_ref",csPtr);
	}

/* reference */
	if (GetField_CString(hRequest,"reference",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: reference = [%s]\n",csPtr));
		PutField_CString(hResponse,"reference",csPtr);
	}
/* transaction_datetime */
	if (GetField_CString(hRequest,"transaction_datetime",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: transaction_datetime = [%s]\n",csPtr));
		PutField_CString(hResponse,"transaction_datetime",csPtr);
	}

/* pay_method */
	if (GetField_CString(hRequest,"pay_method",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: pay_method = [%s]\n",csPtr));
		PutField_CString(hResponse,"pay_method",csPtr);
	}

/* pay_amount */
	if (GetField_CString(hRequest,"txn_amt",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: txn_amt = [%s]\n",csPtr));
		PutField_CString(hResponse,"txn_amt",csPtr);
	}
/* currency_code */
	if (GetField_CString(hRequest,"txn_ccy",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: txn_ccy= [%s]\n",csPtr));
		PutField_CString(hResponse,"txn_ccy",csPtr);
	}
/* show_paypage */
	if (GetField_CString(hRequest,"show_paypage",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: show_paypage = [%s]\n",csPtr));
		PutField_CString(hResponse,"show_paypage",csPtr);
	}

/* success_url */
	if (GetField_CString(hRequest,"success_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: success_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"success_url",csPtr);
	}
/* success_callback_url */
	if (GetField_CString(hRequest,"success_callback_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: success_callback_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"success_callback_url",csPtr);
	}

/* failure_url */
	if (GetField_CString(hRequest,"failure_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: failure_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"failure_url",csPtr);
	}
/* failure_callback_url */
	if (GetField_CString(hRequest,"failure_callback_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: failure_callback_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"failure_callback_url",csPtr);
	}
/* process_type */
	if (GetField_CString(hRequest,"process_type",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: process_type = [%s]\n",csPtr));
		PutField_CString(hResponse,"process_type",csPtr);
	}
/* process_code */
	if (GetField_CString(hRequest,"process_code",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: process_code = [%s]\n",csPtr));
		PutField_CString(hResponse,"process_code",csPtr);
	}

/* currency_code */
/*
	if (GetField_CString(hRequest,"currency_code",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: currency_code = [%s]\n",csPtr));
		PutField_CString(hResponse,"currency_code",csPtr);
	}
*/

/* recvenctype */
	if (GetField_CString(hRequest,"recvenctype",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: recvenctype = [%s]\n",csPtr));
		PutField_CString(hResponse,"recvenctype",csPtr);
	}

/*
//// bank_code 
	if (GetField_CString(hRequest,"bank_code",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: bank_code = [%s]\n",csPtr));
		PutField_CString(hResponse,"bank_code",csPtr);
	}

///internal bank_code
	if (GetField_CString(hRequest,"internal_bank_code",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: internal_bank_code = [%s]\n",csPtr));
		PutField_CString(hResponse,"internal_bank_code",csPtr);
	}
*/


DEBUGLOG(("initReplyFromRequest() Exit\n"));
	return iRet;
}
int DEBlockXpayData(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csBuf;
	char	*csDATA;
	char	*p;
	int	iLen;
	char*   csTxnCountry;
	char*   csTxnCcy;

	csBuf = (char*) malloc (PD_MAX_BUFFER +1);
	csDATA = (char*) malloc (PD_MAX_BUFFER +1);

	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';
DEBUGLOG(("\n\nDEBlockData data=[%s]\n\n",csBuf));
	//if (base64_decode(csBuf,csDATA,PD_MAX_BUFFER) > 0 ) {
	iLen = base64_decode(csBuf,(unsigned char*)csDATA,PD_MAX_BUFFER);
	csDATA[iLen] = '\0';
	if (iLen > 0 ) {
DEBUGLOG(("\n\nDEBlockData data=[%s]\n\n",csDATA));
DEBUGLOG(("iRet = [%d] DATA = [%s]\n",iRet,csDATA));
		PutField_CString(hOut,"plainttext_data",csDATA);
/* reference */
		p = strtok(csDATA,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"merchant_ref",p);
DEBUGLOG(("DEBlockData merchant_ref = [%s]\n",p));
		}

/* transmission_datetime */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"transmission_datetime",p);
DEBUGLOG(("DEBlockData transmission_datetime = [%s]\n",p));
/* same as transmission_datetime in this case */
			PutField_CString(hOut,"tm_date",p);
DEBUGLOG(("DEBlockData tm_date = [%s]\n",p));
		}
/* pay_amount */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"txn_amt",p);
DEBUGLOG(("DEBlockData txn_amt = [%s]\n",p));
		}
/* curtype */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
//				PutField_CString(hOut,"currency_code",p);
				if(!strncmp(p,PD_CCY_RMB,PD_CCY_ID_LEN)){
					csTxnCcy=strdup(PD_CCY_ISO_CNY);
				}
				else if(!strncmp(p,PD_CCY_TWD,PD_CCY_ID_LEN)) {
					csTxnCcy=strdup(PD_CCY_ISO_TWD);
				}
				else if(!strncmp(p,PD_CCY_JPY,PD_CCY_ID_LEN)) {
					csTxnCcy=strdup(PD_CCY_ISO_JPY);
				}
DEBUGLOG(("DEBlockData txn_ccy =[%s] [%s]\n",p,csTxnCcy));

				PutField_CString(hOut,"txn_ccy",csTxnCcy);
				if (!strcmp(csTxnCcy,PD_CCY_ISO_CNY))
					csTxnCountry=strdup(PD_CHINA);
				else if (!strcmp(csTxnCcy,PD_CCY_ISO_TWD))
					csTxnCountry=strdup(PD_TAIWAN);
				else if (!strcmp(csTxnCcy,PD_CCY_ISO_JPY))
					csTxnCountry=strdup(PD_JAPAN);
DEBUGLOG(("DEBlockData txn_country = [%s]\n",csTxnCountry));
				PutField_CString(hOut,"txn_country",csTxnCountry);
		}
/* tradeway */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"tradeway",p);
DEBUGLOG(("DEBlockData tradeway = [%s]\n",p));

/* recvenctype */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"recvenctype",p);
DEBUGLOG(("DEBlockData recvenctype = [%s]\n",p));
		}
		}
/* success_callback_url */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"success_callback_url",p);
			PutField_CString(hOut,"failure_callback_url",p);
DEBUGLOG(("DEBlockData success_callback_url = [%s]\n",p));
DEBUGLOG(("DEBlockData failure_callback_url = [%s]\n",p));
		}

/* failure_url */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"failure_url",p);
DEBUGLOG(("DEBlockData failure_url = [%s]\n",p));
		}

/* success_url */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"success_url",p);
DEBUGLOG(("DEBlockData success_url = [%s]\n",p));
		}
/* language */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"language",p);
DEBUGLOG(("DEBlockData language = [%s]\n",p));
		}



/* show_paypage */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"show_paypage",p);
DEBUGLOG(("DEBlockData show_paypage = [%s]\n",p));
		}
/* remark */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"remark",p);
DEBUGLOG(("DEBlockData remark = [%s]\n",p));
		}
		else {
			PutField_CString(hOut,"remark","");
		}
	}


	FREE_ME(csBuf);
	FREE_ME(csDATA);
DEBUGLOG(("DBlockData Exit\n"));
	return	iRet;
}

int BuildData(hash_t* hIn)
{
	int	iRet = PD_OK;
	char	cArInd;
	char*	csPtr,*csDATA;
	char	csTmp[PD_MAX_BUFFER + 1];
	double	dTmp;
	csDATA = (char*) malloc (1024 * 2 +1);

DEBUGLOG(("BuildData()\n"));

        if (GetField_Char(hIn,"ar_ind",&cArInd)) {
DEBUGLOG(("BuildData ArInd = [%c]\n",cArInd));
	}

	memset(csDATA,0,sizeof(csDATA));
/* txn_id */
        if (GetField_CString(hIn,"txn_seq",&csPtr)) {
DEBUGLOG(("BuildData:: ORDERID = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
       		strcat((char*)csDATA,MY_XPAY_DATA_TOKEN);	
	}

/* Merchant Ref */
        if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
DEBUGLOG(("BuildData:: MERORDERID = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
       		strcat((char*)csDATA,MY_XPAY_DATA_TOKEN);	
	}

/* transmission_datetime */
        if (GetField_CString(hIn,"transmission_datetime",&csPtr)) {
DEBUGLOG(("BuildData:: MERDATE = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
       		strcat((char*)csDATA,MY_XPAY_DATA_TOKEN);	
	}

/* tid */
        if (GetField_CString(hIn,"tid",&csPtr)) {
DEBUGLOG(("BuildData:: BANKBILLNO = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
       		strcat((char*)csDATA,MY_XPAY_DATA_TOKEN);	
	}
/* fundin_date */
        if (GetField_CString(hIn,"fundin_date",&csPtr)) {
DEBUGLOG(("BuildData:: BANKTIME = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
       		strcat((char*)csDATA,MY_XPAY_DATA_TOKEN);	
	}



/* txn_amt */
        if (GetField_Double(hIn,"txn_amt",&dTmp)) {
DEBUGLOG(("BuildData:: AMOUNT = [%f]\n",dTmp));
		sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("BuildData:: AMOUNT = [%s]\n",csTmp));
       		strcat((char*)csDATA,(char*)csTmp);
       		strcat((char*)csDATA,MY_XPAY_DATA_TOKEN);	
	}
/* currency_code */
        if (GetField_CString(hIn,"currency_code",&csPtr)) {
DEBUGLOG(("BuildData:: CURTYPE = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
       		strcat((char*)csDATA,MY_XPAY_DATA_TOKEN);	
	}
/* language */
        if (GetField_CString(hIn,"language",&csPtr)) {
DEBUGLOG(("BuildData:: LANG = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
       		strcat((char*)csDATA,MY_XPAY_DATA_TOKEN);	
	}
	if (cArInd == PD_ACCEPT) {
DEBUGLOG(("BuildData:: ISSUCC = '0'\n"));
		sprintf(csPtr,"0");
	}
	else {
		if (GetField_CString(hIn,"error_code",&csPtr)) {
DEBUGLOG(("BuildData:: ISSUCC = [%s]\n",csPtr));
		}
		else {
DEBUGLOG(("BuildData:: ISSUCC = 'N'\n"));
			sprintf(csPtr,"N");
		}
	}
       	strcat((char*)csDATA,csPtr);
       	strcat((char*)csDATA,MY_XPAY_DATA_TOKEN);	

/* remark */
/*
        if (GetField_CString(hIn,"remark",&csPtr)) {
DEBUGLOG(("BuildData:: REMARK = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
	}
*/

	PutField_CString(hIn,"plainttext_data",csDATA);

DEBUGLOG(("BuildData:: DATA = [%s]\n",csDATA));

	FREE_ME(csDATA);
DEBUGLOG(("BuildData() Exit iRet = [%d]\n",iRet));
	return 	iRet;
}

int FormatFEMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
        int     iRet = PD_OK;
        int     iTmp = 0;
        char    *csPtr;
	char	*csBuf;
	char	cStatus;
	char	cPtr;
DEBUGLOG(("FormatFEMsg()\n"));

	csBuf = (char*) malloc (1024 *2 +1);
	memset(csBuf,0,sizeof(csBuf));
	outMsg[0] = '\0';
	if (GetField_Char(hIn,"status",&cStatus)) {
DEBUGLOG(("FormatFEMsg:: status = [%c]\n",cStatus));
	}
	else {
DEBUGLOG(("FormatFEMsg:: status not found\n"));
	}
	if (cStatus == PD_TO_PSP) {
               	if (GetField_CString(hIn,"failure_url",&csPtr)) {
               		strcat((char*)outMsg,csPtr);
                }
               	strcat((char*)outMsg,"?");
		sprintf(csBuf,"error_code%s%d%s",MY_XPAY_FIELD_TOKEN,INT_ACK_NOT_YET_RETURN,MY_XPAY_TOKEN);
		strcat((char*)outMsg,csBuf);

		if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
                        strcat((char*)outMsg,"MERORDERID");
                        strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_XPAY_TOKEN);
                }
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
                if (GetField_CString(hIn,"merchant_id",&csPtr)) {
                        strcat((char*)outMsg,"MERID");
                        strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_XPAY_TOKEN);
                }
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
		base64_encode(outMsg,strlen((char*)outMsg),csBuf,PD_MAX_BUFFER);
        	outMsg[0] = '\0';
		sprintf((char*)outMsg,"status=%c&",cStatus);
        	strcat((char*)outMsg,"redirect_url");
        	strcat((char*)outMsg,"=");
        	strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
		*outLen = strlen((const char*)outMsg);
DEBUGLOG(("FormatFEMsg:: ACK not yet return\n"));
		FREE_ME(csBuf);
        	return iRet;
	}
	else {
        	if (GetField_Char(hIn,"ar_ind",&cPtr)) {
                	if (cPtr == PD_ACCEPT) {
                        	if (GetField_CString(hIn,"success_url",&csPtr)) {
                                	strcat((char*)outMsg,csPtr);
                        	}
                	}
                	else {
                        	if (GetField_CString(hIn,"failure_url",&csPtr)) {
                                	strcat((char*)outMsg,csPtr);
                        	}
                	}

                	strcat((char*)outMsg,"?");
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
DEBUGLOG(("FormatFEMsg:: response_code = [%d]\n",iTmp));
        	}
        	if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
                	strcat((char*)outMsg,"MERORDERID");
                	strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
                	strcat((char*)outMsg,csPtr);
                	strcat((char*)outMsg,MY_XPAY_TOKEN);
        	}
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
        	if (GetField_CString(hIn,"merchant_id",&csPtr)) {
                	strcat((char*)outMsg,"MERID");
                	strcat((char*)outMsg,MY_XPAY_FIELD_TOKEN);
                	strcat((char*)outMsg,csPtr);
                	strcat((char*)outMsg,MY_XPAY_TOKEN);
        	}
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
		base64_encode(outMsg,strlen((char*)outMsg),csBuf,PD_MAX_BUFFER);
        	outMsg[0] = '\0';
		sprintf((char*)outMsg,"status=%c&",cStatus);
        	strcat((char*)outMsg,"redirect_url");
        	strcat((char*)outMsg,"=");
        	strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
	
        
		*outLen = strlen((const char*)outMsg);

		FREE_ME(csBuf);

        	return iRet;
	}
}

int DEBlockAckData(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csBuf;
	char	*csDATA;
	char	*p;
	int	iLen;
	//char*   csTxnCountry;
	//char*   csTxnCcy;

	csBuf = (char*) malloc (PD_MAX_BUFFER +1);
	csDATA = (char*) malloc (PD_MAX_BUFFER +1);

	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';
DEBUGLOG(("\n\nDEBlockAckData data=[%s]\n\n",csBuf));

	iLen = base64_decode(csBuf,(unsigned char*)csDATA,PD_MAX_BUFFER);
	csDATA[iLen] = '\0';
	if (iLen > 0 ) {
DEBUGLOG(("\n\nDEBlockAckData data=[%s]\n\n",csDATA));
DEBUGLOG(("iRet = [%d] DATA = [%s]\n",iRet,csDATA));

		PutField_CString(hOut,"plainttext_data",csDATA);
/* txn_id */
		p = strtok(csDATA,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"txn_seq",p);
DEBUGLOG(("DEBlockAckData txn_id = [%s]\n",p));
		}

/* reference */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"merchant_ref",p);
DEBUGLOG(("DEBlockAckData merchant_ref = [%s]\n",p));
		}

/* transmission_datetime */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"transmission_datetime",p);
DEBUGLOG(("DEBlockAckData transmission_datetime = [%s]\n",p));
/* same as transmission_datetime in this case */
			PutField_CString(hOut,"tm_date",p);
DEBUGLOG(("DEBlockAckData tm_date = [%s]\n",p));
		}
/* tid */
		 p = strtok(NULL,MY_XPAY_DATA_TOKEN);
                if (p) {
                        PutField_CString(hOut,"tid",p);
DEBUGLOG(("DEBlockAckData tid = [%s]\n",p));
		}

/* fundin_date */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
                if (p) {
                        PutField_CString(hOut,"fundin_date",p);
DEBUGLOG(("DEBlockAckData fundin_date = [%s]\n",p));
                }


/* pay_amount */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"txn_amt",p);
DEBUGLOG(("DEBlockAckData txn_amt = [%s]\n",p));
		}
/* curtype */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"currency_code",p);
		}

/* language */
		p = strtok(NULL,MY_XPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"language",p);
DEBUGLOG(("DEBlockAckData language = [%s]\n",p));
		}
	}


	FREE_ME(csBuf);
	FREE_ME(csDATA);
DEBUGLOG(("DBlockAckData Exit\n"));


	return	iRet;
}


int BreakDownAckMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	int	iHeader;
	char	*csBuf;
	char	*p;

	csBuf = (char*) malloc (PD_TMP_MSG_BUF_LEN +1);

DEBUGLOG(("BreakDownAckMsg msg=[%s][%d]\n",inMsg,inLen));

/*	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';
DEBUGLOG(("BreakDownAckMsg()\n"));
DEBUGLOG(("BreakDownAckMsg msg=[%s]\n",csBuf));
*/

	memcpy(csBuf,inMsg,PD_WEB_HEADER_LEN_LEN);
	csBuf[PD_WEB_HEADER_LEN_LEN] = '\0';
	iHeader = ctos((unsigned char*)csBuf,strlen(csBuf));

	csBuf[0] = '\0';
	memcpy(csBuf,&inMsg[PD_WEB_HEADER_LEN_LEN],iHeader);
	csBuf[iHeader] = '\0';
DEBUGLOG(("HEADER = [%s]\n",csBuf));


	csBuf[0] = '\0';
	memcpy(csBuf,&inMsg[PD_WEB_HEADER_LEN_LEN + iHeader],inLen - iHeader - PD_WEB_HEADER_LEN_LEN);
	csBuf[inLen - iHeader - PD_WEB_HEADER_LEN_LEN] = '\0';
DEBUGLOG(("DATA = [%s]\n",csBuf));


/*merchant id */
	p = GetField((const unsigned char*)csBuf,"MERID",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"merchant_id",p);
DEBUGLOG(("BreakDownMsg merchant_id = [%s]\n",p));
	}
/*encrypt_type */
	p = GetField((const unsigned char*)csBuf,"ENCTYPE",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"encrypt_type",p);
DEBUGLOG(("BreakDownMsg encrypt_type = [%s]\n",p));
	}

/* data */
	p = GetField((const unsigned char*)csBuf,"DATA",MY_XPAY_TOKEN,MY_XPAY_FIELD_TOKEN);
	if(p) {
		iRet = DEBlockAckData(hOut,(const unsigned char*)p,strlen(p));
	}


	FREE_ME(csBuf);
DEBUGLOG(("BreakDownAckMsg Exit\n"));
	return	iRet;
}
