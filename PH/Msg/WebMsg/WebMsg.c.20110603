/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010                    Cody Chan
handle new psp: ESKY                               20110110                LokMan Chow
call ESkeyMsg Ptr				   20110113		   LokMan Chow
add encrypt type				   20110209		   LokMan Chow
add client ip and service code			   20110218		   LokMan Chow
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "WebMsg.h"
#include "common.h"
#include "utilitys.h"
#include "b64.h"
#include "queue_defs.h"
#include "internal.h"
#include <zlib.h>
#include "ObjPtr.h"

char	cDebug;

OBJPTR(Msg);

void	WebMsg(char cdebug)
{
	cDebug = cdebug;
}

int ParseField(hash_t *hOut,const char* inMsg);
int DeBlockWTBData(hash_t *hOut,const char* inMsg);
int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;

//	double	dTmp;
	char*	csTmp = NULL;
	char*	csPtr = NULL;
	char*	csPspChannel = NULL;
	char*   csTxnCode = strdup("");
	char*	csBuf;
	char*	csLang;
	char	cStatus;
//	char	cPtr;
DEBUGLOG(("FormatMsg()\n"));

//txn code
        if (GetField_CString(hIn,"txn_code",&csTxnCode)) {
DEBUGLOG(("FormatMsg:: txn_code = [%s]\n",csTxnCode));
        }	

//language
	if (GetField_CString(hIn,"language",&csLang)) {
DEBUGLOG(("FormatMsg:: language = [%s]\n",csLang));
        }


	outMsg[0]= '\0';
	*outLen = 0;

	if (!strcmp(csTxnCode,PD_WITHDRAW_BATCH_TXN_CODE)) {
		if (GetField_CString(hIn,"response_code",&csPtr)) {
DEBUGLOG(("FormatMsg:: response_code = [%s]\n", csPtr));
                	strcat((char*)outMsg,"response_code");
                	strcat((char*)outMsg,"=");
                	strcat((char*)outMsg, csPtr);
			*outLen = strlen((const char*)outMsg);
		}
		return iRet;
	}
/************************/

	if (GetField_Char(hIn,"status",&cStatus)) {
DEBUGLOG(("FormatMsg:: status = [%c]\n",cStatus));
		if (cStatus == PD_TO_PSP) {
			if (!GetField_CString(hIn,"psp_channel_code",&csPspChannel)) {
DEBUGLOG(("FormatMsg:: Psp Channel Code Not Found!\n"));
ERRLOG("WebMsg::FormatMsg:: Psp Channel Code Not Found!\n");
                        }
                        else{

DEBUGLOG(("FormatMsg:: Psp Id = [%s]\n",csPspChannel));
// call TWV
				if(!strcmp(csPspChannel,PD_CHANNEL_TWV) ||
				   !strcmp(csPspChannel,PD_CHANNEL_PGEN)){
                                        if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: redirect_url = [%s]\n",csPtr));
                                                strcat((char*)outMsg,"redirect_url");
                                                strcat((char*)outMsg,"=");
                                                csBuf = (char*) malloc (PD_MAX_BUFFER +1);
                                                base64_encode(csPtr,strlen(csPtr),csBuf,PD_MAX_BUFFER);
                                                strcat((char*)outMsg,csBuf);
                                                *outLen = strlen((const char*)outMsg);
                                                FREE_ME(csBuf);
                                        }
                                        else {
DEBUGLOG(("FormatMsg redirect_url not found\n"));
ERRLOG("FormatMsg redirect_url not found\n");
                                        }
                                }
                                else if(!strcmp(csPspChannel,PD_CHANNEL_ESKY)){
//call ESkyMsg//
                                        MsgObjPtr = CreateObj(MsgPtr,"ESkyMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format ESkyMsg error\n"));
ERRLOG("FormatMsg format ESkyMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));

                                }
                                else if(!strcmp(csPspChannel,PD_CHANNEL_HPAY)){
//call HpyMsg//
                                        MsgObjPtr = CreateObj(MsgPtr,"HpyMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format HpyMsg error\n"));
ERRLOG("FormatMsg format HpyMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
                                else if(!strcmp(csPspChannel,PD_CHANNEL_LKPAY)){
//call LKPAY//
                                        MsgObjPtr = CreateObj(MsgPtr,"LkpMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format LkpMsg error\n"));
ERRLOG("FormatMsg format LkpMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
                                else if(!strcmp(csPspChannel,PD_CHANNEL_HHPAY)){
//call HoHoPay//
                                        MsgObjPtr = CreateObj(MsgPtr,"HhpMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format HhpMsg error\n"));
ERRLOG("FormatMsg format HhpMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
                                else if(!strcmp(csPspChannel,PD_CHANNEL_PGEN)){
//call PayGen//
                                        MsgObjPtr = CreateObj(MsgPtr,"PgnMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format PgnMsg error\n"));
ERRLOG("FormatMsg format PgnMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
                                else {
DEBUGLOG(("FormatMsg format error !!! undefine msg object [%s]\n",csPspChannel));
ERRLOG("WebMsg::FormatMsg format error !!! undefine msg object [%s]\n",csPspChannel);

				}

			}
			return iRet;
		}


		else if(cStatus==PD_INIT || cStatus == PD_COMPLETE){
			if (GetField_CString(hIn,"process_type",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: process_type = [%s]\n",csPtr));
				strcat((char*)outMsg,"process_type");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"process_code",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: process_code = [%s]\n",csPtr));
				strcat((char*)outMsg,"process_code");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"response_code",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: response_code = [%s]\n",csPtr));
				strcat((char*)outMsg,"status");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: url = [%s]\n",csPtr));
				strcat((char*)outMsg,"url");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				char* csBuf;
				csBuf = (char*) malloc (PD_MAX_BUFFER +1);
        			base64_encode(csPtr,strlen(csPtr),csBuf,PD_MAX_BUFFER);
				strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatMsg (INI):: url = [%s] base64\n",csBuf));
				strcat((char*)outMsg,MY_WEB_TOKEN);
				FREE_ME(csBuf);
			}
			else {
				strcat((char*)outMsg,"url");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: merchant_ref = [%s]\n",csPtr));
				strcat((char*)outMsg,"mer_ref");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"merchant_id",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: merchant_id = [%s]\n",csPtr));
				strcat((char*)outMsg,"mer_id");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"encrypt_type",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: encrypt_type = [%s]\n",csPtr));
				strcat((char*)outMsg,"enctype");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"mac",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: mac = [%s]\n",csPtr));
				strcat((char*)outMsg,"signature");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
			}
DEBUGLOG(("FormatMsg (INI):: outmsg = [%s]\n",outMsg));
				*outLen = strlen((const char*)outMsg);
			return iRet;
		}
	}


/* response code */
	if (GetField_CString(hIn,"response_code",&csPtr)) {
		if (!strcmp(csPtr,"0")) {
			if (GetField_CString(hIn,"success_url",&csTmp)) {
                		strcat((char*)outMsg,csTmp);
			}
		}
		else {
			if (GetField_CString(hIn,"failure_url",&csTmp)) {
                		strcat((char*)outMsg,csTmp);
			}
		}
                strcat((char*)outMsg,"?");
DEBUGLOG(("FormatMsg:: redirect_url = [%s]\n",outMsg));
DEBUGLOG(("FormatMsg:: response_code = [%s]\n",csPtr));
                strcat((char*)outMsg,"status");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
		
	}

DEBUGLOG(("try to compare [%s]\n",csTxnCode));
/* DSP txn */
        if (!strcmp(csTxnCode,PD_DEPOSIT_TXN_CODE)) {
DEBUGLOG(("FormatMsg:: [%s]\n",csTxnCode));
//status
		if (GetField_CString(hIn,"status",&csPtr)) {
DEBUGLOG(("FormatMsg:: status = [%s]\n",csPtr));
                        strcat((char*)outMsg,"status");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//transaction_id
		if (GetField_CString(hIn,"transaction_id",&csPtr)) {
DEBUGLOG(("FormatMsg:: transaction_id = [%s]\n",csPtr));
                        strcat((char*)outMsg,"transaction_id");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

		if (GetField_CString(hIn,"psp_txn_amt",&csPtr)) {
DEBUGLOG(("FormatMsg:: amount = [%s]\n",csPtr));
                        strcat((char*)outMsg,"amount");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//currency_code
		
                if (GetField_CString(hIn,"txn_ccy",&csPtr)) {
DEBUGLOG(("FormatMsg:: currency_code = [%s]\n",csPtr));
                        strcat((char*)outMsg,"currency_code");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//reference
		if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
DEBUGLOG(("FormatMsg:: reference = [%s]\n",csPtr));
                        strcat((char*)outMsg,"reference");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }


//request_time
		if (GetField_CString(hIn,"transaction_datetime",&csPtr)) {
DEBUGLOG(("FormatMsg:: transmission_datetime = [%s]\n",csPtr));
                        strcat((char*)outMsg,"transaction_datetime");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//merchant_id
		if (GetField_CString(hIn,"merchant_id",&csPtr)) {
DEBUGLOG(("FormatMsg:: merchant_id = [%s]\n",csPtr));
                        strcat((char*)outMsg,"merchant_id");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//response_time
		if (GetField_CString(hIn,"response_time",&csPtr)) {
DEBUGLOG(("FormatMsg:: response_time = [%s]\n",csPtr));
                        strcat((char*)outMsg,"response_time");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//country
		if (GetField_CString(hIn,"txn_country",&csPtr)) {
DEBUGLOG(("FormatMsg:: txn_country = [%s]\n",csPtr));
                        strcat((char*)outMsg,"country");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
	
//pay_method
		if (GetField_CString(hIn,"pay_method",&csPtr)) {
DEBUGLOG(("FormatMsg:: pay_method = [%s]\n",csPtr));
                        strcat((char*)outMsg,"pay_method");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//bank_code
		if (GetField_CString(hIn,"bank_code",&csPtr)) {
DEBUGLOG(("FormatMsg:: bank_code = [%s]\n",csPtr));
                        strcat((char*)outMsg,"bank_code");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//service_fee
		if (GetField_CString(hIn,"service_fee",&csPtr)) {
DEBUGLOG(("FormatMsg:: service_fee = [%s]\n",csPtr));
                        strcat((char*)outMsg,"service_fee");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//service_currency
		if (GetField_CString(hIn,"service_currency",&csPtr)) {
DEBUGLOG(("FormatMsg:: service_currency = [%s]\n",csPtr));
                        strcat((char*)outMsg,"service_currency");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }


//remark
		if (GetField_CString(hIn,"remark",&csPtr)) {
DEBUGLOG(("FormatMsg:: remark = [%s]\n",csPtr));
                        strcat((char*)outMsg,"remark");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//response time
		if (GetField_CString(hIn,"local_tm_date",&csPtr)) {
                        strcat((char*)outMsg,"response_time");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
DEBUGLOG(("FormatMsg:: response_time = [%s]\n",csPtr));
			GetField_CString(hIn,"local_tm_time",&csPtr);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
		}
//net_amount
		if (GetField_CString(hIn,"net_amt",&csPtr)) {
DEBUGLOG(("FormatMsg:: net_amt = [%s]\n",csPtr));
                        strcat((char*)outMsg,"net_amount");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//pay_amount
		if (GetField_CString(hIn,"txn_amt",&csPtr)) {
DEBUGLOG(("FormatMsg:: txn_amt = [%s]\n",csPtr));
                        strcat((char*)outMsg,"pay_amount");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//net_ccy
		if (GetField_CString(hIn,"net_ccy",&csPtr)) {
DEBUGLOG(("FormatMsg:: net_ccy = [%s]\n",csPtr));
                        strcat((char*)outMsg,"net_ccy");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//mac
		if (GetField_CString(hIn,"mac",&csPtr)) {
DEBUGLOG(("FormatMsg:: mac = [%s]\n",csPtr));
                        strcat((char*)outMsg,"signature");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//ACK_URL
		if (GetField_CString(hIn,"ACK_URL",&csPtr)) {
DEBUGLOG(("FormatMsg:: ACK_URL = [%s]\n",csPtr));
                        strcat((char*)outMsg,"ACK_ULR");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }


/* for XPAY */

/*
//process_type
		if (GetField_CString(hIn,"process_type",&csPtr)) {
DEBUGLOG(("FormatMsg:: process_type = [%s]\n",csPtr));
                        strcat((char*)outMsg,"process_type");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//process_code
		if (GetField_CString(hIn,"process_code",&csPtr)) {
DEBUGLOG(("FormatMsg:: process_code = [%s]\n",csPtr));
                        strcat((char*)outMsg,"process_code");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//show_paypage
		if (GetField_Char(hIn,"show_paypage",&cPtr)) {
DEBUGLOG(("FormatMsg:: show_paypage = [%c]\n",cPtr));
                        strcat((char*)outMsg,"show_paypage");
			sprintf(csPtr,"%c",cPtr);
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//success_url
		if (GetField_CString(hIn,"success_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: success_url = [%s]\n",csPtr));
                        strcat((char*)outMsg,"success_url");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//success_callback_url
		if (GetField_CString(hIn,"success_callback_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: success_callback_url = [%s]\n",csPtr));
                        strcat((char*)outMsg,"success_callback_url");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//failure_url
		if (GetField_CString(hIn,"failure_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: failure_url = [%s]\n",csPtr));
                        strcat((char*)outMsg,"failure_url");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//failure_callback_url
		if (GetField_CString(hIn,"failure_callback_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: failure_callback_url = [%s]\n",csPtr));
                        strcat((char*)outMsg,"failure_callback_url");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
*/


	}

DEBUGLOG(("FormatMsg:: exit soon\n"));
	csBuf = (char*) malloc (PD_MAX_BUFFER +1);
	base64_encode(outMsg,strlen(outMsg),csBuf,PD_MAX_BUFFER);
	outMsg[0] = '\0';
 	strcat((char*)outMsg,"redirect_url");
       	strcat((char*)outMsg,"=");
       	strcat((char*)outMsg,csBuf);
	strcat((char*)outMsg,MY_WEB_TOKEN);
 	strcat((char*)outMsg,"lang");
       	strcat((char*)outMsg,"=");
       	strcat((char*)outMsg,csLang);
	FREE_ME(csBuf);

	*outLen = strlen((const char*)outMsg);


DEBUGLOG(("FormatMsg:: formated = [%s]\n",outMsg));
DEBUGLOG(("FormatMsg() Exit\n"));
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;

	char	*csBuf;
	char	*csValue;

	char	*p;

	csBuf = (char*) malloc (1024 +1);

	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';
DEBUGLOG(("BreakDownMsg()\n"));

	
DEBUGLOG(("BreakDownMsg()=[%s][%d]\n",inMsg,inLen));

	p = strtok(csBuf,MY_WEB_TOKEN);
	if (p != NULL) 
		iRet = ParseField(hOut,p);

	while (((p = strtok(NULL,MY_WEB_TOKEN)) != NULL) && iRet == PD_OK) {
		iRet = ParseField(hOut,p);
	}

	iRet = BuildAuthData(hOut);

	if (GetField_CString(hOut,"DATA",&csValue))
		iRet = DeBlockWTBData(hOut,csValue);

	FREE_ME(csBuf);
DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	char	*csPtr = NULL;
DEBUGLOG(("initReplyFromRequest()\n"));
	

	if (GetField_CString(hRequest,"success_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: success_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"success_url",csPtr);
	}

	if (GetField_CString(hRequest,"failure_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: failure_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"failure_url",csPtr);
	}

	if (GetField_CString(hRequest,"success_callback_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: success_callback_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"success_callback_url",csPtr);
	}

	if (GetField_CString(hRequest,"failure_callback_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: failure_callback_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"failure_callback_url",csPtr);
	}

	if (GetField_CString(hRequest,"transmission_datetime",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: transmission_datetime = [%s]\n",csPtr));
		PutField_CString(hResponse,"transmission_datetime",csPtr);
	}
	if (GetField_CString(hRequest,"merchant_id",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: merchant_id = [%s]\n",csPtr));
		PutField_CString(hResponse,"merchant_id",csPtr);
	}
	if (GetField_CString(hRequest,"remark",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: remark = [%s]\n",csPtr));
		PutField_CString(hResponse,"remark",csPtr);
	}
	if (GetField_CString(hRequest,"merchant_ref",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: merchant_ref = [%s]\n",csPtr));
		PutField_CString(hResponse,"merchant_ref",csPtr);
	}

	if (GetField_CString(hRequest,"txn_country",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: txn_country = [%s]\n",csPtr));
		PutField_CString(hResponse,"txn_country",csPtr);
	}
	if (GetField_CString(hRequest,"txn_ccy",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: txn_ccy = [%s]\n",csPtr));
		PutField_CString(hResponse,"txn_ccy",csPtr);
	}
	if (GetField_CString(hRequest,"pay_method",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: pay_method = [%s]\n",csPtr));
		PutField_CString(hResponse,"pay_method",csPtr);
	}
	if (GetField_CString(hRequest,"language",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: language = [%s]\n",csPtr));
		PutField_CString(hResponse,"language",csPtr);
	}
	if (GetField_CString(hRequest,"process_code",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: proces_code = [%s]\n",csPtr));
		PutField_CString(hResponse,"process_code",csPtr);
	}
	if (GetField_CString(hRequest,"encrypt_type",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: encrypt_type = [%s]\n",csPtr));
		PutField_CString(hResponse,"encrypt_type",csPtr);
	}



DEBUGLOG(("initReplyFromRequest() Exit\n"));
	return iRet;
}

int ParseField(hash_t *hOut,const char* inMsg)
{
	int	iRet = PD_OK;

	char	*csTag;
	char	*csValue;
	char	*csTmp;
	char	cTmp;
	

	char	*p;
	

	csTmp = (char*) malloc(strlen(inMsg) +1);
	strcpy(csTmp,inMsg);

/* hard code service_code  */
	PutField_CString(hOut,"service_code",PD_DEFAULT_SERVICE);

	p = strstr(csTmp,MY_WEB_FIELD_TOKEN);
	if (strlen(p) > strlen(MY_WEB_FIELD_TOKEN)) {
		csTag = (char*) malloc (PD_TMP_BUF_LEN +1);
		csValue = (char*) malloc (PD_TMP_MSG_BUF_LEN +1);

		strcpy(csValue,p+1);
		memcpy(csTag,inMsg,strlen(inMsg) - strlen(p));
		csTag[strlen(inMsg) - strlen(p)] = '\0';

/* process type */
		if (!strcmp(csTag,"process_type")) {
			strcpy(csTag,"process_type");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* process code */
		else if (!strcmp(csTag,"process_code")) {
			strcpy(csTag,"process_code");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* merchant no */
		else if (!strcmp(csTag,"mer_id"))  {
			strcpy(csTag,"merchant_id");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* merchant ref */
		else if (!strcmp(csTag,"mer_ref")) {
			strcpy(csTag,"merchant_ref");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* merchant transaction date time */
		else if (!strcmp(csTag,"mer_txn_date")) {
			strcpy(csTag,"transmission_datetime");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));

			memcpy(csTmp,csValue,PD_DATE_LEN);
			csTmp[PD_DATE_LEN] = '\0';
			strcpy(csTag,"tm_date");
			PutField_CString(hOut,csTag,csTmp);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csTmp));
			memcpy(csTmp,&csValue[PD_DATE_LEN],PD_TIME_LEN);
			csTmp[PD_TIME_LEN] = '\0';
			strcpy(csTag,"tm_time");
			PutField_CString(hOut,csTag,csTmp);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csTmp));
		}
/* pay method */
		else if (!strcmp(csTag,"pay_method")) {
			strcpy(csTag,"pay_method");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* txn amount */
		else if (!strcmp(csTag,"txn_amt")) {
			strcpy(csTag,"txn_amt");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		} 
/* currency */
		else if (!strcmp(csTag,"ccy")) {
			strcpy(csTag,"txn_ccy");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* country */
		else if (!strcmp(csTag,"country")) {
			strcpy(csTag,"txn_country");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* bank_code */
		else if (!strcmp(csTag,"bank_code")) {
			strcpy(csTag,"bank_code");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* bank_name */
		else if (!strcmp(csTag,"bank_name")) {
			strcpy(csTag,"bank_name");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* branch_name */
		else if (!strcmp(csTag,"branch_name")) {
			strcpy(csTag,"branch_name");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* account_id */
		else if (!strcmp(csTag,"account_id")) {
			strcpy(csTag,"account_id");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* account_name */
		else if (!strcmp(csTag,"account_name")) {
			strcpy(csTag,"account_name");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* identity_id */
		else if (!strcmp(csTag,"identity_id")) {
			strcpy(csTag,"identity_id");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* phone_no */
		else if (!strcmp(csTag,"phone_no")) {
			strcpy(csTag,"phone_no");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* province */
		else if (!strcmp(csTag,"province")) {
			strcpy(csTag,"province");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* batch_id */
		else if (!strcmp(csTag,"batch_id")) {
			strcpy(csTag,"batch_id");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}

/* show paypage */
		else if (!strcmp(csTag,"show_paypage")) {
			strcpy(csTag,"show_paypage");
			cTmp = csValue[0];
			PutField_Char(hOut,csTag,cTmp);
DEBUGLOG(("BreakDownMsg:[%s] = [%c]\n",csTag,cTmp));
		}
		
/* language */
		else if (!strcmp(csTag,"lang")) {
			strcpy(csTag,"language");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
	
/* success url */
		else if (!strcmp(csTag,"success_url")) {
			strcpy(csTag,"success_url");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* success s2s url */
		else if (!strcmp(csTag,"success_s2s_url")) {
			strcpy(csTag,"success_callback_url");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
	
/* failure url */
		else if (!strcmp(csTag,"failure_url")) {
			strcpy(csTag,"failure_url");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* failure s2s url */
		else if (!strcmp(csTag,"failure_s2s_url")) {
			strcpy(csTag,"failure_callback_url");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* remark */
		else if (!strcmp(csTag,"remark")) {
			strcpy(csTag,"remark");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* mac */
		else if (!strcmp(csTag,"signature")) {
			strcpy(csTag,"mac");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* total */
		else if (!strcmp(csTag,"total")) {
			strcpy(csTag,"total");
			PutField_Int(hOut,csTag,ctos(csValue,strlen(csValue)));
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* DATA */
		else if (!strcmp(csTag,"DATA")) {
			strcpy(csTag,"DATA");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
			PutField_CString(hOut,csTag,csValue);
		}
/* encrypt_type */
		else if (!strcmp(csTag,"enctype")) {
			strcpy(csTag,"encrypt_type");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
			PutField_CString(hOut,csTag,csValue);
		}
	
/* ip_addr */
                else if (!strcmp(csTag,"ip_addr")) {
                        strcpy(csTag,"ip_addr");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
                }

/* service_code */
                else if (!strcmp(csTag,"service_code")) {
                        strcpy(csTag,"service_code");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
                }
/* order_num */
/*
                else if (!strcmp(csTag,"order_num")) {
                        strcpy(csTag,"org_txn_seq");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
                }
*/
/* encrypted order_num */
                else if (!strcmp(csTag,"sessionid")) {
                        strcpy(csTag,"org_encrypted_txn_seq");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
                }
/* verno */
                else if (!strcmp(csTag,"verno")) {
                        strcpy(csTag,"version_no");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
			int iVer;
			iVer = ctos(csValue,strlen(csValue));
                        PutField_Int(hOut,csTag,iVer);
                }
/* txn_id bounce back */
                else if (!strcmp(csTag,"txn_id")) {
                        strcpy(csTag,"org_txn_seq");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
	
	
		FREE_ME(csTag);
		FREE_ME(csValue);
	}

	FREE_ME(csTmp);

//DEBUGLOG(("BreakDownMsg = [%d]\n",iRet));;
	return iRet;
}


int FormatFEMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
        int     iRet = PD_OK;
        int     iTmp;
        char    *csPtr;
        char    *csBuf;
        char    cStatus;
        char    cPtr;
DEBUGLOG(("FormatFEMsg()\n"));

        csBuf = (char*) malloc (1024 *2 +1);
        memset(csBuf,0,sizeof(csBuf));
        outMsg[0] = '\0';
        if (GetField_Char(hIn,"status",&cStatus)) {
DEBUGLOG(("FormatFEMsg:: status = [%c]\n",cStatus));
        }
        else {
DEBUGLOG(("FormatFEMsg:: status not found\n"));
        }
        if (cStatus == PD_TO_PSP) {
                if (GetField_CString(hIn,"failure_url",&csPtr)) {
                        strcat((char*)outMsg,csPtr);
                }
                strcat((char*)outMsg,"?");
                sprintf(csBuf,"error_code%s%d%s",MY_WEB_FIELD_TOKEN,INT_ACK_NOT_YET_RETURN,MY_WEB_TOKEN);
                strcat(outMsg,csBuf);

                if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
                        strcat((char*)outMsg,"MERORDERID");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
                if (GetField_CString(hIn,"merchant_id",&csPtr)) {
                        strcat((char*)outMsg,"MERID");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
                base64_encode(outMsg,strlen(outMsg),csBuf,PD_MAX_BUFFER);
                outMsg[0] = '\0';
                sprintf(outMsg,"status=%c&",cStatus);
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
                *outLen = strlen((const char*)outMsg);
DEBUGLOG(("FormatFEMsg:: ACK not yet return\n"));
                FREE_ME(csBuf);
                return iRet;
        }

        else {
                if (GetField_Char(hIn,"ar_ind",&cPtr)) {
                        if (cPtr == PD_ACCEPT) {
                                if (GetField_CString(hIn,"success_url",&csPtr)) {
                                        strcat((char*)outMsg,csPtr);
                                }
                        }
                        else {
                                if (GetField_CString(hIn,"failure_url",&csPtr)) {
                                        strcat((char*)outMsg,csPtr);
                                }
                        }

DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
DEBUGLOG(("FormatFEMsg:: response_code = [%d]\n",iTmp));
                }
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
                base64_encode(outMsg,strlen(outMsg),csBuf,PD_MAX_BUFFER);
                outMsg[0] = '\0';
                sprintf(outMsg,"status=%c&",cStatus);
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));


                *outLen = strlen((const char*)outMsg);

                FREE_ME(csBuf);

                return iRet;
        }
}


/*
int FormatXPAYFEMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{               
        int     iRet = PD_OK;
        int     iTmp;
        char    *csPtr;
        char    *csBuf;
        char    cStatus;
        char    cPtr;
DEBUGLOG(("FormatXPAYFEMsg()\n"));

        csBuf = (char*) malloc (1024 *2 +1);
        memset(csBuf,0,sizeof(csBuf));
        outMsg[0] = '\0'; 
        if (GetField_Char(hIn,"status",&cStatus)) {
DEBUGLOG(("FormatXPAYFEMsg:: status = [%c]\n",cStatus));
        }
        else {
DEBUGLOG(("FormatXPAYFEMsg:: status not found\n"));
        }
        if (cStatus == PD_TO_PSP) {
                if (GetField_CString(hIn,"failure_url",&csPtr)) {
                        strcat((char*)outMsg,csPtr);
                }       
                strcat((char*)outMsg,"?");
                sprintf(csBuf,"error_code%s%d%s",MY_WEB_FIELD_TOKEN,INT_ACK_NOT_YET_RETURN,MY_WEB_TOKEN);
                strcat(outMsg,csBuf);

                if (GetField_CString(hIn,"merchant_ref",&csPtr)) { 
                        strcat((char*)outMsg,"MERORDERID");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }       
                        
DEBUGLOG(("FormatXPAYFEMsg:: outMsg = [%s]\n",outMsg));
                if (GetField_CString(hIn,"merchant_id",&csPtr)) {
                        strcat((char*)outMsg,"MERID");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
DEBUGLOG(("FormatXPAYFEMsg:: outMsg = [%s]\n",outMsg));
                base64_encode(outMsg,strlen(outMsg),csBuf,PD_MAX_BUFFER);
                outMsg[0] = '\0';
                sprintf(outMsg,"status=%c&",cStatus);
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatXPAYFEMsg:: outMsg = [%s]\n",outMsg));
                *outLen = strlen((const char*)outMsg);
DEBUGLOG(("FormatXPAYFEMsg:: ACK not yet return\n"));
                FREE_ME(csBuf);
                return iRet;
        }

	else {
                if (GetField_Char(hIn,"ar_ind",&cPtr)) {
                        if (cPtr == PD_ACCEPT) {
                                if (GetField_CString(hIn,"success_url",&csPtr)) {
                                        strcat((char*)outMsg,csPtr);
                                }
                        }
                        else {
                                if (GetField_CString(hIn,"failure_url",&csPtr)) {
                                        strcat((char*)outMsg,csPtr);
                                }
                        }

                        strcat((char*)outMsg,"?");
DEBUGLOG(("FormatXPAYFEMsg:: outMsg = [%s]\n",outMsg));
DEBUGLOG(("FormatXPAYFEMsg:: response_code = [%d]\n",iTmp));
                }
                if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
                        strcat((char*)outMsg,"MERORDERID");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
DEBUGLOG(("FormatXPAYFEMsg:: outMsg = [%s]\n",outMsg));
                if (GetField_CString(hIn,"merchant_id",&csPtr)) {
                        strcat((char*)outMsg,"MERID");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
DEBUGLOG(("FormatXPAYFEMsg:: outMsg = [%s]\n",outMsg));
                base64_encode(outMsg,strlen(outMsg),csBuf,PD_MAX_BUFFER);
                outMsg[0] = '\0';
                sprintf(outMsg,"status=%c&",cStatus);
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatXPAYFEMsg:: outMsg = [%s]\n",outMsg));


                *outLen = strlen((const char*)outMsg);

                FREE_ME(csBuf);

                return iRet;
        }
}
*/



int DeBlockWTBData(hash_t *hOut,const char* inMsg)
{
	int 	iRet = PD_OK;
	int 	iLen;
	int 	iTotal,i;
	char* 	csDATA;
	char*	p;
	char    csTag[25 +1];

	//unsigned char buf[PD_MAX_BUFFER + 1]={0};
        //unsigned long bufLen=sizeof(buf);


	GetField_Int(hOut,"total",&iTotal);
DEBUGLOG(("DeBlockWTBDATA:: total = [%d]\n",iTotal));

	csDATA = (char*) malloc (MAX_MSG_SIZE +1);
	iLen = base64_decode((char*)inMsg,csDATA,MAX_MSG_SIZE);

	if (iLen > 0 ) {
DEBUGLOG(("DeBlockWTBDATA:: data = [%s]\n",csDATA));
	}
	else 
		iRet = INT_ERR;

	if (iRet == PD_OK) {
		for (i = 0; i < iTotal; i++ ) {
/* merchant_id */
			sprintf(csTag,"mid_%d",i);
			p = GetField(csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"merchant_id_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
        		}
/* merchant_ref */
			sprintf(csTag,"ref_%d",i);
			p = GetField(csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"merchant_ref_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* transmission_datetime */
			sprintf(csTag,"td_%d",i);
			p = GetField(csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"transmission_datetime_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* txn_amount */
			sprintf(csTag,"pm_%d",i);
			p = GetField(csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"txn_amt_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* txn_ccy */
			sprintf(csTag,"cc_%d",i);
			p = GetField(csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"txn_ccy_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* txn_country */
			sprintf(csTag,"ct_%d",i);
			p = GetField(csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"txn_country_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* bank_code */
			sprintf(csTag,"bc_%d",i);
			p = GetField(csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"bank_code_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* branch_name */
			sprintf(csTag,"bn_%d",i);
			p = GetField(csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"branch_name_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* account_id */
			sprintf(csTag,"ai_%d",i);
			p = GetField(csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"account_id_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* account_name */
			sprintf(csTag,"an_%d",i);
			p = GetField(csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"account_name_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* identity_id */
			sprintf(csTag,"id_%d",i);
			p = GetField(csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"identity_id_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* batch_id */
			sprintf(csTag,"bi_%d",i);
			p = GetField(csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"batch_id_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* mac */
			sprintf(csTag,"mac_%d",i);
			p = GetField(csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"mac_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
		}
	}

DEBUGLOG(("DeBlockWTBData Exit = [%d]\n",iRet));
	return iRet;
}

int FormatBatchMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{               
        int     iRet = PD_OK;
        int     iTotal = 0,i;

        char*   csPtr = NULL;
        char    csTag[PD_TAG_LEN +  1];
DEBUGLOG(("FormatBatchMsg()\n"));


        outMsg[0]= '\0';
        *outLen = 0;


        if (GetField_Int(hIn,"total",&iTotal)) {
DEBUGLOG(("FormatBatchMsg:: total = [%d]\n",iTotal));
                sprintf(csTag,"%d",iTotal);
                strcpy((char*)outMsg,"total");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csTag);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }

/* response code */
        if (GetField_CString(hIn,"response_code",&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: response_code = [%s]\n",csPtr));
                strcat((char*)outMsg,"response_code");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);

        }

        for (i =0;  i <  iTotal; i++) {
/* txn_seq */
                sprintf(csTag,"txn_seq_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
                        sprintf(csTag,"txn_id_%d",i);
                        strcat((char*)outMsg,csTag);
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
/* merchant_id */
                sprintf(csTag,"merchant_id_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
                        strcat((char*)outMsg,csTag);
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

/* merchant_ref */
                sprintf(csTag,"merchant_ref_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
                        strcat((char*)outMsg,csTag);
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
/* batch_id */
                sprintf(csTag,"batch_id_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
                        strcat((char*)outMsg,csTag);
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

/* response_code */
                sprintf(csTag,"response_code_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
                        strcat((char*)outMsg,csTag);
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

        }
        *outLen = strlen(outMsg);
DEBUGLOG(("FormatBatchMsg:: formated = [%s]\n",outMsg));
DEBUGLOG(("FormatBatchMsg() Exit\n"));
        return  iRet;
}

int DeBlockWebBounceBackData(hash_t *hOut,const char* inMsg, const int inLen)
{
	int 	iRet = PD_OK;
	int 	iLen;
	char* 	csDATA;
	char*   csValue;
	char*	csBuf;
	char*	p;

//	unsigned char buf[PD_MAX_BUFFER + 1]={0};

	csBuf = (char*) malloc (1024 +1);
	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';

DEBUGLOG(("DeBlockBounceBackDATA () [%s]\n",csBuf));
	p = strtok(csBuf,MY_WEB_TOKEN);
        if (p != NULL) {
                iRet = ParseField(hOut,p);
	}
        while (((p = strtok(NULL,MY_WEB_TOKEN)) != NULL) && iRet == PD_OK) {
                iRet = ParseField(hOut,p);
        }

	
        if (GetField_CString(hOut,"DATA",&csValue)) {
		csDATA = (char*) malloc (MAX_MSG_SIZE +1);
		iLen = base64_decode((char*)csValue,csDATA,MAX_MSG_SIZE);

		if (iLen > 0 ) {
DEBUGLOG(("DeBlockBounceBackDATA:: data = [%s]\n",csDATA));
			p = strtok(csDATA,MY_WEB_BOUNCE_FIELD_TOKEN);
                	if (p) {
				PutField_CString(hOut,"org_txn_seq",p);
DEBUGLOG(("DEBlockData txn_seq = [%s]\n",p));
                	}

		}
		else 
			iRet = INT_ERR;
	}

DEBUGLOG(("DeBlockBounceBackData Exit = [%d]\n",iRet));
	return iRet;
}


int BreakDownRespMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
        int     iRet = PD_OK;
        char    *csBuf;
        char    *p;

        csBuf = (char*) malloc (1024 +1);

        memcpy(csBuf,inMsg,inLen);
        csBuf[inLen] = '\0';
DEBUGLOG(("BreakDownRespMsg()\n"));
DEBUGLOG(("DATA = [%s]\n",inMsg));

/* order_num */
        p = GetField(csBuf,"order_num",MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        if (p) {
                PutField_CString(hOut,"txn_seq",p);
DEBUGLOG(("BreakDownRespMsg:: txn_seq[order_num] = [%s]\n",p));
        }
/* encrypted_order_num */
        p = GetField(csBuf,"sessionid",MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        if (p) {
                PutField_CString(hOut,"encrypted_txn_seq",p);
DEBUGLOG(("BreakDownRespMsg:: txn_seq[encrypted_order_num] = [%s]\n",p));
        }
/* status */
        p = GetField(csBuf,"status",MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        if (p) {
                PutField_CString(hOut,"status",p);
DEBUGLOG(("BreakDownRespMsg:: status = [%s]\n",p));
        }

/* FERESP */
        p = GetField(csBuf,"FERESP",MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        if (p) {
                PutField_Char(hOut,"FERESP",p[0]);
DEBUGLOG(("BreakDownRespMsg:: FERESP = [%c]\n",p[0]));
        }

        FREE_ME(csBuf);
DEBUGLOG(("BreakDownRespMsg Exit\n"));
        return  iRet;

}

int BuildAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char    *csVal;
        char    *csData;

        csData = (char*) malloc (PD_TMP_BUF_LEN +1);
	csData[0] = '\0';

        if (GetField_CString(hIn,"txn_amt",&csVal)) {
DEBUGLOG(("BuildAuthData txn_amt = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"txn_ccy",&csVal)) {
DEBUGLOG(("BuildAuthData txn_ccy = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"merchant_ref",&csVal)) {
DEBUGLOG(("BuildAuthData merchant_ref = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"transmission_datetime",&csVal)) {
DEBUGLOG(("BuildAuthData transmission_datetime = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"txn_country",&csVal)) {
DEBUGLOG(("BuildAuthData txn_country = [%s]\n",csVal));
                strcat(csData,csVal);
        }
DEBUGLOG(("BuildAuthData = [%s]\n",csData));
        PutField_CString(hIn,"auth_data",csData);

	FREE_ME(csData);
        return iRet;
}

int BuildRespAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char    *csVal;
        char    *csData;

        csData = (char*) malloc (PD_TMP_BUF_LEN * 4+1);
	csData[0] = '\0';

        if (GetField_CString(hIn,"response_code",&csVal)) {
DEBUGLOG(("BuildRespAuthData response_code = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"redirect_url",&csVal)) {
DEBUGLOG(("BuildRespAuthData redirect_url = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"merchant_ref",&csVal)) {
DEBUGLOG(("BuildRespAuthData merchant_ref = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"merchant_id",&csVal)) {
DEBUGLOG(("BuildRespAuthData merchant_id = [%s]\n",csVal));
                strcat(csData,csVal);
        }
DEBUGLOG(("BuildRespAuthData = [%s]\n",csData));
        PutField_CString(hIn,"auth_data",csData);

DEBUGLOG(("BuildRespAuthData iRet = [%d]\n",iRet));
	FREE_ME(csData);
        return iRet;
}


int FormatAckMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{                               
        int     iRet = PD_OK;
        char*   csBuf;  
        char*   csPtr;  
        char    cStatus;
	char   	csTmp[PD_TMP_BUF_LEN + 1];
	double	dTmp;
        
DEBUGLOG(("FormatAckMsg()\n"));
        outMsg[0]= '\0'; 
        *outLen = 0;
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );
                        
                                
        memset(csBuf,0,sizeof(csBuf));
        strcat((char*)csBuf,"url");
        strcat((char*)csBuf,MY_WEB_FIELD_TOKEN);
                        
        if (GetField_Char(hIn,"ar_ind",&cStatus)) {
DEBUGLOG(("FormatAckMsg txn_status = [%c]\n",cStatus));
        }       
        if (cStatus == PD_ACCEPT) {
                if (GetField_CString(hIn,"success_callback_url",&csPtr)) {
                        strcat((char*)csBuf,csPtr);
DEBUGLOG(("FormatAckMsg success_callback_url = [%s]\n",csPtr));
                }
        
        }
        else {  
                if (GetField_CString(hIn,"failure_callback_url",&csPtr)) {
                        strcat((char*)csBuf,csPtr);
DEBUGLOG(("FormatAckMsg failure_callback_url = [%s]\n",csPtr));
                }               
        }                       
        strcat((char*)csBuf,MY_WEB_TOKEN);

        sprintf(outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
        strcat(outMsg,csBuf);

/*process_type*/
        if (GetField_CString(hIn,"process_type",&csPtr)){
DEBUGLOG(("FormatAckMsg:: process_type = [%s]\n",csPtr));
                strcat((char*)outMsg,"process_type");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: process_type is missing!!!\n"));
	}

/*process_code*/
        if (GetField_CString(hIn,"process_code",&csPtr)){
DEBUGLOG(("FormatAckMsg:: process_code = [%s]\n",csPtr));
                strcat((char*)outMsg,"process_code");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: process_type is missing!!!\n"));
	}

/* status */
        if (GetField_CString(hIn,"response_code",&csPtr)){
DEBUGLOG(("FormatAckMsg:: response code  = [%s]\n",csPtr));
        	strcat((char*)outMsg,"status");
        	strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
        	strcat((char*)outMsg,csPtr);
        	strcat((char*)outMsg,MY_WEB_TOKEN);
	}
	else {
DEBUGLOG(("FormatAckMsg:: response code is missing!!!\n"));
	}

/*txn_seq*/
        if (GetField_CString(hIn,"txn_seq",&csPtr)){
DEBUGLOG(("FormatAckMsg:: txn_seq = [%s]\n",csPtr));
                strcat((char*)outMsg,"txn_id");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: txn_seq is missing!!!\n"));
	}

/*txn_date*/
        if (GetField_CString(hIn,"local_transmission_datetime",&csPtr)){
DEBUGLOG(("FormatAckMsg:: txn_date = [%s]\n",csPtr));
                strcat((char*)outMsg,"txn_date");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: txn_date is missing!!!\n"));
	}

/*net_ccy*/
        if (GetField_CString(hIn,"net_ccy",&csPtr)){
DEBUGLOG(("FormatAckMsg:: net_ccy = [%s]\n",csPtr));
                strcat((char*)outMsg,"net_ccy");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: net_ccy is missing!!!\n"));
	}

/* net_amt */
        if (GetField_Double(hIn,"net_amt",&dTmp)) {
DEBUGLOG(("FormatAckMsg:: NET AMOUNT = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatAckMsg:: AMOUNT = [%s]\n",csTmp));
                strcat((char*)outMsg,"net_amt");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csTmp);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }

/* service_fee */
        if (GetField_Double(hIn,"service_fee",&dTmp)) {
DEBUGLOG(("FormatAckMsg:: service_fee AMOUNT = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatAckMsg:: service_fee = [%s]\n",csTmp));
                strcat((char*)outMsg,"service_fee");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csTmp);
                strcat((char*)outMsg,MY_WEB_TOKEN);

		if (GetField_CString(hIn,"service_fee_ccy",&csPtr)) {
DEBUGLOG(("FormatAckMsg:: service_fee_ccy = [%s]\n",csPtr));
                	strcat((char*)outMsg,"service_fee_ccy");
                	strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                	strcat((char*)outMsg,csPtr);
                	strcat((char*)outMsg,MY_WEB_TOKEN);
		}
		else {
DEBUGLOG(("FormatAckMsg:: service_fee_ccy is missing!!!\n"));
		}
        }

/* txn_amt */
        if (GetField_Double(hIn,"txn_amt",&dTmp)) {
DEBUGLOG(("FormatAckMsg:: txn amt = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatAckMsg:: txn amt = [%s]\n",csTmp));
                strcat((char*)outMsg,"txn_amt");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csTmp);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: txn_amt is missing!!!\n"));
	}

/* txn_ccy */
        if (GetField_CString(hIn,"txn_ccy",&csPtr)){
DEBUGLOG(("FormatAckMsg:: txn_ccy = [%s]\n",csPtr));
                strcat((char*)outMsg,"txn_ccy");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: txn_ccy is missing!!!\n"));
	}



/*merchant_ref*/
        if (GetField_CString(hIn,"merchant_ref",&csPtr)){
DEBUGLOG(("FormatAckMsg:: mer_ref = [%s]\n",csPtr));
                strcat((char*)outMsg,"mer_ref");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: merchant_ref is missing!!!\n"));
	}

/*mer_txn_date*/
        if (GetField_CString(hIn,"transmission_datetime",&csPtr)){
DEBUGLOG(("FormatAckMsg:: mer_txn_date = [%s]\n",csPtr));
                strcat((char*)outMsg,"mer_txn_date");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: mer_txn_date is missing!!!\n"));
	}


/*merchant_id*/
        if (GetField_CString(hIn,"merchant_id",&csPtr)){
DEBUGLOG(("FormatAckMsg:: mer_id = [%s]\n",csPtr));
                strcat((char*)outMsg,"mer_id");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: merchant_id is missing!!!\n"));
	}

/*encrypt_type*/
        if (GetField_CString(hIn,"encrypt_type",&csPtr)){
DEBUGLOG(("FormatAckMsg:: enctype = [%s]\n",csPtr));
                strcat((char*)outMsg,"enctype");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: enctype is missing!!!\n"));
	}

/*sign*/
        if (GetField_CString(hIn,"mac",&csPtr)){
DEBUGLOG(("FormatAckMsg:: SIGN = [%s]\n",csPtr));
                strcat((char*)outMsg,"signature");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: sign is missing!!!\n"));
	}
/* remark */
        if (GetField_CString(hIn,"remark",&csPtr)){
DEBUGLOG(("FormatAckMsg:: remark = [%s]\n",csPtr));
                strcat((char*)outMsg,"remark");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: sign is missing!!!\n"));
	}

        *outLen = strlen((const char*)outMsg);


        FREE_ME(csBuf);
DEBUGLOG(("FormatAckMsg:: outMsg = [%s]\n",outMsg));
DEBUGLOG(("FormatAckMsg() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

int BuildAckAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char    *csVal;
        char    *csData;
	double	dTmp;
	

        csData = (char*) malloc (PD_TMP_BUF_LEN +1);
        csData[0] = '\0';

        if (GetField_CString(hIn,"response_code",&csVal)) {
DEBUGLOG(("BuildAckAuthData response_code = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"txn_seq",&csVal)) {
DEBUGLOG(("BuildAckAuthData txn_seq = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"local_transmission_datetime",&csVal)) {
DEBUGLOG(("BuildAckAuthData local_transmission_datetime = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"net_ccy",&csVal)) {
DEBUGLOG(("BuildAckAuthData net_ccy = [%s]\n",csVal));
                strcat(csData,csVal);
        }
	/* net_amt */
        if (GetField_Double(hIn,"net_amt",&dTmp)) {
		char*	csTmp;
		csTmp = (char*) malloc (PD_TMP_BUF_LEN + 1);	

DEBUGLOG(("BuildAckAuthData NET AMOUNT = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("BuildAckAuthData net_amt = [%s]\n",csTmp));
                strcat(csData,csTmp);
		FREE_ME(csTmp);
        }

        if (GetField_CString(hIn,"merchant_ref",&csVal)) {
DEBUGLOG(("BuildAckAuthData merchant_ref = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"merchant_id",&csVal)) {
DEBUGLOG(("BuildAckAuthData merchant_id = [%s]\n",csVal));
                strcat(csData,csVal);
        }
DEBUGLOG(("BuildRespAuthData = [%s]\n",csData));
        PutField_CString(hIn,"auth_data",csData);

        FREE_ME(csData);
        return iRet;
}
