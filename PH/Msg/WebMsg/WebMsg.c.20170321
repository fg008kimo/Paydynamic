/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2010                    Cody Chan
handle new psp: ESKY                               20110110                LokMan Chow
call ESkeyMsg Ptr				   20110113		   LokMan Chow
add encrypt type				   20110209		   LokMan Chow
add client ip and service code			   20110218		   LokMan Chow
Add Txn Seq to AckMsg				   2011/11/14		   Cody	Chan
Add AllinPay					   2012/02/15		   Cody Chan
Add SengPay					   2012/04/02		   Cody Chan
Add Selected PID				   2013/03/13		   Cody Chan
Add Magic #,Word and Customer ID		   2013/08/19		   Cody Chan
Add Customer ID in BuildAckAuthData		   2013/08/21		   David Wong
Add ECPSS					   2013/09/03		   Cody Chan
Add BAOFOO and HNA				   2014/07/16              LokMan Chow
Add TenPay Mobile				   2014/08/12              Cody Chan
Add  ReaPay					   2015/03/11              Cody Chan
Add EasyPay					   2015/05/28              LokMan Chow
Add YeePay Mobile				   2015/08/03              LoKMan Chow
Remove EasyPay					   2015/09/21              LokMan Chow
Extend csBuf in BreakDownRespMsg		   2015/12/05              Virginia Yun
Add YsePay					   2016/06/28		   LokMan Chow
Add HeePay and 
 set system_parameter for mobile simulator	   2016/08/24		   LokMan Chow
Add ECPSS Mobile				   2016/09/30		   David Wong
Support Card Type Option			   2016/10/28		   LokMan Chow
Add WeChatPay					   2016/12/14		   David Wong
Add XJ-Ehk					   2016/12/15		   David Wong
Add Now2Pay					   2016/12/22		   David Wong
Add EASYPAY-AIPWeChat				   2017/01/09		   David Wong

*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "WebMsg.h"
#include "common.h"
#include "utilitys.h"
#include "b64.h"
#include "queue_defs.h"
#include "internal.h"
#include <zlib.h>
#include "ObjPtr.h"

char	cDebug;

OBJPTR(Msg);
OBJPTR(DB);

void	WebMsg(char cdebug)
{
	cDebug = cdebug;
}

int ParseField(hash_t *hOut,const char* inMsg);
int DeBlockWTBData(hash_t *hOut,const char* inMsg);
int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;

//	double	dTmp;
	char*	csTmp = NULL;
	char*	csPtr = NULL;
	char*	csPspChannel = NULL;
	char*   csTxnCode = strdup("");
	char*	csBuf;
	char*	csLang;
	char	cStatus;
	char	cArInd;
//	char	cPtr;
	int     iSIM = PD_FALSE;
DEBUGLOG(("FormatMsg()\n"));

//txn code
        if (GetField_CString(hIn,"txn_code",&csTxnCode)) {
DEBUGLOG(("FormatMsg:: txn_code = [%s]\n",csTxnCode));
        }	

//language
	if (GetField_CString(hIn,"language",&csLang)) {
DEBUGLOG(("FormatMsg:: language = [%s]\n",csLang));
        }

//use simulator?
	if (GetField_Int(hIn,"use_mobile_simulator",&iSIM)) {
DEBUGLOG(("FormatMsg:: use_mobile_simulator = [%d]\n",iSIM));
	}

	outMsg[0]= '\0';
	*outLen = 0;

	if (!strcmp(csTxnCode,PD_WITHDRAW_BATCH_TXN_CODE)) {
		if (GetField_CString(hIn,"response_code",&csPtr)) {
DEBUGLOG(("FormatMsg:: response_code = [%s]\n", csPtr));
                	strcat((char*)outMsg,"response_code");
                	strcat((char*)outMsg,"=");
                	strcat((char*)outMsg, csPtr);
			*outLen = strlen((const char*)outMsg);
		}
		return iRet;
	}
/************************/

	if (GetField_Char(hIn,"status",&cStatus)) {
DEBUGLOG(("FormatMsg:: status = [%c]\n",cStatus));
		if (cStatus == PD_TO_PSP &&  strcmp(csTxnCode,PD_MOBILE_DSP_CODE)) {
			if (!GetField_CString(hIn,"psp_channel_code",&csPspChannel)) {
DEBUGLOG(("FormatMsg:: Psp Channel Code Not Found!\n"));
ERRLOG("WebMsg::FormatMsg:: Psp Channel Code Not Found!\n");
                        }
                        else{

DEBUGLOG(("FormatMsg:: Psp Id = [%s]\n",csPspChannel));
// call TWV
				if(!strcmp(csPspChannel,PD_CHANNEL_TWV) ||
				   !strcmp(csPspChannel,PD_CHANNEL_51EPAY) ||
				   !strcmp(csPspChannel,PD_CHANNEL_TENMOBPAY) ||
				   !strcmp(csPspChannel,PD_CHANNEL_PGEN)){
                                        if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: redirect_url = [%s]\n",csPtr));
						char* csTmpBuf;
                                                csTmpBuf = (char*) malloc (PD_MAX_BUFFER +1);
                                                strcpy(csTmpBuf,csPtr);
/* for redriect */
						if(strcmp(csPspChannel,PD_CHANNEL_TWV))
                                                	strcat(csTmpBuf,"?");
//MID
				   		if (!strcmp(csPspChannel,PD_CHANNEL_51EPAY)) {
//#ifdef _SIMULATOR_
							if(iSIM){
								char*   csValueTmp;
								csValueTmp = (char*) malloc (PD_TMP_BUF_LEN);
								csValueTmp[0] = '\0';
								DBObjPtr = CreateObj(DBPtr,"DBSystemParameter","FindCode");
								if ((unsigned long)(DBObjPtr)("FEP_SIM_URL",csValueTmp) == FOUND) {
DEBUGLOG(("FormatMsg::Mobile simulator URL  = [%s]\n",csValueTmp));

									strcpy(csTmpBuf,csValueTmp);
									if(GetField_CString(hIn,"txn_seq",&csPtr)){
										strcat(csTmpBuf,"RMARK1");
										strcat(csTmpBuf,MY_WEB_FIELD_TOKEN );
										strcat(csTmpBuf,csPtr);
										strcat(csTmpBuf,MY_WEB_TOKEN);
									}
									char    csTmp[PD_TMP_BUF_LEN + 1];
									double  dTmp;
									if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {
										sprintf((char*)csTmp,"%.2f",dTmp);
										strcat(csTmpBuf,"AMT");
										strcat(csTmpBuf,MY_WEB_FIELD_TOKEN );
										strcat(csTmpBuf,csTmp);
										strcat(csTmpBuf,MY_WEB_TOKEN);
									}
								}
							}
//#endif

/* MID */
							if (GetField_CString(hIn,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("FormatMsg:: psp_merchant_id = [%s]\n",csPtr));
                                                        	strcat(csTmpBuf,"MID");
                                                        	strcat(csTmpBuf,MY_WEB_FIELD_TOKEN );
                                                        	strcat(csTmpBuf,csPtr);
                                                        	strcat(csTmpBuf,MY_WEB_TOKEN);
DEBUGLOG(("FormatMsg:: [%s]\n",csTmpBuf));
                                                	}
                                                	else {
DEBUGLOG(("FormatMsg:: psp_merchant_id not found\n"));
                                                	}
/* SC*/	
							if (GetField_CString(hIn,"sc",&csPtr)) {
DEBUGLOG(("FormatMsg:: sc = [%s]\n",csPtr));
                                                        	strcat(csTmpBuf,"SC");
                                                        	strcat(csTmpBuf,MY_WEB_FIELD_TOKEN );
                                                        	strcat(csTmpBuf,csPtr);
DEBUGLOG(("FormatMsg:: [%s]\n",csTmpBuf));
                                                	}
                                                	else {
DEBUGLOG(("FormatMsg:: sc not found\n"));
                                                	}
						}

						if (!strcmp(csPspChannel,PD_CHANNEL_TENMOBPAY)) {
/* token_id */
                                                        if (GetField_CString(hIn,"sc",&csPtr)) {
DEBUGLOG(("FormatMsg:: sc = [%s]\n",csPtr));
                                                                strcat(csTmpBuf,"token_id");
                                                                strcat(csTmpBuf,MY_WEB_FIELD_TOKEN );
                                                                strcat(csTmpBuf,csPtr);
DEBUGLOG(("FormatMsg:: [%s]\n",csTmpBuf));
                                                        }
                                                        else {
DEBUGLOG(("FormatMsg:: sc not found\n"));
                                                        }

/* bank_code */
                                                        if (GetField_CString(hIn,"bank_code",&csPtr)) {
DEBUGLOG(("FormatMsg:: bank_code = [%s]\n",csPtr));
                                                                strcat(csTmpBuf,MY_WEB_TOKEN);
                                                                strcat(csTmpBuf,"bank_type");
                                                                strcat(csTmpBuf,MY_WEB_FIELD_TOKEN );
                                                                strcat(csTmpBuf,"0");
DEBUGLOG(("FormatMsg:: [%s]\n",csTmpBuf));
                                                        }
                                                        else {
DEBUGLOG(("FormatMsg:: bank_code not found\n"));
                                                        }
                                                }


                                                strcat((char*)outMsg,"redirect_url");
                                                strcat((char*)outMsg,"=");
                                                csBuf = (char*) malloc (PD_MAX_BUFFER +1);
                                                base64_encode((unsigned char*)csTmpBuf,strlen(csTmpBuf),csBuf,PD_MAX_BUFFER);
                                                strcat((char*)outMsg,csBuf);
                                                *outLen = strlen((const char*)outMsg);

                                                FREE_ME(csBuf);
						FREE_ME(csTmpBuf);
                                        }
                                        else {
DEBUGLOG(("FormatMsg redirect_url not found\n"));
ERRLOG("FormatMsg redirect_url not found\n");
                                        }
                                }
                                else if(!strcmp(csPspChannel,PD_CHANNEL_ESKY)){
//call ESkyMsg//
                                        MsgObjPtr = CreateObj(MsgPtr,"ESkyMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format ESkyMsg error\n"));
ERRLOG("FormatMsg format ESkyMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));

                                }
				else if(!strcmp(csPspChannel,PD_CHANNEL_EEP)){
//call EepMsg//
                                        MsgObjPtr = CreateObj(MsgPtr,"EepMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format EepyMsg error\n"));
ERRLOG("FormatMsg format EepMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));

                                }
                                else if(!strcmp(csPspChannel,PD_CHANNEL_HAIPAY)){
//call HaiMsg//
                                        MsgObjPtr = CreateObj(MsgPtr,"HaiMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format HaiMsg error\n"));
ERRLOG("FormatMsg format HaiMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
                                else if(!strcmp(csPspChannel,PD_CHANNEL_HPAY)){
//call HpyMsg//
                                        MsgObjPtr = CreateObj(MsgPtr,"HpyMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format HpyMsg error\n"));
ERRLOG("FormatMsg format HpyMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
/* call Haipay ChinaPay */
				else if(!strcmp(csPspChannel,PD_CHANNEL_HPAY_CNP)){
DEBUGLOG(("Call HcpMsg\n"));
 					MsgObjPtr = CreateObj(MsgPtr,"HcpMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format HcpMsg error\n"));
ERRLOG("FormatMsg format HcpMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
                                else if(!strcmp(csPspChannel,PD_CHANNEL_LKPAY)){
//call LKPAY//
                                        MsgObjPtr = CreateObj(MsgPtr,"LkpMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format LkpMsg error\n"));
ERRLOG("FormatMsg format LkpMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
                                else if(!strcmp(csPspChannel,PD_CHANNEL_HHPAY)){
//call HoHoPay//
                                        MsgObjPtr = CreateObj(MsgPtr,"HhpMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format HhpMsg error\n"));
ERRLOG("FormatMsg format HhpMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
                                else if(!strcmp(csPspChannel,PD_CHANNEL_PGEN)){
//call PayGen//
                                        MsgObjPtr = CreateObj(MsgPtr,"PgnMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format PgnMsg error\n"));
ERRLOG("FormatMsg format PgnMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
				
				else if(!strcmp(csPspChannel,PD_CHANNEL_YEEPAY)){
//call YeePay//
                                        MsgObjPtr = CreateObj(MsgPtr,"YpyMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format YpyMsg error\n"));
ERRLOG("FormatMsg format YpyMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
//call AllinPay//
                                else if(!strcmp(csPspChannel,PD_CHANNEL_ALLINPAY)){
                                        MsgObjPtr = CreateObj(MsgPtr,"AlpMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format AlpMsg error\n"));
ERRLOG("FormatMsg format AlpMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
//call SpyMsg
                                else if(!strcmp(csPspChannel,PD_CHANNEL_SHENGPAY)){
                                        MsgObjPtr = CreateObj(MsgPtr,"SpyMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format SpyMsg error\n"));
ERRLOG("FormatMsg format SpyMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
//call IpyMsg
                                else if(!strcmp(csPspChannel,PD_CHANNEL_IPAY)){
                                        MsgObjPtr = CreateObj(MsgPtr,"IpyMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format IpyMsg error\n"));
ERRLOG("FormatMsg format IpyMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
//tmp GOPAY
                                else if(!strcmp(csPspChannel,PD_CHANNEL_GOPAY)){
                                        MsgObjPtr = CreateObj(MsgPtr,"GpyMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format GpyMsg error\n"));
ERRLOG("FormatMsg format GpyMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
//ECPSS
                                else if(!strcmp(csPspChannel,PD_CHANNEL_ECPSS)){
                                        MsgObjPtr = CreateObj(MsgPtr,"EcpMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format EcpMsg error\n"));
ERRLOG("FormatMsg format EcpMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
//PROFIT-TOM
                                else if(!strcmp(csPspChannel,PD_CHANNEL_PFTTOM)){
                                        MsgObjPtr = CreateObj(MsgPtr,"PftMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format PftMsg error\n"));
ERRLOG("FormatMsg format PftMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
//EPlutus
                                else if(!strcmp(csPspChannel,PD_CHANNEL_EPLUTUS)){
                                        MsgObjPtr = CreateObj(MsgPtr,"EptMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format EptMsg error\n"));
ERRLOG("FormatMsg format EptMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
//UniPaygo
                                else if(!strcmp(csPspChannel,PD_CHANNEL_UNIPAY)){
                                        MsgObjPtr = CreateObj(MsgPtr,"UniMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format UniMsg error\n"));
ERRLOG("FormatMsg format UniMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
//Baofoo
                                else if(!strcmp(csPspChannel,PD_CHANNEL_BAOFOO)){
                                        MsgObjPtr = CreateObj(MsgPtr,"BfoMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format BfoMsg error\n"));
ERRLOG("FormatMsg format BfoMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
//HnaPay
                                else if(!strcmp(csPspChannel,PD_CHANNEL_HNAPAY)){
                                        MsgObjPtr = CreateObj(MsgPtr,"HnaMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format HnaMsg error\n"));
ERRLOG("FormatMsg format HnaMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
//TenPay
				else if(!strcmp(csPspChannel,PD_CHANNEL_TENPAY)){
                                        MsgObjPtr = CreateObj(MsgPtr,"TpyMsg","FormatMsg");
                                        if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format TpyMsg error\n"));
ERRLOG("FormatMsg format TpyMsg error\n");
                                        }
                                        else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                                }
//ReaPay
				else if(!strcmp(csPspChannel,PD_CHANNEL_REAPAY)){
					MsgObjPtr = CreateObj(MsgPtr,"RpyMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format RpyMsg error\n"));
ERRLOG("FormatMsg format RpyMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
				}
                                else if(!strcmp(csPspChannel,PD_CHANNEL_YEEPAYMOBILE)){
//call YeePay Mobile//
					MsgObjPtr = CreateObj(MsgPtr,"YpmMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format YpmMsg error\n"));
ERRLOG("FormatMsg format YpmMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
				}
                                else if(!strcmp(csPspChannel,PD_CHANNEL_YSEPAY)){
//call YsePay//
					MsgObjPtr = CreateObj(MsgPtr,"YseMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format YseMsg error\n"));
ERRLOG("FormatMsg format YseMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
				}
                                else if(!strcmp(csPspChannel,PD_CHANNEL_HEEPAY)){
//call HeePay//
					MsgObjPtr = CreateObj(MsgPtr,"HeeMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format HeeMsg error\n"));
ERRLOG("FormatMsg format HeeMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
				}
				else if(!strcmp(csPspChannel,PD_CHANNEL_ECPSSMOBILE)){
//call ECPSS Mobile//
					MsgObjPtr = CreateObj(MsgPtr,"EcmMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format EcmMsg error\n"));
ERRLOG("FormatMsg format EcmMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
				}
				else if(!strcmp(csPspChannel,PD_CHANNEL_WECHATPAY)){
//call WeChatPay//
					MsgObjPtr = CreateObj(MsgPtr,"WcpMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format WcpMsg error\n"));
ERRLOG("FormatMsg format WcpMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
				}
				else if(!strcmp(csPspChannel,PD_CHANNEL_XJP)){
//call XJ-Ehk
					MsgObjPtr = CreateObj(MsgPtr,"XjpMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format XjpMsg error\n"));
ERRLOG("FormatMsg format XjpMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
				}
				else if(!strcmp(csPspChannel,PD_CHANNEL_NOW2PAY)){
//call Now2Pay
					MsgObjPtr = CreateObj(MsgPtr,"NtpMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format NtpMsg error\n"));
ERRLOG("FormatMsg format NtpMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
				}
				else if(!strcmp(csPspChannel,PD_CHANNEL_AIPWECHAT)){
//call EASYPAY-AIPWeChat
					MsgObjPtr = CreateObj(MsgPtr,"AwcMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format AwcMsg error\n"));
ERRLOG("FormatMsg format AwcMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
				}

                                else {
DEBUGLOG(("FormatMsg format error !!! undefine msg object [%s]\n",csPspChannel));
ERRLOG("WebMsg::FormatMsg format error !!! undefine msg object [%s]\n",csPspChannel);

				}

			}
			return iRet;
		}

		else if(!strcmp(csTxnCode,PD_CUSTOMER_INFO_ADD) || !strcmp(csTxnCode,PD_CUSTOMER_INFO_DEL)
			||!strcmp(csTxnCode,PD_CUSTOMER_GRP_ENABLE) || !strcmp(csTxnCode,PD_CUSTOMER_GRP_DISABLE)) {
			if (GetField_CString(hIn,"process_type",&csPtr)) {
DEBUGLOG(("FormatMsg (NETWORK):: process_type = [%s]\n",csPtr));
				strcat((char*)outMsg,"process_type");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"process_code",&csPtr)) {
DEBUGLOG(("FormatMsg (NETWORK):: process_code = [%s]\n",csPtr));
				strcat((char*)outMsg,"process_code");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}

			//if (!strcmp(csTxnCode,PD_CUSTOMER_INFO_ADD) || !strcmp(csTxnCode,PD_CUSTOMER_INFO_DEL)) {
				if (GetField_CString(hIn,"response_code",&csPtr)) {
DEBUGLOG(("FormatMsg (NETWORK):: response_code = [%s]\n",csPtr));
					strcat((char*)outMsg,"status");
					strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
					strcat((char*)outMsg,csPtr);
					strcat((char*)outMsg,MY_WEB_TOKEN);
				}
			//}

			if (!strcmp(csTxnCode,PD_CUSTOMER_GRP_ENABLE) || !strcmp(csTxnCode,PD_CUSTOMER_GRP_DISABLE)) {
				if (GetField_CString(hIn,"service_code",&csPtr)) {
DEBUGLOG(("FormatMsg (NETWORK):: service_code = [%s]\n",csPtr));
					strcat((char*)outMsg,"service_code");
					strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
					strcat((char*)outMsg,csPtr);
					strcat((char*)outMsg,MY_WEB_TOKEN);
				}
			}



			if (GetField_CString(hIn,"key_id",&csPtr)) {
DEBUGLOG(("FormatMsg (NETWORK):: key_id = [%s]\n",csPtr));
				strcat((char*)outMsg,"key_id");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"customer_id",&csPtr)) {
DEBUGLOG(("FormatMsg (NETWORK):: customer_id = [%s]\n",csPtr));
				strcat((char*)outMsg,"user_id");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"vp_txn_gp_id",&csPtr)) {
DEBUGLOG(("FormatMsg (NETWORK):: vp_txn_gp_id = [%s]\n",csPtr));
				strcat((char*)outMsg,"vp_txn_gp_id");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}

			if (GetField_CString(hIn,"encrypt_type",&csPtr)) {
DEBUGLOG(("FormatMsg (NETWORK):: encrypt_type = [%s]\n",csPtr));
				strcat((char*)outMsg,"enctype");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}

			if (GetField_CString(hIn,"mac",&csPtr)) {
DEBUGLOG(("FormatMsg (NETWORK):: mac = [%s]\n",csPtr));
				strcat((char*)outMsg,"signature");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
			}
DEBUGLOG(("FormatMsg (NETWORK):: outmsg = [%s]\n",outMsg));
			*outLen = strlen((const char*)outMsg);
			return iRet;

		}
		else if(cStatus==PD_INIT || cStatus == PD_COMPLETE || !strcmp(csTxnCode,PD_MOBILE_DSP_CODE)) {
			if (GetField_CString(hIn,"process_type",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: process_type = [%s]\n",csPtr));
				strcat((char*)outMsg,"process_type");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"process_code",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: process_code = [%s]\n",csPtr));
				strcat((char*)outMsg,"process_code");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"response_code",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: response_code = [%s]\n",csPtr));
				strcat((char*)outMsg,"status");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: url = [%s]\n",csPtr));
				strcat((char*)outMsg,"txn_url");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				char* csBuf;
				csBuf = (char*) malloc (PD_MAX_BUFFER +1);
        			base64_encode((unsigned char*)csPtr,strlen(csPtr),csBuf,PD_MAX_BUFFER);
				strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatMsg (INI):: url = [%s] base64\n",csBuf));
				strcat((char*)outMsg,MY_WEB_TOKEN);
				FREE_ME(csBuf);
			}
			else {
				strcat((char*)outMsg,"txn_url");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}

			if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: merchant_ref = [%s]\n",csPtr));
				strcat((char*)outMsg,"mer_ref");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"merchant_id",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: merchant_id = [%s]\n",csPtr));
				strcat((char*)outMsg,"mer_id");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"encrypt_type",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: encrypt_type = [%s]\n",csPtr));
				strcat((char*)outMsg,"enctype");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"sc",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: sc = [%s]\n",csPtr));
				strcat((char*)outMsg,"sc");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: mid = [%s]\n",csPtr));
				strcat((char*)outMsg,"mid");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_CString(hIn,"mac",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: mac = [%s]\n",csPtr));
				strcat((char*)outMsg,"signature");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
			}
DEBUGLOG(("FormatMsg (INI):: outmsg = [%s]\n",outMsg));
				*outLen = strlen((const char*)outMsg);

			if (GetField_CString(hIn,"psp_channel_code",&csPspChannel)) {
DEBUGLOG(("FormatMsg:: Psp Channel Code = [%s]\n",csPspChannel));
				if (GetField_Char(hIn,"ar_ind",&cArInd)) {
DEBUGLOG(("FormatMsg:: Ar Indicator = [%c]\n",cArInd));
					if (!strcmp(csPspChannel,PD_CHANNEL_WECHATPAY) && cArInd == PD_REJECT) {
						MsgObjPtr = CreateObj(MsgPtr,"WcpMsg","FormatMsg");
						if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format WcpMsg error\n"));
ERRLOG("FormatMsg format WcpMsg error\n");
						}
						else {
DEBUGLOG(("FormatMsg:: the above outmsg has been overridden\n"));
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
						}
					}
					else if (!strcmp(csPspChannel,PD_CHANNEL_AIPWECHAT) && cArInd == PD_REJECT) {
						MsgObjPtr = CreateObj(MsgPtr,"AwcMsg","FormatMsg");
						if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format AwcMsg error\n"));
ERRLOG("FormatMsg format AwcMsg error\n");
						}
						else {
DEBUGLOG(("FormatMsg:: the above outmsg has been overridden\n"));
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
						}
					}
				}
			}

			return iRet;
		}
	}


/* response code */
	if (GetField_CString(hIn,"response_code",&csPtr)) {
		if (!strcmp(csPtr,"0")) {
			if (GetField_CString(hIn,"success_url",&csTmp)) {
                		strcat((char*)outMsg,csTmp);
			}
		}
		else {
			if (GetField_CString(hIn,"failure_url",&csTmp)) {
                		strcat((char*)outMsg,csTmp);
			}
		}
                strcat((char*)outMsg,"?");
DEBUGLOG(("FormatMsg:: redirect_url = [%s]\n",outMsg));
DEBUGLOG(("FormatMsg:: response_code = [%s]\n",csPtr));
                strcat((char*)outMsg,"status");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
		
	}

DEBUGLOG(("try to compare [%s]\n",csTxnCode));
/* DSP txn */
        if (!strcmp(csTxnCode,PD_DEPOSIT_TXN_CODE)) {
DEBUGLOG(("FormatMsg:: [%s]\n",csTxnCode));
//status
		if (GetField_CString(hIn,"status",&csPtr)) {
DEBUGLOG(("FormatMsg:: status = [%s]\n",csPtr));
                        strcat((char*)outMsg,"status");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//transaction_id
		if (GetField_CString(hIn,"transaction_id",&csPtr)) {
DEBUGLOG(("FormatMsg:: transaction_id = [%s]\n",csPtr));
                        strcat((char*)outMsg,"transaction_id");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

		if (GetField_CString(hIn,"psp_txn_amt",&csPtr)) {
DEBUGLOG(("FormatMsg:: amount = [%s]\n",csPtr));
                        strcat((char*)outMsg,"amount");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//currency_code
		
                if (GetField_CString(hIn,"txn_ccy",&csPtr)) {
DEBUGLOG(("FormatMsg:: currency_code = [%s]\n",csPtr));
                        strcat((char*)outMsg,"currency_code");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//reference
		if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
DEBUGLOG(("FormatMsg:: reference = [%s]\n",csPtr));
                        strcat((char*)outMsg,"reference");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }


//request_time
		if (GetField_CString(hIn,"transaction_datetime",&csPtr)) {
DEBUGLOG(("FormatMsg:: transmission_datetime = [%s]\n",csPtr));
                        strcat((char*)outMsg,"transaction_datetime");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//merchant_id
		if (GetField_CString(hIn,"merchant_id",&csPtr)) {
DEBUGLOG(("FormatMsg:: merchant_id = [%s]\n",csPtr));
                        strcat((char*)outMsg,"merchant_id");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//response_time
		if (GetField_CString(hIn,"response_time",&csPtr)) {
DEBUGLOG(("FormatMsg:: response_time = [%s]\n",csPtr));
                        strcat((char*)outMsg,"response_time");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//country
/*
		if (GetField_CString(hIn,"txn_country",&csPtr)) {
DEBUGLOG(("FormatMsg:: txn_country = [%s]\n",csPtr));
                        strcat((char*)outMsg,"country");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
*/
	
//pay_method
		if (GetField_CString(hIn,"pay_method",&csPtr)) {
DEBUGLOG(("FormatMsg:: pay_method = [%s]\n",csPtr));
                        strcat((char*)outMsg,"pay_method");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//bank_code
		if (GetField_CString(hIn,"bank_code",&csPtr)) {
DEBUGLOG(("FormatMsg:: bank_code = [%s]\n",csPtr));
                        strcat((char*)outMsg,"bank_code");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//service_fee
		if (GetField_CString(hIn,"service_fee",&csPtr)) {
DEBUGLOG(("FormatMsg:: service_fee = [%s]\n",csPtr));
                        strcat((char*)outMsg,"service_fee");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//service_currency
		if (GetField_CString(hIn,"service_currency",&csPtr)) {
DEBUGLOG(("FormatMsg:: service_currency = [%s]\n",csPtr));
                        strcat((char*)outMsg,"service_currency");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }


//remark
		if (GetField_CString(hIn,"remark",&csPtr)) {
DEBUGLOG(("FormatMsg:: remark = [%s]\n",csPtr));
                        strcat((char*)outMsg,"remark");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//response time
		if (GetField_CString(hIn,"local_tm_date",&csPtr)) {
                        strcat((char*)outMsg,"response_time");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
DEBUGLOG(("FormatMsg:: response_time = [%s]\n",csPtr));
			GetField_CString(hIn,"local_tm_time",&csPtr);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
		}
//net_amount
		if (GetField_CString(hIn,"net_amt",&csPtr)) {
DEBUGLOG(("FormatMsg:: net_amt = [%s]\n",csPtr));
                        strcat((char*)outMsg,"net_amount");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//pay_amount
		if (GetField_CString(hIn,"txn_amt",&csPtr)) {
DEBUGLOG(("FormatMsg:: txn_amt = [%s]\n",csPtr));
                        strcat((char*)outMsg,"pay_amount");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//net_ccy
		if (GetField_CString(hIn,"net_ccy",&csPtr)) {
DEBUGLOG(("FormatMsg:: net_ccy = [%s]\n",csPtr));
                        strcat((char*)outMsg,"net_ccy");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

//mac
		if (GetField_CString(hIn,"mac",&csPtr)) {
DEBUGLOG(("FormatMsg:: mac = [%s]\n",csPtr));
                        strcat((char*)outMsg,"signature");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//ACK_URL
		if (GetField_CString(hIn,"ACK_URL",&csPtr)) {
DEBUGLOG(("FormatMsg:: ACK_URL = [%s]\n",csPtr));
                        strcat((char*)outMsg,"ACK_ULR");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }


/* for XPAY */

/*
//process_type
		if (GetField_CString(hIn,"process_type",&csPtr)) {
DEBUGLOG(("FormatMsg:: process_type = [%s]\n",csPtr));
                        strcat((char*)outMsg,"process_type");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//process_code
		if (GetField_CString(hIn,"process_code",&csPtr)) {
DEBUGLOG(("FormatMsg:: process_code = [%s]\n",csPtr));
                        strcat((char*)outMsg,"process_code");

                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//show_paypage
		if (GetField_Char(hIn,"show_paypage",&cPtr)) {
DEBUGLOG(("FormatMsg:: show_paypage = [%c]\n",cPtr));
                        strcat((char*)outMsg,"show_paypage");
			sprintf(csPtr,"%c",cPtr);
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//success_url
		if (GetField_CString(hIn,"success_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: success_url = [%s]\n",csPtr));
                        strcat((char*)outMsg,"success_url");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//success_callback_url
		if (GetField_CString(hIn,"success_callback_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: success_callback_url = [%s]\n",csPtr));
                        strcat((char*)outMsg,"success_callback_url");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//failure_url
		if (GetField_CString(hIn,"failure_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: failure_url = [%s]\n",csPtr));
                        strcat((char*)outMsg,"failure_url");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
//failure_callback_url
		if (GetField_CString(hIn,"failure_callback_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: failure_callback_url = [%s]\n",csPtr));
                        strcat((char*)outMsg,"failure_callback_url");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
*/


	}

DEBUGLOG(("FormatMsg:: exit soon\n"));
	csBuf = (char*) malloc (PD_MAX_BUFFER +1);
	base64_encode(outMsg,strlen((char*)outMsg),csBuf,PD_MAX_BUFFER);
	outMsg[0] = '\0';
 	strcat((char*)outMsg,"redirect_url");
       	strcat((char*)outMsg,"=");
       	strcat((char*)outMsg,csBuf);
	strcat((char*)outMsg,MY_WEB_TOKEN);
 	strcat((char*)outMsg,"lang");
       	strcat((char*)outMsg,"=");
       	strcat((char*)outMsg,csLang);
	FREE_ME(csBuf);

	*outLen = strlen((const char*)outMsg);


DEBUGLOG(("FormatMsg:: formated = [%s]\n",outMsg));
DEBUGLOG(("FormatMsg() Exit\n"));
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;

	char	*csBuf;
	char	*csValue;

	char	*csTmp;
	char	*csTxnCountry[PD_COUNTRY_LEN+1];

	char	*p;

	csBuf = (char*) malloc (MAX_MSG_SIZE +1);

	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';
DEBUGLOG(("BreakDownMsg()\n"));

	
DEBUGLOG(("BreakDownMsg()=[%s][%d]\n",inMsg,inLen));

	p = strtok(csBuf,MY_WEB_TOKEN);
	if (p != NULL) 
		iRet = ParseField(hOut,p);

	while (((p = strtok(NULL,MY_WEB_TOKEN)) != NULL) && iRet == PD_OK) {
		iRet = ParseField(hOut,p);
	}

	if(!GetField_CString(hOut,"txn_country",&csValue)){
		if(GetField_CString(hOut,"service_code",&csTmp)){
			DBObjPtr = CreateObj(DBPtr,"DBService","FindCountryByService");
			if ((unsigned long)(DBObjPtr)(csTmp,csTxnCountry) == FOUND) {
				PutField_CString(hOut,"txn_country",(char*)csTxnCountry);
DEBUGLOG(("BreakDownMsg():FindCountryByService: txn_country=[%s]\n",csTxnCountry));
			}
		}
	}

	if(GetField_CString(hOut,"card_type",&csTmp)){
		char cCardType = PD_IND_DEBIT;
		sscanf(csTmp,"%c",&cCardType);
		PutField_Char(hOut,"card_type",cCardType);
	}

	iRet = BuildAuthData(hOut);

	if (GetField_CString(hOut,"DATA",&csValue))
		iRet = DeBlockWTBData(hOut,csValue);

	FREE_ME(csBuf);
DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	char	*csPtr = NULL;
DEBUGLOG(("initReplyFromRequest()\n"));
	

	if (GetField_CString(hRequest,"success_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: success_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"success_url",csPtr);
	}

	if (GetField_CString(hRequest,"failure_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: failure_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"failure_url",csPtr);
	}

	if (GetField_CString(hRequest,"success_callback_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: success_callback_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"success_callback_url",csPtr);
	}

	if (GetField_CString(hRequest,"failure_callback_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: failure_callback_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"failure_callback_url",csPtr);
	}

	if (GetField_CString(hRequest,"transmission_datetime",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: transmission_datetime = [%s]\n",csPtr));
		PutField_CString(hResponse,"transmission_datetime",csPtr);
	}
	if (GetField_CString(hRequest,"merchant_id",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: merchant_id = [%s]\n",csPtr));
		PutField_CString(hResponse,"merchant_id",csPtr);
	}
	if (GetField_CString(hRequest,"remark",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: remark = [%s]\n",csPtr));
		PutField_CString(hResponse,"remark",csPtr);
	}
	if (GetField_CString(hRequest,"merchant_ref",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: merchant_ref = [%s]\n",csPtr));
		PutField_CString(hResponse,"merchant_ref",csPtr);
	}

	if (GetField_CString(hRequest,"txn_country",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: txn_country = [%s]\n",csPtr));
		PutField_CString(hResponse,"txn_country",csPtr);
	}
	if (GetField_CString(hRequest,"txn_ccy",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: txn_ccy = [%s]\n",csPtr));
		PutField_CString(hResponse,"txn_ccy",csPtr);
	}
	if (GetField_CString(hRequest,"pay_method",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: pay_method = [%s]\n",csPtr));
		PutField_CString(hResponse,"pay_method",csPtr);
	}
	if (GetField_CString(hRequest,"language",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: language = [%s]\n",csPtr));
		PutField_CString(hResponse,"language",csPtr);
	}
	if (GetField_CString(hRequest,"process_code",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: proces_code = [%s]\n",csPtr));
		PutField_CString(hResponse,"process_code",csPtr);
	}
	if (GetField_CString(hRequest,"encrypt_type",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: encrypt_type = [%s]\n",csPtr));
		PutField_CString(hResponse,"encrypt_type",csPtr);
	}
/*customer_name*/
	if (GetField_CString(hRequest,"customer_name",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: customer_name = [%s]\n",csPtr));
		PutField_CString(hResponse,"customer_name",csPtr);
	}
/*customer_family_name*/
	if (GetField_CString(hRequest,"customer_family_name",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: customer_family_name = [%s]\n",csPtr));
		PutField_CString(hResponse,"customer_family_name",csPtr);
	}
/*customer_tel*/
	if (GetField_CString(hRequest,"customer_tel",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: customer_tel = [%s]\n",csPtr));
		PutField_CString(hResponse,"customer_tel",csPtr);
	}
/*customer_email*/
	if (GetField_CString(hRequest,"customer_email",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: customer_email = [%s]\n",csPtr));
		PutField_CString(hResponse,"customer_email",csPtr);
	}
/*magic_num*/
	if (GetField_CString(hRequest,"magic_num",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: magic_num = [%s]\n",csPtr));
		PutField_CString(hResponse,"magic_num",csPtr);
	}
/*customer_id*/
	if (GetField_CString(hRequest,"customer_id",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: customer_id = [%s]\n",csPtr));
		PutField_CString(hResponse,"customer_id",csPtr);
	}

/*key_id*/
	if (GetField_CString(hRequest,"key_id",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: key_id = [%s]\n",csPtr));
		PutField_CString(hResponse,"key_id",csPtr);
	}

/*vp_txn_gp_id*/
	if (GetField_CString(hRequest,"vp_txn_gp_id",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: vp_txn_gp_id = [%s]\n",csPtr));
		PutField_CString(hResponse,"vp_txn_gp_id",csPtr);

		if (GetField_CString(hRequest, "service_code", &csPtr)) {
DEBUGLOG(("initReplyFromRequest: service_code = [%s]\n",csPtr));
		PutField_CString(hResponse,"service_code",csPtr);
		}
	}



DEBUGLOG(("initReplyFromRequest() Exit\n"));
	return iRet;
}

int ParseField(hash_t *hOut,const char* inMsg)
{
	int	iRet = PD_OK;

	char	*csTag;
	char	*csValue;
	char	*csTmp;
	char	cTmp;
	

	char	*p;
	

	csTmp = (char*) malloc(strlen(inMsg) +1);
	strcpy(csTmp,inMsg);

	p = strstr(csTmp,MY_WEB_FIELD_TOKEN);
	if (strlen(p) > strlen(MY_WEB_FIELD_TOKEN)) {
		csTag = (char*) malloc (PD_TMP_BUF_LEN +1);
		csValue = (char*) malloc (PD_TMP_MSG_BUF_LEN +1);

		strcpy(csValue,p+1);
		memcpy(csTag,inMsg,strlen(inMsg) - strlen(p));
		csTag[strlen(inMsg) - strlen(p)] = '\0';

/* process type */
		if (!strcmp(csTag,"process_type")) {
			strcpy(csTag,"process_type");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* process code */
		else if (!strcmp(csTag,"process_code")) {
			strcpy(csTag,"process_code");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* merchant no */
		else if (!strcmp(csTag,"mer_id"))  {
			strcpy(csTag,"merchant_id");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* merchant ref */
		else if (!strcmp(csTag,"mer_ref")) {
			strcpy(csTag,"merchant_ref");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* merchant transaction date time */
		else if (!strcmp(csTag,"mer_txn_date")) {
			strcpy(csTag,"transmission_datetime");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));

			memcpy(csTmp,csValue,PD_DATE_LEN);
			csTmp[PD_DATE_LEN] = '\0';
			strcpy(csTag,"tm_date");
			PutField_CString(hOut,csTag,csTmp);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csTmp));
			memcpy(csTmp,&csValue[PD_DATE_LEN],PD_TIME_LEN);
			csTmp[PD_TIME_LEN] = '\0';
			strcpy(csTag,"tm_time");
			PutField_CString(hOut,csTag,csTmp);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csTmp));
		}
/* pay method */
		else if (!strcmp(csTag,"pay_method")) {
			strcpy(csTag,"pay_method");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* txn amount */
		else if (!strcmp(csTag,"txn_amt")) {
			strcpy(csTag,"txn_amt");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		} 
/* currency */
		else if (!strcmp(csTag,"ccy")) {
			strcpy(csTag,"txn_ccy");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* country */
		else if (!strcmp(csTag,"country")) {
			strcpy(csTag,"txn_country");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* bank_code */
		else if (!strcmp(csTag,"bank_code")) {
			strcpy(csTag,"internal_bank_code");
			PutField_CString(hOut,csTag,csValue);
			strcpy(csTag,"bank_code");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* bank_name */
		else if (!strcmp(csTag,"bank_name")) {
			strcpy(csTag,"bank_name");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* branch_name */
		else if (!strcmp(csTag,"branch_name")) {
			strcpy(csTag,"branch_name");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* account_id */
		else if (!strcmp(csTag,"account_id")) {
			strcpy(csTag,"account_id");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* account_name */
		else if (!strcmp(csTag,"account_name")) {
			strcpy(csTag,"account_name");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* identity_id */
		else if (!strcmp(csTag,"identity_id")) {
			strcpy(csTag,"identity_id");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* phone_no */
		else if (!strcmp(csTag,"phone_no")) {
			strcpy(csTag,"phone_no");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* province */
		else if (!strcmp(csTag,"province")) {
			strcpy(csTag,"province");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* batch_id */
		else if (!strcmp(csTag,"batch_id")) {
			strcpy(csTag,"batch_id");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}

/* show paypage */
		else if (!strcmp(csTag,"show_paypage")) {
			strcpy(csTag,"show_paypage");
			cTmp = csValue[0];
			PutField_Char(hOut,csTag,cTmp);
DEBUGLOG(("BreakDownMsg:[%s] = [%c]\n",csTag,cTmp));
		}
		
/* language */
		else if (!strcmp(csTag,"lang")) {
			strcpy(csTag,"language");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
	
/* success url */
		else if (!strcmp(csTag,"success_url")) {
			strcpy(csTag,"success_url");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* success s2s url */
		else if (!strcmp(csTag,"success_s2s_url")) {
			strcpy(csTag,"success_callback_url");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
	
/* failure url */
		else if (!strcmp(csTag,"failure_url")) {
			strcpy(csTag,"failure_url");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* failure s2s url */
		else if (!strcmp(csTag,"failure_s2s_url")) {
			strcpy(csTag,"failure_callback_url");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* remark */
		else if (!strcmp(csTag,"remark")) {
			strcpy(csTag,"remark");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* mac */
		else if (!strcmp(csTag,"signature")) {
			strcpy(csTag,"mac");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* total */
		else if (!strcmp(csTag,"total")) {
			strcpy(csTag,"total");
			PutField_Int(hOut,csTag,ctos((const unsigned char*)csValue,strlen(csValue)));
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
		}
/* DATA */
		else if (!strcmp(csTag,"DATA")) {
			strcpy(csTag,"DATA");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
			PutField_CString(hOut,csTag,csValue);
		}
/* encrypt_type */
		else if (!strcmp(csTag,"enctype")) {
			strcpy(csTag,"encrypt_type");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
			PutField_CString(hOut,csTag,csValue);
		}
	
/* ip_addr */
                else if (!strcmp(csTag,"ip_addr")) {
                        strcpy(csTag,"ip_addr");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
                }

/* service_code */
                else if (!strcmp(csTag,"service_code")) {
                        strcpy(csTag,"service_code");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
                }
/* order_num */
/*
                else if (!strcmp(csTag,"order_num")) {
                        strcpy(csTag,"org_txn_seq");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
                }
*/
/* encrypted order_num */
                else if (!strcmp(csTag,PD_SESSION_ID)) {
                        strcpy(csTag,"org_encrypted_txn_seq");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
                }
/* verno */
                else if (!strcmp(csTag,"verno")) {
                        strcpy(csTag,"version_no");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
			int iVer;
			iVer = ctos((const unsigned char*)csValue,strlen(csValue));
                        PutField_Int(hOut,csTag,iVer);
                }
/* txn_id bounce back */
                else if (!strcmp(csTag,"txn_id")) {
                        strcpy(csTag,"org_txn_seq");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* selectd_paymethod */
                else if (!strcmp(csTag,"selected_pay_method")) {
                        strcpy(csTag,"selected_pay_method");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* conv_store */
                else if (!strcmp(csTag,"conv_store")) {
                        strcpy(csTag,"conv_store");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* customer_name */
                else if (!strcmp(csTag,"customer_name")) {
                        strcpy(csTag,"customer_name");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* customer_family_name */
                else if (!strcmp(csTag,"customer_family_name")) {
                        strcpy(csTag,"customer_family_name");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* customer_tel */
                else if (!strcmp(csTag,"tel_phone")) {
                        strcpy(csTag,"customer_tel");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* customer_email */
                else if (!strcmp(csTag,"customer_email")) {
                        strcpy(csTag,"customer_email");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* customer tag */
                else if (!strcmp(csTag,"cust_tag")) {
                        strcpy(csTag,"customer_tag");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* echo_msg1 */
                else if (!strcmp(csTag,"echo_msg1")) {
                        strcpy(csTag,"echo_msg1");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* echo_msg_2 */
                else if (!strcmp(csTag,"echo_msg2")) {
                        strcpy(csTag,"echo_msg2");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* echo_msg_3 */
                else if (!strcmp(csTag,"echo_msg3")) {
                        strcpy(csTag,"echo_msg3");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* opt_1 */
                else if (!strcmp(csTag,"opt_1")) {
                        strcpy(csTag,"opt_1");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* opt_2 */
                else if (!strcmp(csTag,"opt_2")) {
                        strcpy(csTag,"opt_2");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* opt_3 */
                else if (!strcmp(csTag,"opt_3")) {
                        strcpy(csTag,"opt_3");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* selected_pid */
                else if (!strcmp(csTag,"selected_pid")) {
                        strcpy(csTag,"selected_pid");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* user agent */
                else if (!strcmp(csTag,"uagent")) {
			char csDst[PD_TMP_BUF_LEN+1];
			int iLen = 0;
			urldecode((const unsigned char*)csValue, strlen(csValue),(unsigned char *)csDst, &iLen);
                        strcpy(csTag,"user_agent");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csDst));
                        PutField_CString(hOut,csTag,(const char*)csDst);
		}
/* magic_num */
                else if (!strcmp(csTag,"van")) {
                        strcpy(csTag,"magic_num");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* magic_word */
                else if (!strcmp(csTag,"vap")) {
                        strcpy(csTag,"magic_word");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* customer_id */
                else if (!strcmp(csTag,"user_id")) {
                        strcpy(csTag,"customer_id");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* key_id */
                else if (!strcmp(csTag,"key_id")) {
                        strcpy(csTag,"key_id");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
/* vp_txn_gp_id */
                else if (!strcmp(csTag,"vp_txn_gp_id")) {
                        strcpy(csTag,"vp_txn_gp_id");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
	
/* card_type */
                else if (!strcmp(csTag,"card_type")) {
                        strcpy(csTag,"card_type");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
		}
	
	
		FREE_ME(csTag);
		FREE_ME(csValue);
	}

	FREE_ME(csTmp);

//DEBUGLOG(("BreakDownMsg = [%d]\n",iRet));;
	return iRet;
}


int FormatFEMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
        int     iRet = PD_OK;
        int     iTmp = 0;
        char    *csPtr;
        char    *csBuf;
        char    cStatus;
        char    cPtr;
	char    csTmp[PD_TMP_BUF_LEN + 1];
	double	dTmp = 0.0;
DEBUGLOG(("FormatFEMsg()\n"));

        csBuf = (char*) malloc (1024 *2 +1);
        memset(csBuf,0,sizeof(csBuf));
        outMsg[0] = '\0';
        if (GetField_Char(hIn,"status",&cStatus)) {
DEBUGLOG(("FormatFEMsg:: status = [%c]\n",cStatus));
        }
        else {
DEBUGLOG(("FormatFEMsg:: status not found\n"));
        }
        if (cStatus == PD_TO_PSP) {
                if (GetField_CString(hIn,"failure_url",&csPtr)) {
                        strcat((char*)outMsg,csPtr);
                }
                //strcat((char*)outMsg,"?");
                //sprintf(csBuf,"error_code%s%d%s",MY_WEB_FIELD_TOKEN,INT_ACK_NOT_YET_RETURN,MY_WEB_TOKEN);
                //strcat((char*)outMsg,csBuf);

                if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
                	strcat((char*)outMsg,"?");
                        strcat((char*)outMsg,"MERORDERID");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);

DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
                	if (GetField_CString(hIn,"merchant_id",&csPtr)) {
                       		strcat((char*)outMsg,"MERID");
                        	strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        	strcat((char*)outMsg,csPtr);
                        	strcat((char*)outMsg,MY_WEB_TOKEN);
                	}
                }
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
                base64_encode(outMsg,strlen((char*)outMsg),csBuf,PD_MAX_BUFFER);
                outMsg[0] = '\0';
                sprintf((char*)outMsg,"status=%c&",cStatus);
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
                *outLen = strlen((const char*)outMsg);
DEBUGLOG(("FormatFEMsg:: ACK not yet return\n"));
                FREE_ME(csBuf);
                return iRet;
        }

        else {
                if (GetField_Char(hIn,"ar_ind",&cPtr)) {
			char *csTmpUrl = strdup("");
                        if (cPtr == PD_ACCEPT) {
                                if (GetField_CString(hIn,"success_url",&csPtr)) {
                                        strcat((char*)outMsg,csPtr);
					csTmpUrl = strdup(csPtr);
                                }

                        }
                        else {
                                if (GetField_CString(hIn,"failure_url",&csPtr)) {
                                        strcat((char*)outMsg,csPtr);
					csTmpUrl = strdup(csPtr);
                                }
                        }

DEBUGLOG(("FormatFEMsg:: TmpUrl = [%s]\n",csTmpUrl));
			if(!strrchr(csTmpUrl,'?')){
				strcat((char*)outMsg,"?");
			}
			else{
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			
			FREE_ME(csTmpUrl);

			if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
DEBUGLOG(("FormatFEMsg:: merchant_ref = [%s]\n",csPtr));
				strcat((char*)outMsg,"mref");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}
			if (GetField_Double(hIn,"txn_amt",&dTmp)) {
DEBUGLOG(("FormatFEMsg:: txn_amt = [%lf]\n",dTmp));
				sprintf((char*)csTmp,"%lf",dTmp);
				strcat((char*)outMsg,"tamt");
				strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
				strcat((char*)outMsg,csTmp);
				strcat((char*)outMsg,MY_WEB_TOKEN);
			}

DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
DEBUGLOG(("FormatFEMsg:: response_code = [%d]\n",iTmp));
                }
                base64_encode(outMsg,strlen((char*)outMsg),csBuf,PD_MAX_BUFFER);
                outMsg[0] = '\0';
                sprintf((char*)outMsg,"status=%c&",cStatus);
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
		if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
DEBUGLOG(("FormatFEMsg:: merchant_ref = [%s]\n",csPtr));
			strcat((char*)outMsg,MY_WEB_TOKEN);
			strcat((char*)outMsg,"mref");
			strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
		}
		if (GetField_Double(hIn,"txn_amt",&dTmp)) {
DEBUGLOG(("FormatFEMsg:: txn_amt = [%lf]\n",dTmp));
			strcat((char*)outMsg,MY_WEB_TOKEN);
			sprintf((char*)csTmp,"%lf",dTmp);
			strcat((char*)outMsg,"tamt");
			strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
		}
		if (GetField_CString(hIn,"txnid",&csPtr)) {
DEBUGLOG(("FormatFEMsg:: txnid = [%s]\n",csPtr));
			strcat((char*)outMsg,MY_WEB_TOKEN);
			strcat((char*)outMsg,"txnid");
			strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
		}
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));


                *outLen = strlen((const char*)outMsg);

                FREE_ME(csBuf);

                return iRet;
        }
}


/*
int FormatXPAYFEMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{               
        int     iRet = PD_OK;
        int     iTmp;
        char    *csPtr;
        char    *csBuf;
        char    cStatus;
        char    cPtr;
DEBUGLOG(("FormatXPAYFEMsg()\n"));

        csBuf = (char*) malloc (1024 *2 +1);
        memset(csBuf,0,sizeof(csBuf));
        outMsg[0] = '\0'; 
        if (GetField_Char(hIn,"status",&cStatus)) {
DEBUGLOG(("FormatXPAYFEMsg:: status = [%c]\n",cStatus));
        }
        else {
DEBUGLOG(("FormatXPAYFEMsg:: status not found\n"));
        }
        if (cStatus == PD_TO_PSP) {
                if (GetField_CString(hIn,"failure_url",&csPtr)) {
                        strcat((char*)outMsg,csPtr);
                }       
                strcat((char*)outMsg,"?");
                sprintf(csBuf,"error_code%s%d%s",MY_WEB_FIELD_TOKEN,INT_ACK_NOT_YET_RETURN,MY_WEB_TOKEN);
                strcat(outMsg,csBuf);

                if (GetField_CString(hIn,"merchant_ref",&csPtr)) { 
                        strcat((char*)outMsg,"MERORDERID");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }       
                        
DEBUGLOG(("FormatXPAYFEMsg:: outMsg = [%s]\n",outMsg));
                if (GetField_CString(hIn,"merchant_id",&csPtr)) {
                        strcat((char*)outMsg,"MERID");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
DEBUGLOG(("FormatXPAYFEMsg:: outMsg = [%s]\n",outMsg));
                base64_encode(outMsg,strlen(outMsg),csBuf,PD_MAX_BUFFER);
                outMsg[0] = '\0';
                sprintf((char*)outMsg,"status=%c&",cStatus);
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatXPAYFEMsg:: outMsg = [%s]\n",outMsg));
                *outLen = strlen((const char*)outMsg);
DEBUGLOG(("FormatXPAYFEMsg:: ACK not yet return\n"));
                FREE_ME(csBuf);
                return iRet;
        }

	else {
                if (GetField_Char(hIn,"ar_ind",&cPtr)) {
                        if (cPtr == PD_ACCEPT) {
                                if (GetField_CString(hIn,"success_url",&csPtr)) {
                                        strcat((char*)outMsg,csPtr);
                                }
                        }
                        else {
                                if (GetField_CString(hIn,"failure_url",&csPtr)) {
                                        strcat((char*)outMsg,csPtr);
                                }
                        }

                        strcat((char*)outMsg,"?");
DEBUGLOG(("FormatXPAYFEMsg:: outMsg = [%s]\n",outMsg));
DEBUGLOG(("FormatXPAYFEMsg:: response_code = [%d]\n",iTmp));
                }
                if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
                        strcat((char*)outMsg,"MERORDERID");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
DEBUGLOG(("FormatXPAYFEMsg:: outMsg = [%s]\n",outMsg));
                if (GetField_CString(hIn,"merchant_id",&csPtr)) {
                        strcat((char*)outMsg,"MERID");
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
DEBUGLOG(("FormatXPAYFEMsg:: outMsg = [%s]\n",outMsg));
                base64_encode(outMsg,strlen(outMsg),csBuf,PD_MAX_BUFFER);
                outMsg[0] = '\0';
                sprintf((char*)outMsg,"status=%c&",cStatus);
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatXPAYFEMsg:: outMsg = [%s]\n",outMsg));


                *outLen = strlen((const char*)outMsg);

                FREE_ME(csBuf);

                return iRet;
        }
}
*/



int DeBlockWTBData(hash_t *hOut,const char* inMsg)
{
	int 	iRet = PD_OK;
	int 	iLen;
	int 	iTotal,i;
	char* 	csDATA;
	char*	p;
	char    csTag[25 +1];

	//unsigned char buf[PD_MAX_BUFFER + 1]={0};
        //unsigned long bufLen=sizeof(buf);


	GetField_Int(hOut,"total",&iTotal);
DEBUGLOG(("DeBlockWTBDATA:: total = [%d]\n",iTotal));

	csDATA = (char*) malloc (MAX_MSG_SIZE +1);
	iLen = base64_decode((char*)inMsg,(unsigned char*)csDATA,MAX_MSG_SIZE);

	if (iLen > 0 ) {
DEBUGLOG(("DeBlockWTBDATA:: data = [%s]\n",csDATA));
	}
	else 
		iRet = INT_ERR;

	if (iRet == PD_OK) {
		for (i = 0; i < iTotal; i++ ) {
/* merchant_id */
			sprintf(csTag,"mid_%d",i);
			p = GetField((const unsigned char*)csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"merchant_id_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
        		}
/* merchant_ref */
			sprintf(csTag,"ref_%d",i);
			p = GetField((const unsigned char*)csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"merchant_ref_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* transmission_datetime */
			sprintf(csTag,"td_%d",i);
			p = GetField((const unsigned char*)csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"transmission_datetime_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* txn_amount */
			sprintf(csTag,"pm_%d",i);
			p = GetField((const unsigned char*)csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"txn_amt_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* txn_ccy */
			sprintf(csTag,"cc_%d",i);
			p = GetField((const unsigned char*)csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"txn_ccy_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* txn_country */
			sprintf(csTag,"ct_%d",i);
			p = GetField((const unsigned char*)csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"txn_country_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* bank_code */
			sprintf(csTag,"bc_%d",i);
			p = GetField((const unsigned char*)csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"bank_code_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* branch_name */
			sprintf(csTag,"bn_%d",i);
			p = GetField((const unsigned char*)csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"branch_name_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* account_id */
			sprintf(csTag,"ai_%d",i);
			p = GetField((const unsigned char*)csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"account_id_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* account_name */
			sprintf(csTag,"an_%d",i);
			p = GetField((const unsigned char*)csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"account_name_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* identity_id */
			sprintf(csTag,"id_%d",i);
			p = GetField((const unsigned char*)csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"identity_id_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* batch_id */
			sprintf(csTag,"bi_%d",i);
			p = GetField((const unsigned char*)csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"batch_id_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
/* mac */
			sprintf(csTag,"mac_%d",i);
			p = GetField((const unsigned char*)csDATA, csTag,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        		if(p) {
				sprintf(csTag,"mac_%d",i);
                		PutField_CString(hOut,csTag,p);
DEBUGLOG(("DeBlockWTBData %s = [%s]\n",csTag,p));
			}
		}
	}

DEBUGLOG(("DeBlockWTBData Exit = [%d]\n",iRet));
	return iRet;
}

int FormatBatchMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{               
        int     iRet = PD_OK;
        int     iTotal = 0,i;

        char*   csPtr = NULL;
        char    csTag[PD_TAG_LEN +  1];
DEBUGLOG(("FormatBatchMsg()\n"));


        outMsg[0]= '\0';
        *outLen = 0;


        if (GetField_Int(hIn,"total",&iTotal)) {
DEBUGLOG(("FormatBatchMsg:: total = [%d]\n",iTotal));
                sprintf(csTag,"%d",iTotal);
                strcpy((char*)outMsg,"total");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csTag);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }

/* response code */
        if (GetField_CString(hIn,"response_code",&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: response_code = [%s]\n",csPtr));
                strcat((char*)outMsg,"response_code");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);

        }

        for (i =0;  i <  iTotal; i++) {
/* txn_seq */
                sprintf(csTag,"txn_seq_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
                        sprintf(csTag,"txn_id_%d",i);
                        strcat((char*)outMsg,csTag);
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
/* merchant_id */
                sprintf(csTag,"merchant_id_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
                        strcat((char*)outMsg,csTag);
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

/* merchant_ref */
                sprintf(csTag,"merchant_ref_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
                        strcat((char*)outMsg,csTag);
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }
/* batch_id */
                sprintf(csTag,"batch_id_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
                        strcat((char*)outMsg,csTag);
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

/* response_code */
                sprintf(csTag,"response_code_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
                        strcat((char*)outMsg,csTag);
                        strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_WEB_TOKEN);
                }

        }
        *outLen = strlen((char*)outMsg);
DEBUGLOG(("FormatBatchMsg:: formated = [%s]\n",outMsg));
DEBUGLOG(("FormatBatchMsg() Exit\n"));
        return  iRet;
}

int DeBlockWebBounceBackData(hash_t *hOut,const char* inMsg, const int inLen)
{
	int 	iRet = PD_OK;
	int 	iLen;
	char* 	csDATA;
	char*   csValue;
	char*	csBuf;
	char*	p;

//	unsigned char buf[PD_MAX_BUFFER + 1]={0};

	csBuf = (char*) malloc (2048 +1);
	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';

DEBUGLOG(("DeBlockBounceBackDATA () [%s]len=[%d]\n",csBuf,inLen));
	p = strtok(csBuf,MY_WEB_TOKEN);
        if (p != NULL) {
                iRet = ParseField(hOut,p);
	}
        while (((p = strtok(NULL,MY_WEB_TOKEN)) != NULL) && iRet == PD_OK) {
                iRet = ParseField(hOut,p);
        }

	
        if (GetField_CString(hOut,"DATA",&csValue)) {
		csDATA = (char*) malloc (MAX_MSG_SIZE +1);
		iLen = base64_decode((char*)csValue,(unsigned char*)csDATA,MAX_MSG_SIZE);

		if (iLen > 0 ) {
DEBUGLOG(("DeBlockBounceBackDATA:: data = [%s]\n",csDATA));
			p = strtok(csDATA,MY_WEB_BOUNCE_FIELD_TOKEN);
                	if (p) {
				PutField_CString(hOut,"org_txn_seq",p);
DEBUGLOG(("DEBlockData txn_seq = [%s]\n",p));
                	}

		}
		else 
			iRet = INT_ERR;
	}

DEBUGLOG(("DeBlockBounceBackData Exit = [%d]\n",iRet));
	return iRet;
}


int BreakDownRespMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
        int     iRet = PD_OK;
        char    *csBuf;
        char    *p;

        /*csBuf = (char*) malloc (1024 +1);*/
        csBuf = (char*) malloc (PD_TMP_MSG_BUF_LEN*2 +1);

        memcpy(csBuf,inMsg,inLen);
        csBuf[inLen] = '\0';
DEBUGLOG(("BreakDownRespMsg()\n"));
DEBUGLOG(("DATA = [%*s]\n",inLen,inMsg));

/* order_num */
        p = GetField((const unsigned char*)csBuf,"order_num",MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        if (p) {
                PutField_CString(hOut,"txn_seq",p);
DEBUGLOG(("BreakDownRespMsg:: txn_seq[order_num] = [%s]\n",p));
        }
/* encrypted_order_num */
        p = GetField((const unsigned char*)csBuf,PD_SESSION_ID,MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        if (p) {
                PutField_CString(hOut,"encrypted_txn_seq",p);
DEBUGLOG(("BreakDownRespMsg:: txn_seq[encrypted_order_num] = [%s]\n",p));
        }
/* status */
        p = GetField((const unsigned char*)csBuf,"status",MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        if (p) {
                PutField_CString(hOut,"status",p);
DEBUGLOG(("BreakDownRespMsg:: status = [%s]\n",p));
        }

/* FERESP */
        p = GetField((const unsigned char*)csBuf,"FERESP",MY_WEB_TOKEN,MY_WEB_FIELD_TOKEN);
        if (p) {
                PutField_Char(hOut,"FERESP",p[0]);
DEBUGLOG(("BreakDownRespMsg:: FERESP = [%c]\n",p[0]));
        }

        FREE_ME(csBuf);
DEBUGLOG(("BreakDownRespMsg Exit\n"));
        return  iRet;

}

int BuildAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char    *csVal;
        char    *csData;

        csData = (char*) malloc (PD_TMP_BUF_LEN +1);
	csData[0] = '\0';

        if (GetField_CString(hIn,"txn_amt",&csVal)) {
DEBUGLOG(("BuildAuthData txn_amt = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"txn_ccy",&csVal)) {
DEBUGLOG(("BuildAuthData txn_ccy = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"merchant_ref",&csVal)) {
DEBUGLOG(("BuildAuthData merchant_ref = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"merchant_id",&csVal)) {
DEBUGLOG(("BuildAuthData merchant_id = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"transmission_datetime",&csVal)) {
DEBUGLOG(("BuildAuthData transmission_datetime = [%s]\n",csVal));
                strcat(csData,csVal);
        }

/* key_id */
	if (GetField_CString(hIn,"key_id",&csVal)) {
DEBUGLOG(("BuildAuthData key_id = [%s]\n",csVal));
		strcat(csData,csVal);

/* service_code or customer_id */
		if (GetField_CString(hIn, "service_code", &csVal)) {
DEBUGLOG(("BuildAuthData service_code = [%s]\n",csVal));
			strcat(csData,csVal);
		} else {
			if (GetField_CString(hIn,"customer_id",&csVal)) {
DEBUGLOG(("BuildAuthData customer_id = [%s]\n",csVal));
				strcat(csData,csVal);
			}
        	}
	}

DEBUGLOG(("BuildAuthData = [%s]\n",csData));
        PutField_CString(hIn,"auth_data",csData);

	FREE_ME(csData);
        return iRet;
}

int BuildRespAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char    *csVal;
        char    *csData;

        csData = (char*) malloc (PD_TMP_BUF_LEN * 4+1);
	csData[0] = '\0';

        if (GetField_CString(hIn,"response_code",&csVal)) {
DEBUGLOG(("BuildRespAuthData response_code = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"redirect_url",&csVal)) {
DEBUGLOG(("BuildRespAuthData redirect_url = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"merchant_ref",&csVal)) {
DEBUGLOG(("BuildRespAuthData merchant_ref = [%s]\n",csVal));
                strcat(csData,csVal);
        }
/* key_id */
	 if (GetField_CString(hIn,"key_id",&csVal)) {
DEBUGLOG(("BuildRespAuthData key_id = [%s]\n",csVal));
		strcat(csData,csVal);
	}

/* customer_id */
        if (GetField_CString(hIn, "service_code", &csVal)) {
DEBUGLOG(("BuildRespAuthData service_code = [%s]\n",csVal));
                        strcat(csData,csVal);
        } else {
	        if (GetField_CString(hIn,"customer_id",&csVal)) {
DEBUGLOG(("BuildRespAuthData customer_id = [%s]\n",csVal));
			strcat(csData,csVal);
		}
        }

        if (GetField_CString(hIn,"merchant_id",&csVal)) {
DEBUGLOG(("BuildRespAuthData merchant_id = [%s]\n",csVal));
                strcat(csData,csVal);
        }
DEBUGLOG(("BuildRespAuthData = [%s]\n",csData));
        PutField_CString(hIn,"auth_data",csData);

DEBUGLOG(("BuildRespAuthData iRet = [%d]\n",iRet));
	FREE_ME(csData);
        return iRet;
}


int FormatAckMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{                               
        int     iRet = PD_OK;
        char*   csBuf;  
        char*   csPtr;  
        char    cStatus;
	char   	csTmp[PD_TMP_BUF_LEN + 1];
	double	dTmp;
	char*	csTxnSeq;
	char	csTxnSeqVal[PD_TXN_SEQ_LEN * 2 +1];
        
DEBUGLOG(("FormatAckMsg()\n"));
        outMsg[0]= '\0'; 
        *outLen = 0;
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );
                        
                                
        memset(csBuf,0,sizeof(csBuf));
        strcat((char*)csBuf,"url");
        strcat((char*)csBuf,MY_WEB_FIELD_TOKEN);

	if (GetField_CString(hIn,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("FormatAckMsg txn_seq = [%s]\n",csTxnSeq));
                sprintf(csTxnSeqVal,"txn_id=%s",csTxnSeq);
        }
        else {
DEBUGLOG(("FormatAckMsg txn_seq is missing!!!\n"));
                sprintf(csTxnSeqVal,"txn_id=");
        }
                        
        if (GetField_Char(hIn,"ar_ind",&cStatus)) {
DEBUGLOG(("FormatAckMsg txn_status = [%c]\n",cStatus));
        }       
        if (cStatus == PD_ACCEPT) {
                if (GetField_CString(hIn,"success_callback_url",&csPtr)) {
                        strcat((char*)csBuf,csPtr);
DEBUGLOG(("FormatAckMsg success_callback_url = [%s]\n",csPtr));
                }
        
        }
        else {  
                if (GetField_CString(hIn,"failure_callback_url",&csPtr)) {
                        strcat((char*)csBuf,csPtr);
DEBUGLOG(("FormatAckMsg failure_callback_url = [%s]\n",csPtr));
                }               
        }                       
        strcat((char*)csBuf,MY_WEB_TOKEN);
	strcat((char*)csBuf,csTxnSeqVal);
        strcat((char*)csBuf,MY_WEB_TOKEN);

        sprintf((char*)outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
        strcat((char*)outMsg,csBuf);

/*process_type*/
        if (GetField_CString(hIn,"process_type",&csPtr)){
DEBUGLOG(("FormatAckMsg:: process_type = [%s]\n",csPtr));
                strcat((char*)outMsg,"process_type");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: process_type is missing!!!\n"));
	}

/*process_code*/
        if (GetField_CString(hIn,"process_code",&csPtr)){
DEBUGLOG(("FormatAckMsg:: process_code = [%s]\n",csPtr));
                strcat((char*)outMsg,"process_code");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: process_type is missing!!!\n"));
	}

/* status */
        if (GetField_CString(hIn,"response_code",&csPtr)){
DEBUGLOG(("FormatAckMsg:: response code  = [%s]\n",csPtr));
        	strcat((char*)outMsg,"status");
        	strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
        	strcat((char*)outMsg,csPtr);
        	strcat((char*)outMsg,MY_WEB_TOKEN);
	}
	else {
DEBUGLOG(("FormatAckMsg:: response code is missing!!!\n"));
	}

/*txn_seq*/
        if (GetField_CString(hIn,"txn_seq",&csPtr)){
DEBUGLOG(("FormatAckMsg:: txn_seq = [%s]\n",csPtr));
                strcat((char*)outMsg,"txn_id");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: txn_seq is missing!!!\n"));
	}

/*txn_date*/
        if (GetField_CString(hIn,"local_transmission_datetime",&csPtr)){
DEBUGLOG(("FormatAckMsg:: txn_date = [%s]\n",csPtr));
                strcat((char*)outMsg,"txn_date");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: txn_date is missing!!!\n"));
	}

/*net_ccy*/
        if (GetField_CString(hIn,"net_ccy",&csPtr)){
DEBUGLOG(("FormatAckMsg:: net_ccy = [%s]\n",csPtr));
                strcat((char*)outMsg,"paid_ccy");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: net_ccy is missing!!!\n"));
	}

/* net_amt */
        if (GetField_Double(hIn,"net_amt",&dTmp)) {
DEBUGLOG(("FormatAckMsg:: NET AMOUNT = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatAckMsg:: AMOUNT = [%s]\n",csTmp));
                strcat((char*)outMsg,"paid_amt");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csTmp);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }

/* service_fee */
        if (GetField_Double(hIn,"service_fee",&dTmp)) {
DEBUGLOG(("FormatAckMsg:: service_fee AMOUNT = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatAckMsg:: service_fee = [%s]\n",csTmp));
                strcat((char*)outMsg,"service_fee");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csTmp);
                strcat((char*)outMsg,MY_WEB_TOKEN);

		if (GetField_CString(hIn,"service_fee_ccy",&csPtr)) {
DEBUGLOG(("FormatAckMsg:: service_fee_ccy = [%s]\n",csPtr));
                	strcat((char*)outMsg,"service_fee_ccy");
                	strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                	strcat((char*)outMsg,csPtr);
                	strcat((char*)outMsg,MY_WEB_TOKEN);
		}
		else {
DEBUGLOG(("FormatAckMsg:: service_fee_ccy is missing!!!\n"));
		}
        }

/* txn_amt */
        if (GetField_Double(hIn,"txn_amt",&dTmp)) {
DEBUGLOG(("FormatAckMsg:: txn amt = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatAckMsg:: txn amt = [%s]\n",csTmp));
                strcat((char*)outMsg,"txn_amt");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csTmp);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: txn_amt is missing!!!\n"));
	}

/* txn_ccy */
        if (GetField_CString(hIn,"txn_ccy",&csPtr)){
DEBUGLOG(("FormatAckMsg:: txn_ccy = [%s]\n",csPtr));
                //strcat((char*)outMsg,"txn_ccy");
                strcat((char*)outMsg,"ccy");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: txn_ccy is missing!!!\n"));
	}



/*merchant_ref*/
        if (GetField_CString(hIn,"merchant_ref",&csPtr)){
DEBUGLOG(("FormatAckMsg:: mer_ref = [%s]\n",csPtr));
                strcat((char*)outMsg,"mer_ref");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: merchant_ref is missing!!!\n"));
	}

/*mer_txn_date*/
        if (GetField_CString(hIn,"transmission_datetime",&csPtr)){
DEBUGLOG(("FormatAckMsg:: mer_txn_date = [%s]\n",csPtr));
                strcat((char*)outMsg,"mer_txn_date");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: mer_txn_date is missing!!!\n"));
	}


/*merchant_id*/
        if (GetField_CString(hIn,"merchant_id",&csPtr)){
DEBUGLOG(("FormatAckMsg:: mer_id = [%s]\n",csPtr));
                strcat((char*)outMsg,"mer_id");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: merchant_id is missing!!!\n"));
	}
/*magic_num*/
        if (GetField_CString(hIn,"magic_num",&csPtr)){
DEBUGLOG(("FormatAckMsg:: mer_id = [%s]\n",csPtr));
                strcat((char*)outMsg,"van");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: magic_num is missing!!!\n"));
	}
/*customer_id*/
        if (GetField_CString(hIn,"customer_id",&csPtr)){
DEBUGLOG(("FormatAckMsg:: customer_id = [%s]\n",csPtr));
                strcat((char*)outMsg,"user_id");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: customer_id is missing!!!\n"));
	}

/* service_code -- for vp network msg, any influence to other txn? */
	if (GetField_CString(hIn,"service_code",&csPtr)){
DEBUGLOG(("FormatAckMsg:: service_code = [%s]\n",csPtr));
		strcat((char*)outMsg,"service_code");
		strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_WEB_TOKEN);
	} else {
DEBUGLOG(("FormatAckMsg:: service_code is missing!!!\n"));
	}

/*encrypt_type*/
        if (GetField_CString(hIn,"encrypt_type",&csPtr)){
DEBUGLOG(("FormatAckMsg:: enctype = [%s]\n",csPtr));
                strcat((char*)outMsg,"enctype");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: enctype is missing!!!\n"));
	}

/*sign*/
        if (GetField_CString(hIn,"mac",&csPtr)){
DEBUGLOG(("FormatAckMsg:: SIGN = [%s]\n",csPtr));
                strcat((char*)outMsg,"signature");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: sign is missing!!!\n"));
	}
/* remark */
        if (GetField_CString(hIn,"remark",&csPtr)){
DEBUGLOG(("FormatAckMsg:: remark = [%s]\n",csPtr));
                strcat((char*)outMsg,"remark");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: remark is missing!!!\n"));
	}

/* echo_msg_1 */
        if (GetField_CString(hIn,"echo_msg_1",&csPtr)){
DEBUGLOG(("FormatAckMsg:: echo_msg_1 = [%s]\n",csPtr));
                strcat((char*)outMsg,"echo_msg1");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: echo_msg_1 is missing!!!\n"));
	}

/* echo_msg_2 */
        if (GetField_CString(hIn,"echo_msg_2",&csPtr)){
DEBUGLOG(("FormatAckMsg:: echo_msg_2 = [%s]\n",csPtr));
                strcat((char*)outMsg,"echo_msg2");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: echo_msg_2 is missing!!!\n"));
	}

/* echo_msg_3 */
        if (GetField_CString(hIn,"echo_msg_3",&csPtr)){
DEBUGLOG(("FormatAckMsg:: echo_msg_3 = [%s]\n",csPtr));
                strcat((char*)outMsg,"echo_msg3");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: echo_msg_3 is missing!!!\n"));
	}

/* conv_store */
        if (GetField_CString(hIn,"conv_store",&csPtr)){
DEBUGLOG(("FormatAckMsg:: conv_store = [%s]\n",csPtr));
                strcat((char*)outMsg,"convenience_store");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: conv_store is missing!!!\n"));
	}

/* bank_code */
        if (GetField_CString(hIn,"bank_code",&csPtr)){
DEBUGLOG(("FormatAckMsg:: bank_code = [%s]\n",csPtr));
                strcat((char*)outMsg,"bank_code");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: bank_code is missing!!!\n"));
	}

/* selected_pay_method */
        if (GetField_CString(hIn,"selected_pay_method",&csPtr)){
DEBUGLOG(("FormatAckMsg:: pay_method = [%s]\n",csPtr));
                strcat((char*)outMsg,"pay_method");
                strcat((char*)outMsg,MY_WEB_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_WEB_TOKEN);
        }
	else {
DEBUGLOG(("FormatAckMsg:: selected_pay_method is missing!!!\n"));
	}

        *outLen = strlen((const char*)outMsg);


        FREE_ME(csBuf);
DEBUGLOG(("FormatAckMsg:: outMsg = [%s]\n",outMsg));
DEBUGLOG(("FormatAckMsg() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

int BuildAckAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char    *csVal;
        char    *csData;
	double	dTmp;
	

        csData = (char*) malloc (PD_TMP_BUF_LEN +1);
        csData[0] = '\0';

        if (GetField_CString(hIn,"response_code",&csVal)) {
DEBUGLOG(("BuildAckAuthData response_code = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"txn_seq",&csVal)) {
DEBUGLOG(("BuildAckAuthData txn_seq = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"local_transmission_datetime",&csVal)) {
DEBUGLOG(("BuildAckAuthData local_transmission_datetime = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"net_ccy",&csVal)) {
DEBUGLOG(("BuildAckAuthData net_ccy = [%s]\n",csVal));
                strcat(csData,csVal);
        }
	/* net_amt */
        if (GetField_Double(hIn,"net_amt",&dTmp)) {
		char*	csTmp;
		csTmp = (char*) malloc (PD_TMP_BUF_LEN + 1);	

DEBUGLOG(("BuildAckAuthData NET AMOUNT = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("BuildAckAuthData net_amt = [%s]\n",csTmp));
                strcat(csData,csTmp);
		FREE_ME(csTmp);
        }
	if (GetField_CString(hIn,"customer_id",&csVal)) {
DEBUGLOG(("BuildAckAuthData customer_id = [%s]\n",csVal));
		strcat(csData,csVal);
	}
        if (GetField_CString(hIn,"merchant_ref",&csVal)) {
DEBUGLOG(("BuildAckAuthData merchant_ref = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"merchant_id",&csVal)) {
DEBUGLOG(("BuildAckAuthData merchant_id = [%s]\n",csVal));
                strcat(csData,csVal);
        }

	/* service_code -- for vp network msg, any influence to other txn? */
	if (GetField_CString(hIn,"service_code",&csVal)) {
DEBUGLOG(("BuildAckAuthData service_code = [%s]\n",csVal));
		strcat(csData,csVal);
	}

DEBUGLOG(("BuildRespAuthData = [%s]\n",csData));
        PutField_CString(hIn,"auth_data",csData);

        FREE_ME(csData);
DEBUGLOG(("BuildRespAuthData exit = [%d]\n",iRet));
        return iRet;
}

int BuildNetworkRespAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char    *csVal;
        char    *csData;

        csData = (char*) malloc (PD_TMP_BUF_LEN * 4+1);
	csData[0] = '\0';

/* key_id */
	 if (GetField_CString(hIn,"key_id",&csVal)) {
DEBUGLOG(("BuildNetworkRespAuthData key_id = [%s]\n",csVal));
		strcat(csData,csVal);
	}

/* customer_id */
        if (GetField_CString(hIn, "service_code", &csVal)) {
DEBUGLOG(("BuildNetworkRespAuthData service_code = [%s]\n",csVal));
                        strcat(csData,csVal);
        } else {
	        if (GetField_CString(hIn,"customer_id",&csVal)) {
DEBUGLOG(("BuildNetworkRespAuthData customer_id = [%s]\n",csVal));
			strcat(csData,csVal);
		}
        }

DEBUGLOG(("BuildNetworkRespAuthData = [%s]\n",csData));
        PutField_CString(hIn,"auth_data",csData);

DEBUGLOG(("BuildNetworkRespAuthData iRet = [%d]\n",iRet));
	FREE_ME(csData);
        return iRet;
}



