
/*
 * Partnerdelight (c)2014. All rights reserved. No part of this software may be reproduced in any form without written permission
 * of an authorized representative of Partnerdelight.
 *
 * Change Description                                 Change Date             Change By
 * -------------------------------                    ------------            --------------
 *  Init Version                                      2014/08/14              Cody Chan
 *
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "TpyMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"

char	cDebug;

void	TpyMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;

	char*	csPtr = NULL;
	char*	csURL = NULL;
	char* 	csBuf;
	double	dTmp;


	//double	dTmp;
DEBUGLOG(("FormatMsg()\n"));

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

	outMsg[0]= '\0';
//psp_url
	if (GetField_CString(hIn,"psp_url",&csURL)) {
		if (GetField_CString(hIn,"request_function",&csPtr)) {
			strcpy((char*)csBuf,"url");
DEBUGLOG(("FormatMsg:: psp_url = [%s]\n",csURL));
DEBUGLOG(("FormatMsg:: request function  = [%s]\n",csPtr));
			strcat((char*)csBuf,MY_TPY_FIELD_TOKEN);
			strcat((char*)csBuf,csURL);
			strcat((char*)csBuf,"/");
			strcat((char*)csBuf,csPtr);
//			strcat((char*)csBuf,MY_TPY_TOKEN);
DEBUGLOG(("FormatMsg:: psp_url = [%s]\n",csBuf));
		}	
	
		sprintf((char*)outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));
		strcat((char*)outMsg,csBuf);
		//strcat((char*)outMsg,MY_TPY_URL_END_TOKEN);

	}
	FREE_ME(csBuf);
//version
	if (GetField_CString(hIn,"ver",&csPtr)) {
DEBUGLOG(("FormatMsg:: ver = [%s]\n",csPtr));
		strcat((char*)outMsg,"ver");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("FormatMsg:: ver is missing\n"));
	}

//charset
	if (GetField_CString(hIn,"charset",&csPtr)) {
DEBUGLOG(("FormatMsg:: charset = [%s]\n",csPtr));
		strcat((char*)outMsg,"charset");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("FormatMsg:: charset is missing\n"));
	}

//bank_type
	if (GetField_CString(hIn,"bank_type",&csPtr)) {
DEBUGLOG(("FormatMsg:: bank_type = [%s]\n",csPtr));
		strcat((char*)outMsg,"bank_type");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,"0");
		strcat((char*)outMsg,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("FormatMsg:: bank_type is missing\n"));
	}

//desc
	if (GetField_CString(hIn,"txn_desc",&csPtr)) {
DEBUGLOG(("FormatMsg:: txn_desc = [%s]\n",csPtr));
		strcat((char*)outMsg,"desc");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("FormatMsg:: desc is missing\n"));
	}

//bargainor_id
	if (GetField_CString(hIn,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("FormatMsg:: bargainor_id = [%s]\n",csPtr));
		strcat((char*)outMsg,"bargainor_id");

		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TPY_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: bargainor_id not found!!!\n"));
	}

//sp_billno
	if (GetField_CString(hIn,"order_num",&csPtr)) {
DEBUGLOG(("FormatMsg:: sp_billno = [%s]\n",csPtr));
		strcat((char*)outMsg,"sp_billno");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TPY_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: sp_billno is missing\n"));
	}

//total_fee
	if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {
		char    csTmpAmt[PD_TMP_BUF_LEN +1];
//                sprintf(csTmpAmt,"%.2f",dTmp);
		sprintf((char*)csTmpAmt,"%ld",double2long(dTmp));
DEBUGLOG(("FormatMsg:: total_fee = [%s]\n",csTmpAmt));
                strcat((char*)outMsg,"total_fee");
                strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
                strcat((char*)outMsg,csTmpAmt);
                strcat((char*)outMsg,MY_TPY_TOKEN);
	}
	else{
DEBUGLOG(("FormatMsg:: total_fee is missing\n"));
	}

//fee_type
	if (GetField_CString(hIn,"fee_type",&csPtr)) {
DEBUGLOG(("FormatMsg:: fee_type = [%s]\n",csPtr));
		strcat((char*)outMsg,"fee_type");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TPY_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: fee_type is missing\n"));
	}


//notify_url
	if (GetField_CString(hIn,"return_url_only",&csPtr)) {
DEBUGLOG(("FormatMsg:: return_url_only = [%s]\n",csPtr));
		strcat((char*)outMsg,"notify_url");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TPY_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: return_url_only not found!!!\n"));
	}


/* fe_url */
        if (GetField_CString(hIn,"fe_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: fe_url = [%s]\n",csPtr));
		strcat((char*)outMsg,"callback_url");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TPY_TOKEN);
        }
	else {
DEBUGLOG(("FormatMsg:: fe_url not found!!!\n"));
	}

// timestart
/*
        if (GetField_CString(hIn,"local_tm_date",&csPtr)) {
DEBUGLOG(("FormatMsg:: local_tm_date = [%s]\n",csPtr));
		char* 	csPtr2;
		char	csDateTime[PD_DATETIME_LEN * 2];
        	if (GetField_CString(hIn,"local_tm_time",&csPtr2)) {
DEBUGLOG(("FormatMsg:: local_tm_time = [%s]\n",csPtr2));
			sprintf(csDateTime,"%s-%.*s:%.*s:%.*s",csPtr,2,csPtr2,2,&csPtr2[2],2,&csPtr[4]);
DEBUGLOG(("FormatMsg:: trdt = [%s]\n",csDateTime));
			strcat((char*)outMsg,"timestart");
			strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
			strcat((char*)outMsg,csDateTime);
			strcat((char*)outMsg,MY_TPY_TOKEN);
		}
		else {
DEBUGLOG(("FormatMsg:: local_tm_time is missing!!!\n"));
		}
        }
        else {
DEBUGLOG(("FormatMsg:: local_tm_date is missing!!!\n"));
        }
*/

//sign
	if (GetField_CString(hIn,"sign",&csPtr)) {
DEBUGLOG(("FormatMsg:: sign = [%s]\n",csPtr));
		strcat((char*)outMsg,"sign");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
//		strcat((char*)outMsg,MY_TPY_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: sign not found!!!\n"));
	}


DEBUGLOG(("outmsg = [%s]\n",outMsg));

	*outLen = strlen((const char*)outMsg);
DEBUGLOG(("FormatMsg() [%s][%d]\n",outMsg,*outLen));
DEBUGLOG(("FormatMsg() Exit\n"));
	FREE_ME(csPtr);
	FREE_ME(csURL);
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csPtr;
	hash_t  *hRec;

        hRec = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hRec,0);
                
DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));
                                
        if (Str2Cls(hRec,(char*)inMsg,MY_TPY_TOKEN, MY_TPY_FIELD_TOKEN) == PD_OK) {

// notice_status
		if (GetField_CString(hRec,"notice_status",&csPtr)) {
			PutField_CString(hOut,"notice_status",csPtr);
DEBUGLOG(("BreakDownMsg:: notice_status = [%s]\n",csPtr));
		}
// token_id
		if (GetField_CString(hRec,"token_id",&csPtr)) {
			PutField_CString(hOut,"sc",csPtr);
DEBUGLOG(("BreakDownMsg:: token_id = [%s]\n",csPtr));
		}
//ver 
		if (GetField_CString(hRec,"ver",&csPtr)) {
			PutField_CString(hOut,"ver",csPtr);
DEBUGLOG(("BreakDownMsg:: ver = [%s]\n",csPtr));
		}

//charset 
		if (GetField_CString(hRec,"charset",&csPtr)) {
			PutField_CString(hOut,"charset",csPtr);
DEBUGLOG(("BreakDownMsg:: charset = [%s]\n",csPtr));
		}

//charset 
		if (GetField_CString(hRec,"charset",&csPtr)) {
			PutField_CString(hOut,"charset",csPtr);
DEBUGLOG(("BreakDownMsg:: charset = [%s]\n",csPtr));
		}
//pay_result
		if (GetField_CString(hRec,"pay_result",&csPtr)) {
			PutField_CString(hOut,"error_code",csPtr);
DEBUGLOG(("BreakDownMsg:: pay_result = [%s]\n",csPtr));
		}


//transaction_id 
		if (GetField_CString(hRec,"transaction_id",&csPtr)) {
			PutField_CString(hOut,"tid",csPtr);
DEBUGLOG(("BreakDownMsg:: transaction_id = [%s]\n",csPtr));
		}

//sp_billno
		if (GetField_CString(hRec,"sp_billno",&csPtr)) {
			PutField_CString(hOut,"txn_seq",csPtr);
DEBUGLOG(("BreakDownMsg:: sp_billno = [%s]\n",csPtr));
		}
//total_fee
		if (GetField_CString(hRec,"total_fee",&csPtr)) {
			PutField_CString(hOut,"txn_amt",csPtr);
DEBUGLOG(("BreakDownMsg:: total_fee = [%s]\n",csPtr));
		}

//fee_type
		if (GetField_CString(hRec,"fee_type",&csPtr)) {
			PutField_CString(hOut,"fee_type",csPtr);
DEBUGLOG(("BreakDownMsg:: fee_type = [%s]\n",csPtr));
		}

//bargaior_id
		if (GetField_CString(hRec,"bargainor_id",&csPtr)) {
			PutField_CString(hOut,"mid",csPtr);
DEBUGLOG(("BreakDownMsg:: bargainor_id = [%s]\n",csPtr));
		}

//sign
		if (GetField_CString(hRec,"sign",&csPtr)) {
			PutField_CString(hOut,"sign",csPtr);
DEBUGLOG(("BreakDownMsg:: bargainor_id = [%s]\n",csPtr));
		}

	}
	else{
DEBUGLOG(("BreakDownMsg() Error\n"));
                iRet = PD_ERR;
        }

        hash_destroy(hRec);
        FREE_ME(hRec);
DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	char	*csTmp = NULL;
DEBUGLOG(("initReplyFromRequest()\n"));
	

/* order_num */
        if (GetField_CString(hRequest,"merchant_ref",&csTmp)) {
DEBUGLOG(("initReplyFromRequest: order_num = [%s]\n",csTmp));
                PutField_CString(hResponse,"order_num",csTmp);
        }


DEBUGLOG(("initReplyFromRequest() Exit\n"));
	FREE_ME(csTmp);
	return iRet;
}

int BuildAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr,*csDATA;
        char*   csBuf;
        double  dTmp;
        csDATA = (char*) malloc (PD_TMP_MSG_BUF_LEN  +1);
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildAuthData()\n"));
        memset(csDATA,0,sizeof(csDATA));

//bank_type
        if (GetField_CString(hIn,"bank_type",&csPtr)) {
DEBUGLOG(("BuildAuthData:: bank_type = [%s]\n",csPtr));
		strcpy(csDATA,"bank_type");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: bank_type is missing\n"));
	}

//bargainor_id
        if (GetField_CString(hIn,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("BuildAuthData:: bargainor_id = [%s]\n",csPtr));
		strcat(csDATA,"bargainor_id");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: bargainor_id is missing\n"));
	}

//callback_url
        if (GetField_CString(hIn,"fe_url",&csPtr)) {
DEBUGLOG(("BuildAuthData:: callback_url = [%s]\n",csPtr));
		strcat(csDATA,"callback_url");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: callback_url is missing\n"));
	}


//charset
        if (GetField_CString(hIn,"charset",&csPtr)) {
DEBUGLOG(("BuildAuthData:: charset = [%s]\n",csPtr));
		strcat(csDATA,"charset");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: charset is missing\n"));
	}

//desc
        if (GetField_CString(hIn,"txn_desc",&csPtr)) {
DEBUGLOG(("BuildAuthData:: desc = [%s]\n",csPtr));
		strcat(csDATA,"desc");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: desc is missing\n"));
	}

//fee_type
        if (GetField_CString(hIn,"fee_type",&csPtr)) {
DEBUGLOG(("BuildAuthData:: fee_type = [%s]\n",csPtr));
		strcat(csDATA,"fee_type");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: fee_type is missing\n"));
	}

//notify_url
        if (GetField_CString(hIn,"return_url_only",&csPtr)) {
DEBUGLOG(("BuildAuthData:: notify_url = [%s]\n",csPtr));
		strcat(csDATA,"notify_url");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: notify_url is missing\n"));
	}

//sp_billno
        if (GetField_CString(hIn,"order_num",&csPtr)) {
DEBUGLOG(("BuildAuthData:: sp_billno = [%s]\n",csPtr));
		strcat(csDATA,"sp_billno");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: sp_billno is missing\n"));
	}



//total_fee
        if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {
		char    csTmpAmt[PD_TMP_BUF_LEN +1];
//                sprintf(csTmpAmt,"%.2f",dTmp);
		sprintf((char*)csTmpAmt,"%ld",double2long(dTmp));
DEBUGLOG(("BuildAuthData:: total_fee = [%s]\n",csTmpAmt));
		strcat(csDATA,"total_fee");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csTmpAmt);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: total_fee is missing\n"));
	}

//ver
        if (GetField_CString(hIn,"ver",&csPtr)) {
DEBUGLOG(("BuildAuthData:: ver = [%s]\n",csPtr));
		strcat(csDATA,"ver");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: ver is missing\n"));
	}


	PutField_CString(hIn,"auth_data",csDATA);
DEBUGLOG(("BuildAuthData:: auth_data = [%s]\n",csDATA));
        FREE_ME(csDATA);
DEBUGLOG(("BuildAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}
int BuildRspAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr,*csDATA;
        char*   csBuf;
        csDATA = (char*) malloc (PD_TMP_MSG_BUF_LEN  +1);
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildRspAuthData()\n"));
        memset(csDATA,0,sizeof(csDATA));

//bank_type
	if (GetField_CString(hIn,"ver",&csPtr)) {
DEBUGLOG(("BuildAuthData:: ver = [%s]\n",csPtr));
                strcpy(csDATA,"ver");
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildAuthData:: ver is missing\n"));
        }

//barginor_id
	if (GetField_CString(hIn,"mid",&csPtr)) {
DEBUGLOG(("BuildAuthData:: barginor_id = [%s]\n",csPtr));
                strcpy(csDATA,"barginor_id");
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildAuthData:: barginor_id is missing\n"));
        }

//charset
	if (GetField_CString(hIn,"charset",&csPtr)) {
DEBUGLOG(("BuildAuthData:: charset = [%s]\n",csPtr));
                strcpy(csDATA,"charset");
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildAuthData:: charset is missing\n"));
        }

//fee_type
	if (GetField_CString(hIn,"fee_type",&csPtr)) {
DEBUGLOG(("BuildAuthData:: fee_type = [%s]\n",csPtr));
                strcpy(csDATA,"fee_type");
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildAuthData:: fee_type is missing\n"));
        }

//pay_result
	if (GetField_CString(hIn,"error_code",&csPtr)) {
DEBUGLOG(("BuildAuthData:: pay_result = [%s]\n",csPtr));
                strcpy(csDATA,"pay_result");
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildAuthData:: pay_result is missing\n"));
        }

//sp_billno
	if (GetField_CString(hIn,"txn_seq",&csPtr)) {
DEBUGLOG(("BuildAuthData:: sp_billno = [%s]\n",csPtr));
                strcpy(csDATA,"sp_billno");
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildAuthData:: sp_billno is missing\n"));
        }

//total_fee
	if (GetField_CString(hIn,"txn_amt",&csPtr)) {
DEBUGLOG(("BuildAuthData:: total_fee = [%s]\n",csPtr));
                strcpy(csDATA,"total_fee");
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildAuthData:: total_fee is missing\n"));
        }

//transaction_id
	if (GetField_CString(hIn,"tid",&csPtr)) {
DEBUGLOG(("BuildAuthData:: transaction_id = [%s]\n",csPtr));
                strcpy(csDATA,"transaction_id");
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildAuthData:: transaction_id is missing\n"));
        }

//ver
	if (GetField_CString(hIn,"ver",&csPtr)) {
DEBUGLOG(("BuildAuthData:: ver = [%s]\n",csPtr));
                strcpy(csDATA,"ver");
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildAuthData:: ver is missing\n"));
        }




	PutField_CString(hIn,"auth_data",csDATA);
DEBUGLOG(("BuildRspAuthData:: auth_data = [%s]\n",csDATA));
        FREE_ME(csDATA);
DEBUGLOG(("BuildRspAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

