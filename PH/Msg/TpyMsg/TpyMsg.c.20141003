
/*
 * Partnerdelight (c)2014. All rights reserved. No part of this software may be reproduced in any form without written permission
 * of an authorized representative of Partnerdelight.
 *
 * Change Description                                 Change Date             Change By
 * -------------------------------                    ------------            --------------
 *  Init Version                                      2014/08/14              Cody Chan
 *
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "TpyMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"

char	cDebug;

void	TpyMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;

	char*	csPtr = NULL;
	char*	csURL = NULL;
	char* 	csBuf;
	double	dTmp;
	char*   csMethod = NULL;
	char    *p;
	char    csIP[PD_MAX_BUFFER +1];

	//double	dTmp;
DEBUGLOG(("FormatMsg()\n"));

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

	outMsg[0]= '\0';
//psp_url
/*
	if (GetField_CString(hIn,"psp_url",&csURL)) {
		if (GetField_CString(hIn,"request_function",&csPtr)) {
			strcpy((char*)csBuf,"url");
DEBUGLOG(("FormatMsg:: psp_url = [%s]\n",csURL));
DEBUGLOG(("FormatMsg:: request function  = [%s]\n",csPtr));
			strcat((char*)csBuf,MY_TPY_FIELD_TOKEN);
			strcat((char*)csBuf,csURL);
			strcat((char*)csBuf,"/");
			strcat((char*)csBuf,csPtr);
//			strcat((char*)csBuf,MY_TPY_TOKEN);
DEBUGLOG(("FormatMsg:: psp_url = [%s]\n",csBuf));
		}	
	
		sprintf((char*)outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));
		strcat((char*)outMsg,csBuf);
		//strcat((char*)outMsg,MY_TPY_URL_END_TOKEN);

	}
	FREE_ME(csBuf);
*/

        if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg here\n"));
                strcat((char *)outMsg,csPtr);
                strcat((char *)outMsg,"?");
		//strcat((char*)outMsg,MY_TPY_TOKEN);
	}

//sign
	if (GetField_CString(hIn,"sign",&csPtr)) {
DEBUGLOG(("FormatMsg:: sign = [%s]\n",csPtr));
		strcat((char*)outMsg,"sign");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TPY_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: sign not found!!!\n"));
	}


//attach
/*
	strcat((char*)outMsg, "attach");
	strcat((char*)outMsg, MY_TPY_FIELD_TOKEN);
	strcat((char*)outMsg,MY_TPY_TOKEN);
*/


//bank_type
	if (GetField_CString(hIn,"bank_code",&csPtr)) {
DEBUGLOG(("FormatMsg:: bank_type = [%s]\n",csPtr));
		strcat((char*)outMsg,"bank_type");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("FormatMsg:: bank_type is missing\n"));
	}

//body
	strcat((char*)outMsg, "body");
	strcat((char*)outMsg, MY_TPY_FIELD_TOKEN);
	strcat((char*)outMsg, "desc");
	strcat((char*)outMsg,MY_TPY_TOKEN);

//buyer_id
/*
	strcat((char*)outMsg, "buyer_id");
	strcat((char*)outMsg, MY_TPY_FIELD_TOKEN);
	strcat((char*)outMsg,MY_TPY_TOKEN);
*/

//fee_type
	if (GetField_CString(hIn,"fee_type",&csPtr)) {
DEBUGLOG(("FormatMsg:: fee_type = [%s]\n",csPtr));
		strcat((char*)outMsg,"fee_type");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,"1"); 
		strcat((char*)outMsg,MY_TPY_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: fee_type is missing\n"));
	}

//goods_tag
/*
	strcat((char*)outMsg, "goods_tag");
	strcat((char*)outMsg, MY_TPY_FIELD_TOKEN);
	strcat((char*)outMsg,MY_TPY_TOKEN);
*/

//input_charset
/*
	strcat((char*)outMsg, "input_charset");
	strcat((char*)outMsg, MY_TPY_FIELD_TOKEN);
	strcat((char*)outMsg, "GBK");
	strcat((char*)outMsg,MY_TPY_TOKEN);
*/

//notify_url
	if (GetField_CString(hIn,"return_url_only",&csPtr)) {
DEBUGLOG(("FormatMsg:: return_url_only = [%s]\n",csPtr));
		strcat((char*)outMsg,"notify_url");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TPY_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: return_url_only not found!!!\n"));
	}

//out_trade_no
	if (GetField_CString(hIn,"txn_seq",&csPtr)) {
DEBUGLOG(("FormatMsg:: sp_billno = [%s]\n",csPtr));
		strcat((char*)outMsg,"out_trade_no");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TPY_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: sp_billno is missing\n"));
	}

// partner
	if (GetField_CString(hIn,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("FormatMsg:: partner = [%s]\n",csPtr));
		strcat((char*)outMsg,"partner");

		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TPY_TOKEN);
	}	
	else {
DEBUGLOG(("FormatMsg:: bargainor_id not found!!!\n"));
	}

//product_fee
/*
	strcat((char*)outMsg, "product_fee");
	strcat((char*)outMsg, MY_TPY_FIELD_TOKEN);
	strcat((char*)outMsg,MY_TPY_TOKEN);
*/


/* return_url (fe_url) */
        if (GetField_CString(hIn,"fe_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: fe_url = [%s]\n",csPtr));
		strcat((char*)outMsg,"return_url");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TPY_TOKEN);
        }
	else {
DEBUGLOG(("FormatMsg:: fe_url not found!!!\n"));
	}

//service_version
/*
	strcat((char*)outMsg, "service_version");
	strcat((char*)outMsg, MY_TPY_FIELD_TOKEN);
	strcat((char*)outMsg, "1.0");
	strcat((char*)outMsg,MY_TPY_TOKEN);
*/

//sign_key_index
/*
	strcat((char*)outMsg, "sign_key_index");
	strcat((char*)outMsg, MY_TPY_FIELD_TOKEN);
	strcat((char*)outMsg, "1");
	strcat((char*)outMsg,MY_TPY_TOKEN);
*/

//sign_type
/*
	strcat((char*)outMsg, "sign_type");
	strcat((char*)outMsg, MY_TPY_FIELD_TOKEN);
	strcat((char*)outMsg, "MD5");
	strcat((char*)outMsg,MY_TPY_TOKEN);
*/



//spbill_create_ip
        if (GetField_CString(hIn,"spbill_create_ip",&csPtr)) {
DEBUGLOG(("FormatMsg:: spbill_create_ip = [%s]\n",csPtr));
		p = mystrtok(csPtr,".");
		if (p){
			sprintf(csIP,"%s",p);
			while ((p = mystrtok(NULL,".")) != NULL) {
				strcat(csIP,"\%2E");
				strcat(csIP,p);
			}
		}
		strcat((char*)outMsg,"spbill_create_ip");
		strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
		strcat((char*)outMsg,csIP);
		strcat((char*)outMsg,MY_TPY_TOKEN);
DEBUGLOG(("FormatMsg:: formated spbill_create_ip = [%s]\n",csIP));
        }
	else {
DEBUGLOG(("FormatMsg:: spbill_create_ip not found!!!\n"));
	}

//time_expire
/*
	strcat((char *)outMsg, "time_expire");
	strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
	strcat((char*)outMsg,MY_TPY_TOKEN);
*/

//time_start
/*
	strcat((char *)outMsg, "time_start");
	strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
	strcat((char*)outMsg,MY_TPY_TOKEN);
*/

//total_fee
	if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {
		char    csTmpAmt[PD_TMP_BUF_LEN +1];
//                sprintf(csTmpAmt,"%.2f",dTmp);
		sprintf((char*)csTmpAmt,"%ld",double2long(dTmp));
DEBUGLOG(("FormatMsg:: total_fee = [%s]\n",csTmpAmt));
                strcat((char*)outMsg,"total_fee");
                strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
                strcat((char*)outMsg,csTmpAmt);
                strcat((char*)outMsg,MY_TPY_TOKEN);
	}
	else{
DEBUGLOG(("FormatMsg:: total_fee is missing\n"));
	}

//transport_fee
/*
	strcat((char *)outMsg, "transport_fee");
	strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
	strcat((char*)outMsg,MY_TPY_TOKEN);
*/


// timestart
/*
        if (GetField_CString(hIn,"local_tm_date",&csPtr)) {
DEBUGLOG(("FormatMsg:: local_tm_date = [%s]\n",csPtr));
		char* 	csPtr2;
		char	csDateTime[PD_DATETIME_LEN * 2];
        	if (GetField_CString(hIn,"local_tm_time",&csPtr2)) {
DEBUGLOG(("FormatMsg:: local_tm_time = [%s]\n",csPtr2));
			sprintf(csDateTime,"%s-%.*s:%.*s:%.*s",csPtr,2,csPtr2,2,&csPtr2[2],2,&csPtr[4]);
DEBUGLOG(("FormatMsg:: trdt = [%s]\n",csDateTime));
			strcat((char*)outMsg,"time_start");
			strcat((char*)outMsg,MY_TPY_FIELD_TOKEN);
			strcat((char*)outMsg,csDateTime);
			strcat((char*)outMsg,MY_TPY_TOKEN);
		}
		else {
DEBUGLOG(("FormatMsg:: local_tm_time is missing!!!\n"));
		}
        }
        else {
DEBUGLOG(("FormatMsg:: local_tm_date is missing!!!\n"));
        }
*/

/* url_method */
                if (GetField_CString(hIn,"url_method",&csMethod)) {
DEBUGLOG(("FormatMsg:: url_method = [%s]\n",csMethod));
                }

DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
                base64_encode(outMsg,strlen((char *)outMsg),csBuf,PD_MAX_BUFFER);
DEBUGLOG(("FormatMsg:: after encode\n"));
                outMsg[0] = '\0';
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
                strcat((char*)outMsg,MY_TPY_TOKEN);
                strcat((char*)outMsg,"url_method");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csMethod);
                strcat((char*)outMsg,MY_TPY_TOKEN);
                strcat((char*)outMsg,"ret_status=0");
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));

                *outLen = strlen((const char*)outMsg);


DEBUGLOG(("outmsg = [%s]\n",outMsg));

	*outLen = strlen((const char*)outMsg);
DEBUGLOG(("FormatMsg() [%s][%d]\n",outMsg,*outLen));
DEBUGLOG(("FormatMsg() Exit\n"));
	FREE_ME(csPtr);
	FREE_ME(csURL);
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csPtr;
	char	csTag[PD_TAG_LEN+1];
	hash_t  *hRec;

        hRec = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hRec,0);
                
DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));
                                
        if (Str2Cls(hRec,(char*)inMsg,MY_TPY_TOKEN, MY_TPY_FIELD_TOKEN) == PD_OK) {

//attach
		sprintf(csTag,"attach");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
//bank_billno
		sprintf(csTag,"bank_billno");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
//bank_type
		sprintf(csTag,"bank_type");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: %s not found\n",csTag));
		}
//buyer_alias
		sprintf(csTag,"buyer_alias");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
//discount
		sprintf(csTag,"discount");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
//fee_type
		sprintf(csTag,"fee_type");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: fee_type = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: %s not found\n",csTag));
		}
//input_charset
		sprintf(csTag,"input_charset");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
//notify_id
		sprintf(csTag,"notify_id");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: %s not found\n",csTag));
		}
//out_trade_no
		sprintf(csTag,"out_trade_no");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,"txn_seq",csPtr);
DEBUGLOG(("BreakDownMsg:: out_trade_no = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: %s not found\n",csTag));
		}
//partner
		sprintf(csTag,"partner");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: %s not found\n",csTag));
		}
//pay_info
		sprintf(csTag,"pay_info");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
//product_fee
		sprintf(csTag,"product_fee");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
//service_version
		sprintf(csTag,"service_version");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
//sign
		sprintf(csTag,"sign");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: %s not found\n",csTag));
		}
//sign_key_index
		sprintf(csTag,"sign_key_index");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
//sign_type
		sprintf(csTag,"sign_type");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
//time_end
		sprintf(csTag,"time_end");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,"fundin_date",csPtr);

			csPtr[PD_DATETIME_LEN] = '\0';
                        char csTxnDate[PD_DATE_LEN +1];
                        sprintf(csTxnDate,"%.*s",PD_DATE_LEN,csPtr);
                        PutField_CString(hOut,"txn_date",csTxnDate);

DEBUGLOG(("BreakDownMsg:: fundin_date = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: %s not found\n",csTag));
		}
//total_fee
		sprintf(csTag,"total_fee");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,"txn_amt",csPtr);
DEBUGLOG(("BreakDownMsg:: total_fee = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: %s not found\n",csTag));
		}
//trade_mode
		sprintf(csTag,"trade_mode");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: %s not found\n",csTag));
		}
//trade_state
		sprintf(csTag,"trade_state");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,"notice_status",csPtr);
DEBUGLOG(("BreakDownMsg:: notice_status = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: %s not found\n",csTag));
		}
//transaction_id
		sprintf(csTag,"transaction_id");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,"tid",csPtr);
DEBUGLOG(("BreakDownMsg:: tid = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: %s not found\n",csTag));
		}
//transport_fee
		sprintf(csTag,"transport_fee");
		if (GetField_CString(hRec,csTag,&csPtr)) {
			PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownMsg:: %s = [%s]\n",csTag,csPtr));
		}
	}
	else{
DEBUGLOG(("BreakDownMsg() Error\n"));
                iRet = PD_ERR;
        }

        hash_destroy(hRec);
        FREE_ME(hRec);
DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	char	*csTmp = NULL;
DEBUGLOG(("initReplyFromRequest()\n"));
	

/* order_num */
        if (GetField_CString(hRequest,"merchant_ref",&csTmp)) {
DEBUGLOG(("initReplyFromRequest: order_num = [%s]\n",csTmp));
                PutField_CString(hResponse,"order_num",csTmp);
        }


DEBUGLOG(("initReplyFromRequest() Exit\n"));
	FREE_ME(csTmp);
	return iRet;
}

int BuildAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr,*csDATA;
        char*   csBuf;
        double  dTmp;
        csDATA = (char*) malloc (PD_TMP_MSG_BUF_LEN  +1);
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildAuthData()\n"));
        memset(csDATA,0,sizeof(csDATA));

//attach
/*
	strcat(csDATA, "attach");
	strcat(csDATA,MY_TPY_FIELD_TOKEN);
	strcat(csDATA,MY_TPY_TOKEN);
*/

//bank_type
        if (GetField_CString(hIn,"bank_code",&csPtr)) {
DEBUGLOG(("BuildAuthData:: bank_type = [%s]\n",csPtr));
		strcpy(csDATA,"bank_type");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: bank_type is missing\n"));
	}

//body
	strcat(csDATA, "body");
	strcat(csDATA,MY_TPY_FIELD_TOKEN);
	strcat(csDATA,"desc");
	strcat(csDATA,MY_TPY_TOKEN);

//buyer_id
/*
	strcat(csDATA, "buyer_id");
	strcat(csDATA,MY_TPY_FIELD_TOKEN);
	strcat(csDATA,MY_TPY_TOKEN);
*/

//fee_type
        if (GetField_CString(hIn,"fee_type",&csPtr)) {
DEBUGLOG(("BuildAuthData:: fee_type = [%s]\n",csPtr));
		strcat(csDATA,"fee_type");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: fee_type is missing\n"));
	}

//goods_tag
/*
	strcat(csDATA, "goods_tag");
	strcat(csDATA,MY_TPY_FIELD_TOKEN);
	strcat(csDATA,MY_TPY_TOKEN);
*/

//input_charset
/*
	strcat(csDATA, "input_charset");
	strcat(csDATA,MY_TPY_FIELD_TOKEN);
	strcat(csDATA, "GBK");
	strcat(csDATA,MY_TPY_TOKEN);
*/

//notify_url
        if (GetField_CString(hIn,"return_url_only",&csPtr)) {
DEBUGLOG(("BuildAuthData:: notify_url = [%s]\n",csPtr));
		strcat(csDATA,"notify_url");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: notify_url is missing\n"));
	}

//out_trade_no
        if (GetField_CString(hIn,"txn_seq",&csPtr)) {
DEBUGLOG(("BuildAuthData:: out_trade_no = [%s]\n",csPtr));
		strcat(csDATA,"out_trade_no");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: out_trade_no is missing\n"));
	}


// partner
        if (GetField_CString(hIn,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("BuildAuthData:: partner = [%s]\n",csPtr));
		strcat(csDATA,"partner");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: partner is missing\n"));
	}

// product_fee
/*
	strcat(csDATA, "product_fee");
	strcat(csDATA,MY_TPY_FIELD_TOKEN);
	strcat(csDATA,MY_TPY_TOKEN);
*/

//return_url 
        if (GetField_CString(hIn,"fe_url",&csPtr)) {
DEBUGLOG(("BuildAuthData:: return_url = [%s]\n",csPtr));
		strcat(csDATA,"return_url");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: return_url is missing\n"));
	}

// service_version
/*
	strcat(csDATA, "service_version");
	strcat(csDATA,MY_TPY_FIELD_TOKEN);
	strcat(csDATA,"1.0");
	strcat(csDATA,MY_TPY_TOKEN);
*/

// sign_key_index
/*
	strcat(csDATA, "sign_key_index");
	strcat(csDATA,MY_TPY_FIELD_TOKEN);
	strcat(csDATA, "1");
	strcat(csDATA,MY_TPY_TOKEN);
*/

// sign_type
/*
	strcat(csDATA, "sign_type");
	strcat(csDATA,MY_TPY_FIELD_TOKEN);
	strcat(csDATA,"MD5");
	strcat(csDATA,MY_TPY_TOKEN);
*/


//spbill_create_ip
        if (GetField_CString(hIn,"spbill_create_ip",&csPtr)) {
DEBUGLOG(("BuildAuthData:: spbill_create_ip = [%s]\n",csPtr));
		strcat(csDATA,"spbill_create_ip");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csPtr);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: spbill_create_ip is missing\n"));
	}

// time_expire
/*
	strcat(csDATA, "time_expire");
	strcat(csDATA,MY_TPY_FIELD_TOKEN);
	strcat(csDATA,MY_TPY_TOKEN);
*/

// time_start
/*
	strcat(csDATA, "time_start");
	strcat(csDATA,MY_TPY_FIELD_TOKEN);
	strcat(csDATA,MY_TPY_TOKEN);
*/

//total_fee
        if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {
		char    csTmpAmt[PD_TMP_BUF_LEN +1];
//                sprintf(csTmpAmt,"%.2f",dTmp);
		sprintf((char*)csTmpAmt,"%ld",double2long(dTmp));
DEBUGLOG(("BuildAuthData:: total_fee = [%s]\n",csTmpAmt));
		strcat(csDATA,"total_fee");
		strcat(csDATA,MY_TPY_FIELD_TOKEN);
		strcat(csDATA,csTmpAmt);
		strcat(csDATA,MY_TPY_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: total_fee is missing\n"));
	}

// transport_fee
/*
	strcat(csDATA, "transport_fee");
	strcat(csDATA,MY_TPY_FIELD_TOKEN);
	strcat(csDATA,MY_TPY_TOKEN);
*/

	PutField_CString(hIn,"auth_data",csDATA);
DEBUGLOG(("BuildAuthData:: auth_data = [%s]\n",csDATA));
        FREE_ME(csDATA);
DEBUGLOG(("BuildAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

int BuildRspAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr,*csDATA;
        char*   csBuf;
	char	csTag[PD_TAG_LEN+1];
        csDATA = (char*) malloc (PD_TMP_MSG_BUF_LEN  +1);
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildRspAuthData()\n"));
        memset(csDATA,0,sizeof(csDATA));

//attach        
	sprintf(csTag,"attach");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
//bank_billno     
	sprintf(csTag,"bank_billno");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
//bank_type       
	sprintf(csTag,"bank_type");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildRspAuthData:: %s is missing\n",csTag));
        }
//buyer_alias     
	sprintf(csTag,"buyer_alias");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildRspAuthData:: %s is missing\n",csTag));
        }
//discount        
	sprintf(csTag,"discount");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
//fee_type        
	sprintf(csTag,"fee_type");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildRspAuthData:: %s is missing\n",csTag));
        }
//input_charset   
	sprintf(csTag,"input_charset");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
//notify_id       
	sprintf(csTag,"notify_id");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildRspAuthData:: %s is missing\n",csTag));
        }
//out_trade_no    
	sprintf(csTag,"txn_seq");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,"out_trade_no");
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildRspAuthData:: %s is missing\n",csTag));
        }
//partner         
	sprintf(csTag,"partner");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildRspAuthData:: %s is missing\n",csTag));
        }
//pay_info        
	sprintf(csTag,"pay_info");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
//product_fee     
	sprintf(csTag,"product_fee");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
//service_version 
	sprintf(csTag,"service_version");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
//sign_key_index  
	sprintf(csTag,"sign_key_index");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
//sign_type       
	sprintf(csTag,"sign_type");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
//time_end        
	sprintf(csTag,"fundin_date");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,"time_end");
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildRspAuthData:: %s is missing\n",csTag));
        }
//total_fee       
	sprintf(csTag,"txn_amt");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,"total_fee");
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildRspAuthData:: %s is missing\n",csTag));
        }
//trade_mode      
	sprintf(csTag,"trade_mode");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildRspAuthData:: %s is missing\n",csTag));
        }
//trade_state     
	sprintf(csTag,"notice_status");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,"trade_state");
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildRspAuthData:: %s is missing\n",csTag));
        }
//transaction_id  
	sprintf(csTag,"tid");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,"transaction_id");
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }
        else {
DEBUGLOG(("BuildRspAuthData:: %s is missing\n",csTag));
        }
//transport_fee   
	sprintf(csTag,"transport_fee");
	if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
                strcpy(csDATA,csTag);
                strcat(csDATA,MY_TPY_FIELD_TOKEN);
                strcat(csDATA,csPtr);
                strcat(csDATA,MY_TPY_TOKEN);
        }

	PutField_CString(hIn,"auth_data",csDATA);
DEBUGLOG(("BuildRspAuthData:: auth_data = [%s]\n",csDATA));
        FREE_ME(csDATA);
DEBUGLOG(("BuildRspAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

