/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version					   2011/10/19              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "YpyMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include "b64.h"

char	cDebug;

void	YpyMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;
	char*   csTmp = NULL;
	char*   csPtr = NULL;
	char*   csBuf;
	double  dTmp;
	char*   csMethod = NULL;

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

	memset(outMsg,0,sizeof(outMsg));
	if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg here\n"));
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,"?");
/* p0 */
		if (GetField_CString(hIn,"action",&csTmp)) {
			strcat((char*)outMsg,"p0_Cmd");
			strcat((char*)outMsg,MY_YPY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_YPY_TOKEN);
DEBUGLOG(("FormatMsg:: p0_Cmd = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***action is missing\n"));
		}
/* p1 */
		if (GetField_CString(hIn,"psp_merchant_id",&csTmp)) {
			strcat((char*)outMsg,"p1_MerId");
			strcat((char*)outMsg,MY_YPY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_YPY_TOKEN);
DEBUGLOG(("FormatMsg:: p1_MerId = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***psp_merchant_id is missing\n"));
		}
/* p2 */
		if (GetField_CString(hIn,"txn_seq",&csTmp)) {
			strcat((char*)outMsg,"p2_Order");
			strcat((char*)outMsg,MY_YPY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_YPY_TOKEN);
DEBUGLOG(("FormatMsg:: p2_Order = [%s]\n",csTmp));
		}

/* txn amt */
/* p3 */
                if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {

                        char    csTmpAmt[PD_TMP_BUF_LEN +1];
                        sprintf(csTmpAmt,"%.2f",dTmp);
                        strcat((char*)outMsg,"p3_Amt");
                        strcat((char*)outMsg,MY_YPY_FIELD_TOKEN);
                        strcat((char*)outMsg,csTmpAmt);
                        strcat((char*)outMsg,MY_YPY_TOKEN);
DEBUGLOG(("FormatMsg:: p3_Amt = [%s]\n",csTmpAmt));
                }
                else {
DEBUGLOG(("FormatMsg:: psp_txn_amt is missing!!!\n"));
                }

/* psp txn ccy */
/* p4 */
                if (GetField_CString(hIn,"psp_txn_ccy",&csTmp)) {
                        strcat((char*)outMsg,"p4_Cur");
                        strcat((char*)outMsg,MY_YPY_FIELD_TOKEN);
                        strcat((char*)outMsg,csTmp);
                        strcat((char*)outMsg,MY_YPY_TOKEN);
DEBUGLOG(("FormatMsg:: e_Currency_Type = [%s]\n",csTmp));
                }
/* p5 pid */
/* p6 Pact */
/* p7 Pdesc */
/* p8 url */
		// Use fe_url_only 
		//if (GetField_CString(hIn,"return_url_only",&csTmp)) 
		if (GetField_CString(hIn,"fe_url_only",&csTmp)) {
                        strcat((char*)outMsg,"p8_Url");
                        strcat((char*)outMsg,MY_YPY_FIELD_TOKEN);
                        strcat((char*)outMsg,csTmp);
                        strcat((char*)outMsg,MY_YPY_TOKEN);
DEBUGLOG(("FormatMsg:: p8_Url = [%s]\n",csTmp));
                }       
                else {
                        iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** fe_url is missing\n"));
                }
/* p9_SAF */
/* p10 MP*/
/* p11 */
		strcat((char*)outMsg,"pr_NeedResponse");
                strcat((char*)outMsg,MY_YPY_FIELD_TOKEN);
                strcat((char*)outMsg,"1");
                strcat((char*)outMsg,MY_YPY_TOKEN);
DEBUGLOG(("FormatMsg:: pr_NeedResponse = [1]\n"));

/* p12 */
		if (GetField_CString(hIn,"bank_code",&csTmp)) {
			strcat((char*)outMsg,"pd_FrpId");
			strcat((char*)outMsg,MY_YPY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_YPY_TOKEN);
DEBUGLOG(("FormatMsg:: pd_FrpId = [%s]\n",csTmp));
		}

/* sign */
		if (GetField_CString(hIn,"sign",&csTmp)) {
			strcat((char*)outMsg,"hmac");
			strcat((char*)outMsg,MY_YPY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_YPY_TOKEN);
DEBUGLOG(("FormatMsg:: hmac = [%s]\n",csTmp));
		}

/* url_method */
		if (GetField_CString(hIn,"url_method",&csMethod)) {
DEBUGLOG(("FormatMsg:: url_method = [%s]\n",csMethod));
		}
		else 
			csMethod = strdup("");

DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
		base64_encode(outMsg,strlen((char*)outMsg),csBuf,PD_MAX_BUFFER);
DEBUGLOG(("FormatMsg:: after encode\n"));
                outMsg[0] = '\0';
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
                strcat((char*)outMsg,MY_YPY_TOKEN);
		strcat((char*)outMsg,"url_method");
		strcat((char*)outMsg,"=");
		strcat((char*)outMsg,csMethod);
		strcat((char*)outMsg,MY_YPY_TOKEN);
                strcat((char*)outMsg,"ret_status=0");
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));

		*outLen = strlen((const char*)outMsg);
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: Redirct url not found\n"));
	}


DEBUGLOG(("FormatMsg:: normal exit iret =[%d]\n",iRet));
	FREE_ME(csBuf);
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csPtr;
	char	*csTxnTime;
	char	csTxnDate[PD_DATE_LEN+1];
	char	csPHdate[PD_DATE_LEN+1];
	hash_t  *hRec;

        hRec = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hRec,0);

DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));

	if (Str2Cls(hRec,(char*)inMsg,MY_YPY_TOKEN, MY_YPY_FIELD_TOKEN) == PD_OK) {

/* p1_MerId */
		if (GetField_CString(hRec,"p1_MerId",&csPtr)) {
			PutField_CString(hOut,"psp_merchant_id",csPtr);
DEBUGLOG(("BreakDownMsg:: p1_MerId:psp_merchant_id = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: p1_MerId:psp_merchant_id not found\n"));
		}
/* r0_Cmd */
		if (GetField_CString(hRec,"r0_Cmd",&csPtr)) {
			PutField_CString(hOut,"action",csPtr);
DEBUGLOG(("BreakDownMsg:: r0_Cmd:action = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: r0_Cmd:action not found\n"));
		}
/* r1_Code */
		if (GetField_CString(hRec,"r1_Code",&csPtr)) {
			PutField_CString(hOut,"status",csPtr);
			if(strncmp(csPtr,"1",1)){
				PutField_CString(hOut,"error_code",csPtr);
			}
DEBUGLOG(("BreakDownMsg:: r1_Code:status = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: r1_Code:status not found\n"));
		}

/* r2_TrxId */
		if (GetField_CString(hRec,"r2_TrxId",&csPtr)) {
			PutField_CString(hOut,"tid",csPtr);
DEBUGLOG(("BreakDownMsg:: r2_TrxId:tid = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: r2_TrxId:tid not found\n"));
		}


/* r3_Amt */
		if (GetField_CString(hRec,"r3_Amt",&csPtr)) {
			PutField_CString(hOut,"psp_txn_amt",csPtr);
DEBUGLOG(("BreakDownMsg:: r3_Amt:txn_amt = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: r3_Amt:txn_amt not found\n"));
		}

/* r4_Cur */
		if (GetField_CString(hRec,"r4_Cur",&csPtr)) {
			PutField_CString(hOut,"psp_txn_ccy",csPtr);
DEBUGLOG(("BreakDownMsg:: r4_Cur:txn_ccy = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: r4_Cur:txn_ccy not found\n"));
		}
/* r5_Pid */
		if (GetField_CString(hRec,"r5_Pid",&csPtr)) {
			PutField_CString(hOut,"pid",csPtr);
DEBUGLOG(("BreakDownMsg:: r5_Pid:pid = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: r5_Pid:pid not found\n"));
		}

/* r6_Order */
		if (GetField_CString(hRec,"r6_Order",&csPtr)) {
			PutField_CString(hOut,"txn_seq",csPtr);
DEBUGLOG(("BreakDownMsg:: r6_Order:txn_seq = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: r6_Order:txn_seq not found\n"));
		}
/* r7_Uid */
		if (GetField_CString(hRec,"r7_Uid",&csPtr)) {
			PutField_CString(hOut,"uid",csPtr);
DEBUGLOG(("BreakDownMsg:: r7_Uid:uid = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: r7_Uid:uid not found\n"));
		}
/* r8_MP */
		if (GetField_CString(hRec,"r8_MP",&csPtr)) {
			PutField_CString(hOut,"mp",csPtr);
DEBUGLOG(("BreakDownMsg:: r8_MP:mp = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: r8_MP:mp not found\n"));
		}
/* r9_BType */
		if (GetField_CString(hRec,"r9_BType",&csPtr)) {
			PutField_CString(hOut,"btype",csPtr);
DEBUGLOG(("BreakDownMsg:: r9_BType:btype = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: r9_BType:btype not found\n"));
		}
/* rb_BankId */
		if (GetField_CString(hRec,"rb_BankId",&csPtr)) {
			PutField_CString(hOut,"bank_code",csPtr);
DEBUGLOG(("BreakDownMsg:: rb_BankId:bank_code = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: rb_BankId:bank_code not found\n"));
		}

/* ro_BankOrderId */
		if (GetField_CString(hRec,"ro_BankOrderId",&csPtr)) {
			PutField_CString(hOut,"bank_bill_no",csPtr);
DEBUGLOG(("BreakDownMsg:: ro_BankOrderId:bank_bill_no = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: ro_BankOrderId:bank_bill_no not found\n"));
		}
/* ru_Trxtime */
		if (GetField_CString(hRec,"ru_Trxtime",&csTxnTime)) {
			strcpy(csTxnDate,csTxnTime);
			csTxnDate[PD_DATE_LEN]='\0';
			PutField_CString(hOut,"txn_date",csTxnDate);
DEBUGLOG(("BreakDownMsg:: ru_Trxtime:txn_datetime = [%s]\n",csTxnTime));
DEBUGLOG(("BreakDownMsg:: ru_Trxtime:txn_date = [%s]\n",csTxnDate));

			/////////////TODO: Should be remove after UAT!!!!!!!!/////////////
			strcpy(csPHdate,getdatetime());
			csPHdate[PD_DATE_LEN]='\0';
			PutField_CString(hOut,"txn_date",csPHdate);

		}
		else{
DEBUGLOG(("BreakDownMsg:: ru_Trxtime:txn_date not found\n"));
		}
/* rp_PayDate */
		if (GetField_CString(hRec,"rp_PayDate",&csPtr)) {
			PutField_CString(hOut,"fundin_date",csPtr);
DEBUGLOG(("BreakDownMsg:: rp_PayDate:fundin_date = [%s]\n",csPtr));

			/////////////TODO: Should be remove after UAT!!!!!!!!/////////////
			char csDateTime[PD_DATETIME_LEN+1];
			sprintf(csDateTime,"%.*s%.*s",PD_DATE_LEN,csPHdate,PD_TIME_LEN,&csPtr[PD_DATE_LEN]);
			PutField_CString(hOut,"fundin_date",csDateTime);
		}
		else{
DEBUGLOG(("BreakDownMsg:: rp_PayDate:fundin_date not found\n"));
		}
/* rq_TargetFee */
		if (GetField_CString(hRec,"rq_TargetFee",&csPtr)) {
			PutField_CString(hOut,"service_fee",csPtr);
DEBUGLOG(("BreakDownMsg:: rq_TargetFee:service_fee = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: rq_TargetFee:service_fee not found\n"));
		}

/* hmac */
		if (GetField_CString(hRec,"hmac",&csPtr)) {
			PutField_CString(hOut,"sign",csPtr);
DEBUGLOG(("BreakDownMsg:: sign = [%s]\n",csPtr));
		}
		else{
                	PutField_CString(hOut,"sign"," ");
DEBUGLOG(("BreakDownMsg:: sign = [%s]\n"," "));
        	}

	}
	else {
DEBUGLOG(("BreakDownMsg() Error\n"));
                iRet = PD_ERR;
        }
        
        hash_destroy(hRec);
	FREE_ME(hRec);

DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	return iRet;
}


int BuildReqData(hash_t* hIn)
{       
        int     iRet = PD_OK;
        char*   csPtr,*csDATA;
//        char*   csTmp[PD_MAX_BUFFER + 1];
        char*   csBuf;
        double  dTmp;
        csDATA = (char*) malloc (1024 * 2 +1);
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 ); 

DEBUGLOG(("BuildReqData()\n"));
                
        memset(csDATA,0,sizeof(csDATA));
// 1 cmd
        if (GetField_CString(hIn,"action",&csPtr)) {
DEBUGLOG(("BuildReqData:: 1. cmd = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
//                strcat((char*)csDATA,MY_YPY_DATA_TOKEN);
        }

// 2 merchant id
        if (GetField_CString(hIn,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("BuildReqData:: 2. psp_merchant_id = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
//                strcat((char*)csDATA,MY_YPY_DATA_TOKEN);
        }
// 3 txn_seq
        if (GetField_CString(hIn,"txn_seq",&csPtr)) {
DEBUGLOG(("BuildReqData:: 3. txn_seq = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
//                strcat((char*)csDATA,MY_YPY_DATA_TOKEN);
        }

//4 psp_txn_amt
        if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {
DEBUGLOG(("BuildReqData:: 4. AMOUNT = [%f]\n",dTmp));
		char    csTmpAmt[PD_TMP_BUF_LEN +1];
		sprintf(csTmpAmt,"%.2f",dTmp);
                strcat((char*)csDATA,csTmpAmt);
//                strcat((char*)csDATA,MY_YPY_DATA_TOKEN);
        }

//5 currency_code
        if (GetField_CString(hIn,"psp_txn_ccy",&csPtr)) {
DEBUGLOG(("BuildReqData:: 5. psp_txn_ccy = [%s]\n",csPtr));
                        strcat((char*)csDATA,csPtr );
//                        strcat((char*)csDATA,MY_YPY_DATA_TOKEN);
        }

//6 dispay production name on psp
//7 Product Catergory
//8 product desc
//9 return url
	// use fe_url_only
	//if (GetField_CString(hIn,"return_url_only",&csPtr)) 
	if (GetField_CString(hIn,"fe_url_only",&csPtr)) {
DEBUGLOG(("BuildReqData:: 9. fe_url = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
//                strcat((char*)csDATA,MY_YPY_DATA_TOKEN);
        }
//10 devlivery address
//11 Merchant Message
//12 bank code
	if (GetField_CString(hIn,"bank_code",&csPtr)) {
DEBUGLOG(("BuildReqData:: 12. bank_code = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
        }

//13 NeedResponse
        strcat((char*)csDATA,"1"); //default yes


        PutField_CString(hIn,"auth_data",csDATA);
                
DEBUGLOG(("BuildReqData:: DATA = [%s]\n",csDATA));
        
        FREE_ME(csDATA);
DEBUGLOG(("BuildReqData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

int BuildRspData(hash_t* hIn)
{       
        int     iRet = PD_OK;
        char*   csPtr,*csDATA;
        char*   csBuf;
        csDATA = (char*) malloc (1024 * 2 +1);
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 ); 

DEBUGLOG(("BuildRspData()\n"));
                
        memset(csDATA,0,sizeof(csDATA));

// p1_MerId
        if (GetField_CString(hIn,"psp_merchant_id",&csPtr)) {
DEBUGLOG(("BuildRspData:: p1_MerId:psp_merchant_id = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
        }
// r0_Cmd
        if (GetField_CString(hIn,"action",&csPtr)) {
DEBUGLOG(("BuildRspeqData:: r0_Cmd:action = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
        }
// r1_Code
        if (GetField_CString(hIn,"status",&csPtr)) {
DEBUGLOG(("BuildRspeqData:: r1_Code:status = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
        }

// r2_TrxId
        if (GetField_CString(hIn,"tid",&csPtr)) {
DEBUGLOG(("BuildRspData:: r2_TrxId:tid = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
        }

// r3_Amt
        if (GetField_CString(hIn,"psp_txn_amt",&csPtr)) {
DEBUGLOG(("BuildRspData:: r3_Amt:psp_txn_amt = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
        }

// r4_Cur
        if (GetField_CString(hIn,"psp_txn_ccy",&csPtr)) {
DEBUGLOG(("BuildRspData:: r4_Cur:psp_txn_ccy = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
        }
// r5_Pid
        if (GetField_CString(hIn,"pid",&csPtr)) {
DEBUGLOG(("BuildRspData:: r5_Pid:pid = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
        }
// r6_Order
        if (GetField_CString(hIn,"txn_seq",&csPtr)) {
DEBUGLOG(("BuildRspData:: r6_Order:txn_seq = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
        }

// r7_Uid
        if (GetField_CString(hIn,"uid",&csPtr)) {
DEBUGLOG(("BuildRspData:: r7_Uid:uid = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
        }

// r8_MP
        if (GetField_CString(hIn,"mp",&csPtr)) {
DEBUGLOG(("BuildRspData:: r8_MP:mp = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
        }

// r9_BType
        if (GetField_CString(hIn,"btype",&csPtr)) {
DEBUGLOG(("BuildRspData:: r9_BType:btype = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
        }


        PutField_CString(hIn,"auth_data",csDATA);
                
DEBUGLOG(("BuildRspData:: auth_data = [%s]\n",csDATA));
        
        FREE_ME(csDATA);
DEBUGLOG(("BuildRspData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}
