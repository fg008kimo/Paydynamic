/*
PDProTech (c)2016. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version					   2018/05/24              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "TtpMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"
#include "internal.h"
#include "ObjPtr.h"

char	cDebug;
OBJPTR(DB);

struct key_value_pair
{
        char key[PD_TMP_BUF_LEN];
        char value[PD_TMP_MSG_BUF_LEN];
};


void	TtpMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn, unsigned char *outMsg, int *outLen)
{
	int	iRet = PD_OK;
	char*   csPtr = NULL;
	char*   csBankCode= NULL;
	char*   csBuf;
	double  dTmp;
	char	cTmp;
	char*   csMethod = NULL;
	int	iOpt = PD_TRUE;

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

	memset(outMsg, 0, sizeof(outMsg));
	if (GetField_CString(hIn, "redirect_url", &csPtr)) {
DEBUGLOG(("FormatMsg here\n"));
		strcat((char *)outMsg, csPtr);
		strcat((char *)outMsg, "?");


/* merchantid */
		if (GetField_CString(hIn, "psp_merchant_id", &csPtr)) {
			strcat((char*)outMsg, "merchantid");
			strcat((char*)outMsg, MY_TTP_FIELD_TOKEN);
			strcat((char*)outMsg, csPtr);
			strcat((char*)outMsg, MY_TTP_TOKEN);
DEBUGLOG(("merchantid = [%s]\n", csPtr));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***psp_merchant_id is missing\n"));
		}

/* merc_ord_no */
		if (GetField_CString(hIn, "txn_seq", &csPtr)) {
			strcat((char*)outMsg, "merc_ord_no");
			strcat((char*)outMsg, MY_TTP_FIELD_TOKEN);
			strcat((char*)outMsg, csPtr);
			strcat((char*)outMsg, MY_TTP_TOKEN);
DEBUGLOG(("merc_ord_no = [%s]\n", csPtr));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***txn_seq is missing\n"));
		}

/* version */
		strcat((char*)outMsg, "version");
		strcat((char*)outMsg, MY_TTP_FIELD_TOKEN);
		strcat((char*)outMsg, MY_TTP_VERSION);
		strcat((char*)outMsg, MY_TTP_TOKEN);
DEBUGLOG(("version = [%s]\n", MY_TTP_VERSION));


/* reqtime */
		if (GetField_CString(hIn, "local_tm_date", &csPtr)) {
			char*   csPtr2;
			char    csDateTime[PD_DATETIME_LEN * 2];
                        if (GetField_CString(hIn, "local_tm_time", &csPtr2)) {
                                sprintf(csDateTime, "%s%s", csPtr, csPtr2);
DEBUGLOG(("reqtime = [%s]\n", csDateTime));
				strcat((char*)(char*)outMsg, "reqtime");
				strcat((char*)(char*)outMsg, MY_TTP_FIELD_TOKEN);
				strcat((char*)(char*)outMsg, csDateTime);
				strcat((char*)(char*)outMsg, MY_TTP_TOKEN);
                        }
                        else {
DEBUGLOG(("local_tm_time is missing!!!\n"));
                        }
                }
                else {
DEBUGLOG(("local_tm_date is missing!!!\n"));
		}

/* trxtype */ // EC only
		if (GetField_CString(hIn, "bank_code", &csBankCode)) {
			DBObjPtr = CreateObj(DBPtr, "DBMobBankMap", "IsMobileOption");
			iOpt = (unsigned long)(*DBObjPtr)(csBankCode);
			if(iOpt==PD_TRUE && iOpt!=INT_ERR){
				strcat((char*)outMsg, "trxtype");
				strcat((char*)outMsg, MY_TTP_FIELD_TOKEN);
				strcat((char*)outMsg, MY_TTP_TYPE_EC);
				strcat((char*)outMsg, MY_TTP_TOKEN);
DEBUGLOG(("trxtype = [%s]\n", MY_TTP_TYPE_EC));
			}
		}


/* tranamt */
		if (GetField_Double(hIn, "psp_txn_amt", &dTmp)) {
			char csTmpAmt[PD_TMP_BUF_LEN +1];
			sprintf(csTmpAmt, "%.2f", dTmp);
			//sprintf((char*)csTmpAmt, "%ld", double2long(dTmp));
			strcat((char*)outMsg, "tranamt");
			strcat((char*)outMsg, MY_TTP_FIELD_TOKEN);
			strcat((char*)outMsg, csTmpAmt);
			strcat((char*)outMsg, MY_TTP_TOKEN);
DEBUGLOG(("tranamt = [%s]\n", csTmpAmt));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***psp_txn_amt is missing!!!\n"));
		}

/* curCode */
		strcat((char*)outMsg, "curCode");
		strcat((char*)outMsg, MY_TTP_FIELD_TOKEN);
		strcat((char*)outMsg, MY_TTP_CCY);
		strcat((char*)outMsg, MY_TTP_TOKEN);
DEBUGLOG(("curCode = [%s]\n", MY_TTP_CCY));


/* cardType */
		if (GetField_Char(hIn, "card_type", &cTmp)) {
			if (cTmp == PD_DEPOSIT_CARD_TYPE_DEBIT) {
				strcat((char*)outMsg, "cardType");
				strcat((char*)outMsg, MY_TTP_FIELD_TOKEN);
				strcat((char*)outMsg, MY_TTP_DR_CARD);
				strcat((char*)outMsg, MY_TTP_TOKEN);
DEBUGLOG(("cardType = [%s]\n", MY_TTP_DR_CARD));
			}
			else if (cTmp == PD_DEPOSIT_CARD_TYPE_CREDIT) {
				strcat((char*)outMsg, "cardType");
				strcat((char*)outMsg, MY_TTP_FIELD_TOKEN);
				strcat((char*)outMsg, MY_TTP_CR_CARD);
				strcat((char*)outMsg, MY_TTP_TOKEN);
DEBUGLOG(("cardType = [%s]\n", MY_TTP_CR_CARD));
			}
		}


/* bankcode */
		if(iOpt==PD_FALSE && iOpt!=INT_ERR){
			strcat((char*)outMsg, "bankcode");
			strcat((char*)outMsg, MY_TTP_FIELD_TOKEN);
			strcat((char*)outMsg, csBankCode);
			strcat((char*)outMsg, MY_TTP_TOKEN);
DEBUGLOG(("bankcode = [%s]\n", csBankCode));
		}

/* notifyurl */
		if (GetField_CString(hIn, "return_url_only", &csPtr)) {
			strcat((char*)outMsg, "notifyurl");
			strcat((char*)outMsg, MY_TTP_FIELD_TOKEN);
			strcat((char*)outMsg, csPtr);
			strcat((char*)outMsg, MY_TTP_TOKEN);
DEBUGLOG(("notifyurl = [%s]\n", csPtr));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("*** return_url_only is missing\n"));
		}

/* callbackurl */
		if (GetField_CString(hIn, "fe_url", &csPtr)) {
			strcat((char*)outMsg, "callbackurl");
                        strcat((char*)outMsg, MY_TTP_FIELD_TOKEN);
                        strcat((char*)outMsg, csPtr);
                        strcat((char*)outMsg, MY_TTP_TOKEN);
DEBUGLOG(("callbackurl = [%s]\n", csPtr));
                }
		else {
			iRet = PD_ERR;
DEBUGLOG(("***fe_url is missing\n"));
		}

/* sign */
		if (GetField_CString(hIn, "sign", &csPtr)) {
			strcat((char*)outMsg, "sign");
			strcat((char*)outMsg, MY_TTP_FIELD_TOKEN);
			strcat((char*)outMsg, csPtr);
			strcat((char*)outMsg, MY_TTP_TOKEN);
DEBUGLOG(("sign = [%s]\n", csPtr));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***sign is missing\n"));
		}

/* url_method */
		if (GetField_CString(hIn, "url_method", &csMethod)) {
DEBUGLOG(("url_method = [%s]\n", csMethod));
		}
		else 
			csMethod = strdup("");

DEBUGLOG(("FormatMsg:: outmsg = [%s]\n", outMsg));
		base64_encode(outMsg, strlen((char *)outMsg), csBuf, PD_MAX_BUFFER);
DEBUGLOG(("FormatMsg:: after encode\n"));
                outMsg[0] = '\0';
                strcat((char*)outMsg, "redirect_url");
                strcat((char*)outMsg, "=");
                strcat((char*)outMsg, csBuf);
                strcat((char*)outMsg, MY_TTP_TOKEN);
		strcat((char*)outMsg, "url_method");
		strcat((char*)outMsg, "=");
		strcat((char*)outMsg, csMethod);
                strcat((char*)outMsg, MY_TTP_TOKEN);
		strcat((char*)outMsg, "ret_status=0");
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n", outMsg));

		*outLen = strlen((const char*)outMsg);
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("Redirct url not found\n"));
	}


DEBUGLOG(("FormatMsg:: normal exit iret =[%d]\n", iRet));
	FREE_ME(csBuf);
	return 	iRet;
}

int BreakDownMsg(hash_t *hOut, const unsigned char *inMsg, int inLen)
{
	int	iRet = PD_OK;
	char	*csPtr;
	hash_t  *hRec;

        hRec = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hRec, 0);

DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n", inMsg, inLen));

	if (Str2Cls(hRec, (char *)inMsg, MY_TTP_TOKEN, MY_TTP_FIELD_TOKEN) == PD_OK) {

		PutField_CString(hOut, "in_msg", code_convert(PD_GB2312_CODE, PD_HOST_CODE, (char *)inMsg));

/* merchantid */
		if (GetField_CString(hRec, "merchantid", &csPtr)) {
DEBUGLOG(("merchantid = [%s]\n", csPtr));
		}
		else{
DEBUGLOG(("merchantid not found\n"));
		}

/* merc_ord_no */
		if (GetField_CString(hRec, "merc_ord_no", &csPtr)) {
			PutField_CString(hOut, "txn_seq", csPtr);
DEBUGLOG(("txn_seq = [%s]\n", csPtr));
		}
		else{
DEBUGLOG(("merc_ord_no not found\n"));
		}

/* version */
		if (GetField_CString(hRec, "version", &csPtr)) {
DEBUGLOG(("version = [%s]\n", csPtr));
		}
		else{
DEBUGLOG(("version not found\n"));
		}

/* ord_no */
		if (GetField_CString(hRec, "ord_no", &csPtr)) {
			PutField_CString(hOut, "tid", csPtr);
DEBUGLOG(("tid = [%s]\n", csPtr));
		}
		else{
DEBUGLOG(("ord_no not found\n"));
		}

/* tranamt */
		if (GetField_CString(hRec, "tranamt", &csPtr)) {
			PutField_CString(hOut, "txn_amt", csPtr);
DEBUGLOG(("txn_amt = [%s]\n", csPtr));
		}
		else{
DEBUGLOG(("tranamt not found\n"));
		}

/* reqtime */
		if (GetField_CString(hRec, "reqtime", &csPtr)) {
DEBUGLOG(("reqtime = [%s]\n", csPtr));
		}
		else{
DEBUGLOG(("reqtime not found\n"));
		}

/* returncode */
		if (GetField_CString(hRec, "returncode", &csPtr)) {
DEBUGLOG(("returncode = [%s]\n", csPtr));
		}
		else{
DEBUGLOG(("returncode not found\n"));
		}

/* returnmsg */
		if (GetField_CString(hRec, "returnmsg", &csPtr)) {
DEBUGLOG(("returnmsg = [%s]\n", code_convert(PD_GB2312_CODE, PD_HOST_CODE, csPtr)));
		}
		else{
DEBUGLOG(("returnmsg not found\n"));
		}

/* status */
		if (GetField_CString(hRec, "status", &csPtr)) {
			PutField_CString(hOut, "status", csPtr);
DEBUGLOG(("status = [%s]\n", csPtr));
		}
		else{
DEBUGLOG(("status not found\n"));
		}

/* sign */
                if (GetField_CString(hRec, "sign", &csPtr)) {
                        PutField_CString(hOut, "sign", csPtr);
DEBUGLOG(("sign = [%s]\n", csPtr));
                }
                else{
DEBUGLOG(("sign not found\n"));
                }
	}
	else {
DEBUGLOG(("BreakDownMsg() Error\n"));
                iRet = PD_ERR;
        }
        
        hash_destroy(hRec);
	FREE_ME(hRec);

DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	return iRet;
}

int BuildAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr;
        char*   csBankCode;
        char*   csBuf;
	double	dTmp;
	char	cTmp;
	int	iOpt = PD_TRUE;
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildAuthData()\n"));
	memset(csBuf, 0, MAX_MSG_SIZE);
	csBuf[0] = '\0';
	

/* bankcode */
	if (GetField_CString(hIn, "bank_code", &csBankCode)) {
		DBObjPtr = CreateObj(DBPtr, "DBMobBankMap", "IsMobileOption");
		iOpt = (unsigned long)(*DBObjPtr)(csBankCode);
		if(iOpt==PD_FALSE && iOpt!=INT_ERR){
			strcat((char*)csBuf, "bankcode");
			strcat((char*)csBuf, MY_TTP_FIELD_TOKEN);
			strcat((char*)csBuf, csBankCode);
			strcat((char*)csBuf, MY_TTP_TOKEN);
DEBUGLOG(("bankcode = [%s]\n", csBankCode));
		}
	}

/* callbackurl */
	if (GetField_CString(hIn, "fe_url", &csPtr)) {
		strcat((char*)csBuf, "callbackurl");
		strcat((char*)csBuf, MY_TTP_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_TTP_TOKEN);
DEBUGLOG(("callbackurl = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("***fe_url is missing\n"));
	}


/* cardType */
	if (GetField_Char(hIn, "card_type", &cTmp)) {
		if (cTmp == PD_DEPOSIT_CARD_TYPE_DEBIT) {
			strcat((char*)csBuf, "cardType");
			strcat((char*)csBuf, MY_TTP_FIELD_TOKEN);
			strcat((char*)csBuf, MY_TTP_DR_CARD);
			strcat((char*)csBuf, MY_TTP_TOKEN);
DEBUGLOG(("cardType = [%s]\n", MY_TTP_DR_CARD));
		}
		else if (cTmp == PD_DEPOSIT_CARD_TYPE_CREDIT) {
			strcat((char*)csBuf, "cardType");
			strcat((char*)csBuf, MY_TTP_FIELD_TOKEN);
			strcat((char*)csBuf, MY_TTP_CR_CARD);
			strcat((char*)csBuf, MY_TTP_TOKEN);
DEBUGLOG(("cardType = [%s]\n", MY_TTP_CR_CARD));
		}
	}


/* curCode */
	strcat((char*)csBuf, "curCode");
	strcat((char*)csBuf, MY_TTP_FIELD_TOKEN);
	strcat((char*)csBuf, MY_TTP_CCY);
	strcat((char*)csBuf, MY_TTP_TOKEN);
DEBUGLOG(("curCode = [%s]\n", MY_TTP_CCY));


/* merc_ord_no */
	if (GetField_CString(hIn, "txn_seq", &csPtr)) {
		strcat((char*)csBuf, "merc_ord_no");
		strcat((char*)csBuf, MY_TTP_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_TTP_TOKEN);
DEBUGLOG(("merc_ord_no = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("***txn_seq is missing\n"));
	}

/* merchantid */
	if (GetField_CString(hIn, "psp_merchant_id", &csPtr)) {
		strcat((char*)csBuf, "merchantid");
		strcat((char*)csBuf, MY_TTP_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_TTP_TOKEN);
DEBUGLOG(("merchantid = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("***psp_merchant_id is missing\n"));
	}

/* notifyurl */
	if (GetField_CString(hIn, "return_url_only", &csPtr)) {
		strcat((char*)csBuf, "notifyurl");
		strcat((char*)csBuf, MY_TTP_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_TTP_TOKEN);
DEBUGLOG(("notifyurl = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("*** return_url_only is missing\n"));
	}

/* reqtime */
	if (GetField_CString(hIn, "local_tm_date", &csPtr)) {
		char*   csPtr2;
		char    csDateTime[PD_DATETIME_LEN * 2];
		if (GetField_CString(hIn, "local_tm_time", &csPtr2)) {
			sprintf(csDateTime, "%s%s", csPtr, csPtr2);
DEBUGLOG(("reqtime = [%s]\n", csDateTime));
			strcat((char*)(char*)csBuf, "reqtime");
			strcat((char*)(char*)csBuf, MY_TTP_FIELD_TOKEN);
			strcat((char*)(char*)csBuf, csDateTime);
			strcat((char*)(char*)csBuf, MY_TTP_TOKEN);
		}
		else {
DEBUGLOG(("local_tm_time is missing!!!\n"));
		}
	}
	else {
DEBUGLOG(("local_tm_date is missing!!!\n"));
	}

/* tranamt */
	if (GetField_Double(hIn, "psp_txn_amt", &dTmp)) {
		char csTmpAmt[PD_TMP_BUF_LEN +1];
		sprintf(csTmpAmt, "%.2f", dTmp);
		//sprintf((char*)csTmpAmt, "%ld", double2long(dTmp));
		
		strcat((char*)csBuf, "tranamt");
		strcat((char*)csBuf, MY_TTP_FIELD_TOKEN);
		strcat((char*)csBuf, csTmpAmt);
		strcat((char*)csBuf, MY_TTP_TOKEN);
DEBUGLOG(("tranamt = [%s]\n", csTmpAmt));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("***psp_txn_amt is missing!!!\n"));
	}

/* trxtype */ // EC only
	if(iOpt==PD_TRUE && iOpt!=INT_ERR){
		strcat((char*)csBuf, "trxtype");
		strcat((char*)csBuf, MY_TTP_FIELD_TOKEN);
		strcat((char*)csBuf, MY_TTP_TYPE_EC);
		strcat((char*)csBuf, MY_TTP_TOKEN);
DEBUGLOG(("trxtype = [%s]\n", MY_TTP_TYPE_EC));
	}

/* version */
	strcat((char*)csBuf, "version");
	strcat((char*)csBuf, MY_TTP_FIELD_TOKEN);
	strcat((char*)csBuf, MY_TTP_VERSION);
DEBUGLOG(("version = [%s]\n", MY_TTP_VERSION));


	PutField_CString(hIn, "auth_data", csBuf);
DEBUGLOG(("BuildAuthData:: auth_data = [%s]\n", csBuf));
	FREE_ME(csBuf);
        
DEBUGLOG(("BuildAuthData() Exit iRet = [%d]\n", iRet));
        return  iRet;
}




void Insert2KVPair(struct key_value_pair k_v_pair[], int *iPairCnt, const char *inMsg, const char *FD)
{
	char *csTag;
	char *csValue;
	char *csTmp;
	char *p;

	csTmp = (char*) malloc (PD_TMP_MSG_BUF_LEN + 1);
	strcpy(csTmp, inMsg);

	p = strstr(csTmp, FD);
	if (p) {
		if (strlen(p) > strlen(FD)) {
			csTag = (char*) malloc (PD_TMP_MSG_BUF_LEN + 1);
			csValue = strdup(p + 1);
			memcpy(csTag, inMsg, strlen(inMsg) - strlen(p));
			csTag[strlen(inMsg) - strlen(p)] = '\0';
//DEBUGLOG(("Insert2KVPair:: iPairCnt = [%d], Tag = [%s], Value = [%s]\n", *iPairCnt, csTag, csValue));
			strcpy(k_v_pair[*iPairCnt].key, csTag);
			strcpy(k_v_pair[*iPairCnt].value, csValue);
			*iPairCnt = *iPairCnt + 1;
			free(csTag);
			csTag = NULL;
			free(csValue);
			csValue = NULL;
		}
	}
	free(csTmp);
	csTmp = NULL;
}


int Str2KVPair(struct key_value_pair k_v_pair[], int *iPairCnt, const char *inMsg, const char *DL, const char *FD)
{
	char *csBuf;
	char *p;

	int inLen = strlen(inMsg);
	csBuf = (char*) malloc (inLen + 1);
	memcpy(csBuf, inMsg, inLen);
	csBuf[inLen] = '\0';

	p = strtok(csBuf, DL);
	if (p != NULL) {
		if (strlen(p) > 1) {
			if (p[strlen(p) - 1] == 0x0d)
				p[strlen(p) - 1] = '\0';
			else
				p[strlen(p)] = '\0';
			Insert2KVPair(k_v_pair, iPairCnt, p, FD);
		}
	}

	while ((p = strtok(NULL, DL)) != NULL) {
		if (strlen(p) > 1) {
			if (p[strlen(p) - 1] == 0x0d)
				p[strlen(p) - 1] = '\0';
			else
				p[strlen(p)] = '\0';
			Insert2KVPair(k_v_pair, iPairCnt, p, FD);
		}
	}

//DEBUGLOG(("Str2KVPair:: iPairCnt = [%d]\n", *iPairCnt));

	free(csBuf);
	csBuf = NULL;
	return 0;
}


int string_sort_func(const void *a1, const void *b1)
{
	const char *a = (const char *)a1;
	const char *b = (const char *)b1;
	return(strcmp(a, b));
}


int BuildRspAuthData(hash_t *hIn)
{
	int iRet = PD_OK;
	char *csBuf;
	csBuf = (char*) malloc (MAX_MSG_SIZE + 1);

	char *inMsg;
	int iTmp;

	struct key_value_pair k_v_pair[50];
	int iPairCnt = 0;

DEBUGLOG(("BuildRspAuthData()\n"));
	memset(csBuf, 0, MAX_MSG_SIZE);
	csBuf[0] = '\0';

	if (GetField_CString(hIn, "in_msg", &inMsg)) {
		if (Str2KVPair(k_v_pair, &iPairCnt, inMsg, MY_TTP_TOKEN, MY_TTP_FIELD_TOKEN) == PD_OK) {
//DEBUGLOG(("iPairCnt = [%d]\n", iPairCnt));
			qsort(k_v_pair, iPairCnt, sizeof(struct key_value_pair), string_sort_func);
			for (iTmp = 0; iTmp < iPairCnt; iTmp++) {
DEBUGLOG(("key = [%s], value = [%s]\n", k_v_pair[iTmp].key, k_v_pair[iTmp].value));
				// exclude sign
				if (strcmp(k_v_pair[iTmp].key, "sign")) {
					strcat(csBuf, k_v_pair[iTmp].key);
					strcat(csBuf, MY_TTP_FIELD_TOKEN);
					strcat(csBuf, k_v_pair[iTmp].value);
					strcat(csBuf, MY_TTP_TOKEN);
				}
			}
		}
	}

	csBuf[strlen(csBuf) - 1] = '\0';

	PutField_CString(hIn, "auth_data", csBuf);
DEBUGLOG(("BuildRspAuthData:: auth_data = [%s]\n", csBuf));
	FREE_ME(csBuf);

DEBUGLOG(("BuildRspAuthData() Exit iRet = [%d]\n", iRet));
	return iRet;
}
