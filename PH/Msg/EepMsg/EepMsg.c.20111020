/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version					   2011/08/06              Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "EepMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"

char	cDebug;

void	EepMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;
	char*   csTmp = NULL;
	char*   csPtr = NULL;
	char*   csBuf;
	double  dTmp;
	char*   csMethod = NULL;

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

	memset(outMsg,0,sizeof(outMsg));
	if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg here\n"));
		strcat(outMsg,csPtr);
		strcat(outMsg,"?");
		if (GetField_CString(hIn,"fe_url",&csTmp)) {
			strcat((char*)outMsg,"e_url");
			strcat((char*)outMsg,MY_EEP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_EEP_TOKEN);
DEBUGLOG(("FormatMsg:: e_url = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** fe_url is missing\n"));
		}
		if (GetField_CString(hIn,"return_url_only",&csTmp)) {
			strcat((char*)outMsg,"e_backend_url");
			strcat((char*)outMsg,MY_EEP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_EEP_TOKEN);
DEBUGLOG(("FormatMsg:: e_backend_url = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** return_url_only is missing\n"));
		}

		if (GetField_CString(hIn,"txn_seq",&csTmp)) {
			strcat((char*)outMsg,"e_oderno");
			strcat((char*)outMsg,MY_EEP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_EEP_TOKEN);
DEBUGLOG(("FormatMsg:: e_oderno = [%s]\n",csTmp));
		}
		if (GetField_CString(hIn,"psp_merchant_id",&csTmp)) {
			strcat((char*)outMsg,"e_no");
			strcat((char*)outMsg,MY_EEP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_EEP_TOKEN);
DEBUGLOG(("FormatMsg:: e_no = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***psp_merchant_id is missing\n"));
		}
		if (GetField_CString(hIn,"bank_code",&csTmp)) {
			strcat((char*)outMsg,"e_FrpId");
			strcat((char*)outMsg,MY_EEP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_EEP_TOKEN);
DEBUGLOG(("FormatMsg:: e_FrpId = [%s]\n",csTmp));
		}
/* hard code  - requested by esky */
		strcat((char*)outMsg,"e_storename");
		strcat((char*)outMsg,MY_EEP_FIELD_TOKEN);
		strcat((char*)outMsg,MY_EEP_TOKEN);
/* psp txn ccy */
		if (GetField_CString(hIn,"psp_txn_ccy",&csTmp)) {
			char*   csCcyId = NULL;
			if(strncmp(csTmp,"CNY",PD_CCY_ID_LEN)==0)
				csCcyId = strdup("RMB");
			else if(strncmp(csTmp,"TWD",PD_CCY_ID_LEN)==0)
				csCcyId = strdup("NTD");
			else
				csCcyId = strdup(csTmp);
			strcat((char*)outMsg,"e_Cur");
			strcat((char*)outMsg,MY_EEP_FIELD_TOKEN);
			strcat((char*)outMsg,csCcyId);
			strcat((char*)outMsg,MY_EEP_TOKEN);
DEBUGLOG(("FormatMsg:: e_Currency_Type = [%s]\n",csCcyId));
			FREE_ME(csCcyId);
		}

/* gateway type */
/*
		if (GetField_CString(hIn,"gateway_type",&csTmp)) {
			strcat((char*)outMsg,"e_Gateway_Type");
			strcat((char*)outMsg,MY_EEP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_EEP_TOKEN);
DEBUGLOG(("FormatMsg:: e_Gateway_Type = [%s]\n",csTmp));
		}
		else{
			strcat((char*)outMsg,"e_Gateway_Type");
DEBUGLOG(("FormatMsg:: Defualt Gateway Type[01]\n"));
			strcat((char*)outMsg,MY_EEP_FIELD_TOKEN);
			strcat((char*)outMsg,"01");
			strcat((char*)outMsg,MY_EEP_TOKEN);
		}
*/
/* language */
/*
		if (GetField_CString(hIn,"language",&csTmp)) {
			strcat((char*)outMsg,"e_Lang");
			strcat((char*)outMsg,MY_EEP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_EEP_TOKEN);
DEBUGLOG(("FormatMsg:: e_Lang = [%s]\n",csTmp));

		}
*/
/* txn amt */
		if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {

			char    csTmpAmt[PD_TMP_BUF_LEN +1];
			sprintf(csTmpAmt,"%.2f",dTmp);
			strcat((char*)outMsg,"e_money");
			strcat((char*)outMsg,MY_EEP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmpAmt);
			strcat((char*)outMsg,MY_EEP_TOKEN);
DEBUGLOG(("FormatMsg:: e_money = [%s]\n",csTmpAmt));
		}
		else {
DEBUGLOG(("FormatMsg:: psp_txn_amt is missing!!!\n"));
		}

/* sign */
		if (GetField_CString(hIn,"sign",&csTmp)) {
			strcat((char*)outMsg,"str_check");
			strcat((char*)outMsg,MY_EEP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_EEP_TOKEN);
DEBUGLOG(("FormatMsg:: str_check = [%s]\n",csTmp));
		}

/* url_method */
		if (GetField_CString(hIn,"url_method",&csMethod)) {
DEBUGLOG(("FormatMsg:: url_method = [%s]\n",csMethod));
		}
		else 
			csMethod = strdup("");

DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
		base64_encode(outMsg,strlen(outMsg),csBuf,PD_MAX_BUFFER);
DEBUGLOG(("FormatMsg:: after encode\n"));
                outMsg[0] = '\0';
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
                strcat((char*)outMsg,MY_EEP_TOKEN);
		strcat((char*)outMsg,"url_method");
		strcat((char*)outMsg,"=");
		strcat((char*)outMsg,csMethod);
		strcat((char*)outMsg,MY_EEP_TOKEN);
                strcat((char*)outMsg,"ret_status=0");
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));

		*outLen = strlen((const char*)outMsg);
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: Redirct url not found\n"));
	}


DEBUGLOG(("FormatMsg:: normal exit iret =[%d]\n",iRet));
	FREE_ME(csBuf);
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csPtr;
	double   dTmp;
	char	csDateTime[PD_DATETIME_LEN +1];
	char    csTmp[PD_MAX_BUFFER + 1];
	hash_t  *hRec;

        hRec = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hRec,0);

DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));

	if (Str2Cls(hRec,inMsg,MY_EEP_TOKEN, MY_EEP_FIELD_TOKEN) == PD_OK) {

/* str_ok */
		if (GetField_CString(hRec,"str_ok",&csPtr)) {
			PutField_CString(hOut,"status",csPtr);
			if(strncmp(csPtr,"1",1)){
				PutField_CString(hOut,"error_code",csPtr);
			}
DEBUGLOG(("BreakDownMsg:: status = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: status not found\n"));
		}

/* str_no */
		if (GetField_CString(hRec,"str_no",&csPtr)) {
			PutField_CString(hOut,"tid",csPtr);
DEBUGLOG(("BreakDownMsg:: tid = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: tid not found\n"));
		}

/* e_money 
		if (GetField_CString(hRec,"e_money",&csPtr)) {
			PutField_CString(hOut,"e_money",csPtr);
DEBUGLOG(("BreakDownMsg:: e_money = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: e_money not found\n"));
		}
*/

/* e_rate */
		if (GetField_CString(hRec,"e_rate",&csPtr)) {
			PutField_CString(hOut,"rate",csPtr);
DEBUGLOG(("BreakDownMsg:: rate = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: rate not found\n"));
		}

/* e_money */
		if (GetField_CString(hRec,"e_money",&csPtr)) {
			PutField_CString(hOut,"txn_amt",csPtr);
DEBUGLOG(("BreakDownMsg:: txn_amt = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: txn_amt not found\n"));
		}

/* e_oderno */
		if (GetField_CString(hRec,"e_oderno",&csPtr)) {
			PutField_CString(hOut,"txn_seq",csPtr);
DEBUGLOG(("BreakDownMsg:: txn_seq = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: txn_seq not found\n"));
		}

/* e_no */
		if (GetField_CString(hRec,"e_no",&csPtr)) {
			PutField_CString(hOut,"psp_merchant_id",csPtr);
DEBUGLOG(("BreakDownMsg:: psp_merchant_id = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: psp_merchant_id not found\n"));
		}

/* e_date */
		if (GetField_CString(hRec,"e_date",&csPtr)) {
			strcpy(csTmp,TrimAll(csPtr,strlen(csPtr)));
			PutField_CString(hOut,"txn_date",csTmp);
			PutField_CString(hOut,"tm_date",csTmp);
			strcpy(csDateTime,csTmp);
DEBUGLOG(("BreakDownMsg:: txn_date[tm_date] = [%s]\n",csTmp));
		}
		else{
DEBUGLOG(("BreakDownMsg:: txn_date not found\n"));
		}

/* e_time */
		if (GetField_CString(hRec,"e_time",&csPtr)) {
			strcpy(csTmp,TrimAll(csPtr,strlen(csPtr)));
DEBUGLOG(("BreakDownMsg:: time = [%s]\n",csTmp));
			char* pPtr;
			pPtr = strdup(deleteCharacters(csTmp,":"));
			PutField_CString(hOut,"tm_time",pPtr);
DEBUGLOG(("BreakDownMsg:: time = [%s]\n",pPtr));
			FREE_ME(pPtr);
		}
		else{
DEBUGLOG(("BreakDownMsg:: txn_time not found\n"));
		}

/* service_fee */
		if (GetField_CString(hRec,"e_outlay",&csPtr)) {
			sscanf(csPtr,"%lf",&dTmp);
			PutField_Double(hOut,"service_fee",dTmp);
DEBUGLOG(("BreakDownMsg:: service_fee = [%lf]\n",dTmp));
		}
		else{
DEBUGLOG(("BreakDownMsg:: service_fee not found\n"));
		}


/* str_check */
		if (GetField_CString(hRec,"str_check",&csPtr)) {
			PutField_CString(hOut,"sign",csPtr);
DEBUGLOG(("BreakDownMsg:: sign = [%s]\n",csPtr));
		}
		else{
                	PutField_CString(hOut,"sign"," ");
DEBUGLOG(("BreakDownMsg:: sign = [%s]\n"," "));
        	}

/* str_msg */
		if (GetField_CString(hRec,"str_msg",&csPtr)) {
			PutField_CString(hOut,"error_msg",csPtr);
DEBUGLOG(("BreakDownMsg:: error_msg = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: error_msg not found\n"));
		}
	}
	else {
DEBUGLOG(("BreakDownMsg() Error\n"));
                iRet = PD_ERR;
        }
        
        hash_destroy(hRec);
	FREE_ME(hRec);

DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	return iRet;
}


