/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/10/14              Cody Chan
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "MmsMsg.h"
#include "common.h"
#include "utilitys.h"
#include "b64.h"
#include "queue_defs.h"
#include "internal.h"
#include <zlib.h>
#include "ObjPtr.h"

char	cDebug;

OBJPTR(Msg);
OBJPTR(DB);

void	MmsMsg(char cdebug)
{
	cDebug = cdebug;
}


int FormatMultiMsg(const hash_t* hIn,unsigned char *outMsg, const int iCnt);

int FormatMsg(const hash_t* hIn,unsigned char *outMsg, int *outLen)
{
        int     iRet = PD_OK;
        char*   csPtr = NULL;
        char*   csBuf;  
        char	cType;  
        double  dTmp;   
	int	iTmp;
	char    csTmp[PD_TMP_BUF_LEN +1];
                        
DEBUGLOG(("FormatMsg:: ()\n"));
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );
        memset(outMsg,0,sizeof(outMsg));

/* org_txn_seq */
	if (GetField_CString(hIn,"org_txn_seq",&csPtr)) {
DEBUGLOG(("FormatMsg :: org_txn_seq = [%s]\n",csPtr));
		strcat((char*)outMsg,"org_txn_seq");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
       	}
/* org_dtl_txn_seq */
	if (GetField_CString(hIn,"org_dtl_txn_seq",&csPtr)) {
DEBUGLOG(("FormatMsg :: org_dtl_txn_seq = [%s]\n",csPtr));
		strcat((char*)outMsg,"org_dtl_txn_seq");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
       	}
/* process type */
	if (GetField_CString(hIn,"process_type",&csPtr)) {
DEBUGLOG(("FormatMsg :: process_type = [%s]\n",csPtr));
		strcat((char*)outMsg,"process_type");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
       	}
/* proces code */
	if (GetField_CString(hIn,"process_code",&csPtr)) {
DEBUGLOG(("FormatMsg :: process_code = [%s]\n",csPtr));
		strcat((char*)outMsg,"process_code");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
       	}

/* txn_amt */
        if (GetField_Double(hIn,"txn_amt",&dTmp)) {
DEBUGLOG(("FormatMsg:: txn amt = [%f]\n",dTmp));
                sprintf((char*)csBuf,"%ld",double2long(dTmp));
DEBUGLOG(("FormatMsg:: txn amt = [%s]\n",csBuf));
                strcat((char*)outMsg,"txn_amt");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csBuf);
                strcat((char*)outMsg,MY_MMS_TOKEN);
        }
/* txn ccy */
	if (GetField_CString(hIn,"txn_ccy",&csPtr)) {
DEBUGLOG(("FormatMsg :: txn_ccy = [%s]\n",csPtr));
		strcat((char*)outMsg,"ccy");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
       	}

/* txn_id */
	if (GetField_CString(hIn,"txn_id",&csPtr)) {
DEBUGLOG(("FormatMsg :: client_ref = [%s]\n",csPtr));
		strcat((char*)outMsg,"client_ref");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}
	else if (GetField_CString(hIn,"client_ref",&csPtr)) {
DEBUGLOG(("FormatMsg :: client_ref = [%s]\n",csPtr));
                strcat((char*)outMsg,"client_ref");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* host_txn_id */
	if (GetField_CString(hIn,"host_txn_id",&csPtr)) {
DEBUGLOG(("FormatMsg :: host_ref = [%s]\n",csPtr));
		strcat((char*)outMsg,"host_client_ref");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* host_ref */
        if (GetField_CString(hIn,"host_ref",&csPtr)) {
DEBUGLOG(("FormatMsg :: host_ref = [%s]\n",csPtr));
                strcat((char*)outMsg,"host_ref");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
        }

/* host_dtl_ref */
        if (GetField_CString(hIn,"host_dtl_ref",&csPtr)) {
DEBUGLOG(("FormatMsg :: host_dtl_ref = [%s]\n",csPtr));
                strcat((char*)outMsg,"host_dtl_ref");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
        }


/* transmission_datetime */
	if (GetField_CString(hIn,"transmission_datetime",&csPtr)) {
DEBUGLOG(("FormatMsg :: client_txn_date = [%s]\n",csPtr));
		strcat((char*)outMsg,"client_txn_date");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}
/* mmc_node_id */
/*
	if (GetField_CString(hIn,"mmc_node_id",&csPtr)) {
DEBUGLOG(("FormatMsg :: mmc_node_id = [%s]\n",csPtr));
		strcat((char*)outMsg,"mmc_node_id");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}
*/

/* mms_node_id */
	if (GetField_CString(hIn,"mms_node_id",&csPtr)) {
DEBUGLOG(("FormatMsg :: mms_node_id = [%s]\n",csPtr));
		strcat((char*)outMsg,"mms_node_id");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}
/* merchant_id */
	if (GetField_CString(hIn,"merchant_id",&csPtr)) {
DEBUGLOG(("FormatMsg :: merchant_id = [%s]\n",csPtr));
		strcat((char*)outMsg,"merchant_id");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}
/* psp_id */
	if (GetField_CString(hIn,"psp_id",&csPtr)) {
DEBUGLOG(("FormatMsg :: psp_id = [%s]\n",csPtr));
		strcat((char*)outMsg,"psp_id");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* party_id */
	if (GetField_CString(hIn,"party_id",&csPtr)) {
DEBUGLOG(("FormatMsg :: party_id = [%s]\n",csPtr));
		strcat((char*)outMsg,"party_id");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* txn_country */
	if (GetField_CString(hIn,"txn_country",&csPtr)) {
DEBUGLOG(("FormatMsg :: country = [%s]\n",csPtr));
		strcat((char*)outMsg,"country");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* query_type */
	if (GetField_Char(hIn,"query_type",&cType)) {
DEBUGLOG(("FormatMsg :: query_type = [%c]\n",cType));
		sprintf(csTmp,"%c",cType);
		strcat((char*)outMsg,"query_type");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csTmp);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}
/* business_type */
	if (GetField_Char(hIn,"business_type",&cType)) {
DEBUGLOG(("FormatMsg :: business_type = [%c]\n",cType));
		sprintf(csTmp,"%c",cType);
		strcat((char*)outMsg,"business_type");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csTmp);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* party_type */
	if (GetField_CString(hIn,"party_type",&csPtr)) {
DEBUGLOG(("FormatMsg :: party_type = [%s]\n",csPtr));
		strcat((char*)outMsg,"party_type");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* refresh_interval */
	if (GetField_Int(hIn,"refresh_interval",&iTmp)) {
DEBUGLOG(("FormatMsg :: refresh_interval = [%d]\n",iTmp));
		sprintf(csTmp,"%d",iTmp);
		strcat((char*)outMsg,"refresh_interval");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csTmp);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* max_rtn */
	if (GetField_Int(hIn,"max_rtn",&iTmp)) {
DEBUGLOG(("FormatMsg :: max_rtn = [%d]\n",iTmp));
		sprintf(csTmp,"%d",iTmp);
		strcat((char*)outMsg,"max_rtn");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csTmp);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* last_id */
	if (GetField_CString(hIn,"last_id",&csPtr)) {
DEBUGLOG(("FormatMsg :: last_id = [%s]\n",csPtr));
		strcat((char*)outMsg,"last_id");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* enctype */
	if (GetField_CString(hIn,"encrypt_type",&csPtr)) {
DEBUGLOG(("FormatMsg :: enctype = [%s]\n",csPtr));
		strcat((char*)outMsg,"enctype");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* verno */
	if (GetField_CString(hIn,"version_no",&csPtr)) {
DEBUGLOG(("FormatMsg :: verno = [%s]\n",csPtr));
		strcat((char*)outMsg,"verno");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* signature */
	if (GetField_CString(hIn,"mac",&csPtr)) {
DEBUGLOG(("FormatMsg :: mac = [%s]\n",csPtr));
		strcat((char*)outMsg,"signature");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* remark */
	if (GetField_CString(hIn,"remark",&csPtr)) {
DEBUGLOG(("FormatMsg :: remark = [%s]\n",csPtr));
		strcat((char*)outMsg,"remark");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}
/* service_code */
	if (GetField_CString(hIn,"service_code",&csPtr)) {
DEBUGLOG(("FormatMsg :: service_code = [%s]\n",csPtr));
		strcat((char*)outMsg,"service_code");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* end_ind */
        if (GetField_Int(hIn,"end_ind",&iTmp)) {
DEBUGLOG(("FormatMsg end_ind = [%d]\n",iTmp));
		sprintf(csTmp,"%d",iTmp);
		strcat((char*)outMsg,"end_ind");
		strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
		strcat((char*)outMsg,csTmp);
		strcat((char*)outMsg,MY_MMS_TOKEN);
	}

/* isd_ind */
/*
        if (GetField_Char(hIn,"isd_ind",&cType)) {
DEBUGLOG(("FormatMsg :: isd_ind = [%c]\n",cType));
                sprintf(csTmp,"%c",cType);
                strcat((char*)outMsg,"isd_ind");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csTmp);
                strcat((char*)outMsg,MY_MMS_TOKEN);
        }
*/

/* user */
        if (GetField_CString(hIn,"add_user",&csPtr)) {
DEBUGLOG(("FormatMsg :: user = [%s]\n",csPtr));
                strcat((char*)outMsg,"user");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
        }

/* processing_cost*/
        if (GetField_Double(hIn,"processing_cost",&dTmp)) {
DEBUGLOG(("FormatMsg:: processing_cost = [%f]\n",dTmp));
                sprintf((char*)csBuf,"%ld",double2long(dTmp));
DEBUGLOG(("FormatMsg:: processing_cost = [%s]\n",csBuf));
                strcat((char*)outMsg,"pc_amt");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csBuf);
                strcat((char*)outMsg,MY_MMS_TOKEN);
        }

/* bank_charge*/
        if (GetField_Double(hIn,"bank_charge",&dTmp)) {
DEBUGLOG(("FormatMsg:: bank_charge = [%f]\n",dTmp));
                sprintf((char*)csBuf,"%ld",double2long(dTmp));
DEBUGLOG(("FormatMsg:: bank_charge = [%s]\n",csBuf));
                strcat((char*)outMsg,"bk_chrg");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csBuf);
                strcat((char*)outMsg,MY_MMS_TOKEN);
        }

/* cal_amt_ind */
        if (GetField_Char(hIn,"cal_amt_ind",&cType)) {
DEBUGLOG(("FormatMsg :: cal_amt_ind = [%c]\n",cType));
                sprintf(csTmp,"%c",cType);
                strcat((char*)outMsg,"cal_amt_ind");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csTmp);
                strcat((char*)outMsg,MY_MMS_TOKEN);
        }

/* init_channel*/
        if (GetField_CString(hIn,"init_channel",&csPtr)) {
DEBUGLOG(("FormatMsg :: user = [%s]\n",csPtr));
                strcat((char*)outMsg,"init_channel");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_MMS_TOKEN);
        }

/* carry_forward_ind */
        if (GetField_Int(hIn,"cf_ind",&iTmp)) {
DEBUGLOG(("FormatMsg :: carry_forward_ind = [%d]\n",iTmp));
                sprintf(csTmp,"%d",iTmp);
                strcat((char*)outMsg,"cf_ind");
                strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
                strcat((char*)outMsg,csTmp);
                strcat((char*)outMsg,MY_MMS_TOKEN);
        }


/* total_cnt */
        if (GetField_Int(hIn,"total_cnt",&iTmp)) {
DEBUGLOG(("FormatMsg total_cnt = [%d]\n",iTmp));
		sprintf(csTmp,"%d",iTmp);
		strcat((char*)outMsg,"total_cnt");
		strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
		strcat((char*)outMsg,csTmp);
		strcat((char*)outMsg,MY_MMS_TOKEN);

		FormatMultiMsg(hIn,outMsg,iTmp);
	}


	*outLen = strlen((const char*)outMsg);
DEBUGLOG(("FormatMsg:: formated = [%s]\n",outMsg));

DEBUGLOG(("FormatMsg:: normal exit iret =[%d]\n",iRet));
        FREE_ME(csBuf);
        return  iRet;
}


int FormatMultiMsg(const hash_t* hIn,unsigned char *outMsg, const int iCnt)
{
	int iRet = PD_OK;
	int i;
	char*   csPtr;
	char    csTag[PD_TAG_LEN +1];

	for(i=1;i<=iCnt;i++){
		sprintf(csTag,"party_id_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
                        sprintf(csTag,"id_%d",i);
DEBUGLOG(("FormatMultiMsg :: [%s] = [%s]\n",csTag,csPtr));
			strcat((char*)outMsg,csTag);
			strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_MMS_TOKEN);
		}

		sprintf(csTag,"party_type_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
                        sprintf(csTag,"type_%d",i);
DEBUGLOG(("FormatMultiMsg :: [%s] = [%s]\n",csTag,csPtr));
			strcat((char*)outMsg,csTag);
			strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_MMS_TOKEN);
		}

		sprintf(csTag,"party_name_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
                        sprintf(csTag,"name_%d",i);
DEBUGLOG(("FormatMultiMsg :: [%s] = [%s]\n",csTag,csPtr));
			strcat((char*)outMsg,csTag);
			strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_MMS_TOKEN);
		}

		sprintf(csTag,"business_type_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
                        sprintf(csTag,"btype_%d",i);
DEBUGLOG(("FormatMultiMsg :: [%s] = [%s]\n",csTag,csPtr));
			strcat((char*)outMsg,csTag);
			strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_MMS_TOKEN);
		}

		sprintf(csTag,"mms_node_id_%d",i);
                if (GetField_CString(hIn,csTag,&csPtr)) {
                        sprintf(csTag,"mms_node_%d",i);
DEBUGLOG(("FormatMultiMsg :: [%s] = [%s]\n",csTag,csPtr));
			strcat((char*)outMsg,csTag);
			strcat((char*)outMsg,MY_MMS_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_MMS_TOKEN);
		}

	}

DEBUGLOG(("FormatMultiMsg:: normal exit iret =[%d]\n",iRet));
	return  iRet;
}


int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
        int     iRet = PD_OK;
        char    *csPtr;
	char	c;
       // double   dTmp;
        //char    csTmp[PD_MAX_BUFFER + 1];
        hash_t  *hRec;
	int	iTmp;

        hRec = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hRec,0);

DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));

        if (Str2Cls(hRec,(const char *)inMsg,MY_MMS_TOKEN, MY_MMS_FIELD_TOKEN) == PD_OK) {

/* org_txn_seq */
		if (GetField_CString(hRec,"org_txn_seq",&csPtr)) {
               		PutField_CString(hOut,"org_txn_seq",csPtr);
DEBUGLOG(("BreakDownMsg:: org_txn_seq = [%s]\n",csPtr));
                }       

/* org_dtl_txn_seq */
		if (GetField_CString(hRec,"org_dtl_txn_seq",&csPtr)) {
               		PutField_CString(hOut,"org_dtl_txn_seq",csPtr);
DEBUGLOG(("BreakDownMsg:: org_dtl_txn_seq = [%s]\n",csPtr));
                }       

/* process type */
		if (GetField_CString(hRec,"process_type",&csPtr)) {
               		PutField_CString(hOut,"process_type",csPtr);
DEBUGLOG(("BreakDownMsg:: process_type = [%s]\n",csPtr));
                }       

/* process code */
		if (GetField_CString(hRec,"process_code",&csPtr)) {
               		PutField_CString(hOut,"process_code",csPtr);
DEBUGLOG(("BreakDownMsg:: process_code = [%s]\n",csPtr));
                }       

/* txn_amt */
		if (GetField_CString(hRec,"txn_amt",&csPtr)) {
               		PutField_CString(hOut,"txn_amt",csPtr);
DEBUGLOG(("BreakDownMsg:: txn_amt = [%s]\n",csPtr));
                }       
/* txn ccy */
		if (GetField_CString(hRec,"ccy",&csPtr)) {
               		PutField_CString(hOut,"txn_ccy",csPtr);
DEBUGLOG(("BreakDownMsg:: txn_ccy = [%s]\n",csPtr));
                }       
/* status */
		if (GetField_CString(hRec,"status",&csPtr)) {
               		PutField_CString(hOut,"status",csPtr);
DEBUGLOG(("BreakDownMsg:: status = [%s]\n",csPtr));
                }       
/* host_ref */
		if (GetField_CString(hRec,"host_ref",&csPtr)) {
               		PutField_CString(hOut,"host_ref",csPtr);
DEBUGLOG(("BreakDownMsg:: host_ref = [%s]\n",csPtr));
                }       
/* host_dtl_ref */
		if (GetField_CString(hRec,"host_dtl_ref",&csPtr)) {
               		PutField_CString(hOut,"host_dtl_ref",csPtr);
DEBUGLOG(("BreakDownMsg:: host_dtl_ref = [%s]\n",csPtr));
                }       
/* client_ref */
		if (GetField_CString(hRec,"client_ref",&csPtr)) {
               		PutField_CString(hOut,"client_ref",csPtr);
DEBUGLOG(("BreakDownMsg:: client_ref = [%s]\n",csPtr));
                }       
/* host_txn_date */
		if (GetField_CString(hRec,"host_txn_date",&csPtr)) {
               		PutField_CString(hOut,"host_transmission_datetime",csPtr);
DEBUGLOG(("BreakDownMsg:: host_transmission_datetime = [%s]\n",csPtr));
                }       
/* client_txn_date */
		if (GetField_CString(hRec,"client_txn_date",&csPtr)) {
               		PutField_CString(hOut,"transmission_datetime",csPtr);
DEBUGLOG(("BreakDownMsg:: transmission_datetime = [%s]\n",csPtr));
			char	csTmp[PD_DATETIME_LEN +1];
			memcpy(csTmp,csPtr,PD_DATE_LEN);
                        csTmp[PD_DATE_LEN] = '\0';
                        PutField_CString(hOut,"tm_date",csTmp);
DEBUGLOG(("BreakDownMsg: tm_date = [%s]\n",csTmp));
                        memcpy(csTmp,&csPtr[PD_DATE_LEN],PD_TIME_LEN);
                        csTmp[PD_TIME_LEN] = '\0';
                        PutField_CString(hOut,"tm_time",csTmp);
DEBUGLOG(("BreakDownMsg: tm_time = [%s]\n",csTmp));
                }       
/* mms_node_id */
		if (GetField_CString(hRec,"mms_node_id",&csPtr)) {
               		PutField_CString(hOut,"mms_node_id",csPtr);
DEBUGLOG(("BreakDownMsg:: mms_node_id = [%s]\n",csPtr));
                }       
/* merchant_id */
		if (GetField_CString(hRec,"merchant_id",&csPtr)) {
               		PutField_CString(hOut,"merchant_id",csPtr);
DEBUGLOG(("BreakDownMsg:: merchant_id = [%s]\n",csPtr));
                }       
/* psp_id */
		if (GetField_CString(hRec,"psp_id",&csPtr)) {
               		PutField_CString(hOut,"psp_id",csPtr);
DEBUGLOG(("BreakDownMsg:: psp_id = [%s]\n",csPtr));
                }       
/* party_id */
		if (GetField_CString(hRec,"party_id",&csPtr)) {
               		PutField_CString(hOut,"party_id",csPtr);
DEBUGLOG(("BreakDownMsg:: party_id = [%s]\n",csPtr));
                }       
/* txn_country */
		if (GetField_CString(hRec,"country",&csPtr)) {
               		PutField_CString(hOut,"country",csPtr);
DEBUGLOG(("BreakDownMsg:: country = [%s]\n",csPtr));
                }       
/* signature */
		if (GetField_CString(hRec,"signature",&csPtr)) {
               		PutField_CString(hOut,"mac",csPtr);
DEBUGLOG(("BreakDownMsg:: mac = [%s]\n",csPtr));
                }       
/* remark */
		if (GetField_CString(hRec,"remark",&csPtr)) {
               		PutField_CString(hOut,"remark",csPtr);
DEBUGLOG(("BreakDownMsg:: remark = [%s]\n",csPtr));
                }       
/* encrypt_type */
		if (GetField_CString(hRec,"enctype",&csPtr)) {
               		PutField_CString(hOut,"encrypt_type",csPtr);
DEBUGLOG(("BreakDownMsg:: encrypt_type = [%s]\n",csPtr));
                }       
/* query_type */
		if (GetField_CString(hRec,"query_type",&csPtr)) {
			c = csPtr[0];
               		PutField_Char(hOut,"query_type",c);
DEBUGLOG(("BreakDownMsg:: query_type = [%c]\n",c));
                }       
/* business_type */
		if (GetField_CString(hRec,"business_type",&csPtr)) {
			c = csPtr[0];
               		PutField_Char(hOut,"business_type",c);
DEBUGLOG(("BreakDownMsg:: business_type = [%c]\n",c));
                }       
/* party_type */
		if (GetField_CString(hRec,"party_type",&csPtr)) {
               		PutField_CString(hOut,"party_type",csPtr);
DEBUGLOG(("BreakDownMsg:: party_type = [%s]\n",csPtr));
                }       
/* verno */
		if (GetField_CString(hRec,"verno",&csPtr)) {
               		PutField_CString(hOut,"version_no",csPtr);
DEBUGLOG(("BreakDownMsg:: version_no = [%s]\n",csPtr));
                }       
/* service_code */
		if (GetField_CString(hRec,"service_code",&csPtr)) {
               		PutField_CString(hOut,"service_code",csPtr);
DEBUGLOG(("BreakDownMsg:: service_code = [%s]\n",csPtr));
                }       
/*refresh_interval*/
		if (GetField_CString(hRec,"refresh_interval",&csPtr)) {
			iTmp = atoi(csPtr);
               		PutField_Int(hOut,"refresh_interval",iTmp);
DEBUGLOG(("BreakDownMsg:: refresh_interval = [%d]\n",iTmp));
                }       
/* last_id */
		if (GetField_CString(hRec,"last_id",&csPtr)) {
               		PutField_CString(hOut,"last_id",csPtr);
DEBUGLOG(("BreakDownMsg:: last_id = [%s]\n",csPtr));
                }       
/*max_rtn*/
		if (GetField_CString(hRec,"max_rtn",&csPtr)) {
			iTmp = atoi(csPtr);
               		PutField_Int(hOut,"max_rtn",iTmp);
DEBUGLOG(("BreakDownMsg:: max_rtn = [%d]\n",iTmp));
                }       

/*isd_ind */
/*
		if (GetField_CString(hRec,"isd_ind",&csPtr)) {
			c = csPtr[0];
               		PutField_Char(hOut,"isd_ind",c);
DEBUGLOG(("BreakDownMsg:: isd_ind = [%c]\n",c));
		}
*/

/* user */
		if (GetField_CString(hRec,"user",&csPtr)) {
               		PutField_CString(hOut,"add_user",csPtr);
DEBUGLOG(("BreakDownMsg:: add_user = [%s]\n",csPtr));
                }       

/* processing_cost */
                if (GetField_CString(hRec,"pc_amt",&csPtr)) {
                        PutField_CString(hOut,"pc_amt",csPtr);
DEBUGLOG(("BreakDownMsg:: pc_amt = [%s]\n",csPtr));
                }	

/* bk_chrg*/
                if (GetField_CString(hRec,"bk_chrg",&csPtr)) {
                        PutField_CString(hOut,"bk_chrg",csPtr);
DEBUGLOG(("BreakDownMsg:: bk_chrg = [%s]\n",csPtr));
                }	

/*cal_amt_ind */
                if (GetField_CString(hRec,"cal_amt_ind",&csPtr)) {
                        c = csPtr[0];
                        PutField_Char(hOut,"cal_amt_ind",c);
DEBUGLOG(("BreakDownMsg:: cal_amt_ind = [%c]\n",c));
		}

/*init_channel */
		if (GetField_CString(hRec, "init_channel", &csPtr)) {
               		PutField_CString(hOut,"init_channel",csPtr);
DEBUGLOG(("BreakDownMsg:: init_channel = [%s]\n",csPtr));
		}

/* cf_ind */
		if (GetField_CString(hRec,"cf_ind",&csPtr)) {
			iTmp = atoi(csPtr);
               		PutField_Int(hOut,"carry_forward_ind",iTmp);
DEBUGLOG(("BreakDownMsg:: carry_forward_ind = [%d]\n",iTmp));
                }       


		iRet = BuildAuthData(hOut);
	}
        else {
DEBUGLOG(("BreakDownMsg() Error\n"));
                iRet = PD_ERR;
        }
        
        hash_destroy(hRec);
        FREE_ME(hRec);

DEBUGLOG(("BreakDownMsg Exit\n"));
        return  iRet;

}

int BreakDownNodeMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
        int     iRet = PD_OK;
        int     i,iTmp;
        char    *csPtr;
        char    csTag[PD_TAG_LEN +1];
        hash_t  *hRec;

        hRec = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hRec,0);

DEBUGLOG(("BreakDownNodeMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));

        if (Str2Cls(hRec,(const char *)inMsg,MY_MMS_TOKEN, MY_MMS_FIELD_TOKEN) == PD_OK) {

/* org_txn_seq */
                if (GetField_CString(hRec,"org_txn_seq",&csPtr)) {
                        PutField_CString(hOut,"org_txn_seq",csPtr);
DEBUGLOG(("BreakDownNodeMsg:: org_txn_seq = [%s]\n",csPtr));
                }

/* org_dtl_txn_seq */
                if (GetField_CString(hRec,"org_dtl_txn_seq",&csPtr)) {
                        PutField_CString(hOut,"org_dtl_txn_seq",csPtr);
DEBUGLOG(("BreakDownNodeMsg:: org_dtl_txn_seq = [%s]\n",csPtr));
                }


/* total_cnt */
                if (GetField_CString(hRec,"total_cnt",&csPtr)) {
                        iTmp = atoi(csPtr);
                        PutField_Int(hOut,"total_cnt",iTmp);
DEBUGLOG(("BreakDownNodeMsg:: total_cnt = [%d]\n",iTmp));
                }

                for(i=1; i<=iTmp;i++){
/*party id*/
                        sprintf(csTag,"id_%d",i);
                        if (GetField_CString(hRec,csTag,&csPtr)) {
                                sprintf(csTag,"party_id_%d",i);
                                PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownNodeMsg:: party_id = [%s]\n",csPtr));
                        }

/*party name*/
                        sprintf(csTag,"name_%d",i);
                        if (GetField_CString(hRec,csTag,&csPtr)) {
                                sprintf(csTag,"party_name_%d",i);
                                PutField_CString(hOut,csTag,csPtr);
DEBUGLOG(("BreakDownNodeMsg:: party_name = [%s]\n",csPtr));
                        }

                }

        }
        else {
DEBUGLOG(("BreakDownNodeMsg() Error\n"));
                iRet = PD_ERR;
        }

        hash_destroy(hRec);
        FREE_ME(hRec);

DEBUGLOG(("BreakDownNodeMsg Exit\n"));
        return  iRet;

}


int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int     iRet = PD_OK;

        char    *csPtr = NULL;
DEBUGLOG(("initReplyFromRequest()\n"));


/* process_code */
        if (GetField_CString(hRequest,"process_code",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: process_code = [%s]\n",csPtr));
                PutField_CString(hResponse,"process_code",csPtr);
        }
/* client_ref */
        if (GetField_CString(hRequest,"client_ref",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: client_ref = [%s]\n",csPtr));
                PutField_CString(hResponse,"client_ref",csPtr);
        }

/* mms_node_id */
        if (GetField_CString(hRequest,"mms_node_id",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: mms_node_id = [%s]\n",csPtr));
                PutField_CString(hResponse,"mms_node_id",csPtr);
        }

/* host_ref */
	if (GetField_CString(hRequest, "host_ref", &csPtr)) {
DEBUGLOG(("initReplyFromRequest: host_ref = [%s]\n",csPtr));
                PutField_CString(hResponse,"host_ref",csPtr);
	}

/* host_dtl_ref */
	if (GetField_CString(hRequest, "host_dtl_ref", &csPtr)) {
DEBUGLOG(("initReplyFromRequest: host_dtl_ref = [%s]\n",csPtr));
                PutField_CString(hResponse,"host_dtl_ref",csPtr);
	}


DEBUGLOG(("initReplyFromRequest() Exit\n"));
        return iRet;

}

int DeBlockBounceBackData(hash_t *hOut,const char* inMsg, const int inLen)
{
	int	iRet = PD_OK;
DEBUGLOG(("DeBlockBounceBackDATA ()\n"));

DEBUGLOG(("DeBlockBounceBackData Exit = [%d]\n",iRet));
        return iRet;
}
int BuildAuthData(hash_t* hIn)
{
	
        int     iRet = PD_OK;
        char    *csVal;
        char    *csData;
	char    csTmp[PD_MAX_BUFFER + 1];
	double	dTmp;
        
        csData = (char*) malloc (PD_TMP_BUF_LEN +1);
        csData[0] = '\0';


/* status */
        if (GetField_CString(hIn,"status",&csVal)) {
DEBUGLOG(("BuildAuthData[str_ok] = [%s]\n",csVal));
                strcat(csData,csVal);
        }
/* txn amt */
	 if (GetField_Double(hIn,"txn_amt",&dTmp)) {
DEBUGLOG(("BuildAuthData() txn_amt= [%f]\n",dTmp));
             sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatMsg:: txn amt = [%s]\n",csTmp));
             strcat((char*)csData,(char*)csTmp);
        }
	else if (GetField_CString(hIn,"txn_amt",&csVal)) {
DEBUGLOG(("BuildAuthData txn_amt = [%s]\n",csVal));
                strcat(csData,csVal);
	}
/* txn ccy */
        if (GetField_CString(hIn,"txn_ccy",&csVal)) {
DEBUGLOG(("BuildAuthData txn_ccy = [%s]\n",csVal));
                strcat(csData,csVal);
        }
/* host_ref */
        if (GetField_CString(hIn,"host_ref",&csVal)) {
DEBUGLOG(("BuildAuthData host_ref = [%s]\n",csVal));
                strcat(csData,csVal);
        }

/* host_dtl_ref */
        if (GetField_CString(hIn,"host_dtl_ref",&csVal)) {
DEBUGLOG(("BuildAuthData host_dtl_ref = [%s]\n",csVal));
                strcat(csData,csVal);
        }

/* client_ref */
        if (GetField_CString(hIn,"txn_id",&csVal)) {
DEBUGLOG(("BuildAuthData client_ref = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        else if (GetField_CString(hIn,"client_ref",&csVal)) {
DEBUGLOG(("BuildAuthData client_ref = [%s]\n",csVal));
                strcat(csData,csVal);
	}
/* mms_node_id */
        if (GetField_CString(hIn,"mms_node_id",&csVal)) {
DEBUGLOG(("BuildAuthData mms_node_id = [%s]\n",csVal));
                strcat(csData,csVal);
        }

/* merchant_id */
        if (GetField_CString(hIn,"merchant_id",&csVal)) {
DEBUGLOG(("BuildAuthData merchant_id = [%s]\n",csVal));
                strcat(csData,csVal);
        }
/* psp_id */
        if (GetField_CString(hIn,"psp_id",&csVal)) {
DEBUGLOG(("BuildAuthData psp_id = [%s]\n",csVal));
                strcat(csData,csVal);
        }

/* client txn date */
        if (GetField_CString(hIn,"transmission_datetime",&csVal)) {
DEBUGLOG(("BuildAuthData transmission_datetime = [%s]\n",csVal));
                strcat(csData,csVal);
        }

/* host txn date */
        if (GetField_CString(hIn,"host_tm_datetime",&csVal)) {
DEBUGLOG(("BuildAuthData host_tm_datetime = [%s]\n",csVal));
                strcat(csData,csVal);
        }

DEBUGLOG(("BuildAuthData = [%s]\n",csData));
        PutField_CString(hIn,"auth_data",csData);
        
        FREE_ME(csData);
        return iRet;
	
}

