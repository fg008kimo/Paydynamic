#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "TwvMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"
#include "internal.h"

char	cDebug;

void	TwvMsg(char cdebug)
{
	cDebug = cdebug;
}

int ParseField(hash_t *hOut,const char* inMsg);

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;

	char*	csTxnCode = NULL;
	char*	csPtr = NULL;
	char*	csURL = NULL;
	char	csTmp[PD_TMP_BUF_LEN + 1];
	char* 	csBuf;
	double	dTmp;
	long	lTmp;


	//double	dTmp;
DEBUGLOG(("FormatMsg()\n"));

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );
//txn code
	if (GetField_CString(hIn,"txn_code",&csTxnCode)) {
DEBUGLOG(("FormatMsg:: txn_code = [%s]\n",csTxnCode));
	}

	outMsg[0]= '\0';
DEBUGLOG(("outmsg = [%s]\n",outMsg));
//psp_url
	if (GetField_CString(hIn,"psp_url",&csURL)) {
//request_function
		if (GetField_CString(hIn,"txn_code",&csPtr)) {
			strcpy((char*)csBuf,"TC");
			strcat((char*)csBuf,MY_TWV_FIELD_TOKEN);
			strcat((char*)csBuf,csPtr);
			strcat((char*)csBuf,MY_TWV_TOKEN);
		}
		if (GetField_CString(hIn,"request_function",&csPtr)) {
			strcat((char*)csBuf,"url");
DEBUGLOG(("FormatMsg:: psp_url = [%s]\n",csURL));
			strcat((char*)csBuf,MY_TWV_FIELD_TOKEN);
			strcat((char*)csBuf,csURL);
			strcat((char*)csBuf,"/");
			strcat((char*)csBuf,csPtr);
			strcat((char*)csBuf,MY_TWV_TOKEN);
		}	
	

//action
		if (GetField_CString(hIn,"action",&csPtr)) {
				strcat((char*)csBuf,"action");
DEBUGLOG(("FormatMsg:: action = [%s]\n",csPtr));
				strcat((char*)csBuf,MY_TWV_FIELD_TOKEN);
				strcat((char*)csBuf,csURL);
				strcat((char*)csBuf,"/");
				strcat((char*)csBuf,csPtr);
		}	
		sprintf(outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));
		strcat(outMsg,csBuf);
	}
	FREE_ME(csBuf);
//access_key
	if (GetField_CString(hIn,"access_key",&csPtr)) {
DEBUGLOG(("FormatMsg:: access_key = [%s]\n",csPtr));
		strcat((char*)outMsg,"access_key");

		strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TWV_TOKEN);
	}	
//order_num
	if (GetField_CString(hIn,"order_num",&csPtr)) {
DEBUGLOG(("FormatMsg:: order_num = [%s]\n",csPtr));
		strcat((char*)outMsg,"order_num");

		strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TWV_TOKEN);
	}	
//amount
	if (GetField_Double(hIn,"txn_amt",&dTmp)) {
		lTmp = (long) dTmp;
		sprintf(csTmp,"%ld",lTmp);
DEBUGLOG(("FormatMsg:: amount = [%ld]\n",lTmp));
		strcat((char*)outMsg,"amount");

		strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
		strcat((char*)outMsg,csTmp);
		strcat((char*)outMsg,MY_TWV_TOKEN);

	}
/* DSP txn */
	if (!strcmp(csTxnCode,PD_DEPOSIT_TXN_CODE)) {
//description
		if (GetField_CString(hIn,"txn_desc",&csPtr)) {
DEBUGLOG(("FormatMsg:: description = [%s]\n",csPtr));
			strcat((char*)outMsg,"description");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}	
//return_url
		if (GetField_CString(hIn,"fe_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: return_url = [%s]\n",csPtr));
			strcat((char*)outMsg,"return_url");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}	
		else {
DEBUGLOG(("FormatMsg:: fe_url not found!!!\n"));
		}
	}
	else if (!strcmp(csTxnCode,PD_WITHDRAW_TXN_CODE) || !strcmp(csTxnCode,PD_WITHDRAW_BATCH_TXN_CODE)) {
//bank_code
		if (GetField_CString(hIn,"bank_code",&csPtr)) {
DEBUGLOG(("FormatMsg:: bank_code = [%s]\n",csPtr));
			strcat((char*)outMsg,"bank_code");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}	
//branch_name
		if (GetField_CString(hIn,"branch_name",&csPtr)) {
DEBUGLOG(("FormatMsg:: branch_name = [%s]\n",csPtr));
			strcat((char*)outMsg,"branch_name");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}

//account_id
		if (GetField_CString(hIn,"account_id",&csPtr)) {
DEBUGLOG(("FormatMsg:: account_id = [%s]\n",csPtr));
			strcat((char*)outMsg,"account_id");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}
//account_name
		if (GetField_CString(hIn,"account_name",&csPtr)) {
DEBUGLOG(("FormatMsg:: account_name = [%s]\n",csPtr));
			strcat((char*)outMsg,"account_name");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}
//identity_id
		if (GetField_CString(hIn,"identity_id",&csPtr)) {
DEBUGLOG(("FormatMsg:: identity_id = [%s]\n",csPtr));
			strcat((char*)outMsg,"identity_id");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}
	}


DEBUGLOG(("outmsg = [%s]\n",outMsg));

	*outLen = strlen(outMsg);
DEBUGLOG(("FormatMsg() [%s][%d]\n",outMsg,*outLen));
DEBUGLOG(("FormatMsg() Exit\n"));
	FREE_ME(csTxnCode);
	FREE_ME(csPtr);
	FREE_ME(csURL);
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csBuf;
	char	*p;
	double	 dTmp;

	csBuf = (char*) malloc (1024 +1);

	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';
DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s]\n",inMsg));

	
/* tid */
	p = GetField(csBuf,"tid",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"tid",p);
DEBUGLOG(("BreakDownMsg:: tid = [%s]\n",p));
	}
/* txn_date */
	p = GetField(csBuf,"req_time",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"txn_date",p);
DEBUGLOG(("BreakDownMsg:: txn_date = [%s]\n",p));
	}
/* access_key */
	p = GetField(csBuf,"access_key",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"access_key",p);
DEBUGLOG(("BreakDownMsg:: access_key = [%s]\n",p));
	}
/* order_num */
	p = GetField(csBuf,"order_num",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"txn_seq",p);
DEBUGLOG(("BreakDownMsg:: txn_seq[order_num] = [%s]\n",p));
	}
/* status */
	p = GetField(csBuf,"status",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"status",p);
DEBUGLOG(("BreakDownMsg:: status = [%s]\n",p));
	}
/* error_code */
	p = GetField(csBuf,"error_code",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"error_code",p);
DEBUGLOG(("BreakDownMsg:: error_code = [%s]\n",p));
	}
/* deposit_url */
	p = GetField(csBuf,"deposit_url",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"deposit_url",p);
DEBUGLOG(("BreakDownMsg:: deposit_url = [%s]\n",p));
	}
/* amount */
	p = GetField(csBuf,"amount",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"txn_amt",p);
DEBUGLOG(("BreakDownMsg:: txn_amt = [%s]\n",p));
	}

/* bank_code */
	p = GetField(csBuf,"bank_code",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"bank_code",p);
DEBUGLOG(("BreakDownMsg:: bank_code = [%s]\n",p));
	}
/* bank_branch */
	p = GetField(csBuf,"bank_branch",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"bank_branch",p);
DEBUGLOG(("BreakDownMsg:: bank_branch = [%s]\n",p));
	}
/* acct_name */
	p = GetField(csBuf,"account_name",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"account_name",p);
DEBUGLOG(("BreakDownMsg:: account_name = [%s]\n",p));
	}
/* acct_no */
	p = GetField(csBuf,"account_no",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"account_no",p);
DEBUGLOG(("BreakDownMsg:: account_no = [%s]\n",p));
	}
/* own_id */
	p = GetField(csBuf,"own_id",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"own_id",p);
DEBUGLOG(("BreakDownMsg:: own_id = [%s]\n",p));
	}
/* description */
	p = GetField(csBuf,"description",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"description",p);
DEBUGLOG(("BreakDownMsg:: description = [%s]\n",p));
	}
/* batch_id */
	p = GetField(csBuf,"batch_id",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"batch_id",p);
DEBUGLOG(("BreakDownMsg:: batch_id = [%s]\n",p));
	}
/* fundin_date */
	p = GetField(csBuf,"fundin_date",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"fundin_date",p);
DEBUGLOG(("BreakDownMsg:: fundin_date = [%s]\n",p));
	}
/* fundout_date */
	p = GetField(csBuf,"fundout_date",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"fundout_date",p);
DEBUGLOG(("BreakDownMsg:: fundout_date = [%s]\n",p));
	}
/* service_fee */
	p = GetField(csBuf,"service_fee",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		dTmp = ctod(p,strlen(p),0);
		//dTmp = myctod(p,strlen(p) - PD_DECIMAL_LEN,PD_DECIMAL_LEN);
		PutField_Double(hOut,"service_fee",dTmp);
DEBUGLOG(("BreakDownMsg:: service_fee = [%f]\n",dTmp));
	}
/* FERESP */
	p = GetField(csBuf,"FERESP",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_Char(hOut,"FERESP",p[0]);
DEBUGLOG(("BreakDownMsg:: FERESP = [%c]\n",p[0]));
	}

	FREE_ME(csBuf);
DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	char	*csTmp = NULL;
DEBUGLOG(("initReplyFromRequest()\n"));
	

/* order_num */
        if (GetField_CString(hRequest,"merchant_ref",&csTmp)) {
DEBUGLOG(("initReplyFromRequest: order_num = [%s]\n",csTmp));
                PutField_CString(hResponse,"order_num",csTmp);
        }


DEBUGLOG(("initReplyFromRequest() Exit\n"));
	FREE_ME(csTmp);
	return iRet;
}

int FormatBatchMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;

	char*	csTxnCode = NULL;
	char*	csPtr = NULL;
	char*	csURL = NULL;
	char	csTmp[PD_TMP_BUF_LEN + 1];
	char* 	csBuf;
	char	csTag[PD_TAG_LEN +1];

	double	dTmp;
	long	lTmp;
	int	iTotal = 0,i;


	unsigned char buf[PD_MAX_BUFFER + 1]={0};
        unsigned long bufLen=sizeof(buf);

	unsigned char tmpbuf[PD_MAX_BUFFER + 1]={0};

	//double	dTmp;
DEBUGLOG(("FormatBatchMsg()\n"));

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );
//txn code
	if (GetField_CString(hIn,"txn_code",&csTxnCode)) {
DEBUGLOG(("FormatBatchMsg:: txn_code = [%s]\n",csTxnCode));
	}

	outMsg[0]= '\0';
DEBUGLOG(("outmsg = [%s]\n",outMsg));
//psp_url
	if (GetField_CString(hIn,"psp_url",&csURL)) {
//request_function
		strcpy((char*)csBuf,"TC");
		strcat((char*)csBuf,MY_TWV_FIELD_TOKEN);
		strcat((char*)csBuf,csTxnCode);
		strcat((char*)csBuf,MY_TWV_TOKEN);

		if (GetField_CString(hIn,"request_function",&csPtr)) {
			strcat((char*)csBuf,"url");
DEBUGLOG(("FormatBatchMsg:: psp_url = [%s]\n",csURL));
			strcat((char*)csBuf,MY_TWV_FIELD_TOKEN);
			strcat((char*)csBuf,csURL);
			strcat((char*)csBuf,"/");
			strcat((char*)csBuf,csPtr);
			strcat((char*)csBuf,MY_TWV_TOKEN);
		}	
	

//action
		if (GetField_CString(hIn,"action",&csPtr)) {
				strcat((char*)csBuf,"action");
DEBUGLOG(("FormatBatchMsg:: action = [%s]\n",csPtr));
				strcat((char*)csBuf,MY_TWV_FIELD_TOKEN);
				strcat((char*)csBuf,csURL);
				strcat((char*)csBuf,"/");
				strcat((char*)csBuf,csPtr);
		}	
		sprintf(outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
DEBUGLOG(("FormatBatchMsg:: outMsg = [%s]\n",outMsg));
		strcat(outMsg,csBuf);
	}
	FREE_ME(csBuf);
//access_key
	if (GetField_CString(hIn,"access_key",&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: access_key = [%s]\n",csPtr));
		strcat((char*)outMsg,"access_key");

		strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TWV_TOKEN);
	}	
	GetField_Int(hIn,"total",&iTotal);
DEBUGLOG(("FormatBatchMsg: total = [%d]\n",iTotal));

	strcat((char*)outMsg,"total");
	strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
	sprintf(csTmp,"%d",iTotal);
	strcat((char*)outMsg,csTmp);
	strcat((char*)outMsg,MY_TWV_TOKEN);

	for (i = 0; i < iTotal; i++) {
//order_num
		sprintf(csTag,"order_num_%d",i);
		if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
			strcat((char*)buf,csTag);

			strcat((char*)buf,MY_TWV_FIELD_TOKEN);
			strcat((char*)buf,csPtr);
			strcat((char*)buf,MY_TWV_TOKEN);
		}	
//amount
		sprintf(csTag,"txn_amt_%d",i);
		if (GetField_Double(hIn,csTag,&dTmp)) {
			lTmp = (long) dTmp;
			sprintf(csTmp,"%ld",lTmp);
			sprintf(csTag,"amount_%d",i);
DEBUGLOG(("FormatBatchMsg:: %s = [%ld]\n",csTag,lTmp));
			strcat((char*)buf,csTag);

			strcat((char*)buf,MY_TWV_FIELD_TOKEN);
			strcat((char*)buf,csTmp);
			strcat((char*)buf,MY_TWV_TOKEN);

		}
//bank_code
		sprintf(csTag,"bank_code_%d",i);
		if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
			strcat((char*)buf,csTag);

			strcat((char*)buf,MY_TWV_FIELD_TOKEN);
			strcat((char*)buf,csPtr);
			strcat((char*)buf,MY_TWV_TOKEN);
		}	
//branch_name
		sprintf(csTag,"branch_name_%d",i);
		if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
			strcat((char*)buf,csTag);

			strcat((char*)buf,MY_TWV_FIELD_TOKEN);
			strcat((char*)buf,csPtr);
			strcat((char*)buf,MY_TWV_TOKEN);
		}

//account_id
		sprintf(csTag,"account_id_%d",i);
		if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
			strcat((char*)buf,csTag);

			strcat((char*)buf,MY_TWV_FIELD_TOKEN);
			strcat((char*)buf,csPtr);
			strcat((char*)buf,MY_TWV_TOKEN);
		}
//account_name

		sprintf(csTag,"account_name_%d",i);
		if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatBatchMsg:: %s = [%s]\n",csTag,csPtr));
			strcat((char*)buf,csTag);

			strcat((char*)buf,MY_TWV_FIELD_TOKEN);
			strcat((char*)buf,csPtr);
			strcat((char*)buf,MY_TWV_TOKEN);
		}
//identity_id
		sprintf(csTag,"identity_id_%d",i);
		if (GetField_CString(hIn,csTag,&csPtr)) {
DEBUGLOG(("FormatMsg:: %s = [%s]\n",csTag,csPtr));
			strcat((char*)buf,csTag);

			strcat((char*)buf,MY_TWV_FIELD_TOKEN);
			strcat((char*)buf,csPtr);
			strcat((char*)buf,MY_TWV_TOKEN);
		}

	}

	bufLen = strlen(buf);
DEBUGLOG(("outmsg = [%s]\n",outMsg));
DEBUGLOG(("buf = [%s]\n",buf));
        base64_encode(buf,bufLen,tmpbuf,PD_MAX_BUFFER);
                
DEBUGLOG(("[%d][%s]\n",strlen(tmpbuf),tmpbuf));
        strcat(outMsg,buf);


	*outLen = strlen(outMsg);
DEBUGLOG(("FormatMsg() [%s][%d]\n",outMsg,*outLen));
DEBUGLOG(("FormatMsg() Exit\n"));
	FREE_ME(csTxnCode);
	FREE_ME(csPtr);
	FREE_ME(csURL);
	return 	iRet;
}



int BreakDownBatchMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csBuf;
	char	*p;
	double	 dTmp;
	int	iTotal = 0,i;
	char	csTag[PD_TAG_LEN + 1];

	csBuf = (char*) malloc (1024 +1);

	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';
DEBUGLOG(("BreakDownBatchMsg()\n"));
DEBUGLOG(("DATA = [%s]\n",inMsg));

/* total */
	p = GetField(csBuf,"total",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		
		iTotal = ctos(p,strlen(p));
		PutField_Int(hOut,"total",iTotal);
DEBUGLOG(("BreakDownBatchMsg:: total = [%d]\n",iTotal));
	}
	
	for (i = 0; i < iTotal; i ++) {
/* tid */
		sprintf(csTag,"tid_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}

/* txn_date */
		sprintf(csTag,"req_time_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}

/* access_key */
		sprintf(csTag,"access_key_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}
/* order_num */
		sprintf(csTag,"order_num_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}
/* status */
		sprintf(csTag,"status_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}
/* error_code */
		sprintf(csTag,"error_code_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}
/* deposit_url */
		sprintf(csTag,"deposit_url_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}
/* amount */
		sprintf(csTag,"amount_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}

/* bank_code */
		sprintf(csTag,"bank_code_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}
/* bank_branch */
		sprintf(csTag,"bank_branch_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}
/* acct_name */
		sprintf(csTag,"account_name_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}
/* acct_no */
		sprintf(csTag,"account_no_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}
/* own_id */
		sprintf(csTag,"own_id_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}
/* description */
		sprintf(csTag,"description_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}
/* batch_id */
		sprintf(csTag,"batch_id_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}
/* fundin_date */
		sprintf(csTag,"fundin_date_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}
/* fundout_date */
		sprintf(csTag,"fundout_date_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			PutField_CString(hOut,csTag,p);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%s]\n",csTag,p));
		}
/* service_fee */
		sprintf(csTag,"service_fee_%d",i);
		p = GetField(csBuf,csTag,MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
		if (p) {
			dTmp = ctod(p,strlen(p),0);
		//dTmp = myctod(p,strlen(p) - PD_DECIMAL_LEN,PD_DECIMAL_LEN);
			PutField_Double(hOut,csTag,dTmp);
DEBUGLOG(("BreakDownBatchMsg:: %s = [%f]\n",csTag,dTmp));
		}
	}
/* FERESP */
	p = GetField(csBuf,"FERESP",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_Char(hOut,"FERESP",p[0]);
DEBUGLOG(("BreakDownMsg:: FERESP = [%c]\n",p[0]));
	}

	FREE_ME(csBuf);
DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}


int DeBlockBounceBackData(hash_t *hOut,const char* inMsg, const int inLen)
{
        int     iRet = PD_OK;
        int     iLen;
        char*   csDATA;
        char*   csValue;
        char*   csBuf;
        char*   p;

//      unsigned char buf[PD_MAX_BUFFER + 1]={0};

        csBuf = (char*) malloc (1024 +1);
        memcpy(csBuf,inMsg,inLen);
        csBuf[inLen] = '\0';

        p = strtok(csBuf,MY_TWV_TOKEN);
        if (p != NULL)
                iRet = ParseField(hOut,p);

        while (((p = strtok(NULL,MY_TWV_TOKEN)) != NULL) && iRet == PD_OK) {
                iRet = ParseField(hOut,p);
        }

        GetField_CString(hOut,"DATA",&csValue);
        csDATA = (char*) malloc (MAX_MSG_SIZE +1);
        iLen = base64_decode((char*)csValue,csDATA,MAX_MSG_SIZE);

        if (iLen > 0 ) {
DEBUGLOG(("DeBlockBounceBackDATA:: data = [%s]\n",csDATA));
                p = strtok(csDATA,MY_TWV_BOUNCE_FIELD_TOKEN);
                if (p) {
                        PutField_CString(hOut,"org_txn_seq",p);
DEBUGLOG(("DEBlockData txn_seq = [%s]\n",p));
                }

        }
        else
                iRet = INT_ERR;

DEBUGLOG(("DeBlockBounceBackData Exit = [%d]\n",iRet));
        return iRet;
}

int ParseField(hash_t *hOut,const char* inMsg)
{
        int     iRet = PD_OK;

        char    *csTag;
        char    *csValue;
        char    *csTmp;
        char    cTmp;


        char    *p;


        csTmp = (char*) malloc(strlen(inMsg) +1);
        strcpy(csTmp,inMsg);

        p = strstr(csTmp,MY_TWV_FIELD_TOKEN);
        if (strlen(p) > strlen(MY_TWV_FIELD_TOKEN)) {
                csTag = (char*) malloc (PD_TMP_BUF_LEN +1);
                csValue = (char*) malloc (MAX_MSG_SIZE +1);

                strcpy(csValue,p+1);
                memcpy(csTag,inMsg,strlen(inMsg) - strlen(p));
                csTag[strlen(inMsg) - strlen(p)] = '\0';

/* process type */
                if (!strcmp(csTag,"process_type")) {
                        strcpy(csTag,"process_type");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* process code */
                else if (!strcmp(csTag,"process_code")) {
                        strcpy(csTag,"process_code");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* merchant no */
                else if (!strcmp(csTag,"merchant_id"))  {
                        strcpy(csTag,"merchant_id");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* merchant ref */
                else if (!strcmp(csTag,"reference")) {
                        strcpy(csTag,"merchant_ref");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* merchant transaction date time */
                else if (!strcmp(csTag,"transaction_datetime")) {
                        strcpy(csTag,"transmission_datetime");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));

                        memcpy(csTmp,csValue,PD_DATE_LEN);
                        csTmp[PD_DATE_LEN] = '\0';
                        strcpy(csTag,"tm_date");
                        PutField_CString(hOut,csTag,csTmp);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csTmp));
                        memcpy(csTmp,&csValue[PD_DATE_LEN],PD_TIME_LEN);
                        csTmp[PD_TIME_LEN] = '\0';
                        strcpy(csTag,"tm_time");
                        PutField_CString(hOut,csTag,csTmp);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csTmp));
                }
/* pay method */
                else if (!strcmp(csTag,"pay_method")) {
                        strcpy(csTag,"pay_method");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* txn amount */
                else if (!strcmp(csTag,"pay_amount")) {
                        strcpy(csTag,"txn_amt");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* currency */
                else if (!strcmp(csTag,"currency_code")) {
                        strcpy(csTag,"txn_ccy");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* country */
                else if (!strcmp(csTag,"country")) {
                        strcpy(csTag,"txn_country");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* bank_code */
                else if (!strcmp(csTag,"bank_code")) {
                        strcpy(csTag,"bank_code");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* bank_name */
                else if (!strcmp(csTag,"bank_name")) {
                        strcpy(csTag,"bank_name");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* branch_name */
                else if (!strcmp(csTag,"branch_name")) {
                        strcpy(csTag,"branch_name");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* account_id */
                else if (!strcmp(csTag,"account_id")) {
                        strcpy(csTag,"account_id");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* account_name */
                else if (!strcmp(csTag,"account_name")) {
                        strcpy(csTag,"account_name");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* identity_id */
                else if (!strcmp(csTag,"identity_id")) {
                        strcpy(csTag,"identity_id");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* phone_no */
                else if (!strcmp(csTag,"phone_no")) {
                        strcpy(csTag,"phone_no");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* province */
                else if (!strcmp(csTag,"province")) {
                        strcpy(csTag,"province");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* batch_id */
                else if (!strcmp(csTag,"batch_id")) {
                        strcpy(csTag,"batch_id");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }

/* show paypage */
                else if (!strcmp(csTag,"show_paypage")) {
                        strcpy(csTag,"show_paypage");
                        cTmp = csValue[0];
                        PutField_Char(hOut,csTag,cTmp);
DEBUGLOG(("BreakDownMsg:[%s] = [%c]\n",csTag,cTmp));
                }
/* language */
                else if (!strcmp(csTag,"language")) {
                        strcpy(csTag,"language");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }

/* success url */
                else if (!strcmp(csTag,"success_url")) {
                        strcpy(csTag,"success_url");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* success callback url */
                else if (!strcmp(csTag,"success_callback_url")) {
                        strcpy(csTag,"success_callback_url");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }

/* failure url */
                else if (!strcmp(csTag,"failure_url")) {
                        strcpy(csTag,"failure_url");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* failure callback url */
                else if (!strcmp(csTag,"failure_callback_url")) {
                        strcpy(csTag,"failure_callback_url");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* remark */
                else if (!strcmp(csTag,"remark")) {
                        strcpy(csTag,"remark");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* mac */
                else if (!strcmp(csTag,"mac")) {
                        strcpy(csTag,"mac");
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* total */
                else if (!strcmp(csTag,"total")) {
                        strcpy(csTag,"total");
                        PutField_Int(hOut,csTag,ctos(csValue,strlen(csValue)));
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                }
/* DATA */
                else if (!strcmp(csTag,"DATA")) {
                        strcpy(csTag,"DATA");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
                }
/* encrypt_type */
                else if (!strcmp(csTag,"enctype")) {
                        strcpy(csTag,"encrypt_type");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
                }

/* ip_addr */
                else if (!strcmp(csTag,"ip_addr")) {
                        strcpy(csTag,"ip_addr");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
                }

/* service_code */
                else if (!strcmp(csTag,"service_code")) {
                        strcpy(csTag,"service_code");
DEBUGLOG(("BreakDownMsg:[%s] = [%s]\n",csTag,csValue));
                        PutField_CString(hOut,csTag,csValue);
                }

                FREE_ME(csTag);
                FREE_ME(csValue);
        }

        FREE_ME(csTmp);

DEBUGLOG(("BreakDownMsg = [%d]\n",iRet));;
        return iRet;
}
