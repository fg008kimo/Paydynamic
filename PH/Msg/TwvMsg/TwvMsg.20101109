#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "TwvMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"

char	cDebug;

void	TwvMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;

	char*	csTxnCode = NULL;
	char*	csPtr = NULL;
	char*	csURL = NULL;
	char	csTmp[PD_TMP_BUF_LEN + 1];
	char* 	csBuf;
	double	dTmp;
	long	lTmp;


	//double	dTmp;
DEBUGLOG(("FormatMsg()\n"));

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );
//txn code
	if (GetField_CString(hIn,"txn_code",&csTxnCode)) {
DEBUGLOG(("FormatMsg:: txn_code = [%s]\n",csTxnCode));
	}

	outMsg[0]= '\0';
DEBUGLOG(("outmsg = [%s]\n",outMsg));
//psp_url
	if (GetField_CString(hIn,"psp_url",&csURL)) {
//request_function
		if (GetField_CString(hIn,"txn_code",&csPtr)) {
			strcpy((char*)csBuf,"TC");
			strcat((char*)csBuf,MY_TWV_FIELD_TOKEN);
			strcat((char*)csBuf,csPtr);
			strcat((char*)csBuf,MY_TWV_TOKEN);
		}
		if (GetField_CString(hIn,"request_function",&csPtr)) {
			strcat((char*)csBuf,"url");
DEBUGLOG(("FormatMsg:: psp_url = [%s]\n",csURL));
			strcat((char*)csBuf,MY_TWV_FIELD_TOKEN);
			strcat((char*)csBuf,csURL);
			strcat((char*)csBuf,"/");
			strcat((char*)csBuf,csPtr);
			strcat((char*)csBuf,MY_TWV_TOKEN);
		}	
	

//action
		if (GetField_CString(hIn,"action",&csPtr)) {
				strcat((char*)csBuf,"action");
DEBUGLOG(("FormatMsg:: action = [%s]\n",csPtr));
				strcat((char*)csBuf,MY_TWV_FIELD_TOKEN);
				strcat((char*)csBuf,csURL);
				strcat((char*)csBuf,"/");
				strcat((char*)csBuf,csPtr);
		}	
		sprintf(outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));
		strcat(outMsg,csBuf);
	}
	FREE_ME(csBuf);
//access_key
	if (GetField_CString(hIn,"access_key",&csPtr)) {
DEBUGLOG(("FormatMsg:: access_key = [%s]\n",csPtr));
		strcat((char*)outMsg,"access_key");

		strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TWV_TOKEN);
	}	
//order_num
	if (GetField_CString(hIn,"order_num",&csPtr)) {
DEBUGLOG(("FormatMsg:: order_num = [%s]\n",csPtr));
		strcat((char*)outMsg,"order_num");

		strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TWV_TOKEN);
	}	
//amount
	if (GetField_Double(hIn,"txn_amt",&dTmp)) {
		lTmp = (long) dTmp;
		sprintf(csTmp,"%ld",lTmp);
DEBUGLOG(("FormatMsg:: amount = [%ld]\n",lTmp));
		strcat((char*)outMsg,"amount");

		strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
		strcat((char*)outMsg,csTmp);
		strcat((char*)outMsg,MY_TWV_TOKEN);

	}
/* DSP txn */
	if (!strcmp(csTxnCode,PD_DEPOSIT_TXN_CODE)) {
//description
		if (GetField_CString(hIn,"txn_desc",&csPtr)) {
DEBUGLOG(("FormatMsg:: description = [%s]\n",csPtr));
			strcat((char*)outMsg,"description");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}	
//return_url
		if (GetField_CString(hIn,"return_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: return_url = [%s]\n",csPtr));
			strcat((char*)outMsg,"return_url");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}	
	}
	else if (!strcmp(csTxnCode,PD_WITHDRAW_TXN_CODE) || !strcmp(csTxnCode,PD_WITHDRAW_BATCH_TXN_CODE)) {
//bank_code
		if (GetField_CString(hIn,"bank_code",&csPtr)) {
DEBUGLOG(("FormatMsg:: bank_code = [%s]\n",csPtr));
			strcat((char*)outMsg,"bank_code");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}	
//branch_name
		if (GetField_CString(hIn,"branch_name",&csPtr)) {
DEBUGLOG(("FormatMsg:: branch_name = [%s]\n",csPtr));
			strcat((char*)outMsg,"branch_name");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}

//account_id
		if (GetField_CString(hIn,"account_id",&csPtr)) {
DEBUGLOG(("FormatMsg:: account_id = [%s]\n",csPtr));
			strcat((char*)outMsg,"account_id");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}
//account_name
		if (GetField_CString(hIn,"account_name",&csPtr)) {
DEBUGLOG(("FormatMsg:: account_name = [%s]\n",csPtr));
			strcat((char*)outMsg,"account_name");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}
//identity_id
		if (GetField_CString(hIn,"identity_id",&csPtr)) {
DEBUGLOG(("FormatMsg:: identity_id = [%s]\n",csPtr));
			strcat((char*)outMsg,"identity_id");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}
	}


DEBUGLOG(("outmsg = [%s]\n",outMsg));

	*outLen = strlen(outMsg);
DEBUGLOG(("FormatMsg() [%s][%d]\n",outMsg,*outLen));
DEBUGLOG(("FormatMsg() Exit\n"));
	FREE_ME(csTxnCode);
	FREE_ME(csPtr);
	FREE_ME(csURL);
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csBuf;
	char	*p;
	double	 dTmp;

	csBuf = (char*) malloc (1024 +1);

	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';
DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s]\n",inMsg));

	
/* tid */
	p = GetField(csBuf,"tid",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"tid",p);
DEBUGLOG(("BreakDownMsg:: tid = [%s]\n",p));
	}
/* txn_date */
	p = GetField(csBuf,"req_time",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"txn_date",p);
DEBUGLOG(("BreakDownMsg:: txn_date = [%s]\n",p));
	}
/* access_key */
	p = GetField(csBuf,"access_key",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"access_key",p);
DEBUGLOG(("BreakDownMsg:: access_key = [%s]\n",p));
	}
/* order_num */
	p = GetField(csBuf,"order_num",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"order_num",p);
DEBUGLOG(("BreakDownMsg:: order_num = [%s]\n",p));
	}
/* status */
	p = GetField(csBuf,"status",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"status",p);
DEBUGLOG(("BreakDownMsg:: status = [%s]\n",p));
	}
/* error_code */
	p = GetField(csBuf,"error_code",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"error_code",p);
DEBUGLOG(("BreakDownMsg:: error_code = [%s]\n",p));
	}
/* deposit_url */
	p = GetField(csBuf,"deposit_url",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"deposit_url",p);
DEBUGLOG(("BreakDownMsg:: deposit_url = [%s]\n",p));
	}
/* amount */
	p = GetField(csBuf,"amount",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"txn_amt",p);
DEBUGLOG(("BreakDownMsg:: txn_amt = [%s]\n",p));
	}

/* bank_code */
	p = GetField(csBuf,"bank_code",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"bank_code",p);
DEBUGLOG(("BreakDownMsg:: bank_code = [%s]\n",p));
	}
/* bank_branch */
	p = GetField(csBuf,"bank_branch",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"bank_branch",p);
DEBUGLOG(("BreakDownMsg:: bank_branch = [%s]\n",p));
	}
/* acct_name */
	p = GetField(csBuf,"account_name",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"account_name",p);
DEBUGLOG(("BreakDownMsg:: account_name = [%s]\n",p));
	}
/* acct_no */
	p = GetField(csBuf,"account_no",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"account_no",p);
DEBUGLOG(("BreakDownMsg:: account_no = [%s]\n",p));
	}
/* own_id */
	p = GetField(csBuf,"own_id",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"own_id",p);
DEBUGLOG(("BreakDownMsg:: own_id = [%s]\n",p));
	}
/* description */
	p = GetField(csBuf,"description",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"description",p);
DEBUGLOG(("BreakDownMsg:: description = [%s]\n",p));
	}
/* batch_id */
	p = GetField(csBuf,"batch_id",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"batch_id",p);
DEBUGLOG(("BreakDownMsg:: batch_id = [%s]\n",p));
	}
/* fundin_date */
	p = GetField(csBuf,"fundin_date",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"fundin_date",p);
DEBUGLOG(("BreakDownMsg:: fundin_date = [%s]\n",p));
	}
/* fundout_date */
	p = GetField(csBuf,"fundout_date",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"fundout_date",p);
DEBUGLOG(("BreakDownMsg:: fundout_date = [%s]\n",p));
	}
/* service_fee */
	p = GetField(csBuf,"service_fee",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		dTmp = ctod(p,strlen(p),0);
		//dTmp = myctod(p,strlen(p) - PD_DECIMAL_LEN,PD_DECIMAL_LEN);
		PutField_Double(hOut,"service_fee",dTmp);
DEBUGLOG(("BreakDownMsg:: service_fee = [%f]\n",dTmp));
	}
/* FERESP */
	p = GetField(csBuf,"FERESP",MY_TWV_TOKEN,MY_TWV_FIELD_TOKEN);
	if (p) {
		PutField_Char(hOut,"FERESP",p[0]);
DEBUGLOG(("BreakDownMsg:: FERESP = [%c]\n",p[0]));
	}

	FREE_ME(csBuf);
DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	char	*csTmp = NULL;
DEBUGLOG(("initReplyFromRequest()\n"));
	

/* order_num */
        if (GetField_CString(hRequest,"merchant_ref",&csTmp)) {
DEBUGLOG(("initReplyFromRequest: order_num = [%s]\n",csTmp));
                PutField_CString(hResponse,"order_num",csTmp);
        }


DEBUGLOG(("initReplyFromRequest() Exit\n"));
	FREE_ME(csTmp);
	return iRet;
}

