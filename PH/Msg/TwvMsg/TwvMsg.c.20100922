#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "TwvMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"

char	cDebug;

void	TwvMsg(char cdebug)
{
	cDebug = cdebug;
}

int ParseMyField(hash_t *hOut,const char* inMsg);
int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;

	char*	csTxnCode = NULL;
	char*	csPtr = NULL;
	char*	csURL = NULL;
	char*	csTmp = strdup("");
	char* 	csBuf;


	//double	dTmp;
DEBUGLOG(("FormatMsg()\n"));

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );
//txn code
	if (GetField_CString(hIn,"txn_code",&csTxnCode)) {
DEBUGLOG(("FormatMsg:: txn_code = [%s]\n",csTxnCode));
	}

	outMsg[0]= '\0';
DEBUGLOG(("outmsg = [%s]\n",outMsg));
//psp_url
	if (GetField_CString(hIn,"psp_url",&csURL)) {
//request_function
		if (GetField_CString(hIn,"txn_code",&csPtr)) {
			strcpy((char*)csBuf,"TC");
			strcat((char*)csBuf,MY_TWV_FIELD_TOKEN);
			strcat((char*)csBuf,csPtr);
			strcat((char*)csBuf,MY_TWV_TOKEN);
		}
		if (GetField_CString(hIn,"request_function",&csPtr)) {
			strcat((char*)csBuf,"url");
DEBUGLOG(("FormatMsg:: psp_url = [%s]\n",csURL));
			strcat((char*)csBuf,MY_TWV_FIELD_TOKEN);
			strcat((char*)csBuf,csURL);
			strcat((char*)csBuf,"/");
			strcat((char*)csBuf,csPtr);
			strcat((char*)csBuf,MY_TWV_TOKEN);
		}	
	

//action
		if (GetField_CString(hIn,"action",&csPtr)) {
				strcat((char*)csBuf,"action");
DEBUGLOG(("FormatMsg:: action = [%s]\n",csPtr));
				strcat((char*)csBuf,MY_TWV_FIELD_TOKEN);
				strcat((char*)csBuf,csURL);
				strcat((char*)csBuf,"/");
				strcat((char*)csBuf,csPtr);
		}	
		sprintf(outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));
		strcat(outMsg,csBuf);
	}
	FREE_ME(csBuf);
//access_key
	if (GetField_CString(hIn,"access_key",&csPtr)) {
DEBUGLOG(("FormatMsg:: access_key = [%s]\n",csPtr));
		strcat((char*)outMsg,"access_key");

		strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
		strcat((char*)outMsg,csPtr);
		strcat((char*)outMsg,MY_TWV_TOKEN);
	}	

/* DSP txn */
	if (!strcmp(csTxnCode,PD_DEPOSIT_TXN_CODE)) {

//order_num
		if (GetField_CString(hIn,"order_num",&csPtr)) {
DEBUGLOG(("FormatMsg:: order_num = [%s]\n",csPtr));
			strcat((char*)outMsg,"order_num");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}	
//amount
		if (GetField_CString(hIn,"txn_amt",&csTmp)) {
		//if (GetField_Double(hIn,"txn_amount",&dTmp)) {
		//	dtoc(dTmp,12,0,csTmp);
		//	trim_leading_zero(csTmp,csTmp);
DEBUGLOG(("FormatMsg:: amount = [%s]\n",csTmp));
			strcat((char*)outMsg,"amount");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}	
//description
		if (GetField_CString(hIn,"txn_desc",&csPtr)) {
DEBUGLOG(("FormatMsg:: description = [%s]\n",csPtr));
			strcat((char*)outMsg,"description");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}	
//return_url
		if (GetField_CString(hIn,"return_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: return_url = [%s]\n",csPtr));
			strcat((char*)outMsg,"return_url");

			strcat((char*)outMsg,MY_TWV_FIELD_TOKEN);
			strcat((char*)outMsg,csPtr);
			strcat((char*)outMsg,MY_TWV_TOKEN);
		}	

	}


DEBUGLOG(("outmsg = [%s]\n",outMsg));

	*outLen = strlen(outMsg);
DEBUGLOG(("FormatMsg() [%s][%d]\n",outMsg,*outLen));
DEBUGLOG(("FormatMsg() Exit\n"));
	FREE_ME(csTxnCode);
	FREE_ME(csPtr);
	FREE_ME(csTmp);
	FREE_ME(csURL);
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;

	char	*csBuf;

	char	*p;

	csBuf = (char*) malloc (1024 +1);

	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';
DEBUGLOG(("BreakDownMsg()\n"));

	
	p = strtok(csBuf,MY_TWV_TOKEN);
	if (p != NULL)
	{
		iRet = ParseMyField(hOut,p);
	}

	while (((p = strtok(NULL,MY_TWV_TOKEN)) != NULL) && iRet == PD_OK) {
		iRet = ParseMyField(hOut,p);
	}


	FREE_ME(csBuf);
DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	char	*csTmp = NULL;
DEBUGLOG(("initReplyFromRequest()\n"));
	

/* order_num */
        if (GetField_CString(hRequest,"merchant_ref",&csTmp)) {
DEBUGLOG(("initReplyFromRequest: order_num = [%s]\n",csTmp));
                PutField_CString(hResponse,"order_num",csTmp);
        }


DEBUGLOG(("initReplyFromRequest() Exit\n"));
	FREE_ME(csTmp);
	return iRet;
}

int ParseMyField(hash_t *hOut,const char* inMsg)
{
	int	iRet = PD_OK;

	char	*csTag;
	char	*csValue;
	char	*csTmp;
	//double	dTmp;

	char	*p;
	

	csTmp = (char*) malloc(strlen(inMsg) +1);
	strcpy(csTmp,inMsg);

	p = strstr(csTmp,MY_TWV_FIELD_TOKEN);
	if (strlen(p) > strlen(MY_TWV_FIELD_TOKEN)) {
		csTag = (char*) malloc (PD_TMP_BUF_LEN +1);
		csValue = (char*) malloc (PD_TMP_BUF_LEN +1);

		strcpy(csValue,p+1);
		memcpy(csTag,inMsg,strlen(inMsg) - strlen(p));
		csTag[strlen(inMsg) - strlen(p)] = '\0';

/* access_key */
		if (!strcmp(csTag,"access_key")) {
			strcpy(csTag,"access_key");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}
		
/*tid*/
		else if(!strcmp(csTag,"tid")){
			strcpy(csTag,"tid");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}

/*req_time*/
		else if(!strcmp(csTag,"req_time")){
			strcpy(csTag,"req_time");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}

/*status*/
		else if(!strcmp(csTag,"status")){
			strcpy(csTag,"status");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}


/*order_num*/
		else if(!strcmp(csTag,"order_num")){
			strcpy(csTag,"order_num");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}


/*pay_type*/
		else if(!strcmp(csTag,"pay_type")){
			strcpy(csTag,"pay_type");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}

/*amount*/
		else if(!strcmp(csTag,"amount")){
                        //dTmp = ctod(csValue,strlen(csValue),0);
                        strcpy(csTag,"txn_amount");
			//PutField_Double(hOut,csTag,dTmp);
//DEBUGLOG(("[%s] = [%lf]\n",csTag,dTmp));
                        PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
                }


/*bank_code*/
		else if(!strcmp(csTag,"bank_code")){
			strcpy(csTag,"bank_code");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}


/*bank_branch*/
		else if(!strcmp(csTag,"bank_branch")){
			strcpy(csTag,"bank_branch");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}


/*account_name*/
		else if(!strcmp(csTag,"account_name")){
			strcpy(csTag,"account_name");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}


/*account_no*/
		else if(!strcmp(csTag,"account_no")){
			strcpy(csTag,"account_no");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}


/*owner_id*/
		else if(!strcmp(csTag,"owner_id")){
			strcpy(csTag,"owner_id");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}


/*description*/
		else if(!strcmp(csTag,"description")){
			strcpy(csTag,"description");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}


/*error_id*/
		else if(!strcmp(csTag,"error_id")){
			strcpy(csTag,"error_id");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}


/*batch_id*/
		else if(!strcmp(csTag,"batch_id")){
			strcpy(csTag,"batch_id");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}


/*fundin_date*/
		else if(!strcmp(csTag,"fundin_date")){
			strcpy(csTag,"fundin_date");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}


/*service_fee*/
		else if(!strcmp(csTag,"service_fee")){
			strcpy(csTag,"service_fee");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));
		}

/*deposit_url*/
		else if(!strcmp(csTag,"deposit_url")){
			strcpy(csTag,"remark");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));

		}

/*txn_seq*/
		else if(!strcmp(csTag,"txn_seq")){
			strcpy(csTag,"txn_seq");
			PutField_CString(hOut,csTag,csValue);
DEBUGLOG(("[%s] = [%s]\n",csTag,csValue));

		}
		FREE_ME(csTag);
		FREE_ME(csValue);
	}

	FREE_ME(csTmp);

	return iRet;
}
