/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version					   2014/07/04              LokMan Chow
Support Unipaygo-Yeepay mobile			   2015/08/13		   LokMan Chow
Support other EC mobile (pay_id configurable)	   2016/03/21		   LokMan Chow
Change from MD5 to RSA (send to PSP)		   2017/01/19		   David Wong
Add order_timestamp				   2018/08/08		   David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "UniMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"
#include "internal.h"
#include "ObjPtr.h"
#define __USE_XOPEN
#include <time.h>
#include "myrecordset.h"
#include <openssl/rsa.h>


static char cDebug;
OBJPTR(DB);
OBJPTR(BO);

void	UniMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;
	char*   csTmp = NULL;
	char*   csPtr = NULL;
	char*   csBuf;
	//double  dTmp;
	char*   csMethod = NULL;

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

	memset(outMsg,0,sizeof(outMsg));
	if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg here\n"));
		strcat((char *)outMsg,csPtr);
		strcat((char *)outMsg,"?");
		strcat((char*)outMsg,MY_UNI_TOKEN);


// 1 partner
		if (GetField_CString(hIn,"psp_merchant_id",&csTmp)) {
			strcat((char*)outMsg,"partner");
			strcat((char*)outMsg,MY_UNI_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_UNI_TOKEN);
DEBUGLOG(("FormatMsg:: partner = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***psp_merchant_id is missing\n"));
		}

// 2 info
		if (GetField_CString(hIn,"sign",&csTmp)) {
			strcat((char*)outMsg,"info");
			strcat((char*)outMsg,MY_UNI_FIELD_TOKEN);
			strcat((char*)outMsg,url_encode(csTmp));
			strcat((char*)outMsg,MY_UNI_TOKEN);
DEBUGLOG(("FormatMsg:: signMsg = [%s]\n",url_encode(csTmp)));
		}

/* url_method */
                if (GetField_CString(hIn,"url_method",&csMethod)) {
DEBUGLOG(("FormatMsg:: url_method = [%s]\n",csMethod));
                }

DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
		base64_encode(outMsg,strlen((char *)outMsg),csBuf,PD_MAX_BUFFER);
DEBUGLOG(("FormatMsg:: after encode\n"));
                outMsg[0] = '\0';
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
                strcat((char*)outMsg,MY_UNI_TOKEN);
		strcat((char*)outMsg,"url_method");
		strcat((char*)outMsg,"=");
		strcat((char*)outMsg,csMethod);
                strcat((char*)outMsg,MY_UNI_TOKEN);
		strcat((char*)outMsg,"ret_status=0");
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));

		*outLen = strlen((const char*)outMsg);
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: Redirct url not found\n"));
	}


DEBUGLOG(("FormatMsg:: normal exit iret =[%d]\n",iRet));
	FREE_ME(csBuf);
	return 	iRet;
}


int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	int	iTmpRet = PD_OK;
	char	*csPtr, *csPspMerchantId, *csInfo, *csPspId, *csKeyFile, *csDecryptedInfo;
	csDecryptedInfo = (char*) malloc (PD_MAX_BUFFER);
	memset(csDecryptedInfo, 0, sizeof(csDecryptedInfo));
	hash_t	*hRec;
	hash_t	*hPspDetail;
	hash_t	*hKey;
	hash_t	*hDecrypted;

        hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec, 0);

	hPspDetail = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hPspDetail, 0);

	hDecrypted = (hash_t*)  malloc (sizeof(hash_t));
	hash_init(hDecrypted, 0);

DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));

	if (Str2Cls(hRec,(char *)inMsg,MY_UNI_TOKEN, MY_UNI_FIELD_TOKEN) == PD_OK) {

// 1 partner
		if (GetField_CString(hRec, "partner", &csPspMerchantId)) {
DEBUGLOG(("BreakDownMsg:: partner = [%s]\n", csPspMerchantId));
		} else {
DEBUGLOG(("BreakDownMsg:: partner not found\n"));
			iRet = PD_ERR;
		}

// 2 info
		if (iRet == PD_OK) {
			if (GetField_CString(hRec, "info", &csInfo)) {
DEBUGLOG(("BreakDownMsg:: info = [%s]\n", csInfo));
			} else {
DEBUGLOG(("BreakDownMsg:: info not found\n"));
				iRet = PD_ERR;
			}
		}

// get psp_id by channel and psp_merchant_id
		if (iRet == PD_OK) {
			DBObjPtr = CreateObj(DBPtr, "DBPspDetail", "GetPspDetailByChannelMerchId");
			iTmpRet = (unsigned long)(*DBObjPtr)(PD_CHANNEL_UNIPAY, csPspMerchantId, hPspDetail);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("BreakDownMsg:: call DBPspDetail:GetPspDetailByChannelMerchId() failed\n"));
				iRet = PD_ERR;
			} else {
				if (GetField_CString(hPspDetail, "psp_id", &csPspId)) {
DEBUGLOG(("BreakDownMsg:: psp_id = [%s]\n", csPspId));
				}
				else {
DEBUGLOG(("BreakDownMsg:: psp_id not found\n"));
					iRet = PD_ERR;
				}
			}
		}

// get private key file by psp_id
		if (iRet == PD_OK) {
			recordset_t *rKeySet;
			rKeySet = (recordset_t*) malloc (sizeof(recordset_t));
			recordset_init(rKeySet, 0);
			DBObjPtr = CreateObj(DBPtr, "DBPspKeys", "GetPspKey");
			iTmpRet = (unsigned long)(*DBObjPtr)(csPspId, PD_PTK_KEY_NAME, rKeySet);
			if (iTmpRet != PD_OK) {
DEBUGLOG(("BreakDownMsg:: call DBPspKeys:GetPspKey() failed\n"));
				iRet = PD_ERR;
			} else {
				hKey = RecordSet_GetFirst(rKeySet);
				while (hKey) {
					if (GetField_CString(hKey, "privatepem", &csKeyFile)) {
DEBUGLOG(("BreakDownMsg:: private key file = [%s]\n", csKeyFile));
					} else {
DEBUGLOG(("BreakDownMsg:: private key file not found\n"));
						iRet = PD_ERR;
					}
					break;
				}
			}
			RecordSet_Destroy(rKeySet);
			FREE_ME(rKeySet);
		}

// RSA decrypt info
		if (iRet == PD_OK) {
			BOObjPtr = CreateObj(BOPtr, "BOSecurity", "RSAEncryptData_with_mode");
                        iRet = (unsigned long)(*BOObjPtr)(csKeyFile, csInfo, csDecryptedInfo, PD_TRUE, PD_FALSE, RSA_PKCS1_OAEP_PADDING, 2048);
		}

// Break down decrypted info
 		if (iRet == PD_OK) {
DEBUGLOG(("BreakDownMsg:: decrypted info = [%s]\n", csDecryptedInfo));
			if (Str2Cls(hDecrypted, csDecryptedInfo, MY_UNI_TOKEN, MY_UNI_FIELD_TOKEN) == PD_OK) {
				// 2.1 partner
				if (GetField_CString(hDecrypted, "partner", &csPtr)) {
DEBUGLOG(("BreakDownMsg:: partner = [%s]\n", csPtr));
					PutField_CString(hOut, "partner", csPtr);
				}
				else {
DEBUGLOG(("BreakDownMsg:: partner not found\n"));
				}

				// 2.2 out_trade_no
				if (GetField_CString(hDecrypted, "out_trade_no", &csPtr)) {
DEBUGLOG(("BreakDownMsg:: txn_seq = [%s]\n", csPtr));
					PutField_CString(hOut, "txn_seq", csPtr);
				}
				else {
DEBUGLOG(("BreakDownMsg:: txn_seq not found\n"));
				}

				// 2.3 pay_no
				if (GetField_CString(hDecrypted, "pay_no", &csPtr)) {
DEBUGLOG(("BreakDownMsg:: tid = [%s]\n", csPtr));
					PutField_CString(hOut, "tid", csPtr);
				}
				else {
DEBUGLOG(("BreakDownMsg:: tid not found\n"));
				}

				// 2.4 amount
				if (GetField_CString(hDecrypted, "amount", &csPtr)) {
DEBUGLOG(("BreakDownMsg:: txn_amt = [%s]\n", csPtr));
					PutField_CString(hOut, "txn_amt", csPtr);
				}
				else {
DEBUGLOG(("BreakDownMsg:: txn_amt not found\n"));
				}

				// 2.5 pay_result
				if (GetField_CString(hDecrypted, "pay_result", &csPtr)) {
DEBUGLOG(("BreakDownMsg:: status = [%s]\n", csPtr));
					PutField_CString(hOut, "status", csPtr);
				}
				else {
DEBUGLOG(("BreakDownMsg:: status not found\n"));
				}

				// 2.6 sett_date
				if (GetField_CString(hDecrypted, "sett_date", &csPtr)) {
DEBUGLOG(("BreakDownMsg:: txn_date = [%s]\n", csPtr));
					PutField_CString(hOut, "fundin_date", csPtr);
					PutField_CString(hOut, "txn_date", csPtr);
				}
				else {
DEBUGLOG(("BreakDownMsg:: txn_date not found\n"));
				}

				// 2.7 mdr_fee
				if (GetField_CString(hDecrypted, "mdr_fee", &csPtr)) {
DEBUGLOG(("BreakDownMsg:: mdr_fee = [%s]\n", csPtr));
					PutField_CString(hOut, "mdr_fee", csPtr);
				}
				else {
DEBUGLOG(("BreakDownMsg:: mdr_fee not found\n"));
				}
			} else {
DEBUGLOG(("BreakDownMsg() Error\n"));
				iRet = PD_ERR;
			}
		}
	}
	else {
DEBUGLOG(("BreakDownMsg() Error\n"));
                iRet = PD_ERR;
        }
        
        hash_destroy(hRec);
	FREE_ME(hRec);
	hash_destroy(hPspDetail);
	FREE_ME(hPspDetail);
	hash_destroy(hDecrypted);
	FREE_ME(hDecrypted);
	FREE_ME(csDecryptedInfo);

DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}


int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	return iRet;
}


int BuildRspAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr;
        char*   csBuf;
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildRspAuthData()\n"));
	memset(csBuf,0,MAX_MSG_SIZE);
	csBuf[0] = '\0';
	

/* 1 amount */
	if (GetField_CString(hIn,"txn_amt",&csPtr)) {
		strcat((char*)csBuf,"amount=");
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: amount = [%s]\n",csPtr));
	}

/* 2 base64_memo*/
	if (GetField_CString(hIn,"remark",&csPtr)) {
		strcat((char*)csBuf,MY_UNI_AUTH_TOKEN);
		strcat((char*)csBuf,"base64_memo=");
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: base64_memo = [%s]\n",csPtr));
	}
	else{
		strcat((char*)csBuf,MY_UNI_AUTH_TOKEN);
		strcat((char*)csBuf,"base64_memo=");
DEBUGLOG(("BuildRspAuthData:: base64_memo is null\n"));
	}

/* 3 out_trade_no */
	if (GetField_CString(hIn,"txn_seq",&csPtr)) {
		strcat((char*)csBuf,MY_UNI_AUTH_TOKEN);
		strcat((char*)csBuf,"out_trade_no=");
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: out_trade_no = [%s]\n",csPtr));
	}

/* 4 partner*/
	if (GetField_CString(hIn,"partner",&csPtr)) {
		strcat((char*)csBuf,MY_UNI_AUTH_TOKEN);
		strcat((char*)csBuf,"partner=");
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: partner = [%s]\n",csPtr));
	}

/* 5 pay_no*/
	if (GetField_CString(hIn,"tid",&csPtr)) {
		strcat((char*)csBuf,MY_UNI_AUTH_TOKEN);
		strcat((char*)csBuf,"pay_no=");
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: pay_no = [%s]\n",csPtr));
	}

/* 6 pay_result*/
	if (GetField_CString(hIn,"status",&csPtr)) {
		strcat((char*)csBuf,MY_UNI_AUTH_TOKEN);
		strcat((char*)csBuf,"pay_result=");
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: pay_result = [%s]\n",csPtr));
	}

/* 7 sett_date*/
	if (GetField_CString(hIn,"txn_date",&csPtr)) {
		strcat((char*)csBuf,MY_UNI_AUTH_TOKEN);
		strcat((char*)csBuf,"sett_date=");
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: sett_date = [%s]\n",csPtr));
	}

	PutField_CString(hIn,"auth_data",csBuf);
DEBUGLOG(("BuildRspAuthData:: auth_data = [%s]\n",csBuf));
	FREE_ME(csBuf);
        
DEBUGLOG(("BuildRspAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}


int BuildAuthData(hash_t* hIn)
{
	int	iRet = PD_OK;
	char*	csPtr;
	char*	csBuf;
	double	dTmp;
	csBuf = (char*) malloc (MAX_MSG_SIZE + 1);

DEBUGLOG(("BuildAuthData()\n"));
	memset(csBuf,0,MAX_MSG_SIZE);
	csBuf[0] = '\0';

/* 1 base64_memo */
// optional
	strcat((char*)csBuf,"base64_memo");
	strcat((char*)csBuf,MY_UNI_FIELD_TOKEN);
	strcat((char*)csBuf,MY_UNI_AUTH_TOKEN);

/* 2 notify_url */
	if (GetField_CString(hIn,"return_url_only",&csPtr)) {
		strcat((char*)csBuf,"notify_url");
		strcat((char*)csBuf,MY_UNI_FIELD_TOKEN);
		strcat((char*)csBuf,url_encode(csPtr));
		strcat((char*)csBuf,MY_UNI_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: notify_url = [%s]\n",url_encode(csPtr)));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: *** notify_url is missing\n"));
	}

/* 3 order_number */
	if (GetField_CString(hIn,"txn_seq",&csPtr)) {
		strcat((char*)csBuf,"order_number");
		strcat((char*)csBuf,MY_UNI_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_UNI_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: order_number = [%s]\n",csPtr));
	}

/* 3.5 order_timestamp */
	if (GetField_CString(hIn, "local_tm_date", &csPtr)) {
		char *csPtr2 = NULL;
		char csRaw[PD_DATETIME_LEN * 2];
		char csConverted[PD_DATETIME_LEN * 2];
		struct tm tm;
		if (GetField_CString(hIn, "local_tm_time", &csPtr2)) {
			sprintf(csRaw, "%s%s", csPtr, csPtr2);
			strptime((const char*)csRaw, "%Y%m%d%H%M%S", &tm);
			strftime(csConverted, sizeof(csConverted), "%s", &tm);
			strcat((char*)csBuf, "order_timestamp");
			strcat((char*)csBuf, MY_UNI_FIELD_TOKEN);
			strcat((char*)csBuf, csConverted);
			strcat((char*)csBuf, MY_UNI_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: order_timestamp = [%s]\n", csConverted));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: *** local_tm_time is missing\n"));
		}
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: *** local_tm_date is missing\n"));
	}

/* 4 pay_id */
	if (GetField_CString(hIn,"bank_code",&csPtr)) {
		strcat((char*)csBuf,"pay_id");
		strcat((char*)csBuf,MY_UNI_FIELD_TOKEN);
		DBObjPtr = CreateObj(DBPtr,"DBMobBankMap","IsMobileOption");
		int iOpt = (unsigned long)(*DBObjPtr)(csPtr);
		if (iOpt==PD_FALSE && iOpt!=INT_ERR) {
			strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildAuthData:: pay_id = [%s]\n",csPtr));
		}
		else if (iOpt==PD_TRUE) {
			if (GetField_CString(hIn,"psp_key_id",&csPtr)) {
				strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildAuthData:: pay_id = [%s]\n",csPtr));
			}
		}
		strcat((char*)csBuf,MY_UNI_AUTH_TOKEN);
	}
	else {
DEBUGLOG(("BuildAuthData:: pay_id is missing!!!\n"));
	}

/* 5 card_type */
	strcat((char*)csBuf,"card_type");
	strcat((char*)csBuf,MY_UNI_FIELD_TOKEN);
	strcat((char*)csBuf,"01");
	strcat((char*)csBuf,MY_UNI_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: card_type = [01]\n"));

/* 6 return_url */
	if (GetField_CString(hIn,"fe_url",&csPtr)) {
		strcat((char*)csBuf,"return_url");
		strcat((char*)csBuf,MY_UNI_FIELD_TOKEN);
		strcat((char*)csBuf,url_encode(csPtr));
		strcat((char*)csBuf,MY_UNI_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: return_url = [%s]\n",url_encode(csPtr)));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: *** return_url is missing\n"));
	}

/* 7 total_fee */
	if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {
		char csTmpAmt[PD_TMP_BUF_LEN + 1];
		sprintf((char*)csTmpAmt,"%.2f",dTmp);
		strcat((char*)csBuf,"total_fee");
		strcat((char*)csBuf,MY_UNI_FIELD_TOKEN);
		strcat((char*)csBuf,csTmpAmt);
		strcat((char*)csBuf,MY_UNI_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: total_fee = [%s]\n",csTmpAmt));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: *** total_fee is missing\n"));
	}

/* 8 version */
// optional
	strcat((char*)csBuf,"version");
	strcat((char*)csBuf,MY_UNI_FIELD_TOKEN);

	PutField_CString(hIn,"auth_data",csBuf);
DEBUGLOG(("BuildAuthData:: auth_data = [%s]\n",csBuf));
	FREE_ME(csBuf);

DEBUGLOG(("BuildAuthData() Exit iRet = [%d]\n",iRet));
	return iRet;
}

