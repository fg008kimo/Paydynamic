/*
Partnerdelight (c)2011. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2011/05/17              Cody Chan
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "PgnMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include "internal.h"
#include <zlib.h>
#include "ObjPtr.h"


char	cDebug;


void	PgnMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int iRet = PD_OK;
	char*	csPtr;
	char*	csTxnCode;
	char*	csURL;
	char*	csBuf;
	double	dTmp;
	long	lTmp;


	csBuf = (char*) malloc (PD_TMP_BUF_LEN * 2 + 1 );
	
	outMsg[0]='\0';
	*outLen = 0;

//txn code
        if (GetField_CString(hIn,"txn_code",&csTxnCode)) {
DEBUGLOG(("FormatMsg:: txn_code = [%s]\n",csTxnCode));
        }
	else {
DEBUGLOG(("FormatMsg:: txn_code  is missing!!!\n"));
		iRet = PD_ERR;
	}

	//psp_url
        if (GetField_CString(hIn,"psp_url",&csURL) && iRet == PD_OK) {
//request_function
                strcpy((char*)csBuf,"TC");
                strcat((char*)csBuf,MY_PGEN_FIELD_TOKEN);
                strcat((char*)csBuf,csTxnCode);
                strcat((char*)csBuf,MY_PGEN_TOKEN);

		
                if (GetField_CString(hIn,"request_function",&csPtr)) {
                        strcat((char*)csBuf,"url");
DEBUGLOG(("FormatMsg:: psp_url = [%s]\n",csURL));
                        strcat((char*)csBuf,MY_PGEN_FIELD_TOKEN);
                        strcat((char*)csBuf,csURL);
                        strcat((char*)csBuf,"/");
                        strcat((char*)csBuf,csPtr);
                        strcat((char*)csBuf,MY_PGEN_TOKEN);
                }

                sprintf(outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));
                strcat(outMsg,csBuf);
        }
	else {
		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: psp_url not found\n"));
	}
        FREE_ME(csBuf);

/* merchant_id */
     	if (GetField_CString(hIn,"psp_merchant_id",&csPtr) && iRet == PD_OK) {
       		strcat((char*)outMsg,"merchant_id");
                strcat((char*)outMsg,MY_PGEN_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_PGEN_TOKEN);
DEBUGLOG(("FormatMsg:: psp_merchant_id = [%s]\n",csPtr));
     	}
        else {
       		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** psp_merchant_id is missing\n"));
        }

/* psp_key_id */
     	if (GetField_CString(hIn,"psp_key_id",&csPtr) && iRet == PD_OK) {
       		strcat((char*)outMsg,"connect_id");
                strcat((char*)outMsg,MY_PGEN_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_PGEN_TOKEN);
DEBUGLOG(("FormatMsg:: psp_key_id = [%s]\n",csPtr));
     	}
        else {
       		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** psp_key_id is missing\n"));
        }

/* psp_key */
     	if (GetField_CString(hIn,"psp_key",&csPtr) && iRet == PD_OK) {
       		strcat((char*)outMsg,"connect_password");
                strcat((char*)outMsg,MY_PGEN_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_PGEN_TOKEN);
DEBUGLOG(("FormatMsg:: psp_key = [%s]\n",csPtr));
     	}
        else {
       		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** psp_key is missing\n"));
        }
/* telegram_kind */
 //    	if (GetField_CString(hIn,"telegram_kind",&csPtr) && iRet == PD_OK) {
       		strcat((char*)outMsg,"telegram_kind");
                strcat((char*)outMsg,MY_PGEN_FIELD_TOKEN);
                strcat((char*)outMsg,"060");
                strcat((char*)outMsg,MY_PGEN_TOKEN);
/*
DEBUGLOG(("FormatMsg:: telegram_kind = [%s]\n",csPtr));
     	}
        else {
       		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** telegram_kind is missing\n"));
        }
*/
/* telegram_version */
//     	if (GetField_CString(hIn,"telegram_version",&csPtr) && iRet == PD_OK) {
       		strcat((char*)outMsg,"telegram_version");
                strcat((char*)outMsg,MY_PGEN_FIELD_TOKEN);
                strcat((char*)outMsg,"1.0");
                strcat((char*)outMsg,MY_PGEN_TOKEN);
/*
DEBUGLOG(("FormatMsg:: telegram_version = [%s]\n",csPtr));
     	}
        else {
       		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** telegram_version is missing\n"));
        }
*/

//order_num
        if (GetField_CString(hIn,"order_num",&csPtr) && iRet == PD_OK) {
DEBUGLOG(("FormatMsg:: order_num = [%s]\n",csPtr));
                strcat((char*)outMsg,"trading_id");
                strcat((char*)outMsg,MY_PGEN_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_PGEN_TOKEN);
        }
	else {
       		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** order_num is missing\n"));
	}

//amount
        if (GetField_Double(hIn,"psp_txn_amt",&dTmp) && iRet == PD_OK) {
		char*	csTmp;
DEBUGLOG(("FormatMsg:: amount = [%lf]\n",dTmp));
                lTmp = double2long(dTmp)/100;
		csTmp = (char*) malloc (PD_TMP_BUF_LEN + 1);
                sprintf(csTmp,"%ld",lTmp);
DEBUGLOG(("FormatMsg:: amount = [%ld]\n",lTmp));
                strcat((char*)outMsg,"amount");
                strcat((char*)outMsg,MY_PGEN_FIELD_TOKEN);
                strcat((char*)outMsg,csTmp);
                strcat((char*)outMsg,MY_PGEN_TOKEN);
		FREE_ME(csTmp);

        }
	else {
       		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** psp_txn_amt is missing\n"));
	}

/*claim_kana*/
                strcat((char*)outMsg,"claim_kana");
                strcat((char*)outMsg,MY_PGEN_FIELD_TOKEN);
                strcat((char*)outMsg,"testing");
                strcat((char*)outMsg,MY_PGEN_TOKEN);
/*claim_kanji*/
                strcat((char*)outMsg,"claim_kanji");
                strcat((char*)outMsg,MY_PGEN_FIELD_TOKEN);
                strcat((char*)outMsg,code_convert(PD_HOST_CODE,PD_JAP_CODE,"備考"));
                strcat((char*)outMsg,MY_PGEN_TOKEN);
	
/* return url*/
        if (GetField_CString(hIn,"fe_url",&csPtr) && iRet == PD_OK) {
DEBUGLOG(("FormatMsg::fe_url = [%s]\n",csPtr));
                strcat((char*)outMsg,"return_url");
                strcat((char*)outMsg,MY_PGEN_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_PGEN_TOKEN);

                strcat((char*)outMsg,"stop_return_url");
                strcat((char*)outMsg,MY_PGEN_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_PGEN_TOKEN);
        }
	else {
       		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***fe_url is missing\n"));
	}

/* bank code */
/*
        strcat((char*)outMsg,"bank_code");
        strcat((char*)outMsg,MY_PGEN_FIELD_TOKEN);
        strcat((char*)outMsg,"0001");
        strcat((char*)outMsg,MY_PGEN_TOKEN);
*/

/* pc_mobile_type */
/*
        strcat((char*)outMsg,"pc_mobile_type");
        strcat((char*)outMsg,MY_PGEN_FIELD_TOKEN);
        strcat((char*)outMsg,"0");
        strcat((char*)outMsg,MY_PGEN_TOKEN);
*/


	if (iRet == PD_OK) {
		*outLen = strlen(outMsg);
	}
        *outLen = strlen(outMsg);
	FREE_ME(csBuf);
DEBUGLOG(("FormatMsg() [%s][%d]\n",outMsg,*outLen));
DEBUGLOG(("FormatMsg:: iRet = [%d]\n",iRet));
	return iRet;
}

int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	char    MY_TOKEN[] =    "\n";
	int	iRet = PD_OK;
	char*	csPtr;
	hash_t	*hRec;

	hRec = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hRec,0);


DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));

	if (Str2Cls(hRec,inMsg,MY_TOKEN, MY_PGEN_FIELD_TOKEN) == PD_OK) {
		
		
/* result */
        	if (GetField_CString(hRec,"result",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: status = [%s]\n",csPtr));
               		PutField_CString(hOut,"status",csPtr);
        	}       
        	else {
DEBUGLOG(("BreakDownMsg:: status not found\n"));
        	}
/* response_code */
        	if (GetField_CString(hRec,"response_code",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: error_code = [%s]\n",csPtr));
               		PutField_CString(hOut,"error_code",csPtr);
        	}       
/* trading_id */
        	if (GetField_CString(hRec,"trading_id",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: txn_seq = [%s]\n",csPtr));
 	               PutField_CString(hOut,"txn_seq",csPtr);
       	 	}       
        	else {
DEBUGLOG(("BreakDownMsg:: txn_seq not found\n"));
        	}
        
/* asp_limit_date */
        	if (GetField_CString(hRec,"asp_limit_date",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: asp_limit_date = [%s]\n",csPtr));
 	               PutField_CString(hOut,"limit_date",csPtr);
        	}
        	else {
DEBUGLOG(("BreakDownMsg:: asp_limit_date not found\n"));
        	}
        
/* asp_payment_limit_date */
        	if (GetField_CString(hRec,"asp_payment_limit_date",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: asp_payment_limit_date = [%s]\n",csPtr));
 	               PutField_CString(hOut,"payment_limit_date",csPtr);
        	}
        	else {
DEBUGLOG(("BreakDownMsg:: asp_payment_limit_date not found\n"));
        	}

/* deposit_url */
        	if (GetField_CString(hRec,"asp_url",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: deposit_url = [%s]\n",csPtr));
                	PutField_CString(hOut,"deposit_url",csPtr);
        	}
        	else {
DEBUGLOG(("BreakDownMsg:: deposit_url not found\n"));
        	}

/* amount */
        	if (GetField_CString(hRec,"amount",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: txn_amt = [%s]\n",csPtr));
 	               PutField_CString(hOut,"txn_amt",csPtr);
        	}
        	else {
DEBUGLOG(("BreakDownMsg:: txn_amt not found\n"));
        	}
/* claim_kana */
        	if (GetField_CString(hRec,"claim_kana",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: claim_kana = [%s]\n",csPtr));
        	}
        	else {
DEBUGLOG(("BreakDownMsg:: claim_kana not found\n"));
		}

/* claim_kanji */
        	if (GetField_CString(hRec,"claim_kanji",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: claim_kanji = [%s]\n",csPtr));
        	}
        	else {
DEBUGLOG(("BreakDownMsg:: claim_kanji not found\n"));
        	}

/* txn_date */
        	if (GetField_CString(hRec,"trade_generation_date",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: txn_date = [%s]\n",csPtr));
	                PutField_CString(hOut,"txn_date",csPtr);
       	 	}
        	else {
DEBUGLOG(("BreakDownMsg:: txn_date not found\n"));
        	}

	}
	else {
DEBUGLOG(("BreakDownMsg() Error\n"));
		iRet = PD_ERR;
	}

	hash_destroy(hRec);
        FREE_ME(hRec);
        return iRet;
}


int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
        int     iRet = PD_OK;

DEBUGLOG(("initReplyFromRequest() ret = [%d]\n",iRet));
	return iRet;
}
