/*
PDProTech (c)2017. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2017/12/11              David Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "RfeMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"
#include "internal.h"
#include "ObjPtr.h"
#define __USE_XOPEN
#include <time.h>

char cDebug;
OBJPTR(DB);


void RfeMsg(char cdebug)
{
	cDebug = cdebug;
}


int FormatMsg(const hash_t *hIn, unsigned char *outMsg, int *outLen)
{
	int	iRet = PD_OK;
	char	*csTmp = NULL;
	char	*csPtr = NULL;
	char	*csBuf;
	double	dTmp;
	char	*csMethod = NULL;

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1);

	memset(outMsg, 0, sizeof(outMsg));
	if (GetField_CString(hIn, "redirect_url", &csPtr)) {
DEBUGLOG(("FormatMsg here\n"));
		strcat((char*)outMsg, csPtr);
		strcat((char*)outMsg, "?");

// payKey
		if (GetField_CString(hIn, "psp_merchant_id", &csTmp)) {
			strcat((char*)outMsg, "payKey");
			strcat((char*)outMsg, MY_RFE_FIELD_TOKEN);
			strcat((char*)outMsg, csTmp);
			strcat((char*)outMsg, MY_RFE_TOKEN);
DEBUGLOG(("FormatMsg:: payKey = [%s]\n", csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***psp_merchant_id is missing\n"));
		}

// orderPrice
		if (GetField_Double(hIn, "psp_txn_amt", &dTmp)) {
			char csTmpAmt[PD_TMP_BUF_LEN + 1];
			//sprintf((char*)csTmpAmt, "%ld", double2long(dTmp));
			sprintf((char*)csTmpAmt, "%.2f", dTmp);
			strcat((char*)outMsg, "orderPrice");
			strcat((char*)outMsg, MY_RFE_FIELD_TOKEN);
			strcat((char*)outMsg, csTmpAmt);
			strcat((char*)outMsg, MY_RFE_TOKEN);
DEBUGLOG(("FormatMsg:: orderPrice = [%s]\n", csTmpAmt));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***psp_txn_amt is missing\n"));
		}

// outTradeNo
		if (GetField_CString(hIn, "txn_seq", &csTmp)) {
			strcat((char*)outMsg, "outTradeNo");
			strcat((char*)outMsg, MY_RFE_FIELD_TOKEN);
			strcat((char*)outMsg, csTmp);
			strcat((char*)outMsg, MY_RFE_TOKEN);
DEBUGLOG(("FormatMsg:: outTradeNo = [%s]\n", csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***txn_seq is missing\n"));
		}

// productType
		strcat((char*)outMsg, "productType");
		strcat((char*)outMsg, MY_RFE_FIELD_TOKEN);
		strcat((char*)outMsg, MY_RFE_PRODUCT_TYPE);
		strcat((char*)outMsg, MY_RFE_TOKEN);
DEBUGLOG(("FormatMsg:: productType = [%s]\n", MY_RFE_PRODUCT_TYPE));

// orderTime
		if (GetField_CString(hIn, "local_tm_date", &csTmp)) {
			char *csTmp2 = NULL;
			char csRaw[PD_DATETIME_LEN + 1];
			if (GetField_CString(hIn, "local_tm_time", &csTmp2)) {
				sprintf(csRaw, "%s%s", csTmp, csTmp2);
				strcat((char*)outMsg, "orderTime");
				strcat((char*)outMsg, MY_RFE_FIELD_TOKEN);
				strcat((char*)outMsg, csRaw);
				strcat((char*)outMsg, MY_RFE_TOKEN);
DEBUGLOG(("FormatMsg:: orderTime = [%s]\n", csRaw));
			}
			else {
				iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***local_tm_time is missing\n"));
			}
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***local_tm_date is missing\n"));
		}

// productName
		strcat((char*)outMsg, "productName");
		strcat((char*)outMsg, MY_RFE_FIELD_TOKEN);
		strcat((char*)outMsg, MY_RFE_PRODUCT_NAME);
		strcat((char*)outMsg, MY_RFE_TOKEN);
DEBUGLOG(("FormatMsg:: productName = [%s]\n", MY_RFE_PRODUCT_NAME));

// orderIp
		if (GetField_CString(hIn, "user_ip", &csTmp)) {
			strcat((char*)outMsg, "orderIp");
			strcat((char*)outMsg, MY_RFE_FIELD_TOKEN);
			strcat((char*)outMsg, csTmp);
			strcat((char*)outMsg, MY_RFE_TOKEN);
DEBUGLOG(("FormatMsg:: orderIp = [%s]\n", csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***user_ip is missing\n"));
		}

// returnUrl
		if (GetField_CString(hIn, "fe_url", &csTmp)) {
			strcat((char*)outMsg, "returnUrl");
			strcat((char*)outMsg, MY_RFE_FIELD_TOKEN);
			strcat((char*)outMsg, csTmp);
			strcat((char*)outMsg, MY_RFE_TOKEN);
DEBUGLOG(("FormatMsg:: returnUrl = [%s]\n", csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***fe_url is missing\n"));
		}

// notifyUrl
		if (GetField_CString(hIn, "return_url_only", &csTmp)) {
			strcat((char*)outMsg, "notifyUrl");
			strcat((char*)outMsg, MY_RFE_FIELD_TOKEN);
			strcat((char*)outMsg, csTmp);
			strcat((char*)outMsg, MY_RFE_TOKEN);
DEBUGLOG(("FormatMsg:: notifyUrl = [%s]\n", csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***return_url_only is missing\n"));
		}

// sign
		if (GetField_CString(hIn, "sign", &csTmp)) {
			strcat((char*)outMsg, "sign");
			strcat((char*)outMsg, MY_RFE_FIELD_TOKEN);
			strcat((char*)outMsg, csTmp);
DEBUGLOG(("FormatMsg:: sign = [%s]\n", csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***sign is missing\n"));
		}

// url_method
		if (GetField_CString(hIn, "url_method", &csMethod)) {
DEBUGLOG(("FormatMsg:: url_method = [%s]\n", csMethod));
		}
		else
			csMethod = strdup("");

DEBUGLOG(("FormatMsg:: outmsg = [%s]\n", outMsg));
		base64_encode(outMsg, strlen((char*)outMsg), csBuf, PD_MAX_BUFFER);
DEBUGLOG(("FormatMsg:: after encode\n"));
		outMsg[0] = '\0';
		strcat((char*)outMsg, "redirect_url");
		strcat((char*)outMsg, "=");
		strcat((char*)outMsg, csBuf);
		strcat((char*)outMsg, MY_RFE_TOKEN);
		strcat((char*)outMsg, "url_method");
		strcat((char*)outMsg, "=");
		strcat((char*)outMsg, csMethod);
		strcat((char*)outMsg, MY_RFE_TOKEN);
		strcat((char*)outMsg, "ret_status=0");
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n", outMsg));

		*outLen = strlen((const char*)outMsg);
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***redirect_url is missing\n"));
	}

DEBUGLOG(("FormatMsg:: normal exit iRet = [%d]\n", iRet));
	FREE_ME(csBuf);
	return iRet;
}


int BreakDownMsg(hash_t *hOut, const unsigned char *inMsg, int inLen)
{
	int	iRet = PD_OK;
	char	*csPtr;
	hash_t 	*hRec;

	hRec = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRec, 0);

DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n", inMsg, inLen));

	if (Str2Cls(hRec, (char *)inMsg, MY_RFE_TOKEN, MY_RFE_FIELD_TOKEN) == PD_OK) {
// field2
		if (GetField_CString(hRec, "field2", &csPtr)) {
			PutField_CString(hOut, "field2", csPtr);
DEBUGLOG(("BreakDownMsg:: field2 = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: field2 not found\n"));
		}

// orderPrice
		if (GetField_CString(hRec, "orderPrice", &csPtr)) {
			PutField_CString(hOut, "psp_txn_amt", csPtr);
			PutField_CString(hOut, "txn_amt", csPtr);
DEBUGLOG(("BreakDownMsg:: orderPrice:txn_amt = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: orderPrice:txn_amt not found\n"));
		}

// orderTime
		if (GetField_CString(hRec, "orderTime", &csPtr)) {
			PutField_CString(hOut, "order_time", csPtr);
DEBUGLOG(("BreakDownMsg:: orderTime:order_time = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: orderTime:order_time not found\n"));
		}

// outTradeNo
		if (GetField_CString(hRec, "outTradeNo", &csPtr)) {
			PutField_CString(hOut, "txn_seq", csPtr);
DEBUGLOG(("BreakDownMsg:: outTradeNo:txn_seq = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: outTradeNo:txn_seq not found\n"));
		}

// payKey
		if (GetField_CString(hRec, "payKey", &csPtr)) {
			PutField_CString(hOut, "psp_merchant_id", csPtr);
DEBUGLOG(("BreakDownMsg:: payKey:psp_merchant_id = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: payKey:psp_merchant_id not found\n"));
		}

// productName
		if (GetField_CString(hRec, "productName", &csPtr)) {
			PutField_CString(hOut, "product_name", csPtr);
DEBUGLOG(("BreakDownMsg:: productName:product_name = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: productName:product_name not found\n"));
		}

// productType
		if (GetField_CString(hRec, "productType", &csPtr)) {
			PutField_CString(hOut, "product_type", csPtr);
DEBUGLOG(("BreakDownMsg:: productType:product_type = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: productType:product_type not found\n"));
		}

// successTime
		if (GetField_CString(hRec, "successTime", &csPtr)) {
			char csTxnDate[PD_DATE_LEN + 1];
			strncpy(csTxnDate, csPtr, PD_DATE_LEN);
			csTxnDate[PD_DATE_LEN] = '\0';

			PutField_CString(hOut, "fundin_date", csPtr);
			PutField_CString(hOut, "txn_date", csTxnDate);
DEBUGLOG(("BreakDownMsg:: successTime:fundin_date = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: successTime:fundin_date not found\n"));
		}

// tradeStatus
		if (GetField_CString(hRec, "tradeStatus", &csPtr)) {
			PutField_CString(hOut, "status", csPtr);
DEBUGLOG(("BreakDownMsg:: tradeStatus:status = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: tradeStatus:status not found\n"));
		}

// trxNo
		if (GetField_CString(hRec, "trxNo", &csPtr)) {
			PutField_CString(hOut, "tid", csPtr);
DEBUGLOG(("BreakDownMsg:: trxNo:tid = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: trxNo:tid not found\n"));
		}

// sign
		if (GetField_CString(hRec, "sign", &csPtr)) {
			PutField_CString(hOut, "sign", csPtr);
DEBUGLOG(("BreakDownMsg:: sign:sign = [%s]\n", csPtr));
		}
		else {
			PutField_CString(hOut, "sign", " ");
DEBUGLOG(("BreakDownMsg:: sign:sign not found\n"));
		}
	}
	else {
DEBUGLOG(("BreakDownMsg() Error\n"));
		iRet = PD_ERR;
	}

	hash_destroy(hRec);
	FREE_ME(hRec);

DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}


int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	return iRet;
}


int BuildAuthData(hash_t *hIn)
{
	int	iRet = PD_OK;
	char	*csPtr;
	char	*csBuf;
	double	dTmp;
	csBuf = (char*) malloc (MAX_MSG_SIZE + 1);

DEBUGLOG(("BuildAuthData()\n"));
	memset(csBuf, 0, MAX_MSG_SIZE);
	csBuf[0] = '\0';

// notifyUrl
	if (GetField_CString(hIn, "return_url_only", &csPtr)) {
		strcat((char*)csBuf, "notifyUrl");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
DEBUGLOG(("BuildAuthData:: notifyUrl = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: return_url_only is missing\n"));
	}

// orderIp
	if (GetField_CString(hIn, "user_ip", &csPtr)) {
		strcat((char*)csBuf, "orderIp");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
DEBUGLOG(("BuildAuthData:: orderIp = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: user_ip is missing\n"));
	}

// orderPrice
	if (GetField_Double(hIn, "psp_txn_amt", &dTmp)) {
		char csTmpAmt[PD_TMP_BUF_LEN + 1];
		//sprintf((char*)csTmpAmt, "%ld", double2long(dTmp));
		sprintf((char*)csTmpAmt, "%.2f", dTmp);
		strcat((char*)csBuf, "orderPrice");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csTmpAmt);
		strcat((char*)csBuf, MY_RFE_TOKEN);
DEBUGLOG(("BuildAuthData:: orderPrice = [%s]\n", csTmpAmt));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: psp_txn_amt is missing\n"));
	}

// orderTime
	if (GetField_CString(hIn, "local_tm_date", &csPtr)) {
		char *csPtr2 = NULL;
		char csRaw[PD_DATETIME_LEN + 1];
		if (GetField_CString(hIn, "local_tm_time", &csPtr2)) {
			sprintf(csRaw, "%s%s", csPtr, csPtr2);
			strcat((char*)csBuf, "orderTime");
			strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
			strcat((char*)csBuf, csRaw);
			strcat((char*)csBuf, MY_RFE_TOKEN);
DEBUGLOG(("BuildAuthData:: orderTime = [%s]\n", csRaw));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: local_tm_time is missing\n"));
		}
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: local_tm_date is missing\n"));
	}

// outTradeNo
	if (GetField_CString(hIn, "txn_seq", &csPtr)) {
		strcat((char*)csBuf, "outTradeNo");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
DEBUGLOG(("BuildAuthData:: outTradeNo = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: txn_seq is missing\n"));
	}

// payKey
	if (GetField_CString(hIn, "psp_merchant_id", &csPtr)) {
		strcat((char*)csBuf, "payKey");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
DEBUGLOG(("BuildAuthData:: payKey = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: psp_merchant_id is missing\n"));
	}

// productName
	strcat((char*)csBuf, "productName");
	strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
	strcat((char*)csBuf, MY_RFE_PRODUCT_NAME);
	strcat((char*)csBuf, MY_RFE_TOKEN);
DEBUGLOG(("BuildAuthData:: productName = [%s]\n", MY_RFE_PRODUCT_NAME));

// productType
	strcat((char*)csBuf, "productType");
	strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
	strcat((char*)csBuf, MY_RFE_PRODUCT_TYPE);
	strcat((char*)csBuf, MY_RFE_TOKEN);
DEBUGLOG(("BuildAuthData:: productType = [%s]\n", MY_RFE_PRODUCT_TYPE));

// returnUrl
	if (GetField_CString(hIn, "fe_url", &csPtr)) {
		strcat((char*)csBuf, "returnUrl");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
DEBUGLOG(("BuildAuthData:: returnUrl = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: fe_url is missing\n"));
	}

	PutField_CString(hIn, "auth_data", csBuf);
DEBUGLOG(("BuildAuthData:: auth_data = [%s]\n", csBuf));
	FREE_ME(csBuf);
        
DEBUGLOG(("BuildAuthData() Exit iRet = [%d]\n", iRet));
	return iRet;
}


int BuildRspAuthData(hash_t *hIn)
{
	int iRet = PD_OK;
	char *csPtr;
	char *csBuf;
	csBuf = (char*) malloc (MAX_MSG_SIZE + 1);

DEBUGLOG(("BuildRspAuthData()\n"));
	memset(csBuf, 0, MAX_MSG_SIZE);
	csBuf[0] = '\0';

// field2
	if (GetField_CString(hIn, "field2", &csPtr)) {
DEBUGLOG(("BuildRspAuthData:: field2 = [%s]\n", csPtr));
		strcat((char*)csBuf, "field2");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
	}

// orderPrice
	if (GetField_CString(hIn, "psp_txn_amt", &csPtr)) {
DEBUGLOG(("BuildRspAuthData:: orderPrice:psp_txn_amt = [%s]\n", csPtr));
		strcat((char*)csBuf, "orderPrice");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
	}

// orderTime
	if (GetField_CString(hIn, "order_time", &csPtr)) {
DEBUGLOG(("BuildRspAuthData:: orderTime:order_time = [%s]\n", csPtr));
		strcat((char*)csBuf, "orderTime");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
	}

// outTradeNo
	if (GetField_CString(hIn, "txn_seq", &csPtr)) {
DEBUGLOG(("BuildRspAuthData:: outTradeNo:txn_seq = [%s]\n", csPtr));
		strcat((char*)csBuf, "outTradeNo");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
	}

// payKey
	if (GetField_CString(hIn, "psp_merchant_id", &csPtr)) {
DEBUGLOG(("BuildRspAuthData:: payKey:psp_merchant_id = [%s]\n", csPtr));
		strcat((char*)csBuf, "payKey");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
	}

// productName
	if (GetField_CString(hIn, "product_name", &csPtr)) {
DEBUGLOG(("BuildRspAuthData:: productName:product_name = [%s]\n", csPtr));
		strcat((char*)csBuf, "productName");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
	}

// productType
	if (GetField_CString(hIn, "product_type", &csPtr)) {
DEBUGLOG(("BuildRspAuthData:: productType:product_type = [%s]\n", csPtr));
		strcat((char*)csBuf, "productType");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
	}

// successTime
	if (GetField_CString(hIn, "fundin_date", &csPtr)) {
DEBUGLOG(("BuildRspAuthData:: successTime:fundin_date = [%s]\n", csPtr));
		strcat((char*)csBuf, "successTime");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
	}

// tradeStatus
	if (GetField_CString(hIn, "status", &csPtr)) {
DEBUGLOG(("BuildRspAuthData:: tradeStatus:status = [%s]\n", csPtr));
		strcat((char*)csBuf, "tradeStatus");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
	}

// trxNo
	if (GetField_CString(hIn, "tid", &csPtr)) {
DEBUGLOG(("BuildRspAuthData:: trxNo:tid = [%s]\n", csPtr));
		strcat((char*)csBuf, "trxNo");
		strcat((char*)csBuf, MY_RFE_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_RFE_TOKEN);
	}

	PutField_CString(hIn, "auth_data", csBuf);
DEBUGLOG(("BuildRspAuthData:: auth_data = [%s]\n", csBuf));
	FREE_ME(csBuf);

DEBUGLOG(("BuildRspAuthData() Exit iRet = [%d]\n", iRet));
	return iRet;
}

