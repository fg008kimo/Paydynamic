/*
PDProTech (c)2018. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version					   2018/04/27              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "ZpeMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"
#include "ObjPtr.h"
#include "myhash.h"
#include "myrecordset.h"
#include "internal.h"
#define __USE_XOPEN
#include <time.h>
#include <json-c/json.h>


OBJPTR(DB);

static char	cDebug;

void	ZpeMsg(char cdebug)
{
	cDebug = cdebug;
}

char *str_replace(char *orig, char *rep, char *with);


int FormatMsg(const hash_t *hIn, unsigned char *outMsg, int *outLen)
{
        int     iRet = PD_OK;
        char    *csPtr = NULL;
        char    *csBankCode = NULL;
        char    *csBuf;
        double  dTmp;
        char    *csMethod = NULL;
        char    csData[MAX_MSG_SIZE + 1];
        int     iOpt = INT_ERR;
        int     iIsVnet = PD_FALSE;

        csBuf = (char*) malloc (MAX_MSG_SIZE + 1);

        memset(outMsg, 0, sizeof(outMsg));
        if (GetField_CString(hIn, "redirect_url", &csPtr)) {
DEBUGLOG(("FormatMsg here\n"));
                strcat((char*)outMsg, csPtr);
                strcat((char*)outMsg, "?");

                json_object *jobj = json_object_new_object();

// Merchant_ID
		if (GetField_CString(hIn, "psp_merchant_id", &csPtr)) {
			json_object_object_add(jobj, "Merchant_ID", json_object_new_string(csPtr));
DEBUGLOG(("Merchant_ID = [%s]\n", csPtr));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***psp_merchant_id is missing\n"));
		}

// Country
		json_object_object_add(jobj, "Country", json_object_new_string(MY_ZPE_COUNTRY));
DEBUGLOG(("Country (default) = [%s]\n", MY_ZPE_COUNTRY));

// Pay_Code
		if (GetField_CString(hIn, "bank_code", &csBankCode)) {
			DBObjPtr = CreateObj(DBPtr,"DBMobBankMap","IsMobileOption");
			iOpt = (unsigned long)(*DBObjPtr)(csBankCode);
			if (iOpt == PD_FALSE && iOpt != INT_ERR) {
				iIsVnet = PD_TRUE;
				json_object_object_add(jobj, "Pay_Code", json_object_new_string(MY_ZPE_PAYCODE_WEB));
DEBUGLOG(("Pay_Code = [%s]\n", MY_ZPE_PAYCODE_WEB));
			} else if (iOpt && iOpt != INT_ERR) {
				json_object_object_add(jobj, "Pay_Code", json_object_new_string(MY_ZPE_PAYCODE_EC));
DEBUGLOG(("Pay_Code = [%s]\n", MY_ZPE_PAYCODE_EC));
			}
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***bank_code is missing\n"));
		}


// Merchant_Ref
		if (GetField_CString(hIn, "txn_seq", &csPtr)) {
			json_object_object_add(jobj, "Merchant_Ref", json_object_new_string(csPtr));
DEBUGLOG(("Merchant_Ref = [%s]\n", csPtr));
		}
		else {  
			iRet = PD_ERR;
DEBUGLOG(("***order_num is missing\n"));
		}

// Mer_txn_date
		if (GetField_CString(hIn,"local_tm_date",&csPtr)) {
			char*   csPtr2;
			char    csDateTime[PD_DATETIME_LEN * 2];
			if (GetField_CString(hIn,"local_tm_time",&csPtr2)) {
				sprintf(csDateTime,"%s%s",csPtr,csPtr2);
				json_object_object_add(jobj, "Mer_txn_date", json_object_new_string(csDateTime));
DEBUGLOG(("Mer_txn_date = [%s]\n",csDateTime));
			}
			else {
DEBUGLOG(("local_tm_time is missing!!!\n"));
			}
		}
		else {
DEBUGLOG(("local_tm_date is missing!!!\n"));
		}


// Currency
		if (GetField_CString(hIn,"psp_txn_ccy",&csPtr)) {
			json_object_object_add(jobj, "Currency", json_object_new_string(csPtr));
DEBUGLOG(("Currency = [%s]\n", csPtr));
		}
		else{
			json_object_object_add(jobj, "Currency", json_object_new_string(MY_ZPE_CCY_CODE));
DEBUGLOG(("Currency (default) = [%s]\n", MY_ZPE_CCY_CODE));
		}

// Amount
		if (GetField_Double(hIn, "psp_txn_amt", &dTmp)) {
			char csTmpAmt[PD_TMP_BUF_LEN + 1];
			sprintf((char*)csTmpAmt, "%.2f", dTmp);
			json_object_object_add(jobj, "Amount", json_object_new_string(csTmpAmt));
DEBUGLOG(("Amount = [%s]\n", csTmpAmt));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***psp_txn_amt is missing\n"));
		}


// Bank_Code
		if (iIsVnet) {
DEBUGLOG(("PH bank_code = [%s]\n", csBankCode));
			json_object_object_add(jobj, "Bank_Code", json_object_new_string(csBankCode));
		}

// Success_URL
		if (GetField_CString(hIn, "fe_url", &csPtr)) {
			json_object_object_add(jobj, "Success_URL", json_object_new_string(csPtr));
DEBUGLOG(("Success_URL = [%s]\n", csPtr));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***fe_url is missing\n"));
		}

// Callback_URL
		if (GetField_CString(hIn, "return_url_only", &csPtr)) {
			json_object_object_add(jobj, "Callback_URL", json_object_new_string(csPtr));
DEBUGLOG(("Callback_URL = [%s]\n", csPtr));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***return_url_only is missing\n"));
		}

// Signature
		if (GetField_CString(hIn, "sign", &csPtr)) {
			json_object_object_add(jobj, "Signature", json_object_new_string(csPtr));
DEBUGLOG(("Signature = [%s]\n", csPtr));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***sign is missing\n"));
		}

// Verno
		json_object_object_add(jobj, "Verno", json_object_new_string(MY_ZPE_VERSION));

		strcpy((char*)csData, str_replace((char*)(json_object_to_json_string_ext(jobj, JSON_C_TO_STRING_PLAIN)), "\\/", "/"));
		strcat((char*)outMsg, csData);

DEBUGLOG(("outmsg = [%s]\n", outMsg));

/* url_method */
		if (GetField_CString(hIn,"url_method",&csMethod)) {
DEBUGLOG(("url_method = [%s]\n",csMethod));
		}

		base64_encode(outMsg, strlen((char*)outMsg), csBuf, PD_MAX_BUFFER);
DEBUGLOG(("after encode\n"));
                outMsg[0] = '\0';
                strcat((char*)outMsg, "redirect_url");
                strcat((char*)outMsg, "=");
                strcat((char*)outMsg, csBuf);
                strcat((char*)outMsg, MY_ZPE_TOKEN);
                strcat((char*)outMsg, "url_method");
                strcat((char*)outMsg, "=");
                strcat((char*)outMsg, csMethod);
                strcat((char*)outMsg, MY_ZPE_TOKEN);
                strcat((char*)outMsg, "ret_status=0");
DEBUGLOG(("outMsg = [%s]\n", outMsg));

                *outLen = strlen((const char*)outMsg);

                json_object_put(jobj);
	}

	else {
		iRet = PD_ERR;
DEBUGLOG(("***redirect_url is missing\n"));
	}

DEBUGLOG(("FormatMsg:: normal exit iRet = [%d]\n", iRet));
        FREE_ME(csBuf);
        return iRet;
}


int BuildAuthData(hash_t* hIn)
{
	int	iRet = PD_OK;
	char	*csPtr;
	char	*csBuf;
	double	dTmp;
	csBuf = (char*) malloc (MAX_MSG_SIZE + 1);
	int	iForEnquiry = PD_FALSE;
	int	iForEnquiryRsp = PD_FALSE;

DEBUGLOG(("BuildAuthData()\n"));

	GetField_Int(hIn, "for_enquiry_use", &iForEnquiry);
	if (iForEnquiry) {
		return BuildInqAuthData(hIn);
	}

	GetField_Int(hIn, "for_enquiry_rsp_use", &iForEnquiryRsp);
	if (iForEnquiryRsp) {
		return BuildCallbackAuthData(hIn);
	}

	memset(csBuf, 0, MAX_MSG_SIZE);
	csBuf[0] = '\0';

// Amount
	if (GetField_Double(hIn, "psp_txn_amt", &dTmp)) {
		char csTmpAmt[PD_TMP_BUF_LEN + 1];
		//sprintf((char*)csTmpAmt, "%ld", double2long(dTmp));
		sprintf((char*)csTmpAmt, "%.2f", dTmp);
		strcat((char*)csBuf, csTmpAmt);
DEBUGLOG(("BuildAuthData:: Amount = [%s]\n", csTmpAmt));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: psp_txn_amt is missing\n"));
	}

// Currency
	if (GetField_CString(hIn, "psp_txn_ccy", &csPtr)) {
		strcat((char*)csBuf, csPtr);
DEBUGLOG(("BuildAuthData:: Currency = [%s]\n", csPtr));
	}
	else {
		strcat((char*)csBuf, MY_ZPE_CCY_CODE);
DEBUGLOG(("BuildAuthData:: Currency (default) = [%s]\n", MY_ZPE_CCY_CODE));
	}


// Merchant_Ref
	if (GetField_CString(hIn, "txn_seq", &csPtr)) {
		strcat((char*)csBuf, csPtr);
DEBUGLOG(("BuildAuthData:: Merchant_Ref = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: txn_seq is missing\n"));
	}

// Merchant_ID
	if (GetField_CString(hIn, "psp_merchant_id", &csPtr)) {
		strcat((char*)csBuf, csPtr);
DEBUGLOG(("BuildAuthData:: Merchant_ID = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: psp_merchant_id is missing\n"));
	}

// Mer_txn_date
	if (GetField_CString(hIn, "local_tm_date", &csPtr)) {
		char *csPtr2 = NULL;
		char csDateTime[PD_DATETIME_LEN * 2];
		if (GetField_CString(hIn, "local_tm_time", &csPtr2)) {
			sprintf(csDateTime, "%s%s", csPtr, csPtr2);
			strcat((char*)csBuf, csDateTime);

DEBUGLOG(("BuildAuthData:: Mer_txn_date = [%s]\n", csDateTime));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: local_tm_time is missing\n"));
		}
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: local_tm_date is missing\n"));
	}

	PutField_CString(hIn, "auth_data", csBuf);
DEBUGLOG(("BuildAuthData:: auth_data = [%s]\n", csBuf));
	FREE_ME(csBuf);

DEBUGLOG(("BuildAuthData() Exit iRet = [%d]\n", iRet));
        return iRet;
}


int BreakDownMsg(hash_t *hOut, const unsigned char *inMsg, int inLen)
{
	int	iRet = PD_OK;
        char    *csPtr;
        char    csMsg[PD_MAX_BUFFER + 1];
        hash_t  *hRec;

        hRec = (hash_t*) malloc (sizeof(hash_t));
        hash_init(hRec, 0);

        csMsg[0] = '\0';

DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n", inMsg, inLen));

        struct json_object *jobj;
        enum json_type type;

        jobj = json_tokener_parse((const char *)inMsg);
        if (jobj != NULL) {
                json_object_object_foreach(jobj, key, val) {
                        type = json_object_get_type(val);
                        switch (type) {
                                case json_type_string:
					PutField_CString(hRec, key, json_object_get_string(val));
                                break;
                                default:
DEBUGLOG(("BreakDownMsg:: unsupported type\n"));
                                break;
                        }
                }
        }

		if (GetField_CString(hRec, "Merchant_ID", &csPtr)) {
			PutField_CString(hOut, "psp_merchant_id", csPtr);
DEBUGLOG(("Merchant_ID = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("Merchant_ID not found\n"));
                }

		if (GetField_CString(hRec, "Merchant_Ref", &csPtr)) {
			PutField_CString(hOut, "txn_seq", csPtr);
DEBUGLOG(("Merchant_Ref = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("Merchant_Ref not found\n"));
                }

		if (GetField_CString(hRec, "Mer_txn_date", &csPtr)) {
			PutField_CString(hOut, "Mer_txn_date", csPtr);
DEBUGLOG(("Mer_txn_date = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("Mer_txn_date not found\n"));
                }

		if (GetField_CString(hRec, "Order_txn_date", &csPtr)) {
			PutField_CString(hOut, "Order_txn_date", csPtr);
DEBUGLOG(("Order_txn_date = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("Order_txn_date not found\n"));
                }

		if (GetField_CString(hRec, "Status", &csPtr)) {
			PutField_CString(hOut, "status", csPtr);
DEBUGLOG(("Status = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("Status not found\n"));
                }

		if (GetField_CString(hRec, "Status_Msg", &csPtr)) {
			PutField_CString(hOut, "Status_Msg", csPtr);
			PutField_CString(hOut, "fail_reason", csPtr);
DEBUGLOG(("Status_Msg = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("Status_Msg not found\n"));
                }

		if (GetField_CString(hRec, "Order_Ref", &csPtr)) {
			PutField_CString(hOut, "tid", csPtr);
DEBUGLOG(("Order_Ref = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("Order_Ref not found\n"));
                }

		if (GetField_CString(hRec, "Currency", &csPtr)) {
			PutField_CString(hOut, "Currency", csPtr);
DEBUGLOG(("Currency = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("Currency not found\n"));
                }

		if (GetField_CString(hRec, "Amount", &csPtr)) {
			PutField_CString(hOut, "txn_amt", csPtr);
DEBUGLOG(("Amount = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("Amount not found\n"));
                }

		if (GetField_CString(hRec, "Service_Fee", &csPtr)) {
DEBUGLOG(("Service_Fee = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("Service_Fee not found\n"));
                }

		if (GetField_CString(hRec, "Signature", &csPtr)) {
			PutField_CString(hOut, "sign", csPtr);
DEBUGLOG(("Signature = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("Signature not found\n"));
                }

        hash_destroy(hRec);
        FREE_ME(hRec);

DEBUGLOG(("BreakDownMsg Exit\n"));
	return iRet;
}


int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	return iRet;
}


int BuildRspAuthData(hash_t* hIn)
{
	int     iRet = PD_OK;
	char *csPtr;
	char *csBuf;
	csBuf = (char*) malloc (MAX_MSG_SIZE + 1);
	int	iForEnquiryRsp = PD_FALSE;

DEBUGLOG(("BuildRspAuthData()\n"));

	GetField_Int(hIn, "for_enquiry_rsp_use", &iForEnquiryRsp);

	memset(csBuf, 0, MAX_MSG_SIZE);
	csBuf[0] = '\0';

// Amount
	if (GetField_CString(hIn, "txn_amt", &csPtr)) {
		strcat((char*)csBuf, csPtr);
DEBUGLOG(("BuildRspAuthData:: Amount = [%s]\n", csPtr));
	}

// Currency
	if (GetField_CString(hIn, "Currency", &csPtr)) {
		strcat((char*)csBuf, csPtr);
DEBUGLOG(("BuildRspAuthData:: Currency = [%s]\n", csPtr));
	}

// Merchant_Ref
	if (GetField_CString(hIn, "txn_seq", &csPtr)) {
		strcat((char*)csBuf, csPtr);
DEBUGLOG(("BuildRspAuthData:: Merchant_Ref = [%s]\n", csPtr));
	}

// Merchant_ID
	if (GetField_CString(hIn, "psp_merchant_id", &csPtr)) {
		strcat((char*)csBuf, csPtr);
DEBUGLOG(("BuildRspAuthData:: Merchant_ID = [%s]\n", csPtr));
	}

// Order_Ref
	if (GetField_CString(hIn, "tid", &csPtr)) {
		strcat((char*)csBuf, csPtr);
DEBUGLOG(("BuildRspAuthData:: Order_Ref = [%s]\n", csPtr));
	}

// Mer_txn_date
	if (GetField_CString(hIn, "Mer_txn_date", &csPtr)) {
		strcat((char*)csBuf, csPtr);
DEBUGLOG(("BuildRspAuthData:: Mer_txn_date = [%s]\n", csPtr));
	}

	if (iForEnquiryRsp) {
		if (!GetField_CString(hIn, "tid", &csPtr)) {
// Status
			if (GetField_CString(hIn, "status", &csPtr)) {
				strcat((char*)csBuf, csPtr);
DEBUGLOG(("BuildRspAuthData:: Status = [%s]\n", csPtr));
			}

// Status_Msg
			if (GetField_CString(hIn, "Status_Msg", &csPtr)) {
				strcat((char*)csBuf, csPtr);
DEBUGLOG(("BuildRspAuthData:: Status_Msg = [%s]\n", csPtr));
			}
		}
	}

	PutField_CString(hIn, "auth_data", csBuf);
DEBUGLOG(("BuildRspAuthData:: auth_data = [%s]\n", csBuf));
	FREE_ME(csBuf);


DEBUGLOG(("BuildRspAuthData() Exit iRet = [%d]\n", iRet));
	return iRet;
}


char *str_replace(char *orig, char *rep, char *with) {
        char *result;   // the return string
        char *ins;      // the next insert point
        char *tmp;      // varies
        int len_rep;    // length of rep (the string to remove)
        int len_with;   // length of with (the string to replace rep with)
        int len_front;  // distance between rep and end of last rep
        int count;      // number of replacements

        if (!orig || !rep)
                return NULL;
        len_rep = strlen(rep);
        if (len_rep == 0)
                return NULL; // empty rep causes infinite loop during count
        if (!with)
                with = "";
        len_with = strlen(with);

        // count the number of replacements needed
        ins = orig;
        for (count = 0; (tmp = strstr(ins, rep)); ++count) {
                ins = tmp + len_rep;
        }

        tmp = result = malloc(strlen(orig) + (len_with - len_rep) * count + 1);

        if (!result)
                return NULL;

        // first time through the loop, all the variable are set correctly
        // from here on,
        //    tmp points to the end of the result string
        //    ins points to the next occurrence of rep in orig
        //    orig points to the remainder of orig after "end of rep"
        while (count--) {
                ins = strstr(orig, rep);
                len_front = ins - orig;
                tmp = strncpy(tmp, orig, len_front) + len_front;
                tmp = strcpy(tmp, with) + len_with;
                orig += len_front + len_rep; // move to next "end of rep"
        }
        strcpy(tmp, orig);
        return result;
}


int FormatInqMsg(const hash_t *hIn, unsigned char *outMsg, int *outLen)
{
	int iRet = PD_OK;
	char *csBuf;
	char *csURL = NULL;
	char *csPtr = NULL;
	char *csTmp = NULL;
	char csData[MAX_MSG_SIZE + 1];

DEBUGLOG(("FormatInqMsg() Start\n"));

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1);
	memset(outMsg, 0, sizeof(outMsg));

	if (GetField_CString(hIn, "psp_url", &csURL)) {
		if (GetField_CString(hIn, "request_function", &csPtr)) {
			strcpy((char*)csBuf, "url");
			strcat((char*)csBuf, MY_ZPE_FIELD_TOKEN);
			strcat((char*)csBuf, csURL);
			strcat((char*)csBuf, "/");
			strcat((char*)csBuf, csPtr);

			/* added for gw to identify the request */
			strcat((char*)csBuf, MY_ZPE_TOKEN);
			strcat((char*)csBuf, "enq");
			strcat((char*)csBuf, MY_ZPE_FIELD_TOKEN);
			strcat((char*)csBuf, "1");

			strcat((char*)csBuf, MY_ZPE_TOKEN);
			strcat((char*)csBuf, "METHOD");
			strcat((char*)csBuf, MY_ZPE_FIELD_TOKEN);
			if (GetField_CString(hIn, "url_method", &csPtr)) {
				strcat((char*)csBuf, csPtr);
			}
			else{
				strcat((char*)csBuf, PD_DEFAULT_METHOD);
			}

			strcat((char*)csBuf, MY_ZPE_TOKEN);
			strcat((char*)csBuf, "CURLOPT_HTTPHEADER");
			strcat((char*)csBuf, MY_ZPE_FIELD_TOKEN);
			strcat((char*)csBuf, "Content-Type: application/json");
		}

		sprintf((char*)outMsg, "%0*d", PD_WEB_HEADER_LEN_LEN, (int)strlen(csBuf));
		strcat((char*)outMsg, csBuf);
DEBUGLOG(("outMsg = [%s]\n", outMsg));

		json_object *jobj = json_object_new_object();

		// Merchant_ID
		if (GetField_CString(hIn, "psp_merchant_id", &csTmp)) {
DEBUGLOG(("Merchant_ID = [%s]\n", csTmp));
			json_object_object_add(jobj, "Merchant_ID", json_object_new_string(csTmp));
		}
		else {
DEBUGLOG(("***psp_merchant_id is missing\n"));
			iRet = PD_ERR;
		}

		// Merchant_Ref
		if (GetField_CString(hIn, "txn_seq", &csTmp)) {
DEBUGLOG(("Merchant_Ref = [%s]\n", csTmp));
			json_object_object_add(jobj, "Merchant_Ref", json_object_new_string(csTmp));
		}
		else {
DEBUGLOG(("***txn_seq is missing\n"));
			iRet = PD_ERR;
		}

		// Verno
DEBUGLOG(("Verno = [%s]\n", MY_ZPE_VERSION));
		json_object_object_add(jobj, "Verno", json_object_new_string(MY_ZPE_VERSION));

		// Signature
		if (GetField_CString(hIn, "sign", &csTmp)) {
DEBUGLOG(("Signature = [%s]\n", csTmp));
			json_object_object_add(jobj, "Signature", json_object_new_string(csTmp));
		}
		else {
DEBUGLOG(("***sign is missing\n"));
			iRet = PD_ERR;
		}

		strcpy((char*)csData, str_replace((char*)(json_object_to_json_string_ext(jobj, JSON_C_TO_STRING_PLAIN)), "\\/", "/"));
		strcat((char*)outMsg, csData);

		json_object_put(jobj);
	}
	else {
DEBUGLOG(("***psp_url is missing\n"));
		iRet = PD_ERR;
	}

	*outLen = strlen((const char*)outMsg);
DEBUGLOG(("FormatInqMsg() [%s][%d]\n", outMsg, *outLen));
DEBUGLOG(("FormatInqMsg() Exit iRet = [%d]\n", iRet));
	FREE_ME(csBuf);
	return iRet;
}


int BuildInqAuthData(hash_t *hIn)
{
	int iRet = PD_OK;
	char *csBuf;
	char *csPtr;

DEBUGLOG(("BuildInqAuthData() Start\n"));

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1);
	memset(csBuf, 0, MAX_MSG_SIZE);
	csBuf[0] = '\0';

	// Merchant_Ref
	if (GetField_CString(hIn, "txn_seq", &csPtr)) {
DEBUGLOG(("Merchant_Ref = [%s]\n", csPtr));
		strcat((char*)csBuf, csPtr);
	}
	else {
DEBUGLOG(("***txn_seq is missing\n"));
		iRet = PD_ERR;
	}

	// Merchant_ID
	if (GetField_CString(hIn, "psp_merchant_id", &csPtr)) {
DEBUGLOG(("Merchant_ID = [%s]\n", csPtr));
		strcat((char*)csBuf, csPtr);
	}
	else {
DEBUGLOG(("***psp_merchant_id is missing\n"));
		iRet = PD_ERR;
	}

	// Verno
DEBUGLOG(("Verno = [%s]\n", MY_ZPE_VERSION));
	strcat((char*)csBuf, MY_ZPE_VERSION);

	PutField_CString(hIn, "auth_data", csBuf);
DEBUGLOG(("BuildInqAuthData() auth_data = [%s]\n", csBuf));
DEBUGLOG(("BuildInqAuthData() Exit iRet = [%d]\n", iRet));
	FREE_ME(csBuf);
	return iRet;
}


int BreakDownInqRspMsg(hash_t *hContext, hash_t *hOut, const unsigned char *inMsg, int inLen)
{
	int iRet = PD_OK;

DEBUGLOG(("BreakDownInqRspMsg() Start\n"));

	PutField_CString(hOut, "orig_msg", (const char *)inMsg);
DEBUGLOG(("BreakDownInqRspMsg() call BreakDownMsg()\n"));
	iRet = BreakDownMsg(hOut, inMsg, inLen);

DEBUGLOG(("BreakDownInqRspMsg() Exit iRet = [%d]\n", iRet));
	return iRet;
}


int BuildInqRspAuthData(hash_t *hIn)
{
	int iRet = PD_OK;

DEBUGLOG(("BuildInqRspAuthData() Exit iRet = [%d]\n", iRet));
	return iRet;
}


int BuildCallbackAuthData(hash_t *hIn)
{
	int iRet = PD_OK;

DEBUGLOG(("BuildCallbackAuthData() Start\n"));

	PutField_CString(hIn, "auth_data", "dummy");
DEBUGLOG(("BuildCallbackAuthData() Exit iRet = [%d]\n", iRet));
	return iRet;
}


int FormatCallbackMsg(hash_t *hContext, hash_t *hIn, unsigned char *outMsg, int *outLen)
{
	int iRet = PD_OK;
	char *csPtr = NULL;

DEBUGLOG(("FormatCallbackMsg() Start\n"));

	memset(outMsg, 0, sizeof(outMsg));

	GetField_CString(hIn, "orig_msg", &csPtr);
	strcat((char*)outMsg, csPtr);

	*outLen = strlen((const char*)outMsg);
DEBUGLOG(("FormatCallbackMsg() [%s][%d]\n", outMsg, *outLen));
DEBUGLOG(("FormatCallbackMsg() Exit iRet = [%d]\n", iRet));
	return iRet;
}

