/*
PDProTech (c)2017. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       2018/02/12              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "PsvMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"
#include "internal.h"
#include "ObjPtr.h"
#define __USE_XOPEN
#include <time.h>
#include <json-c/json.h>


char cDebug;


struct key_value_pair
{
	char key[PD_TMP_BUF_LEN];
	char value[PD_TMP_MSG_BUF_LEN];
};


OBJPTR(DB);


void PsvMsg(char cdebug)
{
	cDebug = cdebug;
}


int FormatMsg(const hash_t *hIn, unsigned char *outMsg, int *outLen)
{
	int	iRet = PD_OK;
	char	*csTmp = NULL;
	char	*csPtr = NULL;
	char	*csBuf;
	double	dTmp;
	char	*csMethod = NULL;
	char	cTmp;
	char	csCardType[PD_TMP_BUF_LEN];
	char *csTag = (char*) malloc (PD_TAG_LEN + 1 );
	char *csTmpBuf = (char*) malloc (PD_TMP_BUF_LEN + 1 );

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1);

	memset(outMsg, 0, sizeof(outMsg));
	if (GetField_CString(hIn, "redirect_url", &csPtr)) {
DEBUGLOG(("FormatMsg here\n"));
		strcat((char*)outMsg, csPtr);
		strcat((char*)outMsg, "?");

//card_type
		if (GetField_Char(hIn, "card_type", &cTmp)) {
			strcat((char*)outMsg, "card_type");
			strcat((char*)outMsg, MY_PSV_FIELD_TOKEN);
			if(cTmp==PD_DEPOSIT_CARD_TYPE_DEBIT)
				sprintf(csCardType,"%s",MY_PSV_DEBIT_CARD);
			else
				sprintf(csCardType,"%s",MY_PSV_CREDIT_CARD);
			strcat((char*)outMsg, csCardType);
			strcat((char*)outMsg, MY_PSV_TOKEN);
DEBUGLOG(("card_type = [%s][%c]\n", csCardType,cTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("card_type is missing\n"));
		}

//certId
		if (GetField_CString(hIn, "psp_key", &csTmp)) {
			strcat((char*)outMsg, "certId");
			strcat((char*)outMsg, MY_PSV_FIELD_TOKEN);
			strcat((char*)outMsg, csTmp);
			strcat((char*)outMsg, MY_PSV_TOKEN);
DEBUGLOG(("certId = [%s]\n", csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("certId is missing\n"));
		}

// currency_type
		strcat((char*)outMsg, "currency_type");
		strcat((char*)outMsg, MY_PSV_FIELD_TOKEN);
		strcat((char*)outMsg, MY_PSV_CUR_CODE);
		strcat((char*)outMsg, MY_PSV_TOKEN);
DEBUGLOG(("currency_type = [%s]\n", MY_PSV_CUR_CODE));


// notify_url
		if (GetField_CString(hIn, "return_url_only", &csTmp)) {
			strcat((char*)outMsg, "notify_url");
			strcat((char*)outMsg, MY_PSV_FIELD_TOKEN);
			//strcat((char*)outMsg, csTmp);
			strcat((char*)outMsg, url_encode(csTmp));
			strcat((char*)outMsg, MY_PSV_TOKEN);
//DEBUGLOG(("notify_url = [%s]\n", csTmp));
DEBUGLOG(("notify_url = [%s]\n", url_encode(csTmp)));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***return_url_only is missing\n"));
		}

// out_trade_no
		if (GetField_CString(hIn, "txn_seq", &csTmp)) {
			strcat((char*)outMsg, "out_trade_no");
			strcat((char*)outMsg, MY_PSV_FIELD_TOKEN);
			strcat((char*)outMsg, csTmp);
			strcat((char*)outMsg, MY_PSV_TOKEN);
DEBUGLOG(("out_trade_no = [%s]\n", csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***txn_seq is missing\n"));
		}

// partner
		if (GetField_CString(hIn, "psp_merchant_id", &csTmp)) {
			strcat((char*)outMsg, "partner");
			strcat((char*)outMsg, MY_PSV_FIELD_TOKEN);
			strcat((char*)outMsg, csTmp);
			strcat((char*)outMsg, MY_PSV_TOKEN);
DEBUGLOG(("partner = [%s]\n", csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***psp_merchant_id is missing\n"));
		}


// pay_id
		if (GetField_CString(hIn, "bank_code", &csTmp)) {
			strcat((char*)outMsg, "pay_id");
			strcat((char*)outMsg, MY_PSV_FIELD_TOKEN);
			strcat((char*)outMsg, csTmp);
			strcat((char*)outMsg, MY_PSV_TOKEN);
DEBUGLOG(("pay_id = [%s]\n", csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***bank_code is missing\n"));
		}

// return_url
		if (GetField_CString(hIn, "fe_url", &csTmp)) {
			strcat((char*)outMsg, "return_url");
			strcat((char*)outMsg, MY_PSV_FIELD_TOKEN);
			//strcat((char*)outMsg, csTmp);
			strcat((char*)outMsg, url_encode(csTmp));
			strcat((char*)outMsg, MY_PSV_TOKEN);
//DEBUGLOG(("return_url = [%s]\n", csTmp));
DEBUGLOG(("return_url = [%s]\n", url_encode(csTmp)));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***fe_url is missing\n"));
		}

//sign_type 
		strcat((char*)outMsg, "sign_type");
		strcat((char*)outMsg, MY_PSV_FIELD_TOKEN);
		strcat((char*)outMsg, MY_PSV_SIGN_TYPE);
		strcat((char*)outMsg, MY_PSV_TOKEN);
DEBUGLOG(("sign_type = [%s]\n", MY_PSV_SIGN_TYPE));


// total_fee
		if (GetField_Double(hIn, "psp_txn_amt", &dTmp)) {
			char csTmpAmt[PD_TMP_BUF_LEN + 1];
			sprintf(csTmpAmt, "%.2f", dTmp);
			strcat((char*)outMsg, "total_fee");
			strcat((char*)outMsg, MY_PSV_FIELD_TOKEN);
			strcat((char*)outMsg, csTmpAmt);
			strcat((char*)outMsg, MY_PSV_TOKEN);
DEBUGLOG(("total_fee = [%s]\n", csTmpAmt));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***psp_txn_amt is missing\n"));
		}

// version
		strcat((char*)outMsg, "version");
		strcat((char*)outMsg, MY_PSV_FIELD_TOKEN);
		strcat((char*)outMsg, MY_PSV_VERSION);
		strcat((char*)outMsg, MY_PSV_TOKEN);
DEBUGLOG(("version = [%s]\n", MY_PSV_VERSION));


/* TLG - Transaction Logging */
                if (GetField_CString(hIn,"psp_id",&csTmp)) {
                        int iDtlRet = PD_FALSE;
DEBUGLOG(("Call DBPspUrl::IsRedirectURL\n"));
			//Call DBPspUrl::IsRedirectURL
			DBObjPtr = CreateObj(DBPtr,"DBPspUrl","IsRedirectURL");
                        iDtlRet = ((unsigned long)(DBObjPtr)(csTmp));

                        if (iDtlRet == PD_TRUE) {
DEBUGLOG(("  psp_id [%s] IsRedirectUrl = TRUE [%d]\n",csTmp,iDtlRet));

                                if (GetField_CString(hIn,"txn_seq",&csTmp)) {
DEBUGLOG(("Call DBDefTlgTagConvert:GetRandomTag\n"));
                                        DBObjPtr = CreateObj(DBPtr,"DBDefTlgTagConvert","GetRandomTag");
                                        iDtlRet = ((unsigned long)(DBObjPtr)("txn_seq",csTag));

                                        if (iDtlRet == PD_OK) {
DEBUGLOG(("  org_tag [%s], new_tag [%s]\n","txn_seq",csTag));
                                                base64_encode((unsigned char*)csTmp,strlen(csTmp),csTmpBuf,PD_TMP_BUF_LEN);
                                                strcat((char*)outMsg,csTag);
                                                strcat((char*)outMsg,MY_PSV_FIELD_TOKEN);
                                                strcat((char*)outMsg,csTmpBuf);
                                                strcat((char*)outMsg,MY_PSV_TOKEN);
                                        } else {
DEBUGLOG(("  CALL FAILED!! Skip Insert TLG Log, iDtlRet = [%d]\n",iDtlRet));
                                        }
                                } else {
DEBUGLOG(("txn_seq NOT FOUND!! Skip Insert TLG Log\n"));
                                }


DEBUGLOG(("FormatMsg:: [%s] = [%s]\n",csTag,csTmp));
                        } else {
DEBUGLOG(("  psp_id [%s] IsRedirectUrl = FALSE [%d]\n",csTmp,iDtlRet));
                        }
                }

// sign
		if (GetField_CString(hIn, "sign", &csTmp)) {
			strcat((char*)outMsg, "sign");
			strcat((char*)outMsg, MY_PSV_FIELD_TOKEN);
			strcat((char*)outMsg, url_encode(csTmp));
			//strcat((char*)outMsg, MY_PSV_TOKEN);
DEBUGLOG(("sign = [%s]\n", url_encode(csTmp)));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("***sign is missing\n"));
		}


// url_method
		if (GetField_CString(hIn, "url_method", &csMethod)) {
DEBUGLOG(("url_method = [%s]\n", csMethod));
		}
		else
			csMethod = strdup("");

DEBUGLOG(("outmsg = [%s]\n", outMsg));
		base64_encode(outMsg, strlen((char*)outMsg), csBuf, PD_MAX_BUFFER);
DEBUGLOG(("after encode\n"));
		outMsg[0] = '\0';
		strcat((char*)outMsg, "redirect_url");
		strcat((char*)outMsg, "=");
		strcat((char*)outMsg, csBuf);
		strcat((char*)outMsg, MY_PSV_TOKEN);
		strcat((char*)outMsg, "url_method");
		strcat((char*)outMsg, "=");
		strcat((char*)outMsg, csMethod);
		strcat((char*)outMsg, MY_PSV_TOKEN);
		strcat((char*)outMsg, "ret_status=0");
DEBUGLOG(("outMsg = [%s]\n", outMsg));

		*outLen = strlen((const char*)outMsg);
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("***redirect_url is missing\n"));
	}

DEBUGLOG(("FormatMsg:: normal exit iRet = [%d]\n", iRet));
	FREE_ME(csBuf);
	FREE_ME(csTag);
	FREE_ME(csTmpBuf);
	return iRet;
}


int BreakDownMsg(hash_t *hOut, const unsigned char *inMsg, int inLen)
{
	int	iRet = PD_OK;
	char	*csPtr;
	hash_t 	*hRec;

	hRec = (hash_t*) malloc (sizeof(hash_t));
	hash_init(hRec, 0);


DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n", inMsg, inLen));


	if (Str2Cls(hRec, (char *)inMsg, MY_PSV_TOKEN, MY_PSV_FIELD_TOKEN) == PD_OK) {
// inMsg
		PutField_CString(hOut, "in_msg", (char *)inMsg);


//version
		if (GetField_CString(hRec, "version", &csPtr)) {
			PutField_CString(hOut, "version", csPtr);
DEBUGLOG(("version = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("version not found\n"));
		}


//sign_type
		if (GetField_CString(hRec, "sign_type", &csPtr)) {
			PutField_CString(hOut, "sign_type", csPtr);
DEBUGLOG(("sign_type = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("sign_type not found\n"));
		}

// sign
		if (GetField_CString(hRec, "sign", &csPtr)) {
			PutField_CString(hOut, "sign", csPtr);
DEBUGLOG(("sign = [%s]\n", csPtr));
		}
		else {
			PutField_CString(hOut, "sign", " ");
DEBUGLOG(("sign not found\n"));
		}

// partner
		if (GetField_CString(hRec, "partner", &csPtr)) {
			PutField_CString(hOut, "psp_merchant_id", csPtr);
DEBUGLOG(("partner:psp_merchant_id = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("partner:psp_merchant_id not found\n"));
		}

// out_trade_no
		if (GetField_CString(hRec, "out_trade_no", &csPtr)) {
			PutField_CString(hOut, "txn_seq", csPtr);
DEBUGLOG(("out_trade_no:txn_seq = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("out_trade_no:txn_seq not found\n"));
		}

// pay_no
		if (GetField_CString(hRec, "pay_no", &csPtr)) {
			PutField_CString(hOut, "tid", csPtr);
DEBUGLOG(("pay_no:tid = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("pay_no:tid not found\n"));
		}

// amount 
		if (GetField_CString(hRec, "amount", &csPtr)) {
			PutField_CString(hOut, "psp_txn_amt", csPtr);
			PutField_CString(hOut, "txn_amt", csPtr);
DEBUGLOG(("amount:txn_amt = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("amount:txn_amt not found\n"));
		}

// pay_result
		if (GetField_CString(hRec, "pay_result", &csPtr)) {
			PutField_CString(hOut, "status", csPtr);
DEBUGLOG(("pay_result:status = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("pay_result:status not found\n"));
		}

// pay_time
		if (GetField_CString(hRec, "pay_time", &csPtr)) {
			char csTxnDate[PD_DATE_LEN + 1];
			strncpy(csTxnDate, csPtr, PD_DATE_LEN);
			csTxnDate[PD_DATE_LEN] = '\0';

			PutField_CString(hOut, "fundin_date", csPtr);
			PutField_CString(hOut, "txn_date", csTxnDate);
DEBUGLOG(("pay_time:fundin_date = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("pay_time:fundin_date not found\n"));
		}

//sett_date
		if (GetField_CString(hRec, "sett_date", &csPtr)) {
			PutField_CString(hOut, "sett_date", csPtr);
DEBUGLOG(("sett_date = [%s]\n", csPtr));
                }
		else {
DEBUGLOG(("sett_date not found\n"));
		}

//sett_time
		if (GetField_CString(hRec, "sett_time", &csPtr)) {
			PutField_CString(hOut, "sett_time", csPtr);
DEBUGLOG(("sett_time = [%s]\n", csPtr));
                }
		else {
DEBUGLOG(("sett_time not found\n"));
		}

//base64_memo
		if (GetField_CString(hRec, "base64_memo", &csPtr)) {
			PutField_CString(hOut, "base64_memo", csPtr);
DEBUGLOG(("base64_memo = [%s]\n", csPtr));
                }

//channel_id
		if (GetField_CString(hRec, "channel_id", &csPtr)) {
			PutField_CString(hOut, "channel_id", csPtr);
DEBUGLOG(("channel_id = [%s]\n", csPtr));
                }

//dec_fee_rate
		if (GetField_CString(hRec, "dec_fee_rate", &csPtr)) {
			PutField_CString(hOut, "dec_fee_rate", csPtr);
DEBUGLOG(("dec_fee_rate = [%s]\n", csPtr));
                }

//dec_fee
		if (GetField_CString(hRec, "dec_fee", &csPtr)) {
			PutField_CString(hOut, "dec_fee", csPtr);
DEBUGLOG(("dec_fee = [%s]\n", csPtr));
                }

	}
	else {
DEBUGLOG(("BreakDownMsg() Error\n"));
		iRet = PD_ERR;
	}

	hash_destroy(hRec);
	FREE_ME(hRec);

DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}


int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	return iRet;
}


int BuildAuthData(hash_t *hIn)
{
	int	iRet = PD_OK;
	char	*csPtr;
	char	*csBuf;
	double	dTmp;
	csBuf = (char*) malloc (MAX_MSG_SIZE + 1);
	char csCardType[PD_TMP_BUF_LEN];
	char	cPtr;

DEBUGLOG(("BuildAuthData()\n"));
	memset(csBuf, 0, MAX_MSG_SIZE);
	csBuf[0] = '\0';

//card_type
	if (GetField_Char(hIn, "card_type", &cPtr)) {
		strcat((char*)csBuf, "card_type");
		strcat((char*)csBuf, MY_PSV_FIELD_TOKEN);
		if(cPtr==PD_DEPOSIT_CARD_TYPE_DEBIT)
			sprintf(csCardType,"%s",MY_PSV_DEBIT_CARD);
		else
			sprintf(csCardType,"%s",MY_PSV_CREDIT_CARD);
		strcat((char*)csBuf, csCardType);
		strcat((char*)csBuf, MY_PSV_TOKEN);
DEBUGLOG(("card_type = [%s][%c]\n", csCardType,cPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("card_type is missing\n"));
	}

// certId
	if (GetField_CString(hIn, "psp_key", &csPtr)) {
		strcat((char*)csBuf, "certId");
		strcat((char*)csBuf, MY_PSV_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_PSV_TOKEN);
DEBUGLOG(("certId = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("certId is missing\n"));
	}


// currency_type
	strcat((char*)csBuf, "currency_type");
	strcat((char*)csBuf, MY_PSV_FIELD_TOKEN);
	strcat((char*)csBuf, MY_PSV_CUR_CODE);
	strcat((char*)csBuf, MY_PSV_TOKEN);
DEBUGLOG(("currency_type = [%s]\n", MY_PSV_CUR_CODE));

// notify_url
	if (GetField_CString(hIn, "return_url_only", &csPtr)) {
		strcat((char*)csBuf, "notify_url");
		strcat((char*)csBuf, MY_PSV_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_PSV_TOKEN);
DEBUGLOG(("notify_url = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("return_url_only is missing\n"));
	}

/* order_create_ip
	if (GetField_CString(hIn, "user_ip", &csPtr)) {
		strcat((char*)csBuf, "order_create_ip");
		strcat((char*)csBuf, MY_PSV_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_PSV_TOKEN);
DEBUGLOG(("order_create_ip = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("user_ip is missing\n"));
	}
*/

// out_trade_no
	if (GetField_CString(hIn, "txn_seq", &csPtr)) {
		strcat((char*)csBuf, "out_trade_no");
		strcat((char*)csBuf, MY_PSV_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_PSV_TOKEN);
DEBUGLOG(("out_trade_no = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("txn_seq is missing\n"));
	}

// partner
	if (GetField_CString(hIn, "psp_merchant_id", &csPtr)) {
		strcat((char*)csBuf, "partner");
		strcat((char*)csBuf, MY_PSV_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_PSV_TOKEN);
DEBUGLOG(("partner = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("psp_merchant_id is missing\n"));
	}

// pay_id
	if (GetField_CString(hIn, "bank_code", &csPtr)) {
		strcat((char*)csBuf, "pay_id");
		strcat((char*)csBuf, MY_PSV_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_PSV_TOKEN);
DEBUGLOG(("pay_id = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("bank_code is missing\n"));
	}

// return_url
	if (GetField_CString(hIn, "fe_url", &csPtr)) {
		strcat((char*)csBuf, "return_url");
		strcat((char*)csBuf, MY_PSV_FIELD_TOKEN);
		strcat((char*)csBuf, csPtr);
		strcat((char*)csBuf, MY_PSV_TOKEN);
DEBUGLOG(("return_url = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("fe_url is missing\n"));
	}

// sign_type
	strcat((char*)csBuf, "sign_type");
	strcat((char*)csBuf, MY_PSV_FIELD_TOKEN);
	strcat((char*)csBuf, MY_PSV_SIGN_TYPE);
	strcat((char*)csBuf, MY_PSV_TOKEN);
DEBUGLOG(("sign_type = [%s]\n", MY_PSV_SIGN_TYPE));

// total_fee
	if (GetField_Double(hIn, "psp_txn_amt", &dTmp)) {
		char csTmpAmt[PD_TMP_BUF_LEN + 1];
		sprintf(csTmpAmt, "%.2f", dTmp);
		strcat((char*)csBuf, "total_fee");
		strcat((char*)csBuf, MY_PSV_FIELD_TOKEN);
		strcat((char*)csBuf, csTmpAmt);
		strcat((char*)csBuf, MY_PSV_TOKEN);
DEBUGLOG(("total_fee = [%s]\n", csTmpAmt));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("psp_txn_amt is missing\n"));
	}

// version
	strcat((char*)csBuf, "version");
	strcat((char*)csBuf, MY_PSV_FIELD_TOKEN);
	strcat((char*)csBuf, MY_PSV_VERSION);
	//strcat((char*)csBuf, MY_PSV_TOKEN);
DEBUGLOG(("version = [%s]\n", MY_PSV_VERSION));

	PutField_CString(hIn, "auth_data", csBuf);
DEBUGLOG(("auth_data = [%s]\n", csBuf));
	FREE_ME(csBuf);
        
DEBUGLOG(("BuildAuthData() Exit iRet = [%d]\n", iRet));
	return iRet;
}


void Insert2KVPair(struct key_value_pair k_v_pair[], int *iPairCnt, const char *inMsg, const char *FD)
{
	char *csTag;
	char *csValue;
	char *csTmp;
	char *p;

	csTmp = (char*) malloc (PD_TMP_MSG_BUF_LEN + 1);
	strcpy(csTmp, inMsg);

	p = strstr(csTmp, FD);
	if (p) {
		if (strlen(p) > strlen(FD)) {
			csTag = (char*) malloc (PD_TMP_MSG_BUF_LEN + 1);
			csValue = strdup(p + 1);
			memcpy(csTag, inMsg, strlen(inMsg) - strlen(p));
			csTag[strlen(inMsg) - strlen(p)] = '\0';
//DEBUGLOG(("Insert2KVPair:: iPairCnt = [%d], Tag = [%s], Value = [%s]\n", *iPairCnt, csTag, csValue));
			strcpy(k_v_pair[*iPairCnt].key, csTag);
			strcpy(k_v_pair[*iPairCnt].value, csValue);
			*iPairCnt = *iPairCnt + 1;
			free(csTag);
			csTag = NULL;
			free(csValue);
			csValue = NULL;
		}
	}
	free(csTmp);
	csTmp = NULL;
}


int Str2KVPair(struct key_value_pair k_v_pair[], int *iPairCnt, const char *inMsg, const char *DL, const char *FD)
{
	char *csBuf;
	char *p;

	int inLen = strlen(inMsg);
	csBuf = (char*) malloc (inLen + 1);
	memcpy(csBuf, inMsg, inLen);
	csBuf[inLen] = '\0';

	p = strtok(csBuf, DL);
	if (p != NULL) {
		if (strlen(p) > 1) {
			if (p[strlen(p) - 1] == 0x0d)
				p[strlen(p) - 1] = '\0';
			else
				p[strlen(p)] = '\0';
			Insert2KVPair(k_v_pair, iPairCnt, p, FD);
		}
	}

	while ((p = strtok(NULL, DL)) != NULL) {
		if (strlen(p) > 1) {
			if (p[strlen(p) - 1] == 0x0d)
				p[strlen(p) - 1] = '\0';
			else
				p[strlen(p)] = '\0';
			Insert2KVPair(k_v_pair, iPairCnt, p, FD);
		}
	}

//DEBUGLOG(("Str2KVPair:: iPairCnt = [%d]\n", *iPairCnt));

	free(csBuf);
	csBuf = NULL;
	return 0;
}


int string_sort_func(const void *a1, const void *b1)
{
	const char *a = (const char *)a1;
	const char *b = (const char *)b1;
	return(strcmp(a, b));
}


int BuildRspAuthData(hash_t *hIn)
{
	int iRet = PD_OK;
	char *csBuf;
	csBuf = (char*) malloc (MAX_MSG_SIZE + 1);

	char *inMsg;
	int iTmp;

	struct key_value_pair k_v_pair[50];
	int iPairCnt = 0;

DEBUGLOG(("BuildRspAuthData()\n"));
	memset(csBuf, 0, MAX_MSG_SIZE);
	csBuf[0] = '\0';

	if (GetField_CString(hIn, "in_msg", &inMsg)) {
		if (Str2KVPair(k_v_pair, &iPairCnt, inMsg, MY_PSV_TOKEN, MY_PSV_FIELD_TOKEN) == PD_OK) {
//DEBUGLOG(("iPairCnt = [%d]\n", iPairCnt));
			qsort(k_v_pair, iPairCnt, sizeof(struct key_value_pair), string_sort_func);
			for (iTmp = 0; iTmp < iPairCnt; iTmp++) {
DEBUGLOG(("key = [%s], value = [%s]\n", k_v_pair[iTmp].key, k_v_pair[iTmp].value));
				// exclude sign
				if (strcmp(k_v_pair[iTmp].key, "sign")) {
					strcat(csBuf, k_v_pair[iTmp].key);
					strcat(csBuf, MY_PSV_FIELD_TOKEN);
					strcat(csBuf, k_v_pair[iTmp].value);
					strcat(csBuf, MY_PSV_TOKEN);
				}
			}
		}
	}
	if(strlen(csBuf)>1) csBuf[strlen(csBuf) - 1] = '\0';

	PutField_CString(hIn, "auth_data", csBuf);
DEBUGLOG(("BuildRspAuthData:: auth_data = [%s]\n", csBuf));
	FREE_ME(csBuf);

DEBUGLOG(("BuildRspAuthData() Exit iRet = [%d]\n", iRet));
	return iRet;
}

