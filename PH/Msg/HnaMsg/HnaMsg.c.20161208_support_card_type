/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version					   2014/07/16              LokMan Chow
Add card_type					   2016/09/30		   Elvis Wong
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "HnaMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"
#include "internal.h"

char	cDebug;

void	HnaMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;
	char*   csTmp = NULL;
	char*   csPtr = NULL;
	char*   csTxnId= NULL;
	char*   csBuf;
	double  dTmp;
	char*   csMethod = NULL;
	char	cCardType;

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

	memset(outMsg,0,sizeof(outMsg));
	if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg here\n"));
		strcat((char *)outMsg,csPtr);
		strcat((char *)outMsg,"?");
		strcat((char*)outMsg,MY_HNA_TOKEN);


/* 0 version*/
		strcat((char*)outMsg,"version");
		strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
		strcat((char*)outMsg,"2.6");
		strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: version = [2.6]\n"));


/* 1 serialID*/
		if (GetField_CString(hIn,"txn_seq",&csTxnId)) {
			strcat((char*)outMsg,"serialID");
			strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
			strcat((char*)outMsg,csTxnId);
			strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: serialID = [%s]\n",csTxnId));
		}

/* 2 submitTime */
		if (GetField_CString(hIn,"local_tm_date",&csTmp)) {
DEBUGLOG(("FormatMsg:: local_tm_date = [%s]\n",csTmp));
                        char*   csPtr2;
                        char    csDateTime[PD_DATETIME_LEN * 2];
                        if (GetField_CString(hIn,"local_tm_time",&csPtr2)) {
DEBUGLOG(("FormatMsg:: local_tm_time = [%s]\n",csPtr2));
                                sprintf(csDateTime,"%s%s",csTmp,csPtr2);
DEBUGLOG(("FormatMsg:: submitTime  = [%s]\n",csDateTime));
                                strcat((char*)outMsg,"submitTime");
                                strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
                                strcat((char*)outMsg,csDateTime);
                                strcat((char*)outMsg,MY_HNA_TOKEN);
                        }
                        else {
DEBUGLOG(("FormatMsg:: local_tm_time is missing!!!\n"));
                        }
                }
                else {
DEBUGLOG(("FormatMsg:: local_tm_date is missing!!!\n"));
                }


/*3 failureTime */
		strcat((char*)outMsg,"failureTime");
		strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
		strcat((char*)outMsg,MY_HNA_TOKEN);

/*4 customerIP */
		strcat((char*)outMsg,"customerIP");
		strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
		strcat((char*)outMsg,MY_HNA_TOKEN);

		char    csTmpAmt[PD_TMP_BUF_LEN +1];
		csTmpAmt[0] = '\0';
		if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {

			sprintf((char*)csTmpAmt,"%ld",double2long(dTmp));
DEBUGLOG(("FormatMsg:: order_amount = [%s]\n",csTmpAmt));
		}
		else {
DEBUGLOG(("FormatMsg:: psp_txn_amt is missing!!!\n"));
		}

/*5 orderDetails*/
		strcat((char*)outMsg,"orderDetails");
		strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
		strcat((char*)outMsg,csTxnId);
		strcat((char*)outMsg,MY_HNA_SEPERATER);
		strcat((char*)outMsg,csTmpAmt);
		strcat((char*)outMsg,MY_HNA_SEPERATER);
		strcat((char*)outMsg,"DSP");
		strcat((char*)outMsg,MY_HNA_SEPERATER);
		strcat((char*)outMsg,"DSP");
		strcat((char*)outMsg,MY_HNA_SEPERATER);
		strcat((char*)outMsg,"1");
		strcat((char*)outMsg,MY_HNA_TOKEN);

/*6 totalAmount*/
		strcat((char*)outMsg,"totalAmount");
		strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
		strcat((char*)outMsg,csTmpAmt);
		strcat((char*)outMsg,MY_HNA_TOKEN);
		
/*7 type*/
		strcat((char*)outMsg,"type");
		strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
		strcat((char*)outMsg,"1000");
		strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: type = [1000]\n"));


/*8 buyerMarked*/
		if (GetField_CString(hIn,"buyer_marked",&csTmp)) {
			strcat((char*)outMsg,"buyerMarked");
			strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: buyerMarked = [%s]\n",csTmp));
		}

/*9 payType*/
		if (GetField_Char(hIn,"card_type",&cCardType)) {
DEBUGLOG(("FormatMsg:: card_type = [%c]\n", cCardType));

			if (cCardType == PD_DEPOSIT_CARD_TYPE_DEBIT) {
				strcat((char*)outMsg,"payType");
                        	strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
                        	strcat((char*)outMsg,"BANK_B2C,LARGE_DEBIT_CARD");				
				//strcat((char*)outMsg,"ALL");
				strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: payType = [BANK_B2C,LARGE_DEBIT_CARD]\n"));				
			} else if (cCardType == PD_DEPOSIT_CARD_TYPE_CREDIT) {
				strcat((char*)outMsg,"payType");
                                strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
                                strcat((char*)outMsg,"BANK_B2C,LARGE_CREDIT_CARD"); 
				//strcat((char*)outMsg,"ALL");
				strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: payType = [BANK_B2C,LARGE_CREDIT_CARD]\n")); 
			} else {
DEBUGLOG(("FormatMsg:: card_type is incorrect!!!\n"));
			}
		} else {	
			strcat((char*)outMsg,"payType");
			strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
			strcat((char*)outMsg,"BANK_B2C");
			//strcat((char*)outMsg,"ALL");
			strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: payType = [BANK_B2C]\n"));
		}

/*10 orgCode*/
		if (GetField_CString(hIn,"bank_code",&csTmp)) {
			strcat((char*)outMsg,"orgCode");
			strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: orgCode = [%s]\n",csTmp));
		}
		else {
DEBUGLOG(("FormatMsg:: bank_code is missing!!!\n"));
		}

/*11 currencyCode*/
		strcat((char*)outMsg,"currencyCode");
                strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
                strcat((char*)outMsg,"1");
                strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: currencyCode = [1]\n"));

/*12 directFlag*/
		strcat((char*)outMsg,"directFlag");
                strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
                //strcat((char*)outMsg,"0");
                strcat((char*)outMsg,"1");
                strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: directFlag = [1]\n"));

/*13 borrowingMarked*/
		strcat((char*)outMsg,"borrowingMarked");
                strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
                strcat((char*)outMsg,"0");
                strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: borrowingMarked = [0]\n"));

/*14 couponFlag*/
		strcat((char*)outMsg,"couponFlag");
                strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
                strcat((char*)outMsg,"0");
                strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: couponFlag = [0]\n"));

/*15 platformID*/
		strcat((char*)outMsg,"platformID");
		strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
		strcat((char*)outMsg,MY_HNA_TOKEN);


/*16 returnUrl*/
		if (GetField_CString(hIn,"fe_url",&csTmp)) {
			strcat((char*)outMsg,"returnUrl");
			strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: returnUrl = [%s]\n",csTmp));
		}

/*17 noticeUrl*/
		if (GetField_CString(hIn,"return_url_only",&csTmp)) {
			strcat((char*)outMsg,"noticeUrl");
			strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: noticeUrl = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** return_url_only is missing\n"));
		}


/*18 partnerID*/
		if (GetField_CString(hIn,"psp_merchant_id",&csTmp)) {
			strcat((char*)outMsg,"partnerID");
			strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: partnerID = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***psp_merchant_id is missing\n"));
		}

/*19 remark*/
		strcat((char*)outMsg,"remark");
		strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
		strcat((char*)outMsg,csTxnId);
		strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: remark = %s\n",csTxnId));


/*20 charset*/
		strcat((char*)outMsg,"charset");
		strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
		strcat((char*)outMsg,"1");
		strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: charset = [1]\n"));



/*21 signType*/
		strcat((char*)outMsg,"signType");
		strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
		strcat((char*)outMsg,"2");
		strcat((char*)outMsg,MY_HNA_TOKEN);
DEBUGLOG(("FormatMsg:: signType = [2]\n"));


/*22 signMsg*/
		if (GetField_CString(hIn,"sign",&csTmp)) {
			strcat((char*)outMsg,"signMsg");
			strcat((char*)outMsg,MY_HNA_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
DEBUGLOG(("FormatMsg:: signMsg = [%s]\n",csTmp));
		}

/* url_method */
                if (GetField_CString(hIn,"url_method",&csMethod)) {
DEBUGLOG(("FormatMsg:: url_method = [%s]\n",csMethod));
                }

DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
		base64_encode(outMsg,strlen((char *)outMsg),csBuf,PD_MAX_BUFFER);
DEBUGLOG(("FormatMsg:: after encode\n"));
                outMsg[0] = '\0';
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
                strcat((char*)outMsg,MY_HNA_TOKEN);
		strcat((char*)outMsg,"url_method");
		strcat((char*)outMsg,"=");
		strcat((char*)outMsg,csMethod);
                strcat((char*)outMsg,MY_HNA_TOKEN);
		strcat((char*)outMsg,"ret_status=0");
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));

		*outLen = strlen((const char*)outMsg);
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: Redirct url not found\n"));
	}


DEBUGLOG(("FormatMsg:: normal exit iret =[%d]\n",iRet));
	FREE_ME(csBuf);
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csPtr;
	hash_t  *hRec;

        hRec = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hRec,0);

DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));

	if (Str2Cls(hRec,(char *)inMsg,MY_HNA_TOKEN, MY_HNA_FIELD_TOKEN) == PD_OK) {

/* 1 orderID*/
		if (GetField_CString(hRec,"orderID",&csPtr)) {
			PutField_CString(hOut,"txn_seq",csPtr);
DEBUGLOG(("BreakDownMsg:: txn_seq = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: txn_seq not found\n"));
		}

/* 2 resultCode*/
		if (GetField_CString(hRec,"resultCode",&csPtr)) {
			PutField_CString(hOut,"resultCode",csPtr);
DEBUGLOG(("BreakDownMsg:: resultCode = [%s]\n",csPtr));
		}

/* 3 stateCode*/
		if (GetField_CString(hRec,"stateCode",&csPtr)) {
			PutField_CString(hOut,"status",csPtr);
DEBUGLOG(("BreakDownMsg:: status = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: status not found\n"));
		}

/* 4 orderAmount */
		if (GetField_CString(hRec,"orderAmount",&csPtr)) {
			PutField_CString(hOut,"txn_amt",csPtr);
DEBUGLOG(("BreakDownMsg:: txn_amt = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: txn_amt not found\n"));
		}

/* 5 payAmount */
		if (GetField_CString(hRec,"payAmount",&csPtr)) {
			PutField_CString(hOut,"pay_amt",csPtr);
DEBUGLOG(("BreakDownMsg:: pay_amt = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: pay_amt not found\n"));
		}

/* 6 acquiringTime*/
		if (GetField_CString(hRec,"acquiringTime",&csPtr)) {
			PutField_CString(hOut,"acquiring_time",csPtr);

			csPtr[PD_DATETIME_LEN] = '\0';
                        char csTxnDate[PD_DATE_LEN +1];
			sprintf(csTxnDate,"%.*s",PD_DATE_LEN,csPtr);
			PutField_CString(hOut,"txn_date",csTxnDate);
DEBUGLOG(("BreakDownMsg:: acquiring_time = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: acquiringTime not found\n"));
		}

/* 7 completeTime*/
		if (GetField_CString(hRec,"completeTime",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: completeTime = [%s]\n",csPtr));
			PutField_CString(hOut,"fundin_date",csPtr);
		}
		else{
DEBUGLOG(("BreakDownMsg:: completeTime not found\n"));
		}

/* 8 orderNo*/
		if (GetField_CString(hRec,"orderNo",&csPtr)) {
			PutField_CString(hOut,"tid",csPtr);
DEBUGLOG(("BreakDownMsg:: tid = [%s]\n",csPtr));
		}

/* 9 partnerID*/
		if (GetField_CString(hRec,"partnerID",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: partnerID = [%s]\n",csPtr));
			PutField_CString(hOut,"mid",csPtr);
		}
		else{
DEBUGLOG(("BreakDownMsg:: partnerID not found\n"));
		}

/* 10 remark*/
		if (GetField_CString(hRec,"remark",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: remark = [%s]\n",csPtr));
			PutField_CString(hOut,"remark",csPtr);
		}
		else{
DEBUGLOG(("BreakDownMsg:: remark not found\n"));
		}

/* 11 charset*/
		if (GetField_CString(hRec,"charset",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: charset = [%s]\n",csPtr));
			PutField_CString(hOut,"charset",csPtr);
		}
		else{
DEBUGLOG(("BreakDownMsg:: charset not found\n"));
		}

/* 12 signType*/
		if (GetField_CString(hRec,"signType",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: signType = [%s]\n",csPtr));
			PutField_CString(hOut,"signType",csPtr);
		}
		else{
DEBUGLOG(("BreakDownMsg:: signType not found\n"));
		}

/*13  signMsg*/
                if (GetField_CString(hRec,"signMsg",&csPtr)) {
                        PutField_CString(hOut,"sign",csPtr);
DEBUGLOG(("BreakDownMsg:: sign = [%s]\n",csPtr));
                }
                else{
DEBUGLOG(("BreakDownMsg:: sign not found\n"));
                }


	}
	else {
DEBUGLOG(("BreakDownMsg() Error\n"));
                iRet = PD_ERR;
        }
        
        hash_destroy(hRec);
	FREE_ME(hRec);

DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	return iRet;
}


int BuildAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csTmp;
        char*   csBuf;
        char*   csTxnId = NULL;
	double	dTmp;
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );
	char	cCardType;

DEBUGLOG(("BuildAuthData()\n"));
	memset(csBuf,0,MAX_MSG_SIZE);
	csBuf[0] = '\0';



/* 0 version*/
	strcat((char*)csBuf,"version");
	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
	strcat((char*)csBuf,"2.6");
	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: version = [2.6]\n"));


/* 1 serialID*/
	if (GetField_CString(hIn,"txn_seq",&csTxnId)) {
		strcat((char*)csBuf,"serialID");
		strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
		strcat((char*)csBuf,csTxnId);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: serialID = [%s]\n",csTxnId));
	}

/* 2 submitTime */
	if (GetField_CString(hIn,"local_tm_date",&csTmp)) {
DEBUGLOG(("BuildAuthData:: local_tm_date = [%s]\n",csTmp));
		char*   csPtr2;
		char    csDateTime[PD_DATETIME_LEN * 2];
		if (GetField_CString(hIn,"local_tm_time",&csPtr2)) {
DEBUGLOG(("BuildAuthData:: local_tm_time = [%s]\n",csPtr2));
			sprintf(csDateTime,"%s%s",csTmp,csPtr2);
DEBUGLOG(("BuildAuthData:: submitTime  = [%s]\n",csDateTime));
			strcat((char*)csBuf,"submitTime");
			strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
			strcat((char*)csBuf,csDateTime);
			strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
		}
		else {
DEBUGLOG(("BuildAuthData:: local_tm_time is missing!!!\n"));
		}
	}
	else {
DEBUGLOG(("BuildAuthData:: local_tm_date is missing!!!\n"));
	}


/*3 failureTime */
	strcat((char*)csBuf,"failureTime");
	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);

/*4 customerIP */
	strcat((char*)csBuf,"customerIP");
	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);

	char    csTmpAmt[PD_TMP_BUF_LEN +1];
	csTmpAmt[0] = '\0';
	if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {

		sprintf((char*)csTmpAmt,"%ld",double2long(dTmp));
DEBUGLOG(("BuildAuthData:: order_amount = [%s]\n",csTmpAmt));
	}
	else {
DEBUGLOG(("BuildAuthData:: psp_txn_amt is missing!!!\n"));
	}

/*5 orderDetails*/
	strcat((char*)csBuf,"orderDetails");
	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
	strcat((char*)csBuf,csTxnId);
	strcat((char*)csBuf,MY_HNA_SEPERATER);
	strcat((char*)csBuf,csTmpAmt);
	strcat((char*)csBuf,MY_HNA_SEPERATER);
	strcat((char*)csBuf,"DSP");
	strcat((char*)csBuf,MY_HNA_SEPERATER);
	strcat((char*)csBuf,"DSP");
	strcat((char*)csBuf,MY_HNA_SEPERATER);
	strcat((char*)csBuf,"1");
	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);

/*6 totalAmount*/
	strcat((char*)csBuf,"totalAmount");
	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
	strcat((char*)csBuf,csTmpAmt);
	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);

/*7 type*/
	strcat((char*)csBuf,"type");
	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
	strcat((char*)csBuf,"1000");
	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: type = [1000]\n"));


/*8 buyerMarked*/
	if (GetField_CString(hIn,"buyer_marked",&csTmp)) {
		strcat((char*)csBuf,"buyerMarked");
		strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
		strcat((char*)csBuf,csTmp);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: buyerMarked = [%s]\n",csTmp));
	}

/*9 payType*/
	if (GetField_Char(hIn,"card_type",&cCardType)) {
DEBUGLOG(("BuildAuthData:: card_type = [%c]\n", cCardType));

		if (cCardType == PD_DEPOSIT_CARD_TYPE_DEBIT) {
			strcat((char*)csBuf,"payType");
                	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
                	strcat((char*)csBuf,"BANK_B2C,LARGE_DEBIT_CARD");
                	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: payType = [BANK_B2C,LARGE_DEBIT_CARD]\n"));
		} else if (cCardType == PD_DEPOSIT_CARD_TYPE_CREDIT) {
			strcat((char*)csBuf,"payType");
                        strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
                        strcat((char*)csBuf,"BANK_B2C,LARGE_CREDIT_CARD");
                        strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: payType = [BANK_B2C,LARGE_CREDIT_CARD]\n"));
		} else {
DEBUGLOG(("BuildAuthData:: card_type is incorrect!!!\n"));
		}		
	} else {
		strcat((char*)csBuf,"payType");
		strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
		strcat((char*)csBuf,"BANK_B2C");
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: payType = [BANK_B2C]\n"));
	}

/*10 orgCode*/
	if (GetField_CString(hIn,"bank_code",&csTmp)) {
		strcat((char*)csBuf,"orgCode");
		strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
		strcat((char*)csBuf,csTmp);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: orgCode = [%s]\n",csTmp));
	}
	else {
DEBUGLOG(("BuildAuthData:: bank_code is missing!!!\n"));
	}

/*11 currencyCode*/
	strcat((char*)csBuf,"currencyCode");
	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
	strcat((char*)csBuf,"1");
	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: currencyCode = [1]\n"));

/*12 directFlag*/
	strcat((char*)csBuf,"directFlag");
	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
	strcat((char*)csBuf,"1");
	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: directFlag = [1]\n"));

/*13 borrowingMarked*/
	strcat((char*)csBuf,"borrowingMarked");
	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
	strcat((char*)csBuf,"0");
	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: borrowingMarked = [0]\n"));

/*14 couponFlag*/
	strcat((char*)csBuf,"couponFlag");
	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
	strcat((char*)csBuf,"0");
	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: couponFlag = [0]\n"));

/*15 platformID*/
	strcat((char*)csBuf,"platformID");
	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);


/*16 returnUrl*/
	if (GetField_CString(hIn,"fe_url",&csTmp)) {
		strcat((char*)csBuf,"returnUrl");
		strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
		strcat((char*)csBuf,csTmp);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: returnUrl = [%s]\n",csTmp));
	}

/*17 noticeUrl*/
	if (GetField_CString(hIn,"return_url_only",&csTmp)) {
		strcat((char*)csBuf,"noticeUrl");
		strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
		strcat((char*)csBuf,csTmp);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: noticeUrl = [%s]\n",csTmp));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: *** return_url_only is missing\n"));
	}


/*18 partnerID*/
	if (GetField_CString(hIn,"psp_merchant_id",&csTmp)) {
		strcat((char*)csBuf,"partnerID");
		strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
		strcat((char*)csBuf,csTmp);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: partnerID = [%s]\n",csTmp));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: ***psp_merchant_id is missing\n"));
	}

/*19 remark*/
	strcat((char*)csBuf,"remark");
	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
	strcat((char*)csBuf,csTxnId);
	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: remark = %s\n",csTxnId));


/*20 charset*/
	strcat((char*)csBuf,"charset");
	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
	strcat((char*)csBuf,"1");
	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: charset = [1]\n"));



/*21 signType*/
	strcat((char*)csBuf,"signType");
	strcat((char*)csBuf,MY_HNA_FIELD_TOKEN);
	strcat((char*)csBuf,"2");
	strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildAuthData:: signType = [2]\n"));


	strcat((char*)csBuf,"pkey=");
	PutField_CString(hIn,"auth_data",csBuf);
DEBUGLOG(("BuildAuthData:: auth_data = [%s]\n",csBuf));
	FREE_ME(csBuf);
        
DEBUGLOG(("BuildAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

int BuildRspAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr;
        char*   csBuf;
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildRspAuthData()\n"));
	memset(csBuf,0,MAX_MSG_SIZE);
	csBuf[0] = '\0';
	

/* 1 orderID*/
	if (GetField_CString(hIn,"txn_seq",&csPtr)) {
		strcat((char*)csBuf,"orderID=");
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildRspAuthData:: orderID = [%s]\n",csPtr));
	}

/* 2 resultCode*/
	if (GetField_CString(hIn,"resultCode",&csPtr)) {
		strcat((char*)csBuf,"resultCode=");
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildRspAuthData:: resultCode = [%s]\n",csPtr));
	}
	else{
		strcat((char*)csBuf,"resultCode=");
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
	}

/* 3 stateCode*/
	if (GetField_CString(hIn,"status",&csPtr)) {
		strcat((char*)csBuf,"stateCode=");
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildRspAuthData:: stateCode = [%s]\n",csPtr));
	}


/* 4 orderAmount*/
	if (GetField_CString(hIn,"txn_amt",&csPtr)) {
		strcat((char*)csBuf,"orderAmount=");
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildRspAuthData:: orderAmount = [%s]\n",csPtr));
	}

/* 5 payAmount*/
	if (GetField_CString(hIn,"pay_amt",&csPtr)) {
		strcat((char*)csBuf,"payAmount=");
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildRspAuthData:: payAmount = [%s]\n",csPtr));
	}


/* 6 acquiringTime*/
	if (GetField_CString(hIn,"acquiring_time",&csPtr)) {
		strcat((char*)csBuf,"acquiringTime=");
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildRspAuthData:: acquiringTime = [%s]\n",csPtr));
	}

/* 7 completeTime*/
	if (GetField_CString(hIn,"fundin_date",&csPtr)) {
		strcat((char*)csBuf,"completeTime=");
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildRspAuthData:: completeTime = [%s]\n",csPtr));
	}

/* 8 orderNo*/
	if (GetField_CString(hIn,"tid",&csPtr)) {
		strcat((char*)csBuf,"orderNo=");
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildRspAuthData:: orderNo = [%s]\n",csPtr));
	}
	else{
		strcat((char*)csBuf,"orderNo=");
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
	}

/* 9 partnerID*/
	if (GetField_CString(hIn,"mid",&csPtr)) {
		strcat((char*)csBuf,"partnerID=");
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildRspAuthData:: partnerID = [%s]\n",csPtr));
	}

/* 10 remark*/
	if (GetField_CString(hIn,"remark",&csPtr)) {
		strcat((char*)csBuf,"remark=");
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildRspAuthData:: remark = [%s]\n",csPtr));
	}

/* 11 charset*/
	if (GetField_CString(hIn,"charset",&csPtr)) {
		strcat((char*)csBuf,"charset=");
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildRspAuthData:: charset = [%s]\n",csPtr));
	}

/* 12 signType*/
	if (GetField_CString(hIn,"signType",&csPtr)) {
		strcat((char*)csBuf,"signType=");
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_HNA_AUTH_TOKEN);
DEBUGLOG(("BuildRspAuthData:: signType = [%s]\n",csPtr));
	}

	strcat((char*)csBuf,"pkey=");

	PutField_CString(hIn,"auth_data",csBuf);
DEBUGLOG(("BuildRspAuthData:: auth_data = [%s]\n",csBuf));
	FREE_ME(csBuf);
        
DEBUGLOG(("BuildRspAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}
