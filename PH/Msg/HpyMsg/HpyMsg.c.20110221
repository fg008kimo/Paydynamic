/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version                                       20110217		   LokMan Chow
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "HpyMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include "internal.h"
#include "ObjPtr.h"

#include "b64.h"
char	cDebug;

OBJPTR(Msg);

void	HpyMsg(char cdebug)
{
	cDebug = cdebug;
}
int DEBlockHpayData(hash_t *hOut,const unsigned char *inMsg,int inLen);

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;

	char*	csPtr = NULL;
	char* 	csTmp;
	char	cStatus;
	char*	csBuf;
	char*	csPspId;

DEBUGLOG(("FormatMsg()\n"));
	outMsg[0]= '\0';
        *outLen = 0;
        if (GetField_Char(hIn,"status",&cStatus)) {
DEBUGLOG(("FormatMsg:: status = [%c]\n",cStatus));
                if (cStatus == PD_TO_PSP) {
			if (!GetField_CString(hIn,"psp_id",&csPspId)) {
DEBUGLOG(("FormatMsg:: Psp Id Not Found!\n"));
			}
			else{
DEBUGLOG(("FormatMsg:: Psp Id = [%s]\n",csPspId));
				if(!strcmp(csPspId,PD_PSP_TWV)){
                        		if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg:: redirect_url = [%s]\n",csPtr));
                                		strcat((char*)outMsg,"redirect_url");
                                		strcat((char*)outMsg,"=");
                                		csBuf = (char*) malloc (PD_MAX_BUFFER +1);
                                		base64_encode(csPtr,strlen(csPtr),csBuf,PD_MAX_BUFFER);
                                		strcat((char*)outMsg,csBuf);
                                		*outLen = strlen((const char*)outMsg);
                                		FREE_ME(csBuf);
                        		}
                        		else {
DEBUGLOG(("FormatMsg redirect_url not found\n"));
ERRLOG("FormatMsg redirect_url not found\n");
                        		}
				}
				else if(!strcmp(csPspId,PD_PSP_ESKY)){
//call ESkyMsg//
					MsgObjPtr = CreateObj(MsgPtr,"ESkyMsg","FormatMsg");
					if ((*MsgObjPtr)(hIn,outMsg,outLen) != PD_OK) {
DEBUGLOG(("FormatMsg format ESkyMsg error\n"));
ERRLOG("FormatMsg format ESkyMsg error\n");
					}
					else
DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));

				}
			}
                        return iRet;
                }
        }

        /* response code */
        if (GetField_CString(hIn,"response_code",&csPtr)) {
                if (!strcmp(csPtr,"0")) {
                        if (GetField_CString(hIn,"success_url",&csTmp)) {
                                strcat((char*)outMsg,csTmp);
                        }
                }
                else {
                        if (GetField_CString(hIn,"failure_url",&csTmp)) {
                                strcat((char*)outMsg,csTmp);
                        }
                }
                strcat((char*)outMsg,"?");
DEBUGLOG(("FormatMsg:: redirect_url = [%s]\n",outMsg));
DEBUGLOG(("FormatMsg:: response_code = [%s]\n",csPtr));
        }
	/* Mode */
        if (GetField_CString(hIn,"txn_mode",&csPtr)) {
DEBUGLOG(("FormatMsg:: txn_mode = [%s]\n",csTmp));
		if (!strcmp(csPtr,PD_FE_TXN)) {
/* Merchant ID */
                        if (GetField_CString(hIn,"merchant_id",&csTmp)) {
DEBUGLOG(("FormatMsg:: MERID = [%s]\n",csTmp));
				strcat((char*)outMsg,"MERID");
                		strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
                		strcat((char*)outMsg,csTmp);
                		strcat((char*)outMsg,MY_HPAY_TOKEN);	
			}
/* Merchant Ref */
                        if (GetField_CString(hIn,"merchant_ref",&csTmp)) {
DEBUGLOG(("FormatMsg:: MERORDERID = [%s]\n",csTmp));
				strcat((char*)outMsg,"MERORDERID");
                		strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
                		strcat((char*)outMsg,csTmp);
                		strcat((char*)outMsg,MY_HPAY_TOKEN);	
			}
		}
		else
		{
		}
	}
	csBuf = (char*) malloc (PD_MAX_BUFFER +1);
DEBUGLOG(("FormatMsg outmsg = [%s]\n",outMsg));
        base64_encode(outMsg,strlen(outMsg),csBuf,PD_MAX_BUFFER);
        outMsg[0] = '\0';
        strcat((char*)outMsg,"redirect_url");
        strcat((char*)outMsg,"=");
        strcat((char*)outMsg,csBuf);
        FREE_ME(csBuf);


	*outLen = strlen((const char*)outMsg);


DEBUGLOG(("FormatMsg() Exit\n"));
	return 	iRet;
}


int FormatAckMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;
	char*	csBuf;
	char*	csPtr;
	char	cStatus;

DEBUGLOG(("FormatAckMsg()\n"));
	outMsg[0]= '\0';
        *outLen = 0;
	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );
	

	memset(csBuf,0,sizeof(csBuf));
        strcat((char*)csBuf,"url");
        strcat((char*)csBuf,MY_HPAY_FIELD_TOKEN);

        if (GetField_Char(hIn,"txn_status",&cStatus)) {
DEBUGLOG(("FormatAckMsg txn_status = [%c]\n",cStatus));
	}
	if (cStatus == PD_ACCEPT) {
                if (GetField_CString(hIn,"success_callback_url",&csPtr)) {
        		strcat((char*)csBuf,csPtr);
DEBUGLOG(("FormatAckMsg success_callback_url = [%s]\n",csPtr));
                }

	}
	else {
                if (GetField_CString(hIn,"failure_callback_url",&csPtr)) {
        		strcat((char*)csBuf,csPtr);
DEBUGLOG(("FormatAckMsg failure_callback_url = [%s]\n",csPtr));
                }
	}
        strcat((char*)csBuf,MY_HPAY_TOKEN);

	sprintf(outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
        strcat(outMsg,csBuf);

/*merchant_id*/
	if (GetField_CString(hIn,"merchant_id",&csPtr)){
DEBUGLOG(("FormatAckMsg:: MERID = [%s]\n",csPtr));
		strcat((char*)outMsg,"MERID");
        	strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
               	strcat((char*)outMsg,csPtr);
               	strcat((char*)outMsg,MY_HPAY_TOKEN);	
	}
/*encrypt_type*/
	if (GetField_CString(hIn,"encrypt_type",&csPtr)){
DEBUGLOG(("FormatAckMsg:: ENCTYPE = [%s]\n",csPtr));
		strcat((char*)outMsg,"ENCTYPE");
        	strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
               	strcat((char*)outMsg,csPtr);
               	strcat((char*)outMsg,MY_HPAY_TOKEN);	
	}
/*plainttext_data*/
	if (GetField_CString(hIn,"plainttext_data",&csPtr)){
DEBUGLOG(("FormatAckMsg:: plainttext_data = [%s]\n",csPtr));
		csBuf[0]='\0';
		base64_encode(csPtr,strlen(csPtr),csBuf,PD_MAX_BUFFER);
DEBUGLOG(("FormatAckMsg:: DATA = [%s]\n",csBuf));

		strcat((char*)outMsg,"DATA");
        	strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
               	strcat((char*)outMsg,csBuf);
               	strcat((char*)outMsg,MY_HPAY_TOKEN);	
	}
/*sign*/
	if (GetField_CString(hIn,"sign",&csPtr)){
DEBUGLOG(("FormatAckMsg:: SIGN = [%s]\n",csPtr));
		strcat((char*)outMsg,"SIGN");
        	strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
               	strcat((char*)outMsg,csPtr);
               	strcat((char*)outMsg,MY_HPAY_TOKEN);	
	}

	*outLen = strlen((const char*)outMsg);


	FREE_ME(csBuf);
DEBUGLOG(("FormatAckMsg:: outMsg = [%s]\n",outMsg));
DEBUGLOG(("FormatAckMsg() Exit iRet = [%d]\n",iRet));
	return 	iRet;
}

int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csBuf;
	char	*p;

	csBuf = (char*) malloc (1024 * 2 +1);

	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';
DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("BreakDownMsg msg=[%s]\n",csBuf));

/*merchant id */
	p = GetField(csBuf,"MERID",MY_HPAY_TOKEN,MY_HPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"merchant_id",p);
DEBUGLOG(("BreakDownMsg merchant_id = [%s]\n",p));
	}
/*encrypt_type */
	p = GetField(csBuf,"ENCTYPE",MY_HPAY_TOKEN,MY_HPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"encrypt_type",p);
DEBUGLOG(("BreakDownMsg encrypt_type = [%s]\n",p));
	}

/* data */
	p = GetField(csBuf,"DATA",MY_HPAY_TOKEN,MY_HPAY_FIELD_TOKEN);
	if(p) {
		iRet = DEBlockHpayData(hOut,p,strlen(p));
	}

/* SIGN */
	p = GetField(csBuf,"SIGN",MY_HPAY_TOKEN,MY_HPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"sign",p);
DEBUGLOG(("BreakDownMsg sign = [%s]\n",p));
	}

/*
// process_type //
	p = GetField(csBuf,"process_type",MY_HPAY_TOKEN,MY_HPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"process_type",p);
DEBUGLOG(("BreakDownMsg process_type = [%s]\n",p));
	}
// process_code //
	p = GetField(csBuf,"process_code",MY_HPAY_TOKEN,MY_HPAY_FIELD_TOKEN);
	if(p) {
		PutField_CString(hOut,"process_code",p);
DEBUGLOG(("BreakDownMsg process_code = [%s]\n",p));
	}
*/	

	FREE_ME(csBuf);
DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	char	*csPtr = NULL;
DEBUGLOG(("initReplyFromRequest()\n"));
	
/* merchant_id */
	if (GetField_CString(hRequest,"merchant_id",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: merchant_id = [%s]\n",csPtr));
		PutField_CString(hResponse,"merchant_id",csPtr);
	}
/* merchant_ref */

	if (GetField_CString(hRequest,"merchant_ref",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: merchant_ref = [%s]\n",csPtr));
		PutField_CString(hResponse,"merchant_ref",csPtr);
	}

/* reference */
	if (GetField_CString(hRequest,"reference",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: reference = [%s]\n",csPtr));
		PutField_CString(hResponse,"reference",csPtr);
	}
/* transaction_datetime */
	if (GetField_CString(hRequest,"transaction_datetime",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: transaction_datetime = [%s]\n",csPtr));
		PutField_CString(hResponse,"transaction_datetime",csPtr);
	}

/* pay_method */
	if (GetField_CString(hRequest,"pay_method",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: pay_method = [%s]\n",csPtr));
		PutField_CString(hResponse,"pay_method",csPtr);
	}

/* pay_amount */
	if (GetField_CString(hRequest,"txn_amt",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: txn_amt = [%s]\n",csPtr));
		PutField_CString(hResponse,"txn_amt",csPtr);
	}
/* currency_code */
	if (GetField_CString(hRequest,"txn_ccy",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: currency_code = [%s]\n",csPtr));
		PutField_CString(hResponse,"txn_ccy",csPtr);
	}
/* show_paypage */
	if (GetField_CString(hRequest,"show_paypage",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: show_paypage = [%s]\n",csPtr));
		PutField_CString(hResponse,"show_paypage",csPtr);
	}

/* success_url */
	if (GetField_CString(hRequest,"success_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: success_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"success_url",csPtr);
	}
/* success_callback_url */
	if (GetField_CString(hRequest,"success_callback_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: success_callback_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"success_callback_url",csPtr);
	}

/* failure_url */
	if (GetField_CString(hRequest,"failure_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: failure_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"failure_url",csPtr);
	}
/* failure_callback_url */
	if (GetField_CString(hRequest,"failure_callback_url",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: failure_callback_url = [%s]\n",csPtr));
		PutField_CString(hResponse,"failure_callback_url",csPtr);
	}
/* process_type */
	if (GetField_CString(hRequest,"process_type",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: process_type = [%s]\n",csPtr));
		PutField_CString(hResponse,"process_type",csPtr);
	}
/* process_code */
	if (GetField_CString(hRequest,"process_code",&csPtr)) {
DEBUGLOG(("initReplyFromRequest: process_code = [%s]\n",csPtr));
		PutField_CString(hResponse,"process_code",csPtr);
	}


DEBUGLOG(("initReplyFromRequest() Exit\n"));
	return iRet;
}
int DEBlockHpayData(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csBuf;
	char	*csDATA;
	char	*p;
	int	iLen;

	csBuf = (char*) malloc (PD_MAX_BUFFER +1);
	csDATA = (char*) malloc (PD_MAX_BUFFER +1);

	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';
DEBUGLOG(("\n\nDEBlockData data=[%s]\n\n",csBuf));
	//if (base64_decode(csBuf,csDATA,PD_MAX_BUFFER) > 0 ) {
	iLen = base64_decode(csBuf,csDATA,PD_MAX_BUFFER);
	csDATA[iLen] = '\0';
	if (iLen > 0 ) {
DEBUGLOG(("\n\nDEBlockData data=[%s]\n\n",csDATA));
DEBUGLOG(("iRet = [%d] DATA = [%s]\n",iRet,csDATA));
		PutField_CString(hOut,"plainttext_data",csDATA);

/* txn_id */
		p = strtok(csDATA,MY_HPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"txn_seq",p);
DEBUGLOG(("DEBlockData txn_id = [%s]\n",p));
		}

/* Merchant Ref */
		p = strtok(csDATA,MY_HPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"merchant_ref",p);
DEBUGLOG(("DEBlockData merchant_ref = [%s]\n",p));
		}

/* transmission_datetime */
		p = strtok(NULL,MY_HPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"transmission_datetime",p);
DEBUGLOG(("DEBlockData transmission_datetime = [%s]\n",p));
		}

/* tid */
		p = strtok(csDATA,MY_HPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"tid",p);
DEBUGLOG(("DEBlockData tid = [%s]\n",p));
		}

/* fundin_date */ 
		p = strtok(csDATA,MY_HPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"fundin_date",p);
DEBUGLOG(("DEBlockData fundin_date = [%s]\n",p));
		}

/* net_amt */
		p = strtok(csDATA,MY_HPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"txn_amt",p);
DEBUGLOG(("DEBlockData txn_amt = [%s]\n",p));
		}

/* currency_code */
		p = strtok(csDATA,MY_HPAY_DATA_TOKEN);
		if (p) {
                        if(strncmp(p,"100",PD_CCY_ID_LEN)==0){
                                PutField_CString(hOut,"currency_code","100");
                                PutField_CString(hOut,"txn_ccy","CNY");
                        }
                        else{
                                iRet = PD_ERR;
DEBUGLOG(("DEBlockData invalid currency code [%s]\n",p));
			}
DEBUGLOG(("DEBlockData currency_code = [%s]\n",p));
		}

/* language */
                p = strtok(NULL,MY_HPAY_DATA_TOKEN);
                if (p) {
                        PutField_CString(hOut,"language",p);
DEBUGLOG(("DEBlockData language = [%s]\n",p));
                }

/* remark */
                p = strtok(NULL,MY_HPAY_DATA_TOKEN);
                if (p) {
                        PutField_CString(hOut,"remark",p);
DEBUGLOG(("DEBlockData remark = [%s]\n",p));
                }
                else {
                        PutField_CString(hOut,"remark","");
                }
	}


	FREE_ME(csBuf);
	FREE_ME(csDATA);
DEBUGLOG(("DBlockData Exit\n"));
	return	iRet;
}

int BuildData(hash_t* hIn)
{
	int	iRet = PD_OK;
	char	cStatus;
	char*	csPtr,*csDATA;
	char*	csTmp[PD_MAX_BUFFER + 1];
	double	dTmp;
	csDATA = (char*) malloc (1024 * 2 +1);

DEBUGLOG(("BuildData()\n"));

        if (GetField_Char(hIn,"txn_status",&cStatus)) {
DEBUGLOG(("BuildData txn_status = [%c]\n",cStatus));
	}

	memset(csDATA,0,sizeof(csDATA));

// Merchant Ref
        if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
DEBUGLOG(("BuildData:: MERORDERID = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }

// transmission_datetime
        if (GetField_CString(hIn,"transmission_datetime",&csPtr)) {
DEBUGLOG(("BuildData:: MERDATE = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }

// net_amt
        if (GetField_Double(hIn,"net_amt",&dTmp)) {
DEBUGLOG(("BuildData:: AMOUNT = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",(long)dTmp * 100);
DEBUGLOG(("BuildData:: AMOUNT = [%s]\n",csTmp));
                strcat((char*)csDATA,(char*)csTmp);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }

// currency_code
        if (GetField_CString(hIn,"currency_code",&csPtr)) {
DEBUGLOG(("BuildData:: CURTYPE = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }

// tradeway
	//hardcode
        strcat((char*)csDATA,"1");
        strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);

// language
        if (GetField_CString(hIn,"language",&csPtr)) {
DEBUGLOG(("BuildData:: LANG = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }

/* success_callback_url */
	if (GetField_CString(hIn,"success_callback_url",&csPtr)) {
DEBUGLOG(("BuildData:: success_callback_url = [%s]\n",csPtr));
		strcat((char*)csDATA,csPtr);
		strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
	}

/* failure_url */
	if (GetField_CString(hIn,"failure_url",&csPtr)) {
DEBUGLOG(("BuildData:: failure_url = [%s]\n",csPtr));
		strcat((char*)csDATA,csPtr);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
	}

/* success_url */
	if (GetField_CString(hIn,"success_url",&csPtr)) {
DEBUGLOG(("BuildData:: success_url = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }

/* recvenctype */
	if (GetField_CString(hIn,"recvenctype",&csPtr)) {
DEBUGLOG(("BuildData:: recvenctype = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }

/* show_paypage */
	if (GetField_CString(hIn,"show_paypage",&csPtr)) {
DEBUGLOG(("BuildData:: show_paypage = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }

/* remark */
	if (GetField_CString(hIn,"remark",&csPtr)) {
DEBUGLOG(("BuildData:: REMARK = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
        }


////old////
/*
// txn_id 
        if (GetField_CString(hIn,"txn_seq",&csPtr)) {
DEBUGLOG(("BuildData:: ORDERID = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
       		strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);	
	}

// Merchant Ref 
        if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
DEBUGLOG(("BuildData:: MERORDERID = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
       		strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);	
	}

// transmission_datetime 
        if (GetField_CString(hIn,"transmission_datetime",&csPtr)) {
DEBUGLOG(("BuildData:: MERDATE = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
       		strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);	
	}

// tid
        if (GetField_CString(hIn,"tid",&csPtr)) {
DEBUGLOG(("BuildData:: BANKBILLNO = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
       		strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);	
	}
// fundin_date 
        if (GetField_CString(hIn,"fundin_date",&csPtr)) {
DEBUGLOG(("BuildData:: BANKTIME = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
       		strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);	
	}



// net_amt 
        if (GetField_Double(hIn,"net_amt",&dTmp)) {
DEBUGLOG(("BuildData:: AMOUNT = [%f]\n",dTmp));
		sprintf((char*)csTmp,"%ld",(long)dTmp * 100);
DEBUGLOG(("BuildData:: AMOUNT = [%s]\n",csTmp));
       		strcat((char*)csDATA,(char*)csTmp);
       		strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);	
	}
// currency_code 
        if (GetField_CString(hIn,"currency_code",&csPtr)) {
DEBUGLOG(("BuildData:: CURTYPE = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
       		strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);	
	}
// language 
        if (GetField_CString(hIn,"language",&csPtr)) {
DEBUGLOG(("BuildData:: LANG = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
       		strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);	
	}
	if (cStatus == PD_ACCEPT) {
DEBUGLOG(("BuildData:: ISSUCC = 'Y'\n"));
		sprintf(csPtr,"Y");
	}
	else {
		if (GetField_CString(hIn,"error_code",&csPtr)) {
DEBUGLOG(("BuildData:: ISSUCC = [%s]\n",csPtr));
		}
		else {
DEBUGLOG(("BuildData:: ISSUCC = 'N'\n"));
			sprintf(csPtr,"N");
		}
	}
       	strcat((char*)csDATA,csPtr);
       	strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);	

// remark 
        if (GetField_CString(hIn,"remark",&csPtr)) {
DEBUGLOG(("BuildData:: REMARK = [%s]\n",csPtr));
       		strcat((char*)csDATA,csPtr);
	}
*/

	PutField_CString(hIn,"plainttext_data",csDATA);

DEBUGLOG(("BuildData:: DATA = [%s]\n",csDATA));

	FREE_ME(csDATA);
DEBUGLOG(("BuildData() Exit iRet = [%d]\n",iRet));
	return 	iRet;
}

int FormatFEMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
        int     iRet = PD_OK;
        int     iTmp;
        char    *csPtr;
	char	*csBuf;
	char	cStatus;
	char	cPtr;
DEBUGLOG(("FormatFEMsg()\n"));

	csBuf = (char*) malloc (1024 *2 +1);
	memset(csBuf,0,sizeof(csBuf));
	outMsg[0] = '\0';
	if (GetField_Char(hIn,"status",&cStatus)) {
DEBUGLOG(("FormatFEMsg:: status = [%c]\n",cStatus));
	}
	else {
DEBUGLOG(("FormatFEMsg:: status not found\n"));
	}
	if (cStatus == PD_TO_PSP) {
               	if (GetField_CString(hIn,"failure_url",&csPtr)) {
               		strcat((char*)outMsg,csPtr);
                }
               	strcat((char*)outMsg,"?");
		sprintf(csBuf,"error_code%s%d%s",MY_HPAY_FIELD_TOKEN,INT_ACK_NOT_YET_RETURN,MY_HPAY_TOKEN);
		strcat(outMsg,csBuf);

		if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
                        strcat((char*)outMsg,"MERORDERID");
                        strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_HPAY_TOKEN);
                }
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
                if (GetField_CString(hIn,"merchant_id",&csPtr)) {
                        strcat((char*)outMsg,"MERID");
                        strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_HPAY_TOKEN);
                }
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
		base64_encode(outMsg,strlen(outMsg),csBuf,PD_MAX_BUFFER);
        	outMsg[0] = '\0';
		sprintf(outMsg,"status=%c&",cStatus);
        	strcat((char*)outMsg,"redirect_url");
        	strcat((char*)outMsg,"=");
        	strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
		*outLen = strlen((const char*)outMsg);
DEBUGLOG(("FormatFEMsg:: ACK not yet return\n"));
		FREE_ME(csBuf);
        	return iRet;
	}
	else {
        	if (GetField_Char(hIn,"ar_ind",&cPtr)) {
                	if (cPtr == PD_ACCEPT) {
                        	if (GetField_CString(hIn,"success_url",&csPtr)) {
                                	strcat((char*)outMsg,csPtr);
                        	}
                	}
                	else {
                        	if (GetField_CString(hIn,"failure_url",&csPtr)) {
                                	strcat((char*)outMsg,csPtr);
                        	}
                	}

                	strcat((char*)outMsg,"?");
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
DEBUGLOG(("FormatFEMsg:: response_code = [%d]\n",iTmp));
        	}
        	if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
                	strcat((char*)outMsg,"MERORDERID");
                	strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
                	strcat((char*)outMsg,csPtr);
                	strcat((char*)outMsg,MY_HPAY_TOKEN);
        	}
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
        	if (GetField_CString(hIn,"merchant_id",&csPtr)) {
                	strcat((char*)outMsg,"MERID");
                	strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
                	strcat((char*)outMsg,csPtr);
                	strcat((char*)outMsg,MY_HPAY_TOKEN);
        	}
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
		base64_encode(outMsg,strlen(outMsg),csBuf,PD_MAX_BUFFER);
        	outMsg[0] = '\0';
		sprintf(outMsg,"status=%c&",cStatus);
        	strcat((char*)outMsg,"redirect_url");
        	strcat((char*)outMsg,"=");
        	strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatFEMsg:: outMsg = [%s]\n",outMsg));
	
        
		*outLen = strlen((const char*)outMsg);

		FREE_ME(csBuf);

        	return iRet;
	}
}
