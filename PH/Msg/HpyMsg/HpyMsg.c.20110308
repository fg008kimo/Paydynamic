/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version					   20110221                LokMan Chow
bug fix						   20110222	 	   Cody Chan
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "HpyMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"

char	cDebug;

void	HpyMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;
	char*   csTmp = NULL;
	char*   csPtr = NULL;
	char*   csBuf;
	char*   csMethod = NULL;

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

	memset(outMsg,0,sizeof(outMsg));
	if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg here\n"));
		strcat(outMsg,csPtr);
		strcat(outMsg,"?");


/* merchant_id */
		if (GetField_CString(hIn,"psp_merchant_id",&csTmp)) {
			strcat((char*)outMsg,"MERID");
			strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_HPAY_TOKEN);
DEBUGLOG(("FormatMsg:: MERID = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** psp_merchant_id is missing\n"));
		}


/* enctype */
        	if (GetField_CString(hIn,"encrypt_type",&csTmp)) {
			strcat((char*)outMsg,"ENCTYPE");
                        strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
                        strcat((char*)outMsg,csTmp);
                        strcat((char*)outMsg,MY_HPAY_TOKEN);
DEBUGLOG(("FormatMsg:: ENCTYPE = [%s]\n",csTmp));
		}
		else{
			strcat((char*)outMsg,"ENCTYPE");
			strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
			strcat((char*)outMsg,"01");
			strcat((char*)outMsg,MY_HPAY_TOKEN);
DEBUGLOG(("FormatMsg:: default ENCTYPE = [01]\n"));
		}


/* data */
		if (GetField_CString(hIn,"plainttext_data",&csTmp)) {
DEBUGLOG(("FormatMsg:: plainttext_data = [%s]\n",csTmp));
			csBuf[0]='\0';
			base64_encode(csTmp,strlen(csTmp),csBuf,PD_MAX_BUFFER);
DEBUGLOG(("FormatMsg:: DATA = [%s]\n",csBuf));
                        strcat((char*)outMsg,"DATA");
                        strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
                        strcat((char*)outMsg,csBuf);
                        strcat((char*)outMsg,MY_HPAY_TOKEN);
                }


/* sign */
		if (GetField_CString(hIn,"sign",&csTmp)) {
			strcat((char*)outMsg,"SIGN");
			strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_HPAY_TOKEN);
DEBUGLOG(("FormatMsg:: SIGN = [%s]\n",csTmp));
		}

/* bank_id */
		if (GetField_CString(hIn,"bank_code",&csTmp)) {
			strcat((char*)outMsg,"BankID");
			strcat((char*)outMsg,MY_HPAY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
DEBUGLOG(("FormatMsg:: BankID = [%s]\n",csTmp));
		}


/* url_method */
                if (GetField_CString(hIn,"url_method",&csMethod)) {
DEBUGLOG(("FormatMsg:: url_method = [%s]\n",csMethod));
		}

DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));

		base64_encode(outMsg,strlen(outMsg),csBuf,PD_MAX_BUFFER);
                outMsg[0] = '\0';
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
		strcat((char*)outMsg,MY_HPAY_TOKEN);
		strcat((char*)outMsg,"url_method");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csMethod);

DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));


		*outLen = strlen((const char*)outMsg);
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: Redirct url not found\n"));
	}


	FREE_ME(csBuf);
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csBuf;
	char	*p;

	csBuf = (char*) malloc (1024 +1);

	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';
DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("BreakDownMsg msg=[%s]\n",csBuf));

/*merchant id */
        p = GetField(csBuf,"MerId",MY_HPAY_TOKEN,MY_HPAY_FIELD_TOKEN);
        if(p) {
                PutField_CString(hOut,"merchant_id",p);
DEBUGLOG(("BreakDownMsg merchant_id = [%s]\n",p));
        }
/*encrypt_type */
        p = GetField(csBuf,"EncType",MY_HPAY_TOKEN,MY_HPAY_FIELD_TOKEN);
        if(p) {
                PutField_CString(hOut,"encrypt_type",p);
DEBUGLOG(("BreakDownMsg encrypt_type = [%s]\n",p));
        }

/* data */
        p = GetField(csBuf,"Data",MY_HPAY_TOKEN,MY_HPAY_FIELD_TOKEN);
        if(p) {
                iRet = DEBlockHpayData(hOut,p,strlen(p));
        }

/* SIGN */
        p = GetField(csBuf,"Sign",MY_HPAY_TOKEN,MY_HPAY_FIELD_TOKEN);
        if(p) {
                PutField_CString(hOut,"sign",p);
DEBUGLOG(("BreakDownMsg sign = [%s]\n",p));
        }
	

	FREE_ME(csBuf);
DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}


int BuildData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr,*csDATA;
        char*   csTmp[PD_MAX_BUFFER + 1];
	char*	csBuf;
        double  dTmp;
        csDATA = (char*) malloc (1024 * 2 +1);
	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 ); 

DEBUGLOG(("BuildData()\n"));

        memset(csDATA,0,sizeof(csDATA));
        
// Merchant Ref
        if (GetField_CString(hIn,"txn_seq",&csPtr)) {
DEBUGLOG(("BuildData:: MERORDERID = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }

// transmission_datetime
        if (GetField_CString(hIn,"local_tm_date",&csPtr)) {
DEBUGLOG(("BuildData:: MERDATE = [%s]\n",csPtr));
		strcat((char*)csDATA,csPtr);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }


// net_amt
        if (GetField_Double(hIn,"net_amt",&dTmp)) {
DEBUGLOG(("BuildData:: AMOUNT = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",(long)(dTmp * 100));
DEBUGLOG(("BuildData:: AMOUNT = [%s]\n",csTmp));
                strcat((char*)csDATA,(char*)csTmp);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }

// currency_code
        if (GetField_CString(hIn,"txn_ccy",&csPtr)) {
DEBUGLOG(("BuildData:: CURTYPE = [%s]\n",csPtr));
		if(!strcmp(csPtr,PD_CCY_ISO_CNY)) {
                	strcat((char*)csDATA,PD_CCY_RMB_HPAY);
                	strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
		}
		else {
ERRLOG("HpyMsg:BuildData unsupport CCY ISO to HIPAY\n");
		}
        }

// tradeway
        //hardcode
        strcat((char*)csDATA,"1");
        strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
DEBUGLOG(("BuildData:: TRADWAY = [%s]\n","1"));

/* recvenctype */
        if (GetField_CString(hIn,"recvenctype",&csPtr)) {
DEBUGLOG(("BuildData:: RECVENCTYPE = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }

/* success_callback_url */
        if (GetField_CString(hIn,"return_url_only",&csPtr)) {
DEBUGLOG(("BuildData:: S2SURL = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }

/* failure_url */
        if (GetField_CString(hIn,"fe_url",&csPtr)) {
DEBUGLOG(("BuildData:: FAILEDURL = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }

/* success_url */
        if (GetField_CString(hIn,"fe_url",&csPtr)) {
DEBUGLOG(("BuildData:: SUCCESSURL = [%s]\n",csPtr));
                strcat((char*)csDATA,csPtr);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }

// language
//        if (GetField_CString(hIn,"language",&csPtr)) {
DEBUGLOG(("BuildData:: LANG = [%s]\n","GB"));
                strcat((char*)csDATA,"GB");
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
 //       }

/* show_paypage */
        if (GetField_CString(hIn,"show_paypage",&csPtr)) {
DEBUGLOG(("BuildData:: show_paypage = [%s]\n",csPtr));
		csBuf[0]='\0';
                base64_encode(csPtr,strlen(csPtr),csBuf,PD_MAX_BUFFER);
DEBUGLOG(("FormatMsg:: SHOWNAMOUNT = [%s]\n",csBuf));
                strcat((char*)csDATA,csBuf);
                strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
        }
	else{
		strcat((char*)csDATA,MY_HPAY_DATA_TOKEN);
	}

/* remark */
        if (GetField_CString(hIn,"remark",&csPtr)) {
DEBUGLOG(("BuildData:: remark = [%s]\n",csPtr));
                csBuf[0]='\0';
                base64_encode(csPtr,strlen(csPtr),csBuf,PD_MAX_BUFFER);
DEBUGLOG(("BuildData:: REMARK = [%s]\n",csBuf));
                strcat((char*)csDATA,csPtr);
        }


        PutField_CString(hIn,"plainttext_data",csDATA);

DEBUGLOG(("BuildData:: DATA = [%s]\n",csDATA));

        FREE_ME(csDATA);
DEBUGLOG(("BuildData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

int DEBlockHpayData(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
        int     iRet = PD_OK;
        char    *csTmp;
        char    *csBuf;
        char    *csDATA;
        char    *p;
        int     iLen;

        csBuf = (char*) malloc (PD_MAX_BUFFER +1);
        csDATA = (char*) malloc (PD_MAX_BUFFER +1);

        memcpy(csBuf,inMsg,inLen);
        csBuf[inLen] = '\0';
DEBUGLOG(("\n\nDEBlockData data=[%s]\n\n",csBuf));
        iLen = base64_decode(csBuf,csDATA,PD_MAX_BUFFER);
        csDATA[iLen] = '\0';
        if (iLen > 0 ) {
DEBUGLOG(("\n\nDEBlockData data=[%s]\n\n",csDATA));
DEBUGLOG(("iRet = [%d] DATA = [%s]\n",iRet,csDATA));
                PutField_CString(hOut,"plainttext_data",csDATA);

/* Merchant Ref */
                p = strtok(csDATA,MY_HPAY_DATA_TOKEN);
                if (p) {
                        PutField_CString(hOut,"merchant_ref",p);
DEBUGLOG(("DEBlockData merchant_reg = [%s]\n",p));
                }

/* txn_id */
                p = strtok(NULL,MY_HPAY_DATA_TOKEN);
                if (p) {
                        PutField_CString(hOut,"txn_seq",p);
DEBUGLOG(("DEBlockData txn_seq = [%s]\n",p));
                }

/* transmission_datetime */
                p = strtok(NULL,MY_HPAY_DATA_TOKEN);
                if (p) {
                        PutField_CString(hOut,"txn_date",p);
DEBUGLOG(("DEBlockData txn_date[transmission_datetime] = [%s]\n",p));
                }

/* tid */
                p = strtok(NULL,MY_HPAY_DATA_TOKEN);
                if (p) {
                        PutField_CString(hOut,"tid",p);
DEBUGLOG(("DEBlockData tid = [%s]\n",p));
                }

/* fundin_date */
                p = strtok(NULL,MY_HPAY_DATA_TOKEN);
                if (p) {
                        PutField_CString(hOut,"fundin_date",p);
DEBUGLOG(("DEBlockData fundin_date = [%s]\n",p));
                }

/* net_amt */
                p = strtok(NULL,MY_HPAY_DATA_TOKEN);
                if (p) {
                        PutField_CString(hOut,"txn_amt",p);
DEBUGLOG(("DEBlockData txn_amt = [%s]\n",p));
                }


/* currency_code */
                p = strtok(NULL,MY_HPAY_DATA_TOKEN);
                if (p) {
                        if(strncmp(p,PD_CCY_RMB_HPAY,PD_CCY_ID_LEN)==0){
                                PutField_CString(hOut,"txn_ccy",PD_CCY_ISO_CNY);
                        }
                        else{
                                iRet = PD_ERR;
DEBUGLOG(("DEBlockData invalid currency code [%s]\n",p));
                        }
DEBUGLOG(("DEBlockData currency_code = [%s]\n",p));
                }

/* language */
                p = strtok(NULL,MY_HPAY_DATA_TOKEN);
                if (p) {
                        PutField_CString(hOut,"language",p);
DEBUGLOG(("DEBlockData language = [%s]\n",p));
                }

/* issucc */
		p = strtok(NULL,MY_HPAY_DATA_TOKEN);
		if (p) {
			PutField_CString(hOut,"status",p);
DEBUGLOG(("DEBlockData status = [%s]\n",p));
		}

/* remark */
                p = strtok(NULL,MY_HPAY_DATA_TOKEN);
                if (p) {
			iLen = base64_decode(p,csTmp,PD_MAX_BUFFER);
			if(iLen>0){
                        	PutField_CString(hOut,"remark",csTmp);
DEBUGLOG(("DEBlockData remark = [%s]\n",csTmp));
			}
			else
DEBUGLOG(("DEBlockData remark = [%s]\n",p));
                }
                else {
                        PutField_CString(hOut,"remark","");
                }
        }


        FREE_ME(csBuf);
        FREE_ME(csDATA);
DEBUGLOG(("DBlockData Exit\n"));
        return  iRet;
}




int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	return iRet;
}


