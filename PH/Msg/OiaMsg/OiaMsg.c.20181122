/*
PDProTech (c)2018. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version (Clone from OPL)                      2018/11/12              Virginia Yun
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "OiaMsg.h"
#include "common.h"
#include "utilitys.h"
#include "b64.h"
#include "queue_defs.h"
#include "internal.h"
#include <zlib.h>
#include "ObjPtr.h"
#include "msg.h"


static char	cDebug;

OBJPTR(Msg);
OBJPTR(DB);

void	OiaMsg(char cdebug)
{
	cDebug = cdebug;
}

/*
int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;
	char*   csPtr = NULL;
	char*   csDate = NULL;
	char*   csTime = NULL;
	char	cStatus;

DEBUGLOG(("FormatMsg()\n"));

	outMsg[0]= '\0';
        *outLen = 0;

	
	if (GetField_Char(hIn,"status",&cStatus)) {
DEBUGLOG(("FormatMsg :: status = [%c]\n",cStatus));
		if (GetField_CString(hIn,"process_type",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: process_type = [%s]\n",csPtr));
                                strcat((char*)outMsg,"process_type");
                                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                                strcat((char*)outMsg,csPtr);
                                strcat((char*)outMsg,MY_OPL_TOKEN);
                        }
                        if (GetField_CString(hIn,"process_code",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: process_code = [%s]\n",csPtr));
                                strcat((char*)outMsg,"process_code");
                                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                                strcat((char*)outMsg,csPtr);
                                strcat((char*)outMsg,MY_OPL_TOKEN);
                        }
                        if (GetField_CString(hIn,"response_code",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: response_code = [%s]\n",csPtr));
                                strcat((char*)outMsg,"status");
                                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                                strcat((char*)outMsg,csPtr);
                                strcat((char*)outMsg,MY_OPL_TOKEN);

                        }

			if (GetField_CString(hIn,"txn_seq",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: txn_id = [%s]\n",csPtr));
				strcat((char*)outMsg,"txn_id");
				strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
				strcat((char*)outMsg,csPtr);
				strcat((char*)outMsg,MY_OPL_TOKEN);
			}
			if (GetField_CString(hIn,"local_tm_date",&csDate) &&
			    GetField_CString(hIn,"local_tm_time",&csTime)) {
DEBUGLOG(("FormatMsg (INI):: local_tm_date = [%s]\n",csDate));
DEBUGLOG(("FormatMsg (INI):: local_tm_time= [%s]\n",csTime));

				char csDateTime[PD_DATETIME_LEN+1];
				sprintf(csDateTime, "%s%s",csDate,csTime);
				strcat((char*)outMsg,"txn_date");
				strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                                strcat((char*)outMsg,csDateTime);
                                strcat((char*)outMsg,MY_OPL_TOKEN);
			}


			if (GetField_CString(hIn,"merchant_ref",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: merchant_ref = [%s]\n",csPtr));
                                strcat((char*)outMsg,"mer_ref");
                                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                                strcat((char*)outMsg,csPtr);
                                strcat((char*)outMsg,MY_OPL_TOKEN);
                        }
                        if (GetField_CString(hIn,"merchant_id",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: merchant_id = [%s]\n",csPtr));
                                strcat((char*)outMsg,"mer_id");
                                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                                strcat((char*)outMsg,csPtr);
                                strcat((char*)outMsg,MY_OPL_TOKEN);
                        }
                        if (GetField_CString(hIn,"encrypt_type",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: encrypt_type = [%s]\n",csPtr));
                                strcat((char*)outMsg,"enctype");
                                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                                strcat((char*)outMsg,csPtr);
                                strcat((char*)outMsg,MY_OPL_TOKEN);
                        }

			if (GetField_CString(hIn,"mac",&csPtr)) {
DEBUGLOG(("FormatMsg (INI):: mac = [%s]\n",csPtr));
                                strcat((char*)outMsg,"signature");
                                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                                strcat((char*)outMsg,csPtr);
                        }
DEBUGLOG(("FormatMsg (INI):: outmsg = [%s]\n",outMsg));
                                *outLen = strlen((const char*)outMsg);
	}

DEBUGLOG(("FormatMsg() Exit\n"));

	return iRet;
}
*/


int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	struct	json_object *jobj;
	
	char	*csPtr;
	int     iTmp;
	//double	dPtr;

	hash_t  *hRec;

	hRec = (hash_t*)  malloc (sizeof(hash_t));
	hash_init(hRec,0);

DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));

	jobj = json_tokener_parse((const char *)inMsg);
DEBUGLOG(("BreakDownMsg parsed\n"));
	iRet = ParseJ(jobj, hRec);
DEBUGLOG(("BreakDownMsg json_parsed\n"));
        json_object_put(jobj);
DEBUGLOG(("BreakDownMsg json_put\n"));

	if (iRet == PD_OK) {
// msg_type
		if (GetField_CString(hRec, "msg_type", &csPtr)) {
			PutField_CString(hOut, "process_type", csPtr);
DEBUGLOG(("BreakDownMsg:: process_type = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: process_type not found\n"));
		}


// msg_code
		if (GetField_CString(hRec, "msg_code", &csPtr)) {
			PutField_CString(hOut, "process_code", csPtr);
DEBUGLOG(("BreakDownMsg:: process_code = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: process_code not found\n"));
		}


// version
		if (GetField_CString(hRec, "version", &csPtr)) {
			PutField_CString(hOut, "version_no", csPtr);
DEBUGLOG(("BreakDownMsg:: version = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: version not found\n"));
		}



// enc_type
		if (GetField_CString(hRec, "enc_type", &csPtr)) {
			PutField_CString(hOut, "enc_type", csPtr);
DEBUGLOG(("BreakDownMsg:: enc_type = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: enc_type not found\n"));
		}

// sign
		if (GetField_CString(hRec, "sign", &csPtr)) {
			PutField_CString(hOut, "mac", csPtr);
DEBUGLOG(("BreakDownMsg:: sign = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: sign not found\n"));
		}

// info
// info.baid
		if (GetField_CString(hRec, "baid", &csPtr)) {
			PutField_CString(hOut, "baid", csPtr);
DEBUGLOG(("BreakDownMsg:: info.baid = [%s]\n", csPtr));
		}

// info.req_id
		if (GetField_CString(hRec, "req_id", &csPtr)) {
			PutField_CString(hOut, "req_ref", csPtr);
DEBUGLOG(("BreakDownMsg:: info.req_id = [%s]\n", csPtr));
		}

// info.to_baid
		if (GetField_CString(hRec, "to_baid", &csPtr)) {
			PutField_CString(hOut, "to_baid", csPtr);
DEBUGLOG(("BreakDownMsg:: info.to_baid = [%s]\n", csPtr));
		}

// info.amount
		if (GetField_CString(hRec, "amount", &csPtr)) {
			PutField_CString(hOut, "txn_amt", csPtr);
DEBUGLOG(("BreakDownMsg:: info.amount = [%s]\n", csPtr));
		}
/*
		if (GetField_Double(hRec, "amount", &dPtr)) {
			char csTmpAmt[PD_TMP_BUF_LEN + 1];
                        sprintf((char*)csTmpAmt, "%.2f", dPtr);

			PutField_CString(hOut, "txn_amt", csTmpAmt);
DEBUGLOG(("BreakDownMsg:: info.amount = [%s]\n", csTmpAmt));
		}
*/

// info.currency
		if (GetField_CString(hRec, "currency", &csPtr)) {
			PutField_CString(hOut, "txn_ccy", csPtr);
DEBUGLOG(("BreakDownMsg:: info.currency = [%s]\n", csPtr));
		}

// info.bank_nature
		if (GetField_CString(hRec, "bank_nature", &csPtr)) {
			PutField_CString(hOut, "bank_nature", csPtr);
DEBUGLOG(("BreakDownMsg:: info.bank_nature = [%s]\n", csPtr));
		}

// info.p_list
		if (GetField_Int(hRec, "p_list", &iTmp)) {
DEBUGLOG(("BreakDownMsg:: info.p_list = [%d]\n", iTmp));
			PutField_Int(hOut, "p_list", iTmp);

//info.p_list.#.baid
			char    csKey[PD_TMP_BUF_LEN +1];	
			int 	i = 0;

			for (i= 0; i < iTmp; i++) {
				sprintf(csKey, "p_list.%d.baid", i);

				if (GetField_CString(hRec, csKey, &csPtr)) {
					PutField_CString(hOut, csKey, csPtr);
DEBUGLOG(("BreakDownMsg:: info.[%s]= [%s]\n", csKey, csPtr));

				}
			}
		}

	} 

	if (iRet == PD_OK) {
		iRet = BuildAuthData(hOut);
DEBUGLOG(("BreakDownMsg:: return from BuildAuthData = [%d]\n",iRet));
	}

        hash_destroy(hRec);
        FREE_ME(hRec);

DEBUGLOG(("BreakDownMsg Exit iRet = [%d]\n", iRet));

	return iRet;
}


int initReplyFromRequest(const hash_t* hIn, hash_t* hOut)
{
        int     iRet = PD_OK;
        char    *csPtr = NULL;
	char	cPtr;

DEBUGLOG(("initReplyFromRequest ()\n"));

//msg_code
	if (GetField_CString(hIn, "process_code", &csPtr)) {
		PutField_CString(hOut, "process_code", csPtr);
DEBUGLOG(("initReplyFromRequest:: msg_code = [%s]\n", csPtr));
	}

//version
	if (GetField_CString(hIn, "version_no", &csPtr)) {
		PutField_CString(hOut, "version_no", csPtr);
DEBUGLOG(("initReplyFromRequest:: version = [%s]\n", csPtr));
	}

//enc_type
	if (GetField_Char(hIn, "enc_type", &cPtr)) {
		PutField_Char(hOut, "enc_type", cPtr);
DEBUGLOG(("initReplyFromRequest:: enc_type = [%c]\n", cPtr));
	}


DEBUGLOG(("initReplyFromRequest() Exit [%d]\n", iRet));
        return iRet;
}



int BuildAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char    *csPtr;
        char    *csData;

	char    csKey[PD_TMP_BUF_LEN +1];
	int	i = 0;
	int	iTmp;

DEBUGLOG(("BuildAuthData ()\n"));

        csData = (char*) malloc (PD_TMP_MSG_BUF_LEN+1);
	memset(csData, 0, sizeof(csData));
	csData[0] = '\0';

	if (GetField_Int(hIn, "p_list", &iTmp)) {
DEBUGLOG(("BuildAuthData List [%d]\n", iTmp));

		for (i=0; i < iTmp; i++) {
// 2 baid (array)
			sprintf(csKey, "p_list.%d.baid", i);

			if (GetField_CString(hIn, csKey, &csPtr)) {
                		strcat((char*)csData, csPtr);
DEBUGLOG(("BuildAuthData:: 2 - baid (array) = [%s]\n", csPtr));
			}

		}
	} else {

// 2 baid
		if (GetField_CString(hIn, "baid", &csPtr)) {
                	strcat((char*)csData, csPtr);
DEBUGLOG(("BuildAuthData:: 2 - baid = [%s]\n", csPtr));
	        } else {
DEBUGLOG(("BuildAuthData:: 2 - baid not exists\n"));
		}

// 8 amount
		if (GetField_CString(hIn, "txn_amt", &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildAuthData:: 8 - amount = [%s]\n", csPtr));
		} else {
DEBUGLOG(("BuildAuthData:: 8 - amount not exists\n"));
		}

// 9 currency
		if (GetField_CString(hIn, "txn_ccy", &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildAuthData:: 9 - currency = [%s]\n", csPtr));
		} else {
DEBUGLOG(("BuildAuthData:: 9 - currenty not exists\n"));
		}


// 10 to_baid
		if (GetField_CString(hIn, "to_baid", &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildAuthData:: 10 - to_baid = [%s]\n", csPtr));
		} else {
DEBUGLOG(("BuildAuthData:: 10 - to_baid not exists\n"));
		}


// 11 req_id
		if (GetField_CString(hIn, "req_ref", &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildAuthData:: 11 - ref_id = [%s]\n", csPtr));
		} else {
DEBUGLOG(("BuildAuthData:: 11 - ref_id not exists\n"));
		}

	}


// end 

        PutField_CString(hIn,"auth_data",csData);
DEBUGLOG(("BuildAuthData:: auth_data= [%s]\n",csData));
        FREE_ME(csData);

DEBUGLOG(("BuildAuthData() Exit iRet = [%d]\n", iRet));

        return iRet;
}



/*
int BuildRespAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char    *csVal;
        char    *csData;

        csData = (char*) malloc (PD_TMP_BUF_LEN * 4+1);
        csData[0] = '\0';

        if (GetField_CString(hIn,"response_code",&csVal)) {
DEBUGLOG(("BuildRespAuthData response_code = [%s]\n",csVal));
                strcat(csData,csVal);
        }

        if (GetField_CString(hIn,"merchant_ref",&csVal)) {
DEBUGLOG(("BuildRespAuthData merchant_ref = [%s]\n",csVal));
                strcat(csData,csVal);
        }
        if (GetField_CString(hIn,"merchant_id",&csVal)) {
DEBUGLOG(("BuildRespAuthData merchant_id = [%s]\n",csVal));
                strcat(csData,csVal);
        }
DEBUGLOG(("BuildRespAuthData = [%s]\n",csData));
        PutField_CString(hIn,"auth_data",csData);

DEBUGLOG(("BuildRespAuthData iRet = [%d]\n",iRet));
        FREE_ME(csData);
        return iRet;
}
*/

/*
int FormatAckMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{   
        int     iRet = PD_OK;
        char*   csBuf;
        char*   csPtr;
        char    cStatus;
        char    csTmp[PD_TMP_BUF_LEN + 1];
        double  dTmp;
        char*   csTxnSeq;
        char    csTxnSeqVal[PD_TXN_SEQ_LEN * 2 +1];
    
DEBUGLOG(("FormatAckMsg()\n"));
        outMsg[0]= '\0';
        *outLen = 0;
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );
    
    
        memset(csBuf,0,sizeof(csBuf));
        strcat((char*)csBuf,"url");
        strcat((char*)csBuf,MY_OPL_FIELD_TOKEN);


        if (GetField_CString(hIn,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("FormatAckMsg txn_seq = [%s]\n",csTxnSeq));
                sprintf(csTxnSeqVal,"txn_id=%s",csTxnSeq);
        }
        else {
DEBUGLOG(("FormatAckMsg txn_seq is missing!!!\n"));
                sprintf(csTxnSeqVal,"txn_id=");
        }

	if (GetField_Char(hIn,"ar_ind",&cStatus)) {
DEBUGLOG(("FormatAckMsg txn_status = [%c]\n",cStatus));
        }
        if (cStatus == PD_ACCEPT) {
                if (GetField_CString(hIn,"success_callback_url",&csPtr)) {
                        strcat((char*)csBuf,csPtr);
DEBUGLOG(("FormatAckMsg success_callback_url = [%s]\n",csPtr));
                }

        }
        else {
                if (GetField_CString(hIn,"failure_callback_url",&csPtr)) {
                        strcat((char*)csBuf,csPtr);
DEBUGLOG(("FormatAckMsg failure_callback_url = [%s]\n",csPtr));
                }
        }
        strcat((char*)csBuf,MY_OPL_TOKEN);
        strcat((char*)csBuf,csTxnSeqVal);
        strcat((char*)csBuf,MY_OPL_TOKEN);

        sprintf((char*)outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
        strcat((char*)outMsg,csBuf);

//process_type
        if (GetField_CString(hIn,"process_type",&csPtr)){
DEBUGLOG(("FormatAckMsg:: process_type = [%s]\n",csPtr));
                strcat((char*)outMsg,"process_type");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: process_type is missing!!!\n"));
        }

//process_code
        if (GetField_CString(hIn,"process_code",&csPtr)){
DEBUGLOG(("FormatAckMsg:: process_code = [%s]\n",csPtr));
                strcat((char*)outMsg,"process_code");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: process_code is missing!!!\n"));
        }

// status
        if (GetField_CString(hIn,"response_code",&csPtr)){
DEBUGLOG(("FormatAckMsg:: response code  = [%s]\n",csPtr));
                strcat((char*)outMsg,"status");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: response code is missing!!!\n"));
        }

//txn_seq
        if (GetField_CString(hIn,"txn_seq",&csPtr)){
DEBUGLOG(("FormatAckMsg:: txn_seq = [%s]\n",csPtr));
                strcat((char*)outMsg,"txn_id");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: txn_seq is missing!!!\n"));
        }

//txn_date
        if (GetField_CString(hIn,"local_transmission_datetime",&csPtr)){
DEBUGLOG(("FormatAckMsg:: txn_date = [%s]\n",csPtr));
                strcat((char*)outMsg,"txn_date");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: txn_date is missing!!!\n"));
        }

// txn_amt 
        if (GetField_Double(hIn,"txn_amt",&dTmp)) {
DEBUGLOG(("FormatAckMsg:: txn amt = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatAckMsg:: txn amt = [%s]\n",csTmp));
                strcat((char*)outMsg,"txn_amt");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csTmp);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: txn_amt is missing!!!\n"));
        }

// txn_ccy
        if (GetField_CString(hIn,"txn_ccy",&csPtr)){
DEBUGLOG(("FormatAckMsg:: txn_ccy = [%s]\n",csPtr));
                //strcat((char*)outMsg,"txn_ccy");
                strcat((char*)outMsg,"ccy");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: txn_ccy is missing!!!\n"));
        }

// paid_amt 
        if (GetField_Double(hIn,"net_amt",&dTmp)) {
DEBUGLOG(("FormatAckMsg:: NET AMOUNT = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatAckMsg:: AMOUNT = [%s]\n",csTmp));
                strcat((char*)outMsg,"paid_amt");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csTmp);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }

//paid_ccy
        if (GetField_CString(hIn,"net_ccy",&csPtr)){
DEBUGLOG(("FormatAckMsg:: net_ccy = [%s]\n",csPtr));
                strcat((char*)outMsg,"paid_ccy");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: net_ccy is missing!!!\n"));
        }

// service_fee 
        if (GetField_Double(hIn,"service_fee",&dTmp)) {
DEBUGLOG(("FormatAckMsg:: service_fee AMOUNT = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatAckMsg:: service_fee = [%s]\n",csTmp));
                strcat((char*)outMsg,"service_fee");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csTmp);
                strcat((char*)outMsg,MY_OPL_TOKEN);

                if (GetField_CString(hIn,"service_fee_ccy",&csPtr)) {
DEBUGLOG(("FormatAckMsg:: service_fee_ccy = [%s]\n",csPtr));
                        strcat((char*)outMsg,"service_fee_ccy");
                        strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_OPL_TOKEN);
                }
                else {
DEBUGLOG(("FormatAckMsg:: service_fee_ccy is missing!!!\n"));
                }
        } else {
		dTmp = 0.0;
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatAckMsg:: service_fee = [%s]\n",csTmp));
                strcat((char*)outMsg,"service_fee");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csTmp);
                strcat((char*)outMsg,MY_OPL_TOKEN);

                if (GetField_CString(hIn,"service_fee_ccy",&csPtr)) {
DEBUGLOG(("FormatAckMsg:: service_fee_ccy = [%s]\n",csPtr));
                        strcat((char*)outMsg,"service_fee_ccy");
                        strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_OPL_TOKEN);
                }
                else {
DEBUGLOG(("FormatAckMsg:: service_fee_ccy is missing!!!\n"));
                }

	}



//merchant_ref
        if (GetField_CString(hIn,"merchant_ref",&csPtr)){
DEBUGLOG(("FormatAckMsg:: mer_ref = [%s]\n",csPtr));
                strcat((char*)outMsg,"mer_ref");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: merchant_ref is missing!!!\n"));
        }

//mer_txn_date
        if (GetField_CString(hIn,"transmission_datetime",&csPtr)){
DEBUGLOG(("FormatAckMsg:: mer_txn_date = [%s]\n",csPtr));
                strcat((char*)outMsg,"mer_txn_date");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: mer_txn_date is missing!!!\n"));
        }


//merchant_id
        if (GetField_CString(hIn,"merchant_id",&csPtr)){
DEBUGLOG(("FormatAckMsg:: mer_id = [%s]\n",csPtr));
                strcat((char*)outMsg,"mer_id");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: merchant_id is missing!!!\n"));
        }

//encrypt_type
        if (GetField_CString(hIn,"encrypt_type",&csPtr)){
DEBUGLOG(("FormatAckMsg:: enctype = [%s]\n",csPtr));
                strcat((char*)outMsg,"enctype");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: enctype is missing!!!\n"));
        }

//sign
        if (GetField_CString(hIn,"mac",&csPtr)){
DEBUGLOG(("FormatAckMsg:: SIGN = [%s]\n",csPtr));
                strcat((char*)outMsg,"signature");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: sign is missing!!!\n"));
        }

// remark 
        if (GetField_CString(hIn,"remark",&csPtr)){
DEBUGLOG(("FormatAckMsg:: remark = [%s]\n",csPtr));
                strcat((char*)outMsg,"remark");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: remark is missing!!!\n"));
        }

	*outLen = strlen((const char*)outMsg);

        FREE_ME(csBuf);
DEBUGLOG(("FormatAckMsg:: outMsg = [%s]\n",outMsg));
DEBUGLOG(("FormatAckMsg() Exit iRet = [%d]\n",iRet));
        return  iRet;
}
*/

/*
int BuildAckAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char    *csVal;
        char    *csData;
        double  dTmp;


        csData = (char*) malloc (PD_TMP_BUF_LEN +1);
        csData[0] = '\0';

// status 
        if (GetField_CString(hIn,"response_code",&csVal)) {
DEBUGLOG(("BuildAckAuthData response_code = [%s]\n",csVal));
                strcat(csData,csVal);
        }
// txn_id
        if (GetField_CString(hIn,"txn_seq",&csVal)) {
DEBUGLOG(("BuildAckAuthData txn_seq = [%s]\n",csVal));
                strcat(csData,csVal);
        }
// txn_date 
        if (GetField_CString(hIn,"local_transmission_datetime",&csVal)) {
DEBUGLOG(("BuildAckAuthData local_transmission_datetime = [%s]\n",csVal));
                strcat(csData,csVal);
        }

// paid_ccy 
        if (GetField_CString(hIn,"net_ccy",&csVal)) {
DEBUGLOG(("BuildAckAuthData paid_ccy = [%s]\n",csVal));
                strcat(csData,csVal);
        }
// paid_amt 
        if (GetField_Double(hIn,"net_amt",&dTmp)) {
                char*   csTmp;
                csTmp = (char*) malloc (PD_TMP_BUF_LEN + 1);

DEBUGLOG(("BuildAckAuthData NET AMOUNT = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("BuildAckAuthData paid_amt = [%s]\n",csTmp));
                strcat(csData,csTmp);
                FREE_ME(csTmp);
        }

// mer_ref 
        if (GetField_CString(hIn,"merchant_ref",&csVal)) {
DEBUGLOG(("BuildAckAuthData merchant_ref = [%s]\n",csVal));
                strcat(csData,csVal);
        }

// mer_id 
        if (GetField_CString(hIn,"merchant_id",&csVal)) {
DEBUGLOG(("BuildAckAuthData merchant_id = [%s]\n",csVal));
                strcat(csData,csVal);
        }


DEBUGLOG(("BuildRespAuthData = [%s]\n",csData));
        PutField_CString(hIn,"auth_data",csData);

        FREE_ME(csData);
DEBUGLOG(("BuildRespAuthData exit = [%d]\n",iRet));
        return iRet;
}
*/
