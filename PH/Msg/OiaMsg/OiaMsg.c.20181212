/*
PDProTech (c)2018. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version (Clone from OPL)                      2018/11/12              Virginia Yun
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "OiaMsg.h"
#include "common.h"
#include "utilitys.h"
#include "b64.h"
#include "queue_defs.h"
#include "internal.h"
#include <zlib.h>
#include "ObjPtr.h"
#include "msg.h"


static char	cDebug;

OBJPTR(Msg);
OBJPTR(DB);

void	OiaMsg(char cdebug)
{
	cDebug = cdebug;
}

char *str_replace(char *orig, char *rep, char *with);

int FormatMsg(const hash_t* hIn, unsigned char *outMsg, int *outLen)
{
	int	iRet = PD_OK;
	char    *csPtr = NULL;
	char    csData[MAX_MSG_SIZE + 1];
	csData[0] = '\0';

DEBUGLOG(("FormatMsg()\n"));

	json_object *jobj = json_object_new_object();
	json_object *new_jobj = json_object_new_object();

//msg_type
	if (GetField_CString(hIn, "process_type", &csPtr)) {
		json_object_object_add(jobj, "msg_type", json_object_new_string(csPtr));
DEBUGLOG((" process_type = [%s]\n", csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG((" ***process_type is missing\n"));
	}

	if (iRet == PD_OK ) {
//msg_code
		if (GetField_CString(hIn, "msg_code", &csPtr)) {
			json_object_object_add(jobj, "msg_code", json_object_new_string(csPtr));
DEBUGLOG((" process_code = [%s]\n", csPtr));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG((" ***process_code is missing\n"));
		}
	}

	if (iRet == PD_OK ) {
//enc_type
		if (GetField_CString(hIn, "enc_type", &csPtr)) {
			json_object_object_add(jobj, "enc_type", json_object_new_string(csPtr));
DEBUGLOG((" enc_type = [%s]\n", csPtr));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG((" ***enc_type is missing\n"));
		}
	}

//version
	if (iRet == PD_OK) {
		if (GetField_CString(hIn, "version", &csPtr)) {
			json_object_object_add(jobj, "version", json_object_new_string(csPtr));
DEBUGLOG((" version = [%s]\n", csPtr));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG((" ***version is missing\n"));
		}
	}

//mac
	if (iRet == PD_OK ) {
		if (GetField_CString(hIn, "mac", &csPtr)) {
			json_object_object_add(jobj, "sign", json_object_new_string(csPtr));
DEBUGLOG((" mac = [%s]\n", csPtr));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG((" ***mac is missing\n"));
		}
	}


//info

//info:err_code
	if (iRet == PD_OK ) {
		if (GetField_CString(hIn, "response_code", &csPtr)) {
			json_object_object_add(new_jobj, "err_code", json_object_new_string(csPtr));
DEBUGLOG((" info.err_code = [%s]\n", csPtr));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG((" info.err_code is missing\n"));
		}
	}

//info:prov_name
	if (iRet == PD_OK ) {
		if (GetField_CString(hIn, "prov_name", &csPtr)) {
			json_object_object_add(new_jobj, "prov_name", json_object_new_string(csPtr));
DEBUGLOG((" info.prov_name = [%s]\n", csPtr));
		}


//info:baid
		if (GetField_CString(hIn, "baid", &csPtr)) {
			json_object_object_add(new_jobj, "baid", json_object_new_string(csPtr));
DEBUGLOG((" info.baid = [%s]\n", csPtr));
		}


//info:baid_status
		if (GetField_CString(hIn, "baid_status", &csPtr)) {
			json_object_object_add(new_jobj, "baid_status", json_object_new_string(csPtr));
DEBUGLOG((" info.baid_status = [%s]\n", csPtr));
		}


//info:bank_nature
		if (GetField_CString(hIn, "bank_nature", &csPtr)) {
			json_object_object_add(new_jobj, "bank_nature", json_object_new_string(csPtr));
DEBUGLOG((" info.bank_nature = [%s]\n", csPtr));
		}


//info:bank_name
		if (GetField_CString(hIn, "bank_name", &csPtr)) {
			json_object_object_add(new_jobj, "bank_name", json_object_new_string(csPtr));
DEBUGLOG((" info.bank_name = [%s]\n", csPtr));
		}


//info:owner_name
		if (GetField_CString(hIn, "owner_name", &csPtr)) {
			json_object_object_add(new_jobj, "owner_name", json_object_new_string(csPtr));
DEBUGLOG((" info.owner_name = [%s]\n", csPtr));
		}


//info:acct_num
		if (GetField_CString(hIn, "acct_num", &csPtr)) {
			json_object_object_add(new_jobj, "acct_num", json_object_new_string(csPtr));
DEBUGLOG((" info.acct_num = [%s]\n", csPtr));
		}


//info:acct_status
		if (GetField_CString(hIn, "acct_status", &csPtr)) {
			json_object_object_add(new_jobj, "acct_status", json_object_new_string(csPtr));
DEBUGLOG((" info.acct_status = [%s]\n", csPtr));
		}


//info:req_id
		if (GetField_CString(hIn, "req_id", &csPtr)) {
			json_object_object_add(new_jobj, "req_id", json_object_new_string(csPtr));
DEBUGLOG((" info.req_id = [%s]\n", csPtr));
		}


//info:to_baid
		if (GetField_CString(hIn, "to_baid", &csPtr)) {
			json_object_object_add(new_jobj, "to_baid", json_object_new_string(csPtr));
DEBUGLOG((" info.to_baid = [%s]\n", csPtr));
		}


//info:txn_id
		if (GetField_CString(hIn, "txn_id", &csPtr)) {
			json_object_object_add(new_jobj, "txn_id", json_object_new_string(csPtr));
DEBUGLOG((" info.txn_id = [%s]\n", csPtr));
		}


//info:to_txn_id
		if (GetField_CString(hIn, "to_txn_id", &csPtr)) {
			json_object_object_add(new_jobj, "to_txn_id", json_object_new_string(csPtr));
DEBUGLOG((" info.to_txn_id = [%s]\n", csPtr));
		}


//info:r_list
		int     iCnt = 0;
		int	iTmp = 0;

		if (GetField_Int(hIn, "r_list", &iCnt)) {
DEBUGLOG((" info.r_list = [%d]\n", iCnt));
		}
		if(iCnt > 0){
			struct json_object *jdt, *json_new_array;
			json_new_array = json_object_new_array();

			int     i, iPtr;
			char    csTag[PD_TAG_LEN + 1];
			char	*csBuf;
			csBuf = (char*) malloc (PD_TMP_BUF_LEN);

			for(i = 0; i < iCnt; i++){
				jdt = json_object_new_object();
//info:r_list.dt_err_code
				sprintf(csTag, "r_list.%d.dt_err_code", i);
				if(GetField_Int(hIn, csTag, &iPtr)){
					sprintf(csBuf, "%d", iPtr);
					json_object_object_add(jdt, "dt_err_code", json_object_new_string(csBuf));
					iTmp ++;
				}
//info:r_list.prov_name
				sprintf(csTag, "r_list.%d.prov_name", i);
				if(GetField_CString(hIn, csTag, &csPtr)){
					json_object_object_add(jdt, "prov_name", json_object_new_string(csPtr));
					iTmp ++;
				}
//info:r_list.baid
				sprintf(csTag, "r_list.%d.baid", i);
				if(GetField_CString(hIn, csTag, &csPtr)){
					json_object_object_add(jdt, "baid", json_object_new_string(csPtr));
					iTmp ++;
				}
//info:r_list.country
				sprintf(csTag, "r_list.%d.country", i);
				if(GetField_CString(hIn, csTag, &csPtr)){
					json_object_object_add(jdt, "country", json_object_new_string(csPtr));
					iTmp ++;
				}
//info:r_list.currency
				sprintf(csTag, "r_list.%d.currency", i);
				if(GetField_CString(hIn, csTag, &csPtr)){
					json_object_object_add(jdt, "currency", json_object_new_string(csPtr));
					iTmp ++;
				}
//info:r_list.baid_status
				sprintf(csTag, "r_list.%d.baid_status", i);
				if(GetField_CString(hIn, csTag, &csPtr)){
					json_object_object_add(jdt, "baid_status", json_object_new_string(csPtr));
					iTmp ++;
				}
//info:r_list.bank_nature
				sprintf(csTag, "r_list.%d.bank_nature", i);
				if(GetField_CString(hIn, csTag, &csPtr)){
					json_object_object_add(jdt, "bank_nature", json_object_new_string(csPtr));
					iTmp ++;
				}
//info:r_list.bank_name
				sprintf(csTag, "r_list.%d.bank_name", i);
				if(GetField_CString(hIn, csTag, &csPtr)){
					json_object_object_add(jdt, "bank_name", json_object_new_string(csPtr));
					iTmp ++;
				}
//info:r_list.owner_name
				sprintf(csTag, "r_list.%d.owner_name", i);
				if(GetField_CString(hIn, csTag, &csPtr)){
					json_object_object_add(jdt, "owner_name", json_object_new_string(csPtr));
					iTmp ++;
				}
//info:r_list.baid_bal
				sprintf(csTag, "r_list.%d.baid_bal", i);
				if(GetField_CString(hIn, csTag, &csPtr)){
					json_object_object_add(jdt, "baid_bal", json_object_new_string(csPtr));
					iTmp ++;
				}
//info:r_list.acct_num
				sprintf(csTag, "r_list.%d.acct_num", i);
				if(GetField_CString(hIn, csTag, &csPtr)){
					json_object_object_add(jdt, "acct_num", json_object_new_string(csPtr));
					iTmp ++;
				}
//info:r_list.acct_status
				sprintf(csTag, "r_list.%d.acct_status", i);
				if(GetField_CString(hIn, csTag, &csPtr)){
					json_object_object_add(jdt, "acct_status", json_object_new_string(csPtr));
					iTmp ++;
				}
//info:r_list.acct_bal
				sprintf(csTag, "r_list.%d.acct_bal", i);
				if(GetField_CString(hIn, csTag, &csPtr)){
					json_object_object_add(jdt, "acct_bal", json_object_new_string(csPtr));
					iTmp ++;
				}

				if(iTmp > 0) json_object_array_add(json_new_array, jdt);
			}

			json_object_object_add(new_jobj, "r_list", json_new_array);

			FREE_ME(csBuf);
		}

	}


//add sub obj to obj
	json_object_object_add(jobj, MY_API_INFO_OBJ , new_jobj);
	strcpy((char*)csData, str_replace((char*)(json_object_to_json_string_ext(jobj, JSON_C_TO_STRING_PLAIN)), "\\/", "/"));
	strcpy((char*)outMsg, csData);

	*outLen = strlen((const char*)outMsg);
DEBUGLOG(("outmsg = [%s][%d]\n", outMsg, *outLen));

	json_object_put(jobj);
DEBUGLOG(("normal return iRet = [%d]\n",iRet));
        return  iRet;
}


int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	struct	json_object *jobj;
	
	char	*csPtr;
	int     iTmp;
	//double	dPtr;

	hash_t  *hRec;

	hRec = (hash_t*)  malloc (sizeof(hash_t));
	hash_init(hRec,0);

DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));

	jobj = json_tokener_parse((const char *)inMsg);
DEBUGLOG(("BreakDownMsg parsed\n"));
	iRet = ParseJ(jobj, hRec);
DEBUGLOG(("BreakDownMsg json_parsed\n"));
        json_object_put(jobj);
DEBUGLOG(("BreakDownMsg json_put\n"));

	if (iRet == PD_OK) {
// msg_type
		if (GetField_CString(hRec, "msg_type", &csPtr)) {
			PutField_CString(hOut, "process_type", csPtr);
DEBUGLOG(("BreakDownMsg:: process_type = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: process_type not found\n"));
		}


// msg_code
		if (GetField_CString(hRec, "msg_code", &csPtr)) {
			PutField_CString(hOut, "process_code", csPtr);
DEBUGLOG(("BreakDownMsg:: process_code = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: process_code not found\n"));
		}


// version
		if (GetField_CString(hRec, "version", &csPtr)) {
			PutField_CString(hOut, "version", csPtr);
DEBUGLOG(("BreakDownMsg:: version = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: version not found\n"));
		}



// enc_type
		if (GetField_CString(hRec, "enc_type", &csPtr)) {
			PutField_CString(hOut, "enc_type", csPtr);
DEBUGLOG(("BreakDownMsg:: enc_type = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: enc_type not found\n"));
		}

// sign
		if (GetField_CString(hRec, "sign", &csPtr)) {
			PutField_CString(hOut, "mac", csPtr);
DEBUGLOG(("BreakDownMsg:: sign = [%s]\n", csPtr));
		}
		else {
DEBUGLOG(("BreakDownMsg:: sign not found\n"));
		}

// info
// info.baid
		if (GetField_CString(hRec, "baid", &csPtr)) {
			PutField_CString(hOut, "baid", csPtr);
DEBUGLOG(("BreakDownMsg:: info.baid = [%s]\n", csPtr));
		}

// info.req_id
		if (GetField_CString(hRec, "req_id", &csPtr)) {
			PutField_CString(hOut, "req_ref", csPtr);
DEBUGLOG(("BreakDownMsg:: info.req_id = [%s]\n", csPtr));
		}

// info.to_baid
		if (GetField_CString(hRec, "to_baid", &csPtr)) {
			PutField_CString(hOut, "to_baid", csPtr);
DEBUGLOG(("BreakDownMsg:: info.to_baid = [%s]\n", csPtr));
		}

// info.amount
		if (GetField_CString(hRec, "amount", &csPtr)) {
			PutField_CString(hOut, "txn_amt", csPtr);
DEBUGLOG(("BreakDownMsg:: info.amount = [%s]\n", csPtr));
		}
/*
		if (GetField_Double(hRec, "amount", &dPtr)) {
			char csTmpAmt[PD_TMP_BUF_LEN + 1];
                        sprintf((char*)csTmpAmt, "%.2f", dPtr);

			PutField_CString(hOut, "txn_amt", csTmpAmt);
DEBUGLOG(("BreakDownMsg:: info.amount = [%s]\n", csTmpAmt));
		}
*/

// info.currency
		if (GetField_CString(hRec, "currency", &csPtr)) {
			PutField_CString(hOut, "txn_ccy", csPtr);
DEBUGLOG(("BreakDownMsg:: info.currency = [%s]\n", csPtr));
		}

// info.bank_nature
		if (GetField_CString(hRec, "bank_nature", &csPtr)) {
			PutField_CString(hOut, "bank_nature", csPtr);
DEBUGLOG(("BreakDownMsg:: info.bank_nature = [%s]\n", csPtr));
		}

// info.p_list
		if (GetField_Int(hRec, "p_list", &iTmp)) {
DEBUGLOG(("BreakDownMsg:: info.p_list = [%d]\n", iTmp));
			PutField_Int(hOut, "p_list", iTmp);

//info.p_list.#.baid
			char    csKey[PD_TMP_BUF_LEN +1];	
			int 	i = 0;

			for (i= 0; i < iTmp; i++) {
				sprintf(csKey, "p_list.%d.baid", i);

				if (GetField_CString(hRec, csKey, &csPtr)) {
					PutField_CString(hOut, csKey, csPtr);
DEBUGLOG(("BreakDownMsg:: info.[%s]= [%s]\n", csKey, csPtr));

				}
			}
		}

	} 

	if (iRet == PD_OK) {
		iRet = BuildAuthData(hOut);
DEBUGLOG(("BreakDownMsg:: return from BuildAuthData = [%d]\n",iRet));
	}

        hash_destroy(hRec);
        FREE_ME(hRec);

DEBUGLOG(("BreakDownMsg Exit iRet = [%d]\n", iRet));

	return iRet;
}


int initReplyFromRequest(const hash_t* hIn, hash_t* hOut)
{
        int     iRet = PD_OK;
        char    *csPtr = NULL;

DEBUGLOG(("initReplyFromRequest ()\n"));

//msg_code
	if (GetField_CString(hIn, "process_code", &csPtr)) {
		PutField_CString(hOut, "msg_code", csPtr);
DEBUGLOG(("initReplyFromRequest:: msg_code = [%s]\n", csPtr));
	}

//version
	if (GetField_CString(hIn, "version", &csPtr)) {
		PutField_CString(hOut, "version", csPtr);
DEBUGLOG(("initReplyFromRequest:: version = [%s]\n", csPtr));
	}

//enc_type
	if (GetField_CString(hIn, "enc_type", &csPtr)) {
		PutField_CString(hOut, "enc_type", csPtr);
DEBUGLOG(("initReplyFromRequest:: enc_type = [%s]\n", csPtr));
	}

DEBUGLOG(("initReplyFromRequest() Exit [%d]\n", iRet));
        return iRet;
}



int BuildAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char    *csPtr;
        char    *csData;

	char    csKey[PD_TMP_BUF_LEN +1];
	int	i = 0;
	int	iTmp;

DEBUGLOG(("BuildAuthData ()\n"));

        csData = (char*) malloc (PD_TMP_MSG_BUF_LEN+1);
	memset(csData, 0, sizeof(csData));
	csData[0] = '\0';

	if (GetField_Int(hIn, "p_list", &iTmp)) {
DEBUGLOG(("BuildAuthData List [%d]\n", iTmp));

		for (i=0; i < iTmp; i++) {
// 2 baid (array)
			sprintf(csKey, "p_list.%d.baid", i);

			if (GetField_CString(hIn, csKey, &csPtr)) {
                		strcat((char*)csData, csPtr);
DEBUGLOG(("BuildAuthData:: 2 - baid (array) = [%s]\n", csPtr));
			}

		}
	} else {

// 2 baid
		if (GetField_CString(hIn, "baid", &csPtr)) {
                	strcat((char*)csData, csPtr);
DEBUGLOG(("BuildAuthData:: 2 - baid = [%s]\n", csPtr));
	        } else {
DEBUGLOG(("BuildAuthData:: 2 - baid not exists\n"));
		}

// 8 amount
		if (GetField_CString(hIn, "txn_amt", &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildAuthData:: 8 - amount = [%s]\n", csPtr));
		} else {
DEBUGLOG(("BuildAuthData:: 8 - amount not exists\n"));
		}

// 9 currency
		if (GetField_CString(hIn, "txn_ccy", &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildAuthData:: 9 - currency = [%s]\n", csPtr));
		} else {
DEBUGLOG(("BuildAuthData:: 9 - currenty not exists\n"));
		}


// 10 to_baid
		if (GetField_CString(hIn, "to_baid", &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildAuthData:: 10 - to_baid = [%s]\n", csPtr));
		} else {
DEBUGLOG(("BuildAuthData:: 10 - to_baid not exists\n"));
		}


// 11 req_id
		if (GetField_CString(hIn, "req_ref", &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildAuthData:: 11 - ref_id = [%s]\n", csPtr));
		} else {
DEBUGLOG(("BuildAuthData:: 11 - ref_id not exists\n"));
		}

	}


// end 

        PutField_CString(hIn,"auth_data",csData);
DEBUGLOG(("BuildAuthData:: auth_data= [%s]\n",csData));
        FREE_ME(csData);

DEBUGLOG(("BuildAuthData() Exit iRet = [%d]\n", iRet));

        return iRet;
}


int BuildRspAuthData(hash_t *hIn)
{
	int	iRet = PD_OK;
	char	*csPtr;
	char	*csData;
	char	*csBuf;

	char	csKey[PD_TMP_BUF_LEN + 1];
	int	i = 0;
	int	iTmp;
	int	iPtr;

DEBUGLOG(("BuildRspAuthData()\n"));

	csData = (char*) malloc (PD_TMP_MSG_BUF_LEN + 1);
	memset(csData, 0, sizeof(csData));
	csData[0] = '\0';

	csBuf = (char*) malloc (PD_TMP_MSG_BUF_LEN + 1);
	memset(csBuf, 0, sizeof(csBuf));
	csBuf[0] = '\0';


// 1 err_code
	if (GetField_CString(hIn, "response_code", &csPtr)) {
		strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 1 - err_code = [%s]\n", csPtr));
	} else {
DEBUGLOG(("BuildRspAuthData:: 1 - err_code not exists\n"));
	}

// 2 baid
	if (GetField_CString(hIn, "baid", &csPtr)) {
		strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 2 - baid = [%s]\n", csPtr));
	} else {
DEBUGLOG(("BuildRspAuthData:: 2 - baid not exists\n"));
	}

// 3 baid_status
	if (GetField_CString(hIn, "baid_status", &csPtr)) {
		strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 3 - baid_status = [%s]\n", csPtr));
	} else {
DEBUGLOG(("BuildRspAuthData:: 3 - baid_status not exists\n"));
	}

// 4 baid_bal
	if (GetField_CString(hIn, "baid_bal", &csPtr)) {
		strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 4 - baid_bal = [%s]\n", csPtr));
	} else {
DEBUGLOG(("BuildRspAuthData:: 4 - baid_bal not exists\n"));
	}

// 5 acct_num
	if (GetField_CString(hIn, "acct_num", &csPtr)) {
		strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 5 - acct_num = [%s]\n", csPtr));
	} else {
DEBUGLOG(("BuildRspAuthData:: 5 - acct_num not exists\n"));
	}

// 6 acct_status
	if (GetField_CString(hIn, "acct_status", &csPtr)) {
		strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 6 - acct_status = [%s]\n", csPtr));
	} else {
DEBUGLOG(("BuildRspAuthData:: 6 - acct_status not exists\n"));
	}

// 7 acct_bal
	if (GetField_CString(hIn, "acct_bal", &csPtr)) {
		strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 7 - acct_bal = [%s]\n", csPtr));
	} else {
DEBUGLOG(("BuildRspAuthData:: 7 - acct_bal not exists\n"));
	}

// 8 amount
	if (GetField_CString(hIn, "amount", &csPtr)) {
		strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 8 - amount = [%s]\n", csPtr));
	} else {
DEBUGLOG(("BuildRspAuthData:: 8 - amount not exists\n"));
	}

// 9 currency
	if (GetField_CString(hIn, "currency", &csPtr)) {
		strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 9 - currency = [%s]\n", csPtr));
	} else {
DEBUGLOG(("BuildRspAuthData:: 9 - currency not exists\n"));
	}

// 10 to_baid
	if (GetField_CString(hIn, "to_baid", &csPtr)) {
		strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 10 - to_baid = [%s]\n", csPtr));
	} else {
DEBUGLOG(("BuildRspAuthData:: 10 - to_baid not exists\n"));
	}

// 11 req_id
	if (GetField_CString(hIn, "req_id", &csPtr)) {
		strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 11 - req_id = [%s]\n", csPtr));
	} else {
DEBUGLOG(("BuildRspAuthData:: 11 - req_id not exists\n"));
	}

// 12 dt_err_code
	if (GetField_Int(hIn, "dt_err_code", &iPtr)) {
		sprintf(csBuf, "%d", iPtr);
		strcat((char*)csData, csBuf);
DEBUGLOG(("BuildRspAuthData:: 12 - dt_err_code = [%s]\n", csBuf));
	} else {
DEBUGLOG(("BuildRspAuthData:: 12 - dt_err_code not exists\n"));
	}


	if (GetField_Int(hIn, "r_list", &iTmp)) {
DEBUGLOG(("BuildRspAuthData List [%d]\n", iTmp));
	}

	for (i = 0; i < iTmp; i++) {
// 1 err_code (array)
		sprintf(csKey, "r_list.%d.err_code", i);
		if (GetField_Int(hIn, csKey, &iPtr)) {
			sprintf(csBuf, "%d", iPtr);
			strcat((char*)csData, csBuf);
DEBUGLOG(("BuildRspAuthData:: 1 - err_code (array) = [%s]\n", csBuf));
		}

// 2 baid (array)
		sprintf(csKey, "r_list.%d.baid", i);
		if (GetField_CString(hIn, csKey, &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 2 - baid (array) = [%s]\n", csPtr));
		}

// 3 baid_status (array)
		sprintf(csKey, "r_list.%d.baid_status", i);
		if (GetField_CString(hIn, csKey, &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 3 - baid_status (array) = [%s]\n", csPtr));
		}

// 4 baid_bal (array)
		sprintf(csKey, "r_list.%d.baid_bal", i);
		if (GetField_CString(hIn, csKey, &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 4 - baid_bal (array) = [%s]\n", csPtr));
		}

// 5 acct_num (array)
		sprintf(csKey, "r_list.%d.acct_num", i);
		if (GetField_CString(hIn, csKey, &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 5 - acct_num (array) = [%s]\n", csPtr));
		}

// 6 acct_status (array)
		sprintf(csKey, "r_list.%d.acct_status", i);
		if (GetField_CString(hIn, csKey, &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 6 - acct_status (array) = [%s]\n", csPtr));
		}

// 7 acct_bal (array)
		sprintf(csKey, "r_list.%d.acct_bal", i);
		if (GetField_CString(hIn, csKey, &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 7 - acct_bal (array) = [%s]\n", csPtr));
		}

// 8 amount (array)
		sprintf(csKey, "r_list.%d.amount", i);
		if (GetField_CString(hIn, csKey, &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 8 - amount (array) = [%s]\n", csPtr));
		}

// 9 currency (array)
		sprintf(csKey, "r_list.%d.currency", i);
		if (GetField_CString(hIn, csKey, &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 9 - currency (array) = [%s]\n", csPtr));
		}

// 10 to_baid (array)
		sprintf(csKey, "r_list.%d.to_baid", i);
		if (GetField_CString(hIn, csKey, &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 10 - to_baid (array) = [%s]\n", csPtr));
		}

// 11 req_id (array)
		sprintf(csKey, "r_list.%d.req_id", i);
		if (GetField_CString(hIn, csKey, &csPtr)) {
			strcat((char*)csData, csPtr);
DEBUGLOG(("BuildRspAuthData:: 11 - req_id (array) = [%s]\n", csPtr));
		}

// 12 dt_err_code (array)
		sprintf(csKey, "r_list.%d.dt_err_code", i);
		if (GetField_Int(hIn, csKey, &iPtr)) {
			sprintf(csBuf, "%d", iPtr);
			strcat((char*)csData, csBuf);
DEBUGLOG(("BuildRspAuthData:: 12 - dt_err_code (array) = [%s]\n", csBuf));
		}
	}


	PutField_CString(hIn, "auth_data", csData);
DEBUGLOG(("BuildRspAuthData:: auth_data = [%s]\n", csData));
	FREE_ME(csData);
	FREE_ME(csBuf);

DEBUGLOG(("BuildRspAuthData() Exit iRet = [%d]\n", iRet));

	return iRet;
}


/*
int FormatAckMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{   
        int     iRet = PD_OK;
        char*   csBuf;
        char*   csPtr;
        char    cStatus;
        char    csTmp[PD_TMP_BUF_LEN + 1];
        double  dTmp;
        char*   csTxnSeq;
        char    csTxnSeqVal[PD_TXN_SEQ_LEN * 2 +1];
    
DEBUGLOG(("FormatAckMsg()\n"));
        outMsg[0]= '\0';
        *outLen = 0;
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );
    
    
        memset(csBuf,0,sizeof(csBuf));
        strcat((char*)csBuf,"url");
        strcat((char*)csBuf,MY_OPL_FIELD_TOKEN);


        if (GetField_CString(hIn,"txn_seq",&csTxnSeq)) {
DEBUGLOG(("FormatAckMsg txn_seq = [%s]\n",csTxnSeq));
                sprintf(csTxnSeqVal,"txn_id=%s",csTxnSeq);
        }
        else {
DEBUGLOG(("FormatAckMsg txn_seq is missing!!!\n"));
                sprintf(csTxnSeqVal,"txn_id=");
        }

	if (GetField_Char(hIn,"ar_ind",&cStatus)) {
DEBUGLOG(("FormatAckMsg txn_status = [%c]\n",cStatus));
        }
        if (cStatus == PD_ACCEPT) {
                if (GetField_CString(hIn,"success_callback_url",&csPtr)) {
                        strcat((char*)csBuf,csPtr);
DEBUGLOG(("FormatAckMsg success_callback_url = [%s]\n",csPtr));
                }

        }
        else {
                if (GetField_CString(hIn,"failure_callback_url",&csPtr)) {
                        strcat((char*)csBuf,csPtr);
DEBUGLOG(("FormatAckMsg failure_callback_url = [%s]\n",csPtr));
                }
        }
        strcat((char*)csBuf,MY_OPL_TOKEN);
        strcat((char*)csBuf,csTxnSeqVal);
        strcat((char*)csBuf,MY_OPL_TOKEN);

        sprintf((char*)outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
        strcat((char*)outMsg,csBuf);

//process_type
        if (GetField_CString(hIn,"process_type",&csPtr)){
DEBUGLOG(("FormatAckMsg:: process_type = [%s]\n",csPtr));
                strcat((char*)outMsg,"process_type");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: process_type is missing!!!\n"));
        }

//process_code
        if (GetField_CString(hIn,"process_code",&csPtr)){
DEBUGLOG(("FormatAckMsg:: process_code = [%s]\n",csPtr));
                strcat((char*)outMsg,"process_code");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: process_code is missing!!!\n"));
        }

// status
        if (GetField_CString(hIn,"response_code",&csPtr)){
DEBUGLOG(("FormatAckMsg:: response code  = [%s]\n",csPtr));
                strcat((char*)outMsg,"status");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: response code is missing!!!\n"));
        }

//txn_seq
        if (GetField_CString(hIn,"txn_seq",&csPtr)){
DEBUGLOG(("FormatAckMsg:: txn_seq = [%s]\n",csPtr));
                strcat((char*)outMsg,"txn_id");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: txn_seq is missing!!!\n"));
        }

//txn_date
        if (GetField_CString(hIn,"local_transmission_datetime",&csPtr)){
DEBUGLOG(("FormatAckMsg:: txn_date = [%s]\n",csPtr));
                strcat((char*)outMsg,"txn_date");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: txn_date is missing!!!\n"));
        }

// txn_amt 
        if (GetField_Double(hIn,"txn_amt",&dTmp)) {
DEBUGLOG(("FormatAckMsg:: txn amt = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatAckMsg:: txn amt = [%s]\n",csTmp));
                strcat((char*)outMsg,"txn_amt");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csTmp);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: txn_amt is missing!!!\n"));
        }

// txn_ccy
        if (GetField_CString(hIn,"txn_ccy",&csPtr)){
DEBUGLOG(("FormatAckMsg:: txn_ccy = [%s]\n",csPtr));
                //strcat((char*)outMsg,"txn_ccy");
                strcat((char*)outMsg,"ccy");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: txn_ccy is missing!!!\n"));
        }

// paid_amt 
        if (GetField_Double(hIn,"net_amt",&dTmp)) {
DEBUGLOG(("FormatAckMsg:: NET AMOUNT = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatAckMsg:: AMOUNT = [%s]\n",csTmp));
                strcat((char*)outMsg,"paid_amt");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csTmp);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }

//paid_ccy
        if (GetField_CString(hIn,"net_ccy",&csPtr)){
DEBUGLOG(("FormatAckMsg:: net_ccy = [%s]\n",csPtr));
                strcat((char*)outMsg,"paid_ccy");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: net_ccy is missing!!!\n"));
        }

// service_fee 
        if (GetField_Double(hIn,"service_fee",&dTmp)) {
DEBUGLOG(("FormatAckMsg:: service_fee AMOUNT = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatAckMsg:: service_fee = [%s]\n",csTmp));
                strcat((char*)outMsg,"service_fee");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csTmp);
                strcat((char*)outMsg,MY_OPL_TOKEN);

                if (GetField_CString(hIn,"service_fee_ccy",&csPtr)) {
DEBUGLOG(("FormatAckMsg:: service_fee_ccy = [%s]\n",csPtr));
                        strcat((char*)outMsg,"service_fee_ccy");
                        strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_OPL_TOKEN);
                }
                else {
DEBUGLOG(("FormatAckMsg:: service_fee_ccy is missing!!!\n"));
                }
        } else {
		dTmp = 0.0;
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("FormatAckMsg:: service_fee = [%s]\n",csTmp));
                strcat((char*)outMsg,"service_fee");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,(char*)csTmp);
                strcat((char*)outMsg,MY_OPL_TOKEN);

                if (GetField_CString(hIn,"service_fee_ccy",&csPtr)) {
DEBUGLOG(("FormatAckMsg:: service_fee_ccy = [%s]\n",csPtr));
                        strcat((char*)outMsg,"service_fee_ccy");
                        strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                        strcat((char*)outMsg,csPtr);
                        strcat((char*)outMsg,MY_OPL_TOKEN);
                }
                else {
DEBUGLOG(("FormatAckMsg:: service_fee_ccy is missing!!!\n"));
                }

	}



//merchant_ref
        if (GetField_CString(hIn,"merchant_ref",&csPtr)){
DEBUGLOG(("FormatAckMsg:: mer_ref = [%s]\n",csPtr));
                strcat((char*)outMsg,"mer_ref");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: merchant_ref is missing!!!\n"));
        }

//mer_txn_date
        if (GetField_CString(hIn,"transmission_datetime",&csPtr)){
DEBUGLOG(("FormatAckMsg:: mer_txn_date = [%s]\n",csPtr));
                strcat((char*)outMsg,"mer_txn_date");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: mer_txn_date is missing!!!\n"));
        }


//merchant_id
        if (GetField_CString(hIn,"merchant_id",&csPtr)){
DEBUGLOG(("FormatAckMsg:: mer_id = [%s]\n",csPtr));
                strcat((char*)outMsg,"mer_id");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: merchant_id is missing!!!\n"));
        }

//encrypt_type
        if (GetField_CString(hIn,"encrypt_type",&csPtr)){
DEBUGLOG(("FormatAckMsg:: enctype = [%s]\n",csPtr));
                strcat((char*)outMsg,"enctype");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: enctype is missing!!!\n"));
        }

//sign
        if (GetField_CString(hIn,"mac",&csPtr)){
DEBUGLOG(("FormatAckMsg:: SIGN = [%s]\n",csPtr));
                strcat((char*)outMsg,"signature");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: sign is missing!!!\n"));
        }

// remark 
        if (GetField_CString(hIn,"remark",&csPtr)){
DEBUGLOG(("FormatAckMsg:: remark = [%s]\n",csPtr));
                strcat((char*)outMsg,"remark");
                strcat((char*)outMsg,MY_OPL_FIELD_TOKEN);
                strcat((char*)outMsg,csPtr);
                strcat((char*)outMsg,MY_OPL_TOKEN);
        }
        else {
DEBUGLOG(("FormatAckMsg:: remark is missing!!!\n"));
        }

	*outLen = strlen((const char*)outMsg);

        FREE_ME(csBuf);
DEBUGLOG(("FormatAckMsg:: outMsg = [%s]\n",outMsg));
DEBUGLOG(("FormatAckMsg() Exit iRet = [%d]\n",iRet));
        return  iRet;
}
*/

/*
int BuildAckAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char    *csVal;
        char    *csData;
        double  dTmp;


        csData = (char*) malloc (PD_TMP_BUF_LEN +1);
        csData[0] = '\0';

// status 
        if (GetField_CString(hIn,"response_code",&csVal)) {
DEBUGLOG(("BuildAckAuthData response_code = [%s]\n",csVal));
                strcat(csData,csVal);
        }
// txn_id
        if (GetField_CString(hIn,"txn_seq",&csVal)) {
DEBUGLOG(("BuildAckAuthData txn_seq = [%s]\n",csVal));
                strcat(csData,csVal);
        }
// txn_date 
        if (GetField_CString(hIn,"local_transmission_datetime",&csVal)) {
DEBUGLOG(("BuildAckAuthData local_transmission_datetime = [%s]\n",csVal));
                strcat(csData,csVal);
        }

// paid_ccy 
        if (GetField_CString(hIn,"net_ccy",&csVal)) {
DEBUGLOG(("BuildAckAuthData paid_ccy = [%s]\n",csVal));
                strcat(csData,csVal);
        }
// paid_amt 
        if (GetField_Double(hIn,"net_amt",&dTmp)) {
                char*   csTmp;
                csTmp = (char*) malloc (PD_TMP_BUF_LEN + 1);

DEBUGLOG(("BuildAckAuthData NET AMOUNT = [%f]\n",dTmp));
                sprintf((char*)csTmp,"%ld",double2long(dTmp));
DEBUGLOG(("BuildAckAuthData paid_amt = [%s]\n",csTmp));
                strcat(csData,csTmp);
                FREE_ME(csTmp);
        }

// mer_ref 
        if (GetField_CString(hIn,"merchant_ref",&csVal)) {
DEBUGLOG(("BuildAckAuthData merchant_ref = [%s]\n",csVal));
                strcat(csData,csVal);
        }

// mer_id 
        if (GetField_CString(hIn,"merchant_id",&csVal)) {
DEBUGLOG(("BuildAckAuthData merchant_id = [%s]\n",csVal));
                strcat(csData,csVal);
        }


DEBUGLOG(("BuildRespAuthData = [%s]\n",csData));
        PutField_CString(hIn,"auth_data",csData);

        FREE_ME(csData);
DEBUGLOG(("BuildRespAuthData exit = [%d]\n",iRet));
        return iRet;
}
*/



char *str_replace(char *orig, char *rep, char *with) {
        char *result;   // the return string
        char *ins;      // the next insert point
        char *tmp;      // varies
        int len_rep;    // length of rep (the string to remove)
        int len_with;   // length of with (the string to replace rep with)
        int len_front;  // distance between rep and end of last rep
        int count;      // number of replacements

        if (!orig || !rep)
                return NULL;
        len_rep = strlen(rep);
        if (len_rep == 0)
                return NULL; // empty rep causes infinite loop during count
        if (!with)
                with = "";
        len_with = strlen(with);

        // count the number of replacements needed
        ins = orig;
        for (count = 0; (tmp = strstr(ins, rep)); ++count) {
                ins = tmp + len_rep;
        }

        tmp = result = malloc(strlen(orig) + (len_with - len_rep) * count + 1);

        if (!result)
                return NULL;

        // first time through the loop, all the variable are set correctly
        // from here on,
        // tmp points to the end of the result string
        // ins points to the next occurrence of rep in orig
        // orig points to the remainder of orig after "end of rep"

        while (count--) {
                ins = strstr(orig, rep);
                len_front = ins - orig;
                tmp = strncpy(tmp, orig, len_front) + len_front;
                tmp = strcpy(tmp, with) + len_with;
                orig += len_front + len_rep; // move to next "end of rep"
        }
        strcpy(tmp, orig);
        return result;
}
