/*
PDProTech (c)2016. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of PDProTech.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version					   2018/05/10              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "NepMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"
#include "internal.h"
#include "ObjPtr.h"

char	cDebug;
OBJPTR(DB);

void	NepMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;
	char*   csTmp = NULL;
	char*   csPtr = NULL;
	char*   csBuf;
	double  dTmp;
	char*   csMethod = NULL;
	int	iOpt = PD_TRUE;

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

	memset(outMsg,0,sizeof(outMsg));
	if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg here\n"));
		strcat((char *)outMsg,csPtr);
		strcat((char *)outMsg,"?");

/* version */
		strcat((char*)outMsg,"version");
		strcat((char*)outMsg,MY_NEP_FIELD_TOKEN);
		strcat((char*)outMsg,MY_NEP_VERSION);
		strcat((char*)outMsg,MY_NEP_TOKEN);
DEBUGLOG(("FormatMsg:: version = [%s]\n",MY_NEP_VERSION));


/* business_id */
		if (GetField_CString(hIn,"psp_merchant_id",&csTmp)) {
			strcat((char*)outMsg,"business_id");
			strcat((char*)outMsg,MY_NEP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_NEP_TOKEN);
DEBUGLOG(("FormatMsg:: business_id = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***psp_merchant_id is missing\n"));
		}

/* order_id */
		if (GetField_CString(hIn,"txn_seq",&csTmp)) {
			strcat((char*)outMsg,"order_id");
			strcat((char*)outMsg,MY_NEP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_NEP_TOKEN);
DEBUGLOG(("FormatMsg:: order_id = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***txn_seq is missing\n"));
		}

/* amount */
		if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {
			char csTmpAmt[PD_TMP_BUF_LEN +1];
			sprintf(csTmpAmt,"%.2f",dTmp);
			//sprintf((char*)csTmpAmt,"%ld",double2long(dTmp));
			strcat((char*)outMsg,"amount");
			strcat((char*)outMsg,MY_NEP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmpAmt);
			strcat((char*)outMsg,MY_NEP_TOKEN);
DEBUGLOG(("FormatMsg:: amount = [%s]\n",csTmpAmt));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***psp_txn_amt is missing!!!\n"));
		}

/* orderDetails */
		strcat((char*)outMsg,"orderDetails");
		strcat((char*)outMsg,MY_NEP_FIELD_TOKEN);
		strcat((char*)outMsg,PD_ORDER_DETAILS);
		strcat((char*)outMsg,MY_NEP_TOKEN);
DEBUGLOG(("FormatMsg:: orderDetails = [%s]\n",PD_ORDER_DETAILS));

/* org_code */
		if (GetField_CString(hIn,"bank_code",&csTmp)) {
			DBObjPtr = CreateObj(DBPtr,"DBMobBankMap","IsMobileOption");
			iOpt = (unsigned long)(*DBObjPtr)(csTmp);
			if(iOpt==PD_FALSE && iOpt!=INT_ERR){
				strcat((char*)outMsg,"org_code");
				strcat((char*)outMsg,MY_NEP_FIELD_TOKEN);
				strcat((char*)outMsg,csTmp);
				strcat((char*)outMsg,MY_NEP_TOKEN);
DEBUGLOG(("FormatMsg:: org_code = [%s]\n",csTmp));
			}
		}
/*
		strcat((char*)outMsg,"org_code");
		strcat((char*)outMsg,MY_NEP_FIELD_TOKEN);
		strcat((char*)outMsg,"TestBank");
		strcat((char*)outMsg,MY_NEP_TOKEN);
DEBUGLOG(("FormatMsg:: org_code = [TestBank]\n"));
*/

/* sign */
		if (GetField_CString(hIn,"sign",&csTmp)) {
			strcat((char*)outMsg,"sign");
			strcat((char*)outMsg,MY_NEP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_NEP_TOKEN);
DEBUGLOG(("FormatMsg:: sign = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***sign is missing\n"));
		}

/* return_url */
		if (GetField_CString(hIn,"fe_url",&csTmp)) {
			strcat((char*)outMsg,"return_url");
                        strcat((char*)outMsg,MY_NEP_FIELD_TOKEN);
                        strcat((char*)outMsg,csTmp);
                        strcat((char*)outMsg,MY_NEP_TOKEN);
DEBUGLOG(("FormatMsg:: return_url = [%s]\n",csTmp));
                }
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***fe_url is missing\n"));
		}

/* notice_url */
		if (GetField_CString(hIn,"return_url_only",&csTmp)) {
			strcat((char*)outMsg,"notice_url");
			strcat((char*)outMsg,MY_NEP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_NEP_TOKEN);
DEBUGLOG(("FormatMsg:: notice_url = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** return_url_only is missing\n"));
		}

/* url_method */
		if (GetField_CString(hIn,"url_method",&csMethod)) {
DEBUGLOG(("FormatMsg:: url_method = [%s]\n",csMethod));
		}
		else 
			csMethod = strdup("");

DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
		base64_encode(outMsg,strlen((char *)outMsg),csBuf,PD_MAX_BUFFER);
DEBUGLOG(("FormatMsg:: after encode\n"));
                outMsg[0] = '\0';
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
                strcat((char*)outMsg,MY_NEP_TOKEN);
		strcat((char*)outMsg,"url_method");
		strcat((char*)outMsg,"=");
		strcat((char*)outMsg,csMethod);
                strcat((char*)outMsg,MY_NEP_TOKEN);
		strcat((char*)outMsg,"ret_status=0");
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));

		*outLen = strlen((const char*)outMsg);
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: Redirct url not found\n"));
	}


DEBUGLOG(("FormatMsg:: normal exit iret =[%d]\n",iRet));
	FREE_ME(csBuf);
	return 	iRet;
}

int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csPtr;
	hash_t  *hRec;

        hRec = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hRec,0);

DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));

	if (Str2Cls(hRec,(char *)inMsg,MY_NEP_TOKEN, MY_NEP_FIELD_TOKEN) == PD_OK) {

/* order_id */
		if (GetField_CString(hRec,"order_id",&csPtr)) {
			PutField_CString(hOut,"txn_seq",csPtr);
DEBUGLOG(("BreakDownMsg:: txn_seq = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: order_id not found\n"));
		}

/* stateCode */
		if (GetField_CString(hRec,"stateCode",&csPtr)) {
			PutField_CString(hOut,"status",csPtr);
DEBUGLOG(("BreakDownMsg:: status = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: stateCode not found\n"));
		}

/* amount */
		if (GetField_CString(hRec,"amount",&csPtr)) {
			PutField_CString(hOut,"txn_amt",csPtr);
DEBUGLOG(("BreakDownMsg:: txn_amt = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: amount not found\n"));
		}

/* order_no */
		if (GetField_CString(hRec,"order_no",&csPtr)) {
			PutField_CString(hOut,"tid",csPtr);
DEBUGLOG(("BreakDownMsg:: tid = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: order_no not found\n"));
		}

/* business_id */
		if (GetField_CString(hRec,"business_id",&csPtr)) {
			PutField_CString(hOut,"business_id",csPtr);
DEBUGLOG(("BreakDownMsg:: business_id = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: business_id not found\n"));
		}

/* sign */
                if (GetField_CString(hRec,"sign",&csPtr)) {
                        PutField_CString(hOut,"sign",csPtr);
DEBUGLOG(("BreakDownMsg:: sign = [%s]\n",csPtr));
                }
                else{
DEBUGLOG(("BreakDownMsg:: sign not found\n"));
                }
	}
	else {
DEBUGLOG(("BreakDownMsg() Error\n"));
                iRet = PD_ERR;
        }
        
        hash_destroy(hRec);
	FREE_ME(hRec);

DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	return iRet;
}

int BuildAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr;
        char*   csBuf;
	double	dTmp;
	//int	iOpt = PD_TRUE;
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildAuthData()\n"));
	memset(csBuf,0,MAX_MSG_SIZE);
	csBuf[0] = '\0';
	

/* business_id */
	if (GetField_CString(hIn,"psp_merchant_id",&csPtr)) {
		strcat((char*)csBuf,"business_id");
		strcat((char*)csBuf,MY_NEP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_NEP_TOKEN);
DEBUGLOG(("BuildAuthData:: business_id = [%s]\n",csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: ***psp_merchant_id is missing\n"));
	}

/* order_id */
	if (GetField_CString(hIn,"txn_seq",&csPtr)) {
		strcat((char*)csBuf,"order_id");
		strcat((char*)csBuf,MY_NEP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_NEP_TOKEN);
DEBUGLOG(("BuildAuthData:: order_id = [%s]\n",csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: ***txn_seq is missing\n"));
	}

/* amount */
	if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {
		char csTmpAmt[PD_TMP_BUF_LEN +1];
		sprintf(csTmpAmt,"%.2f",dTmp);
		//sprintf((char*)csTmpAmt,"%ld",double2long(dTmp));
		
		strcat((char*)csBuf,"amount");
		strcat((char*)csBuf,MY_NEP_FIELD_TOKEN);
		strcat((char*)csBuf,csTmpAmt);
		strcat((char*)csBuf,MY_NEP_TOKEN);
DEBUGLOG(("BuildAuthData:: amount = [%s]\n",csTmpAmt));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: ***psp_txn_amt is missing!!!\n"));
	}


	PutField_CString(hIn,"auth_data",csBuf);
DEBUGLOG(("BuildAuthData:: auth_data = [%s]\n",csBuf));
	FREE_ME(csBuf);
        
DEBUGLOG(("BuildAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

int BuildRspAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr;
        char*   csBuf;
	char	csTag[PD_TAG_LEN +1];
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildRspAuthData()\n"));
	memset(csBuf,0,MAX_MSG_SIZE);
	csBuf[0] = '\0';

/* order_id */
	strcpy(csTag,"txn_seq");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
	}
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}

/* stateCode */
	strcpy(csTag,"status");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
	}
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}

/* amount */
	strcpy(csTag,"txn_amt");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
	}
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}

/* order_no */
	strcpy(csTag,"tid");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
	}
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}

/* business_id */
	strcpy(csTag,"business_id");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
	}
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}

	PutField_CString(hIn,"auth_data",csBuf);
DEBUGLOG(("BuildRspAuthData:: auth_data = [%s]\n",csBuf));
	FREE_ME(csBuf);
        
DEBUGLOG(("BuildRspAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

