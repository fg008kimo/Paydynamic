/*
Partnerdelight (c)2010. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version					   20110110                LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "ESkyMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"

char	cDebug;

void	ESkyMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;
	char*   csTmp = NULL;
	char*   csPtr = NULL;
	char*   csBuf;
	double  dTmp;
	char*   csMethod = NULL;

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

	memset(outMsg,0,sizeof(outMsg));
	if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg here\n"));
		strcat(outMsg,csPtr);
		strcat(outMsg,"?");
		if (GetField_CString(hIn,"fe_url",&csTmp)) {
			strcat((char*)outMsg,"e_url");
			strcat((char*)outMsg,MY_ESKY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ESKY_TOKEN);
DEBUGLOG(("FormatMsg:: e_url = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** fe_url is missing\n"));
		}
		if (GetField_CString(hIn,"return_url_only",&csTmp)) {
			strcat((char*)outMsg,"e_backend_url");
			strcat((char*)outMsg,MY_ESKY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ESKY_TOKEN);
DEBUGLOG(("FormatMsg:: e_backend_url = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** return_url_only is missing\n"));
		}

		if (GetField_CString(hIn,"txn_seq",&csTmp)) {
			strcat((char*)outMsg,"e_oderno");
			strcat((char*)outMsg,MY_ESKY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ESKY_TOKEN);
DEBUGLOG(("FormatMsg:: e_oderno = [%s]\n",csTmp));
		}
		if (GetField_CString(hIn,"psp_merchant_id",&csTmp)) {
			strcat((char*)outMsg,"e_no");
			strcat((char*)outMsg,MY_ESKY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ESKY_TOKEN);
DEBUGLOG(("FormatMsg:: e_no = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***psp_merchant_id is missing\n"));
		}
		if (GetField_CString(hIn,"bank_code",&csTmp)) {
			strcat((char*)outMsg,"e_Bankco");
			strcat((char*)outMsg,MY_ESKY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ESKY_TOKEN);
DEBUGLOG(("FormatMsg:: e_Bankco = [%s]\n",csTmp));
		}
/* hard code  - requested by esky */
		strcat((char*)outMsg,"e_storename");
		strcat((char*)outMsg,MY_ESKY_FIELD_TOKEN);
		strcat((char*)outMsg,MY_ESKY_TOKEN);
/* psp txn ccy */
		if (GetField_CString(hIn,"psp_txn_ccy",&csTmp)) {
			char*   csCcyId = NULL;
			if(strncmp(csTmp,"CNY",PD_CCY_ID_LEN)==0)
				csCcyId = strdup("RMB");
			else if(strncmp(csTmp,"TWD",PD_CCY_ID_LEN)==0)
				csCcyId = strdup("NTD");
			else
				csCcyId = strdup(csTmp);
			strcat((char*)outMsg,"e_Currency_Type");
			strcat((char*)outMsg,MY_ESKY_FIELD_TOKEN);
			strcat((char*)outMsg,csCcyId);
			strcat((char*)outMsg,MY_ESKY_TOKEN);
DEBUGLOG(("FormatMsg:: e_Currency_Type = [%s]\n",csCcyId));
			FREE_ME(csCcyId);
		}

/* gateway type */
		if (GetField_CString(hIn,"gateway_type",&csTmp)) {
			strcat((char*)outMsg,"e_Gateway_Type");
			strcat((char*)outMsg,MY_ESKY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ESKY_TOKEN);
DEBUGLOG(("FormatMsg:: e_Gateway_Type = [%s]\n",csTmp));
		}
		else{
			strcat((char*)outMsg,"e_Gateway_Type");
DEBUGLOG(("FormatMsg:: Defualt Gateway Type[01]\n"));
			strcat((char*)outMsg,MY_ESKY_FIELD_TOKEN);
			strcat((char*)outMsg,"01");
			strcat((char*)outMsg,MY_ESKY_TOKEN);
		}
/* language */
		if (GetField_CString(hIn,"language",&csTmp)) {
			strcat((char*)outMsg,"e_Lang");
			strcat((char*)outMsg,MY_ESKY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ESKY_TOKEN);
DEBUGLOG(("FormatMsg:: e_Lang = [%s]\n",csTmp));
		}
/* txn amt */
		if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {

			char    csTmpAmt[PD_TMP_BUF_LEN +1];
			sprintf(csTmpAmt,"%.2f",dTmp);
			strcat((char*)outMsg,"e_money");
			strcat((char*)outMsg,MY_ESKY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmpAmt);
			strcat((char*)outMsg,MY_ESKY_TOKEN);
DEBUGLOG(("FormatMsg:: e_money = [%s]\n",csTmpAmt));
		}
		else {
DEBUGLOG(("FormatMsg:: psp_txn_amt is missing!!!\n"));
		}

/* sign */
		if (GetField_CString(hIn,"sign",&csTmp)) {
			strcat((char*)outMsg,"str_check");
			strcat((char*)outMsg,MY_ESKY_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ESKY_TOKEN);
DEBUGLOG(("FormatMsg:: str_check = [%s]\n",csTmp));
		}

/* url_method */
		if (GetField_CString(hIn,"url_method",&csMethod)) {
DEBUGLOG(("FormatMsg:: url_method = [%s]\n",csMethod));
		}
		else 
			csMethod = strdup("");

DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
		base64_encode(outMsg,strlen(outMsg),csBuf,PD_MAX_BUFFER);
DEBUGLOG(("FormatMsg:: after encode\n"));
                outMsg[0] = '\0';
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
                strcat((char*)outMsg,MY_ESKY_TOKEN);
		strcat((char*)outMsg,"url_method");
		strcat((char*)outMsg,"=");
		strcat((char*)outMsg,csMethod);
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));

		*outLen = strlen((const char*)outMsg);
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: Redirct url not found\n"));
	}


DEBUGLOG(("FormatMsg:: normal exit iret =[%d]\n",iRet));
	FREE_ME(csBuf);
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csBuf;
	char	*p;
	double   dTmp;
	char	csDateTime[PD_DATETIME_LEN +1];
	char    csTmp[PD_MAX_BUFFER + 1];

	csBuf = (char*) malloc (1024 +1);

	memcpy(csBuf,inMsg,inLen);
	csBuf[inLen] = '\0';
DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s]\n",inMsg));

	
/* str_ok */
	p = GetField(csBuf,"str_ok",MY_ESKY_TOKEN,MY_ESKY_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"status",p);
		if(strncmp(p,"1",1)){
			PutField_CString(hOut,"error_code",p);
		}
DEBUGLOG(("BreakDownMsg:: status = [%s]\n",p));
	}
/* str_no */
	p = GetField(csBuf,"str_no",MY_ESKY_TOKEN,MY_ESKY_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"tid",p);
DEBUGLOG(("BreakDownMsg:: tid = [%s]\n",p));
	}
/* e_ntmoney */
	p = GetField(csBuf,"e_ntmoney",MY_ESKY_TOKEN,MY_ESKY_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"e_ntmoney",p);
DEBUGLOG(("BreakDownMsg:: e_ntmoney = [%s]\n",p));
	}
/* e_rate */
	p = GetField(csBuf,"e_rate",MY_ESKY_TOKEN,MY_ESKY_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"rate",p);
DEBUGLOG(("BreakDownMsg:: rate = [%s]\n",p));
	}
/* e_money */
	p = GetField(csBuf,"e_money",MY_ESKY_TOKEN,MY_ESKY_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"txn_amt",p);
DEBUGLOG(("BreakDownMsg:: txn_amt = [%s]\n",p));
	}
/* e_oderno */
	p = GetField(csBuf,"e_oderno",MY_ESKY_TOKEN,MY_ESKY_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"txn_seq",p);
DEBUGLOG(("BreakDownMsg:: txn_seq = [%s]\n",p));
	}
/* e_no */
	p = GetField(csBuf,"e_no",MY_ESKY_TOKEN,MY_ESKY_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"psp_merchant_id",p);
DEBUGLOG(("BreakDownMsg:: psp_merchant_id = [%s]\n",p));
	}
/* e_date */
	p = GetField(csBuf,"e_date",MY_ESKY_TOKEN,MY_ESKY_FIELD_TOKEN);
	if (p) {
		strcpy(csTmp,TrimAll(p,strlen(p)));
		PutField_CString(hOut,"txn_date",csTmp);
		PutField_CString(hOut,"tm_date",csTmp);
		strcpy(csDateTime,csTmp);
DEBUGLOG(("BreakDownMsg:: txn_date[tm_date] = [%s]\n",csTmp));
	}

/* e_time */
	p = GetField(csBuf,"e_time",MY_ESKY_TOKEN,MY_ESKY_FIELD_TOKEN);
	if (p) {
		strcpy(csTmp,TrimAll(p,strlen(p)));
DEBUGLOG(("BreakDownMsg:: time = [%s]\n",csTmp));
		char* pPtr;
		pPtr = strdup(deleteCharacters(csTmp,":"));
		PutField_CString(hOut,"tm_time",pPtr);
DEBUGLOG(("BreakDownMsg:: time = [%s]\n",pPtr));
		FREE_ME(pPtr);
	}

/* service_fee */
	p = GetField(csBuf,"e_outlay",MY_ESKY_TOKEN,MY_ESKY_FIELD_TOKEN);
	if(p){
		sscanf(p,"%lf",&dTmp);
		PutField_Double(hOut,"service_fee",dTmp);
DEBUGLOG(("BreakDownMsg:: service_fee = [%lf]\n",dTmp));

	}


/* str_check */
	p = GetField(csBuf,"str_check",MY_ESKY_TOKEN,MY_ESKY_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"sign",p);
DEBUGLOG(("BreakDownMsg:: sign = [%s]\n",p));
	}
	else{
                PutField_CString(hOut,"sign"," ");
DEBUGLOG(("BreakDownMsg:: sign = [%s]\n"," "));
        }

/* str_msg */
	p = GetField(csBuf,"str_msg",MY_ESKY_TOKEN,MY_ESKY_FIELD_TOKEN);
	if (p) {
		PutField_CString(hOut,"error_msg",p);
DEBUGLOG(("BreakDownMsg:: error_msg = [%s]\n",p));
	}

	FREE_ME(csBuf);
DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	return iRet;
}


