/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version					   2013/12/09              LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "PftMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"
#include "internal.h"

char	cDebug;

void	PftMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;
	char*   csTmp = NULL;
	char*   csPtr = NULL;
	char*   csBuf;
	double  dTmp;
	char*   csMethod = NULL;

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

	memset(outMsg,0,sizeof(outMsg));
	if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg here\n"));
		strcat((char *)outMsg,csPtr);
		strcat((char *)outMsg,"?");

/* 1 mid*/
		if (GetField_CString(hIn,"psp_merchant_id",&csTmp)) {
			strcat((char*)outMsg,"mid");
			strcat((char*)outMsg,MY_PFT_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_PFT_TOKEN);
DEBUGLOG(("FormatMsg:: mid = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***psp_merchant_id is missing\n"));
		}

/* 2 ordersn*/

		if (GetField_CString(hIn,"txn_seq",&csTmp)) {
			strcat((char*)outMsg,"ordersn");
			strcat((char*)outMsg,MY_PFT_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_PFT_TOKEN);
DEBUGLOG(("FormatMsg:: ordersn = [%s]\n",csTmp));
		}

/* 3 bank_no */
		if (GetField_CString(hIn,"bank_code",&csTmp)) {
			strcat((char*)outMsg,"bank_no");
			strcat((char*)outMsg,MY_PFT_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_PFT_TOKEN);
DEBUGLOG(("FormatMsg:: bank_no = [%s]\n",csTmp));
		}

/* 4 currency */
		strcat((char*)outMsg,"currency");
		strcat((char*)outMsg,MY_PFT_FIELD_TOKEN);
		strcat((char*)outMsg,"RMB");  //default RMB
		strcat((char*)outMsg,MY_PFT_TOKEN);
DEBUGLOG(("FormatMsg:: currency = [RMB] (default)\n"));

/* 5 amount */
		if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {

			char    csTmpAmt[PD_TMP_BUF_LEN +1];
			sprintf(csTmpAmt,"%.2f",dTmp);
			strcat((char*)outMsg,"amount");
			strcat((char*)outMsg,MY_PFT_FIELD_TOKEN);
			strcat((char*)outMsg,csTmpAmt);
			strcat((char*)outMsg,MY_PFT_TOKEN);
DEBUGLOG(("FormatMsg:: amount = [%s]\n",csTmpAmt));
		}
		else {
DEBUGLOG(("FormatMsg:: psp_txn_amt is missing!!!\n"));
		}

/* 6 law_name */
/* 7 telno*/
/* 8 card_number*/

/* 9 return_url*/
		if (GetField_CString(hIn,"return_url_only",&csTmp)) {
			strcat((char*)outMsg,"return_url");
			strcat((char*)outMsg,MY_PFT_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_PFT_TOKEN);
DEBUGLOG(("FormatMsg:: return_url = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** return_url_only is missing\n"));
		}

/* 10 backend_url*/

/* 11 hash_check */
		if (GetField_CString(hIn,"sign",&csTmp)) {
			strcat((char*)outMsg,"hash_check");
			strcat((char*)outMsg,MY_PFT_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_PFT_TOKEN);
DEBUGLOG(("FormatMsg:: hash_check = [%s]\n",csTmp));
		}


DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
		base64_encode(outMsg,strlen((char *)outMsg),csBuf,PD_MAX_BUFFER);
DEBUGLOG(("FormatMsg:: after encode\n"));
                outMsg[0] = '\0';
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
                strcat((char*)outMsg,MY_PFT_TOKEN);
		strcat((char*)outMsg,"url_method");
		strcat((char*)outMsg,"=");
		strcat((char*)outMsg,csMethod);
                strcat((char*)outMsg,MY_PFT_TOKEN);
		strcat((char*)outMsg,"ret_status=0");
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));

		*outLen = strlen((const char*)outMsg);
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: Redirct url not found\n"));
	}


DEBUGLOG(("FormatMsg:: normal exit iret =[%d]\n",iRet));
	FREE_ME(csBuf);
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csPtr;
	hash_t  *hRec;

        hRec = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hRec,0);

DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));

	if (Str2Cls(hRec,(char *)inMsg,MY_PFT_TOKEN, MY_PFT_FIELD_TOKEN) == PD_OK) {

/* 1 res_code*/
		if (GetField_CString(hRec,"res_code",&csPtr)) {
			PutField_CString(hOut,"status",csPtr);
DEBUGLOG(("BreakDownMsg:: status = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: status not found\n"));
		}

/* 2 payment_no */
		if (GetField_CString(hRec,"payment_no",&csPtr)) {
			PutField_CString(hOut,"tid",csPtr);
DEBUGLOG(("BreakDownMsg:: tid = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: tid not found\n"));
		}
/* 3 amount */
		if (GetField_CString(hRec,"amount",&csPtr)) {
			PutField_CString(hOut,"txn_amt",csPtr);
DEBUGLOG(("BreakDownMsg:: txn_amt = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: txn_amt not found\n"));
		}
/* 4 currency */
		if (GetField_CString(hRec,"currency",&csPtr)) {
			PutField_CString(hOut,"currency",csPtr);
DEBUGLOG(("BreakDownMsg:: currency = [%s]\n",csPtr));
                }

/* 5 ordersn */
		if (GetField_CString(hRec,"ordersn",&csPtr)) {
			PutField_CString(hOut,"txn_seq",csPtr);
DEBUGLOG(("BreakDownMsg:: txn_seq = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: txn_seq not found\n"));
		}
/* 6 mid */
		if (GetField_CString(hRec,"mid",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: merchant_id = [%s]\n",csPtr));
			PutField_CString(hOut,"merchant_id",csPtr);
		}
/* 7 res_date */
		if (GetField_CString(hRec,"res_date",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: txn_date = [%s]\n",csPtr));
			if (strlen(csPtr) > 17) {
                                csPtr[17] = '\0';
                        }
                        PutField_CString(hOut,"res_date",csPtr);
                        char csFundinDate[PD_DATETIME_LEN +1];
                        char csTxnDate[PD_DATE_LEN +1];

			sprintf(csTxnDate,"%.*s",PD_DATE_LEN,csPtr);

                        sprintf(csFundinDate,"%.*s%.*s%.*s%.*s",PD_DATE_LEN,csPtr,2,&csPtr[PD_DATE_LEN+1],2,&csPtr[PD_DATE_LEN+4],2,&csPtr[PD_DATE_LEN +7]);

			PutField_CString(hOut,"fundin_date",csFundinDate);
			PutField_CString(hOut,"txn_date",csTxnDate);
		}

/* 8 res_msg*/
		if (GetField_CString(hRec,"res_msg",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: res_msg = [%s]\n",csPtr));
                        PutField_CString(hOut,"res_msg",csPtr);
                }
		
/* 9 res_bmsg*/
		if (GetField_CString(hRec,"res_bmsg",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: res_bmsg = [%s]\n",csPtr));
                        PutField_CString(hOut,"res_bmsg",csPtr);
                }

/*10 hash_check*/
                if (GetField_CString(hRec,"hash_check",&csPtr)) {
                        PutField_CString(hOut,"sign",csPtr);
DEBUGLOG(("BreakDownMsg:: sign = [%s]\n",csPtr));
                }
                else{
DEBUGLOG(("BreakDownMsg:: sign not found\n"));
                }


	}
	else {
DEBUGLOG(("BreakDownMsg() Error\n"));
                iRet = PD_ERR;
        }
        
        hash_destroy(hRec);
	FREE_ME(hRec);

DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	return iRet;
}


int BuildAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr;
        char*   csBuf;
	double	dTmp;
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildAuthData()\n"));
	memset(csBuf,0,MAX_MSG_SIZE);
	csBuf[0] = '\0';
	

/* 1 ordersn*/

	if (GetField_CString(hIn,"txn_seq",&csPtr)) {
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildAuthData:: ordersn = [%s]\n",csPtr));
	}


/* 2 mid */
	if (GetField_CString(hIn,"psp_merchant_id",&csPtr)) {
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildAuthData:: mid = [%s]\n",csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: ***psp_merchant_id is missing\n"));
	}

/* 3 amount */
	if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {

		char    csTmpAmt[PD_TMP_BUF_LEN +1];
		sprintf(csTmpAmt,"%.2f",dTmp);
		strcat((char*)csBuf,csTmpAmt);
DEBUGLOG(("BuildAuthData:: amount = [%s]\n",csTmpAmt));
	}
	else {
DEBUGLOG(("BuildAuthData:: psp_txn_amt is missing!!!\n"));
	}



	PutField_CString(hIn,"auth_data",csBuf);
DEBUGLOG(("BuildAuthData:: auth_data = [%s]\n",csBuf));
	FREE_ME(csBuf);
        
DEBUGLOG(("BuildAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

int BuildRspAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr;
        char*   csBuf;
	char	csTag[PD_TAG_LEN +1];
	double	dTmp=0.0;
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildRspAuthData()\n"));
	memset(csBuf,0,MAX_MSG_SIZE);
	csBuf[0] = '\0';
	

/* 1 res_code*/
	strcpy(csTag,"status");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
	}
	else {
		iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}

/* 2 ordersn*/

	if (GetField_CString(hIn,"txn_seq",&csPtr)) {
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: ordersn = [%s]\n",csPtr));
	}


/* 3 mid */
	if (GetField_CString(hIn,"psp_merchant_id",&csPtr)) {
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: mid = [%s]\n",csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildRspAuthData:: ***psp_merchant_id is missing\n"));
	}

/* 4 amount */
	if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {

		char    csTmpAmt[PD_TMP_BUF_LEN +1];
		sprintf(csTmpAmt,"%.2f",dTmp);
		strcat((char*)csBuf,csTmpAmt);
DEBUGLOG(("BuildRspAuthData:: amount = [%s]\n",csTmpAmt));
	}
	else {
DEBUGLOG(("BuildRspAuthData:: psp_txn_amt is missing!!!\n"));
	}

/* 5 payment_no */
	if (GetField_CString(hIn,"tid",&csPtr)) {
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: payment_no = [%s]\n",csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildRspAuthData:: ***tid is missing\n"));
	}


	PutField_CString(hIn,"auth_data",csBuf);
DEBUGLOG(("BuildRspAuthData:: auth_data = [%s]\n",csBuf));
	FREE_ME(csBuf);
        
DEBUGLOG(("BuildRspAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}
