/*
Partnerdelight (c)2012. All rights reserved. No part of this software may be reproduced in any form without written permission
of an authorized representative of Partnerdelight.

Change Description                                 Change Date             Change By
-------------------------------                    ------------            --------------
Init Version					   2012/02/15              Cody Chan
Add Mobile Payment				   2013/05/20		   Cody Chan
Change the mobile payment code 10->33 (in .h)	   2016/08/29		   LokMan Chow
Support EC (**this change only in DEV)		   2016/09/20		   LokMan Chow
Change the mobile payment code 33->10 (in .h)	   2016/10/19		   LokMan Chow
Add card_type                                      2016/11/11              LokMan Chow
fallback card_type				   2016/12/08		   LokMan Chow
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "AlpMsg.h"
#include "common.h"
#include "utilitys.h"
#include "queue_defs.h"
#include <zlib.h>
#include "b64.h"
#include "internal.h"

char	cDebug;

void	AlpMsg(char cdebug)
{
	cDebug = cdebug;
}

int FormatMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;
	char*   csTmp = NULL;
	char*   csPtr = NULL;
        char*   csPayType = NULL;
	char*   csBuf;
	double  dTmp;
	char*   csMethod = NULL;

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

	memset(outMsg,0,sizeof(outMsg));
	if (GetField_CString(hIn,"redirect_url",&csPtr)) {
DEBUGLOG(("FormatMsg here\n"));
		strcat((char *)outMsg,csPtr);
		strcat((char *)outMsg,"?");

/* 1 inputCharset */
		strcat((char*)outMsg,"inputCharset");
		strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
		//strcat((char*)outMsg,"3"); //GB2312
		strcat((char*)outMsg,"1"); //UTF-8
		strcat((char*)outMsg,MY_ALP_TOKEN);

/* 2 pickupUrl */
		//if (GetField_CString(hIn,"fe_url",&csTmp)) {
		if (GetField_CString(hIn,"return_url_only",&csTmp)) {
			strcat((char*)outMsg,"pickupUrl");
			strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,"fe/");
			strcat((char*)outMsg,MY_ALP_TOKEN);
DEBUGLOG(("FormatMsg:: pickupUrl = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** fe_url is missing\n"));
		}
/* 3 receiveUrl */
		if (GetField_CString(hIn,"return_url_only",&csTmp)) {
			strcat((char*)outMsg,"receiveUrl");
			strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ALP_TOKEN);
DEBUGLOG(("FormatMsg:: receiveUrl = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: *** return_url_only is missing\n"));
		}

/* 4 version */
		strcat((char*)outMsg,"version");
		strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
		strcat((char*)outMsg,"v1.0"); 
		strcat((char*)outMsg,MY_ALP_TOKEN);
/* 5 language */
		strcat((char*)outMsg,"language");
		strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
		strcat((char*)outMsg,"1");  //Chinese
		strcat((char*)outMsg,MY_ALP_TOKEN);
/* 6 signType */
		strcat((char*)outMsg,"signType");
		strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
		strcat((char*)outMsg,"1");  //signed by ssl cert
		strcat((char*)outMsg,MY_ALP_TOKEN);
		

/* 7 merchantId */
		if (GetField_CString(hIn,"psp_merchant_id",&csTmp)) {
			strcat((char*)outMsg,"merchantId");
			strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ALP_TOKEN);
DEBUGLOG(("FormatMsg:: merchantId = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***psp_merchant_id is missing\n"));
		}

/* 13 orderNo */

		if (GetField_CString(hIn,"txn_seq",&csTmp)) {
			strcat((char*)outMsg,"orderNo");
			strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ALP_TOKEN);
DEBUGLOG(("FormatMsg:: orderNo = [%s]\n",csTmp));
		}

/* 14 orderAmount */
		if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {

			char    csTmpAmt[PD_TMP_BUF_LEN +1];
			sprintf(csTmpAmt,"%ld",(long)(((dTmp*200)+1)/2));
			strcat((char*)outMsg,"orderAmount");
			strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmpAmt);
			strcat((char*)outMsg,MY_ALP_TOKEN);
DEBUGLOG(("FormatMsg:: orderAmount = [%s]\n",csTmpAmt));
		}
		else {
DEBUGLOG(("FormatMsg:: psp_txn_amt is missing!!!\n"));
		}

/* 15 orderCurrency */
		strcat((char*)outMsg,"orderCurrency");
		strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
		strcat((char*)outMsg,"0");  //default RMB
		strcat((char*)outMsg,MY_ALP_TOKEN);
/* 16 orderDatetime */
	        if (GetField_CString(hIn,"local_tm_date",&csPtr)) {
DEBUGLOG(("FormatMsg:: local_tm_date = [%s]\n",csPtr));
                	char*   csPtr2;
                	char    csDateTime[PD_DATETIME_LEN * 2];
                	if (GetField_CString(hIn,"local_tm_time",&csPtr2)) {
DEBUGLOG(("FormatMsg:: local_tm_time = [%s]\n",csPtr2));
                        	sprintf(csDateTime,"%s%s",csPtr,csPtr2);
DEBUGLOG(("FormatMsg:: orderDatetime = [%s]\n",csDateTime));
                        	strcat((char*)outMsg,"orderDatetime");
                        	strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
                        	strcat((char*)outMsg,csDateTime);
                        	strcat((char*)outMsg,MY_ALP_TOKEN);
                	}
                	else {
DEBUGLOG(("FormatMsg:: local_tm_time is missing!!!\n"));
                	}
        	}
        	else {
DEBUGLOG(("FormatMsg:: local_tm_date is missing!!!\n"));
        	}
/* 25 payType */
		if (GetField_CString(hIn,"selected_pay_method",&csPayType)) {
DEBUGLOG(("FormatMsg:: selected pay method = [%s]\n",csPayType));
			strcat((char*)outMsg,"payType");
			strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
			if (!strcmp(csPayType,PD_BANKCARD)) {
				strcat((char*)outMsg,MY_ALP_BANKCARD);  //personal netbacking
			}
			else if (!strcmp(csPayType,PD_MOBILE_PAYMENT)) {
				strcat((char*)outMsg,MY_ALP_MOBILE);  //mobile
			}
			strcat((char*)outMsg,MY_ALP_TOKEN);
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: ***selected_pay_method is missing\n"));
		}

/* 26 issueId */
		if (GetField_CString(hIn,"bank_code",&csTmp)) {
			if(strcmp(csTmp,PD_EC_BANK_CODE)){
				strcat((char*)outMsg,"issuerId");
				strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
				strcat((char*)outMsg,csTmp);
				strcat((char*)outMsg,MY_ALP_TOKEN);
DEBUGLOG(("FormatMsg:: issuerId = [%s]\n",csTmp));
			}
			else{
DEBUGLOG(("FormatMsg:: For EC payment, issuerId not included\n"));
			}
		}
/* 28 signMsg */
		if (GetField_CString(hIn,"sign",&csTmp)) {
			strcat((char*)outMsg,"signMsg");
			strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ALP_TOKEN);
DEBUGLOG(("FormatMsg:: signMsg = [%s]\n",csTmp));
		}


/* url_method */
		if (GetField_CString(hIn,"url_method",&csMethod)) {
DEBUGLOG(("FormatMsg:: url_method = [%s]\n",csMethod));
		}
		else 
			csMethod = strdup("");

DEBUGLOG(("FormatMsg:: outmsg = [%s]\n",outMsg));
		base64_encode(outMsg,strlen((char *)outMsg),csBuf,PD_MAX_BUFFER);
DEBUGLOG(("FormatMsg:: after encode\n"));
                outMsg[0] = '\0';
                strcat((char*)outMsg,"redirect_url");
                strcat((char*)outMsg,"=");
                strcat((char*)outMsg,csBuf);
                strcat((char*)outMsg,MY_ALP_TOKEN);
		strcat((char*)outMsg,"url_method");
		strcat((char*)outMsg,"=");
		strcat((char*)outMsg,csMethod);
                strcat((char*)outMsg,MY_ALP_TOKEN);
		strcat((char*)outMsg,"ret_status=0");
DEBUGLOG(("FormatMsg:: outMsg = [%s]\n",outMsg));

		*outLen = strlen((const char*)outMsg);
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("FormatMsg:: Redirct url not found\n"));
	}


DEBUGLOG(("FormatMsg:: normal exit iret =[%d]\n",iRet));
	FREE_ME(csBuf);
	return 	iRet;
}



int BreakDownMsg(hash_t *hOut,const unsigned char *inMsg,int inLen)
{
	int	iRet = PD_OK;
	char	*csPtr;
	hash_t  *hRec;

        hRec = (hash_t*)  malloc (sizeof(hash_t));
        hash_init(hRec,0);

DEBUGLOG(("BreakDownMsg()\n"));
DEBUGLOG(("DATA = [%s][%d]\n",inMsg,inLen));

	if (Str2Cls(hRec,(char *)inMsg,MY_ALP_TOKEN, MY_ALP_FIELD_TOKEN) == PD_OK) {

/* 1 merchantId */
		if (GetField_CString(hRec,"merchantId",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: merchantId = [%s]\n",csPtr));
			PutField_CString(hOut,"merchant_id",csPtr);
		}
/* 2 version */
		if (GetField_CString(hRec,"version",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: version = [%s]\n",csPtr));
			PutField_CString(hOut,"version",csPtr);
		}
/* 3 language */
		if (GetField_CString(hRec,"language",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: language = [%s]\n",csPtr));
			PutField_CString(hOut,"language",csPtr);
		}
/* 4 signType */
		if (GetField_CString(hRec,"signType",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: signType = [%s]\n",csPtr));
			PutField_CString(hOut,"signType",csPtr);
		}
/* 5 payType */
		
		if (GetField_CString(hRec,"payType",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: payType = [%s]\n",csPtr));
			PutField_CString(hOut,"payType",csPtr);
		}
/* 6 issuerId */
		if (GetField_CString(hRec,"issuerId",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: bank_code = [%s]\n",csPtr));
			PutField_CString(hOut,"bank_code",csPtr);
		}
/* 7 paymentOrderId */
		if (GetField_CString(hRec,"paymentOrderId",&csPtr)) {
			PutField_CString(hOut,"tid",csPtr);
DEBUGLOG(("BreakDownMsg:: tid = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: tid not found\n"));
		}
/* 8 orderNo */
		if (GetField_CString(hRec,"orderNo",&csPtr)) {
			PutField_CString(hOut,"txn_seq",csPtr);
DEBUGLOG(("BreakDownMsg:: txn_seq = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: txn_seq not found\n"));
		}
/* 9 orderDatetime */
		if (GetField_CString(hRec,"orderDatetime",&csPtr)) {
DEBUGLOG(("BreakDownMsg:: txn_datetime = [%s]\n",csPtr));
			PutField_CString(hOut,"orderDatetime",csPtr);
		}
/* 10 orderAmount */
		if (GetField_CString(hRec,"orderAmount",&csPtr)) {
			PutField_CString(hOut,"txn_amt",csPtr);
DEBUGLOG(("BreakDownMsg:: txn_amt = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: txn_amt not found\n"));
		}
/* 11 payDatetime */
                if (GetField_CString(hRec,"payDatetime",&csPtr)) {
                        PutField_CString(hOut,"fundin_date",csPtr);
DEBUGLOG(("BreakDownMsg:: payDatetime:fundin_date = [%s]\n",csPtr));
                }
                else{
DEBUGLOG(("BreakDownMsg:: payDatetime:fundin_date not found\n"));
                }

/* 12 payAmount */
		if (GetField_CString(hRec,"payAmount",&csPtr)) {
			PutField_CString(hOut,"payAmount",csPtr);
DEBUGLOG(("BreakDownMsg:: payAmount = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: payAmount not found\n"));
		}

/* 15 payResult */
		if (GetField_CString(hRec,"payResult",&csPtr)) {
			PutField_CString(hOut,"status",csPtr);
DEBUGLOG(("BreakDownMsg:: status = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BreakDownMsg:: status not found\n"));
		}
/* 16 errorCode */
		if (GetField_CString(hRec,"errorCode",&csPtr)) {
			PutField_CString(hOut,"error_code",csPtr);
DEBUGLOG(("BreakDownMsg:: error_code = [%s]\n",csPtr));
		}

/* 17 returnDatetime */
                if (GetField_CString(hRec,"returnDatetime",&csPtr)) {
                        PutField_CString(hOut,"txn_date",csPtr);
DEBUGLOG(("BreakDownMsg:: txn_date = [%s]\n",csPtr));
                }
                else{
DEBUGLOG(("BreakDownMsg:: txn_date not found\n"));
                }
/* signMsg */
                if (GetField_CString(hRec,"signMsg",&csPtr)) {
                        PutField_CString(hOut,"sign",csPtr);
DEBUGLOG(("BreakDownMsg:: sign = [%s]\n",csPtr));
                }
                else{
DEBUGLOG(("BreakDownMsg:: sign not found\n"));
                }


	}
	else {
DEBUGLOG(("BreakDownMsg() Error\n"));
                iRet = PD_ERR;
        }
        
        hash_destroy(hRec);
	FREE_ME(hRec);

DEBUGLOG(("BreakDownMsg Exit\n"));
	return	iRet;
}

int initReplyFromRequest(const hash_t* hRequest, hash_t* hResponse)
{
	int	iRet = PD_OK;

	return iRet;
}


int BuildAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPayType = NULL;
        char*   csPtr;
        char*   csBuf;
	double	dTmp;
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildAuthData()\n"));
	memset(csBuf,0,MAX_MSG_SIZE);
	csBuf[0] = '\0';
	


/* 1 inputCharset */
	strcat((char*)csBuf,"inputCharset");
	strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
	//strcat((char*)csBuf,"3"); //GB2312
	strcat((char*)csBuf,"1"); //UTF-8
	strcat((char*)csBuf,MY_ALP_TOKEN);

/* 2 pickupUrl */
	//if (GetField_CString(hIn,"fe_url",&csPtr)) {
	if (GetField_CString(hIn,"return_url_only",&csPtr)) {
		strcat((char*)csBuf,"pickupUrl");
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,"fe/");
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildAuthData:: pickupUrl = [%s]\n",csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: *** fe_url is missing\n"));
		}
/* 3 receiveUrl */
	if (GetField_CString(hIn,"return_url_only",&csPtr)) {
		strcat((char*)csBuf,"receiveUrl");
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildAuthData:: receiveUrl = [%s]\n",csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: *** return_url_only is missing\n"));
	}

/* 4 version */
	strcat((char*)csBuf,"version");
	strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
	strcat((char*)csBuf,"v1.0"); 
	strcat((char*)csBuf,MY_ALP_TOKEN);
/* 5 language */
	strcat((char*)csBuf,"language");
	strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
	strcat((char*)csBuf,"1");  //Chinese
	strcat((char*)csBuf,MY_ALP_TOKEN);
/* 6 signType */
	strcat((char*)csBuf,"signType");
	strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
	strcat((char*)csBuf,"1");  //signed by ssl cert
	strcat((char*)csBuf,MY_ALP_TOKEN);
		

/* 7 merchantId */
	if (GetField_CString(hIn,"psp_merchant_id",&csPtr)) {
		strcat((char*)csBuf,"merchantId");
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildAuthData:: merchantId = [%s]\n",csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: ***psp_merchant_id is missing\n"));
	}

/* 13 orderNo */

	if (GetField_CString(hIn,"txn_seq",&csPtr)) {
		strcat((char*)csBuf,"orderNo");
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildAuthData:: orderNo = [%s]\n",csPtr));
	}

/* 14 orderAmount */
	if (GetField_Double(hIn,"psp_txn_amt",&dTmp)) {

		char    csTmpAmt[PD_TMP_BUF_LEN +1];
		sprintf(csTmpAmt,"%ld",(long)(((dTmp*200)+1)/2));
		strcat((char*)csBuf,"orderAmount");
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csTmpAmt);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildAuthData:: orderAmount = [%s]\n",csTmpAmt));
	}
	else {
DEBUGLOG(("BuildAuthData:: psp_txn_amt is missing!!!\n"));
	}

/* 15 orderCurrency */
	strcat((char*)csBuf,"orderCurrency");
	strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
	strcat((char*)csBuf,"0");  //default RMB
	strcat((char*)csBuf,MY_ALP_TOKEN);
/* 16 orderDatetime */
        if (GetField_CString(hIn,"local_tm_date",&csPtr)) {
DEBUGLOG(("BuildAuthData:: local_tm_date = [%s]\n",csPtr));
               	char*   csPtr2;
               	char    csDateTime[PD_DATETIME_LEN * 2];
               	if (GetField_CString(hIn,"local_tm_time",&csPtr2)) {
DEBUGLOG(("BuildAuthData:: local_tm_time = [%s]\n",csPtr2));
                       	sprintf(csDateTime,"%s%s",csPtr,csPtr2);
DEBUGLOG(("BuildAuthData:: orderDatetime = [%s]\n",csDateTime));
                       	strcat((char*)csBuf,"orderDatetime");
                       	strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
                       	strcat((char*)csBuf,csDateTime);
                       	strcat((char*)csBuf,MY_ALP_TOKEN);
               	}
               	else {
DEBUGLOG(("BuildAuthData:: local_tm_time is missing!!!\n"));
               	}
       	}
       	else {
DEBUGLOG(("BuildAuthData:: local_tm_date is missing!!!\n"));
       	}
/* 25 payType */
	if (GetField_CString(hIn,"selected_pay_method",&csPayType)) {
DEBUGLOG(("BuildAuthData:: selected pay method = [%s]\n",csPayType));
		strcat((char*)csBuf,"payType");
                strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
                if (!strcmp(csPayType,PD_BANKCARD)) {
               		strcat((char*)csBuf,MY_ALP_BANKCARD);  //personal netbacking
		}
                else if (!strcmp(csPayType,PD_MOBILE_PAYMENT)) {
               		strcat((char*)csBuf,MY_ALP_MOBILE);  //mobile
                }
		strcat((char*)csBuf,MY_ALP_TOKEN);
	}
	else {
       		iRet = PD_ERR;
DEBUGLOG(("BuildAuthData:: ***selected_pay_method is missing\n"));
	}


/* 26 issueId */
	if (GetField_CString(hIn,"bank_code",&csPtr)) {
		if(strcmp(csPtr,PD_EC_BANK_CODE)){
			strcat((char*)csBuf,"issuerId");
			strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
			strcat((char*)csBuf,csPtr);
			strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildAuthData:: issuerId = [%s]\n",csPtr));
		}
		else{
DEBUGLOG(("BuildAuthData:: For EC payment, issuerId not included\n"));
		}
	}


	PutField_CString(hIn,"auth_data",csBuf);
DEBUGLOG(("BuildAuthData:: auth_data = [%s]\n",csBuf));
	FREE_ME(csBuf);
        
DEBUGLOG(("BuildAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

int BuildRspAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr;
        char*   csBuf;
	char	csTag[PD_TAG_LEN +1];
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildRspAuthData()\n"));
	memset(csBuf,0,MAX_MSG_SIZE);
	csBuf[0] = '\0';
	


/* 1 merchantId */
	strcpy(csTag,"merchant_id");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,"merchantId");
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildRspAuthData:: [%s] = [%s]\n",csTag,csPtr));
	}
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}

/* 2 version */
	strcpy(csTag,"version");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,csTag);
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildRspAuthData:: [%s] = [%s]\n",csTag,csPtr));
	}
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}

/* 3 language */
        strcpy(csTag,"language");
        if (GetField_CString(hIn,csTag,&csPtr)) {
                strcat((char*)csBuf,csTag);
                strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
                strcat((char*)csBuf,csPtr);
                strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildRspAuthData:: [%s] = [%s]\n",csTag,csPtr));
        }
        else {
                //iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
        }

/* 4 signType */
	strcpy(csTag,"signType");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,csTag);
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
	}
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}

/* 5 payType */
        strcpy(csTag,"payType");
        if (GetField_CString(hIn,csTag,&csPtr)) {
                strcat((char*)csBuf,csTag);
                strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
                strcat((char*)csBuf,csPtr);
                strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
        }
        else {
                //iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
        }

/* 7 paymentOrderId */
	strcpy(csTag,"tid");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,"paymentOrderId");
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
	}
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}

/* 8 orderNo */
	strcpy(csTag,"txn_seq");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,"orderNo");
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
	}

/* 9 orderDatetime */
	strcpy(csTag,"orderDatetime");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,csTag);
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
	}
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}

/* 10 orderAmount */
        strcpy(csTag,"txn_amt");
        if (GetField_CString(hIn,csTag,&csPtr)) {
                strcat((char*)csBuf,"orderAmount");
                strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
                strcat((char*)csBuf,csPtr);
                strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
        }
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}

/* 11 payDatetime */
	strcpy(csTag,"fundin_date");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,"payDatetime");
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
	}
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}

/* 12 payAmount */
	strcpy(csTag,"payAmount");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,csTag);
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
	}
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}

/* 15 payResult */
	strcpy(csTag,"status");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,"payResult");
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
	}
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}


/* 17 returnDatetime */
	strcpy(csTag,"txn_date");
	if (GetField_CString(hIn,csTag,&csPtr)) {
		strcat((char*)csBuf,"returnDatetime");
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
DEBUGLOG(("BuildRspAuthData:: %s = [%s]\n",csTag,csPtr));
	}
	else {
		//iRet = INT_ERR;
DEBUGLOG(("BuildRspAuthData:: ****[%s] is missing\n",csTag));
	}



	PutField_CString(hIn,"auth_data",csBuf);
DEBUGLOG(("BuildRspAuthData:: auth_data = [%s]\n",csBuf));
	FREE_ME(csBuf);
        
DEBUGLOG(("BuildRspAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

int BuildInqAuthData(hash_t* hIn)
{
        int     iRet = PD_OK;
        char*   csPtr;
        char*   csBuf;
        csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );

DEBUGLOG(("BuildInqAuthData()\n"));
	memset(csBuf,0,MAX_MSG_SIZE);
	csBuf[0] = '\0';
	


/* 1 merchantId */
	if (GetField_CString(hIn,"psp_merchant_id",&csPtr)) {
		strcat((char*)csBuf,"merchantId");
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildInqAuthData:: merchantId = [%s]\n",csPtr));
	}
	else {
		iRet = PD_ERR;
DEBUGLOG(("BuildInqAuthData:: ***psp_merchant_id is missing\n"));
	}


/* 2 version */
	strcat((char*)csBuf,"version");
	strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
	strcat((char*)csBuf,"v1.5"); 
	strcat((char*)csBuf,MY_ALP_TOKEN);

/* 3 signType */
	strcat((char*)csBuf,"signType");
	strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
	strcat((char*)csBuf,"1");  //signed by ssl cert
	strcat((char*)csBuf,MY_ALP_TOKEN);
		

/* 4 orderNo */

	if (GetField_CString(hIn,"org_txn_seq",&csPtr)) {
		strcat((char*)csBuf,"orderNo");
		strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
		strcat((char*)csBuf,csPtr);
		strcat((char*)csBuf,MY_ALP_TOKEN);
DEBUGLOG(("BuildInqAuthData:: orderNo = [%s]\n",csPtr));
	}
	else {
DEBUGLOG(("BuildInqAuthData:: org_txn_seq is missing!!!\n"));
	}

/* 5 orderDatetime */
        if (GetField_CString(hIn,"org_local_tm_date",&csPtr)) {
DEBUGLOG(("BuildInqAuthData:: local_tm_date = [%s]\n",csPtr));
               	char*   csPtr2;
               	char    csDateTime[PD_DATETIME_LEN * 2];
               	if (GetField_CString(hIn,"org_local_tm_time",&csPtr2)) {
DEBUGLOG(("BuildInqAuthData:: org_local_tm_time = [%s]\n",csPtr2));
                       	sprintf(csDateTime,"%s%s",csPtr,csPtr2);
DEBUGLOG(("BuildInqAuthData:: orderDatetime = [%s]\n",csDateTime));
                       	strcat((char*)csBuf,"orderDatetime");
                       	strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
                       	strcat((char*)csBuf,csDateTime);
                       	strcat((char*)csBuf,MY_ALP_TOKEN);
               	}
               	else {
DEBUGLOG(("BuildInqAuthData:: org_local_tm_time is missing!!!\n"));
               	}
       	}
       	else {
DEBUGLOG(("BuildInqAuthData:: org_local_tm_date is missing!!!\n"));
       	}

/* 6 queryDatetime */
        if (GetField_CString(hIn,"local_tm_datetime",&csPtr)) {
DEBUGLOG(("BuildInqAuthData:: local_tm_datetime = [%s]\n",csPtr));
        	strcat((char*)csBuf,"queryDatetime");
               	strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
                strcat((char*)csBuf,csPtr);
               	strcat((char*)csBuf,MY_ALP_TOKEN);
	}
       	else {
DEBUGLOG(("BuildInqAuthData:: local_tm_datetime is missing!!!\n"));
       	}


	PutField_CString(hIn,"auth_data",csBuf);
DEBUGLOG(("BuildInqAuthData:: auth_data = [%s]\n",csBuf));
	FREE_ME(csBuf);
        
DEBUGLOG(("BuildInqAuthData() Exit iRet = [%d]\n",iRet));
        return  iRet;
}

int FormatInqMsg(const hash_t* hIn,unsigned char *outMsg,int *outLen)
{
	int	iRet = PD_OK;
	char*   csTmp = NULL;
	char*   csPtr = NULL;
	char*   csBuf;
	char*	csURL;
	char*	csTxnCode;

	csBuf = (char*) malloc (MAX_MSG_SIZE + 1 );
//txn code
	if (GetField_CString(hIn,"txn_code",&csTxnCode)) {
DEBUGLOG(("FormatInqMsg:: txn_code = [%s]\n",csTxnCode));
        }

	memset(outMsg,0,sizeof(outMsg));

	 if (GetField_CString(hIn,"psp_url",&csURL)) {
		if (GetField_CString(hIn,"request_function",&csPtr)) {
                        strcpy((char*)csBuf,"url");
DEBUGLOG(("FormatInqMsg:: psp_url = [%s]\n",csURL));
                        strcat((char*)csBuf,MY_ALP_FIELD_TOKEN);
                        strcat((char*)csBuf,csURL);
                        strcat((char*)csBuf,"/");
                        strcat((char*)csBuf,csPtr);
                        strcat((char*)csBuf,MY_ALP_TOKEN);
                }

DEBUGLOG(("FormatInqMsg: [%s]\n",csBuf));
		sprintf((char*)outMsg,"%0*d",PD_WEB_HEADER_LEN_LEN,(int)strlen(csBuf));
DEBUGLOG(("FormatInqMsg:: outMsg = [%s]\n",outMsg));
                strcat((char*)outMsg,csBuf);
DEBUGLOG(("FormatInqMsg:: outMsg = [%s]\n",outMsg));

/* 1 merchantId */
		if (GetField_CString(hIn,"psp_merchant_id",&csTmp)) {
			strcat((char*)outMsg,"merchantId");
			strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ALP_TOKEN);
DEBUGLOG(("FormatInqMsg:: merchantId = [%s]\n",csTmp));
		}
		else {
			iRet = PD_ERR;
DEBUGLOG(("FormatInqMsg:: ***psp_merchant_id is missing\n"));
		}

/* 2 version */
		strcat((char*)outMsg,"version");
		strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
		strcat((char*)outMsg,"v1.5"); 
		strcat((char*)outMsg,MY_ALP_TOKEN);

/* 3 signType */
		strcat((char*)outMsg,"signType");
		strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
		strcat((char*)outMsg,"1");  //signed by ssl cert
		strcat((char*)outMsg,MY_ALP_TOKEN);
		
/* 4 orderNo */

		if (GetField_CString(hIn,"org_txn_seq",&csTmp)) {
			strcat((char*)outMsg,"orderNo");
			strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ALP_TOKEN);
DEBUGLOG(("FormatInqMsg:: orderNo = [%s]\n",csTmp));
		}

/* 5 orderDatetime */
       	 	if (GetField_CString(hIn,"org_local_tm_date",&csPtr)) {
DEBUGLOG(("FormatInqMsg:: local_tm_date = [%s]\n",csPtr));
               		char*   csPtr2;
               		char    csDateTime[PD_DATETIME_LEN * 2];
               		if (GetField_CString(hIn,"org_local_tm_time",&csPtr2)) {
DEBUGLOG(("FormatInqMsg:: local_tm_time = [%s]\n",csPtr2));
                       		sprintf(csDateTime,"%s%s",csPtr,csPtr2);
DEBUGLOG(("FormatInqMsg:: orderDatetime = [%s]\n",csDateTime));
                       		strcat((char*)outMsg,"orderDatetime");
                       		strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
                       		strcat((char*)outMsg,csDateTime);
                       		strcat((char*)outMsg,MY_ALP_TOKEN);
               		}
               		else {
DEBUGLOG(("FormatInqMsg:: org_local_tm_time is missing!!!\n"));
               		}
       		}
       		else {
DEBUGLOG(("FormatInqMsg:: org_local_tm_date is missing!!!\n"));
       		}

/* 6 queryDatetime */
        	if (GetField_CString(hIn,"local_tm_datetime",&csPtr)) {
DEBUGLOG(("FormatInqMsg:: local_tm_datetime = [%s]\n",csPtr));
        		strcat((char*)outMsg,"queryDatetime");
               		strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
               	 	strcat((char*)outMsg,csPtr);
               		strcat((char*)outMsg,MY_ALP_TOKEN);
		}
       		else {
DEBUGLOG(("FormatInqMsg:: local_tm_datetime is missing!!!\n"));
       		}

/* 7 signMsg */
		if (GetField_CString(hIn,"sign",&csTmp)) {
			strcat((char*)outMsg,"signMsg");
			strcat((char*)outMsg,MY_ALP_FIELD_TOKEN);
			strcat((char*)outMsg,csTmp);
			strcat((char*)outMsg,MY_ALP_TOKEN);
DEBUGLOG(("FormatInqMsg:: signMsg = [%s]\n",csTmp));
		}

	}
	else {
DEBUGLOG(("FormatInqMsg:: psp_url not found\n"));
		iRet = PD_ERR;
	}

DEBUGLOG(("FormatInqMsg:: outmsg = [%s]\n",outMsg));
	*outLen = strlen((const char*)outMsg);


DEBUGLOG(("FormatInqMsg:: normal exit iret =[%d]\n",iRet));
	FREE_ME(csBuf);
	return 	iRet;
}
